@interface HMDHomeManager
+ (BOOL)doesSaveReasonAffectHomeManager:(id)manager;
+ (BOOL)doesSaveReasonAffectOnlyLocalData:(id)data;
+ (BOOL)doesSaveReasonNotAffectLocalData:(id)data;
+ (BOOL)doesSaveReasonRequireForceSyncToWatch:(id)watch;
+ (BOOL)isPrefSetForHH2WithoutCloudKit;
+ (BOOL)shouldIgnoreExpectedConfigurationVersionUpdateForReason:(id)reason;
+ (BOOL)shouldIncrementGenerationCounterForReason:(id)reason;
+ (id)_findDuplicateUserModelsWithContext:(id)context;
+ (id)_getIntentGroupClientIdentifierSalt;
+ (id)allowedClassesForAccessAllowedWhenLockedArchive;
+ (id)convertSaveReasonToTransactionReason:(id)reason;
+ (id)createIdentifierSalt:(id)salt deviceSpecific:(BOOL)specific;
+ (id)deriveIntentGroupIdentifierFromBaseUUID:(id)d;
+ (id)emptyModelObjectWithChangeType:(unint64_t)type homeManagerUUID:(id)d;
+ (id)getAccessoryCacheForIdentifier:(id)identifier;
+ (id)getAllBackingStoreObjects:(int64_t)objects primaryHomeUUID:(id)d cloudZone:(id)zone appData:(id)data;
+ (id)getContainersToCleanUp;
+ (id)getUniqueDeviceIdSalt;
+ (id)logCategory;
+ (id)remotePeerDeviceAddress:(id)address;
+ (id)saltForDeviceSpecificIdentifier;
+ (id)setupCoreDataUsingBackingStore:(id)store;
+ (void)_eraseAllAccessoryKeysAndIdentifiers;
+ (void)makeSureHomeManagerExistInWorkingStore:(id)store;
+ (void)relaunchHomedDueToResetConfigurationWithDelay:(double)delay;
+ (void)removeAccessoryCacheForIdentifier:(id)identifier;
+ (void)saveAccessoryCache:(id)cache forIdentifier:(id)identifier;
+ (void)wipeCoreDataStorageDueToExcessiveHistoryPrunedAndRelaunchHomeKitDaemon;
- (BOOL)_associateAccessories:(id)accessories withHomes:(id)homes;
- (BOOL)_capabilitiesAreSupported:(id)supported;
- (BOOL)_configureHomes:(id)homes uncommittedTransactions:(id)transactions;
- (BOOL)_configureHomesImpl:(id)impl uncommittedTransactions:(id)transactions;
- (BOOL)_findAnyAccessoryWithIdentities:(id)identities inAccessoryServers:(id)servers;
- (BOOL)_handleAccessoryDiagnosticStateQueryWithResponse:(id)response accessory:(id)accessory hasAdditionalRequest:(BOOL)request error:(id)error completion:(id)completion;
- (BOOL)_isAutoAcceptMetadataPresentForHome:(id)home owner:(id)owner;
- (BOOL)_isMetadataExpiredForHomeAwaitingAutoAccept:(id)accept;
- (BOOL)_processTestModeCurrentHomeOverride:(id)override error:(id *)error;
- (BOOL)_processTestModeHomeAccessControlOverride:(id)override error:(id *)error;
- (BOOL)_processTestModeHomeLocationStatusOverride:(id)override error:(id *)error;
- (BOOL)_processTestModeOverridesPayload:(id)payload error:(id *)error;
- (BOOL)_processTestModeSkipHH2MigrationOverride:(id)override error:(id *)error;
- (BOOL)_processTestModeUpdateHomeLocation:(id)location error:(id *)error;
- (BOOL)_redirectAppDataRequestToResidentWithMessage:(id)message;
- (BOOL)_removeAndAddKeyPair:(id)pair userName:(id)name eraseReason:(unint64_t)reason;
- (BOOL)_setPrimaryHome:(id)home idsDataSync:(BOOL)sync;
- (BOOL)_shouldCheckExcessiveHistoryPruning;
- (BOOL)_shouldDecodeMessage:(id)message error:(id *)error;
- (BOOL)_shouldHandleHomeDataSync:(id)sync remoteHome:(id)home sourceDeviceVersion:(id)version;
- (BOOL)_submitSpamReportToIDS:(id)s;
- (BOOL)_updateAccessoriesConfigured;
- (BOOL)_updateIncomingInvitesPresent;
- (BOOL)_updatePreferencesForConfiguredHomes;
- (BOOL)_updatePreferencesForCurrentHome;
- (BOOL)_zonesFetched;
- (BOOL)addHH2KeyInResponsePayload:(id)payload invitation:(id)invitation;
- (BOOL)areThereAnyTTSUSessionsOngoing;
- (BOOL)badCDPState;
- (BOOL)checkConflictInHomeNamespaceWithName:(id)name options:(unint64_t)options namespaceUUID:(id)d error:(id *)error;
- (BOOL)daemonHasLoadedSceneGraph;
- (BOOL)deviceAddressBelongsToResidentOfCurrentHome:(id)home;
- (BOOL)deviceAddressIsForPrimaryResident:(id)resident;
- (BOOL)expectingInvitationResponseForIdentifier:(id)identifier;
- (BOOL)fetchAndRemoveNextBatchOfZonesFromDatabase:(id)database;
- (BOOL)getOrCreateControllerPublicKey:(id *)key controllerUsername:(id *)username error:(id *)error;
- (BOOL)hasClientRequestedMediaAccessoryControl:(id)control;
- (BOOL)hasDemoAccessories;
- (BOOL)hasHAPAccessoryInAnyHome;
- (BOOL)hasMediaSystemHints;
- (BOOL)isAccessAllowedWhenLocked;
- (BOOL)isActive;
- (BOOL)isCloudKitRequiredForHH2;
- (BOOL)isCurrentDevicePrimaryResident;
- (BOOL)isCurrentDeviceResident;
- (BOOL)isCurrentResidentDeviceRunningThreadNetwork:(id)network;
- (BOOL)isHH1EOLEnabled;
- (BOOL)isHH1EOLForResidentDeviceRunningSoftwareVersion:(id)version;
- (BOOL)isInitialReplay:(id)replay;
- (BOOL)isNetworkConnectionAvailable;
- (BOOL)isPairedWithWatch;
- (BOOL)isResidentCapable;
- (BOOL)isResidentEnabled;
- (BOOL)isSignedIntoiCloud;
- (BOOL)isStartThreadNetworkInProgress;
- (BOOL)isThisDesignatedFMFDevice;
- (BOOL)pendingInviteExistsForSenderOfMessage:(id)message;
- (BOOL)postSyncDataUpdatedNotification;
- (BOOL)restoreMediaSystemHintsFromDisk;
- (BOOL)setLocalPairingIdentity:(id)identity error:(id *)error;
- (BOOL)shouldAcceptInvitationPayload:(id)payload error:(id *)error;
- (BOOL)shouldClearDeviceSetupFollowUp;
- (BOOL)shouldDropNotification;
- (BOOL)userWithMergeIdIsMemberOfAHome:(id)home;
- (BOOL)zoneFetchFailed;
- (HMDAccountHandle)accountHandleForOwner;
- (HMDDemoModeManagerDataSource)demoModeDataSource;
- (HMDDevice)companionDevice;
- (HMDHomeManager)init;
- (HMDHomeManager)initWithMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry metricsManager:(id)self0 configuringStateController:(id)self1 diagnosticInfoController:(id)self2 currentAccessorySetupMetricDispatcher:(id)self3 uncommittedTransactions:(id)self4 featuresDataSource:(id)self5;
- (HMDHomeManager)initWithMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry metricsManager:(id)self0 darwinNotificationProvider:(id)self1 notificationCenter:(id)self2 dataSource:(id)self3 appleAccountManager:(id)self4 remoteAccountManager:(id)self5 userDefaults:(id)self6 hmdUserDefaults:(id)self7 biomeEventManager:(id)self8 logEventSubmitter:(id)self9 widgetConfigurationReader:(id)reader configuringStateController:(id)controller diagnosticInfoController:(id)infoController currentAccessorySetupMetricDispatcher:(id)metricDispatcher uncommittedTransactions:(id)transactions featuresDataSource:(id)dataSource;
- (HMDHomeOwnerCloudShareManager)homeOwnerCloudShareManager;
- (HMDHomeSharedUserCloudShareManager)homeSharedUserCloudShareManager;
- (HMDSharedUserPrivateSettingsManager)sharedUserPrivateSettingsManager;
- (HMFBoolean)overrideCurrentHomeUUIDToNil;
- (NSArray)homes;
- (NSDate)lastSoftwareUpdateDate;
- (NSSet)homeUUIDsWithAutoAddWalletKeySuppressed;
- (NSString)currentEventSource;
- (NSUUID)currentHomeUUID;
- (NSUUID)currentHomeUUIDOverride;
- (_TtCE13HomeKitDaemonCSo14HMDHomeManagerP33_A2017DEA629FAA91F481E814718C0BF815SwiftExtensions)_swiftExtensions;
- (double)setupEndTimestamp;
- (double)setupStartTimestamp;
- (id)__computedCurrentHomeUUID;
- (id)__dumpHomeManagerDataWithPrivacyLevel:(unint64_t)level;
- (id)__generateAssistantTeamIdentifier;
- (id)__homeContainingInviteWithIDSInvitationIdentifier:(id)identifier;
- (id)__homeContainingInviteWithInvitationIdentifier:(id)identifier;
- (id)_accessoryOfCurrentDevice;
- (id)_accountHandleFromMetadataForHomeAwaitingAutoAccept:(id)accept;
- (id)_appleMediaAccessoryOfCurrentDevice;
- (id)_checkActionSetNameConflict:(id)conflict withNamespaceUUIDs:(id)ds;
- (id)_checkNameConflict:(id)conflict withNamespaceUUIDs:(id)ds;
- (id)_compressHomeData:(id)data;
- (id)_computedCurrentHomeUUID;
- (id)_currentHome;
- (id)_decodeDiagnosticInfoFromLocalResponse:(id)response;
- (id)_destinationFromMessage:(id)message;
- (id)_deviceForIdentifier:(id)identifier;
- (id)_diagnosticInfoFromRemoteResponse:(id)response;
- (id)_dumpHomeManagerDataWithPrivacyLevel:(unint64_t)level;
- (id)_filterAccessories:(id)accessories inHome:(id)home;
- (id)_filterAccessories:(id)accessories withIdentifiers:(id)identifiers;
- (id)_findHomeModel:(id)model;
- (id)_getAssistantHashingData;
- (id)_getListOfUsersToPushMetadataChangesTo;
- (id)_getRequestedState:(id)state activity:(id)activity privacyLevel:(unint64_t)level;
- (id)_homeFromEventIdentifier:(id)identifier;
- (id)_homeFromIncomingInvitationWithIdentifier:(id)identifier invitationIdentifier:(id)invitationIdentifier homeUUID:(id)d;
- (id)_homeWithAssistantIdentifier:(id)identifier;
- (id)_homeWithName:(id)name;
- (id)_homeWithUUID:(id)d;
- (id)_homeWithUniqueIdentifier:(id)identifier forClientIdentifierSalt:(id)salt;
- (id)_homeWithZoneID:(id)d;
- (id)_homesWithName:(id)name;
- (id)_legacyContainer;
- (id)_legacyHomeAcceptedZoneIDFromHomeUUID:(id)d;
- (id)_legacyHomeZoneIDFromHomeUUID:(id)d;
- (id)_loadCloudTransactionForRemoteHome:(id)home localHome:(id)localHome cachedHome:(id)cachedHome version:(int64_t)version;
- (id)_mediaRouteIdentifierForAccessory:(id)accessory;
- (id)_prepareAnswerForRequestedCapabilities:(id)capabilities;
- (id)_prepareDataForDevicesOnSameAccountForHome:(id)home remoteGateway:(BOOL)gateway isAtLeastV4:(BOOL)v4 migrateToHH2:(BOOL)h2;
- (id)_prepareHomesVersionDict;
- (id)_remotePeers;
- (id)_remoteUserForMessage:(id)message;
- (id)_runtimeState;
- (id)_scrubRequestedCapabilities:(id)capabilities fromMessage:(id)message;
- (id)_statusPayloadForMessage:(id)message;
- (id)_trackIncomingInvitationFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload invitationState:(int64_t)state error:(id *)error;
- (id)_userPushCachedGetDeviceForUser:(id)user;
- (id)_zoneInformationWithUUID:(id)d;
- (id)accessAllowedWhenLockedSettingFileName;
- (id)accessoriesMatchingIdentifier:(id)identifier;
- (id)accessorySetupMetricDispatcherForAccessoryUUID:(id)d;
- (id)accessorySetupMetricDispatchersForHome:(id)home;
- (id)accessoryWithHomeUUID:(id)d accessoryUUID:(id)iD;
- (id)accessoryWithIDSIdentifier:(id)identifier;
- (id)accessoryWithUUID:(id)d;
- (id)activeAccountIdentifier;
- (id)addName:(id)name namespace:(id)namespace;
- (id)backingStoreObjects:(int64_t)objects;
- (id)createCloudDatabaseAndPerformInitialSync:(id)sync;
- (id)createCurrentAccessoryCapabilities;
- (id)createCurrentResidentCapabilities;
- (id)currentAccessory;
- (id)currentAccessoryHome;
- (id)currentAccessoryHomeUUID;
- (id)currentAccessoryUUID;
- (id)currentHome;
- (id)currentMediaGroupsAggregateConsumer;
- (id)delegatingRouter:(id)router filteredTopics:(id)topics forRouter:(id)forRouter;
- (id)deleteLocalZone:(id)zone localDatabase:(id)database containerID:(id)d;
- (id)destinationIdentifierForMediaSystem:(id)system role:(unint64_t)role;
- (id)eventRouterServerDiagnosticInfo;
- (id)filterHomes:(id)homes isSPIEntitled:(BOOL)entitled;
- (id)firstSetupSessionIdentifierOutputStartTime:(double *)time;
- (id)generateDataForSharedHomeModel:(id)model;
- (id)generatePayloadFromHome:(id)home forAdmin:(BOOL)admin user:(id)user supportedFeatures:(id)features;
- (id)getOrCreateLocalPairingIdentity:(id *)identity;
- (id)hh1UserIDsForCurrentUserForHomeUUID:(id)d;
- (id)hh2ControllerKey;
- (id)homeUUIDFromHints;
- (id)homeUUIDsWithAutoAddWalletKeySuppressedSync;
- (id)homesToSendForNonSPIClients;
- (id)hubAccessoriesWithHomeUUID:(id)d forSiriEndpointProfileMessageHandler:(id)handler;
- (id)identifiersOfAccessories:(id)accessories;
- (id)identifiersOfAccessoriesForHome:(id)home;
- (id)languageListProviderForHomeUUID:(id)d;
- (id)mediaGroupUsingHintsForHomeUUID:(id)d accessoryUUID:(id)iD;
- (id)mediaSystemForAppleMediaAccessory:(id)accessory;
- (id)mediaSystemUUIDFromHints;
- (id)messageDestination;
- (id)modelObjectWithChangeType:(unint64_t)type version:(int64_t)version;
- (id)multiUserSettingsForMultiUserSettingsMetricsEventDispatcherDataSource;
- (id)needsOnboardingForHomeUUID:(id)d accessoryUUID:(id)iD;
- (id)pairedAccessories;
- (id)peerAccessoryRoleFromHints;
- (id)peerAccessoryUUIDFromHints;
- (id)queryDeviceCapabilities:(id)capabilities;
- (id)removeName:(id)name namespace:(id)namespace;
- (id)replaceName:(id)name withNewName:(id)newName inNamespaces:(id)namespaces;
- (id)settingsControllerForAccessoryUUID:(id)d homeUUID:(id)iD;
- (id)setupSessionIdentifierForAccessoryUUID:(id)d outStartTime:(double *)time;
- (id)sharedUserAcceptEventBuilderForHomeUuid:(id)uuid;
- (id)topicNameForMediaGroupParticipantDataLocalStorage:(id)storage;
- (id)updateMediaRouteIDOfDeviceWithIdentifier:(id)identifier;
- (id)updatedUUIDForDiscoveredUnpairedAccessory:(id)accessory;
- (id)userUUIDForMessage:(id)message homeUUID:(id)d;
- (id)userWithMergeID:(id)d;
- (id)validateHomeName:(id)name;
- (int64_t)numberOfAccessoryWithNewFirmwareAvailable;
- (int64_t)numberOfPendingIncomingInvitation;
- (uint64_t)__shouldScanAndUpdateDeviceInfoForDevice:(void *)device;
- (unint64_t)generationCounter;
- (unint64_t)numHomes;
- (unint64_t)statusForMessage:(id)message;
- (unsigned)_nextTransactionIdentifier;
- (void)__accountAddedDevice:(id)device;
- (void)__accountRegistryAddedAccount:(id)account;
- (void)__accountRegistryRemovedAccount:(id)account;
- (void)__accountRemovedDevice:(id)device;
- (void)__checkForBootTimeLogout;
- (void)__handleAppleAccountUpdated:(id)updated;
- (void)__handleAppleAccountUpdated:(id)updated previousAccount:(id)account;
- (void)__handleCompanionUpdated:(id)updated;
- (void)__handleDeviceCapabilitiesUpdated:(id)updated;
- (void)__handleDeviceUpdatedNotification:(id)notification;
- (void)__handleRequestFetchHomeConfiguration:(id)configuration;
- (void)__handleUpdatedCurrentDevice:(id)device;
- (void)__sendUpdateRequestToAdminForInvitation:(id)invitation homeUUID:(id)d invitationState:(int64_t)state authStatus:(id)status reverseShareInvitation:(id)shareInvitation logEventBuilder:(id)builder;
- (void)__setLastSyncedAssistantConfigurationVersion:(unint64_t)version;
- (void)__startupFirewallRuleManagerForMessage:(id)message completion:(id)completion;
- (void)_acceptHomeInviteFromAccount:(id)account message:(id)message trackInvite:(BOOL)invite;
- (void)_accessoriesAreLocallyReachableOnTransientDevice:(BOOL)device forHome:(id)home;
- (void)_addCloudZone:(id)zone ownerName:(id)name;
- (void)_addCurrentResidentDeviceToHomes:(id)homes;
- (void)_addIncomingInvitation:(id)invitation;
- (void)_addPendingDataSyncAcksForUser:(id)user forHome:(id)home;
- (void)_assistantSyncDataChanged:(id)changed;
- (void)_auditDuplicatePreviouslyAddedAccessory:(id)accessory;
- (void)_auditIDSSentInvitations;
- (void)_auditKeychainEntries;
- (void)_autoAcceptAllPendingReinvitations;
- (void)_autoAcceptInviteIfReinvitation:(id)reinvitation;
- (void)_cancelAccessoryFinderTimer;
- (void)_changePrimaryHome:(id)home;
- (void)_checkAndInformCompanionDevice;
- (void)_checkForRemotePeers;
- (void)_checkForRemotePeersAndRegisterForRemoteNotifications:(BOOL)notifications;
- (void)_checkForSelfRemoval;
- (void)_dumpToLog:(id)log withState:(id)state;
- (void)_electCompanionForRemoteAccess:(id)access;
- (void)_electRemoteAccessDeviceForHome:(id)home retryCount:(unint64_t)count;
- (void)_electRemoteGatewayForHomesAfterReachabilityChanges;
- (void)_eraseLocalHomeConfiguration;
- (void)_eraseLocalHomeConfigurationAfterSignOut;
- (void)_eraseLocalHomeConfigurationAndDeleteMetadata:(BOOL)metadata reason:(unint64_t)reason completionQueue:(id)queue completion:(id)completion;
- (void)_eraseLocalHomeConfigurationWithReason:(unint64_t)reason;
- (void)_eraseLocalMetadata;
- (void)_findRemotePeerContainingAccessories:(id)accessories forHome:(id)home;
- (void)_fragmentationStream:(id)stream didCloseWithError:(id)error;
- (void)_fragmentationStream:(id)stream didReceiveData:(id)data transactionIdentifier:(unsigned __int16)identifier error:(id)error;
- (void)_generateAssistantSyncDataAndIncrementVersion:(BOOL)version requestSync:(BOOL)sync urgent:(BOOL)urgent completion:(id)completion;
- (void)_handleAccessAllowedWhenLockedRequest:(id)request;
- (void)_handleAccessHomeInvite:(id)invite;
- (void)_handleAccessHomeInviteFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload messageResponseHandler:(id)handler;
- (void)_handleAccessoryDiagnosticQueryWithOptions:(unint64_t)options accessory:(id)accessory accessoryUUID:(id)d mediaRouteID:(id)iD additionalFetchKeys:(id)keys filteringKeyPaths:(id)paths remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)self0 completion:(id)self1;
- (void)_handleAccessoryDiagnosticStateQuery:(id)query;
- (void)_handleAddRemoteAccessRequest:(id)request;
- (void)_handleAddedAccessory:(id)accessory;
- (void)_handleAppleMediaAccessoryDeviceInfoRequestMessage:(id)message;
- (void)_handleAppleMediaResidentCoreDataChanges:(id)changes;
- (void)_handleAreYouAtHome:(id)home;
- (void)_handleAssistantSyncDataRequest:(id)request;
- (void)_handleClearMobileAssetsInfoRequest:(id)request;
- (void)_handleCompanionKeysSync:(id)sync;
- (void)_handleConnectivityInfoRequest:(id)request;
- (void)_handleContactStoreChanged;
- (void)_handleCurrentAccessoryAddedNotification:(id)notification;
- (void)_handleCurrentAccessoryRemovedNotification:(id)notification;
- (void)_handleCurrentHomeChanged:(id)changed;
- (void)_handleDeviceNotification:(id)notification;
- (void)_handleDeviceSetupConfiguringStateQuery:(id)query;
- (void)_handleDeviceSetupSessionClose:(id)close;
- (void)_handleDeviceSetupSessionOpen:(id)open;
- (void)_handleDiagnosticInfo:(id)info;
- (void)_handleDismissBulletinRequest:(id)request;
- (void)_handleDismissDialogRequest:(id)request;
- (void)_handleDoYouSeeUnpairedAccessories:(id)accessories;
- (void)_handleDumpDatabase:(id)database;
- (void)_handleDumpState:(id)state;
- (void)_handleElectDeviceForIDSSession:(id)session;
- (void)_handleEnableResidentForThisDeviceRequest:(id)request;
- (void)_handleEnableUARPPacketCaptureRequest:(id)request;
- (void)_handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest:(id)request;
- (void)_handleFetchDevicesMessage:(id)message;
- (void)_handleFetchSetupMode:(id)mode;
- (void)_handleForwardedSharedUserInvitationAcceptance:(id)acceptance;
- (void)_handleGetTLVForJSON:(id)n;
- (void)_handleHH2SentinelZonePresent:(id)present;
- (void)_handleHomeDataSync:(id)sync;
- (void)_handleHomeManagerSyncWalletKeysPassSerialNumbersMessage:(id)message;
- (void)_handleHomeUtilCommandWalletMessage:(id)message;
- (void)_handleHomeUtilRemoteMessageRequest:(id)request;
- (void)_handleHomeUtilSetOverridesMessage:(id)message;
- (void)_handleHomesConfigSync:(id)sync;
- (void)_handleKeyRoll:(id)roll;
- (void)_handleMetadataSync:(id)sync;
- (void)_handleNetworkFirewallAddOverridesRequest:(id)request;
- (void)_handleNetworkFirewallDumpCloudRecordsRequest:(id)request;
- (void)_handleNetworkFirewallDumpLocalRulesRequest:(id)request;
- (void)_handleNetworkFirewallDumpPairedMetadataRequest:(id)request;
- (void)_handleNetworkFirewallFetchCloudChangesRequest:(id)request;
- (void)_handleNetworkFirewallRemoveLocalRulesRequest:(id)request;
- (void)_handleNetworkFirewallRemoveOverridesRequest:(id)request;
- (void)_handleNetworkMismatchInfo:(id)info;
- (void)_handlePairingIdentityRequest:(id)request;
- (void)_handlePing:(id)ping;
- (void)_handlePrepareForDiagnosticExtension:(id)extension;
- (void)_handleQueryHomeNamespace:(id)namespace;
- (void)_handleQueryMetadata:(id)metadata;
- (void)_handleQueryVersionInformation:(id)information;
- (void)_handleQueryiCloudSwitchState:(id)state;
- (void)_handleRemoteSessionTornDownNotification:(id)notification;
- (void)_handleRemoveAccount:(id)account;
- (void)_handleRemoveAllHomeKitPairingIdentities:(id)identities;
- (void)_handleRemoveAllUsersFromAccessories:(id)accessories;
- (void)_handleRemoveHomeOperation:(id)operation message:(id)message;
- (void)_handleRequestAddHome:(id)home;
- (void)_handleRequestFetchHomeConfiguration:(id)configuration;
- (void)_handleRequestIsUserUsingHomeKit:(id)kit;
- (void)_handleRequestRemoveHome:(id)home;
- (void)_handleRequestRuntimeStateUpdate:(id)update;
- (void)_handleRequestSetPrimaryHome:(id)home;
- (void)_handleRequestToCancelHomeInvitation:(id)invitation saveReason:(id)reason;
- (void)_handleRequestToUpdateHomeInvitationFromInviter:(id)inviter;
- (void)_handleRequestToUpdateHomeInvitationFromLocalUser:(id)user;
- (void)_handleResetConfiguration:(id)configuration;
- (void)_handleResetHome:(id)home;
- (void)_handleResolveAccount:(id)account;
- (void)_handleRetrieveVendorIdentifier:(id)identifier;
- (void)_handleSEUpdatedAliroVersions;
- (void)_handleSetAppData:(id)data;
- (void)_handleSetMetadata:(id)metadata;
- (void)_handleSharedUserMovedToHH2:(id)h2;
- (void)_handleSignificantTimeChange;
- (void)_handleSwitchSetupMode:(id)mode;
- (void)_handleTestHH2Migration:(id)migration;
- (void)_handleTestModeConfigRequest:(id)request;
- (void)_handleUpdateMobileAssetsRequest:(id)request;
- (void)_handleUpdatedCurrentDevice:(id)device;
- (void)_handleUpdateiCloudSwitchState:(id)state;
- (void)_handleUserRemoved:(id)removed;
- (void)_incrementAssistantGenerationCounter;
- (void)_informMdnsOfHomeWithResidentsUpdate;
- (void)_loadMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry uncommittedTransactions:(id)self0 reloadData:(BOOL)self1;
- (void)_logState:(id)state key:(id)key indent:(id)indent;
- (void)_markExcessiveHistoryPruningHandled;
- (void)_maybeConfigureDuplicateUserModelChecker;
- (void)_maybeCreateLegacyHomeAcceptedZone:(id)zone;
- (void)_maybeMessageOwnersOfFrameworkSwitch;
- (void)_migrateAccessAllowedWhenLockedSettingIfNeeded;
- (void)_migrateUniqueIdentifierPrefsIfNeeded;
- (void)_monitorMemoryUsage;
- (void)_monitorReachability;
- (void)_notifyClientsOfUpdatedStatus;
- (void)_notifyCurrentHomeUpdated:(id)updated isLocalUpdate:(BOOL)update;
- (void)_notifyMetricsManagerOfConfigurationChange;
- (void)_notifyXPCClientsOfHomeConfigurationChange;
- (void)_notifyXPCClientsOfUpdatedDevices;
- (void)_postIncomingInvitationStateChangedNotification:(id)notification newInvitationState:(int64_t)state;
- (void)_postPreferencesChangedNotification;
- (void)_processAnyPendingRequestsForRemoteAccess:(BOOL)access;
- (void)_processLocalRequestToUpdateHomeInvitation:(id)invitation newState:(int64_t)state authStatus:(id)status logEventBuilder:(id)builder;
- (void)_processMetricStagesDuringSessionOpening;
- (void)_processRequestToUpdateHomeInvitation:(id)invitation invitationState:(int64_t)state homeUUID:(id)d authStatus:(id)status invitationSource:(unint64_t)source messageName:(id)name message:(id)message;
- (void)_processSharedHomeModel:(id)model message:(id)message;
- (void)_pruneExpiredHomesAwaitingAutoAccept;
- (void)_pruneExpiredHomesNotYetMigrated;
- (void)_pruneExpiredIncomingInvitations;
- (void)_pushChangesForHH2SharedUserLastSync:(id)sync completion:(id)completion;
- (void)_pushMetadataChangesToUsers;
- (void)_pushUserRemovedForHome:(id)home;
- (void)_queryLegacyHomeAndAcceptedZoneExists:(id)exists completion:(id)completion;
- (void)_readAccessAllowedWhenLockedSettingFromLocalStore;
- (void)_registerForAppleMediaMessages;
- (void)_registerForConfiguringStateMessages;
- (void)_registerForFrameworkSwitch;
- (void)_registerForMediaSystemHintsMessages;
- (void)_registerForMessages;
- (void)_remoteAccessHealthMonitorTimerDidFire:(id)fire;
- (void)_removeAccessAllowedWhenLockedFileFromDisk;
- (void)_removeAllUsersOfHome:(id)home;
- (void)_removeConfigurationVersionForHome:(id)home;
- (void)_removeCurrentResidentDeviceFromHomes:(id)homes;
- (void)_removeFromAssociatedPeers:(id)peers home:(id)home;
- (void)_removeFromUnassociatedPeers:(id)peers home:(id)home;
- (void)_removeHome:(id)home withMessage:(id)message saveToStore:(BOOL)store notifyUsers:(BOOL)users shouldRemovePairings:(BOOL)pairings;
- (void)_removeIncomingInvitation:(id)invitation;
- (void)_removePendingDataSyncAcksForUser:(id)user forHome:(id)home;
- (void)_resetSiriSyncNotification;
- (void)_saveAccessAllowedWhenLockedToLocalStore:(BOOL)store message:(id)message;
- (void)_saveAssistantHashingData:(id)data;
- (void)_scheduleNextCheck;
- (void)_scheduleSendHomeDataToAllWatches;
- (void)_sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier:(id)identifier homeInviteUUID:(id)d payload:(id)payload invitationState:(int64_t)state responseHandler:(id)handler;
- (void)_sendCurrentHomeToWatch:(id)watch;
- (void)_sendFragmentedMessage:(id)message messageIndex:(unint64_t)index messageIdentity:(id)identity userID:(id)d destination:(id)destination completionHandler:(id)handler;
- (void)_sendHomeDataToWatch:(id)watch migrateToHH2:(BOOL)h2 completionHandler:(id)handler;
- (void)_sendOwnerPingMessageToAccountHandle:(id)handle;
- (void)_sendUserAdded:(id)added destination:(id)destination toHome:(id)home;
- (void)_sendUserRemoved:(id)removed fromHome:(id)home pairingUsername:(id)username pushToCloud:(BOOL)cloud completionHandler:(id)handler;
- (void)_setAppDataWithMessage:(id)message;
- (void)_setAssistantSyncRequest:(id)request;
- (void)_setHomekitAssistantConfigurationVersion:(unint64_t)version;
- (void)_setHomekitAssistantNumEntities:(unint64_t)entities;
- (void)_setUniqueDeviceIdSalt:(id)salt;
- (void)_signpostAssistantSyncDataNotification;
- (void)_signpostAssistantSyncDataRequestHandled;
- (void)_startAccessoryFinderTimer;
- (void)_startAccessoryFinderTimerExpired;
- (void)_startScanningForAccessories:(id)accessories;
- (void)_stopTrackingRemovedHomeUserMergeId:(id)id;
- (void)_teardownRemoteAccessForHome:(id)home;
- (void)_teardownRemoteAccessForHomeCommon:(id)common isCompanion:(BOOL)companion;
- (void)_teardownRemoteAccessForHomeThroughCompanion:(id)companion;
- (void)_trackRemovedHomeUserMergeId:(id)id;
- (void)_updateCurrentHomeIfNecessary;
- (void)_updateGenerationCounterWithReason:(id)reason sourceUUID:(id)d shouldNotifyClients:(BOOL)clients;
- (void)_updateHome:(id)home configurationVersion:(int64_t)version;
- (void)_updateHomesDiscoveredBonjourServicesMetrics;
- (void)_updatePreferencesAndPostNotificationIfNecessary;
- (void)_updateResidentEnabledOnThisDevice:(BOOL)device forceNotify:(BOOL)notify message:(id)message;
- (void)_updateUserPushCachedForUser:(id)user device:(id)device;
- (void)accessoriesAreLocallyReachableOnTransientDevice:(BOOL)device forHome:(id)home;
- (void)accessoryBrowserDidFindNewAccessory;
- (void)accountAvailabilityChanged:(id)changed;
- (void)addAccessorySetupMetricDispatcher:(id)dispatcher;
- (void)addHome:(id)home;
- (void)addIssuerKeyToMessagePayload:(id)payload invitation:(id)invitation completion:(id)completion;
- (void)addSharedUserAcceptEventBuilder:(id)builder forHomeUuid:(id)uuid;
- (void)addTransactionAfterPush:(id)push;
- (void)addWalletKeyWithHomeUUID:(id)d reason:(id)reason;
- (void)applyOnboardingSelections:(id)selections accessoryUUID:(id)d homeUUID:(id)iD completion:(id)completion;
- (void)archiveServerToken:(id)token;
- (void)assistantSyncDataChanged:(id)changed;
- (void)atHomeLevelChanged:(int64_t)changed formerLevel:(int64_t)level home:(id)home;
- (void)auditAccessForUsersForHome:(id)home;
- (void)auditDuplicatePreviouslyAddedAccessory:(id)accessory;
- (void)autoAddWalletKeysOncePerDeviceSetup;
- (void)checkAndProcessHH2UpgradeRecommendation;
- (void)checkAndPushMetadataToUser:(id)user destination:(id)destination userInfo:(id)info;
- (void)checkForRemotePeers;
- (void)cleanupLocalConfiguration;
- (void)clearMediaSystemHints:(BOOL)hints;
- (void)cloudHomeSettingsUpdated:(id)updated;
- (void)configureForWalletKey;
- (void)configureSwiftExtensions;
- (void)dataSyncInProgressUpdatedNotification:(id)notification;
- (void)dealloc;
- (void)deleteAllZonesFromContainer:(id)container;
- (void)deleteZonesFromLegacyAndCameraContainers;
- (void)deregisterForMessagesInDemoModeV2;
- (void)deregisterForSignificantTimeChangeNotification;
- (void)detectAndHandleExcessiveHistoryPruning;
- (void)determineDataSyncSateForHH2:(BOOL *)h2 homeManagerDataSyncState:(unint64_t *)state homeManagerStatus:(unint64_t *)status;
- (void)dismissBulletinOnAllMyTransientDevicesWithContext:(id)context;
- (void)dmHandleRequestAddHome:(id)home;
- (void)dmHandleRequestRemoveHome:(id)home;
- (void)dmKickClients;
- (void)dm_transactionObjectRemoved:(id)removed message:(id)message;
- (void)dm_transactionObjectUpdated:(id)updated newValues:(id)values message:(id)message;
- (void)electDeviceForHH1User:(id)user destination:(id)destination deviceCapabilities:(id)capabilities queue:(id)queue completionHandler:(id)handler;
- (void)electDeviceForUser:(id)user destination:(id)destination deviceCapabilities:(id)capabilities responseTimeout:(double)timeout queue:(id)queue completionHandler:(id)handler;
- (void)enableUserListeningHistoryForHomeUUID:(id)d accessoryUUID:(id)iD userUUID:(id)uID;
- (void)fetchAndRemoveAllZonesFromDatabase:(id)database;
- (void)fetchAndUpdatePCSStatus;
- (void)fetchDiagnosticStateWithOptions:(unint64_t)options accessoryUUID:(id)d additionalFetchKeys:(id)keys filteringKeyPaths:(id)paths remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)restriction completion:(id)completion;
- (void)fetchSetupDiagnosticStateWithOptions:(unint64_t)options accessoryUUID:(id)d remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)restriction completion:(id)completion;
- (void)findAccessoriesNotOnWiFiWithCurrentWiFi:(HMFWiFiNetworkInfo *)fi completionHandler:(id)handler;
- (void)fragmentationStream:(id)stream didCloseWithError:(id)error;
- (void)fragmentationStream:(id)stream didReceiveData:(id)data transactionIdentifier:(unsigned __int16)identifier error:(id)error;
- (void)handleAcceptRequestForIDSInvitationWithIdentifier:(id)identifier homeUUID:(id)d payload:(id)payload fromAddress:(id)address fromMergeID:(id)iD;
- (void)handleAddMediaSystemHints:(id)hints;
- (void)handleAutoAddWalletKeySupressionAssertionAcquireMessage:(id)message;
- (void)handleAutoAddWalletKeySupressionAssertionReleaseMessage:(id)message;
- (void)handleCancelRequestForIDSInvitationWithIdentifier:(id)identifier;
- (void)handleCheckIsUsingProductionObjectModelMessage:(id)message;
- (void)handleContactStoreChanged:(id)changed;
- (void)handleDeclineRequestForIDSInvitationWithIdentifier:(id)identifier fromAddress:(id)address homeUUID:(id)d;
- (void)handleDeleteModelMessage:(id)message;
- (void)handleDumpDatabaseMessage:(id)message;
- (void)handleFindVendorAccessoryRequest:(id)request;
- (void)handleHomeCurrentDeviceResidentEligibleNotification:(id)notification;
- (void)handleHomeOrResidentUpdated:(id)updated;
- (void)handleHomeOrResidentsChanged;
- (void)handleLocalEnergyKitClearAllMessage:(id)message;
- (void)handleMetadataDictionary:(id)dictionary message:(id)message;
- (void)handleReceivedIDSInviteFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload;
- (void)handleRemoteEnergyKitClearAllMessage:(id)message;
- (void)handleRemoteUserClientCloudShareRepairRequest:(id)request;
- (void)handleRemoteUserClientCloudShareRequest:(id)request;
- (void)handleRemoveMediaSystemHints:(id)hints;
- (void)handleRollPreferredHH2ControllerKeyMessage:(id)message;
- (void)handleSiriSyncDataRequest:(id)request;
- (void)handleVendorInfoUpdated:(id)updated;
- (void)handleXPCConnectionDeactivatedNotification:(id)notification;
- (void)hh2FirstCKImportFinished;
- (void)homeModelHomeDelete:(id)delete message:(id)message;
- (void)homeModelHomeUpdate:(id)update message:(id)message;
- (void)idsServerBagDidUpdate:(id)update;
- (void)initHomeManagerFrameworkNotify;
- (void)initHomeManagerStartup;
- (void)initSwiftExtensions;
- (void)initializeHH2FrameworkSwitch;
- (void)initializeMediaGroupParticipantDataLocalStorage;
- (void)invalidate;
- (void)mediaGroupParticipantLocalDataStorage:(id)storage didChangeDestinationIdentifier:(id)identifier forDestinationControllerIdentifier:(id)controllerIdentifier;
- (void)memoryMonitor:(id)monitor didReceiveMemoryEvent:(int64_t)event;
- (void)migrateLocalHomeTheaterDataForCurrentAccessory:(id)accessory currentMediaSystem:(id)system;
- (void)migrateLocalMediaGroupParticipantData;
- (void)migrateLocalStereoPairDataForCurrentMediaSystem:(id)system;
- (void)migrateSharedUserFromIncomingInvitation:(id)invitation;
- (void)multiUserStatusController:(id)controller statusDidChange:(int64_t)change;
- (void)networkMonitorIsReachable:(id)reachable;
- (void)networkMonitorIsUnreachable:(id)unreachable;
- (void)notifyClientsOfUserSettingsChangeWithReason:(id)reason sourceUUID:(id)d;
- (void)notifyClientsResidentCapable:(BOOL)capable;
- (void)performCleanupOnHH2Container;
- (void)performInitialGraphLoad:(id)load;
- (void)pingDevice:(id)device secure:(BOOL)secure restrictToLocalNetwork:(BOOL)network completionHandler:(id)handler;
- (void)postFinishSetupForCurrentAccessoryFollowUpIfNeeded;
- (void)postHH2AutoMigratedSuccessBulletinIfNeeded;
- (void)prepareForDiagnosticExtension:(id)extension;
- (void)processAnyPendingRequestsForRemoteAccess;
- (void)processAppDataModelRemove:(id)remove message:(id)message;
- (void)processAppDataModelUpdate:(id)update message:(id)message;
- (void)processCloudZoneModelAdd:(id)add message:(id)message;
- (void)processCloudZoneModelRemoved:(id)removed message:(id)message;
- (void)processHomeManagerModelUpdate:(id)update message:(id)message;
- (void)processHomeModelAdd:(id)add message:(id)message;
- (void)processHomeModelRemoved:(id)removed message:(id)message;
- (void)processMetadataModel:(id)model message:(id)message;
- (void)processRequestToUpdateHomeInvitation:(id)invitation invitationState:(int64_t)state homeUUID:(id)d authStatus:(id)status invitationSource:(unint64_t)source messageName:(id)name message:(id)message;
- (void)processSharedHomeModelRemoved:(id)removed message:(id)message;
- (void)processSharedHomeModelUpdate:(id)update message:(id)message;
- (void)processTransactionsFromHomeDataSync:(id)sync accessories:(id)accessories version:(int64_t)version completion:(id)completion;
- (void)purgeAllRecordZones:(id)zones fromDatabase:(id)database completionHandler:(id)handler;
- (void)purgeAllSharesFromZones:(id)zones fromDatabase:(id)database dispatchGroup:(id)group;
- (void)purgeShares:(id)shares fromDatabase:(id)database completionHandler:(id)handler;
- (void)pushChangesForHH2SharedUserLastSync:(id)sync completion:(id)completion;
- (void)pushMetadataToAllWatches;
- (void)registerForSignificantTimeChangeNotification;
- (void)registerNotificationsForPowerManagement;
- (void)removeAccessorySetupMetricDispatcherForAccessoryUUID:(id)d;
- (void)removeAllHomeKitPairingIdentitiesAfterSignOut;
- (void)removeFromUnassociatedPeers:(id)peers home:(id)home;
- (void)removeHome:(id)home;
- (void)removeHomeFromAwaitingAutoAcceptHomes:(id)homes;
- (void)removeHomeFromSharedHomesNotYetMigrated:(id)migrated;
- (void)removeHomeWalletKeysExcludingSerialNumbers:(id)numbers flow:(id)flow;
- (void)removeSharedUserAcceptEventBuilderForHomeUuid:(id)uuid;
- (void)requestAccessoryBrowsing;
- (void)resetHomeConfigForHH2:(BOOL)h2 message:(id)message;
- (void)resetTTSUHH2SettingsMigrationKey;
- (void)runTransactionForAddHomeMessage:(id)message withInitialHomeObjects:(id)objects homeManagerModel:(id)model homeManagerHomeModel:(id)homeModel homeBackingStore:(id)store homeUUID:(id)d homeName:(id)name makeNewHomePrimaryHome:(BOOL)self0;
- (void)saveAssistantSyncDataPostedToWorkingStore;
- (void)saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:(id)accessory;
- (void)saveMediaSystemHintsWithHomeUUIDString:(id)string mediaSystemUUIDString:(id)dString peerAccessoryUUIDString:(id)iDString peerAccessoryRoleString:(id)roleString persistToDisk:(BOOL)disk;
- (void)scheduleAddACWGKeysOperationIfAllowed;
- (void)scheduleRemovalForHome:(id)home message:(id)message options:(id)options;
- (void)sendFragmentedMessageForData:(id)data objectUUID:(id)d withMessageName:(id)name toUser:(id)user destination:(id)destination completionHandler:(id)handler;
- (void)sendHomeDataToAllWatchesWithCompletion:(id)completion;
- (void)sendPairingIdentity:(id)identity includePrivateKey:(BOOL)key requestMessage:(id)message;
- (void)sendRequestForInvitation:(id)invitation homeUUID:(id)d payload:(id)payload invitationState:(int64_t)state responseHandler:(id)handler;
- (void)sendSecureMessage:(id)message target:(id)target userID:(id)d destination:(id)destination responseQueue:(id)queue responseHandler:(id)handler;
- (void)sendUnsecureMessage:(id)message target:(id)target userID:(id)d responseQueue:(id)queue responseHandler:(id)handler;
- (void)sendUserAdded:(id)added destination:(id)destination toHome:(id)home;
- (void)sendUserRemoved:(id)removed fromHome:(id)home pairingUsername:(id)username pushToCloud:(BOOL)cloud completionHandler:(id)handler;
- (void)setAccessAllowedWhenLocked:(BOOL)locked;
- (void)setAppDataWithMessage:(id)message;
- (void)setCurrentHomeUUID:(id)d;
- (void)setCurrentHomeUUIDOverride:(id)override;
- (void)setGenerationCounter:(unint64_t)counter;
- (void)setHomeOwnerCloudShareManager:(id)manager;
- (void)setHomeSharedUserCloudShareManager:(id)manager;
- (void)setHomes:(id)homes;
- (void)setNeedsOnboardingCompleteWitHomeUUID:(id)d accessoryUUID:(id)iD completion:(id)completion;
- (void)setOverrideCurrentHomeUUIDToNil:(id)nil;
- (void)setPostSyncDataUpdatedNotification:(BOOL)notification;
- (void)setSetupEndTimestamp:(double)timestamp;
- (void)setSetupStartTimestamp:(double)timestamp;
- (void)setupSession:(id)session didCloseWithError:(id)error;
- (void)setupSession:(id)session didReceiveAccessoryWithUUID:(id)d;
- (void)startFindMyHandler;
- (void)startIndexing;
- (void)startWithCompletionHandler:(id)handler;
- (void)syncWalletKeyPassSerialNumbersToWatch:(id)watch withCompletion:(id)completion;
- (void)teardownRemoteAccessForHome:(id)home;
- (void)timerDidFire:(id)fire;
- (void)transactionObjectRemoved:(id)removed message:(id)message;
- (void)transactionObjectUpdated:(id)updated newValues:(id)values message:(id)message;
- (void)updateAccessoryModelsFromContext:(id)context;
- (void)updateGenerationCounterWithReason:(id)reason sourceUUID:(id)d shouldNotifyClients:(BOOL)clients;
- (void)updateHomeKitInUsePreferences;
- (void)updatePowerAssertion;
- (void)updateUserPushCachedForUser:(id)user device:(id)device;
- (void)verifyCurrentDeviceResidentStatus;
- (void)waitForHH2SentinelZoneToBeRemoved;
- (void)writeAssistantCurrentHome:(id)home;
@end

@implementation HMDHomeManager

- (NSArray)homes
{
  os_unfair_lock_lock_with_options();
  v3 = [(NSMutableArray *)self->_homes copy];
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

+ (id)logCategory
{
  if (logCategory__hmf_once_t14_255193 != -1)
  {
    dispatch_once(&logCategory__hmf_once_t14_255193, &__block_literal_global_488_255194);
  }

  v3 = logCategory__hmf_once_v15_255195;

  return v3;
}

- (void)deregisterForMessagesInDemoModeV2
{
  selfCopy = self;
  sub_229590D4C();
}

- (BOOL)hasDemoAccessories
{
  selfCopy = self;
  v3 = sub_229591184();

  return v3 & 1;
}

- (HMDDemoModeManagerDataSource)demoModeDataSource
{
  if (qword_27D87F8F8)
  {
    v2 = qword_27D87F8F8;
  }

  else
  {
    if (qword_281402220 != -1)
    {
      swift_once();
    }

    v2 = qword_281402230;
    swift_unknownObjectRetain();
  }

  swift_unknownObjectRetain();

  return v2;
}

- (_TtCE13HomeKitDaemonCSo14HMDHomeManagerP33_A2017DEA629FAA91F481E814718C0BF815SwiftExtensions)_swiftExtensions
{
  selfCopy = self;
  result = [(HMDHomeManager *)selfCopy swiftExtensions];
  if (result)
  {
    sub_22A4DE01C();
    swift_unknownObjectRelease();

    sub_229543C58(v5, v6);
    _s15SwiftExtensionsCMa();
    swift_dynamicCast();

    return v4;
  }

  else
  {
    __break(1u);
  }

  return result;
}

- (void)initSwiftExtensions
{
  selfCopy = self;
  sub_2296BA018();
}

- (void)configureSwiftExtensions
{
  selfCopy = self;
  sub_2296BA158();
}

- (void)findAccessoriesNotOnWiFiWithCurrentWiFi:(HMFWiFiNetworkInfo *)fi completionHandler:(id)handler
{
  v7 = __swift_instantiateConcreteTypeFromMangledNameV2(&unk_27D87D8F0, &qword_22A578D70);
  v8 = *(*(v7 - 8) + 64);
  MEMORY[0x28223BE20](v7 - 8);
  v10 = &v18 - v9;
  v11 = _Block_copy(handler);
  v12 = swift_allocObject();
  v12[2] = fi;
  v12[3] = v11;
  v12[4] = self;
  v13 = sub_22A4DD9DC();
  (*(*(v13 - 8) + 56))(v10, 1, 1, v13);
  v14 = swift_allocObject();
  v14[2] = 0;
  v14[3] = 0;
  v14[4] = &unk_22A57DFA0;
  v14[5] = v12;
  v15 = swift_allocObject();
  v15[2] = 0;
  v15[3] = 0;
  v15[4] = &unk_22A57B590;
  v15[5] = v14;
  fiCopy = fi;
  selfCopy = self;
  sub_229859F70(0, 0, v10, &unk_22A581CC0, v15);
}

- (void)startFindMyHandler
{
  v2 = __swift_instantiateConcreteTypeFromMangledNameV2(&unk_27D87D8F0, &qword_22A578D70);
  v3 = *(*(v2 - 8) + 64);
  MEMORY[0x28223BE20](v2 - 8);
  v5 = &v8 - v4;
  v6 = sub_22A4DD9DC();
  (*(*(v6 - 8) + 56))(v5, 1, 1, v6);
  v7 = swift_allocObject();
  *(v7 + 16) = 0;
  *(v7 + 24) = 0;
  sub_22957F3C0(0, 0, v5, &unk_22A57DF90, v7);
}

- (BOOL)isThisDesignatedFMFDevice
{
  selfCopy = self;
  fmfHandler = [(HMDHomeManager *)selfCopy fmfHandler];
  if (fmfHandler)
  {
    isThisDesignatedFMFDevice = [(HMDFMFHandlerProtocol *)fmfHandler isThisDesignatedFMFDevice];

    swift_unknownObjectRelease();
    LOBYTE(fmfHandler) = isThisDesignatedFMFDevice;
  }

  else
  {
    __break(1u);
  }

  return fmfHandler;
}

- (void)startIndexing
{
  v3 = __swift_instantiateConcreteTypeFromMangledNameV2(&unk_27D87D8F0, &qword_22A578D70);
  v4 = *(*(v3 - 8) + 64);
  MEMORY[0x28223BE20](v3 - 8);
  v6 = &v10 - v5;
  v7 = sub_22A4DD9DC();
  (*(*(v7 - 8) + 56))(v6, 1, 1, v7);
  v8 = swift_allocObject();
  v8[2] = 0;
  v8[3] = 0;
  v8[4] = self;
  selfCopy = self;
  sub_22957F6B0(0, 0, v6, &unk_22A57DF80, v8);
}

- (void)handleRemoteEnergyKitClearAllMessage:(id)message
{
  messageCopy = message;
  selfCopy = self;
  sub_229787320(messageCopy);
}

- (void)handleLocalEnergyKitClearAllMessage:(id)message
{
  messageCopy = message;
  selfCopy = self;
  sub_22978880C(messageCopy);
}

- (void)handleFindVendorAccessoryRequest:(id)request
{
  v5 = __swift_instantiateConcreteTypeFromMangledNameV2(&unk_27D87D8F0, &qword_22A578D70);
  v6 = *(*(v5 - 8) + 64);
  MEMORY[0x28223BE20](v5 - 8);
  v8 = &v13 - v7;
  v9 = sub_22A4DD9DC();
  (*(*(v9 - 8) + 56))(v8, 1, 1, v9);
  v10 = swift_allocObject();
  v10[2] = 0;
  v10[3] = 0;
  v10[4] = self;
  v10[5] = request;
  requestCopy = request;
  selfCopy = self;
  sub_22957F3C0(0, 0, v8, &unk_22A582FD0, v10);
}

- (void)_handleSignificantTimeChange
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

void __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke(uint64_t a1)
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v1 = [*(a1 + 32) homes];
  v2 = [v1 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v2)
  {
    v3 = v2;
    v4 = *v11;
    do
    {
      for (i = 0; i != v3; ++i)
      {
        if (*v11 != v4)
        {
          objc_enumerationMutation(v1);
        }

        v6 = *(*(&v10 + 1) + 8 * i);
        v7 = [v6 workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke_2;
        block[3] = &unk_27868A728;
        block[4] = v6;
        dispatch_async(v7, block);
      }

      v3 = [v1 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v3);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)deregisterForSignificantTimeChangeNotification
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEBUG, "%{public}@De-Registering for Significant time change event.", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  DarwinNotifyCenter = CFNotificationCenterGetDarwinNotifyCenter();
  CFNotificationCenterRemoveObserver(DarwinNotifyCenter, selfCopy, @"SignificantTimeChangeNotification", 0);
  v8 = *MEMORY[0x277D85DE8];
}

- (void)registerForSignificantTimeChangeNotification
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEBUG, "%{public}@Registering for Significant time change event.", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  DarwinNotifyCenter = CFNotificationCenterGetDarwinNotifyCenter();
  CFNotificationCenterAddObserver(DarwinNotifyCenter, selfCopy, significantTimeDidChangeNotification, @"SignificantTimeChangeNotification", 0, CFNotificationSuspensionBehaviorDeliverImmediately);
  v8 = *MEMORY[0x277D85DE8];
}

- (void)_handleAppleMediaResidentCoreDataChanges:(id)changes
{
  changesCopy = changes;
  object = [changesCopy object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = object;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  v8 = +[HMDCoreData sharedInstance];
  v9 = [v8 isRelatedContext:v7];

  if (v9)
  {
    v10 = objc_autoreleasePoolPush();
    userInfo = [changesCopy userInfo];
    v12 = [userInfo objectForKeyedSubscript:*MEMORY[0x277CBE188]];

    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v13 = v12;
    }

    else
    {
      v13 = 0;
    }

    v14 = v13;

    userInfo2 = [changesCopy userInfo];
    v16 = [userInfo2 objectForKeyedSubscript:*MEMORY[0x277CBE310]];

    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v17 = v16;
    }

    else
    {
      v17 = 0;
    }

    v18 = v17;

    v23 = 0;
    v24 = &v23;
    v25 = 0x2020000000;
    v26 = 0;
    v19 = [v18 setByAddingObjectsFromSet:v14];
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __71__HMDHomeManager_AppleMedia___handleAppleMediaResidentCoreDataChanges___block_invoke;
    v22[3] = &unk_278671420;
    v22[4] = self;
    v22[5] = &v23;
    [v19 hmf_enumerateWithAutoreleasePoolUsingBlock:v22];

    if (*(v24 + 24) == 1)
    {
      workContext = [(HMDHomeManager *)self workContext];
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __71__HMDHomeManager_AppleMedia___handleAppleMediaResidentCoreDataChanges___block_invoke_95;
      v21[3] = &unk_27868A728;
      v21[4] = self;
      [workContext performBlock:v21];
    }

    _Block_object_dispose(&v23, 8);

    objc_autoreleasePoolPop(v10);
  }
}

void __71__HMDHomeManager_AppleMedia___handleAppleMediaResidentCoreDataChanges___block_invoke(uint64_t a1, void *a2, _BYTE *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = *(a1 + 32);
  v7 = v5;
  v8 = v7;
  if (v6)
  {
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v9 = v8;
    }

    else
    {
      v9 = 0;
    }

    v10 = v9;
    v11 = v10;
    if (v10)
    {
      v6 = [v10 castIfResident];
    }

    else
    {
      v6 = 0;
    }

    if (v6)
    {
      v12 = [v6 device];

      if (!v12)
      {
        v13 = [v6 appleMediaAccessory];
        v14 = [v13 device];

        if (v14)
        {
          *(*(*(a1 + 40) + 8) + 24) = 1;
          *a3 = 1;
          v15 = objc_autoreleasePoolPush();
          v16 = *(a1 + 32);
          v17 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
          {
            v18 = HMFGetLogIdentifier();
            v20 = 138543874;
            v21 = v18;
            v22 = 2112;
            v23 = v6;
            v24 = 2112;
            v25 = v13;
            _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Scheduling scan due to found resident with no device (%@) belonging to an apple media accessory with a device: %@", &v20, 0x20u);
          }

          objc_autoreleasePoolPop(v15);
        }
      }
    }
  }

  else
  {
  }

  v19 = *MEMORY[0x277D85DE8];
}

void __71__HMDHomeManager_AppleMedia___handleAppleMediaResidentCoreDataChanges___block_invoke_95(uint64_t a1)
{
  v1 = *(a1 + 32);
  v2 = [v1 workContext];
  [v1 updateAccessoryModelsFromContext:v2];
}

- (void)updateAccessoryModelsFromContext:(id)context
{
  contextCopy = context;
  [contextCopy assertIsExecuting];
  if (![(HMDHomeManager *)self haveQueuedUpdateAccessories])
  {
    [(HMDHomeManager *)self setHaveQueuedUpdateAccessories:1];
    objc_initWeak(&location, self);
    startupCompleted = [(HMDHomeManager *)self startupCompleted];
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __63__HMDHomeManager_AppleMedia__updateAccessoryModelsFromContext___block_invoke;
    v7[3] = &unk_278685A80;
    objc_copyWeak(&v8, &location);
    v6 = [startupCompleted inContext:contextCopy then:v7];

    objc_destroyWeak(&v8);
    objc_destroyWeak(&location);
  }
}

uint64_t __63__HMDHomeManager_AppleMedia__updateAccessoryModelsFromContext___block_invoke(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    LODWORD(v12) = 138543362;
    *(&v12 + 4) = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Scanning for accessories to update", &v12, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  if (v6)
  {
    v9 = [v6 workContext];
    *&v12 = MEMORY[0x277D85DD0];
    *(&v12 + 1) = 3221225472;
    v13 = __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke;
    v14 = &unk_27868A728;
    v15 = v6;
    [v9 performBlock:&v12];
  }

  [v6 setHaveQueuedUpdateAccessories:0];

  v10 = *MEMORY[0x277D85DE8];
  return 1;
}

void __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) homes];
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke_2;
  v3[3] = &unk_278685B78;
  v3[4] = *(a1 + 32);
  [v2 hmf_enumerateWithAutoreleasePoolUsingBlock:v3];
}

void __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke_2(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [v3 owner];
  v5 = [v4 account];

  v6 = [v5 modelIdentifier];

  if (v6)
  {
    v7 = [v3 accessories];
    v14[0] = MEMORY[0x277D85DD0];
    v14[1] = 3221225472;
    v14[2] = __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke_77;
    v14[3] = &unk_2786713D0;
    v14[4] = *(a1 + 32);
    v15 = v3;
    v16 = v5;
    [v7 hmf_enumerateWithAutoreleasePoolUsingBlock:v14];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 32);
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [v3 shortDescription];
      *buf = 138543618;
      v18 = v11;
      v19 = 2112;
      v20 = v12;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Not updating accessories for home %@ ownerAccount.modelIdentifier is nil", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager_AppleMedia____scanForAccessoriesToUpdate__block_invoke_77(uint64_t a1, void *a2)
{
  v13 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v13;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;
  if (v4)
  {
    v5 = *(a1 + 32);
    v6 = *(a1 + 48);
    v7 = *(a1 + 40);
    v8 = v6;
    v9 = v4;
    if (v5)
    {
      v10 = [v7 homeManager];
      v11 = [v10 backingStore];
      v12 = [v11 context];
      v14[0] = MEMORY[0x277D85DD0];
      v14[1] = 3221225472;
      v14[2] = __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke;
      v14[3] = &unk_2786891E0;
      v15 = v8;
      v16 = v9;
      v17 = v7;
      v18 = v5;
      [v12 performBlock:v14];
    }
  }
}

void __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke(uint64_t a1)
{
  v26 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) modelIdentifier];
  v3 = [HMCContext findAccountWithModelID:v2];

  if (v3)
  {
    v18 = 0;
    v19 = &v18;
    v20 = 0x2020000000;
    v21 = 0;
    v4 = [v3 devices];
    v13[0] = MEMORY[0x277D85DD0];
    v13[1] = 3221225472;
    v13[2] = __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke_2;
    v13[3] = &unk_2786713A8;
    v14 = *(a1 + 40);
    v17 = &v18;
    v5 = *(a1 + 48);
    v6 = *(a1 + 56);
    v15 = v5;
    v16 = v6;
    [v4 hmf_enumerateWithAutoreleasePoolUsingBlock:v13];

    if ((v19[3] & 1) == 0)
    {
      v7 = objc_autoreleasePoolPush();
      v8 = *(a1 + 48);
      v9 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
      {
        v10 = HMFGetLogIdentifier();
        v11 = *(a1 + 40);
        *buf = 138543618;
        v23 = v10;
        v24 = 2112;
        v25 = v11;
        _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Unable to find MKFDevice for accessory %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v7);
    }

    _Block_object_dispose(&v18, 8);
  }

  v12 = *MEMORY[0x277D85DE8];
}

void __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke_2(uint64_t a1, void *a2, uint64_t a3, _BYTE *a4)
{
  v6 = a2;
  v7 = [v6 mediaRouteID];
  v8 = [v7 UUIDString];
  v9 = [*(a1 + 32) identifier];
  v10 = [v8 isEqual:v9];

  if (v10)
  {
    *(*(*(a1 + 56) + 8) + 24) = 1;
    *a4 = 1;
    v11 = [v6 databaseID];
    v12 = [v6 identifier];
    v13 = [*(a1 + 40) backingStore];
    v14 = [v13 context];

    v18[0] = MEMORY[0x277D85DD0];
    v18[1] = 3221225472;
    v18[2] = __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke_3;
    v18[3] = &unk_278683598;
    v19 = *(a1 + 32);
    v20 = v12;
    v21 = *(a1 + 40);
    v22 = v11;
    v23 = *(a1 + 48);
    v24 = v14;
    v15 = v14;
    v16 = v11;
    v17 = v12;
    [v15 performBlock:v18];
  }
}

void __84__HMDHomeManager_AppleMedia____updateAccessoryDeviceForHome_ownerAccount_accessory___block_invoke_3(uint64_t a1)
{
  v83 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) uuid];
  v3 = [HMCContext findAppleMediaAccessoryWithModelID:v2];

  v4 = [v3 device];

  v5 = [v3 idsIdentifier];

  v6 = [v3 resident];
  v7 = v6;
  if (v6)
  {
    v8 = [v6 device];
    v72 = v8 == 0;

    v9 = [v7 idsIdentifier];
    v10 = v9 == 0;
  }

  else
  {
    v10 = 0;
    v72 = 0;
  }

  v11 = +[HMDAccountRegistry sharedRegistry];
  v12 = a1;
  v13 = [v11 deviceForIdentifier:*(a1 + 40)];

  v14 = v13;
  v15 = [v13 globalDestination];
  v74 = v3;
  v16 = [v3 idsDestination];
  v17 = HMFEqualObjects();

  v73 = v7;
  if (v7)
  {
    v18 = [v7 idsDestination];
    v19 = v15;
    v20 = HMFEqualObjects();

    v21 = v20 ^ 1;
  }

  else
  {
    v19 = v15;
    v21 = 0;
  }

  if (v4)
  {
    v22 = v5 == 0;
  }

  else
  {
    v22 = 1;
  }

  v23 = v22;
  v24 = v12;
  if (v23 & 1 | ((v17 & 1) == 0) | (v72 || v10) || (v21 & 1) != 0)
  {
    v33 = [HMCContext findDeviceWithDatabaseID:*(v12 + 56)];
    v29 = v14;
    if (v33)
    {
      v34 = [(HMDHomeManager *)*(v12 + 64) __shouldScanAndUpdateDeviceInfoForDevice:v14];
      v35 = objc_autoreleasePoolPush();
      v36 = *(v12 + 48);
      v37 = HMFGetOSLogHandle();
      v38 = v37;
      v31 = v19;
      if (v34)
      {
        v32 = v74;
        if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
        {
          v39 = HMFGetLogIdentifier();
          v40 = *(v12 + 32);
          *buf = 138543874;
          v76 = v39;
          v77 = 2112;
          v78 = v40;
          v79 = 2112;
          v80 = v33;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_DEFAULT, "%{public}@Updating accessory %@ with device %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v35);
        [v74 setDevice:v33];
        v41 = [v74 resident];

        if (v41)
        {
          v42 = [v74 resident];
          [v42 setDevice:v33];

          v43 = objc_autoreleasePoolPush();
          v44 = *(v24 + 48);
          v45 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
          {
            v46 = HMFGetLogIdentifier();
            v47 = [v74 resident];
            *buf = 138543874;
            v76 = v46;
            v77 = 2112;
            v78 = v47;
            v79 = 2112;
            v80 = v33;
            _os_log_impl(&dword_229538000, v45, OS_LOG_TYPE_DEFAULT, "%{public}@Updating accessory's resident %@ with device %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v43);
        }

        v28 = v73;
        if (v29)
        {
          v48 = [v29 idsIdentifier];
          if (v48)
          {
            v49 = objc_autoreleasePoolPush();
            v50 = *(v24 + 48);
            v51 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
            {
              v52 = HMFGetLogIdentifier();
              *buf = 138544130;
              v76 = v52;
              v77 = 2160;
              v78 = 1752392040;
              v79 = 2112;
              v80 = v48;
              v81 = 2112;
              v82 = v74;
              _os_log_impl(&dword_229538000, v51, OS_LOG_TYPE_DEFAULT, "%{public}@Setting IDS identifier=%{mask.hash}@ from apple media scan for accessory: %@", buf, 0x2Au);
            }

            objc_autoreleasePoolPop(v49);
            [v74 setIdsIdentifier:v48];
            v53 = [v74 resident];
            [v53 setIdsIdentifier:v48];

            v28 = v73;
          }

          if (v31)
          {
            v54 = objc_autoreleasePoolPush();
            v55 = *(v24 + 48);
            v56 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
            {
              v57 = HMFGetLogIdentifier();
              *buf = 138544130;
              v76 = v57;
              v77 = 2160;
              v78 = 1752392040;
              v79 = 2112;
              v80 = v31;
              v81 = 2112;
              v82 = v74;
              _os_log_impl(&dword_229538000, v56, OS_LOG_TYPE_DEFAULT, "%{public}@Setting IDS destination=%{mask.hash}@ from apple media scan for accessory: %@", buf, 0x2Au);
            }

            objc_autoreleasePoolPop(v54);
            [v74 setIdsDestination:v31];
            v58 = [v74 resident];
            [v58 setIdsDestination:v31];

            v28 = v73;
          }
        }

        else
        {
          v65 = objc_autoreleasePoolPush();
          v66 = *(v24 + 48);
          v67 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v67, OS_LOG_TYPE_ERROR))
          {
            v68 = HMFGetLogIdentifier();
            [v33 identifier];
            v70 = v69 = v65;
            *buf = 138543618;
            v76 = v68;
            v77 = 2112;
            v78 = v70;
            _os_log_impl(&dword_229538000, v67, OS_LOG_TYPE_ERROR, "%{public}@Unable to find device to set IDS identifiers: %@", buf, 0x16u);

            v65 = v69;
            v28 = v73;
          }

          objc_autoreleasePoolPop(v65);
        }

        [*(v24 + 72) save];
      }

      else
      {
        v32 = v74;
        if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
        {
          v64 = HMFGetLogIdentifier();
          *buf = 138543618;
          v76 = v64;
          v77 = 2112;
          v78 = v29;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_INFO, "%{public}@Do not update IDS tokens for MKF models for device: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v35);
        v28 = v73;
      }
    }

    else
    {
      v59 = objc_autoreleasePoolPush();
      v60 = *(v12 + 48);
      v61 = HMFGetOSLogHandle();
      v31 = v19;
      if (os_log_type_enabled(v61, OS_LOG_TYPE_ERROR))
      {
        v62 = HMFGetLogIdentifier();
        v63 = *(v12 + 56);
        *buf = 138543618;
        v76 = v62;
        v77 = 2112;
        v78 = v63;
        _os_log_impl(&dword_229538000, v61, OS_LOG_TYPE_ERROR, "%{public}@Lost the device that was here a second ago: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v59);
      v28 = v73;
      v32 = v74;
    }
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = *(v12 + 48);
    v27 = HMFGetOSLogHandle();
    v28 = v73;
    v29 = v14;
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543618;
      v76 = v30;
      v77 = 2112;
      v78 = v74;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_DEBUG, "%{public}@Not updating accessory because it and its resident already has a device and ids information set: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v31 = v19;
    v32 = v74;
  }

  v71 = *MEMORY[0x277D85DE8];
}

- (uint64_t)__shouldScanAndUpdateDeviceInfoForDevice:(void *)device
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = v3;
  v5 = 0;
  if (device && v3)
  {
    productInfo = [v3 productInfo];

    if (!productInfo)
    {
      v17 = objc_autoreleasePoolPush();
      deviceCopy = device;
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        *v23 = 138543618;
        *&v23[4] = v20;
        *&v23[12] = 2112;
        *&v23[14] = v4;
        _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@ProductInfo is not available for device: %@", v23, 0x16u);
      }

      objc_autoreleasePoolPop(v17);
      goto LABEL_13;
    }

    v7 = objc_alloc(MEMORY[0x277D0F8F8]);
    *v23 = *MEMORY[0x277D0F588];
    *&v23[16] = *(MEMORY[0x277D0F588] + 16);
    v8 = [v7 initWithOperatingSystemVersion:v23];
    v9 = objc_alloc(MEMORY[0x277D0F8F8]);
    *v23 = *MEMORY[0x277D0F550];
    *&v23[16] = *(MEMORY[0x277D0F550] + 16);
    v10 = [v9 initWithOperatingSystemVersion:v23];
    productInfo2 = [v4 productInfo];
    softwareVersion = [productInfo2 softwareVersion];

    if ([softwareVersion isAtLeastVersion:v8] && objc_msgSend(v10, "isGreaterThanVersion:", softwareVersion))
    {
      v13 = objc_autoreleasePoolPush();
      deviceCopy2 = device;
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *v23 = 138543618;
        *&v23[4] = v16;
        *&v23[12] = 2112;
        *&v23[14] = softwareVersion;
        _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Scan and update device address for software version: %@", v23, 0x16u);
      }

      objc_autoreleasePoolPop(v13);
LABEL_13:
      v5 = 1;
      goto LABEL_14;
    }

    v5 = 0;
  }

LABEL_14:

  v21 = *MEMORY[0x277D85DE8];
  return v5;
}

- (id)updateMediaRouteIDOfDeviceWithIdentifier:(id)identifier
{
  v30 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v8;
    v28 = 2112;
    v29 = identifierCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Updating capabilities for device with identifier: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = +[HMDAccountRegistry sharedRegistry];
  v10 = [v9 deviceForIdentifier:identifierCopy];

  if (v10)
  {
    if (([(HMDHomeManager *)selfCopy __shouldScanAndUpdateDeviceInfoForDevice:v10]& 1) != 0)
    {
      v11 = [(HMDHomeManager *)selfCopy queryDeviceCapabilities:v10];
      v12 = +[HMCContext currentContext];
      objc_initWeak(buf, selfCopy);
      v22[0] = MEMORY[0x277D85DD0];
      v22[1] = 3221225472;
      v22[2] = __71__HMDHomeManager_AppleMedia__updateMediaRouteIDOfDeviceWithIdentifier___block_invoke;
      v22[3] = &unk_2786713F8;
      objc_copyWeak(&v25, buf);
      v23 = identifierCopy;
      v13 = v12;
      v24 = v13;
      v14 = [v11 inContext:v13 then:v22];

      objc_destroyWeak(&v25);
      objc_destroyWeak(buf);

      goto LABEL_11;
    }

    futureWithNoValue = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = selfCopy;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543618;
      v27 = v18;
      v28 = 2112;
      v29 = identifierCopy;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Unable to find device: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    futureWithNoValue = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  v14 = futureWithNoValue;
LABEL_11:

  v20 = *MEMORY[0x277D85DE8];

  return v14;
}

uint64_t __71__HMDHomeManager_AppleMedia__updateMediaRouteIDOfDeviceWithIdentifier___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v9 = *(a1 + 32);
    v22 = 138543874;
    v23 = v8;
    v24 = 2112;
    v25 = v9;
    v26 = 2112;
    v27 = v3;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Resolved capabilities for device %@: %@", &v22, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = [v3 modelID];
  v11 = [HMCContext findDeviceWithModelID:v10];

  if (v11)
  {
    v12 = [v11 mediaRouteID];

    if (!v12)
    {
      v13 = [v3 mediaRouteUUID];
      [v11 setMediaRouteID:v13];
    }

    [*(a1 + 40) save];
    [v6 updateAccessoryModelsFromContext:*(a1 + 40)];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = v6;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      v18 = *(a1 + 32);
      v19 = [v3 modelID];
      v22 = 138543874;
      v23 = v17;
      v24 = 2112;
      v25 = v18;
      v26 = 2112;
      v27 = v19;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Unable to find MKFDevice for device identifier: %@ -- modelID: %@", &v22, 0x20u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v20 = *MEMORY[0x277D85DE8];
  return 1;
}

- (id)queryDeviceCapabilities:(id)capabilities
{
  v26 = *MEMORY[0x277D85DE8];
  capabilitiesCopy = capabilities;
  v5 = +[HMDAppleAccountManager sharedManager];
  device = [v5 device];
  v7 = [capabilitiesCopy isEqual:device];

  if (v7)
  {
    v8 = objc_alloc_init(HMDAppleMediaDeviceInfo);
    modelIdentifier = [capabilitiesCopy modelIdentifier];
    [(HMDAppleMediaDeviceInfo *)v8 setModelID:modelIdentifier];

    v10 = objc_autoreleasePoolPush();
    selfCopy = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543618;
      v23 = v13;
      v24 = 2112;
      v25 = v8;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Generating HMDAppleMediaDeviceInfo locally: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [MEMORY[0x277D0F7C0] futureWithValue:v8];
  }

  else
  {
    workContext = [(HMDHomeManager *)self workContext];
    v16 = MEMORY[0x277D0F7C0];
    v19[0] = MEMORY[0x277D85DD0];
    v19[1] = 3221225472;
    v19[2] = __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke;
    v19[3] = &unk_278686828;
    v19[4] = self;
    v20 = capabilitiesCopy;
    v21 = workContext;
    v8 = workContext;
    v14 = [v16 inContext:v8 perform:v19];
  }

  v17 = *MEMORY[0x277D85DE8];

  return v14;
}

uint64_t __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke(uint64_t a1)
{
  v31 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    *buf = 138543618;
    *&buf[4] = v5;
    v29 = 2112;
    v30 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Querying HMDAppleMediaDeviceInfo remotely to: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = [HMDRemoteDeviceMessageDestination alloc];
  v8 = [*(a1 + 32) uuid];
  v9 = [(HMDRemoteDeviceMessageDestination *)v7 initWithTarget:v8 device:*(a1 + 40)];

  v10 = [HMDRemoteMessage secureMessageWithName:@"HMDAM.g" qualityOfService:-1 destination:v9 messagePayload:MEMORY[0x277CBEC10] restriction:9];
  *buf = 0;
  v11 = [MEMORY[0x277D0F7C0] futureWithPromise:buf];
  v20 = MEMORY[0x277D85DD0];
  v21 = 3221225472;
  v22 = __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke_84;
  v23 = &unk_27867E7E8;
  v12 = *(a1 + 48);
  v13 = *(a1 + 32);
  v14 = *(a1 + 40);
  v24 = v12;
  v25 = v13;
  v26 = v14;
  v27 = *buf;
  [v10 setResponseHandler:&v20];
  v15 = [*(a1 + 32) messageDispatcher];
  [v15 sendMessage:v10];

  v16 = v11;
  if (!v16)
  {
    _HMFPreconditionFailure();
  }

  v17 = v16;

  v18 = *MEMORY[0x277D85DE8];
  return 3;
}

void __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke_84(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke_2;
  v12[3] = &unk_278689550;
  v8 = *(a1 + 32);
  v7 = *(a1 + 40);
  v9 = *(a1 + 48);
  v13 = v5;
  v14 = v7;
  v15 = v9;
  v16 = *(a1 + 56);
  v17 = v6;
  v10 = v6;
  v11 = v5;
  [v8 performBlock:v12];
}

void __54__HMDHomeManager_AppleMedia__queryDeviceCapabilities___block_invoke_2(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 40);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = HMFGetLogIdentifier();
      v6 = [*(a1 + 48) identifier];
      v7 = *(a1 + 32);
      v16 = 138543874;
      v17 = v5;
      v18 = 2112;
      v19 = v6;
      v20 = 2112;
      v21 = v7;
      _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_ERROR, "%{public}@Query of HMDAppleDeviceInfo to %@ failed: %@", &v16, 0x20u);
    }

    objc_autoreleasePoolPop(v2);
    [*(a1 + 56) rejectWithError:*(a1 + 32)];
  }

  else
  {
    v8 = [[HMDAppleMediaDeviceInfo alloc] initWithPayload:*(a1 + 64)];
    v9 = [*(a1 + 48) modelIdentifier];
    [(HMDAppleMediaDeviceInfo *)v8 setModelID:v9];

    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [*(a1 + 48) identifier];
      v16 = 138543874;
      v17 = v13;
      v18 = 2112;
      v19 = v14;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Query of HMDAppleDeviceInfo to %@ succeeded: %@", &v16, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    [*(a1 + 56) fulfillWithValue:v8];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)_handleAddedAccessory:(id)accessory
{
  userInfo = [accessory userInfo];
  v5 = [userInfo objectForKeyedSubscript:@"HMDNotificationAddedAccessoryKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  if (v7)
  {
    workContext = [(HMDHomeManager *)self workContext];
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __52__HMDHomeManager_AppleMedia___handleAddedAccessory___block_invoke;
    v9[3] = &unk_27868A750;
    v9[4] = self;
    v10 = v7;
    [workContext performBlock:v9];
  }
}

void __52__HMDHomeManager_AppleMedia___handleAddedAccessory___block_invoke(uint64_t a1)
{
  v14 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v10 = 138543618;
    v11 = v5;
    v12 = 2112;
    v13 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling scan due to accessory add: %@", &v10, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *(a1 + 32);
  v8 = [v7 workContext];
  [v7 updateAccessoryModelsFromContext:v8];

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_handleDeviceNotification:(id)notification
{
  notificationCopy = notification;
  objc_initWeak(&location, self);
  workContext = [(HMDHomeManager *)self workContext];
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke;
  v6[3] = &unk_278686B80;
  objc_copyWeak(&v7, &location);
  [workContext performBlock:v6];

  objc_destroyWeak(&v7);
  objc_destroyWeak(&location);
}

void __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v3 = +[HMDAppleAccountManager sharedManager];
  v4 = [v3 account];
  v5 = [v4 modelIdentifier];

  if (v5)
  {
    v6 = [WeakRetained backingStore];
    v7 = [v6 context];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke_2;
    v8[3] = &unk_278686B48;
    objc_copyWeak(&v10, (a1 + 32));
    v9 = v5;
    [v7 performBlock:v8];

    objc_destroyWeak(&v10);
  }
}

void __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke_2(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v3 = [HMCContext findAccountWithModelID:*(a1 + 32)];
  v4 = v3;
  if (v3)
  {
    v5 = [v3 devices];
    v6[0] = MEMORY[0x277D85DD0];
    v6[1] = 3221225472;
    v6[2] = __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke_3;
    v6[3] = &unk_278677358;
    v6[4] = WeakRetained;
    [v5 hmf_enumerateWithAutoreleasePoolUsingBlock:v6];
  }
}

void __56__HMDHomeManager_AppleMedia___handleDeviceNotification___block_invoke_3(uint64_t a1, void *a2)
{
  v10 = a2;
  v3 = [v10 mediaRouteID];

  if (v3)
  {
    v4 = [v10 mediaRouteID];
    if (([v4 hmf_isEqualToUUIDString:@"20BC605A-C33B-4D36-B885-C2EE6102B308"] & 1) == 0)
    {
      v5 = [v10 mediaRouteID];
      if (![v5 hmf_isEqualToUUIDString:@"00000000-0000-0000-0000-C2EE6102B308"])
      {
        v6 = [v10 accessoryAppleMedia];

        if (v6)
        {
          goto LABEL_9;
        }

        v7 = *(a1 + 32);
        v4 = [v7 backingStore];
        v5 = [v4 context];
        [v7 updateAccessoryModelsFromContext:v5];
      }
    }
  }

  else
  {
    v8 = *(a1 + 32);
    v4 = [v10 identifier];
    v9 = [v8 updateMediaRouteIDOfDeviceWithIdentifier:v4];
  }

LABEL_9:
}

- (void)_handleAppleMediaAccessoryDeviceInfoRequestMessage:(id)message
{
  v26 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v5 = objc_alloc_init(HMDAppleMediaDeviceInfo);
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    shortDescription = [messageCopy shortDescription];
    v20 = 138543874;
    v21 = v9;
    v22 = 2114;
    v23 = shortDescription;
    v24 = 2112;
    v25 = v5;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Handling apple media accessory device info request message: %{public}@ with device info: %@", &v20, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  mediaRouteUUID = [(HMDAppleMediaDeviceInfo *)v5 mediaRouteUUID];
  v12 = [mediaRouteUUID hmf_isEqualToUUIDString:@"00000000-0000-0000-0000-C2EE6102B308"];

  if (v12)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = selfCopy;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      shortDescription2 = [messageCopy shortDescription];
      v20 = 138543618;
      v21 = v16;
      v22 = 2114;
      v23 = shortDescription2;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Failed to handle apple media accessory device info request message: %{public}@ due to invalid media remote identifier", &v20, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    asPayload = [MEMORY[0x277CCA9B8] hmfErrorWithCode:15];
    [messageCopy respondWithError:asPayload];
  }

  else
  {
    asPayload = [(HMDAppleMediaDeviceInfo *)v5 asPayload];
    [messageCopy respondWithPayload:asPayload];
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_registerForAppleMediaMessages
{
  v9[1] = *MEMORY[0x277D85DE8];
  v3 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v3 setRequiresAccountMessage:1];
  v4 = [v3 copy];
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  v9[0] = v4;
  v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v9 count:1];
  [messageDispatcher registerForMessage:@"HMDAM.g" receiver:self policies:v6 selector:sel__handleAppleMediaAccessoryDeviceInfoRequestMessage_];

  defaultCenter = [MEMORY[0x277CCAB98] defaultCenter];
  [defaultCenter addObserver:self selector:sel__handleDeviceNotification_ name:@"HMDAppleAccountManagerResolved" object:0];
  [defaultCenter addObserver:self selector:sel__handleAddedAccessory_ name:@"HMDNotificationHomeAddedAccessory" object:0];
  [defaultCenter addObserver:self selector:sel__handleAppleMediaResidentCoreDataChanges_ name:*MEMORY[0x277CBE1A8] object:0];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)checkAndProcessHH2UpgradeRecommendation
{
  if (self)
  {
    workQueue = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __93__HMDHomeManager_HH2UpgradeRecommendation___postHH2UpgradeRecommendationFollowUpItemIfNeeded__block_invoke;
    block[3] = &unk_27868A728;
    block[4] = self;
    dispatch_async(workQueue, block);
  }
}

void __93__HMDHomeManager_HH2UpgradeRecommendation___postHH2UpgradeRecommendationFollowUpItemIfNeeded__block_invoke(uint64_t a1)
{
  if (([*(a1 + 32) needHH2UpgradeRecommendation] & 1) == 0)
  {
    v2 = +[HMDDeviceSetupManager sharedManager];
    v1 = [v2 followUpManager];
    [v1 stopAdvertisingHH2UpgradeRecommendationCFU];
  }
}

- (void)postHH2AutoMigratedSuccessBulletinIfNeeded
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __86__HMDHomeManager_HH2UpgradeRecommendation__postHH2AutoMigratedSuccessBulletinIfNeeded__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

void __86__HMDHomeManager_HH2UpgradeRecommendation__postHH2AutoMigratedSuccessBulletinIfNeeded__block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) userDefaults];
  v3 = [v2 BOOLForKey:@"HMDHH2AutoMigrationSuccesKey"];

  if (v3)
  {
    v4 = +[HMDBulletinBoard sharedBulletinBoard];
    [v4 insertHH2AutoMigratedSuccessBulletin];

    v5 = [*(a1 + 32) userDefaults];
    [v5 setObject:0 forKey:@"HMDHH2AutoMigrationSuccesKey"];
  }
}

- (void)handleDumpDatabaseMessage:(id)message
{
  v23[1] = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v4 = objc_autoreleasePoolPush();
  v5 = [messageCopy numberForKey:*MEMORY[0x277CD0138]];
  bOOLValue = [v5 BOOLValue];

  v7 = [messageCopy numberForKey:*MEMORY[0x277CD0148]];
  bOOLValue2 = [v7 BOOLValue];

  v9 = [messageCopy numberForKey:*MEMORY[0x277CD0150]];
  bOOLValue3 = [v9 BOOLValue];

  v11 = [messageCopy numberForKey:*MEMORY[0x277CD0160]];
  bOOLValue4 = [v11 BOOLValue];

  if (bOOLValue & 1) != 0 || (bOOLValue3 & 1) != 0 || (bOOLValue4 & 1) != 0 || (bOOLValue2)
  {
    v13 = +[HMDCoreData sharedInstance];
    newManagedObjectContext = [v13 newManagedObjectContext];
    v21 = 0;
    v15 = [v13 dumpCloudKitConfiguration:bOOLValue localConfiguration:bOOLValue3 workingConfiguration:bOOLValue4 includeFakeModels:bOOLValue2 context:newManagedObjectContext error:&v21];
    v16 = v21;
    if (v15)
    {
      v17 = [v15 dataUsingEncoding:4];
      hmd_compressedData = [v17 hmd_compressedData];

      if (hmd_compressedData)
      {
        v22 = *MEMORY[0x277CD0140];
        v23[0] = hmd_compressedData;
        v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v23 forKeys:&v22 count:1];
        [messageCopy respondWithPayload:v19];
      }

      else
      {
        v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
        [messageCopy respondWithError:v19];
      }
    }

    else
    {
      [messageCopy respondWithError:v16];
    }
  }

  else
  {
    v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [messageCopy respondWithError:v13];
  }

  objc_autoreleasePoolPop(v4);
  v20 = *MEMORY[0x277D85DE8];
}

- (void)homeModelHomeDelete:(id)delete message:(id)message
{
  v22 = *MEMORY[0x277D85DE8];
  deleteCopy = delete;
  messageCopy = message;
  handle = [deleteCopy handle];
  homeUUID = [handle homeUUID];

  if (!homeUUID)
  {
    _HMFPreconditionFailure();
  }

  v10 = [(HMDHomeManager *)self _homeWithUUID:homeUUID];
  if (v10)
  {
    transactionResult = [messageCopy transactionResult];
    v12 = [transactionResult source] == 1;

    [(HMDHomeManager *)self _removeHome:v10 withMessage:messageCopy saveToStore:1 notifyUsers:1 shouldRemovePairings:v12];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v16;
      v20 = 2112;
      v21 = homeUUID;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Home with UUID not found: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)homeModelHomeUpdate:(id)update message:(id)message
{
  v137 = *MEMORY[0x277D85DE8];
  updateCopy = update;
  messageCopy = message;
  v113 = updateCopy;
  if (updateCopy)
  {
    v112 = messageCopy;
    handle = [updateCopy handle];
    homeUUID = [handle homeUUID];

    HMFUptime();
    v11 = v10;
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138544898;
      *&buf[4] = v15;
      *&buf[12] = 2114;
      *&buf[14] = @"homeManagerInitStart";
      *&buf[22] = 2112;
      v126 = @"Loading home model from backing store";
      *v127 = 2114;
      *&v127[2] = @"state";
      *&v127[10] = 2112;
      *&v127[12] = @"homeManagerLoadingHomeModel";
      *&v127[20] = 2114;
      *&v127[22] = @"homeUUID";
      *&v127[30] = 2112;
      v128 = homeUUID;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
    }

    objc_autoreleasePoolPop(v12);
    mEMORY[0x277D17DE8] = [MEMORY[0x277D17DE8] sharedInstance];
    v17 = objc_alloc(MEMORY[0x277D17DF8]);
    v18 = HMDTaggedLoggingCreateDictionary();
    v19 = [v17 initWithTag:@"homeManagerInitStart" data:{v18, @"state", @"homeManagerLoadingHomeModel", @"homeUUID", homeUUID}];
    currentTagProcessorList = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8] submitTaggedEvent:v19 processorList:currentTagProcessorList];

    if (homeUUID)
    {
      v21 = [(HMDHomeManager *)selfCopy _homeWithUUID:homeUUID];
      v22 = v21 == 0;

      if (!v22)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = selfCopy;
        v25 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
        {
          v26 = HMFGetLogIdentifier();
          *buf = 138543618;
          *&buf[4] = v26;
          *&buf[12] = 2112;
          *&buf[14] = homeUUID;
          _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_ERROR, "%{public}@Not re-adding a home that already exists (%@)", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v23);
LABEL_39:

        messageCopy = v112;
        goto LABEL_40;
      }
    }

    else
    {
      v27 = objc_autoreleasePoolPush();
      v28 = selfCopy;
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v30;
        _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_DEFAULT, "%{public}@model.homeUUID is nil for HMDCloudZoneInformationModel. This may cause extra work.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v27);
    }

    handle2 = [v113 handle];
    v116 = 0;
    v111 = [HMDBackingStore cdlsBackingStoreWithHandle:handle2 error:&v116];
    v110 = v116;

    v32 = objc_autoreleasePoolPush();
    v33 = selfCopy;
    v34 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
    {
      v35 = HMFGetLogIdentifier();
      v36 = MEMORY[0x277CCACA8];
      HMFUptime();
      v38 = [v36 stringWithFormat:@"%.3f", v37 - v11];
      v39 = [MEMORY[0x277CCABB0] numberWithInteger:{-[__CFString code](v110, "code")}];
      *buf = 138545922;
      *&buf[4] = v35;
      *&buf[12] = 2114;
      *&buf[14] = @"homeManagerInitStart";
      *&buf[22] = 2112;
      v126 = @"Loaded home model from backing store";
      *v127 = 2114;
      *&v127[2] = @"state";
      *&v127[10] = 2112;
      *&v127[12] = @"homeManagerLoadedHomeModel";
      *&v127[20] = 2114;
      *&v127[22] = @"duration";
      *&v127[30] = 2112;
      v128 = v38;
      v129 = 2114;
      v130 = @"homeUUID";
      v131 = 2112;
      v132 = homeUUID;
      v133 = 2114;
      v134 = @"error";
      v135 = 2112;
      v136 = v39;
      _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x70u);
    }

    objc_autoreleasePoolPop(v32);
    mEMORY[0x277D17DE8]2 = [MEMORY[0x277D17DE8] sharedInstance];
    v41 = objc_alloc(MEMORY[0x277D17DF8]);
    v42 = MEMORY[0x277CCACA8];
    HMFUptime();
    v44 = [v42 stringWithFormat:@"%.3f", v43 - v11];
    v45 = [MEMORY[0x277CCABB0] numberWithInteger:{-[__CFString code](v110, "code")}];
    v46 = HMDTaggedLoggingCreateDictionary();
    v47 = [v41 initWithTag:@"homeManagerInitStart" data:{v46, @"state", @"homeManagerLoadedHomeModel", @"duration", v44, @"homeUUID", homeUUID, @"error", v45}];
    currentTagProcessorList2 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]2 submitTaggedEvent:v47 processorList:currentTagProcessorList2];

    if (v111)
    {
      homeManager = [v111 homeManager];
      v50 = homeManager == 0;

      if (v50)
      {
        [v111 setHomeManager:v33];
      }

      v51 = v33;
      v52 = v111;
      v53 = homeUUID;
      v117 = 0;
      v118 = &v117;
      v119 = 0x3032000000;
      v120 = __Block_byref_object_copy__56247;
      v121 = __Block_byref_object_dispose__56248;
      v122 = 0;
      context = [v52 context];
      managedObjectContext = [context managedObjectContext];
      *buf = MEMORY[0x277D85DD0];
      *&buf[8] = 3221225472;
      *&buf[16] = ____homeWithHomeManager_block_invoke;
      v126 = &unk_278689D20;
      v56 = v51;
      *v127 = v56;
      v57 = v53;
      *&v127[8] = v57;
      *&v127[24] = &v117;
      v58 = v52;
      *&v127[16] = v58;
      [managedObjectContext performBlockAndWait:buf];

      v109 = v118[5];
      _Block_object_dispose(&v117, 8);

      if (v109)
      {
        HMFUptime();
        v60 = v59;
        v61 = objc_autoreleasePoolPush();
        v62 = v56;
        v63 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v63, OS_LOG_TYPE_DEBUG))
        {
          v64 = HMFGetLogIdentifier();
          *buf = 138544898;
          *&buf[4] = v64;
          *&buf[12] = 2114;
          *&buf[14] = @"homeManagerInitStart";
          *&buf[22] = 2112;
          v126 = @"Replaying all models for home";
          *v127 = 2114;
          *&v127[2] = @"state";
          *&v127[10] = 2112;
          *&v127[12] = @"homeManagerReplayHome";
          *&v127[20] = 2114;
          *&v127[22] = @"homeUUID";
          *&v127[30] = 2112;
          v128 = v57;
          _os_log_impl(&dword_229538000, v63, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
        }

        objc_autoreleasePoolPop(v61);
        mEMORY[0x277D17DE8]3 = [MEMORY[0x277D17DE8] sharedInstance];
        v66 = objc_alloc(MEMORY[0x277D17DF8]);
        v67 = HMDTaggedLoggingCreateDictionary();
        v68 = [v66 initWithTag:@"homeManagerInitStart" data:{v67, @"state", @"homeManagerReplayHome", @"homeUUID", v57}];
        currentTagProcessorList3 = [MEMORY[0x277D0F770] currentTagProcessorList];
        [mEMORY[0x277D17DE8]3 submitTaggedEvent:v68 processorList:currentTagProcessorList3];

        [v58 cdlsReplayAllModelsStartingAt:v109 isInitialGraphLoad:{-[HMDHomeManager isInitialReplay:](v62, "isInitialReplay:", v112)}];
        [(HMDHomeManager *)v62 updateHomeKitInUsePreferences];
        v70 = objc_autoreleasePoolPush();
        v71 = v62;
        v72 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
        {
          v73 = HMFGetLogIdentifier();
          v74 = MEMORY[0x277CCACA8];
          HMFUptime();
          v76 = [v74 stringWithFormat:@"%.3f", v75 - v60];
          *buf = 138545410;
          *&buf[4] = v73;
          *&buf[12] = 2114;
          *&buf[14] = @"homeManagerInitStart";
          *&buf[22] = 2112;
          v126 = @"Replayed all models for home";
          *v127 = 2114;
          *&v127[2] = @"state";
          *&v127[10] = 2112;
          *&v127[12] = @"homeManagerReplayedHome";
          *&v127[20] = 2114;
          *&v127[22] = @"duration";
          *&v127[30] = 2112;
          v128 = v76;
          v129 = 2114;
          v130 = @"homeUUID";
          v131 = 2112;
          v132 = v57;
          _os_log_impl(&dword_229538000, v72, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x5Cu);
        }

        objc_autoreleasePoolPop(v70);
        mEMORY[0x277D17DE8]4 = [MEMORY[0x277D17DE8] sharedInstance];
        v78 = objc_alloc(MEMORY[0x277D17DF8]);
        v79 = MEMORY[0x277CCACA8];
        HMFUptime();
        v81 = [v79 stringWithFormat:@"%.3f", v80 - v60];
        v82 = HMDTaggedLoggingCreateDictionary();
        v83 = [v78 initWithTag:@"homeManagerInitStart" data:{v82, @"state", @"homeManagerReplayedHome", @"duration", v81, @"homeUUID", v57}];
        currentTagProcessorList4 = [MEMORY[0x277D0F770] currentTagProcessorList];
        [mEMORY[0x277D17DE8]4 submitTaggedEvent:v83 processorList:currentTagProcessorList4];

        v85 = objc_alloc(MEMORY[0x277D0F7A8]);
        workQueue = [(HMDHomeManager *)v71 workQueue];
        v87 = [v85 initWithQueue:workQueue];

        v114[0] = MEMORY[0x277D85DD0];
        v114[1] = 3221225472;
        v114[2] = __56__HMDHomeManager_CoreData__homeModelHomeUpdate_message___block_invoke;
        v114[3] = &unk_27868A750;
        v114[4] = v71;
        v88 = v87;
        v115 = v88;
        [v88 performBlock:v114];
        v123 = *MEMORY[0x277CD0640];
        v124 = v57;
        v89 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v124 forKeys:&v123 count:1];
        logAndPostNotification(@"HMDHomeAddedNotification", v71, v89);
        primaryHomeUUID = [(HMDHomeManager *)v71 primaryHomeUUID];
        if (!primaryHomeUUID || (-[HMDHomeManager primaryHomeUUID](v71, "primaryHomeUUID"), v91 = objc_claimAutoreleasedReturnValue(), v92 = [v91 isEqual:v57], v91, primaryHomeUUID, (v92 & 1) == 0))
        {
          primaryHomeUUID2 = [(HMDHomeManager *)v71 primaryHomeUUID];
          if (primaryHomeUUID2)
          {
          }

          else
          {
            homes = [(HMDHomeManager *)v71 homes];
            v99 = [homes count] == 1;

            if (v99)
            {
              [(HMDHomeManager *)v71 _changePrimaryHome:v57];
            }
          }
        }

        v100 = [(HMDHomeManager *)v71 _homeWithUUID:v57];
        currentUser = [v100 currentUser];
        v102 = currentUser == 0;

        if (v102)
        {
          v104 = objc_autoreleasePoolPush();
          v105 = v71;
          v106 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v106, OS_LOG_TYPE_INFO))
          {
            v107 = HMFGetLogIdentifier();
            *buf = 138543618;
            *&buf[4] = v107;
            *&buf[12] = 2112;
            *&buf[14] = v100;
            _os_log_impl(&dword_229538000, v106, OS_LOG_TYPE_INFO, "%{public}@Not sending home added notification to clients as this home does not have current user: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v104);
          transactionResult = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2011];
          [v112 respondWithError:transactionResult];
        }

        else
        {
          transactionResult = [v112 transactionResult];
          [transactionResult markSaveToAssistant];
        }
      }
    }

    else
    {
      v94 = objc_autoreleasePoolPush();
      v95 = v33;
      v96 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v96, OS_LOG_TYPE_ERROR))
      {
        v97 = HMFGetLogIdentifier();
        *buf = 138543874;
        *&buf[4] = v97;
        *&buf[12] = 2112;
        *&buf[14] = homeUUID;
        *&buf[22] = 2112;
        v126 = v110;
        _os_log_impl(&dword_229538000, v96, OS_LOG_TYPE_ERROR, "%{public}@Unable to open backing store %@: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v94);
    }

    goto LABEL_39;
  }

LABEL_40:

  v108 = *MEMORY[0x277D85DE8];
}

- (BOOL)isInitialReplay:(id)replay
{
  replayCopy = replay;
  v4 = replayCopy;
  if (replayCopy)
  {
    transactionResult = [replayCopy transactionResult];

    if (transactionResult)
    {
      transactionResult2 = [v4 transactionResult];
      label = [transactionResult2 label];
      LOBYTE(transactionResult) = HMFEqualObjects();
    }
  }

  else
  {
    LOBYTE(transactionResult) = 0;
  }

  return transactionResult;
}

- (void)dm_transactionObjectRemoved:(id)removed message:(id)message
{
  removedCopy = removed;
  messageCopy = message;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = removedCopy;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;
  [(HMDHomeManager *)self homeModelHomeDelete:v8 message:messageCopy];
}

- (void)dm_transactionObjectUpdated:(id)updated newValues:(id)values message:(id)message
{
  valuesCopy = values;
  messageCopy = message;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v8 = valuesCopy;
  }

  else
  {
    v8 = 0;
  }

  v9 = v8;
  [(HMDHomeManager *)self homeModelHomeUpdate:v9 message:messageCopy];
}

- (void)dmKickClients
{
  uuid = [(HMDHomeManager *)self uuid];
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"CoreData data changed" sourceUUID:uuid shouldNotifyClients:1];
}

- (void)dmHandleRequestRemoveHome:(id)home
{
  v4 = *MEMORY[0x277CD0640];
  homeCopy = home;
  v6 = [homeCopy uuidForKey:v4];
  v7 = [(HMDHomeManager *)self _homeWithUUID:v6];
  deletedBackingStoreObject = [v7 deletedBackingStoreObject];
  untrustedClientIdentifier = [homeCopy untrustedClientIdentifier];
  v10 = [HMDBackingStoreTransactionOptions defaultXPCOptionsWithCDTransactionAuthor:10 clientIdentifier:untrustedClientIdentifier];

  backingStore = [(HMDHomeManager *)self backingStore];
  name = [homeCopy name];
  v13 = [backingStore transaction:name options:v10];

  [v13 add:deletedBackingStoreObject];
  v14 = [HMDHomeManagerHomeModel modelForHomeUUID:v6];
  [v14 setObjectChangeType:3];
  [v13 add:v14 withMessage:homeCopy];

  v17[0] = MEMORY[0x277D85DD0];
  v17[1] = 3221225472;
  v17[2] = __54__HMDHomeManager_CoreData__dmHandleRequestRemoveHome___block_invoke;
  v17[3] = &unk_27868A250;
  v17[4] = self;
  [v13 run:v17];
  if ([v7 isOwnerUser])
  {
    homeOwnerCloudShareManager = [(HMDHomeManager *)self homeOwnerCloudShareManager];
    v16 = [homeOwnerCloudShareManager removeSharesForHome:v7];
  }
}

void __54__HMDHomeManager_CoreData__dmHandleRequestRemoveHome___block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543618;
    v10 = v7;
    v11 = 2112;
    v12 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Transaction to remove the home finished with error: %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *MEMORY[0x277D85DE8];
}

- (id)hh2ControllerKey
{
  v23 = *MEMORY[0x277D85DE8];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v17 = 0;
  v18 = 0;
  v4 = [systemStore getOrCreateHH2ControllerKey:&v18 secretKey:0 keyPair:0 username:&v17];
  v5 = v18;
  v6 = v17;

  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  v10 = v9;
  if (v4)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543618;
      v20 = v11;
      v21 = 2112;
      v22 = v6;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Going to use HH2 controller key : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v12 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v5];
    v13 = [objc_alloc(MEMORY[0x277D0F8A8]) initWithIdentifier:v6 publicKey:v12 privateKey:0];
  }

  else
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v20 = v14;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@FATAL Error : Unable to get or create HH2 Controller key", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v13 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v13;
}

- (HMDAccountHandle)accountHandleForOwner
{
  v27 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self isCloudKitRequiredForHH2])
  {
    v3 = +[HMDAppleAccountManager sharedManager];
    account = [v3 account];
    primaryHandle = [account primaryHandle];
  }

  else
  {
    v6 = MEMORY[0x277CCACA8];
    uUID = [MEMORY[0x277CCAD78] UUID];
    v3 = [v6 stringWithFormat:@"mailto:hh2_qa_%@_@apple.com", uUID];

    demoModeManager = [(HMDHomeManager *)self demoModeManager];
    demoModeDataSource = [demoModeManager demoModeDataSource];
    isDemoModeV2WithoutCKEnabled = [demoModeDataSource isDemoModeV2WithoutCKEnabled];

    if (isDemoModeV2WithoutCKEnabled)
    {
      v11 = MEMORY[0x277CCACA8];
      uUID2 = [MEMORY[0x277CCAD78] UUID];
      v13 = [v11 stringWithFormat:@"mailto:demo_user_%@_@icloud.com", uUID2];

      v3 = v13;
    }

    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543618;
      v24 = v17;
      v25 = 2112;
      v26 = v3;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Using : %@ for new home creation", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    v18 = objc_alloc(MEMORY[0x277D18A48]);
    v19 = MEMORY[0x22AAD2AB0](v3);
    v20 = [v18 initWithPrefixedURI:v19];

    primaryHandle = [[HMDAccountHandle alloc] initWithURI:v20];
  }

  v21 = *MEMORY[0x277D85DE8];

  return primaryHandle;
}

- (void)runTransactionForAddHomeMessage:(id)message withInitialHomeObjects:(id)objects homeManagerModel:(id)model homeManagerHomeModel:(id)homeModel homeBackingStore:(id)store homeUUID:(id)d homeName:(id)name makeNewHomePrimaryHome:(BOOL)self0
{
  messageCopy = message;
  modelCopy = model;
  storeCopy = store;
  dCopy = d;
  nameCopy = name;
  homeModelCopy = homeModel;
  objectsCopy = objects;
  backingStore = [(HMDHomeManager *)self backingStore];
  v23 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
  v24 = [backingStore transaction:@"HomeModelAddition" options:v23];

  v38[0] = MEMORY[0x277D85DD0];
  v38[1] = 3221225472;
  v38[2] = __179__HMDHomeManager_CoreData__runTransactionForAddHomeMessage_withInitialHomeObjects_homeManagerModel_homeManagerHomeModel_homeBackingStore_homeUUID_homeName_makeNewHomePrimaryHome___block_invoke;
  v38[3] = &unk_2786743D8;
  v25 = v24;
  v39 = v25;
  [objectsCopy hmf_enumerateWithAutoreleasePoolUsingBlock:v38];

  [v25 add:homeModelCopy withMessage:messageCopy];
  if (modelCopy)
  {
    [v25 add:modelCopy];
  }

  v31[0] = MEMORY[0x277D85DD0];
  v31[1] = 3221225472;
  v31[2] = __179__HMDHomeManager_CoreData__runTransactionForAddHomeMessage_withInitialHomeObjects_homeManagerModel_homeManagerHomeModel_homeBackingStore_homeUUID_homeName_makeNewHomePrimaryHome___block_invoke_2;
  v31[3] = &unk_27867AE88;
  v32 = storeCopy;
  selfCopy = self;
  v34 = nameCopy;
  v35 = messageCopy;
  v36 = dCopy;
  homeCopy = home;
  v26 = dCopy;
  v27 = messageCopy;
  v28 = nameCopy;
  v29 = storeCopy;
  [v25 run:v31];
}

void __179__HMDHomeManager_CoreData__runTransactionForAddHomeMessage_withInitialHomeObjects_homeManagerModel_homeManagerHomeModel_homeBackingStore_homeUUID_homeName_makeNewHomePrimaryHome___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  [v3 setObjectChangeType:1];
  [*(a1 + 32) add:v3];
}

void __179__HMDHomeManager_CoreData__runTransactionForAddHomeMessage_withInitialHomeObjects_homeManagerModel_homeManagerHomeModel_homeBackingStore_homeUUID_homeName_makeNewHomePrimaryHome___block_invoke_2(uint64_t a1, void *a2)
{
  v36 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 40);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      *buf = 138543618;
      v33 = v7;
      v34 = 2112;
      v35 = v3;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to run transaction for adding home: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    v8 = *(a1 + 40);
    v9 = *(a1 + 48);
    v10 = [v8 uuid];
    v11 = [v8 removeName:v9 namespace:v10];

    [*(a1 + 56) respondWithError:v3];
  }

  else
  {
    v12 = [*(a1 + 40) _homeWithUUID:*(a1 + 64)];
    v13 = objc_autoreleasePoolPush();
    v14 = *(a1 + 40);
    v15 = HMFGetOSLogHandle();
    v16 = v15;
    if (v12)
    {
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v17 = HMFGetLogIdentifier();
        v18 = [*(a1 + 56) shortDescription];
        *buf = 138543618;
        v33 = v17;
        v34 = 2112;
        v35 = v18;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Replying to message %@ for client which asked to add home", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v13);
      v19 = *(a1 + 56);
      if ([v19 isEntitledForSPIAccess])
      {
        encodeRootObjectForSPIClients(v12);
      }

      else
      {
        encodeRootObjectForIncomingXPCMessage(v12, 0);
      }
      v26 = ;
      v30[1] = *MEMORY[0x277CD0260];
      v31[0] = v26;
      v27 = [MEMORY[0x277CCABB0] numberWithBool:*(a1 + 72)];
      v31[1] = v27;
      v28 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v31 forKeys:v30 count:2];
      [v19 respondWithPayload:v28];
    }

    else
    {
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543362;
        v33 = v20;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Unable to find added home after running transaction to add home", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v13);
      v21 = *(a1 + 40);
      v22 = *(a1 + 48);
      v23 = [v21 uuid];
      v24 = [v21 removeName:v22 namespace:v23];

      v25 = *(a1 + 56);
      v26 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
      [v25 respondWithError:v26];
    }
  }

  v29 = *MEMORY[0x277D85DE8];
}

- (void)dmHandleRequestAddHome:(id)home
{
  v130 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v5 = [homeCopy stringForKey:*MEMORY[0x277CD23D0]];
  if (!v5)
  {
    v11 = MEMORY[0x277CCA9B8];
    v12 = 20;
LABEL_10:
    v9 = [v11 hmErrorWithCode:v12];
    [homeCopy respondWithError:v9];
    goto LABEL_11;
  }

  homes = [(HMDHomeManager *)self homes];
  v7 = [homes count];
  v8 = maximumHomes;

  if (v7 >= v8)
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543618;
      v125 = v16;
      v126 = 2112;
      v127 = v5;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Can't add home %@; already at maximum homes", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 49;
    goto LABEL_10;
  }

  v9 = [homeCopy uuidForKey:*MEMORY[0x277CD0B10]];
  if (v9)
  {
    v10 = +[HMDAppleAccountSettings sharedSettings];
    if ([v10 isHomeEnabled])
    {

      goto LABEL_18;
    }

    isCloudKitRequiredForHH2 = [(HMDHomeManager *)self isCloudKitRequiredForHH2];

    if (!isCloudKitRequiredForHH2)
    {
LABEL_18:
      v25 = objc_alloc(MEMORY[0x277D0F770]);
      v26 = [MEMORY[0x277CCACA8] stringWithFormat:@"add home %@", v9];
      v27 = [v25 initWithName:v26];

      hh2ControllerKey = [(HMDHomeManager *)self hh2ControllerKey];
      if (!hh2ControllerKey)
      {
        v48 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v50 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v52 = v51 = v27;
          *buf = 138543362;
          v125 = v52;
          _os_log_impl(&dword_229538000, v50, OS_LOG_TYPE_ERROR, "%{public}@Unable to get or create HH2 key.", buf, 0xCu);

          v27 = v51;
        }

        objc_autoreleasePoolPop(v48);
        v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:53];
        [homeCopy respondWithError:v28];
        goto LABEL_59;
      }

      v28 = [HMDHomeManagerHomeModel deriveUUIDFromHomeUUID:v9];
      uUID = [MEMORY[0x277CCAD78] UUID];
      v30 = [HMDHomeManagerHomeModel alloc];
      uuid = [(HMDHomeManager *)self uuid];
      v32 = [(HMDBackingStoreModelObject *)v30 initWithObjectChangeType:1 uuid:v28 parentUUID:uuid];

      v109 = uUID;
      v33 = [[HMDHomeManagerHomeHandle alloc] initWithBackingStoreUUID:uUID homeUUID:v9];
      [(HMDHomeManagerHomeModel *)v32 setHandle:v33];

      v106 = v32;
      handle = [(HMDHomeManagerHomeModel *)v32 handle];
      v123 = 0;
      v35 = [HMDBackingStore cdlsBackingStoreWithHandle:handle error:&v123];
      v36 = v123;

      if (!v35)
      {
        [homeCopy respondWithError:v36];
        v53 = v106;
LABEL_58:

LABEL_59:
        goto LABEL_11;
      }

      v103 = v36;
      homeManager = [v35 homeManager];

      if (!homeManager)
      {
        [v35 setHomeManager:self];
      }

      v38 = [(HMDHomeManager *)self modelObjectWithChangeType:2];
      primaryHomeUUID = [v38 primaryHomeUUID];
      if (!primaryHomeUUID)
      {
        goto LABEL_24;
      }

      v40 = primaryHomeUUID;
      [(HMDHomeManager *)self homes];
      v100 = v38;
      v41 = v9;
      v42 = v35;
      v43 = v28;
      v45 = v44 = v27;
      hmf_isEmpty = [v45 hmf_isEmpty];

      v27 = v44;
      v28 = v43;
      v35 = v42;
      v9 = v41;
      v38 = v100;

      if (!hmf_isEmpty)
      {
        uUIDString = v100;
        v38 = 0;
      }

      else
      {
LABEL_24:
        uUIDString = [v9 UUIDString];
        [v38 setPrimaryHomeUUID:uUIDString];
        LOBYTE(hmf_isEmpty) = 1;
      }

      accountHandleForOwner = [(HMDHomeManager *)self accountHandleForOwner];
      if (!accountHandleForOwner && [(HMDHomeManager *)self isCloudKitRequiredForHH2])
      {
        v54 = objc_autoreleasePoolPush();
        selfCopy3 = self;
        v56 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v56, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v101 = v54;
          v58 = v57 = v27;
          *buf = 138543362;
          v125 = v58;
          _os_log_impl(&dword_229538000, v56, OS_LOG_TYPE_ERROR, "%{public}@Unable to create home (cannot determine account handle for the owner).", buf, 0xCu);

          v27 = v57;
          v54 = v101;
        }

        objc_autoreleasePoolPop(v54);
        v59 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75];
        [homeCopy respondWithError:v59];
        v53 = v106;
        v36 = v103;
        goto LABEL_57;
      }

      v99 = [[HMDUser alloc] initWithAccountHandle:accountHandleForOwner homeUUID:v9 pairingIdentity:hh2ControllerKey privilege:3];
      v60 = [(HMDHomeManager *)self validateHomeName:v5];

      if (v60)
      {
        [homeCopy respondWithError:v60];
        v36 = v60;
        v53 = v106;
      }

      else
      {
        v102 = v38;
        v104 = v27;
        featuresDataSource = [(HMDHomeManager *)self featuresDataSource];
        isActivityHistory2025Enabled = [featuresDataSource isActivityHistory2025Enabled];

        if (isActivityHistory2025Enabled)
        {
          appData = [(HMDHomeManager *)self appData];
          v64 = appData;
          if (appData)
          {
            v65 = [appData applicationDataForIdentifier:@"com.apple.homekit-entitledclient.identifer"];
            if (v65)
            {
              v98 = [HMDHome didHomeAppOnboardHindsightWithAppData:v65];
            }

            else
            {
              v98 = 0;
            }
          }

          else
          {
            v98 = 0;
          }
        }

        else
        {
          v98 = 0;
        }

        v53 = v106;
        v107 = hmf_isEmpty;
        if (!_os_feature_enabled_impl())
        {
          uuid2 = [(HMDHomeManager *)self uuid];
          LOBYTE(v92) = v98;
          v77 = [HMDHome createNewHomeModelsWithModelID:v9 parentModelID:uuid2 name:v5 acwgGroupResolvingKey:0 acwgIssuerPublicKeyExternalRepresentation:0 userUniqueIDForAccessories:0 hasOnboardedActivityHistory:v92 ownedBy:v99];

          LOBYTE(v93) = hmf_isEmpty;
          [(HMDHomeManager *)self runTransactionForAddHomeMessage:homeCopy withInitialHomeObjects:v77 homeManagerModel:v102 homeManagerHomeModel:v53 homeBackingStore:v35 homeUUID:v9 homeName:v5 makeNewHomePrimaryHome:v93];

          v38 = v102;
          v59 = v99;
          v36 = 0;
          v27 = v104;
          goto LABEL_57;
        }

        internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
        v66 = objc_autoreleasePoolPush();
        selfCopy4 = self;
        v68 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v68, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v69 = v95 = v66;
          uUID2 = [internalOnlyInitializer UUID];
          *buf = 138543874;
          v125 = v69;
          v126 = 2112;
          v127 = uUID2;
          v128 = 2112;
          v129 = v9;
          _os_log_impl(&dword_229538000, v68, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Creating ACWG keys for new home: %@", buf, 0x20u);

          v66 = v95;
        }

        objc_autoreleasePoolPop(v66);
        v71 = +[HMDACWGUtilities createGroupResolvingKey];
        v27 = v104;
        if (!v71)
        {
          v78 = objc_autoreleasePoolPush();
          v79 = selfCopy4;
          v80 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v80, OS_LOG_TYPE_ERROR))
          {
            v81 = HMFGetLogIdentifier();
            *buf = 138543362;
            v125 = v81;
            _os_log_impl(&dword_229538000, v80, OS_LOG_TYPE_ERROR, "%{public}@Failed to create ACWG group resolving key", buf, 0xCu);

            v27 = v104;
          }

          objc_autoreleasePoolPop(v78);
          uuid3 = [(HMDHomeManager *)v79 uuid];
          v83 = [(HMDHomeManager *)v79 removeName:v5 namespace:uuid3];

          v84 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:9010 description:@"Failed to create ACWG group resolving key - Security framework probably failed to find sufficient random data. Try again." underlyingError:0];
          [homeCopy respondWithError:v84];

          v36 = 0;
          v59 = v99;
          v38 = v102;
          goto LABEL_57;
        }

        v72 = v71;
        v73 = [HMDHome createUserUniqueIDForAccessoriesWithoutDuplicatingExistingIDs:MEMORY[0x277CBEBF8]];
        v96 = v73;
        if (v73)
        {
          v74 = v73;
          v94 = +[HMDACWGKeyManager shared];
          v111[0] = MEMORY[0x277D85DD0];
          v111[1] = 3221225472;
          v111[2] = __51__HMDHomeManager_CoreData__dmHandleRequestAddHome___block_invoke;
          v111[3] = &unk_2786743B0;
          v111[4] = selfCopy4;
          v112 = v9;
          v113 = v5;
          v114 = homeCopy;
          v115 = v72;
          v116 = v74;
          v121 = v98;
          v117 = v99;
          v75 = v72;
          v38 = v102;
          v118 = v102;
          v119 = v53;
          v120 = v35;
          v122 = v107;
          [v94 getOrCreateIssuerKeyPairExternalRepresentationWithHomeUUID:v112 shouldRoll:0 flow:internalOnlyInitializer requireCloudFetch:0 shouldAwaitOnPush:0 completionHandler:v111];
        }

        else
        {
          v108 = v72;
          v85 = objc_autoreleasePoolPush();
          v86 = selfCopy4;
          v87 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v87, OS_LOG_TYPE_ERROR))
          {
            v88 = HMFGetLogIdentifier();
            *buf = 138543362;
            v125 = v88;
            _os_log_impl(&dword_229538000, v87, OS_LOG_TYPE_ERROR, "%{public}@Failed to create userUniqueIDForAccessories", buf, 0xCu);

            v27 = v104;
          }

          objc_autoreleasePoolPop(v85);
          uuid4 = [(HMDHomeManager *)v86 uuid];
          v90 = [(HMDHomeManager *)v86 removeName:v5 namespace:uuid4];

          v91 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:9010 description:@"Failed to create userUniqueIDForAccessories. Try again." underlyingError:0];
          [homeCopy respondWithError:v91];

          v38 = v102;
          v75 = v108;
        }

        v36 = 0;
      }

      v59 = v99;
LABEL_57:

      goto LABEL_58;
    }

    v20 = objc_autoreleasePoolPush();
    selfCopy5 = self;
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      v23 = HMFGetLogIdentifier();
      *buf = 138543362;
      v125 = v23;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, "%{public}@iCloud switch is not enabled. Not allowing to create a new home", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v20);
    v18 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2013];
  }

  else
  {
    v18 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
  }

  v24 = v18;
  [homeCopy respondWithError:v18];

LABEL_11:
  v17 = *MEMORY[0x277D85DE8];
}

void __51__HMDHomeManager_CoreData__dmHandleRequestAddHome___block_invoke(uint64_t a1, void *a2, uint64_t a3, void *a4)
{
  v40 = *MEMORY[0x277D85DE8];
  v6 = a2;
  v7 = a4;
  v8 = v7;
  if (v6)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 32);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v13 = *(a1 + 40);
      *buf = 138543618;
      v37 = v12;
      v38 = 2112;
      v39 = v13;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Successfully created ACWG issuer key on creating new home: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    v14 = [HMDNIST256Utilities publicKeyExternalRepresentationFromKeyPairExternalRepresentation:v6];
LABEL_5:
    v15 = *(a1 + 40);
    v16 = [*(a1 + 32) uuid];
    LOBYTE(v34) = *(a1 + 112);
    v17 = [HMDHome createNewHomeModelsWithModelID:v15 parentModelID:v16 name:*(a1 + 48) acwgGroupResolvingKey:*(a1 + 64) acwgIssuerPublicKeyExternalRepresentation:v14 userUniqueIDForAccessories:*(a1 + 72) hasOnboardedActivityHistory:v34 ownedBy:*(a1 + 80)];

    LOBYTE(v35) = *(a1 + 113);
    [*(a1 + 32) runTransactionForAddHomeMessage:*(a1 + 56) withInitialHomeObjects:v17 homeManagerModel:*(a1 + 88) homeManagerHomeModel:*(a1 + 96) homeBackingStore:*(a1 + 104) homeUUID:*(a1 + 40) homeName:*(a1 + 48) makeNewHomePrimaryHome:v35];

    goto LABEL_16;
  }

  v18 = [v7 domain];
  if ([v18 isEqualToString:*MEMORY[0x277CCFD28]])
  {
    v19 = [v8 code];

    if (v19 == 75 && ([*(a1 + 32) isCloudKitRequiredForHH2] & 1) == 0)
    {
      v20 = objc_autoreleasePoolPush();
      v21 = *(a1 + 32);
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543618;
        v37 = v23;
        v38 = 2112;
        v39 = v8;
        _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Failed to create ACWG issuer key during home creation but proceeding anyway: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v20);
      v14 = 0;
      goto LABEL_5;
    }
  }

  else
  {
  }

  v24 = objc_autoreleasePoolPush();
  v25 = *(a1 + 32);
  v26 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
  {
    v27 = HMFGetLogIdentifier();
    *buf = 138543618;
    v37 = v27;
    v38 = 2112;
    v39 = v8;
    _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_ERROR, "%{public}@Failed to create ACWG issuer key during home creation with error: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v24);
  v28 = *(a1 + 32);
  v29 = *(a1 + 48);
  v30 = [v28 uuid];
  v31 = [v28 removeName:v29 namespace:v30];

  v32 = *(a1 + 56);
  v14 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:9010 underlyingError:v8];
  [v32 respondWithError:v14];
LABEL_16:

  v33 = *MEMORY[0x277D85DE8];
}

+ (void)makeSureHomeManagerExistInWorkingStore:(id)store
{
  newManagedObjectContext = [store newManagedObjectContext];
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __67__HMDHomeManager_CoreData__makeSureHomeManagerExistInWorkingStore___block_invoke;
  v6[3] = &unk_27868A0D0;
  v7 = newManagedObjectContext;
  selfCopy = self;
  v5 = newManagedObjectContext;
  [v5 performBlockAndWait:v6];
}

void __67__HMDHomeManager_CoreData__makeSureHomeManagerExistInWorkingStore___block_invoke(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  v2 = *(a1 + 32);
  v17 = 0;
  v3 = [_MKFHomeManager fetchWithContext:v2 error:&v17];
  v4 = v17;
  v5 = v4;
  if (v3)
  {
    v6 = v4;
  }

  else
  {
    v7 = [[_MKFHomeManager alloc] initWithContext:*(a1 + 32)];
    v8 = +[_MKFHomeManager defaultModelID];
    [(_MKFHomeManager *)v7 setModelID:v8];

    v9 = *(a1 + 32);
    v16 = v5;
    v10 = [v9 save:&v16];
    v6 = v16;

    [*(a1 + 32) reset];
    if ((v10 & 1) == 0)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = *(a1 + 40);
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        *buf = 138543618;
        v19 = v14;
        v20 = 2112;
        v21 = v6;
        _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Unable to insert MKFHomeManager to working store: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v11);
    }
  }

  v15 = *MEMORY[0x277D85DE8];
}

+ (id)setupCoreDataUsingBackingStore:(id)store
{
  storeCopy = store;
  v4 = objc_alloc(MEMORY[0x277CCAD78]);
  v5 = [v4 initWithUUIDString:*MEMORY[0x277CD23C8]];
  v16 = 0;
  v6 = [storeCopy cdlsFetchObjectWithUUID:v5 ofModelType:objc_opt_class() error:&v16];
  v7 = v16;
  v8 = v7;
  if (v6)
  {
    v9 = v6;
  }

  else
  {
    if (v7 && ![v7 code])
    {
      v14 = _HMFPreconditionFailure();
      [(HMDCameraAudioParameterCombination *)v14 .cxx_destruct];
      return result;
    }

    v10 = [(HMDBackingStoreModelObject *)[HMDHomeManagerModel alloc] initWithUUID:v5];
    [(HMDBackingStoreModelObject *)v10 setObjectChangeType:1];
    v11 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v12 = [storeCopy transaction:@"Initial Home Manager Setup" options:v11];

    [v12 add:v10];
    [v12 run];
    v9 = v10;
  }

  return v9;
}

- (id)userUUIDForMessage:(id)message homeUUID:(id)d
{
  v27 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  dCopy = d;
  v8 = [(HMDHomeManager *)self _homeWithUUID:dCopy];
  if (v8)
  {
    v9 = [messageCopy userForHome:v8];
    if (v9)
    {
      v10 = objc_autoreleasePoolPush();
      selfCopy = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v21 = 138543874;
        v22 = v13;
        v23 = 2112;
        v24 = v9;
        v25 = 2112;
        v26 = messageCopy;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Getting user %@ from message %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v10);
      uuid = [v9 uuid];
    }

    else
    {
      uuid = 0;
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      v21 = 138543618;
      v22 = v18;
      v23 = 2112;
      v24 = dCopy;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Failed to get user from message due to no home with uuid: %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    uuid = 0;
  }

  v19 = *MEMORY[0x277D85DE8];

  return uuid;
}

- (void)enableUserListeningHistoryForHomeUUID:(id)d accessoryUUID:(id)iD userUUID:(id)uID
{
  v22 = *MEMORY[0x277D85DE8];
  dCopy = d;
  iDCopy = iD;
  uIDCopy = uID;
  v11 = [(HMDHomeManager *)self _homeWithUUID:dCopy];
  v12 = v11;
  if (v11)
  {
    [v11 enableUserListeningHistoryForAccessoryUUID:iDCopy userUUID:uIDCopy];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v16;
      v20 = 2112;
      v21 = dCopy;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Failed to enable ULH due to no home with uuid: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (id)hubAccessoriesWithHomeUUID:(id)d forSiriEndpointProfileMessageHandler:(id)handler
{
  v21 = *MEMORY[0x277D85DE8];
  dCopy = d;
  handlerCopy = handler;
  v8 = [(HMDHomeManager *)self _homeWithUUID:dCopy];
  v9 = v8;
  if (v8)
  {
    hubAccessories = [v8 hubAccessories];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    selfCopy = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = dCopy;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to get hub accessories due to no home with uuid: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    hubAccessories = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return hubAccessories;
}

- (id)accessoryWithHomeUUID:(id)d accessoryUUID:(id)iD
{
  v28 = *MEMORY[0x277D85DE8];
  dCopy = d;
  iDCopy = iD;
  homes = [(HMDHomeManager *)self homes];
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke;
  v22[3] = &unk_278685BA0;
  v9 = dCopy;
  v23 = v9;
  v10 = [homes na_firstObjectPassingTest:v22];

  if (v10)
  {
    accessories = [v10 accessories];
    v12 = [accessories copy];

    v20[0] = MEMORY[0x277D85DD0];
    v20[1] = 3221225472;
    v20[2] = __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke_20;
    v20[3] = &unk_278681708;
    v21 = iDCopy;
    v13 = [v12 na_firstObjectPassingTest:v20];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543618;
      v25 = v17;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    v13 = 0;
  }

  v18 = *MEMORY[0x277D85DE8];

  return v13;
}

uint64_t __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke_20(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (void)applyOnboardingSelections:(id)selections accessoryUUID:(id)d homeUUID:(id)iD completion:(id)completion
{
  v24 = *MEMORY[0x277D85DE8];
  selectionsCopy = selections;
  dCopy = d;
  iDCopy = iD;
  completionCopy = completion;
  v14 = objc_autoreleasePoolPush();
  selfCopy = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    v20 = 138543618;
    v21 = v17;
    v22 = 2112;
    v23 = selectionsCopy;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Apply onboarding selections to the controller manager: %@", &v20, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  compositeSettingsControllerManager = [(HMDHomeManager *)selfCopy compositeSettingsControllerManager];
  [compositeSettingsControllerManager applyOnboardingSelections:selectionsCopy accessoryUUID:dCopy homeUUID:iDCopy completion:completionCopy];

  v19 = *MEMORY[0x277D85DE8];
}

- (void)setNeedsOnboardingCompleteWitHomeUUID:(id)d accessoryUUID:(id)iD completion:(id)completion
{
  v59 = *MEMORY[0x277D85DE8];
  dCopy = d;
  iDCopy = iD;
  completionCopy = completion;
  homes = [(HMDHomeManager *)self homes];
  v53[0] = MEMORY[0x277D85DD0];
  v53[1] = 3221225472;
  v53[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke;
  v53[3] = &unk_278685BA0;
  v12 = dCopy;
  v54 = v12;
  v13 = [homes na_firstObjectPassingTest:v53];

  if (v13)
  {
    accessories = [v13 accessories];
    v15 = [accessories copy];

    v51[0] = MEMORY[0x277D85DD0];
    v51[1] = 3221225472;
    v51[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_12;
    v51[3] = &unk_278681708;
    v16 = iDCopy;
    v52 = v16;
    v17 = [v15 na_firstObjectPassingTest:v51];
    v18 = v17;
    if (v17)
    {
      v47 = iDCopy;
      v19 = v17;
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v20 = v19;
      }

      else
      {
        v20 = 0;
      }

      v21 = v20;

      needsOnboarding = [v21 needsOnboarding];
      if (needsOnboarding && (v23 = needsOnboarding, [v21 needsOnboarding], v24 = objc_claimAutoreleasedReturnValue(), v25 = objc_msgSend(v24, "integerValue"), v24, v23, v25 == 2))
      {
        v26 = objc_autoreleasePoolPush();
        selfCopy = self;
        v28 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
        {
          v29 = HMFGetLogIdentifier();
          *buf = 138543362;
          v56 = v29;
          _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Skipping needsOnboarding transaction since there's no change.", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v26);
        completionCopy[2](completionCopy, 0);
      }

      else
      {
        v34 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v36 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
        {
          v37 = HMFGetLogIdentifier();
          *buf = 138543362;
          v56 = v37;
          _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_INFO, "%{public}@Starting Updating needsOnboarding", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v34);
        backingStore = [v13 backingStore];
        v39 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v40 = [backingStore transaction:@"Updating needsOnboarding" options:v39];

        v41 = [v21 transactionWithObjectChangeType:2];
        [v41 setNeedsOnboarding:&unk_283E722D8];
        [v40 add:v41];
        v49[0] = MEMORY[0x277D85DD0];
        v49[1] = 3221225472;
        v49[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_18;
        v49[3] = &unk_278689A68;
        v49[4] = selfCopy2;
        v50 = completionCopy;
        [v40 run:v49];
      }

      iDCopy = v47;
    }

    else
    {
      v42 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v44 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v45 = v48 = iDCopy;
        *buf = 138543618;
        v56 = v45;
        v57 = 2112;
        v58 = v16;
        _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_ERROR, "%{public}@Accessory is not found. accessoryUUID: %@", buf, 0x16u);

        iDCopy = v48;
      }

      objc_autoreleasePoolPop(v42);
      v21 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      (completionCopy)[2](completionCopy, v21);
    }
  }

  else
  {
    v30 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v32 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
    {
      v33 = HMFGetLogIdentifier();
      *buf = 138543618;
      v56 = v33;
      v57 = 2112;
      v58 = v12;
      _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v30);
    v15 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
    (completionCopy)[2](completionCopy, v15);
  }

  v46 = *MEMORY[0x277D85DE8];
}

uint64_t __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_12(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

void __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_18(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = v6;
  if (v3)
  {
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543618;
      v12 = v8;
      v13 = 2112;
      v14 = v3;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_ERROR, "%{public}@Updating needsOnboarding reported error: %@", &v11, 0x16u);
    }
  }

  else if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v9;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Updating needsOnboarding success", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v4);
  (*(*(a1 + 40) + 16))();

  v10 = *MEMORY[0x277D85DE8];
}

- (id)needsOnboardingForHomeUUID:(id)d accessoryUUID:(id)iD
{
  v41 = *MEMORY[0x277D85DE8];
  dCopy = d;
  iDCopy = iD;
  homes = [(HMDHomeManager *)self homes];
  v35[0] = MEMORY[0x277D85DD0];
  v35[1] = 3221225472;
  v35[2] = __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke;
  v35[3] = &unk_278685BA0;
  v9 = dCopy;
  v36 = v9;
  v10 = [homes na_firstObjectPassingTest:v35];

  if (v10)
  {
    accessories = [v10 accessories];
    v12 = [accessories copy];

    v30 = MEMORY[0x277D85DD0];
    v31 = 3221225472;
    v32 = __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke_8;
    v33 = &unk_278681708;
    v13 = iDCopy;
    v34 = v13;
    v14 = [v12 na_firstObjectPassingTest:&v30];
    if (v14)
    {
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v15 = v14;
      }

      else
      {
        v15 = 0;
      }

      v16 = v15;
      needsOnboarding = [v16 needsOnboarding];

      if (needsOnboarding)
      {
        v18 = [needsOnboarding integerValue] == 0;
      }

      else
      {
        v18 = 1;
      }

      v23 = [MEMORY[0x277CCABB0] numberWithBool:v18];
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      selfCopy = self;
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
      {
        v27 = HMFGetLogIdentifier();
        *buf = 138543618;
        v38 = v27;
        v39 = 2112;
        v40 = v13;
        _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_INFO, "%{public}@Accessory is not found. accessoryUUID: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v24);
      v23 = MEMORY[0x277CBEC38];
    }
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v22;
      v39 = 2112;
      v40 = v9;
      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v19);
    v23 = 0;
  }

  v28 = *MEMORY[0x277D85DE8];

  return v23;
}

uint64_t __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke_8(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (void)prepareForDiagnosticExtension:(id)extension
{
  v23 = *MEMORY[0x277D85DE8];
  extensionCopy = extension;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v22 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Triggering memory exception.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85F48];
  corpse_task_port = 0;
  if (task_generate_corpse(v9, &corpse_task_port))
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v12;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Failed to generate a corpse task for memory exception reporting.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [extensionCopy respondWithError:v13];
  }

  else
  {
    processInfo = [MEMORY[0x277D0F8E0] processInfo];
    executableURL = [processInfo executableURL];
    path = [executableURL path];
    [path UTF8String];
    v17 = dispatch_get_global_queue(-32768, 0);
    v19 = extensionCopy;
    ReportMemoryExceptionFromTask();

    v13 = v19;
  }

  v18 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_DiagnosticExtension__prepareForDiagnosticExtension___block_invoke(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  [*(a1 + 32) respondWithPayload:0 error:v3];
  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v8 = 138543618;
    v9 = v6;
    v10 = 2112;
    v11 = v3;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Memory exception reporting completed with error: %@", &v8, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  mach_port_deallocate(*MEMORY[0x277D85F48], *(a1 + 40));

  v7 = *MEMORY[0x277D85DE8];
}

- (id)_homeFromIncomingInvitationWithIdentifier:(id)identifier invitationIdentifier:(id)invitationIdentifier homeUUID:(id)d
{
  v37 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  invitationIdentifierCopy = invitationIdentifier;
  dCopy = d;
  v11 = [(HMDHomeManager *)self __homeContainingInviteWithIDSInvitationIdentifier:identifierCopy];
  v12 = v11;
  if (invitationIdentifierCopy && !v11)
  {
    v12 = [(HMDHomeManager *)self __homeContainingInviteWithInvitationIdentifier:invitationIdentifierCopy];
  }

  if (!v12)
  {
    homes = [(HMDHomeManager *)self homes];
    v12 = [homes hmf_firstObjectWithUUID:dCopy];

    v15 = objc_autoreleasePoolPush();
    v16 = HMFGetOSLogHandle();
    v23 = os_log_type_enabled(v16, OS_LOG_TYPE_ERROR);
    if (v12)
    {
      if (!v23)
      {
        goto LABEL_15;
      }

      v17 = HMFGetLogIdentifier();
      uUIDString = [identifierCopy UUIDString];
      uUIDString2 = [dCopy UUIDString];
      *buf = 138543874;
      v30 = v17;
      v31 = 2112;
      v32 = uUIDString;
      v33 = 2112;
      v34 = uUIDString2;
      v25 = "%{public}@Did not find invitation %@ in any homes, cannot handle request. But did find home with corresponding homeUUID %@";
    }

    else
    {
      if (!v23)
      {
        goto LABEL_15;
      }

      v17 = HMFGetLogIdentifier();
      uUIDString = [identifierCopy UUIDString];
      uUIDString2 = [dCopy UUIDString];
      *buf = 138543874;
      v30 = v17;
      v31 = 2112;
      v32 = uUIDString;
      v33 = 2112;
      v34 = uUIDString2;
      v25 = "%{public}@Did not find invitation %@ in any homes (requested: %@), cannot handle request.";
    }

    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, v25, buf, 0x20u);

    goto LABEL_14;
  }

  uuid = [v12 uuid];
  v14 = [uuid hmf_isEqualToUUID:dCopy];

  if (v14)
  {
    goto LABEL_16;
  }

  v15 = objc_autoreleasePoolPush();
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
  {
    v17 = HMFGetLogIdentifier();
    uUIDString = [identifierCopy UUIDString];
    uuid2 = [v12 uuid];
    uUIDString3 = [uuid2 UUIDString];
    [dCopy UUIDString];
    v21 = v28 = v15;
    *buf = 138544130;
    v30 = v17;
    v31 = 2112;
    v32 = uUIDString;
    v33 = 2112;
    v34 = uUIDString3;
    v35 = 2112;
    v36 = v21;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Found invitation %@ in home %@ but was supposed to find it in %@. Dropping request.", buf, 0x2Au);

    v15 = v28;
LABEL_14:
  }

LABEL_15:

  objc_autoreleasePoolPop(v15);
  v12 = 0;
LABEL_16:

  v26 = *MEMORY[0x277D85DE8];

  return v12;
}

- (id)__homeContainingInviteWithInvitationIdentifier:(id)identifier
{
  v39 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v26 objects:v38 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v27;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v27 != v8)
        {
          objc_enumerationMutation(homes);
        }

        v10 = *(*(&v26 + 1) + 8 * i);
        v11 = [v10 invitationWithInvitationIdentifier:identifierCopy];
        if (v11)
        {
          v13 = v11;
          v14 = objc_autoreleasePoolPush();
          v15 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
          {
            v16 = HMFGetLogIdentifier();
            idsInvitationUUID = [v13 idsInvitationUUID];
            uUIDString = [idsInvitationUUID UUIDString];
            identifier = [v13 identifier];
            uUIDString2 = [identifier UUIDString];
            [v10 uuid];
            v19 = v25 = v14;
            uUIDString3 = [v19 UUIDString];
            *buf = 138544130;
            v31 = v16;
            v32 = 2112;
            v33 = uUIDString;
            v34 = 2112;
            v35 = uUIDString2;
            v36 = 2112;
            v37 = uUIDString3;
            _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Found matching invitatation with idsInviteID %@ homeInviteID %@ in home %@", buf, 0x2Au);

            v14 = v25;
          }

          objc_autoreleasePoolPop(v14);
          v12 = v10;

          goto LABEL_13;
        }
      }

      v7 = [homes countByEnumeratingWithState:&v26 objects:v38 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v12 = 0;
LABEL_13:

  v21 = *MEMORY[0x277D85DE8];

  return v12;
}

- (id)__homeContainingInviteWithIDSInvitationIdentifier:(id)identifier
{
  v38 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v25 objects:v37 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v26;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v26 != v8)
        {
          objc_enumerationMutation(homes);
        }

        v10 = *(*(&v25 + 1) + 8 * i);
        v11 = [v10 invitationWithIDSInvitationIdentifier:identifierCopy];
        if (v11)
        {
          v13 = v11;
          v14 = objc_autoreleasePoolPush();
          v15 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
          {
            v16 = HMFGetLogIdentifier();
            uUIDString = [identifierCopy UUIDString];
            identifier = [v13 identifier];
            uUIDString2 = [identifier UUIDString];
            uuid = [v10 uuid];
            [uuid UUIDString];
            v20 = v24 = v14;
            *buf = 138544130;
            v30 = v16;
            v31 = 2112;
            v32 = uUIDString;
            v33 = 2112;
            v34 = uUIDString2;
            v35 = 2112;
            v36 = v20;
            _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Found matching invitatation with idsInviteID %@ homeInviteID %@ in home %@", buf, 0x2Au);

            v14 = v24;
          }

          objc_autoreleasePoolPop(v14);
          v12 = v10;

          goto LABEL_13;
        }
      }

      v7 = [homes countByEnumeratingWithState:&v25 objects:v37 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v12 = 0;
LABEL_13:

  v21 = *MEMORY[0x277D85DE8];

  return v12;
}

- (void)handleCancelRequestForIDSInvitationWithIdentifier:(id)identifier
{
  v19 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  if (identifierCopy)
  {
    incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
    v6 = [incomingInvitations hmf_firstObjectWithValue:identifierCopy forKeyPath:@"idsInvitationUUID"];

    if (v6)
    {
      [(HMDHomeManager *)self _handleRequestToCancelHomeInvitation:v6 saveReason:@"cancelIDSReceivedInvite"];
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v12 = HMFGetLogIdentifier();
        uUIDString = [identifierCopy UUIDString];
        v15 = 138543618;
        v16 = v12;
        v17 = 2112;
        v18 = uUIDString;
        _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Invalid invite IDS identifier specified %@", &v15, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
    }
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v15 = 138543362;
      v16 = v9;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_ERROR, "%{public}@Cannot cancel invite, not IDS invite identifier specified.", &v15, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)handleDeclineRequestForIDSInvitationWithIdentifier:(id)identifier fromAddress:(id)address homeUUID:(id)d
{
  v22 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  addressCopy = address;
  dCopy = d;
  v11 = [(HMDHomeManager *)self _homeFromIncomingInvitationWithIdentifier:identifierCopy homeUUID:dCopy];
  v12 = v11;
  if (v11)
  {
    [v11 handleDeclineRequestForIDSInvitationWithIdentifier:identifierCopy fromAddress:addressCopy];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      uUIDString = [identifierCopy UUIDString];
      v18 = 138543618;
      v19 = v15;
      v20 = 2112;
      v21 = uUIDString;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@Did not find invitation %@ in any homes, cannot handle decline request.", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)handleAcceptRequestForIDSInvitationWithIdentifier:(id)identifier homeUUID:(id)d payload:(id)payload fromAddress:(id)address fromMergeID:(id)iD
{
  identifierCopy = identifier;
  dCopy = d;
  payloadCopy = payload;
  addressCopy = address;
  iDCopy = iD;
  workQueue = [(HMDHomeManager *)self workQueue];
  v23[0] = MEMORY[0x277D85DD0];
  v23[1] = 3221225472;
  v23[2] = __125__HMDHomeManager_IDSInvitations__handleAcceptRequestForIDSInvitationWithIdentifier_homeUUID_payload_fromAddress_fromMergeID___block_invoke;
  v23[3] = &unk_278683598;
  v24 = payloadCopy;
  selfCopy = self;
  v26 = identifierCopy;
  v27 = dCopy;
  v28 = addressCopy;
  v29 = iDCopy;
  v18 = iDCopy;
  v19 = addressCopy;
  v20 = dCopy;
  v21 = identifierCopy;
  v22 = payloadCopy;
  dispatch_async(workQueue, v23);
}

void __125__HMDHomeManager_IDSInvitations__handleAcceptRequestForIDSInvitationWithIdentifier_homeUUID_payload_fromAddress_fromMergeID___block_invoke(uint64_t a1)
{
  v24 = *MEMORY[0x277D85DE8];
  v2 = objc_alloc(MEMORY[0x277CCAD78]);
  v3 = [*(a1 + 32) hmf_stringForKey:@"kInvitationIdentifierKey"];
  v4 = [v2 initWithUUIDString:v3];

  v5 = [*(a1 + 40) _homeFromIncomingInvitationWithIdentifier:*(a1 + 48) invitationIdentifier:v4 homeUUID:*(a1 + 56)];
  if (v5)
  {
    v6 = [HMDAccountHandle accountHandleForDestination:*(a1 + 64)];
    v7 = [HMDUser userIDForAccountHandle:v6];
    v8 = [*(a1 + 40) idsFirewallManager];
    v14[0] = MEMORY[0x277D85DD0];
    v14[1] = 3221225472;
    v14[2] = __125__HMDHomeManager_IDSInvitations__handleAcceptRequestForIDSInvitationWithIdentifier_homeUUID_payload_fromAddress_fromMergeID___block_invoke_3;
    v14[3] = &unk_278675A28;
    v14[4] = *(a1 + 40);
    v15 = *(a1 + 64);
    v16 = v5;
    v17 = *(a1 + 48);
    v18 = *(a1 + 32);
    v19 = *(a1 + 72);
    [v8 handleDidAddUserWithUserID:v7 completion:v14];
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [*(a1 + 48) UUIDString];
      *buf = 138543618;
      v21 = v11;
      v22 = 2112;
      v23 = v12;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Did not find invitation %@ in any homes, cannot handle accept request.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __125__HMDHomeManager_IDSInvitations__handleAcceptRequestForIDSInvitationWithIdentifier_homeUUID_payload_fromAddress_fromMergeID___block_invoke_3(id *a1, void *a2)
{
  v27 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = a1[4];
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = a1[5];
    *buf = 138543875;
    v22 = v7;
    v23 = 2117;
    v24 = v8;
    v25 = 2114;
    v26 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@IDS firewall user donation completed for userID %{sensitive}@ with error %{public}@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  v9 = [a1[6] workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __125__HMDHomeManager_IDSInvitations__handleAcceptRequestForIDSInvitationWithIdentifier_homeUUID_payload_fromAddress_fromMergeID___block_invoke_4;
  block[3] = &unk_278689550;
  v10 = a1[6];
  v11 = a1[7];
  v12 = a1[8];
  v13 = a1[5];
  *&v14 = v12;
  *(&v14 + 1) = v13;
  *&v15 = v10;
  *(&v15 + 1) = v11;
  v18 = v15;
  v19 = v14;
  v20 = a1[9];
  dispatch_async(v9, block);

  v16 = *MEMORY[0x277D85DE8];
}

- (void)handleReceivedIDSInviteFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload
{
  identifierCopy = identifier;
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __109__HMDHomeManager_IDSInvitations__handleReceivedIDSInviteFromAccount_mergeID_idsInvitationIdentifier_payload___block_invoke;
  v12[3] = &unk_278689DC0;
  v13 = identifierCopy;
  v11 = identifierCopy;
  [(HMDHomeManager *)self _handleAccessHomeInviteFromAccount:account mergeID:d idsInvitationIdentifier:v11 payload:payload messageResponseHandler:v12];
}

void __109__HMDHomeManager_IDSInvitations__handleReceivedIDSInviteFromAccount_mergeID_idsInvitationIdentifier_payload___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v23 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_ERROR);
  if (v5)
  {
    if (v9)
    {
      v10 = HMFGetLogIdentifier();
      v11 = *(a1 + 32);
      v17 = 138543874;
      v18 = v10;
      v19 = 2112;
      v20 = v11;
      v21 = 2112;
      v22 = v5;
      v12 = "%{public}@Could not process received ids invitation %@ due to error %@";
      v13 = v8;
      v14 = 32;
LABEL_6:
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, v12, &v17, v14);
    }
  }

  else if (v9)
  {
    v10 = HMFGetLogIdentifier();
    v15 = *(a1 + 32);
    v17 = 138543618;
    v18 = v10;
    v19 = 2112;
    v20 = v15;
    v12 = "%{public}@Successfully processed received ids invitation %@.";
    v13 = v8;
    v14 = 22;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v7);
  v16 = *MEMORY[0x277D85DE8];
}

- (id)mediaGroupUsingHintsForHomeUUID:(id)d accessoryUUID:(id)iD
{
  v30 = *MEMORY[0x277D85DE8];
  dCopy = d;
  iDCopy = iD;
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];

  if (mediaSystemHints)
  {
    homeUUIDFromHints = [(HMDHomeManager *)self homeUUIDFromHints];
    mediaSystemUUIDFromHints = [(HMDHomeManager *)self mediaSystemUUIDFromHints];
    peerAccessoryUUIDFromHints = [(HMDHomeManager *)self peerAccessoryUUIDFromHints];
    peerAccessoryRoleFromHints = [(HMDHomeManager *)self peerAccessoryRoleFromHints];
    v13 = peerAccessoryRoleFromHints;
    v14 = 0;
    if (homeUUIDFromHints && mediaSystemUUIDFromHints && peerAccessoryUUIDFromHints && peerAccessoryRoleFromHints)
    {
      if ([dCopy hmf_isEqualToUUID:homeUUIDFromHints])
      {
        roomNameSentinel = [MEMORY[0x277CD1C08] roomNameSentinel];
        leftRole = [MEMORY[0x277CD1C10] leftRole];
        v17 = [v13 isEqual:leftRole];

        if (v17)
        {
          v18 = peerAccessoryUUIDFromHints;
        }

        else
        {
          v18 = iDCopy;
        }

        if (v17)
        {
          v19 = iDCopy;
        }

        else
        {
          v19 = peerAccessoryUUIDFromHints;
        }

        v20 = v18;
        v21 = v19;
        v14 = [objc_alloc(MEMORY[0x277CD1C08]) initWithIdentifier:mediaSystemUUIDFromHints parentIdentifier:dCopy name:roomNameSentinel defaultName:1 associatedGroupIdentifier:0 leftDestinationIdentifier:v20 rightDestinationIdentifier:v21];
      }

      else
      {
        v22 = objc_autoreleasePoolPush();
        selfCopy = self;
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v29 = v25;
          _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_ERROR, "%{public}@Home UUID is different from the current accessory home UUID", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v22);
        v14 = 0;
      }
    }
  }

  else
  {
    v14 = 0;
  }

  v26 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)peerAccessoryRoleFromHints
{
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];

  if (mediaSystemHints)
  {
    mediaSystemHints2 = [(HMDHomeManager *)self mediaSystemHints];
    peerAccessoryRoleString = [mediaSystemHints2 peerAccessoryRoleString];
    v6 = StringAsHMMediaSystemRoleType();

    v7 = [objc_alloc(MEMORY[0x277CD1C10]) initWithRole:v6];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)peerAccessoryUUIDFromHints
{
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];
  if (mediaSystemHints)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    mediaSystemHints2 = [(HMDHomeManager *)self mediaSystemHints];
    peerAccessoryUUIDString = [mediaSystemHints2 peerAccessoryUUIDString];
    v7 = [v4 initWithUUIDString:peerAccessoryUUIDString];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)mediaSystemUUIDFromHints
{
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];
  if (mediaSystemHints)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    mediaSystemHints2 = [(HMDHomeManager *)self mediaSystemHints];
    mediaSystemUUIDString = [mediaSystemHints2 mediaSystemUUIDString];
    v7 = [v4 initWithUUIDString:mediaSystemUUIDString];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)homeUUIDFromHints
{
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];
  if (mediaSystemHints)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    mediaSystemHints2 = [(HMDHomeManager *)self mediaSystemHints];
    mediaSystemHomeUUIDString = [mediaSystemHints2 mediaSystemHomeUUIDString];
    v7 = [v4 initWithUUIDString:mediaSystemHomeUUIDString];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (BOOL)hasMediaSystemHints
{
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];
  if (mediaSystemHints)
  {
    mediaSystemHints2 = [(HMDHomeManager *)self mediaSystemHints];
    mediaSystemHomeUUIDString = [mediaSystemHints2 mediaSystemHomeUUIDString];
    if (mediaSystemHomeUUIDString)
    {
      mediaSystemHints3 = [(HMDHomeManager *)self mediaSystemHints];
      mediaSystemUUIDString = [mediaSystemHints3 mediaSystemUUIDString];
      if (mediaSystemUUIDString)
      {
        mediaSystemHints4 = [(HMDHomeManager *)self mediaSystemHints];
        peerAccessoryUUIDString = [mediaSystemHints4 peerAccessoryUUIDString];
        if (peerAccessoryUUIDString)
        {
          mediaSystemHints5 = [(HMDHomeManager *)self mediaSystemHints];
          peerAccessoryRoleString = [mediaSystemHints5 peerAccessoryRoleString];
          v12 = peerAccessoryRoleString != 0;
        }

        else
        {
          v12 = 0;
        }
      }

      else
      {
        v12 = 0;
      }
    }

    else
    {
      v12 = 0;
    }
  }

  else
  {
    v12 = 0;
  }

  return v12;
}

- (BOOL)restoreMediaSystemHintsFromDisk
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Ask to restore the media system hints from previously saved hints", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
  v8 = [userDefaults objectForKey:*MEMORY[0x277CD2450]];

  userDefaults2 = [(HMDHomeManager *)selfCopy userDefaults];
  v10 = [userDefaults2 objectForKey:*MEMORY[0x277CD2470]];

  userDefaults3 = [(HMDHomeManager *)selfCopy userDefaults];
  v12 = [userDefaults3 objectForKey:*MEMORY[0x277CD24A0]];

  userDefaults4 = [(HMDHomeManager *)selfCopy userDefaults];
  v14 = [userDefaults4 objectForKey:*MEMORY[0x277CD2498]];

  if (v8)
  {
    v15 = v10 == 0;
  }

  else
  {
    v15 = 1;
  }

  v17 = v15 || v12 == 0 || v14 == 0;
  v18 = !v17;
  if (!v17)
  {
    v19 = [[HMDMediaSystemHints alloc] initWithMediaSystemHomeUUIDString:v8 mediaSystemUUIDString:v10 peerAccessoryUUIDString:v12 peerAccessoryRoleString:v14];
    [(HMDHomeManager *)selfCopy setMediaSystemHints:v19];
  }

  v20 = *MEMORY[0x277D85DE8];
  return v18;
}

- (void)clearMediaSystemHints:(BOOL)hints
{
  hintsCopy = hints;
  v22 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    mediaSystemHints = [(HMDHomeManager *)selfCopy mediaSystemHints];
    v10 = HMFBooleanToString();
    v16 = 138543874;
    v17 = v8;
    v18 = 2112;
    v19 = mediaSystemHints;
    v20 = 2112;
    v21 = v10;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Ask to clear the media system hints %@, persist to disk: %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)selfCopy setMediaSystemHints:0];
  if (hintsCopy)
  {
    userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
    [userDefaults removeObjectForKey:*MEMORY[0x277CD2450]];

    userDefaults2 = [(HMDHomeManager *)selfCopy userDefaults];
    [userDefaults2 removeObjectForKey:*MEMORY[0x277CD2470]];

    userDefaults3 = [(HMDHomeManager *)selfCopy userDefaults];
    [userDefaults3 removeObjectForKey:*MEMORY[0x277CD24A0]];

    userDefaults4 = [(HMDHomeManager *)selfCopy userDefaults];
    [userDefaults4 removeObjectForKey:*MEMORY[0x277CD2498]];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)saveMediaSystemHintsWithHomeUUIDString:(id)string mediaSystemUUIDString:(id)dString peerAccessoryUUIDString:(id)iDString peerAccessoryRoleString:(id)roleString persistToDisk:(BOOL)disk
{
  diskCopy = disk;
  v46 = *MEMORY[0x277D85DE8];
  stringCopy = string;
  dStringCopy = dString;
  iDStringCopy = iDString;
  roleStringCopy = roleString;
  mediaSystemHints = [(HMDHomeManager *)self mediaSystemHints];

  if (mediaSystemHints)
  {
    v17 = objc_autoreleasePoolPush();
    selfCopy = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v20 = v38 = diskCopy;
      mediaSystemHints2 = [(HMDHomeManager *)selfCopy mediaSystemHints];
      *buf = 138543618;
      v41 = v20;
      v42 = 2112;
      v43 = mediaSystemHints2;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Overwriting existing media system hints %@", buf, 0x16u);

      diskCopy = v38;
    }

    objc_autoreleasePoolPop(v17);
  }

  v22 = [[HMDMediaSystemHints alloc] initWithMediaSystemHomeUUIDString:stringCopy mediaSystemUUIDString:dStringCopy peerAccessoryUUIDString:iDStringCopy peerAccessoryRoleString:roleStringCopy];
  [(HMDHomeManager *)self setMediaSystemHints:v22];

  v23 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
  {
    v26 = HMFGetLogIdentifier();
    mediaSystemHints3 = [(HMDHomeManager *)selfCopy2 mediaSystemHints];
    HMFBooleanToString();
    v39 = roleStringCopy;
    v28 = iDStringCopy;
    v29 = dStringCopy;
    v30 = stringCopy;
    v32 = v31 = diskCopy;
    *buf = 138543874;
    v41 = v26;
    v42 = 2112;
    v43 = mediaSystemHints3;
    v44 = 2112;
    v45 = v32;
    _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Set media system hints to %@, persist to disk: %@", buf, 0x20u);

    diskCopy = v31;
    stringCopy = v30;
    dStringCopy = v29;
    iDStringCopy = v28;
    roleStringCopy = v39;
  }

  objc_autoreleasePoolPop(v23);
  if (diskCopy)
  {
    userDefaults = [(HMDHomeManager *)selfCopy2 userDefaults];
    [userDefaults setObject:stringCopy forKey:*MEMORY[0x277CD2450]];

    userDefaults2 = [(HMDHomeManager *)selfCopy2 userDefaults];
    [userDefaults2 setObject:dStringCopy forKey:*MEMORY[0x277CD2470]];

    userDefaults3 = [(HMDHomeManager *)selfCopy2 userDefaults];
    [userDefaults3 setObject:iDStringCopy forKey:*MEMORY[0x277CD24A0]];

    userDefaults4 = [(HMDHomeManager *)selfCopy2 userDefaults];
    [userDefaults4 setObject:roleStringCopy forKey:*MEMORY[0x277CD2498]];
  }

  v37 = *MEMORY[0x277D85DE8];
}

- (void)handleRemoveMediaSystemHints:(id)hints
{
  v12 = *MEMORY[0x277D85DE8];
  hintsCopy = hints;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Handling remove media system hints message", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)selfCopy clearMediaSystemHints:0];
  [hintsCopy respondWithSuccess];

  v9 = *MEMORY[0x277D85DE8];
}

- (void)handleAddMediaSystemHints:(id)hints
{
  v29 = *MEMORY[0x277D85DE8];
  hintsCopy = hints;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v27 = 138543362;
    v28 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Handling add media system hints message", &v27, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  messagePayload = [hintsCopy messagePayload];
  v10 = [messagePayload objectForKeyedSubscript:*MEMORY[0x277CD2450]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v11 = v10;
  }

  else
  {
    v11 = 0;
  }

  v12 = v11;

  messagePayload2 = [hintsCopy messagePayload];
  v14 = [messagePayload2 objectForKeyedSubscript:*MEMORY[0x277CD2470]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v15 = v14;
  }

  else
  {
    v15 = 0;
  }

  v16 = v15;

  messagePayload3 = [hintsCopy messagePayload];
  v18 = [messagePayload3 objectForKeyedSubscript:*MEMORY[0x277CD24A0]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v19 = v18;
  }

  else
  {
    v19 = 0;
  }

  v20 = v19;

  messagePayload4 = [hintsCopy messagePayload];
  v22 = [messagePayload4 objectForKeyedSubscript:*MEMORY[0x277CD2498]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v23 = v22;
  }

  else
  {
    v23 = 0;
  }

  v24 = v23;

  if (v12 && v16 && v20 && v24)
  {
    [(HMDHomeManager *)selfCopy saveMediaSystemHintsWithHomeUUIDString:v12 mediaSystemUUIDString:v16 peerAccessoryUUIDString:v20 peerAccessoryRoleString:v24 persistToDisk:0];
    [hintsCopy respondWithSuccess];
  }

  else
  {
    v25 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [hintsCopy respondWithError:v25];
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (void)_registerForMediaSystemHintsMessages
{
  v19 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v18 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for media system hints messages", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
  v9 = *MEMORY[0x277CD2090];
  v16 = v7;
  v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
  [messageDispatcher registerForMessage:v9 receiver:selfCopy policies:v10 selector:sel_handleAddMediaSystemHints_];

  messageDispatcher2 = [(HMDHomeManager *)selfCopy messageDispatcher];
  v12 = *MEMORY[0x277CD2510];
  v15 = v7;
  v13 = [MEMORY[0x277CBEA60] arrayWithObjects:&v15 count:1];
  [messageDispatcher2 registerForMessage:v12 receiver:selfCopy policies:v13 selector:sel_handleRemoveMediaSystemHints_];

  v14 = *MEMORY[0x277D85DE8];
}

- (void)autoAddWalletKeysOncePerDeviceSetup
{
  v38 = *MEMORY[0x277D85DE8];
  v24 = objc_alloc_init(HMDHomeWalletDataSource);
  v22 = [(HMDHomeWalletDataSource *)v24 numberValueFromNoBackupStoreWithKey:@"HMDHomeManagerRecordInitialWalletKeysOncePerDevice"];
  if (([v22 BOOLValue] & 1) == 0)
  {
    v3 = [HMDWalletPassLibrary alloc];
    workQueue = [(HMDHomeManager *)self workQueue];
    v5 = [(HMDWalletPassLibrary *)v3 initWithWorkQueue:workQueue];

    v6 = +[HMDHomeKeyDataRecorder sharedRecorder];
    walletKeys = [(HMDWalletPassLibrary *)v5 walletKeys];
    allObjects = [walletKeys allObjects];
    [v6 recordInitialWalletKeys:allObjects];

    [(HMDHomeWalletDataSource *)v24 persistNumberValueToNoBackupStore:MEMORY[0x277CBEC38] withKey:@"HMDHomeManagerRecordInitialWalletKeysOncePerDevice"];
  }

  internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v10 = objc_autoreleasePoolPush();
  selfCopy = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    uUID = [internalOnlyInitializer UUID];
    *buf = 138543618;
    v35 = v13;
    v36 = 2112;
    v37 = uUID;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Auto add wallet keys once per device setup", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  v31 = 0u;
  v32 = 0u;
  v29 = 0u;
  v30 = 0u;
  obj = [(HMDHomeManager *)selfCopy homes];
  v15 = [obj countByEnumeratingWithState:&v29 objects:v33 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v30;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v30 != v17)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v29 + 1) + 8 * i);
        workQueue2 = [v19 workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __61__HMDHomeManager_Wallet__autoAddWalletKeysOncePerDeviceSetup__block_invoke;
        block[3] = &unk_2786891E0;
        block[4] = v19;
        v26 = v24;
        v27 = selfCopy;
        v28 = internalOnlyInitializer;
        dispatch_async(workQueue2, block);
      }

      v16 = [obj countByEnumeratingWithState:&v29 objects:v33 count:16];
    }

    while (v16);
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager_Wallet__autoAddWalletKeysOncePerDeviceSetup__block_invoke(id *a1)
{
  v35 = *MEMORY[0x277D85DE8];
  v2 = MEMORY[0x277CCAD78];
  v3 = [a1[4] uuid];
  v4 = [@"D4F5EA54-226C-44B6-B7CD-45DA59BE5B1F" dataUsingEncoding:4];
  v5 = [v2 hmf_UUIDWithNamespace:v3 data:v4];
  v6 = [v5 UUIDString];

  v7 = [a1[5] numberValueFromNoBackupStoreWithKey:v6];
  v8 = objc_autoreleasePoolPush();
  v9 = a1[6];
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v12 = [a1[7] UUID];
    v13 = a1[4];
    v27 = 138544130;
    v28 = v11;
    v29 = 2112;
    v30 = v12;
    v31 = 2112;
    v32 = v13;
    v33 = 2112;
    v34 = v6;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Auto add wallet key preference key for home %@:%@", &v27, 0x2Au);
  }

  objc_autoreleasePoolPop(v8);
  v14 = [v7 BOOLValue];
  v15 = objc_autoreleasePoolPush();
  v16 = a1[6];
  v17 = HMFGetOSLogHandle();
  v18 = os_log_type_enabled(v17, OS_LOG_TYPE_INFO);
  if (v14)
  {
    if (v18)
    {
      v19 = HMFGetLogIdentifier();
      v20 = [a1[7] UUID];
      v21 = a1[4];
      v27 = 138543874;
      v28 = v19;
      v29 = 2112;
      v30 = v20;
      v31 = 2112;
      v32 = v21;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Already auto added wallet key once per device setup for home: %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v15);
  }

  else
  {
    if (v18)
    {
      v22 = HMFGetLogIdentifier();
      v23 = [a1[7] UUID];
      v24 = a1[4];
      v27 = 138543874;
      v28 = v22;
      v29 = 2112;
      v30 = v23;
      v31 = 2112;
      v32 = v24;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Auto adding wallet key once per device setup for home: %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v15);
    v25 = [a1[4] walletKeyManager];
    [v25 autoAddWalletKeyWithFlow:a1[7]];

    [a1[5] persistNumberValueToNoBackupStore:MEMORY[0x277CBEC38] withKey:v6];
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (void)removeHomeWalletKeysExcludingSerialNumbers:(id)numbers flow:(id)flow
{
  v53 = *MEMORY[0x277D85DE8];
  numbersCopy = numbers;
  flowCopy = flow;
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    uUID = [flowCopy UUID];
    *buf = 138543874;
    v48 = v9;
    v49 = 2112;
    v50 = uUID;
    v51 = 2112;
    v52 = numbersCopy;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Removing home wallet keys with serial number not in: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v11 = [HMDWalletPassLibrary alloc];
  workQueue = [(HMDHomeManager *)selfCopy workQueue];
  v13 = [(HMDWalletPassLibrary *)v11 initWithWorkQueue:workQueue];

  v38 = v13;
  walletKeys = [(HMDWalletPassLibrary *)v13 walletKeys];
  v15 = objc_autoreleasePoolPush();
  v16 = selfCopy;
  v17 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
  {
    v18 = HMFGetLogIdentifier();
    uUID2 = [flowCopy UUID];
    *buf = 138543874;
    v48 = v18;
    v49 = 2112;
    v50 = uUID2;
    v51 = 2112;
    v52 = walletKeys;
    _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Existing home keys in wallet: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v15);
  v44 = 0u;
  v45 = 0u;
  v42 = 0u;
  v43 = 0u;
  obj = walletKeys;
  v20 = [obj countByEnumeratingWithState:&v42 objects:v46 count:16];
  if (v20)
  {
    v22 = v20;
    v23 = *v43;
    *&v21 = 138543874;
    v37 = v21;
    do
    {
      for (i = 0; i != v22; ++i)
      {
        if (*v43 != v23)
        {
          objc_enumerationMutation(obj);
        }

        v25 = *(*(&v42 + 1) + 8 * i);
        serialNumber = [v25 serialNumber];
        v27 = [numbersCopy containsObject:serialNumber];

        if ((v27 & 1) == 0)
        {
          v28 = objc_autoreleasePoolPush();
          v29 = v16;
          v30 = v16;
          v31 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
          {
            v32 = HMFGetLogIdentifier();
            uUID3 = [flowCopy UUID];
            *buf = v37;
            v48 = v32;
            v49 = 2112;
            v50 = uUID3;
            v51 = 2112;
            v52 = v25;
            _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Removing wallet key that doesn't belong to any home: %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v28);
          typeIdentifier = [v25 typeIdentifier];
          serialNumber2 = [v25 serialNumber];
          [(HMDWalletPassLibrary *)v38 removePassWithTypeIdentifier:typeIdentifier serialNumber:serialNumber2 flow:flowCopy];

          v16 = v29;
        }
      }

      v22 = [obj countByEnumeratingWithState:&v42 objects:v46 count:16];
    }

    while (v22);
  }

  v36 = *MEMORY[0x277D85DE8];
}

- (NSSet)homeUUIDsWithAutoAddWalletKeySuppressed
{
  os_unfair_lock_lock_with_options();
  homeUUIDsWithAutoAddWalletKeySuppressedSync = [(HMDHomeManager *)self homeUUIDsWithAutoAddWalletKeySuppressedSync];
  os_unfair_lock_unlock(&self->_lock);

  return homeUUIDsWithAutoAddWalletKeySuppressedSync;
}

- (void)handleXPCConnectionDeactivatedNotification:(id)notification
{
  v35 = *MEMORY[0x277D85DE8];
  notificationCopy = notification;
  userInfo = [notificationCopy userInfo];
  v6 = [userInfo objectForKeyedSubscript:@"connection"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if (!v8)
  {
    _HMFPreconditionFailure();
  }

  v9 = objc_autoreleasePoolPush();
  selfCopy = self;
  v11 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
  {
    v12 = HMFGetLogIdentifier();
    *buf = 138543618;
    v32 = v12;
    v33 = 2112;
    v34 = v8;
    _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Handling wallet key assertion when xpc connection was removed: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  os_unfair_lock_lock_with_options();
  homeUUIDsWithAutoAddWalletKeySuppressedSync = [(HMDHomeManager *)selfCopy homeUUIDsWithAutoAddWalletKeySuppressedSync];
  v14 = [homeUUIDsWithAutoAddWalletKeySuppressedSync mutableCopy];

  homeUUIDsByWalletKeyAssertionXPCConnection = [(HMDHomeManager *)selfCopy homeUUIDsByWalletKeyAssertionXPCConnection];
  [homeUUIDsByWalletKeyAssertionXPCConnection removeObjectForKey:v8];

  homeUUIDsWithAutoAddWalletKeySuppressedSync2 = [(HMDHomeManager *)selfCopy homeUUIDsWithAutoAddWalletKeySuppressedSync];
  [v14 minusSet:homeUUIDsWithAutoAddWalletKeySuppressedSync2];

  os_unfair_lock_unlock(&selfCopy->_lock);
  if ([v14 count])
  {
    v17 = objc_autoreleasePoolPush();
    v18 = selfCopy;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543618;
      v32 = v20;
      v33 = 2112;
      v34 = v14;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Auto adding wallet key due to xpc connection was removed for homes with UUIDs: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    v21 = v14;
    v22 = [v21 countByEnumeratingWithState:&v26 objects:v30 count:16];
    if (v22)
    {
      v23 = *v27;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v27 != v23)
          {
            objc_enumerationMutation(v21);
          }

          [(HMDHomeManager *)v18 addWalletKeyWithHomeUUID:*(*(&v26 + 1) + 8 * i) reason:@"connection removed", v26];
        }

        v22 = [v21 countByEnumeratingWithState:&v26 objects:v30 count:16];
      }

      while (v22);
    }
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (id)homeUUIDsWithAutoAddWalletKeySuppressedSync
{
  v21 = *MEMORY[0x277D85DE8];
  os_unfair_lock_assert_owner(&self->_lock);
  v3 = [MEMORY[0x277CBEB58] set];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  homeUUIDsByWalletKeyAssertionXPCConnection = [(HMDHomeManager *)self homeUUIDsByWalletKeyAssertionXPCConnection];
  v5 = [homeUUIDsByWalletKeyAssertionXPCConnection countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v17;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v17 != v7)
        {
          objc_enumerationMutation(homeUUIDsByWalletKeyAssertionXPCConnection);
        }

        v9 = *(*(&v16 + 1) + 8 * i);
        homeUUIDsByWalletKeyAssertionXPCConnection2 = [(HMDHomeManager *)self homeUUIDsByWalletKeyAssertionXPCConnection];
        v11 = [homeUUIDsByWalletKeyAssertionXPCConnection2 objectForKey:v9];
        allObjects = [v11 allObjects];
        [v3 addObjectsFromArray:allObjects];
      }

      v6 = [homeUUIDsByWalletKeyAssertionXPCConnection countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v6);
  }

  v13 = [v3 copy];
  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)addWalletKeyWithHomeUUID:(id)d reason:(id)reason
{
  v33 = *MEMORY[0x277D85DE8];
  dCopy = d;
  reasonCopy = reason;
  v8 = [(HMDHomeManager *)self _homeWithUUID:dCopy];
  if (v8)
  {
    internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
    v10 = objc_autoreleasePoolPush();
    selfCopy = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      uUID = [internalOnlyInitializer UUID];
      *buf = 138544130;
      v26 = v13;
      v27 = 2112;
      v28 = uUID;
      v29 = 2112;
      v30 = dCopy;
      v31 = 2112;
      v32 = reasonCopy;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Auto adding for wallet key for home with uuid: %@ reason: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v10);
    workQueue = [v8 workQueue];
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __58__HMDHomeManager_Wallet__addWalletKeyWithHomeUUID_reason___block_invoke;
    v22[3] = &unk_27868A750;
    v23 = v8;
    v24 = internalOnlyInitializer;
    v16 = internalOnlyInitializer;
    dispatch_async(workQueue, v22);
  }

  else
  {
    v17 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543874;
      v26 = v20;
      v27 = 2112;
      v28 = dCopy;
      v29 = 2112;
      v30 = reasonCopy;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Not auto adding wallet key for home with uuid: %@ reason: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager_Wallet__addWalletKeyWithHomeUUID_reason___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) walletKeyManager];
  [v2 autoAddWalletKeyWithFlow:*(a1 + 40)];
}

- (void)handleAutoAddWalletKeySupressionAssertionReleaseMessage:(id)message
{
  v48 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    messagePayload = [messageCopy messagePayload];
    v42 = 138543874;
    v43 = v9;
    v44 = 2112;
    v45 = messageCopy;
    v46 = 2112;
    v47 = messagePayload;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Handling auto add wallet key suppression assertion release message: %@, payload: %@", &v42, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  transport = [messageCopy transport];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = transport;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  if (v13)
  {
    v14 = [messageCopy uuidForKey:*MEMORY[0x277CD0298]];
    if (v14)
    {
      os_unfair_lock_lock_with_options();
      homeUUIDsByWalletKeyAssertionXPCConnection = [(HMDHomeManager *)selfCopy homeUUIDsByWalletKeyAssertionXPCConnection];
      v16 = [homeUUIDsByWalletKeyAssertionXPCConnection objectForKey:v13];

      v17 = [v16 containsObject:v14];
      v18 = v17;
      if (v17)
      {
        [v16 removeObject:v14];
      }

      homeUUIDsWithAutoAddWalletKeySuppressedSync = [(HMDHomeManager *)selfCopy homeUUIDsWithAutoAddWalletKeySuppressedSync];
      v20 = [homeUUIDsWithAutoAddWalletKeySuppressedSync containsObject:v14];

      os_unfair_lock_unlock(&selfCopy->_lock);
      if (v18)
      {
        [messageCopy respondWithSuccess];
        if (v20)
        {
          v21 = objc_autoreleasePoolPush();
          v22 = selfCopy;
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            v42 = 138543618;
            v43 = v24;
            v44 = 2112;
            v45 = v14;
            _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Not auto adding wallet key for home with uuid: %@ after assertion was released because of some other pending assertion", &v42, 0x16u);
          }

          objc_autoreleasePoolPop(v21);
        }

        else
        {
          [(HMDHomeManager *)selfCopy addWalletKeyWithHomeUUID:v14 reason:@"assertion released"];
        }
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        v37 = selfCopy;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          v42 = 138543874;
          v43 = v39;
          v44 = 2112;
          v45 = v14;
          v46 = 2112;
          v47 = v13;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_INFO, "%{public}@Could not find any any assertion for home with uuid: %@ for connection: %@", &v42, 0x20u);
        }

        objc_autoreleasePoolPop(v36);
        v40 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        [messageCopy respondWithError:v40];
      }
    }

    else
    {
      v30 = objc_autoreleasePoolPush();
      v31 = selfCopy;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        v33 = HMFGetLogIdentifier();
        messagePayload2 = [messageCopy messagePayload];
        v42 = 138543618;
        v43 = v33;
        v44 = 2112;
        v45 = messagePayload2;
        _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@Missing home uuid parameter in message payload: %@", &v42, 0x16u);
      }

      objc_autoreleasePoolPop(v30);
      v35 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [messageCopy respondWithError:v35];

      v14 = 0;
    }
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = selfCopy;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      v28 = HMFGetLogIdentifier();
      transport2 = [messageCopy transport];
      v42 = 138543618;
      v43 = v28;
      v44 = 2112;
      v45 = transport2;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_ERROR, "%{public}@Received auto add wallet key suppression assertion release message from unknown transport: %@", &v42, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [messageCopy respondWithError:v14];
  }

  v41 = *MEMORY[0x277D85DE8];
}

- (void)handleAutoAddWalletKeySupressionAssertionAcquireMessage:(id)message
{
  v36 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    messagePayload = [messageCopy messagePayload];
    v30 = 138543874;
    v31 = v9;
    v32 = 2112;
    v33 = messageCopy;
    v34 = 2112;
    v35 = messagePayload;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Handling auto add wallet key suppression assertion acquire message: %@, payload: %@", &v30, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  transport = [messageCopy transport];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = transport;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  if (v13)
  {
    v14 = [messageCopy uuidForKey:*MEMORY[0x277CD0298]];
    if (v14)
    {
      os_unfair_lock_lock_with_options();
      homeUUIDsByWalletKeyAssertionXPCConnection = [(HMDHomeManager *)selfCopy homeUUIDsByWalletKeyAssertionXPCConnection];
      v16 = [homeUUIDsByWalletKeyAssertionXPCConnection objectForKey:v13];

      if (!v16)
      {
        v16 = [MEMORY[0x277CBEB58] set];
        homeUUIDsByWalletKeyAssertionXPCConnection2 = [(HMDHomeManager *)selfCopy homeUUIDsByWalletKeyAssertionXPCConnection];
        [homeUUIDsByWalletKeyAssertionXPCConnection2 setObject:v16 forKey:v13];
      }

      [v16 addObject:v14];

      os_unfair_lock_unlock(&selfCopy->_lock);
      [messageCopy respondWithSuccess];
    }

    else
    {
      v23 = objc_autoreleasePoolPush();
      v24 = selfCopy;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
      {
        v26 = HMFGetLogIdentifier();
        messagePayload2 = [messageCopy messagePayload];
        v30 = 138543618;
        v31 = v26;
        v32 = 2112;
        v33 = messagePayload2;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_ERROR, "%{public}@Missing home uuid parameter in message payload: %@", &v30, 0x16u);
      }

      objc_autoreleasePoolPop(v23);
      v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [messageCopy respondWithError:v28];

      v14 = 0;
    }
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = selfCopy;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      transport2 = [messageCopy transport];
      v30 = 138543618;
      v31 = v21;
      v32 = 2112;
      v33 = transport2;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Received auto add wallet key suppression assertion acquire message from unknown transport: %@", &v30, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [messageCopy respondWithError:v14];
  }

  v29 = *MEMORY[0x277D85DE8];
}

- (void)configureForWalletKey
{
  v13[1] = *MEMORY[0x277D85DE8];
  v3 = [HMDXPCMessagePolicy policyWithEntitlements:131077];
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  v5 = *MEMORY[0x277CD0098];
  v13[0] = v3;
  v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v13 count:1];
  [messageDispatcher registerForMessage:v5 receiver:self policies:v6 selector:sel_handleAutoAddWalletKeySupressionAssertionAcquireMessage_];

  messageDispatcher2 = [(HMDHomeManager *)self messageDispatcher];
  v8 = *MEMORY[0x277CD00A0];
  v12 = v3;
  v9 = [MEMORY[0x277CBEA60] arrayWithObjects:&v12 count:1];
  [messageDispatcher2 registerForMessage:v8 receiver:self policies:v9 selector:sel_handleAutoAddWalletKeySupressionAssertionReleaseMessage_];

  notificationCenter = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter addObserver:self selector:sel_handleXPCConnectionDeactivatedNotification_ name:@"HMDXPCClientConnectionDidDeactivateNotification" object:0];

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_maybeCreateLegacyHomeAcceptedZone:(id)zone
{
  zoneCopy = zone;
  if (zoneCopy)
  {
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke;
    v9[3] = &unk_278677B00;
    v9[4] = self;
    v10 = zoneCopy;
    v5 = zoneCopy;
    [(HMDHomeManager *)self _queryLegacyHomeAndAcceptedZoneExists:v5 completion:v9];
  }

  else
  {
    v6 = _HMFPreconditionFailure();
    __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke(v6, v7, v8);
  }
}

void __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke(uint64_t a1, char a2, int a3)
{
  v48[1] = *MEMORY[0x277D85DE8];
  if ((a2 & 1) == 0)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v10 = *(a1 + 40);
      *buf = 138543618;
      v41 = v7;
      v42 = 2112;
      v43 = v10;
      v9 = "%{public}@Skip creating home accepted zone since no legacy home %@ was found";
      goto LABEL_7;
    }

LABEL_8:

    objc_autoreleasePoolPop(v4);
    goto LABEL_17;
  }

  if (a3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v8 = *(a1 + 40);
      *buf = 138543618;
      v41 = v7;
      v42 = 2112;
      v43 = v8;
      v9 = "%{public}@Skip creating home accepted zone for home %@ since it already exists";
LABEL_7:
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, v9, buf, 0x16u);

      goto LABEL_8;
    }

    goto LABEL_8;
  }

  v11 = [*(a1 + 32) _legacyContainer];
  v12 = [v11 privateCloudDatabase];
  v13 = objc_alloc(MEMORY[0x277CBC5E8]);
  v14 = [*(a1 + 32) _legacyHomeAcceptedZoneIDFromHomeUUID:*(a1 + 40)];
  v15 = [v13 initWithZoneID:v14];

  if (v15)
  {
    v16 = objc_alloc(MEMORY[0x277CBC490]);
    v48[0] = v15;
    v17 = [MEMORY[0x277CBEA60] arrayWithObjects:v48 count:1];
    v18 = [v16 initWithRecordZonesToSave:v17 recordZoneIDsToDelete:0];

    v37 = v12;
    [v18 setDatabase:v12];
    v19 = [v18 operationID];
    v20 = objc_autoreleasePoolPush();
    v21 = *(a1 + 32);
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v23 = v36 = v11;
      v24 = *(a1 + 40);
      [v15 zoneID];
      v25 = v35 = v20;
      v26 = [v25 zoneName];
      *buf = 138544130;
      v41 = v23;
      v42 = 2112;
      v43 = v24;
      v44 = 2112;
      v45 = v26;
      v46 = 2112;
      v47 = v19;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Saving legacy home accepted zone for home/zoneAccepted (%@/%@) with operation ID %@", buf, 0x2Au);

      v20 = v35;
      v11 = v36;
    }

    objc_autoreleasePoolPop(v20);
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke_13;
    v38[3] = &unk_278677AD8;
    v38[4] = *(a1 + 32);
    v39 = v19;
    v27 = v19;
    [v18 setModifyRecordZonesCompletionBlock:v38];
    v12 = v37;
    v28 = [v37 operationQueue];
    [v28 addOperation:v18];
  }

  else
  {
    v29 = objc_autoreleasePoolPush();
    v30 = *(a1 + 32);
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
    {
      v32 = HMFGetLogIdentifier();
      v33 = *(a1 + 40);
      *buf = 138543618;
      v41 = v32;
      v42 = 2112;
      v43 = v33;
      _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@Failed to determine legacy accepted zoneID for home %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
  }

LABEL_17:
  v34 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke_13(uint64_t a1, void *a2, void *a3, void *a4)
{
  v22 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 32);
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = *(a1 + 40);
    v16 = 138543874;
    v17 = v13;
    v18 = 2112;
    v19 = v14;
    v20 = 2112;
    v21 = v9;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Completed saving legacy home accepted zone with operation ID %@ and error %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v10);
  v15 = *MEMORY[0x277D85DE8];
}

- (void)_queryLegacyHomeAndAcceptedZoneExists:(id)exists completion:(id)completion
{
  v46[2] = *MEMORY[0x277D85DE8];
  existsCopy = exists;
  completionCopy = completion;
  if (!existsCopy)
  {
    _HMFPreconditionFailure();
  }

  v8 = completionCopy;
  _legacyContainer = [(HMDHomeManager *)self _legacyContainer];
  privateCloudDatabase = [_legacyContainer privateCloudDatabase];
  v11 = [(HMDHomeManager *)self _legacyHomeZoneIDFromHomeUUID:existsCopy];
  v12 = [(HMDHomeManager *)self _legacyHomeAcceptedZoneIDFromHomeUUID:existsCopy];
  v13 = v12;
  if (v11 && v12)
  {
    v32 = _legacyContainer;
    v14 = objc_alloc(MEMORY[0x277CBC3D0]);
    v46[0] = v11;
    v46[1] = v13;
    v15 = [MEMORY[0x277CBEA60] arrayWithObjects:v46 count:2];
    v16 = [v14 initWithRecordZoneIDs:v15];

    v31 = privateCloudDatabase;
    [v16 setDatabase:privateCloudDatabase];
    operationID = [v16 operationID];
    v18 = objc_autoreleasePoolPush();
    selfCopy = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v21 = v30 = v8;
      zoneName = [v11 zoneName];
      *buf = 138544130;
      v39 = v21;
      v40 = 2112;
      v41 = existsCopy;
      v42 = 2112;
      v43 = zoneName;
      v44 = 2112;
      v45 = operationID;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Querying the legacy container for existing home/zone (%@/%@) with operation ID %@", buf, 0x2Au);

      v8 = v30;
    }

    objc_autoreleasePoolPop(v18);
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __83__HMDHomeManager_LegacyHomeZone___queryLegacyHomeAndAcceptedZoneExists_completion___block_invoke;
    v33[3] = &unk_278677AB0;
    v33[4] = selfCopy;
    v34 = operationID;
    v35 = v11;
    v36 = v13;
    v37 = v8;
    v23 = operationID;
    [v16 setFetchRecordZonesCompletionBlock:v33];
    privateCloudDatabase = v31;
    operationQueue = [v31 operationQueue];
    [operationQueue addOperation:v16];

    _legacyContainer = v32;
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543618;
      v39 = v28;
      v40 = 2112;
      v41 = existsCopy;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Failed to determine legacy zoneID for home %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v8[2](v8, 0, 0);
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __83__HMDHomeManager_LegacyHomeZone___queryLegacyHomeAndAcceptedZoneExists_completion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v31 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    *buf = 138543874;
    v26 = v10;
    v27 = 2112;
    v28 = v11;
    v29 = 2112;
    v30 = v6;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Completed fetching record zone with operation ID %@ and error %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  if (v5)
  {
    [v5 objectForKeyedSubscript:*(a1 + 48)];

    [v5 objectForKeyedSubscript:*(a1 + 56)];
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v24 = v6;
      v15 = HMFGetLogIdentifier();
      v16 = HMFBooleanToString();
      v17 = HMFBooleanToString();
      *buf = 138543874;
      v26 = v15;
      v27 = 2112;
      v28 = v16;
      v29 = 2112;
      v30 = v17;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Legacy home zone exists = %@ and legacy home accepted zone = %@", buf, 0x20u);

      v6 = v24;
    }

    objc_autoreleasePoolPop(v12);
    v18 = *(*(a1 + 64) + 16);
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = *(a1 + 32);
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543362;
      v26 = v22;
      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to determine legacy zones returning that neither home zone or home accepted zone exist", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v19);
    v18 = *(*(a1 + 64) + 16);
  }

  v18();

  v23 = *MEMORY[0x277D85DE8];
}

- (id)_legacyHomeAcceptedZoneIDFromHomeUUID:(id)d
{
  dCopy = d;
  if (dCopy)
  {
    v4 = dCopy;
    v5 = [HMDHome zoneIDFromHomeUUID:dCopy];
    v6 = MEMORY[0x277CCACA8];
    uUIDString = [v5 UUIDString];
    v8 = [v6 stringWithFormat:@"%@_accepted", uUIDString];

    v9 = objc_alloc(MEMORY[0x277CBC5F8]);
    v10 = [v9 initWithZoneName:v8 ownerName:*MEMORY[0x277CBBF28]];

    return v10;
  }

  else
  {
    v12 = _HMFPreconditionFailure();
    return [(HMDHomeManager *)v12 _legacyHomeZoneIDFromHomeUUID:v13, v14];
  }
}

- (id)_legacyHomeZoneIDFromHomeUUID:(id)d
{
  dCopy = d;
  if (dCopy)
  {
    v4 = dCopy;
    v5 = [HMDHome zoneIDFromHomeUUID:dCopy];
    v6 = objc_alloc(MEMORY[0x277CBC5F8]);
    uUIDString = [v5 UUIDString];
    v8 = [v6 initWithZoneName:uUIDString ownerName:*MEMORY[0x277CBBF28]];

    return v8;
  }

  else
  {
    v10 = _HMFPreconditionFailure();
    return [(HMDHomeManager *)v10 _legacyContainer];
  }
}

- (id)_legacyContainer
{
  v2 = objc_alloc(MEMORY[0x277CBC220]);
  v3 = [v2 initWithContainerIdentifier:@"com.apple.willow.config" environment:cloudKitContainerEnvironment];
  v4 = [objc_alloc(MEMORY[0x277CBC218]) initWithContainerID:v3];

  return v4;
}

- (void)updatePowerAssertion
{
  v17 = *MEMORY[0x277D85DE8];
  homes = [(HMDHomeManager *)self homes];
  v4 = [homes count] != 0;
  v5 = [homes na_any:&__block_literal_global_134033];
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEBUG))
  {
    v9 = HMFGetLogIdentifier();
    v10 = HMFBooleanToString();
    v13 = 138543618;
    v14 = v9;
    v15 = 2112;
    v16 = v10;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_DEBUG, "%{public}@Setting network access required (power assertion) to %@", &v13, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  powerManager = [(HMDHomeManager *)selfCopy powerManager];
  [powerManager setNetworkAccessRequired:v4 & v5];

  v12 = *MEMORY[0x277D85DE8];
}

uint64_t __55__HMDHomeManager_PowerManagement__updatePowerAssertion__block_invoke(uint64_t a1, void *a2)
{
  v2 = [a2 residentDeviceManager];
  v3 = [v2 residentDevices];
  v4 = [v3 na_any:&__block_literal_global_3_134036];

  return v4;
}

- (void)handleHomeOrResidentUpdated:(id)updated
{
  [(HMDHomeManager *)self _updatePowerAssertion:updated];

  [(HMDHomeManager *)self handleHomeOrResidentsChanged];
}

- (void)registerNotificationsForPowerManagement
{
  notificationCenter = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter addObserver:self selector:sel_handleHomeOrResidentUpdated_ name:@"HMDHomeAddedNotification" object:0];

  notificationCenter2 = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter2 addObserver:self selector:sel_handleHomeOrResidentUpdated_ name:@"HMDHomeRemovedNotification" object:0];

  notificationCenter3 = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter3 addObserver:self selector:sel_handleHomeOrResidentUpdated_ name:@"HMDResidentDeviceManagerAddResidentNotification" object:0];

  notificationCenter4 = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter4 addObserver:self selector:sel_handleHomeOrResidentUpdated_ name:@"HMDResidentDeviceManagerRemoveResidentNotification" object:0];
}

- (void)_pruneExpiredHomesNotYetMigrated
{
  v56 = *MEMORY[0x277D85DE8];
  hmdUserDefaults = [(HMDHomeManager *)self hmdUserDefaults];
  v4 = [hmdUserDefaults objectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = v4;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;

  if (!v6)
  {
    v31 = objc_autoreleasePoolPush();
    selfCopy = self;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEBUG))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v34;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_DEBUG, "%{public}@List of not yet migrated homes is empty.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v31);
    goto LABEL_39;
  }

  v7 = [v6 mutableCopy];
  v47 = 0u;
  v48 = 0u;
  v49 = 0u;
  v50 = 0u;
  v45 = v6;
  v8 = v6;
  v9 = [v8 countByEnumeratingWithState:&v47 objects:v55 count:16];
  if (!v9)
  {
    goto LABEL_23;
  }

  v10 = v9;
  v11 = *v48;
  v46 = v7;
  do
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v48 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v47 + 1) + 8 * i);
      v14 = [v8 objectForKeyedSubscript:v13];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v15 = v14;
      }

      else
      {
        v15 = 0;
      }

      v16 = v15;

      if (v16)
      {
        if (![(HMDHomeManager *)self _isMetadataExpiredForHomeAwaitingAutoAccept:v16])
        {
          goto LABEL_21;
        }

        v17 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543618;
          v52 = v20;
          v53 = 2112;
          v54 = v13;
          v21 = v19;
          v22 = "%{public}@Removing %@ from list of not yet migrated homes.";
LABEL_19:
          _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, v22, buf, 0x16u);
        }
      }

      else
      {
        v17 = objc_autoreleasePoolPush();
        selfCopy3 = self;
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543618;
          v52 = v20;
          v53 = 2112;
          v54 = v13;
          v21 = v19;
          v22 = "%{public}@Failed to parse stashed metadata for not yet migrated home %@, removing it.";
          goto LABEL_19;
        }
      }

      objc_autoreleasePoolPop(v17);
      v7 = v46;
      [v46 removeObjectForKey:v13];
LABEL_21:
    }

    v10 = [v8 countByEnumeratingWithState:&v47 objects:v55 count:16];
  }

  while (v10);
LABEL_23:

  if (![v7 count])
  {
    v35 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v37 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
    {
      v38 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v38;
      _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@All stashed metadata for homes not yet migrated is expired - purging.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v35);
    hmdUserDefaults2 = [(HMDHomeManager *)selfCopy4 hmdUserDefaults];
    [hmdUserDefaults2 removeObjectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];
    goto LABEL_37;
  }

  v24 = [v7 count];
  v25 = [v8 count];
  v26 = objc_autoreleasePoolPush();
  selfCopy5 = self;
  v28 = HMFGetOSLogHandle();
  v29 = os_log_type_enabled(v28, OS_LOG_TYPE_INFO);
  if (v24 != v25)
  {
    if (v29)
    {
      v40 = HMFGetLogIdentifier();
      v41 = [v8 count];
      v42 = [v7 count];
      *buf = 138543618;
      v52 = v40;
      v53 = 2048;
      v54 = v41 - v42;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Purging %lu expired metadata records for homes not yet migrated.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
    hmdUserDefaults2 = [(HMDHomeManager *)selfCopy5 hmdUserDefaults];
    v43 = [v7 copy];
    [hmdUserDefaults2 setObject:v43 forKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];

LABEL_37:
    goto LABEL_38;
  }

  if (v29)
  {
    v30 = HMFGetLogIdentifier();
    *buf = 138543362;
    v52 = v30;
    _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@No homes pending migration were expired, doing nothing.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v26);
LABEL_38:

  v6 = v45;
LABEL_39:

  v44 = *MEMORY[0x277D85DE8];
}

- (void)removeHomeFromSharedHomesNotYetMigrated:(id)migrated
{
  migratedCopy = migrated;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __70__HMDHomeManager_SharedUser__removeHomeFromSharedHomesNotYetMigrated___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = migratedCopy;
  v6 = migratedCopy;
  dispatch_async(workQueue, v7);
}

void __70__HMDHomeManager_SharedUser__removeHomeFromSharedHomesNotYetMigrated___block_invoke(uint64_t a1)
{
  v27 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) hmdUserDefaults];
  v3 = [v2 objectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 32);
  v8 = HMFGetOSLogHandle();
  v9 = v8;
  if (v5)
  {
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *(a1 + 40);
      v12 = [v5 allKeys];
      v21 = 138543874;
      v22 = v10;
      v23 = 2112;
      v24 = v11;
      v25 = 2112;
      v26 = v12;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Removing %@ from list of homes not yet migrated: %@", &v21, 0x20u);
    }

    objc_autoreleasePoolPop(v6);
    v13 = [v5 mutableCopy];
    v14 = [*(a1 + 40) UUIDString];
    [v13 removeObjectForKey:v14];

    v15 = [v13 count];
    v16 = [*(a1 + 32) hmdUserDefaults];
    v17 = v16;
    if (v15)
    {
      v18 = [v13 copy];
      [v17 setObject:v18 forKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];
    }

    else
    {
      [v16 removeObjectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];
    }
  }

  else
  {
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEBUG))
    {
      v19 = HMFGetLogIdentifier();
      v21 = 138543362;
      v22 = v19;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEBUG, "%{public}@No home to remove from list of homes not yet migrated.", &v21, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_autoAcceptInviteIfReinvitation:(id)reinvitation
{
  reinvitationCopy = reinvitation;
  if (!isWatch())
  {
    objc_initWeak(&location, self);
    homeUUID = [reinvitationCopy homeUUID];
    v6[0] = MEMORY[0x277D85DD0];
    v6[1] = 3221225472;
    v6[2] = __62__HMDHomeManager_SharedUser___autoAcceptInviteIfReinvitation___block_invoke;
    v6[3] = &unk_27867BF38;
    objc_copyWeak(&v8, &location);
    v7 = reinvitationCopy;
    [(HMDHomeManager *)self _queryLegacyHomeAndAcceptedZoneExists:homeUUID completion:v6];

    objc_destroyWeak(&v8);
    objc_destroyWeak(&location);
  }
}

void __62__HMDHomeManager_SharedUser___autoAcceptInviteIfReinvitation___block_invoke(uint64_t a1, int a2, int a3)
{
  v33 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v7 = [*(a1 + 32) homeUUID];
    v8 = [*(a1 + 32) inviterAccount];
    v9 = [WeakRetained _isAutoAcceptMetadataPresentForHome:v7 owner:v8];

    v10 = objc_autoreleasePoolPush();
    v11 = WeakRetained;
    v12 = HMFGetOSLogHandle();
    v13 = os_log_type_enabled(v12, OS_LOG_TYPE_INFO);
    if (a2 && (a3 & 1) == 0 && v9)
    {
      if (v13)
      {
        v14 = HMFGetLogIdentifier();
        v15 = [*(a1 + 32) homeUUID];
        v16 = [v15 UUIDString];
        *buf = 138543618;
        v24 = v14;
        v25 = 2112;
        v26 = v16;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Auto accept because legacy home zone exists for: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v17 = [*(a1 + 32) identifier];
      v18 = [*(a1 + 32) homeUUID];
      v19 = [MEMORY[0x277CD1F00] authWithValue:1];
      [v11 processRequestToUpdateHomeInvitation:v17 invitationState:3 homeUUID:v18 authStatus:v19 invitationSource:4 messageName:@"kUpdateInvitationStateRequestKey" message:0];
    }

    else
    {
      if (v13)
      {
        v20 = HMFGetLogIdentifier();
        v21 = [*(a1 + 32) homeUUID];
        *buf = 138544386;
        v24 = v20;
        v25 = 2112;
        v26 = v21;
        v27 = 1024;
        v28 = a2;
        v29 = 1024;
        v30 = a3;
        v31 = 1024;
        v32 = v9;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Not auto accepting invitation for home %@ (home zone exists: %d auto accept zone exists: %d local marker present: %d", buf, 0x28u);
      }

      objc_autoreleasePoolPop(v10);
    }
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (BOOL)_isAutoAcceptMetadataPresentForHome:(id)home owner:(id)owner
{
  v35 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  ownerCopy = owner;
  hmdUserDefaults = [(HMDHomeManager *)self hmdUserDefaults];
  v9 = [hmdUserDefaults objectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v10 = v9;
  }

  else
  {
    v10 = 0;
  }

  v11 = v10;

  uUIDString = [homeCopy UUIDString];
  v13 = [v11 hmf_dictionaryForKey:uUIDString];

  if (v13)
  {
    v14 = [v13 hmf_stringForKey:@"HMDHomeManagerAutoAcceptOwnerMergeIDKey"];
    v15 = objc_autoreleasePoolPush();
    selfCopy = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      v27 = 138544130;
      v28 = v18;
      v29 = 2112;
      v30 = v14;
      v31 = 2112;
      v32 = ownerCopy;
      v33 = 2112;
      v34 = v13;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Looking for home metadata for merge id %@ in owner %@: %@", &v27, 0x2Au);
    }

    objc_autoreleasePoolPop(v15);
    senderCorrelationIdentifier = [ownerCopy senderCorrelationIdentifier];
    v20 = [v14 isEqual:senderCorrelationIdentifier];
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
    {
      v24 = HMFGetLogIdentifier();
      v27 = 138543618;
      v28 = v24;
      v29 = 2112;
      v30 = homeCopy;
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@No stashed home metadata so can't auto accept for home %@", &v27, 0x16u);
    }

    objc_autoreleasePoolPop(v21);
    v20 = 0;
  }

  v25 = *MEMORY[0x277D85DE8];
  return v20;
}

- (void)removeHomeFromAwaitingAutoAcceptHomes:(id)homes
{
  v26 = *MEMORY[0x277D85DE8];
  homesCopy = homes;
  hmdUserDefaults = [(HMDHomeManager *)self hmdUserDefaults];
  v6 = [hmdUserDefaults objectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  v9 = objc_autoreleasePoolPush();
  selfCopy = self;
  v11 = HMFGetOSLogHandle();
  v12 = v11;
  if (v8)
  {
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v22 = 138543618;
      v23 = v13;
      v24 = 2112;
      v25 = homesCopy;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Removing %@ from list of homes to ping about account upgrade.", &v22, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    v14 = [v8 mutableCopy];
    uUIDString = [homesCopy UUIDString];
    [v14 removeObjectForKey:uUIDString];

    v16 = [v14 count];
    hmdUserDefaults2 = [(HMDHomeManager *)selfCopy hmdUserDefaults];
    v18 = hmdUserDefaults2;
    if (v16)
    {
      v19 = [v14 copy];
      [v18 setObject:v19 forKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];
    }

    else
    {
      [hmdUserDefaults2 removeObjectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];
    }
  }

  else
  {
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEBUG))
    {
      v20 = HMFGetLogIdentifier();
      v22 = 138543362;
      v23 = v20;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEBUG, "%{public}@No home owners to ping about upgrade to HH2, so no need to delete anything.", &v22, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (BOOL)_isMetadataExpiredForHomeAwaitingAutoAccept:(id)accept
{
  v3 = [accept hmf_dateForKey:@"HMDHomeManagerAutoAcceptMigrationDateKey"];
  v4 = v3;
  if (v3)
  {
    [v3 timeIntervalSinceNow];
    v6 = fabs(v5) > 5184000.0;
  }

  else
  {
    v6 = 1;
  }

  return v6;
}

- (id)_accountHandleFromMetadataForHomeAwaitingAutoAccept:(id)accept
{
  v3 = [accept hmf_stringForKey:@"HMDHomeManagerAutoAcceptOwnerHandleKey"];
  if (v3)
  {
    v4 = [HMDAccountHandle accountHandleForDestination:v3];
  }

  else
  {
    v4 = 0;
  }

  return v4;
}

- (void)_pruneExpiredHomesAwaitingAutoAccept
{
  v56 = *MEMORY[0x277D85DE8];
  hmdUserDefaults = [(HMDHomeManager *)self hmdUserDefaults];
  v4 = [hmdUserDefaults objectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = v4;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;

  if (!v6)
  {
    v31 = objc_autoreleasePoolPush();
    selfCopy = self;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEBUG))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v34;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_DEBUG, "%{public}@No homes awaiting hh2 auto accept.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v31);
    goto LABEL_39;
  }

  v7 = [v6 mutableCopy];
  v47 = 0u;
  v48 = 0u;
  v49 = 0u;
  v50 = 0u;
  v45 = v6;
  v8 = v6;
  v9 = [v8 countByEnumeratingWithState:&v47 objects:v55 count:16];
  if (!v9)
  {
    goto LABEL_23;
  }

  v10 = v9;
  v11 = *v48;
  v46 = v7;
  do
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v48 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v47 + 1) + 8 * i);
      v14 = [v8 objectForKeyedSubscript:v13];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v15 = v14;
      }

      else
      {
        v15 = 0;
      }

      v16 = v15;

      if (v16)
      {
        if (![(HMDHomeManager *)self _isMetadataExpiredForHomeAwaitingAutoAccept:v16])
        {
          goto LABEL_21;
        }

        v17 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543618;
          v52 = v20;
          v53 = 2112;
          v54 = v13;
          v21 = v19;
          v22 = "%{public}@Removing %@ from list of homes to ping about account upgrade.";
LABEL_19:
          _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, v22, buf, 0x16u);
        }
      }

      else
      {
        v17 = objc_autoreleasePoolPush();
        selfCopy3 = self;
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543618;
          v52 = v20;
          v53 = 2112;
          v54 = v13;
          v21 = v19;
          v22 = "%{public}@Failed to parse stashed metadata for %@, removing it.";
          goto LABEL_19;
        }
      }

      objc_autoreleasePoolPop(v17);
      v7 = v46;
      [v46 removeObjectForKey:v13];
LABEL_21:
    }

    v10 = [v8 countByEnumeratingWithState:&v47 objects:v55 count:16];
  }

  while (v10);
LABEL_23:

  if (![v7 count])
  {
    v35 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v37 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
    {
      v38 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v38;
      _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@All stashed metadata for homes awaiting auto accept is expired - purging.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v35);
    hmdUserDefaults2 = [(HMDHomeManager *)selfCopy4 hmdUserDefaults];
    [hmdUserDefaults2 removeObjectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];
    goto LABEL_37;
  }

  v24 = [v7 count];
  v25 = [v8 count];
  v26 = objc_autoreleasePoolPush();
  selfCopy5 = self;
  v28 = HMFGetOSLogHandle();
  v29 = os_log_type_enabled(v28, OS_LOG_TYPE_INFO);
  if (v24 != v25)
  {
    if (v29)
    {
      v40 = HMFGetLogIdentifier();
      v41 = [v8 count];
      v42 = [v7 count];
      *buf = 138543618;
      v52 = v40;
      v53 = 2048;
      v54 = v41 - v42;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Purging %lu expired metadata records for homes awaiting auto accept.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
    hmdUserDefaults2 = [(HMDHomeManager *)selfCopy5 hmdUserDefaults];
    v43 = [v7 copy];
    [hmdUserDefaults2 setObject:v43 forKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];

LABEL_37:
    goto LABEL_38;
  }

  if (v29)
  {
    v30 = HMFGetLogIdentifier();
    *buf = 138543362;
    v52 = v30;
    _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@No homes pending auto accept were expired, doing nothing.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v26);
LABEL_38:

  v6 = v45;
LABEL_39:

  v44 = *MEMORY[0x277D85DE8];
}

- (void)_sendOwnerPingMessageToAccountHandle:(id)handle
{
  handleCopy = handle;
  v5 = [HMDRemoteAccountMessageDestination alloc];
  uuid = [(HMDHomeManager *)self uuid];
  v7 = [(HMDRemoteAccountMessageDestination *)v5 initWithTarget:uuid handle:handleCopy multicast:1];

  [(HMDRemoteAccountMessageDestination *)v7 setRestrictToResidentCapable:1];
  v8 = [HMDRemoteMessage secureMessageWithName:@"HMDHomeManagerSharedUserMigratedToHH2MessageKey" destination:v7 messagePayload:MEMORY[0x277CBEC10]];
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  v11[0] = MEMORY[0x277D85DD0];
  v11[1] = 3221225472;
  v11[2] = __67__HMDHomeManager_SharedUser___sendOwnerPingMessageToAccountHandle___block_invoke;
  v11[3] = &unk_27868A1D8;
  v11[4] = self;
  v12 = v7;
  v10 = v7;
  [messageDispatcher sendMessage:v8 completionHandler:v11];
}

void __67__HMDHomeManager_SharedUser___sendOwnerPingMessageToAccountHandle___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __67__HMDHomeManager_SharedUser___sendOwnerPingMessageToAccountHandle___block_invoke_2;
  block[3] = &unk_27868A010;
  v5 = *(a1 + 32);
  v6 = *(a1 + 40);
  v9 = v3;
  v10 = v5;
  v11 = v6;
  v7 = v3;
  dispatch_async(v4, block);
}

void __67__HMDHomeManager_SharedUser___sendOwnerPingMessageToAccountHandle___block_invoke_2(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  v2 = *(a1 + 32);
  v3 = objc_autoreleasePoolPush();
  v4 = *(a1 + 40);
  v5 = HMFGetOSLogHandle();
  v6 = v5;
  if (v2)
  {
    if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      v8 = *(a1 + 48);
      v9 = *(a1 + 32);
      v16 = 138543874;
      v17 = v7;
      v18 = 2112;
      v19 = v8;
      v20 = 2112;
      v21 = v9;
      v10 = "%{public}@Failed to send account upgrade message to owner account %@ with error %@";
      v11 = v6;
      v12 = OS_LOG_TYPE_ERROR;
      v13 = 32;
LABEL_6:
      _os_log_impl(&dword_229538000, v11, v12, v10, &v16, v13);
    }
  }

  else if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v14 = *(a1 + 48);
    v16 = 138543618;
    v17 = v7;
    v18 = 2112;
    v19 = v14;
    v10 = "%{public}@Sent account upgrade message to owner account %@";
    v11 = v6;
    v12 = OS_LOG_TYPE_INFO;
    v13 = 22;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v3);
  v15 = *MEMORY[0x277D85DE8];
}

- (void)_maybeMessageOwnersOfFrameworkSwitch
{
  v35 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self isOwnerPingPending])
  {
    v3 = objc_autoreleasePoolPush();
    selfCopy = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v32 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Shared user account upgrade ping is already scheduled - not scheduling again.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
  }

  else
  {
    hmdUserDefaults = [(HMDHomeManager *)self hmdUserDefaults];
    v8 = [hmdUserDefaults objectForKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];

    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v9 = v8;
    }

    else
    {
      v9 = 0;
    }

    v10 = v9;

    if (v10)
    {
      [(HMDHomeManager *)self setIsOwnerPingPending:1];
      mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
      v12 = [mEMORY[0x277D0F8D0] preferenceForKey:@"NotifyOwnersOfFrameworkSwitchDelayInterval"];
      numberValue = [v12 numberValue];
      [numberValue doubleValue];
      v15 = v14;

      v16 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v20 = [MEMORY[0x277CCABB0] numberWithDouble:v15];
        *buf = 138543618;
        v32 = v19;
        v33 = 2112;
        v34 = v20;
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Will ping owners in %@ seconds to indicate current account has migrated to HH2", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v16);
      v21 = dispatch_time(0xFFFFFFFFFFFFFFFELL, (v15 * 1000000000.0));
      workQueue = [(HMDHomeManager *)selfCopy2 workQueue];
      v28[0] = MEMORY[0x277D85DD0];
      v28[1] = 3221225472;
      v28[2] = __66__HMDHomeManager_SharedUser___maybeMessageOwnersOfFrameworkSwitch__block_invoke;
      v28[3] = &unk_27868A750;
      v29 = v10;
      v30 = selfCopy2;
      dispatch_after(v21, workQueue, v28);
    }

    else
    {
      v23 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEBUG))
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543362;
        v32 = v26;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_DEBUG, "%{public}@No owners to ping about upgrade to HH2.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v23);
    }
  }

  v27 = *MEMORY[0x277D85DE8];
}

uint64_t __66__HMDHomeManager_SharedUser___maybeMessageOwnersOfFrameworkSwitch__block_invoke(uint64_t a1)
{
  v37 = *MEMORY[0x277D85DE8];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  obj = *(a1 + 32);
  v2 = [obj countByEnumeratingWithState:&v28 objects:v36 count:16];
  if (v2)
  {
    v4 = v2;
    v27 = *v29;
    *&v3 = 138543618;
    v25 = v3;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v29 != v27)
        {
          objc_enumerationMutation(obj);
        }

        v6 = *(*(&v28 + 1) + 8 * i);
        v7 = [*(a1 + 32) objectForKeyedSubscript:{v6, v25}];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v8 = v7;
        }

        else
        {
          v8 = 0;
        }

        v9 = v8;

        v10 = [*(a1 + 40) _accountHandleFromMetadataForHomeAwaitingAutoAccept:v9];
        if (!v10)
        {
          v18 = objc_autoreleasePoolPush();
          v19 = *(a1 + 40);
          v20 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
          {
            v21 = HMFGetLogIdentifier();
            *buf = v25;
            v33 = v21;
            v34 = 2112;
            v35 = v6;
            _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Invalid owner destination specified for home %@ awaiting auto accept", buf, 0x16u);
          }

          v17 = v18;
          goto LABEL_17;
        }

        v11 = [*(a1 + 40) _isMetadataExpiredForHomeAwaitingAutoAccept:v9];
        v12 = objc_autoreleasePoolPush();
        v13 = *(a1 + 40);
        v14 = HMFGetOSLogHandle();
        v15 = os_log_type_enabled(v14, OS_LOG_TYPE_INFO);
        if (v11)
        {
          if (v15)
          {
            v16 = HMFGetLogIdentifier();
            *buf = v25;
            v33 = v16;
            v34 = 2112;
            v35 = v6;
            _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Metadata is expired for home %@ awaiting auto accept.", buf, 0x16u);
          }

          v17 = v12;
LABEL_17:
          objc_autoreleasePoolPop(v17);
          goto LABEL_21;
        }

        if (v15)
        {
          v22 = HMFGetLogIdentifier();
          *buf = v25;
          v33 = v22;
          v34 = 2112;
          v35 = v10;
          _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Pinging owner %@ that the current account has migrated to HH2", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v12);
        [*(a1 + 40) _sendOwnerPingMessageToAccountHandle:v10];
LABEL_21:
      }

      v4 = [obj countByEnumeratingWithState:&v28 objects:v36 count:16];
    }

    while (v4);
  }

  result = [*(a1 + 40) setIsOwnerPingPending:0];
  v24 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)determineDataSyncSateForHH2:(BOOL *)h2 homeManagerDataSyncState:(unint64_t *)state homeManagerStatus:(unint64_t *)status
{
  v20 = *MEMORY[0x277D85DE8];
  if (!h2)
  {
    _HMFPreconditionFailure();
  }

  if (![(HMDHomeManager *)self isCloudKitRequiredForHH2])
  {
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v15;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Allowing HomeKit to run without CloudKit for HH2", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
LABEL_12:
    *h2 = 0;
    if (state)
    {
      v16 = 1;
LABEL_17:
      *state = v16;
      goto LABEL_18;
    }

    goto LABEL_18;
  }

  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  if ([appleAccountManager isLoggedInToPrimaryAccount])
  {
    v10 = +[HMDAppleAccountSettings sharedSettings];
    isHomeEnabled = [v10 isHomeEnabled];

    if (isHomeEnabled)
    {
      if (![(HMDHomeManager *)self initialPCSStatusFetchCompleted])
      {
        if (status)
        {
          *status = 1;
        }

        goto LABEL_21;
      }

      if (![(HMDHomeManager *)self pcsEnabled])
      {
        if (status)
        {
          *status = 32;
        }

        *h2 = 1;
        if (state)
        {
          v16 = 6;
          goto LABEL_17;
        }

        goto LABEL_18;
      }

      if (![(HMDHomeManager *)self daemonHasLoadedSceneGraph])
      {
LABEL_21:
        *h2 = 1;
        if (!state)
        {
          goto LABEL_18;
        }

        v16 = 4;
        goto LABEL_17;
      }

      goto LABEL_12;
    }
  }

  else
  {
  }

  *h2 = 0;
  if (state)
  {
    v16 = 3;
    goto LABEL_17;
  }

LABEL_18:
  v17 = *MEMORY[0x277D85DE8];
}

- (BOOL)isCloudKitRequiredForHH2
{
  if ([objc_opt_class() isPrefSetForHH2WithoutCloudKit])
  {
    return 0;
  }

  else
  {
    return ![(HMDHomeManager *)self isDemoModeV2WithoutCKEnabled];
  }
}

- (BOOL)daemonHasLoadedSceneGraph
{
  if (![(HMDHomeManager *)self startupHasCompleted]|| ![(HMDHomeManager *)self deviceAccountHasSettled])
  {
    return 0;
  }

  return [(HMDHomeManager *)self firstCloudKitImportComplete];
}

- (void)initHomeManagerFrameworkNotify
{
  v31[2] = *MEMORY[0x277D85DE8];
  [(HMDHomeManager *)self setStartupHasCompleted:0];
  [(HMDHomeManager *)self setDeviceAccountHasSettled:0];
  objc_initWeak(&location, self);
  startupCompleted = [(HMDHomeManager *)self startupCompleted];
  workContext = [(HMDHomeManager *)self workContext];
  v28[0] = MEMORY[0x277D85DD0];
  v28[1] = 3221225472;
  v28[2] = __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke;
  v28[3] = &unk_278685A80;
  objc_copyWeak(&v29, &location);
  v5 = [startupCompleted inContext:workContext then:v28];

  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  deviceAccountSettled = [appleAccountManager deviceAccountSettled];

  workContext2 = [(HMDHomeManager *)self workContext];
  v26[0] = MEMORY[0x277D85DD0];
  v26[1] = 3221225472;
  v26[2] = __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_2;
  v26[3] = &unk_278685A80;
  objc_copyWeak(&v27, &location);
  v9 = [deviceAccountSettled inContext:workContext2 then:v26];

  v10 = MEMORY[0x277D0F7C0];
  startupCompleted2 = [(HMDHomeManager *)self startupCompleted];
  v31[0] = startupCompleted2;
  v31[1] = deviceAccountSettled;
  v12 = [MEMORY[0x277CBEA60] arrayWithObjects:v31 count:2];
  v13 = [v10 allSettled:v12];

  workContext3 = [(HMDHomeManager *)self workContext];
  v24[0] = MEMORY[0x277D85DD0];
  v24[1] = 3221225472;
  v24[2] = __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_3;
  v24[3] = &unk_278685A80;
  objc_copyWeak(&v25, &location);
  v15 = [v13 inContext:workContext3 then:v24];

  v16 = +[HMDMainDriver driver];
  coreData = [v16 coreData];
  firstCloudKitImportFuture = [coreData firstCloudKitImportFuture];

  workContext4 = [(HMDHomeManager *)self workContext];
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_11;
  v22[3] = &unk_278685A80;
  objc_copyWeak(&v23, &location);
  v20 = [firstCloudKitImportFuture inContext:workContext4 then:v22];

  objc_destroyWeak(&v23);
  objc_destroyWeak(&v25);

  objc_destroyWeak(&v27);
  objc_destroyWeak(&v29);
  objc_destroyWeak(&location);
  v21 = *MEMORY[0x277D85DE8];
}

uint64_t __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  [WeakRetained setStartupHasCompleted:1];

  return 1;
}

uint64_t __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_2(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  [WeakRetained setDeviceAccountHasSettled:1];

  return 1;
}

uint64_t __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_3(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543362;
    v14 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Initial scene graph has loaded, allows kFetchConfiguration.", &v13, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [MEMORY[0x277CCAB98] defaultCenter];
  [v9 postNotificationName:@"kCloudDataSyncInProgressUpdatedNotification" object:0];

  v10 = [v6 uuid];
  [v6 updateGenerationCounterWithReason:@"Initial Framework Notify Startup" sourceUUID:v10 shouldNotifyClients:0];

  v11 = *MEMORY[0x277D85DE8];
  return 1;
}

uint64_t __65__HMDHomeManager_FrameworkNotify__initHomeManagerFrameworkNotify__block_invoke_11(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  [WeakRetained setFirstCloudKitImportComplete:1];
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v16 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@First CloudKit import complete, update status.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [MEMORY[0x277CCAB98] defaultCenter];
  v13 = @"HMDHH2FirstCKImportFinished";
  v14 = MEMORY[0x277CBEC38];
  v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v14 forKeys:&v13 count:1];
  [v9 postNotificationName:@"kCloudDataSyncInProgressUpdatedNotification" object:v6 userInfo:v10];

  v11 = *MEMORY[0x277D85DE8];
  return 1;
}

+ (BOOL)isPrefSetForHH2WithoutCloudKit
{
  if (isInternalBuild())
  {
    if (isPrefSetForHH2WithoutCloudKit__hmf_once_t2 != -1)
    {
      dispatch_once(&isPrefSetForHH2WithoutCloudKit__hmf_once_t2, &__block_literal_global_173791);
    }

    v2 = isPrefSetForHH2WithoutCloudKit__hmf_once_v3;
  }

  else
  {
    v2 = 0;
  }

  return v2 & 1;
}

void __65__HMDHomeManager_FrameworkNotify__isPrefSetForHH2WithoutCloudKit__block_invoke()
{
  v1 = [MEMORY[0x277D0F8D0] sharedPreferences];
  v0 = [v1 preferenceForKey:@"allowAccessWithoutCloudKit"];
  isPrefSetForHH2WithoutCloudKit__hmf_once_v3 = [v0 BOOLValue];
}

- (id)_mediaRouteIdentifierForAccessory:(id)accessory
{
  v3 = [(HMDHomeManager *)self accessoryWithUUID:accessory];
  v4 = v3;
  if (v3)
  {
    identifier = [v3 identifier];
  }

  else
  {
    identifier = 0;
  }

  return identifier;
}

- (id)_decodeDiagnosticInfoFromLocalResponse:(id)response
{
  v18 = *MEMORY[0x277D85DE8];
  responseCopy = response;
  v5 = [responseCopy hmf_dataForKey:*MEMORY[0x277CD0120]];
  if (v5)
  {
    v6 = [objc_alloc(MEMORY[0x277CD16B8]) initWithData:v5];
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *MEMORY[0x277CCFC70];
      v14 = 138543618;
      v15 = v10;
      v16 = 2112;
      v17 = v11;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@Response does not contain key %@", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v6 = 0;
  }

  v12 = *MEMORY[0x277D85DE8];

  return v6;
}

- (id)_diagnosticInfoFromRemoteResponse:(id)response
{
  v19 = *MEMORY[0x277D85DE8];
  responseCopy = response;
  v5 = *MEMORY[0x277CCFC70];
  v6 = [responseCopy hmf_dataForKey:*MEMORY[0x277CCFC70]];
  v7 = v6;
  if (v6)
  {
    v8 = v6;
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    selfCopy = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v12;
      v17 = 2112;
      v18 = v5;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_ERROR, "%{public}@Response does not contain key %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = *MEMORY[0x277D85DE8];

  return v7;
}

- (void)_handleAccessoryDiagnosticQueryWithOptions:(unint64_t)options accessory:(id)accessory accessoryUUID:(id)d mediaRouteID:(id)iD additionalFetchKeys:(id)keys filteringKeyPaths:(id)paths remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)self0 completion:(id)self1
{
  optionsCopy = options;
  v71 = *MEMORY[0x277D85DE8];
  accessoryCopy = accessory;
  dCopy = d;
  iDCopy = iD;
  keysCopy = keys;
  pathsCopy = paths;
  completionCopy = completion;
  home = [accessoryCopy home];
  deviceForDirectMessaging = [accessoryCopy deviceForDirectMessaging];
  currentUser = [home currentUser];
  uuid = [(HMDHomeManager *)self uuid];
  if (currentUser && ([currentUser isOwner] & 1) == 0)
  {
    messageTargetUUID = [home messageTargetUUID];

    v20 = @"HMD.accessoryDiagnosticInfo.s";
    uuid = messageTargetUUID;
  }

  else
  {
    v20 = @"HMD.accessoryDiagnosticInfo.o";
  }

  if (!deviceForDirectMessaging)
  {
    v22 = objc_autoreleasePoolPush();
    selfCopy = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543618;
      *&buf[4] = v25;
      *&buf[12] = 2112;
      *&buf[14] = accessoryCopy;
      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@No device for messaging for accessory %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v22);
  }

  v26 = dispatch_group_create();
  v27 = v26;
  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x2020000000;
  v70 = 0;
  v28 = optionsCopy & 2;
  if ((optionsCopy & 1) != 0 && deviceForDirectMessaging)
  {
    dispatch_group_enter(v26);
    workQueue = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke;
    block[3] = &unk_27867D0E0;
    v52 = uuid;
    v53 = deviceForDirectMessaging;
    v54 = dCopy;
    v55 = iDCopy;
    v56 = keysCopy;
    v57 = pathsCopy;
    v58 = v20;
    timeoutCopy = timeout;
    selfCopy2 = self;
    v63 = buf;
    restrictionCopy = restriction;
    v60 = accessoryCopy;
    v66 = v28 >> 1;
    v62 = completionCopy;
    v61 = v27;
    dispatch_async(workQueue, block);

    if (!v28)
    {
      goto LABEL_18;
    }

    goto LABEL_17;
  }

  if ((optionsCopy & 2) != 0)
  {
LABEL_17:
    workQueue2 = [(HMDHomeManager *)self workQueue];
    v45[0] = MEMORY[0x277D85DD0];
    v45[1] = 3221225472;
    v45[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_2;
    v45[3] = &unk_2786889C8;
    v50 = buf;
    v45[4] = self;
    v46 = dCopy;
    v47 = iDCopy;
    v48 = accessoryCopy;
    v49 = completionCopy;
    dispatch_group_notify(v27, workQueue2, v45);

    goto LABEL_18;
  }

  v30 = objc_autoreleasePoolPush();
  selfCopy3 = self;
  v32 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
  {
    v33 = HMFGetLogIdentifier();
    *v67 = 138543362;
    v68 = v33;
    _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@No query will be performed.", v67, 0xCu);
  }

  objc_autoreleasePoolPop(v30);
  v34 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
  (*(completionCopy + 2))(completionCopy, 0, v34);

LABEL_18:
  _Block_object_dispose(buf, 8);

  v36 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke(uint64_t a1)
{
  v32[3] = *MEMORY[0x277D85DE8];
  v2 = [[HMDRemoteDeviceMessageDestination alloc] initWithTarget:*(a1 + 32) device:*(a1 + 40)];
  v31[0] = @"uuid";
  v3 = [*(a1 + 48) UUIDString];
  v4 = *(a1 + 56);
  v5 = *(a1 + 64);
  v32[0] = v3;
  v32[1] = v4;
  v6 = *MEMORY[0x277CD0110];
  v31[1] = @"identifier";
  v31[2] = v6;
  v32[2] = v5;
  v7 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v32 forKeys:v31 count:3];
  v8 = [v7 mutableCopy];

  [v8 setObject:*(a1 + 72) forKeyedSubscript:*MEMORY[0x277CD0130]];
  v9 = [HMDRemoteMessage secureMessageWithName:*(a1 + 80) qualityOfService:-1 destination:v2 messagePayload:v8 restriction:*(a1 + 128)];
  v10 = [v9 mutableCopy];

  [v10 setTimeout:*(a1 + 136)];
  v11 = objc_autoreleasePoolPush();
  v12 = *(a1 + 88);
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v15 = *(a1 + 48);
    *buf = 138543618;
    v28 = v14;
    v29 = 2112;
    v30 = v15;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Performing accessory diagnostic fetch for accessory %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_25;
  v22[3] = &unk_27867D0B8;
  v25 = *(a1 + 120);
  v21 = *(a1 + 88);
  v16 = *(&v21 + 1);
  v26 = *(a1 + 144);
  v17 = *(a1 + 112);
  *&v18 = *(a1 + 104);
  *(&v18 + 1) = v17;
  v23 = v21;
  v24 = v18;
  [v10 setResponseHandler:v22];
  v19 = [*(a1 + 88) messageDispatcher];
  [v19 sendMessage:v10];

  v20 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_2(uint64_t a1)
{
  v17 = *MEMORY[0x277D85DE8];
  if ((*(*(*(a1 + 72) + 8) + 24) & 1) == 0)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 32);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      v6 = *(a1 + 40);
      *buf = 138543618;
      v14 = v5;
      v15 = 2112;
      v16 = v6;
      _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Performing accessory diagnostic fetch using rapport %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    v7 = [*(a1 + 32) configuringStateController];
    v10[0] = MEMORY[0x277D85DD0];
    v10[1] = 3221225472;
    v10[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_27;
    v10[3] = &unk_27867D108;
    v10[4] = *(a1 + 32);
    v8 = *(a1 + 48);
    v11 = *(a1 + 56);
    v12 = *(a1 + 64);
    [v7 queryConfiguringState:v8 additionalKeys:MEMORY[0x277CBEBF8] withCompletion:v10];
  }

  v9 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_25(uint64_t a1, uint64_t a2, uint64_t a3)
{
  *(*(*(a1 + 64) + 8) + 24) = [*(a1 + 32) _handleAccessoryDiagnosticStateQueryWithResponse:a3 accessory:*(a1 + 40) hasAdditionalRequest:*(a1 + 72) error:a2 completion:*(a1 + 56)];
  v4 = *(a1 + 48);

  dispatch_group_leave(v4);
}

- (void)_handleAccessoryDiagnosticStateQuery:(id)query
{
  v35 = *MEMORY[0x277D85DE8];
  queryCopy = query;
  messagePayload = [queryCopy messagePayload];
  v6 = [messagePayload hmf_numberForKey:*MEMORY[0x277CD0128]];
  integerValue = [v6 integerValue];

  if (integerValue)
  {
    v8 = [queryCopy uuidForKey:*MEMORY[0x277CD0108]];
    if (v8)
    {
      v9 = [(HMDHomeManager *)self accessoryWithUUID:v8];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v10 = v9;
      }

      else
      {
        v10 = 0;
      }

      v11 = v10;

      identifier = [v11 identifier];
      if (identifier)
      {
        messagePayload2 = [queryCopy messagePayload];
        v14 = [messagePayload2 objectForKey:*MEMORY[0x277CD0130]];

        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v15 = v14;
        }

        else
        {
          v15 = 0;
        }

        v16 = v15;

        v31[0] = MEMORY[0x277D85DD0];
        v31[1] = 3221225472;
        v31[2] = __73__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticStateQuery___block_invoke;
        v31[3] = &unk_278689230;
        v32 = queryCopy;
        [(HMDHomeManager *)self _handleAccessoryDiagnosticQueryWithOptions:integerValue accessory:v11 accessoryUUID:v8 mediaRouteID:identifier additionalFetchKeys:MEMORY[0x277CBEBF8] filteringKeyPaths:v16 remoteMessageTimeout:10.0 remoteMessageRestriction:9 completion:v31];

        v17 = v32;
      }

      else
      {
        v26 = objc_autoreleasePoolPush();
        selfCopy = self;
        v28 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
        {
          v29 = HMFGetLogIdentifier();
          *buf = 138543362;
          v34 = v29;
          _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_ERROR, "%{public}@mediaRouteIdentifier is nil", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v26);
        v17 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
        [queryCopy respondWithError:v17];
      }
    }

    else
    {
      v22 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v24 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        v25 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v25;
        _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_ERROR, "%{public}@Could not determine accessory UUID", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [queryCopy respondWithError:v11];
    }
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v34 = v21;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Invalid fetch options", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [queryCopy respondWithError:v8];
  }

  v30 = *MEMORY[0x277D85DE8];
}

uint64_t __73__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticStateQuery___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3)
{
  v3 = *(a1 + 32);
  if (a3)
  {
    return [v3 respondWithError:?];
  }

  else
  {
    return [v3 respondWithPayload:a2];
  }
}

- (BOOL)_handleAccessoryDiagnosticStateQueryWithResponse:(id)response accessory:(id)accessory hasAdditionalRequest:(BOOL)request error:(id)error completion:(id)completion
{
  v46 = *MEMORY[0x277D85DE8];
  responseCopy = response;
  accessoryCopy = accessory;
  errorCopy = error;
  completionCopy = completion;
  if (!errorCopy)
  {
    v21 = [(HMDHomeManager *)self _diagnosticInfoFromRemoteResponse:responseCopy];
    v20 = v21 != 0;
    v22 = objc_autoreleasePoolPush();
    selfCopy = self;
    v24 = HMFGetOSLogHandle();
    v25 = v24;
    if (v21)
    {
      if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v26;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Responding with diagnostic Info", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      v27 = [objc_alloc(MEMORY[0x277CD1698]) initWithProtoData:v21];
      v28 = v27;
      if (v27 && ([v27 wifiInfo], v29 = objc_claimAutoreleasedReturnValue(), v29, v29))
      {
        wifiInfo = [v28 wifiInfo];
        [accessoryCopy updateWiFiNetworkInfoIfNeeded:wifiInfo reason:@"DiagnosticFetchUpdate"];
      }

      else
      {
        v31 = objc_autoreleasePoolPush();
        v32 = selfCopy;
        v33 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v34 = v38 = v31;
          *buf = 138543362;
          v43 = v34;
          _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_ERROR, "%{public}@Failed to create HMAccessoryDiagnosticInfo object or WiFi info is nil", buf, 0xCu);

          v31 = v38;
        }

        objc_autoreleasePoolPop(v31);
      }

      v40 = *MEMORY[0x277CD0120];
      v41 = v21;
      v35 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v41 forKeys:&v40 count:1];
      completionCopy[2](completionCopy, v35, 0);
    }

    else
    {
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        v39 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v39;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_ERROR, "%{public}@Failed to decode the response", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      if (request)
      {
        goto LABEL_22;
      }

      v28 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      (completionCopy)[2](completionCopy, 0, v28);
    }

LABEL_22:
    goto LABEL_23;
  }

  v16 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
  {
    v19 = HMFGetLogIdentifier();
    *buf = 138543618;
    v43 = v19;
    v44 = 2112;
    v45 = errorCopy;
    _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_ERROR, "%{public}@Query message failed, error: (%@): ", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v16);
  if (!request)
  {
    (completionCopy)[2](completionCopy, 0, errorCopy);
  }

  v20 = 0;
LABEL_23:

  v36 = *MEMORY[0x277D85DE8];
  return v20;
}

- (void)_handleDeviceSetupConfiguringStateQuery:(id)query
{
  v28 = *MEMORY[0x277D85DE8];
  queryCopy = query;
  v5 = [queryCopy uuidForKey:*MEMORY[0x277CD1FE8]];
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543874;
    v23 = v9;
    v24 = 2112;
    v25 = queryCopy;
    v26 = 2112;
    v27 = v5;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Handle query message %@ with mediaRouteID %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  if (!v5)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = selfCopy;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v23 = v16;
      v17 = "%{public}@mediaRouteIdentifier is nil";
LABEL_10:
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, v17, buf, 0xCu);
    }

LABEL_11:

    objc_autoreleasePoolPop(v13);
    v18 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
    [queryCopy respondWithError:v18];

    goto LABEL_12;
  }

  configuringStateController = [(HMDHomeManager *)selfCopy configuringStateController];

  if (!configuringStateController)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = selfCopy;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v23 = v16;
      v17 = "%{public}@Configuring controller is nil";
      goto LABEL_10;
    }

    goto LABEL_11;
  }

  configuringStateController2 = [(HMDHomeManager *)selfCopy configuringStateController];
  uUIDString = [v5 UUIDString];
  v20[0] = MEMORY[0x277D85DD0];
  v20[1] = 3221225472;
  v20[2] = __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke;
  v20[3] = &unk_27867DBA0;
  v20[4] = selfCopy;
  v21 = queryCopy;
  [configuringStateController2 queryConfiguringState:uUIDString additionalKeys:MEMORY[0x277CBEBF8] withCompletion:v20];

LABEL_12:
  v19 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) workQueue];
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke_2;
  v12[3] = &unk_2786891E0;
  v8 = *(a1 + 32);
  v9 = *(a1 + 40);
  v13 = v6;
  v14 = v8;
  v15 = v9;
  v16 = v5;
  v10 = v5;
  v11 = v6;
  dispatch_async(v7, v12);
}

void __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke_2(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 40);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = HMFGetLogIdentifier();
      v6 = *(a1 + 32);
      v18 = 138543618;
      v19 = v5;
      v20 = 2112;
      v21 = v6;
      _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_ERROR, "%{public}@Query message failed, error: (%@): ", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    [*(a1 + 48) respondWithError:*(a1 + 32)];
  }

  else
  {
    v7 = [*(a1 + 40) _diagnosticInfoFromRemoteResponse:*(a1 + 56)];
    v8 = [HMDAppleMediaAccessoryDiagnosticInfoController diagnosticInfoDescriptionWithData:v7];

    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    v12 = v11;
    if (v8)
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v18 = 138543618;
        v19 = v13;
        v20 = 2112;
        v21 = v8;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Query message sent, response: %@", &v18, 0x16u);
      }

      objc_autoreleasePoolPop(v9);
      [*(a1 + 48) respondWithPayload:v8];
    }

    else
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        v18 = 138543362;
        v19 = v14;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Failed to decode the response", &v18, 0xCu);
      }

      objc_autoreleasePoolPop(v9);
      v15 = *(a1 + 48);
      v16 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      [v15 respondWithError:v16];
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_registerForConfiguringStateMessages
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = *MEMORY[0x277CD00F0];
    *buf = 138543618;
    v19 = v6;
    v20 = 2112;
    v21 = v7;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for %@ message for device setup configuring state query", buf, 0x16u);
  }

  else
  {
    v7 = *MEMORY[0x277CD00F0];
  }

  objc_autoreleasePoolPop(v3);
  messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
  v9 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v17 = v9;
  v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v17 count:1];
  [messageDispatcher registerForMessage:v7 receiver:selfCopy policies:v10 selector:sel__handleDeviceSetupConfiguringStateQuery_];

  messageDispatcher2 = [(HMDHomeManager *)selfCopy messageDispatcher];
  v12 = *MEMORY[0x277CD01B8];
  v13 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v16 = v13;
  v14 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
  [messageDispatcher2 registerForMessage:v12 receiver:selfCopy policies:v14 selector:sel__handleAccessoryDiagnosticStateQuery_];

  v15 = *MEMORY[0x277D85DE8];
}

- (void)fetchDiagnosticStateWithOptions:(unint64_t)options accessoryUUID:(id)d additionalFetchKeys:(id)keys filteringKeyPaths:(id)paths remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)restriction completion:(id)completion
{
  v45 = *MEMORY[0x277D85DE8];
  dCopy = d;
  keysCopy = keys;
  pathsCopy = paths;
  completionCopy = completion;
  if (dCopy)
  {
    v20 = [(HMDHomeManager *)self _mediaRouteIdentifierForAccessory:dCopy];
    if (v20)
    {
      v21 = v20;
      configuringStateController = [(HMDHomeManager *)self configuringStateController];

      if (configuringStateController)
      {
        v23 = [(HMDHomeManager *)self accessoryWithUUID:dCopy];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v24 = v23;
        }

        else
        {
          v24 = 0;
        }

        v25 = v24;

        v41[0] = MEMORY[0x277D85DD0];
        v41[1] = 3221225472;
        v41[2] = __177__HMDHomeManager_ConfiguringState__fetchDiagnosticStateWithOptions_accessoryUUID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke;
        v41[3] = &unk_27867D090;
        v41[4] = self;
        v42 = completionCopy;
        [(HMDHomeManager *)self _handleAccessoryDiagnosticQueryWithOptions:options accessory:v25 accessoryUUID:dCopy mediaRouteID:v21 additionalFetchKeys:keysCopy filteringKeyPaths:pathsCopy remoteMessageTimeout:timeout remoteMessageRestriction:restriction completion:v41];
      }

      else
      {
        v35 = objc_autoreleasePoolPush();
        selfCopy = self;
        v37 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
        {
          v38 = HMFGetLogIdentifier();
          *buf = 138543362;
          v44 = v38;
          _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as the controller is nil", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v35);
        v39 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        (*(completionCopy + 2))(completionCopy, 0, v39);
      }
    }

    else
    {
      v30 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
      {
        v33 = HMFGetLogIdentifier();
        *buf = 138543362;
        v44 = v33;
        _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as peer identifier is nil", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v30);
      v34 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (*(completionCopy + 2))(completionCopy, 0, v34);

      v21 = 0;
    }
  }

  else
  {
    v26 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      *buf = 138543362;
      v44 = v29;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as accessory UUID is nil", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v26);
    v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(completionCopy + 2))(completionCopy, 0, v21);
  }

  v40 = *MEMORY[0x277D85DE8];
}

void __177__HMDHomeManager_ConfiguringState__fetchDiagnosticStateWithOptions_accessoryUUID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 32);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v10;
      v19 = 2112;
      v20 = v6;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@Query configuring state failed with error: (%@): ", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    (*(*(a1 + 40) + 16))();
  }

  else
  {
    v11 = [*(a1 + 32) _decodeDiagnosticInfoFromLocalResponse:v5];
    (*(*(a1 + 40) + 16))();
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v15;
      v19 = 2112;
      v20 = v11;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Query message sent, response: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)fetchSetupDiagnosticStateWithOptions:(unint64_t)options accessoryUUID:(id)d remoteMessageTimeout:(double)timeout remoteMessageRestriction:(unint64_t)restriction completion:(id)completion
{
  v18 = *MEMORY[0x277D85DE8];
  v17 = *MEMORY[0x277CD0118];
  v12 = MEMORY[0x277CBEA60];
  completionCopy = completion;
  dCopy = d;
  v15 = [v12 arrayWithObjects:&v17 count:1];
  [(HMDHomeManager *)self fetchDiagnosticStateWithOptions:options accessoryUUID:dCopy additionalFetchKeys:v15 filteringKeyPaths:MEMORY[0x277CBEBF8] remoteMessageTimeout:restriction remoteMessageRestriction:completionCopy completion:timeout, v17, v18];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleAssistantSyncDataRequest:(id)request
{
  v33 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  if ([(HMDHomeManager *)self isDataSyncInProgressWithMessage:requestCopy])
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v32 = v9;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Data sync in progress - do not sync data to Siri servers", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    [requestCopy respondWithPayload:0];
  }

  else
  {
    clientIdentifier = [requestCopy clientIdentifier];
    if (clientIdentifier)
    {
      v11 = clientIdentifier;
    }

    else
    {
      v11 = @"com.apple.homeutil";
    }

    if (hasAssistantHashingKeyChanged())
    {
      v12 = 0;
    }

    else
    {
      v12 = [requestCopy stringForKey:*MEMORY[0x277CD26A8]];
    }

    objc_initWeak(buf, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke;
    aBlock[3] = &unk_278687568;
    aBlock[4] = self;
    objc_copyWeak(&v29, buf);
    v13 = v12;
    v27 = v13;
    v28 = requestCopy;
    v14 = _Block_copy(aBlock);
    v15 = v14;
    if (v13)
    {
      (*(v14 + 2))(v14);
    }

    else
    {
      isWatch();
      __generateAssistantTeamIdentifier = [(HMDHomeManager *)self __generateAssistantTeamIdentifier];
      [(HMDHomeManager *)self _setAssistantSyncRequest:v11];
      v24 = 0u;
      v25 = 0u;
      v22 = 0u;
      v23 = 0u;
      homes = [(HMDHomeManager *)self homes];
      v18 = [homes countByEnumeratingWithState:&v22 objects:v30 count:16];
      if (v18)
      {
        v19 = *v23;
        do
        {
          v20 = 0;
          do
          {
            if (*v23 != v19)
            {
              objc_enumerationMutation(homes);
            }

            [*(*(&v22 + 1) + 8 * v20++) resetAccessoryHashedRouteIdentifiers];
          }

          while (v18 != v20);
          v18 = [homes countByEnumeratingWithState:&v22 objects:v30 count:16];
        }

        while (v18);
      }

      [(HMDHomeManager *)self _generateAssistantSyncDataAndIncrementVersion:1 requestSync:0 urgent:0 completion:v15];
    }

    objc_destroyWeak(&v29);
    objc_destroyWeak(buf);
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke(id *a1)
{
  v2 = [a1[4] gatherer];
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_2;
  v3[3] = &unk_278684610;
  objc_copyWeak(&v6, a1 + 7);
  v4 = a1[5];
  v5 = a1[6];
  [v2 getSyncEntityObjectsWithCompletionHandler:v3];

  objc_destroyWeak(&v6);
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_2(id *a1, void *a2)
{
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v5 = WeakRetained;
  if (WeakRetained)
  {
    v6 = [WeakRetained workQueue];
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_3;
    v7[3] = &unk_2786891E0;
    v7[4] = v5;
    v8 = a1[4];
    v9 = v3;
    v10 = a1[5];
    dispatch_async(v6, v7);
  }
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_3(uint64_t a1)
{
  v31 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) assistantGenerationCounter];
  [*(a1 + 32) __setLastSyncedAssistantConfigurationVersion:v2];
  v3 = objc_autoreleasePoolPush();
  v4 = *(a1 + 32);
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = *(a1 + 40);
    v8 = [*(a1 + 32) _getAssistantHashingData];
    *buf = 138544130;
    v24 = v6;
    v25 = 2112;
    v26 = v7;
    v27 = 2048;
    v28 = v2;
    v29 = 2112;
    v30 = v8;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Siri sync validity %@, assistantConfigurationVersion %tu - assistant identifier %@", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v3);
  v9 = *(a1 + 48);
  v21 = @"kSiriSyncDataEntitiesKey";
  v22 = v9;
  v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v22 forKeys:&v21 count:1];
  [*(a1 + 56) respondWithPayload:v10];
  v11 = *(a1 + 40);
  if (v11)
  {
    v12 = [v11 componentsSeparatedByString:@":"];
    v13 = [v12 firstObject];
    v14 = v13;
    if (v13)
    {
      [v13 cStringUsingEncoding:4];
    }
  }

  if ([*(a1 + 32) siriSyncNotificationTime])
  {
    mach_absolute_time();
    UpTicksToMilliseconds();
    [*(a1 + 32) siriSyncNotificationTime];
  }

  [*(a1 + 32) _resetSiriSyncNotification];
  if ([*(a1 + 32) assistantIdentifierChanged])
  {
    [*(a1 + 32) setAssistantIdentifierChanged:0];
    v15 = *(a1 + 32);
    v16 = [v15 uuid];
    [v15 updateGenerationCounterWithReason:@"AssistantIdentifierChanged" sourceUUID:v16 shouldNotifyClients:1];
  }

  [*(a1 + 32) _signpostAssistantSyncDataRequestHandled];
  v17 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
  [v17 markSetupEndStage:8 error:0];

  v18 = +[HMDHelper sharedHelper];
  v19 = [v18 hashedRouteIDForIdentifier:@"A77C551E-C3FA-414E-ACD8-A7DF3D64E9D6"];

  CFPreferencesSetAppValue(@"HMDAssistantLastHashingKey", v19, *MEMORY[0x277CD0030]);
  v20 = *MEMORY[0x277D85DE8];
}

- (void)writeAssistantCurrentHome:(id)home
{
  v27 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v5 = MEMORY[0x277CBEBC0];
  urlString = [homeCopy urlString];
  v7 = [v5 URLWithString:urlString];

  v8 = objc_autoreleasePoolPush();
  selfCopy = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    name = [homeCopy name];
    currentHomeUUID = [(HMDHomeManager *)selfCopy currentHomeUUID];
    uUIDString = [currentHomeUUID UUIDString];
    v19 = 138544130;
    v20 = v11;
    v21 = 2112;
    v22 = v7;
    v23 = 2112;
    v24 = name;
    v25 = 2112;
    v26 = uUIDString;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Notifying assistant that current home updated to: %@ (%@/%@)", &v19, 0x2Au);
  }

  objc_autoreleasePoolPop(v8);
  v15 = *MEMORY[0x277CD20B8];
  absoluteString = [v7 absoluteString];
  v17 = *MEMORY[0x277CD0028];
  [(HMDHomeManager *)selfCopy _setHomeConfigurationKey:v15 value:absoluteString applicationIdentifier:*MEMORY[0x277CD0028]];
  -[HMDHomeManager _setHomeConfigurationKey:value:applicationIdentifier:](selfCopy, "_setHomeConfigurationKey:value:applicationIdentifier:", *MEMORY[0x277CD20C0], [homeCopy name], v17);
  notify_post("com.apple.homed.current-home.changed");

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_resetSiriSyncNotification
{
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  [(HMDHomeManager *)self setSiriSyncNotificationTime:0];
}

- (BOOL)shouldDropNotification
{
  v11 = 0;
  v12 = &v11;
  v13 = 0x2020000000;
  v14 = 0;
  v3 = +[HMDCoreData sharedInstance];
  contextWithRootPartition = [v3 contextWithRootPartition];

  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __51__HMDHomeManager_Assistant__shouldDropNotification__block_invoke;
  v7[3] = &unk_27868A4D8;
  v5 = contextWithRootPartition;
  v8 = v5;
  selfCopy = self;
  v10 = &v11;
  [v5 unsafeSynchronousBlock:v7];
  LOBYTE(self) = *(v12 + 24);

  _Block_object_dispose(&v11, 8);
  return (self & 1) == 0;
}

void __51__HMDHomeManager_Assistant__shouldDropNotification__block_invoke(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) findHomeManagerWithError:0];
  v3 = v2;
  if (v2)
  {
    v4 = [v2 assistantSyncDataPosted];
    *(*(*(a1 + 48) + 8) + 24) = [v4 BOOLValue];
  }

  else
  {
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 40);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543362;
      v11 = v8;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_ERROR, "%{public}@Missing mkfHomeManager", &v10, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)saveAssistantSyncDataPostedToWorkingStore
{
  v3 = +[HMDCoreData sharedInstance];
  contextWithRootPartition = [v3 contextWithRootPartition];

  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __70__HMDHomeManager_Assistant__saveAssistantSyncDataPostedToWorkingStore__block_invoke;
  v6[3] = &unk_27868A750;
  v6[4] = self;
  v7 = contextWithRootPartition;
  v5 = contextWithRootPartition;
  [v5 performBlock:v6];
}

void __70__HMDHomeManager_Assistant__saveAssistantSyncDataPostedToWorkingStore__block_invoke(uint64_t a1)
{
  v30 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v27 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Going to save first CK import finished to working store.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 40) findHomeManagerWithError:0];
  v7 = v6;
  if (v6)
  {
    [v6 setAssistantSyncDataPosted:MEMORY[0x277CBEC38]];
    v8 = *(a1 + 40);
    v25 = 0;
    v9 = [v8 save:&v25];
    v10 = v25;
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 32);
    v13 = HMFGetOSLogHandle();
    v14 = v13;
    if (v9)
    {
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v15 = HMFGetLogIdentifier();
        *buf = 138543362;
        v27 = v15;
        v16 = "%{public}@Successfully saved the assistant sync data posted flag.";
        v17 = v14;
        v18 = OS_LOG_TYPE_INFO;
        v19 = 12;
LABEL_12:
        _os_log_impl(&dword_229538000, v17, v18, v16, buf, v19);
      }
    }

    else if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v27 = v15;
      v28 = 2112;
      v29 = v10;
      v16 = "%{public}@Unable to store the assistant sync data posted flag : %@";
      v17 = v14;
      v18 = OS_LOG_TYPE_ERROR;
      v19 = 22;
      goto LABEL_12;
    }

    objc_autoreleasePoolPop(v11);
    goto LABEL_14;
  }

  v20 = objc_autoreleasePoolPush();
  v21 = *(a1 + 32);
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
  {
    v23 = HMFGetLogIdentifier();
    *buf = 138543362;
    v27 = v23;
    _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, "%{public}@Missing mkfHomeManager", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v20);
LABEL_14:

  v24 = *MEMORY[0x277D85DE8];
}

- (void)hh2FirstCKImportFinished
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v15 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@HH2 : First CK import finished", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = +[HMDCoreData sharedInstance];
  contextWithRootPartition = [v7 contextWithRootPartition];

  v11[0] = MEMORY[0x277D85DD0];
  v11[1] = 3221225472;
  v11[2] = __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke;
  v11[3] = &unk_27868A750;
  v12 = contextWithRootPartition;
  v13 = selfCopy;
  v9 = contextWithRootPartition;
  [v9 performBlock:v11];

  v10 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) findHomeManagerWithError:0];
  if (v2)
  {
    v3 = v2;
    v4 = [v2 assistantSyncDataPosted];

    if (!v4)
    {
      if (![*(a1 + 40) siriSyncNotificationTime])
      {
        mach_absolute_time();
        [*(a1 + 40) setSiriSyncNotificationTime:UpTicksToMilliseconds()];
      }

      v5 = [*(a1 + 40) workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke_2;
      block[3] = &unk_27868A728;
      block[4] = *(a1 + 40);
      dispatch_async(v5, block);
    }
  }

  else
  {
    v6 = _HMFPreconditionFailure();
    __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke_2(v6);
  }
}

uint64_t __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke_2(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v11 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Posting an urgent sync notification after first HH2 cloudkit import", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *(a1 + 32);
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __53__HMDHomeManager_Assistant__hh2FirstCKImportFinished__block_invoke_21;
  v9[3] = &unk_27868A728;
  v9[4] = v6;
  result = [v6 _generateAssistantSyncDataAndIncrementVersion:1 requestSync:1 urgent:1 completion:v9];
  v8 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_setAssistantSyncRequest:(id)request
{
  v22 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v16 = 138543618;
    v17 = v9;
    v18 = 2112;
    v19 = requestCopy;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Assistant sync data re-generation requested due to reason: %@", &v16, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if (![(HMDHomeManager *)selfCopy siriSyncNotificationTime])
  {
    mach_absolute_time();
    [(HMDHomeManager *)selfCopy setSiriSyncNotificationTime:UpTicksToMilliseconds()];
  }

  if (requestCopy && [requestCopy isEqual:@"SyncStateCompleted"])
  {
    v10 = objc_autoreleasePoolPush();
    v11 = selfCopy;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      assistantGenerationCounter = [(HMDHomeManager *)v11 assistantGenerationCounter];
      v16 = 138543874;
      v17 = v13;
      v18 = 2112;
      v19 = requestCopy;
      v20 = 2048;
      v21 = assistantGenerationCounter;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Posting an urgent sync notification after %@: %tu", &v16, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    [(HMDHomeManager *)v11 _generateAssistantSyncDataAndIncrementVersion:1 requestSync:1 urgent:1 completion:0];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)_assistantSyncDataChanged:(id)changed
{
  changedCopy = changed;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  [(HMDHomeManager *)self _setAssistantSyncRequest:changedCopy];
  debounceRegenerateAssistantSyncDataTimer = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];
  LOBYTE(workQueue) = [debounceRegenerateAssistantSyncDataTimer isRunning];

  if ((workQueue & 1) == 0)
  {
    debounceRegenerateAssistantSyncDataTimer2 = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];
    [debounceRegenerateAssistantSyncDataTimer2 resume];
  }
}

- (void)_generateAssistantSyncDataAndIncrementVersion:(BOOL)version requestSync:(BOOL)sync urgent:(BOOL)urgent completion:(id)completion
{
  versionCopy = version;
  v31 = *MEMORY[0x277D85DE8];
  completionCopy = completion;
  if (urgent || ![(HMDHomeManager *)self shouldDropNotification])
  {
    workQueue = [(HMDHomeManager *)self workQueue];
    dispatch_assert_queue_V2(workQueue);

    if (versionCopy)
    {
      [(HMDHomeManager *)self _incrementAssistantGenerationCounter];
    }

    currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
    v19 = [(HMDHomeManager *)self _homeWithUUID:currentHomeUUID];

    objc_initWeak(buf, self);
    gatherer = [(HMDHomeManager *)self gatherer];
    v23[0] = MEMORY[0x277D85DD0];
    v23[1] = 3221225472;
    v23[2] = __105__HMDHomeManager_Assistant___generateAssistantSyncDataAndIncrementVersion_requestSync_urgent_completion___block_invoke;
    v23[3] = &unk_27867DB50;
    objc_copyWeak(&v26, buf);
    v21 = v19;
    v24 = v21;
    syncCopy = sync;
    urgentCopy = urgent;
    v25 = completionCopy;
    [gatherer gatherHomeKitObjectsWithCompletion:v23];

    objc_destroyWeak(&v26);
    objc_destroyWeak(buf);
  }

  else
  {
    v11 = _Block_copy(completionCopy);
    v12 = v11;
    if (v11)
    {
      (*(v11 + 2))(v11);
    }

    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v30 = v16;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Not generating sync_now data until we have generated data for sync_urgent", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  v22 = *MEMORY[0x277D85DE8];
}

void __105__HMDHomeManager_Assistant___generateAssistantSyncDataAndIncrementVersion_requestSync_urgent_completion___block_invoke(uint64_t a1, uint64_t a2)
{
  v21 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  [WeakRetained writeAssistantCurrentHome:*(a1 + 32)];
  [WeakRetained _setHomekitAssistantNumEntities:a2];
  if (*(a1 + 56) == 1)
  {
    v5 = [WeakRetained currentAccessorySetupMetricDispatcher];
    [v5 markSetupBeginStage:8 error:0];

    v6 = objc_autoreleasePoolPush();
    v7 = WeakRetained;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v9;
      v19 = 2048;
      v20 = [v7 assistantGenerationCounter];
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Generated sync data and posted sync data changed notification with siri generation counter: %tu", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    if (*(a1 + 57))
    {
      v10 = "com.apple.assistant.sync_homekit_urgent";
    }

    else
    {
      v10 = "com.apple.assistant.sync_homekit_now";
    }

    notify_post(v10);
    [v7 _signpostAssistantSyncDataNotification];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = WeakRetained;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2048;
      v20 = [v12 assistantGenerationCounter];
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Generated sync data with siri generation counter: %tu", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *(a1 + 40);
  if (v15)
  {
    (*(v15 + 16))();
  }

  [WeakRetained setPostSyncDataUpdatedNotification:1];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_incrementAssistantGenerationCounter
{
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  [(HMDHomeManager *)self setAssistantGenerationCounter:[(HMDHomeManager *)self assistantGenerationCounter]+ 1];
  assistantGenerationCounter = [(HMDHomeManager *)self assistantGenerationCounter];

  [(HMDHomeManager *)self _setHomekitAssistantConfigurationVersion:assistantGenerationCounter];
}

- (void)__setLastSyncedAssistantConfigurationVersion:(unint64_t)version
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedLong:version];
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kLastSyncedAssistantConfigurationVersionKey" value:v4];
}

- (void)_setHomekitAssistantNumEntities:(unint64_t)entities
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:entities];

  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantConfigurationNumberOfEntitiesKey" value:v4];
}

- (void)_setHomekitAssistantConfigurationVersion:(unint64_t)version
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedLong:version];
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantConfigurationVersionKey" value:v4];
}

- (void)_saveAssistantHashingData:(id)data
{
  v4 = *MEMORY[0x277CD0028];
  dataCopy = data;
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantTeamIdentifier" value:dataCopy applicationIdentifier:v4];
  [(HMDHomeManager *)self _setAssistantHashingData:dataCopy];
}

- (id)_getAssistantHashingData
{
  v3 = CFPreferencesCopyAppValue(@"kAssistantTeamIdentifier", *MEMORY[0x277CD0028]);
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  if (v5)
  {
    v6 = v5;
    __generateAssistantTeamIdentifier = v3;
  }

  else
  {
    __generateAssistantTeamIdentifier = [(HMDHomeManager *)self __generateAssistantTeamIdentifier];
  }

  return __generateAssistantTeamIdentifier;
}

- (id)__generateAssistantTeamIdentifier
{
  uUID = [MEMORY[0x277CCAD78] UUID];
  hm_convertToData = [uUID hm_convertToData];

  [(HMDHomeManager *)self _saveAssistantHashingData:hm_convertToData];
  [(HMDHomeManager *)self setAssistantIdentifierChanged:1];

  return hm_convertToData;
}

- (void)detectAndHandleExcessiveHistoryPruning
{
  v16 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self _shouldCheckExcessiveHistoryPruning])
  {
    [(HMDHomeManager *)self _markExcessiveHistoryPruningHandled];
    backingStore = [(HMDHomeManager *)self backingStore];
    context = [backingStore context];
    managedObjectContext = [context managedObjectContext];

    v6 = [HMDCoreDataCloudTransform detectExcessiveHistoryPruningInContext:managedObjectContext];
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    v10 = os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT);
    if (v6)
    {
      if (v10)
      {
        v11 = HMFGetLogIdentifier();
        v14 = 138543362;
        v15 = v11;
        _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Excessive history pruning detected. Wiping Core Data storage and relaunching daemon", &v14, 0xCu);
      }

      objc_autoreleasePoolPop(v7);
      [objc_opt_class() wipeCoreDataStorageDueToExcessiveHistoryPrunedAndRelaunchHomeKitDaemon];
    }

    else
    {
      if (v10)
      {
        v12 = HMFGetLogIdentifier();
        v14 = 138543362;
        v15 = v12;
        _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@No excessive pruning detected", &v14, 0xCu);
      }

      objc_autoreleasePoolPop(v7);
    }
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_markExcessiveHistoryPruningHandled
{
  v2 = +[HMDHomeKitVersion currentVersion];
  versionString = [v2 versionString];

  standardUserDefaults = [MEMORY[0x277CBEBD0] standardUserDefaults];
  [standardUserDefaults setObject:versionString forKey:@"excessiveHistoryPruningCheckHomeKitVersionKey"];
  v4 = [MEMORY[0x277CBEAA8] now];
  v5 = [v4 description];
  [standardUserDefaults setObject:v5 forKey:@"excessiveHistoryPruningCheckDateKey"];
}

- (BOOL)_shouldCheckExcessiveHistoryPruning
{
  v18 = *MEMORY[0x277D85DE8];
  standardUserDefaults = [MEMORY[0x277CBEBD0] standardUserDefaults];
  v4 = [standardUserDefaults stringForKey:@"excessiveHistoryPruningCheckHomeKitVersionKey"];
  v5 = [standardUserDefaults stringForKey:@"excessiveHistoryPruningCheckDateKey"];
  if (v4)
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543874;
      v13 = v9;
      v14 = 2112;
      v15 = v4;
      v16 = 2112;
      v17 = v5;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@Excessive history pruning detection was already checked on version %@ at %@", &v12, 0x20u);
    }

    objc_autoreleasePoolPop(v6);
  }

  v10 = *MEMORY[0x277D85DE8];
  return v4 == 0;
}

- (void)performInitialGraphLoad:(id)load
{
  v68 = *MEMORY[0x277D85DE8];
  loadCopy = load;
  [(HMDHomeManager *)self detectAndHandleExcessiveHistoryPruning];
  HMFUptime();
  v6 = v5;
  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138544386;
    *&buf[4] = v10;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v56 = @"Starting replay of all models in the home graph";
    *v57 = 2114;
    *&v57[2] = @"state";
    *&v57[10] = 2112;
    *&v57[12] = @"homeManagerLoadingInitialGraph";
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v7);
  mEMORY[0x277D17DE8] = [MEMORY[0x277D17DE8] sharedInstance];
  v12 = objc_alloc(MEMORY[0x277D17DF8]);
  v62 = @"state";
  v63 = @"homeManagerLoadingInitialGraph";
  v13 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v63 forKeys:&v62 count:1];
  v14 = [v12 initWithTag:@"homeManagerInitStart" data:v13];
  currentTagProcessorList = [MEMORY[0x277D0F770] currentTagProcessorList];
  [mEMORY[0x277D17DE8] submitTaggedEvent:v14 processorList:currentTagProcessorList];

  backingStore = [(HMDHomeManager *)selfCopy backingStore];
  [backingStore cdlsReplayAllModelsStartingAt:loadCopy isInitialGraphLoad:1];

  v17 = objc_autoreleasePoolPush();
  v18 = selfCopy;
  v19 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEBUG))
  {
    v20 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v20;
    _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_DEBUG, "%{public}@Replay of all models in the home graph, resolving startup future.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v17);
  v54 = loadCopy;
  if (v18)
  {
    v21 = objc_autoreleasePoolPush();
    v22 = v18;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v24;
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Loading locally persisted incoming invitations", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v21);
    array = [MEMORY[0x277CBEB18] array];
    backingStore2 = [(HMDHomeManager *)v22 backingStore];
    context = [backingStore2 context];
    *buf = MEMORY[0x277D85DD0];
    *&buf[8] = 3221225472;
    *&buf[16] = __50__HMDHomeManager_Startup__loadIncomingInvitations__block_invoke;
    v56 = &unk_27868A750;
    *v57 = v22;
    v28 = array;
    *&v57[8] = v28;
    [context unsafeSynchronousBlock:buf];

    v29 = objc_autoreleasePoolPush();
    v30 = v22;
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
    {
      v32 = HMFGetLogIdentifier();
      v33 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v28, "count")}];
      *v64 = 138543618;
      v65 = v32;
      v66 = 2112;
      v67 = v33;
      _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@Loaded %@ incoming invitations", v64, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
    v34 = *&v57[8];
    v35 = v28;
  }

  else
  {
    v35 = 0;
  }

  [(HMDHomeManager *)v18 setIncomingInvitations:v35];

  startupPromise = [(HMDHomeManager *)v18 startupPromise];
  futureWithNoValue = [MEMORY[0x277D0F7C0] futureWithNoValue];
  [startupPromise resolveWithFuture:futureWithNoValue];

  v38 = objc_autoreleasePoolPush();
  v39 = v18;
  v40 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_INFO))
  {
    v41 = HMFGetLogIdentifier();
    v42 = MEMORY[0x277CCACA8];
    HMFUptime();
    v44 = [v42 stringWithFormat:@"%.3f", v43 - v6];
    *buf = 138544898;
    *&buf[4] = v41;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v56 = @"Loaded initial home graph.";
    *v57 = 2114;
    *&v57[2] = @"state";
    *&v57[10] = 2112;
    *&v57[12] = @"homeManagerLoadedInitialGraph";
    v58 = 2114;
    v59 = @"duration";
    v60 = 2112;
    v61 = v44;
    _os_log_impl(&dword_229538000, v40, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
  }

  objc_autoreleasePoolPop(v38);
  mEMORY[0x277D17DE8]2 = [MEMORY[0x277D17DE8] sharedInstance];
  v46 = objc_alloc(MEMORY[0x277D17DF8]);
  v47 = MEMORY[0x277CCACA8];
  HMFUptime();
  v49 = [v47 stringWithFormat:@"%.3f", v48 - v6];
  v50 = HMDTaggedLoggingCreateDictionary();
  v51 = [v46 initWithTag:@"homeManagerInitStart" data:{v50, @"state", @"homeManagerLoadedInitialGraph", @"duration", v49}];
  currentTagProcessorList2 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [mEMORY[0x277D17DE8]2 submitTaggedEvent:v51 processorList:currentTagProcessorList2];

  v53 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager_Startup__loadIncomingInvitations__block_invoke(uint64_t a1)
{
  v2 = +[HMCContext currentContext];
  v3 = [v2 findHomeManagerWithError:0];
  if (v3)
  {
    v4 = v3;
    v5 = [v3 incomingInvitations];
    v9 = MEMORY[0x277D85DD0];
    v10 = 3221225472;
    v11 = __50__HMDHomeManager_Startup__loadIncomingInvitations__block_invoke_2;
    v12 = &unk_27867E568;
    v6 = *(a1 + 40);
    v13 = *(a1 + 32);
    v14 = v6;
    [v5 hmf_enumerateWithAutoreleasePoolUsingBlock:&v9];

    [v2 rollback];
  }

  else
  {
    v7 = _HMFPreconditionFailure();
    __50__HMDHomeManager_Startup__loadIncomingInvitations__block_invoke_2(v7, v8);
  }
}

void __50__HMDHomeManager_Startup__loadIncomingInvitations__block_invoke_2(uint64_t a1, void *a2)
{
  v50[1] = *MEMORY[0x277D85DE8];
  v2 = a2;
  v3 = objc_alloc(MEMORY[0x277D0F8B0]);
  v4 = [v2 inviterPairingPublicKey];
  v5 = [v3 initWithPairingKeyData:v4];

  v6 = objc_alloc(MEMORY[0x277D0F8A8]);
  v7 = [v2 inviterPairingIdentifier];
  v43 = v5;
  v44 = [v6 initWithIdentifier:v7 publicKey:v5 privateKey:0];

  v8 = [v2 inviterUserID];
  v9 = [HMDAccountHandle accountHandleForDestination:v8];

  v10 = [v2 inviterMergeID];
  v11 = [HMDAccountIdentifier accountIdentifierForSenderCorrelationIdentifier:v10];

  v12 = [HMDAccount alloc];
  v42 = v9;
  v50[0] = v9;
  v13 = [MEMORY[0x277CBEA60] arrayWithObjects:v50 count:1];
  v41 = v11;
  v14 = [(HMDAccount *)v12 initWithIdentifier:v11 handles:v13 devices:MEMORY[0x277CBEBF8]];

  v15 = [HMDIncomingHomeInvitation alloc];
  v16 = [v2 modelID];
  v17 = [v2 invitationState];
  v18 = [v17 integerValue];
  v19 = [v2 homeName];
  v20 = [v2 homeModelID];
  v21 = [v2 inviterMergeID];
  v22 = [v2 expiryDate];
  v40 = v14;
  v23 = [(HMDIncomingHomeInvitation *)v15 initWithInviterAccount:v14 invitationIdentifier:v16 invitationState:v18 homeName:v19 homeUUID:v20 inviterIdentity:v44 inviterMergeID:v21 expiryDate:v22];

  v24 = [v2 idsIdentifier];
  [(HMDHomeInvitation *)v23 setIdsInvitationUUID:v24];

  v25 = [v2 shareURL];
  [(HMDHomeInvitation *)v23 setShareURL:v25];

  v26 = [v2 homeHasCameras];
  -[HMDIncomingHomeInvitation setHomeHasCameras:](v23, "setHomeHasCameras:", [v26 BOOLValue]);

  v27 = [v2 inviteePrivilege];
  -[HMDIncomingHomeInvitation setInviteePrivilege:](v23, "setInviteePrivilege:", [v27 integerValue]);

  v28 = [v2 restrictedGuestSchedule];
  [(HMDIncomingHomeInvitation *)v23 setRestrictedGuestSchedule:v28];

  v29 = MEMORY[0x277CCAAC8];
  v30 = [MEMORY[0x277CBEB98] setWithObject:objc_opt_class()];
  v31 = [v2 shareToken];
  v45 = 0;
  v32 = [v29 _strictlyUnarchivedObjectOfClasses:v30 fromData:v31 error:&v45];
  v33 = v45;

  if (v33)
  {
    v34 = objc_autoreleasePoolPush();
    v35 = *(a1 + 32);
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
    {
      v37 = HMFGetLogIdentifier();
      *buf = 138543618;
      v47 = v37;
      v48 = 2112;
      v49 = v33;
      _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_ERROR, "%{public}@Unarchive share token from store failed with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v34);
  }

  [(HMDHomeInvitation *)v23 setShareToken:v32];
  [*(a1 + 40) addObject:v23];

  v38 = *MEMORY[0x277D85DE8];
}

- (void)initHomeManagerStartup
{
  v4 = 0;
  v3 = [MEMORY[0x277D0F7C0] futureWithPromise:&v4];
  [(HMDHomeManager *)self setStartupCompleted:v3];

  [(HMDHomeManager *)self setStartupPromise:v4];
}

+ (void)wipeCoreDataStorageDueToExcessiveHistoryPrunedAndRelaunchHomeKitDaemon
{
  v15 = *MEMORY[0x277D85DE8];
  defaultStore = [MEMORY[0x277CB8F48] defaultStore];
  aa_primaryAppleAccount = [defaultStore aa_primaryAppleAccount];

  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  v8 = os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT);
  if (aa_primaryAppleAccount)
  {
    if (v8)
    {
      v9 = HMFGetLogIdentifier();
      v13 = 138543362;
      v14 = v9;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Excessive history pruned: Will be removing working, cloud, and shared cloud", &v13, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    [HMDResetConfigPostCleanup writePostCleanupRecordWithReason:10 steps:22];
    v10 = +[HMDMainDriver driver];
    [v10 relaunch];
  }

  else
  {
    if (v8)
    {
      v11 = HMFGetLogIdentifier();
      v13 = 138543362;
      v14 = v11;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Excessive history pruned: Not going to remove the CD stores as user is in the process of signing out.", &v13, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    [HMDResetConfigPostCleanup writePostCleanupRecordWithReason:2 steps:-1];
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (id)currentHome
{
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  v3 = _accessoryOfCurrentDevice;
  if (_accessoryOfCurrentDevice)
  {
    home = [_accessoryOfCurrentDevice home];
  }

  else
  {
    home = 0;
  }

  return home;
}

- (BOOL)deviceAddressIsForPrimaryResident:(id)resident
{
  residentCopy = resident;
  currentHome = [(HMDHomeManager *)self currentHome];
  v6 = currentHome;
  if (currentHome)
  {
    primaryResident = [currentHome primaryResident];
    messageAddress = [primaryResident messageAddress];
    idsIdentifier = [messageAddress idsIdentifier];
    idsIdentifier2 = [residentCopy idsIdentifier];
    v11 = [idsIdentifier isEqual:idsIdentifier2];
  }

  else
  {
    v11 = 0;
  }

  return v11;
}

- (BOOL)isCurrentDevicePrimaryResident
{
  currentHome = [(HMDHomeManager *)self currentHome];
  v3 = currentHome;
  if (currentHome)
  {
    isCurrentDevicePrimaryResident = [currentHome isCurrentDevicePrimaryResident];
  }

  else
  {
    isCurrentDevicePrimaryResident = 0;
  }

  return isCurrentDevicePrimaryResident;
}

- (void)_informMdnsOfHomeWithResidentsUpdate
{
  [(HMDHomeManager *)self homeWithResidentsPresent];
  workQueue = [(HMDHomeManager *)self workQueue];
  mrc_shared_assist_cache_set_enable();
}

void __71__HMDHomeManager_DeviceResidency___informMdnsOfHomeWithResidentsUpdate__block_invoke(uint64_t a1, int a2)
{
  v17 = *MEMORY[0x277D85DE8];
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEBUG))
  {
    v7 = HMFGetLogIdentifier();
    v8 = *(a1 + 40);
    v9 = HMFBooleanToString();
    v11 = 138543874;
    v12 = v7;
    v13 = 2112;
    v14 = v9;
    v15 = 1024;
    v16 = a2;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_DEBUG, "%{public}@Informing mDNS about homeWithResidents: %@ completed with error: %d", &v11, 0x1Cu);
  }

  objc_autoreleasePoolPop(v4);
  v10 = *MEMORY[0x277D85DE8];
}

- (void)handleHomeOrResidentsChanged
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __63__HMDHomeManager_DeviceResidency__handleHomeOrResidentsChanged__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

void __63__HMDHomeManager_DeviceResidency__handleHomeOrResidentsChanged__block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) homes];
  v3 = [v2 na_firstObjectPassingTest:&__block_literal_global_204462];

  if ((v3 != 0) != [*(a1 + 32) homeWithResidentsPresent])
  {
    [*(a1 + 32) setHomeWithResidentsPresent:v3 != 0];
    [*(a1 + 32) _informMdnsOfHomeWithResidentsUpdate];
  }
}

BOOL __63__HMDHomeManager_DeviceResidency__handleHomeOrResidentsChanged__block_invoke_2(uint64_t a1, void *a2)
{
  v2 = [a2 enabledResidents];
  v3 = [v2 count] != 0;

  return v3;
}

- (BOOL)deviceAddressBelongsToResidentOfCurrentHome:(id)home
{
  v31 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  currentHome = [(HMDHomeManager *)self currentHome];
  v6 = currentHome;
  if (currentHome)
  {
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    residentDeviceManager = [currentHome residentDeviceManager];
    residentDevices = [residentDeviceManager residentDevices];

    obj = residentDevices;
    v9 = [residentDevices countByEnumeratingWithState:&v26 objects:v30 count:16];
    if (v9)
    {
      v10 = v9;
      v25 = *v27;
      v23 = v6;
      while (2)
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v27 != v25)
          {
            objc_enumerationMutation(obj);
          }

          v12 = *(*(&v26 + 1) + 8 * i);
          idsIdentifier = [homeCopy idsIdentifier];
          messageAddress = [v12 messageAddress];
          idsIdentifier2 = [messageAddress idsIdentifier];
          if ([idsIdentifier isEqual:idsIdentifier2])
          {

LABEL_15:
            v20 = 1;
            v6 = v23;
            goto LABEL_16;
          }

          idsDestination = [homeCopy idsDestination];
          messageAddress2 = [v12 messageAddress];
          idsDestination2 = [messageAddress2 idsDestination];
          v19 = [idsDestination isEqualToString:idsDestination2];

          if (v19)
          {
            goto LABEL_15;
          }
        }

        v10 = [obj countByEnumeratingWithState:&v26 objects:v30 count:16];
        v20 = 0;
        v6 = v23;
        if (v10)
        {
          continue;
        }

        break;
      }
    }

    else
    {
      v20 = 0;
    }

LABEL_16:
  }

  else
  {
    v20 = 0;
  }

  v21 = *MEMORY[0x277D85DE8];
  return v20;
}

- (BOOL)isCurrentDeviceResident
{
  currentHome = [(HMDHomeManager *)self currentHome];
  v3 = currentHome;
  if (currentHome)
  {
    isCurrentDeviceAvailableResident = [currentHome isCurrentDeviceAvailableResident];
  }

  else
  {
    isCurrentDeviceAvailableResident = 0;
  }

  return isCurrentDeviceAvailableResident;
}

- (id)multiUserSettingsForMultiUserSettingsMetricsEventDispatcherDataSource
{
  v35 = *MEMORY[0x277D85DE8];
  [(HMDHomeManager *)self homes];
  v30 = 0u;
  v31 = 0u;
  v32 = 0u;
  obj = v33 = 0u;
  v26 = [obj countByEnumeratingWithState:&v30 objects:v34 count:16];
  if (v26)
  {
    v28 = 0;
    v29 = 0;
    v27 = 0;
    v2 = 0;
    v3 = 0;
    v4 = 0;
    v5 = 0;
    v6 = 0;
    v7 = 0;
    v8 = 0;
    v25 = *v31;
    do
    {
      for (i = 0; i != v26; ++i)
      {
        if (*v31 != v25)
        {
          objc_enumerationMutation(obj);
        }

        multiUserSettings = [*(*(&v30 + 1) + 8 * i) multiUserSettings];
        numSharedUsers = [multiUserSettings numSharedUsers];
        v8 += [numSharedUsers unsignedIntValue];

        numUsersWithSettings = [multiUserSettings numUsersWithSettings];
        v7 += [numUsersWithSettings unsignedIntValue];

        numUsersWithIdentifyVoiceOff = [multiUserSettings numUsersWithIdentifyVoiceOff];
        v6 += [numUsersWithIdentifyVoiceOff unsignedIntValue];

        numUsersWithPlayBackInfluencesForYouOff = [multiUserSettings numUsersWithPlayBackInfluencesForYouOff];
        v5 += [numUsersWithPlayBackInfluencesForYouOff unsignedIntValue];

        numUsersCloudShareTrustNotConfigured = [multiUserSettings numUsersCloudShareTrustNotConfigured];
        v29 += [numUsersCloudShareTrustNotConfigured unsignedIntValue];

        numUsersSharedBackingStoreNotStarted = [multiUserSettings numUsersSharedBackingStoreNotStarted];
        v28 += [numUsersSharedBackingStoreNotStarted unsignedIntValue];

        numUsersSharedBackingStoreRunning = [multiUserSettings numUsersSharedBackingStoreRunning];
        v27 += [numUsersSharedBackingStoreRunning unsignedIntValue];

        numUsersSharedBackingStoreNotRunningDueToError = [multiUserSettings numUsersSharedBackingStoreNotRunningDueToError];
        v2 += [numUsersSharedBackingStoreNotRunningDueToError unsignedIntValue];

        numUsersSharedBackingStoreNotRunningDueToStopped = [multiUserSettings numUsersSharedBackingStoreNotRunningDueToStopped];
        v3 += [numUsersSharedBackingStoreNotRunningDueToStopped unsignedIntValue];

        numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation = [multiUserSettings numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation];
        v4 += [numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation unsignedIntValue];
      }

      v26 = [obj countByEnumeratingWithState:&v30 objects:v34 count:16];
    }

    while (v26);
  }

  else
  {
    v28 = 0;
    v29 = 0;
    v27 = 0;
    v2 = 0;
    v3 = 0;
    v4 = 0;
    v5 = 0;
    v6 = 0;
    v7 = 0;
    v8 = 0;
  }

  v21 = [objc_alloc(MEMORY[0x277CD1C20]) initWithNumSharedUsers:v8 numUsersWithSettings:v7 numUsersWithIdentifyVoiceOff:v6 numUsersWithPlayBackInfluencesForYouOff:v5 numUsersCloudShareTrustNotConfigured:v29 numUsersSharedBackingStoreNotStarted:v28 numUsersSharedBackingStoreRunning:v27 numUsersSharedBackingStoreNotRunningDueToError:v2 numUsersSharedBackingStoreNotRunningDueToStopped:v3 numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation:v4];

  v22 = *MEMORY[0x277D85DE8];

  return v21;
}

- (void)resetTTSUHH2SettingsMigrationKey
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Going to delete the TTSU HH2 settings migration key", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
  [userDefaults removeObjectForKey:@"mi.hh2"];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)purgeAllRecordZones:(id)zones fromDatabase:(id)database completionHandler:(id)handler
{
  v30 = *MEMORY[0x277D85DE8];
  zonesCopy = zones;
  databaseCopy = database;
  handlerCopy = handler;
  v11 = objc_autoreleasePoolPush();
  selfCopy = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v14;
    v28 = 2048;
    v29 = [zonesCopy count];
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Going to purge all the zones : %lu", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v15 = objc_alloc(MEMORY[0x277CBC490]);
  allKeys = [zonesCopy allKeys];
  v17 = [v15 initWithRecordZonesToSave:0 recordZoneIDsToDelete:allKeys];

  [v17 setMarkZonesAsUserPurged:1];
  v20 = MEMORY[0x277D85DD0];
  v21 = 3221225472;
  v22 = __82__HMDHomeManager_ResetConfig__purgeAllRecordZones_fromDatabase_completionHandler___block_invoke;
  v23 = &unk_278683CB8;
  v24 = selfCopy;
  v25 = handlerCopy;
  v18 = handlerCopy;
  [v17 setModifyRecordZonesCompletionBlock:&v20];
  [databaseCopy addOperation:{v17, v20, v21, v22, v23, v24}];

  v19 = *MEMORY[0x277D85DE8];
}

void __82__HMDHomeManager_ResetConfig__purgeAllRecordZones_fromDatabase_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v23 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 32);
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v17 = 138543874;
    v18 = v13;
    v19 = 2112;
    v20 = v8;
    v21 = 2112;
    v22 = v9;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] :Purging for zones:%@ finished with error: %@", &v17, 0x20u);
  }

  objc_autoreleasePoolPop(v10);
  v14 = _Block_copy(*(a1 + 40));
  v15 = v14;
  if (v14)
  {
    (*(v14 + 2))(v14, v9);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)purgeShares:(id)shares fromDatabase:(id)database completionHandler:(id)handler
{
  v26 = *MEMORY[0x277D85DE8];
  sharesCopy = shares;
  databaseCopy = database;
  handlerCopy = handler;
  v11 = objc_autoreleasePoolPush();
  selfCopy = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v14;
    *&buf[12] = 2048;
    *&buf[14] = [sharesCopy count];
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : purgeShares %ld", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v15 = [objc_alloc(MEMORY[0x277CBC4A0]) initWithRecordsToSave:0 recordIDsToDelete:sharesCopy];
  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x3032000000;
  v23 = __Block_byref_object_copy__238199;
  v24 = __Block_byref_object_dispose__238200;
  v25 = 0;
  v21[0] = MEMORY[0x277D85DD0];
  v21[1] = 3221225472;
  v21[2] = __74__HMDHomeManager_ResetConfig__purgeShares_fromDatabase_completionHandler___block_invoke;
  v21[3] = &unk_278683C68;
  v21[4] = selfCopy;
  v21[5] = buf;
  [v15 setPerRecordDeleteBlock:v21];
  v18[0] = MEMORY[0x277D85DD0];
  v18[1] = 3221225472;
  v18[2] = __74__HMDHomeManager_ResetConfig__purgeShares_fromDatabase_completionHandler___block_invoke_217;
  v18[3] = &unk_278683C90;
  v18[4] = selfCopy;
  v20 = buf;
  v16 = handlerCopy;
  v19 = v16;
  [v15 setModifyRecordsCompletionBlock:v18];
  [databaseCopy addOperation:v15];

  _Block_object_dispose(buf, 8);
  v17 = *MEMORY[0x277D85DE8];
}

void __74__HMDHomeManager_ResetConfig__purgeShares_fromDatabase_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  v10 = v9;
  if (v6)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [v5 hmbDescription];
      v15 = 138543874;
      v16 = v11;
      v17 = 2112;
      v18 = v12;
      v19 = 2114;
      v20 = v6;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] Failed to delete record with ID %@: %{public}@", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v7);
    objc_storeStrong((*(*(a1 + 40) + 8) + 40), a3);
  }

  else
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEBUG))
    {
      v13 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v13;
      v17 = 2112;
      v18 = v5;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_DEBUG, "%{public}@[Reset Config] Successfully deleted record with ID: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __74__HMDHomeManager_ResetConfig__purgeShares_fromDatabase_completionHandler___block_invoke_217(uint64_t a1, void *a2, void *a3, void *a4)
{
  v23 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 32);
  v12 = HMFGetOSLogHandle();
  v13 = v12;
  if (v9)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v14;
      v21 = 2114;
      v22 = v9;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] purgeShares CKModifyRecordsOperation failed: %{public}@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    objc_storeStrong((*(*(a1 + 48) + 8) + 40), a4);
  }

  else
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v19 = 138543362;
      v20 = v15;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] purgeShares CKModifyRecordsOperation succeeded", &v19, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
  }

  v16 = _Block_copy(*(a1 + 40));
  v17 = v16;
  if (v16)
  {
    (*(v16 + 2))(v16, *(*(*(a1 + 48) + 8) + 40));
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)purgeAllSharesFromZones:(id)zones fromDatabase:(id)database dispatchGroup:(id)group
{
  v49 = *MEMORY[0x277D85DE8];
  zonesCopy = zones;
  databaseCopy = database;
  group = group;
  v8 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v10;
    *&buf[12] = 2112;
    *&buf[14] = zonesCopy;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] Going to purge all the zones : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x3032000000;
  v46 = __Block_byref_object_copy__238199;
  v47 = __Block_byref_object_dispose__238200;
  v48 = 0;
  v11 = objc_alloc_init(MEMORY[0x277CBEB18]);
  [zonesCopy allKeys];
  v38 = 0u;
  v39 = 0u;
  v36 = 0u;
  v12 = v37 = 0u;
  v13 = [v12 countByEnumeratingWithState:&v36 objects:v44 count:16];
  if (v13)
  {
    v30 = *v37;
    v29 = *MEMORY[0x277CBC020];
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v37 != v30)
        {
          objc_enumerationMutation(v12);
        }

        v15 = *(*(&v36 + 1) + 8 * i);
        v16 = [objc_alloc(MEMORY[0x277CBC5D0]) initWithRecordName:v29 zoneID:v15];
        [v11 addObject:v16];
        lastObject = [v12 lastObject];
        v18 = [v15 isEqual:lastObject];

        if (([v11 count] > 0x63) | v18 & 1)
        {
          dispatch_group_enter(group);
          v19 = objc_autoreleasePoolPush();
          v20 = selfCopy;
          v21 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
          {
            v22 = HMFGetLogIdentifier();
            v23 = [v11 count];
            *v40 = 138543618;
            v41 = v22;
            v42 = 2048;
            v43 = v23;
            _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] purging batch of shares [%lu]", v40, 0x16u);
          }

          objc_autoreleasePoolPop(v19);
          v32[0] = MEMORY[0x277D85DD0];
          v32[1] = 3221225472;
          v32[2] = __82__HMDHomeManager_ResetConfig__purgeAllSharesFromZones_fromDatabase_dispatchGroup___block_invoke;
          v32[3] = &unk_278683C40;
          v34 = buf;
          v32[4] = v20;
          v35 = v18;
          groupCopy = group;
          [(HMDHomeManager *)v20 purgeShares:v11 fromDatabase:databaseCopy completionHandler:v32];
          v24 = objc_alloc_init(MEMORY[0x277CBEB18]);

          v11 = v24;
        }
      }

      v13 = [v12 countByEnumeratingWithState:&v36 objects:v44 count:16];
    }

    while (v13);
  }

  _Block_object_dispose(buf, 8);
  v25 = *MEMORY[0x277D85DE8];
}

void __82__HMDHomeManager_ResetConfig__purgeAllSharesFromZones_fromDatabase_dispatchGroup___block_invoke(uint64_t a1, void *a2)
{
  v25 = *MEMORY[0x277D85DE8];
  v4 = a2;
  if (v4)
  {
    objc_storeStrong((*(*(a1 + 48) + 8) + 40), a2);
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 32);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v21 = 138543618;
      v22 = v8;
      v23 = 2112;
      v24 = v4;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] purgeShares returned error %@. Will try to continue.", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  if (*(a1 + 56) == 1)
  {
    v9 = *(*(*(a1 + 48) + 8) + 40);
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 32);
    v12 = HMFGetOSLogHandle();
    v13 = v12;
    if (v9)
    {
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        v15 = *(*(*(a1 + 48) + 8) + 40);
        v21 = 138543618;
        v22 = v14;
        v23 = 2112;
        v24 = v15;
        v16 = "%{public}@[Reset Config] :Purging shares of zones on HH2 failed with error: %@";
        v17 = v13;
        v18 = OS_LOG_TYPE_ERROR;
        v19 = 22;
LABEL_11:
        _os_log_impl(&dword_229538000, v17, v18, v16, &v21, v19);
      }
    }

    else if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v21 = 138543362;
      v22 = v14;
      v16 = "%{public}@[Reset Config] :Purging shares of zones on HH2 succeeded";
      v17 = v13;
      v18 = OS_LOG_TYPE_INFO;
      v19 = 12;
      goto LABEL_11;
    }

    objc_autoreleasePoolPop(v10);
  }

  dispatch_group_leave(*(a1 + 40));

  v20 = *MEMORY[0x277D85DE8];
}

- (BOOL)fetchAndRemoveNextBatchOfZonesFromDatabase:(id)database
{
  v36 = *MEMORY[0x277D85DE8];
  databaseCopy = database;
  v5 = objc_autoreleasePoolPush();
  fetchAllRecordZonesOperation = [MEMORY[0x277CBC3D0] fetchAllRecordZonesOperation];
  [fetchAllRecordZonesOperation setDatabase:databaseCopy];
  currentThread = [MEMORY[0x277CCACC8] currentThread];
  qualityOfService = [currentThread qualityOfService];
  configuration = [fetchAllRecordZonesOperation configuration];
  [configuration setQualityOfService:qualityOfService];

  v10 = dispatch_group_create();
  dispatch_group_enter(v10);
  v30 = 0;
  v31 = &v30;
  v32 = 0x2020000000;
  v33 = 0;
  v22 = MEMORY[0x277D85DD0];
  v23 = 3221225472;
  v24 = __74__HMDHomeManager_ResetConfig__fetchAndRemoveNextBatchOfZonesFromDatabase___block_invoke;
  v25 = &unk_278683C18;
  selfCopy = self;
  v11 = databaseCopy;
  v27 = v11;
  v29 = &v30;
  v12 = v10;
  v28 = v12;
  [fetchAllRecordZonesOperation setFetchRecordZonesCompletionBlock:&v22];
  operationQueue = [v11 operationQueue];
  [operationQueue addOperation:fetchAllRecordZonesOperation];

  v14 = dispatch_time(0, 30000000000);
  if (dispatch_group_wait(v12, v14))
  {
    v15 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v18;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] :Timed out while waiting to fetch all cloud zones from HH2 container. Give up.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
  }

  v19 = *(v31 + 24);

  _Block_object_dispose(&v30, 8);
  objc_autoreleasePoolPop(v5);

  v20 = *MEMORY[0x277D85DE8];
  return v19 & 1;
}

void __74__HMDHomeManager_ResetConfig__fetchAndRemoveNextBatchOfZonesFromDatabase___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v28 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = [v5 allKeys];
    *buf = 138543874;
    v23 = v10;
    v24 = 2112;
    v25 = v11;
    v26 = 2112;
    v27 = v6;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] :All fetched keys for removal %@, error: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  if ([*(a1 + 40) databaseScope] == 3 && objc_msgSend(v5, "count"))
  {
    *(*(*(a1 + 56) + 8) + 24) = 1;
    [*(a1 + 32) purgeAllSharesFromZones:v5 fromDatabase:*(a1 + 40) dispatchGroup:*(a1 + 48)];
LABEL_11:
    dispatch_group_leave(*(a1 + 48));
    goto LABEL_12;
  }

  if ([v5 count] < 2)
  {
    v14 = objc_autoreleasePoolPush();
    v15 = *(a1 + 32);
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
    {
      v17 = HMFGetLogIdentifier();
      v18 = *(a1 + 40);
      *buf = 138543618;
      v23 = v17;
      v24 = 2112;
      v25 = v18;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] No more zones found for removal in database %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    goto LABEL_11;
  }

  *(*(*(a1 + 56) + 8) + 24) = 1;
  v12 = *(a1 + 32);
  v13 = *(a1 + 40);
  v20[0] = MEMORY[0x277D85DD0];
  v20[1] = 3221225472;
  v20[2] = __74__HMDHomeManager_ResetConfig__fetchAndRemoveNextBatchOfZonesFromDatabase___block_invoke_211;
  v20[3] = &unk_27868A1D8;
  v20[4] = v12;
  v21 = *(a1 + 48);
  [v12 purgeAllRecordZones:v5 fromDatabase:v13 completionHandler:v20];

LABEL_12:
  v19 = *MEMORY[0x277D85DE8];
}

void __74__HMDHomeManager_ResetConfig__fetchAndRemoveNextBatchOfZonesFromDatabase___block_invoke_211(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543618;
    v10 = v7;
    v11 = 2112;
    v12 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] :Purging of zones on HH2 finished with error: %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  dispatch_group_leave(*(a1 + 40));

  v8 = *MEMORY[0x277D85DE8];
}

- (void)fetchAndRemoveAllZonesFromDatabase:(id)database
{
  v21 = *MEMORY[0x277D85DE8];
  databaseCopy = database;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v18 = v8;
    v19 = 2112;
    v20 = databaseCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] Fetching and removing all zones from database %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  if ([(HMDHomeManager *)selfCopy fetchAndRemoveNextBatchOfZonesFromDatabase:databaseCopy])
  {
    v9 = 1;
    while (1)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = selfCopy;
      v12 = HMFGetOSLogHandle();
      v13 = v12;
      if (v9 == 101)
      {
        break;
      }

      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        *buf = 138543618;
        v18 = v14;
        v19 = 1024;
        LODWORD(v20) = v9;
        _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] Found something in batch %d. Trying again in case there is more", buf, 0x12u);
      }

      objc_autoreleasePoolPop(v10);
      ++v9;
      if (![(HMDHomeManager *)v11 fetchAndRemoveNextBatchOfZonesFromDatabase:databaseCopy])
      {
        goto LABEL_13;
      }
    }

    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v18 = v15;
      v19 = 1024;
      LODWORD(v20) = 101;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] Went through too many batches [%d]. Giving up.", buf, 0x12u);
    }

    objc_autoreleasePoolPop(v10);
  }

LABEL_13:

  v16 = *MEMORY[0x277D85DE8];
}

- (void)performCleanupOnHH2Container
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v14 = 138543618;
    v15 = v6;
    v16 = 2112;
    v17 = @"com.apple.homekit.config";
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Perform clean up on HH2 container. : %@", &v14, 0x16u);
  }

  objc_autoreleasePoolPop(v3);
  v7 = objc_alloc(MEMORY[0x277CBC220]);
  v8 = [v7 initWithContainerIdentifier:@"com.apple.homekit.config" environment:cloudKitContainerEnvironment];
  v9 = objc_opt_new();
  [v9 setUseZoneWidePCS:1];
  v10 = [objc_alloc(MEMORY[0x277CBC218]) initWithContainerID:v8 options:v9];
  privateCloudDatabase = [v10 privateCloudDatabase];
  [(HMDHomeManager *)selfCopy fetchAndRemoveAllZonesFromDatabase:privateCloudDatabase];

  sharedCloudDatabase = [v10 sharedCloudDatabase];
  [(HMDHomeManager *)selfCopy fetchAndRemoveAllZonesFromDatabase:sharedCloudDatabase];

  v13 = *MEMORY[0x277D85DE8];
}

- (void)cleanupLocalConfiguration
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    v14 = 138543362;
    v15 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : cleaning up local configuration", &v14, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [(HMDHomeManager *)selfCopy _eraseLocalHomeConfiguration];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  [systemStore removeControllerKeyPairWithError:0];
  v8 = objc_autoreleasePoolPush();
  v9 = selfCopy;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = HMFGetLogIdentifier();
    v12 = HMFBooleanToString();
    v14 = 138543618;
    v15 = v11;
    v16 = 2112;
    v17 = v12;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Controller key removal status : %@", &v14, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v13 = *MEMORY[0x277D85DE8];
}

- (void)resetHomeConfigForHH2:(BOOL)h2 message:(id)message
{
  h2Copy = h2;
  v47 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    v10 = HMFGetLogIdentifier();
    LODWORD(buf) = 138543362;
    *(&buf + 4) = v10;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Reset config is invoked", &buf, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  v11 = objc_autoreleasePoolPush();
  qualityOfService = [messageCopy qualityOfService];
  if (selfCopy)
  {
    v13 = qualityOfService;
    v14 = +[HMDAppleAccountManager sharedManager];
    account = [v14 account];
    handles = [account handles];
    firstObject = [handles firstObject];

    if (firstObject)
    {
      v42 = v11;
      v18 = h2Copy;
      v19 = [HMDRemoteAccountMessageDestination alloc];
      messageTargetUUID = [(HMDHomeManager *)selfCopy messageTargetUUID];
      v21 = [(HMDRemoteAccountMessageDestination *)v19 initWithTarget:messageTargetUUID handle:firstObject multicast:1];

      [(HMDRemoteAccountMessageDestination *)v21 setRestrictToResidentCapable:1];
      v22 = [HMDRemoteMessage secureMessageWithName:@"HMD.EL.reset" qualityOfService:v13 destination:v21 messagePayload:MEMORY[0x277CBEC10]];
      v23 = objc_autoreleasePoolPush();
      v24 = selfCopy;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        v26 = HMFGetLogIdentifier();
        LODWORD(buf) = 138543362;
        *(&buf + 4) = v26;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Signaling all resident devices to reset hindsight configuration", &buf, 0xCu);
      }

      objc_autoreleasePoolPop(v23);
      messageDispatcher = [(HMDHomeManager *)v24 messageDispatcher];
      *&buf = MEMORY[0x277D85DD0];
      *(&buf + 1) = 3221225472;
      v44 = __67__HMDHomeManager_ResetConfig___resetHindsightWithQualityOfService___block_invoke;
      v45 = &unk_27868A250;
      v46 = v24;
      [messageDispatcher sendMessage:v22 completionHandler:&buf];

      h2Copy = v18;
      v11 = v42;
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      v29 = selfCopy;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
      {
        v31 = HMFGetLogIdentifier();
        LODWORD(buf) = 138543362;
        *(&buf + 4) = v31;
        _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Can't notify residents to reset hindsight configuration because the current account is missing or has no handles", &buf, 0xCu);
      }

      objc_autoreleasePoolPop(v28);
    }
  }

  objc_autoreleasePoolPop(v11);
  +[HMDAuditHH2KeysForBackupOperation resetHH2KeyBackupOperationFromUserDefault];
  v32 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)selfCopy performCleanupOnHH2Container];
  objc_autoreleasePoolPop(v32);
  v33 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)selfCopy cleanupLocalConfiguration];
  objc_autoreleasePoolPop(v33);
  if (h2Copy)
  {
    v34 = objc_autoreleasePoolPush();
    [(HMDHomeManager *)selfCopy _eraseLocalMetadata];
    objc_autoreleasePoolPop(v34);
  }

  v35 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)selfCopy deleteZonesFromLegacyAndCameraContainers];
  objc_autoreleasePoolPop(v35);
  v36 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)selfCopy waitForHH2SentinelZoneToBeRemoved];
  objc_autoreleasePoolPop(v36);
  [messageCopy respondWithSuccess];
  v37 = objc_autoreleasePoolPush();
  v38 = selfCopy;
  v39 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
  {
    v40 = HMFGetLogIdentifier();
    LODWORD(buf) = 138543362;
    *(&buf + 4) = v40;
    _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Reset config is finished", &buf, 0xCu);
  }

  objc_autoreleasePoolPop(v37);
  [objc_opt_class() relaunchHomedDueToResetConfigurationWithDelay:2.0];

  v41 = *MEMORY[0x277D85DE8];
}

void __67__HMDHomeManager_ResetConfig___resetHindsightWithQualityOfService___block_invoke(uint64_t a1, void *a2)
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = v6;
  if (v3)
  {
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v14 = 138543618;
      v15 = v8;
      v16 = 2114;
      v17 = v3;
      v9 = "%{public}@Failed to signal resident devices to reset hindsight configuration: %{public}@";
      v10 = v7;
      v11 = OS_LOG_TYPE_ERROR;
      v12 = 22;
LABEL_6:
      _os_log_impl(&dword_229538000, v10, v11, v9, &v14, v12);
    }
  }

  else if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v14 = 138543362;
    v15 = v8;
    v9 = "%{public}@Sent reset hindsight configuration message successfully";
    v10 = v7;
    v11 = OS_LOG_TYPE_INFO;
    v12 = 12;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v4);
  v13 = *MEMORY[0x277D85DE8];
}

- (id)createCloudDatabaseAndPerformInitialSync:(id)sync
{
  v50 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v45 = v8;
    v46 = 2112;
    v47 = syncCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Creating cloud database from container : [%@]", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = objc_alloc(MEMORY[0x277CBC220]);
  v10 = [v9 initWithContainerIdentifier:@"com.apple.willow.config" environment:cloudKitContainerEnvironment];
  v11 = [objc_alloc(MEMORY[0x277D17050]) initWithContainerID:v10];
  v12 = objc_alloc(MEMORY[0x277D17048]);
  v13 = +[HMDDatabase defaultDatabase];
  localDatabase = [v13 localDatabase];
  v43 = 0;
  v15 = [v12 initWithLocalDatabase:localDatabase configuration:v11 error:&v43];
  v16 = v43;

  v17 = objc_autoreleasePoolPush();
  v18 = selfCopy;
  v19 = HMFGetOSLogHandle();
  v20 = v19;
  if (v15)
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543618;
      v45 = v21;
      v46 = 2112;
      v47 = v15;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Going to performInitialCloudSync for %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v22 = dispatch_group_create();
    dispatch_group_enter(v22);
    performInitialCloudSync = [v15 performInitialCloudSync];
    v40[0] = MEMORY[0x277D85DD0];
    v40[1] = 3221225472;
    v40[2] = __72__HMDHomeManager_ResetConfig__createCloudDatabaseAndPerformInitialSync___block_invoke;
    v40[3] = &unk_2786879C0;
    v40[4] = v18;
    v24 = v15;
    v41 = v24;
    v25 = v22;
    v42 = v25;
    v26 = [performInitialCloudSync addCompletionBlock:v40];
    v27 = dispatch_time(0, 30000000000);
    if (dispatch_group_wait(v25, v27))
    {
      v39 = v11;
      v28 = v10;
      v29 = v16;
      v30 = objc_autoreleasePoolPush();
      v31 = v18;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v33 = v38 = syncCopy;
        *buf = 138543618;
        v45 = v33;
        v46 = 2112;
        v47 = v24;
        _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Timed out while waiting to perform initial sync on %@", buf, 0x16u);

        syncCopy = v38;
      }

      objc_autoreleasePoolPop(v30);
      v16 = v29;
      v10 = v28;
      v11 = v39;
    }

    v34 = v24;
  }

  else
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v35 = HMFGetLogIdentifier();
      *buf = 138543874;
      v45 = v35;
      v46 = 2112;
      v47 = syncCopy;
      v48 = 2112;
      v49 = v16;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Failed to create cloud database with containerID %@: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
  }

  v36 = *MEMORY[0x277D85DE8];

  return v15;
}

void __72__HMDHomeManager_ResetConfig__createCloudDatabaseAndPerformInitialSync___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    v13 = 138543874;
    v14 = v10;
    v15 = 2112;
    v16 = v11;
    v17 = 2112;
    v18 = v6;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Initial cloud sync finished on %@ with error: %@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 48));

  v12 = *MEMORY[0x277D85DE8];
}

- (id)deleteLocalZone:(id)zone localDatabase:(id)database containerID:(id)d
{
  v32 = *MEMORY[0x277D85DE8];
  zoneCopy = zone;
  databaseCopy = database;
  dCopy = d;
  v11 = objc_autoreleasePoolPush();
  selfCopy = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v14;
    v28 = 2112;
    v29 = zoneCopy;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Going to open local zone [%@] and delete it", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v15 = objc_alloc_init(MEMORY[0x277D170F8]);
  [v15 setCreateIfNeeded:0];
  v25 = 0;
  v16 = [databaseCopy openZoneWithZoneID:zoneCopy configuration:v15 error:&v25];
  v17 = v25;
  if (v16)
  {
    v18 = [databaseCopy removeZone:v16];
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = selfCopy;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543874;
      v27 = v22;
      v28 = 2112;
      v29 = zoneCopy;
      v30 = 2112;
      v31 = v17;
      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Failed to open local zone with zoneID %@: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v19);
    v18 = 0;
  }

  v23 = *MEMORY[0x277D85DE8];

  return v18;
}

- (void)deleteAllZonesFromContainer:(id)container
{
  v58 = *MEMORY[0x277D85DE8];
  containerCopy = container;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v53 = v8;
    v54 = 2112;
    v55 = containerCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Asked to delete all the zones from container : [%@]", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)selfCopy createCloudDatabaseAndPerformInitialSync:containerCopy];
  v10 = objc_autoreleasePoolPush();
  v11 = selfCopy;
  v12 = HMFGetOSLogHandle();
  v13 = v12;
  if (v9)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v15 = MEMORY[0x277CCABB0];
      privateZoneIDs = [v9 privateZoneIDs];
      v17 = [v15 numberWithUnsignedInteger:{objc_msgSend(privateZoneIDs, "count")}];
      *buf = 138543874;
      v53 = v14;
      v54 = 2112;
      v55 = containerCopy;
      v56 = 2112;
      v57 = v17;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] There are %@ zones", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    array = [MEMORY[0x277CBEB18] array];
    privateZoneIDs2 = [v9 privateZoneIDs];
    v49[0] = MEMORY[0x277D85DD0];
    v49[1] = 3221225472;
    v49[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke;
    v49[3] = &unk_278683BC8;
    v49[4] = v11;
    v20 = v9;
    v50 = v20;
    v21 = array;
    v51 = v21;
    [privateZoneIDs2 hmf_enumerateWithAutoreleasePoolUsingBlock:v49];

    localDatabase = [v20 localDatabase];
    v23 = [localDatabase fetchZonesWithError:0];

    if ([v23 count])
    {
      v24 = dispatch_group_create();
      dispatch_group_enter(v24);
      v45[0] = MEMORY[0x277D85DD0];
      v45[1] = 3221225472;
      v45[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_196;
      v45[3] = &unk_278683BF0;
      v45[4] = v11;
      v46 = v20;
      v25 = containerCopy;
      v47 = v25;
      v26 = v21;
      v48 = v26;
      [v23 hmf_enumerateWithAutoreleasePoolUsingBlock:v45];
      v27 = MEMORY[0x277D2C900];
      immediateScheduler = [MEMORY[0x277D2C938] immediateScheduler];
      v29 = [v27 combineAllFutures:v26 ignoringErrors:1 scheduler:immediateScheduler];
      v43[0] = MEMORY[0x277D85DD0];
      v43[1] = 3221225472;
      v43[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_2;
      v43[3] = &unk_278688CE8;
      v43[4] = v11;
      v30 = v24;
      v44 = v30;
      v31 = [v29 addCompletionBlock:v43];

      v32 = objc_autoreleasePoolPush();
      v33 = v11;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543618;
        v53 = v35;
        v54 = 2112;
        v55 = v25;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Finished deleting zones for container : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v32);
      dispatch_group_wait(v30, 0xFFFFFFFFFFFFFFFFLL);
    }

    else
    {
      v37 = objc_autoreleasePoolPush();
      v38 = v11;
      v39 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
      {
        v40 = HMFGetLogIdentifier();
        containerID = [v20 containerID];
        *buf = 138543618;
        v53 = v40;
        v54 = 2112;
        v55 = containerID;
        _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] No local zones to delete", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v37);
    }
  }

  else
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v36 = HMFGetLogIdentifier();
      *buf = 138543618;
      v53 = v36;
      v54 = 2112;
      v55 = containerCopy;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Unable to create cloud database for container : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
  }

  v42 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke(id *a1, void *a2)
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = a1[4];
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [a1[5] containerID];
    v9 = [v3 name];
    v12 = 138543874;
    v13 = v7;
    v14 = 2112;
    v15 = v8;
    v16 = 2112;
    v17 = v9;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] Going to delete [%@]", &v12, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  v10 = [a1[5] removePrivateZoneWithID:v3];
  [a1[6] addObject:v10];

  v11 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_196(uint64_t a1, void *a2)
{
  v3 = *(a1 + 32);
  v4 = *(a1 + 40);
  v5 = a2;
  v6 = [v4 localDatabase];
  v8 = [v3 deleteLocalZone:v5 localDatabase:v6 containerID:*(a1 + 48)];

  v7 = v8;
  if (v8)
  {
    [*(a1 + 56) addObject:v8];
    v7 = v8;
  }
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v16 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v12 = 138543618;
    v13 = v10;
    v14 = 2112;
    v15 = v6;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : >> Deleting cloud & local zones finished with error: %@", &v12, 0x16u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 40));

  v11 = *MEMORY[0x277D85DE8];
}

- (void)deleteZonesFromLegacyAndCameraContainers
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v11 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Asked to delete all zones from legacy & camera containers", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  getContainersToCleanUp = [objc_opt_class() getContainersToCleanUp];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __71__HMDHomeManager_ResetConfig__deleteZonesFromLegacyAndCameraContainers__block_invoke;
  v9[3] = &unk_278683BA0;
  v9[4] = selfCopy;
  [getContainersToCleanUp hmf_enumerateWithAutoreleasePoolUsingBlock:v9];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalMetadata
{
  mobileAssetManager = [(HMDHomeManager *)self mobileAssetManager];
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __50__HMDHomeManager_ResetConfig___eraseLocalMetadata__block_invoke;
  v4[3] = &unk_27868A728;
  v4[4] = self;
  [mobileAssetManager purgeAllInstalledAssetsWithCompletion:v4];

  +[HMDHAPMetadata updateLocalMetadataWithBuiltinMetadata];
}

void __50__HMDHomeManager_ResetConfig___eraseLocalMetadata__block_invoke(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Finished purging mobile assets]", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfigurationAndDeleteMetadata:(BOOL)metadata reason:(unint64_t)reason completionQueue:(id)queue completion:(id)completion
{
  v30 = *MEMORY[0x277D85DE8];
  queueCopy = queue;
  completionCopy = completion;
  v11 = objc_autoreleasePoolPush();
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v13;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Resetting local configuration, users and keys for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v11);
  v14 = dispatch_group_create();
  dispatch_group_enter(v14);
  objc_initWeak(buf, self);
  syncManager = [(HMDHomeManager *)self syncManager];
  v25[0] = MEMORY[0x277D85DD0];
  v25[1] = 3221225472;
  v25[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke;
  v25[3] = &unk_278686B48;
  objc_copyWeak(&v27, buf);
  v16 = v14;
  v26 = v16;
  [syncManager pauseAndWaitForCurrentOperationCompletion:v25];

  workQueue = [(HMDHomeManager *)self workQueue];
  v21[0] = MEMORY[0x277D85DD0];
  v21[1] = 3221225472;
  v21[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_188;
  v21[3] = &unk_278683B78;
  objc_copyWeak(v24, buf);
  v24[1] = reason;
  v22 = queueCopy;
  v23 = completionCopy;
  v18 = queueCopy;
  v19 = completionCopy;
  dispatch_group_notify(v16, workQueue, v21);

  objc_destroyWeak(v24);
  objc_destroyWeak(&v27);
  objc_destroyWeak(buf);

  v20 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    v20 = 0u;
    v21 = 0u;
    v18 = 0u;
    v19 = 0u;
    obj = [WeakRetained homes];
    v4 = [obj countByEnumeratingWithState:&v18 objects:v22 count:16];
    if (v4)
    {
      v5 = v4;
      v6 = *v19;
      do
      {
        v7 = 0;
        do
        {
          if (*v19 != v6)
          {
            objc_enumerationMutation(obj);
          }

          v8 = *(*(&v18 + 1) + 8 * v7);
          dispatch_group_enter(*(a1 + 32));
          v9 = [v8 name];
          v10 = MEMORY[0x277D0F818];
          v15[0] = MEMORY[0x277D85DD0];
          v15[1] = 3221225472;
          v15[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_2;
          v15[3] = &unk_278686658;
          v15[4] = v3;
          v16 = v9;
          v17 = *(a1 + 32);
          v11 = v9;
          v12 = [v10 messageWithName:@"kResetConfigRequestKey" messagePayload:0 responseHandler:v15];
          [v3 _removeHome:v8 withMessage:v12 saveToStore:0 notifyUsers:0 shouldRemovePairings:1];

          ++v7;
        }

        while (v5 != v7);
        v5 = [obj countByEnumeratingWithState:&v18 objects:v22 count:16];
      }

      while (v5);
    }

    [v3 setHomeManagerZoneFirstFetch:1];
    dispatch_group_leave(*(a1 + 32));
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_188(uint64_t a1)
{
  v25 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v3 = WeakRetained;
  if (!WeakRetained)
  {
    goto LABEL_14;
  }

  [WeakRetained setPrimaryHomeUUID:0];
  [v3 _updateCurrentHomeIfNecessary];
  v4 = [MEMORY[0x277CFEC78] systemStore];
  v5 = [v4 removeControllerKeyPairWithError:0];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  v8 = v7;
  if (v5)
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v24 = v9;
      v10 = "%{public}@[Reset Config] : Removed controller key";
      v11 = v8;
      v12 = OS_LOG_TYPE_INFO;
LABEL_7:
      _os_log_impl(&dword_229538000, v11, v12, v10, buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543362;
    v24 = v9;
    v10 = "%{public}@[Reset Config] : Failed removing controller key";
    v11 = v8;
    v12 = OS_LOG_TYPE_ERROR;
    goto LABEL_7;
  }

  objc_autoreleasePoolPop(v6);
  [v3 _eraseLocalHomeConfigurationWithReason:*(a1 + 56)];
  v13 = objc_autoreleasePoolPush();
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v24 = v15;
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Completed configuration reset", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v13);
  v16 = [v3 syncManager];
  [v16 cancelOperations];

  v17 = [v3 syncManager];
  [v17 resume];

  v18 = *(a1 + 40);
  if (v18)
  {
    v19 = *(a1 + 32);
    if (v19)
    {
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_189;
      block[3] = &unk_278688B80;
      v22 = v18;
      dispatch_async(v19, block);
    }
  }

LABEL_14:
  v20 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    v13 = 138543874;
    v14 = v10;
    v15 = 2112;
    v16 = v11;
    v17 = 2112;
    v18 = v5;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Removed home %@ - error %@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 48));

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfigurationAfterSignOut
{
  v10 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v8 = 138543362;
    v9 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Erase local data on this device since we signed out of iCloud", &v8, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [HMDPersistentStore resetConfiguration:2];
  [(HMDHomeManager *)selfCopy resetTTSUHH2SettingsMigrationKey];
  +[HMDAuditHH2KeysForBackupOperation resetHH2KeyBackupOperationFromUserDefault];
  [(HMDHomeManager *)selfCopy removeAllHomeKitPairingIdentitiesAfterSignOut];
  [(HMDHomeManager *)selfCopy _eraseLocalHomeConfiguration];
  [(HMDHomeManager *)selfCopy _eraseLocalMetadata];
  [objc_opt_class() relaunchHomedDueToResetConfigurationWithDelay:2.0];
  v7 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfiguration
{
  v32 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v31 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Resetting local configuration and accessory keys for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v27 = 0u;
  v28 = 0u;
  v25 = 0u;
  v26 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v7 = [homes countByEnumeratingWithState:&v25 objects:v29 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v26;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v26 != v9)
        {
          objc_enumerationMutation(homes);
        }

        v11 = *(*(&v25 + 1) + 8 * i);
        name = [v11 name];
        uuid = [(HMDHomeManager *)self uuid];
        v14 = [(HMDHomeManager *)self removeName:name namespace:uuid];

        nameValidator = [(HMDHomeManager *)self nameValidator];
        uuid2 = [v11 uuid];
        v17 = [nameValidator removeNamespace:uuid2];

        uuid3 = [v11 uuid];
        [(HMDHomeManager *)self _removeConfigurationVersionForHome:uuid3];
      }

      v8 = [homes countByEnumeratingWithState:&v25 objects:v29 count:16];
    }

    while (v8);
  }

  [(HMDHomeManager *)self setPrimaryHomeUUID:0];
  [(HMDHomeManager *)self setRecoveryVersion:0];
  [(HMDHomeManager *)self _updateCurrentHomeIfNecessary];
  backingStore = [(HMDHomeManager *)self backingStore];
  lookup = [backingStore lookup];
  [lookup resetObjects];

  [(HMDHomeManager *)self _eraseLocalHomeConfigurationWithReason:1];
  v21 = objc_autoreleasePoolPush();
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
  {
    v23 = HMFGetLogIdentifier();
    *buf = 138543362;
    v31 = v23;
    _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Completed erasing local home configuration", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v21);
  v24 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfigurationWithReason:(unint64_t)reason
{
  v66 = *MEMORY[0x277D85DE8];
  +[HMDHomeManager _eraseAllAccessoryKeysAndIdentifiers];
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  [messageDispatcher reset];

  identityRegistry = [(HMDHomeManager *)self identityRegistry];
  [identityRegistry reset];

  accountRegistry = [(HMDHomeManager *)self accountRegistry];
  [accountRegistry reset];

  [MEMORY[0x277CFEC78] systemStore];
  v52 = v61 = 0;
  [v52 updateCurrentiCloudIdentifier:0 controllerPairingIdentifier:0 error:&v61];
  v51 = v61;
  v7 = MEMORY[0x277CBEB18];
  homes = [(HMDHomeManager *)self homes];
  v9 = [v7 arrayWithCapacity:{objc_msgSend(homes, "count")}];

  v59 = 0u;
  v60 = 0u;
  v57 = 0u;
  v58 = 0u;
  selfCopy = self;
  homes2 = [(HMDHomeManager *)self homes];
  v11 = [homes2 countByEnumeratingWithState:&v57 objects:v65 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v58;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v58 != v13)
        {
          objc_enumerationMutation(homes2);
        }

        v15 = *(*(&v57 + 1) + 8 * i);
        *buf = 0;
        v16 = [MEMORY[0x277D0F7C0] futureWithPromise:buf];
        v55[0] = MEMORY[0x277D85DD0];
        v55[1] = 3221225472;
        v55[2] = __70__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationWithReason___block_invoke;
        v55[3] = &unk_27868A728;
        v56 = *buf;
        [v15 stopThreadNetworkWithCompletion:1 completion:v55];
        [v9 addObject:v16];
        [v15 resetConfiguration];
      }

      v12 = [homes2 countByEnumeratingWithState:&v57 objects:v65 count:16];
    }

    while (v12);
  }

  [(HMDHomeManager *)selfCopy setHomes:MEMORY[0x277CBEBF8]];
  accessoryBrowserInternal = [(HMDHomeManager *)selfCopy accessoryBrowserInternal];
  [accessoryBrowserInternal resetConfiguration];

  v18 = objc_autoreleasePoolPush();
  v19 = selfCopy;
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v21;
    v63 = 2048;
    reasonCopy = reason;
    _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@_eraseLocalHomeConfigurationWithReason: ==== reason is... %lu", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v18);
  [HMDPersistentStore resetConfiguration:reason];
  lastEventStore = [(HMDHomeManager *)v19 lastEventStore];
  [lastEventStore resetEventStore];

  cloudZones = [(HMDHomeManager *)v19 cloudZones];
  [cloudZones removeAllObjects];

  [(HMDHomeManager *)v19 setAppData:0];
  pendingResponsesForAccessoryFinder = [(HMDHomeManager *)v19 pendingResponsesForAccessoryFinder];
  [pendingResponsesForAccessoryFinder removeAllObjects];

  associatedRemotePeers = [(HMDHomeManager *)v19 associatedRemotePeers];
  [associatedRemotePeers removeAllObjects];

  unassociatedRemotePeers = [(HMDHomeManager *)v19 unassociatedRemotePeers];
  [unassociatedRemotePeers removeAllObjects];

  pendingRemoteSessions = [(HMDHomeManager *)v19 pendingRemoteSessions];
  [pendingRemoteSessions removeAllObjects];

  pendingResidentSetupSessions = [(HMDHomeManager *)v19 pendingResidentSetupSessions];
  [pendingResidentSetupSessions removeAllObjects];

  uuidsOfRemovedHomes = [(HMDHomeManager *)v19 uuidsOfRemovedHomes];
  [uuidsOfRemovedHomes removeAllObjects];

  incomingInvitations = [(HMDHomeManager *)v19 incomingInvitations];
  [incomingInvitations removeAllObjects];

  [(HMDHomeManager *)v19 updateHomeKitInUsePreferences];
  v31 = +[HMDBulletinBoard sharedBulletinBoard];
  [v31 removeAllBulletins];
  [v31 refreshHomeBadgeNumber];
  [(HMDHomeManager *)v19 _eraseLocalMetadata];
  [(HMDHomeManager *)v19 _checkForRemotePeers];
  [(HMDHomeManager *)v19 assistantSyncDataChanged:@"kResetConfigRequestKey"];
  CFPreferencesSetAppValue(@"HMDAssistantLastHashingKey", 0, *MEMORY[0x277CD0030]);
  uuid = [(HMDHomeManager *)v19 uuid];
  [(HMDHomeManager *)v19 updateGenerationCounterWithReason:@"Erase local home configuration" sourceUUID:uuid shouldNotifyClients:1];

  defaultCenter = [MEMORY[0x277CCAB98] defaultCenter];
  [defaultCenter postNotificationName:@"HMDHomeManagerLocalHomeDataRemovedNotification" object:0];

  v53 = 0;
  v54 = 0;
  v34 = objc_autoreleasePoolPush();
  v35 = v19;
  v36 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    v37 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v37;
    _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_DEFAULT, "%{public}@Waiting for thread network shutdown to complete", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v34);
  v38 = [MEMORY[0x277D0F7C0] allSettled:v9];
  v39 = [v38 waitForResult:&v54 orError:&v53 withTimeout:4.0];

  v40 = objc_autoreleasePoolPush();
  v41 = v35;
  v42 = HMFGetOSLogHandle();
  v43 = v42;
  if (v39)
  {
    if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
    {
      v44 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v44;
      v45 = "%{public}@Thread network shutdown completed - continuing with reset config";
      v46 = v43;
      v47 = OS_LOG_TYPE_DEFAULT;
LABEL_17:
      _os_log_impl(&dword_229538000, v46, v47, v45, buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v42, OS_LOG_TYPE_ERROR))
  {
    v44 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v44;
    v45 = "%{public}@Gave up waiting for thread network shutdown";
    v46 = v43;
    v47 = OS_LOG_TYPE_ERROR;
    goto LABEL_17;
  }

  objc_autoreleasePoolPop(v40);
  v48 = *MEMORY[0x277D85DE8];
}

- (void)_handleResetConfiguration:(id)configuration
{
  configurationCopy = configuration;
  [HMDResetConfigPostCleanup writePostCleanupRecordWithReason:1 steps:-1];
  +[HMDHH2FrameworkSwitch removeHH2EnablementPreferenceKey];
  v5 = [configurationCopy BOOLForKey:@"kResetConfigMetadataKey"];
  v6 = [objc_alloc(MEMORY[0x277D0F770]) initWithName:@"Reset Config" parent:0 options:1];
  [v6 begin];
  v7 = v6;
  [(HMDHomeManager *)self resetHomeConfigForHH2:v5 message:configurationCopy];
  __HMFActivityScopeLeave();
}

+ (id)getContainersToCleanUp
{
  v7[3] = *MEMORY[0x277D85DE8];
  v2 = MEMORY[0x277CBEB98];
  v7[0] = @"com.apple.homekit";
  v7[1] = @"com.apple.homekit.camera.clips";
  v7[2] = @"com.apple.willow.config";
  v3 = [MEMORY[0x277CBEA60] arrayWithObjects:v7 count:3];
  v4 = [v2 setWithArray:v3];

  v5 = *MEMORY[0x277D85DE8];

  return v4;
}

+ (void)relaunchHomedDueToResetConfigurationWithDelay:(double)delay
{
  v14 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v13 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Scheduling homed relaunch due to reset configuration. (Either user logged out or user issued reset-config SPI", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = dispatch_time(0, delay);
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __77__HMDHomeManager_ResetConfig__relaunchHomedDueToResetConfigurationWithDelay___block_invoke;
  block[3] = &__block_descriptor_40_e5_v8__0l;
  block[4] = selfCopy;
  dispatch_after(v9, MEMORY[0x277D85CD0], block);
  v10 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager_ResetConfig__relaunchHomedDueToResetConfigurationWithDelay___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = +[HMDLaunchHandler sharedHandler];
  v3 = objc_alloc(MEMORY[0x277CCAD78]);
  v4 = [v3 initWithUUIDString:*MEMORY[0x277CD23C8]];
  [v2 registerRelaunchClientWithUUID:v4];

  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 32);
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Going to relaunch homed due to resetConfiguration", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  _Exit(0);
}

+ (void)_eraseAllAccessoryKeysAndIdentifiers
{
  v32 = *MEMORY[0x277D85DE8];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v27 = 0;
  v4 = [systemStore removeAllAccessoryKeys:&v27];
  v5 = v27;
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  v9 = v8;
  if (v4)
  {
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v10;
    v11 = "%{public}@[Reset Config] : Removed all accessory keys from controller";
    v12 = v9;
    v13 = OS_LOG_TYPE_INFO;
    v14 = 12;
  }

  else
  {
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    *buf = 138543618;
    v29 = v10;
    v30 = 2112;
    v31 = v5;
    v11 = "%{public}@[Reset Config] : Could not remove all accessory keys from controller (%@)";
    v12 = v9;
    v13 = OS_LOG_TYPE_ERROR;
    v14 = 22;
  }

  _os_log_impl(&dword_229538000, v12, v13, v11, buf, v14);

LABEL_7:
  objc_autoreleasePoolPop(v6);
  v26 = v5;
  v15 = [systemStore deleteAllPeripheralIdentifiers:&v26];
  v16 = v26;

  v17 = objc_autoreleasePoolPush();
  v18 = selfCopy;
  v19 = HMFGetOSLogHandle();
  v20 = os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT);
  if (v15)
  {
    if (v20)
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v29 = v21;
      v22 = "%{public}@[Reset Config] : Removed all Bluetooth peripheral identifiers.";
      v23 = v19;
      v24 = 12;
LABEL_12:
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_DEFAULT, v22, buf, v24);
    }
  }

  else if (v20)
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v29 = v21;
    v30 = 2112;
    v31 = v16;
    v22 = "%{public}@[Reset Config] : Could not remove all Bluetooth peripheral identifiers (%@).";
    v23 = v19;
    v24 = 22;
    goto LABEL_12;
  }

  objc_autoreleasePoolPop(v17);
  v25 = *MEMORY[0x277D85DE8];
}

- (void)_sendFragmentedMessage:(id)message messageIndex:(unint64_t)index messageIdentity:(id)identity userID:(id)d destination:(id)destination completionHandler:(id)handler
{
  messageCopy = message;
  identityCopy = identity;
  dCopy = d;
  destinationCopy = destination;
  handlerCopy = handler;
  objc_initWeak(&location, self);
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  v20 = [messageCopy objectAtIndexedSubscript:index];
  uuid = [(HMDHomeManager *)self uuid];
  workQueue = [(HMDHomeManager *)self workQueue];
  v28[0] = MEMORY[0x277D85DD0];
  v28[1] = 3221225472;
  v28[2] = __124__HMDHomeManager_FragmentMessage___sendFragmentedMessage_messageIndex_messageIdentity_userID_destination_completionHandler___block_invoke;
  v28[3] = &unk_278683D88;
  objc_copyWeak(v34, &location);
  v34[1] = index;
  v23 = messageCopy;
  v29 = v23;
  v24 = identityCopy;
  v30 = v24;
  v25 = handlerCopy;
  v33 = v25;
  v26 = dCopy;
  v31 = v26;
  v27 = destinationCopy;
  v32 = v27;
  [messageDispatcher sendSecureMessage:v20 target:uuid userID:v26 destination:v27 responseQueue:workQueue responseHandler:v28];

  objc_destroyWeak(v34);
  objc_destroyWeak(&location);
}

void __124__HMDHomeManager_FragmentMessage___sendFragmentedMessage_messageIndex_messageIdentity_userID_destination_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v42 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (WeakRetained)
  {
    v8 = *(a1 + 80);
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [*(a1 + 32) count];
      v13 = *(a1 + 40);
      *buf = 138544130;
      v35 = v11;
      v36 = 2048;
      v37 = (v8 + 1);
      v38 = 2048;
      v39 = v12;
      v40 = 2112;
      v41 = v13;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Sent packet %tu/%tu with identity %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v9);
    if (v5)
    {
      v31 = v6;
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        v17 = [v5 localizedDescription];
        v18 = *(a1 + 48);
        *buf = 138543874;
        v35 = v16;
        v36 = 2112;
        v37 = v17;
        v38 = 2112;
        v39 = v18;
        _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Received %@ from user %@, cancel message", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      v19 = *(a1 + 40);
      v32[0] = @"kHomeDataFragmentIdentityKey";
      v32[1] = @"kHomeDataFragmentNumberKey";
      v33[0] = v19;
      v33[1] = &unk_283E74C90;
      v20 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v33 forKeys:v32 count:2];
      v21 = [MEMORY[0x277D0F818] messageWithName:@"kHomeDataFragmentedSyncRequestKey" messagePayload:v20];
      v22 = [WeakRetained messageDispatcher];
      v23 = [WeakRetained uuid];
      v24 = *(a1 + 48);
      v25 = *(a1 + 56);
      v26 = [WeakRetained workQueue];
      [v22 sendSecureMessage:v21 target:v23 userID:v24 destination:v25 responseQueue:v26 responseHandler:&__block_literal_global_239331];

      v27 = *(a1 + 64);
      v6 = v31;
      if (v27)
      {
        (*(v27 + 16))(v27, v5, v31);
      }
    }

    else
    {
      v28 = *(a1 + 80);
      if (v28 == [*(a1 + 32) count] - 1 || objc_msgSend(v6, "hmf_BOOLForKey:", @"kDataSyncResponseCancelKey"))
      {
        v29 = *(a1 + 64);
        if (v29)
        {
          (*(v29 + 16))(v29, 0, v6);
        }
      }

      else
      {
        [WeakRetained _sendFragmentedMessage:*(a1 + 32) messageIndex:*(a1 + 80) + 1 messageIdentity:*(a1 + 40) userID:*(a1 + 48) destination:*(a1 + 56) completionHandler:*(a1 + 64)];
      }
    }
  }

  v30 = *MEMORY[0x277D85DE8];
}

- (void)_fragmentationStream:(id)stream didReceiveData:(id)data transactionIdentifier:(unsigned __int16)identifier error:(id)error
{
  v55 = *MEMORY[0x277D85DE8];
  streamCopy = stream;
  dataCopy = data;
  errorCopy = error;
  if (dataCopy)
  {
    v44 = 0u;
    v45 = 0u;
    v42 = 0u;
    v43 = 0u;
    pendingFragmentationStream = [(HMDHomeManager *)self pendingFragmentationStream];
    allKeys = [pendingFragmentationStream allKeys];

    v14 = [allKeys countByEnumeratingWithState:&v42 objects:v54 count:16];
    if (v14)
    {
      v40 = errorCopy;
      v41 = dataCopy;
      v15 = 0;
      v16 = *v43;
LABEL_4:
      v17 = 0;
      v18 = v15;
      while (1)
      {
        if (*v43 != v16)
        {
          objc_enumerationMutation(allKeys);
        }

        v19 = *(*(&v42 + 1) + 8 * v17);
        pendingFragmentationStream2 = [(HMDHomeManager *)self pendingFragmentationStream];
        v15 = [pendingFragmentationStream2 objectForKeyedSubscript:v19];

        fragmentationStream = [v15 fragmentationStream];

        if (fragmentationStream == streamCopy)
        {
          break;
        }

        v17 = v17 + 1;
        v18 = v15;
        if (v14 == v17)
        {
          v14 = [allKeys countByEnumeratingWithState:&v42 objects:v54 count:16];
          if (v14)
          {
            goto LABEL_4;
          }

          errorCopy = v40;
          dataCopy = v41;
          goto LABEL_24;
        }
      }

      v14 = v19;

      if (v14)
      {
        v22 = v15 == 0;
      }

      else
      {
        v22 = 1;
      }

      if (v22)
      {
        errorCopy = v40;
        dataCopy = v41;
        goto LABEL_25;
      }

      v23 = MEMORY[0x277D0F818];
      lastMessage = [v15 lastMessage];
      v25 = [v23 messageWithMessage:lastMessage messagePayload:0];
      allKeys = [v25 mutableCopy];

      lastMessage2 = [v15 lastMessage];
      destination = [lastMessage2 destination];
      [allKeys setDestination:destination];

      lastMessage3 = [v15 lastMessage];
      remoteSenderContext = [lastMessage3 remoteSenderContext];
      [allKeys setRemoteSenderContext:remoteSenderContext];

      [v15 close];
      pendingFragmentationStream3 = [(HMDHomeManager *)self pendingFragmentationStream];
      [pendingFragmentationStream3 removeObjectForKey:v14];

      lastMessage4 = [v15 lastMessage];
      v32 = [lastMessage4 stringForKey:@"kDataFragmentMessageNameKey"];

      v33 = objc_autoreleasePoolPush();
      v34 = HMFGetOSLogHandle();
      v35 = os_log_type_enabled(v34, OS_LOG_TYPE_INFO);
      errorCopy = v40;
      if (v35)
      {
        v36 = HMFGetLogIdentifier();
        *buf = 138543618;
        v51 = v36;
        v52 = 2112;
        v53 = v32;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_INFO, "%{public}@Full message received with name %@, calling the handle method.", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v33);
      dataCopy = v41;
      if ([v32 isEqualToString:@"kMetadataDataSyncRequestKey"])
      {
        v48 = @"kHAPMetadataDataKey";
        v49 = v41;
        v37 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v49 forKeys:&v48 count:1];
        [allKeys setMessagePayload:v37];

        [(HMDHomeManager *)self _handleMetadataSync:allKeys];
      }

      else
      {
        v46 = @"kHomeDataKey";
        v47 = v41;
        v38 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v47 forKeys:&v46 count:1];
        [allKeys setMessagePayload:v38];

        [(HMDHomeManager *)self _handleHomeDataSync:allKeys];
      }
    }

    else
    {
      v15 = 0;
    }

LABEL_24:

LABEL_25:
  }

  v39 = *MEMORY[0x277D85DE8];
}

- (void)_fragmentationStream:(id)stream didCloseWithError:(id)error
{
  v23 = *MEMORY[0x277D85DE8];
  streamCopy = stream;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  pendingFragmentationStream = [(HMDHomeManager *)self pendingFragmentationStream];
  allKeys = [pendingFragmentationStream allKeys];

  v8 = [allKeys countByEnumeratingWithState:&v18 objects:v22 count:16];
  v9 = 0;
  if (v8)
  {
    v10 = *v19;
LABEL_3:
    v11 = 0;
    v12 = v9;
    while (1)
    {
      if (*v19 != v10)
      {
        objc_enumerationMutation(allKeys);
      }

      v13 = *(*(&v18 + 1) + 8 * v11);
      pendingFragmentationStream2 = [(HMDHomeManager *)self pendingFragmentationStream];
      v9 = [pendingFragmentationStream2 objectForKeyedSubscript:v13];

      fragmentationStream = [v9 fragmentationStream];

      if (fragmentationStream == streamCopy)
      {
        break;
      }

      v11 = v11 + 1;
      v12 = v9;
      if (v8 == v11)
      {
        v8 = [allKeys countByEnumeratingWithState:&v18 objects:v22 count:16];
        if (v8)
        {
          goto LABEL_3;
        }

        goto LABEL_15;
      }
    }

    v8 = v13;

    if (v8)
    {
      v16 = v9 == 0;
    }

    else
    {
      v16 = 1;
    }

    if (!v16)
    {
      [v9 close];
      allKeys = [(HMDHomeManager *)self pendingFragmentationStream];
      [allKeys removeObjectForKey:v8];
      goto LABEL_15;
    }
  }

  else
  {
LABEL_15:
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)sendFragmentedMessageForData:(id)data objectUUID:(id)d withMessageName:(id)name toUser:(id)user destination:(id)destination completionHandler:(id)handler
{
  v55 = *MEMORY[0x277D85DE8];
  dataCopy = data;
  dCopy = d;
  nameCopy = name;
  userCopy = user;
  destinationCopy = destination;
  handlerCopy = handler;
  uUID = [MEMORY[0x277CCAD78] UUID];
  uUIDString = [uUID UUIDString];

  v19 = [MEMORY[0x277CFEB68] fragmentationPacketsForData:dataCopy maxLength:maximumDataSyncFragmentSize transactionIdentifier:{-[HMDHomeManager _nextTransactionIdentifier](self, "_nextTransactionIdentifier")}];
  if (v19)
  {
    v38 = handlerCopy;
    v39 = destinationCopy;
    v40 = userCopy;
    v41 = dataCopy;
    array = [MEMORY[0x277CBEB18] array];
    v46 = 0u;
    v47 = 0u;
    v48 = 0u;
    v49 = 0u;
    v37 = v19;
    v20 = v19;
    v21 = [v20 countByEnumeratingWithState:&v46 objects:v52 count:16];
    if (v21)
    {
      v22 = v21;
      v23 = *v47;
      v24 = 1;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v47 != v23)
          {
            objc_enumerationMutation(v20);
          }

          v26 = *(*(&v46 + 1) + 8 * i);
          v50[0] = @"kHomeUUID";
          v50[1] = @"kHomeDataFragmentIdentityKey";
          v51[0] = dCopy;
          v51[1] = uUIDString;
          v50[2] = @"kHomeDataFragmentKey";
          serialize = [v26 serialize];
          v51[2] = serialize;
          v50[3] = @"kHomeDataFragmentNumberKey";
          v28 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v24];
          v51[3] = v28;
          v50[4] = @"kHomeDataFragmentTotalCountKey";
          v29 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v20, "count")}];
          v50[5] = @"kDataFragmentMessageNameKey";
          v51[4] = v29;
          v51[5] = nameCopy;
          v30 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v51 forKeys:v50 count:6];

          v31 = [MEMORY[0x277D0F848] messageWithName:@"kHomeDataFragmentedSyncRequestKey" messagePayload:v30];
          [v31 setRemoteRestriction:17];
          [array addObject:v31];
          ++v24;
        }

        v22 = [v20 countByEnumeratingWithState:&v46 objects:v52 count:16];
      }

      while (v22);
    }

    v32 = array;
    destinationCopy = v39;
    userCopy = v40;
    handlerCopy = v38;
    [(HMDHomeManager *)self _sendFragmentedMessage:array messageIndex:0 messageIdentity:uUIDString userID:v40 destination:v39 completionHandler:v38];
    dataCopy = v41;
    v19 = v37;
    goto LABEL_14;
  }

  v33 = objc_autoreleasePoolPush();
  v34 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
  {
    v35 = HMFGetLogIdentifier();
    *buf = 138543362;
    v54 = v35;
    _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_ERROR, "%{public}@Failed to fragment data sync, aborting", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v33);
  if (handlerCopy)
  {
    v32 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    handlerCopy[2](handlerCopy, v32, 0);
LABEL_14:
  }

  v36 = *MEMORY[0x277D85DE8];
}

- (void)_maybeConfigureDuplicateUserModelChecker
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __85__HMDHomeManager_HH2DuplicateUserModelsFix___maybeConfigureDuplicateUserModelChecker__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)_scheduleNextCheck
{
  v38 = *MEMORY[0x277D85DE8];
  if (self)
  {
    workQueue = [self workQueue];
    dispatch_assert_queue_V2(workQueue);

    idsServerBag = [self idsServerBag];
    hh2SuppressDuplicateUserModelBulletins = [idsServerBag hh2SuppressDuplicateUserModelBulletins];

    if (hh2SuppressDuplicateUserModelBulletins)
    {
      v5 = objc_autoreleasePoolPush();
      selfCopy = self;
      v7 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
      {
        v8 = HMFGetLogIdentifier();
        *buf = 138543362;
        v33 = v8;
        _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Duplicate user model checker is disabled via server flags", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v5);
    }

    else
    {
      v9 = [MEMORY[0x277CBEAA8] now];
      currentCalendar = [MEMORY[0x277CBEA80] currentCalendar];
      v11 = [currentCalendar components:0x200000 fromDate:v9];
      if (isInternalBuild())
      {
        mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
        v13 = [mEMORY[0x277D0F8D0] preferenceForKey:@"hh2DuplicateUserModelsFixHour"];
        numberValue = [v13 numberValue];

        if (numberValue)
        {
          integerValue = [numberValue integerValue];
        }

        else
        {
          integerValue = 14;
        }

        v17 = [mEMORY[0x277D0F8D0] preferenceForKey:@"hh2DuplicateUserModelsFixMinute"];
        numberValue2 = [v17 numberValue];

        if (numberValue2)
        {
          integerValue2 = [numberValue2 integerValue];
        }

        else
        {
          integerValue2 = 0;
        }
      }

      else
      {
        integerValue2 = 0;
        integerValue = 14;
      }

      [v11 setHour:integerValue];
      [v11 setMinute:integerValue2];
      v19 = [currentCalendar nextDateAfterDate:v9 matchingComponents:v11 options:1024];
      [v19 timeIntervalSinceDate:v9];
      v21 = v20;
      v22 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v24 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
      {
        v25 = HMFGetLogIdentifier();
        hmf_localTimeDescription = [v19 hmf_localTimeDescription];
        *buf = 138543874;
        v33 = v25;
        v34 = 2112;
        v35 = hmf_localTimeDescription;
        v36 = 2048;
        v37 = v21;
        _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Setting duplicate user model checker timer for %@ (%llu seconds from now)", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v22);
      objc_initWeak(buf, selfCopy2);
      v27 = dispatch_time(0, (v21 * 1000000000.0));
      workQueue2 = [selfCopy2 workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __63__HMDHomeManager_HH2DuplicateUserModelsFix___scheduleNextCheck__block_invoke;
      block[3] = &unk_278686B80;
      objc_copyWeak(&v31, buf);
      dispatch_after(v27, workQueue2, block);

      objc_destroyWeak(&v31);
      objc_destroyWeak(buf);
    }
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __63__HMDHomeManager_HH2DuplicateUserModelsFix___scheduleNextCheck__block_invoke(uint64_t a1)
{
  v39 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v31 = WeakRetained;
    v2 = [WeakRetained workQueue];
    dispatch_assert_queue_V2(v2);

    v3 = [v31 idsServerBag];
    v4 = [v3 hh2SuppressDuplicateUserModelBulletins];

    if (v4)
    {
      v5 = objc_autoreleasePoolPush();
      v6 = v31;
      v7 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
      {
        v8 = HMFGetLogIdentifier();
        *buf = 138543362;
        v36 = v8;
        v9 = "%{public}@Duplicate user model checker is disabled via server flags";
LABEL_14:
        _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, v9, buf, 0xCu);
      }
    }

    else
    {
      if (isThisDeviceDesignatedFMFDevice())
      {
        v10 = [v31 backingStore];
        v11 = [v10 context];
        v12 = [v11 managedObjectContext];

        v13 = objc_autoreleasePoolPush();
        v14 = v31;
        v15 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
        {
          v16 = HMFGetLogIdentifier();
          *buf = 138543362;
          v36 = v16;
          _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Running duplicate user model checker", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v13);
        v17 = [objc_opt_class() _findDuplicateUserModelsWithContext:v12];
        v18 = [v17 count];
        v19 = objc_autoreleasePoolPush();
        v20 = v14;
        v21 = HMFGetOSLogHandle();
        v22 = v21;
        if (v18)
        {
          if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
          {
            v23 = HMFGetLogIdentifier();
            *buf = 138543618;
            v36 = v23;
            v37 = 2112;
            v38 = v17;
            _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, "%{public}@Duplicate user models found: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v19);
          v24 = +[HMDBulletinBoard sharedBulletinBoard];
          v25 = +[HMDHomeKitVersion version10_3];
          v32[0] = MEMORY[0x277D85DD0];
          v32[1] = 3221225472;
          v32[2] = __58__HMDHomeManager_HH2DuplicateUserModelsFix___performCheck__block_invoke;
          v32[3] = &unk_278685710;
          v32[4] = v20;
          v33 = v25;
          v34 = v24;
          v26 = v24;
          v27 = v25;
          [v17 hmf_enumerateWithAutoreleasePoolUsingBlock:v32];

          [(HMDHomeManager *)v20 _scheduleNextCheck];
        }

        else
        {
          if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
          {
            v30 = HMFGetLogIdentifier();
            *buf = 138543362;
            v36 = v30;
            _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@No duplicate user models found", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v19);
        }

        goto LABEL_16;
      }

      v5 = objc_autoreleasePoolPush();
      v28 = v31;
      v7 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
      {
        v8 = HMFGetLogIdentifier();
        *buf = 138543362;
        v36 = v8;
        v9 = "%{public}@Skipping duplicate user model checker as this device is not currently the FMF device";
        goto LABEL_14;
      }
    }

    objc_autoreleasePoolPop(v5);
LABEL_16:
    WeakRetained = v31;
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager_HH2DuplicateUserModelsFix___performCheck__block_invoke(uint64_t a1, void *a2)
{
  v44 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = *(a1 + 32);
  v5 = [v3 homeModelID];
  v6 = [v4 _homeWithUUID:v5];

  if (v6)
  {
    v7 = [v3 userMergeID];
    v8 = [v6 userWithMergeID:v7];

    if (!v8)
    {
      v19 = objc_autoreleasePoolPush();
      v20 = *(a1 + 32);
      v21 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        v22 = HMFGetLogIdentifier();
        v23 = [v3 userMergeID];
        *buf = 138543618;
        v37 = v22;
        v38 = 2112;
        v39 = v23;
        _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@Couldn't find user with mergeID %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v19);
      goto LABEL_20;
    }

    v9 = [v6 residentDeviceManager];
    v10 = [v9 primaryResidentDevice];

    if (v10)
    {
      v11 = [v10 device];
      v12 = [v11 version];
      v13 = [v12 isAtLeastVersion:*(a1 + 40)];

      if (v13)
      {
        [*(a1 + 48) insertHH2DuplicateUserModelBulletinForHome:v6 user:v8];
LABEL_19:

LABEL_20:
        goto LABEL_21;
      }

      v24 = objc_autoreleasePoolPush();
      v28 = *(a1 + 32);
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        v31 = [v10 device];
        [v31 version];
        v32 = v35 = v24;
        v33 = *(a1 + 40);
        *buf = 138544130;
        v37 = v30;
        v38 = 2112;
        v39 = v6;
        v40 = 2112;
        v41 = v32;
        v42 = 2112;
        v43 = v33;
        _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_ERROR, "%{public}@Primary resident for home %@ is too old to fix duplicate user models: %@ < %@", buf, 0x2Au);

        v24 = v35;
      }
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      v25 = *(a1 + 32);
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        v27 = HMFGetLogIdentifier();
        *buf = 138543618;
        v37 = v27;
        v38 = 2112;
        v39 = v6;
        _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_ERROR, "%{public}@Couldn't find primary resident for home %@", buf, 0x16u);
      }
    }

    objc_autoreleasePoolPop(v24);
    goto LABEL_19;
  }

  v14 = objc_autoreleasePoolPush();
  v15 = *(a1 + 32);
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
  {
    v17 = HMFGetLogIdentifier();
    v18 = [v3 homeModelID];
    *buf = 138543618;
    v37 = v17;
    v38 = 2112;
    v39 = v18;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Couldn't find home with uuid %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
LABEL_21:

  v34 = *MEMORY[0x277D85DE8];
}

+ (id)_findDuplicateUserModelsWithContext:(id)context
{
  contextCopy = context;
  array = [MEMORY[0x277CBEB18] array];
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke;
  v10[3] = &unk_278685DF8;
  v12 = array;
  selfCopy = self;
  v11 = contextCopy;
  v6 = array;
  v7 = contextCopy;
  [v7 performBlockAndWait:v10];
  v8 = [v6 copy];

  return v8;
}

void __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke(uint64_t a1)
{
  v53[3] = *MEMORY[0x277D85DE8];
  v1 = *(a1 + 48);
  v2 = *(a1 + 32);
  v3 = objc_opt_self();
  v4 = +[_MKFUser fetchRequest];
  v5 = [MEMORY[0x277CCAC30] predicateWithFormat:@"(%K.%K == YES) AND (%K != %@)", @"home", @"owned", @"privilege", &unk_283E74E40];
  [v4 setPredicate:v5];

  v53[0] = @"accountIdentifier";
  v53[1] = @"idsMergeIdentifier";
  v53[2] = @"privilege";
  v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v53 count:3];
  [v4 setPropertiesToFetch:v6];

  v52 = @"home";
  v7 = [MEMORY[0x277CBEA60] arrayWithObjects:&v52 count:1];
  [v4 setRelationshipKeyPathsForPrefetching:v7];

  [v4 setFetchBatchSize:10];
  v46 = 0;
  v8 = [v2 executeFetchRequest:v4 error:&v46];
  v9 = v46;
  v10 = v9;
  if (v8)
  {

    v11 = [MEMORY[0x277CCAB00] strongToStrongObjectsMapTable];
    v44[0] = MEMORY[0x277D85DD0];
    v44[1] = 3221225472;
    v44[2] = __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_2;
    v44[3] = &unk_278685738;
    v12 = v11;
    v45 = v12;
    v30 = v8;
    [v8 hmf_enumerateWithAutoreleasePoolUsingBlock:v44];
    v42 = 0u;
    v43 = 0u;
    v40 = 0u;
    v41 = 0u;
    v33 = v12;
    obj = [v12 keyEnumerator];
    v13 = [obj countByEnumeratingWithState:&v40 objects:v47 count:16];
    if (v13)
    {
      v14 = v13;
      v15 = *v41;
      do
      {
        v16 = 0;
        do
        {
          if (*v41 != v15)
          {
            objc_enumerationMutation(obj);
          }

          v17 = *(*(&v40 + 1) + 8 * v16);
          v18 = objc_autoreleasePoolPush();
          v19 = [v33 objectForKey:v17];
          v20 = [MEMORY[0x277CBEB58] setWithCapacity:{objc_msgSend(v19, "count")}];
          v21 = [MEMORY[0x277CBEB38] dictionary];
          v36[0] = MEMORY[0x277D85DD0];
          v36[1] = 3221225472;
          v36[2] = __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_3;
          v36[3] = &unk_278685760;
          v22 = *(a1 + 48);
          v38 = v20;
          v39 = v22;
          v37 = v21;
          v23 = v20;
          v24 = v21;
          [v19 hmf_enumerateWithAutoreleasePoolUsingBlock:v36];
          v34[0] = MEMORY[0x277D85DD0];
          v34[1] = 3221225472;
          v34[2] = __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_57;
          v34[3] = &unk_278685788;
          v34[4] = v17;
          v35 = *(a1 + 40);
          [v24 enumerateKeysAndObjectsUsingBlock:v34];

          objc_autoreleasePoolPop(v18);
          ++v16;
        }

        while (v14 != v16);
        v14 = [obj countByEnumeratingWithState:&v40 objects:v47 count:16];
      }

      while (v14);
    }

    v8 = v30;
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = v3;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543618;
      v49 = v28;
      v50 = 2112;
      v51 = v10;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_ERROR, "%{public}@Failed to fetch shared users: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  v6 = [v3 home];
  v4 = [*(a1 + 32) objectForKey:?];
  if (v4)
  {
    v5 = v4;
    [v4 addObject:v3];
  }

  else
  {
    v5 = [MEMORY[0x277CBEB18] arrayWithObject:v3];

    [*(a1 + 32) setObject:v5 forKey:v6];
  }
}

void __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_3(id *a1, void *a2)
{
  v34 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = a1[6];
  v5 = v3;
  v6 = objc_opt_self();
  v7 = [v5 idsMergeIdentifier];
  if (v7)
  {
    v8 = v7;
    goto LABEL_17;
  }

  v9 = objc_autoreleasePoolPush();
  v10 = v6;
  v11 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
  {
    v12 = HMFGetLogIdentifier();
    v30 = 138543618;
    v31 = v12;
    v32 = 2112;
    v33 = v5;
    _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_ERROR, "%{public}@User has no idsMergeIdentifier: %@", &v30, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  v13 = [v5 accountIdentifier];
  v14 = v13;
  if (v13)
  {
    v15 = [v13 senderCorrelationIdentifier];
    v16 = objc_autoreleasePoolPush();
    v17 = v10;
    v18 = HMFGetOSLogHandle();
    v19 = v18;
    if (v15)
    {
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        v30 = 138543618;
        v31 = v20;
        v32 = 2112;
        v33 = v5;
        _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Using accountIdentifier as idsMergeIdentifier for user: %@", &v30, 0x16u);
      }

      objc_autoreleasePoolPop(v16);
      v8 = v15;
      goto LABEL_16;
    }

    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      v30 = 138543618;
      v31 = v21;
      v32 = 2112;
      v33 = v5;
      v22 = "%{public}@User accountIdentifier doesn't contain a mergeID: %@";
      goto LABEL_14;
    }
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = v10;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      v30 = 138543618;
      v31 = v21;
      v32 = 2112;
      v33 = v5;
      v22 = "%{public}@User has no accountIdentifier: %@";
LABEL_14:
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_ERROR, v22, &v30, 0x16u);
    }
  }

  objc_autoreleasePoolPop(v16);
  v8 = 0;
LABEL_16:

LABEL_17:
  if (v8)
  {
    v23 = [a1[4] objectForKeyedSubscript:v8];

    if (!v23)
    {
      if ([a1[5] containsObject:v8])
      {
        [a1[4] setObject:v5 forKeyedSubscript:v8];
      }

      else
      {
        [a1[5] addObject:v8];
      }
    }
  }

  else
  {
    v24 = objc_autoreleasePoolPush();
    v25 = a1[6];
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEBUG))
    {
      v27 = HMFGetLogIdentifier();
      v28 = [v5 debugDescription];
      v30 = 138543618;
      v31 = v27;
      v32 = 2112;
      v33 = v28;
      _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_DEBUG, "%{public}@%@", &v30, 0x16u);
    }

    objc_autoreleasePoolPop(v24);
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __81__HMDHomeManager_HH2DuplicateUserModelsFix___findDuplicateUserModelsWithContext___block_invoke_57(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [HMDHH2DuplicateUserModelTuple alloc];
  v5 = [*(a1 + 32) modelID];
  v6 = [(HMDHH2DuplicateUserModelTuple *)v4 initWithHomeModelID:v5 userMergeID:v3];

  [*(a1 + 40) addObject:v6];
}

- (void)memoryMonitor:(id)monitor didReceiveMemoryEvent:(int64_t)event
{
  v20 = *MEMORY[0x277D85DE8];
  monitorCopy = monitor;
  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
  {
    v10 = HMFGetLogIdentifier();
    *v19 = 138543362;
    *&v19[4] = v10;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_FAULT, "%{public}@Received process memory event", v19, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  *v19 = 0;
  [(HMDHomeManager *)selfCopy dataSyncInProgressWithState:v19 withMessage:0];
  logEventSubmitter = [(HMDHomeManager *)selfCopy logEventSubmitter];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = logEventSubmitter;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  [v13 handleMemoryEvent:event];
  v14 = [HMDProcessMemoryPressureNotificationLogEvent alloc];
  v15 = [(HMDProcessMemoryPressureNotificationLogEvent *)v14 initWithProcessMemoryEvent:event dataSyncState:*v19];
  logEventSubmitter2 = [(HMDHomeManager *)selfCopy logEventSubmitter];
  [logEventSubmitter2 submitLogEvent:v15];

  memoryTracker = [(HMDHomeManager *)selfCopy memoryTracker];
  [memoryTracker trackMemoryUsageWithReason:2];

  v18 = *MEMORY[0x277D85DE8];
}

- (BOOL)isHH1EOLForResidentDeviceRunningSoftwareVersion:(id)version
{
  versionCopy = version;
  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  hh1EOLMinimumResidentVersion = [idsServerBag hh1EOLMinimumResidentVersion];

  if (hh1EOLMinimumResidentVersion)
  {
    idsServerBag2 = [(HMDHomeManager *)self idsServerBag];
    hh1EOLMinimumResidentVersion2 = [idsServerBag2 hh1EOLMinimumResidentVersion];
    v9 = [versionCopy isAtLeastVersion:hh1EOLMinimumResidentVersion2];
  }

  else
  {
    v9 = 0;
  }

  return v9;
}

- (BOOL)isHH1EOLEnabled
{
  v31 = *MEMORY[0x277D85DE8];
  if (!_os_feature_enabled_impl())
  {
    goto LABEL_15;
  }

  userDefaults = [(HMDHomeManager *)self userDefaults];
  v4 = [userDefaults BOOLForKey:@"HH1EOLEnabled"];

  if (v4)
  {
LABEL_8:
    v16 = 1;
    goto LABEL_16;
  }

  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  hh1EOLMininumControllerHomeKitVersion = [idsServerBag hh1EOLMininumControllerHomeKitVersion];
  if (hh1EOLMininumControllerHomeKitVersion)
  {
    v7 = hh1EOLMininumControllerHomeKitVersion;
    v8 = +[HMDHomeKitVersion currentVersion];
    idsServerBag2 = [(HMDHomeManager *)self idsServerBag];
    hh1EOLMininumControllerHomeKitVersion2 = [idsServerBag2 hh1EOLMininumControllerHomeKitVersion];
    v11 = [v8 isAtLeastVersion:hh1EOLMininumControllerHomeKitVersion2];

    if (v11)
    {
      v12 = objc_autoreleasePoolPush();
      selfCopy = self;
      v14 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
      {
        v15 = HMFGetLogIdentifier();
        *buf = 138543362;
        v30 = v15;
        _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@HH1 EOL minimum version met.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v12);
      goto LABEL_8;
    }
  }

  else
  {
  }

  if (!isInternalBuild())
  {
LABEL_15:
    v16 = 0;
    goto LABEL_16;
  }

  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];
  modelIdentifier = [account modelIdentifier];

  if (modelIdentifier)
  {
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __33__HMDHomeManager_isHH1EOLEnabled__block_invoke;
    v26[3] = &unk_27868A750;
    v27 = modelIdentifier;
    selfCopy2 = self;
    if (isHH1EOLEnabled_onceToken != -1)
    {
      dispatch_once(&isHH1EOLEnabled_onceToken, v26);
    }

    v16 = isHH1EOLEnabled_hh1EOLEnabled;
  }

  else
  {
    v22 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543362;
      v30 = v25;
      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@HH1 EOL is enabled as current account identifier is nil.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v22);
    v16 = 1;
  }

LABEL_16:
  v20 = *MEMORY[0x277D85DE8];
  return v16;
}

void __33__HMDHomeManager_isHH1EOLEnabled__block_invoke(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  v14 = 0;
  v2 = [*(a1 + 32) hmf_bytesAsData];
  v3 = [v2 hm_generateSHA256];

  [v3 getBytes:&v14 length:8];
  v4 = v14;
  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 40);
  v7 = HMFGetOSLogHandle();
  v8 = os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT);
  if (v4)
  {
    if (v8)
    {
      v9 = HMFGetLogIdentifier();
      v10 = *(a1 + 32);
      *buf = 138543874;
      v16 = v9;
      v17 = 2112;
      v18 = v10;
      v19 = 2048;
      v20 = v14;
      v11 = "%{public}@HH1 EOL is enabled for user: %@ based on UUID hash: %tu";
LABEL_6:
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, v11, buf, 0x20u);
    }
  }

  else if (v8)
  {
    v9 = HMFGetLogIdentifier();
    v12 = *(a1 + 32);
    *buf = 138543874;
    v16 = v9;
    v17 = 2112;
    v18 = v12;
    v19 = 2048;
    v20 = v14;
    v11 = "%{public}@HH1 EOL is not enabled for user: %@ based on UUID hash: %tu";
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v5);
  isHH1EOLEnabled_hh1EOLEnabled = v4 & 1;

  v13 = *MEMORY[0x277D85DE8];
}

- (void)removeSharedUserAcceptEventBuilderForHomeUuid:(id)uuid
{
  uuidCopy = uuid;
  if (uuidCopy)
  {
    v6 = uuidCopy;
    os_unfair_lock_lock_with_options();
    pendingSharedUserAcceptLogEventBuilders = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    [pendingSharedUserAcceptLogEventBuilders removeObjectForKey:v6];

    os_unfair_lock_unlock(&self->_lock);
    uuidCopy = v6;
  }
}

- (id)sharedUserAcceptEventBuilderForHomeUuid:(id)uuid
{
  uuidCopy = uuid;
  if (uuidCopy)
  {
    os_unfair_lock_lock_with_options();
    pendingSharedUserAcceptLogEventBuilders = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    v6 = [pendingSharedUserAcceptLogEventBuilders objectForKeyedSubscript:uuidCopy];

    os_unfair_lock_unlock(&self->_lock);
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

- (void)addSharedUserAcceptEventBuilder:(id)builder forHomeUuid:(id)uuid
{
  builderCopy = builder;
  uuidCopy = uuid;
  if (builderCopy && uuidCopy)
  {
    os_unfair_lock_lock_with_options();
    pendingSharedUserAcceptLogEventBuilders = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];

    if (!pendingSharedUserAcceptLogEventBuilders)
    {
      v8 = objc_alloc_init(MEMORY[0x277CBEB38]);
      [(HMDHomeManager *)self setPendingSharedUserAcceptLogEventBuilders:v8];
    }

    pendingSharedUserAcceptLogEventBuilders2 = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    [pendingSharedUserAcceptLogEventBuilders2 setObject:builderCopy forKeyedSubscript:uuidCopy];

    os_unfair_lock_unlock(&self->_lock);
  }
}

- (void)_signpostAssistantSyncDataRequestHandled
{
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    *v3 = 0;
    _os_signpost_emit_with_name_impl(&dword_229538000, logger, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "AssistantSyncDataRequestHandled", "", v3, 2u);
  }
}

- (void)_signpostAssistantSyncDataNotification
{
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    *v3 = 0;
    _os_signpost_emit_with_name_impl(&dword_229538000, logger, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "NotifyAssistantSyncDataReadiness", "", v3, 2u);
  }
}

- (void)_handlePrepareForDiagnosticExtension:(id)extension
{
  v23 = *MEMORY[0x277D85DE8];
  extensionCopy = extension;
  if ((isInternalBuild() & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
    {
      v10 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v10;
      v21 = 2112;
      v22 = extensionCopy;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_FAULT, "%{public}@Should never call _handlePrepareForDiagnosticExtension in non-internal builds: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 52;
    goto LABEL_10;
  }

  name = [extensionCopy name];
  v6 = [name isEqualToString:*MEMORY[0x277CD02F0]];

  if ((v6 & 1) == 0)
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v16;
      v21 = 2112;
      v22 = extensionCopy;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Received bad message in _handlePrepareForDiagnosticExtension: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 3;
LABEL_10:
    v17 = [v11 hmErrorWithCode:v12];
    [extensionCopy respondWithError:v17];

    goto LABEL_11;
  }

  [(HMDHomeManager *)self prepareForDiagnosticExtension:extensionCopy];
LABEL_11:

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleDumpDatabase:(id)database
{
  v23 = *MEMORY[0x277D85DE8];
  databaseCopy = database;
  if ((isInternalBuild() & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
    {
      v10 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v10;
      v21 = 2112;
      v22 = databaseCopy;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_FAULT, "%{public}@Should never call _handleDumpDatabase in non-internal builds: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 52;
    goto LABEL_10;
  }

  name = [databaseCopy name];
  v6 = [name isEqualToString:*MEMORY[0x277CD0158]];

  if ((v6 & 1) == 0)
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v16;
      v21 = 2112;
      v22 = databaseCopy;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Received bad message in _handleDumpDatabase: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 3;
LABEL_10:
    v17 = [v11 hmErrorWithCode:v12];
    [databaseCopy respondWithError:v17];

    goto LABEL_11;
  }

  [(HMDHomeManager *)self handleDumpDatabaseMessage:databaseCopy];
LABEL_11:

  v18 = *MEMORY[0x277D85DE8];
}

- (BOOL)expectingInvitationResponseForIdentifier:(id)identifier
{
  v32 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  if (identifierCopy)
  {
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    homes = [(HMDHomeManager *)self homes];
    v6 = [homes countByEnumeratingWithState:&v26 objects:v31 count:16];
    if (v6)
    {
      v7 = v6;
      v8 = *v27;
      v21 = *v27;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v27 != v8)
          {
            objc_enumerationMutation(homes);
          }

          v10 = *(*(&v26 + 1) + 8 * i);
          v22 = 0u;
          v23 = 0u;
          v24 = 0u;
          v25 = 0u;
          outgoingInvitations = [v10 outgoingInvitations];
          v12 = [outgoingInvitations countByEnumeratingWithState:&v22 objects:v30 count:16];
          if (v12)
          {
            v13 = v12;
            v14 = *v23;
            while (2)
            {
              for (j = 0; j != v13; ++j)
              {
                if (*v23 != v14)
                {
                  objc_enumerationMutation(outgoingInvitations);
                }

                identifier = [*(*(&v22 + 1) + 8 * j) identifier];
                v17 = [identifier isEqual:identifierCopy];

                if (v17)
                {

                  v18 = 1;
                  goto LABEL_21;
                }
              }

              v13 = [outgoingInvitations countByEnumeratingWithState:&v22 objects:v30 count:16];
              if (v13)
              {
                continue;
              }

              break;
            }
          }

          v8 = v21;
        }

        v7 = [homes countByEnumeratingWithState:&v26 objects:v31 count:16];
        v18 = 0;
      }

      while (v7);
    }

    else
    {
      v18 = 0;
    }

LABEL_21:
  }

  else
  {
    v18 = 0;
  }

  v19 = *MEMORY[0x277D85DE8];
  return v18;
}

- (BOOL)userWithMergeIdIsMemberOfAHome:(id)home
{
  v62 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v51 = 0u;
  v52 = 0u;
  v53 = 0u;
  v54 = 0u;
  selfCopy = self;
  obj = [(HMDHomeManager *)self homes];
  v40 = [obj countByEnumeratingWithState:&v51 objects:v61 count:16];
  if (v40)
  {
    v5 = *v52;
    v38 = *v52;
    while (2)
    {
      v6 = 0;
      do
      {
        if (*v52 != v5)
        {
          v7 = v6;
          objc_enumerationMutation(obj);
          v6 = v7;
        }

        v39 = v6;
        v8 = *(*(&v51 + 1) + 8 * v6);
        v9 = [v8 userWithMergeID:homeCopy];
        v10 = v9 == 0;

        if (!v10)
        {
          goto LABEL_33;
        }

        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        pendingUsers = [v8 pendingUsers];
        v12 = [pendingUsers countByEnumeratingWithState:&v47 objects:v60 count:16];
        if (v12)
        {
          v13 = *v48;
          while (2)
          {
            for (i = 0; i != v12; ++i)
            {
              if (*v48 != v13)
              {
                objc_enumerationMutation(pendingUsers);
              }

              v15 = *(*(&v47 + 1) + 8 * i);
              account = [v15 account];
              senderCorrelationIdentifier = [account senderCorrelationIdentifier];
              if ([senderCorrelationIdentifier isEqualToString:homeCopy])
              {

                goto LABEL_32;
              }

              mergeIdentifier = [v15 mergeIdentifier];
              v19 = [mergeIdentifier isEqualToString:homeCopy];

              if (v19)
              {
                goto LABEL_32;
              }
            }

            v12 = [pendingUsers countByEnumeratingWithState:&v47 objects:v60 count:16];
            if (v12)
            {
              continue;
            }

            break;
          }
        }

        sharedUserLastSyncManager = [(HMDHomeManager *)selfCopy sharedUserLastSyncManager];
        v21 = [sharedUserLastSyncManager isManagingUserWithMergeID:homeCopy];

        if (v21)
        {
          goto LABEL_33;
        }

        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        pendingUsers = [v8 removedUsers];
        v22 = [pendingUsers countByEnumeratingWithState:&v43 objects:v59 count:16];
        if (v22)
        {
          v23 = *v44;
LABEL_19:
          v24 = 0;
          while (1)
          {
            if (*v44 != v23)
            {
              objc_enumerationMutation(pendingUsers);
            }

            mergeID = [*(*(&v43 + 1) + 8 * v24) mergeID];
            v26 = [mergeID isEqualToString:homeCopy];

            if (v26)
            {
              break;
            }

            if (v22 == ++v24)
            {
              v22 = [pendingUsers countByEnumeratingWithState:&v43 objects:v59 count:16];
              if (v22)
              {
                goto LABEL_19;
              }

              goto LABEL_25;
            }
          }

LABEL_32:

LABEL_33:
          goto LABEL_34;
        }

LABEL_25:

        v6 = v39 + 1;
        v5 = v38;
      }

      while (v39 + 1 != v40);
      v40 = [obj countByEnumeratingWithState:&v51 objects:v61 count:16];
      v5 = v38;
      if (v40)
      {
        continue;
      }

      break;
    }
  }

  os_unfair_lock_lock_with_options();
  if ([(NSMutableSet *)selfCopy->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:homeCopy])
  {
    v27 = objc_autoreleasePoolPush();
    v28 = selfCopy;
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543618;
      v56 = v30;
      v57 = 2112;
      v58 = homeCopy;
      _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_INFO, "%{public}@Merge ID %@ found in list of removed homes", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v27);
    os_unfair_lock_unlock(&selfCopy->_lock);
LABEL_34:
    v31 = 1;
  }

  else
  {
    os_unfair_lock_unlock(&selfCopy->_lock);
    v34 = objc_autoreleasePoolPush();
    v35 = selfCopy;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      v37 = HMFGetLogIdentifier();
      *buf = 138543618;
      v56 = v37;
      v57 = 2112;
      v58 = homeCopy;
      _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_DEFAULT, "%{public}@Home Membership Verifier unable to find user with mergeID %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v34);
    v31 = 0;
  }

  v32 = *MEMORY[0x277D85DE8];
  return v31;
}

- (id)createCurrentResidentCapabilities
{
  v196 = *MEMORY[0x277D85DE8];
  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  homeSafetySecurityEnabled = [idsServerBag homeSafetySecurityEnabled];

  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    idsServerBag2 = [(HMDHomeManager *)selfCopy idsServerBag];
    v10 = HMFBooleanToString();
    *buf = 138543874;
    *&buf[4] = v8;
    *&buf[12] = 2112;
    *&buf[14] = idsServerBag2;
    *&buf[22] = 2112;
    v195 = v10;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@self.idsServerBag: %@, homeSafetySecurityEnabled: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  v11 = [[HMDMobileGestaltClient alloc] initWithHomeSafetySecurityEnabled:homeSafetySecurityEnabled];
  productInfo = [MEMORY[0x277D0F8E8] productInfo];
  v13 = +[HMDHomeKitVersion currentVersion];
  featuresDataSource = [(HMDHomeManager *)selfCopy featuresDataSource];
  v15 = productInfo;
  v16 = v11;
  v17 = v13;
  v18 = featuresDataSource;
  if (!productIsResidentCapable(v15))
  {
    v139 = 0;
    goto LABEL_151;
  }

  v156 = productSupportsCameraRecording(v15);
  v19 = productSupportsRouterManagement(v15);
  v20 = 2;
  if (!v19)
  {
    v20 = 0;
  }

  v160 = v20;
  v21 = productSupportsShortcutActions(v15);
  v22 = 4;
  if (!v21)
  {
    v22 = 0;
  }

  v158 = v22;
  v23 = productSupportsMediaActions(v15);
  v24 = 8;
  if (!v23)
  {
    v24 = 0;
  }

  v157 = v24;
  v25 = productSupportsFirmwareUpdate(v15);
  v26 = 32;
  if (!v25)
  {
    v26 = 0;
  }

  v170 = v26;
  v27 = productSupportsResidentFirmwareUpdate(v15);
  v28 = 64;
  if (!v27)
  {
    v28 = 0;
  }

  v179 = v28;
  v29 = productSupportsCameraActivityZones(v15);
  v30 = 128;
  if (!v29)
  {
    v30 = 0;
  }

  v178 = v30;
  v31 = productSupportsCameraActivityZones(v15);
  v32 = 256;
  if (!v31)
  {
    v32 = 0;
  }

  v177 = v32;
  v33 = productSupportsCameraActivityZones(v15);
  v34 = 512;
  if (!v33)
  {
    v34 = 0;
  }

  v176 = v34;
  v35 = productSupportsCameraActivityZones(v15);
  v36 = 1024;
  if (!v35)
  {
    v36 = 0;
  }

  v175 = v36;
  v37 = productSupportsAnnounce(v15);
  v38 = 2048;
  if (!v37)
  {
    v38 = 0;
  }

  v174 = v38;
  v39 = productSupportsWakeOnLAN(v15);
  v40 = 4096;
  if (!v39)
  {
    v40 = 0;
  }

  v173 = v40;
  v41 = productSupportsLockNotificationContext(v15);
  v42 = 0x2000;
  if (!v41)
  {
    v42 = 0;
  }

  v172 = v42;
  v43 = productSupportsLockNotificationContext(v15);
  v44 = 0x4000;
  if (!v43)
  {
    v44 = 0;
  }

  v171 = v44;
  v45 = productSupportsLockNotificationContext(v15);
  v46 = 0x8000;
  if (!v45)
  {
    v46 = 0;
  }

  v169 = v46;
  v47 = productSupportsLockNotificationContext(v15);
  v48 = 0x10000;
  if (!v47)
  {
    v48 = 0;
  }

  v168 = v48;
  v49 = productSupportsLockNotificationContext(v15);
  v50 = 0x20000;
  if (!v49)
  {
    v50 = 0;
  }

  v167 = v50;
  v51 = productSupportsSiriEndpointSetup(v15);
  v52 = 0x80000;
  if (!v51)
  {
    v52 = 0;
  }

  v166 = v52;
  v53 = productSupportsCustomMediaApplicationDestination(v15);
  v54 = 0x100000;
  if (!v53)
  {
    v54 = 0;
  }

  v165 = v54;
  v55 = productSupportsUnifiedMediaNotifications(v15);
  v56 = 0x200000;
  if (!v55)
  {
    v56 = 0;
  }

  v164 = v56;
  v57 = productSupportsHomeHub(v15, v16);
  v58 = 0x400000;
  if (!v57)
  {
    v58 = 0;
  }

  v163 = v58;
  AccessoryCommunication = productSupportsResidentFirstAccessoryCommunication(v15);
  v60 = 0x800000;
  if (!AccessoryCommunication)
  {
    v60 = 0;
  }

  v162 = v60;
  v61 = productSupportsThreadNetworkCredentialSharing(v15, v16, v17);
  v62 = 0x1000000;
  if (!v61)
  {
    v62 = 0;
  }

  v161 = v62;
  v63 = productSupportsMatterSharedAdminPairing(v15, v16, v17);
  v64 = 0x2000000;
  if (!v63)
  {
    v64 = 0;
  }

  v159 = v64;
  memset(buf, 0, sizeof(buf));
  v65 = v15;
  softwareVersion = [v65 softwareVersion];
  v67 = softwareVersion;
  if (softwareVersion)
  {
    [softwareVersion operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform = [v65 productPlatform];
  productClass = [v65 productClass];

  if ((productClass | 2) == 6 && productPlatform == 4)
  {
    v182 = *MEMORY[0x277D0F698];
    v188 = *(MEMORY[0x277D0F698] + 16);
    v155 = (HMFOperatingSystemVersionCompare() != 1) << 26;
  }

  else
  {
    v155 = 0;
  }

  memset(buf, 0, sizeof(buf));
  v71 = v65;
  softwareVersion2 = [v71 softwareVersion];
  v73 = softwareVersion2;
  if (softwareVersion2)
  {
    [softwareVersion2 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform2 = [v71 productPlatform];
  productClass2 = [v71 productClass];

  if ((productClass2 | 2) == 6 && productPlatform2 == 4)
  {
    v183 = *MEMORY[0x277D0F678];
    v189 = *(MEMORY[0x277D0F678] + 16);
    if (HMFOperatingSystemVersionCompare() == 1 && (_os_feature_enabled_impl() & 1) == 0)
    {
      v76 = (CFPreferencesGetAppBooleanValue(@"MatterTTU", @"/Library/Managed Preferences/mobile/com.apple.homed.plist", 0) != 0) << 27;
    }

    else
    {
      v76 = 0x8000000;
    }

    v154 = v76;
  }

  else
  {
    v154 = 0;
  }

  v77 = v71;
  v78 = v16;
  v79 = v17;
  memset(buf, 0, sizeof(buf));
  softwareVersion3 = [v77 softwareVersion];
  v81 = softwareVersion3;
  if (softwareVersion3)
  {
    [softwareVersion3 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  v181 = *MEMORY[0x277D0F5F8];
  v82 = *(MEMORY[0x277D0F5F8] + 16);
  if (HMFOperatingSystemVersionCompare() == 1)
  {
    v153 = 0;
  }

  else
  {
    IsResidentCapable = productIsResidentCapable(v77);
    v84 = 0x10000000;
    if (!IsResidentCapable)
    {
      v84 = 0;
    }

    v153 = v84;
  }

  memset(buf, 0, sizeof(buf));
  v85 = v77;
  softwareVersion4 = [v85 softwareVersion];
  v87 = softwareVersion4;
  if (softwareVersion4)
  {
    [softwareVersion4 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform3 = [v85 productPlatform];
  productClass3 = [v85 productClass];

  if ((productClass3 | 2) == 6 && productPlatform3 == 4)
  {
    v152 = (HMFOperatingSystemVersionCompare() != 1) << 29;
  }

  else
  {
    v152 = 0;
  }

  memset(buf, 0, sizeof(buf));
  v90 = v85;
  softwareVersion5 = [v90 softwareVersion];
  v92 = softwareVersion5;
  if (softwareVersion5)
  {
    [softwareVersion5 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform4 = [v90 productPlatform];
  productClass4 = [v90 productClass];

  if ((productClass4 | 2) == 6 && productPlatform4 == 4)
  {
    if (HMFOperatingSystemVersionCompare() == 1)
    {
      v95 = _os_feature_enabled_impl();
      v96 = 0x40000000;
      if (!v95)
      {
        v96 = 0;
      }
    }

    else
    {
      v96 = 0x40000000;
    }

    v151 = v96;
  }

  else
  {
    v151 = 0;
  }

  memset(buf, 0, sizeof(buf));
  v97 = v90;
  softwareVersion6 = [v97 softwareVersion];
  v99 = softwareVersion6;
  if (softwareVersion6)
  {
    [softwareVersion6 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform5 = [v97 productPlatform];
  productClass5 = [v97 productClass];

  if ((productClass5 | 2) == 6 && productPlatform5 == 4)
  {
    v150 = (HMFOperatingSystemVersionCompare() != 1) << 31;
  }

  else
  {
    v150 = 0;
  }

  v102 = productSupportsMatterOwnerCertFetch(v97, v78, v79);
  v103 = 0x100000000;
  if (!v102)
  {
    v103 = 0;
  }

  v149 = v103;
  memset(buf, 0, sizeof(buf));
  v104 = v97;
  softwareVersion7 = [v104 softwareVersion];
  v106 = softwareVersion7;
  if (softwareVersion7)
  {
    [softwareVersion7 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform6 = [v104 productPlatform];
  productClass6 = [v104 productClass];

  if ((productClass6 | 2) == 6 && productPlatform6 == 4)
  {
    v148 = (HMFOperatingSystemVersionCompare() != 1) << 33;
  }

  else
  {
    v148 = 0;
  }

  memset(buf, 0, sizeof(buf));
  v109 = v104;
  softwareVersion8 = [v109 softwareVersion];
  v111 = softwareVersion8;
  if (softwareVersion8)
  {
    [softwareVersion8 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform7 = [v109 productPlatform];
  productClass7 = [v109 productClass];

  if ((productClass7 | 2) == 6 && productPlatform7 == 4)
  {
    if (HMFOperatingSystemVersionCompare() != 1)
    {
      v114 = 0x400000000;
      goto LABEL_122;
    }

    if (isInternalBuild())
    {
      v184 = *MEMORY[0x277D0F690];
      v190 = *(MEMORY[0x277D0F690] + 16);
      v114 = (HMFOperatingSystemVersionCompare() != 1) << 34;
LABEL_122:
      v147 = v114;
      goto LABEL_123;
    }
  }

  v147 = 0;
LABEL_123:
  v115 = v18;
  memset(buf, 0, sizeof(buf));
  v116 = v109;
  softwareVersion9 = [v116 softwareVersion];
  v118 = softwareVersion9;
  if (softwareVersion9)
  {
    [softwareVersion9 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform8 = [v116 productPlatform];
  productClass8 = [v116 productClass];

  v180 = v18;
  if ((productClass8 | 2) == 6 && productPlatform8 == 4 && (v185 = *MEMORY[0x277D0F5E0], v191 = *(MEMORY[0x277D0F5E0] + 16), HMFOperatingSystemVersionCompare() != 1))
  {
    isRVCEnabled = [v115 isRVCEnabled];
    v145 = 0x800000000;
    if (!isRVCEnabled)
    {
      v145 = 0;
    }

    v146 = v145;
  }

  else
  {
    v146 = 0;
  }

  v121 = v115;
  v122 = v116;
  productPlatform9 = [v122 productPlatform];
  productClass9 = [v122 productClass];

  if ((productClass9 | 2) == 6 && productPlatform9 == 4)
  {
    if ([v121 isHomeActivityStateFeatureEnabled])
    {
      v125 = 0x1000000000;
    }

    else
    {
      v125 = 0;
    }
  }

  else
  {
    v125 = 0;
  }

  memset(buf, 0, sizeof(buf));
  v126 = v122;
  softwareVersion10 = [v126 softwareVersion];
  v128 = softwareVersion10;
  if (softwareVersion10)
  {
    [softwareVersion10 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform10 = [v126 productPlatform];
  productClass10 = [v126 productClass];

  if ((productClass10 | 2) == 6 && productPlatform10 == 4)
  {
    v186 = *MEMORY[0x277D0F5E0];
    v192 = *(MEMORY[0x277D0F5E0] + 16);
    v131 = (HMFOperatingSystemVersionCompare() != 1) << 37;
  }

  else
  {
    v131 = 0;
  }

  v132 = v121;
  memset(buf, 0, sizeof(buf));
  v133 = v126;
  softwareVersion11 = [v133 softwareVersion];
  v135 = softwareVersion11;
  if (softwareVersion11)
  {
    [softwareVersion11 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform11 = [v133 productPlatform];
  productClass11 = [v133 productClass];

  if ((productClass11 | 2) == 6 && productPlatform11 == 4 && (v187 = *MEMORY[0x277D0F5E8], v193 = *(MEMORY[0x277D0F5E8] + 16), HMFOperatingSystemVersionCompare() != 1))
  {
    if ([v132 isRVCEnabled])
    {
      v138 = 0x4000000000;
    }

    else
    {
      v138 = 0;
    }
  }

  else
  {
    v138 = 0;
  }

  v139 = v148 | v147 | v146 | v125 | v131 | v138;
  v140 = objc_alloc(MEMORY[0x277CD1D60]);
  uUID = [MEMORY[0x277CCAD78] UUID];
  v139 = [v140 initWithTagUUID:uUID capabilities:v160 | v156 | v158 | v157 | v170 | v179 | v178 | v177 | v176 | v175 | v174 | v173 | v172 | v171 | v169 | v168 | v167 | v166 | v165 | v164 | v163 | v162 | v161 | v159 | v155 | v154 | v153 | v152 | v151 | v150 | v149 | v139];

  v18 = v180;
LABEL_151:

  v142 = *MEMORY[0x277D85DE8];

  return v139;
}

- (id)createCurrentAccessoryCapabilities
{
  v193 = *MEMORY[0x277D85DE8];
  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  homeSafetySecurityEnabled = [idsServerBag homeSafetySecurityEnabled];

  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    idsServerBag2 = [(HMDHomeManager *)selfCopy idsServerBag];
    v10 = HMFBooleanToString();
    *buf = 138543874;
    *&buf[4] = v8;
    *&buf[12] = 2112;
    *&buf[14] = idsServerBag2;
    *&buf[22] = 2112;
    v192 = v10;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@self.idsServerBag: %@, homeSafetySecurityEnabled: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  v11 = [[HMDMobileGestaltClient alloc] initWithHomeSafetySecurityEnabled:homeSafetySecurityEnabled];
  productInfo = [MEMORY[0x277D0F8E8] productInfo];
  v13 = +[HMDHomeKitVersion currentVersion];
  featuresDataSource = [(HMDHomeManager *)selfCopy featuresDataSource];
  v15 = v13;
  v16 = v11;
  v17 = productInfo;
  v18 = productSupportsKeychainSync(v17);
  v19 = productSupportsDeviceSetup(v17);
  v20 = productSupportsKeyTransferClient(v17, v16, v15);
  v175 = productSupportsKeyTransferServer(v17);
  v173 = productSupportsKeychainSync(v17);
  v172 = productSupportsCloudDataSync(v17);
  v174 = productSupportsWholeHouseAudio(v17);
  v171 = productSupportsAssistantAccessControl(v17);
  v170 = productSupportsHomeInvitation(v17);
  v169 = productSupportsTargetControl(v17);
  v167 = productSupportsMultiUser(v17);
  v165 = productSupportsHomeLevelLocationServiceSetting(v17);
  v163 = productSupportsCompanionInitiatedRestart(v17);
  v161 = productSupportsMusicAlarm(v17);
  v159 = productSupportsAnnounce(v17);
  v157 = productSupportsAudioAnalysis(v17, v16);
  v155 = productSupportsThirdPartyMusic(v17);
  v153 = productSupportsPreferredMediaUser(v17);
  v150 = productSupportsThirdPartyMusic(v17);
  v148 = productSupportsUserMediaSettings(v17);
  v146 = productSupportsCoordinationDoorbellChime(v17);
  v144 = productSupportsHomeHub(v17, v16);
  v142 = productSupportsAudioReturnChannel(v17, v16);
  v140 = productSupportsUserMediaSettings(v17);
  v138 = productSupportsCaptiveNetworks(v17);
  v136 = productSupportsMessagedHomePodSettings(v17, v15);
  v134 = productSupportsMediaActions(v17);
  v176 = v16;
  v21 = productSupportsDropIn(v17, v16);
  v131 = productSupportsRMVonAppleTV(v17);
  v129 = productSupportsJustSiri(v17);
  memset(buf, 0, sizeof(buf));
  v22 = v17;
  softwareVersion = [v22 softwareVersion];
  v24 = softwareVersion;
  if (softwareVersion)
  {
    [softwareVersion operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform = [v22 productPlatform];
  productClass = [v22 productClass];

  v27 = 0;
  if (productClass == 6 && productPlatform == 4)
  {
    v177 = *MEMORY[0x277D0F680];
    v184 = *(MEMORY[0x277D0F680] + 16);
    v27 = (HMFOperatingSystemVersionCompare() != 1) << 31;
  }

  v152 = v27;
  v126 = productSupportsCoordinationFreeDoorbellChime(v22);
  v124 = productSupportsCompanionInitiatedObliterate(v22);
  v28 = v22;
  productPlatform2 = [v28 productPlatform];
  productClass2 = [v28 productClass];
  memset(buf, 0, sizeof(buf));
  softwareVersion2 = [v28 softwareVersion];

  if (softwareVersion2)
  {
    [softwareVersion2 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  v32 = 0;
  if (productClass2 == 4 && productPlatform2 == 4)
  {
    v178 = *MEMORY[0x277D0F5F8];
    v185 = *(MEMORY[0x277D0F5F8] + 16);
    v32 = (HMFOperatingSystemVersionCompare() != 1) << 34;
  }

  v133 = v32;
  productClass3 = [v28 productClass];
  memset(buf, 0, sizeof(buf));
  v34 = v28;
  softwareVersion3 = [v34 softwareVersion];
  v36 = softwareVersion3;
  if (softwareVersion3)
  {
    [softwareVersion3 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform3 = [v34 productPlatform];
  productClass4 = [v34 productClass];

  v39 = 0;
  if (productClass4 == 6 && productPlatform3 == 4)
  {
    v179 = *MEMORY[0x277D0F5E0];
    v186 = *(MEMORY[0x277D0F5E0] + 16);
    v39 = (HMFOperatingSystemVersionCompare() != 1) << 36;
  }

  v128 = v39;
  memset(buf, 0, sizeof(buf));
  v40 = v34;
  softwareVersion4 = [v40 softwareVersion];
  v42 = softwareVersion4;
  if (softwareVersion4)
  {
    [softwareVersion4 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform4 = [v40 productPlatform];
  productClass5 = [v40 productClass];

  v45 = 0;
  if (productClass5 == 6 && productPlatform4 == 4)
  {
    v180 = *MEMORY[0x277D0F588];
    v187 = *(MEMORY[0x277D0F588] + 16);
    v45 = (HMFOperatingSystemVersionCompare() != 1) << 37;
  }

  v123 = v45;
  v46 = featuresDataSource;
  memset(buf, 0, sizeof(buf));
  v47 = v40;
  softwareVersion5 = [v47 softwareVersion];
  v49 = softwareVersion5;
  if (softwareVersion5)
  {
    [softwareVersion5 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform5 = [v47 productPlatform];
  productClass6 = [v47 productClass];

  v52 = 0;
  if (productClass6 == 6 && productPlatform5 == 4)
  {
    v181 = *MEMORY[0x277D0F5E8];
    v188 = *(MEMORY[0x277D0F5E8] + 16);
    if (HMFOperatingSystemVersionCompare() == 1)
    {
      v52 = 0;
    }

    else
    {
      isStereoOdeonTTSUBypassingPrimaryEnabled = [v46 isStereoOdeonTTSUBypassingPrimaryEnabled];
      v52 = 0x4000000000;
      if (!isStereoOdeonTTSUBypassingPrimaryEnabled)
      {
        v52 = 0;
      }
    }
  }

  v122 = v52;

  v54 = v46;
  memset(buf, 0, sizeof(buf));
  v55 = v47;
  softwareVersion6 = [v55 softwareVersion];
  v57 = softwareVersion6;
  if (softwareVersion6)
  {
    [softwareVersion6 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform6 = [v55 productPlatform];
  productClass7 = [v55 productClass];

  if ((productClass7 | 2) == 6 && productPlatform6 == 4 && (v182 = *MEMORY[0x277D0F298], v189 = *(MEMORY[0x277D0F298] + 16), HMFOperatingSystemVersionCompare() != 1) && [v54 isNetworkDiagnosticsEnabled])
  {
    isWifiPickerApiEnabled = [v54 isWifiPickerApiEnabled];
    v61 = 0x8000000000;
    if (!isWifiPickerApiEnabled)
    {
      v61 = 0;
    }

    v121 = v61;
  }

  else
  {
    v121 = 0;
  }

  v62 = v54;
  memset(buf, 0, sizeof(buf));
  v63 = v55;
  softwareVersion7 = [v63 softwareVersion];
  v65 = softwareVersion7;
  if (softwareVersion7)
  {
    [softwareVersion7 operatingSystemVersion];
  }

  else
  {
    memset(buf, 0, sizeof(buf));
  }

  productPlatform7 = [v63 productPlatform];
  productClass8 = [v63 productClass];

  v68 = 0;
  if (productClass8 == 6)
  {
    v69 = v63;
    if (productPlatform7 == 4)
    {
      v183 = *MEMORY[0x277D0F298];
      v190 = *(MEMORY[0x277D0F298] + 16);
      if (HMFOperatingSystemVersionCompare() == 1)
      {
        v68 = 0;
      }

      else
      {
        isCrossfadeAsAirplaySourceEnabled = [v62 isCrossfadeAsAirplaySourceEnabled];
        v68 = 0x10000000000;
        if (!isCrossfadeAsAirplaySourceEnabled)
        {
          v68 = 0;
        }
      }
    }
  }

  else
  {
    v69 = v63;
  }

  v120 = v68;
  v119 = (productClass3 & 0xFFFFFFFFFFFFFFFDLL) == 4;
  if (v124)
  {
    v71 = 0x200000000;
  }

  else
  {
    v71 = 0;
  }

  v72 = 0x100000000;
  if (!v126)
  {
    v72 = 0;
  }

  v125 = v71;
  v127 = v72;
  if (v129)
  {
    v73 = 0x40000000;
  }

  else
  {
    v73 = 0;
  }

  v74 = 0x20000000;
  if (!v131)
  {
    v74 = 0;
  }

  v130 = v73;
  v132 = v74;
  v75 = 0x10000000;
  if (!v21)
  {
    v75 = 0;
  }

  v118 = v75;
  if (v134)
  {
    v76 = 0x8000000;
  }

  else
  {
    v76 = 0;
  }

  v77 = 0x4000000;
  if (!v136)
  {
    v77 = 0;
  }

  v135 = v76;
  v137 = v77;
  if (v138)
  {
    v78 = 0x2000000;
  }

  else
  {
    v78 = 0;
  }

  v79 = 0x1000000;
  if (!v140)
  {
    v79 = 0;
  }

  v139 = v78;
  v141 = v79;
  if (v142)
  {
    v80 = 0x800000;
  }

  else
  {
    v80 = 0;
  }

  v81 = 0x400000;
  if (!v144)
  {
    v81 = 0;
  }

  v143 = v80;
  v145 = v81;
  if (v146)
  {
    v82 = 0x200000;
  }

  else
  {
    v82 = 0;
  }

  v83 = 0x100000;
  if (!v148)
  {
    v83 = 0;
  }

  v147 = v82;
  v149 = v83;
  v84 = 0x80000;
  if (!v150)
  {
    v84 = 0;
  }

  v151 = v84;
  if (v153)
  {
    v85 = 0x20000;
  }

  else
  {
    v85 = 0;
  }

  v86 = 0x10000;
  if (!v155)
  {
    v86 = 0;
  }

  v154 = v85;
  v156 = v86;
  if (v157)
  {
    v87 = 0x8000;
  }

  else
  {
    v87 = 0;
  }

  v88 = 0x4000;
  if (!v159)
  {
    v88 = 0;
  }

  v158 = v87;
  v160 = v88;
  if (v161)
  {
    v89 = 0x2000;
  }

  else
  {
    v89 = 0;
  }

  v90 = 4096;
  if (!v163)
  {
    v90 = 0;
  }

  v162 = v89;
  v164 = v90;
  if (v165)
  {
    v91 = 2048;
  }

  else
  {
    v91 = 0;
  }

  v92 = 1024;
  if (!v167)
  {
    v92 = 0;
  }

  v166 = v91;
  v168 = v92;
  if (v169)
  {
    v93 = 512;
  }

  else
  {
    v93 = 0;
  }

  if (v170)
  {
    v94 = 256;
  }

  else
  {
    v94 = 0;
  }

  if (v171)
  {
    v95 = 128;
  }

  else
  {
    v95 = 0;
  }

  v96 = 2;
  if (!v19)
  {
    v96 = 0;
  }

  v97 = v96 | v18;
  v98 = 4;
  if (!v20)
  {
    v98 = 0;
  }

  v99 = v97 | v98;
  v100 = 8;
  if (!v175)
  {
    v100 = 0;
  }

  v101 = 16;
  if (!v173)
  {
    v101 = 0;
  }

  v102 = v100 | v101;
  v103 = 32;
  if (!v172)
  {
    v103 = 0;
  }

  v104 = v99 | v102 | v103;
  v105 = v62;
  if (v174)
  {
    v106 = 64;
  }

  else
  {
    v106 = 0;
  }

  productClass9 = [v69 productClass];
  v108 = productClass9 < 0xC;
  v109 = 0x40u >> productClass9;

  v110 = 0x20000000000;
  if ((v108 & v109) == 0)
  {
    v110 = 0;
  }

  v111 = v104 | v106 | v95 | v94 | v93 | v168 | v166 | v164 | v162 | v160 | v158 | v156 | v154 | v151 | v149 | v147 | v145 | v143 | v141 | v139 | v137 | v135 | v118 | v132 | v130 | v152 | v127 | v125 | v133 | (v119 << 35);
  v112 = v128 | v123 | v122 | v121 | v120 | v110;
  v113 = objc_alloc(MEMORY[0x277CD1678]);
  uUID = [MEMORY[0x277CCAD78] UUID];
  v112 = [v113 initWithTagUUID:uUID capabilities:v111 | v112];

  v116 = *MEMORY[0x277D85DE8];

  return v112;
}

- (id)currentAccessoryHomeUUID
{
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = _accessoryOfCurrentDevice;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  if (v4)
  {
    home = [v4 home];
    uuid = [home uuid];
  }

  else
  {
    uuid = 0;
  }

  return uuid;
}

- (id)currentAccessoryUUID
{
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = _accessoryOfCurrentDevice;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  if (v4)
  {
    uuid = [v4 uuid];
  }

  else
  {
    uuid = 0;
  }

  return uuid;
}

- (id)currentAccessoryHome
{
  v14 = *MEMORY[0x277D85DE8];
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  if (_accessoryOfCurrentDevice)
  {
    _accessoryOfCurrentDevice2 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
    home = [_accessoryOfCurrentDevice2 home];
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to get current accessory home due to no current accessory", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    home = 0;
  }

  v10 = *MEMORY[0x277D85DE8];

  return home;
}

- (id)currentMediaGroupsAggregateConsumer
{
  v14 = *MEMORY[0x277D85DE8];
  currentAccessoryHome = [(HMDHomeManager *)self currentAccessoryHome];
  v4 = currentAccessoryHome;
  if (currentAccessoryHome)
  {
    mediaGroupsAggregateConsumer = [currentAccessoryHome mediaGroupsAggregateConsumer];
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to get current media groups aggregate consumer due to no current accessory home", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    mediaGroupsAggregateConsumer = 0;
  }

  v10 = *MEMORY[0x277D85DE8];

  return mediaGroupsAggregateConsumer;
}

- (void)mediaGroupParticipantLocalDataStorage:(id)storage didChangeDestinationIdentifier:(id)identifier forDestinationControllerIdentifier:(id)controllerIdentifier
{
  v20 = *MEMORY[0x277D85DE8];
  storageCopy = storage;
  identifierCopy = identifier;
  controllerIdentifierCopy = controllerIdentifier;
  currentMediaGroupsAggregateConsumer = [(HMDHomeManager *)self currentMediaGroupsAggregateConsumer];
  v12 = currentMediaGroupsAggregateConsumer;
  if (currentMediaGroupsAggregateConsumer)
  {
    if (identifierCopy)
    {
      [currentMediaGroupsAggregateConsumer unstageNullDestinationForCurrentDestinationController];
    }

    else
    {
      [currentMediaGroupsAggregateConsumer stageNullDestinationForCurrentDestinationControllerIdentifier:controllerIdentifierCopy];
    }
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v16;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Failed to stage current destination controller change due to no current consumer", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (id)topicNameForMediaGroupParticipantDataLocalStorage:(id)storage
{
  v26 = *MEMORY[0x277D85DE8];
  storageCopy = storage;
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  v6 = _accessoryOfCurrentDevice;
  if (_accessoryOfCurrentDevice)
  {
    home = [_accessoryOfCurrentDevice home];
    v8 = home;
    if (home)
    {
      v9 = MEMORY[0x277CD16F0];
      v10 = *MEMORY[0x277CCEA70];
      uuid = [home uuid];
      uuid2 = [v6 uuid];
      v13 = [v9 topicFromSuffixID:v10 homeUUID:uuid accessoryUUID:uuid2];
    }

    else
    {
      v18 = objc_autoreleasePoolPush();
      selfCopy = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
      {
        v21 = HMFGetLogIdentifier();
        v24 = 138543362;
        v25 = v21;
        _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Failed to get media group participant data topic name due to no home on current accessory", &v24, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      v13 = 0;
    }
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
    {
      v17 = HMFGetLogIdentifier();
      v24 = 138543362;
      v25 = v17;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Failed to get media group participant data topic name due to no current accessory", &v24, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
    v13 = 0;
  }

  v22 = *MEMORY[0x277D85DE8];

  return v13;
}

- (BOOL)isStartThreadNetworkInProgress
{
  v25 = *MEMORY[0x277D85DE8];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v4 = [homes countByEnumeratingWithState:&v16 objects:v24 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v17;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v17 != v6)
        {
          objc_enumerationMutation(homes);
        }

        v8 = *(*(&v16 + 1) + 8 * i);
        if ([v8 startThreadNetworkInProgress])
        {
          v10 = objc_autoreleasePoolPush();
          selfCopy = self;
          v12 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
          {
            v13 = HMFGetLogIdentifier();
            *buf = 138543618;
            v21 = v13;
            v22 = 2112;
            v23 = v8;
            _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@thread start in progress for %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v10);
          v9 = 1;
          goto LABEL_13;
        }
      }

      v5 = [homes countByEnumeratingWithState:&v16 objects:v24 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  v9 = 0;
LABEL_13:

  v14 = *MEMORY[0x277D85DE8];
  return v9;
}

- (BOOL)isCurrentResidentDeviceRunningThreadNetwork:(id)network
{
  v14 = *MEMORY[0x277D85DE8];
  if (network)
  {
    v11 = 0u;
    v12 = 0u;
    v9 = 0u;
    v10 = 0u;
    homes = [(HMDHomeManager *)self homes];
    v4 = [homes countByEnumeratingWithState:&v9 objects:v13 count:16];
    if (v4)
    {
      v5 = *v10;
      while (2)
      {
        for (i = 0; i != v4; ++i)
        {
          if (*v10 != v5)
          {
            objc_enumerationMutation(homes);
          }

          if ([*(*(&v9 + 1) + 8 * i) isCurrentDeviceAvailableResident])
          {
            LOBYTE(v4) = 1;
            goto LABEL_12;
          }
        }

        v4 = [homes countByEnumeratingWithState:&v9 objects:v13 count:16];
        if (v4)
        {
          continue;
        }

        break;
      }
    }

LABEL_12:
  }

  else
  {
    LOBYTE(v4) = 0;
  }

  v7 = *MEMORY[0x277D85DE8];
  return v4;
}

- (id)setupSessionIdentifierForAccessoryUUID:(id)d outStartTime:(double *)time
{
  v5 = [(HMDHomeManager *)self accessorySetupMetricDispatcherForAccessoryUUID:d];
  v6 = v5;
  if (v5)
  {
    if (time)
    {
      trackingInfo = [v5 trackingInfo];
      *time = [trackingInfo startTime];
    }

    setupSessionIdentifier = [v6 setupSessionIdentifier];
  }

  else
  {
    setupSessionIdentifier = 0;
    if (time)
    {
      *time = 0.0;
    }
  }

  return setupSessionIdentifier;
}

- (id)accessorySetupMetricDispatchersForHome:(id)home
{
  homeCopy = home;
  os_unfair_lock_lock_with_options();
  accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __57__HMDHomeManager_accessorySetupMetricDispatchersForHome___block_invoke;
  v9[3] = &unk_2786866D0;
  v6 = homeCopy;
  v10 = v6;
  v7 = [(NSMutableArray *)accessorySetupMetricDispatchers na_filter:v9];

  os_unfair_lock_unlock(&self->_lock);

  return v7;
}

- (id)firstSetupSessionIdentifierOutputStartTime:(double *)time
{
  os_unfair_lock_lock_with_options();
  if ([(NSMutableArray *)self->_accessorySetupMetricDispatchers count])
  {
    firstObject = [(NSMutableArray *)self->_accessorySetupMetricDispatchers firstObject];
    v6 = firstObject;
    if (time)
    {
      trackingInfo = [firstObject trackingInfo];
      *time = [trackingInfo startTime];
    }

    setupSessionIdentifier = [v6 setupSessionIdentifier];
  }

  else
  {
    setupSessionIdentifier = 0;
    if (time)
    {
      *time = 0.0;
    }
  }

  os_unfair_lock_unlock(&self->_lock);

  return setupSessionIdentifier;
}

- (void)removeAccessorySetupMetricDispatcherForAccessoryUUID:(id)d
{
  dCopy = d;
  if (dCopy)
  {
    os_unfair_lock_lock_with_options();
    accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __71__HMDHomeManager_removeAccessorySetupMetricDispatcherForAccessoryUUID___block_invoke;
    v7[3] = &unk_2786866D0;
    v8 = dCopy;
    v6 = [(NSMutableArray *)accessorySetupMetricDispatchers na_firstObjectPassingTest:v7];
    if (v6)
    {
      [(NSMutableArray *)self->_accessorySetupMetricDispatchers removeObject:v6];
    }

    os_unfair_lock_unlock(&self->_lock);
  }
}

uint64_t __71__HMDHomeManager_removeAccessorySetupMetricDispatcherForAccessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 trackingInfo];
  v4 = [v3 accessoryUUID];
  v5 = [v4 hmf_isEqualToUUID:*(a1 + 32)];

  return v5;
}

- (void)addAccessorySetupMetricDispatcher:(id)dispatcher
{
  dispatcherCopy = dispatcher;
  os_unfair_lock_lock_with_options();
  if (!self->_accessorySetupMetricDispatchers)
  {
    array = [MEMORY[0x277CBEB18] array];
    accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
    self->_accessorySetupMetricDispatchers = array;
  }

  accessorySetupMetricDispatchers = [(HMDHomeManager *)self accessorySetupMetricDispatchers];
  [accessorySetupMetricDispatchers addObject:dispatcherCopy];

  os_unfair_lock_unlock(&self->_lock);
}

- (id)accessorySetupMetricDispatcherForAccessoryUUID:(id)d
{
  dCopy = d;
  os_unfair_lock_lock_with_options();
  accessorySetupMetricDispatchers = [(HMDHomeManager *)self accessorySetupMetricDispatchers];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __65__HMDHomeManager_accessorySetupMetricDispatcherForAccessoryUUID___block_invoke;
  v9[3] = &unk_2786866D0;
  v6 = dCopy;
  v10 = v6;
  v7 = [accessorySetupMetricDispatchers na_firstObjectPassingTest:v9];

  os_unfair_lock_unlock(&self->_lock);

  return v7;
}

uint64_t __65__HMDHomeManager_accessorySetupMetricDispatcherForAccessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 trackingInfo];
  v4 = [v3 accessoryUUID];
  v5 = [v4 hmf_isEqualToUUID:*(a1 + 32)];

  return v5;
}

- (void)_handleEnableUARPPacketCaptureRequest:(id)request
{
  v25 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = [requestCopy BOOLForKey:*MEMORY[0x277CD0190]];
  v6 = [requestCopy stringForKey:*MEMORY[0x277CD01A0]];
  v7 = v6;
  if (v5)
  {
    v8 = v6 == 0;
  }

  else
  {
    v8 = 0;
  }

  if (!v8)
  {
    accessoryFirmwareUpdateManager = [(HMDHomeManager *)self accessoryFirmwareUpdateManager];
    v10 = accessoryFirmwareUpdateManager;
    if (v5)
    {
      v11 = [accessoryFirmwareUpdateManager startUARPPacketCapture:v7];

      if ((v11 & 1) == 0)
      {
        v12 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
        {
          v15 = HMFGetLogIdentifier();
          v21 = 138543618;
          v22 = v15;
          v23 = 2112;
          v24 = @"Request to enable UARP packet capture failed";
          v16 = "%{public}@%@";
          v17 = v14;
          v18 = 22;
LABEL_11:
          _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, v16, &v21, v18);

          goto LABEL_12;
        }

        goto LABEL_12;
      }
    }

    else
    {
      [accessoryFirmwareUpdateManager stopUARPPacketCapture];
    }

    [requestCopy respondWithSuccess];
    goto LABEL_15;
  }

  v12 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    v15 = HMFGetLogIdentifier();
    v21 = 138543362;
    v22 = v15;
    v16 = "%{public}@Request to enable UARP packet capture is missing capture path";
    v17 = v14;
    v18 = 12;
    goto LABEL_11;
  }

LABEL_12:

  objc_autoreleasePoolPop(v12);
  v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [requestCopy respondWithError:v19];

LABEL_15:
  v20 = *MEMORY[0x277D85DE8];
}

- (void)_handleHH2SentinelZonePresent:(id)present
{
  v13 = *MEMORY[0x277D85DE8];
  presentCopy = present;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@HH2 sentinel zone detected", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  uuid = [(HMDHomeManager *)selfCopy uuid];
  [(HMDHomeManager *)selfCopy updateGenerationCounterWithReason:@"HH2 sentinel zone detected" sourceUUID:uuid shouldNotifyClients:1];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)handleCheckIsUsingProductionObjectModelMessage:(id)message
{
  v17 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  if (isInternalBuild())
  {
    v5 = +[HMDCoreData isUsingProductionObjectModel];
    v6 = [MEMORY[0x277CCABB0] numberWithBool:{v5, *MEMORY[0x277CD03F0]}];
    v14 = v6;
    v7 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v14 forKeys:&v13 count:1];
    [messageCopy respondWithPayload:v7];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    selfCopy = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543362;
      v16 = v11;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Not supported in non-internal builds", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v8);
    v6 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [messageCopy respondWithError:v6];
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)handleDeleteModelMessage:(id)message
{
  v36 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v5 = isInternalBuild();
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  v9 = v8;
  if (v5)
  {
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      shortDescription = [messageCopy shortDescription];
      messagePayload = [messageCopy messagePayload];
      *buf = 138543874;
      v31 = v10;
      v32 = 2112;
      v33 = shortDescription;
      v34 = 2112;
      v35 = messagePayload;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Asked to delete the modelID from working store: %@ / %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v6);
    messagePayload2 = [messageCopy messagePayload];
    v14 = [messagePayload2 hmf_UUIDForKey:*MEMORY[0x277CD02A0]];

    if (v14)
    {
      backingStore = [(HMDHomeManager *)selfCopy backingStore];
      context = [backingStore context];
      managedObjectContext = [context managedObjectContext];

      v25[0] = MEMORY[0x277D85DD0];
      v25[1] = 3221225472;
      v25[2] = __43__HMDHomeManager_handleDeleteModelMessage___block_invoke;
      v25[3] = &unk_2786891E0;
      v26 = v14;
      v27 = managedObjectContext;
      v28 = selfCopy;
      v29 = messageCopy;
      v18 = managedObjectContext;
      [v18 performBlock:v25];
    }

    else
    {
      v20 = objc_autoreleasePoolPush();
      v21 = selfCopy;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543362;
        v31 = v23;
        _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, "%{public}@Model id was not missing from the message payload", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v20);
      v18 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
      [messageCopy respondWithError:v18];
    }
  }

  else
  {
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v31 = v19;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@Not supported in non-internal builds", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [messageCopy respondWithError:v14];
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __43__HMDHomeManager_handleDeleteModelMessage___block_invoke(uint64_t a1)
{
  v1 = a1;
  v69 = *MEMORY[0x277D85DE8];
  v2 = *(a1 + 40);
  v51 = *(a1 + 32);
  v50 = v2;
  if (isInternalBuild())
  {
    v47 = v1;
    v57 = 0u;
    v58 = 0u;
    v55 = 0u;
    v56 = 0u;
    obj = +[HMDCoreData managedObjectModel];
    v3 = [obj countByEnumeratingWithState:&v55 objects:v65 count:16];
    if (v3)
    {
      v4 = v3;
      v52 = *v56;
LABEL_4:
      v5 = 0;
      while (1)
      {
        if (*v56 != v52)
        {
          objc_enumerationMutation(obj);
        }

        v6 = *(*(&v55 + 1) + 8 * v5);
        v7 = [v6 propertiesByName];
        v8 = [v7 objectForKeyedSubscript:@"modelID"];

        if (v8)
        {
          v9 = objc_autoreleasePoolPush();
          v10 = objc_alloc(MEMORY[0x277CBE428]);
          v11 = [v6 name];
          v12 = [v10 initWithEntityName:v11];

          v13 = [MEMORY[0x277CCAC30] predicateWithFormat:@"modelID == %@", v51];
          [v12 setPredicate:v13];
          v54 = 0;
          v14 = [v50 executeFetchRequest:v12 error:&v54];
          v15 = v54;
          v16 = objc_autoreleasePoolPush();
          v17 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
          {
            v18 = HMFGetLogIdentifier();
            *buf = 138543618;
            v62 = v18;
            v63 = 2112;
            v64 = v14;
            _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@fetchedObjects : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v16);
          if ([v14 count] && (objc_msgSend(v14, "firstObject"), v19 = objc_claimAutoreleasedReturnValue(), objc_opt_class(), isKindOfClass = objc_opt_isKindOfClass(), v19, (isKindOfClass & 1) != 0))
          {
            v48 = [v14 firstObject];
            v21 = 0;
          }

          else
          {
            v21 = 1;
          }

          objc_autoreleasePoolPop(v9);
          if (!v21)
          {
            break;
          }
        }

        if (v4 == ++v5)
        {
          v4 = [obj countByEnumeratingWithState:&v55 objects:v65 count:16];
          if (v4)
          {
            goto LABEL_4;
          }

          goto LABEL_17;
        }
      }
    }

    else
    {
LABEL_17:
      v48 = 0;
    }

    v1 = v47;
    v22 = v48;
  }

  else
  {
    v22 = 0;
  }

  if (v22)
  {
    v23 = [v22 debugDescription];
    v24 = objc_autoreleasePoolPush();
    v25 = *(v1 + 48);
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
    {
      v27 = HMFGetLogIdentifier();
      *v65 = 138543618;
      v66 = v27;
      v67 = 2112;
      v68 = v23;
      _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_INFO, "%{public}@Found the entity to delete: %@", v65, 0x16u);
    }

    objc_autoreleasePoolPop(v24);
    v28 = v22;
    [*(v1 + 40) deleteObject:v22];
    v59 = @"entity";
    v60 = v23;
    v29 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v60 forKeys:&v59 count:1];
    v30 = *(v1 + 40);
    v53 = 0;
    v31 = [v30 save:&v53];
    v32 = v53;
    v33 = objc_autoreleasePoolPush();
    v34 = v1;
    v35 = *(v1 + 48);
    v36 = HMFGetOSLogHandle();
    v37 = v36;
    if (v31)
    {
      if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
      {
        v38 = HMFGetLogIdentifier();
        *v65 = 138543618;
        v66 = v38;
        v67 = 2112;
        v68 = v23;
        _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@Successfully deleted the entity: %@", v65, 0x16u);
      }

      objc_autoreleasePoolPop(v33);
      [*(v34 + 56) respondWithPayload:v29];
    }

    else
    {
      if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
      {
        v45 = HMFGetLogIdentifier();
        *v65 = 138543618;
        v66 = v45;
        v67 = 2112;
        v68 = v23;
        _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_ERROR, "%{public}@Unable to delete the entity: %@", v65, 0x16u);
      }

      objc_autoreleasePoolPop(v33);
      [*(v34 + 56) respondWithPayload:v29 error:v32];
    }

    v22 = v28;
  }

  else
  {
    v39 = objc_autoreleasePoolPush();
    v40 = *(v1 + 48);
    v41 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
    {
      v42 = HMFGetLogIdentifier();
      v43 = *(v1 + 32);
      *v65 = 138543618;
      v66 = v42;
      v67 = 2112;
      v68 = v43;
      _os_log_impl(&dword_229538000, v41, OS_LOG_TYPE_ERROR, "%{public}@Could not fetch model with modelID from working store: %@", v65, 0x16u);
    }

    objc_autoreleasePoolPop(v39);
    v44 = *(v1 + 56);
    v23 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [v44 respondWithError:v23];
  }

  v46 = *MEMORY[0x277D85DE8];
}

- (void)handleRollPreferredHH2ControllerKeyMessage:(id)message
{
  v18 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    shortDescription = [messageCopy shortDescription];
    v14 = 138543618;
    v15 = v8;
    v16 = 2112;
    v17 = shortDescription;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Handling roll preferred HH2 controller key message: %@", &v14, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  triggerPreferredHH2ControllerKeyRoll = [systemStore triggerPreferredHH2ControllerKeyRoll];

  if (triggerPreferredHH2ControllerKeyRoll)
  {
    [messageCopy respondWithSuccess];
  }

  else
  {
    v12 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:15];
    [messageCopy respondWithError:v12];
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_handleKeyRoll:(id)roll
{
  v40 = *MEMORY[0x277D85DE8];
  rollCopy = roll;
  messagePayload = [rollCopy messagePayload];
  v6 = [messagePayload hmf_stringForKey:*MEMORY[0x277CD0078]];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self accessoriesMatchingIdentifier:v6];
    if ([v7 count])
    {
      firstObject = [v7 firstObject];
      v9 = objc_alloc_init(HMDHH2Migrator);
      systemStore = [MEMORY[0x277CFEC78] systemStore];
      v36 = 0;
      v37 = 0;
      v11 = [systemStore getOrCreateHH2ControllerKey:&v37 secretKey:0 keyPair:0 username:&v36];
      v12 = v37;
      v13 = v36;

      if (v11)
      {
        v14 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v12];
        v34 = v13;
        v15 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:v13 publicKey:v14 privateKey:0 permissions:1];
        home = [firstObject home];
        owner = [home owner];
        [owner pairingIdentity];
        v33 = v12;
        v19 = v18 = v9;

        [(HMDHH2Migrator *)v18 scheduleAccessoryKeyMigration:firstObject oldPairingIdentity:v19 hh2PairingIdentity:v15];
        [rollCopy respondWithSuccess];

        v9 = v18;
        v12 = v33;

        v13 = v34;
      }

      else
      {
        v28 = objc_autoreleasePoolPush();
        selfCopy = self;
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v31 = v35 = v13;
          *buf = 138543362;
          v39 = v31;
          _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@FATAL Error : Unable to create HH2 Controller key", buf, 0xCu);

          v13 = v35;
        }

        objc_autoreleasePoolPop(v28);
        v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
        [rollCopy respondWithError:v14];
      }
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        v27 = HMFGetLogIdentifier();
        *buf = 138543362;
        v39 = v27;
        _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_ERROR, "%{public}@Did not find the accessory with that identifier", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v24);
      firstObject = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [rollCopy respondWithError:firstObject];
    }
  }

  else
  {
    v20 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      v23 = HMFGetLogIdentifier();
      *buf = 138543362;
      v39 = v23;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, "%{public}@accessory identifier cannot be nil", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v20);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [rollCopy respondWithError:v7];
  }

  v32 = *MEMORY[0x277D85DE8];
}

- (void)handleSiriSyncDataRequest:(id)request
{
  requestCopy = request;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __44__HMDHomeManager_handleSiriSyncDataRequest___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = requestCopy;
  v6 = requestCopy;
  dispatch_async(workQueue, v7);
}

- (void)assistantSyncDataChanged:(id)changed
{
  changedCopy = changed;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __43__HMDHomeManager_assistantSyncDataChanged___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = changedCopy;
  v6 = changedCopy;
  dispatch_async(workQueue, v7);
}

- (void)setPostSyncDataUpdatedNotification:(BOOL)notification
{
  os_unfair_lock_lock_with_options();
  self->_postSyncDataUpdatedNotification = notification;

  os_unfair_lock_unlock(&self->_lock);
}

- (BOOL)postSyncDataUpdatedNotification
{
  os_unfair_lock_lock_with_options();
  postSyncDataUpdatedNotification = self->_postSyncDataUpdatedNotification;
  os_unfair_lock_unlock(&self->_lock);
  return postSyncDataUpdatedNotification;
}

- (void)_handleCurrentAccessoryAddedNotification:(id)notification
{
  capabilitiesController = [(HMDHomeManager *)self capabilitiesController];
  [capabilitiesController currentAccessoryDidBecomeAvailable];

  [(HMDHomeManager *)self _updateCurrentHomeIfNecessary];
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __59__HMDHomeManager__handleCurrentAccessoryAddedNotification___block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)_handleCurrentAccessoryRemovedNotification:(id)notification
{
  notificationCopy = notification;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __61__HMDHomeManager__handleCurrentAccessoryRemovedNotification___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = notificationCopy;
  selfCopy = self;
  v6 = notificationCopy;
  dispatch_async(workQueue, v7);
}

void __61__HMDHomeManager__handleCurrentAccessoryRemovedNotification___block_invoke(uint64_t a1)
{
  v27 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 hmf_UUIDForKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

  if (v3)
  {
    v4 = *(a1 + 40);
    os_unfair_lock_lock_with_options();
    v5 = [*(a1 + 40) lastRemovedCurrentAccessoryUUID];
    v6 = [v3 hmf_isEqualToUUID:v5];

    if (v6)
    {
      os_unfair_lock_unlock(v4 + 12);
      v7 = [*(a1 + 40) capabilitiesController];
      [v7 didRemoveCurrentAccessory:v3];
    }

    else
    {
      [*(a1 + 40) setLastRemovedCurrentAccessoryUUID:v3];
      os_unfair_lock_unlock(v4 + 12);
      v13 = [*(a1 + 40) capabilitiesController];
      [v13 didRemoveCurrentAccessory:v3];

      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 40);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = HMFGetLogIdentifier();
        v23 = 138543618;
        v24 = v17;
        v25 = 2112;
        v26 = v3;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Last removed current accessory changed to %@", &v23, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v18 = [*(a1 + 40) userDefaults];
      v19 = [v3 UUIDString];
      [v18 setObject:v19 forKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

      [*(a1 + 40) resetTTSUHH2SettingsMigrationKey];
      v20 = *(a1 + 40);
      v21 = [v20 uuid];
      [v20 _updateGenerationCounterWithReason:@"CurrentAccessoryRemoved" sourceUUID:v21 shouldNotifyClients:1];
    }

    [*(a1 + 40) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 40);
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = *(a1 + 32);
      v23 = 138543618;
      v24 = v11;
      v25 = 2112;
      v26 = v12;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Last removed current accessory uuid missing from notification : %@", &v23, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (unint64_t)numHomes
{
  homes = [(HMDHomeManager *)self homes];
  v3 = [homes count];

  return v3;
}

- (BOOL)isSignedIntoiCloud
{
  v2 = +[HMDAppleAccountManager sharedManager];
  isLoggedInToPrimaryAccount = [v2 isLoggedInToPrimaryAccount];

  return isLoggedInToPrimaryAccount;
}

- (id)delegatingRouter:(id)router filteredTopics:(id)topics forRouter:(id)forRouter
{
  routerCopy = router;
  topicsCopy = topics;
  forRouterCopy = forRouter;
  v11 = objc_autoreleasePoolPush();
  array = [MEMORY[0x277CBEA60] array];
  registrationForwardingEventRouter = [(HMDHomeManager *)self registrationForwardingEventRouter];

  if (registrationForwardingEventRouter == routerCopy)
  {
    v14 = forRouterCopy;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v15 = v14;
    }

    else
    {
      v15 = 0;
    }

    v16 = v15;

    memoryEventRouter = [(HMDHomeManager *)self memoryEventRouter];
    synchronousSubscriptionProvider = [memoryEventRouter synchronousSubscriptionProvider];

    if (synchronousSubscriptionProvider == v14)
    {
      v21 = topicsCopy;
    }

    else
    {
      if (!v16)
      {
        goto LABEL_11;
      }

      identifier = [v16 identifier];

      if (!identifier)
      {
        goto LABEL_11;
      }

      identifier2 = [v16 identifier];
      v21 = [HMDHomeEventsGenerated forwardingTopicsWithTopics:topicsCopy forHomeRouterWithUUID:identifier2];

      array = identifier2;
    }

    array = v21;
LABEL_11:
  }

  objc_autoreleasePoolPop(v11);

  return array;
}

- (id)_currentHome
{
  v21 = *MEMORY[0x277D85DE8];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v4 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v17;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v17 != v6)
        {
          objc_enumerationMutation(homes);
        }

        v8 = *(*(&v16 + 1) + 8 * i);
        uuid = [v8 uuid];
        currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
        v11 = [uuid hmf_isEqualToUUID:currentHomeUUID];

        if (v11)
        {
          firstObject = v8;
          goto LABEL_11;
        }
      }

      v5 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  homes = [(HMDHomeManager *)self homes];
  firstObject = [homes firstObject];
LABEL_11:
  v13 = firstObject;

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (BOOL)isNetworkConnectionAvailable
{
  reachabilityMonitor = [(HMDHomeManager *)self reachabilityMonitor];

  if (!reachabilityMonitor)
  {
    return 0;
  }

  reachabilityMonitor2 = [(HMDHomeManager *)self reachabilityMonitor];
  isReachable = [reachabilityMonitor2 isReachable];

  return isReachable;
}

- (void)multiUserStatusController:(id)controller statusDidChange:(int64_t)change
{
  v5 = [(HMDHomeManager *)self uuid:controller];
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"MultiUserStatusChanged" sourceUUID:v5 shouldNotifyClients:1];
}

- (void)handleRemoteUserClientCloudShareRepairRequest:(id)request
{
  requestCopy = request;
  userCloudShareManager = [(HMDHomeManager *)self userCloudShareManager];
  [userCloudShareManager handleRemoteUserClientCloudShareRepairRequest:requestCopy];
}

- (void)handleRemoteUserClientCloudShareRequest:(id)request
{
  requestCopy = request;
  userCloudShareManager = [(HMDHomeManager *)self userCloudShareManager];
  [userCloudShareManager handleRemoteUserClientCloudShareRequest:requestCopy];
}

- (id)modelObjectWithChangeType:(unint64_t)type version:(int64_t)version
{
  v6 = objc_opt_class();
  uuid = [(HMDHomeManager *)self uuid];
  v8 = [v6 emptyModelObjectWithChangeType:type homeManagerUUID:uuid];

  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];

  if (primaryHomeUUID)
  {
    primaryHomeUUID2 = [(HMDHomeManager *)self primaryHomeUUID];
    uUIDString = [primaryHomeUUID2 UUIDString];
    [v8 setPrimaryHomeUUID:uUIDString];
  }

  cloudZones = [(HMDHomeManager *)self cloudZones];
  v13 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:cloudZones];
  [v8 setCloudZoneInformation:v13];

  return v8;
}

- (id)backingStoreObjects:(int64_t)objects
{
  array = [MEMORY[0x277CBEB18] array];
  v6 = [(HMDHomeManager *)self modelObjectWithChangeType:1 version:objects];
  [array addObject:v6];

  if (objects >= 3)
  {
    appData = [(HMDHomeManager *)self appData];

    if (appData)
    {
      appData2 = [(HMDHomeManager *)self appData];
      v9 = [appData2 modelObjectWithChangeType:1];
      [array addObject:v9];
    }
  }

  return array;
}

- (void)transactionObjectRemoved:(id)removed message:(id)message
{
  v44 = *MEMORY[0x277D85DE8];
  removedCopy = removed;
  messageCopy = message;
  v8 = objc_autoreleasePoolPush();
  selfCopy = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v40 = 138543618;
    v41 = v11;
    v42 = 2112;
    v43 = removedCopy;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@transactionObjectRemoved: %@", &v40, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v12 = removedCopy;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v13 = v12;
  }

  else
  {
    v13 = 0;
  }

  v14 = v13;

  if (v14)
  {
    v15 = objc_autoreleasePoolPush();
    v16 = selfCopy;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      v40 = 138543618;
      v41 = v18;
      v42 = 2112;
      v43 = v14;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@transactionObjectRemoved HMDHomeManagerHomeModel: %@", &v40, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    [(HMDHomeManager *)v16 dm_transactionObjectRemoved:v12 message:messageCopy];
    goto LABEL_37;
  }

  v19 = v12;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v20 = v19;
  }

  else
  {
    v20 = 0;
  }

  v21 = v20;

  v22 = v19;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v23 = v22;
  }

  else
  {
    v23 = 0;
  }

  v24 = v23;

  if (v24)
  {
    [(HMDHomeManager *)selfCopy processSharedHomeModelRemoved:v24 message:messageCopy];
LABEL_37:

    goto LABEL_38;
  }

  v25 = v22;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v26 = v25;
  }

  else
  {
    v26 = 0;
  }

  v27 = v26;

  if (v27)
  {
    [(HMDHomeManager *)selfCopy processCloudZoneModelRemoved:v27 message:messageCopy];
    goto LABEL_37;
  }

  v28 = v25;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v29 = v28;
  }

  else
  {
    v29 = 0;
  }

  v30 = v29;

  if (v30)
  {
    [(HMDHomeManager *)selfCopy processAppDataModelRemove:v30 message:messageCopy];
    goto LABEL_37;
  }

  v31 = v28;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v32 = v31;
  }

  else
  {
    v32 = 0;
  }

  v33 = v32;

  if (v33)
  {
    appleAccountManager = [(HMDHomeManager *)selfCopy appleAccountManager];
    account = [appleAccountManager account];
    modelIdentifier = [account modelIdentifier];
    uuid = [v33 uuid];
    if ([modelIdentifier isEqual:uuid])
    {
    }

    else
    {
      v38 = [appleAccountManager isModelCurrentAccount:v33];

      if ((v38 & 1) == 0)
      {
LABEL_36:

        goto LABEL_37;
      }
    }

    [appleAccountManager processAccountModelRemove:v33 message:messageCopy];
    goto LABEL_36;
  }

LABEL_38:

  v39 = *MEMORY[0x277D85DE8];
}

- (void)transactionObjectUpdated:(id)updated newValues:(id)values message:(id)message
{
  updatedCopy = updated;
  valuesCopy = values;
  messageCopy = message;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v10 = valuesCopy;
  }

  else
  {
    v10 = 0;
  }

  if (!v10)
  {
    v11 = valuesCopy;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v12 = v11;
    }

    else
    {
      v12 = 0;
    }

    v13 = v12;

    v14 = v11;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v15 = v14;
    }

    else
    {
      v15 = 0;
    }

    v16 = v15;

    if (v16)
    {
      [(HMDHomeManager *)self processSharedHomeModelUpdate:v16 message:messageCopy];
      goto LABEL_40;
    }

    v17 = v14;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v18 = v17;
    }

    else
    {
      v18 = 0;
    }

    v19 = v18;

    if (v19)
    {
      [(HMDHomeManager *)self processHomeManagerModelUpdate:v19 message:messageCopy];
      goto LABEL_40;
    }

    v20 = v17;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v21 = v20;
    }

    else
    {
      v21 = 0;
    }

    v22 = v21;

    if (v22)
    {
      parentUUID = [v22 parentUUID];
      appleAccountManager = [(HMDHomeManager *)self _homeWithUUID:parentUUID];

      [appleAccountManager transactionObjectUpdated:updatedCopy newValues:v22 message:messageCopy];
LABEL_24:

      goto LABEL_40;
    }

    v25 = v20;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v26 = v25;
    }

    else
    {
      v26 = 0;
    }

    v27 = v26;

    if (v27)
    {
      [(HMDHomeManager *)self processCloudZoneModelAdd:v27 message:messageCopy];
      goto LABEL_40;
    }

    v28 = v25;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v29 = v28;
    }

    else
    {
      v29 = 0;
    }

    v30 = v29;

    if (v30)
    {
      [(HMDHomeManager *)self processAppDataModelUpdate:v30 message:messageCopy];
      goto LABEL_40;
    }

    v31 = v28;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v32 = v31;
    }

    else
    {
      v32 = 0;
    }

    v33 = v32;

    if (v33)
    {
      [(HMDHomeManager *)self processMetadataModel:v33 message:messageCopy];
      goto LABEL_40;
    }

    v34 = v31;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v35 = v34;
    }

    else
    {
      v35 = 0;
    }

    v36 = v35;

    if (!v36)
    {
      goto LABEL_41;
    }

    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    account = [appleAccountManager account];
    modelIdentifier = [account modelIdentifier];
    uuid = [v36 uuid];
    if ([modelIdentifier isEqual:uuid])
    {
    }

    else
    {
      v40 = [appleAccountManager isModelCurrentAccount:v36];

      if ((v40 & 1) == 0)
      {
        goto LABEL_24;
      }
    }

    [appleAccountManager processAccountModel:v36 message:messageCopy];
    goto LABEL_24;
  }

  [(HMDHomeManager *)self dm_transactionObjectUpdated:updatedCopy newValues:valuesCopy message:messageCopy];
LABEL_40:

LABEL_41:
}

- (id)userWithMergeID:(id)d
{
  v19 = *MEMORY[0x277D85DE8];
  dCopy = d;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(homes);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) userWithMergeID:dCopy];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (void)archiveServerToken:(id)token
{
  tokenCopy = token;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __37__HMDHomeManager_archiveServerToken___block_invoke;
  block[3] = &unk_27868A728;
  v8 = tokenCopy;
  v6 = tokenCopy;
  dispatch_async(workQueue, block);
}

- (void)_remoteAccessHealthMonitorTimerDidFire:(id)fire
{
  v21 = *MEMORY[0x277D85DE8];
  fireCopy = fire;
  v5 = objc_autoreleasePoolPush();
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    *buf = 138543362;
    v20 = v7;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@Remote access health monitor timer fired, checking state for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v16 = 0u;
  v17 = 0u;
  v14 = 0u;
  v15 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v9 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v15;
    do
    {
      v12 = 0;
      do
      {
        if (*v15 != v11)
        {
          objc_enumerationMutation(homes);
        }

        [*(*(&v14 + 1) + 8 * v12++) remoteAccessHealthMonitorTimerDidFire];
      }

      while (v10 != v12);
      v10 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
    }

    while (v10);
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (void)timerDidFire:(id)fire
{
  v30 = *MEMORY[0x277D85DE8];
  fireCopy = fire;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  remoteAccessHealthMonitorTimer = [(HMDHomeManager *)self remoteAccessHealthMonitorTimer];

  if (remoteAccessHealthMonitorTimer == fireCopy)
  {
    [(HMDHomeManager *)self _remoteAccessHealthMonitorTimerDidFire:fireCopy];
  }

  else
  {
    watchPushDelayTimer = [(HMDHomeManager *)self watchPushDelayTimer];

    if (watchPushDelayTimer == fireCopy)
    {
      v15 = objc_autoreleasePoolPush();
      selfCopy = self;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = HMFGetLogIdentifier();
        v28 = 138543362;
        v29 = v18;
        _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_DEFAULT, "%{public}@Watch push delay timer fired, pushing to watches", &v28, 0xCu);
      }

      objc_autoreleasePoolPop(v15);
      [(HMDHomeManager *)selfCopy _sendHomeDataToAllWatchesWithCompletion:0];
    }

    else
    {
      debounceHomesUpdateTimer = [(HMDHomeManager *)self debounceHomesUpdateTimer];

      if (debounceHomesUpdateTimer == fireCopy)
      {
        v19 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v21 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          v22 = HMFGetLogIdentifier();
          v28 = 138543362;
          v29 = v22;
          _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Debounce homes update timer has fired, posting homed did update notification", &v28, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        [(HMDHomeManager *)selfCopy2 _notifyXPCClientsOfHomeConfigurationChange];
      }

      else
      {
        memoryMonitorLogEventTimer = [(HMDHomeManager *)self memoryMonitorLogEventTimer];

        if (memoryMonitorLogEventTimer == fireCopy)
        {
          v23 = objc_autoreleasePoolPush();
          selfCopy3 = self;
          v25 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
          {
            v26 = HMFGetLogIdentifier();
            v28 = 138543362;
            v29 = v26;
            _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Memory monitor log event timer has fired", &v28, 0xCu);
          }

          objc_autoreleasePoolPop(v23);
          [(HMDHomeManager *)selfCopy3 _monitorMemoryUsage];
          [(HMDHomeManager *)selfCopy3 _updateHomesDiscoveredBonjourServicesMetrics];
        }

        else
        {
          debounceRegenerateAssistantSyncDataTimer = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];

          if (debounceRegenerateAssistantSyncDataTimer == fireCopy)
          {
            v11 = objc_autoreleasePoolPush();
            selfCopy4 = self;
            v13 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
            {
              v14 = HMFGetLogIdentifier();
              v28 = 138543362;
              v29 = v14;
              _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_DEFAULT, "%{public}@Debounce Siri sync timer has fired, re-generating Siri sync data", &v28, 0xCu);
            }

            objc_autoreleasePoolPop(v11);
            [(HMDHomeManager *)selfCopy4 _generateAssistantSyncDataAndIncrementVersion:1 requestSync:1 urgent:0 completion:0];
          }
        }
      }
    }
  }

  v27 = *MEMORY[0x277D85DE8];
}

- (void)setupSession:(id)session didCloseWithError:(id)error
{
  sessionCopy = session;
  errorCopy = error;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __49__HMDHomeManager_setupSession_didCloseWithError___block_invoke;
  block[3] = &unk_27868A010;
  block[4] = self;
  v12 = sessionCopy;
  v13 = errorCopy;
  v9 = errorCopy;
  v10 = sessionCopy;
  dispatch_async(workQueue, block);
}

void __49__HMDHomeManager_setupSession_didCloseWithError___block_invoke(uint64_t a1)
{
  v79 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) identifier];
    v7 = *(a1 + 48);
    *buf = 138543874;
    v74 = v5;
    v75 = 2112;
    v76 = v6;
    v77 = 2112;
    v78 = v7;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Setup Session : %@, closed with error: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v2);
  v8 = [*(a1 + 40) setupTrackingInfo];
  v9 = [v8 accessoryUUID];
  if (v9)
  {
    v10 = [*(a1 + 32) accessorySetupMetricDispatcherForAccessoryUUID:v9];
    [v10 updateTrackingInfo:v8];
  }

  else
  {
    v10 = 0;
  }

  v11 = [*(a1 + 40) role] | v10;
  v72 = v11 == 0;
  if (!v11)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = [*(a1 + 40) identifier];
      *buf = 138543874;
      v74 = v15;
      v75 = 2112;
      v76 = v16;
      v77 = 2112;
      v78 = v9;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Setup Session : %@, did not find existing setup metric dispatcher for accessory uuid: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v12);
    v17 = [HMDAccessorySetupMetricDispatcher alloc];
    v18 = [*(a1 + 32) workQueue];
    v19 = [*(a1 + 40) identifier];
    v10 = [(HMDAccessorySetupMetricDispatcher *)v17 initWithQueue:v18 trackingInfo:v8 setupSessionIdentifier:v19 homeManager:*(a1 + 32)];

    [v10 setDelegate:*(a1 + 32)];
  }

  if ([*(a1 + 40) role] == 1)
  {
    v20 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];

    if (v20)
    {
      v21 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
      [v21 markSetupBeginStage:2 error:*(a1 + 48)];
    }
  }

  if (!*(a1 + 48))
  {
    if (v9)
    {
      v22 = [*(a1 + 32) accessoryWithUUID:v9];
      LODWORD(context) = v22 != 0;
      if (v22)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = *(a1 + 32);
        v25 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
        {
          v26 = HMFGetLogIdentifier();
          v27 = [*(a1 + 40) identifier];
          *buf = 138543874;
          v74 = v26;
          v75 = 2112;
          v76 = v27;
          v77 = 2112;
          v78 = v22;
          _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Submitting Repair Setup Session metric : %@ as accessory is already in the home %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v23);
        [v10 markRepairSessionComplete];
      }
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      v29 = *(a1 + 32);
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v31 = HMFGetLogIdentifier();
        v32 = [*(a1 + 40) identifier];
        *buf = 138543618;
        v74 = v31;
        v75 = 2112;
        v76 = v32;
        _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Submitting Setup Session metric : %@ as accessory was not provided in setup payload", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v28);
      LODWORD(context) = 1;
    }

    v33 = [v8 accessoryIDSIdentifier];

    if (v33)
    {
      v34 = objc_alloc(MEMORY[0x277CCAD78]);
      v35 = [v8 accessoryIDSIdentifier];
      v36 = [v34 initWithUUIDString:v35];

      if (v36)
      {
        v37 = [*(a1 + 32) accessoryWithIDSIdentifier:v36];
        if (v37)
        {
          contexta = objc_autoreleasePoolPush();
          v38 = *(a1 + 32);
          v39 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
          {
            v40 = HMFGetLogIdentifier();
            v41 = [*(a1 + 40) identifier];
            *buf = 138543874;
            v74 = v40;
            v75 = 2112;
            v76 = v41;
            v77 = 2112;
            v78 = v37;
            _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@Submitting Repair Setup Session metric : %@ as accessory with matching IDS identifier is already in the home %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(contexta);
          [v10 markRepairSessionComplete];
          LODWORD(contexta) = 1;
        }
      }
    }

    v42 = [v8 accessoryCategory];
    v43 = [v42 categoryType];
    v44 = [v43 isEqualToString:*MEMORY[0x277CCE870]];

    if (v44)
    {
      v45 = objc_autoreleasePoolPush();
      v46 = *(a1 + 32);
      v47 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v47, OS_LOG_TYPE_INFO))
      {
        v48 = HMFGetLogIdentifier();
        v49 = [*(a1 + 40) identifier];
        *buf = 138543874;
        v74 = v48;
        v75 = 2112;
        v76 = v49;
        v77 = 2112;
        v78 = v9;
        _os_log_impl(&dword_229538000, v47, OS_LOG_TYPE_INFO, "%{public}@Submitting Setup Session metric : %@ as accessory is an ATV %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v45);
    }

    else if (!contextb)
    {
      v50 = [*(a1 + 32) eventRouterAssertionController];
      v51 = [v50 takeEventRouterAssertion];

      [v10 addRemoteEventRouterAssertion:v51];
      if (v72)
      {
        [*(a1 + 32) addAccessorySetupMetricDispatcher:v10];
      }

      goto LABEL_41;
    }

    [v10 submit];
    [*(a1 + 32) removeAccessorySetupMetricDispatcherForAccessoryUUID:v9];
LABEL_41:
    v52 = [*(a1 + 40) setupTrackingInfo];
    [*(a1 + 32) setSetupEndTimestamp:{objc_msgSend(v52, "endTime")}];

    goto LABEL_42;
  }

  [v10 submit];
  [*(a1 + 32) removeAccessorySetupMetricDispatcherForAccessoryUUID:v9];
LABEL_42:
  v53 = *(a1 + 32);
  os_unfair_lock_lock_with_options();
  v54 = [*(a1 + 32) deviceSetupSessions];
  [v54 removeObject:*(a1 + 40)];

  os_unfair_lock_unlock(v53 + 12);
  if (!*(a1 + 48) && [*(a1 + 40) role] == 1)
  {
    v55 = [MEMORY[0x277CFEC78] systemStore];
    v56 = [v55 getLocalPairingIdentity:0];
    v57 = v56 == 0;

    if (!v57)
    {
      v58 = objc_autoreleasePoolPush();
      v59 = *(a1 + 32);
      v60 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v60, OS_LOG_TYPE_INFO))
      {
        v61 = HMFGetLogIdentifier();
        *buf = 138543362;
        v74 = v61;
        _os_log_impl(&dword_229538000, v60, OS_LOG_TYPE_INFO, "%{public}@Resetting legacy key transfer and starting cloud fetch", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v58);
      v62 = [MEMORY[0x277CBEB38] dictionary];
      [v62 setObject:*(a1 + 48) forKeyedSubscript:@"TTSU.error"];
      v63 = *(a1 + 32);
      v64 = [v62 copy];
      logAndPostNotification(@"TTSU.Finished.NotificationKey", v63, v64);

      v65 = [*(a1 + 32) userDefaults];
      [v65 setBool:1 forKey:@"TTSU.Finished"];
    }
  }

  if ([*(a1 + 40) role] == 1)
  {
    v66 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
    [v66 markSetupEndStage:2 error:*(a1 + 48)];

    if ([*(a1 + 32) firstCloudKitImportComplete])
    {
      v67 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
      [v67 markSetupEndStage:13 error:*(a1 + 48)];
    }
  }

  v68 = *MEMORY[0x277D85DE8];
}

- (void)setupSession:(id)session didReceiveAccessoryWithUUID:(id)d
{
  v25 = *MEMORY[0x277D85DE8];
  sessionCopy = session;
  dCopy = d;
  v8 = objc_autoreleasePoolPush();
  selfCopy = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = HMFGetLogIdentifier();
    identifier = [sessionCopy identifier];
    v19 = 138543874;
    v20 = v11;
    v21 = 2112;
    v22 = identifier;
    v23 = 2112;
    v24 = dCopy;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Setup Session : %@, received accessory uuid: %@", &v19, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  if (![sessionCopy role])
  {
    v13 = [HMDAccessorySetupMetricDispatcher alloc];
    workQueue = [(HMDHomeManager *)selfCopy workQueue];
    setupTrackingInfo = [sessionCopy setupTrackingInfo];
    identifier2 = [sessionCopy identifier];
    v17 = [(HMDAccessorySetupMetricDispatcher *)v13 initWithQueue:workQueue trackingInfo:setupTrackingInfo setupSessionIdentifier:identifier2 homeManager:selfCopy];

    [(HMDAccessorySetupMetricDispatcher *)v17 setDelegate:selfCopy];
    [(HMDHomeManager *)selfCopy addAccessorySetupMetricDispatcher:v17];
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)__handleCompanionUpdated:(id)updated
{
  v4 = +[HMDCompanionManager sharedManager];
  companion = [v4 companion];

  workQueue = [(HMDHomeManager *)self workQueue];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __43__HMDHomeManager___handleCompanionUpdated___block_invoke;
  v8[3] = &unk_27868A750;
  v9 = companion;
  selfCopy = self;
  v7 = companion;
  dispatch_async(workQueue, v8);
}

void __43__HMDHomeManager___handleCompanionUpdated___block_invoke(uint64_t a1)
{
  v29 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEBUG))
  {
    v4 = HMFGetLogIdentifier();
    v5 = *(a1 + 32);
    *buf = 138543618;
    v26 = v4;
    v27 = 2112;
    v28 = v5;
    _os_log_impl(&dword_229538000, v3, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that the companion changed: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  [*(a1 + 40) _checkAndInformCompanionDevice];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v26 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Electing companion based off of changed companion device", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v6);
  v22 = 0u;
  v23 = 0u;
  v20 = 0u;
  v21 = 0u;
  v9 = [*(a1 + 40) homes];
  v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v21;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v21 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v20 + 1) + 8 * i);
        v15 = *(a1 + 40);
        v16 = [v14 uuid];
        [v15 electRemoteAccessPeerForHome:v16];

        if (*(a1 + 32))
        {
          v17 = [v14 primaryResident];
          v18 = [v17 device];
        }

        else
        {
          v18 = 0;
        }

        [v14 resubscribeForNotificationsOnResident:v18];
      }

      v11 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v11);
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleUpdatedCurrentDevice:(id)device
{
  v36 = *MEMORY[0x277D85DE8];
  deviceCopy = device;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v33 = v8;
    v34 = 2112;
    v35 = deviceCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that current device was updated: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if (deviceCopy)
  {
    [(HMDHomeManager *)self startLocalTransport];
  }

  else
  {
    [(HMDHomeManager *)self stopLocalTransport];
  }

  v9 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v9 isResidentCapable];

  if (isResidentCapable)
  {
    if (deviceCopy)
    {
      [(HMDHomeManager *)self notifyClientsResidentCapable:1];
      if (![(HMDHomeManager *)self residentEnabledState])
      {
        productInfo = [deviceCopy productInfo];
        productClass = [productInfo productClass];

        if (productClass == 3)
        {
          v29 = 0u;
          v30 = 0u;
          v27 = 0u;
          v28 = 0u;
          homes = [(HMDHomeManager *)self homes];
          v14 = [homes countByEnumeratingWithState:&v27 objects:v31 count:16];
          if (v14)
          {
            v15 = *v28;
            while (2)
            {
              for (i = 0; i != v14; ++i)
              {
                if (*v28 != v15)
                {
                  objc_enumerationMutation(homes);
                }

                v17 = *(*(&v27 + 1) + 8 * i);
                if ([v17 isOwnerUser])
                {
                  residentCapableDevices = [v17 residentCapableDevices];
                  v19 = [residentCapableDevices containsObject:deviceCopy];

                  if (v19)
                  {
                    v22 = objc_autoreleasePoolPush();
                    selfCopy = self;
                    v24 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
                    {
                      v25 = HMFGetLogIdentifier();
                      *buf = 138543362;
                      v33 = v25;
                      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in one or more homes, enabling ourselves as a resident device", buf, 0xCu);
                    }

                    objc_autoreleasePoolPop(v22);
                    v14 = 1;
                    goto LABEL_25;
                  }
                }
              }

              v14 = [homes countByEnumeratingWithState:&v27 objects:v31 count:16];
              if (v14)
              {
                continue;
              }

              break;
            }
          }

LABEL_25:

          selfCopy3 = self;
          v21 = v14;
        }

        else
        {
          selfCopy3 = self;
          v21 = 1;
        }

        [(HMDHomeManager *)selfCopy3 _updateResidentEnabledOnThisDevice:v21 forceNotify:0 message:0];
      }
    }

    else
    {
      [(HMDHomeManager *)self notifyClientsResidentCapable:0];
    }
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (void)__handleUpdatedCurrentDevice:(id)device
{
  userInfo = [device userInfo];
  v5 = [userInfo objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  if ([v7 isCurrentDevice])
  {
    workQueue = [(HMDHomeManager *)self workQueue];
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __47__HMDHomeManager___handleUpdatedCurrentDevice___block_invoke;
    v9[3] = &unk_27868A750;
    v9[4] = self;
    v10 = v7;
    dispatch_async(workQueue, v9);
  }
}

uint64_t __47__HMDHomeManager___handleUpdatedCurrentDevice___block_invoke(uint64_t a1)
{
  [*(a1 + 32) _handleUpdatedCurrentDevice:*(a1 + 40)];
  v2 = *(a1 + 32);

  return [v2 postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
}

- (void)__handleDeviceCapabilitiesUpdated:(id)updated
{
  v20[1] = *MEMORY[0x277D85DE8];
  updatedCopy = updated;
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  device = [appleAccountManager device];

  if (device)
  {
    object = [updatedCopy object];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = object;
    }

    else
    {
      v8 = 0;
    }

    v9 = v8;

    if (v9)
    {
      capabilities = [device capabilities];

      if (capabilities == v9)
      {
        userInfo = [updatedCopy userInfo];
        v12 = MEMORY[0x277CBEB98];
        v20[0] = objc_opt_class();
        v13 = [MEMORY[0x277CBEA60] arrayWithObjects:v20 count:1];
        v14 = [v12 setWithArray:v13];
        v15 = [userInfo hmf_arrayForKey:@"HMDDeviceCapabilitiesUpdatedDifferingFieldsNotificationKey" ofClasses:v14];

        if ([v15 count])
        {
          workQueue = [(HMDHomeManager *)self workQueue];
          v18[0] = MEMORY[0x277D85DD0];
          v18[1] = 3221225472;
          v18[2] = __52__HMDHomeManager___handleDeviceCapabilitiesUpdated___block_invoke;
          v18[3] = &unk_27868A750;
          v18[4] = self;
          v19 = device;
          dispatch_async(workQueue, v18);
        }
      }
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)verifyCurrentDeviceResidentStatus
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_verifyCurrentDeviceResidentStatus__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

uint64_t __51__HMDHomeManager_verifyCurrentDeviceResidentStatus__block_invoke(uint64_t a1)
{
  result = [*(a1 + 32) isResidentCapable];
  if (result)
  {
    v3 = *(a1 + 32);
    v4 = [v3 isResidentEnabled];

    return [v3 _updateResidentEnabledOnThisDevice:v4 forceNotify:1 message:0];
  }

  return result;
}

- (void)__accountRegistryRemovedAccount:(id)account
{
  accountCopy = account;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __50__HMDHomeManager___accountRegistryRemovedAccount___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = accountCopy;
  selfCopy = self;
  v6 = accountCopy;
  dispatch_async(workQueue, v7);
}

void __50__HMDHomeManager___accountRegistryRemovedAccount___block_invoke(uint64_t a1)
{
  v19 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 40);
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v15 = 138543618;
    v16 = v9;
    v17 = 2112;
    v18 = v5;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that account was removed: %@", &v15, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if ([v5 isCurrentAccount])
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v15 = 138543362;
      v16 = v13;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@The removed account is the current account", &v15, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    [*(a1 + 40) stopLocalTransport];
    +[HMDHH2FrameworkSwitch switchBackToHH1AndDoNotLaunchDueToPrimaryAccountRemoval];
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)__accountRegistryAddedAccount:(id)account
{
  accountCopy = account;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __48__HMDHomeManager___accountRegistryAddedAccount___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = accountCopy;
  selfCopy = self;
  v6 = accountCopy;
  dispatch_async(workQueue, v7);
}

void __48__HMDHomeManager___accountRegistryAddedAccount___block_invoke(uint64_t a1)
{
  v19 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 40);
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v15 = 138543618;
    v16 = v9;
    v17 = 2112;
    v18 = v5;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that account was added: %@", &v15, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 40);
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v15 = 138543362;
    v16 = v13;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Not migrating triggers to owning device in HH2 mode.", &v15, 0xCu);
  }

  objc_autoreleasePoolPop(v10);
  v14 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchDevicesMessage:(id)message
{
  v15[1] = *MEMORY[0x277D85DE8];
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v14 = *MEMORY[0x277CD00F8];
  v6 = MEMORY[0x277CBEB98];
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];
  devices = [account devices];
  v10 = [v6 setWithArray:devices];
  v11 = encodeRootObjectForIncomingXPCMessage(v10, 0);
  v15[0] = v11;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v15 forKeys:&v14 count:1];
  [messageCopy respondWithPayload:v12];

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_notifyXPCClientsOfUpdatedDevices
{
  v27[1] = *MEMORY[0x277D85DE8];
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v4 = MEMORY[0x277D0F818];
  v5 = *MEMORY[0x277CD0100];
  v26 = *MEMORY[0x277CD00F8];
  v6 = MEMORY[0x277CBEB98];
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];
  devices = [account devices];
  v10 = [v6 setWithArray:devices];
  v11 = encodeRootObjectForIncomingXPCMessage(v10, 0);
  v27[0] = v11;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v27 forKeys:&v26 count:1];
  v13 = [v4 entitledMessageWithName:v5 messagePayload:v12];

  v14 = objc_autoreleasePoolPush();
  selfCopy = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    shortDescription = [v13 shortDescription];
    v22 = 138543618;
    v23 = v17;
    v24 = 2112;
    v25 = shortDescription;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Notifying clients of updated devices with message: %@", &v22, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
  uuid = [(HMDHomeManager *)selfCopy uuid];
  [messageDispatcher sendMessage:v13 target:uuid];

  v21 = *MEMORY[0x277D85DE8];
}

- (void)__accountRemovedDevice:(id)device
{
  deviceCopy = device;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __41__HMDHomeManager___accountRemovedDevice___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = deviceCopy;
  selfCopy = self;
  v6 = deviceCopy;
  dispatch_async(workQueue, v7);
}

void __41__HMDHomeManager___accountRemovedDevice___block_invoke(uint64_t a1)
{
  v29 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = [*(a1 + 32) userInfo];
  v6 = [v5 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if ([v4 isCurrentAccount])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v26 = v12;
      v27 = 2112;
      v28 = v8;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Received notification that device was removed from our account: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v13 = [*(a1 + 40) homes];
    v14 = [v13 countByEnumeratingWithState:&v20 objects:v24 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v21;
      do
      {
        for (i = 0; i != v15; ++i)
        {
          if (*v21 != v16)
          {
            objc_enumerationMutation(v13);
          }

          v18 = *(*(&v20 + 1) + 8 * i);
          if ([v18 isOwnerUser])
          {
            [v18 removeResidentCapableDevice:v8];
          }
        }

        v15 = [v13 countByEnumeratingWithState:&v20 objects:v24 count:16];
      }

      while (v15);
    }

    [*(a1 + 40) _checkForRemotePeers];
    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)__handleDeviceUpdatedNotification:(id)notification
{
  notificationCopy = notification;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __52__HMDHomeManager___handleDeviceUpdatedNotification___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = notificationCopy;
  selfCopy = self;
  v6 = notificationCopy;
  dispatch_async(workQueue, v7);
}

void __52__HMDHomeManager___handleDeviceUpdatedNotification___block_invoke(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 40);
  v7 = HMFGetOSLogHandle();
  v8 = v7;
  if (v4)
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v9;
      v17 = 2112;
      v18 = v4;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that device updated: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
  }

  else
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 32) object];
      v12 = [*(a1 + 32) object];
      v15 = 138543874;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      v19 = 2112;
      v20 = objc_opt_class();
      v13 = v20;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_ERROR, "%{public}@Notification object was not an HMDDevice: %@ (%@)", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)__accountAddedDevice:(id)device
{
  deviceCopy = device;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __39__HMDHomeManager___accountAddedDevice___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = deviceCopy;
  selfCopy = self;
  v6 = deviceCopy;
  dispatch_async(workQueue, v7);
}

void __39__HMDHomeManager___accountAddedDevice___block_invoke(uint64_t a1)
{
  v18 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = [*(a1 + 32) userInfo];
  v6 = [v5 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if ([v4 isCurrentAccount])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v14 = 138543618;
      v15 = v12;
      v16 = 2112;
      v17 = v8;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Received notification that device was added to our account: %@", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [*(a1 + 40) _checkForRemotePeers];
    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (id)updatedUUIDForDiscoveredUnpairedAccessory:(id)accessory
{
  v34 = *MEMORY[0x277D85DE8];
  accessoryCopy = accessory;
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = _accessoryOfCurrentDevice;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  if (!v7)
  {
    derivedSensorUUID = 0;
    goto LABEL_24;
  }

  sensorManager = [v7 sensorManager];
  v9 = sensorManager;
  if (sensorManager)
  {
    derivedHAPAccessoryIdentifier = [sensorManager derivedHAPAccessoryIdentifier];
    if (derivedHAPAccessoryIdentifier)
    {
      identifier = [accessoryCopy identifier];
      v12 = [identifier isEqualToString:derivedHAPAccessoryIdentifier];

      if (v12)
      {
        derivedSensorUUID = [v9 derivedSensorUUID];
        v14 = objc_autoreleasePoolPush();
        selfCopy = self;
        v16 = HMFGetOSLogHandle();
        v17 = v16;
        if (derivedSensorUUID)
        {
          if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
          {
            v18 = HMFGetLogIdentifier();
            uuid = [accessoryCopy uuid];
            v28 = 138543874;
            v29 = v18;
            v30 = 2112;
            v31 = uuid;
            v32 = 2112;
            v33 = derivedSensorUUID;
            _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Updating unpaired sensor accessory UUID from %@ to %@", &v28, 0x20u);
          }

          objc_autoreleasePoolPop(v14);
          v20 = derivedSensorUUID;
        }

        else
        {
          if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
          {
            v25 = HMFGetLogIdentifier();
            v28 = 138543362;
            v29 = v25;
            _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Unexpectedly did not get a derived sensor UUID for the current accessory", &v28, 0xCu);
          }

          objc_autoreleasePoolPop(v14);
        }

        goto LABEL_22;
      }
    }

    else
    {
      v21 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v23 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
      {
        v24 = HMFGetLogIdentifier();
        v28 = 138543362;
        v29 = v24;
        _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_ERROR, "%{public}@Unexpectedly did not get a derived sensor identifier for the current accessory", &v28, 0xCu);
      }

      objc_autoreleasePoolPop(v21);
    }

    derivedSensorUUID = 0;
LABEL_22:

    goto LABEL_23;
  }

  derivedSensorUUID = 0;
LABEL_23:

LABEL_24:
  v26 = *MEMORY[0x277D85DE8];

  return derivedSensorUUID;
}

- (void)accessoryBrowserDidFindNewAccessory
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __53__HMDHomeManager_accessoryBrowserDidFindNewAccessory__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)_removeAccessAllowedWhenLockedFileFromDisk
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = objc_alloc(MEMORY[0x277CBEBC0]);
  accessAllowedWhenLockedSettingFileName = [(HMDHomeManager *)self accessAllowedWhenLockedSettingFileName];
  v5 = [v3 initFileURLWithPath:accessAllowedWhenLockedSettingFileName];

  fileManager = [(HMDHomeManager *)self fileManager];
  v13 = 0;
  [fileManager removeItemAtURL:v5 error:&v13];
  v7 = v13;

  if (v7)
  {
    v8 = objc_autoreleasePoolPush();
    selfCopy = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543618;
      v15 = v11;
      v16 = 2112;
      v17 = v7;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Error occurred while removing access allowed when locked setting file from disk : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_migrateAccessAllowedWhenLockedSettingIfNeeded
{
  v56 = *MEMORY[0x277D85DE8];
  accessAllowedWhenLockedSettingFileName = [(HMDHomeManager *)self accessAllowedWhenLockedSettingFileName];
  fileManager = [(HMDHomeManager *)self fileManager];
  v5 = [fileManager fileExistsAtPath:accessAllowedWhenLockedSettingFileName];

  if (v5)
  {
    v49 = 0;
    v6 = [MEMORY[0x277CBEA90] dataWithContentsOfFile:accessAllowedWhenLockedSettingFileName options:2 error:&v49];
    v7 = v49;
    if (v6)
    {
      v8 = MEMORY[0x277CCAAC8];
      allowedClassesForAccessAllowedWhenLockedArchive = [objc_opt_class() allowedClassesForAccessAllowedWhenLockedArchive];
      v48 = v7;
      v10 = [v8 unarchivedObjectOfClasses:allowedClassesForAccessAllowedWhenLockedArchive fromData:v6 error:&v48];
      v11 = v48;

      if (v10)
      {
        v12 = v10;
        objc_opt_class();
        v13 = objc_opt_isKindOfClass() & 1;
        if (v13)
        {
          v14 = v12;
        }

        else
        {
          v14 = 0;
        }

        v15 = v14;

        v16 = objc_autoreleasePoolPush();
        selfCopy = self;
        v18 = HMFGetOSLogHandle();
        v19 = v18;
        if (v13)
        {
          if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v51 = v20;
            v52 = 2112;
            v53 = v12;
            _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Found HH1 accessAllowedWhenLocked setting : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v16);
          v21 = [v12 objectForKeyedSubscript:@"kAccessAllowedWhenLockedKey"];
          if (v21)
          {
            backingStore = [(HMDHomeManager *)selfCopy backingStore];
            context = [backingStore context];

            managedObjectContext = [context managedObjectContext];
            v45[0] = MEMORY[0x277D85DD0];
            v45[1] = 3221225472;
            v45[2] = __64__HMDHomeManager__migrateAccessAllowedWhenLockedSettingIfNeeded__block_invoke;
            v45[3] = &unk_27868A010;
            v45[4] = selfCopy;
            v46 = v21;
            v47 = managedObjectContext;
            v25 = managedObjectContext;
            [v25 performBlockAndWait:v45];
            [(HMDHomeManager *)selfCopy _removeAccessAllowedWhenLockedFileFromDisk];
          }

          else
          {
            v39 = objc_autoreleasePoolPush();
            v40 = selfCopy;
            v41 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
            {
              HMFGetLogIdentifier();
              v42 = v44 = v39;
              *buf = 138543618;
              v51 = v42;
              v52 = 2112;
              v53 = v12;
              _os_log_impl(&dword_229538000, v41, OS_LOG_TYPE_ERROR, "%{public}@That's weird. accessAllowedWhenLocked dictionary contain nil value kAccessAllowedWhenLockedKey : %@", buf, 0x16u);

              v39 = v44;
            }

            objc_autoreleasePoolPop(v39);
          }
        }

        else
        {
          if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
          {
            v38 = HMFGetLogIdentifier();
            *buf = 138543618;
            v51 = v38;
            v52 = 2112;
            v53 = v12;
            _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_ERROR, "%{public}@Unarchived data is the wrong type : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v16);
        }
      }

      else
      {
        v34 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v36 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
        {
          v37 = HMFGetLogIdentifier();
          *buf = 138543618;
          v51 = v37;
          v52 = 2112;
          v53 = v11;
          _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_ERROR, "%{public}@Unable to unarchive from disk : %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v34);
      }

      v7 = v11;
    }

    else
    {
      v30 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        v33 = HMFGetLogIdentifier();
        *buf = 138543874;
        v51 = v33;
        v52 = 2112;
        v53 = accessAllowedWhenLockedSettingFileName;
        v54 = 2112;
        v55 = v7;
        _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@Unable to read data from file : %@ / %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v30);
    }
  }

  else
  {
    v26 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      *buf = 138543618;
      v51 = v29;
      v52 = 2112;
      v53 = accessAllowedWhenLockedSettingFileName;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@HH1 accessAllowedWhenLocked setting file do not exist : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
  }

  v43 = *MEMORY[0x277D85DE8];
}

uint64_t __64__HMDHomeManager__migrateAccessAllowedWhenLockedSettingIfNeeded__block_invoke(uint64_t a1)
{
  v2 = *(a1 + 32);
  v3 = [*(a1 + 40) BOOLValue];
  v4 = *(a1 + 48);

  return [v2 _updateAccessAllowedWhenLockedToLocalStore:v3 managedObjectContext:v4];
}

- (void)_readAccessAllowedWhenLockedSettingFromLocalStore
{
  v3 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)self _migrateAccessAllowedWhenLockedSettingIfNeeded];
  objc_autoreleasePoolPop(v3);
  backingStore = [(HMDHomeManager *)self backingStore];
  context = [backingStore context];

  managedObjectContext = [context managedObjectContext];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __67__HMDHomeManager__readAccessAllowedWhenLockedSettingFromLocalStore__block_invoke;
  v8[3] = &unk_27868A750;
  v9 = managedObjectContext;
  selfCopy = self;
  v7 = managedObjectContext;
  [v7 performBlockAndWait:v8];
}

void __67__HMDHomeManager__readAccessAllowedWhenLockedSettingFromLocalStore__block_invoke(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  v2 = *(a1 + 32);
  v3 = +[MKFLocalSettings fetchRequest];
  v17 = 0;
  v4 = [v2 executeFetchRequest:v3 error:&v17];
  v5 = v17;

  v6 = [v4 firstObject];
  v7 = v6;
  if (v6 && ([v6 accessAllowedWhenLocked], v8 = objc_claimAutoreleasedReturnValue(), v8, v8))
  {
    v9 = [v7 accessAllowedWhenLocked];
    [*(a1 + 40) setAccessAllowedWhenLocked:{objc_msgSend(v9, "BOOLValue")}];

    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      [*(a1 + 40) isAccessAllowedWhenLocked];
      v14 = HMFBooleanToString();
      *buf = 138543618;
      v19 = v13;
      v20 = 2112;
      v21 = v14;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Access allowed when locked: %@", buf, 0x16u);
    }
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v19 = v15;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Did not find accessAllowedWhenLocked in local store.", buf, 0xCu);
    }
  }

  objc_autoreleasePoolPop(v10);
  v16 = *MEMORY[0x277D85DE8];
}

- (void)_saveAccessAllowedWhenLockedToLocalStore:(BOOL)store message:(id)message
{
  messageCopy = message;
  backingStore = [(HMDHomeManager *)self backingStore];
  context = [backingStore context];

  managedObjectContext = [context managedObjectContext];
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __67__HMDHomeManager__saveAccessAllowedWhenLockedToLocalStore_message___block_invoke;
  v12[3] = &unk_278685AA8;
  storeCopy = store;
  v12[4] = self;
  v13 = managedObjectContext;
  v14 = messageCopy;
  v10 = messageCopy;
  v11 = managedObjectContext;
  [v11 performBlock:v12];
}

void __67__HMDHomeManager__saveAccessAllowedWhenLockedToLocalStore_message___block_invoke(uint64_t a1)
{
  if ([*(a1 + 32) _updateAccessAllowedWhenLockedToLocalStore:*(a1 + 56) managedObjectContext:*(a1 + 40)])
  {
    [*(a1 + 32) setAccessAllowedWhenLocked:*(a1 + 56)];
    [*(a1 + 48) respondWithSuccess];
    v2 = *(a1 + 32);
    v3 = *(a1 + 56);

    [v2 notifySPIClientsAboutAccessAllowedWhenLocked:v3];
  }

  else
  {
    v4 = *(a1 + 48);
    v5 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2711];
    [v4 respondWithError:v5];
  }
}

- (id)accessAllowedWhenLockedSettingFileName
{
  v2 = MEMORY[0x277CCACA8];
  v3 = hh1ToHH2PerDeviceMigrationDirectoryPath;
  v4 = [v2 stringWithFormat:@"%@/AllowedAccessWhenLockedSetting.plist", v3];

  return v4;
}

- (void)_handleAccessAllowedWhenLockedRequest:(id)request
{
  v21 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v18 = v8;
    v19 = 2112;
    v20 = requestCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Asked to update access allowed when locked : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v16 = 0;
  v9 = [requestCopy BOOLForKey:@"kAccessAllowedWhenLockedKey" keyPresent:&v16];
  if (v16)
  {
    [(HMDHomeManager *)selfCopy _saveAccessAllowedWhenLockedToLocalStore:v9 message:requestCopy];
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    v11 = selfCopy;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v13;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Unable to find the key in the message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [requestCopy respondWithError:v14];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)_checkForSelfRemoval
{
  v17 = *MEMORY[0x277D85DE8];
  if (+[HMDDeviceCapabilities isAppleMediaAccessory])
  {
    v3 = objc_autoreleasePoolPush();
    selfCopy = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v16 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Checking for pending self removal", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    backingStore = [(HMDHomeManager *)selfCopy backingStore];
    context = [backingStore context];
    managedObjectContext = [context managedObjectContext];

    v12[0] = MEMORY[0x277D85DD0];
    v12[1] = 3221225472;
    v12[2] = __38__HMDHomeManager__checkForSelfRemoval__block_invoke;
    v12[3] = &unk_27868A750;
    v13 = managedObjectContext;
    v14 = selfCopy;
    v10 = managedObjectContext;
    [v10 performBlock:v12];
  }

  v11 = *MEMORY[0x277D85DE8];
}

void __38__HMDHomeManager__checkForSelfRemoval__block_invoke(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) hmd_coreData];
  v3 = [v2 localStore];

  if (v3)
  {
    v4 = [v3 metadata];
    v5 = [v4 hmf_UUIDForKey:@"HMDLastRemovedCurrentAccessoryMetadataKey"];
    if (v5)
    {
      v6 = objc_autoreleasePoolPush();
      v7 = *(a1 + 40);
      v8 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        v9 = HMFGetLogIdentifier();
        *buf = 138543618;
        v19 = v9;
        v20 = 2112;
        v21 = v5;
        _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@Found for pending self removal for: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v6);
      v10 = [*(a1 + 40) workQueue];
      v16[0] = MEMORY[0x277D85DD0];
      v16[1] = 3221225472;
      v16[2] = __38__HMDHomeManager__checkForSelfRemoval__block_invoke_1347;
      v16[3] = &unk_27868A750;
      v16[4] = *(a1 + 40);
      v17 = v5;
      dispatch_async(v10, v16);
    }
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 40);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v19 = v14;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Could not find local store when processing removal for AppleMediaAccessory", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __38__HMDHomeManager__checkForSelfRemoval__block_invoke_1347(uint64_t a1)
{
  v2 = [HMDSelfRemovalWatchdog alloc];
  v3 = *(a1 + 40);
  v4 = [*(a1 + 32) workQueue];
  v5 = [(HMDSelfRemovalWatchdog *)v2 initWithCurrentAccessoryUUID:v3 workQueue:v4];
  [*(a1 + 32) setSelfRemovalWatchdog:v5];

  v6 = [*(a1 + 32) selfRemovalWatchdog];
  [v6 configure];

  objc_initWeak(&location, *(a1 + 32));
  v7 = [*(a1 + 32) selfRemovalWatchdog];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __38__HMDHomeManager__checkForSelfRemoval__block_invoke_2;
  v8[3] = &unk_278687540;
  objc_copyWeak(&v10, &location);
  v9 = *(a1 + 40);
  [v7 startWithCompletion:v8];

  objc_destroyWeak(&v10);
  objc_destroyWeak(&location);
}

void __38__HMDHomeManager__checkForSelfRemoval__block_invoke_2(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v3 = [WeakRetained workQueue];
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __38__HMDHomeManager__checkForSelfRemoval__block_invoke_3;
  v4[3] = &unk_27868A750;
  v4[4] = WeakRetained;
  v5 = *(a1 + 32);
  dispatch_async(v3, v4);
}

void __38__HMDHomeManager__checkForSelfRemoval__block_invoke_3(uint64_t a1)
{
  v17 = *MEMORY[0x277D85DE8];
  [*(a1 + 32) setSelfRemovalWatchdog:0];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    *buf = 138543618;
    v14 = v5;
    v15 = 2112;
    v16 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Posting notification about current accessory removal %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = [*(a1 + 32) notificationCenter];
  v8 = *(a1 + 40);
  v11 = @"HMDLastRemovedCurrentAccessoryUUIDKey";
  v12 = v8;
  v9 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v12 forKeys:&v11 count:1];
  [v7 postNotificationName:@"HMDHomeManagerDidRemoveCurrentAccessoryNotification" object:0 userInfo:v9];

  v10 = *MEMORY[0x277D85DE8];
}

- (unint64_t)statusForMessage:(id)message
{
  v44 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v37 = 0;
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  v6 = +[HMDDeviceCapabilities deviceCapabilities];
  supportsDeviceSetup = [v6 supportsDeviceSetup];

  if (supportsDeviceSetup)
  {
    accountContext = [appleAccountManager accountContext];

    if (accountContext)
    {
      device = [appleAccountManager device];

      if (device)
      {
        goto LABEL_10;
      }

      v10 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v12 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        goto LABEL_9;
      }

      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v39 = v13;
      v14 = "%{public}@Device setup required, haven't resolved current device yet";
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v12 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
LABEL_9:

        objc_autoreleasePoolPop(v10);
        v37 = 16;
        goto LABEL_10;
      }

      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v39 = v13;
      v14 = "%{public}@Device setup required, no active account";
    }

    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, v14, buf, 0xCu);

    goto LABEL_9;
  }

LABEL_10:
  v36 = 0;
  [(HMDHomeManager *)self determineDataSyncSateForHH2:&v36 homeManagerDataSyncState:0 homeManagerStatus:&v37];
  if (v36 == 1)
  {
    v15 = v37;
    v16 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v18 = HMFGetOSLogHandle();
    v19 = os_log_type_enabled(v18, OS_LOG_TYPE_INFO);
    if ((v15 & 0x10) != 0)
    {
      if (v19)
      {
        v21 = HMFGetLogIdentifier();
        *buf = 138543362;
        v39 = v21;
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Suppressing busy status while device setup required", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
    }

    else
    {
      if (v19)
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543362;
        v39 = v20;
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Busy, data sync in progress", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      v37 |= 1uLL;
    }
  }

  accountContext2 = [appleAccountManager accountContext];

  if (!accountContext2)
  {
    v23 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v25 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
    {
      v26 = HMFGetLogIdentifier();
      *buf = 138543362;
      v39 = v26;
      _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@No account", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v23);
    v37 |= 0x20uLL;
  }

  v27 = objc_autoreleasePoolPush();
  selfCopy5 = self;
  v29 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
  {
    v30 = HMFGetLogIdentifier();
    v31 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v37];
    [appleAccountManager isLoggedInToPrimaryAccount];
    v32 = HMFBooleanToString();
    *buf = 138543874;
    v39 = v30;
    v40 = 2112;
    v41 = v31;
    v42 = 2112;
    v43 = v32;
    _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_INFO, "%{public}@status : %@, %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v27);
  v33 = v37;

  v34 = *MEMORY[0x277D85DE8];
  return v33;
}

- (id)_statusPayloadForMessage:(id)message
{
  v51 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  unsignedIntegerValue = 0;
  unsignedIntegerValue2 = [(HMDHomeManager *)self statusForMessage:messageCopy];
  v38 = 0;
  [(HMDHomeManager *)self determineDataSyncSateForHH2:&v38 homeManagerDataSyncState:&unsignedIntegerValue homeManagerStatus:&unsignedIntegerValue2];
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = HMFBooleanToString();
    v10 = HMHomeManagerDataSyncStateToString();
    v11 = HMHomeManagerStatusToString();
    *buf = 138544130;
    v44 = v8;
    v45 = 2112;
    v46 = v9;
    v47 = 2112;
    v48 = v10;
    v49 = 2112;
    v50 = v11;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@[CloudProgress: %@] [dataSyncState: %@] [HomeManager status : %@]", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v5);
  multiUserStatusController = [(HMDHomeManager *)selfCopy multiUserStatusController];
  [multiUserStatusController didUpdateDataSyncState:unsignedIntegerValue];

  if (isInternalBuild())
  {
    mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
    v14 = [mEMORY[0x277D0F8D0] preferenceForKey:@"HMDHomeManagerForceOverrideDataSyncStateAndStatus"];
    bOOLValue = [v14 BOOLValue];

    if (bOOLValue)
    {
      mEMORY[0x277D0F8D0]2 = [MEMORY[0x277D0F8D0] sharedPreferences];
      v17 = [mEMORY[0x277D0F8D0]2 preferenceForKey:@"HMDHomeManagerDataSyncStateOverride"];
      numberValue = [v17 numberValue];
      unsignedIntegerValue = [numberValue unsignedIntegerValue];

      mEMORY[0x277D0F8D0]3 = [MEMORY[0x277D0F8D0] sharedPreferences];
      v20 = [mEMORY[0x277D0F8D0]3 preferenceForKey:@"HMDHomeManagerStatusOverride"];
      numberValue2 = [v20 numberValue];
      unsignedIntegerValue2 = [numberValue2 unsignedIntegerValue];
    }
  }

  metricsManager = [(HMDHomeManager *)selfCopy metricsManager];
  deviceStateManager = [metricsManager deviceStateManager];
  [deviceStateManager updateWithDataSyncState:unsignedIntegerValue];

  metricsManager2 = [(HMDHomeManager *)selfCopy metricsManager];
  deviceStateManager2 = [metricsManager2 deviceStateManager];
  [deviceStateManager2 updateWithHomeManagerStatus:unsignedIntegerValue2];

  metricsManager3 = [(HMDHomeManager *)selfCopy metricsManager];
  deviceStateManager3 = [metricsManager3 deviceStateManager];
  hh2FrameworkSwitch = [(HMDHomeManager *)selfCopy hh2FrameworkSwitch];
  [deviceStateManager3 updateHH2SentinelZoneExists:{objc_msgSend(hh2FrameworkSwitch, "checkExistenceOfHH2SentinelZone")}];

  v41[0] = *MEMORY[0x277CD00D8];
  v29 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:unsignedIntegerValue];
  v42[0] = v29;
  v41[1] = *MEMORY[0x277CD0398];
  v30 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:unsignedIntegerValue2];
  v42[1] = v30;
  v41[2] = @"kConfigGenerationCounterKey";
  v31 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{-[HMDHomeManager generationCounter](selfCopy, "generationCounter")}];
  v42[2] = v31;
  v41[3] = *MEMORY[0x277CD02B0];
  v32 = MEMORY[0x277CCABB0];
  multiUserStatusController2 = [(HMDHomeManager *)selfCopy multiUserStatusController];
  v34 = [v32 numberWithInteger:{objc_msgSend(multiUserStatusController2, "multiUserState")}];
  v42[3] = v34;
  v35 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v42 forKeys:v41 count:4];

  v36 = *MEMORY[0x277D85DE8];

  return v35;
}

- (void)_notifyClientsOfUpdatedStatus
{
  v22 = *MEMORY[0x277D85DE8];
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  uuid = [(HMDHomeManager *)self uuid];
  [(HMDHomeManager *)self _updateGenerationCounterWithReason:@"DataSyncStatusUpdate" sourceUUID:uuid shouldNotifyClients:0];

  v5 = objc_alloc(MEMORY[0x277D0F818]);
  v6 = *MEMORY[0x277CD03A0];
  messageDestination = [(HMDHomeManager *)self messageDestination];
  v8 = [(HMDHomeManager *)self _statusPayloadForMessage:0];
  v9 = [v5 initWithName:v6 destination:messageDestination payload:v8];

  v10 = objc_autoreleasePoolPush();
  selfCopy = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = HMFGetLogIdentifier();
    messagePayload = [v9 messagePayload];
    v18 = 138543618;
    v19 = v13;
    v20 = 2112;
    v21 = messagePayload;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Notifying clients of updated status message payload: %@", &v18, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
  [messageDispatcher sendMessage:v9];

  notificationCenter = [(HMDHomeManager *)selfCopy notificationCenter];
  [notificationCenter postNotificationName:@"HMDHomeManagerDataSyncInProgressChangedNotification" object:selfCopy];

  v17 = *MEMORY[0x277D85DE8];
}

- (BOOL)areThereAnyTTSUSessionsOngoing
{
  v18 = *MEMORY[0x277D85DE8];
  os_unfair_lock_lock_with_options();
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = MEMORY[0x277CCABB0];
    deviceSetupSessions = [(HMDHomeManager *)selfCopy deviceSetupSessions];
    v9 = [v7 numberWithUnsignedInteger:{objc_msgSend(deviceSetupSessions, "count")}];
    v14 = 138543618;
    v15 = v6;
    v16 = 2112;
    v17 = v9;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Ongoing TTSU sessions : %@", &v14, 0x16u);
  }

  objc_autoreleasePoolPop(v3);
  deviceSetupSessions2 = [(HMDHomeManager *)selfCopy deviceSetupSessions];
  hmf_isEmpty = [deviceSetupSessions2 hmf_isEmpty];

  os_unfair_lock_unlock(&self->_lock);
  v12 = *MEMORY[0x277D85DE8];
  return hmf_isEmpty ^ 1;
}

- (void)_processMetricStagesDuringSessionOpening
{
  v32 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v31 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Setup happened in HH2 directly and mark the beginning stages.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  currentAccessorySetupMetricDispatcher = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher markSetupBeginStage:13 error:0];

  currentAccessorySetupMetricDispatcher2 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher2 markSetupBeginStage:10 error:0];

  currentAccessorySetupMetricDispatcher3 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher3 markSetupBeginStage:11 error:0];

  currentAccessorySetupMetricDispatcher4 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher4 markSetupBeginStage:12 error:0];

  currentAccessorySetupMetricDispatcher5 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher5 markSetupBeginStage:9 error:0];

  appleAccountManager = [(HMDHomeManager *)selfCopy appleAccountManager];
  deviceAccountSettled = [appleAccountManager deviceAccountSettled];

  workContext = [(HMDHomeManager *)selfCopy workContext];
  v29[0] = MEMORY[0x277D85DD0];
  v29[1] = 3221225472;
  v29[2] = __58__HMDHomeManager__processMetricStagesDuringSessionOpening__block_invoke;
  v29[3] = &unk_278689CB0;
  v29[4] = selfCopy;
  v15 = [deviceAccountSettled inContext:workContext then:v29];

  appleAccountManager2 = [(HMDHomeManager *)selfCopy appleAccountManager];
  currentDeviceSettled = [appleAccountManager2 currentDeviceSettled];

  workContext2 = [(HMDHomeManager *)selfCopy workContext];
  v28[0] = MEMORY[0x277D85DD0];
  v28[1] = 3221225472;
  v28[2] = __58__HMDHomeManager__processMetricStagesDuringSessionOpening__block_invoke_1343;
  v28[3] = &unk_278689CB0;
  v28[4] = selfCopy;
  v19 = [currentDeviceSettled inContext:workContext2 then:v28];

  if ([(HMDHomeManager *)selfCopy firstCloudKitImportComplete])
  {
    v20 = objc_autoreleasePoolPush();
    v21 = selfCopy;
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      v23 = HMFGetLogIdentifier();
      *buf = 138543362;
      v31 = v23;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@First cloud imported completed and mark the end stage.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v20);
    currentAccessorySetupMetricDispatcher6 = [(HMDHomeManager *)v21 currentAccessorySetupMetricDispatcher];
    [currentAccessorySetupMetricDispatcher6 markSetupEndStage:13 error:0];
  }

  currentAccessorySetupMetricDispatcher7 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher7 markSetupEndStage:12 error:0];

  currentAccessorySetupMetricDispatcher8 = [(HMDHomeManager *)selfCopy currentAccessorySetupMetricDispatcher];
  [currentAccessorySetupMetricDispatcher8 markSetupEndStage:9 error:0];

  v27 = *MEMORY[0x277D85DE8];
}

uint64_t __58__HMDHomeManager__processMetricStagesDuringSessionOpening__block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v7;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@Device account settled and mark the end stage.", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v4);
  v8 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
  [v8 markSetupEndStage:10 error:0];

  v9 = *MEMORY[0x277D85DE8];
  return 1;
}

uint64_t __58__HMDHomeManager__processMetricStagesDuringSessionOpening__block_invoke_1343(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v7;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@Current IDS device settled and mark the end stage.", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v4);
  v8 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
  [v8 markSetupEndStage:11 error:0];

  v9 = *MEMORY[0x277D85DE8];
  return 1;
}

- (void)_handleDeviceSetupSessionOpen:(id)open
{
  v55 = *MEMORY[0x277D85DE8];
  openCopy = open;
  v47 = [openCopy uuidForKey:*MEMORY[0x277CCFCA8]];
  v5 = [openCopy numberForKey:*MEMORY[0x277CCFCC0]];
  v48 = v5;
  if (v47)
  {
    v6 = v5 == 0;
  }

  else
  {
    v6 = 1;
  }

  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Invalid message parameters", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    device = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [openCopy respondWithError:device];
  }

  else
  {
    activity = [openCopy activity];
    [(HMDHomeManager *)self setSetupActivity:activity];

    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = HMFGetLogIdentifier();
      [(HMDHomeManager *)selfCopy2 setupStartTimestamp];
      *buf = 138543618;
      v52 = v17;
      v53 = 2048;
      v54 = v18;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_DEFAULT, "%{public}@Noting setup start system time: %f", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    setupActivity = [(HMDHomeManager *)selfCopy2 setupActivity];
    [setupActivity begin];

    appleAccountManager = [(HMDHomeManager *)selfCopy2 appleAccountManager];
    device = [appleAccountManager device];

    setupActivity2 = [(HMDHomeManager *)selfCopy2 setupActivity];
    v49[0] = @"currentHomeUUID";
    currentHomeUUID = [(HMDHomeManager *)selfCopy2 currentHomeUUID];
    v23 = HMDailyRotatedUUID();
    uUIDString = [v23 UUIDString];
    v25 = uUIDString;
    v26 = @"nil current home UUID";
    if (uUIDString)
    {
      v26 = uUIDString;
    }

    v50[0] = v26;
    v49[1] = @"productClass";
    v27 = MEMORY[0x277CCABB0];
    productInfo = [device productInfo];
    v29 = [v27 numberWithInteger:{objc_msgSend(productInfo, "productClass")}];
    v50[1] = v29;
    v49[2] = @"productType";
    v30 = [MEMORY[0x277CCABB0] numberWithLong:MGGetProductType()];
    v50[2] = v30;
    v31 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v50 forKeys:v49 count:3];

    setupActivity3 = [(HMDHomeManager *)selfCopy2 setupActivity];
    [setupActivity3 markWithReason:@"HMDHomeManager._handleDeviceSetupSessionOpen"];

    integerValue = [v48 integerValue];
    if ([HMDDeviceSetupSession isRoleSupported:integerValue])
    {
      v34 = [[HMDDeviceSetupSession alloc] initWithIdentifier:v47 role:integerValue homeManager:selfCopy2];
      setupTrackingInfo = [(HMDDeviceSetupSession *)v34 setupTrackingInfo];
      -[HMDHomeManager setSetupStartTimestamp:](selfCopy2, "setSetupStartTimestamp:", [setupTrackingInfo startTime]);

      [(HMDDeviceSetupSession *)v34 setDelegate:selfCopy2];
      os_unfair_lock_lock_with_options();
      deviceSetupSessions = [(HMDHomeManager *)selfCopy2 deviceSetupSessions];
      [deviceSetupSessions addObject:v34];

      os_unfair_lock_unlock(&selfCopy2->_lock);
      v37 = objc_autoreleasePoolPush();
      v38 = selfCopy2;
      v39 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
      {
        v40 = HMFGetLogIdentifier();
        identifier = [(HMDDeviceSetupSession *)v34 identifier];
        *buf = 138543618;
        v52 = v40;
        v53 = 2112;
        v54 = identifier;
        _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@New TTSU session created: [%@]", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v37);
      [openCopy respondWithSuccess];
    }

    else
    {
      v42 = objc_autoreleasePoolPush();
      v43 = selfCopy2;
      v44 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
      {
        v45 = HMFGetLogIdentifier();
        *buf = 138543618;
        v52 = v45;
        v53 = 2048;
        v54 = integerValue;
        _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Unsupported role: %tu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v42);
      v34 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
      [openCopy respondWithError:v34];
    }
  }

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_handleDeviceSetupSessionClose:(id)close
{
  v47 = *MEMORY[0x277D85DE8];
  closeCopy = close;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    LODWORD(buf) = 138543362;
    *(&buf + 4) = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received HMDHomeManager close session message", &buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [closeCopy uuidForKey:*MEMORY[0x277CCFCA8]];
  if (v9)
  {
    *&buf = 0;
    *(&buf + 1) = &buf;
    v45 = 0x2020000000;
    v46 = 0;
    v10 = objc_autoreleasePoolPush();
    v11 = selfCopy;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      deviceSetupSessions = [(HMDHomeManager *)v11 deviceSetupSessions];
      *v38 = 138543874;
      v39 = v13;
      v40 = 2112;
      v41 = v9;
      v42 = 2048;
      v43 = [deviceSetupSessions count];
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@HMDHomeManager close session %@. Total current sessions %lu", v38, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    deviceSetupSessions2 = [(HMDHomeManager *)v11 deviceSetupSessions];
    v30 = MEMORY[0x277D85DD0];
    v31 = 3221225472;
    v32 = __49__HMDHomeManager__handleDeviceSetupSessionClose___block_invoke;
    v33 = &unk_2786866A8;
    v16 = v9;
    v34 = v16;
    v35 = v11;
    v17 = closeCopy;
    v36 = v17;
    p_buf = &buf;
    [deviceSetupSessions2 hmf_enumerateWithAutoreleasePoolUsingBlock:&v30];

    if ((*(*(&buf + 1) + 24) & 1) == 0)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = v11;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v21 = HMFGetLogIdentifier();
        v22 = [(HMDHomeManager *)v19 deviceSetupSessions:v30];
        v23 = [v22 count];
        *v38 = 138543874;
        v39 = v21;
        v40 = 2112;
        v41 = v16;
        v42 = 2048;
        v43 = v23;
        _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@Didn't close session %@ due to session not found (already closed?). Total current sessions %lu", v38, 0x20u);
      }

      objc_autoreleasePoolPop(v18);
      [v17 respondWithSuccess];
    }

    _Block_object_dispose(&buf, 8);
  }

  else
  {
    v24 = objc_autoreleasePoolPush();
    v25 = selfCopy;
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      v27 = HMFGetLogIdentifier();
      LODWORD(buf) = 138543362;
      *(&buf + 4) = v27;
      _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_ERROR, "%{public}@Received close session message without UUID. Respond with error.", &buf, 0xCu);
    }

    objc_autoreleasePoolPop(v24);
    v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [closeCopy respondWithError:v28];
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __49__HMDHomeManager__handleDeviceSetupSessionClose___block_invoke(uint64_t a1, void *a2, uint64_t a3, _BYTE *a4)
{
  v19 = *MEMORY[0x277D85DE8];
  v6 = a2;
  v7 = [v6 identifier];
  v8 = [v7 isEqual:*(a1 + 32)];

  if (v8)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v13 = [v6 identifier];
      v15 = 138543618;
      v16 = v12;
      v17 = 2112;
      v18 = v13;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Found close session: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [v6 close:*(a1 + 48)];
    *a4 = 1;
    *(*(*(a1 + 56) + 8) + 24) = 1;
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_handleRemoveAllHomeKitPairingIdentities:(id)identities
{
  v39 = *MEMORY[0x277D85DE8];
  identitiesCopy = identities;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v36 = v8;
    v37 = 2112;
    v38 = identitiesCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Going to delete all the HomeKit pairing identities before TTSU: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  if (!systemStore)
  {
    v22 = objc_autoreleasePoolPush();
    v23 = selfCopy;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v25;
      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_ERROR, "%{public}@Could not find key chain store instance.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v22);
    v20 = MEMORY[0x277CCA9B8];
    v21 = 20;
    goto LABEL_13;
  }

  defaultStore = [MEMORY[0x277CB8F48] defaultStore];
  aa_primaryAppleAccount = [defaultStore aa_primaryAppleAccount];

  if (aa_primaryAppleAccount)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = selfCopy;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v15;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@Cannot remove all the keys as the primary account is logged in.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    v16 = objc_autoreleasePoolPush();
    v17 = v13;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_FAULT))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v19;
      _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_FAULT, "%{public}@Remove All HomeKit Pairing Identity was called with a logged in Account : ", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v20 = MEMORY[0x277CCA9B8];
    v21 = 10;
LABEL_13:
    v26 = [v20 hmErrorWithCode:v21];
    [identitiesCopy respondWithError:v26];
    goto LABEL_14;
  }

  v34 = 0;
  v28 = [systemStore removeControllerKeyPairLeaveTombstone:0 error:&v34];
  v26 = v34;
  if (v28)
  {
    [identitiesCopy respondWithSuccess];
  }

  else
  {
    v29 = objc_autoreleasePoolPush();
    v30 = selfCopy;
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543618;
      v36 = v32;
      v37 = 2112;
      v38 = v26;
      _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_ERROR, "%{public}@Failed to remove all the HomeKit pairing identities : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
    v33 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [identitiesCopy respondWithError:v33];
  }

LABEL_14:

  v27 = *MEMORY[0x277D85DE8];
}

- (void)removeAllHomeKitPairingIdentitiesAfterSignOut
{
  v3 = [MEMORY[0x277D0F818] messageWithName:@"removeAllHomeKitPairingIdentitiesDueToSignOut" messagePayload:MEMORY[0x277CBEC10]];
  [(HMDHomeManager *)self _handleRemoveAllHomeKitPairingIdentities:v3];
}

- (double)setupEndTimestamp
{
  os_unfair_lock_lock_with_options();
  setupEndTimestamp = self->_setupEndTimestamp;
  os_unfair_lock_unlock(&self->_lock);
  return setupEndTimestamp;
}

- (void)setSetupEndTimestamp:(double)timestamp
{
  v17 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543618;
    v14 = v8;
    v15 = 2048;
    timestampCopy = timestamp;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Saving current accessory setup end timestamp: %f", &v13, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
  v10 = userDefaults;
  if (fabs(timestamp) >= 2.22044605e-16)
  {
    v11 = [MEMORY[0x277CCABB0] numberWithDouble:timestamp];
    [v10 setObject:v11 forKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
  }

  else
  {
    [userDefaults removeObjectForKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
  }

  os_unfair_lock_lock_with_options();
  selfCopy->_setupEndTimestamp = timestamp;
  os_unfair_lock_unlock(&selfCopy->_lock);
  v12 = *MEMORY[0x277D85DE8];
}

- (double)setupStartTimestamp
{
  os_unfair_lock_lock_with_options();
  setupStartTimestamp = self->_setupStartTimestamp;
  os_unfair_lock_unlock(&self->_lock);
  return setupStartTimestamp;
}

- (void)setSetupStartTimestamp:(double)timestamp
{
  v17 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543618;
    v14 = v8;
    v15 = 2048;
    timestampCopy = timestamp;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Saving current accessory setup timestamp: %f", &v13, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
  v10 = userDefaults;
  if (fabs(timestamp) >= 2.22044605e-16)
  {
    v11 = [MEMORY[0x277CCABB0] numberWithDouble:timestamp];
    [v10 setObject:v11 forKey:@"HMDCurrentAccessorySetupStartUptimeKey"];
  }

  else
  {
    [userDefaults removeObjectForKey:@"HMDCurrentAccessorySetupStartUptimeKey"];

    [(HMDHomeManager *)selfCopy setSetupEndTimestamp:0.0];
  }

  os_unfair_lock_lock_with_options();
  selfCopy->_setupStartTimestamp = timestamp;
  os_unfair_lock_unlock(&selfCopy->_lock);
  v12 = *MEMORY[0x277D85DE8];
}

- (void)pingDevice:(id)device secure:(BOOL)secure restrictToLocalNetwork:(BOOL)network completionHandler:(id)handler
{
  networkCopy = network;
  deviceCopy = device;
  handlerCopy = handler;
  v12 = [HMDRemoteDeviceMessageDestination alloc];
  uuid = [(HMDHomeManager *)self uuid];
  v14 = [(HMDRemoteDeviceMessageDestination *)v12 initWithTarget:uuid device:deviceCopy];

  if (secure)
  {
    if (networkCopy)
    {
      v15 = 8;
    }

    else
    {
      v15 = -1;
    }

    v16 = [HMDRemoteMessage secureMessageWithName:@"kPingInternalRequestKey" qualityOfService:25 destination:v14 messagePayload:MEMORY[0x277CBEC10] restriction:v15];
  }

  else
  {
    globalHandles = [deviceCopy globalHandles];
    v18 = [globalHandles count];

    if (v18 == 1)
    {
      globalHandles2 = [deviceCopy globalHandles];
      firstObject = [globalHandles2 firstObject];
      [(HMDRemoteDeviceMessageDestination *)v14 setPreferredHandle:firstObject];
    }

    if (networkCopy)
    {
      v21 = 8;
    }

    else
    {
      v21 = -1;
    }

    v16 = [HMDRemoteMessage messageWithName:@"kPingInternalRequestKey" qualityOfService:25 destination:v14 messagePayload:MEMORY[0x277CBEC10] restriction:v21];
  }

  v22 = v16;
  objc_initWeak(&location, self);
  v25[0] = MEMORY[0x277D85DD0];
  v25[1] = 3221225472;
  v25[2] = __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke;
  v25[3] = &unk_278689728;
  objc_copyWeak(&v27, &location);
  v23 = handlerCopy;
  v26 = v23;
  [v22 setResponseHandler:v25];
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  [messageDispatcher sendMessage:v22 completionHandler:0];

  objc_destroyWeak(&v27);
  objc_destroyWeak(&location);
}

void __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v8 = objc_autoreleasePoolPush();
  v9 = WeakRetained;
  v10 = HMFGetOSLogHandle();
  v11 = v10;
  if (v5)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v23 = v12;
      v24 = 2112;
      v25 = v5;
      v13 = "%{public}@Failed to respond to ping with error: %@";
      v14 = v11;
      v15 = OS_LOG_TYPE_DEFAULT;
      v16 = 22;
LABEL_6:
      _os_log_impl(&dword_229538000, v14, v15, v13, buf, v16);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v12 = HMFGetLogIdentifier();
    *buf = 138543362;
    v23 = v12;
    v13 = "%{public}@Successfully responded to ping";
    v14 = v11;
    v15 = OS_LOG_TYPE_INFO;
    v16 = 12;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v8);
  if (v9 && *(a1 + 32))
  {
    v17 = [v9 workQueue];
    v19[0] = MEMORY[0x277D85DD0];
    v19[1] = 3221225472;
    v19[2] = __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke_1322;
    v19[3] = &unk_27868A7A0;
    v21 = *(a1 + 32);
    v20 = v5;
    dispatch_async(v17, v19);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handlePing:(id)ping
{
  v54 = *MEMORY[0x277D85DE8];
  pingCopy = ping;
  v5 = [pingCopy uuidForKey:@"kIdentifierKey"];
  if (v5)
  {
    v34 = pingCopy;
    selfCopy = self;
    v46 = 0u;
    v47 = 0u;
    v44 = 0u;
    v45 = 0u;
    accountRegistry = [(HMDHomeManager *)self accountRegistry];
    accounts = [accountRegistry accounts];

    obj = accounts;
    v8 = [accounts countByEnumeratingWithState:&v44 objects:v53 count:16];
    if (v8)
    {
      v9 = v8;
      v37 = *v45;
      while (2)
      {
        for (i = 0; i != v9; ++i)
        {
          if (*v45 != v37)
          {
            objc_enumerationMutation(obj);
          }

          v11 = *(*(&v44 + 1) + 8 * i);
          v40 = 0u;
          v41 = 0u;
          v42 = 0u;
          v43 = 0u;
          devices = [v11 devices];
          v13 = [devices countByEnumeratingWithState:&v40 objects:v52 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v41;
LABEL_9:
            v16 = 0;
            while (1)
            {
              if (*v41 != v15)
              {
                objc_enumerationMutation(devices);
              }

              v17 = *(*(&v40 + 1) + 8 * v16);
              identifier = [v17 identifier];
              v19 = [identifier isEqual:v5];

              if (v19)
              {
                break;
              }

              if (v14 == ++v16)
              {
                v14 = [devices countByEnumeratingWithState:&v40 objects:v52 count:16];
                if (v14)
                {
                  goto LABEL_9;
                }

                goto LABEL_15;
              }
            }

            v20 = v17;

            if (!v20)
            {
              continue;
            }

            pingCopy = v34;
            if ([v34 BOOLForKey:*MEMORY[0x277CD02A8]])
            {
              v29 = +[HMDSecureRemoteMessageTransport defaultTransport];
              deviceMonitor = [v29 deviceMonitor];

              [deviceMonitor startMonitoringDevice:v20 withInitialReachability:0 forClient:selfCopy];
            }

            v31 = [v34 BOOLForKey:*MEMORY[0x277CD0358]];
            v32 = [v34 BOOLForKey:*MEMORY[0x277CD0290]];
            v38[0] = MEMORY[0x277D85DD0];
            v38[1] = 3221225472;
            v38[2] = __30__HMDHomeManager__handlePing___block_invoke;
            v38[3] = &unk_27868A250;
            v39 = v34;
            [(HMDHomeManager *)selfCopy pingDevice:v20 secure:v31 restrictToLocalNetwork:v32 completionHandler:v38];

            goto LABEL_29;
          }

LABEL_15:
        }

        v9 = [obj countByEnumeratingWithState:&v44 objects:v53 count:16];
        if (v9)
        {
          continue;
        }

        break;
      }
    }

    v21 = objc_autoreleasePoolPush();
    v22 = selfCopy;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543618;
      v49 = v24;
      v50 = 2112;
      v51 = v5;
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_ERROR, "%{public}@Failed to find device with identifier: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v21);
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    pingCopy = v34;
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543362;
      v49 = v28;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_ERROR, "%{public}@Message is missing device identifier", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v25);
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
  }

  [pingCopy respondWithError:v20];
LABEL_29:

  v33 = *MEMORY[0x277D85DE8];
}

void __30__HMDHomeManager__handlePing___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = [*(a1 + 32) responseHandler];

  if (v3)
  {
    v4 = [*(a1 + 32) responseHandler];
    (v4)[2](v4, v5, 0);
  }
}

- (void)_handleRemoveAccount:(id)account
{
  v79 = *MEMORY[0x277D85DE8];
  accountCopy = account;
  messagePayload = [accountCopy messagePayload];
  v6 = [messagePayload valueForKey:@"kIdentifierKey"];

  if (v6)
  {
    responseHandler10 = [accountCopy uuidForKey:@"kIdentifierKey"];
    if (responseHandler10)
    {
      v68 = accountCopy;
      v72 = 0u;
      v73 = 0u;
      v70 = 0u;
      v71 = 0u;
      accountRegistry = [(HMDHomeManager *)self accountRegistry];
      accounts = [accountRegistry accounts];

      v10 = [accounts countByEnumeratingWithState:&v70 objects:v78 count:16];
      if (v10)
      {
        v11 = v10;
        v12 = *v71;
LABEL_5:
        v13 = 0;
        while (1)
        {
          if (*v71 != v12)
          {
            objc_enumerationMutation(accounts);
          }

          v14 = *(*(&v70 + 1) + 8 * v13);
          identifier = [v14 identifier];
          v15Identifier = [identifier identifier];
          v17 = [v15Identifier hmf_isEqualToUUID:responseHandler10];

          if (v17)
          {
            break;
          }

          if (v11 == ++v13)
          {
            v11 = [accounts countByEnumeratingWithState:&v70 objects:v78 count:16];
            if (v11)
            {
              goto LABEL_5;
            }

            goto LABEL_11;
          }
        }

        responseHandler = v14;

        if (!responseHandler)
        {
          goto LABEL_24;
        }

        accountCopy = v68;
        goto LABEL_19;
      }

LABEL_11:

LABEL_24:
      v34 = objc_autoreleasePoolPush();
      selfCopy = self;
      v36 = HMFGetOSLogHandle();
      accountCopy = v68;
      if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
      {
        v37 = HMFGetLogIdentifier();
        *buf = 138543618;
        v75 = v37;
        v76 = 2112;
        v77 = responseHandler10;
        _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to find matching account with identifier: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v34);
      responseHandler = [v68 responseHandler];

      if (!responseHandler)
      {
        goto LABEL_46;
      }

      v38 = 2;
    }

    else
    {
      v39 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v41 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
      {
        v42 = HMFGetLogIdentifier();
        *buf = 138543362;
        v75 = v42;
        _os_log_impl(&dword_229538000, v41, OS_LOG_TYPE_ERROR, "%{public}@Message is missing account identifier", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v39);
      responseHandler = [accountCopy responseHandler];

      if (!responseHandler)
      {
        goto LABEL_46;
      }

      v38 = 3;
    }

    v43 = MEMORY[0x277CCA9B8];
    goto LABEL_33;
  }

  messagePayload2 = [accountCopy messagePayload];
  v19 = *MEMORY[0x277CD00E8];
  v20 = [messagePayload2 valueForKey:*MEMORY[0x277CD00E8]];

  if (!v20)
  {
    v46 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v48 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      v49 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v49;
      v50 = "%{public}@Message is missing account identifier";
LABEL_42:
      _os_log_impl(&dword_229538000, v48, OS_LOG_TYPE_ERROR, v50, buf, 0xCu);
    }

LABEL_43:

    objc_autoreleasePoolPop(v46);
    responseHandler2 = [accountCopy responseHandler];

    if (!responseHandler2)
    {
      responseHandler = 0;
      goto LABEL_47;
    }

    responseHandler10 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    responseHandler3 = [accountCopy responseHandler];
    responseHandler3[2](responseHandler3, responseHandler10, 0);
    goto LABEL_45;
  }

  v21 = [accountCopy stringForKey:v19];
  if (!v21)
  {
    v46 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v48 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      v49 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v49;
      v50 = "%{public}@Message is missing account handle";
      goto LABEL_42;
    }

    goto LABEL_43;
  }

  responseHandler10 = v21;
  v22 = [HMDAccountHandle accountHandleForDestination:v21];
  if (!v22)
  {
    v57 = objc_autoreleasePoolPush();
    selfCopy5 = self;
    v59 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v59, OS_LOG_TYPE_ERROR))
    {
      v60 = HMFGetLogIdentifier();
      *buf = 138543618;
      v75 = v60;
      v76 = 2112;
      v77 = responseHandler10;
      _os_log_impl(&dword_229538000, v59, OS_LOG_TYPE_ERROR, "%{public}@Invalid account handle: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v57);
    responseHandler = [accountCopy responseHandler];

    if (!responseHandler)
    {
      goto LABEL_46;
    }

    v43 = MEMORY[0x277CCA9B8];
    v38 = 19;
LABEL_33:
    responseHandler3 = [v43 hmErrorWithCode:v38];
    responseHandler4 = [accountCopy responseHandler];
    responseHandler4[2](responseHandler4, responseHandler3, 0);

LABEL_45:
    responseHandler = 0;
    goto LABEL_46;
  }

  v23 = v22;
  v69 = 0;
  v24 = +[HMDAccountRegistry sharedRegistry];
  responseHandler = [v24 accountForHandle:v23 exists:&v69];

  if ((v69 & 1) == 0)
  {
    v61 = objc_autoreleasePoolPush();
    selfCopy6 = self;
    v63 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_ERROR))
    {
      v64 = HMFGetLogIdentifier();
      *buf = 138543618;
      v75 = v64;
      v76 = 2112;
      v77 = v23;
      _os_log_impl(&dword_229538000, v63, OS_LOG_TYPE_ERROR, "%{public}@Failed to find account with handle: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v61);
    responseHandler5 = [accountCopy responseHandler];

    if (responseHandler5)
    {
      v66 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      responseHandler6 = [accountCopy responseHandler];
      (responseHandler6)[2](responseHandler6, v66, 0);
    }

    goto LABEL_46;
  }

LABEL_19:
  isCurrentAccount = [responseHandler isCurrentAccount];
  v27 = objc_autoreleasePoolPush();
  selfCopy7 = self;
  v29 = HMFGetOSLogHandle();
  v30 = v29;
  if (isCurrentAccount)
  {
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v31;
      _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Cannot remove current account", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v27);
    responseHandler7 = [accountCopy responseHandler];

    if (responseHandler7)
    {
      responseHandler10 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
      responseHandler8 = [accountCopy responseHandler];
      responseHandler8[2](responseHandler8, responseHandler10, 0);

LABEL_46:
    }
  }

  else
  {
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      v51 = HMFGetLogIdentifier();
      shortDescription = [responseHandler shortDescription];
      *buf = 138543618;
      v75 = v51;
      v76 = 2112;
      v77 = shortDescription;
      _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_DEFAULT, "%{public}@Removing account: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v27);
    remoteAccountManager = [(HMDHomeManager *)selfCopy7 remoteAccountManager];
    [remoteAccountManager removeAccount:responseHandler];

    responseHandler9 = [accountCopy responseHandler];

    if (responseHandler9)
    {
      responseHandler10 = [accountCopy responseHandler];
      responseHandler10[2](responseHandler10, 0, 0);
      goto LABEL_46;
    }
  }

LABEL_47:

  v56 = *MEMORY[0x277D85DE8];
}

- (void)_handleResolveAccount:(id)account
{
  v27 = *MEMORY[0x277D85DE8];
  accountCopy = account;
  v5 = [accountCopy stringForKey:*MEMORY[0x277CD00E8]];
  if (v5)
  {
    responseHandler = [HMDAccountHandle accountHandleForDestination:v5];
    if (responseHandler)
    {
      objc_initWeak(location, self);
      v7 = +[HMDAccountRegistry sharedRegistry];
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __40__HMDHomeManager__handleResolveAccount___block_invoke;
      v21[3] = &unk_278686680;
      objc_copyWeak(&v23, location);
      v22 = accountCopy;
      [v7 _resolveAccountForHandle:responseHandler completionHandler:v21];

      objc_destroyWeak(&v23);
      objc_destroyWeak(location);
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      selfCopy = self;
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        *location = 138543618;
        *&location[4] = v17;
        v25 = 2112;
        v26 = v5;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Invalid account handle: %@", location, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      responseHandler = [accountCopy responseHandler];

      if (responseHandler)
      {
        v18 = [MEMORY[0x277CCA9B8] hmErrorWithCode:19];
        responseHandler2 = [accountCopy responseHandler];
        (responseHandler2)[2](responseHandler2, v18, 0);

        responseHandler = 0;
      }
    }

    goto LABEL_12;
  }

  v8 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    v11 = HMFGetLogIdentifier();
    *location = 138543362;
    *&location[4] = v11;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Message is missing account handle", location, 0xCu);
  }

  objc_autoreleasePoolPop(v8);
  responseHandler3 = [accountCopy responseHandler];

  if (responseHandler3)
  {
    responseHandler = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    responseHandler4 = [accountCopy responseHandler];
    (responseHandler4)[2](responseHandler4, responseHandler, 0);

LABEL_12:
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__handleResolveAccount___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v8 = objc_autoreleasePoolPush();
  v9 = WeakRetained;
  v10 = HMFGetOSLogHandle();
  v11 = v10;
  if (v5)
  {
    if (!os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_7;
    }

    v12 = HMFGetLogIdentifier();
    v13 = [v5 shortDescription];
    v17 = 138543618;
    v18 = v12;
    v19 = 2112;
    v20 = v13;
    _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Resolved account: %@", &v17, 0x16u);
  }

  else
  {
    if (!os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v12 = HMFGetLogIdentifier();
    v17 = 138543618;
    v18 = v12;
    v19 = 2112;
    v20 = v6;
    _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_ERROR, "%{public}@Failed to resolved account with error: %@", &v17, 0x16u);
  }

LABEL_7:
  objc_autoreleasePoolPop(v8);
  v14 = [*(a1 + 32) responseHandler];

  if (v14)
  {
    v15 = [*(a1 + 32) responseHandler];
    (v15)[2](v15, v6, 0);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_removeCurrentResidentDeviceFromHomes:(id)homes
{
  v33 = *MEMORY[0x277D85DE8];
  homesCopy = homes;
  v5 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v5 isResidentCapable];

  if (isResidentCapable)
  {
    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    device = [appleAccountManager device];

    v29 = 0u;
    v30 = 0u;
    v27 = 0u;
    v28 = 0u;
    v22 = homesCopy;
    v9 = homesCopy;
    v10 = [v9 countByEnumeratingWithState:&v27 objects:v32 count:16];
    if (v10)
    {
      v11 = v10;
      v12 = *v28;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v28 != v12)
          {
            objc_enumerationMutation(v9);
          }

          v14 = *(*(&v27 + 1) + 8 * i);
          if (device)
          {
LABEL_8:
            if ([v14 isOwnerUser])
            {
              [v14 removeResidentCapableDevice:device];
            }
          }

          else
          {
            v25 = 0u;
            v26 = 0u;
            v23 = 0u;
            v24 = 0u;
            residentCapableDevices = [v14 residentCapableDevices];
            v16 = [residentCapableDevices countByEnumeratingWithState:&v23 objects:v31 count:16];
            if (v16)
            {
              v17 = v16;
              v18 = *v24;
LABEL_12:
              v19 = 0;
              while (1)
              {
                if (*v24 != v18)
                {
                  objc_enumerationMutation(residentCapableDevices);
                }

                v20 = *(*(&v23 + 1) + 8 * v19);
                if ([v20 isCurrentDevice])
                {
                  break;
                }

                if (v17 == ++v19)
                {
                  v17 = [residentCapableDevices countByEnumeratingWithState:&v23 objects:v31 count:16];
                  if (v17)
                  {
                    goto LABEL_12;
                  }

                  goto LABEL_18;
                }
              }

              device = v20;

              if (device)
              {
                goto LABEL_8;
              }
            }

            else
            {
LABEL_18:

              device = 0;
            }
          }
        }

        v11 = [v9 countByEnumeratingWithState:&v27 objects:v32 count:16];
      }

      while (v11);
    }

    homesCopy = v22;
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_addCurrentResidentDeviceToHomes:(id)homes
{
  v26 = *MEMORY[0x277D85DE8];
  homesCopy = homes;
  if ([(HMDHomeManager *)self isResidentEnabled])
  {
    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    device = [appleAccountManager device];

    capabilitiesController = [(HMDHomeManager *)self capabilitiesController];
    currentResidentCapabilities = [capabilitiesController currentResidentCapabilities];

    if (currentResidentCapabilities)
    {
      v21 = 0u;
      v22 = 0u;
      v19 = 0u;
      v20 = 0u;
      v9 = homesCopy;
      v10 = [v9 countByEnumeratingWithState:&v19 objects:v23 count:16];
      if (v10)
      {
        v11 = v10;
        v12 = *v20;
        do
        {
          for (i = 0; i != v11; ++i)
          {
            if (*v20 != v12)
            {
              objc_enumerationMutation(v9);
            }

            v14 = *(*(&v19 + 1) + 8 * i);
            if ([v14 isOwnerUser] && objc_msgSend(v14, "hasReachableAccessories"))
            {
              [v14 addResidentCapableDevice:device];
            }
          }

          v11 = [v9 countByEnumeratingWithState:&v19 objects:v23 count:16];
        }

        while (v11);
      }
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543362;
      v25 = v17;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEBUG, "%{public}@Not adding ourselves as a resident as we are disabled as a resident", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)handleHomeCurrentDeviceResidentEligibleNotification:(id)notification
{
  notificationCopy = notification;
  v5 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v5 isResidentCapable];

  if (isResidentCapable)
  {
    object = [notificationCopy object];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = object;
    }

    else
    {
      v8 = 0;
    }

    v9 = v8;

    if ([v9 hasReachableAccessories])
    {
      workQueue = [(HMDHomeManager *)self workQueue];
      v11[0] = MEMORY[0x277D85DD0];
      v11[1] = 3221225472;
      v11[2] = __70__HMDHomeManager_handleHomeCurrentDeviceResidentEligibleNotification___block_invoke;
      v11[3] = &unk_27868A750;
      v11[4] = self;
      v12 = v9;
      dispatch_async(workQueue, v11);
    }
  }
}

void __70__HMDHomeManager_handleHomeCurrentDeviceResidentEligibleNotification___block_invoke(uint64_t a1)
{
  v4[1] = *MEMORY[0x277D85DE8];
  v1 = *(a1 + 32);
  v4[0] = *(a1 + 40);
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v4 count:1];
  [v1 _addCurrentResidentDeviceToHomes:v2];

  v3 = *MEMORY[0x277D85DE8];
}

- (void)_updateResidentEnabledOnThisDevice:(BOOL)device forceNotify:(BOOL)notify message:(id)message
{
  notifyCopy = notify;
  deviceCopy = device;
  v37 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  if (![(HMDHomeManager *)self isResidentCapable])
  {
    v15 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v17 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
LABEL_15:

      objc_autoreleasePoolPop(v15);
      homes = [(HMDHomeManager *)selfCopy2 homes];
      [(HMDHomeManager *)selfCopy2 _removeCurrentResidentDeviceFromHomes:homes];
      goto LABEL_16;
    }

    v18 = HMFGetLogIdentifier();
    *buf = 138543362;
    v36 = v18;
    v19 = "%{public}@Not resident capable, removing ourselves as a resident from all homes";
    v20 = v17;
    v21 = OS_LOG_TYPE_INFO;
LABEL_14:
    _os_log_impl(&dword_229538000, v20, v21, v19, buf, 0xCu);

    goto LABEL_15;
  }

  residentEnabledState = [(HMDHomeManager *)self residentEnabledState];
  if (!deviceCopy)
  {
    if (residentEnabledState != 1)
    {
      notifyCopy = 1;
      [(HMDHomeManager *)self setResidentEnabledState:1];
    }

    v15 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v17 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_15;
    }

    v18 = HMFGetLogIdentifier();
    *buf = 138543362;
    v36 = v18;
    v19 = "%{public}@Disabled as a resident device, removing ourselves as a resident from all homes";
    v20 = v17;
    v21 = OS_LOG_TYPE_DEFAULT;
    goto LABEL_14;
  }

  if (residentEnabledState != 2)
  {
    [(HMDHomeManager *)self setResidentEnabledState:2];
    notifyCopy = 1;
  }

  v10 = objc_autoreleasePoolPush();
  selfCopy3 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543362;
    v36 = v13;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Enabled as a resident device, adding ourselves as a resident to all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v10);
  homes = [(HMDHomeManager *)selfCopy3 homes];
  [(HMDHomeManager *)selfCopy3 _addCurrentResidentDeviceToHomes:homes];
LABEL_16:

  if (messageCopy || notifyCopy)
  {
    v33 = @"kResidentEnabledKey";
    v22 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentEnabled](self, "isResidentEnabled")}];
    v34 = v22;
    v23 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v34 forKeys:&v33 count:1];

    v24 = MEMORY[0x277D0F818];
    identifier = [messageCopy identifier];
    v26 = [v24 entitledMessageWithName:@"kResidentEnabledForThisDeviceUpdatedNotificationKey" identifier:identifier messagePayload:v23];

    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    uuid = [(HMDHomeManager *)self uuid];
    v31[0] = MEMORY[0x277D85DD0];
    v31[1] = 3221225472;
    v31[2] = __73__HMDHomeManager__updateResidentEnabledOnThisDevice_forceNotify_message___block_invoke;
    v31[3] = &unk_27868A728;
    v32 = messageCopy;
    [messageDispatcher sendMessage:v26 target:uuid andInvokeCompletionHandler:v31];

    notificationCenter = [(HMDHomeManager *)self notificationCenter];
    [notificationCenter postNotificationName:@"HMDHomeManagerResidentEnabledChangedNotification" object:self userInfo:v23];
  }

  v30 = *MEMORY[0x277D85DE8];
}

void __73__HMDHomeManager__updateResidentEnabledOnThisDevice_forceNotify_message___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) responseHandler];

  if (v2)
  {
    v3 = [*(a1 + 32) responseHandler];
    (*(v3 + 2))(v3, 0, 0);
  }
}

- (void)_handleEnableResidentForThisDeviceRequest:(id)request
{
  requestCopy = request;
  v9 = 0;
  v5 = [requestCopy BOOLForKey:@"kResidentEnabledKey" keyPresent:&v9];
  if (v9 == 1)
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:v5 forceNotify:0 message:requestCopy];
  }

  else
  {
    responseHandler = [requestCopy responseHandler];

    if (responseHandler)
    {
      v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      responseHandler2 = [requestCopy responseHandler];
      (responseHandler2)[2](responseHandler2, v7, 0);
    }
  }
}

- (void)notifyClientsResidentCapable:(BOOL)capable
{
  capableCopy = capable;
  v13[1] = *MEMORY[0x277D85DE8];
  v5 = MEMORY[0x277D0F818];
  v12 = @"kResidentCapableDeviceKey";
  v6 = [MEMORY[0x277CCABB0] numberWithBool:?];
  v13[0] = v6;
  v7 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v13 forKeys:&v12 count:1];
  v8 = [v5 entitledMessageWithName:@"kResidentDeviceCapableUpdatedNotificationKey" messagePayload:v7];

  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  uuid = [(HMDHomeManager *)self uuid];
  [messageDispatcher sendMessage:v8 target:uuid andInvokeCompletionHandler:0];

  if (capableCopy && [(HMDHomeManager *)self isResidentEnabled])
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:1 forceNotify:1 message:0];
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (BOOL)isResidentEnabled
{
  isResidentCapable = [(HMDHomeManager *)self isResidentCapable];
  if (isResidentCapable)
  {
    LOBYTE(isResidentCapable) = [(HMDHomeManager *)self residentEnabledState]== 2;
  }

  return isResidentCapable;
}

- (BOOL)isResidentCapable
{
  v2 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v2 isResidentCapable];

  return isResidentCapable;
}

- (void)processAppDataModelRemove:(id)remove message:(id)message
{
  messageCopy = message;
  [(HMDHomeManager *)self setAppData:0];
  [messageCopy respondWithPayload:0];
}

- (void)processAppDataModelUpdate:(id)update message:(id)message
{
  v25 = *MEMORY[0x277D85DE8];
  updateCopy = update;
  messageCopy = message;
  appData = [(HMDHomeManager *)self appData];

  if (appData)
  {
    appData2 = [(HMDHomeManager *)self appData];
    [appData2 updateWithModel:updateCopy];
  }

  else
  {
    v10 = [HMDApplicationData alloc];
    appDataDictionary = [updateCopy appDataDictionary];
    uuid = [(HMDHomeManager *)self uuid];
    v13 = [(HMDApplicationData *)v10 initWithDictionary:appDataDictionary parentUUID:uuid];
    [(HMDHomeManager *)self setAppData:v13];

    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
    {
      v17 = HMFGetLogIdentifier();
      appDataDictionary2 = [updateCopy appDataDictionary];
      v21 = 138543618;
      v22 = v17;
      v23 = 2112;
      v24 = appDataDictionary2;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEBUG, "%{public}@Updating the application data : %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  transactionResult = [messageCopy transactionResult];
  [transactionResult markChanged];
  [messageCopy respondWithPayload:0];
  logAndPostNotification(@"HMDHomeManagerDidUpdateApplicationData", self, 0);

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_setAppDataWithMessage:(id)message
{
  v28 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v5 = @"com.apple.homekit-entitledclient.identifer";
  appData = [(HMDHomeManager *)self appData];
  v7 = [appData copy];
  v23 = 0;
  v8 = [messageCopy appDataDictionaryWithError:&v23];
  v9 = v23;
  if (v8)
  {
    v10 = objc_autoreleasePoolPush();
    selfCopy = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543618;
      v25 = v13;
      v26 = 2112;
      v27 = v8;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Client needs to set home manager appData to %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    if ([v8 count])
    {
      if (!v7)
      {
        v14 = [HMDApplicationData alloc];
        uuid = [(HMDHomeManager *)selfCopy uuid];
        v7 = [(HMDApplicationData *)v14 initWithParentUUID:uuid];
      }

      [(HMDApplicationData *)v7 setApplicationData:v8 forIdentifier:@"com.apple.homekit-entitledclient.identifer"];
      v16 = [(HMDApplicationData *)v7 modelObjectWithChangeType:1];
      v17 = v16;
      if (!appData)
      {
        [v16 setObjectChangeType:1];
      }

      if (!v17)
      {
        goto LABEL_15;
      }
    }

    else
    {
      [(HMDApplicationData *)v7 removeApplicationDataForIdentifier:@"com.apple.homekit-entitledclient.identifer"];
      if (!v7 || ([(HMDApplicationData *)v7 modelObjectWithChangeType:1], (v17 = objc_claimAutoreleasedReturnValue()) == 0))
      {
LABEL_15:
        [messageCopy respondWithPayload:0];
        goto LABEL_16;
      }
    }

    backingStore = [(HMDHomeManager *)selfCopy backingStore];
    name = [messageCopy name];
    v20 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v21 = [backingStore transaction:name options:v20];

    [v21 add:v17 withMessage:messageCopy];
    [v21 run];
  }

  else
  {
    [messageCopy respondWithError:v9];
  }

LABEL_16:

  v22 = *MEMORY[0x277D85DE8];
}

- (void)setAppDataWithMessage:(id)message
{
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __40__HMDHomeManager_setAppDataWithMessage___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = messageCopy;
  v6 = messageCopy;
  dispatch_async(workQueue, v7);
}

- (void)_handleSetAppData:(id)data
{
  dataCopy = data;
  if (![(HMDHomeManager *)self _redirectAppDataRequestToResidentWithMessage:?])
  {
    [(HMDHomeManager *)self _setAppDataWithMessage:dataCopy];
  }
}

- (BOOL)_redirectAppDataRequestToResidentWithMessage:(id)message
{
  v49 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];

  if (primaryHomeUUID)
  {
    primaryHomeUUID2 = [(HMDHomeManager *)self primaryHomeUUID];
    v8 = [(HMDHomeManager *)self _homeWithUUID:primaryHomeUUID2];

    if (v8)
    {
      if ([v8 isOwnerUser])
      {
        v42 = 0;
        v9 = [messageCopy appDataDictionaryWithError:&v42];
        v10 = v42;
        if (v9)
        {
          v11 = [messageCopy mutableCopy];
          [v11 setName:@"HMDHomeSetHomeManagerAppData"];
          v39[0] = MEMORY[0x277D85DD0];
          v39[1] = 3221225472;
          v39[2] = __63__HMDHomeManager__redirectAppDataRequestToResidentWithMessage___block_invoke;
          v39[3] = &unk_278686658;
          v39[4] = self;
          v40 = messageCopy;
          v41 = v9;
          [v11 setResponseHandler:v39];
          v12 = [HMDRemoteHomeMessageDestination alloc];
          uuid = [v8 uuid];
          uuid2 = [v8 uuid];
          v15 = [(HMDRemoteHomeMessageDestination *)v12 initWithTarget:uuid homeUUID:uuid2];

          [v11 setDestination:v15];
          v16 = objc_autoreleasePoolPush();
          selfCopy = self;
          v18 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
          {
            HMFGetLogIdentifier();
            v19 = v38 = v10;
            [v8 shortDescription];
            v20 = v37 = v16;
            shortDescription = [v11 shortDescription];
            *buf = 138543874;
            v44 = v19;
            v45 = 2112;
            v46 = v20;
            v47 = 2112;
            v48 = shortDescription;
            _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Redirecting app data request to home %@ with message %@", buf, 0x20u);

            v16 = v37;
            v10 = v38;
          }

          objc_autoreleasePoolPop(v16);
          messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
          [messageDispatcher sendMessage:v11];
        }

        else
        {
          [messageCopy respondWithError:v10];
        }

        v27 = 1;
        goto LABEL_19;
      }

      v28 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v31 = HMFGetLogIdentifier();
        *buf = 138543362;
        v44 = v31;
        v32 = "%{public}@Not redirecting app data request, we are not owners in the primary home";
        v33 = v30;
        v34 = OS_LOG_TYPE_INFO;
        goto LABEL_15;
      }
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
      {
        v31 = HMFGetLogIdentifier();
        *buf = 138543362;
        v44 = v31;
        v32 = "%{public}@Not redirecting app data request, unable to find primary home";
        v33 = v30;
        v34 = OS_LOG_TYPE_ERROR;
LABEL_15:
        _os_log_impl(&dword_229538000, v33, v34, v32, buf, 0xCu);
      }
    }

    objc_autoreleasePoolPop(v28);
    v27 = 0;
LABEL_19:

    goto LABEL_20;
  }

  v23 = objc_autoreleasePoolPush();
  selfCopy4 = self;
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
  {
    v26 = HMFGetLogIdentifier();
    *buf = 138543362;
    v44 = v26;
    _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Not redirecting app data request, no primary home", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v23);
  v27 = 0;
LABEL_20:

  v35 = *MEMORY[0x277D85DE8];
  return v27;
}

void __63__HMDHomeManager__redirectAppDataRequestToResidentWithMessage___block_invoke(id *a1, void *a2, void *a3)
{
  v40 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v5)
  {
    v7 = v5;
    if ([v7 isHMError])
    {
      if ([v7 code] == 23)
      {

LABEL_17:
        v25 = objc_autoreleasePoolPush();
        v26 = a1[4];
        v27 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
        {
          v28 = HMFGetLogIdentifier();
          *buf = 138543618;
          v37 = v28;
          v38 = 2112;
          v39 = v7;
          _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@App data request redirect request failed, handling locally: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v25);
        [a1[4] setAppDataWithMessage:a1[5]];
        goto LABEL_20;
      }

      v24 = [v7 code];

      if (v24 == 8)
      {
        goto LABEL_17;
      }
    }

    else
    {
    }

    v18 = v7;
    if ([v18 isHMFError])
    {
      v19 = [v18 code];

      if (v19 == 14)
      {
        goto LABEL_17;
      }
    }

    else
    {
    }

    v20 = objc_autoreleasePoolPush();
    v21 = a1[4];
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      v23 = HMFGetLogIdentifier();
      *buf = 138543618;
      v37 = v23;
      v38 = 2112;
      v39 = v18;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@App data request redirect request failed: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v20);
    [a1[5] respondWithError:v18];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = a1[4];
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543362;
      v37 = v11;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@App data redirect request succeeded", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v8);
    v12 = [a1[4] backingStore];
    v13 = [v12 context];

    v30[0] = MEMORY[0x277D85DD0];
    v30[1] = 3221225472;
    v30[2] = __63__HMDHomeManager__redirectAppDataRequestToResidentWithMessage___block_invoke_1319;
    v30[3] = &unk_278689550;
    v31 = v13;
    v14 = a1[6];
    v15 = a1[4];
    v16 = a1[5];
    v32 = v14;
    v33 = v15;
    v34 = v16;
    v35 = v6;
    v17 = v13;
    [v17 performBlock:v30];
  }

LABEL_20:

  v29 = *MEMORY[0x277D85DE8];
}

void __63__HMDHomeManager__redirectAppDataRequestToResidentWithMessage___block_invoke_1319(uint64_t a1)
{
  v20 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) findHomeManagerWithError:0];
  if (!v2)
  {
    _HMFPreconditionFailure();
  }

  v3 = v2;
  v4 = [v2 appDataDictionary];
  v5 = *(a1 + 40);
  v6 = HMFEqualObjects();

  if ((v6 & 1) == 0)
  {
    [v3 setAppDataDictionary:*(a1 + 40)];
    v7 = [*(a1 + 32) managedObjectContext];
    v15 = 0;
    v8 = [v7 hmd_saveWithTransactionAuthor:11 error:&v15];
    v9 = v15;

    if ((v8 & 1) == 0)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = *(a1 + 48);
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543618;
        v17 = v13;
        v18 = 2112;
        v19 = v9;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Failed to save local HMDHomeManager.appDataDictionary: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      [*(a1 + 32) reset];
    }
  }

  [*(a1 + 56) respondWithPayload:*(a1 + 64)];

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_teardownRemoteAccessForHomeCommon:(id)common isCompanion:(BOOL)companion
{
  companionCopy = companion;
  v38 = *MEMORY[0x277D85DE8];
  commonCopy = common;
  v7 = [(HMDHomeManager *)self _homeWithUUID:commonCopy];
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    uUIDString = [commonCopy UUIDString];
    *buf = 138543618;
    v35 = v10;
    v36 = 2112;
    v37 = uUIDString;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Tearing down any previously setup remote access for home: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  v13 = messageDispatcher;
  if (companionCopy)
  {
    [messageDispatcher setCompanionDevice:0 forHome:v7];
  }

  else
  {
    [messageDispatcher setRemoteAccessDevice:0 forHome:v7];
  }

  v31 = 0u;
  v32 = 0u;
  v29 = 0u;
  v30 = 0u;
  pendingRemoteSessions = [(HMDHomeManager *)self pendingRemoteSessions];
  v15 = [pendingRemoteSessions countByEnumeratingWithState:&v29 objects:v33 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v30;
LABEL_8:
    v18 = 0;
    while (1)
    {
      if (*v30 != v17)
      {
        objc_enumerationMutation(pendingRemoteSessions);
      }

      v19 = *(*(&v29 + 1) + 8 * v18);
      pendingRemoteSessions2 = [(HMDHomeManager *)self pendingRemoteSessions];
      v21 = [pendingRemoteSessions2 objectForKeyedSubscript:v19];

      if ([v21 isEqual:commonCopy])
      {
        break;
      }

      if (v16 == ++v18)
      {
        v16 = [pendingRemoteSessions countByEnumeratingWithState:&v29 objects:v33 count:16];
        if (v16)
        {
          goto LABEL_8;
        }

        goto LABEL_14;
      }
    }

    v22 = v19;

    if (!v22)
    {
      goto LABEL_20;
    }

    v23 = objc_autoreleasePoolPush();
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      uUIDString2 = [v22 UUIDString];
      *buf = 138543618;
      v35 = v25;
      v36 = 2112;
      v37 = uUIDString2;
      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Clearing pending remote session with identifier %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v23);
    pendingRemoteSessions3 = [(HMDHomeManager *)self pendingRemoteSessions];
    [pendingRemoteSessions3 removeObjectForKey:v22];
  }

  else
  {
LABEL_14:
    v22 = pendingRemoteSessions;
  }

LABEL_20:
  v28 = *MEMORY[0x277D85DE8];
}

- (void)_teardownRemoteAccessForHomeThroughCompanion:(id)companion
{
  companionCopy = companion;
  isWatch();
}

- (void)_teardownRemoteAccessForHome:(id)home
{
  homeCopy = home;
  v4 = [(HMDHomeManager *)self _homeWithUUID:?];
  residentDeviceManager = [v4 residentDeviceManager];
  isResidentAvailable = [residentDeviceManager isResidentAvailable];

  if ((isResidentAvailable & 1) == 0)
  {
    [(HMDHomeManager *)self _teardownRemoteAccessForHomeCommon:homeCopy isCompanion:0];
  }
}

- (void)teardownRemoteAccessForHome:(id)home
{
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __46__HMDHomeManager_teardownRemoteAccessForHome___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = homeCopy;
  v6 = homeCopy;
  dispatch_async(workQueue, v7);
}

- (void)addIssuerKeyToMessagePayload:(id)payload invitation:(id)invitation completion:(id)completion
{
  v37 = *MEMORY[0x277D85DE8];
  payloadCopy = payload;
  invitationCopy = invitation;
  completionCopy = completion;
  if (_os_feature_enabled_impl())
  {
    internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      uUID = [internalOnlyInitializer UUID];
      homeUUID = [invitationCopy homeUUID];
      *buf = 138543874;
      v32 = v15;
      v33 = 2112;
      v34 = uUID;
      v35 = 2112;
      v36 = homeUUID;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Creating ACWG Issuer key for newly accepted shared home: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v12);
    v18 = +[HMDCoreData sharedInstance];
    homeUUID2 = [invitationCopy homeUUID];
    v20 = [v18 contextWithHomeUUID:homeUUID2];

    v21 = +[HMDACWGKeyManager shared];
    homeUUID3 = [invitationCopy homeUUID];
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __69__HMDHomeManager_addIssuerKeyToMessagePayload_invitation_completion___block_invoke;
    v26[3] = &unk_278686630;
    v26[4] = selfCopy;
    v27 = internalOnlyInitializer;
    v28 = invitationCopy;
    v30 = completionCopy;
    v29 = payloadCopy;
    v23 = internalOnlyInitializer;
    LOBYTE(v25) = 1;
    [v21 getOrCreateIssuerKeyAndSaveToSharedUserReverseShareWithHomeUUID:homeUUID3 context:v20 shouldUpdateLocks:0 shouldRoll:0 flow:v23 requireCloudFetch:0 isOnSharedUserAcceptance:v25 completionHandler:v26];
  }

  else
  {
    (*(completionCopy + 2))(completionCopy, 0);
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_addIssuerKeyToMessagePayload_invitation_completion___block_invoke(uint64_t a1, void *a2, uint64_t a3, void *a4)
{
  v30 = *MEMORY[0x277D85DE8];
  v6 = a2;
  v7 = a4;
  if (v6)
  {
    v8 = [HMDNIST256Utilities publicKeyExternalRepresentationFromKeyPairExternalRepresentation:v6];
    [*(a1 + 56) setObject:v8 forKeyedSubscript:@"HMDIssuerPublicKeyExternalRepresentationKey"];
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 32);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v13 = [*(a1 + 40) UUID];
      v22 = 138543874;
      v23 = v12;
      v24 = 2112;
      v25 = v13;
      v26 = 2112;
      v27 = v8;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Added issuerPublicKeyER to payload. issuerPublicKeyER: %@", &v22, 0x20u);
    }

    objc_autoreleasePoolPop(v9);
    (*(*(a1 + 64) + 16))();
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = *(a1 + 32);
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      v18 = [*(a1 + 40) UUID];
      v19 = *(a1 + 48);
      v22 = 138544130;
      v23 = v17;
      v24 = 2112;
      v25 = v18;
      v26 = 2112;
      v27 = v19;
      v28 = 2112;
      v29 = v7;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@[Flow: %@] Failed to create Issuer Key while accepting home invitation: %@, with error: %@", &v22, 0x2Au);
    }

    objc_autoreleasePoolPop(v14);
    v20 = *(a1 + 64);
    if (v7)
    {
      (*(v20 + 16))(v20, v7);
      goto LABEL_10;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    (*(v20 + 16))(v20, v8);
  }

LABEL_10:
  v21 = *MEMORY[0x277D85DE8];
}

- (void)sendRequestForInvitation:(id)invitation homeUUID:(id)d payload:(id)payload invitationState:(int64_t)state responseHandler:(id)handler
{
  v40 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  dCopy = d;
  payloadCopy = payload;
  handlerCopy = handler;
  uUIDString = [dCopy UUIDString];
  [payloadCopy setValue:uUIDString forKey:*MEMORY[0x277CD0640]];

  v17 = objc_autoreleasePoolPush();
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
  {
    HMFGetLogIdentifier();
    v19 = v28 = handlerCopy;
    [invitationCopy idsInvitationUUID];
    v20 = v29 = v17;
    uUIDString2 = [v20 UUIDString];
    identifier = [invitationCopy identifier];
    [identifier UUIDString];
    v23 = v30 = self;
    [dCopy UUIDString];
    v24 = v31 = state;
    *buf = 138544130;
    v33 = v19;
    v34 = 2112;
    v35 = uUIDString2;
    v36 = 2112;
    v37 = v23;
    v38 = 2112;
    v39 = v24;
    _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Accept/decline request to admin for idsInviteUUID %@, homeInviteUUID %@ homeUUID %@", buf, 0x2Au);

    v17 = v29;
    state = v31;

    self = v30;
    handlerCopy = v28;
  }

  objc_autoreleasePoolPop(v17);
  idsInvitationUUID = [invitationCopy idsInvitationUUID];
  identifier2 = [invitationCopy identifier];
  [(HMDHomeManager *)self _sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier:idsInvitationUUID homeInviteUUID:identifier2 payload:payloadCopy invitationState:state responseHandler:handlerCopy];

  v27 = *MEMORY[0x277D85DE8];
}

- (void)__sendUpdateRequestToAdminForInvitation:(id)invitation homeUUID:(id)d invitationState:(int64_t)state authStatus:(id)status reverseShareInvitation:(id)shareInvitation logEventBuilder:(id)builder
{
  v70[2] = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  dCopy = d;
  statusCopy = status;
  shareInvitationCopy = shareInvitation;
  builderCopy = builder;
  v69[0] = @"kInvitationIdentifierKey";
  identifier = [invitationCopy identifier];
  uUIDString = [identifier UUIDString];
  v69[1] = @"kInvitationStateKey";
  v70[0] = uUIDString;
  v18 = [MEMORY[0x277CCABB0] numberWithInteger:state];
  v70[1] = v18;
  v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v70 forKeys:v69 count:2];
  v20 = [v19 mutableCopy];

  if (state != 3)
  {
LABEL_21:
    objc_initWeak(buf, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __133__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus_reverseShareInvitation_logEventBuilder___block_invoke;
    aBlock[3] = &unk_2786865E0;
    objc_copyWeak(v63, buf);
    aBlock[4] = self;
    v44 = invitationCopy;
    v61 = v44;
    v45 = builderCopy;
    v62 = v45;
    v63[1] = state;
    v46 = _Block_copy(aBlock);
    if (state == 3)
    {
      objc_initWeak(&location, self);
      v52[0] = MEMORY[0x277D85DD0];
      v52[1] = 3221225472;
      v52[2] = __133__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus_reverseShareInvitation_logEventBuilder___block_invoke_1310;
      v52[3] = &unk_278686608;
      objc_copyWeak(v58, &location);
      v53 = v45;
      v54 = v44;
      v55 = dCopy;
      v56 = v20;
      v58[1] = 3;
      v57 = v46;
      [(HMDHomeManager *)self addIssuerKeyToMessagePayload:v56 invitation:v54 completion:v52];

      objc_destroyWeak(v58);
      objc_destroyWeak(&location);
    }

    else
    {
      [(HMDHomeManager *)self sendRequestForInvitation:v44 homeUUID:dCopy payload:v20 invitationState:state responseHandler:v46];
    }

    objc_destroyWeak(v63);
    objc_destroyWeak(buf);
    goto LABEL_25;
  }

  if (!shareInvitationCopy)
  {
LABEL_8:
    if (![(HMDHomeManager *)self addHH2KeyInResponsePayload:v20 invitation:invitationCopy, v48])
    {
      v32 = objc_autoreleasePoolPush();
      selfCopy = self;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543362;
        v66 = v35;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_ERROR, "%{public}@Failed to get or create HH2 Controller key", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
    }

    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    account = [appleAccountManager account];
    primaryHandle = [account primaryHandle];

    if (primaryHandle)
    {
      v39 = +[HMDAccountHandleFormatter defaultFormatter];
      v40 = [v39 stringForObjectValue:primaryHandle];

      if (v40)
      {
        [v20 setObject:v40 forKeyedSubscript:@"kUserIDKey"];
      }
    }

    inviterAccount = [invitationCopy inviterAccount];
    if (inviterAccount)
    {
      v42 = +[HMDIdentityRegistry sharedRegistry];
      inviterIdentity = [invitationCopy inviterIdentity];
      [v42 registerIdentity:inviterIdentity account:inviterAccount object:invitationCopy];
    }

    if (statusCopy)
    {
      [statusCopy addToPayload:v20];
    }

    goto LABEL_21;
  }

  v21 = MEMORY[0x277CCAAB0];
  token = [shareInvitationCopy token];
  v64 = 0;
  v48 = [v21 archivedDataWithRootObject:token requiringSecureCoding:1 error:&v64];
  v23 = v64;

  if (!v23)
  {
    v30 = [shareInvitationCopy url];
    absoluteString = [v30 absoluteString];
    [v20 setObject:absoluteString forKeyedSubscript:@"HMDHomeInvitationShareURLKey"];

    [v20 setObject:v48 forKeyedSubscript:@"HMDHomeInvitationShareTokenKey"];
    goto LABEL_8;
  }

  v24 = [MEMORY[0x277CCA9B8] hmInternalErrorWithCode:3509 underlyingError:v23];
  [builderCopy markError:v24];

  v25 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v27 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
  {
    v28 = HMFGetLogIdentifier();
    token2 = [shareInvitationCopy token];
    *buf = 138543618;
    v66 = v28;
    v67 = 2112;
    v68 = token2;
    _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_ERROR, "%{public}@Failed to encode reverse share token %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v25);
LABEL_25:

  v47 = *MEMORY[0x277D85DE8];
}

void __133__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus_reverseShareInvitation_logEventBuilder___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v45 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 32);
    v10 = HMFGetOSLogHandle();
    v11 = os_log_type_enabled(v10, OS_LOG_TYPE_INFO);
    if (v6)
    {
      if (v11)
      {
        v12 = HMFGetLogIdentifier();
        v13 = [*(a1 + 40) describeWithFormat];
        v39 = 138543874;
        v40 = v12;
        v41 = 2112;
        v42 = v13;
        v43 = 2112;
        v44 = v6;
        _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Failed to modify invitation state for invite %@ due to error %@", &v39, 0x20u);
      }

      objc_autoreleasePoolPop(v8);
      v14 = *(a1 + 48);
      v15 = [MEMORY[0x277CCA9B8] hmInternalErrorWithCode:3510 underlyingError:v6];
      [v14 markError:v15];

      v16 = [v6 code];
      v17 = [v6 code];
      v18 = [v6 code];
      v19 = [v6 code];
      if (v17 == 1006 || v19 == 1008)
      {
        v28 = objc_autoreleasePoolPush();
        v29 = *(a1 + 32);
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
        {
          v31 = HMFGetLogIdentifier();
          v32 = [*(a1 + 40) describeWithFormat];
          v39 = 138543618;
          v40 = v31;
          v41 = 2112;
          v42 = v32;
          _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Updating invitation (%@) to expired since sender could not find it or it was expired", &v39, 0x16u);
        }

        objc_autoreleasePoolPop(v28);
        [*(a1 + 40) expire];
      }

      else if (v18 == 1007)
      {
        v20 = objc_autoreleasePoolPush();
        v21 = *(a1 + 32);
        v22 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
        {
          v23 = HMFGetLogIdentifier();
          v24 = [*(a1 + 40) describeWithFormat];
          v39 = 138543618;
          v40 = v23;
          v41 = 2112;
          v42 = v24;
          _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Updating invitation (%@) to accepted and pending to match sender state", &v39, 0x16u);
        }

        objc_autoreleasePoolPop(v20);
        [WeakRetained _postIncomingInvitationStateChangedNotification:*(a1 + 40) newInvitationState:5];
      }

      else if (v16 == 2)
      {
        v34 = objc_autoreleasePoolPush();
        v35 = *(a1 + 32);
        v36 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
        {
          v37 = HMFGetLogIdentifier();
          v38 = [*(a1 + 40) describeWithFormat];
          v39 = 138543618;
          v40 = v37;
          v41 = 2112;
          v42 = v38;
          _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_INFO, "%{public}@Inviter did not find invitation (%@), ignoring response", &v39, 0x16u);
        }

        objc_autoreleasePoolPop(v34);
      }
    }

    else
    {
      if (v11)
      {
        v25 = HMFGetLogIdentifier();
        v26 = [*(a1 + 40) describeWithFormat];
        v39 = 138543618;
        v40 = v25;
        v41 = 2112;
        v42 = v26;
        _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Modified invitation state for invite %@", &v39, 0x16u);
      }

      objc_autoreleasePoolPop(v8);
      if (*(a1 + 64) == 3)
      {
        [*(a1 + 48) markSendAcceptanceToOwnerEnd];
        [WeakRetained _postIncomingInvitationStateChangedNotification:*(a1 + 40) newInvitationState:3];
        v27 = [*(a1 + 40) homeUUID];
        [WeakRetained _maybeCreateLegacyHomeAcceptedZone:v27];
      }
    }
  }

  v33 = *MEMORY[0x277D85DE8];
}

void __133__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus_reverseShareInvitation_logEventBuilder___block_invoke_1310(uint64_t a1, void *a2)
{
  v6 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (WeakRetained)
  {
    v4 = *(a1 + 32);
    if (v6)
    {
      v5 = [MEMORY[0x277CCA9B8] hmInternalErrorWithCode:3508 underlyingError:v6];
      [v4 markError:v5];
    }

    else
    {
      [v4 markSendAcceptanceToOwnerBegin];
      [WeakRetained sendRequestForInvitation:*(a1 + 40) homeUUID:*(a1 + 48) payload:*(a1 + 56) invitationState:*(a1 + 80) responseHandler:*(a1 + 64)];
    }
  }
}

- (void)_sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier:(id)identifier homeInviteUUID:(id)d payload:(id)payload invitationState:(int64_t)state responseHandler:(id)handler
{
  identifierCopy = identifier;
  dCopy = d;
  payloadCopy = payload;
  handlerCopy = handler;
  if (state == 4)
  {
    idsInvitationManager = [(HMDHomeManager *)self idsInvitationManager];
    v18[0] = MEMORY[0x277D85DD0];
    v18[1] = 3221225472;
    v18[2] = __134__HMDHomeManager__sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier_homeInviteUUID_payload_invitationState_responseHandler___block_invoke_2;
    v18[3] = &unk_2786865B8;
    v17 = &v19;
    v19 = handlerCopy;
    [idsInvitationManager declineInvitationWithIDSIdentifier:identifierCopy homeInvitationID:dCopy completionBlock:v18];
    goto LABEL_5;
  }

  if (state == 3)
  {
    idsInvitationManager = [(HMDHomeManager *)self idsInvitationManager];
    v20[0] = MEMORY[0x277D85DD0];
    v20[1] = 3221225472;
    v20[2] = __134__HMDHomeManager__sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier_homeInviteUUID_payload_invitationState_responseHandler___block_invoke;
    v20[3] = &unk_2786865B8;
    v17 = &v21;
    v21 = handlerCopy;
    [idsInvitationManager acceptInvitationWithIDSIdentifier:identifierCopy homeInvitationID:dCopy dictionary:payloadCopy completionBlock:v20];
LABEL_5:
  }
}

uint64_t __134__HMDHomeManager__sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier_homeInviteUUID_payload_invitationState_responseHandler___block_invoke(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))(result, @"IncomingInvitationAccepted");
  }

  return result;
}

uint64_t __134__HMDHomeManager__sendAcceptOrDeclineRequestToAdminForIDSInvitationIdentifier_homeInviteUUID_payload_invitationState_responseHandler___block_invoke_2(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))(result, @"IncomingInvitationDeclined", 0);
  }

  return result;
}

- (BOOL)getOrCreateControllerPublicKey:(id *)key controllerUsername:(id *)username error:(id *)error
{
  v30 = *MEMORY[0x277D85DE8];
  v25 = 0;
  v9 = [(HMDHomeManager *)self getOrCreateLocalPairingIdentity:&v25];
  v10 = v25;
  v11 = v10;
  if (v10)
  {
    if (error)
    {
      v12 = v10;
      *error = v11;
    }

    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v16 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v16;
    v28 = 2112;
    v29 = v11;
    v17 = "%{public}@Failed to get or create local pairing identity: %@";
    v18 = v15;
    v19 = OS_LOG_TYPE_INFO;
    v20 = 22;
    goto LABEL_6;
  }

  if (!v9)
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_7;
    }

    v16 = HMFGetLogIdentifier();
    *buf = 138543362;
    v27 = v16;
    v17 = "%{public}@Unable to get identity but no error provided";
    v18 = v15;
    v19 = OS_LOG_TYPE_DEFAULT;
    v20 = 12;
LABEL_6:
    _os_log_impl(&dword_229538000, v18, v19, v17, buf, v20);

LABEL_7:
    objc_autoreleasePoolPop(v13);
    v21 = 0;
    goto LABEL_14;
  }

  if (key)
  {
    publicKey = [v9 publicKey];
    *key = [publicKey data];
  }

  if (username)
  {
    *username = [v9 identifier];
  }

  v21 = 1;
LABEL_14:

  v23 = *MEMORY[0x277D85DE8];
  return v21;
}

- (id)getOrCreateLocalPairingIdentity:(id *)identity
{
  v78 = *MEMORY[0x277D85DE8];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v70 = 0;
  v71 = 0;
  v68 = 0;
  v69 = 0;
  v5 = [systemStore getAllAvailableControllerPublicKeys:&v71 secretKeys:&v70 userNames:&v69 error:&v68];
  v6 = v71;
  v7 = v70;
  v8 = v69;
  v9 = v68;

  if (v5)
  {
    v10 = v9 == 0;
  }

  else
  {
    v10 = 0;
  }

  if (v10 && v6 != 0 && v8 != 0)
  {
    if ([v8 count])
    {
      v13 = [v8 count];
      if (v13 == [v6 count])
      {
        v14 = [v6 objectAtIndexedSubscript:0];
        v15 = [v7 objectAtIndexedSubscript:0];
        v16 = [v8 objectAtIndexedSubscript:0];
        if ([v8 count] < 2)
        {
          systemStore2 = [MEMORY[0x277CFEC78] systemStore];
          activeControllerPairingIdentifier = [systemStore2 activeControllerPairingIdentifier];

          if (activeControllerPairingIdentifier)
          {
LABEL_34:
            identityCopy2 = identity;
            goto LABEL_35;
          }

          v59 = v7;
          v17 = objc_autoreleasePoolPush();
          selfCopy = self;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v75 = v20;
            v76 = 2112;
            v77 = v16;
            v21 = "%{public}@Setting controller key as active as none was found: %@";
            goto LABEL_32;
          }
        }

        else
        {
          v59 = v7;
          v17 = objc_autoreleasePoolPush();
          selfCopy2 = self;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v75 = v20;
            v76 = 2112;
            v77 = v16;
            v21 = "%{public}@Found multiple controller keys, using first entry as the controller username: %@";
LABEL_32:
            _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_DEFAULT, v21, buf, 0x16u);
          }
        }

        objc_autoreleasePoolPop(v17);
        systemStore3 = [MEMORY[0x277CFEC78] systemStore];
        [systemStore3 updateActiveControllerPairingIdentifier:v16];

        v7 = v59;
        goto LABEL_34;
      }
    }
  }

  v22 = +[HMDDeviceCapabilities deviceCapabilities];
  supportsKeychainSync = [v22 supportsKeychainSync];

  if (!supportsKeychainSync)
  {
    v30 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    v16 = 0;
    v15 = 0;
    v14 = 0;
LABEL_24:

    goto LABEL_26;
  }

  v60 = v7;
  v24 = objc_autoreleasePoolPush();
  selfCopy3 = self;
  v26 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    v27 = HMFGetLogIdentifier();
    *buf = 138543362;
    v75 = v27;
    _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_DEFAULT, "%{public}@Local controller key does not exist, creating one", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v24);
  systemStore4 = [MEMORY[0x277CFEC78] systemStore];
  v66 = 0;
  v67 = 0;
  v64 = v9;
  v65 = 0;
  v29 = [systemStore4 getControllerPublicKey:&v67 secretKey:&v66 username:&v65 allowCreation:1 error:&v64];
  v14 = v67;
  v15 = v66;
  v16 = v65;
  v30 = v64;

  if (v29)
  {
    v31 = objc_autoreleasePoolPush();
    v32 = selfCopy3;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v34;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_DEFAULT, "%{public}@Created new local controller key, forcing push to HomeManager zone to anchor key...", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v31);
    v35 = [HMDHomeManagerModel alloc];
    uuid = [(HMDHomeManager *)v32 uuid];
    v9 = [(HMDBackingStoreModelObject *)v35 initWithObjectChangeType:1 uuid:uuid parentUUID:0];

    [(HMDHomeManagerModel *)v9 setControllerKeyIdentifier:v16];
    backingStore = [(HMDHomeManager *)v32 backingStore];
    v38 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v39 = [backingStore transaction:@"HMD.hm" options:v38];

    [v39 add:v9 withMessage:0];
    [v39 run];

    v7 = v60;
    goto LABEL_24;
  }

  v7 = v60;
LABEL_26:
  identityCopy2 = identity;
  if (v30)
  {
    if (identity)
    {
      v41 = v30;
      v42 = 0;
      *identity = v30;
      goto LABEL_43;
    }

    goto LABEL_42;
  }

LABEL_35:
  if (v14 && v15 && v16)
  {
    v47 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v14];
    v48 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v15];
    v42 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:v16 publicKey:v47 privateKey:v48 permissions:0];

    v30 = 0;
    goto LABEL_43;
  }

  if (identityCopy2)
  {
    v61 = MEMORY[0x277CCA9B8];
    v49 = *MEMORY[0x277CCFD28];
    v72 = *MEMORY[0x277CCA450];
    [MEMORY[0x277CCA8D8] mainBundle];
    v63 = v15;
    v51 = v50 = identityCopy2;
    v52 = [v51 localizedStringForKey:@"Unable to get local pairing identity" value:&stru_283CF9D50 table:0];
    v73 = v52;
    [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v73 forKeys:&v72 count:1];
    v53 = v14;
    v54 = v6;
    v56 = v55 = v7;
    *v50 = [v61 errorWithDomain:v49 code:2 userInfo:v56];
    v15 = v63;

    v7 = v55;
    v6 = v54;
    v14 = v53;
  }

  v30 = 0;
LABEL_42:
  v42 = 0;
LABEL_43:

  v57 = *MEMORY[0x277D85DE8];

  return v42;
}

- (id)hh1UserIDsForCurrentUserForHomeUUID:(id)d
{
  v29 = *MEMORY[0x277D85DE8];
  dCopy = d;
  array = [MEMORY[0x277CBEB18] array];
  hapKeyStore = [(HMDHomeManager *)self hapKeyStore];
  v7 = hapKeyStore;
  if (hapKeyStore)
  {
    systemStore = hapKeyStore;
  }

  else
  {
    systemStore = [MEMORY[0x277CFEC78] systemStore];
  }

  v9 = systemStore;

  allAccessoryPairingKeys = [v9 allAccessoryPairingKeys];
  v21[0] = MEMORY[0x277D85DD0];
  v21[1] = 3221225472;
  v21[2] = __54__HMDHomeManager_hh1UserIDsForCurrentUserForHomeUUID___block_invoke;
  v21[3] = &unk_278686590;
  v11 = v9;
  v22 = v11;
  v12 = dCopy;
  v23 = v12;
  v13 = array;
  v24 = v13;
  [allAccessoryPairingKeys hmf_enumerateWithAutoreleasePoolUsingBlock:v21];

  v14 = objc_autoreleasePoolPush();
  selfCopy = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    *buf = 138543618;
    v26 = v17;
    v27 = 2112;
    v28 = v13;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Possible HH1 User UUIDs: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  v18 = [v13 copy];

  v19 = *MEMORY[0x277D85DE8];

  return v18;
}

void __54__HMDHomeManager_hh1UserIDsForCurrentUserForHomeUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = *(a1 + 32);
  v7 = v3;
  v5 = [v3 identifier];
  LOBYTE(v4) = [v4 isHH2KeyType:v5];

  if ((v4 & 1) == 0)
  {
    v6 = [HMDUser UUIDWithUserID:0 forHomeIdentifier:*(a1 + 40) uuid:0 pairingIdentity:v7];
    [*(a1 + 48) addObject:v6];
  }
}

- (void)migrateSharedUserFromIncomingInvitation:(id)invitation
{
  v49 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  if (([invitationCopy isAccepted] & 1) == 0)
  {
    _HMFPreconditionFailure();
  }

  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v8;
    *&buf[12] = 2112;
    *&buf[14] = invitationCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Going to do shared user migration from incoming invitation : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  homeUUID = [invitationCopy homeUUID];
  v10 = [(HMDHomeManager *)selfCopy hh1UserIDsForCurrentUserForHomeUUID:homeUUID];

  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x3032000000;
  v46 = __Block_byref_object_copy__254244;
  v47 = __Block_byref_object_dispose__254245;
  v48 = 0;
  defaultDatabase = [(HMDHomeManager *)selfCopy defaultDatabase];
  v12 = defaultDatabase;
  if (defaultDatabase)
  {
    v13 = defaultDatabase;
  }

  else
  {
    v13 = +[HMDDatabase defaultDatabase];
  }

  v14 = v13;

  v33 = MEMORY[0x277D85DD0];
  v34 = 3221225472;
  v35 = __58__HMDHomeManager_migrateSharedUserFromIncomingInvitation___block_invoke;
  v36 = &unk_278686568;
  v15 = v14;
  v37 = v15;
  v16 = invitationCopy;
  v38 = v16;
  v39 = selfCopy;
  v40 = buf;
  [v10 hmf_enumerateWithAutoreleasePoolUsingBlock:&v33];
  v17 = *(*&buf[8] + 40);
  if (v17)
  {
    v18 = [HMDUser localSharedZoneForSharedUserUUID:v17 database:v15, v33, v34, v35, v36, v37];
    if (v18)
    {
      v19 = *(*&buf[8] + 40);
      homeUUID2 = [v16 homeUUID];
      backingStore = [(HMDHomeManager *)selfCopy backingStore];
      context = [backingStore context];
      [HMDUser migrateHH1SettingsToHH2ForSharedUserWithUUID:v19 homeUUID:homeUUID2 sharedZone:v18 backingStoreContext:context];
    }

    else
    {
      v27 = objc_autoreleasePoolPush();
      v28 = selfCopy;
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
      {
        v30 = HMFGetLogIdentifier();
        v31 = *(*&buf[8] + 40);
        *v41 = 138543618;
        v42 = v30;
        v43 = 2112;
        v44 = v31;
        _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_INFO, "%{public}@could not open shared zone using user UUID : %@", v41, 0x16u);
      }

      objc_autoreleasePoolPop(v27);
    }
  }

  else
  {
    v23 = objc_autoreleasePoolPush();
    v24 = selfCopy;
    v25 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
    {
      v26 = HMFGetLogIdentifier();
      *v41 = 138543618;
      v42 = v26;
      v43 = 2112;
      v44 = v16;
      _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Unable to migrate shared user settings from incoming invitation: %@", v41, 0x16u);
    }

    objc_autoreleasePoolPop(v23);
  }

  _Block_object_dispose(buf, 8);
  v32 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager_migrateSharedUserFromIncomingInvitation___block_invoke(uint64_t a1, void *a2, uint64_t a3, _BYTE *a4)
{
  v21 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = [HMDUser localPrivateZoneForSharedUserUUID:v7 database:*(a1 + 32)];
  if (v8)
  {
    v9 = [*(a1 + 40) homeUUID];
    v10 = [*(a1 + 48) backingStore];
    v11 = [v10 context];
    [HMDUser migrateHH1SettingsToHH2ForSharedUserWithUUID:v7 homeUUID:v9 privateZone:v8 backingStoreContext:v11];

    objc_storeStrong((*(*(a1 + 56) + 8) + 40), a2);
    *a4 = 1;
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 48);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v15;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@could not open private zone using user UUID : %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (BOOL)_submitSpamReportToIDS:(id)s
{
  v51 = *MEMORY[0x277D85DE8];
  sCopy = s;
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  v6 = +[HMDAppleAccountManager sharedManager];
  account = [v6 account];
  handles = [account handles];
  firstObject = [handles firstObject];
  remoteDestinationString = [firstObject remoteDestinationString];

  inviterUserID = [sCopy inviterUserID];
  if (!inviterUserID)
  {
    goto LABEL_15;
  }

  v12 = inviterUserID;
  homeName = [sCopy homeName];
  if (!homeName)
  {
    goto LABEL_14;
  }

  v14 = homeName;
  identifier = [sCopy identifier];
  if (!identifier)
  {

LABEL_14:
    goto LABEL_15;
  }

  v16 = identifier;
  startDate = [sCopy startDate];

  if (startDate && remoteDestinationString)
  {
    inviterUserID2 = [sCopy inviterUserID];
    [dictionary setObject:inviterUserID2 forKeyedSubscript:*MEMORY[0x277D18A70]];

    homeName2 = [sCopy homeName];
    [dictionary setObject:homeName2 forKeyedSubscript:@"home-name"];

    identifier2 = [sCopy identifier];
    uUIDString = [identifier2 UUIDString];
    [dictionary setObject:uUIDString forKeyedSubscript:*MEMORY[0x277D18A60]];

    v22 = MEMORY[0x277CCABB0];
    startDate2 = [sCopy startDate];
    [startDate2 timeIntervalSince1970];
    v25 = [v22 numberWithInteger:v24];
    [dictionary setObject:v25 forKeyedSubscript:*MEMORY[0x277D18A80]];

    [dictionary setObject:remoteDestinationString forKeyedSubscript:*MEMORY[0x277D18A68]];
    [dictionary setObject:@"HomeKitInviteSpam" forKeyedSubscript:*MEMORY[0x277D18A78]];
    v26 = objc_autoreleasePoolPush();
    selfCopy = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      v45 = 138543618;
      v46 = v29;
      v47 = 2112;
      v48 = dictionary;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Reporting invitation as spam: %@", &v45, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
    v30 = +[HMDIDSServiceManager sharedManager];
    service = [v30 service];

    v32 = [dictionary copy];
    v33 = [service reportSpamMessage:v32];

    if ((v33 & 1) == 0)
    {
      v34 = objc_autoreleasePoolPush();
      v35 = selfCopy;
      v36 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_FAULT))
      {
        v37 = HMFGetLogIdentifier();
        v45 = 138543362;
        v46 = v37;
        _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_FAULT, "%{public}@Spam report was rejected for some reason. Please file a bug.", &v45, 0xCu);
      }

      objc_autoreleasePoolPop(v34);
    }

    goto LABEL_18;
  }

LABEL_15:
  v38 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v40 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_ERROR))
  {
    v41 = HMFGetLogIdentifier();
    identifier3 = [sCopy identifier];
    v45 = 138543874;
    v46 = v41;
    v47 = 2112;
    v48 = identifier3;
    v49 = 2112;
    v50 = remoteDestinationString;
    _os_log_impl(&dword_229538000, v40, OS_LOG_TYPE_ERROR, "%{public}@Unexpected nil value for invitation %@, reporter %@", &v45, 0x20u);
  }

  objc_autoreleasePoolPop(v38);
  v33 = 0;
LABEL_18:

  v43 = *MEMORY[0x277D85DE8];
  return v33;
}

- (void)_processLocalRequestToUpdateHomeInvitation:(id)invitation newState:(int64_t)state authStatus:(id)status logEventBuilder:(id)builder
{
  v75 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  statusCopy = status;
  builderCopy = builder;
  identifier = [invitationCopy identifier];
  uUIDString = [identifier UUIDString];

  v13 = objc_autoreleasePoolPush();
  selfCopy = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
  {
    v16 = HMFGetLogIdentifier();
    identifier2 = [invitationCopy identifier];
    uUIDString2 = [identifier2 UUIDString];
    v19 = [MEMORY[0x277CD1A88] homeInvitationStateDescription:state];
    *buf = 138543874;
    v70 = v16;
    v71 = 2112;
    v72 = uUIDString2;
    v73 = 2112;
    v74 = v19;
    _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@[HomeManager] Processing request to update invitation %@ to state %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v13);
  v20 = +[HMDBulletinBoard sharedBulletinBoard];
  [v20 removeBulletinWithRecordID:uUIDString];

  v67[0] = @"kBulletinRecordIDKey";
  v67[1] = @"kInvitationIdentifierKey";
  v68[0] = uUIDString;
  v68[1] = uUIDString;
  v67[2] = @"kInvitationStateKey";
  v21 = [MEMORY[0x277CCABB0] numberWithInteger:state];
  v68[2] = v21;
  v67[3] = *MEMORY[0x277CD23D0];
  homeName = [invitationCopy homeName];
  v68[3] = homeName;
  v67[4] = *MEMORY[0x277CD0640];
  homeUUID = [invitationCopy homeUUID];
  uUIDString3 = [homeUUID UUIDString];
  v68[4] = uUIDString3;
  v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v68 forKeys:v67 count:5];
  [(HMDHomeManager *)selfCopy dismissBulletinOnAllMyTransientDevicesWithContext:v25];

  resolutionHandler = [invitationCopy resolutionHandler];

  if (resolutionHandler)
  {
    if (state == 3)
    {
      [invitationCopy accept];
    }

    else
    {
      [invitationCopy decline];
    }
  }

  else
  {
    if (state == 3)
    {
      inviterUserID = [invitationCopy inviterUserID];
      v56 = [HMDAccountHandle accountHandleForDestination:inviterUserID];

      v28 = [[HMDUser alloc] initWithAccountHandle:v56 home:0 pairingIdentity:0 privilege:3];
      idsFirewallManager = [(HMDHomeManager *)selfCopy idsFirewallManager];
      userID = [(HMDUser *)v28 userID];
      [idsFirewallManager handleDidAddUserWithUserID:userID];

      objc_initWeak(buf, selfCopy);
      homeSharedUserCloudShareManager = [(HMDHomeManager *)selfCopy homeSharedUserCloudShareManager];
      homeUUID2 = [invitationCopy homeUUID];
      v33 = [homeSharedUserCloudShareManager grantAccessForOwner:v28 sharedUserDataWithHomeModelID:homeUUID2 logEventBuilder:builderCopy];
      v62[0] = MEMORY[0x277D85DD0];
      v62[1] = 3221225472;
      v62[2] = __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke;
      v62[3] = &unk_278686540;
      v62[4] = selfCopy;
      v34 = invitationCopy;
      v63 = v34;
      objc_copyWeak(v66, buf);
      v66[1] = 3;
      v64 = statusCopy;
      v35 = builderCopy;
      v65 = v35;
      v36 = [v33 then:v62];
      v59[0] = MEMORY[0x277D85DD0];
      v59[1] = 3221225472;
      v59[2] = __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_3;
      v59[3] = &unk_278685D80;
      v59[4] = selfCopy;
      v37 = v34;
      v60 = v37;
      v61 = v35;
      v38 = [v36 recover:v59];

      objc_destroyWeak(v66);
      objc_destroyWeak(buf);

      [(HMDHomeManager *)selfCopy _postIncomingInvitationStateChangedNotification:v37 newInvitationState:5];
      uuidsOfRemovedHomes = [(HMDHomeManager *)selfCopy uuidsOfRemovedHomes];
      homeUUID3 = [v37 homeUUID];
      LODWORD(v35) = [uuidsOfRemovedHomes containsObject:homeUUID3];

      if (v35)
      {
        uuidsOfRemovedHomes2 = [(HMDHomeManager *)selfCopy uuidsOfRemovedHomes];
        homeUUID4 = [v37 homeUUID];
        [uuidsOfRemovedHomes2 removeObject:homeUUID4];

        v43 = objc_autoreleasePoolPush();
        v44 = selfCopy;
        v45 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v45, OS_LOG_TYPE_INFO))
        {
          v46 = HMFGetLogIdentifier();
          homeUUID5 = [v37 homeUUID];
          uUIDString4 = [homeUUID5 UUIDString];
          *buf = 138543618;
          v70 = v46;
          v71 = 2112;
          v72 = uUIDString4;
          _os_log_impl(&dword_229538000, v45, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v43);
      }

      homeUUID6 = [v37 homeUUID];
      v50 = [(HMDHomeManager *)selfCopy _homeWithUUID:homeUUID6];
      owner = [v50 owner];
      account = [owner account];
      senderCorrelationIdentifier = [account senderCorrelationIdentifier];

      [(HMDHomeManager *)selfCopy _stopTrackingRemovedHomeUserMergeId:senderCorrelationIdentifier];
    }

    else
    {
      [builderCopy cancel];
      homeUUID7 = [invitationCopy homeUUID];
      [(HMDHomeManager *)selfCopy __sendUpdateRequestToAdminForInvitation:invitationCopy homeUUID:homeUUID7 invitationState:state authStatus:statusCopy reverseShareInvitation:0 logEventBuilder:0];

      [(HMDHomeManager *)selfCopy _removeIncomingInvitation:invitationCopy];
      [(HMDHomeManager *)selfCopy _postIncomingInvitationStateChangedNotification:invitationCopy newInvitationState:state];
    }

    [(HMDHomeManager *)selfCopy _updateIncomingInvitesPresent];
  }

  v55 = *MEMORY[0x277D85DE8];
}

uint64_t __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    *buf = 138543362;
    v22 = v7;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Created reverse share successful, proceeding to send invitation acceptance", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *(a1 + 32);
  v9 = [*(a1 + 40) homeUUID];
  v15[0] = MEMORY[0x277D85DD0];
  v15[1] = 3221225472;
  v15[2] = __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_1291;
  v15[3] = &unk_278686518;
  objc_copyWeak(v20, (a1 + 64));
  v10 = *(a1 + 40);
  v11 = *(a1 + 72);
  v16 = v10;
  v20[1] = v11;
  v17 = *(a1 + 48);
  v12 = v3;
  v18 = v12;
  v19 = *(a1 + 56);
  [v8 _queryLegacyHomeAndAcceptedZoneExists:v9 completion:v15];

  objc_destroyWeak(v20);
  v13 = *MEMORY[0x277D85DE8];
  return 1;
}

uint64_t __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_3(id *a1, void *a2)
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = a1[4];
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [a1[5] identifier];
    v9 = [v8 UUIDString];
    v12 = 138543874;
    v13 = v7;
    v14 = 2112;
    v15 = v9;
    v16 = 2112;
    v17 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to grant share access back to owner for invite with identifier %@ due to error %@", &v12, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  [a1[6] markError:v3];

  v10 = *MEMORY[0x277D85DE8];
  return 1;
}

void __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_1291(uint64_t a1, int a2, char a3)
{
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if (a2 && (a3 & 1) == 0)
    {
      v7 = objc_autoreleasePoolPush();
      [WeakRetained migrateSharedUserFromIncomingInvitation:*(a1 + 32)];
      objc_autoreleasePoolPop(v7);
    }

    v8 = [WeakRetained workQueue];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_2;
    v15[3] = &unk_2786864F0;
    v15[4] = WeakRetained;
    v9 = *(a1 + 32);
    v18 = *(a1 + 72);
    v10 = *(a1 + 40);
    v11 = *(a1 + 48);
    v12 = *(a1 + 56);
    *&v13 = v11;
    *(&v13 + 1) = v12;
    *&v14 = v9;
    *(&v14 + 1) = v10;
    v16 = v14;
    v17 = v13;
    dispatch_async(v8, v15);
  }
}

void __97__HMDHomeManager__processLocalRequestToUpdateHomeInvitation_newState_authStatus_logEventBuilder___block_invoke_2(void *a1)
{
  v2 = a1[4];
  v3 = a1[5];
  v4 = [v3 homeUUID];
  [v2 __sendUpdateRequestToAdminForInvitation:v3 homeUUID:v4 invitationState:a1[9] authStatus:a1[6] reverseShareInvitation:a1[7] logEventBuilder:a1[8]];
}

- (BOOL)addHH2KeyInResponsePayload:(id)payload invitation:(id)invitation
{
  v74 = *MEMORY[0x277D85DE8];
  payloadCopy = payload;
  invitationCopy = invitation;
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v66 = 0;
  v67 = 0;
  LODWORD(data) = [systemStore getOrCreateHH2ControllerKey:&v67 secretKey:0 keyPair:0 username:&v66];
  v10 = v67;
  v11 = v66;

  if (data)
  {
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      inviterIdentity = [invitationCopy inviterIdentity];
      *buf = 138543618;
      v69 = v15;
      v70 = 2114;
      v71 = inviterIdentity;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Owner's pairing identity: %{public}@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v17 = objc_autoreleasePoolPush();
    v18 = selfCopy;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543874;
      v69 = v20;
      v70 = 2114;
      v71 = v10;
      v72 = 2114;
      v73 = v11;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Shared user's HH2 controller key [%{public}@] [%{public}@] before sending invite accept", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
    inviterIdentity2 = [invitationCopy inviterIdentity];
    identifier = [inviterIdentity2 identifier];
    v23 = HMFEqualObjects();

    if (v23)
    {
      systemStore2 = [MEMORY[0x277CFEC78] systemStore];
      allHH2PairingKeys = [systemStore2 allHH2PairingKeys];

      v26 = objc_autoreleasePoolPush();
      v27 = v18;
      v28 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
      {
        v29 = HMFGetLogIdentifier();
        *buf = 138543874;
        v69 = v29;
        v70 = 2114;
        v71 = v11;
        v72 = 2114;
        v73 = allHH2PairingKeys;
        _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Looks like Owner and shared user has the same pairing identity : %{public}@, HH2 key list: %{public}@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v26);
      v64[0] = MEMORY[0x277D85DD0];
      v64[1] = 3221225472;
      v64[2] = __56__HMDHomeManager_addHH2KeyInResponsePayload_invitation___block_invoke;
      v64[3] = &unk_2786864C8;
      v30 = invitationCopy;
      v65 = v30;
      v31 = [allHH2PairingKeys na_filter:v64];

      v32 = objc_autoreleasePoolPush();
      v33 = v27;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
      {
        HMFGetLogIdentifier();
        v61 = invitationCopy;
        v35 = payloadCopy;
        v37 = v36 = v31;
        inviterIdentity3 = [v30 inviterIdentity];
        identifier2 = [inviterIdentity3 identifier];
        *buf = 138543874;
        v69 = v37;
        v70 = 2114;
        v71 = identifier2;
        v72 = 2114;
        v73 = v36;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_INFO, "%{public}@All HH2 keys after removing %{public}@ / %{public}@", buf, 0x20u);

        v31 = v36;
        payloadCopy = v35;
        invitationCopy = v61;
      }

      objc_autoreleasePoolPop(v32);
      if ([v31 hmf_isEmpty])
      {
        systemStore3 = [MEMORY[0x277CFEC78] systemStore];
        v62 = v11;
        v63 = v10;
        v41 = [systemStore3 createHH2ControllerKey:&v63 secretKey:0 keyPair:0 username:&v62];
        v42 = v63;

        v43 = v62;
        if (v41)
        {
          v44 = objc_autoreleasePoolPush();
          v45 = v33;
          v46 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v46, OS_LOG_TYPE_FAULT))
          {
            v47 = HMFGetLogIdentifier();
            *buf = 138543362;
            v69 = v47;
            _os_log_impl(&dword_229538000, v46, OS_LOG_TYPE_FAULT, "%{public}@This makes me sad. :( I need a break. Unable to create a brand new HH2 pairing key.", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v44);
          v48 = objc_autoreleasePoolPush();
          data = v45;
          v49 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v49, OS_LOG_TYPE_ERROR))
          {
            v50 = HMFGetLogIdentifier();
            v51 = [MEMORY[0x277CCABB0] numberWithInt:v41];
            *buf = 138543618;
            v69 = v50;
            v70 = 2112;
            v71 = v51;
            _os_log_impl(&dword_229538000, v49, OS_LOG_TYPE_ERROR, "%{public}@This makes me sad. :( I need a break. Unable to create a brand new HH2 pairing key. %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v48);
          LOBYTE(data) = 0;
        }

        else
        {
          [payloadCopy setObject:v42 forKeyedSubscript:@"kControllerPublicKey"];
          [payloadCopy setObject:v43 forKeyedSubscript:@"kControllerPairingNameKey"];
          LOBYTE(data) = 1;
        }

        v11 = v43;
        v10 = v42;
      }

      else
      {
        firstObject = [v31 firstObject];
        v53 = objc_autoreleasePoolPush();
        v54 = v33;
        v55 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v55, OS_LOG_TYPE_INFO))
        {
          v56 = HMFGetLogIdentifier();
          *buf = 138543618;
          v69 = v56;
          v70 = 2114;
          v71 = firstObject;
          _os_log_impl(&dword_229538000, v55, OS_LOG_TYPE_INFO, "%{public}@Key chosen by the shared user: %{public}@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v53);
        publicKey = [firstObject publicKey];
        data = [publicKey data];
        [payloadCopy setObject:data forKeyedSubscript:@"kControllerPublicKey"];

        identifier3 = [firstObject identifier];
        [payloadCopy setObject:identifier3 forKeyedSubscript:@"kControllerPairingNameKey"];

        LOBYTE(data) = 1;
      }
    }

    else
    {
      [payloadCopy setObject:v10 forKeyedSubscript:@"kControllerPublicKey"];
      [payloadCopy setObject:v11 forKeyedSubscript:@"kControllerPairingNameKey"];
      LOBYTE(data) = 1;
    }
  }

  v59 = *MEMORY[0x277D85DE8];
  return data;
}

uint64_t __56__HMDHomeManager_addHH2KeyInResponsePayload_invitation___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 inviterIdentity];
  v5 = [v4 identifier];
  v6 = [v3 identifier];

  LODWORD(v3) = HMFEqualObjects();
  return v3 ^ 1;
}

- (void)_processRequestToUpdateHomeInvitation:(id)invitation invitationState:(int64_t)state homeUUID:(id)d authStatus:(id)status invitationSource:(unint64_t)source messageName:(id)name message:(id)message
{
  v117 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  dCopy = d;
  statusCopy = status;
  nameCopy = name;
  messageCopy = message;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v21 = [incomingInvitations hmf_firstObjectWithValue:invitationCopy forKeyPath:@"identifier"];

  if (v21)
  {
    v96 = dCopy;
    v22 = [HMDHomeInviteLogEvent updateWithInvitationState:state isFMFDevice:isThisDeviceDesignatedFMFDevice()];
    if (v22)
    {
      logEventSubmitter = [(HMDHomeManager *)self logEventSubmitter];
      [logEventSubmitter submitLogEvent:v22];
    }

    v95 = v22;
    if (state <= 7 && ((1 << state) & 0xD8) != 0)
    {
      identifier = [v21 identifier];
      uUIDString = [identifier UUIDString];

      isExpired = [v21 isExpired];
      if (state == 7 || isExpired)
      {
        v90 = nameCopy;
        v92 = invitationCopy;
        v94 = statusCopy;
        v88 = messageCopy;
        v60 = [messageCopy numberForKey:@"kInvitationResponseOptionsKey"];
        integerValue = [v60 integerValue];

        v62 = objc_autoreleasePoolPush();
        selfCopy = self;
        v64 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v64, OS_LOG_TYPE_INFO))
        {
          v86 = v62;
          v65 = HMFGetLogIdentifier();
          [v21 isExpired];
          v66 = HMFBooleanToString();
          v67 = HMFBooleanToString();
          HMFBooleanToString();
          v69 = v68 = uUIDString;
          *buf = 138544130;
          v110 = v65;
          v111 = 2112;
          v112 = v66;
          v113 = 2112;
          v114 = v67;
          v115 = 2112;
          v116 = v69;
          _os_log_impl(&dword_229538000, v64, OS_LOG_TYPE_INFO, "%{public}@Invitation has expired (%@) or was ignored (%@) / reported as spam (%@), removing and notifying clients.", buf, 0x2Au);

          uUIDString = v68;
          v62 = v86;
        }

        objc_autoreleasePoolPop(v62);
        if (integerValue)
        {
          [(HMDHomeManager *)selfCopy _submitSpamReportToIDS:v21];
        }

        v107[0] = @"kBulletinRecordIDKey";
        v107[1] = @"kInvitationIdentifierKey";
        v108[0] = uUIDString;
        v108[1] = uUIDString;
        v107[2] = @"kInvitationStateKey";
        v70 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v21, "invitationState")}];
        v108[2] = v70;
        v107[3] = *MEMORY[0x277CD23D0];
        homeName = [v21 homeName];
        v108[3] = homeName;
        v107[4] = *MEMORY[0x277CD0640];
        homeUUID = [v21 homeUUID];
        uUIDString2 = [homeUUID UUIDString];
        v108[4] = uUIDString2;
        v74 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v108 forKeys:v107 count:5];
        [(HMDHomeManager *)selfCopy dismissBulletinOnAllMyTransientDevicesWithContext:v74];

        if ([v21 isExpired])
        {
          v75 = 6;
        }

        else
        {
          v75 = 7;
        }

        [(HMDHomeManager *)selfCopy _postIncomingInvitationStateChangedNotification:v21 newInvitationState:v75];
        [(HMDHomeManager *)selfCopy _removeIncomingInvitation:v21];
        if (state == 3)
        {
          v76 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:23 userInfo:0];
        }

        else
        {
          v76 = 0;
        }

        invitationCopy = v92;
        statusCopy = v94;
        messageCopy = v88;
        nameCopy = v90;
        [v88 respondWithPayload:0 error:v76];
      }

      else if (state == 3)
      {
        v85 = uUIDString;
        v87 = messageCopy;
        v89 = nameCopy;
        v91 = invitationCopy;
        v93 = statusCopy;
        v27 = [HMDSharedUserInviteAcceptLogEventBuilder alloc];
        homeUUID2 = [v21 homeUUID];
        identifier2 = [v21 identifier];
        inviteePrivilege = [v21 inviteePrivilege];
        [v21 age];
        v32 = v31;
        dataSource = [(HMDHomeManager *)self dataSource];
        createWiFiManager = [dataSource createWiFiManager];
        v35 = [(HMDSharedUserInviteAcceptLogEventBuilder *)v27 initWithHomeUUID:homeUUID2 homeManager:self sessionIdentifier:identifier2 invitationType:inviteePrivilege invitationAge:source invitationSource:createWiFiManager wifiManager:v32];

        homeUUID3 = [v21 homeUUID];
        [(HMDHomeManager *)self addSharedUserAcceptEventBuilder:v35 forHomeUuid:homeUUID3];

        v37 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v39 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
        {
          v40 = HMFGetLogIdentifier();
          *buf = 138543362;
          v110 = v40;
          _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@Creating HH2 controller key before accepting owner's cloud share", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v37);
        systemStore = [MEMORY[0x277CFEC78] systemStore];
        v42 = [systemStore getOrCreateHH2ControllerKey:0 secretKey:0 keyPair:0 username:0];

        if (v42)
        {
          v43 = [HMDCoreDataCloudShareInvitation alloc];
          shareURL = [v21 shareURL];
          shareToken = [v21 shareToken];
          v46 = [(HMDCoreDataCloudShareInvitation *)v43 initWithURL:shareURL token:shareToken];

          [(HMDSharedUserInviteAcceptLogEventBuilder *)v35 markJoinOwnerShareBegin];
          homeSharedUserCloudShareManager = [(HMDHomeManager *)selfCopy2 homeSharedUserCloudShareManager];
          homeUUID4 = [v21 homeUUID];
          v47 = [homeSharedUserCloudShareManager acceptShareInvitation:v46 homeWithHomeModelID:homeUUID4];
          [(HMDHomeManager *)selfCopy2 workContext];
          v49 = v48 = v35;
          v101[0] = MEMORY[0x277D85DD0];
          v101[1] = 3221225472;
          v101[2] = __129__HMDHomeManager__processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke;
          v101[3] = &unk_278686478;
          v101[4] = selfCopy2;
          v102 = v21;
          v103 = v48;
          v106 = 3;
          v104 = v93;
          v105 = v87;
          v97[0] = MEMORY[0x277D85DD0];
          v97[1] = 3221225472;
          v97[2] = __129__HMDHomeManager__processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke_1289;
          v97[3] = &unk_2786864A0;
          v97[4] = selfCopy2;
          messageCopy = v87;
          v98 = v102;
          v99 = v103;
          v100 = v105;
          v50 = [v47 inContext:v49 then:v101 orRecover:v97];

          v35 = v48;
          invitationCopy = v91;
          uUIDString = v85;
        }

        else
        {
          v78 = objc_autoreleasePoolPush();
          v79 = selfCopy2;
          v80 = HMFGetOSLogHandle();
          invitationCopy = v91;
          uUIDString = v85;
          if (os_log_type_enabled(v80, OS_LOG_TYPE_ERROR))
          {
            v81 = HMFGetLogIdentifier();
            *buf = 138543362;
            v110 = v81;
            _os_log_impl(&dword_229538000, v80, OS_LOG_TYPE_ERROR, "%{public}@Failed to create HH2 controller key before accepting invitation", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v78);
          v46 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
          [(HMDSharedUserInviteLogEventBuilder *)v35 markError:v46];
          messageCopy = v87;
          [v87 respondWithError:v46];
        }

        statusCopy = v93;
        nameCopy = v89;
      }

      else
      {
        [(HMDHomeManager *)self _processLocalRequestToUpdateHomeInvitation:v21 newState:state authStatus:statusCopy logEventBuilder:0];
        [messageCopy respondWithPayload:0];
      }

      v59 = v95;
    }

    else
    {
      v77 = [MEMORY[0x277CCA9B8] hmErrorWithCode:43];
      [messageCopy respondWithError:v77];

      v59 = v22;
    }

    dCopy = v96;
  }

  else
  {
    v51 = nameCopy;
    v52 = objc_autoreleasePoolPush();
    v53 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v53, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v55 = v54 = statusCopy;
      [invitationCopy UUIDString];
      v56 = messageCopy;
      v58 = v57 = dCopy;
      *buf = 138543618;
      v110 = v55;
      v111 = 2112;
      v112 = v58;
      _os_log_impl(&dword_229538000, v53, OS_LOG_TYPE_INFO, "%{public}@Invalid invite identifier specified %@", buf, 0x16u);

      dCopy = v57;
      messageCopy = v56;

      statusCopy = v54;
    }

    objc_autoreleasePoolPop(v52);
    v59 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    [messageCopy respondWithError:v59];
    nameCopy = v51;
  }

  v82 = *MEMORY[0x277D85DE8];
}

uint64_t __129__HMDHomeManager__processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke(uint64_t a1, void *a2)
{
  v19 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [*(a1 + 40) homeName];
    v9 = [*(a1 + 40) homeUUID];
    v10 = [v9 UUIDString];
    v13 = 138543874;
    v14 = v7;
    v15 = 2112;
    v16 = v8;
    v17 = 2112;
    v18 = v10;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Joined cloud share successfully for invitation, continue to process invitation for home %@/%@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 48) markJoinOwnerShareEnd];
  [*(a1 + 32) _processLocalRequestToUpdateHomeInvitation:*(a1 + 40) newState:*(a1 + 72) authStatus:*(a1 + 56) logEventBuilder:*(a1 + 48)];
  [*(a1 + 32) _removeIncomingInvitation:*(a1 + 40)];
  [*(a1 + 64) respondWithPayload:0];

  v11 = *MEMORY[0x277D85DE8];
  return 1;
}

uint64_t __129__HMDHomeManager__processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke_1289(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [*(a1 + 40) homeName];
    v9 = [*(a1 + 40) homeUUID];
    v10 = [v9 UUIDString];
    v15 = 138544130;
    v16 = v7;
    v17 = 2112;
    v18 = v8;
    v19 = 2112;
    v20 = v10;
    v21 = 2112;
    v22 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to accept cloud share for invitation home %@/%@ due to %@", &v15, 0x2Au);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 48) markError:v3];
  v11 = *(a1 + 56);
  v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
  [v11 respondWithError:v12];

  v13 = *MEMORY[0x277D85DE8];
  return 1;
}

- (void)processRequestToUpdateHomeInvitation:(id)invitation invitationState:(int64_t)state homeUUID:(id)d authStatus:(id)status invitationSource:(unint64_t)source messageName:(id)name message:(id)message
{
  invitationCopy = invitation;
  dCopy = d;
  statusCopy = status;
  nameCopy = name;
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  v26[0] = MEMORY[0x277D85DD0];
  v26[1] = 3221225472;
  v26[2] = __128__HMDHomeManager_processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke;
  v26[3] = &unk_278686450;
  v26[4] = self;
  v27 = invitationCopy;
  v28 = dCopy;
  v29 = statusCopy;
  stateCopy = state;
  sourceCopy = source;
  v30 = nameCopy;
  v31 = messageCopy;
  v21 = messageCopy;
  v22 = nameCopy;
  v23 = statusCopy;
  v24 = dCopy;
  v25 = invitationCopy;
  dispatch_async(workQueue, v26);
}

- (void)_handleRequestToUpdateHomeInvitationFromLocalUser:(id)user
{
  userCopy = user;
  v4 = [userCopy uuidForKey:@"kInvitationIdentifierKey"];
  v5 = [userCopy numberForKey:@"kInvitationStateKey"];
  v6 = [userCopy uuidForKey:*MEMORY[0x277CD0640]];
  v7 = [MEMORY[0x277CD1F00] authWithMessage:userCopy];
  if (v4 && v5 && v6)
  {
    integerValue = [v5 integerValue];
    name = [userCopy name];
    [(HMDHomeManager *)self _processRequestToUpdateHomeInvitation:v4 invitationState:integerValue homeUUID:v6 authStatus:v7 invitationSource:1 messageName:name message:userCopy];
  }

  else
  {
    name = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    responseHandler = [userCopy responseHandler];
    (responseHandler)[2](responseHandler, name, 0);
  }
}

- (void)_handleRequestToCancelHomeInvitation:(id)invitation saveReason:(id)reason
{
  v21 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  reasonCopy = reason;
  identifier = [invitationCopy identifier];
  uUIDString = [identifier UUIDString];

  v10 = objc_autoreleasePoolPush();
  selfCopy = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    describeWithFormat = [invitationCopy describeWithFormat];
    v17 = 138543618;
    v18 = v13;
    v19 = 2112;
    v20 = describeWithFormat;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Updating invitation %@ to canceled due to request from inviter", &v17, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  v15 = +[HMDBulletinBoard sharedBulletinBoard];
  [v15 removeBulletinWithRecordID:uUIDString];

  [(HMDHomeManager *)selfCopy _postIncomingInvitationStateChangedNotification:invitationCopy newInvitationState:1];
  [(HMDHomeManager *)selfCopy _removeIncomingInvitation:invitationCopy];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestToUpdateHomeInvitationFromInviter:(id)inviter
{
  v24 = *MEMORY[0x277D85DE8];
  inviterCopy = inviter;
  v5 = [inviterCopy uuidForKey:@"kInvitationIdentifierKey"];
  v6 = [inviterCopy numberForKey:@"kInvitationStateKey"];
  v7 = v6;
  if (!v5 || !v6)
  {
    v9 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    [inviterCopy respondWithError:v9];
    goto LABEL_12;
  }

  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v9 = [incomingInvitations hmf_firstObjectWithValue:v5 forKeyPath:@"identifier"];

  if (!v9)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      uUIDString = [v5 UUIDString];
      v20 = 138543618;
      v21 = v13;
      v22 = 2112;
      v23 = uUIDString;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Invalid invite identifier specified %@", &v20, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 2;
    goto LABEL_11;
  }

  if ([v7 integerValue] != 1)
  {
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 43;
LABEL_11:
    v18 = [v15 errorWithDomain:v16 code:v17 userInfo:0];
    [inviterCopy respondWithError:v18];

    goto LABEL_12;
  }

  name = [inviterCopy name];
  [(HMDHomeManager *)self _handleRequestToCancelHomeInvitation:v9 saveReason:name];

LABEL_12:
  v19 = *MEMORY[0x277D85DE8];
}

- (void)_pruneExpiredIncomingInvitations
{
  v37 = *MEMORY[0x277D85DE8];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v3 = [incomingInvitations copy];

  obj = v3;
  v4 = [v3 countByEnumeratingWithState:&v28 objects:v36 count:16];
  if (v4)
  {
    v5 = v4;
    v27 = *v29;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v29 != v27)
        {
          objc_enumerationMutation(obj);
        }

        v7 = *(*(&v28 + 1) + 8 * i);
        date = [MEMORY[0x277CBEAA8] date];
        endDate = [v7 endDate];
        v10 = [date compare:endDate];

        if (v10 != -1)
        {
          [v7 updateInvitationState:6];
          identifier = [v7 identifier];
          v12 = objc_autoreleasePoolPush();
          selfCopy = self;
          v14 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
          {
            v15 = HMFGetLogIdentifier();
            describeWithFormat = [v7 describeWithFormat];
            *buf = 138543618;
            v33 = v15;
            v34 = 2112;
            v35 = describeWithFormat;
            _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Pruning invitation %@ as expired", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v12);
          v17 = +[HMDBulletinBoard sharedBulletinBoard];
          uUIDString = [identifier UUIDString];
          [v17 removeBulletinWithRecordID:uUIDString];

          -[HMDHomeManager _postIncomingInvitationStateChangedNotification:newInvitationState:](selfCopy, "_postIncomingInvitationStateChangedNotification:newInvitationState:", v7, [v7 invitationState]);
          [(HMDHomeManager *)selfCopy _removeIncomingInvitation:v7];
          v19 = objc_autoreleasePoolPush();
          v20 = selfCopy;
          v21 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
          {
            v22 = HMFGetLogIdentifier();
            incomingInvitations2 = [(HMDHomeManager *)v20 incomingInvitations];
            *buf = 138543618;
            v33 = v22;
            v34 = 2112;
            v35 = incomingInvitations2;
            _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, "%{public}@Incoming invitations after pruning: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v19);
        }
      }

      v5 = [obj countByEnumeratingWithState:&v28 objects:v36 count:16];
    }

    while (v5);
  }

  v24 = *MEMORY[0x277D85DE8];
}

- (int64_t)numberOfPendingIncomingInvitation
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v3 = [incomingInvitations copy];

  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = 0;
    v7 = *v12;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v7)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v11 + 1) + 8 * i) invitationState] == 2)
        {
          ++v6;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v5);
  }

  else
  {
    v6 = 0;
  }

  v9 = *MEMORY[0x277D85DE8];
  return v6;
}

- (HMDSharedUserPrivateSettingsManager)sharedUserPrivateSettingsManager
{
  os_unfair_lock_lock_with_options();
  sharedUserPrivateSettingsManager = self->_sharedUserPrivateSettingsManager;
  if (!sharedUserPrivateSettingsManager)
  {
    v4 = [HMDSharedUserPrivateSettingsManager alloc];
    v5 = +[HMDCoreData sharedInstance];
    v6 = +[HMDCoreDataCloudTransform sharedInstance];
    v7 = [(HMDSharedUserPrivateSettingsManager *)v4 initWithCoreData:v5 cloudTransform:v6 homeManager:self];
    v8 = self->_sharedUserPrivateSettingsManager;
    self->_sharedUserPrivateSettingsManager = v7;

    sharedUserPrivateSettingsManager = self->_sharedUserPrivateSettingsManager;
  }

  v9 = sharedUserPrivateSettingsManager;
  os_unfair_lock_unlock(&self->_lock);

  return v9;
}

- (void)setHomeSharedUserCloudShareManager:(id)manager
{
  managerCopy = manager;
  os_unfair_lock_lock_with_options();
  homeSharedUserCloudShareManager = self->_homeSharedUserCloudShareManager;
  self->_homeSharedUserCloudShareManager = managerCopy;

  os_unfair_lock_unlock(&self->_lock);
}

- (HMDHomeSharedUserCloudShareManager)homeSharedUserCloudShareManager
{
  os_unfair_lock_lock_with_options();
  homeSharedUserCloudShareManager = self->_homeSharedUserCloudShareManager;
  if (!homeSharedUserCloudShareManager)
  {
    v4 = +[HMDCoreData sharedInstance];
    v5 = [HMDHomeSharedUserCloudShareManager alloc];
    container = [v4 container];
    cloudSharedStore = [v4 cloudSharedStore];
    cloudPrivateStore = [v4 cloudPrivateStore];
    newManagedObjectContext = [v4 newManagedObjectContext];
    v10 = [(HMDHomeSharedUserCloudShareManager *)v5 initWithContainer:container sharedStore:cloudSharedStore privateStore:cloudPrivateStore moc:newManagedObjectContext];
    v11 = self->_homeSharedUserCloudShareManager;
    self->_homeSharedUserCloudShareManager = v10;

    homeSharedUserCloudShareManager = self->_homeSharedUserCloudShareManager;
  }

  v12 = homeSharedUserCloudShareManager;
  os_unfair_lock_unlock(&self->_lock);

  return v12;
}

- (void)setHomeOwnerCloudShareManager:(id)manager
{
  managerCopy = manager;
  os_unfair_lock_lock_with_options();
  homeOwnerCloudShareManager = self->_homeOwnerCloudShareManager;
  self->_homeOwnerCloudShareManager = managerCopy;

  os_unfair_lock_unlock(&self->_lock);
}

- (HMDHomeOwnerCloudShareManager)homeOwnerCloudShareManager
{
  os_unfair_lock_lock_with_options();
  homeOwnerCloudShareManager = self->_homeOwnerCloudShareManager;
  if (!homeOwnerCloudShareManager)
  {
    v4 = +[HMDCoreData sharedInstance];
    v5 = [HMDHomeOwnerCloudShareManager alloc];
    container = [v4 container];
    cloudSharedStore = [v4 cloudSharedStore];
    cloudPrivateStore = [v4 cloudPrivateStore];
    newManagedObjectContext = [v4 newManagedObjectContext];
    v10 = +[HMDCoreDataCloudTransform sharedInstance];
    v11 = [(HMDHomeOwnerCloudShareManager *)v5 initWithContainer:container sharedStore:cloudSharedStore privateStore:cloudPrivateStore moc:newManagedObjectContext cloudTransform:v10 homeManager:self];
    v12 = self->_homeOwnerCloudShareManager;
    self->_homeOwnerCloudShareManager = v11;

    homeOwnerCloudShareManager = self->_homeOwnerCloudShareManager;
  }

  v13 = homeOwnerCloudShareManager;
  os_unfair_lock_unlock(&self->_lock);

  return v13;
}

- (void)auditAccessForUsersForHome:(id)home
{
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __45__HMDHomeManager_auditAccessForUsersForHome___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = homeCopy;
  v6 = homeCopy;
  dispatch_async(workQueue, v7);
}

void __45__HMDHomeManager_auditAccessForUsersForHome___block_invoke(uint64_t a1)
{
  v1 = [*(a1 + 32) _homeWithUUID:*(a1 + 40)];
  [v1 auditAccessForUsers];
}

- (void)_removeIncomingInvitation:(id)invitation
{
  v19 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  if (invitationCopy)
  {
    backingStore = [(HMDHomeManager *)self backingStore];
    context = [backingStore context];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __44__HMDHomeManager__removeIncomingInvitation___block_invoke;
    v15[3] = &unk_27868A728;
    v7 = invitationCopy;
    v16 = v7;
    [context performBlock:v15];

    os_unfair_lock_lock_with_options();
    incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
    [incomingInvitations removeObject:v7];

    os_unfair_lock_unlock(&self->_lock);
    [(HMDHomeManager *)self _updateIncomingInvitesPresent];
    v9 = v16;
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    selfCopy = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v13;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Unexpected nil invitation", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v9 = +[HMDTTRManager sharedManager];
    [v9 requestRadarWithDisplayReason:@"detected issue related to HomeKit Shared User functionality" radarTitle:@"Unexpected nil invitation detected" componentName:@"HomeKit" componentVersion:@"Users+Invitations" componentID:938670];
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __44__HMDHomeManager__removeIncomingInvitation___block_invoke(uint64_t a1)
{
  v10 = +[HMCContext currentContext];
  v2 = [v10 findHomeManagerWithError:0];
  if (v2)
  {
    v3 = v2;
    v4 = [*(a1 + 32) identifier];
    v5 = [v3 findIncomingInvitationsRelationWithModelID:v4];

    v6 = v10;
    if (v5)
    {
      [v10 deleteObject:v5];
      v6 = v10;
    }

    [v6 save];
  }

  else
  {
    v7 = _HMFPreconditionFailure();
    [(HMDHomeManager *)v7 _addIncomingInvitation:v8, v9];
  }
}

- (void)_addIncomingInvitation:(id)invitation
{
  v25 = *MEMORY[0x277D85DE8];
  invitationCopy = invitation;
  backingStore = [(HMDHomeManager *)self backingStore];
  context = [backingStore context];
  v15 = MEMORY[0x277D85DD0];
  v16 = 3221225472;
  v17 = __41__HMDHomeManager__addIncomingInvitation___block_invoke;
  v18 = &unk_27868A750;
  v7 = invitationCopy;
  v19 = v7;
  selfCopy = self;
  [context performBlock:&v15];

  os_unfair_lock_lock_with_options();
  v8 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    describeWithFormat = [v7 describeWithFormat];
    *buf = 138543618;
    v22 = v11;
    v23 = 2112;
    v24 = describeWithFormat;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Added the invitation object to the list : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  incomingInvitations = [(HMDHomeManager *)selfCopy2 incomingInvitations];
  [incomingInvitations addObject:v7];

  os_unfair_lock_unlock(&self->_lock);
  [(HMDHomeManager *)selfCopy2 _updateIncomingInvitesPresent];

  v14 = *MEMORY[0x277D85DE8];
}

void __41__HMDHomeManager__addIncomingInvitation___block_invoke(uint64_t a1)
{
  v41 = *MEMORY[0x277D85DE8];
  v2 = +[HMCContext currentContext];
  v3 = [v2 findHomeManagerWithError:0];
  if (!v3)
  {
    _HMFPreconditionFailure();
  }

  v4 = v3;
  v5 = [*(a1 + 32) identifier];
  v6 = [v4 materializeOrCreateIncomingInvitationsRelationWithModelID:v5 createdNew:0];

  v7 = [*(a1 + 32) idsInvitationUUID];
  [v6 setIdsIdentifier:v7];

  v8 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(*(a1 + 32), "invitationState")}];
  [v6 setInvitationState:v8];

  v9 = [*(a1 + 32) endDate];
  [v6 setExpiryDate:v9];

  v10 = [*(a1 + 32) homeName];
  [v6 setHomeName:v10];

  v11 = [*(a1 + 32) homeUUID];
  [v6 setHomeModelID:v11];

  v12 = [*(a1 + 32) inviterMergeID];
  [v6 setInviterMergeID:v12];

  v13 = [*(a1 + 32) inviterIdentity];
  v14 = [v13 identifier];
  [v6 setInviterPairingIdentifier:v14];

  v15 = [*(a1 + 32) inviterIdentity];
  v16 = [v15 publicKey];
  v17 = [v16 data];
  [v6 setInviterPairingPublicKey:v17];

  v18 = [*(a1 + 32) inviterUserID];
  [v6 setInviterUserID:v18];

  v19 = [*(a1 + 32) shareURL];
  [v6 setShareURL:v19];

  v20 = [MEMORY[0x277CCABB0] numberWithBool:{objc_msgSend(*(a1 + 32), "homeHasCameras")}];
  [v6 setHomeHasCameras:v20];

  v21 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(*(a1 + 32), "inviteePrivilege")}];
  [v6 setInviteePrivilege:v21];

  v22 = [*(a1 + 32) restrictedGuestSchedule];
  [v6 populateWorkingStoreFromRestrictedGuestSchedule:v22];

  v23 = objc_autoreleasePoolPush();
  v24 = *(a1 + 40);
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
  {
    v26 = HMFGetLogIdentifier();
    *buf = 138543362;
    v38 = v26;
    _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Adding RG payload to invitation and running CD transaction", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v23);
  v27 = MEMORY[0x277CCAAB0];
  v28 = [*(a1 + 32) shareToken];
  v36 = 0;
  v29 = [v27 archivedDataWithRootObject:v28 requiringSecureCoding:1 error:&v36];
  v30 = v36;

  if (v30)
  {
    v31 = objc_autoreleasePoolPush();
    v32 = *(a1 + 40);
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v34;
      v39 = 2112;
      v40 = v30;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_ERROR, "%{public}@Archiving share token on invitation failed with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v31);
  }

  [v6 setShareToken:v29];
  [v2 save];

  v35 = *MEMORY[0x277D85DE8];
}

- (void)_handleGetTLVForJSON:(id)n
{
  v13[1] = *MEMORY[0x277D85DE8];
  nCopy = n;
  v4 = [nCopy dataForKey:*MEMORY[0x277CD0270]];
  if (v4)
  {
    v11 = 0;
    v5 = [HMDNetworkRouterFirewallRuleManagerUtils dumpTLVsFromJSONData:v4 error:&v11];
    v6 = v11;
    v7 = v6;
    if (v5)
    {
      v12 = *MEMORY[0x277CD0278];
      v13[0] = v5;
      v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v13 forKeys:&v12 count:1];
      [nCopy respondWithPayload:v8];
    }

    else
    {
      if (!v6)
      {
        v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      }

      [nCopy respondWithError:v7];
    }
  }

  else
  {
    v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [nCopy respondWithError:v9];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallFetchCloudChangesRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy BOOLForKey:*MEMORY[0x277CD0AE0]];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke;
  v7[3] = &unk_278686428;
  v9 = v5;
  v8 = requestCopy;
  v6 = requestCopy;
  [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v6 completion:v7];
}

void __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3 = *(a1 + 40);
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke_2;
  v4[3] = &unk_278686400;
  v5 = *(a1 + 32);
  [a2 forceFetchCloudChangesAndForceChangeNotifications:v3 completion:v4];
}

uint64_t __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke_2(uint64_t a1, uint64_t a2, uint64_t a3)
{
  v3 = *(a1 + 32);
  if (a2)
  {
    a3 = 0;
  }

  return [v3 respondWithPayload:0 error:a3];
}

- (void)_handleNetworkFirewallRemoveLocalRulesRequest:(id)request
{
  requestCopy = request;
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke;
  v6[3] = &unk_2786863D8;
  v7 = requestCopy;
  v5 = requestCopy;
  [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v5 completion:v6];
}

void __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke_2;
  v3[3] = &unk_27868A250;
  v4 = *(a1 + 32);
  [a2 removeAllLocalRulesWithCompletion:v3];
}

- (void)_handleNetworkFirewallDumpPairedMetadataRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy stringForKey:*MEMORY[0x277CD0AC0]];
  v6 = [requestCopy stringForKey:*MEMORY[0x277CD0AC8]];
  v7 = [requestCopy stringForKey:*MEMORY[0x277CD0AA8]];
  v8 = [requestCopy BOOLForKey:*MEMORY[0x277CD0AB0]];
  v9 = [requestCopy BOOLForKey:*MEMORY[0x277CD0AD0]];
  if ((v5 != 0) != (v6 != 0))
  {
    goto LABEL_8;
  }

  if (v7 && v6 == 0)
  {
    goto LABEL_8;
  }

  v11 = v9;
  if (!v7)
  {
    v12 = 0;
    goto LABEL_11;
  }

  v12 = [objc_alloc(MEMORY[0x277D0F940]) initWithString:v7];
  if (v12)
  {
LABEL_11:
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke;
    v15[3] = &unk_2786863B0;
    v16 = requestCopy;
    v17 = v5;
    v18 = v6;
    v19 = v12;
    v20 = v8;
    v21 = v11;
    v14 = v12;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v16 completion:v15];

    goto LABEL_9;
  }

LABEL_8:
  v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [requestCopy respondWithError:v13];

LABEL_9:
}

void __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke_2;
  aBlock[3] = &unk_278686310;
  v7 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  [v4 dumpPairedMetadataForProductGroup:*(a1 + 40) productNumber:*(a1 + 48) firmwareVersion:*(a1 + 56) ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v5];
}

void __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0AD8];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallDumpLocalRulesRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy stringForKey:*MEMORY[0x277CD0A88]];
  v6 = [requestCopy stringForKey:*MEMORY[0x277CD0A90]];
  v7 = [requestCopy stringForKey:*MEMORY[0x277CD0A70]];
  v8 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A78]];
  v9 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A98]];
  if (v6)
  {
    v10 = v5 == 0;
  }

  else
  {
    v10 = 0;
  }

  if (v10)
  {
    goto LABEL_11;
  }

  if (v7 && v6 == 0)
  {
    goto LABEL_11;
  }

  v12 = v9;
  if (!v7)
  {
    v13 = 0;
    goto LABEL_14;
  }

  v13 = [objc_alloc(MEMORY[0x277D0F940]) initWithString:v7];
  if (v13)
  {
LABEL_14:
    v16[0] = MEMORY[0x277D85DD0];
    v16[1] = 3221225472;
    v16[2] = __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke;
    v16[3] = &unk_2786863B0;
    v17 = requestCopy;
    v18 = v6;
    v19 = v5;
    v20 = v13;
    v21 = v8;
    v22 = v12;
    v15 = v13;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v17 completion:v16];

    goto LABEL_12;
  }

LABEL_11:
  v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [requestCopy respondWithError:v14];

LABEL_12:
}

void __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke_2;
  aBlock[3] = &unk_278686310;
  v8 = *(a1 + 32);
  v4 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  v5 = *(a1 + 48);
  if (v6)
  {
    [v3 dumpLocalRulesForProductGroup:v5 productNumber:v6 firmwareVersion:*(a1 + 56) ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }

  else if (v5)
  {
    [v3 dumpLocalRulesForProductGroup:v5 ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }

  else
  {
    [v3 dumpAllLocalRulesIgnoringOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }
}

void __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0AA0];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallRemoveOverridesRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy stringForKey:*MEMORY[0x277CD0B00]];
  v6 = [requestCopy stringForKey:*MEMORY[0x277CD0B08]];
  if (v6)
  {
    v7 = v5 == 0;
  }

  else
  {
    v7 = 0;
  }

  if (v7)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [requestCopy respondWithError:v8];
  }

  else
  {
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke;
    v9[3] = &unk_278686388;
    v10 = requestCopy;
    v11 = v5;
    v12 = v6;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v10 completion:v9];
  }
}

void __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke_2;
  aBlock[3] = &unk_27868A250;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (v6)
  {
    [v4 removeOverridesForProductGroup:v6 productNumber:*(a1 + 48) completion:v5];
  }

  else
  {
    [v4 removeAllOverridesWithCompletion:v5];
  }
}

- (void)_handleNetworkFirewallAddOverridesRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy dataForKey:*MEMORY[0x277CD0A20]];
  if (v5)
  {
    v6 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A30]];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke;
    v8[3] = &unk_278686360;
    v9 = requestCopy;
    v11 = v6;
    v10 = v5;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v9 completion:v8];
  }

  else
  {
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [requestCopy respondWithError:v7];
  }
}

void __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke_2;
  aBlock[3] = &unk_27868A250;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (*(a1 + 48) == 1)
  {
    [v4 setOverrides:v6 completion:v5];
  }

  else
  {
    [v4 addOverrides:v6 completion:v5];
  }
}

- (void)_handleNetworkFirewallDumpCloudRecordsRequest:(id)request
{
  requestCopy = request;
  v5 = [requestCopy stringForKey:*MEMORY[0x277CD0A48]];
  v6 = [requestCopy stringForKey:*MEMORY[0x277CD0A50]];
  v7 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A58]];
  v8 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A38]];
  v9 = [requestCopy BOOLForKey:*MEMORY[0x277CD0A68]];
  if (!v5 || [v5 length])
  {
    if (v6)
    {
      v10 = [v6 length];
      if (v5)
      {
        v11 = v10 == 0;
      }

      else
      {
        v11 = 1;
      }

      if (!v11)
      {
        goto LABEL_12;
      }
    }

    else if (v5 || (v8 & 1) != 0)
    {
LABEL_12:
      v13[0] = MEMORY[0x277D85DD0];
      v13[1] = 3221225472;
      v13[2] = __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke;
      v13[3] = &unk_278686338;
      v14 = requestCopy;
      v17 = v8;
      v15 = v5;
      v18 = v7;
      v16 = v6;
      v19 = v9;
      [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v14 completion:v13];

      goto LABEL_13;
    }
  }

  v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [requestCopy respondWithError:v12];

LABEL_13:
}

void __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke_2;
  aBlock[3] = &unk_278686310;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (*(a1 + 56) == 1)
  {
    [v4 listCloudRecordsForProductGroup:v6 rawOutput:*(a1 + 57) completion:v5];
  }

  else
  {
    [v4 dumpCloudRecordsForProductGroup:v6 productNumber:*(a1 + 48) rawOutput:*(a1 + 57) verifySignatures:*(a1 + 58) completion:v5];
  }
}

void __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0A60];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)__startupFirewallRuleManagerForMessage:(id)message completion:(id)completion
{
  messageCopy = message;
  completionCopy = completion;
  v8 = [HMDTransientRuleManagerClient alloc];
  identifier = [messageCopy identifier];
  uUIDString = [identifier UUIDString];
  v11 = [(HMDTransientRuleManagerClient *)v8 initWithDescription:uUIDString];

  v12 = +[HMDNetworkRouterFirewallRuleManager sharedInstance];
  v17[0] = MEMORY[0x277D85DD0];
  v17[1] = 3221225472;
  v17[2] = __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke;
  v17[3] = &unk_2786862E8;
  v17[4] = self;
  v18 = messageCopy;
  v19 = v12;
  v20 = v11;
  v21 = completionCopy;
  v13 = completionCopy;
  v14 = v11;
  v15 = v12;
  v16 = messageCopy;
  [v15 startupForClient:v14 completion:v17];
}

void __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      *buf = 138543618;
      v18 = v7;
      v19 = 2112;
      v20 = v3;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to start up rule manager: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    [*(a1 + 40) respondWithError:v3];
  }

  else
  {
    v8 = [*(a1 + 40) responseHandler];
    v13[0] = MEMORY[0x277D85DD0];
    v13[1] = 3221225472;
    v13[2] = __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke_1276;
    v13[3] = &unk_2786862C0;
    v14 = *(a1 + 48);
    v15 = *(a1 + 56);
    v16 = v8;
    v9 = *(a1 + 40);
    v10 = v8;
    [v9 setResponseHandler:v13];
    v11 = *(a1 + 48);
    (*(*(a1 + 64) + 16))();
  }

  v12 = *MEMORY[0x277D85DE8];
}

void __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke_1276(uint64_t a1, void *a2, void *a3)
{
  v7 = a2;
  v5 = a3;
  [*(a1 + 32) shutdownForClient:*(a1 + 40)];
  v6 = *(a1 + 48);
  if (v6)
  {
    (*(v6 + 16))(v6, v7, v5);
  }
}

- (void)_logState:(id)state key:(id)key indent:(id)indent
{
  v55 = *MEMORY[0x277D85DE8];
  stateCopy = state;
  keyCopy = key;
  indentCopy = indent;
  v11 = indentCopy;
  if (indentCopy)
  {
    [indentCopy indentationByLevels:1];
  }

  else
  {
    [MEMORY[0x277D0F908] indentation];
  }
  v35 = ;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v32 = v11;
    v33 = keyCopy;
    v34 = stateCopy;
    v41 = 0u;
    v42 = 0u;
    v43 = 0u;
    v44 = 0u;
    v12 = stateCopy;
    v13 = [v12 countByEnumeratingWithState:&v41 objects:v54 count:16];
    if (v13)
    {
      v14 = v13;
      v15 = *v42;
      v36 = *MEMORY[0x277D0F170];
      v16 = 0x277CCA000uLL;
      do
      {
        for (i = 0; i != v14; ++i)
        {
          if (*v42 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v18 = *(*(&v41 + 1) + 8 * i);
          v19 = *(v16 + 3240);
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            if (([v18 isEqualToString:v36] & 1) == 0)
            {
              v20 = [v12 objectForKey:v18];
              [(HMDHomeManager *)self _logState:v20 key:v18 indent:v35];

              v16 = 0x277CCA000;
            }
          }

          else
          {
            v21 = objc_autoreleasePoolPush();
            selfCopy = self;
            v23 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
            {
              v24 = HMFGetLogIdentifier();
              v25 = objc_opt_class();
              *buf = 138544130;
              v47 = v24;
              v48 = 2112;
              v49 = v25;
              v50 = 2112;
              v51 = v18;
              v52 = 2112;
              v53 = v12;
              _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_ERROR, "%{public}@Cannot include key of non-NSString class %@: %@ in %@", buf, 0x2Au);

              v16 = 0x277CCA000;
            }

            objc_autoreleasePoolPop(v21);
          }
        }

        v14 = [v12 countByEnumeratingWithState:&v41 objects:v54 count:16];
      }

      while (v14);
    }

    keyCopy = v33;
    stateCopy = v34;
    v11 = v32;
LABEL_27:

    goto LABEL_28;
  }

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v26 = stateCopy;
    v27 = [v26 countByEnumeratingWithState:&v37 objects:v45 count:16];
    if (v27)
    {
      v28 = v27;
      v29 = *v38;
      do
      {
        for (j = 0; j != v28; ++j)
        {
          if (*v38 != v29)
          {
            objc_enumerationMutation(v26);
          }

          [(HMDHomeManager *)self _logState:*(*(&v37 + 1) + 8 * j) key:keyCopy indent:v11];
        }

        v28 = [v26 countByEnumeratingWithState:&v37 objects:v45 count:16];
      }

      while (v28);
    }

    goto LABEL_27;
  }

LABEL_28:

  v31 = *MEMORY[0x277D85DE8];
}

- (void)_dumpToLog:(id)log withState:(id)state
{
  logCopy = log;
  stateCopy = state;
  v7 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)self _logState:logCopy key:0 indent:0];
  [(HMDHomeManager *)self _logState:stateCopy key:0 indent:0];
  objc_autoreleasePoolPop(v7);
}

- (id)_destinationFromMessage:(id)message
{
  messageCopy = message;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __42__HMDHomeManager__destinationFromMessage___block_invoke;
  aBlock[3] = &unk_278686270;
  aBlock[4] = self;
  v5 = messageCopy;
  v25 = v5;
  v6 = _Block_copy(aBlock);
  v7 = [v5 uuidForKey:@"HomeUtilRemoteMessageTargetKey"];
  if (v7)
  {
    v8 = [v5 stringForKey:@"HomeUtilRemoteMessageDestinationKey"];
    if (v8)
    {
      v9 = [HMDDeviceHandle deviceHandleForDestination:v8];
      if (v9)
      {
        accountRegistry = [(HMDHomeManager *)self accountRegistry];
        v11 = [accountRegistry deviceForHandle:v9];

        v12 = [[HMDRemoteDeviceMessageDestination alloc] initWithTarget:v7 device:v11];
      }

      else
      {
        v11 = [HMDAccountHandle accountHandleForDestination:v8];
        if (v11)
        {
          v13 = [v5 dictionaryForKey:@"HomeUtilRemoteMessageDeviceCapabilitiesKey"];
          v12 = [[HMDRemoteAccountMessageDestination alloc] initWithTarget:v7 handle:v11 multicast:v13 == 0 deviceCapabilities:v13];
        }

        else
        {
          v13 = [v8 componentsSeparatedByString:@":"];
          if ([v13 count] >= 2 && (objc_msgSend(v13, "objectAtIndexedSubscript:", 0), v14 = objc_claimAutoreleasedReturnValue(), v15 = objc_msgSend(v14, "isEqualToString:", @"home"), v14, v15))
          {
            v16 = objc_alloc(MEMORY[0x277CCAD78]);
            v17 = [v13 objectAtIndexedSubscript:1];
            v18 = [v16 initWithUUIDString:v17];

            if (v18)
            {
              if ([v13 count] < 3)
              {
                v12 = [[HMDRemoteHomeMessageDestination alloc] initWithTarget:v7 homeUUID:v18];
              }

              else
              {
                v19 = objc_alloc_init(MEMORY[0x277CCABB8]);
                [v19 setNumberStyle:1];
                v20 = [v13 objectAtIndexedSubscript:2];
                v23 = v19;
                v21 = [v19 numberFromString:v20];

                if (v21)
                {
                  v12 = [[HMDRemoteHomeMessageDestination alloc] initWithTarget:v7 homeUUID:v18 queueTimeout:v21];
                }

                else
                {
                  v6[2](v6, @"Home destination queueTimeout is not a valid number");
                  v12 = 0;
                }
              }
            }

            else
            {
              v6[2](v6, @"Home destination has an invalid homeUUID");
              v12 = 0;
            }
          }

          else
          {
            v6[2](v6, @"Unknown device, account or home destination");
            v12 = 0;
          }
        }
      }
    }

    else
    {
      v6[2](v6, @"Remote destination string is missing");
      v12 = 0;
    }
  }

  else
  {
    v6[2](v6, @"Target UUID is missing");
    v12 = 0;
  }

  return v12;
}

void __42__HMDHomeManager__destinationFromMessage___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@HomeUtilRemoteMessageRequest: Invalid parameter: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *(a1 + 40);
  v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3 description:v3 reason:0 suggestion:0];
  [v8 respondWithError:v9];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_handleClearMobileAssetsInfoRequest:(id)request
{
  v21 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v20 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Received request to clear mobile assets info", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  mobileAssetManager = [(HMDHomeManager *)selfCopy mobileAssetManager];

  if (mobileAssetManager)
  {
    mobileAssetManager2 = [(HMDHomeManager *)selfCopy mobileAssetManager];
    v17[0] = MEMORY[0x277D85DD0];
    v17[1] = 3221225472;
    v17[2] = __54__HMDHomeManager__handleClearMobileAssetsInfoRequest___block_invoke;
    v17[3] = &unk_27868A250;
    v18 = requestCopy;
    [mobileAssetManager2 clearLocalInfoWithCompletion:v17];

    v11 = v18;
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = selfCopy;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v20 = v15;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@No mobile asset manager, bailing", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    [requestCopy respondWithError:v11];
  }

  v16 = *MEMORY[0x277D85DE8];
}

uint64_t __54__HMDHomeManager__handleClearMobileAssetsInfoRequest___block_invoke(uint64_t a1, uint64_t a2)
{
  v2 = *(a1 + 32);
  if (a2)
  {
    return [v2 respondWithError:a2];
  }

  else
  {
    return [v2 respondWithSuccess];
  }
}

- (void)_handleUpdateMobileAssetsRequest:(id)request
{
  v22 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v21 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Received request to update mobile assets", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  mobileAssetManager = [(HMDHomeManager *)selfCopy mobileAssetManager];

  if (mobileAssetManager)
  {
    v10 = [requestCopy BOOLForKey:*MEMORY[0x277CD01F8]];
    mobileAssetManager2 = [(HMDHomeManager *)selfCopy mobileAssetManager];
    v18[0] = MEMORY[0x277D85DD0];
    v18[1] = 3221225472;
    v18[2] = __51__HMDHomeManager__handleUpdateMobileAssetsRequest___block_invoke;
    v18[3] = &unk_278686298;
    v18[4] = selfCopy;
    v19 = requestCopy;
    [mobileAssetManager2 updateAssetsWithForce:v10 allowCatalogDownloadFailure:1 completion:v18];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = selfCopy;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v21 = v15;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@No mobile asset manager, bailing", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    v16 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    [requestCopy respondWithError:v16];
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __51__HMDHomeManager__handleUpdateMobileAssetsRequest___block_invoke(uint64_t a1, unint64_t a2, uint64_t a3, void *a4)
{
  v33 = *MEMORY[0x277D85DE8];
  v7 = a4;
  if (!v7)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    v15 = os_log_type_enabled(v14, OS_LOG_TYPE_INFO);
    if (a3 | a2)
    {
      if (v15)
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543874;
        v28 = v16;
        v29 = 2048;
        v30 = a2;
        v31 = 2048;
        v32 = a3;
        v17 = "%{public}@Updating mobile assets succeeded, old version %lu, new version %lu";
        v18 = v14;
        v19 = 32;
LABEL_10:
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, v17, buf, v19);
      }
    }

    else if (v15)
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v28 = v16;
      v17 = "%{public}@Updating mobile assets succeeded and didn't find any updates";
      v18 = v14;
      v19 = 12;
      goto LABEL_10;
    }

    objc_autoreleasePoolPop(v12);
    v20 = *(a1 + 40);
    v21 = [MEMORY[0x277CCABB0] numberWithInteger:{a2, *MEMORY[0x277CD02D0]}];
    v26[0] = v21;
    v25[1] = *MEMORY[0x277CD02C8];
    v22 = [MEMORY[0x277CCABB0] numberWithInteger:a3];
    v26[1] = v22;
    v23 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v26 forKeys:v25 count:2];
    [v20 respondWithPayload:v23];

    goto LABEL_12;
  }

  v8 = objc_autoreleasePoolPush();
  v9 = *(a1 + 32);
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    v11 = HMFGetLogIdentifier();
    *buf = 138543618;
    v28 = v11;
    v29 = 2112;
    v30 = v7;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Updating mobile assets failed with error: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  [*(a1 + 40) respondWithError:v7];
LABEL_12:

  v24 = *MEMORY[0x277D85DE8];
}

- (void)_handleHomeUtilRemoteMessageRequest:(id)request
{
  v35 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke;
  aBlock[3] = &unk_278686270;
  aBlock[4] = self;
  v5 = requestCopy;
  v30 = v5;
  v6 = _Block_copy(aBlock);
  v7 = [v5 stringForKey:@"HomeUtilRemoteMessageMessageNameKey"];
  if (v7)
  {
    v8 = [(HMDHomeManager *)self _destinationFromMessage:v5];
    if (v8)
    {
      v9 = [v5 dictionaryForKey:@"HomeUtilRemoteMessagePayloadKey"];
      v10 = [v5 numberForKey:@"HomeUtilRemoteMessageRestrictionKey"];
      v25 = v10;
      if (v10)
      {
        unsignedIntegerValue = [v10 unsignedIntegerValue];
      }

      else
      {
        unsignedIntegerValue = -1;
      }

      v12 = [v5 BOOLForKey:@"HomeUtilRemoteMessageIsSecureKey"];
      v13 = [v5 BOOLForKey:@"HomeUtilRemoteMessageIsOnewayKey"];
      v14 = v13;
      if (v13)
      {
        v15 = 3;
      }

      else
      {
        v15 = 0;
      }

      v16 = [[HMDRemoteMessage alloc] initWithName:v7 destination:v8 payload:v9 type:v15 timeout:v12 secure:unsignedIntegerValue restriction:0.0];
      if ((v14 & 1) == 0)
      {
        responseHandler = [v5 responseHandler];
        [(HMDRemoteMessage *)v16 setResponseHandler:responseHandler];
      }

      v18 = objc_autoreleasePoolPush();
      selfCopy = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        HMFGetLogIdentifier();
        v21 = v24 = v9;
        *buf = 138543618;
        v32 = v21;
        v33 = 2112;
        v34 = v16;
        _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@HomeUtilRemoteMessageRequest: Sending message: %@", buf, 0x16u);

        v9 = v24;
      }

      objc_autoreleasePoolPop(v18);
      messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
      v26[0] = MEMORY[0x277D85DD0];
      v26[1] = 3221225472;
      v26[2] = __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke_1246;
      v26[3] = &unk_27868A188;
      v28 = v15;
      v27 = v5;
      [messageDispatcher sendMessage:v16 completionHandler:v26];
    }
  }

  else
  {
    v6[2](v6, @"Message name is missing");
  }

  v23 = *MEMORY[0x277D85DE8];
}

void __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@HomeUtilRemoteMessageRequest: Invalid parameter: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *(a1 + 40);
  v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3 description:v3 reason:0 suggestion:0];
  [v8 respondWithError:v9];

  v10 = *MEMORY[0x277D85DE8];
}

uint64_t __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke_1246(uint64_t result, uint64_t a2)
{
  if (*(result + 40) == 3)
  {
    return [*(result + 32) respondWithPayload:0 error:a2];
  }

  return result;
}

- (void)_handleHomeUtilSetOverridesMessage:(id)message
{
  v21 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  v5 = [messageCopy dictionaryForKey:@"kConfigTestingOverrideKey"];
  if (!v5)
  {
    v8 = objc_autoreleasePoolPush();
    selfCopy = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      messagePayload = [messageCopy messagePayload];
      *buf = 138543874;
      v16 = v11;
      v17 = 2112;
      v18 = @"kConfigTestingOverrideKey";
      v19 = 2112;
      v20 = messagePayload;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_ERROR, "%{public}@Cannot handle set overrides message: No value for %@ in payload: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    goto LABEL_7;
  }

  v14 = 0;
  v6 = [(HMDHomeManager *)self _processTestModeOverridesPayload:v5 error:&v14];
  v7 = v14;
  if (!v6)
  {
LABEL_7:
    [messageCopy respondWithError:v7];
    goto LABEL_8;
  }

  [messageCopy respondWithSuccess];
LABEL_8:

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_handleTestModeConfigRequest:(id)request
{
  v25 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  demoModeManager = [(HMDHomeManager *)self demoModeManager];

  if (demoModeManager)
  {
    demoModeManager2 = [(HMDHomeManager *)self demoModeManager];
    messagePayload = [requestCopy messagePayload];
    v18 = 0;
    v8 = [demoModeManager2 handleTestModeConfigRequestPayload:messagePayload error:&v18];
    v9 = v18;

    if (v8)
    {
      [requestCopy respondWithPayload:v8];
    }

    else
    {
      [requestCopy respondWithError:v9];
    }
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    selfCopy = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      v14 = demoModeV2Status();
      *buf = 138543618;
      v22 = v13;
      v23 = 2112;
      v24 = v14;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Cannot handle test mode config request: HH2 demo mode is not enabled: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v15 = MEMORY[0x277CCA9B8];
    v19 = *MEMORY[0x277CCA450];
    v20 = @"Invalid demo mode v2 state";
    v16 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v20 forKeys:&v19 count:1];
    v9 = [v15 hmErrorWithCode:48 userInfo:v16];

    [requestCopy respondWithError:v9];
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (BOOL)_processTestModeOverridesPayload:(id)payload error:(id *)error
{
  payloadCopy = payload;
  v7 = [payloadCopy hmf_dictionaryForKey:@"kConfigTestingOverrideCurrentHomeKey"];
  if (v7)
  {
    v8 = [(HMDHomeManager *)self _processTestModeCurrentHomeOverride:v7 error:error];
  }

  else
  {
    v9 = [payloadCopy hmf_dictionaryForKey:@"kConfigTestingOverrideHomeLocationStatusKey"];
    if (v9)
    {
      v8 = [(HMDHomeManager *)self _processTestModeHomeLocationStatusOverride:v9 error:error];
    }

    else
    {
      v10 = [payloadCopy hmf_dictionaryForKey:@"kConfigTestingOverrideHomeAccessControlKey"];
      if (v10)
      {
        v8 = [(HMDHomeManager *)self _processTestModeHomeAccessControlOverride:v10 error:error];
      }

      else
      {
        v11 = [payloadCopy hmf_dictionaryForKey:@"kConfigTestingOverrideSkipHH2MigrationCheckDictionaryKey"];
        if (v11)
        {
          v8 = [(HMDHomeManager *)self _processTestModeSkipHH2MigrationOverride:v11 error:error];
        }

        else
        {
          v12 = [payloadCopy hmf_dictionaryForKey:@"kConfigTestingUpdateHomeLocationKey"];
          if (v12)
          {
            v8 = [(HMDHomeManager *)self _processTestModeUpdateHomeLocation:v12 error:error];
          }

          else if (error)
          {
            [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
            *error = v8 = 0;
          }

          else
          {
            v8 = 0;
          }
        }
      }
    }
  }

  return v8;
}

- (BOOL)_processTestModeSkipHH2MigrationOverride:(id)override error:(id *)error
{
  v21 = *MEMORY[0x277D85DE8];
  overrideCopy = override;
  v7 = [overrideCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeSkipHH2MigrationOverride:overrideCopy error:error];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    selfCopy = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set skip HH2 migration override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (error)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *error = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeHomeAccessControlOverride:(id)override error:(id *)error
{
  v22 = *MEMORY[0x277D85DE8];
  overrideCopy = override;
  v7 = [overrideCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (!v8)
  {
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v15;
      v20 = 2112;
      v21 = v7;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home access control override: no home found with UUID: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    if (error)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *error = v11 = 0;
      goto LABEL_9;
    }

LABEL_8:
    v11 = 0;
    goto LABEL_9;
  }

  if (![v8 _processTestModeHomeAccessControlOverride:overrideCopy error:error])
  {
    goto LABEL_8;
  }

  uuid = [(HMDHomeManager *)self uuid];
  v11 = 1;
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"kTestModeHomeAccessControlOverride" sourceUUID:uuid shouldNotifyClients:1];

LABEL_9:
  v16 = *MEMORY[0x277D85DE8];
  return v11;
}

- (BOOL)_processTestModeUpdateHomeLocation:(id)location error:(id *)error
{
  v21 = *MEMORY[0x277D85DE8];
  locationCopy = location;
  v7 = [locationCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeUpdateHomeLocation:locationCopy error:error];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    selfCopy = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home location override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (error)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *error = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeHomeLocationStatusOverride:(id)override error:(id *)error
{
  v21 = *MEMORY[0x277D85DE8];
  overrideCopy = override;
  v7 = [overrideCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeHomeLocationStatusOverride:overrideCopy error:error];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    selfCopy = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home location status override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (error)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *error = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeCurrentHomeOverride:(id)override error:(id *)error
{
  v24 = *MEMORY[0x277D85DE8];
  overrideCopy = override;
  if ([overrideCopy hmf_BOOLForKey:@"kConfigTestingResetOverrideKey"])
  {
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:0];
LABEL_7:
    __computedCurrentHomeUUID = [(HMDHomeManager *)self __computedCurrentHomeUUID];
    v13 = 1;
    [(HMDHomeManager *)self _notifyCurrentHomeUpdated:__computedCurrentHomeUUID isLocalUpdate:1];

    goto LABEL_8;
  }

  if ([overrideCopy hmf_BOOLForKey:@"kConfigTestingOverrideToNilKey"])
  {
    v7 = [MEMORY[0x277D0F788] BOOLeanWithBool:1];
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:v7];

    goto LABEL_7;
  }

  v8 = [overrideCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v9 = [(HMDHomeManager *)self _homeWithUUID:v8];
  if (v9)
  {
    v10 = v9;
    [(HMDHomeManager *)self setCurrentHomeUUIDOverride:v8];
    v11 = [MEMORY[0x277D0F788] BOOLeanWithBool:0];
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:v11];

    goto LABEL_7;
  }

  v16 = objc_autoreleasePoolPush();
  selfCopy = self;
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
  {
    v19 = HMFGetLogIdentifier();
    v20 = 138543618;
    v21 = v19;
    v22 = 2112;
    v23 = v8;
    _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_ERROR, "%{public}@Cannot set current home override: no home found with UUID: %@", &v20, 0x16u);
  }

  objc_autoreleasePoolPop(v16);
  if (error)
  {
    *error = [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
  }

  v13 = 0;
LABEL_8:

  v14 = *MEMORY[0x277D85DE8];
  return v13;
}

- (id)__dumpHomeManagerDataWithPrivacyLevel:(unint64_t)level
{
  v82 = *MEMORY[0x277D85DE8];
  v4 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:7];
  string = [MEMORY[0x277CCAB68] string];
  mainBundle = [MEMORY[0x277CCA8D8] mainBundle];
  infoDictionary = [mainBundle infoDictionary];
  v7 = [infoDictionary objectForKey:*MEMORY[0x277CBED58]];
  [string appendFormat:@"homed: %@  ", v7];

  v8 = +[HMDHAPMetadata getSharedInstance];
  v9 = +[HMDHAPMetadata getBuiltinInstance];
  schemaVersion = [v8 schemaVersion];
  v68 = v8;
  version = [v8 version];
  schemaVersion2 = [v9 schemaVersion];
  v67 = v9;
  version2 = [v9 version];
  [string appendFormat:@"Metadata - Current: %@/%@   Builtin: %@/%@\n", schemaVersion, version, schemaVersion2, version2];

  v70 = string;
  [v4 setObject:string forKeyedSubscript:*MEMORY[0x277D0F0B0]];
  v14 = MEMORY[0x277CCACA8];
  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];
  uUIDString = [primaryHomeUUID UUIDString];
  currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
  uUIDString2 = [currentHomeUUID UUIDString];
  [(HMDHomeManager *)self isAccessAllowedWhenLocked];
  v19 = HMFBooleanToString();
  v20 = getLastSyncedAssistantConfigurationVersion();
  v21 = getAssistantConfigurationSnapshot();
  v22 = [v14 stringWithFormat:@"Primary Home: %@, Current Home: %@, Allow locked access: %@, Siri lastSyncedVersion: %@  currentSyncSnapshot: %@", uUIDString, uUIDString2, v19, v20, v21];

  v66 = v22;
  [v4 setObject:v22 forKeyedSubscript:*MEMORY[0x277D0F0C0]];
  syncManager = [(HMDHomeManager *)self syncManager];
  dumpState = [syncManager dumpState];
  [v4 setObject:dumpState forKeyedSubscript:*MEMORY[0x277D0F178]];

  appData = [(HMDHomeManager *)self appData];
  v26 = [appData dumpStateWithPrivacyLevel:level];
  [v4 setObject:v26 forKeyedSubscript:*MEMORY[0x277D0F050]];

  homes = [(HMDHomeManager *)self homes];
  v28 = [homes count];

  if (v28)
  {
    v29 = MEMORY[0x277CBEB18];
    homes2 = [(HMDHomeManager *)self homes];
    v31 = [v29 arrayWithCapacity:{objc_msgSend(homes2, "count")}];

    homes3 = [(HMDHomeManager *)self homes];
    v78[0] = MEMORY[0x277D85DD0];
    v78[1] = 3221225472;
    v78[2] = __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke;
    v78[3] = &unk_278686220;
    v79 = v31;
    levelCopy = level;
    v33 = v31;
    [homes3 hmf_enumerateWithAutoreleasePoolUsingBlock:v78];

    [v4 setObject:v33 forKey:*MEMORY[0x277D0F0B8]];
  }

  systemStore = [MEMORY[0x277CFEC78] systemStore];
  dumpState2 = [systemStore dumpState];
  [v4 setObject:dumpState2 forKey:*MEMORY[0x277D0F0F0]];

  v36 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:2];
  array = [MEMORY[0x277CBEB18] array];
  v74 = 0u;
  v75 = 0u;
  v76 = 0u;
  v77 = 0u;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v39 = [incomingInvitations copy];

  v40 = [v39 countByEnumeratingWithState:&v74 objects:v81 count:16];
  if (v40)
  {
    v41 = v40;
    v42 = *v75;
    do
    {
      for (i = 0; i != v41; ++i)
      {
        if (*v75 != v42)
        {
          objc_enumerationMutation(v39);
        }

        describeWithFormat = [*(*(&v74 + 1) + 8 * i) describeWithFormat];
        [array addObject:describeWithFormat];
      }

      v41 = [v39 countByEnumeratingWithState:&v74 objects:v81 count:16];
    }

    while (v41);
  }

  [v36 setObject:array forKeyedSubscript:*MEMORY[0x277D0F0D8]];
  array2 = [MEMORY[0x277CBEB18] array];
  homes4 = [(HMDHomeManager *)self homes];
  v72[0] = MEMORY[0x277D85DD0];
  v72[1] = 3221225472;
  v72[2] = __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke_2;
  v72[3] = &unk_278685B78;
  v47 = array2;
  v73 = v47;
  [homes4 hmf_enumerateWithAutoreleasePoolUsingBlock:v72];

  [v36 setObject:v47 forKeyedSubscript:*MEMORY[0x277D0F110]];
  [v4 setObject:v36 forKeyedSubscript:*MEMORY[0x277D0F0E0]];
  v48 = MEMORY[0x277CCACA8];
  v49 = (_os_feature_enabled_impl() & 1) != 0 || CFPreferencesGetAppBooleanValue(@"MatterTTU", @"/Library/Managed Preferences/mobile/com.apple.homed.plist", 0) != 0;
  v50 = [v48 stringWithFormat:@"%d", v49];
  [v4 setObject:v50 forKeyedSubscript:@"HM_FEATURE_MATTER_TTU_ENABLED_FEATURE_OR_PROFILE"];

  v51 = [MEMORY[0x277CCACA8] stringWithFormat:@"%d", 1];
  [v4 setObject:v51 forKeyedSubscript:@"HM_FEATURE_UWB_ENABLED_FEATURE_AND_PROFILE"];

  v52 = [MEMORY[0x277CCACA8] stringWithFormat:@"%d", isFeatureMatteriPhoneOnlyPairingControlEnabled()];
  [v4 setObject:v52 forKeyedSubscript:@"iPhoneOnlyPairingAndControl (iPOP)"];

  v53 = MEMORY[0x277CCACA8];
  currentDeviceAliroVersion = [(HMDHomeManager *)self currentDeviceAliroVersion];
  v55 = [v53 stringWithFormat:@"%@", currentDeviceAliroVersion];
  [v4 setObject:v55 forKeyedSubscript:@"Current device Aliro version"];

  v56 = +[HMDHomeKeyDataRecorder sharedRecorder];
  records = [v56 records];
  [v4 setObject:records forKeyedSubscript:@"Home Key Change Records"];

  bgOpsManager = [(HMDHomeManager *)self bgOpsManager];
  v59 = [bgOpsManager dumpStateWithPrivacyLevel:level];
  [v4 setObject:v59 forKeyedSubscript:@"Background operations"];

  mobileAssetManager = [(HMDHomeManager *)self mobileAssetManager];
  dumpState3 = [mobileAssetManager dumpState];
  [v4 setObject:dumpState3 forKeyedSubscript:@"MobileAssetManager"];

  v62 = objc_alloc_init(MEMORY[0x277CD55A8]);
  storedValuesByKey = [v62 storedValuesByKey];
  [v4 setObject:storedValuesByKey forKeyedSubscript:@"System Commissioner Key-Value Store"];

  v64 = *MEMORY[0x277D85DE8];

  return v4;
}

void __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 dumpStateWithPrivacyLevel:*(a1 + 40)];
  [v2 addObject:v3];
}

void __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke_2(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v3 = [a2 outgoingInvitations];
  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v12;
    do
    {
      v7 = 0;
      do
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(a1 + 32);
        v9 = [*(*(&v11 + 1) + 8 * v7) describeWithFormat];
        [v8 addObject:v9];

        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v5);
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (id)_dumpHomeManagerDataWithPrivacyLevel:(unint64_t)level
{
  v5 = objc_autoreleasePoolPush();
  v6 = [(HMDHomeManager *)self __dumpHomeManagerDataWithPrivacyLevel:level];
  objc_autoreleasePoolPop(v5);

  return v6;
}

- (void)_handleNetworkMismatchInfo:(id)info
{
  v17 = *MEMORY[0x277D85DE8];
  infoCopy = info;
  if (isInternalBuild())
  {
    v5 = +[HMDMainDriver driver];
    currentWiFiNetworkInfo = [v5 currentWiFiNetworkInfo];
    v13[0] = MEMORY[0x277D85DD0];
    v13[1] = 3221225472;
    v13[2] = __45__HMDHomeManager__handleNetworkMismatchInfo___block_invoke;
    v13[3] = &unk_278686248;
    v13[4] = self;
    v14 = infoCopy;
    [(HMDHomeManager *)self findAccessoriesNotOnWiFiWithCurrentWiFi:currentWiFiNetworkInfo completionHandler:v13];
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v16 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@Not internal build NetworkMismatchInfo message not allowed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [infoCopy respondWithError:v11];
  }

  v12 = *MEMORY[0x277D85DE8];
}

void __45__HMDHomeManager__handleNetworkMismatchInfo___block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543618;
    v10 = v7;
    v11 = 2112;
    v12 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@wifi mismatch accessories %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 40) respondWithSuccess];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_handleDiagnosticInfo:(id)info
{
  v22[1] = *MEMORY[0x277D85DE8];
  infoCopy = info;
  if (isInternalBuild())
  {
    appleMediaAccessoryDiagnosticInfoController = [(HMDHomeManager *)self appleMediaAccessoryDiagnosticInfoController];
    v22[0] = *MEMORY[0x277CD0118];
    v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v22 count:1];
    v7 = [appleMediaAccessoryDiagnosticInfoController diagnosticInfoDataWithAdditionalKeys:v6];

    v8 = [HMDAppleMediaAccessoryDiagnosticInfoController diagnosticInfoDescriptionWithData:v7];
    v9 = objc_autoreleasePoolPush();
    selfCopy = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v12;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Obtained diagnostic Info %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [infoCopy respondWithPayload:v8];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v16;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Not internal build DiagnosticInfo message not allowed", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [infoCopy respondWithError:v7];
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_handleDumpState:(id)state
{
  stateCopy = state;
  v5 = [stateCopy arrayForKey:*MEMORY[0x277CD2260]];
  if ([v5 count])
  {
    v6 = [v5 containsObject:*MEMORY[0x277CD2200]];
  }

  else
  {
    v6 = 1;
  }

  messagePayload = [stateCopy messagePayload];
  v8 = [messagePayload hmf_numberForKey:*MEMORY[0x277CD0740]];
  unsignedIntValue = [v8 unsignedIntValue];

  activity = [stateCopy activity];
  v11 = [(HMDHomeManager *)self _getRequestedState:v5 activity:activity privacyLevel:unsignedIntValue];

  v12 = objc_autoreleasePoolPush();
  if (v6 & 1) != 0 || ([v5 containsObject:*MEMORY[0x277CD0188]])
  {
    v13 = +[HMDXPCMessageCountTracker sharedTracker];
    stateDump = [v13 stateDump];
    [v11 setObject:stateDump forKeyedSubscript:@"XPC Message Count Tracker"];

    v15 = +[HMDXPCMessageTransport defaultTransport];
    stateDump2 = [v15 stateDump];
    [v11 setObject:stateDump2 forKeyedSubscript:@"Default XPC Transport"];

    v17 = +[HMDXPCMessageTransport accessorySetupTransport];
    stateDump3 = [v17 stateDump];
    [v11 setObject:stateDump3 forKeyedSubscript:@"Accessory Setup XPC Transport"];

    objc_autoreleasePoolPop(v12);
    v19 = objc_autoreleasePoolPush();
    if (v6)
    {
      v20 = *MEMORY[0x277CD0168];
      goto LABEL_10;
    }
  }

  else
  {
    objc_autoreleasePoolPop(v12);
    v19 = objc_autoreleasePoolPush();
  }

  v20 = *MEMORY[0x277CD0168];
  if (([v5 containsObject:*MEMORY[0x277CD0168]] & 1) == 0)
  {
    objc_autoreleasePoolPop(v19);
    v23 = objc_autoreleasePoolPush();
    goto LABEL_13;
  }

LABEL_10:
  compositeSettingsControllerManager = [(HMDHomeManager *)self compositeSettingsControllerManager];
  dumpStateInfo = [compositeSettingsControllerManager dumpStateInfo];
  [v11 setObject:dumpStateInfo forKeyedSubscript:v20];

  objc_autoreleasePoolPop(v19);
  v23 = objc_autoreleasePoolPush();
  if (v6)
  {
    v24 = *MEMORY[0x277CD0178];
LABEL_14:
    dictionary = [MEMORY[0x277CBEB38] dictionary];
    eventRouterXPCServer = [(HMDHomeManager *)self eventRouterXPCServer];
    dumpStateDescription = [eventRouterXPCServer dumpStateDescription];
    [dictionary setObject:dumpStateDescription forKeyedSubscript:@"XPCServer"];

    homes = [(HMDHomeManager *)self homes];
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __35__HMDHomeManager__handleDumpState___block_invoke;
    v38[3] = &unk_278685B78;
    v39 = dictionary;
    v29 = dictionary;
    [homes hmf_enumerateWithAutoreleasePoolUsingBlock:v38];

    v30 = [v29 copy];
    [v11 setObject:v30 forKeyedSubscript:v24];

    goto LABEL_15;
  }

LABEL_13:
  v24 = *MEMORY[0x277CD0178];
  if ([v5 containsObject:*MEMORY[0x277CD0178]])
  {
    goto LABEL_14;
  }

LABEL_15:
  objc_autoreleasePoolPop(v23);
  v31 = [(HMDHomeManager *)self _dumpHomeManagerDataWithPrivacyLevel:unsignedIntValue];
  if ([v5 containsObject:*MEMORY[0x277CD0170]] && objc_msgSend(stateCopy, "isEntitledForStateDump"))
  {
    [v11 setObject:v31 forKeyedSubscript:*MEMORY[0x277CD2220]];
  }

  else
  {
    [(HMDHomeManager *)self _dumpToLog:v31 withState:v11];
  }

  v32 = [MEMORY[0x277CCABB0] numberWithBool:1];
  [v11 setObject:v32 forKeyedSubscript:*MEMORY[0x277CD0258]];

  v33 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isThisDesignatedFMFDevice](self, "isThisDesignatedFMFDevice")}];
  [v11 setObject:v33 forKeyedSubscript:*MEMORY[0x277CD0268]];

  v34 = CFPreferencesCopyMultiple(0, *MEMORY[0x277CD0030], *MEMORY[0x277CBF040], *MEMORY[0x277CBF030]);
  [v11 setObject:v34 forKeyedSubscript:*MEMORY[0x277CD2278]];

  powerManager = [(HMDHomeManager *)self powerManager];
  if ([powerManager isPowerAsserted])
  {
    v36 = @"YES";
  }

  else
  {
    v36 = @"NO";
  }

  [v11 setObject:v36 forKeyedSubscript:*MEMORY[0x277CCFD00]];

  v37 = [v11 copy];
  [stateCopy respondWithPayload:v37];
}

void __35__HMDHomeManager__handleDumpState___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 eventRouterDumpStateInfo];
  [v2 addEntriesFromDictionary:v3];
}

- (id)_getRequestedState:(id)state activity:(id)activity privacyLevel:(unint64_t)level
{
  v254 = *MEMORY[0x277D85DE8];
  stateCopy = state;
  activityCopy = activity;
  v9 = objc_opt_new();
  v10 = [stateCopy count];
  v11 = &unk_22A586000;
  v12 = MEMORY[0x277CD2270];
  v228 = activityCopy;
  if (v10 && ([stateCopy containsObject:*MEMORY[0x277CD2200]] & 1) == 0)
  {
    if (![stateCopy containsObject:*MEMORY[0x277CD2218]])
    {
      goto LABEL_44;
    }

    selfCopy2 = self;
    v226 = v9;
    v227 = stateCopy;
    v224 = 0;
  }

  else
  {
    selfCopy2 = self;
    v226 = v9;
    v227 = stateCopy;
    v224 = 1;
  }

  array = [MEMORY[0x277CBEB18] array];
  maximumHomes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumHomes", maximumHomes];
  [array addObject:maximumHomes];

  maximumAccessoriesPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumAccessoriesPerHome", maximumAccessoriesPerHome];
  [array addObject:maximumAccessoriesPerHome];

  maximumRoomsPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumRoomsPerHome", maximumRoomsPerHome];
  [array addObject:maximumRoomsPerHome];

  maximumZonesPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumZonesPerHome", maximumZonesPerHome];
  [array addObject:maximumZonesPerHome];

  maximumTriggersPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumTriggersPerHome", maximumTriggersPerHome];
  [array addObject:maximumTriggersPerHome];

  maximumActionSetsPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumActionSetsPerHome", maximumActionSetsPerHome];
  [array addObject:maximumActionSetsPerHome];

  maximumServiceGroupsPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServiceGroupsPerHome", maximumServiceGroupsPerHome];
  [array addObject:maximumServiceGroupsPerHome];

  maximumUsersPerHome = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumUsersPerHome", maximumUsersPerHome];
  [array addObject:maximumUsersPerHome];

  maximumRoomsPerZone = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumRoomsPerZone", maximumRoomsPerZone];
  [array addObject:maximumRoomsPerZone];

  maximumActionsPerActionSet = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumActionsPerActionSet", maximumActionsPerActionSet];
  [array addObject:maximumActionsPerActionSet];

  maximumServicesPerServiceGroup = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServicesPerServiceGroup", maximumServicesPerServiceGroup];
  [array addObject:maximumServicesPerServiceGroup];

  maximumAccessoriesPerBridge = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumAccessoriesPerBridge", maximumAccessoriesPerBridge];
  [array addObject:maximumAccessoriesPerBridge];

  maximumServicesPerAccessory = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServicesPerAccessory", maximumServicesPerAccessory];
  [array addObject:maximumServicesPerAccessory];

  maximumCharacteristicsPerService = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumCharacteristicsPerService", maximumCharacteristicsPerService];
  [array addObject:maximumCharacteristicsPerService];

  maximumDataSyncFragmentSize = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumDataSyncFragmentSize", maximumDataSyncFragmentSize];
  [array addObject:maximumDataSyncFragmentSize];

  minimumTimerRecurrence = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %f", @"minimumTimerRecurrence", minimumTimerRecurrence];
  [array addObject:minimumTimerRecurrence];

  cloudPushBatchLimit = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudPushBatchLimit", cloudPushBatchLimit];
  [array addObject:cloudPushBatchLimit];

  maxCloudOperationRetries = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maxCloudOperationRetries", maxCloudOperationRetries];
  [array addObject:maxCloudOperationRetries];

  cloudUploadTimerInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudUploadTimerInterval", cloudUploadTimerInterval];
  [array addObject:cloudUploadTimerInterval];

  cloudZoneUploadTimerInitialInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudZoneUploadTimerInitialInterval", cloudZoneUploadTimerInitialInterval];
  [array addObject:cloudZoneUploadTimerInitialInterval];

  cloudZoneUploadTimerInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudZoneUploadTimerInterval", cloudZoneUploadTimerInterval];
  [array addObject:cloudZoneUploadTimerInterval];

  aggressiveControllerKeyPollInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"aggressiveControllerKeyPollInterval", aggressiveControllerKeyPollInterval];
  [array addObject:aggressiveControllerKeyPollInterval];

  watchdogControllerKeyPollTimeout = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"watchdogControllerKeyPollTimeout", watchdogControllerKeyPollTimeout];
  [array addObject:watchdogControllerKeyPollTimeout];

  controllerKeyPollInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyPollInterval", controllerKeyPollInterval];
  [array addObject:controllerKeyPollInterval];

  keychainPopupTimerInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"keychainPopupTimerInterval", keychainPopupTimerInterval];
  [array addObject:keychainPopupTimerInterval];

  checkRemoteAccessTimeout = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"checkRemoteAccessTimeout", checkRemoteAccessTimeout];
  [array addObject:checkRemoteAccessTimeout];

  hrsCommitTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsCommitTimeout", hrsCommitTimeoutNanoseconds];
  [array addObject:hrsCommitTimeoutNanoseconds];

  hrsIdleClientTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsIdleClientTimeout", hrsIdleClientTimeoutNanoseconds];
  [array addObject:hrsIdleClientTimeoutNanoseconds];

  hrsIdleServertTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsIdleServertTimeout", hrsIdleServertTimeoutNanoseconds];
  [array addObject:hrsIdleServertTimeoutNanoseconds];

  hrsSendInternalRequestTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendInternalRequestTimeout", hrsSendInternalRequestTimeoutNanoseconds];
  [array addObject:hrsSendInternalRequestTimeoutNanoseconds];

  hrsSendInternalRequestToWatchTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendInternalRequestToWatchTimeout", hrsSendInternalRequestToWatchTimeoutNanoseconds];
  [array addObject:hrsSendInternalRequestToWatchTimeoutNanoseconds];

  hrsSendUserRequestTimeoutNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendUserRequestTimeout", hrsSendUserRequestTimeoutNanoseconds];
  [array addObject:hrsSendUserRequestTimeoutNanoseconds];

  maximumSecureRemoteStreams = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"maximumSecureRemoteStreams", maximumSecureRemoteStreams];
  [array addObject:maximumSecureRemoteStreams];

  secureSessionMessageTimeout = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %f", @"secureSessionMessageTimeout", secureSessionMessageTimeout];
  [array addObject:secureSessionMessageTimeout];

  deviceConnectionKeepAliveTimerPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"DeviceConnectionKeepAliveTimerPeriod", deviceConnectionKeepAliveTimerPeriod];
  [array addObject:deviceConnectionKeepAliveTimerPeriod];

  deviceConnectionKeepAliveResponseTimeoutPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"DeviceConnectionKeepAliveResponseTimeoutPeriod", deviceConnectionKeepAliveResponseTimeoutPeriod];
  [array addObject:deviceConnectionKeepAliveResponseTimeoutPeriod];

  supportedResolutions = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedResolutions", supportedResolutions];
  [array addObject:supportedResolutions];

  supportedVideoCodecs = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedVideoCodecs", supportedVideoCodecs];
  [array addObject:supportedVideoCodecs];

  supportedAudioCodecs = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedAudioCodecs", supportedAudioCodecs];
  [array addObject:supportedAudioCodecs];

  supportedSRTPAuths = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedSRTPAuths", supportedSRTPAuths];
  [array addObject:supportedSRTPAuths];

  v54 = MEMORY[0x277CCACA8];
  v55 = HMFBooleanToString();
  v56 = [v54 stringWithFormat:@"%@: %@", @"CameraStreamNetworkAdaptation", v55];
  [array addObject:v56];

  rtpPtime = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"RTPPtime", rtpPtime];
  [array addObject:rtpPtime];

  snapshotResolution = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SnapshotResolution", snapshotResolution];
  [array addObject:snapshotResolution];

  maximumSimultaneousRemoteStreams = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"MaximumSimultaneousRemoteStreams", maximumSimultaneousRemoteStreams];
  [array addObject:maximumSimultaneousRemoteStreams];

  snapshotCacheValidPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %g", @"SnapshotCacheValidPeriod", snapshotCacheValidPeriod];
  [array addObject:snapshotCacheValidPeriod];

  bulletinSecureTriggerTimeoutInSeconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"BulletinSecureTriggerTimeoutInSeconds", bulletinSecureTriggerTimeoutInSeconds];
  [array addObject:bulletinSecureTriggerTimeoutInSeconds];

  broadcastKeyRefreshTimeInSeconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"BroadcastKeyRefreshTimeInSeconds", broadcastKeyRefreshTimeInSeconds];
  [array addObject:broadcastKeyRefreshTimeInSeconds];

  bluetoothGSNMaxValue = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"BluetoothGSNMaxValue", bluetoothGSNMaxValue];
  [array addObject:bluetoothGSNMaxValue];

  btleReachabilityTimerNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"btleReachabilityTimer", btleReachabilityTimerNanoseconds];
  [array addObject:btleReachabilityTimerNanoseconds];

  btleReachabilityLeewayNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"btleReachabilityLeeway", btleReachabilityLeewayNanoseconds];
  [array addObject:btleReachabilityLeewayNanoseconds];

  btleReachabilityProbeReduceFactor = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"btleReachabilityProbeReduceFactor", btleReachabilityProbeReduceFactor];
  [array addObject:btleReachabilityProbeReduceFactor];

  remotePendingResponseTimerNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"remotePendingResponseTimer", remotePendingResponseTimerNanoseconds];
  [array addObject:remotePendingResponseTimerNanoseconds];

  remotePendingResponseLeewayNanoseconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"remotePendingResponseLeeway", remotePendingResponseLeewayNanoseconds];
  [array addObject:remotePendingResponseLeewayNanoseconds];

  remotePendingResponseDecayScale = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"remotePendingResponseDecayScale", remotePendingResponseDecayScale];
  [array addObject:remotePendingResponseDecayScale];

  remoteDeviceMonitorHealthTimerTimeInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorHealthTimerTimeInterval", remoteDeviceMonitorHealthTimerTimeInterval];
  [array addObject:remoteDeviceMonitorHealthTimerTimeInterval];

  remoteDeviceMonitorRetryTimerMinimumTimeInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorRetryTimerMinimumTimeInterval", remoteDeviceMonitorRetryTimerMinimumTimeInterval];
  [array addObject:remoteDeviceMonitorRetryTimerMinimumTimeInterval];

  remoteDeviceMonitorRetryTimerMaximumTimeInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorRetryTimerMaximumTimeInterval", remoteDeviceMonitorRetryTimerMaximumTimeInterval];
  [array addObject:remoteDeviceMonitorRetryTimerMaximumTimeInterval];

  remoteDeviceMonitorRetryTimerFactor = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"remoteDeviceMonitorRetryTimerFactor", remoteDeviceMonitorRetryTimerFactor];
  [array addObject:remoteDeviceMonitorRetryTimerFactor];

  accessoryConnectivityWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"accessoryConnectivityWaitPeriod", accessoryConnectivityWaitPeriod];
  [array addObject:accessoryConnectivityWaitPeriod];

  cloudDataSyncInProgressWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"cloudDataSyncInProgressWaitPeriod", cloudDataSyncInProgressWaitPeriod];
  [array addObject:cloudDataSyncInProgressWaitPeriod];

  controllerKeyNotLandingWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyNotLandingWaitPeriod", controllerKeyNotLandingWaitPeriod];
  [array addObject:controllerKeyNotLandingWaitPeriod];

  controllerKeyNotLandingShortCircuitWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyNotLandingShortCircuitWaitPeriod", controllerKeyNotLandingShortCircuitWaitPeriod];
  [array addObject:controllerKeyNotLandingShortCircuitWaitPeriod];

  assistantClientReadWriteTimeoutSeconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"assistantClientReadWriteTimeout", assistantClientReadWriteTimeoutSeconds];
  [array addObject:assistantClientReadWriteTimeoutSeconds];

  assistantClientActionSetTimeoutSeconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"assistantClientActionSetTimeout", assistantClientActionSetTimeoutSeconds];
  [array addObject:assistantClientActionSetTimeoutSeconds];

  disableNotificationsDeferPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"disableNotificationsDeferPeriod", disableNotificationsDeferPeriod];
  [array addObject:disableNotificationsDeferPeriod];

  coalesceNotificationsPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"coalesceNotificationsPeriod", coalesceNotificationsPeriod];
  [array addObject:coalesceNotificationsPeriod];

  delayNotificationsPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"delayNotificationsPeriod", delayNotificationsPeriod];
  [array addObject:delayNotificationsPeriod];

  pendingResponseTickPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pendingResponseTickPeriod", pendingResponseTickPeriod];
  [array addObject:pendingResponseTickPeriod];

  pendingResponseMaxPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pendingResponseMaxPeriod", pendingResponseMaxPeriod];
  [array addObject:pendingResponseMaxPeriod];

  remoteReachabilityNotificationsDeferPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"kRemoteReachabilitNotificationsDeferPeriod", remoteReachabilityNotificationsDeferPeriod];
  [array addObject:remoteReachabilityNotificationsDeferPeriod];

  remoteReachabilityDeregistrationDeferPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"kRemoteReachabilityDeregistrationDeferPeriod", remoteReachabilityDeregistrationDeferPeriod];
  [array addObject:remoteReachabilityDeregistrationDeferPeriod];

  if (skipAuthPromptDialog)
  {
    v87 = @"YES";
  }

  else
  {
    v87 = @"NO";
  }

  v88 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"allowSkipMFIPrompt", v87];
  [array addObject:v88];

  if (showAuthDialog)
  {
    v89 = @"YES";
  }

  else
  {
    v89 = @"NO";
  }

  v90 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"showAuthDialog", v89];
  [array addObject:v90];

  if (disableCloudDataSync)
  {
    v91 = @"YES";
  }

  else
  {
    v91 = @"NO";
  }

  v92 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"DisableCloudDataSync", v91];
  [array addObject:v92];

  if (disableLegacyCloudDataSync)
  {
    v93 = @"YES";
  }

  else
  {
    v93 = @"NO";
  }

  v94 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"DisableLegacyCloudDataSync", v93];
  [array addObject:v94];

  if (enableWakeNotifications)
  {
    v95 = @"YES";
  }

  else
  {
    v95 = @"NO";
  }

  v96 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"EnableWakeNotifications", v95];
  [array addObject:v96];

  pairingInterruptionGracePeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pairingInterruptionGracePeriod", pairingInterruptionGracePeriod];
  [array addObject:pairingInterruptionGracePeriod];

  pairingReconfirmWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pairingReconfirmWaitPeriod", pairingReconfirmWaitPeriod];
  [array addObject:pairingReconfirmWaitPeriod];

  vendorInfoFetchPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"vendorInfoFetchPeriod", vendorInfoFetchPeriod];
  [array addObject:vendorInfoFetchPeriod];

  attestationInfoFetchPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"attestationInfoFetchPeriod", attestationInfoFetchPeriod];
  [array addObject:attestationInfoFetchPeriod];

  keyTransferBroadcastMaximumDelay = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"keyTransferBroadcastMaximumDelay", keyTransferBroadcastMaximumDelay];
  [array addObject:keyTransferBroadcastMaximumDelay];

  vendorInfoDatabaseServerURLOverride = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"vendorInfoDatabaseServerURLOverride", vendorInfoDatabaseServerURLOverride];
  [array addObject:vendorInfoDatabaseServerURLOverride];

  appleConfigurationServer = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"appleConfigurationServer", appleConfigurationServer];
  [array addObject:appleConfigurationServer];

  homeKitConfigurationPath = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"homeKitConfigurationPath", homeKitConfigurationPath];
  [array addObject:homeKitConfigurationPath];

  mediaBrowserProcessingInterval = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"mediaBrowserProcessingInterval", mediaBrowserProcessingInterval];
  [array addObject:mediaBrowserProcessingInterval];

  disableReprivsionBrowsingPeriodInMinutes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"disableReprivsionBrowsingPeriodInMinutes", disableReprivsionBrowsingPeriodInMinutes];
  [array addObject:disableReprivsionBrowsingPeriodInMinutes];

  authServerRetryTimeIntervalInSeconds = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"authServerRetryTimeIntervalInSeconds", authServerRetryTimeIntervalInSeconds];
  [array addObject:authServerRetryTimeIntervalInSeconds];

  authServerRetryCount = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"authServerRetryCount", authServerRetryCount];
  v109 = array;
  [array addObject:authServerRetryCount];

  v251 = 0u;
  v252 = 0u;
  v249 = 0u;
  v250 = 0u;
  obj = preferredPrimaryForHome;
  v110 = [obj countByEnumeratingWithState:&v249 objects:v253 count:16];
  if (v110)
  {
    v111 = v110;
    v112 = *v250;
    do
    {
      for (i = 0; i != v111; ++i)
      {
        if (*v250 != v112)
        {
          objc_enumerationMutation(obj);
        }

        v114 = *(*(&v249 + 1) + 8 * i);
        v115 = MEMORY[0x277CCACA8];
        uUIDString = [v114 UUIDString];
        v117 = [preferredPrimaryForHome objectForKey:v114];
        uUIDString2 = [v117 UUIDString];
        v118 = [v115 stringWithFormat:@"%@: %@: %@", @"preferredPrimaryForHome", uUIDString, uUIDString2];
        [v109 addObject:v118];
      }

      v111 = [obj countByEnumeratingWithState:&v249 objects:v253 count:16];
    }

    while (v111);
  }

  if (disableWACBrowser)
  {
    v120 = @"YES";
  }

  else
  {
    v120 = @"NO";
  }

  v120 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"disableWACBrowser", v120];
  v122 = v109;
  [v109 addObject:v120];

  if (delayBatchedReadWrite)
  {
    v123 = @"YES";
  }

  else
  {
    v123 = @"NO";
  }

  v123 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"delayBatchedReadWrite", v123];
  [v109 addObject:v123];

  if (enableNetworkLogging)
  {
    v125 = @"YES";
  }

  else
  {
    v125 = @"NO";
  }

  v125 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"enableNetworkLogging", v125];
  [v109 addObject:v125];

  v127 = MEMORY[0x277CCACA8];
  v128 = CKContainerEnvironmentString();
  v128 = [v127 stringWithFormat:@"%@: %@", @"cloudKitEnvironment", v128];
  [v109 addObject:v128];

  if (allowAnonymousServerConnections)
  {
    v130 = @"YES";
  }

  else
  {
    v130 = @"NO";
  }

  v130 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"allowAnonymousServerConnections", v130];
  [v109 addObject:v130];

  presenceFeedRefreshInMinutes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceFeedRefreshInMinutes", presenceFeedRefreshInMinutes];
  [v109 addObject:presenceFeedRefreshInMinutes];

  presenceMonitorAuditInMinutes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceMonitorAuditInMinutes", presenceMonitorAuditInMinutes];
  [v109 addObject:presenceMonitorAuditInMinutes];

  presenceMonitorRefreshGracePeriodInMinutes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceMonitorRefreshGracePeriodInMinutes", presenceMonitorRefreshGracePeriodInMinutes];
  [v109 addObject:presenceMonitorRefreshGracePeriodInMinutes];

  startCharacteristicsMonitorWaitPeriod = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"startCharacteristicsMonitorWaitPeriod", startCharacteristicsMonitorWaitPeriod];
  [v109 addObject:startCharacteristicsMonitorWaitPeriod];

  requestHomeDataSyncRetryPeriodInMinutes = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"requestHomeDataSyncRetryPeriodInMinutes", requestHomeDataSyncRetryPeriodInMinutes];
  [v109 addObject:requestHomeDataSyncRetryPeriodInMinutes];

  v137 = [v109 copy];
  v138 = [v137 count];
  v9 = v226;
  v12 = MEMORY[0x277CD2270];
  if (v138)
  {
    [v226 setObject:v137 forKeyedSubscript:*MEMORY[0x277CD2218]];
  }

  stateCopy = v227;
  self = selfCopy2;
  v11 = &unk_22A586000;
  if (v224)
  {
    v139 = 1;
    goto LABEL_46;
  }

LABEL_44:
  if (![stateCopy containsObject:*v12])
  {
    goto LABEL_50;
  }

  v139 = 0;
LABEL_46:
  accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
  dumpUnassociatedAccessories = [accessoryBrowserInternal dumpUnassociatedAccessories];

  if ([dumpUnassociatedAccessories count])
  {
    [v9 setObject:dumpUnassociatedAccessories forKeyedSubscript:*v12];
  }

  if (v139)
  {
    v142 = 1;
    goto LABEL_52;
  }

LABEL_50:
  if (![stateCopy containsObject:*MEMORY[0x277CD2240]])
  {
    goto LABEL_56;
  }

  v142 = 0;
LABEL_52:
  v143 = MEMORY[0x277CBEB18];
  homes = [(HMDHomeManager *)self homes];
  v145 = [v143 arrayWithCapacity:{objc_msgSend(homes, "count")}];

  homes2 = [(HMDHomeManager *)self homes];
  v247[0] = MEMORY[0x277D85DD0];
  v247[1] = v11[441];
  v247[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke;
  v247[3] = &unk_278685B78;
  v147 = v145;
  v248 = v147;
  [homes2 hmf_enumerateWithAutoreleasePoolUsingBlock:v247];

  if ([v147 count])
  {
    v148 = [v147 copy];
    [v9 setObject:v148 forKeyedSubscript:*MEMORY[0x277CD2240]];
  }

  if (v142)
  {
    v149 = 1;
    goto LABEL_58;
  }

LABEL_56:
  if (![stateCopy containsObject:*MEMORY[0x277CD2228]])
  {
    goto LABEL_62;
  }

  v149 = 0;
LABEL_58:
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  homes3 = [(HMDHomeManager *)self homes];
  v245[0] = MEMORY[0x277D85DD0];
  v245[1] = v11[441];
  v245[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_2;
  v245[3] = &unk_278685B78;
  v152 = dictionary;
  v246 = v152;
  [homes3 hmf_enumerateWithAutoreleasePoolUsingBlock:v245];

  if ([v152 count])
  {
    [v9 setObject:v152 forKeyedSubscript:*MEMORY[0x277CD2228]];
  }

  if (v149)
  {
    v153 = 1;
    goto LABEL_64;
  }

LABEL_62:
  if (![stateCopy containsObject:*MEMORY[0x277CD2268]])
  {
    goto LABEL_69;
  }

  v153 = 0;
LABEL_64:
  string = [MEMORY[0x277CCAB68] string];
  residentMesh = [(HMDHomeManager *)self residentMesh];

  if (residentMesh)
  {
    residentMesh2 = [(HMDHomeManager *)self residentMesh];
    stateDump = [residentMesh2 stateDump];
    [string appendString:stateDump];
  }

  else
  {
    [string appendString:{@"No Resident mesh (not resident capable device, or hasn't completely started up)."}];
  }

  [v9 setObject:string forKeyedSubscript:*MEMORY[0x277CD2268]];

  if (v153)
  {
    v158 = 1;
    goto LABEL_71;
  }

LABEL_69:
  if (![stateCopy containsObject:*MEMORY[0x277CD21F0]])
  {
    goto LABEL_77;
  }

  v158 = 0;
LABEL_71:
  string2 = [MEMORY[0x277CCAB68] string];
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  device = [appleAccountManager device];

  if (device)
  {
    name = [device name];
    identifier = [device identifier];
    uUIDString3 = [identifier UUIDString];
    [string2 appendFormat:@"Current Device %@(%@)\n", name, uUIDString3];

    v11 = &unk_22A586000;
  }

  accountRegistry = [(HMDHomeManager *)self accountRegistry];
  accounts = [accountRegistry accounts];
  v243[0] = MEMORY[0x277D85DD0];
  v243[1] = v11[441];
  v243[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_3;
  v243[3] = &unk_2786861F8;
  v167 = string2;
  v244 = v167;
  [accounts hmf_enumerateWithAutoreleasePoolUsingBlock:v243];

  if ([v167 length])
  {
    [v9 setObject:v167 forKeyedSubscript:*MEMORY[0x277CD21F0]];
  }

  if (v158)
  {
    v168 = 1;
    goto LABEL_79;
  }

LABEL_77:
  v169 = *MEMORY[0x277CD2250];
  if (![stateCopy containsObject:*MEMORY[0x277CD2250]])
  {
    goto LABEL_84;
  }

  v168 = 0;
LABEL_79:
  accessoryBrowserInternal2 = [(HMDHomeManager *)self accessoryBrowserInternal];
  dumpRegisteredPairedAccessories = [accessoryBrowserInternal2 dumpRegisteredPairedAccessories];

  if ([dumpRegisteredPairedAccessories length])
  {
    [v9 setObject:dumpRegisteredPairedAccessories forKeyedSubscript:*MEMORY[0x277CD2250]];
  }

  if (v168)
  {
    v172 = 1;
    goto LABEL_87;
  }

  v169 = *MEMORY[0x277CD2250];
LABEL_84:
  if (([stateCopy containsObject:v169] & 1) == 0 && !objc_msgSend(stateCopy, "containsObject:", *v12))
  {
    goto LABEL_91;
  }

  v172 = 0;
LABEL_87:
  accessoryBrowser = [(HMDHomeManager *)self accessoryBrowser];
  dumpBrowsingConnections = [accessoryBrowser dumpBrowsingConnections];

  if ([dumpBrowsingConnections length])
  {
    [v9 setObject:dumpBrowsingConnections forKeyedSubscript:*MEMORY[0x277CD2208]];
  }

  if (v172)
  {
    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    secureRemoteTransport = [messageDispatcher secureRemoteTransport];
    levelCopy2 = level;
    v178 = [secureRemoteTransport dumpStateWithPrivacyLevel:level];
    [v9 setObject:v178 forKeyedSubscript:@"RemoteMessaging"];

    v11 = &unk_22A586000;
    v179 = 1;
    goto LABEL_95;
  }

LABEL_91:
  if ([stateCopy containsObject:*MEMORY[0x277CD2258]])
  {
    messageDispatcher2 = [(HMDHomeManager *)self messageDispatcher];
    secureRemoteTransport2 = [messageDispatcher2 secureRemoteTransport];
    v182 = [secureRemoteTransport2 dumpStateWithPrivacyLevel:level];
    [v9 setObject:v182 forKeyedSubscript:@"RemoteMessaging"];

    v11 = &unk_22A586000;
  }

  if (![stateCopy containsObject:*MEMORY[0x277CD21F8]])
  {
    isWatch();
    goto LABEL_100;
  }

  v179 = 0;
  levelCopy2 = level;
LABEL_95:
  dictionary2 = [MEMORY[0x277CBEB38] dictionary];
  homes4 = [(HMDHomeManager *)self homes];
  v240[0] = MEMORY[0x277D85DD0];
  v240[1] = v11[441];
  v240[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_4;
  v240[3] = &unk_278686220;
  v185 = dictionary2;
  v241 = v185;
  v242 = levelCopy2;
  [homes4 hmf_enumerateWithAutoreleasePoolUsingBlock:v240];

  if ([v185 count])
  {
    v186 = [v185 copy];
    [v9 setObject:v186 forKeyedSubscript:*MEMORY[0x277CD21F8]];
  }

  isWatch();
  if (v179)
  {
    v187 = 1;
    goto LABEL_102;
  }

LABEL_100:
  if (![stateCopy containsObject:*MEMORY[0x277CD2210]])
  {
    goto LABEL_106;
  }

  v187 = 0;
LABEL_102:
  string3 = [MEMORY[0x277CCAB68] string];
  homes5 = [(HMDHomeManager *)self homes];
  v238[0] = MEMORY[0x277D85DD0];
  v238[1] = v11[441];
  v238[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_5;
  v238[3] = &unk_278685B78;
  v190 = string3;
  v239 = v190;
  [homes5 hmf_enumerateWithAutoreleasePoolUsingBlock:v238];

  if ([v190 length])
  {
    [v9 setObject:v190 forKeyedSubscript:*MEMORY[0x277CD2210]];
  }

  if (v187)
  {
    v191 = 1;
    goto LABEL_108;
  }

LABEL_106:
  if (![stateCopy containsObject:*MEMORY[0x277CD2230]])
  {
    goto LABEL_112;
  }

  v191 = 0;
LABEL_108:
  dictionary3 = [MEMORY[0x277CBEB38] dictionary];
  homes6 = [(HMDHomeManager *)self homes];
  v235[0] = MEMORY[0x277D85DD0];
  v235[1] = v11[441];
  v235[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_6;
  v235[3] = &unk_278686220;
  v194 = dictionary3;
  v236 = v194;
  levelCopy3 = level;
  [homes6 hmf_enumerateWithAutoreleasePoolUsingBlock:v235];

  if ([v194 count])
  {
    v195 = [v194 copy];
    [v9 setObject:v195 forKeyedSubscript:*MEMORY[0x277CD2230]];
  }

  if (v191)
  {
    syncManager = [(HMDHomeManager *)self syncManager];
    dumpState = [syncManager dumpState];
    [v9 setObject:dumpState forKeyedSubscript:*MEMORY[0x277D0F178]];

    v198 = *MEMORY[0x277D0F050];
    appData = [(HMDHomeManager *)self appData];
    v200 = [appData dumpStateWithPrivacyLevel:level];
    [v9 setObject:v200 forKeyedSubscript:v198];

    systemStore = [MEMORY[0x277CFEC78] systemStore];
    dumpState2 = [systemStore dumpState];
    [v9 setObject:dumpState2 forKeyedSubscript:*MEMORY[0x277D0F0F0]];

    v203 = *MEMORY[0x277CD2238];
    v204 = 1;
    v205 = v228;
    goto LABEL_120;
  }

LABEL_112:
  v206 = *MEMORY[0x277D0F178];
  if ([stateCopy containsObject:*MEMORY[0x277D0F178]])
  {
    syncManager2 = [(HMDHomeManager *)self syncManager];
    dumpState3 = [syncManager2 dumpState];
    [v9 setObject:dumpState3 forKeyedSubscript:v206];
  }

  v209 = *MEMORY[0x277D0F050];
  if ([stateCopy containsObject:*MEMORY[0x277D0F050]])
  {
    appData2 = [(HMDHomeManager *)self appData];
    v211 = [appData2 dumpStateWithPrivacyLevel:level];
    [v9 setObject:v211 forKeyedSubscript:v209];
  }

  v212 = *MEMORY[0x277D0F0F0];
  if ([stateCopy containsObject:*MEMORY[0x277D0F0F0]])
  {
    systemStore2 = [MEMORY[0x277CFEC78] systemStore];
    dumpState4 = [systemStore2 dumpState];
    [v9 setObject:dumpState4 forKeyedSubscript:v212];
  }

  v203 = *MEMORY[0x277CD2238];
  v205 = v228;
  if ([stateCopy containsObject:*MEMORY[0x277CD2238]])
  {
    v204 = 0;
LABEL_120:
    array2 = [MEMORY[0x277CBEB18] array];
    homes7 = [(HMDHomeManager *)self homes];
    v233[0] = MEMORY[0x277D85DD0];
    v233[1] = 3221225472;
    v233[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_7;
    v233[3] = &unk_278685B78;
    v234 = array2;
    v217 = array2;
    [homes7 hmf_enumerateWithAutoreleasePoolUsingBlock:v233];

    [v9 setObject:v217 forKeyedSubscript:v203];
    if (v204)
    {
      dictionary4 = [MEMORY[0x277CBEB38] dictionary];
      homes8 = [(HMDHomeManager *)self homes];
      v231[0] = MEMORY[0x277D85DD0];
      v231[1] = 3221225472;
      v231[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_8;
      v231[3] = &unk_278685B78;
      v232 = dictionary4;
      v220 = dictionary4;
      [homes8 hmf_enumerateWithAutoreleasePoolUsingBlock:v231];

      [v9 setObject:v220 forKeyedSubscript:@"kDumpStateBulletinNotificationRegistrationsKey"];
    }
  }

  v221 = v9;

  v222 = *MEMORY[0x277D85DE8];
  return v9;
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:3];
  v5 = [v3 accessories];
  v6 = MEMORY[0x277CCACA8];
  v7 = [v3 name];
  v8 = [v6 stringWithFormat:@"Home: %@", v7];
  [v4 setObject:v8 forKeyedSubscript:*MEMORY[0x277D0F0B8]];

  v9 = [v3 primaryResident];
  v10 = [v9 dumpState];

  v11 = MEMORY[0x277CCACA8];
  v12 = [v10 objectForKeyedSubscript:*MEMORY[0x277D0F170]];
  v13 = [v11 stringWithFormat:@"Resident: %@", v12];
  [v4 setObject:v13 forKeyedSubscript:*MEMORY[0x277D0F138]];

  v14 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v5, "count")}];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v15 = v5;
  v16 = [v15 countByEnumeratingWithState:&v23 objects:v27 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v24;
    do
    {
      v19 = 0;
      do
      {
        if (*v24 != v18)
        {
          objc_enumerationMutation(v15);
        }

        v20 = [*(*(&v23 + 1) + 8 * v19) dumpSimpleState];
        [v14 addObject:v20];

        ++v19;
      }

      while (v17 != v19);
      v17 = [v15 countByEnumeratingWithState:&v23 objects:v27 count:16];
    }

    while (v17);
  }

  if ([v14 count])
  {
    v21 = [v14 copy];
    [v4 setObject:v21 forKeyedSubscript:*MEMORY[0x277D0F028]];
  }

  [*(a1 + 32) addObject:v4];

  v22 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_2(uint64_t a1, void *a2)
{
  v30 = *MEMORY[0x277D85DE8];
  v2 = a2;
  [MEMORY[0x277CBEB38] dictionary];
  v24 = v23 = v2;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v3 = [v2 appleMediaAccessories];
  v4 = [v3 countByEnumeratingWithState:&v25 objects:v29 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v26;
    do
    {
      v7 = 0;
      do
      {
        if (*v26 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v25 + 1) + 8 * v7);
        v9 = objc_autoreleasePoolPush();
        if (v8)
        {
          v10 = MEMORY[0x277CCACA8];
          v11 = [v8 name];
          v12 = [v8 uuid];
          v13 = [v12 UUIDString];
          v14 = [v10 stringWithFormat:@"HomePod: %@ uuid: %@", v11, v13];

          v15 = [v8 dumpStateLocalSettings];
          [v24 setObject:v15 forKeyedSubscript:v14];
        }

        objc_autoreleasePoolPop(v9);
        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v25 objects:v29 count:16];
    }

    while (v5);
  }

  v16 = MEMORY[0x277CCACA8];
  v17 = [v23 name];
  v18 = [v23 uuid];
  v19 = [v18 UUIDString];
  v20 = [v16 stringWithFormat:@"home: %@ uuid: %@", v17, v19];

  [*(a1 + 32) setObject:v24 forKeyedSubscript:v20];
  v21 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_3(uint64_t a1, void *a2)
{
  v58 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = *(a1 + 32);
  v5 = [v3 shortDescription];
  [v4 appendFormat:@"Account %@:\n", v5];

  v53 = 0u;
  v54 = 0u;
  v51 = 0u;
  v52 = 0u;
  v6 = [v3 handles];
  v7 = [v6 countByEnumeratingWithState:&v51 objects:v57 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v52;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v52 != v9)
        {
          objc_enumerationMutation(v6);
        }

        [*(a1 + 32) appendFormat:@"\t%@\n", *(*(&v51 + 1) + 8 * i)];
      }

      v8 = [v6 countByEnumeratingWithState:&v51 objects:v57 count:16];
    }

    while (v8);
  }

  v11 = [v3 devices];
  v12 = [v11 count];

  if (v12)
  {
    v49 = 0u;
    v50 = 0u;
    v47 = 0u;
    v48 = 0u;
    v31 = v3;
    obj = [v3 devices];
    v34 = [obj countByEnumeratingWithState:&v47 objects:v56 count:16];
    if (v34)
    {
      v33 = *v48;
      do
      {
        v13 = 0;
        do
        {
          if (*v48 != v33)
          {
            objc_enumerationMutation(obj);
          }

          v14 = *(*(&v47 + 1) + 8 * v13);
          v37 = *(a1 + 32);
          v42 = [v14 name];
          v39 = [v14 identifier];
          v41 = [v39 UUIDString];
          v38 = [v14 version];
          v40 = v13;
          if (v38)
          {
            v35 = [v14 version];
            v36 = v35;
          }

          else
          {
            v36 = @"Unknown";
          }

          v15 = [v14 productInfo];
          [v15 productPlatform];
          v16 = HMFProductPlatformToString();
          v17 = [v14 productInfo];
          [v17 productClass];
          v18 = HMFProductClassToString();
          v19 = [v14 productInfo];
          v20 = [v19 softwareVersion];
          v21 = [v20 versionString];
          [v37 appendFormat:@"\tDevice %@(%@), Version = %@, Platform = %@, Class = %@, OS = %@\n", v42, v41, v36, v16, v18, v21];

          if (v38)
          {
          }

          v45 = 0u;
          v46 = 0u;
          v43 = 0u;
          v44 = 0u;
          v22 = [v14 handles];
          v23 = [v22 countByEnumeratingWithState:&v43 objects:v55 count:16];
          if (v23)
          {
            v24 = v23;
            v25 = *v44;
            do
            {
              for (j = 0; j != v24; ++j)
              {
                if (*v44 != v25)
                {
                  objc_enumerationMutation(v22);
                }

                [*(a1 + 32) appendFormat:@"\t\t%@\n", *(*(&v43 + 1) + 8 * j)];
              }

              v24 = [v22 countByEnumeratingWithState:&v43 objects:v55 count:16];
            }

            while (v24);
          }

          v27 = [v14 capabilities];

          if (v27)
          {
            v28 = *(a1 + 32);
            v29 = [v14 capabilities];
            [v28 appendFormat:@"\t\t%@\n", v29];
          }

          v13 = v40 + 1;
        }

        while (v40 + 1 != v34);
        v34 = [obj countByEnumeratingWithState:&v47 objects:v56 count:16];
      }

      while (v34);
    }

    v3 = v31;
  }

  v30 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_4(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCACA8];
  v4 = a2;
  v5 = [v4 name];
  v6 = [v4 uuid];
  v8 = [v3 stringWithFormat:@"%@/%@", v5, v6];

  v7 = [v4 dumpActionSetDescriptionWithPrivacyLevel:*(a1 + 40)];

  [*(a1 + 32) setObject:v7 forKeyedSubscript:v8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_5(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 dumpCharacteristicNotificationRegistry];
  [v2 appendString:v3];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_6(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCACA8];
  v4 = a2;
  v5 = [v4 name];
  v6 = [v4 uuid];
  v8 = [v3 stringWithFormat:@"%@/%@", v5, v6];

  v7 = [v4 dumpMediaSessionDescriptionWithPrivacyLevel:*(a1 + 40)];

  [*(a1 + 32) setObject:v7 forKeyedSubscript:v8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_7(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v3 = [a2 accessories];
  v4 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v11;
    do
    {
      v7 = 0;
      do
      {
        if (*v11 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = [*(*(&v10 + 1) + 8 * v7) dumpNetworkState];
        if (v8)
        {
          [*(a1 + 32) addObject:v8];
        }

        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v5);
  }

  v9 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_8(uint64_t a1, void *a2)
{
  v3 = a2;
  v6 = [v3 dumpBulletinNotificationRegistrationsState];
  v4 = *(a1 + 32);
  v5 = [v3 name];

  [v4 setObject:v6 forKeyedSubscript:v5];
}

- (void)_handleQueryVersionInformation:(id)information
{
  v19[1] = *MEMORY[0x277D85DE8];
  v3 = MEMORY[0x277CCAB68];
  informationCopy = information;
  string = [v3 string];
  mainBundle = [MEMORY[0x277CCA8D8] mainBundle];
  infoDictionary = [mainBundle infoDictionary];
  v8 = [infoDictionary objectForKey:*MEMORY[0x277CBED58]];
  [string appendFormat:@"homed: %@\n", v8];

  v9 = +[HMDHAPMetadata getSharedInstance];
  v10 = +[HMDHAPMetadata getBuiltinInstance];
  schemaVersion = [v9 schemaVersion];
  version = [v9 version];
  schemaVersion2 = [v10 schemaVersion];
  version2 = [v10 version];
  [string appendFormat:@"Metadata - Current: %@/%@   Builtin: %@/%@\n", schemaVersion, version, schemaVersion2, version2];

  v18 = @"kHomeKitVersionStringKey";
  v19[0] = string;
  v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v19 forKeys:&v18 count:1];
  responseHandler = [informationCopy responseHandler];

  (responseHandler)[2](responseHandler, 0, v15);
  v17 = *MEMORY[0x277D85DE8];
}

- (void)_handleContactStoreChanged
{
  v35 = *MEMORY[0x277D85DE8];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v4 = [incomingInvitations copy];

  v5 = [v4 countByEnumeratingWithState:&v25 objects:v34 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = 0;
    v8 = *v26;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v26 != v8)
        {
          objc_enumerationMutation(v4);
        }

        v7 |= [*(*(&v25 + 1) + 8 * i) refreshDisplayName];
      }

      v6 = [v4 countByEnumeratingWithState:&v25 objects:v34 count:16];
    }

    while (v6);
    v10 = v7 & 1;
  }

  else
  {
    v10 = 0;
  }

  v11 = objc_autoreleasePoolPush();
  selfCopy = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    v31 = v14;
    v32 = 1024;
    v33 = v10;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Handling contact store changed with saveToStore: %{BOOL}d", buf, 0x12u);
  }

  objc_autoreleasePoolPop(v11);
  v23 = 0u;
  v24 = 0u;
  v21 = 0u;
  v22 = 0u;
  homes = [(HMDHomeManager *)selfCopy homes];
  v16 = [homes countByEnumeratingWithState:&v21 objects:v29 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v22;
    do
    {
      for (j = 0; j != v17; ++j)
      {
        if (*v22 != v18)
        {
          objc_enumerationMutation(homes);
        }

        [*(*(&v21 + 1) + 8 * j) refreshUserDisplayNames];
      }

      v17 = [homes countByEnumeratingWithState:&v21 objects:v29 count:16];
    }

    while (v17);
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)handleContactStoreChanged:(id)changed
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __44__HMDHomeManager_handleContactStoreChanged___block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)processMetadataModel:(id)model message:(id)message
{
  v63 = *MEMORY[0x277D85DE8];
  modelCopy = model;
  messageCopy = message;
  transactionResult = [messageCopy transactionResult];
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = +[HMDBackingStoreTransactionOptions stringForHMDBackingStoreTransactionSource:](HMDBackingStoreTransactionActions, "stringForHMDBackingStoreTransactionSource:", [transactionResult source]);
    *buf = 138543618;
    v54 = v10;
    v55 = 2112;
    v56 = v11;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Receiving metadata model from %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  metadataVersion = [modelCopy metadataVersion];
  unsignedIntegerValue = [metadataVersion unsignedIntegerValue];

  schemaVersion = [modelCopy schemaVersion];
  unsignedIntegerValue2 = [schemaVersion unsignedIntegerValue];

  v16 = +[HMDHAPMetadata getSharedInstance];
  version = [v16 version];
  unsignedIntegerValue3 = [version unsignedIntegerValue];

  v19 = +[HMDHAPMetadata getSharedInstance];
  schemaVersion2 = [v19 schemaVersion];
  unsignedIntegerValue4 = [schemaVersion2 unsignedIntegerValue];

  v22 = objc_autoreleasePoolPush();
  v23 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
  {
    v24 = HMFGetLogIdentifier();
    *buf = 138544386;
    v54 = v24;
    v55 = 2048;
    v56 = unsignedIntegerValue;
    v57 = 2048;
    v58 = unsignedIntegerValue2;
    v59 = 2048;
    v60 = unsignedIntegerValue3;
    v61 = 2048;
    v62 = unsignedIntegerValue4;
    _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@The new metadata has version %tu, schema version %tu, current version %tu, schema %tu", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v22);
  if (unsignedIntegerValue4 == unsignedIntegerValue2)
  {
    v25 = transactionResult;
    if (unsignedIntegerValue <= unsignedIntegerValue3)
    {
      if (unsignedIntegerValue >= unsignedIntegerValue3)
      {
        +[HMDHAPMetadata shouldUploadToCloudAfterHomedReady];
        v45 = objc_autoreleasePoolPush();
        v46 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v46, OS_LOG_TYPE_INFO))
        {
          v47 = HMFGetLogIdentifier();
          v48 = +[HMDHAPMetadata shouldUploadToCloudAfterHomedReady];
          v49 = "NO";
          if (v48)
          {
            v49 = "YES";
          }

          *buf = 138543618;
          v54 = v47;
          v55 = 2080;
          v56 = v49;
          _os_log_impl(&dword_229538000, v46, OS_LOG_TYPE_INFO, "%{public}@Metadata should be uploaded to cloud after homed is ready: %s", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v45);
        [transactionResult markChanged];
        goto LABEL_29;
      }

      if ([transactionResult source] != 2)
      {
LABEL_29:
        +[HMDHAPMetadata resetShouldUploadToCloudAfterHomedReady];
        goto LABEL_30;
      }

      v36 = +[HMDPersistentStore loadPlainMetadataDictionary];
      [(HMDHomeManager *)self handleMetadataDictionary:v36 message:0];
LABEL_18:

      goto LABEL_29;
    }

    rawPlist = [modelCopy rawPlist];
    v52 = 0;
    v27 = [HMDHAPMetadata metadataWithDictionary:rawPlist error:&v52];
    v28 = v52;

    v29 = objc_autoreleasePoolPush();
    v30 = HMFGetOSLogHandle();
    v31 = v30;
    if (!v28 && v27)
    {
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        version2 = [v27 version];
        schemaVersion3 = [v27 schemaVersion];
        *buf = 138543874;
        v54 = v32;
        v55 = 2112;
        v56 = version2;
        v57 = 2112;
        v58 = schemaVersion3;
        _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@Updating current metadata to the new metadata %@/%@.", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v29);
      metadataDictionary = [modelCopy metadataDictionary];
      [HMDHAPMetadata updateLocalMetadataWithMetadata:metadataDictionary];

      v36 = +[HMDHAPMetadata getSharedInstance];

      [transactionResult markSaveToAssistant];
      [transactionResult markChanged];
      [(HMDHomeManager *)self _pushMetadataChangesToUsers];
      [(HMDHomeManager *)self pushMetadataToAllWatches];
      [(HMDHomeManager *)self _notifyMetadata:v36 limitToSPIClients:0 message:messageCopy invokeResponseHandler:1];
      [(HMDHomeManager *)self _notifyMetadata:v36 limitToSPIClients:1 message:messageCopy invokeResponseHandler:0];
      goto LABEL_18;
    }

    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      v40 = HMFGetLogIdentifier();
      rawPlist2 = [modelCopy rawPlist];
      *buf = 138543618;
      v54 = v40;
      v55 = 2112;
      v56 = rawPlist2;
      _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_ERROR, "%{public}@Failed to init metadata with dictionary %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
    responseHandler = [messageCopy responseHandler];

    if (responseHandler)
    {
      responseHandler2 = [messageCopy responseHandler];
      v44 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      (responseHandler2)[2](responseHandler2, v44, 0);
    }
  }

  else
  {
    v37 = objc_autoreleasePoolPush();
    v38 = HMFGetOSLogHandle();
    v25 = transactionResult;
    if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
    {
      v39 = HMFGetLogIdentifier();
      *buf = 138543362;
      v54 = v39;
      _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_ERROR, "%{public}@Schema is compatible, not processing this metadata.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v37);
  }

LABEL_30:

  v50 = *MEMORY[0x277D85DE8];
}

uint64_t __82__HMDHomeManager__notifyMetadata_limitToSPIClients_message_invokeResponseHandler___block_invoke(uint64_t result)
{
  if (*(result + 40) == 1)
  {
    return [*(result + 32) respondWithPayload:0];
  }

  return result;
}

- (void)handleMetadataDictionary:(id)dictionary message:(id)message
{
  v23 = *MEMORY[0x277D85DE8];
  dictionaryCopy = dictionary;
  messageCopy = message;
  v8 = [HMDHAPMetadataModel modelWithDictionary:dictionaryCopy];
  if (v8)
  {
    backingStore = [(HMDHomeManager *)self backingStore];
    v10 = +[HMDBackingStoreTransactionOptions defaultMetadataCloudOptions];
    v11 = [backingStore transaction:@"MetadataUpdate" options:v10];

    [v11 add:v8 withMessage:messageCopy];
    [v11 run];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v14;
      v21 = 2112;
      v22 = dictionaryCopy;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to generate metadata model object from dictionary %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    responseHandler = [messageCopy responseHandler];

    if (responseHandler)
    {
      responseHandler2 = [messageCopy responseHandler];
      v17 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      (responseHandler2)[2](responseHandler2, v17, 0);
    }
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleHomeManagerSyncWalletKeysPassSerialNumbersMessage:(id)message
{
  v33 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    uUID = [internalOnlyInitializer UUID];
    *buf = 138543874;
    v26 = v10;
    v27 = 2112;
    v28 = uUID;
    v29 = 2112;
    v30 = messageCopy;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Handling message to sync wallet keys pass serial numbers: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  v12 = [(__CFString *)messageCopy arrayForKey:@"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers"];
  v13 = [v12 na_map:&__block_literal_global_1121];

  if (v13)
  {
    v14 = [MEMORY[0x277CBEB98] setWithArray:v13];
    [(HMDHomeManager *)selfCopy removeHomeWalletKeysExcludingSerialNumbers:v14 flow:internalOnlyInitializer];
    v23 = @"kDataSyncResponseAckKey";
    v24 = MEMORY[0x277CBEC38];
    v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v24 forKeys:&v23 count:1];
    [(__CFString *)messageCopy respondWithPayload:v15];
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = selfCopy;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v19 = HMFGetLogIdentifier();
      uUID2 = [internalOnlyInitializer UUID];
      messagePayload = [(__CFString *)messageCopy messagePayload];
      *buf = 138544130;
      v26 = v19;
      v27 = 2112;
      v28 = uUID2;
      v29 = 2112;
      v30 = @"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers";
      v31 = 2112;
      v32 = messagePayload;
      _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_ERROR, "%{public}@[Flow: %@] Payload of message to sync wallet keys pass serial numbers is missing key %@: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v16);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [(__CFString *)messageCopy respondWithError:v14];
  }

  v22 = *MEMORY[0x277D85DE8];
}

void *__75__HMDHomeManager__handleHomeManagerSyncWalletKeysPassSerialNumbersMessage___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  return v3;
}

- (void)_handleMetadataSync:(id)sync
{
  v38 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  if ([syncCopy remoteRestriction] == 4)
  {
    v5 = [syncCopy dataForKey:@"kHAPMetadataDataKey"];
    hmd_uncompressedData = [v5 hmd_uncompressedData];

    v7 = MEMORY[0x277CCAAC8];
    v8 = +[HMDHAPMetadataModel allowedTypes];
    v29 = 0;
    v9 = [v7 unarchivedObjectOfClasses:v8 fromData:hmd_uncompressedData error:&v29];
    v10 = v29;

    if (hmd_uncompressedData && v9)
    {
      [(HMDHomeManager *)self handleMetadataDictionary:v9 message:0];
      responseHandler = [syncCopy responseHandler];

      if (!responseHandler)
      {
LABEL_19:

        goto LABEL_20;
      }

      responseHandler2 = [syncCopy responseHandler];
      v30 = @"kDataSyncResponseAckKey";
      v31 = MEMORY[0x277CBEC38];
      responseHandler4 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v31 forKeys:&v30 count:1];
      responseHandler2[2](responseHandler2, 0, responseHandler4);
    }

    else
    {
      v19 = objc_autoreleasePoolPush();
      selfCopy = self;
      v21 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        v22 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v22;
        _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to receive metadata update", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v19);
      if (hmd_uncompressedData)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = selfCopy;
        v25 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
        {
          v26 = HMFGetLogIdentifier();
          *buf = 138543618;
          v35 = v26;
          v36 = 2112;
          v37 = v10;
          _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive hap metadata model from metadata data: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v23);
      }

      responseHandler3 = [syncCopy responseHandler];

      if (!responseHandler3)
      {
        goto LABEL_19;
      }

      responseHandler2 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      responseHandler4 = [syncCopy responseHandler];
      responseHandler4[2](responseHandler4, responseHandler2, 0);
    }

    goto LABEL_19;
  }

  v14 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    *buf = 138543618;
    v35 = v17;
    v36 = 2112;
    v37 = syncCopy;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Dropping metadata sync: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  responseHandler5 = [syncCopy responseHandler];

  if (responseHandler5)
  {
    hmd_uncompressedData = [syncCopy responseHandler];
    v32 = @"kDataSyncResponseAckKey";
    v33 = MEMORY[0x277CBEC38];
    v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v33 forKeys:&v32 count:1];
    (hmd_uncompressedData)[2](hmd_uncompressedData, 0, v10);
LABEL_20:
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_handleSetMetadata:(id)metadata
{
  metadataCopy = metadata;
  v5 = [metadataCopy stringForKey:@"kMetadataPlistPathKey"];
  v10 = v5;
  if (v5)
  {
    v6 = MEMORY[0x277CBEBC0];
    v7 = [@"file://" stringByAppendingString:v5];
    v8 = [v6 URLWithString:v7];

    v9 = [MEMORY[0x277CBEAC0] dictionaryWithContentsOfURL:v8];
    [(HMDHomeManager *)self handleMetadataDictionary:v9 message:metadataCopy];

    metadataCopy = v8;
  }

  else
  {
    +[HMDHAPMetadata updateLocalMetadataWithBuiltinMetadata];
    [metadataCopy respondWithPayload:0];
  }
}

- (void)_handleQueryMetadata:(id)metadata
{
  v17[1] = *MEMORY[0x277D85DE8];
  metadataCopy = metadata;
  v4 = [metadataCopy stringForKey:@"kMetadataPlistPathKey"];
  if (!v4)
  {
    v8 = [metadataCopy numberForKey:@"kMetadataDictionaryTypeKey"];
    unsignedIntegerValue = [v8 unsignedIntegerValue];
    if (unsignedIntegerValue == 1)
    {
      v10 = +[HMDHAPMetadata getSharedInstance];
    }

    else
    {
      if (unsignedIntegerValue)
      {
        v5 = 0;
        goto LABEL_10;
      }

      v10 = +[HMDHAPMetadata getBuiltinInstance];
    }

    v5 = v10;
LABEL_10:

    goto LABEL_11;
  }

  v15 = 0;
  v5 = [HMDHAPMetadata metadataWithPath:v4 error:&v15];
  v6 = v15;
  if (v6)
  {
    v7 = v6;
    [metadataCopy respondWithError:v6];
    goto LABEL_15;
  }

LABEL_11:
  rawPlist = [v5 rawPlist];
  v12 = rawPlist;
  if (rawPlist)
  {
    v16 = @"kMetadataDictionaryKey";
    v17[0] = rawPlist;
    v13 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v17 forKeys:&v16 count:1];
    [metadataCopy respondWithPayload:v13];

    v7 = 0;
  }

  else
  {
    v7 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:1001 userInfo:0];
    [metadataCopy respondWithError:v7];
  }

LABEL_15:
  v14 = *MEMORY[0x277D85DE8];
}

- (void)idsServerBagDidUpdate:(id)update
{
  v17 = *MEMORY[0x277D85DE8];
  updateCopy = update;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v16 = v8;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@idsServerBagDidUpdate delegate called", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  capabilitiesController = [(HMDHomeManager *)selfCopy capabilitiesController];
  [capabilitiesController updateCurrentAccessoryCapabilities];

  workQueue = [(HMDHomeManager *)selfCopy workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __40__HMDHomeManager_idsServerBagDidUpdate___block_invoke;
  block[3] = &unk_27868A728;
  block[4] = selfCopy;
  dispatch_async(workQueue, block);

  [(HMDHomeManager *)selfCopy checkAndProcessHH2UpgradeRecommendation];
  uuid = [(HMDHomeManager *)selfCopy uuid];
  [(HMDHomeManager *)selfCopy updateGenerationCounterWithReason:@"IDS server bag updated" sourceUUID:uuid shouldNotifyClients:1];

  useDeferredResolutionStrategy = [updateCopy useDeferredResolutionStrategy];
  [MEMORY[0x277CFEA40] setUseDeferredResolutionStrategy:useDeferredResolutionStrategy];

  v13 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager_idsServerBagDidUpdate___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) notificationCenter];
  [v2 postNotificationName:@"HMDHomeManagerServerBagUpdatedNotification" object:*(a1 + 32) userInfo:0];
}

- (void)_handleRemoteSessionTornDownNotification:(id)notification
{
  v31 = *MEMORY[0x277D85DE8];
  notificationCopy = notification;
  userInfo = [notificationCopy userInfo];
  v6 = [userInfo hmf_UUIDForKey:*MEMORY[0x277CD0640]];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self _homeWithUUID:v6];
    residentDeviceManager = [v7 residentDeviceManager];
    isResidentAvailable = [residentDeviceManager isResidentAvailable];

    if ((isResidentAvailable & 1) == 0)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v12 = HMFGetLogIdentifier();
        v25 = 138543618;
        v26 = v12;
        v27 = 2112;
        v28 = v7;
        _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Receive notification that remote access was torn down for home %@", &v25, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      if (v7)
      {
        v13 = objc_autoreleasePoolPush();
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          name = [v7 name];
          uuid = [v7 uuid];
          uUIDString = [uuid UUIDString];
          v25 = 138543874;
          v26 = v15;
          v27 = 2112;
          v28 = name;
          v29 = 2112;
          v30 = uUIDString;
          _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Re-electing new resident device for home: %@ (%@)", &v25, 0x20u);
        }

        objc_autoreleasePoolPop(v13);
        uuid2 = [v7 uuid];
        [(HMDHomeManager *)self _teardownRemoteAccessForHome:uuid2];

        uuid3 = [v7 uuid];
        [(HMDHomeManager *)self _electRemoteAccessPeerForHome:uuid3];
      }
    }
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      v23 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v23;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Receive notification that remote access was torn down for an unknown home, re-checking if we need to spin up remote access for any of our homes", &v25, 0xCu);
    }

    objc_autoreleasePoolPop(v21);
    [(HMDHomeManager *)self _checkForRemotePeers];
  }

  v24 = *MEMORY[0x277D85DE8];
}

- (void)_electCompanionForRemoteAccess:(id)access
{
  v22 = *MEMORY[0x277D85DE8];
  accessCopy = access;
  v5 = [(HMDHomeManager *)self _homeWithUUID:accessCopy];
  if (v5)
  {
    associatedRemotePeers = [(HMDHomeManager *)self associatedRemotePeers];
    v7 = [associatedRemotePeers objectForKeyedSubscript:accessCopy];

    if ([v7 count])
    {
      anyObject = [v7 anyObject];
      v9 = [HMDDevice deviceWithDestination:anyObject];
      messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
      [messageDispatcher setCompanionDevice:v9 forHome:v5];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        v18 = 138543618;
        v19 = v16;
        v20 = 2112;
        v21 = accessCopy;
        _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@There are no remote peers for this home: %@", &v18, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      [(HMDHomeManager *)self _teardownRemoteAccessForHomeThroughCompanion:accessCopy];
    }
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v13;
      v20 = 2112;
      v21 = accessCopy;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Home with UUID not found: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_electRemoteAccessDeviceForHome:(id)home retryCount:(unint64_t)count
{
  v103 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v4 = [(HMDHomeManager *)self _homeWithUUID:?];
  v59 = v4;
  if (v4)
  {
    if ([v4 isResidentSupported])
    {
      v5 = objc_autoreleasePoolPush();
      v6 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v7 = HMFGetLogIdentifier();
        *buf = 138543618;
        *&buf[4] = v7;
        *&buf[12] = 2112;
        *&buf[14] = homeCopy;
        _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Skipping electing remote access for home, %@, with a resident device", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v5);
    }

    else
    {
      associatedRemotePeers = [(HMDHomeManager *)self associatedRemotePeers];
      v48 = [associatedRemotePeers objectForKeyedSubscript:homeCopy];

      if ([v48 count])
      {
        pendingRemoteSessions = [(HMDHomeManager *)self pendingRemoteSessions];
        allValues = [pendingRemoteSessions allValues];

        if ([allValues containsObject:homeCopy])
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v12 = HMFGetLogIdentifier();
            uUIDString = [homeCopy UUIDString];
            *buf = 138543618;
            *&buf[4] = v12;
            *&buf[12] = 2112;
            *&buf[14] = uUIDString;
            _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@We have a pending election for home: %@, dropping this request", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v10);
        }

        else
        {
          v14 = [(HMDHomeManager *)self identifiersOfAccessoriesForHome:v59];
          allObjects = [v14 allObjects];

          uUID = [MEMORY[0x277CCAD78] UUID];
          pendingRemoteSessions2 = [(HMDHomeManager *)self pendingRemoteSessions];
          [pendingRemoteSessions2 setObject:homeCopy forKeyedSubscript:uUID];

          v16 = objc_autoreleasePoolPush();
          v17 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
          {
            v18 = HMFGetLogIdentifier();
            uUIDString2 = [uUID UUIDString];
            *buf = 138544130;
            *&buf[4] = v18;
            *&buf[12] = 2112;
            *&buf[14] = v59;
            *&buf[22] = 2112;
            v101 = uUIDString2;
            LOWORD(v102) = 2048;
            *(&v102 + 2) = [v48 count];
            _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Spinning up remote access for home, %@, for session %@, pinging total of %lu peers", buf, 0x2Au);
          }

          objc_autoreleasePoolPop(v16);
          v86[0] = 0;
          v86[1] = v86;
          v86[2] = 0x2020000000;
          v87 = 0;
          *buf = 0;
          *&buf[8] = buf;
          *&buf[16] = 0x3032000000;
          v101 = __Block_byref_object_copy__254244;
          *&v102 = __Block_byref_object_dispose__254245;
          *(&v102 + 1) = 0;
          v84[0] = 0;
          v84[1] = v84;
          v84[2] = 0x3032000000;
          v84[3] = __Block_byref_object_copy__254244;
          v84[4] = __Block_byref_object_dispose__254245;
          v85 = 0;
          group = dispatch_group_create();
          v80 = 0u;
          v81 = 0u;
          v82 = 0u;
          v83 = 0u;
          obj = v48;
          v20 = [obj countByEnumeratingWithState:&v80 objects:v99 count:16];
          if (v20)
          {
            v53 = 0;
            v58 = *v81;
            v50 = *MEMORY[0x277CD0640];
            do
            {
              for (i = 0; i != v20; ++i)
              {
                if (*v81 != v58)
                {
                  objc_enumerationMutation(obj);
                }

                v22 = *(*(&v80 + 1) + 8 * i);
                users = [v59 users];
                v24 = [users hmf_firstObjectWithValue:v22 forKeyPath:@"userID"];

                objc_opt_class();
                if (objc_opt_isKindOfClass())
                {
                  v25 = v24;
                  if ([v25 configurationState] == 2)
                  {
                    v92 = @"kRequestedCapabilitiesKey";
                    v90 = @"kHomedVersionKey";
                    v26 = homedVersion;
                    v91 = v26;
                    v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v91 forKeys:&v90 count:1];
                    v93 = v27;
                    v28 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v93 forKeys:&v92 count:1];

                    v88[0] = v50;
                    uuid = [v59 uuid];
                    uUIDString3 = [uuid UUIDString];
                    v89[0] = uUIDString3;
                    v89[1] = allObjects;
                    v88[1] = @"kAccessoryIdentitiesKey";
                    v88[2] = @"kRemoteSessionIdentifierKey";
                    uUIDString4 = [uUID UUIDString];
                    v89[2] = uUIDString4;
                    v32 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v89 forKeys:v88 count:3];

                    v33 = [MEMORY[0x277D0F818] internalMessageWithName:@"kAreYouAtHomeRequestKey" messagePayload:v32];
                    dispatch_group_enter(group);
                    objc_initWeak(location, self);
                    workQueue = [(HMDHomeManager *)self workQueue];
                    v70[0] = MEMORY[0x277D85DD0];
                    v70[1] = 3221225472;
                    v70[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke;
                    v70[3] = &unk_278686188;
                    v70[4] = self;
                    v35 = v33;
                    v71 = v35;
                    v72 = v22;
                    objc_copyWeak(v79, location);
                    v73 = v59;
                    v76 = buf;
                    v77 = v84;
                    v36 = uUID;
                    v79[1] = count;
                    v74 = v36;
                    v78 = v86;
                    v75 = group;
                    [(HMDHomeManager *)self electDeviceForUser:v22 destination:v22 deviceCapabilities:v28 queue:workQueue completionHandler:v70];

                    objc_destroyWeak(v79);
                    objc_destroyWeak(location);
                  }

                  else
                  {
                    v40 = objc_autoreleasePoolPush();
                    v41 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
                    {
                      v42 = HMFGetLogIdentifier();
                      displayName = [v25 displayName];
                      *location = 138543618;
                      *&location[4] = v42;
                      v95 = 2112;
                      v96 = displayName;
                      _os_log_impl(&dword_229538000, v41, OS_LOG_TYPE_INFO, "%{public}@Skipping resident %@ since it is disabled", location, 0x16u);
                    }

                    objc_autoreleasePoolPop(v40);
                    ++v53;
                  }
                }

                else
                {
                  v37 = objc_autoreleasePoolPush();
                  v38 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
                  {
                    v39 = HMFGetLogIdentifier();
                    *location = 138543874;
                    *&location[4] = v39;
                    v95 = 2112;
                    v96 = v24;
                    v97 = 2112;
                    v98 = v22;
                    _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_ERROR, "%{public}@Found user %@ when looking for a resident user if userID %@", location, 0x20u);
                  }

                  objc_autoreleasePoolPop(v37);
                }
              }

              v20 = [obj countByEnumeratingWithState:&v80 objects:v99 count:16];
            }

            while (v20);
          }

          else
          {
            v53 = 0;
          }

          workQueue2 = [(HMDHomeManager *)self workQueue];
          block[0] = MEMORY[0x277D85DD0];
          block[1] = 3221225472;
          block[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_1110;
          block[3] = &unk_2786861B0;
          v61 = uUID;
          selfCopy = self;
          v69 = v53;
          v63 = obj;
          v64 = homeCopy;
          v66 = buf;
          v65 = v59;
          v67 = v86;
          countCopy = count;
          v45 = uUID;
          dispatch_group_notify(group, workQueue2, block);

          _Block_object_dispose(v84, 8);
          _Block_object_dispose(buf, 8);

          _Block_object_dispose(v86, 8);
        }
      }
    }

    v4 = v59;
  }

  v46 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v40 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  if (v7)
  {
    WeakRetained = objc_loadWeakRetained((a1 + 104));
    if (WeakRetained)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543362;
        v39 = v13;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Failed to elect device for remote session", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
    }

    dispatch_group_leave(*(a1 + 72));
  }

  else
  {
    v14 = [*(a1 + 32) messageDispatcher];
    v26 = *(a1 + 40);
    v15 = [*(a1 + 32) uuid];
    v25 = *(a1 + 48);
    v16 = [v8 destination];
    v17 = [*(a1 + 32) workQueue];
    v27[0] = MEMORY[0x277D85DD0];
    v27[1] = 3221225472;
    v27[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_2;
    v27[3] = &unk_278686160;
    objc_copyWeak(v37, (a1 + 104));
    v18 = v8;
    v19 = *(a1 + 32);
    v28 = v18;
    v29 = v19;
    v20 = *(a1 + 56);
    v21 = *(a1 + 48);
    v30 = v20;
    v31 = v21;
    v32 = v9;
    v35 = *(a1 + 80);
    v22 = *(a1 + 64);
    v37[1] = *(a1 + 112);
    v23 = *(a1 + 96);
    v33 = v22;
    v36 = v23;
    v34 = *(a1 + 72);
    [v14 sendSecureMessage:v26 target:v15 userID:v25 destination:v16 responseQueue:v17 responseHandler:v27];

    objc_destroyWeak(v37);
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_1110(uint64_t a1)
{
  v33 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v5 = [*(a1 + 32) UUIDString];
    v27 = 138543618;
    v28 = v4;
    v29 = 2112;
    v30 = v5;
    _os_log_impl(&dword_229538000, v3, OS_LOG_TYPE_INFO, "%{public}@Remote access election completed for session %@", &v27, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 40) pendingRemoteSessions];
  [v6 removeObjectForKey:*(a1 + 32)];

  v7 = *(a1 + 96);
  if ([*(a1 + 48) count] == v7)
  {
    [*(a1 + 40) _teardownRemoteAccessForHome:*(a1 + 56)];
    goto LABEL_17;
  }

  if (*(*(*(a1 + 72) + 8) + 40))
  {
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 64) uuid];
      v12 = [v11 UUIDString];
      v13 = [*(*(*(a1 + 72) + 8) + 40) userID];
      v27 = 138543874;
      v28 = v10;
      v29 = 2112;
      v30 = v12;
      v31 = 2112;
      v32 = v13;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Setting up remote access for home, %@, with resident %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v14 = [*(*(*(a1 + 72) + 8) + 40) userID];
    v15 = [HMDDevice deviceWithDestination:v14];

    v16 = [*(a1 + 40) messageDispatcher];
    [v16 setRemoteAccessDevice:v15 forHome:*(a1 + 64)];

LABEL_16:
    goto LABEL_17;
  }

  v17 = *(*(*(a1 + 80) + 8) + 24);
  v18 = objc_autoreleasePoolPush();
  v19 = HMFGetOSLogHandle();
  v20 = os_log_type_enabled(v19, OS_LOG_TYPE_INFO);
  if (v17 != 1)
  {
    if (v20)
    {
      v24 = HMFGetLogIdentifier();
      v25 = [*(a1 + 64) uuid];
      v27 = 138543618;
      v28 = v24;
      v29 = 2112;
      v30 = v25;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Not setting up remote access for home, %@, as no available residents were found", &v27, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v15 = [*(a1 + 40) messageDispatcher];
    [v15 setRemoteAccessDevice:0 forHome:*(a1 + 64)];
    goto LABEL_16;
  }

  if (v20)
  {
    v21 = HMFGetLogIdentifier();
    v22 = [*(a1 + 56) UUIDString];
    v23 = *(a1 + 88) + 1;
    v27 = 138543874;
    v28 = v21;
    v29 = 2112;
    v30 = v22;
    v31 = 2048;
    v32 = v23;
    _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Failed to setup remote session for home with UUID %@, retry attempt %ld", &v27, 0x20u);
  }

  objc_autoreleasePoolPop(v18);
  [*(a1 + 40) _electRemoteAccessPeerForHome:*(a1 + 56) retryCount:*(a1 + 88) + 1];
LABEL_17:
  v26 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v65 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 112));
  if (WeakRetained)
  {
    if (!v5 && v6)
    {
      v8 = [v6 hmf_BOOLForKey:@"kAtHomeStateKey"];
      v9 = [v6 hmf_UUIDForKey:@"kRemoteSessionIdentifierKey"];
      v10 = v9;
      if (!v8 || !v9)
      {
        v36 = objc_autoreleasePoolPush();
        v37 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
        {
          v38 = HMFGetLogIdentifier();
          v39 = *(a1 + 72);
          *buf = 138543618;
          v56 = v38;
          v57 = 2112;
          v58 = v39;
          _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is not at home", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v36);
        goto LABEL_44;
      }

      v11 = [*(a1 + 32) destination];
      v12 = [WeakRetained pendingRemoteSessions];
      v13 = [v12 objectForKeyedSubscript:v10];

      if (!v13)
      {
        v40 = objc_autoreleasePoolPush();
        v41 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v43 = v42 = v11;
          *buf = 138543618;
          v56 = v43;
          v57 = 2112;
          v58 = v42;
          _os_log_impl(&dword_229538000, v41, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is at home, dropping setting up remote access since we tore the session down", buf, 0x16u);

          v11 = v42;
        }

        objc_autoreleasePoolPop(v40);
        goto LABEL_43;
      }

      v14 = *(a1 + 40);
      v15 = [*(a1 + 48) uuid];
      v16 = [v14 _homeWithUUID:v15];

      v17 = [v16 users];
      v18 = [v17 hmf_firstObjectWithValue:*(a1 + 56) forKeyPath:@"userID"];

      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v19 = v18;
      }

      else
      {
        v19 = 0;
      }

      v20 = v19;

      if (!v20 || [v20 configurationState] != 2)
      {
LABEL_42:

LABEL_43:
LABEL_44:

        goto LABEL_45;
      }

      context = objc_autoreleasePoolPush();
      v21 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
      {
        HMFGetLogIdentifier();
        v49 = v16;
        v23 = v22 = v11;
        *buf = 138543618;
        v56 = v23;
        v57 = 2112;
        v58 = v22;
        _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is at home", buf, 0x16u);

        v11 = v22;
        v16 = v49;
      }

      objc_autoreleasePoolPop(context);
      v24 = [*(a1 + 64) objectForKeyedSubscript:@"kHomedVersionKey"];
      if (v24)
      {
        v25 = v24;
      }

      else
      {
        v25 = &unk_283E75FD8;
      }

      v26 = *(*(a1 + 88) + 8);
      v28 = *(v26 + 40);
      v27 = (v26 + 40);
      if (v28)
      {
        v29 = *(*(*(a1 + 96) + 8) + 40);
        if (!v29 || [v29 compare:v25] != -1)
        {
          contexta = objc_autoreleasePoolPush();
          v30 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
          {
            HMFGetLogIdentifier();
            v31 = v50 = v11;
            *buf = 138543874;
            v56 = v31;
            v57 = 2112;
            v58 = v50;
            v59 = 2112;
            v60 = v25;
            _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Dropping resident %@ (%@) as a resident with a higher homed version was found", buf, 0x20u);

            v11 = v50;
          }

          objc_autoreleasePoolPop(contexta);
          goto LABEL_41;
        }

        v48 = objc_autoreleasePoolPush();
        contextb = HMFGetOSLogHandle();
        if (os_log_type_enabled(contextb, OS_LOG_TYPE_INFO))
        {
          v47 = HMFGetLogIdentifier();
          [*(*(*(a1 + 88) + 8) + 40) userID];
          v44 = v51 = v11;
          v45 = *(*(*(a1 + 96) + 8) + 40);
          *buf = 138544386;
          v56 = v47;
          v57 = 2112;
          v58 = v51;
          v59 = 2112;
          v60 = v25;
          v61 = 2112;
          v62 = v44;
          v63 = 2112;
          v64 = v45;
          _os_log_impl(&dword_229538000, contextb, OS_LOG_TYPE_INFO, "%{public}@Preferring %@ (%@) over %@ (%@) due to higher homed version", buf, 0x34u);

          v11 = v51;
        }

        objc_autoreleasePoolPop(v48);
        v27 = (*(*(a1 + 88) + 8) + 40);
      }

      objc_storeStrong(v27, v19);
      objc_storeStrong((*(*(a1 + 96) + 8) + 40), v25);
LABEL_41:

      goto LABEL_42;
    }

    v32 = objc_autoreleasePoolPush();
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v56 = v34;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_INFO, "%{public}@Failed to send secure message to elect device for remote session", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v32);
    if (v5)
    {
      v10 = [v5 domain];
      if (![v10 isEqualToString:*MEMORY[0x277CCA590]] || objc_msgSend(v5, "code") != -6722 && objc_msgSend(v5, "code") != -6752)
      {
        goto LABEL_44;
      }

      v35 = *(a1 + 120);

      if (v35 <= 1)
      {
        *(*(*(a1 + 104) + 8) + 24) = 1;
      }
    }
  }

LABEL_45:
  dispatch_group_leave(*(a1 + 80));

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_electRemoteGatewayForHomesAfterReachabilityChanges
{
  v35 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Reachability changed from not reachable to reachable, checking remote access setup for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v26 = 0u;
  v27 = 0u;
  v24 = 0u;
  v25 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v6 = [obj countByEnumeratingWithState:&v24 objects:v34 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v25;
    selfCopy = self;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v25 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v10 = *(*(&v24 + 1) + 8 * i);
        v11 = objc_autoreleasePoolPush();
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          name = [v10 name];
          uuid = [v10 uuid];
          [uuid UUIDString];
          v16 = v7;
          v18 = v17 = v8;
          *buf = 138543874;
          v29 = v13;
          v30 = 2112;
          v31 = name;
          v32 = 2112;
          v33 = v18;
          _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Triggering election of resident device for remote access for home %@ (%@)", buf, 0x20u);

          v8 = v17;
          v7 = v16;
          self = selfCopy;
        }

        objc_autoreleasePoolPop(v11);
        uuid2 = [v10 uuid];
        [(HMDHomeManager *)self _teardownRemoteAccessForHome:uuid2];

        uuid3 = [v10 uuid];
        [(HMDHomeManager *)self _electRemoteAccessPeerForHome:uuid3];
      }

      v7 = [obj countByEnumeratingWithState:&v24 objects:v34 count:16];
    }

    while (v7);
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_findRemotePeerContainingAccessories:(id)accessories forHome:(id)home
{
  v59 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  homeCopy = home;
  if (!isAppleTV())
  {
    v40 = homeCopy;
    v48 = 0u;
    v49 = 0u;
    v46 = 0u;
    v47 = 0u;
    obj = [(HMDHomeManager *)self unassociatedRemotePeers];
    v7 = [obj countByEnumeratingWithState:&v46 objects:v58 count:16];
    if (v7)
    {
      v41 = *v47;
      v37 = *MEMORY[0x277CD0640];
      *&v8 = 138543874;
      v36 = v8;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v47 != v41)
          {
            objc_enumerationMutation(obj);
          }

          v10 = *(*(&v46 + 1) + 8 * i);
          capabilities = [v10 capabilities];
          isResidentCapable = [capabilities isResidentCapable];

          if ((isResidentCapable & 1) == 0)
          {
            pendingResidentSetupSessions = [(HMDHomeManager *)self pendingResidentSetupSessions];
            remoteDestinationString = [v10 remoteDestinationString];
            v15 = [pendingResidentSetupSessions containsObject:remoteDestinationString];

            if (v15)
            {
              v16 = objc_autoreleasePoolPush();
              v17 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
              {
                v18 = HMFGetLogIdentifier();
                uuid = [v40 uuid];
                uUIDString = [uuid UUIDString];
                *buf = v36;
                v53 = v18;
                v54 = 2112;
                v55 = v10;
                v56 = 2112;
                v57 = uUIDString;
                _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@We have a pending request to look for unpaired accessories to device, %@, for home: %@, dropping this request", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v16);
            }

            else
            {
              pendingResidentSetupSessions2 = [(HMDHomeManager *)self pendingResidentSetupSessions];
              remoteDestinationString2 = [v10 remoteDestinationString];
              [pendingResidentSetupSessions2 addObject:remoteDestinationString2];

              v50[0] = @"kAccessoryIdentitiesKey";
              v50[1] = v37;
              v51[0] = accessoriesCopy;
              uuid2 = [v40 uuid];
              uUIDString2 = [uuid2 UUIDString];
              v51[1] = uUIDString2;
              v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v51 forKeys:v50 count:2];

              v26 = [HMDRemoteDeviceMessageDestination alloc];
              uuid3 = [(HMDHomeManager *)self uuid];
              v28 = [(HMDRemoteDeviceMessageDestination *)v26 initWithTarget:uuid3 device:v10];

              v29 = objc_autoreleasePoolPush();
              v30 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
              {
                v31 = HMFGetLogIdentifier();
                uuid4 = [v40 uuid];
                *buf = v36;
                v53 = v31;
                v54 = 2112;
                v55 = v10;
                v56 = 2112;
                v57 = uuid4;
                _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Requesting remote gateway, %@, to look for accessories in home %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v29);
              v33 = [MEMORY[0x277D0F818] internalMessageWithName:@"kDoYouSeeUnpairedAccessoriesKey" destination:v28 messagePayload:v25];
              objc_initWeak(buf, self);
              v42[0] = MEMORY[0x277D85DD0];
              v42[1] = 3221225472;
              v42[2] = __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke;
              v42[3] = &unk_278689460;
              objc_copyWeak(&v45, buf);
              v43 = v40;
              v44 = v10;
              [v33 setResponseHandler:v42];
              messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
              [messageDispatcher sendMessage:v33 completionHandler:0];

              objc_destroyWeak(&v45);
              objc_destroyWeak(buf);
            }
          }
        }

        v7 = [obj countByEnumeratingWithState:&v46 objects:v58 count:16];
      }

      while (v7);
    }

    homeCopy = v40;
  }

  v35 = *MEMORY[0x277D85DE8];
}

void __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v8 = WeakRetained;
  if (WeakRetained)
  {
    v9 = [WeakRetained workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke_2;
    block[3] = &unk_278689550;
    v13 = v5;
    v14 = v6;
    v10 = *(a1 + 32);
    v11 = *(a1 + 40);
    v15 = v10;
    v16 = v11;
    v17 = v8;
    dispatch_async(v9, block);
  }
}

void __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke_2(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32) || (v7 = *(a1 + 40)) == 0)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
    {
      v4 = HMFGetLogIdentifier();
      v5 = *(a1 + 56);
      v6 = *(a1 + 32);
      v15 = 138543874;
      v16 = v4;
      v17 = 2112;
      v18 = v5;
      v19 = 2112;
      v20 = v6;
      _os_log_impl(&dword_229538000, v3, OS_LOG_TYPE_INFO, "%{public}@Remote peer, %@, failed to look for accessories with error:%@", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v2);
  }

  else
  {
    v8 = [v7 hmf_BOOLForKey:@"kAtHomeStateKey"];
    v9 = [*(a1 + 40) hmf_stringForKey:@"kDeviceNameKey"];
    v10 = v9;
    if (v8)
    {
      v11 = v9 == 0;
    }

    else
    {
      v11 = 1;
    }

    if (!v11)
    {
      [*(a1 + 48) addUnconfiguredResidentDevice:*(a1 + 56)];
    }
  }

  v12 = [*(a1 + 64) pendingResidentSetupSessions];
  v13 = [*(a1 + 56) remoteDestinationString];
  [v12 removeObject:v13];

  v14 = *MEMORY[0x277D85DE8];
}

- (void)atHomeLevelChanged:(int64_t)changed formerLevel:(int64_t)level home:(id)home
{
  v6 = [(HMDHomeManager *)self workQueue:changed];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __54__HMDHomeManager_atHomeLevelChanged_formerLevel_home___block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(v6, block);
}

- (void)_accessoriesAreLocallyReachableOnTransientDevice:(BOOL)device forHome:(id)home
{
  deviceCopy = device;
  v29 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    if (deviceCopy)
    {
      v10 = "";
    }

    else
    {
      v10 = "not ";
    }

    uUIDString = [homeCopy UUIDString];
    unassociatedRemotePeers = [(HMDHomeManager *)self unassociatedRemotePeers];
    v21 = 138544130;
    v22 = v9;
    v23 = 2080;
    v24 = v10;
    v25 = 2112;
    v26 = uUIDString;
    v27 = 2048;
    v28 = [unassociatedRemotePeers count];
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Accessories are %slocally reachable for home %@, peers %lu", &v21, 0x2Au);
  }

  objc_autoreleasePoolPop(v7);
  if (deviceCopy)
  {
    isWatch();
    v13 = [(HMDHomeManager *)self _homeWithUUID:homeCopy];
    isOwnerUser = [v13 isOwnerUser];
    if (v13)
    {
      v15 = isOwnerUser;
      unassociatedRemotePeers2 = [(HMDHomeManager *)self unassociatedRemotePeers];
      if ((([unassociatedRemotePeers2 count] != 0) & v15) != 1 || !objc_msgSend(v13, "allowsRemoteAccess"))
      {
LABEL_13:

        goto LABEL_14;
      }

      currentUser = [v13 currentUser];
      isRemoteAccessAllowed = [currentUser isRemoteAccessAllowed];

      if (isRemoteAccessAllowed)
      {
        v19 = [(HMDHomeManager *)self identifiersOfAccessoriesForHome:v13];
        unassociatedRemotePeers2 = [v19 allObjects];

        if ([unassociatedRemotePeers2 count])
        {
          [(HMDHomeManager *)self _findRemotePeerContainingAccessories:unassociatedRemotePeers2 forHome:v13];
        }

        goto LABEL_13;
      }
    }

LABEL_14:
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_removeFromAssociatedPeers:(id)peers home:(id)home
{
  v26 = *MEMORY[0x277D85DE8];
  peersCopy = peers;
  homeCopy = home;
  [(HMDHomeManager *)self _remotePeers];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v8 = v24 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v22;
    while (2)
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v22 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v21 + 1) + 8 * i);
        remoteDestinationString = [v13 remoteDestinationString];
        v15 = [remoteDestinationString isEqualToString:peersCopy];

        if (v15)
        {
          unassociatedRemotePeers = [(HMDHomeManager *)self unassociatedRemotePeers];
          [unassociatedRemotePeers addObject:v13];

          if (homeCopy)
          {
            associatedRemotePeers = [(HMDHomeManager *)self associatedRemotePeers];
            uuid = [homeCopy uuid];
            v19 = [associatedRemotePeers objectForKeyedSubscript:uuid];

            if (v19)
            {
              [v19 removeObject:peersCopy];
            }
          }

          goto LABEL_14;
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
      if (v10)
      {
        continue;
      }

      break;
    }
  }

LABEL_14:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_removeFromUnassociatedPeers:(id)peers home:(id)home
{
  v29 = *MEMORY[0x277D85DE8];
  peersCopy = peers;
  homeCopy = home;
  _remotePeers = [(HMDHomeManager *)self _remotePeers];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v9 = [_remotePeers countByEnumeratingWithState:&v24 objects:v28 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v25;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v25 != v11)
        {
          objc_enumerationMutation(_remotePeers);
        }

        v13 = *(*(&v24 + 1) + 8 * i);
        remoteDestinationString = [v13 remoteDestinationString];
        v15 = [remoteDestinationString isEqualToString:peersCopy];

        if (v15)
        {
          unassociatedRemotePeers = [(HMDHomeManager *)self unassociatedRemotePeers];
          [unassociatedRemotePeers removeObject:v13];

          remoteDestinationString2 = [v13 remoteDestinationString];
          [homeCopy removeUnconfiguredResidentDeviceWithUserID:remoteDestinationString2];

          if (homeCopy)
          {
            associatedRemotePeers = [(HMDHomeManager *)self associatedRemotePeers];
            uuid = [homeCopy uuid];
            v20 = [associatedRemotePeers objectForKeyedSubscript:uuid];

            if (!v20)
            {
              v20 = [MEMORY[0x277CBEB58] set];
              associatedRemotePeers2 = [(HMDHomeManager *)self associatedRemotePeers];
              uuid2 = [homeCopy uuid];
              [associatedRemotePeers2 setObject:v20 forKeyedSubscript:uuid2];
            }

            [v20 addObject:peersCopy];
          }
        }
      }

      v10 = [_remotePeers countByEnumeratingWithState:&v24 objects:v28 count:16];
    }

    while (v10);
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)removeFromUnassociatedPeers:(id)peers home:(id)home
{
  peersCopy = peers;
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_removeFromUnassociatedPeers_home___block_invoke;
  block[3] = &unk_27868A010;
  block[4] = self;
  v12 = peersCopy;
  v13 = homeCopy;
  v9 = homeCopy;
  v10 = peersCopy;
  dispatch_async(workQueue, block);
}

- (void)_checkForRemotePeersAndRegisterForRemoteNotifications:(BOOL)notifications
{
  notificationsCopy = notifications;
  v204 = *MEMORY[0x277D85DE8];
  unassociatedRemotePeers = [(HMDHomeManager *)self unassociatedRemotePeers];
  [unassociatedRemotePeers removeAllObjects];

  associatedRemotePeers = [(HMDHomeManager *)self associatedRemotePeers];
  [associatedRemotePeers removeAllObjects];

  isWatch();
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];

  if (account)
  {
    array = [MEMORY[0x277CBEB18] array];
    v184 = 0u;
    v185 = 0u;
    v186 = 0u;
    v187 = 0u;
    selfCopy = self;
    homes = [(HMDHomeManager *)self homes];
    v11 = [homes countByEnumeratingWithState:&v184 objects:v203 count:16];
    if (v11)
    {
      v12 = v11;
      v13 = *v185;
      do
      {
        for (i = 0; i != v12; ++i)
        {
          if (*v185 != v13)
          {
            objc_enumerationMutation(homes);
          }

          users = [*(*(&v184 + 1) + 8 * i) users];
          [array addObjectsFromArray:users];
        }

        v12 = [homes countByEnumeratingWithState:&v184 objects:v203 count:16];
      }

      while (v12);
    }

    v16 = selfCopy;
    _remotePeers = [(HMDHomeManager *)selfCopy _remotePeers];
    productInfo = [MEMORY[0x277D0F8E8] productInfo];
    productClass = [productInfo productClass];

    v142 = notificationsCopy;
    if (productClass == 1)
    {
      watchManager = [(HMDHomeManager *)selfCopy watchManager];
      watches = [watchManager watches];

      v22 = [MEMORY[0x277CBEB58] setWithCapacity:{objc_msgSend(watches, "count")}];
      v180 = 0u;
      v181 = 0u;
      v182 = 0u;
      v183 = 0u;
      v23 = watches;
      v24 = [v23 countByEnumeratingWithState:&v180 objects:v202 count:16];
      if (v24)
      {
        v25 = v24;
        v26 = *v181;
        do
        {
          for (j = 0; j != v25; ++j)
          {
            if (*v181 != v26)
            {
              objc_enumerationMutation(v23);
            }

            remoteDestinationString = [*(*(&v180 + 1) + 8 * j) remoteDestinationString];
            [v22 addObject:remoteDestinationString];
          }

          v25 = [v23 countByEnumeratingWithState:&v180 objects:v202 count:16];
        }

        while (v25);
      }

      v149 = _remotePeers;

      v178 = 0u;
      v179 = 0u;
      v176 = 0u;
      v177 = 0u;
      homes2 = [(HMDHomeManager *)selfCopy homes];
      v30 = [homes2 countByEnumeratingWithState:&v176 objects:v201 count:16];
      if (v30)
      {
        v31 = v30;
        v32 = *v177;
        do
        {
          for (k = 0; k != v31; ++k)
          {
            if (*v177 != v32)
            {
              objc_enumerationMutation(homes2);
            }

            [*(*(&v176 + 1) + 8 * k) auditDestinationsForNotifications:v22];
          }

          v31 = [homes2 countByEnumeratingWithState:&v176 objects:v201 count:16];
        }

        while (v31);
      }

      obj = v23;
      v151 = array;

      v174 = 0u;
      v175 = 0u;
      v172 = 0u;
      v173 = 0u;
      v16 = selfCopy;
      fullSyncedWatchPeers = [(HMDHomeManager *)selfCopy fullSyncedWatchPeers];
      v35 = [fullSyncedWatchPeers copy];

      v36 = [v35 countByEnumeratingWithState:&v172 objects:v200 count:16];
      if (v36)
      {
        v37 = v36;
        v38 = *v173;
        do
        {
          for (m = 0; m != v37; ++m)
          {
            if (*v173 != v38)
            {
              objc_enumerationMutation(v35);
            }

            v40 = *(*(&v172 + 1) + 8 * m);
            if (([v22 containsObject:v40] & 1) == 0)
            {
              v41 = objc_autoreleasePoolPush();
              v42 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v42, OS_LOG_TYPE_INFO))
              {
                v43 = HMFGetLogIdentifier();
                *buf = 138543618;
                v190 = v43;
                v191 = 2112;
                v192 = v40;
                _os_log_impl(&dword_229538000, v42, OS_LOG_TYPE_INFO, "%{public}@Fully synced watch %@ is no more paired", buf, 0x16u);
              }

              objc_autoreleasePoolPop(v41);
              fullSyncedWatchPeers2 = [(HMDHomeManager *)selfCopy fullSyncedWatchPeers];
              [fullSyncedWatchPeers2 removeObject:v40];
            }
          }

          v37 = [v35 countByEnumeratingWithState:&v172 objects:v200 count:16];
        }

        while (v37);
      }

      _remotePeers = v149;
      array = v151;
    }

    v150 = [MEMORY[0x277CBEB58] set];
    v45 = objc_autoreleasePoolPush();
    v46 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v46, OS_LOG_TYPE_INFO))
    {
      v47 = HMFGetLogIdentifier();
      *buf = 138543362;
      v190 = v47;
      _os_log_impl(&dword_229538000, v46, OS_LOG_TYPE_INFO, "%{public}@Checking for updated list of devices for remote access", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v45);
    v170 = 0u;
    v171 = 0u;
    v168 = 0u;
    v169 = 0u;
    obja = _remotePeers;
    v153 = [obja countByEnumeratingWithState:&v168 objects:v199 count:16];
    if (v153)
    {
      v48 = *v169;
      v145 = *v169;
      do
      {
        for (n = 0; n != v153; ++n)
        {
          if (*v169 != v48)
          {
            objc_enumerationMutation(obja);
          }

          v50 = *(*(&v168 + 1) + 8 * n);
          remoteDestinationString2 = [v50 remoteDestinationString];

          if (remoteDestinationString2)
          {
            remoteDestinationString3 = [v50 remoteDestinationString];
            [v150 addObject:remoteDestinationString3];
          }

          v53 = objc_autoreleasePoolPush();
          v54 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v54, OS_LOG_TYPE_INFO))
          {
            v55 = HMFGetLogIdentifier();
            *buf = 138543618;
            v190 = v55;
            v191 = 2112;
            v192 = v50;
            _os_log_impl(&dword_229538000, v54, OS_LOG_TYPE_INFO, "%{public}@Detected device: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v53);
          remoteDestinationString4 = [v50 remoteDestinationString];
          v57 = array;
          v58 = [array hmf_firstObjectWithValue:remoteDestinationString4 forKeyPath:@"userID"];

          isWatch();
          if (v58 && (objc_opt_class(), (objc_opt_isKindOfClass() & 1) != 0))
          {
            v59 = v58;
            if (([v59 updateWithDevice:v50] & 1) != 0 || !objc_msgSend(v59, "configurationState"))
            {
              [v59 setConfigurationState:2];
            }

            else
            {
              v166 = 0u;
              v167 = 0u;
              v164 = 0u;
              v165 = 0u;
              homes3 = [(HMDHomeManager *)v16 homes];
              v61 = [homes3 countByEnumeratingWithState:&v164 objects:v198 count:16];
              if (v61)
              {
                v62 = v61;
                v63 = *v165;
                do
                {
                  for (ii = 0; ii != v62; ++ii)
                  {
                    if (*v165 != v63)
                    {
                      objc_enumerationMutation(homes3);
                    }

                    usersPendingUserManagementOperations = [*(*(&v164 + 1) + 8 * ii) usersPendingUserManagementOperations];
                    if ([usersPendingUserManagementOperations containsObject:v59])
                    {
                      configurationState = [v59 configurationState];

                      if (configurationState == 1)
                      {
                        [v59 setConfigurationState:2];
                      }
                    }

                    else
                    {
                    }
                  }

                  v62 = [homes3 countByEnumeratingWithState:&v164 objects:v198 count:16];
                }

                while (v62);
              }

              v16 = selfCopy;
              v48 = v145;
            }
          }

          else
          {
            unassociatedRemotePeers2 = [(HMDHomeManager *)v16 unassociatedRemotePeers];
            [unassociatedRemotePeers2 addObject:v50];

            v68 = objc_autoreleasePoolPush();
            v69 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v69, OS_LOG_TYPE_INFO))
            {
              v70 = HMFGetLogIdentifier();
              *buf = 138543618;
              v190 = v70;
              v191 = 2112;
              v192 = v50;
              _os_log_impl(&dword_229538000, v69, OS_LOG_TYPE_INFO, "%{public}@Adding remote peer, %@, to unassociated list", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v68);
          }

          array = v57;
        }

        v153 = [obja countByEnumeratingWithState:&v168 objects:v199 count:16];
      }

      while (v153);
    }

    v71 = objc_autoreleasePoolPush();
    v72 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
    {
      v73 = HMFGetLogIdentifier();
      unassociatedRemotePeers3 = [(HMDHomeManager *)v16 unassociatedRemotePeers];
      v75 = [unassociatedRemotePeers3 count];
      *buf = 138543618;
      v190 = v73;
      v191 = 2048;
      v192 = v75;
      _os_log_impl(&dword_229538000, v72, OS_LOG_TYPE_INFO, "%{public}@Total unassociated peers %ld", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v71);
    appleAccountManager2 = [(HMDHomeManager *)v16 appleAccountManager];
    device = [appleAccountManager2 device];
    identifier = [device identifier];

    array2 = [MEMORY[0x277CBEB18] array];
    v160 = 0u;
    v161 = 0u;
    v162 = 0u;
    v163 = 0u;
    v146 = array;
    v79 = v142;
    v152 = [v146 countByEnumeratingWithState:&v160 objects:v197 count:16];
    if (v152)
    {
      v81 = *v161;
      *&v80 = 138543362;
      v140 = v80;
      v143 = identifier;
      v144 = *v161;
      do
      {
        for (jj = 0; jj != v152; ++jj)
        {
          if (*v161 != v81)
          {
            objc_enumerationMutation(v146);
          }

          v83 = *(*(&v160 + 1) + 8 * jj);
          uUIDString = [identifier UUIDString];
          pairingUsername = [v83 pairingUsername];
          v86 = [uUIDString isEqualToString:pairingUsername];

          if (!v86)
          {
            if (shouldLogPrivateInformation())
            {
              userID = [v83 userID];
            }

            else
            {
              v91 = @"...";
              userID = @"...";
            }

            home = [v83 home];
            v93 = objc_autoreleasePoolPush();
            v94 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v94, OS_LOG_TYPE_INFO))
            {
              v95 = HMFGetLogIdentifier();
              home2 = [v83 home];
              name = [home2 name];
              [v83 isRemoteGateway];
              v98 = HMFBooleanToString();
              *buf = 138544130;
              v190 = v95;
              v191 = 2112;
              v192 = userID;
              v193 = 2112;
              v194 = name;
              v195 = 2112;
              v196 = v98;
              _os_log_impl(&dword_229538000, v94, OS_LOG_TYPE_INFO, "%{public}@Existing user: %@, for home: %@, isRemoteGateway: %@", buf, 0x2Au);

              identifier = v143;
              v81 = v144;

              v16 = selfCopy;
            }

            objc_autoreleasePoolPop(v93);
            if (![v83 isRemoteGateway])
            {
              goto LABEL_110;
            }

            isOwnerUser = [home isOwnerUser];
            if ((isOwnerUser & 1) == 0)
            {
              isWatch();
            }

            userID2 = [v83 userID];
            v101 = [v150 containsObject:userID2];
            if ((v101 | isOwnerUser))
            {
              v102 = v101;

              if (!v102)
              {
LABEL_91:
                v16 = selfCopy;
                if (isOwnerUser)
                {
                  v103 = objc_autoreleasePoolPush();
                  v104 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v104, OS_LOG_TYPE_INFO))
                  {
                    v105 = HMFGetLogIdentifier();
                    userID3 = [v83 userID];
                    *buf = 138543618;
                    v190 = v105;
                    v191 = 2112;
                    v192 = userID3;
                    _os_log_impl(&dword_229538000, v104, OS_LOG_TYPE_INFO, "%{public}@Previous associated remote peer %@ has been removed", buf, 0x16u);

                    v16 = selfCopy;
                  }

                  objc_autoreleasePoolPop(v103);
                  [array2 addObject:v83];
                  v107 = objc_autoreleasePoolPush();
                  v108 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v108, OS_LOG_TYPE_DEBUG))
                  {
                    v109 = HMFGetLogIdentifier();
                    *buf = v140;
                    v190 = v109;
                    _os_log_impl(&dword_229538000, v108, OS_LOG_TYPE_DEBUG, "%{public}@Remove resident device", buf, 0xCu);
                  }

                  objc_autoreleasePoolPop(v107);
                }

                goto LABEL_110;
              }
            }

            else
            {
              userID4 = [v83 userID];

              if (!userID4)
              {
                goto LABEL_91;
              }
            }

            v111 = objc_autoreleasePoolPush();
            v112 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v112, OS_LOG_TYPE_INFO))
            {
              v113 = HMFGetLogIdentifier();
              userID5 = [v83 userID];
              home3 = [v83 home];
              name2 = [home3 name];
              *buf = 138543874;
              v190 = v113;
              v191 = 2112;
              v192 = userID5;
              v193 = 2112;
              v194 = name2;
              _os_log_impl(&dword_229538000, v112, OS_LOG_TYPE_INFO, "%{public}@Adding remote peer %@ for home %@", buf, 0x20u);

              v79 = v142;
              identifier = v143;

              v81 = v144;
            }

            objc_autoreleasePoolPop(v111);
            associatedRemotePeers2 = [(HMDHomeManager *)selfCopy associatedRemotePeers];
            uuid = [home uuid];
            v119 = [associatedRemotePeers2 objectForKeyedSubscript:uuid];

            if (!v119)
            {
              v119 = [MEMORY[0x277CBEB58] set];
              associatedRemotePeers3 = [(HMDHomeManager *)selfCopy associatedRemotePeers];
              uuid2 = [home uuid];
              [associatedRemotePeers3 setObject:v119 forKeyedSubscript:uuid2];
            }

            userID6 = [v83 userID];
            [v119 addObject:userID6];

            userID7 = [v83 userID];
            if (([v150 containsObject:userID7] | isOwnerUser))
            {
LABEL_108:
            }

            else
            {
              objc_opt_class();
              isKindOfClass = objc_opt_isKindOfClass();

              if (isKindOfClass)
              {
                userID7 = v83;
                if (![userID7 configurationState])
                {
                  v125 = objc_autoreleasePoolPush();
                  v126 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v126, OS_LOG_TYPE_INFO))
                  {
                    v127 = HMFGetLogIdentifier();
                    v123UserID = [userID7 userID];
                    *buf = 138543618;
                    v190 = v127;
                    v191 = 2112;
                    v192 = v123UserID;
                    _os_log_impl(&dword_229538000, v126, OS_LOG_TYPE_INFO, "%{public}@[HMDHomeManager] Unknown configuration state, enabling '%@'", buf, 0x16u);

                    v81 = v144;
                  }

                  objc_autoreleasePoolPop(v125);
                  [userID7 setConfigurationState:2];
                }

                goto LABEL_108;
              }
            }

            v16 = selfCopy;
LABEL_110:

            continue;
          }

          v87 = objc_autoreleasePoolPush();
          v88 = v16;
          v89 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v89, OS_LOG_TYPE_INFO))
          {
            v90 = HMFGetLogIdentifier();
            *buf = 138543618;
            v190 = v90;
            v191 = 2112;
            v192 = v83;
            _os_log_impl(&dword_229538000, v89, OS_LOG_TYPE_INFO, "%{public}@Skipping resident user representing ourselves: %@", buf, 0x16u);

            v16 = selfCopy;
          }

          objc_autoreleasePoolPop(v87);
        }

        v152 = [v146 countByEnumeratingWithState:&v160 objects:v197 count:16];
      }

      while (v152);
    }

    v158 = 0u;
    v159 = 0u;
    v156 = 0u;
    v157 = 0u;
    homes4 = [(HMDHomeManager *)v16 homes];
    v130 = [homes4 countByEnumeratingWithState:&v156 objects:v188 count:16];
    if (v130)
    {
      v131 = v130;
      v132 = *v157;
      do
      {
        for (kk = 0; kk != v131; ++kk)
        {
          if (*v157 != v132)
          {
            objc_enumerationMutation(homes4);
          }

          v134 = *(*(&v156 + 1) + 8 * kk);
          unassociatedRemotePeers4 = [(HMDHomeManager *)selfCopy unassociatedRemotePeers];
          [v134 notifyNewRemotePeersFound:objc_msgSend(unassociatedRemotePeers4 remoteUsersRemoved:"count") != 0 forceRemoteNotificationRegistration:{array2, v79}];
        }

        v131 = [homes4 countByEnumeratingWithState:&v156 objects:v188 count:16];
      }

      while (v131);
    }
  }

  else
  {
    v136 = objc_autoreleasePoolPush();
    v137 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v137, OS_LOG_TYPE_INFO))
    {
      v138 = HMFGetLogIdentifier();
      *buf = 138543362;
      v190 = v138;
      _os_log_impl(&dword_229538000, v137, OS_LOG_TYPE_INFO, "%{public}@No active IDS account, cannot check for remote peers.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v136);
  }

  v139 = *MEMORY[0x277D85DE8];
}

- (id)_remotePeers
{
  v25 = *MEMORY[0x277D85DE8];
  isWatch();
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];
  devices = [account devices];

  v6 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(devices, "count")}];
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  appleAccountManager2 = [(HMDHomeManager *)self appleAccountManager];
  account2 = [appleAccountManager2 account];
  devices2 = [account2 devices];

  v10 = [devices2 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v21;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v21 != v12)
        {
          objc_enumerationMutation(devices2);
        }

        v14 = *(*(&v20 + 1) + 8 * i);
        capabilities = [v14 capabilities];
        if ([capabilities isRemoteGatewayCapable])
        {
          isCurrentDevice = [v14 isCurrentDevice];

          if ((isCurrentDevice & 1) == 0)
          {
            [v6 addObject:v14];
          }
        }

        else
        {
        }
      }

      v11 = [devices2 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v11);
  }

  v17 = [v6 copy];
  v18 = *MEMORY[0x277D85DE8];

  return v17;
}

- (void)_checkForRemotePeers
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __38__HMDHomeManager__checkForRemotePeers__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)checkForRemotePeers
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __37__HMDHomeManager_checkForRemotePeers__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (BOOL)isPairedWithWatch
{
  watchManager = [(HMDHomeManager *)self watchManager];
  isPairedWithWatch = [watchManager isPairedWithWatch];

  return isPairedWithWatch;
}

- (void)_checkAndInformCompanionDevice
{
  v25 = *MEMORY[0x277D85DE8];
  companionManager = [(HMDHomeManager *)self companionManager];
  companion = [companionManager companion];

  if ((companion != 0) != [(HMDHomeManager *)self companionReachable])
  {
    [(HMDHomeManager *)self setCompanionReachable:companion != 0];
    v5 = +[HMDWatchSystemState sharedState];
    [v5 setCompanionReachable:companion != 0];

    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v22 = v8;
      v23 = 1024;
      companionReachable = [(HMDHomeManager *)self companionReachable];
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Companion is reachable: %d", buf, 0x12u);
    }

    objc_autoreleasePoolPop(v6);
    [(HMDHomeManager *)self _checkForRemotePeers];
    if (![(HMDHomeManager *)self companionReachable])
    {
      v18 = 0u;
      v19 = 0u;
      v16 = 0u;
      v17 = 0u;
      homes = [(HMDHomeManager *)self homes];
      v10 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
      if (v10)
      {
        v11 = v10;
        v12 = *v17;
        do
        {
          v13 = 0;
          do
          {
            if (*v17 != v12)
            {
              objc_enumerationMutation(homes);
            }

            uuid = [*(*(&v16 + 1) + 8 * v13) uuid];
            [(HMDHomeManager *)self _teardownRemoteAccessForHomeThroughCompanion:uuid];

            ++v13;
          }

          while (v11 != v13);
          v11 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
        }

        while (v11);
      }
    }
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (HMDDevice)companionDevice
{
  companionManager = [(HMDHomeManager *)self companionManager];
  companion = [companionManager companion];

  return companion;
}

- (void)_handleHomeUtilCommandWalletMessage:(id)message
{
  v18 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  if (isInternalBuild())
  {
    v5 = objc_autoreleasePoolPush();
    selfCopy = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v15 = v8;
      v16 = 2112;
      v17 = messageCopy;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@homeUtilCommandWallet message: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    v9 = [messageCopy dataForKey:@"HomeUtil.Command.Wallet"];
    if (v9)
    {
      v12[0] = MEMORY[0x277D85DD0];
      v12[1] = 3221225472;
      v12[2] = __54__HMDHomeManager__handleHomeUtilCommandWalletMessage___block_invoke;
      v12[3] = &unk_278686138;
      v13 = messageCopy;
      [HMDHomeUtilPassCommandHandler handlePassCommandForData:v9 completionHandler:v12];
      v10 = v13;
    }

    else
    {
      v10 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:3 reason:@"Command data was nil"];
      [messageCopy respondWithError:v10];
    }
  }

  v11 = *MEMORY[0x277D85DE8];
}

void __54__HMDHomeManager__handleHomeUtilCommandWalletMessage___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v11[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v6)
  {
    [*(a1 + 32) respondWithError:v6];
  }

  else
  {
    v7 = *(a1 + 32);
    if (v5)
    {
      v10 = @"result";
      v11[0] = v5;
      v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v11 forKeys:&v10 count:1];
      [v7 respondWithPayload:v8];
    }

    else
    {
      [v7 respondWithSuccess];
    }
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)syncWalletKeyPassSerialNumbersToWatch:(id)watch withCompletion:(id)completion
{
  v48 = *MEMORY[0x277D85DE8];
  watchCopy = watch;
  completionCopy = completion;
  version = [watchCopy version];
  v9 = +[HMDHomeKitVersion version8];
  v10 = [version isAtLeastVersion:v9];

  if (v10)
  {
    remoteDestinationString = [watchCopy remoteDestinationString];
    homes = [(HMDHomeManager *)self homes];
    v13 = [homes na_map:&__block_literal_global_1086];

    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    v17 = os_log_type_enabled(v16, OS_LOG_TYPE_INFO);
    if (v13)
    {
      if (v17)
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543874;
        v43 = v18;
        v44 = 2112;
        v45 = v13;
        v46 = 2112;
        v47 = remoteDestinationString;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Syncing wallet key pass serial numbers: %@ to watch: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      uuid = [(HMDHomeManager *)selfCopy uuid];
      v20 = [HMDMessageDispatcher destinationWithTarget:uuid userID:0 destination:remoteDestinationString multicast:0];

      if (v20)
      {
        v40 = @"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers";
        v41 = v13;
        v21 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v41 forKeys:&v40 count:1];
        v22 = [MEMORY[0x277D0F848] messageWithName:@"HMDHomeManagerSyncWalletKeysPassSerialNumbersMessage" qualityOfService:17 destination:v20 payload:v21];
        [v22 setSecureRemote:1];
        [v22 setRemoteRestriction:4];
        objc_initWeak(buf, selfCopy);
        workQueue = [(HMDHomeManager *)selfCopy workQueue];
        v32 = MEMORY[0x277D85DD0];
        v33 = 3221225472;
        v34 = __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_1087;
        v35 = &unk_278686110;
        v24 = workQueue;
        v36 = v24;
        objc_copyWeak(&v39, buf);
        v37 = remoteDestinationString;
        v38 = completionCopy;
        [v22 setResponseHandler:&v32];
        v25 = [(HMDHomeManager *)selfCopy messageDispatcher:v32];
        [v25 sendMessage:v22];

        objc_destroyWeak(&v39);
        objc_destroyWeak(buf);
      }

      else
      {
        v27 = objc_autoreleasePoolPush();
        v28 = selfCopy;
        v29 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
        {
          v30 = HMFGetLogIdentifier();
          *buf = 138543618;
          v43 = v30;
          v44 = 2112;
          v45 = remoteDestinationString;
          _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot sync wallet pass serial numbers to watch: could not create message destination for deviceId: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v27);
        completionCopy[2](completionCopy);
      }
    }

    else
    {
      if (v17)
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543618;
        v43 = v26;
        v44 = 2112;
        v45 = remoteDestinationString;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Did not find any wallet key pass serial numbers to sync to watch: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      completionCopy[2](completionCopy);
    }
  }

  else
  {
    completionCopy[2](completionCopy);
  }

  v31 = *MEMORY[0x277D85DE8];
}

void __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_1087(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = *(a1 + 32);
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_2;
  block[3] = &unk_2786860E8;
  objc_copyWeak(&v16, (a1 + 56));
  v12 = *(a1 + 40);
  v8 = *(a1 + 48);
  v14 = v5;
  v15 = v8;
  v13 = v6;
  v9 = v5;
  v10 = v6;
  dispatch_async(v7, block);

  objc_destroyWeak(&v16);
}

void __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_2(uint64_t a1)
{
  v24 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    v3 = [*(a1 + 40) hmf_BOOLForKey:@"kDataSyncResponseAckKey"];
    v4 = objc_autoreleasePoolPush();
    v5 = WeakRetained;
    v6 = HMFGetOSLogHandle();
    v7 = v6;
    if (v3)
    {
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v8 = HMFGetLogIdentifier();
        v9 = *(a1 + 32);
        v18 = 138543618;
        v19 = v8;
        v20 = 2112;
        v21 = v9;
        v10 = "%{public}@Successfully synced wallet key pass serial numbers to watch: %@";
        v11 = v7;
        v12 = OS_LOG_TYPE_INFO;
        v13 = 22;
LABEL_9:
        _os_log_impl(&dword_229538000, v11, v12, v10, &v18, v13);
      }
    }

    else if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v15 = *(a1 + 32);
      v16 = *(a1 + 48);
      v18 = 138543874;
      v19 = v8;
      v20 = 2112;
      v21 = v15;
      v22 = 2112;
      v23 = v16;
      v10 = "%{public}@Failed to sync wallet key pass serials numbers to watch %@:%@";
      v11 = v7;
      v12 = OS_LOG_TYPE_ERROR;
      v13 = 32;
      goto LABEL_9;
    }

LABEL_10:

    goto LABEL_11;
  }

  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v14 = *(a1 + 32);
    v18 = 138543618;
    v19 = v7;
    v20 = 2112;
    v21 = v14;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@HomeManager became nil while syncing wallet key pass serial numbers to watch: %@", &v18, 0x16u);
    goto LABEL_10;
  }

LABEL_11:

  objc_autoreleasePoolPop(v4);
  (*(*(a1 + 56) + 16))();

  v17 = *MEMORY[0x277D85DE8];
}

id __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke(uint64_t a1, void *a2)
{
  v2 = [a2 walletKeyManager];
  v3 = [v2 passSerialNumber];

  return v3;
}

- (void)_sendHomeDataToWatch:(id)watch migrateToHH2:(BOOL)h2 completionHandler:(id)handler
{
  h2Copy = h2;
  v119 = *MEMORY[0x277D85DE8];
  watchCopy = watch;
  handlerCopy = handler;
  val = self;
  watchManager = [(HMDHomeManager *)self watchManager];
  v72 = [watchManager connectedWatchFromDeviceID:watchCopy];

  if (!-[HMDHomeManager accountActive](self, "accountActive") || ([v72 capabilities], v8 = objc_claimAutoreleasedReturnValue(), v9 = objc_msgSend(v8, "supportsCloudDataSync"), v8, !v9))
  {
    context = objc_autoreleasePoolPush();
    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x3032000000;
    v116 = __Block_byref_object_copy__254244;
    v117 = __Block_byref_object_dispose__254245;
    v118 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-home-to-watch"];
    group = dispatch_group_create();
    version = [v72 version];
    v16 = +[HMDHomeKitVersion version4];
    v74 = [version isAtLeastVersion:v16];

    associatedWatchPeers = [(HMDHomeManager *)val associatedWatchPeers];
    v78 = [associatedWatchPeers objectForKeyedSubscript:watchCopy];

    objc_initWeak(&location, val);
    [(HMDHomeManager *)val homes];
    v99 = 0u;
    v100 = 0u;
    v97 = 0u;
    obj = v98 = 0u;
    v18 = [obj countByEnumeratingWithState:&v97 objects:v114 count:16];
    if (v18)
    {
      v19 = 0;
      v77 = *v98;
      do
      {
        for (i = 0; i != v18; ++i)
        {
          if (*v98 != v77)
          {
            objc_enumerationMutation(obj);
          }

          v21 = *(*(&v97 + 1) + 8 * i);
          configurationVersion = [v21 configurationVersion];
          homeConfig = [v78 homeConfig];
          uuid = [v21 uuid];
          v25 = [homeConfig objectForKeyedSubscript:uuid];

          watchSkipVersionCheck = [v21 watchSkipVersionCheck];
          if (v25)
          {
            v27 = watchSkipVersionCheck;
          }

          else
          {
            v27 = 1;
          }

          if ((v27 & 1) != 0 || [v25 integerValue] != configurationVersion)
          {
            v33 = objc_autoreleasePoolPush();
            v34 = val;
            v35 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
            {
              v36 = HMFGetLogIdentifier();
              name = [v21 name];
              *v106 = 138543874;
              v107 = v36;
              v108 = 2112;
              v109 = name;
              v110 = 2112;
              v111 = watchCopy;
              _os_log_impl(&dword_229538000, v35, OS_LOG_TYPE_INFO, "%{public}@Sending over the data for home %@ to watch %@", v106, 0x20u);
            }

            objc_autoreleasePoolPop(v33);
            v38 = [(HMDHomeManager *)v34 _prepareDataForDevicesOnSameAccountForHome:v21 remoteGateway:0 isAtLeastV4:v74 migrateToHH2:h2Copy];
            v92[0] = MEMORY[0x277D85DD0];
            v92[1] = 3221225472;
            v92[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke;
            v92[3] = &unk_278686050;
            objc_copyWeak(v96, &location);
            v93 = watchCopy;
            v94 = v21;
            v96[1] = configurationVersion;
            v95 = v34;
            [(HMDHomeManager *)v34 _pushChangesToWatch:v93 payload:v38 group:group completionHandler:v92];

            objc_destroyWeak(v96);
            v19 = 1;
          }

          else
          {
            v28 = objc_autoreleasePoolPush();
            v29 = val;
            v30 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
            {
              v31 = HMFGetLogIdentifier();
              name2 = [v21 name];
              *v106 = 138544130;
              v107 = v31;
              v108 = 2112;
              v109 = name2;
              v110 = 2112;
              v111 = v25;
              v112 = 2048;
              v113 = configurationVersion;
              _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Not sending home data for %@ as the config versions match (W: %@, C: %ld)", v106, 0x2Au);
            }

            objc_autoreleasePoolPop(v28);
          }
        }

        v18 = [obj countByEnumeratingWithState:&v97 objects:v114 count:16];
      }

      while (v18);

      if (v19)
      {
        v39 = 1;
LABEL_39:
        workQueue = [(HMDHomeManager *)val workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1083;
        block[3] = &unk_2786860A0;
        block[4] = val;
        v82 = watchCopy;
        v85 = buf;
        v84 = handlerCopy;
        v86 = v39;
        v83 = v72;
        dispatch_group_notify(group, workQueue, block);

        objc_destroyWeak(&location);
        _Block_object_dispose(buf, 8);

        objc_autoreleasePoolPop(context);
        goto LABEL_40;
      }
    }

    else
    {
    }

    primaryHomeUUID = [(HMDHomeManager *)val primaryHomeUUID];
    if (!primaryHomeUUID)
    {
      goto LABEL_30;
    }

    primaryHome = [v78 primaryHome];
    primaryHomeUUID2 = [(HMDHomeManager *)val primaryHomeUUID];
    v43 = HMFEqualObjects();

    if ((v43 & 1) == 0)
    {
      v49 = objc_autoreleasePoolPush();
      v50 = val;
      v51 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
      {
        v52 = HMFGetLogIdentifier();
        primaryHome2 = [v78 primaryHome];
        uUIDString = [primaryHome2 UUIDString];
        primaryHomeUUID3 = [(HMDHomeManager *)v50 primaryHomeUUID];
        uUIDString2 = [primaryHomeUUID3 UUIDString];
        *v106 = 138543874;
        v107 = v52;
        v108 = 2112;
        v109 = uUIDString;
        v110 = 2112;
        v111 = uUIDString2;
        _os_log_impl(&dword_229538000, v51, OS_LOG_TYPE_INFO, "%{public}@Primary home has been updated from %@ to %@, sending primary home update", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v49);
      primaryHomeUUID4 = [(HMDHomeManager *)v50 primaryHomeUUID];
      v104 = @"kPrimaryHomeUUIDKey";
      uUIDString3 = [primaryHomeUUID4 UUIDString];
      v105 = uUIDString3;
      v59 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v105 forKeys:&v104 count:1];

      v102 = @"kHomeDataKey";
      v60 = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v59, v74, 0);
      v103 = v60;
      v61 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v103 forKeys:&v102 count:1];

      v62 = objc_autoreleasePoolPush();
      v63 = v50;
      v64 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v64, OS_LOG_TYPE_INFO))
      {
        v65 = HMFGetLogIdentifier();
        uUIDString4 = [primaryHomeUUID4 UUIDString];
        *v106 = 138543874;
        v107 = v65;
        v108 = 2112;
        v109 = uUIDString4;
        v110 = 2112;
        v111 = watchCopy;
        _os_log_impl(&dword_229538000, v64, OS_LOG_TYPE_INFO, "%{public}@Sending over the data for primary home update to %@ to watch %@", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v62);
      v87[0] = MEMORY[0x277D85DD0];
      v87[1] = 3221225472;
      v87[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1082;
      v87[3] = &unk_278686078;
      objc_copyWeak(&v91, &location);
      v88 = watchCopy;
      v67 = primaryHomeUUID4;
      v89 = v67;
      v90 = v63;
      [(HMDHomeManager *)v63 _pushChangesToWatch:v88 payload:v61 group:group completionHandler:v87];

      objc_destroyWeak(&v91);
    }

    else
    {
LABEL_30:
      v44 = objc_autoreleasePoolPush();
      v45 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_INFO))
      {
        v46 = HMFGetLogIdentifier();
        primaryHome3 = [v78 primaryHome];
        primaryHomeUUID5 = [(HMDHomeManager *)val primaryHomeUUID];
        *v106 = 138543874;
        v107 = v46;
        v108 = 2112;
        v109 = primaryHome3;
        v110 = 2112;
        v111 = primaryHomeUUID5;
        _os_log_impl(&dword_229538000, v45, OS_LOG_TYPE_INFO, "%{public}@Not sending primary home update as they match: (W: %@, C: %@)", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v44);
    }

    v39 = 0;
    goto LABEL_39;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = val;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v13;
    *&buf[12] = 2112;
    *&buf[14] = v72;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Paired watch %@ supports cloud data sync - skipping sending home data", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  if (handlerCopy)
  {
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
    (*(handlerCopy + 2))(handlerCopy, 0, v14);
  }

LABEL_40:

  v69 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke(uint64_t a1, int a2)
{
  v29 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    if (a2)
    {
      v6 = [WeakRetained associatedWatchPeers];
      v7 = [v6 objectForKeyedSubscript:*(a1 + 32)];

      v8 = [MEMORY[0x277CCABB0] numberWithInteger:*(a1 + 64)];
      v9 = [*(a1 + 40) uuid];
      [v7 setConfigVersion:v8 forHome:v9];

      v10 = objc_autoreleasePoolPush();
      v11 = *(a1 + 48);
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v14 = *(a1 + 32);
        v15 = [*(a1 + 40) name];
        v23 = 138543874;
        v24 = v13;
        v25 = 2112;
        v26 = v14;
        v27 = 2112;
        v28 = v15;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Received ACK from watch %@ for data corresponding to home %@", &v23, 0x20u);
      }

      objc_autoreleasePoolPop(v10);
    }

    else
    {
      v16 = objc_autoreleasePoolPush();
      v17 = *(a1 + 48);
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = HMFGetLogIdentifier();
        v20 = [*(a1 + 40) name];
        v21 = *(a1 + 32);
        v23 = 138543874;
        v24 = v19;
        v25 = 2112;
        v26 = v20;
        v27 = 2112;
        v28 = v21;
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_ERROR, "%{public}@Failed to send data for home %@ to watch %@", &v23, 0x20u);
      }

      objc_autoreleasePoolPop(v16);
    }
  }

  v22 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1082(uint64_t a1, int a2)
{
  v27 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    if (a2)
    {
      v6 = [WeakRetained associatedWatchPeers];
      v7 = [v6 objectForKeyedSubscript:*(a1 + 32)];

      [v7 setPrimaryHome:*(a1 + 40)];
      v8 = objc_autoreleasePoolPush();
      v9 = *(a1 + 48);
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        v12 = *(a1 + 32);
        v13 = *(a1 + 40);
        v21 = 138543874;
        v22 = v11;
        v23 = 2112;
        v24 = v12;
        v25 = 2112;
        v26 = v13;
        _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Received ACK from watch %@ for primary home update to %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v8);
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 48);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        v19 = *(a1 + 32);
        v18 = *(a1 + 40);
        v21 = 138543874;
        v22 = v17;
        v23 = 2112;
        v24 = v18;
        v25 = 2112;
        v26 = v19;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to primary home update %@ to watch %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
    }
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1083(uint64_t a1)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_2;
  aBlock[3] = &unk_278686E40;
  v2 = *(a1 + 40);
  aBlock[4] = *(a1 + 32);
  v8 = v2;
  v6 = *(a1 + 56);
  v3 = v6;
  v9 = v6;
  v4 = _Block_copy(aBlock);
  v5 = v4;
  if (*(a1 + 72))
  {
    [*(a1 + 32) syncWalletKeyPassSerialNumbersToWatch:*(a1 + 48) withCompletion:v4];
  }

  else
  {
    (*(v4 + 2))(v4);
  }
}

uint64_t __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_2(uint64_t a1)
{
  v15 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v11 = 138543618;
    v12 = v5;
    v13 = 2112;
    v14 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Finished pushing home data changes to watch: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *(*(a1 + 56) + 8);
  v8 = *(v7 + 40);
  *(v7 + 40) = 0;

  result = *(a1 + 48);
  if (result)
  {
    result = (*(result + 16))(result, 1, 0);
  }

  v10 = *MEMORY[0x277D85DE8];
  return result;
}

uint64_t __74__HMDHomeManager__sendHomeDataToAllWatchesMigrateToHH2_completionHandler___block_invoke_2(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

- (void)sendHomeDataToAllWatchesWithCompletion:(id)completion
{
  completionCopy = completion;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __57__HMDHomeManager_sendHomeDataToAllWatchesWithCompletion___block_invoke;
  v7[3] = &unk_27868A7A0;
  v7[4] = self;
  v8 = completionCopy;
  v6 = completionCopy;
  dispatch_async(workQueue, v7);
}

uint64_t __57__HMDHomeManager_sendHomeDataToAllWatchesWithCompletion___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Syncing home data to all watches", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 32) watchPushDelayTimer];
  [v6 suspend];

  result = [*(a1 + 32) _sendHomeDataToAllWatchesWithCompletion:*(a1 + 40)];
  v8 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_scheduleSendHomeDataToAllWatches
{
  v10 = *MEMORY[0x277D85DE8];
  if (isiOSDevice())
  {
    watchPushDelayTimer = [(HMDHomeManager *)self watchPushDelayTimer];
    [watchPushDelayTimer resume];

    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v8 = 138543362;
      v9 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Kicking watch push delay", &v8, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v7 = *MEMORY[0x277D85DE8];
}

- (void)_handleAreYouAtHome:(id)home
{
  v3 = MEMORY[0x277CCA9B8];
  homeCopy = home;
  v5 = [v3 hmErrorWithCode:52 description:@"This device does not support legacy remote sessions" reason:0 suggestion:0];
  [homeCopy respondWithError:v5];
}

- (void)cloudHomeSettingsUpdated:(id)updated
{
  uuid = [(HMDHomeManager *)self uuid];
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"iCloud Switch Toggle" sourceUUID:uuid shouldNotifyClients:1];
}

- (void)_handleUpdateiCloudSwitchState:(id)state
{
  stateCopy = state;
  objc_initWeak(&location, self);
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __49__HMDHomeManager__handleUpdateiCloudSwitchState___block_invoke;
  aBlock[3] = &unk_278687540;
  objc_copyWeak(&v13, &location);
  v5 = stateCopy;
  v12 = v5;
  v6 = _Block_copy(aBlock);
  v10 = 0;
  v7 = [v5 BOOLForKey:@"kiCloudSwitchStateKey" keyPresent:&v10];
  if (v10 == 1 && (v8 = v7, [(HMDHomeManager *)self accountActive]))
  {
    v9 = +[HMDAppleAccountSettings sharedSettings];
    [v9 updateHomeEnabled:v8 completionHandler:v6];
  }

  else
  {
    v9 = +[HMDAppleAccountSettings sharedSettings];
    [v9 updateHomeEnabled:0 completionHandler:v6];
  }

  objc_destroyWeak(&v13);
  objc_destroyWeak(&location);
}

void __49__HMDHomeManager__handleUpdateiCloudSwitchState___block_invoke(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (v3)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      v12 = 138543618;
      v13 = v8;
      v14 = 2112;
      v15 = v3;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to update iCloud state with error: %@", &v12, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = [*(a1 + 32) responseHandler];

  if (v9)
  {
    v10 = [*(a1 + 32) responseHandler];
    (v10)[2](v10, v3, 0);
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_handleQueryiCloudSwitchState:(id)state
{
  v11[1] = *MEMORY[0x277D85DE8];
  stateCopy = state;
  v4 = +[HMDAppleAccountSettings sharedSettings];
  isHomeEnabled = [v4 isHomeEnabled];

  responseHandler = [stateCopy responseHandler];

  v10 = @"kiCloudSwitchStateKey";
  v7 = [MEMORY[0x277CCABB0] numberWithBool:isHomeEnabled];
  v11[0] = v7;
  v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v11 forKeys:&v10 count:1];
  (responseHandler)[2](responseHandler, 0, v8);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_auditDuplicatePreviouslyAddedAccessory:(id)accessory
{
  accessoryCopy = accessory;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = accessoryCopy;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;
  v7 = accessoryCopy;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v8 = v7;
  }

  else
  {
    v8 = 0;
  }

  v9 = v8;

  if (v6 | v9)
  {
    v10 = dispatch_time(0, 60000000000);
    workQueue = [(HMDHomeManager *)self workQueue];
    v12[0] = MEMORY[0x277D85DD0];
    v12[1] = 3221225472;
    v12[2] = __58__HMDHomeManager__auditDuplicatePreviouslyAddedAccessory___block_invoke;
    v12[3] = &unk_2786891E0;
    v12[4] = self;
    v13 = v7;
    v14 = v6;
    v15 = v9;
    dispatch_after(v10, workQueue, v12);
  }
}

void __58__HMDHomeManager__auditDuplicatePreviouslyAddedAccessory___block_invoke(uint64_t a1)
{
  v80 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v57 = a1;
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v71 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Auditing accessories", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = a1;
  v7 = [*(a1 + 40) home];

  if (v7)
  {
    v68 = 0u;
    v69 = 0u;
    v66 = 0u;
    v67 = 0u;
    obj = [*(a1 + 32) homes];
    v8 = [obj countByEnumeratingWithState:&v66 objects:v79 count:16];
    if (!v8)
    {
      goto LABEL_43;
    }

    v10 = v8;
    v11 = *v67;
    *&v9 = 138544130;
    v54 = v9;
    v55 = *v67;
    while (1)
    {
      v12 = 0;
      v56 = v10;
      do
      {
        if (*v67 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v66 + 1) + 8 * v12);
        if (![v13 isOwnerUser])
        {
          goto LABEL_41;
        }

        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v14 = [v13 accessories];
        v15 = [v14 countByEnumeratingWithState:&v62 objects:v78 count:16];
        if (!v15)
        {
LABEL_40:

          goto LABEL_41;
        }

        v16 = v15;
        v17 = *v63;
        v59 = v12;
        v60 = *v63;
LABEL_12:
        v18 = 0;
        v61 = v16;
        while (1)
        {
          if (*v63 != v17)
          {
            objc_enumerationMutation(v14);
          }

          v19 = *(*(&v62 + 1) + 8 * v18);
          v20 = *(v6 + 48);
          if (!v20)
          {
            goto LABEL_20;
          }

          v21 = [v20 serialNumber];
          if (!v21)
          {
            goto LABEL_20;
          }

          v22 = v21;
          v23 = v14;
          [*(v6 + 48) uuid];
          v25 = v24 = v6;
          v26 = [v19 uuid];
          if (![v25 hmf_isEqualToUUID:v26])
          {
            break;
          }

          v14 = v23;
          v6 = v24;
          v17 = v60;
          v16 = v61;
LABEL_20:
          v30 = *(v6 + 56);
          if (v30)
          {
            v31 = v19 == v30;
          }

          else
          {
            v31 = 1;
          }

          if (!v31)
          {
            v32 = v19;
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v33 = v32;
            }

            else
            {
              v33 = 0;
            }

            v34 = v33;

            if (v34)
            {
              v35 = [*(v6 + 56) identifier];
              v36 = [v34 identifier];
              v37 = [v35 isEqual:v36];

              if (v37)
              {
                v38 = objc_autoreleasePoolPush();
                v39 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
                {
                  v40 = HMFGetLogIdentifier();
                  v41 = *(v57 + 56);
                  v42 = [v41 identifier];
                  *buf = v54;
                  v71 = v40;
                  v72 = 2112;
                  v73 = v34;
                  v74 = 2112;
                  v75 = v41;
                  v76 = 2112;
                  v77 = v42;
                  _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@Found an existing media accessory (%@) match the newly added hap accessory (%@) with device identifier %@, trying to remove it.", buf, 0x2Au);
                }

                objc_autoreleasePoolPop(v38);
                v11 = v55;
                v10 = v56;
                v12 = v59;
                v6 = v57;
LABEL_39:
                [v32 sendRemovalRequest];
                v14 = v32;
                goto LABEL_40;
              }
            }
          }

          if (v16 == ++v18)
          {
            v16 = [v14 countByEnumeratingWithState:&v62 objects:v78 count:16];
            if (v16)
            {
              goto LABEL_12;
            }

            v11 = v55;
            v10 = v56;
            v12 = v59;
            goto LABEL_40;
          }
        }

        v27 = [*(v24 + 48) serialNumber];
        v28 = [v19 serialNumber];
        v29 = [v27 isEqual:v28];

        v14 = v23;
        v6 = v24;
        v17 = v60;
        v16 = v61;
        if (!v29)
        {
          goto LABEL_20;
        }

        v43 = objc_autoreleasePoolPush();
        v44 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
        {
          v45 = HMFGetLogIdentifier();
          v46 = *(v57 + 48);
          v47 = [v46 serialNumber];
          *buf = v54;
          v71 = v45;
          v72 = 2112;
          v73 = v19;
          v74 = 2112;
          v75 = v46;
          v76 = 2112;
          v77 = v47;
          _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_INFO, "%{public}@Found an existing accessory (%@) match the newly added accessory (%@) with serialNumber %@, trying to remove it.", buf, 0x2Au);
        }

        objc_autoreleasePoolPop(v43);
        v32 = v19;

        v11 = v55;
        v10 = v56;
        v12 = v59;
        v6 = v57;
        if (v32)
        {
          goto LABEL_39;
        }

LABEL_41:
        ++v12;
      }

      while (v12 != v10);
      v10 = [obj countByEnumeratingWithState:&v66 objects:v79 count:16];
      if (!v10)
      {
LABEL_43:

        goto LABEL_47;
      }
    }
  }

  v48 = objc_autoreleasePoolPush();
  v49 = *(a1 + 32);
  v50 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
  {
    v51 = HMFGetLogIdentifier();
    v52 = *(a1 + 40);
    *buf = 138543618;
    v71 = v51;
    v72 = 2112;
    v73 = v52;
    _os_log_impl(&dword_229538000, v50, OS_LOG_TYPE_ERROR, "%{public}@Skipping audit as accessory (%@) or home has been removed", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v48);
LABEL_47:
  v53 = *MEMORY[0x277D85DE8];
}

- (void)auditDuplicatePreviouslyAddedAccessory:(id)accessory
{
  userInfo = [accessory userInfo];
  v5 = [userInfo objectForKeyedSubscript:@"HMDAccessoryNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  [(HMDHomeManager *)self _auditDuplicatePreviouslyAddedAccessory:v7];
}

- (void)_handleRetrieveVendorIdentifier:(id)identifier
{
  v26 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  responseHandler = [identifierCopy responseHandler];

  if (responseHandler)
  {
    v5 = [identifierCopy stringForKey:@"kCompanionApplicationIdentifierKey"];
    if (!v5)
    {
      goto LABEL_8;
    }

    v6 = +[HMDApplicationVendorIDStore sharedStore];
    v7 = [v6 vendorIDForApplicationBundleID:v5];

    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543874;
      v21 = v10;
      v22 = 2112;
      v23 = v7;
      v24 = 2112;
      v25 = v5;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Retrieved vendor ID %@ for application bundle ID: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    if (v7 && (v18 = @"kCompanionApplicationVendorIdentifierKey", v19 = v7, [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v19 forKeys:&v18 count:1], v11 = objc_claimAutoreleasedReturnValue(), v7, v11))
    {
      v12 = 0;
    }

    else
    {
LABEL_8:
      v12 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
      v11 = 0;
    }

    responseHandler2 = [identifierCopy responseHandler];
    (responseHandler2)[2](responseHandler2, v12, v11);
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v21 = v16;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@No response handler set for the retrieve vendor identifier message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (BOOL)_removeAndAddKeyPair:(id)pair userName:(id)name eraseReason:(unint64_t)reason
{
  v42 = *MEMORY[0x277D85DE8];
  pairCopy = pair;
  nameCopy = name;
  [(HMDHomeManager *)self _eraseLocalHomeConfigurationWithReason:reason];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v11 = [systemStore removeControllerKeyPairWithError:0];
  v12 = objc_autoreleasePoolPush();
  v13 = HMFGetOSLogHandle();
  v14 = v13;
  if (v11)
  {
    if (!os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v41 = v15;
    v16 = "%{public}@Removed controller key from store";
    v17 = v14;
    v18 = OS_LOG_TYPE_INFO;
  }

  else
  {
    if (!os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v41 = v15;
    v16 = "%{public}@Failed removing controller key from store";
    v17 = v14;
    v18 = OS_LOG_TYPE_ERROR;
  }

  _os_log_impl(&dword_229538000, v17, v18, v16, buf, 0xCu);

LABEL_7:
  objc_autoreleasePoolPop(v12);
  v39 = 0;
  v19 = [systemStore saveKeyPair:pairCopy username:nameCopy syncable:0 error:&v39];
  v20 = v39;
  v21 = v20;
  if (v19)
  {
    v37 = v20;
    v38 = 0;
    LODWORD(v22) = [systemStore deserializeKeyPair:pairCopy publicKey:&v38 secretKey:0 error:&v37];
    v23 = v38;
    v24 = v37;

    if (v22)
    {
      appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
      account = [appleAccountManager account];

      if (account)
      {
        v27 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v23];
        v28 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:nameCopy publicKey:v27 privateKey:0 permissions:0];
        v29 = +[HMDIdentityRegistry sharedRegistry];
        [v29 registerIdentity:v28 account:account object:account];
      }
    }

    else
    {
      v32 = objc_autoreleasePoolPush();
      v33 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
      {
        v34 = HMFGetLogIdentifier();
        *buf = 138543362;
        v41 = v34;
        _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_INFO, "%{public}@Deserialize of key pair failed", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
    }

    v21 = v24;
  }

  else
  {
    v30 = objc_autoreleasePoolPush();
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543362;
      v41 = v31;
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Failed to save key pair", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v30);
    LOBYTE(v22) = 0;
  }

  v35 = *MEMORY[0x277D85DE8];
  return v22;
}

- (void)__handleAppleAccountUpdated:(id)updated previousAccount:(id)account
{
  updatedCopy = updated;
  accountCopy = account;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __62__HMDHomeManager___handleAppleAccountUpdated_previousAccount___block_invoke;
  block[3] = &unk_27868A010;
  v12 = accountCopy;
  v13 = updatedCopy;
  selfCopy = self;
  v9 = updatedCopy;
  v10 = accountCopy;
  dispatch_async(workQueue, block);
}

void __62__HMDHomeManager___handleAppleAccountUpdated_previousAccount___block_invoke(uint64_t a1)
{
  v26 = *MEMORY[0x277D85DE8];
  v2 = [MEMORY[0x277CFEC78] systemStore];
  v3 = [v2 getLocalPairingIdentity:0];

  if (*(a1 + 32))
  {
    v4 = v3 == 0;
  }

  else
  {
    v4 = 1;
  }

  if (!v4)
  {
    v5 = +[HMDIdentityRegistry sharedRegistry];
    [v5 deregisterIdentity:v3 object:*(a1 + 32)];
  }

  if (*(a1 + 40) && v3)
  {
    v6 = +[HMDIdentityRegistry sharedRegistry];
    [v6 registerIdentity:v3 account:*(a1 + 40) object:*(a1 + 40)];
  }

  [*(a1 + 48) _notifyClientsOfUpdatedStatus];
  [*(a1 + 48) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
  if (*(a1 + 40))
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 48);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v24 = 138543362;
      v25 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign in", &v24, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    isWatch();
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 48);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v24 = 138543362;
      v25 = v14;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Clearing CloudKit account status", &v24, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    [*(a1 + 48) setCloudkitAccountStatusDetermined:0];
    [*(a1 + 48) setBackOffOperationInProgress:0];
    v15 = [*(a1 + 48) multiUserStatusController];
    [v15 didChangeHasActiveAccountState:0];

    v16 = [*(a1 + 48) notificationCenter];
    [v16 postNotificationName:@"HMDHomeManagerKeyTransferResetTimerNotification" object:*(a1 + 48) userInfo:0];
  }

  else if (*(a1 + 32))
  {
    v17 = objc_autoreleasePoolPush();
    v18 = *(a1 + 48);
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = HMFGetLogIdentifier();
      v24 = 138543362;
      v25 = v20;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign out", &v24, 0xCu);
    }

    objc_autoreleasePoolPop(v17);
    v21 = [*(a1 + 48) multiUserStatusController];
    [v21 didChangeHasActiveAccountState:0];

    [*(a1 + 48) _eraseLocalHomeConfigurationAfterSignOut];
    [*(a1 + 48) setBackOffOperationInProgress:0];
    [*(a1 + 48) setCloudkitAccountStatusDetermined:0];
    v22 = [HMDPersistentStore archiveCloudServerTokenData:0];
    [*(a1 + 48) updatePowerAssertion];
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)__handleAppleAccountUpdated:(id)updated
{
  updatedCopy = updated;
  userInfo = [updatedCopy userInfo];
  v6 = [userInfo objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v12 = v7;

  userInfo2 = [updatedCopy userInfo];

  v9 = [userInfo2 objectForKeyedSubscript:@"HMDPreviousAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v10 = v9;
  }

  else
  {
    v10 = 0;
  }

  v11 = v10;

  [(HMDHomeManager *)self __handleAppleAccountUpdated:v12 previousAccount:v11];
}

- (void)__checkForBootTimeLogout
{
  v23 = *MEMORY[0x277D85DE8];
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  didProcessAccountSignOut = [appleAccountManager didProcessAccountSignOut];

  if (didProcessAccountSignOut)
  {
    appleAccountManager2 = [(HMDHomeManager *)self appleAccountManager];
    lastSignedOutAccount = [appleAccountManager2 lastSignedOutAccount];

    defaultStore = [MEMORY[0x277CB8F48] defaultStore];
    aa_primaryAppleAccount = [defaultStore aa_primaryAppleAccount];

    if (aa_primaryAppleAccount)
    {
      v9 = objc_autoreleasePoolPush();
      selfCopy = self;
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        v12 = HMFGetLogIdentifier();
        v21 = 138543362;
        v22 = v12;
        _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Relaunching due to account sign out and sign in that occurred during boot", &v21, 0xCu);
      }

      objc_autoreleasePoolPop(v9);
      v13 = +[HMDMainDriver driver];
      [v13 relaunch];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v16 = HMFGetOSLogHandle();
      v17 = os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT);
      if (lastSignedOutAccount)
      {
        if (v17)
        {
          v18 = HMFGetLogIdentifier();
          v21 = 138543362;
          v22 = v18;
          _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign out that occurred during boot", &v21, 0xCu);
        }

        objc_autoreleasePoolPop(v14);
        [(HMDHomeManager *)selfCopy2 __handleAppleAccountUpdated:0 previousAccount:lastSignedOutAccount];
      }

      else
      {
        if (v17)
        {
          v19 = HMFGetLogIdentifier();
          v21 = 138543362;
          v22 = v19;
          _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign out that occurred before boot", &v21, 0xCu);
        }

        objc_autoreleasePoolPop(v14);
        [(HMDHomeManager *)selfCopy2 _eraseLocalHomeConfigurationAfterSignOut];
      }
    }
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (BOOL)setLocalPairingIdentity:(id)identity error:(id *)error
{
  v25 = *MEMORY[0x277D85DE8];
  identityCopy = identity;
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v8 = [systemStore getLocalPairingIdentity:0];
  if ([v8 isEqual:identityCopy])
  {
    v9 = objc_autoreleasePoolPush();
    selfCopy = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v23 = 138543362;
      v24 = v12;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Skipping updating pairing identity, it matches current identity", &v23, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
LABEL_9:
    v16 = 1;
    goto LABEL_13;
  }

  if ([systemStore saveLocalPairingIdentity:identityCopy syncable:0 error:error])
  {
    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    account = [appleAccountManager account];

    if (account)
    {
      v15 = +[HMDIdentityRegistry sharedRegistry];
      [v15 registerIdentity:identityCopy account:account object:account];
    }

    goto LABEL_9;
  }

  v17 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v19 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    v20 = HMFGetLogIdentifier();
    v23 = 138543362;
    v24 = v20;
    _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to save local pairing identity", &v23, 0xCu);
  }

  objc_autoreleasePoolPop(v17);
  v16 = 0;
LABEL_13:

  v21 = *MEMORY[0x277D85DE8];
  return v16;
}

- (void)_handleCompanionKeysSync:(id)sync
{
  v36 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  v5 = [syncCopy dataForKey:@"kControllerKeyPairKey"];
  v6 = [syncCopy stringForKey:@"kControllerPairingNameKey"];
  v7 = [syncCopy dataForKey:@"kControllerUniqueDeviceIdSaltKey"];
  v8 = [syncCopy dataForKey:@"kControllerAssistantTeamIdentifierKey"];
  responseHandler = [syncCopy responseHandler];

  if (responseHandler)
  {
    if (v5 && v7 && v8)
    {
      v31 = v6;
      if ([(HMDHomeManager *)self _removeAndAddKeyPair:v5 userName:v6 eraseReason:1])
      {
        v10 = +[HMDHAPMetadata getSharedInstance];
        v32[0] = @"kHomedVersionKey";
        v11 = homedVersion;
        v33[0] = v11;
        v32[1] = @"kMetadataInfoVersionKey";
        version = [v10 version];
        v33[1] = version;
        v32[2] = @"kMetadataInfoSchemaVersionKey";
        schemaVersion = [v10 schemaVersion];
        v33[2] = schemaVersion;
        v14 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v33 forKeys:v32 count:3];

        [(HMDHomeManager *)self _setUniqueDeviceIdSalt:v7];
        [(HMDHomeManager *)self _saveAssistantHashingData:v8];
      }

      else
      {
        v23 = objc_autoreleasePoolPush();
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v35 = v25;
          _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Failed to save the key pair to keychain", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v23);
        v14 = 0;
      }

      v26 = objc_autoreleasePoolPush();
      v27 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
      {
        v28 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v28;
        _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Answering Companion Sync request", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v26);
      responseHandler2 = [syncCopy responseHandler];
      (responseHandler2)[2](responseHandler2, 0, v14);

      v6 = v31;
    }

    else
    {
      v18 = objc_autoreleasePoolPush();
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v20;
        _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_ERROR, "%{public}@Key pair/salts are missing the companion key sync message", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      responseHandler3 = [syncCopy responseHandler];
      v22 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (responseHandler3)[2](responseHandler3, v22, 0);
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v17;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@No response handler", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
  }

  v30 = *MEMORY[0x277D85DE8];
}

- (void)_handleHomesConfigSync:(id)sync
{
  v45 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  v5 = +[HMDHAPMetadata getSharedInstance];
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  v7 = homedVersion;
  [dictionary setObject:v7 forKeyedSubscript:@"kHomedVersionKey"];

  version = [v5 version];
  [dictionary setObject:version forKeyedSubscript:@"kMetadataInfoVersionKey"];

  schemaVersion = [v5 schemaVersion];
  [dictionary setObject:schemaVersion forKeyedSubscript:@"kMetadataInfoSchemaVersionKey"];

  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];

  if (primaryHomeUUID)
  {
    primaryHomeUUID2 = [(HMDHomeManager *)self primaryHomeUUID];
    uUIDString = [primaryHomeUUID2 UUIDString];
    [dictionary setObject:uUIDString forKeyedSubscript:@"kPrimaryHomeUUIDKey"];
  }

  messagePayload = [syncCopy messagePayload];
  v14 = [messagePayload hmf_UUIDForKey:@"kCurrentHomeUUIDKey"];

  if (v14)
  {
    [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v14 isLocalUpdate:0];
  }

  _prepareHomesVersionDict = [(HMDHomeManager *)self _prepareHomesVersionDict];
  if (_prepareHomesVersionDict)
  {
    [dictionary setObject:_prepareHomesVersionDict forKeyedSubscript:@"kHomeConfigHomesKey"];
  }

  remoteSourceDevice = [syncCopy remoteSourceDevice];
  version2 = [remoteSourceDevice version];
  v18 = +[HMDHomeKitVersion version4_1];
  v19 = [version2 isAtLeastVersion:v18];

  if (!v19)
  {
    v25 = objc_autoreleasePoolPush();
    selfCopy = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543362;
      v42 = v28;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Responding with legacy pairing identity", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v25);
    systemStore = [MEMORY[0x277CFEC78] systemStore];
    v38 = 0;
    v39 = 0;
    v37 = 0;
    [systemStore getControllerPublicKey:0 secretKey:0 keyPair:&v39 username:&v38 allowCreation:0 error:&v37];
    v22 = v39;
    publicPairingIdentity = v38;
    v21 = v37;

    if (v22)
    {
      [dictionary setObject:v22 forKeyedSubscript:@"kControllerKeyPairKey"];
    }

    if (publicPairingIdentity)
    {
      [dictionary setObject:publicPairingIdentity forKeyedSubscript:@"kControllerPairingNameKey"];
    }

    goto LABEL_16;
  }

  systemStore2 = [MEMORY[0x277CFEC78] systemStore];
  v40 = 0;
  v21 = [systemStore2 getLocalPairingIdentity:&v40];
  v22 = v40;

  if (v21)
  {
    publicPairingIdentity = [v21 publicPairingIdentity];
    v24 = encodeRootObject();
    [dictionary setObject:v24 forKeyedSubscript:@"pairingIdentity"];

LABEL_16:
    goto LABEL_17;
  }

  v33 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v35 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
  {
    v36 = HMFGetLogIdentifier();
    *buf = 138543618;
    v42 = v36;
    v43 = 2112;
    v44 = v22;
    _os_log_impl(&dword_229538000, v35, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to get local pairing identity with error: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v33);
  v21 = 0;
LABEL_17:

  v30 = +[HMDHomeManager getUniqueDeviceIdSalt];
  if (v30)
  {
    [dictionary setObject:v30 forKeyedSubscript:@"kControllerUniqueDeviceIdSaltKey"];
  }

  responseHandler = [syncCopy responseHandler];
  (responseHandler)[2](responseHandler, 0, dictionary);

  v32 = *MEMORY[0x277D85DE8];
}

- (id)_prepareHomesVersionDict
{
  v21 = *MEMORY[0x277D85DE8];
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v5 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v17;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v17 != v7)
        {
          objc_enumerationMutation(homes);
        }

        v9 = *(*(&v16 + 1) + 8 * i);
        v10 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v9, "configurationVersion")}];
        uuid = [v9 uuid];
        uUIDString = [uuid UUIDString];
        [dictionary setObject:v10 forKeyedSubscript:uUIDString];
      }

      v6 = [homes countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v6);
  }

  if ([dictionary count])
  {
    v13 = [dictionary copy];
  }

  else
  {
    v13 = 0;
  }

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)processTransactionsFromHomeDataSync:(id)sync accessories:(id)accessories version:(int64_t)version completion:(id)completion
{
  v67[1] = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  accessoriesCopy = accessories;
  completionCopy = completion;
  v67[0] = syncCopy;
  v11 = [MEMORY[0x277CBEA60] arrayWithObjects:v67 count:1];
  [(HMDHomeManager *)self _associateAccessories:accessoriesCopy withHomes:v11];

  [syncCopy fixupHomeAfterDecoding];
  uuid = [syncCopy uuid];
  v13 = [(HMDHomeManager *)self _homeWithUUID:uuid];

  sharedHomeSourceVersion = [syncCopy sharedHomeSourceVersion];
  v14 = objc_autoreleasePoolPush();
  v15 = [(HMDHomeManager *)self _loadCloudTransactionForRemoteHome:syncCopy localHome:v13 cachedHome:0 version:version];
  objc_autoreleasePoolPop(v14);
  if ([v15 count])
  {
    v16 = [(HMDHomeManager *)self _findHomeModel:v15];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v17 = v16;
    }

    else
    {
      v17 = 0;
    }

    v41 = v17;

    if (!v13 && v41)
    {
      v18 = [v15 mutableCopy];
      [v18 removeObject:v41];
      v19 = [v18 copy];

      v15 = v19;
    }

    objc_initWeak(&location, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke;
    aBlock[3] = &unk_278685FB0;
    objc_copyWeak(&v63, &location);
    v20 = syncCopy;
    v60 = v20;
    v21 = completionCopy;
    v62 = v21;
    v22 = sharedHomeSourceVersion;
    v61 = v22;
    v23 = _Block_copy(aBlock);
    v52[0] = MEMORY[0x277D85DD0];
    v52[1] = 3221225472;
    v52[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1064;
    v52[3] = &unk_278685FD8;
    objc_copyWeak(&v58, &location);
    v24 = v21;
    v56 = v24;
    v25 = v22;
    v53 = v25;
    v54 = v20;
    v15 = v15;
    v55 = v15;
    v26 = v23;
    v57 = v26;
    v27 = _Block_copy(v52);
    v28 = v27;
    if (v13)
    {
      (*(v27 + 2))(v27, 0);
    }

    else
    {
      if (v41)
      {
        backingStore = [(HMDHomeManager *)self backingStore];
        v34 = +[HMDBackingStoreTransactionOptions defaultIDSOptions];
        v35 = [backingStore transaction:@"kTransactionUpdate" options:v34];

        [v35 add:v41 withMessage:0];
        v45[0] = MEMORY[0x277D85DD0];
        v45[1] = 3221225472;
        v45[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1065;
        v45[3] = &unk_278686000;
        objc_copyWeak(&v51, &location);
        v48 = v24;
        v46 = v25;
        v47 = v15;
        v49 = v26;
        v50 = v28;
        [v35 run:v45];

        objc_destroyWeak(&v51);
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        selfCopy = self;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
        {
          v39 = HMFGetLogIdentifier();
          *buf = 138543362;
          v66 = v39;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_ERROR, "%{public}@Must have home model to create home because it does not already exist", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v36);
        if (!v24)
        {
          goto LABEL_21;
        }

        v35 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
        (v24[2])(v24, 0, 0, v35);
      }
    }

LABEL_21:

    objc_destroyWeak(&v58);
    objc_destroyWeak(&v63);
    objc_destroyWeak(&location);

    goto LABEL_22;
  }

  v29 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v31 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
  {
    v32 = HMFGetLogIdentifier();
    *buf = 138543362;
    v66 = v32;
    _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@No changes to home", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v29);
  if (completionCopy)
  {
    completionCopy[2]();
  }

LABEL_22:

  v40 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke(uint64_t a1, void *a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v5 = [*(a1 + 32) uuid];
    v6 = [WeakRetained _homeWithUUID:v5];

    v7 = [WeakRetained incomingInvitations];
    v8 = [v6 uuid];
    v9 = [v7 hmf_firstObjectWithValue:v8 forKeyPath:@"homeUUID"];

    if (v9)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = WeakRetained;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v18 = [v6 uuid];
        [v18 UUIDString];
        v14 = v19 = v10;
        v15 = [v9 describeWithFormat];
        *buf = 138543874;
        v21 = v13;
        v22 = 2112;
        v23 = v14;
        v24 = 2112;
        v25 = v15;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Found home with UUID %@ in invite %@, removing it since it was accepted", buf, 0x20u);

        v10 = v19;
      }

      objc_autoreleasePoolPop(v10);
      [v11 _postIncomingInvitationStateChangedNotification:v9 newInvitationState:3];
      [v11 _removeIncomingInvitation:v9];
    }
  }

  v16 = *(a1 + 48);
  if (v16)
  {
    (*(v16 + 16))(v16, 1, *(a1 + 40), 0);
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1064(uint64_t a1, void *a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  v5 = WeakRetained;
  if (v3)
  {
    v6 = *(a1 + 56);
    if (v6)
    {
      (*(v6 + 16))(v6, 0, *(a1 + 32), v3);
    }
  }

  else if (WeakRetained)
  {
    v7 = [*(a1 + 40) uuid];
    v8 = [v5 _homeWithUUID:v7];

    v9 = [v8 sharedHomeUpdateHandler];
    [v9 pause];

    v20 = v8;
    v10 = [v8 backingStore];
    v11 = +[HMDBackingStoreTransactionOptions defaultIDSOptions];
    v12 = [v10 transaction:@"kTransactionUpdate" options:v11];

    v23 = 0u;
    v24 = 0u;
    v21 = 0u;
    v22 = 0u;
    v13 = *(a1 + 48);
    v14 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v22;
      do
      {
        v17 = 0;
        do
        {
          if (*v22 != v16)
          {
            objc_enumerationMutation(v13);
          }

          v18 = *(*(&v21 + 1) + 8 * v17);
          objc_opt_class();
          if ((objc_opt_isKindOfClass() & 1) == 0)
          {
            [v12 add:v18 withMessage:0];
          }

          ++v17;
        }

        while (v15 != v17);
        v15 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
      }

      while (v15);
    }

    [v12 run:*(a1 + 64)];
  }

  v19 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1065(uint64_t a1, void *a2)
{
  v6 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (v6)
  {
    v4 = *(a1 + 48);
    if (v4)
    {
      (*(v4 + 16))(v4, 0, *(a1 + 32), v6);
    }
  }

  else if (WeakRetained)
  {
    if ([*(a1 + 40) count])
    {
      v5 = *(a1 + 64);
    }

    else
    {
      v5 = *(a1 + 56);
    }

    (*(v5 + 16))(v5, 0);
  }
}

- (void)_processSharedHomeModel:(id)model message:(id)message
{
  v46[7] = *MEMORY[0x277D85DE8];
  modelCopy = model;
  messageCopy = message;
  v40[0] = 0;
  v40[1] = v40;
  v40[2] = 0x3032000000;
  v40[3] = __Block_byref_object_copy__254244;
  v40[4] = __Block_byref_object_dispose__254245;
  v41 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.handle-home-sync"];
  v6 = MEMORY[0x277CBEB98];
  v46[0] = objc_opt_class();
  v46[1] = objc_opt_class();
  v46[2] = objc_opt_class();
  v46[3] = objc_opt_class();
  v46[4] = objc_opt_class();
  v46[5] = objc_opt_class();
  v46[6] = objc_opt_class();
  v7 = [MEMORY[0x277CBEA60] arrayWithObjects:v46 count:7];
  v31 = [v6 setWithArray:v7];

  v8 = objc_alloc(MEMORY[0x277CCAAC8]);
  homeData = [modelCopy homeData];
  v39 = 0;
  v10 = [v8 initForReadingFromData:homeData error:&v39];
  v11 = v39;

  [v10 _allowDecodingCyclesInSecureMode];
  v12 = *MEMORY[0x277CCA308];
  v38 = v11;
  v13 = [v10 decodeTopLevelObjectOfClasses:v31 forKey:v12 error:&v38];
  v29 = v38;

  if (!v13)
  {
    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543618;
      v43 = v17;
      v44 = 2112;
      v45 = v29;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive home from shared home model's home data: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = v13;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v19 = v18;
  }

  else
  {
    v19 = 0;
  }

  v20 = v19;

  v21 = [v20 objectForKeyedSubscript:@"kHomeDataBlobKey"];
  v22 = [v20 objectForKeyedSubscript:@"kAccessoriesDataBlobKey"];
  v23 = [v20 hmf_numberForKey:@"kHomeDataVersionKey"];
  v24 = v23;
  if (v23)
  {
    integerValue = [v23 integerValue];
    if (!v21)
    {
      goto LABEL_13;
    }

    goto LABEL_12;
  }

  integerValue = 0;
  if (v21)
  {
LABEL_12:
    [(HMDHomeManager *)self setHomeDataLoadedFromArchive:1, v29];
    zoneID = [v21 zoneID];
    ownerName = [v21 ownerName];
    [(HMDHomeManager *)self _addCloudZone:zoneID ownerName:ownerName];

    objc_initWeak(buf, self);
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __50__HMDHomeManager__processSharedHomeModel_message___block_invoke;
    v33[3] = &unk_278685F88;
    objc_copyWeak(&v37, buf);
    v34 = v21;
    v35 = messageCopy;
    v36 = v40;
    [(HMDHomeManager *)self processTransactionsFromHomeDataSync:v34 accessories:v22 version:integerValue completion:v33];

    objc_destroyWeak(&v37);
    objc_destroyWeak(buf);
  }

LABEL_13:

  _Block_object_dispose(v40, 8);
  v28 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__processSharedHomeModel_message___block_invoke(uint64_t a1, uint64_t a2, void *a3, void *a4)
{
  v38[1] = *MEMORY[0x277D85DE8];
  v7 = a3;
  v8 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v10 = WeakRetained;
  if (!v8 && WeakRetained)
  {
    v11 = [*(a1 + 32) uuid];
    v12 = [v10 _homeWithUUID:v11];

    if (v12)
    {
      v13 = v7;
      v14 = [*(a1 + 40) name];
      v15 = [v14 isEqualToString:@"kTransactionUpdate"];

      if ((v15 & 1) == 0)
      {
        v16 = [*(a1 + 40) destination];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v17 = v16;
        }

        else
        {
          v17 = 0;
        }

        v18 = v17;

        v19 = [v18 device];

        v20 = [v19 version];

        v13 = v20;
      }

      v21 = [v12 sharedHomeUpdateHandler];
      v32[0] = MEMORY[0x277D85DD0];
      v32[1] = 3221225472;
      v32[2] = __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_2;
      v32[3] = &unk_278685F60;
      objc_copyWeak(&v35, (a1 + 56));
      v33 = *(a1 + 40);
      v36 = a2;
      v22 = v12;
      v34 = v22;
      [v21 receivedHomeDataFromSourceVersion:v13 forceUpdateVersion:a2 completion:v32];

      v23 = [v22 presenceFeeder];
      [v23 homeDataProcessed];

      objc_destroyWeak(&v35);
    }

    goto LABEL_14;
  }

  if (!v8)
  {
LABEL_14:
    v26 = [*(a1 + 40) responseHandler];

    if (v26)
    {
      v37 = @"kDataSyncResponseAckKey";
      v38[0] = MEMORY[0x277CBEC38];
      v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v38 forKeys:&v37 count:1];
      v28 = [*(a1 + 40) responseHandler];
      (v28)[2](v28, 0, v27);
    }

    goto LABEL_16;
  }

  v24 = [*(a1 + 40) responseHandler];

  if (v24)
  {
    v25 = [*(a1 + 40) responseHandler];
    (v25)[2](v25, v8, 0);
  }

LABEL_16:
  v29 = *(*(a1 + 48) + 8);
  v30 = *(v29 + 40);
  *(v29 + 40) = 0;

  v31 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_2(uint64_t a1, int a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v11 = WeakRetained;
    v5 = [*(a1 + 32) name];
    if (([v5 isEqualToString:@"kTransactionUpdate"] & 1) == 0)
    {
      v6 = *(a1 + 56);

      if ((v6 & 1) == 0 && !a2)
      {
        goto LABEL_7;
      }

      v5 = [*(a1 + 40) sharedHomeModel];
      v7 = [v11 backingStore];
      v8 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v9 = [v7 transaction:@"kTransactionIDSUpdate" options:v8];

      [v9 add:v5 withMessage:0];
      [v9 save:&__block_literal_global_1058];
    }

LABEL_7:
    v10 = [*(a1 + 40) sharedHomeUpdateHandler];
    [v10 resume];

    WeakRetained = v11;
  }
}

- (void)processSharedHomeModelUpdate:(id)update message:(id)message
{
  updateCopy = update;
  messageCopy = message;
  objc_initWeak(&location, self);
  workQueue = [(HMDHomeManager *)self workQueue];
  v11[0] = MEMORY[0x277D85DD0];
  v11[1] = 3221225472;
  v11[2] = __55__HMDHomeManager_processSharedHomeModelUpdate_message___block_invoke;
  v11[3] = &unk_278685F38;
  objc_copyWeak(&v14, &location);
  v12 = updateCopy;
  v13 = messageCopy;
  v9 = messageCopy;
  v10 = updateCopy;
  dispatch_async(workQueue, v11);

  objc_destroyWeak(&v14);
  objc_destroyWeak(&location);
}

void __55__HMDHomeManager_processSharedHomeModelUpdate_message___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  [WeakRetained _processSharedHomeModel:*(a1 + 32) message:*(a1 + 40)];
}

- (id)_loadCloudTransactionForRemoteHome:(id)home localHome:(id)localHome cachedHome:(id)cachedHome version:(int64_t)version
{
  v210 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  localHomeCopy = localHome;
  cachedHomeCopy = cachedHome;
  v145 = localHomeCopy;
  v141 = [localHomeCopy backingStoreObjects:version];
  v143 = homeCopy;
  v12 = [homeCopy backingStoreObjects:version];
  v158 = [v12 mutableCopy];

  v142 = cachedHomeCopy;
  versionCopy = version;
  v149 = [cachedHomeCopy backingStoreObjects:version];
  v13 = objc_autoreleasePoolPush();
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543618;
    v202 = v15;
    v203 = 2048;
    versionCopy2 = version;
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Received data with home-data-version %tu", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v13);
  v193 = 0u;
  v194 = 0u;
  v191 = 0u;
  v192 = 0u;
  obj = [v158 copy];
  v16 = [obj countByEnumeratingWithState:&v191 objects:v209 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v192;
    v150 = *v192;
    do
    {
      v19 = 0;
      v151 = v17;
      do
      {
        if (*v192 != v18)
        {
          objc_enumerationMutation(obj);
        }

        v20 = *(*(&v191 + 1) + 8 * v19);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v21 = v20;
        }

        else
        {
          v21 = 0;
        }

        v22 = v21;

        if (v22)
        {
          if (![v22 propertyWasSet:@"uniqueIdentifier"] || (objc_msgSend(v22, "uniqueIdentifier"), v23 = objc_claimAutoreleasedReturnValue(), v23, !v23))
          {
            v156 = v22;
            v41 = v19;
            v42 = objc_autoreleasePoolPush();
            v43 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
            {
              v44 = HMFGetLogIdentifier();
              v45 = objc_opt_class();
              v46 = NSStringFromClass(v45);
              bsoType = [v20 bsoType];
              uuid = [v20 uuid];
              uUIDString = [uuid UUIDString];
              *buf = 138544130;
              v202 = v44;
              v203 = 2112;
              versionCopy2 = v46;
              v205 = 2112;
              v206 = bsoType;
              v207 = 2112;
              v208 = uUIDString;
              _os_log_impl(&dword_229538000, v43, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object (uuid: %@) from remote that has a null / unset uniqueIdentifier (no way to recover).", buf, 0x2Au);

              v17 = v151;
              v18 = v150;
            }

            objc_autoreleasePoolPop(v42);
            [v158 removeObject:v20];
            v19 = v41;
            goto LABEL_62;
          }
        }

        uuid2 = [v20 uuid];

        if (!uuid2)
        {
          v156 = v22;
          v50 = v20;
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            v51 = v50;
          }

          else
          {
            v51 = 0;
          }

          v52 = v51;

          if (v52)
          {
            v185 = 0u;
            v186 = 0u;
            v183 = 0u;
            v184 = 0u;
            users = [v145 users];
            v54 = [users countByEnumeratingWithState:&v183 objects:v199 count:16];
            v55 = v50;
            if (v54)
            {
              v56 = v54;
              v163 = v50;
              v147 = v19;
              v57 = *v184;
              while (2)
              {
                for (i = 0; i != v56; ++i)
                {
                  if (*v184 != v57)
                  {
                    objc_enumerationMutation(users);
                  }

                  v59 = *(*(&v183 + 1) + 8 * i);
                  pairingUsername = [v59 pairingUsername];
                  pairingIdentity = [(HMDUserModel *)v52 pairingIdentity];
                  v62 = [pairingIdentity objectForKey:@"HAP.identifier"];
                  v63 = [pairingUsername isEqual:v62];

                  if (v63)
                  {
                    v64 = [HMDUserModel alloc];
                    bsoDataVersion = [(HMDBackingStoreModelObject *)v52 bsoDataVersion];
                    objectChangeType = [(HMDBackingStoreModelObject *)v52 objectChangeType];
                    uuid3 = [v59 uuid];
                    parentUUID = [(HMDBackingStoreModelObject *)v52 parentUUID];
                    v55 = [(HMDBackingStoreModelObject *)v64 initWithVersion:bsoDataVersion changeType:objectChangeType uuid:uuid3 parentUUID:parentUUID];

                    v69 = [(HMDBackingStoreModelObject *)v55 merge:v52];
                    goto LABEL_48;
                  }
                }

                v56 = [users countByEnumeratingWithState:&v183 objects:v199 count:16];
                if (v56)
                {
                  continue;
                }

                break;
              }

              v55 = v52;
LABEL_48:
              v18 = v150;
              v19 = v147;
              v50 = v163;
            }

            uuid4 = [(HMDBackingStoreModelObject *)v55 uuid];

            v17 = v151;
            if (uuid4)
            {
              goto LABEL_61;
            }

            v71 = objc_autoreleasePoolPush();
            v72 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
            {
              v88 = HMFGetLogIdentifier();
              v89 = objc_opt_class();
              v90 = NSStringFromClass(v89);
              bsoType2 = [(HMDBackingStoreModelObject *)v50 bsoType];
              *buf = 138543874;
              v202 = v88;
              v203 = 2112;
              versionCopy2 = v90;
              v205 = 2112;
              v206 = bsoType2;
              _os_log_impl(&dword_229538000, v72, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object from remote that has a null UUID (tried to match via pairing ID and failed).", buf, 0x20u);

              v18 = v150;
            }
          }

          else
          {
            v71 = objc_autoreleasePoolPush();
            v72 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
            {
              v73 = HMFGetLogIdentifier();
              v74 = objc_opt_class();
              v75 = NSStringFromClass(v74);
              bsoType3 = [(HMDBackingStoreModelObject *)v50 bsoType];
              *buf = 138543874;
              v202 = v73;
              v203 = 2112;
              versionCopy2 = v75;
              v205 = 2112;
              v206 = bsoType3;
              _os_log_impl(&dword_229538000, v72, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object from remote that has a null UUID (and no way to recover).", buf, 0x20u);
            }

            v55 = 0;
          }

          objc_autoreleasePoolPop(v71);
          [v158 removeObject:v50];
LABEL_61:

LABEL_62:
          v22 = v156;
          goto LABEL_63;
        }

        if (versionCopy <= 3)
        {
          v25 = v20;
          objc_opt_class();
          v26 = (objc_opt_isKindOfClass() & 1) != 0 ? v25 : 0;
          v27 = v26;

          if (v27)
          {
            v189 = 0u;
            v190 = 0u;
            v187 = 0u;
            v188 = 0u;
            users2 = [v145 users];
            v28 = [users2 countByEnumeratingWithState:&v187 objects:v200 count:16];
            if (v28)
            {
              v29 = v28;
              v144 = v25;
              v155 = v22;
              v146 = v19;
              v30 = *v188;
              while (2)
              {
                for (j = 0; j != v29; ++j)
                {
                  if (*v188 != v30)
                  {
                    objc_enumerationMutation(users2);
                  }

                  v32 = *(*(&v187 + 1) + 8 * j);
                  uuid5 = [v32 uuid];
                  uuid6 = [(HMDBackingStoreModelObject *)v27 uuid];
                  if ([uuid5 isEqual:uuid6])
                  {
                  }

                  else
                  {
                    pairingUsername2 = [v32 pairingUsername];
                    [(HMDUserModel *)v27 pairingIdentity];
                    v160 = v32;
                    v37 = v36 = v29;
                    [v37 objectForKey:@"HAP.identifier"];
                    v39 = v38 = v27;
                    v40 = [pairingUsername2 isEqual:v39];

                    v27 = v38;
                    v29 = v36;

                    if (v40)
                    {
                      v77 = objc_autoreleasePoolPush();
                      v78 = HMFGetOSLogHandle();
                      if (os_log_type_enabled(v78, OS_LOG_TYPE_INFO))
                      {
                        v79 = HMFGetLogIdentifier();
                        *buf = 138543874;
                        v202 = v79;
                        v203 = 2112;
                        versionCopy2 = v160;
                        v205 = 2112;
                        v206 = v38;
                        _os_log_impl(&dword_229538000, v78, OS_LOG_TYPE_INFO, "%{public}@Found an existing user %@, MERGING properties from %@", buf, 0x20u);
                      }

                      objc_autoreleasePoolPop(v77);
                      v80 = [HMDUserModel alloc];
                      bsoDataVersion2 = [(HMDBackingStoreModelObject *)v38 bsoDataVersion];
                      objectChangeType2 = [(HMDBackingStoreModelObject *)v38 objectChangeType];
                      uuid7 = [v160 uuid];
                      parentUUID2 = [(HMDBackingStoreModelObject *)v38 parentUUID];
                      v85 = [(HMDBackingStoreModelObject *)v80 initWithVersion:bsoDataVersion2 changeType:objectChangeType2 uuid:uuid7 parentUUID:parentUUID2];

                      v86 = [(HMDBackingStoreModelObject *)v85 merge:v38];
                      v87 = v85;

                      [v158 removeObject:v144];
                      [v158 addObject:v87];

                      v25 = v87;
                      goto LABEL_57;
                    }
                  }
                }

                v29 = [users2 countByEnumeratingWithState:&v187 objects:v200 count:16];
                if (v29)
                {
                  continue;
                }

                break;
              }

              v25 = v27;
LABEL_57:
              v18 = v150;
              v17 = v151;
              v19 = v146;
              v22 = v155;
            }

            else
            {
              v17 = v151;
            }
          }
        }

LABEL_63:

        v19 = v19 + 1;
      }

      while (v19 != v17);
      v92 = [obj countByEnumeratingWithState:&v191 objects:v209 count:16];
      v17 = v92;
    }

    while (v92);
  }

  v164 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v158, "count") + objc_msgSend(v141, "count")}];
  v179 = 0u;
  v180 = 0u;
  v181 = 0u;
  v182 = 0u;
  v152 = v141;
  v161 = [v152 countByEnumeratingWithState:&v179 objects:v198 count:16];
  if (v161)
  {
    v157 = *v180;
    do
    {
      for (k = 0; k != v161; ++k)
      {
        if (*v180 != v157)
        {
          objc_enumerationMutation(v152);
        }

        v94 = *(*(&v179 + 1) + 8 * k);
        v175 = 0u;
        v176 = 0u;
        v177 = 0u;
        v178 = 0u;
        v95 = v158;
        v96 = [v95 countByEnumeratingWithState:&v175 objects:v197 count:16];
        if (v96)
        {
          v97 = v96;
          v98 = *v176;
LABEL_75:
          v99 = 0;
          while (1)
          {
            if (*v176 != v98)
            {
              objc_enumerationMutation(v95);
            }

            v100 = *(*(&v175 + 1) + 8 * v99);
            uuid8 = [v94 uuid];
            uuid9 = [v100 uuid];
            v103 = [uuid8 isEqual:uuid9];

            if (v103)
            {
              break;
            }

            if (v97 == ++v99)
            {
              v97 = [v95 countByEnumeratingWithState:&v175 objects:v197 count:16];
              if (v97)
              {
                goto LABEL_75;
              }

              goto LABEL_81;
            }
          }

          v104 = v100;

          if (!v104)
          {
            goto LABEL_92;
          }

          [v95 removeObject:v104];
          obja = v104;
          [v104 setObjectChangeType:2];
          v173 = 0u;
          v174 = 0u;
          v171 = 0u;
          v172 = 0u;
          v105 = v149;
          v106 = [v105 countByEnumeratingWithState:&v171 objects:v196 count:16];
          if (v106)
          {
            v107 = v106;
            v108 = *v172;
LABEL_85:
            v109 = 0;
            while (1)
            {
              if (*v172 != v108)
              {
                objc_enumerationMutation(v105);
              }

              v110 = *(*(&v171 + 1) + 8 * v109);
              uuid10 = [v94 uuid];
              uuid11 = [v110 uuid];
              v113 = [uuid10 isEqual:uuid11];

              if (v113)
              {
                break;
              }

              if (v107 == ++v109)
              {
                v107 = [v105 countByEnumeratingWithState:&v171 objects:v196 count:16];
                if (v107)
                {
                  goto LABEL_85;
                }

                goto LABEL_91;
              }
            }

            v118 = v110;

            if (!v118)
            {
              goto LABEL_101;
            }

            v170 = 0;
            v119 = obja;
            [(HMDBackingStoreModelObject *)v118 diff:obja differingFields:&v170];
            v120 = v170;
            if ([(HMDUserModel *)v120 count])
            {
              v121 = objc_autoreleasePoolPush();
              selfCopy = self;
              v123 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v123, OS_LOG_TYPE_INFO))
              {
                v124 = HMFGetLogIdentifier();
                *buf = 138543874;
                v202 = v124;
                v203 = 2112;
                versionCopy2 = obja;
                v205 = 2112;
                v206 = v120;
                _os_log_impl(&dword_229538000, v123, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Object was changed since last push or fetch: object %@ has diff %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v121);
              [v164 addObject:obja];
              [(HMDBackingStoreModelObject *)v118 dumpDebug:@"CACHED: "];
              [obja dumpDebug:@"REMOTE: "];
            }
          }

          else
          {
LABEL_91:

LABEL_101:
            v169 = 0;
            v119 = obja;
            [v94 diff:obja differingFields:&v169];
            v118 = v169;
            if ([(HMDUserModel *)v118 count])
            {
              v125 = objc_autoreleasePoolPush();
              selfCopy2 = self;
              v127 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v127, OS_LOG_TYPE_INFO))
              {
                v128 = HMFGetLogIdentifier();
                *buf = 138543874;
                v202 = v128;
                v203 = 2112;
                versionCopy2 = obja;
                v205 = 2112;
                v206 = v118;
                _os_log_impl(&dword_229538000, v127, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: object %@ has diff %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v125);
              [v164 addObject:obja];
              [v94 dumpDebug:@"LOCAL: "];
              [obja dumpDebug:@"REMOTE: "];
            }
          }
        }

        else
        {
LABEL_81:

LABEL_92:
          v114 = objc_autoreleasePoolPush();
          selfCopy3 = self;
          v116 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v116, OS_LOG_TYPE_INFO))
          {
            v117 = HMFGetLogIdentifier();
            *buf = 138543618;
            v202 = v117;
            v203 = 2112;
            versionCopy2 = v94;
            _os_log_impl(&dword_229538000, v116, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: local object %@ deleted", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v114);
          [v94 setObjectChangeType:3];
          [v164 addObject:v94];
          [v94 dumpDebug:@"LOCAL:"];
        }
      }

      v161 = [v152 countByEnumeratingWithState:&v179 objects:v198 count:16];
    }

    while (v161);
  }

  v167 = 0u;
  v168 = 0u;
  v165 = 0u;
  v166 = 0u;
  v129 = v158;
  v130 = [v129 countByEnumeratingWithState:&v165 objects:v195 count:16];
  if (v130)
  {
    v131 = v130;
    v132 = *v166;
    do
    {
      for (m = 0; m != v131; ++m)
      {
        if (*v166 != v132)
        {
          objc_enumerationMutation(v129);
        }

        v134 = *(*(&v165 + 1) + 8 * m);
        v135 = objc_autoreleasePoolPush();
        selfCopy4 = self;
        v137 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v137, OS_LOG_TYPE_INFO))
        {
          v138 = HMFGetLogIdentifier();
          *buf = 138543618;
          v202 = v138;
          v203 = 2112;
          versionCopy2 = v134;
          _os_log_impl(&dword_229538000, v137, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: remote object %@ added", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v135);
        [v134 setObjectChangeType:1];
        [v164 addObject:v134];
        [v134 dumpDebug:@"REMOTE: "];
      }

      v131 = [v129 countByEnumeratingWithState:&v165 objects:v195 count:16];
    }

    while (v131);
  }

  v139 = *MEMORY[0x277D85DE8];

  return v164;
}

- (BOOL)_shouldDecodeMessage:(id)message error:(id *)error
{
  v51 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  remoteUserPairingIdentity = [messageCopy remoteUserPairingIdentity];
  remoteSenderContext = [messageCopy remoteSenderContext];
  mergeID = [remoteSenderContext mergeID];

  v43 = 0u;
  v44 = 0u;
  v41 = 0u;
  v42 = 0u;
  selfCopy = self;
  homes = [(HMDHomeManager *)self homes];
  v10 = [homes countByEnumeratingWithState:&v41 objects:v50 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v42;
LABEL_3:
    v13 = 0;
    while (1)
    {
      if (*v42 != v12)
      {
        objc_enumerationMutation(homes);
      }

      v14 = *(*(&v41 + 1) + 8 * v13);
      v15 = [messageCopy matchingRemoteIdentityUserForHome:v14];

      if (v15)
      {
        break;
      }

      if (v11 == ++v13)
      {
        v11 = [homes countByEnumeratingWithState:&v41 objects:v50 count:16];
        if (v11)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v27 = objc_autoreleasePoolPush();
    v28 = selfCopy;
    v29 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v29, OS_LOG_TYPE_DEBUG))
    {
      goto LABEL_25;
    }

    v30 = HMFGetLogIdentifier();
    name = [v14 name];
    *buf = 138543618;
    v47 = v30;
    v48 = 2112;
    v49 = name;
    _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_DEBUG, "%{public}@Received home sync from owner of known home %@", buf, 0x16u);
  }

  else
  {
LABEL_9:
    errorCopy = error;

    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    incomingInvitations = [(HMDHomeManager *)selfCopy incomingInvitations];
    homes = [incomingInvitations copy];

    v17 = [homes countByEnumeratingWithState:&v37 objects:v45 count:16];
    if (!v17)
    {
LABEL_18:

      if (errorCopy)
      {
        [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        *errorCopy = v26 = 0;
      }

      else
      {
        v26 = 0;
      }

      goto LABEL_26;
    }

    v18 = v17;
    v19 = *v38;
LABEL_11:
    v20 = 0;
    while (1)
    {
      if (*v38 != v19)
      {
        objc_enumerationMutation(homes);
      }

      v21 = *(*(&v37 + 1) + 8 * v20);
      inviterIdentity = [v21 inviterIdentity];
      v23 = [inviterIdentity isEqual:remoteUserPairingIdentity];

      inviterMergeID = [v21 inviterMergeID];
      v25 = [inviterMergeID isEqual:mergeID];

      if ([v21 isAccepted])
      {
        if ((v23 | v25))
        {
          break;
        }
      }

      if (v18 == ++v20)
      {
        v18 = [homes countByEnumeratingWithState:&v37 objects:v45 count:16];
        if (v18)
        {
          goto LABEL_11;
        }

        goto LABEL_18;
      }
    }

    v27 = objc_autoreleasePoolPush();
    v28 = selfCopy;
    v29 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v29, OS_LOG_TYPE_DEBUG))
    {
      goto LABEL_25;
    }

    v30 = HMFGetLogIdentifier();
    *buf = 138543618;
    v47 = v30;
    v48 = 2112;
    v49 = v21;
    _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_DEBUG, "%{public}@Received home sync from accepted invitation %@", buf, 0x16u);
  }

LABEL_25:
  objc_autoreleasePoolPop(v27);

  v26 = 1;
LABEL_26:

  v32 = *MEMORY[0x277D85DE8];
  return v26;
}

- (void)_handleHomeDataSync:(id)sync
{
  v217 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  v5 = objc_autoreleasePoolPush();
  v179 = 0;
  v6 = [(HMDHomeManager *)self _shouldDecodeMessage:syncCopy error:&v179];
  v7 = v179;
  if (v6)
  {
    v8 = [syncCopy dataForKey:@"kHomeDataKey"];
    if (!v8)
    {
      v59 = objc_autoreleasePoolPush();
      v60 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
      {
        v61 = HMFGetLogIdentifier();
        *buf = 138543362;
        v204 = v61;
        _os_log_impl(&dword_229538000, v60, OS_LOG_TYPE_ERROR, "%{public}@Failed to receive home data", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v59);
      responseHandler = [syncCopy responseHandler];

      if (!responseHandler)
      {
        goto LABEL_100;
      }

      v63 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      responseHandler2 = [syncCopy responseHandler];
      responseHandler2[2](responseHandler2, v63, 0);
LABEL_99:

LABEL_100:
      goto LABEL_101;
    }

    v168 = v5;
    v166 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.handle-home-sync"];
    responseHandler2 = [v8 hmd_uncompressedData];
    if (!responseHandler2)
    {
      responseHandler2 = v8;
    }

    v10 = MEMORY[0x277CBEB98];
    v192[0] = objc_opt_class();
    v192[1] = objc_opt_class();
    v192[2] = objc_opt_class();
    v192[3] = objc_opt_class();
    v192[4] = objc_opt_class();
    v192[5] = objc_opt_class();
    v192[6] = objc_opt_class();
    v11 = [MEMORY[0x277CBEA60] arrayWithObjects:v192 count:7];
    v12 = [v10 setWithArray:v11];

    v178 = 0;
    v13 = [objc_alloc(MEMORY[0x277CCAAC8]) initForReadingFromData:responseHandler2 error:&v178];
    v169 = v178;
    [v13 _allowDecodingCyclesInSecureMode];
    v164 = v13;
    v165 = v12;
    v14 = [v13 decodeObjectOfClasses:v12 forKey:*MEMORY[0x277CCA308]];
    if (!v14)
    {
      v15 = objc_autoreleasePoolPush();
      selfCopy = self;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v19 = v18 = responseHandler2;
        *buf = 138543618;
        v204 = v19;
        v205 = 2112;
        v206 = v169;
        _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive home from uncompressed data: %@", buf, 0x16u);

        responseHandler2 = v18;
      }

      objc_autoreleasePoolPop(v15);
    }

    v167 = v8;
    v20 = v14;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v21 = v20;
    }

    else
    {
      v21 = 0;
    }

    v22 = v21;

    v23 = [v22 objectForKeyedSubscript:@"kHomeDataBlobKey"];
    [v23 _removeCorruptAccessories];
    v190 = @"kDataSyncResponseAckKey";
    v191 = MEMORY[0x277CBEC38];
    v170 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v191 forKeys:&v190 count:1];
    if (!v23)
    {
      goto LABEL_87;
    }

    v161 = v20;
    v162 = v22;
    v163 = responseHandler2;
    v158 = v7;
    selfCopy2 = self;
    v160 = v23;
    v25 = v23;
    v159 = syncCopy;
    v171 = syncCopy;
    v175 = selfCopy2;
    v177 = v25;
    v184 = 0u;
    v185 = 0u;
    v186 = 0u;
    v187 = 0u;
    obj = [(HMDHomeManager *)v175 homes];
    v26 = [obj countByEnumeratingWithState:&v184 objects:buf count:16];
    if (v26)
    {
      v27 = v26;
      v28 = *v185;
      while (2)
      {
        for (i = 0; i != v27; ++i)
        {
          if (*v185 != v28)
          {
            objc_enumerationMutation(obj);
          }

          v30 = *(*(&v184 + 1) + 8 * i);
          v31 = objc_autoreleasePoolPush();
          v32 = v175;
          v33 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v33, OS_LOG_TYPE_DEBUG))
          {
            v34 = HMFGetLogIdentifier();
            uuid = [v177 uuid];
            *v197 = 138543874;
            v198 = v34;
            v199 = 2112;
            v200 = uuid;
            v201 = 2112;
            v202 = v30;
            _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_DEBUG, "%{public}@Looking for home uuid %@, currentHome:  %@", v197, 0x20u);
          }

          objc_autoreleasePoolPop(v31);
          uuid2 = [v30 uuid];
          if (uuid2)
          {
            v37 = uuid2;
            uuid3 = [v30 uuid];
            uuid4 = [v177 uuid];
            v40 = [uuid3 hmf_isEqualToUUID:uuid4];

            if (v40)
            {
              owner = [v30 owner];
              pairingIdentity = [owner pairingIdentity];
              v65 = pairingIdentity;

              owner2 = [v30 owner];
              account = [owner2 account];
              senderCorrelationIdentifier = [account senderCorrelationIdentifier];
              v68 = senderCorrelationIdentifier;

              v69 = objc_autoreleasePoolPush();
              v70 = v32;
              v71 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v71, OS_LOG_TYPE_DEBUG))
              {
                v72 = HMFGetLogIdentifier();
                *v197 = 138543618;
                v198 = v72;
                v199 = 2112;
                v200 = senderCorrelationIdentifier;
                _os_log_impl(&dword_229538000, v71, OS_LOG_TYPE_DEBUG, "%{public}@Found current home account mergeID %@", v197, 0x16u);
              }

              objc_autoreleasePoolPop(v69);
              owner3 = [v30 owner];
              account2 = [owner3 account];
              v74 = account2;

LABEL_44:
              v75 = 1;
              goto LABEL_53;
            }
          }
        }

        v27 = [obj countByEnumeratingWithState:&v184 objects:buf count:16];
        if (v27)
        {
          continue;
        }

        break;
      }
    }

    v182 = 0u;
    v183 = 0u;
    v180 = 0u;
    v181 = 0u;
    incomingInvitations = [(HMDHomeManager *)v175 incomingInvitations];
    v42 = [incomingInvitations copy];

    obj = v42;
    account2 = [v42 countByEnumeratingWithState:&v180 objects:v197 count:16];
    if (account2)
    {
      v44 = *v181;
LABEL_26:
      v45 = 0;
      while (1)
      {
        if (*v181 != v44)
        {
          objc_enumerationMutation(obj);
        }

        v46 = *(*(&v180 + 1) + 8 * v45);
        homeUUID = [v46 homeUUID];
        if (homeUUID)
        {
          v48 = homeUUID;
          homeUUID2 = [v46 homeUUID];
          uuid5 = [v177 uuid];
          v51 = [homeUUID2 hmf_isEqualToUUID:uuid5];

          if (v51)
          {
            break;
          }
        }

        if (account2 == ++v45)
        {
          account2 = [obj countByEnumeratingWithState:&v180 objects:v197 count:16];
          if (account2)
          {
            goto LABEL_26;
          }

          goto LABEL_33;
        }
      }

      isAccepted = [v46 isAccepted];
      v77 = objc_autoreleasePoolPush();
      v78 = v175;
      v79 = HMFGetOSLogHandle();
      v80 = os_log_type_enabled(v79, OS_LOG_TYPE_INFO);
      if (isAccepted)
      {
        if (v80)
        {
          v81 = HMFGetLogIdentifier();
          *v193 = 138543618;
          v194 = v81;
          v195 = 2112;
          v196 = v46;
          _os_log_impl(&dword_229538000, v79, OS_LOG_TYPE_INFO, "%{public}@Received home sync for invitation: %@", v193, 0x16u);
        }

        objc_autoreleasePoolPop(v77);
        pairingIdentity = [v46 inviterIdentity];
        v82 = pairingIdentity;
        account2 = [v46 inviterAccount];
        v83 = account2;
        senderCorrelationIdentifier = [v46 inviterMergeID];
        v84 = senderCorrelationIdentifier;
        goto LABEL_44;
      }

      if (v80)
      {
        v85 = HMFGetLogIdentifier();
        *v193 = 138543618;
        v194 = v85;
        v195 = 2112;
        v196 = v46;
        _os_log_impl(&dword_229538000, v79, OS_LOG_TYPE_INFO, "%{public}@Received home sync for unaccepted invitation: %@", v193, 0x16u);
      }

      objc_autoreleasePoolPop(v77);
      pairingIdentity = 0;
      senderCorrelationIdentifier = 0;
      account2 = 0;
    }

    else
    {
LABEL_33:
      pairingIdentity = 0;
      senderCorrelationIdentifier = 0;
    }

    v75 = 0;
LABEL_53:
    responseHandler2 = v163;

    v86 = pairingIdentity;
    v87 = senderCorrelationIdentifier;
    v88 = account2;
    v89 = objc_autoreleasePoolPush();
    v90 = v175;
    v91 = HMFGetOSLogHandle();
    v92 = v91;
    if ((v75 & 1) == 0)
    {
      if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
      {
        v114 = HMFGetLogIdentifier();
        *buf = 138543618;
        v204 = v114;
        v205 = 2112;
        v206 = v177;
        _os_log_impl(&dword_229538000, v92, OS_LOG_TYPE_ERROR, "%{public}@Unable to determine current owner of home: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v89);
      v111 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v115 = v111;
      v113 = 0;
      goto LABEL_68;
    }

    if (os_log_type_enabled(v91, OS_LOG_TYPE_DEBUG))
    {
      v93 = HMFGetLogIdentifier();
      *buf = 138544130;
      v204 = v93;
      v205 = 2112;
      v206 = v171;
      v207 = 2112;
      v208 = v86;
      v209 = 2112;
      v210 = v87;
      _os_log_impl(&dword_229538000, v92, OS_LOG_TYPE_DEBUG, "%{public}@Found owner identity, checking message: %@, against pairing identity: %@, mergeID: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v89);
    remoteSenderContext = [v171 remoteSenderContext];
    mergeID = [remoteSenderContext mergeID];
    v96 = [v87 isEqualToString:mergeID];

    identifier = [v86 identifier];
    remoteSenderContext2 = [v171 remoteSenderContext];
    pairingIdentityIdentifier = [remoteSenderContext2 pairingIdentityIdentifier];
    v100 = v96 | [identifier isEqualToString:pairingIdentityIdentifier];

    if ([v88 isAuthenticated])
    {
      remoteSourceDevice = [v171 remoteSourceDevice];
      account3 = [remoteSourceDevice account];
      v103 = [v88 isEqual:account3];

      if ((v103 & v100 & 1) == 0)
      {
LABEL_58:
        v104 = objc_autoreleasePoolPush();
        v105 = v90;
        v106 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v106, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v107 = obja = v86;
          [v88 isAuthenticated];
          v172 = HMFBooleanToString();
          [v171 remoteSourceDevice];
          v108 = v176 = v104;
          account4 = [v108 account];
          v110 = HMFBooleanToString();
          *buf = 138544898;
          v204 = v107;
          v205 = 2112;
          v206 = v177;
          v207 = 2112;
          v208 = v171;
          v209 = 2112;
          v210 = v88;
          v211 = 2112;
          v212 = v172;
          v213 = 2112;
          v214 = account4;
          v215 = 2112;
          v216 = v110;
          _os_log_impl(&dword_229538000, v106, OS_LOG_TYPE_ERROR, "%{public}@Received unexpected home data sync for home: %@, message: %@, ownerAccount: %@, ownerAccount.isAuthenticated: %@, sourceDevice.account: %@, isValidOwnerAccountIdentity: %@", buf, 0x48u);

          v104 = v176;
          v86 = obja;
        }

        objc_autoreleasePoolPop(v104);
        v111 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        v112 = v111;
        v113 = 0;
        responseHandler2 = v163;
LABEL_68:
        v22 = v162;

        responseHandler9 = v111;
        if ((v113 & 1) == 0)
        {
          uuidsOfRemovedHomes = [(HMDHomeManager *)v90 uuidsOfRemovedHomes];
          uuid6 = [v177 uuid];
          v129 = [uuidsOfRemovedHomes containsObject:uuid6];

          v7 = v158;
          syncCopy = v159;
          v5 = v168;
          if (v129)
          {
            v130 = objc_autoreleasePoolPush();
            v131 = v90;
            v132 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v132, OS_LOG_TYPE_INFO))
            {
              v133 = HMFGetLogIdentifier();
              *buf = 138543618;
              v204 = v133;
              v205 = 2112;
              v206 = v177;
              _os_log_impl(&dword_229538000, v132, OS_LOG_TYPE_INFO, "%{public}@Rejecting home data sync, home was removed: %@", buf, 0x16u);

              v22 = v162;
            }

            objc_autoreleasePoolPop(v130);
            responseHandler3 = [v171 responseHandler];

            v8 = v167;
            if (!responseHandler3)
            {
              goto LABEL_96;
            }

            responseHandler4 = [v171 responseHandler];
            v188 = @"kDataSyncResponseNAckKey";
            v189 = MEMORY[0x277CBEC38];
            v136 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v189 forKeys:&v188 count:1];
            (responseHandler4)[2](responseHandler4, 0, v136);
          }

          else
          {
            responseHandler5 = [v171 responseHandler];

            if (!responseHandler5)
            {
              v8 = v167;
LABEL_96:
              v23 = v160;
              v20 = v161;
              goto LABEL_97;
            }

            responseHandler4 = [v171 responseHandler];
            (responseHandler4)[2](responseHandler4, responseHandler9, 0);
            v8 = v167;
          }

          v23 = v160;
          v20 = v161;

LABEL_97:
          goto LABEL_98;
        }

        v7 = v158;
        syncCopy = v159;
        if ([v177 isOwnerUser])
        {
          v121 = objc_autoreleasePoolPush();
          v122 = v90;
          v123 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v123, OS_LOG_TYPE_INFO))
          {
            v124 = HMFGetLogIdentifier();
            *buf = 138543618;
            v204 = v124;
            v205 = 2112;
            v206 = v177;
            _os_log_impl(&dword_229538000, v123, OS_LOG_TYPE_INFO, "%{public}@Dropping remote home sync to owner: %@", buf, 0x16u);

            v22 = v162;
          }

          objc_autoreleasePoolPop(v121);
          responseHandler6 = [v171 responseHandler];

          v8 = v167;
          v5 = v168;
          if (responseHandler6)
          {
            responseHandler7 = [v171 responseHandler];
            (responseHandler7)[2](responseHandler7, 0, v170);
          }

          goto LABEL_96;
        }

        uuid7 = [v177 uuid];
        v138 = [(HMDHomeManager *)v90 _homeWithUUID:uuid7];

        destination = [v171 destination];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v140 = destination;
        }

        else
        {
          v140 = 0;
        }

        v141 = v140;

        device = [v141 device];

        version = [device version];

        LODWORD(device) = [(HMDHomeManager *)v90 _shouldHandleHomeDataSync:v138 remoteHome:v177 sourceDeviceVersion:version];
        v23 = v160;
        v20 = v161;
        if (device)
        {
          if (([v177 isOwnerUser] & 1) == 0)
          {
            v150 = [HMDSharedHomeModel alloc];
            uuid8 = [v177 uuid];
            uuid9 = [(HMDHomeManager *)v90 uuid];
            responseHandler9 = [(HMDBackingStoreModelObject *)v150 initWithObjectChangeType:1 uuid:uuid8 parentUUID:uuid9];

            [(HMDSharedHomeModel *)responseHandler9 setHomeData:responseHandler2];
            v153 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v177, "configurationVersion")}];
            [(HMDSharedHomeModel *)responseHandler9 setConfigurationVersion:v153];

            homes = [(HMDHomeManager *)v90 homes];
            v155 = [homes count];

            if (!v155)
            {
              uuid10 = [v177 uuid];
              [(HMDHomeManager *)v90 setPrimaryHomeUUID:uuid10];
            }

            [(HMDHomeManager *)v90 transactionObjectUpdated:0 newValues:responseHandler9 message:v171, v158];
            v8 = v167;
            v5 = v168;
            goto LABEL_96;
          }

          v144 = objc_autoreleasePoolPush();
          v145 = v90;
          v146 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v146, OS_LOG_TYPE_ERROR))
          {
            v147 = HMFGetLogIdentifier();
            *buf = 138543618;
            v204 = v147;
            v205 = 2112;
            v206 = v177;
            _os_log_impl(&dword_229538000, v146, OS_LOG_TYPE_ERROR, "%{public}@Received unexpected home data sync for owned home %@", buf, 0x16u);

            v22 = v162;
          }

          objc_autoreleasePoolPop(v144);
          v23 = v160;
          v20 = v161;
        }

LABEL_87:
        responseHandler8 = [syncCopy responseHandler];

        v8 = v167;
        v5 = v168;
        if (!responseHandler8)
        {
LABEL_98:

          v63 = v166;
          goto LABEL_99;
        }

        responseHandler9 = [syncCopy responseHandler];
        (*&responseHandler9->super._bsoDataVersionOverride)(responseHandler9, 0, v170);
        goto LABEL_97;
      }
    }

    else if ((v100 & 1) == 0)
    {
      goto LABEL_58;
    }

    v116 = objc_autoreleasePoolPush();
    v117 = v90;
    v118 = HMFGetOSLogHandle();
    responseHandler2 = v163;
    if (os_log_type_enabled(v118, OS_LOG_TYPE_DEBUG))
    {
      v119 = HMFGetLogIdentifier();
      *buf = 138543618;
      v204 = v119;
      v205 = 2112;
      v206 = v171;
      _os_log_impl(&dword_229538000, v118, OS_LOG_TYPE_DEBUG, "%{public}@Accepting home data sync: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v116);
    v111 = 0;
    v113 = 1;
    goto LABEL_68;
  }

  v54 = objc_autoreleasePoolPush();
  selfCopy3 = self;
  v56 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v56, OS_LOG_TYPE_ERROR))
  {
    v57 = HMFGetLogIdentifier();
    remoteUserPairingIdentity = [syncCopy remoteUserPairingIdentity];
    *buf = 138543618;
    v204 = v57;
    v205 = 2112;
    v206 = remoteUserPairingIdentity;
    _os_log_impl(&dword_229538000, v56, OS_LOG_TYPE_ERROR, "%{public}@Rejecting home data sync - Sync not from trusted account %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v54);
  [syncCopy respondWithError:v7];
LABEL_101:

  objc_autoreleasePoolPop(v5);
  v157 = *MEMORY[0x277D85DE8];
}

- (BOOL)_shouldHandleHomeDataSync:(id)sync remoteHome:(id)home sourceDeviceVersion:(id)version
{
  v39 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  homeCopy = home;
  versionCopy = version;
  if (isWatch())
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = 1;
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v31 = 138543362;
      v32 = v13;
      v14 = "%{public}@Adding or updating home on the watch";
LABEL_12:
      v21 = v11;
      v22 = 12;
LABEL_13:
      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, v14, &v31, v22);

      goto LABEL_30;
    }

    goto LABEL_30;
  }

  if (syncCopy)
  {
    sharedHomeUpdateHandler = [syncCopy sharedHomeUpdateHandler];
    if ([sharedHomeUpdateHandler pendingRequestDataFromResident])
    {
      sharedHomeSourceVersion = [syncCopy sharedHomeSourceVersion];
      v17 = [versionCopy isGreaterThanVersion:sharedHomeSourceVersion];

      if (v17)
      {
        configurationVersion = [homeCopy configurationVersion];
        if (configurationVersion < [syncCopy configurationVersion])
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v19 = HMFGetLogIdentifier();
            v31 = 138543874;
            v32 = v19;
            v33 = 2048;
            configurationVersion2 = [syncCopy configurationVersion];
            v35 = 2048;
            configurationVersion3 = [homeCopy configurationVersion];
            v20 = "%{public}@Pending request data from resident is active, Local home is at version %ld and incoming home version is at %ld, discarding changes and sending ack";
LABEL_24:
            v27 = v11;
            v28 = 32;
            goto LABEL_25;
          }

          goto LABEL_26;
        }

        goto LABEL_16;
      }
    }

    else
    {
    }

    configurationVersion4 = [homeCopy configurationVersion];
    if (configurationVersion4 <= [syncCopy configurationVersion])
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v31 = 138543874;
        v32 = v19;
        v33 = 2048;
        configurationVersion2 = [syncCopy configurationVersion];
        v35 = 2048;
        configurationVersion3 = [homeCopy configurationVersion];
        v20 = "%{public}@Local home is at version %ld and incoming home version is at %ld, discarding changes and sending ack";
        goto LABEL_24;
      }

LABEL_26:
      v12 = 0;
      goto LABEL_30;
    }

LABEL_16:
    if (versionCopy)
    {
      v24 = +[HMDHomeKitVersion version3];
      if ([versionCopy isAtLeastVersion:v24] && objc_msgSend(syncCopy, "expectedConfigurationVersion"))
      {
        expectedConfigurationVersion = [syncCopy expectedConfigurationVersion];
        configurationVersion5 = [homeCopy configurationVersion];

        if (expectedConfigurationVersion > configurationVersion5)
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v19 = HMFGetLogIdentifier();
            v31 = 138544130;
            v32 = v19;
            v33 = 2048;
            configurationVersion2 = [syncCopy configurationVersion];
            v35 = 2048;
            configurationVersion3 = [syncCopy expectedConfigurationVersion];
            v37 = 2048;
            configurationVersion6 = [homeCopy configurationVersion];
            v20 = "%{public}@Local is config version is at %ld and expected config version %ld and incoming home config version is at %ld, discarding changes and sending ack";
            v27 = v11;
            v28 = 42;
LABEL_25:
            _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, v20, &v31, v28);

            goto LABEL_26;
          }

          goto LABEL_26;
        }
      }

      else
      {
      }
    }

    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = 1;
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      goto LABEL_30;
    }

    v13 = HMFGetLogIdentifier();
    v31 = 138544130;
    v32 = v13;
    v33 = 2048;
    configurationVersion2 = [syncCopy configurationVersion];
    v35 = 2048;
    configurationVersion3 = [syncCopy expectedConfigurationVersion];
    v37 = 2048;
    configurationVersion6 = [homeCopy configurationVersion];
    v14 = "%{public}@Local is config version is at %ld and expected config version %ld and incoming home config version is at %ld, accepting new changes";
    v12 = 1;
    v21 = v11;
    v22 = 42;
    goto LABEL_13;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = HMFGetOSLogHandle();
  v12 = 1;
  if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v31 = 138543362;
    v32 = v13;
    v14 = "%{public}@Receiving a new shared home";
    goto LABEL_12;
  }

LABEL_30:

  objc_autoreleasePoolPop(v10);
  v29 = *MEMORY[0x277D85DE8];
  return v12;
}

- (void)fragmentationStream:(id)stream didReceiveData:(id)data transactionIdentifier:(unsigned __int16)identifier error:(id)error
{
  streamCopy = stream;
  dataCopy = data;
  errorCopy = error;
  if (dataCopy)
  {
    workQueue = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __81__HMDHomeManager_fragmentationStream_didReceiveData_transactionIdentifier_error___block_invoke;
    block[3] = &unk_278685F10;
    block[4] = self;
    v15 = streamCopy;
    v16 = dataCopy;
    identifierCopy = identifier;
    v17 = errorCopy;
    dispatch_async(workQueue, block);
  }
}

- (void)fragmentationStream:(id)stream didCloseWithError:(id)error
{
  streamCopy = stream;
  errorCopy = error;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __56__HMDHomeManager_fragmentationStream_didCloseWithError___block_invoke;
  block[3] = &unk_27868A010;
  block[4] = self;
  v12 = streamCopy;
  v13 = errorCopy;
  v9 = errorCopy;
  v10 = streamCopy;
  dispatch_async(workQueue, block);
}

- (void)processSharedHomeModelRemoved:(id)removed message:(id)message
{
  v25 = *MEMORY[0x277D85DE8];
  removedCopy = removed;
  messageCopy = message;
  uuid = [removedCopy uuid];
  if (uuid)
  {
    v9 = [(HMDHomeManager *)self _homeWithUUID:uuid];
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = v11;
    if (v9)
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v21 = 138543618;
        v22 = v13;
        v23 = 2112;
        v24 = v9;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Attempting to remove home %@ since we are no longer part of the home", &v21, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      [(HMDHomeManager *)self _removeHome:v9 withMessage:messageCopy saveToStore:1 notifyUsers:0 shouldRemovePairings:0];
      goto LABEL_13;
    }

    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v16 = HMFGetLogIdentifier();
      uUIDString = [uuid UUIDString];
      v21 = 138543618;
      v22 = v16;
      v23 = 2112;
      v24 = uUIDString;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Home %@ not found for user", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    responseHandler = [messageCopy responseHandler];

    if (!responseHandler)
    {
      goto LABEL_13;
    }

    responseHandler4 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    responseHandler2 = [messageCopy responseHandler];
    responseHandler2[2](responseHandler2, responseHandler4, 0);

LABEL_12:
LABEL_13:

    goto LABEL_14;
  }

  responseHandler3 = [messageCopy responseHandler];

  if (responseHandler3)
  {
    v9 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    responseHandler4 = [messageCopy responseHandler];
    (responseHandler4)[2](responseHandler4, v9, 0);
    goto LABEL_12;
  }

LABEL_14:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_handleUserRemoved:(id)removed
{
  v25 = *MEMORY[0x277D85DE8];
  removedCopy = removed;
  v5 = [removedCopy uuidForKey:*MEMORY[0x277CD0640]];
  v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
  if (v6)
  {
    v7 = removedCopy;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = v7;
    }

    else
    {
      v8 = 0;
    }

    responseHandler4 = v8;

    if ([v7 isRemote] && objc_msgSend(responseHandler4, "restriction") != 4)
    {
      v10 = __isUserInMessagePartOfHome(self, v6, v7);
      if (([v10 isOwner] & 1) == 0)
      {
        v13 = objc_autoreleasePoolPush();
        selfCopy = self;
        v15 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
        {
          v16 = HMFGetLogIdentifier();
          v21 = 138543618;
          v22 = v16;
          v23 = 2112;
          v24 = v7;
          _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Only owner can remove homes: %@", &v21, 0x16u);
        }

        objc_autoreleasePoolPop(v13);
        responseHandler = [v7 responseHandler];

        if (responseHandler)
        {
          responseHandler2 = [v7 responseHandler];
          v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
          (responseHandler2)[2](responseHandler2, v19, 0);
        }

        goto LABEL_17;
      }
    }

    [(HMDHomeManager *)self dmHandleRequestRemoveHome:v7];
LABEL_17:

    goto LABEL_18;
  }

  responseHandler3 = [removedCopy responseHandler];

  if (responseHandler3)
  {
    responseHandler4 = [removedCopy responseHandler];
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(responseHandler4 + 2))(responseHandler4, v12, 0);

    goto LABEL_17;
  }

LABEL_18:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_handleResetHome:(id)home
{
  v41 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v5 = [homeCopy uuidForKey:*MEMORY[0x277CD0640]];
  if (v5)
  {
    v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
    if (v6)
    {
      v7 = v6;
      v8 = homeCopy;
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v9 = v8;
      }

      else
      {
        v9 = 0;
      }

      responseHandler4 = v9;

      if (![v8 isRemote] || objc_msgSend(responseHandler4, "restriction") == 4)
      {
        goto LABEL_10;
      }

      v11 = __isUserInMessagePartOfHome(self, v7, v8);
      if ([v11 isOwner])
      {

LABEL_10:
        v12 = objc_autoreleasePoolPush();
        selfCopy = self;
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          v37 = 138543618;
          v38 = v15;
          v39 = 2112;
          v40 = v7;
          _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Received request to reset configuration for home %@", &v37, 0x16u);
        }

        objc_autoreleasePoolPop(v12);
        v16 = objc_autoreleasePoolPush();
        v17 = selfCopy;
        v18 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
        {
          v19 = HMFGetLogIdentifier();
          v37 = 138543618;
          v38 = v19;
          v39 = 2112;
          v40 = v7;
          _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Attempting to reset home %@ by removing it", &v37, 0x16u);
        }

        objc_autoreleasePoolPop(v16);
        [(HMDHomeManager *)v17 _removeHome:v7 withMessage:v8 saveToStore:1 notifyUsers:1 shouldRemovePairings:0];
        goto LABEL_21;
      }

      v30 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        v33 = HMFGetLogIdentifier();
        v37 = 138543618;
        v38 = v33;
        v39 = 2112;
        v40 = v8;
        _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_ERROR, "%{public}@Only owner can remove homes: %@", &v37, 0x16u);
      }

      objc_autoreleasePoolPop(v30);
      responseHandler = [v8 responseHandler];

      if (responseHandler)
      {
        responseHandler2 = [v8 responseHandler];
        v36 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        (responseHandler2)[2](responseHandler2, v36, 0);
      }
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
      {
        v26 = HMFGetLogIdentifier();
        uUIDString = [v5 UUIDString];
        v37 = 138543618;
        v38 = v26;
        v39 = 2112;
        v40 = uUIDString;
        _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_INFO, "%{public}@Cannot reset home %@ since it could not be found", &v37, 0x16u);
      }

      objc_autoreleasePoolPop(v24);
      responseHandler4 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
      responseHandler3 = [homeCopy responseHandler];
      (responseHandler3)[2](responseHandler3, responseHandler4, 0);

      v7 = 0;
    }
  }

  else
  {
    v20 = objc_autoreleasePoolPush();
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v22 = HMFGetLogIdentifier();
      name = [homeCopy name];
      v37 = 138543618;
      v38 = v22;
      v39 = 2112;
      v40 = name;
      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for message %@", &v37, 0x16u);
    }

    objc_autoreleasePoolPop(v20);
    v7 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    responseHandler4 = [homeCopy responseHandler];
    (*(responseHandler4 + 2))(responseHandler4, v7, 0);
  }

LABEL_21:

  v29 = *MEMORY[0x277D85DE8];
}

- (void)_removeAllUsersOfHome:(id)home
{
  v78[1] = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v77 = *MEMORY[0x277CD0640];
  v52 = homeCopy;
  uuid = [homeCopy uuid];
  uUIDString = [uuid UUIDString];
  v78[0] = uUIDString;
  v53 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v78 forKeys:&v77 count:1];

  v66 = 0u;
  v67 = 0u;
  v64 = 0u;
  v65 = 0u;
  obj = [(HMDHomeManager *)self associatedWatchPeers];
  v7 = [obj countByEnumeratingWithState:&v64 objects:v76 count:16];
  if (v7)
  {
    v8 = *v65;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v65 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v10 = *(*(&v64 + 1) + 8 * i);
        v11 = objc_autoreleasePoolPush();
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          name = [v52 name];
          *buf = 138543874;
          v71 = v13;
          v72 = 2112;
          v73 = name;
          v74 = 2112;
          v75 = v10;
          _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Sending the remove home for %@ to watch %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v11);
        v15 = [HMDDevice deviceWithDestination:v10];
        v16 = [HMDRemoteDeviceMessageDestination alloc];
        uuid2 = [(HMDHomeManager *)self uuid];
        v18 = [(HMDRemoteDeviceMessageDestination *)v16 initWithTarget:uuid2 device:v15];

        v19 = [MEMORY[0x277D0F818] internalMessageWithName:@"kUserResetHomeConfigRequestKey" destination:v18 messagePayload:v53];
        messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
        [messageDispatcher sendMessage:v19 completionHandler:0];
      }

      v7 = [obj countByEnumeratingWithState:&v64 objects:v76 count:16];
    }

    while (v7);
  }

  v62 = 0u;
  v63 = 0u;
  v60 = 0u;
  v61 = 0u;
  users = [v52 users];
  v22 = [users countByEnumeratingWithState:&v60 objects:v69 count:16];
  if (v22)
  {
    v23 = *v61;
    do
    {
      for (j = 0; j != v22; ++j)
      {
        if (*v61 != v23)
        {
          objc_enumerationMutation(users);
        }

        account = [*(*(&v60 + 1) + 8 * j) account];
        senderCorrelationIdentifier = [account senderCorrelationIdentifier];
        [(HMDHomeManager *)self _trackRemovedHomeUserMergeId:senderCorrelationIdentifier];
      }

      v22 = [users countByEnumeratingWithState:&v60 objects:v69 count:16];
    }

    while (v22);
  }

  if ([v52 isOwnerUser])
  {
    users2 = [v52 users];
    v28 = [users2 copy];

    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    v49 = v28;
    v29 = [v49 countByEnumeratingWithState:&v56 objects:v68 count:16];
    if (v29)
    {
      obja = *v57;
      *&v30 = 138543874;
      v48 = v30;
      do
      {
        for (k = 0; k != v29; ++k)
        {
          if (*v57 != obja)
          {
            objc_enumerationMutation(v49);
          }

          v32 = *(*(&v56 + 1) + 8 * k);
          currentUser = [v52 currentUser];
          v34 = [v32 isEqual:currentUser];

          if ((v34 & 1) == 0)
          {
            objc_opt_class();
            isKindOfClass = objc_opt_isKindOfClass();
            uuid3 = [(HMDHomeManager *)self uuid];
            userID = [v32 userID];
            if (isKindOfClass)
            {
              userID2 = [v32 userID];
              v39 = [HMDMessageDispatcher destinationWithTarget:uuid3 userID:userID destination:userID2 multicast:0];
            }

            else
            {
              v39 = [HMDMessageDispatcher destinationWithTarget:uuid3 userID:userID destination:0 multicast:0];
            }

            if (v39)
            {
              v40 = [HMDRemoteMessage secureMessageWithName:@"kUserResetHomeConfigRequestKey" destination:v39 messagePayload:v53];
              objc_initWeak(buf, self);
              v54[0] = MEMORY[0x277D85DD0];
              v54[1] = 3221225472;
              v54[2] = __40__HMDHomeManager__removeAllUsersOfHome___block_invoke;
              v54[3] = &unk_278687F40;
              v54[4] = v32;
              objc_copyWeak(&v55, buf);
              [v40 setResponseHandler:v54];
              messageDispatcher2 = [(HMDHomeManager *)self messageDispatcher];
              [messageDispatcher2 sendMessage:v40 completionHandler:0];

              objc_destroyWeak(&v55);
              objc_destroyWeak(buf);
            }

            else
            {
              v42 = objc_autoreleasePoolPush();
              selfCopy = self;
              v44 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
              {
                v45 = HMFGetLogIdentifier();
                userID3 = [v32 userID];
                *buf = v48;
                v71 = v45;
                v72 = 2112;
                v73 = v32;
                v74 = 2112;
                v75 = userID3;
                _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot notify user %@ of home reset: could not create message destination for userID: %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v42);
            }
          }
        }

        v29 = [v49 countByEnumeratingWithState:&v56 objects:v68 count:16];
      }

      while (v29);
    }
  }

  v47 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__removeAllUsersOfHome___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v25 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [*(a1 + 32) home];
    *buf = 138543874;
    v20 = v9;
    v21 = 2112;
    v22 = v10;
    v23 = 2112;
    v24 = v5;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Reset home for user %@ with error: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained && [*(a1 + 32) isRemoteGateway])
  {
    v12 = [WeakRetained workQueue];
    v16[0] = MEMORY[0x277D85DD0];
    v16[1] = 3221225472;
    v16[2] = __40__HMDHomeManager__removeAllUsersOfHome___block_invoke_1035;
    v16[3] = &unk_27868A750;
    v13 = WeakRetained;
    v14 = *(a1 + 32);
    v17 = v13;
    v18 = v14;
    dispatch_async(v12, v16);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__removeAllUsersOfHome___block_invoke_1035(uint64_t a1)
{
  v2 = *(a1 + 32);
  v4 = [*(a1 + 40) userID];
  v3 = [*(a1 + 40) home];
  [v2 _removeFromAssociatedPeers:v4 home:v3];
}

- (void)_sendUserRemoved:(id)removed fromHome:(id)home pairingUsername:(id)username pushToCloud:(BOOL)cloud completionHandler:(id)handler
{
  location[2] = *MEMORY[0x277D85DE8];
  removedCopy = removed;
  homeCopy = home;
  usernameCopy = username;
  handlerCopy = handler;
  v13 = MEMORY[0x277D0F818];
  v42 = *MEMORY[0x277CD0640];
  uuid = [homeCopy uuid];
  uUIDString = [uuid UUIDString];
  v43 = uUIDString;
  v16 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v43 forKeys:&v42 count:1];
  v34 = [v13 internalMessageWithName:@"kUserRemovedRequestKey" messagePayload:v16];

  if ([removedCopy isRemoteGateway])
  {
    userID = [removedCopy userID];
  }

  else
  {
    userID = 0;
  }

  v46 = @"kDeviceClassTypeKey";
  v47 = @"kDeviceClassTypeTransient";
  v48[0] = @"kRequiredCapabilitiesKey";
  v18 = MEMORY[0x277CBEAC0];
  v19 = @"kDeviceClassTypeTransient";
  v20 = [v18 dictionaryWithObjects:&v47 forKeys:&v46 count:1];
  v48[1] = @"kRequestedCapabilitiesKey";
  location[0] = v20;
  v44[0] = @"kHomedVersionKey";
  v44[1] = @"kHomeKitVersionStringKey";
  v45[0] = homedVersion;
  v21 = homedVersion;
  v22 = +[HMDHomeKitVersion currentVersion];
  versionString = [v22 versionString];
  v45[1] = versionString;
  v24 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v45 forKeys:v44 count:2];
  location[1] = v24;
  v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:location forKeys:v48 count:2];

  objc_initWeak(location, self);
  userID2 = [removedCopy userID];
  workQueue = [(HMDHomeManager *)self workQueue];
  v36[0] = MEMORY[0x277D85DD0];
  v36[1] = 3221225472;
  v36[2] = __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke;
  v36[3] = &unk_278685EE8;
  objc_copyWeak(&v41, location);
  v28 = handlerCopy;
  v40 = v28;
  v29 = homeCopy;
  v37 = v29;
  v30 = removedCopy;
  v38 = v30;
  v31 = v34;
  v39 = v31;
  [(HMDHomeManager *)self electDeviceForUser:userID2 destination:userID deviceCapabilities:v25 queue:workQueue completionHandler:v36];

  objc_destroyWeak(&v41);
  objc_destroyWeak(location);

  v32 = *MEMORY[0x277D85DE8];
}

void __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v37 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if (v7)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = WeakRetained;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        v15 = *(a1 + 32);
        *buf = 138543618;
        v34 = v14;
        v35 = 2112;
        v36 = v15;
        _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Failed to elect device to send request to remove user from home: %@", buf, 0x16u);
      }

LABEL_14:

      objc_autoreleasePoolPop(v11);
      (*(*(a1 + 56) + 16))();
      goto LABEL_15;
    }

    if (([*(a1 + 32) containsRemovedUser:*(a1 + 40)] & 1) == 0)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = WeakRetained;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v25 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v25;
        _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Skipping send remove user message due to the user being removed from removed user list", buf, 0xCu);
      }

      goto LABEL_14;
    }

    v28 = [WeakRetained messageDispatcher];
    v27 = *(a1 + 48);
    v21 = [WeakRetained uuid];
    v22 = [*(a1 + 40) userID];
    v23 = [v8 destination];
    v24 = [WeakRetained workQueue];
    v29[0] = MEMORY[0x277D85DD0];
    v29[1] = 3221225472;
    v29[2] = __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke_1032;
    v29[3] = &unk_278685EC0;
    objc_copyWeak(&v32, (a1 + 64));
    v30 = *(a1 + 40);
    v31 = *(a1 + 56);
    [v28 sendSecureMessage:v27 target:v21 userID:v22 destination:v23 responseQueue:v24 responseHandler:v29];

    objc_destroyWeak(&v32);
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543362;
      v34 = v18;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Lost reference to home manager while electing a device to remove user", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v19 = *(a1 + 56);
    if (v19)
    {
      v20 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:8];
      (*(v19 + 16))(v19, v20, v9);
    }
  }

LABEL_15:

  v26 = *MEMORY[0x277D85DE8];
}

void __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke_1032(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = WeakRetained;
    v10 = HMFGetOSLogHandle();
    v11 = v10;
    if (v5)
    {
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v12 = HMFGetLogIdentifier();
        v22 = 138543618;
        v23 = v12;
        v24 = 2112;
        v25 = v5;
        v13 = "%{public}@User removed message responded with error: %@";
        v14 = v11;
        v15 = OS_LOG_TYPE_ERROR;
LABEL_10:
        _os_log_impl(&dword_229538000, v14, v15, v13, &v22, 0x16u);
      }
    }

    else if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v19 = *(a1 + 32);
      v22 = 138543618;
      v23 = v12;
      v24 = 2112;
      v25 = v19;
      v13 = "%{public}@Successfully removed user: %@";
      v14 = v11;
      v15 = OS_LOG_TYPE_INFO;
      goto LABEL_10;
    }

    objc_autoreleasePoolPop(v8);
    (*(*(a1 + 40) + 16))(*(a1 + 40), v5, v6, v20);
    goto LABEL_12;
  }

  v16 = objc_autoreleasePoolPush();
  v17 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
  {
    v18 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v18;
    _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_ERROR, "%{public}@Lost reference to home manager while sending remove user message", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v16);
LABEL_12:

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_sendUserAdded:(id)added destination:(id)destination toHome:(id)home
{
  v53 = *MEMORY[0x277D85DE8];
  addedCopy = added;
  destinationCopy = destination;
  homeCopy = home;
  if (shouldLogPrivateInformation())
  {
    userID = [addedCopy userID];
  }

  else
  {
    userID = @"...";
    v11 = @"...";
  }

  v12 = shouldLogPrivateInformation();
  v13 = destinationCopy;
  if (!v12)
  {
    v13 = @"...";
  }

  v14 = v13;
  v15 = objc_autoreleasePoolPush();
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    *buf = 138543874;
    v48 = v17;
    v49 = 2112;
    v50 = userID;
    v51 = 2112;
    v52 = v14;
    _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Going to send home configuration to added user %@ at %@ and all resident devices", buf, 0x20u);
  }

  v35 = v14;

  objc_autoreleasePoolPop(v15);
  if ([addedCopy isRemoteGateway])
  {
    v18 = objc_autoreleasePoolPush();
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543618;
      v48 = v20;
      v49 = 2112;
      v50 = userID;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Removing resident user %@ from unassociated list", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    userID2 = [addedCopy userID];
    [(HMDHomeManager *)self _removeFromUnassociatedPeers:userID2 home:homeCopy];
  }

  v36 = userID;
  selfCopy = self;
  array = [MEMORY[0x277CBEB18] array];
  array2 = [MEMORY[0x277CBEB18] array];
  [MEMORY[0x277CBEB18] array];
  v39 = v38 = homeCopy;
  v42 = 0u;
  v43 = 0u;
  v44 = 0u;
  v45 = 0u;
  users = [homeCopy users];
  v24 = [users countByEnumeratingWithState:&v42 objects:v46 count:16];
  if (v24)
  {
    v25 = v24;
    v26 = *v43;
    do
    {
      for (i = 0; i != v25; ++i)
      {
        if (*v43 != v26)
        {
          objc_enumerationMutation(users);
        }

        v28 = *(*(&v42 + 1) + 8 * i);
        isRemoteGateway = [v28 isRemoteGateway];
        userID3 = [v28 userID];
        if (isRemoteGateway)
        {
          v31 = array;
LABEL_24:
          [v31 addObject:userID3];

          continue;
        }

        userID4 = [addedCopy userID];
        v33 = [(HMDHomeDataPushDestination *)userID3 isEqualToString:userID4];

        if (destinationCopy && v33)
        {
          userID3 = [[HMDHomeDataPushDestination alloc] initWithUser:v28 destination:destinationCopy];
          [(HMDHomeDataPushDestination *)userID3 setIgnoreConfigCompare:1];
          if ([v28 isAdministrator])
          {
            v31 = v39;
          }

          else
          {
            v31 = array2;
          }

          goto LABEL_24;
        }
      }

      v25 = [users countByEnumeratingWithState:&v42 objects:v46 count:16];
    }

    while (v25);
  }

  [(HMDHomeManager *)selfCopy _pushChangesForHome:v38 toRemoteDevicesOnSameAccount:array addedUser:addedCopy];
  [(HMDHomeManager *)selfCopy _pushChangesForHome:v38 toRegularUsersOfHome:array2 adminUsersOfHome:v39];

  v34 = *MEMORY[0x277D85DE8];
}

- (void)_acceptHomeInviteFromAccount:(id)account message:(id)message trackInvite:(BOOL)invite
{
  inviteCopy = invite;
  v68 = *MEMORY[0x277D85DE8];
  accountCopy = account;
  messageCopy = message;
  messagePayload = [messageCopy messagePayload];
  v11 = [messagePayload objectForKeyedSubscript:@"kRequestedCapabilitiesKey"];

  v12 = objc_autoreleasePoolPush();
  selfCopy = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v65 = v15;
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Handling request for getting controller identity for home invite request", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v12);
  if (accountCopy)
  {
    v16 = [messageCopy dataForKey:@"kControllerPublicKey"];
    v17 = [messageCopy stringForKey:@"kControllerPairingNameKey"];
    responseHandler4 = v17;
    if (v16 && v17)
    {
      v19 = v11;
      v56 = v16;
      v20 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v16];
      responseHandler2 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:responseHandler4 publicKey:v20 privateKey:0 permissions:0];
      v22 = +[HMDIdentityRegistry sharedRegistry];
      [v22 registerIdentity:responseHandler2 account:accountCopy object:selfCopy];

      v60 = 0;
      v61 = 0;
      v59 = 0;
      LOBYTE(v22) = [(HMDHomeManager *)selfCopy getOrCreateControllerPublicKey:&v61 controllerUsername:&v60 error:&v59];
      v58 = v61;
      v57 = v60;
      v23 = v59;
      v24 = v23;
      if (v22)
      {
        v52 = v23;
        if (inviteCopy)
        {
          remoteSenderContext = [messageCopy remoteSenderContext];
          mergeID = [remoteSenderContext mergeID];
          messagePayload2 = [messageCopy messagePayload];
          v28 = [(HMDHomeManager *)selfCopy _trackIncomingInvitationFromAccount:accountCopy mergeID:mergeID idsInvitationIdentifier:0 payload:messagePayload2 invitationState:5 error:0];
        }

        v54 = accountCopy;
        v29 = objc_autoreleasePoolPush();
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
        {
          v31 = HMFGetLogIdentifier();
          *buf = 138543618;
          v65 = v31;
          v66 = 2112;
          v67 = v58;
          _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_INFO, "%{public}@Preparing response for request for controller info: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v29);
        dictionary = [MEMORY[0x277CBEB38] dictionary];
        v62[0] = @"kControllerPublicKey";
        null = v58;
        if (!v58)
        {
          null = [MEMORY[0x277CBEB68] null];
        }

        v55 = v20;
        v63[0] = null;
        v63[1] = v57;
        v62[1] = @"kControllerPairingNameKey";
        v62[2] = @"kInviteAcceptedKey";
        v63[2] = MEMORY[0x277CBEC38];
        v34 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v63 forKeys:v62 count:{3, v52}];
        [dictionary addEntriesFromDictionary:v34];

        if (!v58)
        {
        }

        appleAccountManager = [(HMDHomeManager *)selfCopy appleAccountManager];
        account = [appleAccountManager account];
        primaryHandle = [account primaryHandle];

        accountCopy = v54;
        if (primaryHandle)
        {
          v38 = +[HMDAccountHandleFormatter defaultFormatter];
          v39 = [v38 stringForObjectValue:primaryHandle];

          if (v39)
          {
            [dictionary setObject:v39 forKeyedSubscript:@"kUserIDKey"];
          }
        }

        v40 = [(HMDHomeManager *)selfCopy _prepareAnswerForRequestedCapabilities:v19];
        if (v40)
        {
          [dictionary addEntriesFromDictionary:v40];
        }

        [(HMDHomeManager *)selfCopy _updateIncomingInvitesPresent];
        responseHandler = [messageCopy responseHandler];
        responseHandler[2](responseHandler, 0, dictionary);

        v20 = v55;
        v11 = v19;
        v24 = v53;
      }

      else
      {
        dictionary = [messageCopy responseHandler];
        (dictionary)[2](dictionary, v24, 0);
        v11 = v19;
      }

      v16 = v56;
    }

    else
    {
      v47 = objc_autoreleasePoolPush();
      v48 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v48, OS_LOG_TYPE_DEFAULT))
      {
        v49 = HMFGetLogIdentifier();
        name = [messageCopy name];
        *buf = 138543618;
        v65 = v49;
        v66 = 2112;
        v67 = name;
        _os_log_impl(&dword_229538000, v48, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for message %@, missing controller or public key", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v47);
      v20 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
      responseHandler2 = [messageCopy responseHandler];
      (responseHandler2)[2](responseHandler2, v20, 0);
    }

    goto LABEL_32;
  }

  v42 = objc_autoreleasePoolPush();
  v43 = selfCopy;
  v44 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
  {
    v45 = HMFGetLogIdentifier();
    *buf = 138543618;
    v65 = v45;
    v66 = 2112;
    v67 = messageCopy;
    _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_ERROR, "%{public}@Failed to resolve inviter account for message: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v42);
  responseHandler3 = [messageCopy responseHandler];

  if (responseHandler3)
  {
    v16 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    responseHandler4 = [messageCopy responseHandler];
    (responseHandler4)[2](responseHandler4, v16, 0);
LABEL_32:
  }

  v51 = *MEMORY[0x277D85DE8];
}

- (void)_autoAcceptAllPendingReinvitations
{
  v17 = *MEMORY[0x277D85DE8];
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v14 = 0u;
  v15 = 0u;
  v12 = 0u;
  v13 = 0u;
  incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
  v5 = [incomingInvitations copy];

  v6 = [v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v13;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v13 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v12 + 1) + 8 * i);
        if ([v10 invitationState] == 2)
        {
          [(HMDHomeManager *)self _autoAcceptInviteIfReinvitation:v10];
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v7);
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_postIncomingInvitationStateChangedNotification:(id)notification newInvitationState:(int64_t)state
{
  v37[1] = *MEMORY[0x277D85DE8];
  notificationCopy = notification;
  backingStore = [(HMDHomeManager *)self backingStore];
  context = [backingStore context];
  v23 = MEMORY[0x277D85DD0];
  v24 = 3221225472;
  v25 = __85__HMDHomeManager__postIncomingInvitationStateChangedNotification_newInvitationState___block_invoke;
  v26 = &unk_27868A0D0;
  v9 = notificationCopy;
  v27 = v9;
  stateCopy = state;
  [context performBlock:&v23];

  [v9 updateInvitationState:{state, v23, v24, v25, v26}];
  v37[0] = v9;
  v10 = [MEMORY[0x277CBEA60] arrayWithObjects:v37 count:1];
  v11 = encodeRootObjectForIncomingXPCMessage(v10, 0);

  v35 = @"kInvitationsDataKey";
  v36 = v11;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v36 forKeys:&v35 count:1];
  v13 = objc_autoreleasePoolPush();
  selfCopy = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
  {
    v16 = HMFGetLogIdentifier();
    v17 = [MEMORY[0x277CCABB0] numberWithInteger:state];
    describeWithFormat = [v9 describeWithFormat];
    *buf = 138543874;
    v30 = v16;
    v31 = 2112;
    v32 = v17;
    v33 = 2112;
    v34 = describeWithFormat;
    _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Posting incoming state update to clients: %@ / %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v13);
  v19 = [MEMORY[0x277D0F818] entitledMessageWithName:@"kUserInvitationsUpdatedNotificationKey" messagePayload:v12];
  messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
  uuid = [(HMDHomeManager *)selfCopy uuid];
  [messageDispatcher sendMessage:v19 target:uuid];

  v22 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager__postIncomingInvitationStateChangedNotification_newInvitationState___block_invoke(uint64_t a1)
{
  v15 = +[HMCContext currentContext];
  v2 = [v15 findHomeManagerWithError:0];
  if (v2)
  {
    v3 = v2;
    v4 = [*(a1 + 32) identifier];
    v5 = [v3 findIncomingInvitationsRelationWithModelID:v4];

    v6 = [MEMORY[0x277CCABB0] numberWithInteger:*(a1 + 40)];
    [v5 setInvitationState:v6];

    [v15 save];
  }

  else
  {
    v7 = _HMFPreconditionFailure();
    [(HMDHomeManager *)v7 _trackIncomingInvitationFromAccount:v8 mergeID:v9 idsInvitationIdentifier:v10 payload:v11 invitationState:v12 error:v13, v14];
  }
}

- (id)_trackIncomingInvitationFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload invitationState:(int64_t)state error:(id *)error
{
  v138 = *MEMORY[0x277D85DE8];
  accountCopy = account;
  dCopy = d;
  identifierCopy = identifier;
  payloadCopy = payload;
  v13 = objc_autoreleasePoolPush();
  selfCopy = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543874;
    v126 = v15;
    v127 = 2112;
    v128 = accountCopy;
    v129 = 2112;
    v130 = payloadCopy;
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Incoming invitation from account %@ with payload: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v13);
  v108 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_stringForKey:*MEMORY[0x277CD23D0]];
  v16 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v110 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_UUIDForKey:@"kInvitationIdentifierKey"];
  v106 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_dateForKey:@"kInvitationExpiryDateKey"];
  v122 = 0u;
  v123 = 0u;
  v120 = 0u;
  v121 = 0u;
  incomingInvitations = [(HMDHomeManager *)selfCopy incomingInvitations];
  v18 = [incomingInvitations copy];

  v19 = [v18 countByEnumeratingWithState:&v120 objects:v137 count:16];
  if (!v19)
  {
LABEL_14:
    v26 = v18;
    goto LABEL_19;
  }

  v20 = *v121;
LABEL_5:
  v21 = 0;
  while (1)
  {
    if (*v121 != v20)
    {
      objc_enumerationMutation(v18);
    }

    v22 = *(*(&v120 + 1) + 8 * v21);
    homeUUID = [v22 homeUUID];
    if (([homeUUID isEqual:v16] & 1) == 0)
    {

      goto LABEL_12;
    }

    inviterAccount = [v22 inviterAccount];
    v25 = [inviterAccount isRelatedToAccount:accountCopy];

    if (v25)
    {
      break;
    }

LABEL_12:
    if (v19 == ++v21)
    {
      v19 = [v18 countByEnumeratingWithState:&v120 objects:v137 count:16];
      if (v19)
      {
        goto LABEL_5;
      }

      goto LABEL_14;
    }
  }

  v26 = v22;

  if (!v26)
  {
    goto LABEL_20;
  }

  v27 = objc_autoreleasePoolPush();
  v28 = selfCopy;
  v29 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
  {
    v30 = HMFGetLogIdentifier();
    describeWithFormat = [v26 describeWithFormat];
    shortDescription = [(__CFString *)accountCopy shortDescription];
    *buf = 138544130;
    v126 = v30;
    v127 = 2112;
    v128 = describeWithFormat;
    v129 = 2112;
    v130 = shortDescription;
    v131 = 2112;
    v132 = v16;
    _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_INFO, "%{public}@Replacing existing invitation %@ with the new incoming from account %@ for home %@", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v27);
  v33 = +[HMDBulletinBoard sharedBulletinBoard];
  identifier = [v26 identifier];
  uUIDString = [identifier UUIDString];
  [v33 removeBulletinWithRecordID:uUIDString];

  [(HMDHomeManager *)v28 _postIncomingInvitationStateChangedNotification:v26 newInvitationState:1];
  [(HMDHomeManager *)v28 _removeIncomingInvitation:v26];
LABEL_19:

LABEL_20:
  v112 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_dataForKey:@"kControllerPublicKey"];
  v111 = [(HMDIncomingHomeInvitation *)payloadCopy hmf_stringForKey:@"kControllerPairingNameKey"];
  if (!v112 || !v111)
  {
    v52 = objc_autoreleasePoolPush();
    v53 = selfCopy;
    v54 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
    {
      v55 = HMFGetLogIdentifier();
      *buf = 138543618;
      v126 = v55;
      v127 = 2112;
      v128 = v110;
      _os_log_impl(&dword_229538000, v54, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for invitation with ID %@, missing controller or public key", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v52);
    if (error)
    {
      *error = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    }

LABEL_45:
    v42 = 0;
    goto LABEL_46;
  }

  v102 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v112];
  v101 = [objc_alloc(MEMORY[0x277D0F8A8]) initWithIdentifier:v111 publicKey:v102 privateKey:0];
  if ([0 isExpired])
  {
    v36 = objc_autoreleasePoolPush();
    v37 = selfCopy;
    v38 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
    {
      v39 = HMFGetLogIdentifier();
      shortDescription2 = [(__CFString *)accountCopy shortDescription];
      *buf = 138543618;
      v126 = v39;
      v127 = 2112;
      v128 = shortDescription2;
      _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_INFO, "%{public}@Existing invitation from user (%@) was expired, recreating a new invitation", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v36);
    [(HMDHomeManager *)v37 _postIncomingInvitationStateChangedNotification:0 newInvitationState:6];
    [(HMDHomeManager *)v37 _removeIncomingInvitation:0];
  }

  v41 = [[HMDIncomingHomeInvitation alloc] initWithInviterAccount:accountCopy invitationIdentifier:v110 invitationState:state homeName:v108 homeUUID:v16 inviterIdentity:v101 inviterMergeID:dCopy expiryDate:v106];
  [(HMDHomeInvitation *)v41 setIdsInvitationUUID:identifierCopy];
  v42 = v41;
  v43 = payloadCopy;
  v44 = [(HMDIncomingHomeInvitation *)v43 hmf_stringForKey:@"HMDHomeInvitationShareURLKey"];
  if (!v44)
  {
    v56 = objc_autoreleasePoolPush();
    v57 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
    {
      v58 = HMFGetLogIdentifier();
      *buf = 138543618;
      v126 = v58;
      v127 = 2112;
      v128 = v42;
      _os_log_impl(&dword_229538000, v57, OS_LOG_TYPE_ERROR, "%{public}@Share URL is missing from invitation %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v56);
    if (error)
    {
      *error = [MEMORY[0x277CCA9B8] hmErrorWithCode:27];
    }

LABEL_44:
    goto LABEL_45;
  }

  v99 = [MEMORY[0x277CBEBC0] URLWithString:v44];
  v45 = [(HMDIncomingHomeInvitation *)v43 hmf_dataForKey:@"HMDHomeInvitationShareTokenKey"];
  v46 = MEMORY[0x277CCAAC8];
  v47 = [MEMORY[0x277CBEB98] setWithObject:objc_opt_class()];
  location = 0;
  v48 = [v46 _strictlyUnarchivedObjectOfClasses:v47 fromData:v45 error:&location];
  v49 = location;

  if (v49)
  {
    context = objc_autoreleasePoolPush();
    v50 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
    {
      v51 = HMFGetLogIdentifier();
      *buf = 138543874;
      v126 = v51;
      v127 = 2112;
      v128 = v49;
      v129 = 2112;
      v130 = v42;
      _os_log_impl(&dword_229538000, v50, OS_LOG_TYPE_ERROR, "%{public}@Unarchive share token due to error %@ for invitation %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(context);
    if (error)
    {
      *error = [MEMORY[0x277CCA9B8] hmErrorWithCode:27];
    }
  }

  else
  {
    [(HMDHomeInvitation *)v42 setShareURL:v99];
    [(HMDHomeInvitation *)v42 setShareToken:v48];
  }

  if (v49)
  {
    goto LABEL_44;
  }

  [(HMDIncomingHomeInvitation *)v42 setHomeHasCameras:[(HMDIncomingHomeInvitation *)v43 hmf_BOOLForKey:*MEMORY[0x277CD0748]]];
  v61 = [(HMDIncomingHomeInvitation *)v43 hmf_numberForKey:*MEMORY[0x277CD0010]];
  -[HMDIncomingHomeInvitation setInviteePrivilege:](v42, "setInviteePrivilege:", [v61 integerValue]);

  v105 = [(HMDIncomingHomeInvitation *)v43 hmf_dictionaryForKey:*MEMORY[0x277CD0D18]];
  v62 = objc_autoreleasePoolPush();
  v63 = selfCopy;
  v64 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v64, OS_LOG_TYPE_INFO))
  {
    v65 = HMFGetLogIdentifier();
    inviteePrivilege = [(HMDIncomingHomeInvitation *)v42 inviteePrivilege];
    if (inviteePrivilege > 5)
    {
      v67 = @"None";
    }

    else
    {
      v67 = off_278684178[inviteePrivilege];
    }

    v68 = v67;
    [(HMDIncomingHomeInvitation *)v42 homeHasCameras];
    v69 = HMFBooleanToString();
    *buf = 138544130;
    v126 = v65;
    v127 = 2112;
    v128 = v68;
    v129 = 2112;
    v130 = v69;
    v131 = 2112;
    v132 = v105;
    _os_log_impl(&dword_229538000, v64, OS_LOG_TYPE_INFO, "%{public}@Incoming invitation: [Privilege : %@], [HomeHasCameras: %@], [rgSchedule: %@]", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v62);
  if (v105)
  {
    v70 = [objc_alloc(MEMORY[0x277CD1D78]) initWithDictionary:v105];
    [(HMDIncomingHomeInvitation *)v42 setRestrictedGuestSchedule:v70];

    v71 = objc_autoreleasePoolPush();
    v72 = v63;
    v73 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v73, OS_LOG_TYPE_INFO))
    {
      v74 = HMFGetLogIdentifier();
      inviteePrivilege2 = [(HMDIncomingHomeInvitation *)v42 inviteePrivilege];
      if (inviteePrivilege2 > 5)
      {
        v76 = @"None";
      }

      else
      {
        v76 = off_278684178[inviteePrivilege2];
      }

      v77 = v76;
      restrictedGuestSchedule = [(HMDIncomingHomeInvitation *)v42 restrictedGuestSchedule];
      *buf = 138543874;
      v126 = v74;
      v127 = 2112;
      v128 = v77;
      v129 = 2112;
      v130 = restrictedGuestSchedule;
      _os_log_impl(&dword_229538000, v73, OS_LOG_TYPE_INFO, "%{public}@Unable to parse the RG schedule payload from invitation OR it does not exist. %@ / %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v71);
  }

  v79 = objc_autoreleasePoolPush();
  v80 = v63;
  v81 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v81, OS_LOG_TYPE_INFO))
  {
    v82 = HMFGetLogIdentifier();
    *buf = 138543874;
    v126 = v82;
    v127 = 2112;
    v128 = dCopy;
    v129 = 2112;
    v130 = v110;
    _os_log_impl(&dword_229538000, v81, OS_LOG_TYPE_INFO, "%{public}@Received incoming invitation from mergeID %@ for invite %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v79);
  workQueue = [(HMDHomeManager *)v80 workQueue];
  [(HMDHomeInvitation *)v42 setClientQueue:workQueue];

  objc_initWeak(&location, v80);
  objc_initWeak(&from, v42);
  v116[0] = MEMORY[0x277D85DD0];
  v116[1] = 3221225472;
  v116[2] = __116__HMDHomeManager__trackIncomingInvitationFromAccount_mergeID_idsInvitationIdentifier_payload_invitationState_error___block_invoke;
  v116[3] = &unk_278687590;
  objc_copyWeak(&v117, &location);
  objc_copyWeak(&v118, &from);
  v116[4] = v80;
  [(HMDHomeInvitation *)v42 setExpirationHandler:v116];
  [(HMDHomeManager *)v80 _addIncomingInvitation:v42];
  [(HMDHomeManager *)v80 _postIncomingInvitationStateChangedNotification:v42 newInvitationState:state];
  v100 = objc_autoreleasePoolPush();
  v114 = v80;
  v84 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v84, OS_LOG_TYPE_DEFAULT))
  {
    v85 = HMFGetLogIdentifier();
    contexta = [(HMDHomeInvitation *)v42 identifier];
    uUIDString2 = [contexta UUIDString];
    v87 = [MEMORY[0x277CD1A88] homeInvitationStateDescription:state];
    shortDescription3 = [(__CFString *)accountCopy shortDescription];
    uUIDString3 = [v16 UUIDString];
    *buf = 138544642;
    v126 = v85;
    v127 = 2112;
    v128 = uUIDString2;
    v129 = 2112;
    v130 = v87;
    v131 = 2112;
    v132 = shortDescription3;
    v133 = 2112;
    v134 = v108;
    v135 = 2112;
    v136 = uUIDString3;
    _os_log_impl(&dword_229538000, v84, OS_LOG_TYPE_DEFAULT, "%{public}@Tracking incoming invite %@ with state %@ from account %@ for home %@(%@)", buf, 0x3Eu);
  }

  objc_autoreleasePoolPop(v100);
  if (isThisDeviceDesignatedFMFDevice())
  {
    [(HMDHomeManager *)v114 _autoAcceptInviteIfReinvitation:v42];
  }

  objc_destroyWeak(&v118);
  objc_destroyWeak(&v117);
  objc_destroyWeak(&from);
  objc_destroyWeak(&location);

  if (state == 5)
  {
    uuidsOfRemovedHomes = [(HMDHomeManager *)v114 uuidsOfRemovedHomes];
    v91 = [uuidsOfRemovedHomes containsObject:v16];

    if (v91)
    {
      uuidsOfRemovedHomes2 = [(HMDHomeManager *)v114 uuidsOfRemovedHomes];
      [uuidsOfRemovedHomes2 removeObject:v16];

      v93 = objc_autoreleasePoolPush();
      v94 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v94, OS_LOG_TYPE_INFO))
      {
        v95 = HMFGetLogIdentifier();
        uUIDString4 = [v16 UUIDString];
        *buf = 138543618;
        v126 = v95;
        v127 = 2112;
        v128 = uUIDString4;
        _os_log_impl(&dword_229538000, v94, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v93);
    }

    [(HMDHomeManager *)v114 _stopTrackingRemovedHomeUserMergeId:dCopy];
  }

LABEL_46:

  v59 = *MEMORY[0x277D85DE8];

  return v42;
}

void __116__HMDHomeManager__trackIncomingInvitationFromAccount_mergeID_idsInvitationIdentifier_payload_invitationState_error___block_invoke(id *a1)
{
  v17 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained(a1 + 5);
  if (WeakRetained)
  {
    v3 = objc_loadWeakRetained(a1 + 6);
    v4 = +[HMDBulletinBoard sharedBulletinBoard];
    v5 = [v3 identifier];
    v6 = [v5 UUIDString];
    [v4 removeBulletinWithRecordID:v6];

    [WeakRetained _postIncomingInvitationStateChangedNotification:v3 newInvitationState:{objc_msgSend(v3, "invitationState")}];
    [a1[4] _removeIncomingInvitation:v3];
    v7 = objc_autoreleasePoolPush();
    v8 = a1[4];
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [a1[4] incomingInvitations];
      v13 = 138543618;
      v14 = v10;
      v15 = 2112;
      v16 = v11;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@New incomingInvitations after expiration: %@", &v13, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_handleDismissDialogRequest:(id)request
{
  v24 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = [requestCopy stringForKey:@"kDialogContextKey"];
  v17 = 0;
  v6 = [requestCopy BOOLForKey:@"kDialogSelectionKey" keyPresent:&v17];
  if (v5 && v17 == 1)
  {
    v7 = v6;
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v11 = "canceled";
      *buf = 138543874;
      v19 = v10;
      if (v7)
      {
        v11 = "accepted";
      }

      v20 = 2112;
      v21 = v5;
      v22 = 2080;
      v23 = v11;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Received message from peer device to dismiss dialog with context %@, selection: %s", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v12 = +[HMDUIDialogPresenter sharedUIDialogPresenter];
    workQueue = [(HMDHomeManager *)self workQueue];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __46__HMDHomeManager__handleDismissDialogRequest___block_invoke;
    v15[3] = &unk_27868A728;
    v16 = v5;
    [v12 dismissPendingDialogDueToPeerDeviceSelection:v7 context:v16 queue:workQueue completionHandler:v15];
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __46__HMDHomeManager__handleDismissDialogRequest___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = HMFGetLogIdentifier();
    v5 = *(a1 + 32);
    v7 = 138543618;
    v8 = v4;
    v9 = 2112;
    v10 = v5;
    _os_log_impl(&dword_229538000, v3, OS_LOG_TYPE_DEFAULT, "%{public}@Dismissed dialog with context %@", &v7, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *MEMORY[0x277D85DE8];
}

- (void)_handleDismissBulletinRequest:(id)request
{
  v40 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = [requestCopy stringForKey:@"kBulletinRecordIDKey"];
  if (v5)
  {
    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v37 = v8;
      v38 = 2112;
      v39 = v5;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received message from peer device to dismiss bulletin with record ID %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    v9 = +[HMDBulletinBoard sharedBulletinBoard];
    [v9 removeBulletinWithRecordID:v5];

    v10 = [requestCopy numberForKey:@"kInvitationStateKey"];
    v11 = v10;
    if (!v10)
    {
      goto LABEL_19;
    }

    unsignedIntegerValue = [v10 unsignedIntegerValue];
    v13 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v5];
    incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
    v15 = [incomingInvitations hmf_firstObjectWithValue:v13 forKeyPath:@"identifier"];

    if (v15)
    {
      if ((unsignedIntegerValue - 6) < 2 || unsignedIntegerValue == 4)
      {
        [(HMDHomeManager *)self _postIncomingInvitationStateChangedNotification:v15 newInvitationState:unsignedIntegerValue];
        [(HMDHomeManager *)self _removeIncomingInvitation:v15];
LABEL_18:
        [(HMDHomeManager *)self _updateIncomingInvitesPresent];

LABEL_19:
        goto LABEL_20;
      }

      if (unsignedIntegerValue == 3)
      {
        v16 = objc_alloc(MEMORY[0x277CCAD78]);
        v17 = [requestCopy stringForKey:*MEMORY[0x277CD0640]];
        v18 = [v16 initWithUUIDString:v17];

        [(HMDHomeManager *)self _postIncomingInvitationStateChangedNotification:v15 newInvitationState:5];
        uuidsOfRemovedHomes = [(HMDHomeManager *)self uuidsOfRemovedHomes];
        v20 = [uuidsOfRemovedHomes containsObject:v18];

        if (v20)
        {
          uuidsOfRemovedHomes2 = [(HMDHomeManager *)self uuidsOfRemovedHomes];
          [uuidsOfRemovedHomes2 removeObject:v18];

          v22 = objc_autoreleasePoolPush();
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            [v18 UUIDString];
            v25 = v34 = v22;
            *buf = 138543618;
            v37 = v24;
            v38 = 2112;
            v39 = v25;
            _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);

            v22 = v34;
          }

          objc_autoreleasePoolPop(v22);
        }

        v26 = [(HMDHomeManager *)self _homeWithUUID:v18];
        owner = [v26 owner];
        account = [owner account];
        [account senderCorrelationIdentifier];
        v29 = v35 = v18;

        [(HMDHomeManager *)self _stopTrackingRemovedHomeUserMergeId:v29];
        goto LABEL_18;
      }
    }

    v30 = objc_autoreleasePoolPush();
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543618;
      v37 = v32;
      v38 = 2112;
      v39 = v5;
      _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_DEFAULT, "%{public}@Dismiss bulletin request received with no matching invitation: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v30);
    goto LABEL_18;
  }

LABEL_20:

  v33 = *MEMORY[0x277D85DE8];
}

- (void)dismissBulletinOnAllMyTransientDevicesWithContext:(id)context
{
  v21 = *MEMORY[0x277D85DE8];
  contextCopy = context;
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  account = [appleAccountManager account];
  handles = [account handles];
  firstObject = [handles firstObject];

  if (firstObject)
  {
    v9 = [HMDRemoteAccountMessageDestination alloc];
    uuid = [(HMDHomeManager *)self uuid];
    v11 = [(HMDRemoteAccountMessageDestination *)v9 initWithTarget:uuid handle:firstObject multicast:1];

    v12 = [MEMORY[0x277D0F818] internalMessageWithName:@"kDismissBulletinInternalRequestKey" destination:v11 messagePayload:contextCopy];
    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    [messageDispatcher sendMessage:v12];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    selfCopy = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v17 = HMFGetLogIdentifier();
      v19 = 138543362;
      v20 = v17;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot find own account handle to send message to dismiss bulletin on all devices", &v19, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleAccessHomeInviteFromAccount:(id)account mergeID:(id)d idsInvitationIdentifier:(id)identifier payload:(id)payload messageResponseHandler:(id)handler
{
  v40 = *MEMORY[0x277D85DE8];
  accountCopy = account;
  dCopy = d;
  identifierCopy = identifier;
  payloadCopy = payload;
  handlerCopy = handler;
  v17 = [dCopy length];
  if (accountCopy && v17)
  {
    v18 = [HMDHomeInviteLogEvent updateWithState:1 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
    if (v18)
    {
      logEventSubmitter = [(HMDHomeManager *)self logEventSubmitter];
      [logEventSubmitter submitLogEvent:v18];
    }

    v35 = 0;
    v20 = [(HMDHomeManager *)self shouldAcceptInvitationPayload:payloadCopy error:&v35];
    v21 = v35;
    if (v20)
    {
      aBlock[0] = MEMORY[0x277D85DD0];
      aBlock[1] = 3221225472;
      aBlock[2] = __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke;
      aBlock[3] = &unk_278685E98;
      aBlock[4] = self;
      v30 = payloadCopy;
      v34 = handlerCopy;
      v22 = accountCopy;
      v31 = v22;
      v32 = dCopy;
      v33 = identifierCopy;
      v23 = _Block_copy(aBlock);
      [v22 isOfKnownPersonWithCompletion:v23];
    }

    else if (handlerCopy)
    {
      (*(handlerCopy + 2))(handlerCopy, v21, 0);
    }
  }

  else
  {
    v24 = objc_autoreleasePoolPush();
    selfCopy = self;
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      v27 = HMFGetLogIdentifier();
      *buf = 138543618;
      v37 = v27;
      v38 = 2048;
      v39 = [dCopy length];
      _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation because of invalid mergeID: %lu or nil account", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v24);
    v18 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    if (handlerCopy)
    {
      (*(handlerCopy + 2))(handlerCopy, v18, 0);
    }
  }

  v28 = *MEMORY[0x277D85DE8];
}

void __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke(id *a1, char a2)
{
  v4 = a1 + 4;
  v5 = [a1[4] workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke_2;
  block[3] = &unk_278685E70;
  v6 = a1[5];
  v17 = a2;
  *&v7 = v6;
  *(&v7 + 1) = *v4;
  v11 = v7;
  v16 = a1[9];
  v8 = a1[6];
  v9 = a1[7];
  *&v10 = v8;
  *(&v10 + 1) = v9;
  v13 = v11;
  v14 = v10;
  v15 = a1[8];
  dispatch_async(v5, block);
}

void __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke_2(uint64_t a1)
{
  v38 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) hmf_stringForKey:*MEMORY[0x277CD23D0]];
  if (*(a1 + 80) & 1) != 0 || ([*(a1 + 40) shouldAcceptInvitationWithHomeName:v2])
  {
    v3 = *(a1 + 48);
    v4 = *(a1 + 56);
    v5 = *(a1 + 64);
    v7 = *(a1 + 32);
    v6 = *(a1 + 40);
    v33 = 0;
    v8 = [v6 _trackIncomingInvitationFromAccount:v3 mergeID:v4 idsInvitationIdentifier:v5 payload:v7 invitationState:2 error:&v33];
    v9 = v33;
    v10 = [*(a1 + 32) hmf_BOOLForKey:@"HMDHomeSuppressInviteNotificationKey"];
    if (v9 && (v11 = *(a1 + 72)) != 0)
    {
      (*(v11 + 16))(*(a1 + 72), v9, 0);
    }

    else if (v8)
    {
      if (v10)
      {
        v12 = objc_autoreleasePoolPush();
        v13 = *(a1 + 40);
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          *buf = 138543362;
          v35 = v15;
          _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Suppressing home invite notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v12);
        v16 = [HMDHomeInviteLogEvent updateWithState:3 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
        if (v16)
        {
          v17 = [*(a1 + 40) logEventSubmitter];
          [v17 submitLogEvent:v16];
        }
      }

      else
      {
        v16 = +[HMDBulletinBoard sharedBulletinBoard];
        v24 = *(a1 + 80);
        v25 = objc_autoreleasePoolPush();
        v26 = *(a1 + 40);
        v27 = HMFGetOSLogHandle();
        v28 = os_log_type_enabled(v27, OS_LOG_TYPE_INFO);
        if (v24 == 1)
        {
          if (v28)
          {
            v29 = HMFGetLogIdentifier();
            *buf = 138543362;
            v35 = v29;
            _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Inserting notification because inviter is a known person.", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v25);
          v30 = [v16 insertBulletinForIncomingInvitation:v8];
        }

        else
        {
          if (v28)
          {
            v31 = HMFGetLogIdentifier();
            *buf = 138543362;
            v35 = v31;
            _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Suppressing home invite notification because inviter is not a known person.", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v25);
        }

        [v16 refreshHomeBadgeNumber];
      }
    }

    goto LABEL_27;
  }

  v18 = objc_autoreleasePoolPush();
  v19 = *(a1 + 40);
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v35 = v21;
    v36 = 2112;
    v37 = v2;
    _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload due to invalid home name: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v18);
  v9 = [HMDHomeInviteLogEvent updateWithState:2 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
  if (v9)
  {
    v22 = [*(a1 + 40) logEventSubmitter];
    [v22 submitLogEvent:v9];
  }

  v23 = *(a1 + 72);
  if (v23)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    (*(v23 + 16))(v23, v8, 0);
LABEL_27:
  }

  v32 = *MEMORY[0x277D85DE8];
}

- (BOOL)shouldAcceptInvitationPayload:(id)payload error:(id *)error
{
  v44 = *MEMORY[0x277D85DE8];
  payloadCopy = payload;
  v7 = [payloadCopy hmf_stringForKey:*MEMORY[0x277CD23D0]];
  v8 = [payloadCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v9 = v8;
  if (v7)
  {
    v10 = v8 == 0;
  }

  else
  {
    v10 = 1;
  }

  if (!v10)
  {
    v16 = [(HMDHomeManager *)self _homeWithUUID:v8];
    v17 = v16;
    if (v16)
    {
      v18 = objc_autoreleasePoolPush();
      selfCopy = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v21 = HMFGetLogIdentifier();
        v38 = 138543618;
        v39 = v21;
        v40 = 2112;
        v41 = v9;
        _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because home already exists for homeUUID: %@", &v38, 0x16u);
      }

      objc_autoreleasePoolPop(v18);
      if (error)
      {
        v22 = 1;
LABEL_27:
        [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:v22 userInfo:0];
        *error = v15 = 0;
        goto LABEL_29;
      }
    }

    else
    {
      v23 = +[HMDDeviceCapabilities deviceCapabilities];
      supportsHomeInvitation = [v23 supportsHomeInvitation];

      if (supportsHomeInvitation)
      {
        homes = [(HMDHomeManager *)self homes];
        v26 = [homes count];
        v27 = maximumHomes;

        if (v26 < v27)
        {
          v15 = 1;
LABEL_29:

          goto LABEL_30;
        }

        v32 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v34 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
        {
          v35 = HMFGetLogIdentifier();
          v38 = 138543362;
          v39 = v35;
          _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because invitee has already maximum allowed homes", &v38, 0xCu);
        }

        objc_autoreleasePoolPop(v32);
        if (error)
        {
          v22 = 49;
          goto LABEL_27;
        }
      }

      else
      {
        v28 = objc_autoreleasePoolPush();
        selfCopy3 = self;
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
        {
          v31 = HMFGetLogIdentifier();
          v38 = 138543362;
          v39 = v31;
          _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because device does not support invitations", &v38, 0xCu);
        }

        objc_autoreleasePoolPop(v28);
        if (error)
        {
          v22 = 10;
          goto LABEL_27;
        }
      }
    }

    v15 = 0;
    goto LABEL_29;
  }

  v11 = objc_autoreleasePoolPush();
  selfCopy4 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
  {
    v14 = HMFGetLogIdentifier();
    v38 = 138543874;
    v39 = v14;
    v40 = 2112;
    v41 = v7;
    v42 = 2112;
    v43 = v9;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because homeName: %@ or homeUUID: %@ is missing", &v38, 0x20u);
  }

  objc_autoreleasePoolPop(v11);
  if (error)
  {
    [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    *error = v15 = 0;
  }

  else
  {
    v15 = 0;
  }

LABEL_30:

  v36 = *MEMORY[0x277D85DE8];
  return v15;
}

- (void)_handleAccessHomeInvite:(id)invite
{
  v33 = *MEMORY[0x277D85DE8];
  inviteCopy = invite;
  remoteSourceID = [inviteCopy remoteSourceID];
  if (remoteSourceID)
  {
    remoteSourceDevice = [inviteCopy remoteSourceDevice];
    account = [remoteSourceDevice account];

    if (account)
    {
      messagePayload = [inviteCopy messagePayload];
      v9 = [messagePayload hmf_stringForKey:*MEMORY[0x277CD23D0]];

      if (v9)
      {
        v24[0] = MEMORY[0x277D85DD0];
        v24[1] = 3221225472;
        v24[2] = __42__HMDHomeManager__handleAccessHomeInvite___block_invoke;
        v24[3] = &unk_278685E48;
        v24[4] = self;
        v25 = account;
        v26 = v9;
        [v25 isOfKnownPersonWithCompletion:v24];
      }

      else
      {
        v18 = objc_autoreleasePoolPush();
        selfCopy = self;
        v20 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
        {
          v21 = HMFGetLogIdentifier();
          name = [account name];
          *buf = 138543874;
          v28 = v21;
          v29 = 2160;
          v30 = 1752392040;
          v31 = 2112;
          v32 = name;
          _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_ERROR, "%{public}@Dropping incompatible HH1 invitation from %{mask.hash}@ due to missing home name", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v18);
      }
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        *buf = 138543362;
        v28 = v17;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Dropping incompatible HH1 invitation due account resolve failure", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v14);
    }
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v28 = v13;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Dropping incompatible HH1 invitation due missing fromID", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
  }

  v23 = *MEMORY[0x277D85DE8];
}

void __42__HMDHomeManager__handleAccessHomeInvite___block_invoke(uint64_t a1, int a2)
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [*(a1 + 40) name];
    v13 = 138543874;
    v14 = v7;
    v15 = 2160;
    v16 = 1752392040;
    v17 = 2112;
    v18 = v8;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Posting bulletin for incompatible HH1 invitation from %{mask.hash}@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  v9 = +[HMDBulletinBoard sharedBulletinBoard];
  v10 = [*(a1 + 40) name];
  if (a2)
  {
    v11 = *(a1 + 48);
  }

  else
  {
    v11 = 0;
  }

  [v9 insertBulletinForIncompatibleInvitationFromInviterName:v10 homeName:v11];

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_handleAddRemoteAccessRequest:(id)request
{
  v3 = MEMORY[0x277CCA9B8];
  requestCopy = request;
  v5 = [v3 hmErrorWithCode:48];
  [requestCopy respondWithError:v5];
}

- (void)_handleDoYouSeeUnpairedAccessories:(id)accessories
{
  v3 = MEMORY[0x277CCA9B8];
  accessoriesCopy = accessories;
  v5 = [v3 hmErrorWithCode:48];
  [accessoriesCopy respondWithError:v5];
}

- (BOOL)_findAnyAccessoryWithIdentities:(id)identities inAccessoryServers:(id)servers
{
  v20 = *MEMORY[0x277D85DE8];
  identitiesCopy = identities;
  serversCopy = servers;
  if ([identitiesCopy count] && objc_msgSend(serversCopy, "count"))
  {
    v17 = 0u;
    v18 = 0u;
    v15 = 0u;
    v16 = 0u;
    v7 = identitiesCopy;
    v8 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
    if (v8)
    {
      v9 = *v16;
      while (2)
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v16 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = [MEMORY[0x277CFE9F8] serverIdentifierWithUniqueIdentifier:{*(*(&v15 + 1) + 8 * i), v15}];
          v12 = [serversCopy containsObject:v11];

          if (v12)
          {
            LOBYTE(v8) = 1;
            goto LABEL_14;
          }
        }

        v8 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
        if (v8)
        {
          continue;
        }

        break;
      }
    }

LABEL_14:
  }

  else
  {
    LOBYTE(v8) = 0;
  }

  v13 = *MEMORY[0x277D85DE8];
  return v8;
}

- (void)_startScanningForAccessories:(id)accessories
{
  v24 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  v5 = [accessoriesCopy stringForKey:*MEMORY[0x277CD0640]];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    name = [accessoriesCopy name];
    v18 = 138543874;
    v19 = v8;
    v20 = 2112;
    v21 = v5;
    v22 = 2112;
    v23 = name;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received request to determine if we are at home %@ for message %@", &v18, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  accessoryFinderTimer = [(HMDHomeManager *)self accessoryFinderTimer];

  if (!accessoryFinderTimer)
  {
    [(HMDHomeManager *)self _startAccessoryFinderTimer];
    accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
    [accessoryBrowserInternal stopDiscoveringAccessories];

    accessoryBrowserInternal2 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [accessoryBrowserInternal2 startDiscoveringAccessories];

    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v15;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Starting timer to discover all accessories", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  pendingResponsesForAccessoryFinder = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  [pendingResponsesForAccessoryFinder addObject:accessoriesCopy];

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_processAnyPendingRequestsForRemoteAccess:(BOOL)access
{
  v76 = *MEMORY[0x277D85DE8];
  v4 = [MEMORY[0x277CBEB58] set];
  v62 = 0u;
  v63 = 0u;
  v64 = 0u;
  v65 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v62 objects:v75 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v63;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v63 != v8)
        {
          objc_enumerationMutation(homes);
        }

        hapAccessoryServerIdentifiers = [*(*(&v62 + 1) + 8 * i) hapAccessoryServerIdentifiers];
        [v4 unionSet:hapAccessoryServerIdentifiers];
      }

      v7 = [homes countByEnumeratingWithState:&v62 objects:v75 count:16];
    }

    while (v7);
  }

  v11 = [v4 mutableCopy];
  accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
  discoveredAccessoryServers = [accessoryBrowserInternal discoveredAccessoryServers];
  [v11 unionSet:discoveredAccessoryServers];

  array = [MEMORY[0x277CBEB18] array];
  v58 = 0u;
  v59 = 0u;
  v60 = 0u;
  v61 = 0u;
  obj = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  v52 = v11;
  v57 = [obj countByEnumeratingWithState:&v58 objects:v74 count:16];
  if (v57)
  {
    v56 = *v59;
    v49 = *MEMORY[0x277CCFD28];
    v50 = *MEMORY[0x277CD0640];
    selfCopy = self;
    do
    {
      for (j = 0; j != v57; ++j)
      {
        if (*v59 != v56)
        {
          objc_enumerationMutation(obj);
        }

        v15 = *(*(&v58 + 1) + 8 * j);
        name = [v15 name];
        v17 = [name isEqualToString:@"kDoYouSeeUnpairedAccessoriesKey"];

        v18 = v11;
        if (v17 & 1) != 0 || ([v15 name], v19 = objc_claimAutoreleasedReturnValue(), v20 = objc_msgSend(v19, "isEqualToString:", @"kAreYouAtHomeRequestKey"), v19, v18 = v4, (v20))
        {
          v21 = v18;
          responseHandler3 = [v15 arrayForKey:@"kAccessoryIdentitiesKey"];
          v23 = [(HMDHomeManager *)self _findAnyAccessoryWithIdentities:responseHandler3 inAccessoryServers:v21];
          if (v23 || access)
          {
            v27 = v4;
            v72[0] = @"kAtHomeStateKey";
            v28 = [MEMORY[0x277CCABB0] numberWithBool:v23];
            v73[0] = v28;
            v72[1] = @"kHomedVersionKey";
            v29 = homedVersion;
            v73[1] = v29;
            v72[2] = @"kDeviceNameKey";
            v30 = deviceName();
            v73[2] = v30;
            v31 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v73 forKeys:v72 count:3];

            v32 = [v15 stringForKey:v50];
            v33 = objc_autoreleasePoolPush();
            v34 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
            {
              v35 = HMFGetLogIdentifier();
              *buf = 138543874;
              v67 = v35;
              v68 = 2112;
              v69 = v31;
              v70 = 2112;
              v71 = v32;
              _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@Sending response %@ for home %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v33);
            responseHandler = [v15 responseHandler];
            (responseHandler)[2](responseHandler, 0, v31);

            [array addObject:v15];
            v4 = v27;
            self = selfCopy;
            v11 = v52;
          }

          else
          {
            v24 = objc_autoreleasePoolPush();
            v25 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
            {
              v26 = HMFGetLogIdentifier();
              *buf = 138543618;
              v67 = v26;
              v68 = 2112;
              v69 = v21;
              _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Did not find any of the accessories in the list %@ but there is a timer pending, continuing to scan", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v24);
          }

          goto LABEL_27;
        }

        [array addObject:v15];
        v37 = objc_autoreleasePoolPush();
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          v39 = HMFGetLogIdentifier();
          name2 = [v15 name];
          *buf = 138543618;
          v67 = v39;
          v68 = 2112;
          v69 = name2;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_DEFAULT, "%{public}@There is an invalid message in the pending responses for accessory finder %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v37);
        responseHandler2 = [v15 responseHandler];

        if (responseHandler2)
        {
          v21 = [MEMORY[0x277CCA9B8] errorWithDomain:v49 code:3 userInfo:0];
          responseHandler3 = [v15 responseHandler];
          (responseHandler3)[2](responseHandler3, v21, 0);
LABEL_27:

          continue;
        }
      }

      v57 = [obj countByEnumeratingWithState:&v58 objects:v74 count:16];
    }

    while (v57);
  }

  pendingResponsesForAccessoryFinder = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  [pendingResponsesForAccessoryFinder removeObjectsInArray:array];

  pendingResponsesForAccessoryFinder2 = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  v44 = [pendingResponsesForAccessoryFinder2 count];

  if (!v44)
  {
    v45 = objc_autoreleasePoolPush();
    v46 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
    {
      v47 = HMFGetLogIdentifier();
      *buf = 138543362;
      v67 = v47;
      _os_log_impl(&dword_229538000, v46, OS_LOG_TYPE_DEFAULT, "%{public}@Processed all requests for accessory scan for remote access, stopping scan timer", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v45);
    [(HMDHomeManager *)self _cancelAccessoryFinderTimer];
  }

  v48 = *MEMORY[0x277D85DE8];
}

- (void)processAnyPendingRequestsForRemoteAccess
{
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __58__HMDHomeManager_processAnyPendingRequestsForRemoteAccess__block_invoke;
  block[3] = &unk_27868A728;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)_cancelAccessoryFinderTimer
{
  v13 = *MEMORY[0x277D85DE8];
  accessoryFinderTimer = [(HMDHomeManager *)self accessoryFinderTimer];

  if (accessoryFinderTimer)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v6 = HMFGetLogIdentifier();
      v11 = 138543362;
      v12 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Cancelling accessory finder timer", &v11, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    accessoryFinderTimer2 = [(HMDHomeManager *)self accessoryFinderTimer];
    dispatch_source_cancel(accessoryFinderTimer2);

    [(HMDHomeManager *)self setAccessoryFinderTimer:0];
    accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
    [accessoryBrowserInternal stopDiscoveringAccessories];

    accessoryBrowserInternal2 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [accessoryBrowserInternal2 setManagerDelegate:0];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_startAccessoryFinderTimerExpired
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Timer expired, and stopping request to discover accessories", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [(HMDHomeManager *)self _processAnyPendingRequestsForRemoteAccess:1];
  accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
  [accessoryBrowserInternal stopDiscoveringAccessories];

  accessoryBrowserInternal2 = [(HMDHomeManager *)self accessoryBrowserInternal];
  [accessoryBrowserInternal2 setManagerDelegate:0];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_startAccessoryFinderTimer
{
  workQueue = [(HMDHomeManager *)self workQueue];
  v4 = dispatch_source_create(MEMORY[0x277D85D38], 0, 0, workQueue);
  [(HMDHomeManager *)self setAccessoryFinderTimer:v4];

  accessoryFinderTimer = [(HMDHomeManager *)self accessoryFinderTimer];
  v6 = dispatch_time(0, 10000000000);
  dispatch_source_set_timer(accessoryFinderTimer, v6, 0xFFFFFFFFFFFFFFFFLL, 0x2FAF080uLL);

  objc_initWeak(&location, self);
  accessoryFinderTimer2 = [(HMDHomeManager *)self accessoryFinderTimer];
  v10 = MEMORY[0x277D85DD0];
  v11 = 3221225472;
  v12 = __44__HMDHomeManager__startAccessoryFinderTimer__block_invoke;
  v13 = &unk_278686B80;
  objc_copyWeak(&v14, &location);
  dispatch_source_set_event_handler(accessoryFinderTimer2, &v10);

  v8 = [(HMDHomeManager *)self accessoryFinderTimer:v10];
  dispatch_resume(v8);

  accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
  [accessoryBrowserInternal setManagerDelegate:self];

  objc_destroyWeak(&v14);
  objc_destroyWeak(&location);
}

void __44__HMDHomeManager__startAccessoryFinderTimer__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = WeakRetained;
    [WeakRetained _startAccessoryFinderTimerExpired];
    WeakRetained = v2;
  }
}

- (void)networkMonitorIsUnreachable:(id)unreachable
{
  unreachableCopy = unreachable;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __46__HMDHomeManager_networkMonitorIsUnreachable___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = unreachableCopy;
  v6 = unreachableCopy;
  dispatch_async(workQueue, v7);
}

void __46__HMDHomeManager_networkMonitorIsUnreachable___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) reachabilityMonitor];
  v3 = [v2 isEqual:*(a1 + 40)];

  if (v3)
  {
    v4 = *(a1 + 32);

    [v4 _reachabilityMonitorChanged:0];
  }
}

- (void)networkMonitorIsReachable:(id)reachable
{
  reachableCopy = reachable;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __44__HMDHomeManager_networkMonitorIsReachable___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = reachableCopy;
  v6 = reachableCopy;
  dispatch_async(workQueue, v7);
}

void __44__HMDHomeManager_networkMonitorIsReachable___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) reachabilityMonitor];
  v3 = [v2 isEqual:*(a1 + 40)];

  if (v3)
  {
    v4 = *(a1 + 32);

    [v4 _reachabilityMonitorChanged:1];
  }
}

- (void)_monitorReachability
{
  v29 = *MEMORY[0x277D85DE8];
  reachabilityMonitor = [(HMDHomeManager *)self reachabilityMonitor];

  if (!reachabilityMonitor)
  {
    v4 = objc_autoreleasePoolPush();
    selfCopy = self;
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v7;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Creating network reachability monitor", &v25, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    v8 = [objc_alloc(MEMORY[0x277D0F868]) initWithNetAddress:0];
    [(HMDHomeManager *)selfCopy setReachabilityMonitor:v8];

    reachabilityMonitor2 = [(HMDHomeManager *)selfCopy reachabilityMonitor];
    [reachabilityMonitor2 setDelegate:selfCopy];

    reachabilityMonitor3 = [(HMDHomeManager *)selfCopy reachabilityMonitor];
    isReachable = [reachabilityMonitor3 isReachable];

    if (isReachable)
    {
      [(HMDHomeManager *)selfCopy _reachabilityMonitorChanged:1];
    }
  }

  cloudReachabilityMonitor = [(HMDHomeManager *)self cloudReachabilityMonitor];

  if (!cloudReachabilityMonitor)
  {
    mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
    v14 = [mEMORY[0x277D0F8D0] preferenceForKey:@"cloudReachabilityMonitorHostname"];
    stringValue = [v14 stringValue];

    if (stringValue)
    {
      v16 = stringValue;
    }

    else
    {
      v16 = @"gateway.icloud.com";
    }

    v17 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      v25 = 138543618;
      v26 = v20;
      v27 = 2112;
      v28 = v16;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Creating cloud network reachability monitor for host: %@", &v25, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v21 = [objc_alloc(MEMORY[0x277D0F858]) initWithHostname:v16];
    v22 = [objc_alloc(MEMORY[0x277D0F868]) initWithNetAddress:v21];
    [(HMDHomeManager *)selfCopy2 setCloudReachabilityMonitor:v22];

    cloudReachabilityMonitor2 = [(HMDHomeManager *)selfCopy2 cloudReachabilityMonitor];
    [cloudReachabilityMonitor2 setDelegate:selfCopy2];
  }

  v24 = *MEMORY[0x277D85DE8];
}

- (id)eventRouterServerDiagnosticInfo
{
  currentAccessory = [(HMDHomeManager *)self currentAccessory];
  home = [currentAccessory home];
  eventRouterServerDiagnosticInfo = [home eventRouterServerDiagnosticInfo];

  return eventRouterServerDiagnosticInfo;
}

- (id)currentAccessory
{
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = _accessoryOfCurrentDevice;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  return v3;
}

- (void)handleVendorInfoUpdated:(id)updated
{
  updatedCopy = updated;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = updatedCopy;
  selfCopy = self;
  v6 = updatedCopy;
  dispatch_async(workQueue, v7);
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  v10 = [*(a1 + 32) userInfo];
  v11 = [v10 hmf_arrayForKey:@"ChangedManufacturer"];
  if (v11)
  {
    v1 = dispatch_group_create();
    v20[0] = 0;
    v20[1] = v20;
    v20[2] = 0x2020000000;
    v21 = 0;
    v16 = 0u;
    v17 = 0u;
    v18 = 0u;
    v19 = 0u;
    v2 = [*(a1 + 40) homes];
    v3 = [v2 countByEnumeratingWithState:&v16 objects:v22 count:16];
    if (v3)
    {
      v4 = *v17;
      do
      {
        v5 = 0;
        do
        {
          if (*v17 != v4)
          {
            objc_enumerationMutation(v2);
          }

          v6 = *(*(&v16 + 1) + 8 * v5);
          dispatch_group_enter(v1);
          v13[0] = MEMORY[0x277D85DD0];
          v13[1] = 3221225472;
          v13[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_2;
          v13[3] = &unk_278685E20;
          v15 = v20;
          v14 = v1;
          [v6 notifyClientOfVendorInfoUpdatedForManufacturers:v11 withCompletion:v13];

          ++v5;
        }

        while (v3 != v5);
        v3 = [v2 countByEnumeratingWithState:&v16 objects:v22 count:16];
      }

      while (v3);
    }

    v7 = [*(a1 + 40) workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_3;
    block[3] = &unk_27868A688;
    block[4] = *(a1 + 40);
    block[5] = v20;
    dispatch_group_notify(v1, v7, block);

    _Block_object_dispose(v20, 8);
  }

  v8 = *MEMORY[0x277D85DE8];
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_2(uint64_t a1, int a2)
{
  if (a2)
  {
    *(*(*(a1 + 40) + 8) + 24) = 1;
  }

  dispatch_group_leave(*(a1 + 32));
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_3(uint64_t a1)
{
  if (*(*(*(a1 + 40) + 8) + 24) == 1)
  {
    v1 = *(a1 + 32);
    v2 = [v1 uuid];
    [v1 _updateGenerationCounterWithReason:@"VendorInfoUpdated" sourceUUID:v2 shouldNotifyClients:0];
  }

  v3 = +[HMDBulletinBoard sharedBulletinBoard];
  [v3 refreshHomeBadgeNumber];
}

- (void)_handleElectDeviceForIDSSession:(id)session
{
  v40 = *MEMORY[0x277D85DE8];
  sessionCopy = session;
  messagePayload = [sessionCopy messagePayload];
  v6 = [messagePayload hmf_dictionaryForKey:@"kRequiredCapabilitiesKey"];

  messagePayload2 = [sessionCopy messagePayload];
  v8 = [messagePayload2 hmf_dictionaryForKey:@"kRequestedCapabilitiesKey"];

  if (isWatch())
  {
    v9 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEBUG))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v12;
      v13 = "%{public}@### Watch is current device so ignoring IDS Elect";
      v14 = v11;
      v15 = OS_LOG_TYPE_DEBUG;
LABEL_11:
      _os_log_impl(&dword_229538000, v14, v15, v13, buf, 0xCu);

      goto LABEL_12;
    }

    goto LABEL_12;
  }

  if (![(HMDHomeManager *)self _capabilitiesAreSupported:v6])
  {
    v9 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v12;
      v13 = "%{public}@### All capabilities are not met so ignoring IDS Elect";
      v14 = v11;
      v15 = OS_LOG_TYPE_INFO;
      goto LABEL_11;
    }

LABEL_12:

    objc_autoreleasePoolPop(v9);
    goto LABEL_17;
  }

  homes = [(HMDHomeManager *)self homes];
  v32[0] = MEMORY[0x277D85DD0];
  v32[1] = 3221225472;
  v32[2] = __50__HMDHomeManager__handleElectDeviceForIDSSession___block_invoke;
  v32[3] = &unk_278685B20;
  v17 = sessionCopy;
  v33 = v17;
  v18 = [homes hmf_objectPassingTest:v32];

  if (v18)
  {
    v19 = [(HMDHomeManager *)self _scrubRequestedCapabilities:v8 fromMessage:v17];
    v20 = [(HMDHomeManager *)self _prepareAnswerForRequestedCapabilities:v19];

    v21 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
    {
      v24 = HMFGetLogIdentifier();
      [v17 shortDescription];
      v25 = v31 = v21;
      *buf = 138543874;
      v35 = v24;
      v36 = 2114;
      v37 = v25;
      v38 = 2112;
      v39 = v20;
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Answering %{public}@ request with response: %@", buf, 0x20u);

      v21 = v31;
    }

    objc_autoreleasePoolPop(v21);
    [v17 respondWithPayload:v20];
  }

  else
  {
    v26 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
    {
      v29 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v29;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_ERROR, "%{public}@### Message user not allowed to perform this request", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v26);
    v20 = 0;
  }

LABEL_17:
  v30 = *MEMORY[0x277D85DE8];
}

BOOL __50__HMDHomeManager__handleElectDeviceForIDSSession___block_invoke(uint64_t a1, uint64_t a2)
{
  v2 = [*(a1 + 32) userForHome:a2];
  v3 = v2 != 0;

  return v3;
}

- (id)_scrubRequestedCapabilities:(id)capabilities fromMessage:(id)message
{
  v23 = *MEMORY[0x277D85DE8];
  capabilitiesCopy = capabilities;
  messageCopy = message;
  v8 = [capabilitiesCopy mutableCopy];
  v9 = [capabilitiesCopy objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];

  if (v9)
  {
    v10 = *MEMORY[0x277CD0640];
    v11 = [capabilitiesCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
    v12 = [(HMDHomeManager *)self _homeWithUUID:v11];
    if (v12)
    {
      v13 = [messageCopy userForHome:v12];

      if (!v13)
      {
        v14 = objc_autoreleasePoolPush();
        selfCopy = self;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v17 = HMFGetLogIdentifier();
          v21 = 138543362;
          v22 = v17;
          _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Purging home info request for capabilities from user that is not a part of the home", &v21, 0xCu);
        }

        objc_autoreleasePoolPop(v14);
        [v8 removeObjectForKey:v10];
        [v8 removeObjectForKey:@"kHomeConfigurationVersionKey"];
      }
    }
  }

  v18 = [v8 copy];

  v19 = *MEMORY[0x277D85DE8];

  return v18;
}

- (id)_prepareAnswerForRequestedCapabilities:(id)capabilities
{
  v35 = *MEMORY[0x277D85DE8];
  capabilitiesCopy = capabilities;
  v5 = objc_alloc_init(MEMORY[0x277CBEB38]);
  v6 = +[HMDHAPMetadata getSharedInstance];
  v7 = [capabilitiesCopy objectForKeyedSubscript:@"kDeviceClassTypeKey"];

  if (v7)
  {
    v8 = getDeviceClass();
    [v5 setObject:v8 forKeyedSubscript:@"kDeviceClassTypeKey"];
  }

  v9 = [capabilitiesCopy objectForKeyedSubscript:@"kHomedVersionKey"];

  if (v9)
  {
    v10 = homedVersion;
    [v5 setObject:v10 forKeyedSubscript:@"kHomedVersionKey"];
  }

  v11 = [capabilitiesCopy objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];

  if (v11)
  {
    v12 = *MEMORY[0x277CD0640];
    v13 = [capabilitiesCopy hmf_UUIDForKey:*MEMORY[0x277CD0640]];
    currentHomeConfigurations = [(HMDHomeManager *)self currentHomeConfigurations];
    v15 = [currentHomeConfigurations objectForKeyedSubscript:v13];

    if (v13 && v15)
    {
      uUIDString = [v13 UUIDString];
      [v5 setObject:uUIDString forKeyedSubscript:v12];

      [v5 setObject:v15 forKeyedSubscript:@"kHomeConfigurationVersionKey"];
    }

    else
    {
      v17 = objc_autoreleasePoolPush();
      selfCopy = self;
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        v29 = 138543874;
        v30 = v20;
        v31 = 2114;
        v32 = v13;
        v33 = 2114;
        v34 = v15;
        _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Home UUID %{public}@ or Configuration Version %{public}@ is nil", &v29, 0x20u);
      }

      objc_autoreleasePoolPop(v17);
    }
  }

  if (v6)
  {
    version = [v6 version];
    [v5 setObject:version forKeyedSubscript:@"kMetadataInfoVersionKey"];

    schemaVersion = [v6 schemaVersion];
    [v5 setObject:schemaVersion forKeyedSubscript:@"kMetadataInfoSchemaVersionKey"];

    v23 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v6, "incomplete") ^ 1}];
    [v5 setObject:v23 forKeyedSubscript:@"kMetadataInfoCompletenessKey"];
  }

  v24 = [capabilitiesCopy objectForKeyedSubscript:@"kHomedSupportedFeaturesKey"];

  if (v24)
  {
    v25 = homedSupportedFeatures;
    [v5 setObject:v25 forKeyedSubscript:@"kHomedSupportedFeaturesKey"];
  }

  v26 = [v5 copy];

  v27 = *MEMORY[0x277D85DE8];

  return v26;
}

- (BOOL)_capabilitiesAreSupported:(id)supported
{
  v64 = *MEMORY[0x277D85DE8];
  supportedCopy = supported;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v58 = v8;
    v59 = 2114;
    v60 = supportedCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Checking for capabilities %{public}@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v54 = 0u;
  v55 = 0u;
  v52 = 0u;
  v53 = 0u;
  v9 = supportedCopy;
  v10 = [v9 countByEnumeratingWithState:&v52 objects:v63 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v53;
    v47 = *MEMORY[0x277CD0640];
    v45 = *v53;
    v46 = selfCopy;
    while (2)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v53 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v52 + 1) + 8 * i);
        if ([v14 isEqualToString:{@"kDeviceClassTypeKey", v45, v46}])
        {
          v15 = [v9 hmf_stringForKey:@"kDeviceClassTypeKey"];
          v16 = getDeviceClass();
          v17 = [v15 isEqualToString:v16];

          if ((v17 & 1) == 0)
          {
            goto LABEL_38;
          }
        }

        else if ([v14 isEqualToString:@"kHomedVersionKey"])
        {
          v18 = [v9 hmf_numberForKey:@"kHomedVersionKey"];
          v19 = homedVersion;
          v20 = [v18 compare:v19];

          if (v20 == 1)
          {
            goto LABEL_38;
          }
        }

        else
        {
          if ([v14 isEqualToString:v47])
          {
            v21 = [v9 hmf_UUIDForKey:v47];
            currentHomeConfigurations = [(HMDHomeManager *)selfCopy currentHomeConfigurations];
            v23 = [currentHomeConfigurations objectForKeyedSubscript:v21];

            if (!v21 || !v23)
            {
              v41 = objc_autoreleasePoolPush();
              v42 = selfCopy;
              v43 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
              {
                v44 = HMFGetLogIdentifier();
                *buf = 138543874;
                v58 = v44;
                v59 = 2114;
                v60 = v21;
                v61 = 2114;
                v62 = v23;
                _os_log_impl(&dword_229538000, v43, OS_LOG_TYPE_INFO, "%{public}@Home UUID %{public}@ or Configuration Version %{public}@ is nil", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v41);
LABEL_37:

LABEL_38:
              v34 = 0;
              goto LABEL_40;
            }
          }

          else
          {
            if (![v14 isEqualToString:@"kHomedSupportedFeaturesKey"])
            {
              goto LABEL_38;
            }

            v24 = [v9 hmf_arrayForKey:@"kHomedSupportedFeaturesKey"];
            v23 = homedSupportedFeatures;
            v25 = objc_autoreleasePoolPush();
            v26 = selfCopy;
            v27 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
            {
              v28 = HMFGetLogIdentifier();
              *buf = 138543874;
              v58 = v28;
              v59 = 2114;
              v60 = v24;
              v61 = 2114;
              v62 = v23;
              _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_DEBUG, "%{public}@Checking for required features: %{public}@, ours: %{public}@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v25);
            v50 = 0u;
            v51 = 0u;
            v48 = 0u;
            v49 = 0u;
            v21 = v24;
            v29 = [v21 countByEnumeratingWithState:&v48 objects:v56 count:16];
            if (v29)
            {
              v30 = v29;
              v31 = *v49;
              while (2)
              {
                for (j = 0; j != v30; ++j)
                {
                  if (*v49 != v31)
                  {
                    objc_enumerationMutation(v21);
                  }

                  v33 = *(*(&v48 + 1) + 8 * j);
                  if (([v23 containsObject:v33] & 1) == 0)
                  {
                    v35 = objc_autoreleasePoolPush();
                    v36 = v26;
                    v37 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
                    {
                      v38 = HMFGetLogIdentifier();
                      *buf = 138543618;
                      v58 = v38;
                      v59 = 2114;
                      v60 = v33;
                      _os_log_impl(&dword_229538000, v37, OS_LOG_TYPE_INFO, "%{public}@### Feature: %{public}@ not supported", buf, 0x16u);
                    }

                    objc_autoreleasePoolPop(v35);
                    goto LABEL_37;
                  }
                }

                v30 = [v21 countByEnumeratingWithState:&v48 objects:v56 count:16];
                if (v30)
                {
                  continue;
                }

                break;
              }
            }

            v12 = v45;
            selfCopy = v46;
          }
        }
      }

      v11 = [v9 countByEnumeratingWithState:&v52 objects:v63 count:16];
      v34 = 1;
      if (v11)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v34 = 1;
  }

LABEL_40:

  v39 = *MEMORY[0x277D85DE8];
  return v34;
}

- (void)_removeConfigurationVersionForHome:(id)home
{
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __53__HMDHomeManager__removeConfigurationVersionForHome___block_invoke;
  v7[3] = &unk_27868A750;
  v7[4] = self;
  v8 = homeCopy;
  v6 = homeCopy;
  dispatch_async(workQueue, v7);
}

void __53__HMDHomeManager__removeConfigurationVersionForHome___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) currentHomeConfigurations];
  [v2 removeObjectForKey:*(a1 + 40)];
}

- (void)_updateHome:(id)home configurationVersion:(int64_t)version
{
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager__updateHome_configurationVersion___block_invoke;
  block[3] = &unk_278685DF8;
  block[4] = self;
  v10 = homeCopy;
  versionCopy = version;
  v8 = homeCopy;
  dispatch_async(workQueue, block);
}

void __51__HMDHomeManager__updateHome_configurationVersion___block_invoke(uint64_t a1)
{
  v3 = [MEMORY[0x277CCABB0] numberWithInteger:*(a1 + 48)];
  v2 = [*(a1 + 32) currentHomeConfigurations];
  [v2 setObject:v3 forKeyedSubscript:*(a1 + 40)];
}

- (void)_handleRequestIsUserUsingHomeKit:(id)kit
{
  v14[2] = *MEMORY[0x277D85DE8];
  kitCopy = kit;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes count];

  if (v6)
  {
    v13[0] = @"kHomeKitInUseKey";
    v13[1] = @"kHomeKitUsingCloudKey";
    v14[0] = MEMORY[0x277CBEC38];
    v7 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager accountActive](self, "accountActive")}];
    v14[1] = v7;
    v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v14 forKeys:v13 count:2];
  }

  else
  {
    v11[0] = @"kHomeKitInUseKey";
    v11[1] = @"kHomeKitUsingCloudKey";
    v12[0] = MEMORY[0x277CBEC28];
    v12[1] = MEMORY[0x277CBEC28];
    v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v12 forKeys:v11 count:2];
  }

  responseHandler = [kitCopy responseHandler];

  (responseHandler)[2](responseHandler, 0, v8);
  v10 = *MEMORY[0x277D85DE8];
}

- (void)processCloudZoneModelRemoved:(id)removed message:(id)message
{
  removedCopy = removed;
  messageCopy = message;
  uuid = [removedCopy uuid];
  v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:uuid];

  if (v9)
  {
    cloudZones = [(HMDHomeManager *)self cloudZones];
    [cloudZones removeObject:v9];

    transactionResult = [messageCopy transactionResult];
    [transactionResult markChanged];
    uuid2 = [v9 uuid];
    responseHandler2 = [(HMDHomeManager *)self _homeWithZoneID:uuid2];

    if (responseHandler2)
    {
      v14 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
      [(HMDHomeManager *)self scheduleRemovalForHome:responseHandler2 message:0 options:v14];
    }

    if ([removedCopy requiresHomeManagerUpdate])
    {
      backingStore = [(HMDHomeManager *)self backingStore];
      v16 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v17 = [backingStore transaction:@"kHomeManagerUpdatedKey" options:v16];

      v18 = [HMDHomeManagerModel alloc];
      uuid3 = [(HMDHomeManager *)self uuid];
      v20 = [(HMDBackingStoreModelObject *)v18 initWithObjectChangeType:1 uuid:uuid3 parentUUID:0];

      cloudZones2 = [(HMDHomeManager *)self cloudZones];
      v22 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:cloudZones2];
      [(HMDHomeManagerModel *)v20 setCloudZoneInformation:v22];

      [v17 add:v20 withMessage:0];
      objc_initWeak(&location, self);
      v24 = MEMORY[0x277D85DD0];
      v25 = 3221225472;
      v26 = __55__HMDHomeManager_processCloudZoneModelRemoved_message___block_invoke;
      v27 = &unk_278688A18;
      objc_copyWeak(&v28, &location);
      [v17 save:&v24];
      objc_destroyWeak(&v28);
      objc_destroyWeak(&location);
    }

    [messageCopy respondWithPayload:{0, v24, v25, v26, v27}];
    goto LABEL_9;
  }

  responseHandler = [messageCopy responseHandler];

  if (responseHandler)
  {
    transactionResult = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    responseHandler2 = [messageCopy responseHandler];
    (responseHandler2)[2](responseHandler2, transactionResult, 0);
LABEL_9:
  }
}

void __55__HMDHomeManager_processCloudZoneModelRemoved_message___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v3;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Update zone information in home manager with error %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)processCloudZoneModelAdd:(id)add message:(id)message
{
  v38 = *MEMORY[0x277D85DE8];
  addCopy = add;
  messageCopy = message;
  uuid = [addCopy uuid];
  v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:uuid];

  v10 = objc_autoreleasePoolPush();
  selfCopy = self;
  v12 = HMFGetOSLogHandle();
  v13 = os_log_type_enabled(v12, OS_LOG_TYPE_INFO);
  if (v9)
  {
    if (v13)
    {
      v14 = HMFGetLogIdentifier();
      ownerName = [addCopy ownerName];
      *buf = 138543618;
      v35 = v14;
      v36 = 2112;
      v37 = ownerName;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Processing zone model update %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    [(HMDCloudZoneInformation *)v9 updateCloudZoneInformationWithModel:addCopy message:messageCopy];
  }

  else
  {
    if (v13)
    {
      v16 = HMFGetLogIdentifier();
      ownerName2 = [addCopy ownerName];
      *buf = 138543618;
      v35 = v16;
      v36 = 2112;
      v37 = ownerName2;
      _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Processing zone model add %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v18 = [HMDCloudZoneInformation alloc];
    ownerName3 = [addCopy ownerName];
    uuid2 = [addCopy uuid];
    v9 = [(HMDCloudZoneInformation *)v18 initWithOwnerName:ownerName3 uuid:uuid2];

    [(HMDCloudZoneInformation *)v9 updateCloudZoneInformationWithModel:addCopy message:messageCopy];
    cloudZones = [(HMDHomeManager *)selfCopy cloudZones];
    [cloudZones addObject:v9];
  }

  transactionResult = [messageCopy transactionResult];
  [transactionResult markChanged];
  if ([addCopy requiresHomeManagerUpdate])
  {
    backingStore = [(HMDHomeManager *)selfCopy backingStore];
    v24 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v25 = [backingStore transaction:@"kHomeManagerUpdatedKey" options:v24];

    v26 = [HMDHomeManagerModel alloc];
    uuid3 = [(HMDHomeManager *)selfCopy uuid];
    v28 = [(HMDBackingStoreModelObject *)v26 initWithObjectChangeType:1 uuid:uuid3 parentUUID:0];

    cloudZones2 = [(HMDHomeManager *)selfCopy cloudZones];
    v30 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:cloudZones2];
    [(HMDHomeManagerModel *)v28 setCloudZoneInformation:v30];

    [v25 add:v28 withMessage:0];
    objc_initWeak(buf, selfCopy);
    v32[0] = MEMORY[0x277D85DD0];
    v32[1] = 3221225472;
    v32[2] = __51__HMDHomeManager_processCloudZoneModelAdd_message___block_invoke;
    v32[3] = &unk_278688A18;
    objc_copyWeak(&v33, buf);
    [v25 save:v32];
    objc_destroyWeak(&v33);
    objc_destroyWeak(buf);
  }

  [messageCopy respondWithPayload:0];

  v31 = *MEMORY[0x277D85DE8];
}

void __51__HMDHomeManager_processCloudZoneModelAdd_message___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v3;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Update zone information in home manager with error %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)addTransactionAfterPush:(id)push
{
  if (push)
  {
    pushCopy = push;
    backingStore = [(HMDHomeManager *)self backingStore];
    v6 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v12 = [backingStore transaction:@"kHomeManagerCloudZoneAddedKey" options:v6];

    v7 = [HMDCloudZoneInformationModel alloc];
    uuid = [pushCopy uuid];
    uuid2 = [(HMDHomeManager *)self uuid];
    v10 = [(HMDBackingStoreModelObject *)v7 initWithObjectChangeType:1 uuid:uuid parentUUID:uuid2];

    ownerName = [pushCopy ownerName];

    [(HMDCloudZoneInformationModel *)v10 setOwnerName:ownerName];
    [(HMDCloudZoneInformationModel *)v10 setRequiresHomeManagerUpdate:1];
    [v12 add:v10 withMessage:0];
    [v12 run];
  }
}

- (void)_addCloudZone:(id)zone ownerName:(id)name
{
  v21 = *MEMORY[0x277D85DE8];
  zoneCopy = zone;
  nameCopy = name;
  v8 = nameCopy;
  if (zoneCopy)
  {
    if (nameCopy)
    {
      v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:zoneCopy];
      if (!v9)
      {
        v9 = [[HMDCloudZoneInformation alloc] initWithOwnerName:v8 uuid:zoneCopy];
        cloudZones = [(HMDHomeManager *)self cloudZones];
        [cloudZones addObject:v9];
      }
    }

    else
    {
      v11 = objc_autoreleasePoolPush();
      selfCopy = self;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        uUIDString = [zoneCopy UUIDString];
        v17 = 138543618;
        v18 = v14;
        v19 = 2112;
        v20 = uUIDString;
        _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot add zone because the ownerName was not specified, %@", &v17, 0x16u);
      }

      objc_autoreleasePoolPop(v11);
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (BOOL)zoneFetchFailed
{
  v14 = *MEMORY[0x277D85DE8];
  v9 = 0u;
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  cloudZones = [(HMDHomeManager *)self cloudZones];
  v3 = [cloudZones copy];

  v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
  if (v4)
  {
    v5 = *v10;
    while (2)
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v10 != v5)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v9 + 1) + 8 * i) didFetchFailed])
        {
          LOBYTE(v4) = 1;
          goto LABEL_11;
        }
      }

      v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
      if (v4)
      {
        continue;
      }

      break;
    }
  }

LABEL_11:

  v7 = *MEMORY[0x277D85DE8];
  return v4;
}

- (BOOL)_zonesFetched
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  cloudZones = [(HMDHomeManager *)self cloudZones];
  v3 = [cloudZones copy];

  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v12;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v11 + 1) + 8 * i) isFirstFetch])
        {
          v8 = 0;
          goto LABEL_11;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  v8 = 1;
LABEL_11:

  v9 = *MEMORY[0x277D85DE8];
  return v8;
}

- (void)processHomeManagerModelUpdate:(id)update message:(id)message
{
  v27 = *MEMORY[0x277D85DE8];
  updateCopy = update;
  messageCopy = message;
  if ([updateCopy propertyWasSet:@"primaryHomeUUID"])
  {
    primaryHomeUUID = [updateCopy primaryHomeUUID];

    if (primaryHomeUUID)
    {
      v9 = objc_alloc(MEMORY[0x277CCAD78]);
      primaryHomeUUID2 = [updateCopy primaryHomeUUID];
      v11 = [v9 initWithUUIDString:primaryHomeUUID2];

      primaryHomeUUID3 = [(HMDHomeManager *)self primaryHomeUUID];
      v13 = HMFEqualObjects();

      if ((v13 & 1) == 0)
      {
        v14 = objc_autoreleasePoolPush();
        selfCopy = self;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v17 = HMFGetLogIdentifier();
          v23 = 138543618;
          v24 = v17;
          v25 = 2112;
          v26 = v11;
          _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, "%{public}@Applying primary home UUID: %@", &v23, 0x16u);
        }

        objc_autoreleasePoolPop(v14);
        [(HMDHomeManager *)selfCopy setPrimaryHomeUUID:v11];
        v18 = objc_opt_new();
        primaryHomeUUID4 = [(HMDHomeManager *)selfCopy primaryHomeUUID];
        [v18 setObject:primaryHomeUUID4 forKeyedSubscript:@"HMDPrimaryHomeUUIDKey"];

        defaultCenter = [MEMORY[0x277CCAB98] defaultCenter];
        [defaultCenter postNotificationName:@"HMDNotificationPrimaryHomeDidChange" object:selfCopy userInfo:v18];
      }
    }
  }

  transactionResult = [messageCopy transactionResult];
  [transactionResult markChanged];
  [messageCopy respondWithSuccess];

  v22 = *MEMORY[0x277D85DE8];
}

- (void)_changePrimaryHome:(id)home
{
  v26 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  if (homeCopy)
  {
    primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];
    v6 = HMFEqualObjects();

    if ((v6 & 1) == 0)
    {
      v7 = objc_autoreleasePoolPush();
      selfCopy = self;
      v9 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
      {
        v10 = HMFGetLogIdentifier();
        primaryHomeUUID2 = [(HMDHomeManager *)selfCopy primaryHomeUUID];
        v20 = 138543874;
        v21 = v10;
        v22 = 2112;
        v23 = primaryHomeUUID2;
        v24 = 2112;
        v25 = homeCopy;
        _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Updating the primary home from %@ to %@", &v20, 0x20u);
      }

      objc_autoreleasePoolPop(v7);
      v12 = [HMDHomeManagerModel alloc];
      uuid = [(HMDHomeManager *)selfCopy uuid];
      v14 = [(HMDBackingStoreModelObject *)v12 initWithObjectChangeType:1 uuid:uuid parentUUID:0];

      uUIDString = [homeCopy UUIDString];
      [(HMDHomeManagerModel *)v14 setPrimaryHomeUUID:uUIDString];

      backingStore = [(HMDHomeManager *)selfCopy backingStore];
      v17 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v18 = [backingStore transaction:@"HMD.hm" options:v17];

      [v18 add:v14 withMessage:0];
      [v18 run];
    }
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestSetPrimaryHome:(id)home
{
  homeCopy = home;
  v4 = [homeCopy uuidForKey:*MEMORY[0x277CD0640]];
  if (v4)
  {
    v5 = [(HMDHomeManager *)self _homeWithUUID:v4];
    if (v5)
    {
      v6 = [HMDHomeManagerModel alloc];
      uuid = [(HMDHomeManager *)self uuid];
      responseHandler4 = [(HMDBackingStoreModelObject *)v6 initWithObjectChangeType:1 uuid:uuid parentUUID:0];

      uUIDString = [v4 UUIDString];
      [(HMDHomeManagerModel *)responseHandler4 setPrimaryHomeUUID:uUIDString];

      backingStore = [(HMDHomeManager *)self backingStore];
      name = [homeCopy name];
      v12 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      responseHandler2 = [backingStore transaction:name options:v12];

      [responseHandler2 add:responseHandler4 withMessage:homeCopy];
      [responseHandler2 run];
    }

    else
    {
      responseHandler = [homeCopy responseHandler];

      if (!responseHandler)
      {
        v5 = 0;
        goto LABEL_10;
      }

      responseHandler4 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      responseHandler2 = [homeCopy responseHandler];
      (responseHandler2)[2](responseHandler2, responseHandler4, 0);
    }
  }

  else
  {
    responseHandler3 = [homeCopy responseHandler];

    if (!responseHandler3)
    {
      goto LABEL_11;
    }

    v5 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    responseHandler4 = [homeCopy responseHandler];
    (*&responseHandler4->super._bsoDataVersionOverride)(responseHandler4, v5, 0);
  }

LABEL_10:
LABEL_11:
}

- (void)processHomeModelRemoved:(id)removed message:(id)message
{
  v29 = *MEMORY[0x277D85DE8];
  removedCopy = removed;
  messageCopy = message;
  v8 = objc_autoreleasePoolPush();
  selfCopy = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v23 = 138543874;
    v24 = v11;
    v25 = 2112;
    v26 = removedCopy;
    v27 = 2112;
    v28 = messageCopy;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Removing home model : %@ due to message: %@", &v23, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  uuid = [removedCopy uuid];
  if (uuid)
  {
    v13 = [(HMDHomeManager *)selfCopy _homeWithUUID:uuid];
    if (v13)
    {
      v14 = v13;
      transactionResult = [messageCopy transactionResult];
      v16 = [transactionResult source] == 1;

      [(HMDHomeManager *)selfCopy _removeHome:v14 withMessage:messageCopy saveToStore:1 notifyUsers:1 shouldRemovePairings:v16];
    }

    else
    {
      responseHandler = [messageCopy responseHandler];

      if (responseHandler)
      {
        v20 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
        responseHandler2 = [messageCopy responseHandler];
        (responseHandler2)[2](responseHandler2, v20, 0);
      }

      v14 = 0;
    }

    goto LABEL_11;
  }

  responseHandler3 = [messageCopy responseHandler];

  if (responseHandler3)
  {
    v14 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    responseHandler4 = [messageCopy responseHandler];
    (responseHandler4)[2](responseHandler4, v14, 0);

LABEL_11:
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestRemoveHome:(id)home
{
  v26 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  v5 = [homeCopy uuidForKey:*MEMORY[0x277CD0640]];
  v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
  if (v6)
  {
    if ([homeCopy isEntitledForSPIAccess])
    {
      [(HMDHomeManager *)self _handleRemoveHomeOperation:v6 message:homeCopy];
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      selfCopy = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543618;
        v23 = v13;
        v24 = 2112;
        v25 = v6;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Presenting delete home confirmation dialog to user for %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v14 = +[HMDUIDialogPresenter sharedUIDialogPresenter];
      name = [v6 name];
      workQueue = [(HMDHomeManager *)selfCopy workQueue];
      v18[0] = MEMORY[0x277D85DD0];
      v18[1] = 3221225472;
      v18[2] = __43__HMDHomeManager__handleRequestRemoveHome___block_invoke;
      v18[3] = &unk_278685DD0;
      v18[4] = selfCopy;
      v19 = v5;
      v20 = v6;
      v21 = homeCopy;
      [v14 requestUserPermissionForDeletionOfHomeWithName:name withContext:v19 queue:workQueue completionHandler:v18];
    }
  }

  else
  {
    responseHandler = [homeCopy responseHandler];

    if (responseHandler)
    {
      responseHandler2 = [homeCopy responseHandler];
      v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (responseHandler2)[2](responseHandler2, v9, 0);
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __43__HMDHomeManager__handleRequestRemoveHome___block_invoke(uint64_t a1, int a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = v7;
    v9 = @"delete home";
    if (a2)
    {
      v9 = @"cancel";
    }

    v22 = 138543618;
    v23 = v7;
    v24 = 2112;
    v25 = v9;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@User selected %@", &v22, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  if ((a2 & 1) == 0)
  {
    v13 = [*(a1 + 32) _homeWithUUID:*(a1 + 40)];
    if (v13)
    {
      v11 = v13;
      [*(a1 + 32) _handleRemoveHomeOperation:*(a1 + 48) message:*(a1 + 56)];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 32);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        v18 = *(a1 + 40);
        v22 = 138543618;
        v23 = v17;
        v24 = 2112;
        v25 = v18;
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Home Removal failed because no home found for %@", &v22, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v11 = [*(a1 + 56) responseHandler];

      if (v11)
      {
        v19 = [*(a1 + 56) responseHandler];
        v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        (v19)[2](v19, v20, 0);

        v11 = 0;
      }
    }

    goto LABEL_14;
  }

  v10 = [*(a1 + 56) responseHandler];

  if (v10)
  {
    v11 = [*(a1 + 56) responseHandler];
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23];
    (v11)[2](v11, v12, 0);

LABEL_14:
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (id)_remoteUserForMessage:(id)message
{
  v23 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = messageCopy;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;

  senderContext = [v6 senderContext];
  accountHandle = [senderContext accountHandle];

  if (accountHandle)
  {
    v9 = [HMDUser alloc];
    senderContext2 = [v6 senderContext];
    accountHandle2 = [senderContext2 accountHandle];
    v12 = [(HMDUser *)v9 initWithAccountHandle:accountHandle2 home:0 pairingIdentity:0 privilege:2];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v16;
      v21 = 2112;
      v22 = v6;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Received message that a shared user migrated to HH2, but there's insufficient info about the sender: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v12 = 0;
  }

  v17 = *MEMORY[0x277D85DE8];

  return v12;
}

- (void)_handleSharedUserMovedToHH2:(id)h2
{
  v16 = *MEMORY[0x277D85DE8];
  v4 = [(HMDHomeManager *)self _remoteUserForMessage:h2];
  if (v4)
  {
    v13 = 0u;
    v14 = 0u;
    v11 = 0u;
    v12 = 0u;
    homes = [(HMDHomeManager *)self homes];
    v6 = [homes countByEnumeratingWithState:&v11 objects:v15 count:16];
    if (v6)
    {
      v7 = v6;
      v8 = *v12;
      do
      {
        v9 = 0;
        do
        {
          if (*v12 != v8)
          {
            objc_enumerationMutation(homes);
          }

          [*(*(&v11 + 1) + 8 * v9++) resendOutgoingInvitationToUser:v4];
        }

        while (v7 != v9);
        v7 = [homes countByEnumeratingWithState:&v11 objects:v15 count:16];
      }

      while (v7);
    }
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (BOOL)pendingInviteExistsForSenderOfMessage:(id)message
{
  v17 = *MEMORY[0x277D85DE8];
  v4 = [(HMDHomeManager *)self _remoteUserForMessage:message];
  if (v4)
  {
    v14 = 0u;
    v15 = 0u;
    v12 = 0u;
    v13 = 0u;
    homes = [(HMDHomeManager *)self homes];
    v6 = [homes countByEnumeratingWithState:&v12 objects:v16 count:16];
    if (v6)
    {
      v7 = *v13;
      while (2)
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v13 != v7)
          {
            objc_enumerationMutation(homes);
          }

          v9 = [*(*(&v12 + 1) + 8 * i) outgoingInvitationToResendForUser:v4];

          if (v9)
          {
            LOBYTE(v6) = 1;
            goto LABEL_12;
          }
        }

        v6 = [homes countByEnumeratingWithState:&v12 objects:v16 count:16];
        if (v6)
        {
          continue;
        }

        break;
      }
    }

LABEL_12:
  }

  else
  {
    LOBYTE(v6) = 0;
  }

  v10 = *MEMORY[0x277D85DE8];
  return v6;
}

- (void)_handleRemoveAllUsersFromAccessories:(id)accessories
{
  v31 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v28 = v8;
    v29 = 2112;
    v30 = accessoriesCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Received request to remove pairings from all the accessories: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [accessoriesCopy uuidForKey:*MEMORY[0x277CD0640]];
  v10 = [(HMDHomeManager *)selfCopy _homeWithUUID:v9];
  if (v10)
  {
    v11 = dispatch_get_global_queue(25, 0);
    v12 = dispatch_group_create();
    accessories = [v10 accessories];
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke;
    v22[3] = &unk_278685DA8;
    v14 = v12;
    v23 = v14;
    v24 = v11;
    v25 = selfCopy;
    v26 = v10;
    v15 = v11;
    [accessories hmf_enumerateWithAutoreleasePoolUsingBlock:v22];

    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_988;
    block[3] = &unk_27868A010;
    v19 = v14;
    v20 = selfCopy;
    v21 = accessoriesCopy;
    v16 = v14;
    dispatch_async(v15, block);
  }

  else
  {
    v15 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    [accessoriesCopy respondWithError:v15];
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  dispatch_group_enter(*(a1 + 32));
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_2;
  v7[3] = &unk_2786891E0;
  v4 = *(a1 + 40);
  v5 = *(a1 + 56);
  v7[4] = *(a1 + 48);
  v8 = v3;
  v9 = v5;
  v10 = *(a1 + 32);
  v6 = v3;
  dispatch_async(v4, v7);
}

uint64_t __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_988(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  v2 = *(a1 + 32);
  v3 = dispatch_time(0, 5000000000);
  if (dispatch_group_wait(v2, v3))
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 40);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      v10 = 138543362;
      v11 = v7;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Timed out while waiting to remove the pairing from the accessories.", &v10, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  result = [*(a1 + 48) respondWithSuccess];
  v9 = *MEMORY[0x277D85DE8];
  return result;
}

void __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_2(uint64_t a1)
{
  v24 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v7 = [*(a1 + 48) name];
    *buf = 138543874;
    v19 = v5;
    v20 = 2112;
    v21 = v6;
    v22 = 2112;
    v23 = v7;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Going to remove all users and cloud data from accessory: %@ for home: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v2);
  v9 = *(a1 + 40);
  v8 = *(a1 + 48);
  v14[0] = MEMORY[0x277D85DD0];
  v14[1] = 3221225472;
  v14[2] = __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_986;
  v14[3] = &unk_27868A010;
  v10 = *(a1 + 56);
  v11 = *(a1 + 32);
  v12 = *(a1 + 40);
  v15 = v10;
  v16 = v11;
  v17 = v12;
  [v8 removeAllUsersAndCloudDataFromAccessory:v9 completionHandler:v14];

  v13 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__handleRemoveAllUsersFromAccessories___block_invoke_986(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  dispatch_group_leave(*(a1 + 32));
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 40);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 48);
    v8 = 138543618;
    v9 = v5;
    v10 = 2112;
    v11 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Finished removing all users from accessory: %@", &v8, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *MEMORY[0x277D85DE8];
}

- (void)_handleRemoveHomeOperation:(id)operation message:(id)message
{
  v53 = *MEMORY[0x277D85DE8];
  operationCopy = operation;
  messageCopy = message;
  administratorHandler = [operationCopy administratorHandler];
  if ([operationCopy isOwnerUser])
  {
    if ([administratorHandler shouldRelayMessages])
    {
      v9 = MEMORY[0x277D0F848];
      v10 = *MEMORY[0x277CD2500];
      messagePayload = [messageCopy messagePayload];
      v12 = [messagePayload copy];
      v45[0] = MEMORY[0x277D85DD0];
      v45[1] = 3221225472;
      v45[2] = __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke;
      v45[3] = &unk_278688370;
      v45[4] = self;
      v46 = messageCopy;
      v13 = [v9 messageWithName:v10 messagePayload:v12 responseHandler:v45];

      v44 = 0;
      v14 = [administratorHandler operationForMessage:v13 error:&v44];
      v15 = v44;
      v16 = objc_autoreleasePoolPush();
      selfCopy = self;
      v18 = HMFGetOSLogHandle();
      v19 = v18;
      if (v14)
      {
        if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543618;
          v48 = v20;
          v49 = 2112;
          v50 = operationCopy;
          _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Adding HMDHomeAdministratorConfigurationOperation to remove home: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v16);
        [administratorHandler addOperation:v14];
      }

      else
      {
        if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
        {
          v36 = HMFGetLogIdentifier();
          *buf = 138543874;
          v48 = v36;
          v49 = 2112;
          v50 = operationCopy;
          v51 = 2112;
          v52 = v15;
          _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_ERROR, "%{public}@Failed to create operation to remove home: %@ with error: %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v16);
      }
    }

    else
    {
      v32 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543618;
        v48 = v35;
        v49 = 2112;
        v50 = operationCopy;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_INFO, "%{public}@Removing Home locally : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v32);
      [(HMDHomeManager *)selfCopy2 dmHandleRequestRemoveHome:messageCopy];
    }
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543618;
      v48 = v24;
      v49 = 2112;
      v50 = operationCopy;
      _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Leaving share to remove shared home: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v21);
    v25 = objc_alloc(MEMORY[0x277D0F7A8]);
    workQueue = [(HMDHomeManager *)selfCopy3 workQueue];
    v27 = [v25 initWithQueue:workQueue];

    homeSharedUserCloudShareManager = [(HMDHomeManager *)selfCopy3 homeSharedUserCloudShareManager];
    uuid = [operationCopy uuid];
    v30 = [homeSharedUserCloudShareManager leaveShareWithSharedHomeModelID:uuid];
    v41[0] = MEMORY[0x277D85DD0];
    v41[1] = 3221225472;
    v41[2] = __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke_983;
    v41[3] = &unk_278685D58;
    v41[4] = selfCopy3;
    v42 = operationCopy;
    v43 = messageCopy;
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke_984;
    v38[3] = &unk_278685D80;
    v38[4] = selfCopy3;
    v39 = v42;
    v40 = v43;
    v31 = [v30 inContext:v27 then:v41 orRecover:v38];
  }

  v37 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v18 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v12 = 138543874;
    v13 = v10;
    v14 = 2112;
    v15 = v6;
    v16 = 2112;
    v17 = v5;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Accessory pairing removal finished with : %@, error: %@", &v12, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  [*(a1 + 32) dmHandleRequestRemoveHome:*(a1 + 40)];

  v11 = *MEMORY[0x277D85DE8];
}

uint64_t __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke_983(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = *(a1 + 40);
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v8;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Left share for home: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 48) respondWithSuccess];

  v9 = *MEMORY[0x277D85DE8];
  return 1;
}

uint64_t __53__HMDHomeManager__handleRemoveHomeOperation_message___block_invoke_984(uint64_t a1, void *a2)
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = *(a1 + 40);
    v16 = 138543874;
    v17 = v7;
    v18 = 2112;
    v19 = v8;
    v20 = 2112;
    v21 = v3;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Failed to leave share for home: %@ with error: %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  if (isTransientCloudKitError(v3))
  {
    [*(a1 + 48) respondWithError:v3];
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 32);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v13 = *(a1 + 40);
      v16 = 138543618;
      v17 = v12;
      v18 = 2112;
      v19 = v13;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Leaving share failed. Removing Home locally : %@", &v16, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [*(a1 + 32) dmHandleRequestRemoveHome:*(a1 + 48)];
  }

  v14 = *MEMORY[0x277D85DE8];
  return 1;
}

- (void)scheduleRemovalForHome:(id)home message:(id)message options:(id)options
{
  location[3] = *MEMORY[0x277D85DE8];
  homeCopy = home;
  messageCopy = message;
  optionsCopy = options;
  if (homeCopy)
  {
    v11 = homeCopy;
    name = [v11 name];
    name2 = [messageCopy name];
    v14 = name2;
    v15 = @"kHomeManagerUpdatedKey";
    if (name2)
    {
      v15 = name2;
    }

    v16 = v15;

    syncManager = [(HMDHomeManager *)self syncManager];
    objc_initWeak(location, self);
    v28[0] = MEMORY[0x277D85DD0];
    v28[1] = 3221225472;
    v28[2] = __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke;
    v28[3] = &unk_278685D30;
    objc_copyWeak(&v35, location);
    responseHandler2 = v11;
    v29 = responseHandler2;
    v19 = v16;
    v30 = v19;
    v31 = optionsCopy;
    v32 = messageCopy;
    v20 = name;
    v33 = v20;
    v21 = syncManager;
    v34 = v21;
    [v21 pauseAndWaitForCurrentOperationCompletion:v28];

    objc_destroyWeak(&v35);
    objc_destroyWeak(location);

    goto LABEL_9;
  }

  v22 = objc_autoreleasePoolPush();
  selfCopy = self;
  v24 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
  {
    v25 = HMFGetLogIdentifier();
    LODWORD(location[0]) = 138543362;
    *(location + 4) = v25;
    _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_ERROR, "%{public}@Cannot schedule removal of home because the home was not specified", location, 0xCu);
  }

  objc_autoreleasePoolPop(v22);
  responseHandler = [messageCopy responseHandler];

  if (responseHandler)
  {
    responseHandler2 = [messageCopy responseHandler];
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(responseHandler2 + 2))(responseHandler2, v20, 0);
LABEL_9:
  }

  v27 = *MEMORY[0x277D85DE8];
}

void __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 80));
  if (WeakRetained)
  {
    v3 = [*(a1 + 32) deletedBackingStoreObject];
    v4 = [WeakRetained backingStore];
    v5 = [v4 transaction:*(a1 + 40) options:*(a1 + 48)];

    [v5 add:v3 withMessage:*(a1 + 56)];
    v6[0] = MEMORY[0x277D85DD0];
    v6[1] = 3221225472;
    v6[2] = __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke_2;
    v6[3] = &unk_278685D08;
    objc_copyWeak(&v9, (a1 + 80));
    v7 = *(a1 + 64);
    v8 = *(a1 + 72);
    [v5 run:v6];

    objc_destroyWeak(&v9);
  }

  else
  {
    [*(a1 + 72) resume];
  }
}

void __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke_2(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = *(a1 + 32);
    v11 = 138543874;
    v12 = v8;
    v13 = 2112;
    v14 = v9;
    v15 = 2112;
    v16 = v3;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Resume sync manager after finishing removing home %@ - error %@", &v11, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  [*(a1 + 40) resume];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_removeHome:(id)home withMessage:(id)message saveToStore:(BOOL)store notifyUsers:(BOOL)users shouldRemovePairings:(BOOL)pairings
{
  pairingsCopy = pairings;
  v45 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  messageCopy = message;
  uuid = [homeCopy uuid];
  owner = [homeCopy owner];
  account = [owner account];
  senderCorrelationIdentifier = [account senderCorrelationIdentifier];

  pendingHomesBeingRemoved = [(HMDHomeManager *)self pendingHomesBeingRemoved];
  [pendingHomesBeingRemoved addObject:uuid];

  transactionResult = [messageCopy transactionResult];
  [transactionResult markChanged];
  v19 = objc_autoreleasePoolPush();
  selfCopy = self;
  v21 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
  {
    HMFGetLogIdentifier();
    v32 = transactionResult;
    v22 = v31 = store;
    [homeCopy name];
    v24 = v23 = users;
    *buf = 138543618;
    v42 = v22;
    v43 = 2112;
    v44 = v24;
    _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, "%{public}@Removing all accessories for home %@", buf, 0x16u);

    users = v23;
    store = v31;
    transactionResult = v32;
  }

  objc_autoreleasePoolPop(v19);
  workQueue = [(HMDHomeManager *)selfCopy workQueue];
  v34[0] = MEMORY[0x277D85DD0];
  v34[1] = 3221225472;
  v34[2] = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke;
  v34[3] = &unk_278685CE0;
  v34[4] = selfCopy;
  v35 = homeCopy;
  usersCopy = users;
  v36 = uuid;
  v37 = senderCorrelationIdentifier;
  storeCopy = store;
  v38 = messageCopy;
  v26 = messageCopy;
  v27 = senderCorrelationIdentifier;
  v28 = uuid;
  v29 = homeCopy;
  [v29 removeAllHomeContentsAndAccessoryPairings:pairingsCopy queue:workQueue completionHandler:v34];

  v30 = *MEMORY[0x277D85DE8];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke(uint64_t a1)
{
  v85 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) name];
    *buf = 138543618;
    v82 = v5;
    v83 = 2112;
    v84 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Removing home %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = +[HMDBulletinBoard sharedBulletinBoard];
  [v7 removeBulletinsForHome:*(a1 + 40)];
  if (*(a1 + 72) == 1)
  {
    [*(a1 + 32) _removeAllUsersOfHome:*(a1 + 40)];
  }

  [*(a1 + 40) unconfigure];
  [*(a1 + 32) removeHome:*(a1 + 40)];
  v8 = [*(a1 + 32) pendingHomesBeingRemoved];
  [v8 removeObject:*(a1 + 48)];

  [*(a1 + 40) stopThreadNetwork:0];
  if ([*(a1 + 40) isOwnerUser])
  {
    v9 = [*(a1 + 32) homes];
    v10 = [v9 na_any:&__block_literal_global_981];

    if ((v10 & 1) == 0)
    {
      v11 = [*(a1 + 32) workQueue];
      v73 = MEMORY[0x277D85DD0];
      v74 = 3221225472;
      v75 = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_2;
      v76 = &unk_27868A750;
      v12 = *(a1 + 40);
      v77 = *(a1 + 32);
      v78 = v12;
      dispatch_async(v11, &v73);
    }
  }

  v13 = [*(a1 + 40) uuid];
  v14 = [*(a1 + 32) primaryHomeUUID];
  v15 = [v13 isEqual:v14];

  if (v15)
  {
    v16 = [*(a1 + 32) homes];
    v17 = [v16 firstObject];

    v18 = *(a1 + 32);
    v19 = [v17 uuid];
    [v18 _changePrimaryHome:v19];
  }

  v20 = [*(a1 + 40) uuid];
  v21 = [*(a1 + 32) currentHomeUUID];
  v22 = [v20 isEqual:v21];

  if (v22)
  {
    [*(a1 + 32) _updateCurrentHomeIfNecessary];
  }

  [*(a1 + 32) updateHomeKitInUsePreferences];
  v23 = [*(a1 + 32) nameValidator];
  v24 = [*(a1 + 40) uuid];
  v25 = [v23 removeNamespace:v24];

  v26 = *(a1 + 32);
  v27 = [*(a1 + 40) uuid];
  [v26 _removeConfigurationVersionForHome:v27];

  v28 = *(a1 + 32);
  v29 = [*(a1 + 40) name];
  v30 = [*(a1 + 32) uuid];
  v31 = [v28 removeName:v29 namespace:v30];

  if (v31)
  {
    v32 = objc_autoreleasePoolPush();
    v33 = *(a1 + 32);
    v34 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
    {
      v35 = HMFGetLogIdentifier();
      v36 = [*(a1 + 40) name];
      *buf = 138543618;
      v82 = v35;
      v83 = 2112;
      v84 = v36;
      _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to remove home name '%@' from homeManager namespace", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v32);
  }

  if (([*(a1 + 40) isOwnerUser] & 1) == 0)
  {
    isWatch();
    v37 = [*(a1 + 32) uuidsOfRemovedHomes];
    v38 = [v37 containsObject:*(a1 + 48)];

    if ((v38 & 1) == 0)
    {
      v39 = [*(a1 + 32) uuidsOfRemovedHomes];
      [v39 addObject:*(a1 + 48)];

      v40 = objc_autoreleasePoolPush();
      v41 = *(a1 + 32);
      v42 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_INFO))
      {
        v43 = HMFGetLogIdentifier();
        v44 = [*(a1 + 48) UUIDString];
        *buf = 138543618;
        v82 = v43;
        v83 = 2112;
        v84 = v44;
        _os_log_impl(&dword_229538000, v42, OS_LOG_TYPE_INFO, "%{public}@Adding home with UUID %@ to the uuids of guest homes removed locally", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v40);
    }

    [*(a1 + 32) _trackRemovedHomeUserMergeId:*(a1 + 56)];
  }

  if (*(a1 + 73) == 1)
  {
    v45 = *(a1 + 32);
    v46 = [*(a1 + 64) name];
    [v45 assistantSyncDataChanged:v46];
  }

  v47 = [*(a1 + 64) transactionResult];
  v48 = [v47 source] == 1;
  v49 = *(a1 + 32);
  v50 = [*(a1 + 40) zoneID];
  [v49 _removeCloudZone:v50 updateHomeManager:v48];

  v51 = [*(a1 + 32) compositeSettingsControllerManager];
  v52 = [*(a1 + 40) uuid];
  [v51 removeHomeZone:v52];

  v53 = objc_autoreleasePoolPush();
  v54 = *(a1 + 32);
  v55 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v55, OS_LOG_TYPE_INFO))
  {
    v56 = HMFGetLogIdentifier();
    v57 = [*(a1 + 40) name];
    *buf = 138543618;
    v82 = v56;
    v83 = 2112;
    v84 = v57;
    _os_log_impl(&dword_229538000, v55, OS_LOG_TYPE_INFO, "%{public}@Removed home: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v53);
  [*(a1 + 64) respondWithSuccess];
  v58 = *(a1 + 40);
  v79 = @"HMDHomeNotificationKey";
  v80 = v58;
  v59 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v80 forKeys:&v79 count:1];
  logAndPostNotification(@"HMDHomeRemovedNotification", *(a1 + 32), v59);
  [*(a1 + 40) handleHomeWasRemoved];
  v60 = [*(a1 + 32) lastEventStoreController];
  v61 = [*(a1 + 40) uuid];
  [v60 didRemoveHome:v61];

  if (([*(a1 + 40) isOwnerUser] & 1) == 0)
  {
    v62 = [*(a1 + 32) homeSharedUserCloudShareManager];
    v63 = [*(a1 + 40) uuid];
    [v62 removeShareForSharedUserDataWithHomeModelID:v63];

    v64 = [*(a1 + 32) homeSharedUserCloudShareManager];
    v65 = [*(a1 + 40) uuid];
    v66 = [v64 leaveShareWithSharedHomeModelID:v65];
  }

  v67 = objc_autoreleasePoolPush();
  v68 = *(a1 + 32);
  v69 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v69, OS_LOG_TYPE_INFO))
  {
    v70 = HMFGetLogIdentifier();
    v71 = *(a1 + 40);
    *buf = 138543618;
    v82 = v70;
    v83 = 2112;
    v84 = v71;
    _os_log_impl(&dword_229538000, v69, OS_LOG_TYPE_INFO, "%{public}@The home should be gone : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v67);
  v72 = *MEMORY[0x277D85DE8];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_2(uint64_t a1)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_3;
  aBlock[3] = &unk_27868A250;
  aBlock[4] = *(a1 + 32);
  v2 = _Block_copy(aBlock);
  [*(a1 + 40) removeThreadNetworkPreferredNetworkWithCompletion:v2];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_3(uint64_t a1, void *a2)
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      v9 = 138543362;
      v10 = v7;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to delete preferred Thread network credentials - continuing anyways", &v9, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)processHomeModelAdd:(id)add message:(id)message
{
  v256[1] = *MEMORY[0x277D85DE8];
  addCopy = add;
  messageCopy = message;
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    v10 = logger;
    uuid = [addCopy uuid];
    parentUUID = [addCopy parentUUID];
    *buf = 138412546;
    v246 = uuid;
    v247 = 2112;
    v248 = parentUUID;
    _os_signpost_emit_with_name_impl(&dword_229538000, v10, OS_SIGNPOST_INTERVAL_BEGIN, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "identifier=%{signpost.description:attribute}@ parentIdentifier=%{signpost.description:attribute}@ ", buf, 0x16u);
  }

  setupActivity = [(HMDHomeManager *)self setupActivity];

  v221 = messageCopy;
  if (setupActivity)
  {
    setupActivity2 = [(HMDHomeManager *)self setupActivity];
    v255 = @"HMDHomeModelUUID";
    uuid2 = [addCopy uuid];
    v16 = HMDailyRotatedUUID();
    uUIDString = [v16 UUIDString];
    v18 = uUIDString;
    v19 = @"no uuid";
    if (uUIDString)
    {
      v19 = uUIDString;
    }

    v256[0] = v19;
    v20 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v256 forKeys:&v255 count:1];

    messageCopy = v221;
    setupActivity3 = [(HMDHomeManager *)self setupActivity];
    [setupActivity3 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];
  }

  name = [addCopy name];
  if (name)
  {
    aSelector = a2;
    v22 = objc_alloc(MEMORY[0x277D0F8B0]);
    ownerPublicKey = [addCopy ownerPublicKey];
    v24 = [v22 initWithPairingKeyData:ownerPublicKey];

    v25 = objc_alloc(MEMORY[0x277D0F8A8]);
    ownerName = [addCopy ownerName];
    v27 = [v25 initWithIdentifier:ownerName publicKey:v24 privateKey:0];

    ownerUserID = [addCopy ownerUserID];
    v29 = [HMDUser ownerWithUserID:ownerUserID home:0 pairingIdentity:v27 homeManager:self];

    if (!v29)
    {
      v218 = v27;
      v67 = objc_autoreleasePoolPush();
      selfCopy = self;
      v69 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v69, OS_LOG_TYPE_ERROR))
      {
        v70 = HMFGetLogIdentifier();
        *buf = 138543618;
        v246 = v70;
        v247 = 2112;
        v248 = name;
        _os_log_impl(&dword_229538000, v69, OS_LOG_TYPE_ERROR, "%{public}@Failed to create owner user while trying to create home with name %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v67);
      responseHandler = [messageCopy responseHandler];

      v72 = v218;
      if (responseHandler)
      {
        v73 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        responseHandler2 = [messageCopy responseHandler];
        (responseHandler2)[2](responseHandler2, v73, 0);

        setupActivity4 = [(HMDHomeManager *)selfCopy setupActivity];

        if (setupActivity4)
        {
          aSelectora = [(HMDHomeManager *)selfCopy setupActivity];
          v251[0] = @"errorCode";
          v76 = v73;
          v77 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v73, "code")}];
          v251[1] = @"HMDHomeModelUUID";
          v252[0] = v77;
          uuid3 = [addCopy uuid];
          v79 = HMDailyRotatedUUID();
          uUIDString2 = [v79 UUIDString];
          selfCopy2 = self;
          v82 = uUIDString2;
          v83 = @"no uuid";
          if (uUIDString2)
          {
            v83 = uUIDString2;
          }

          v252[1] = v83;
          v84 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v252 forKeys:v251 count:2];

          self = selfCopy2;
          v29 = 0;
          v72 = v218;

          messageCopy = v221;
          v73 = v76;

          setupActivity5 = [(HMDHomeManager *)selfCopy setupActivity];
          [setupActivity5 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];

          v86 = self->_logger;
          if (os_signpost_enabled(v86))
          {
            v87 = v86;
            stringValueSafe = [v73 stringValueSafe];
            *buf = 138412290;
            v246 = stringValueSafe;
            _os_signpost_emit_with_name_impl(&dword_229538000, v87, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "Error=%{signpost.description:attribute}@ ", buf, 0xCu);
          }
        }
      }

      v89 = self->_logger;
      if (os_signpost_enabled(v89))
      {
        *buf = 0;
        _os_signpost_emit_with_name_impl(&dword_229538000, v89, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
      }

      goto LABEL_107;
    }

    ownerUUID = [addCopy ownerUUID];
    if (ownerUUID)
    {
      v31 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:ownerUUID];
      [v29 setUUID:v31];
    }

    transactionResult = [messageCopy transactionResult];
    v33 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v35 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
    {
      v36 = HMFGetLogIdentifier();
      v37 = +[HMDBackingStoreTransactionOptions stringForHMDBackingStoreTransactionSource:](HMDBackingStoreTransactionOptions, "stringForHMDBackingStoreTransactionSource:", [transactionResult source]);
      *buf = 138543618;
      v246 = v36;
      v247 = 2112;
      v248 = v37;
      _os_log_impl(&dword_229538000, v35, OS_LOG_TYPE_INFO, "%{public}@Process Home Model Add source: %@", buf, 0x16u);

      messageCopy = v221;
    }

    objc_autoreleasePoolPop(v33);
    v220 = transactionResult;
    selfCopy4 = self;
    if ([transactionResult source] == 1)
    {
      systemStore = [MEMORY[0x277CFEC78] systemStore];
      activeAccountIdentifier = [(HMDHomeManager *)selfCopy3 activeAccountIdentifier];
      if (!activeAccountIdentifier)
      {
        v237 = 0;
        v238 = 0;
        v40 = [systemStore getCurrentiCloudIdentifier:&v238 controllerPairingIdentifier:&v237 error:0];
        activeAccountIdentifier = v238;
        v41 = v237;
        if (!v40 || !-[__CFString length](activeAccountIdentifier, "length") || ![v41 length])
        {
          v42 = objc_autoreleasePoolPush();
          v43 = selfCopy3;
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
          {
            HMFGetLogIdentifier();
            v46 = v45 = addCopy;
            *buf = 138543362;
            v246 = v46;
            _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_INFO, "%{public}@We don't have an active iCloud account, using the sentinel account identifier to remember the controller key", buf, 0xCu);

            addCopy = v45;
          }

          objc_autoreleasePoolPop(v42);
          activeAccountIdentifier = @"__HomeKit_NoAccount_Identifier__";
        }

        messageCopy = v221;
      }

      pairingUsername = [v29 pairingUsername];
      [systemStore updateCurrentiCloudIdentifier:activeAccountIdentifier controllerPairingIdentifier:pairingUsername error:0];
    }

    else if ([transactionResult source] == 1)
    {
      v90 = objc_autoreleasePoolPush();
      v91 = selfCopy3;
      v92 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v92, OS_LOG_TYPE_INFO))
      {
        v93 = HMFGetLogIdentifier();
        v94 = objc_opt_class();
        v95 = NSStringFromClass(v94);
        v96 = NSStringFromSelector(aSelector);
        *buf = 138543874;
        v246 = v93;
        v247 = 2112;
        v248 = v95;
        v249 = 2112;
        v250 = v96;
        _os_log_impl(&dword_229538000, v92, OS_LOG_TYPE_INFO, "%{public}@[%@ %@] Suppressing iCloud identifier update because CoreData storage is enabled", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v90);
      messageCopy = v221;
    }

    defaultRoomUUID = [addCopy defaultRoomUUID];

    if (defaultRoomUUID)
    {
      v98 = objc_alloc(MEMORY[0x277CCAD78]);
      defaultRoomUUID2 = [addCopy defaultRoomUUID];
      v100 = [v98 initWithUUIDString:defaultRoomUUID2];
    }

    else
    {
      v100 = 0;
    }

    v101 = MEMORY[0x277CD1F00];
    presenceAuthorizationStatus = [addCopy presenceAuthorizationStatus];
    v103 = [v101 authWithNumber:presenceAuthorizationStatus];

    v104 = [HMDHome alloc];
    uuid4 = [addCopy uuid];
    v106 = objc_alloc_init(HMDHomeDefaultDataSource);
    v219 = v100;
    v215 = v103;
    v107 = [(HMDHome *)v104 initWithName:name uuid:uuid4 defaultRoomUUID:v100 owner:v29 homeManager:selfCopy3 presenceAuth:v103 dataSource:v106];

    owned = [addCopy owned];
    -[HMDHome setOwnerUser:](v107, "setOwnerUser:", [owned BOOLValue]);

    nameValidator = [(HMDHomeManager *)selfCopy3 nameValidator];
    uuid5 = [(HMDHome *)v107 uuid];
    v111 = [nameValidator addNamespace:uuid5];

    name2 = [(HMDHome *)v107 name];
    uuid6 = [(HMDHomeManager *)selfCopy3 uuid];
    v114 = [(HMDHomeManager *)selfCopy3 addName:name2 namespace:uuid6];

    roomForEntireHome = [(HMDHome *)v107 roomForEntireHome];
    name3 = [roomForEntireHome name];
    uuid7 = [(HMDHome *)v107 uuid];
    v118 = [(HMDHomeManager *)selfCopy3 addName:name3 namespace:uuid7];

    v119 = objc_autoreleasePoolPush();
    v120 = selfCopy3;
    v121 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v121, OS_LOG_TYPE_INFO))
    {
      v122 = HMFGetLogIdentifier();
      pairingUsername2 = [v29 pairingUsername];
      *buf = 138543874;
      v246 = v122;
      v247 = 2112;
      v248 = name;
      v249 = 2112;
      v250 = pairingUsername2;
      _os_log_impl(&dword_229538000, v121, OS_LOG_TYPE_INFO, "%{public}@Created home %@ with administrator %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v119);
    uuid8 = [(HMDHome *)v107 uuid];
    [(HMDHomeManager *)v120 _updateHome:uuid8 configurationVersion:[(HMDHome *)v107 configurationVersion]];

    [(HMDHomeManager *)v120 addHome:v107];
    [(HMDHome *)v107 refreshUserDisplayNames];
    v125 = v220;
    aSelectorb = v107;
    if ([v220 source] == 1)
    {
      v126 = messageCopy;
      v211 = addCopy;
      v127 = objc_autoreleasePoolPush();
      v128 = v120;
      v129 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v129, OS_LOG_TYPE_INFO))
      {
        v130 = HMFGetLogIdentifier();
        name4 = [aSelectorb name];
        *buf = 138543618;
        v246 = v130;
        v247 = 2112;
        v248 = name4;
        _os_log_impl(&dword_229538000, v129, OS_LOG_TYPE_INFO, "%{public}@Saving addition objects created during creation of home %@", buf, 0x16u);
      }

      v213 = v29;

      objc_autoreleasePoolPop(v127);
      backingStore = [aSelectorb backingStore];
      name5 = [v126 name];
      v134 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v135 = [backingStore transaction:name5 options:v134];

      v136 = [aSelectorb backingStoreObjects:4];
      v233 = 0u;
      v234 = 0u;
      v235 = 0u;
      v236 = 0u;
      v137 = [v136 countByEnumeratingWithState:&v233 objects:v244 count:16];
      if (v137)
      {
        v138 = v137;
        v139 = *v234;
        do
        {
          for (i = 0; i != v138; ++i)
          {
            if (*v234 != v139)
            {
              objc_enumerationMutation(v136);
            }

            v141 = *(*(&v233 + 1) + 8 * i);
            objc_opt_class();
            isKindOfClass = objc_opt_isKindOfClass();

            if ((isKindOfClass & 1) == 0 || !v141)
            {
              [v135 add:v141 withMessage:0];
            }
          }

          v138 = [v136 countByEnumeratingWithState:&v233 objects:v244 count:16];
        }

        while (v138);
      }

      [v135 save];

      addCopy = v211;
      v29 = v213;
      messageCopy = v126;
      v125 = v220;
      v107 = aSelectorb;
    }

    source = [v125 source];
    [(HMDHome *)v107 configureWithHomeManager:v120 accessoriesPresent:0 uncommittedTransactions:MEMORY[0x277CBEBF8] source:source];
    if (!-[HMDHome isOwnerUser](v107, "isOwnerUser") || (+[HMDDeviceCapabilities deviceCapabilities](HMDDeviceCapabilities, "deviceCapabilities"), v144 = objc_claimAutoreleasedReturnValue(), v145 = [v144 isResidentCapable], v144, !v145))
    {
LABEL_77:
      [(HMDHomeManager *)v120 updateHomeKitInUsePreferences];
      v155 = [messageCopy mutableCopy];
      [v155 setResponseHandler:0];
      v156 = [v155 copy];
      v157 = [(HMDHome *)v107 updateHomeWithModel:addCopy message:v156];

      zoneID = [(HMDHome *)v107 zoneID];
      ownerName2 = [(HMDHome *)v107 ownerName];
      [(HMDHomeManager *)v120 _addCloudZone:zoneID ownerName:ownerName2];

      v160 = objc_autoreleasePoolPush();
      v161 = v120;
      v162 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v162, OS_LOG_TYPE_INFO))
      {
        v163 = HMFGetLogIdentifier();
        *buf = 138543618;
        v246 = v163;
        v247 = 2112;
        v248 = name;
        _os_log_impl(&dword_229538000, v162, OS_LOG_TYPE_INFO, "%{public}@Add home: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v160);
      homes = [(HMDHomeManager *)v161 homes];
      if ([homes count] == 1)
      {
        v217 = 1;
      }

      else
      {
        primaryHomeUUID = [(HMDHomeManager *)v161 primaryHomeUUID];
        if (primaryHomeUUID)
        {
          v217 = 0;
        }

        else
        {
          v217 = [v220 source] != 1;
        }
      }

      uuidsOfRemovedHomes = [(HMDHomeManager *)v161 uuidsOfRemovedHomes];
      uuid9 = [(HMDHome *)v107 uuid];
      v168 = [uuidsOfRemovedHomes containsObject:uuid9];

      if (v168)
      {
        uuidsOfRemovedHomes2 = [(HMDHomeManager *)v161 uuidsOfRemovedHomes];
        uuid10 = [(HMDHome *)v107 uuid];
        [uuidsOfRemovedHomes2 removeObject:uuid10];

        v171 = objc_autoreleasePoolPush();
        v172 = v161;
        v173 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v173, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v174 = v209 = v155;
          [(HMDHome *)v107 uuid];
          v207 = v161;
          v176 = v175 = messageCopy;
          uUIDString3 = [v176 UUIDString];
          *buf = 138543618;
          v246 = v174;
          v247 = 2112;
          v248 = uUIDString3;
          _os_log_impl(&dword_229538000, v173, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);

          messageCopy = v175;
          v161 = v207;

          v107 = aSelectorb;
          v155 = v209;
        }

        objc_autoreleasePoolPop(v171);
      }

      owner = [(HMDHome *)v107 owner];
      account = [owner account];
      senderCorrelationIdentifier = [account senderCorrelationIdentifier];
      [(HMDHomeManager *)v161 _stopTrackingRemovedHomeUserMergeId:senderCorrelationIdentifier];

      v242[0] = @"kHomeDataKey";
      if ([messageCopy isEntitledForSPIAccess])
      {
        encodeRootObjectForSPIClients(v107);
      }

      else
      {
        encodeRootObjectForIncomingXPCMessage(v107, 0);
      }
      v181 = ;
      v243[0] = v181;
      v242[1] = *MEMORY[0x277CD0260];
      v182 = [MEMORY[0x277CCABB0] numberWithBool:v217];
      v243[1] = v182;
      v183 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v243 forKeys:v242 count:2];
      [messageCopy respondWithPayload:v183];

      v184 = selfCopy4;
      if (-[HMDHome isOwnerUser](v107, "isOwnerUser") && [v220 source] == 1)
      {
        v208 = v161;
        v210 = v155;
        v212 = addCopy;
        v214 = v29;
        backingStore2 = [(HMDHome *)v107 backingStore];
        v186 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v225 = [backingStore2 transaction:@"kBuiltinActionSetsKey" options:v186];

        v231 = 0u;
        v232 = 0u;
        v229 = 0u;
        v230 = 0u;
        obj = [(HMDHome *)v107 builtInActionSetInfo];
        v187 = [obj countByEnumeratingWithState:&v229 objects:v241 count:16];
        if (v187)
        {
          v188 = v187;
          v189 = *v230;
          v190 = *MEMORY[0x277CD2050];
          v191 = *MEMORY[0x277CD2040];
          v192 = *MEMORY[0x277CD2048];
          do
          {
            for (j = 0; j != v188; ++j)
            {
              if (*v230 != v189)
              {
                objc_enumerationMutation(obj);
              }

              v194 = *(*(&v229 + 1) + 8 * j);
              v195 = [HMDActionSetModel alloc];
              v196 = [v194 hmf_UUIDForKey:v190];
              uuid11 = [aSelectorb uuid];
              v198 = [(HMDBackingStoreModelObject *)v195 initWithObjectChangeType:1 uuid:v196 parentUUID:uuid11];

              v199 = [v194 hmf_stringForKey:v191];
              [(HMDActionSetModel *)v198 setName:v199];

              v200 = [v194 hmf_stringForKey:v192];
              [(HMDActionSetModel *)v198 setType:v200];

              [v225 add:v198 withMessage:0];
            }

            v188 = [obj countByEnumeratingWithState:&v229 objects:v241 count:16];
          }

          while (v188);
        }

        [v225 save];
        addCopy = v212;
        v29 = v214;
        v184 = selfCopy4;
        v107 = aSelectorb;
        v161 = v208;
        v155 = v210;
      }

      v239 = *MEMORY[0x277CD0640];
      uuid12 = [(HMDHome *)v107 uuid];
      v240 = uuid12;
      v202 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v240 forKeys:&v239 count:1];

      notificationCenter = [(HMDHomeManager *)v161 notificationCenter];
      [notificationCenter postNotificationName:@"HMDHomeAddedNotification" object:v161 userInfo:v202];

      v204 = v184->_logger;
      if (os_signpost_enabled(v204))
      {
        *buf = 0;
        _os_signpost_emit_with_name_impl(&dword_229538000, v204, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
      }

      v72 = v219;
      if (v217)
      {
        uuid13 = [aSelectorb uuid];
        [(HMDHomeManager *)v161 _changePrimaryHome:uuid13];

        [(HMDHomeManager *)v161 _updateCurrentHomeIfNecessary];
      }

      v24 = v220;
      messageCopy = v221;
LABEL_107:

LABEL_108:
      goto LABEL_109;
    }

    notificationCenter2 = [(HMDHomeManager *)v120 notificationCenter];
    [notificationCenter2 addObserver:v120 selector:sel_handleHomeCurrentDeviceResidentEligibleNotification_ name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:v107];

    appleAccountManager = [(HMDHomeManager *)v120 appleAccountManager];
    device = [appleAccountManager device];

    name6 = [messageCopy name];
    if ([name6 isEqualToString:*MEMORY[0x277CD2080]])
    {
      capabilitiesController = [(HMDHomeManager *)v120 capabilitiesController];
      currentResidentCapabilities = [capabilitiesController currentResidentCapabilities];
      if (currentResidentCapabilities)
      {
        v152 = currentResidentCapabilities;
        isResidentEnabled = [(HMDHomeManager *)v120 isResidentEnabled];

        if (isResidentEnabled)
        {
          residentCapableDevices = [(HMDHome *)v107 residentCapableDevices];
          v154 = [residentCapableDevices containsObject:device];

          if ((v154 & 1) == 0)
          {
            [(HMDHome *)v107 addResidentCapableDevice:device];
          }
        }

        goto LABEL_76;
      }
    }

LABEL_76:
    goto LABEL_77;
  }

  responseHandler3 = [messageCopy responseHandler];

  if (responseHandler3)
  {
    v29 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    responseHandler4 = [messageCopy responseHandler];
    (responseHandler4)[2](responseHandler4, v29, 0);

    setupActivity6 = [(HMDHomeManager *)self setupActivity];

    if (setupActivity6)
    {
      setupActivity7 = [(HMDHomeManager *)self setupActivity];
      v253[0] = @"errorCode";
      v52 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v29, "code")}];
      v254[0] = v52;
      v253[1] = @"domain";
      domain = [v29 domain];
      v54 = domain;
      v55 = &stru_283CF9D50;
      if (domain)
      {
        v55 = domain;
      }

      v254[1] = v55;
      v253[2] = @"HMDHomeModelUUID";
      uuid14 = [addCopy uuid];
      v57 = HMDailyRotatedUUID();
      uUIDString4 = [v57 UUIDString];
      v59 = uUIDString4;
      v60 = @"no uuid";
      if (uUIDString4)
      {
        v60 = uUIDString4;
      }

      v254[2] = v60;
      v61 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v254 forKeys:v253 count:3];

      messageCopy = v221;
      setupActivity8 = [(HMDHomeManager *)self setupActivity];
      [setupActivity8 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];

      v63 = self->_logger;
      if (os_signpost_enabled(v63))
      {
        v64 = v63;
        stringValueSafe2 = [v29 stringValueSafe];
        *buf = 138412290;
        v246 = stringValueSafe2;
        _os_signpost_emit_with_name_impl(&dword_229538000, v64, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "Error=%{signpost.description:attribute}@ ", buf, 0xCu);
      }
    }

    v66 = self->_logger;
    if (os_signpost_enabled(v66))
    {
      *buf = 0;
      _os_signpost_emit_with_name_impl(&dword_229538000, v66, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
    }

    goto LABEL_108;
  }

LABEL_109:

  v206 = *MEMORY[0x277D85DE8];
}

- (id)activeAccountIdentifier
{
  if (self)
  {
    appleAccountManager = [self appleAccountManager];
    accountContext = [appleAccountManager accountContext];
    identifier = [accountContext identifier];
  }

  else
  {
    identifier = 0;
  }

  return identifier;
}

- (id)validateHomeName:(id)name
{
  v20 = *MEMORY[0x277D85DE8];
  nameCopy = name;
  v5 = HMMaxLengthForNaming();
  if ([nameCopy length] > v5)
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v9;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_ERROR, "%{public}@New name is longer than the pre-defined max length", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v10 = MEMORY[0x277CCA9B8];
    v11 = 46;
    goto LABEL_7;
  }

  v12 = [(HMDHomeManager *)self _homeWithName:nameCopy];

  if (v12)
  {
    v10 = MEMORY[0x277CCA9B8];
    v11 = 32;
LABEL_7:
    v13 = [v10 hmErrorWithCode:v11];
    goto LABEL_8;
  }

  uuid = [(HMDHomeManager *)self uuid];
  v13 = [(HMDHomeManager *)self addName:nameCopy namespace:uuid];

  if (v13 && [v13 code] == 31)
  {
    v17 = [MEMORY[0x277CCA9B8] hmErrorWithCode:32];

    v13 = v17;
  }

LABEL_8:

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)_handleRequestAddHome:(id)home
{
  v15 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  hh2FrameworkSwitch = [(HMDHomeManager *)self hh2FrameworkSwitch];
  [hh2FrameworkSwitch checkExistenceOfHH2SentinelZone];

  if (![(HMDHomeManager *)self isHH1EOLEnabled])
  {
    goto LABEL_8;
  }

  activeAccountIdentifier = [(HMDHomeManager *)self activeAccountIdentifier];
  if (activeAccountIdentifier)
  {

LABEL_8:
    [(HMDHomeManager *)self dmHandleRequestAddHome:homeCopy];
    goto LABEL_9;
  }

  if (![(HMDHomeManager *)self isCloudKitRequiredForHH2])
  {
    goto LABEL_8;
  }

  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    v10 = HMFGetLogIdentifier();
    v13 = 138543362;
    v14 = v10;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@No iCloud account. Creating home is not allowed.", &v13, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  v11 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2040];
  [homeCopy respondWithError:v11];

LABEL_9:
  v12 = *MEMORY[0x277D85DE8];
}

- (id)_findHomeModel:(id)model
{
  v20 = *MEMORY[0x277D85DE8];
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  modelCopy = model;
  v4 = [modelCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v16;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v16 != v6)
        {
          objc_enumerationMutation(modelCopy);
        }

        v8 = *(*(&v15 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v9 = v8;
        }

        else
        {
          v9 = 0;
        }

        v10 = v9;

        if (v10)
        {

LABEL_17:
          v12 = v8;
          goto LABEL_18;
        }

        v8 = v8;
        objc_opt_class();
        isKindOfClass = objc_opt_isKindOfClass();

        if ((isKindOfClass & 1) != 0 && v8)
        {
          goto LABEL_17;
        }
      }

      v5 = [modelCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
      v12 = 0;
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v12 = 0;
  }

LABEL_18:

  v13 = *MEMORY[0x277D85DE8];

  return v12;
}

- (void)_handleCurrentHomeChanged:(id)changed
{
  changedCopy = changed;
  messagePayload = [changedCopy messagePayload];
  v5 = [messagePayload hmf_UUIDForKey:@"kCurrentHomeUUIDKey"];

  [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v5 isLocalUpdate:0];
  responseHandler = [changedCopy responseHandler];

  if (responseHandler)
  {
    responseHandler2 = [changedCopy responseHandler];
    responseHandler2[2](responseHandler2, 0, 0);
  }
}

- (void)_sendCurrentHomeToWatch:(id)watch
{
  v27 = *MEMORY[0x277D85DE8];
  watchCopy = watch;
  version = [watchCopy version];
  v6 = +[HMDHomeKitVersion version3];
  v7 = [version isAtLeastVersion:v6];

  if (v7)
  {
    currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];

    if (currentHomeUUID)
    {
      v23 = @"kCurrentHomeUUIDKey";
      currentHomeUUID2 = [(HMDHomeManager *)self currentHomeUUID];
      uUIDString = [currentHomeUUID2 UUIDString];
      v24 = uUIDString;
      v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v24 forKeys:&v23 count:1];
    }

    else
    {
      v21 = @"kNoCurrentHomeKey";
      v22 = MEMORY[0x277CBEC38];
      v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v22 forKeys:&v21 count:1];
    }

    v15 = [HMDRemoteDeviceMessageDestination alloc];
    uuid = [(HMDHomeManager *)self uuid];
    v17 = [(HMDRemoteDeviceMessageDestination *)v15 initWithTarget:uuid device:watchCopy];

    v18 = [MEMORY[0x277D0F818] messageWithName:@"kCurrentHomeChangedNotificationKey" qualityOfService:9 destination:v17 payload:v11];
    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    [messageDispatcher sendMessage:v18 completionHandler:0];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v26 = v14;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Not sending current home update to legacy watch", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_notifyCurrentHomeUpdated:(id)updated isLocalUpdate:(BOOL)update
{
  v48 = *MEMORY[0x277D85DE8];
  updatedCopy = updated;
  currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
  if (!HMFEqualObjects())
  {
    if (updatedCopy)
    {
      v11 = [(HMDHomeManager *)self _homeWithUUID:updatedCopy];
      if (isAppleTV() && v11 && ([v11 isOwnerUser] & 1) == 0)
      {
        v12 = objc_autoreleasePoolPush();
        v13 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
        {
          v14 = HMFGetLogIdentifier();
          uUIDString = [updatedCopy UUIDString];
          *buf = 138543618;
          v43 = v14;
          v44 = 2112;
          v45 = uUIDString;
          _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Not updating current home since user is not owner of home %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v12);
LABEL_26:

        goto LABEL_27;
      }
    }

    else
    {
      v11 = 0;
    }

    isWatch();
    v16 = objc_autoreleasePoolPush();
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543874;
      v43 = v18;
      v44 = 2112;
      v45 = currentHomeUUID;
      v46 = 2112;
      v47 = updatedCopy;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Updating the current home from %@ to %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v16);
    [(HMDHomeManager *)self setCurrentHomeUUID:updatedCopy];
    [(HMDHomeManager *)self _updatePreferencesForCurrentHome];
    if (updatedCopy)
    {
      v40 = @"kCurrentHomeUUIDKey";
      uUIDString2 = [updatedCopy UUIDString];
      v41 = uUIDString2;
      v20 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v41 forKeys:&v40 count:1];
    }

    else
    {
      v38 = @"kNoCurrentHomeKey";
      v39 = MEMORY[0x277CBEC38];
      v20 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v39 forKeys:&v38 count:1];
    }

    v21 = [MEMORY[0x277D0F818] entitledMessageWithName:@"kCurrentHomeChangedNotificationKey" messagePayload:v20];
    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    uuid = [(HMDHomeManager *)self uuid];
    [messageDispatcher sendMessage:v21 target:uuid];

    v35 = 0u;
    v36 = 0u;
    v33 = 0u;
    v34 = 0u;
    watchManager = [(HMDHomeManager *)self watchManager];
    watches = [watchManager watches];

    v26 = [watches countByEnumeratingWithState:&v33 objects:v37 count:16];
    if (v26)
    {
      v27 = v26;
      v28 = *v34;
      do
      {
        v29 = 0;
        do
        {
          if (*v34 != v28)
          {
            objc_enumerationMutation(watches);
          }

          [(HMDHomeManager *)self _sendCurrentHomeToWatch:*(*(&v33 + 1) + 8 * v29++)];
        }

        while (v27 != v29);
        v27 = [watches countByEnumeratingWithState:&v33 objects:v37 count:16];
      }

      while (v27);
    }

    [(HMDHomeManager *)self writeAssistantCurrentHome:v11];
    v30 = objc_opt_new();
    [v30 setObject:updatedCopy forKeyedSubscript:@"HMDCurrentHomeUUIDKey"];
    [v30 setObject:currentHomeUUID forKeyedSubscript:@"HMDPreviousHomeUUIDKey"];
    defaultCenter = [MEMORY[0x277CCAB98] defaultCenter];
    [defaultCenter postNotificationName:@"HMDNotificationCurrentHomeDidChange" object:self userInfo:v30];

    goto LABEL_26;
  }

  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138543618;
    v43 = v10;
    v44 = 2112;
    v45 = updatedCopy;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Current home is already %@, not notifying", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v7);
LABEL_27:

  v32 = *MEMORY[0x277D85DE8];
}

- (void)_updateCurrentHomeIfNecessary
{
  _computedCurrentHomeUUID = [(HMDHomeManager *)self _computedCurrentHomeUUID];
  [(HMDHomeManager *)self _notifyCurrentHomeUpdated:_computedCurrentHomeUUID isLocalUpdate:1];
}

- (id)_computedCurrentHomeUUID
{
  v24 = *MEMORY[0x277D85DE8];
  currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
  v4 = [(HMDHomeManager *)self _homeWithUUID:currentHomeUUID];

  if ([v4 homeLocation] != 1)
  {
LABEL_10:
    __computedCurrentHomeUUID = [(HMDHomeManager *)self __computedCurrentHomeUUID];
    goto LABEL_11;
  }

  _appleMediaAccessoryOfCurrentDevice = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
  home = [_appleMediaAccessoryOfCurrentDevice home];
  v7 = home;
  if (home)
  {
    uuid = [home uuid];
    uuid2 = [v4 uuid];
    v10 = [uuid hmf_isEqualToUUID:uuid2];

    if (!v10)
    {
      v16 = objc_autoreleasePoolPush();
      selfCopy = self;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v22 = 138543362;
        v23 = v19;
        _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_INFO, "%{public}@Current home does not match current accessory home, recalculating...", &v22, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      goto LABEL_10;
    }
  }

  v11 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v14;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Last current home still has AtHome status, stay as current home", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v11);
  __computedCurrentHomeUUID = [v4 uuid];

LABEL_11:
  v20 = *MEMORY[0x277D85DE8];

  return __computedCurrentHomeUUID;
}

- (id)__computedCurrentHomeUUID
{
  v50 = *MEMORY[0x277D85DE8];
  overrideCurrentHomeUUIDToNil = [(HMDHomeManager *)self overrideCurrentHomeUUIDToNil];
  v4 = overrideCurrentHomeUUIDToNil;
  if (overrideCurrentHomeUUIDToNil)
  {
    if ([overrideCurrentHomeUUIDToNil BOOLValue])
    {
      currentHomeUUIDOverride = 0;
    }

    else
    {
      currentHomeUUIDOverride = [(HMDHomeManager *)self currentHomeUUIDOverride];
    }
  }

  else
  {
    _appleMediaAccessoryOfCurrentDevice = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
    home = [_appleMediaAccessoryOfCurrentDevice home];
    if (home)
    {
      v8 = objc_autoreleasePoolPush();
      selfCopy = self;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543618;
        v47 = v11;
        v48 = 2112;
        v49 = home;
        _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Returning current accessory home %@ as current home", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v8);
      currentHomeUUIDOverride = [home uuid];
    }

    else
    {
      v40 = _appleMediaAccessoryOfCurrentDevice;
      v12 = objc_alloc(MEMORY[0x277CBEB18]);
      homes = [(HMDHomeManager *)self homes];
      v14 = [v12 initWithCapacity:{objc_msgSend(homes, "count")}];

      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      homes2 = [(HMDHomeManager *)self homes];
      v16 = [homes2 countByEnumeratingWithState:&v41 objects:v45 count:16];
      if (v16)
      {
        v17 = v16;
        v18 = *v42;
        while (2)
        {
          for (i = 0; i != v17; ++i)
          {
            if (*v42 != v18)
            {
              objc_enumerationMutation(homes2);
            }

            v20 = *(*(&v41 + 1) + 8 * i);
            if ([v20 homeLocation] == 3 || objc_msgSend(v20, "homeLocation") == 1)
            {
              uuid = [v20 uuid];
              primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];
              v23 = [uuid isEqual:primaryHomeUUID];

              if (v23)
              {
                v30 = objc_autoreleasePoolPush();
                selfCopy2 = self;
                v32 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
                {
                  v33 = HMFGetLogIdentifier();
                  *buf = 138543618;
                  v47 = v33;
                  v48 = 2112;
                  v49 = v20;
                  _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_INFO, "%{public}@New nominated current home is primary home : %@", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v30);
                currentHomeUUIDOverride = [v20 uuid];

                goto LABEL_27;
              }

              [v14 addObject:v20];
            }
          }

          v17 = [homes2 countByEnumeratingWithState:&v41 objects:v45 count:16];
          if (v17)
          {
            continue;
          }

          break;
        }
      }

      if ([v14 count])
      {
        [v14 sortUsingComparator:&__block_literal_global_952];
        v24 = objc_autoreleasePoolPush();
        selfCopy3 = self;
        v26 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          firstObject = [v14 firstObject];
          *buf = 138543618;
          v47 = v27;
          v48 = 2112;
          v49 = firstObject;
          _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_INFO, "%{public}@New nominated current home is %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v24);
        firstObject2 = [v14 firstObject];
        currentHomeUUIDOverride = [firstObject2 uuid];
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        selfCopy4 = self;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          *buf = 138543362;
          v47 = v39;
          _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_INFO, "%{public}@There is no current home", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v36);
        currentHomeUUIDOverride = 0;
      }

LABEL_27:
      _appleMediaAccessoryOfCurrentDevice = v40;
      v4 = 0;
      home = 0;
    }
  }

  v34 = *MEMORY[0x277D85DE8];

  return currentHomeUUIDOverride;
}

uint64_t __43__HMDHomeManager___computedCurrentHomeUUID__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v4 = a3;
  v5 = [a2 uuid];
  v6 = [v5 UUIDString];
  v7 = [v4 uuid];

  v8 = [v7 UUIDString];
  v9 = [v6 compare:v8];

  return v9;
}

- (void)_handleConnectivityInfoRequest:(id)request
{
  v73 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  responseHandler = [requestCopy responseHandler];

  if (responseHandler)
  {
    if ([requestCopy isEntitledForSPIAccess])
    {
      if ([requestCopy isRemote])
      {
        v6 = objc_autoreleasePoolPush();
        selfCopy4 = self;
        v8 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          v9 = HMFGetLogIdentifier();
          *buf = 138543618;
          v70 = v9;
          v71 = 2112;
          v72 = requestCopy;
          v10 = "%{public}@This message should only be passed over XPC: %@";
          v11 = v8;
          v12 = OS_LOG_TYPE_DEFAULT;
LABEL_12:
          _os_log_impl(&dword_229538000, v11, v12, v10, buf, 0x16u);
        }

LABEL_13:

        objc_autoreleasePoolPop(v6);
        responseHandler2 = [requestCopy responseHandler];
        responseHandler4 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        responseHandler2[2](responseHandler2, responseHandler4, 0);
LABEL_14:

        goto LABEL_15;
      }

      proxyConnection = [requestCopy proxyConnection];
      entitlements = [proxyConnection entitlements];

      if ((entitlements & 0x100) != 0)
      {
        responseHandler2 = [requestCopy stringForKey:@"kIdentifierKey"];
        v22 = objc_autoreleasePoolPush();
        selfCopy2 = self;
        v24 = HMFGetOSLogHandle();
        v25 = os_log_type_enabled(v24, OS_LOG_TYPE_INFO);
        if (responseHandler2)
        {
          v53 = requestCopy;
          if (v25)
          {
            v26 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v26;
            v71 = 2112;
            v72 = responseHandler2;
            _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve connectivity info for identifier : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
          v63 = 0u;
          v64 = 0u;
          v61 = 0u;
          v62 = 0u;
          v52 = selfCopy2;
          obj = [(HMDHomeManager *)selfCopy2 homes];
          v56 = [obj countByEnumeratingWithState:&v61 objects:v68 count:16];
          if (v56)
          {
            v55 = *v62;
            while (2)
            {
              for (i = 0; i != v56; ++i)
              {
                if (*v62 != v55)
                {
                  objc_enumerationMutation(obj);
                }

                v28 = *(*(&v61 + 1) + 8 * i);
                v57 = 0u;
                v58 = 0u;
                v59 = 0u;
                v60 = 0u;
                accessories = [v28 accessories];
                v30 = [accessories copy];

                v31 = [v30 countByEnumeratingWithState:&v57 objects:v67 count:16];
                if (v31)
                {
                  v32 = v31;
                  v33 = *v58;
LABEL_29:
                  v34 = 0;
                  while (1)
                  {
                    if (*v58 != v33)
                    {
                      objc_enumerationMutation(v30);
                    }

                    v35 = *(*(&v57 + 1) + 8 * v34);
                    objc_opt_class();
                    v36 = (objc_opt_isKindOfClass() & 1) != 0 ? v35 : 0;
                    v37 = v36;

                    identifier = [v37 identifier];
                    v39 = HMFAreStringsEqualIgnoringCase();

                    if (v39)
                    {
                      break;
                    }

                    if (v32 == ++v34)
                    {
                      v32 = [v30 countByEnumeratingWithState:&v57 objects:v67 count:16];
                      if (v32)
                      {
                        goto LABEL_29;
                      }

                      goto LABEL_41;
                    }
                  }

                  connectivityInfo = [v37 connectivityInfo];
                  v41 = encodeRootObject();
                  if (!v41)
                  {

                    goto LABEL_41;
                  }

                  v49 = v41;
                  requestCopy = v53;
                  responseHandler3 = [v53 responseHandler];
                  v65 = *MEMORY[0x277CCE9C8];
                  v66 = v49;
                  v51 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v66 forKeys:&v65 count:1];
                  (responseHandler3)[2](responseHandler3, 0, v51);

                  responseHandler4 = obj;
                  goto LABEL_51;
                }

LABEL_41:
              }

              v56 = [obj countByEnumeratingWithState:&v61 objects:v68 count:16];
              if (v56)
              {
                continue;
              }

              break;
            }
          }

          v42 = objc_autoreleasePoolPush();
          v43 = v52;
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
          {
            v45 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v45;
            v71 = 2112;
            v72 = responseHandler2;
            _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_INFO, "%{public}@Unable to get connectivity info accessory identifier: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v42);
          requestCopy = v53;
          responseHandler4 = [v53 responseHandler];
          v46 = MEMORY[0x277CCA9B8];
          v47 = 2;
        }

        else
        {
          if (v25)
          {
            v48 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v48;
            v71 = 2112;
            v72 = requestCopy;
            _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve identifier from message: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
          responseHandler4 = [requestCopy responseHandler];
          v46 = MEMORY[0x277CCA9B8];
          v47 = 3;
        }

        v30 = [v46 hmErrorWithCode:v47];
        (responseHandler4)[2](responseHandler4, v30, 0);
LABEL_51:

        goto LABEL_14;
      }

      v6 = objc_autoreleasePoolPush();
      selfCopy4 = self;
      v8 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
      {
        goto LABEL_13;
      }

      v9 = HMFGetLogIdentifier();
      *buf = 138543618;
      v70 = v9;
      v71 = 2112;
      v72 = requestCopy;
      v10 = "%{public}@Unable to retrieve connectivity info due to insufficient privileges for message: %@";
    }

    else
    {
      v6 = objc_autoreleasePoolPush();
      selfCopy4 = self;
      v8 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
      {
        goto LABEL_13;
      }

      v9 = HMFGetLogIdentifier();
      *buf = 138543618;
      v70 = v9;
      v71 = 2112;
      v72 = requestCopy;
      v10 = "%{public}@Unable to retrieve connectivity info due to insufficient internal privileges for message: %@";
    }

    v11 = v8;
    v12 = OS_LOG_TYPE_INFO;
    goto LABEL_12;
  }

  v13 = objc_autoreleasePoolPush();
  selfCopy5 = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v16 = HMFGetLogIdentifier();
    *buf = 138543618;
    v70 = v16;
    v71 = 2112;
    v72 = requestCopy;
    _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@No response handler in _handleConnectivityInfoRequest: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v13);
LABEL_15:

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleForwardedSharedUserInvitationAcceptance:(id)acceptance
{
  acceptanceCopy = acceptance;
  idsInvitationManager = [(HMDHomeManager *)self idsInvitationManager];
  [idsInvitationManager handleForwardedAcceptance:acceptanceCopy];
}

- (void)_handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest:(id)request
{
  v36 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  v5 = [requestCopy uuidForKey:@"kIdentifierKey"];
  if (v5)
  {
    homes = [(HMDHomeManager *)self homes];
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __90__HMDHomeManager__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest___block_invoke;
    v26[3] = &unk_278685BA0;
    v7 = v5;
    v27 = v7;
    v8 = [homes na_firstObjectPassingTest:v26];

    if (v8)
    {
      currentUser = [v8 currentUser];
      v10 = objc_autoreleasePoolPush();
      selfCopy = self;
      v12 = HMFGetOSLogHandle();
      v13 = os_log_type_enabled(v12, OS_LOG_TYPE_INFO);
      if (currentUser)
      {
        if (v13)
        {
          v14 = HMFGetLogIdentifier();
          *buf = 138544130;
          v29 = v14;
          v30 = 2112;
          v31 = currentUser;
          v32 = 2112;
          v33 = v8;
          v34 = 2112;
          v35 = v7;
          _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve pairing identity for current user (%@) in home (%@) with accessory identifier : %@", buf, 0x2Au);
        }

        objc_autoreleasePoolPop(v10);
        [currentUser fetchPairingIdentityForClientWithMessage:requestCopy];
      }

      else
      {
        if (v13)
        {
          v24 = HMFGetLogIdentifier();
          *buf = 138543618;
          v29 = v24;
          v30 = 2112;
          v31 = v8;
          _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@No current user in home: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v10);
        currentUser = 0;
      }
    }

    else
    {
      v20 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543618;
        v29 = v23;
        v30 = 2112;
        v31 = v7;
        _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Unable to find accessory (%@) in any home", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v20);
      currentUser = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [requestCopy respondWithError:currentUser];
    }

    v19 = v27;
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543618;
      v29 = v18;
      v30 = 2112;
      v31 = requestCopy;
      _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve accessory unique identifier from message: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [requestCopy respondWithError:v19];
  }

  v25 = *MEMORY[0x277D85DE8];
}

BOOL __90__HMDHomeManager__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest___block_invoke(uint64_t a1, void *a2)
{
  v2 = [a2 accessoryWithSPIClientIdentifier:*(a1 + 32)];
  v3 = v2 != 0;

  return v3;
}

- (void)_handlePairingIdentityRequest:(id)request
{
  v64 = *MEMORY[0x277D85DE8];
  requestCopy = request;
  proxyConnection = [requestCopy proxyConnection];
  entitlements = [proxyConnection entitlements];

  v5 = [requestCopy stringForKey:@"kIdentifierKey"];
  if (v5)
  {
    v6 = objc_autoreleasePoolPush();
    selfCopy = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      *&buf[4] = v8;
      *&buf[12] = 2112;
      *&buf[14] = v5;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve pairing identity for identifier : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    v52 = 0u;
    v53 = 0u;
    v51 = 0u;
    v50 = 0u;
    obj = [(HMDHomeManager *)selfCopy homes];
    v38 = [obj countByEnumeratingWithState:&v50 objects:v63 count:16];
    if (v38)
    {
      v9 = *v51;
      v37 = *v51;
      do
      {
        for (i = 0; i != v38; ++i)
        {
          if (*v51 != v9)
          {
            objc_enumerationMutation(obj);
          }

          v11 = *(*(&v50 + 1) + 8 * i);
          v46 = 0u;
          v47 = 0u;
          v48 = 0u;
          v49 = 0u;
          accessories = [v11 accessories];
          v13 = [accessories copy];

          v14 = [v13 countByEnumeratingWithState:&v46 objects:v62 count:16];
          if (v14)
          {
            v15 = *v47;
            while (2)
            {
              for (j = 0; j != v14; ++j)
              {
                if (*v47 != v15)
                {
                  objc_enumerationMutation(v13);
                }

                v17 = *(*(&v46 + 1) + 8 * j);
                if ([v17 conformsToProtocol:&unk_283F01280])
                {
                  v18 = v17;
                }

                else
                {
                  v18 = 0;
                }

                pairingIdentity = [v18 pairingIdentity];

                identifier = [pairingIdentity identifier];
                v21 = HMFAreStringsEqualIgnoringCase();

                if (v21)
                {
                  [(HMDHomeManager *)selfCopy sendPairingIdentity:pairingIdentity includePrivateKey:(entitlements >> 4) & 1 requestMessage:requestCopy];

                  goto LABEL_32;
                }
              }

              v14 = [v13 countByEnumeratingWithState:&v46 objects:v62 count:16];
              if (v14)
              {
                continue;
              }

              break;
            }
          }

          v9 = v37;
        }

        v38 = [obj countByEnumeratingWithState:&v50 objects:v63 count:16];
        v9 = v37;
      }

      while (v38);
    }

    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x3032000000;
    v59 = __Block_byref_object_copy__254244;
    v60 = __Block_byref_object_dispose__254245;
    v61 = 0;
    backingStore = [(HMDHomeManager *)selfCopy backingStore];
    context = [backingStore context];
    v43[0] = MEMORY[0x277D85DD0];
    v43[1] = 3221225472;
    v43[2] = __48__HMDHomeManager__handlePairingIdentityRequest___block_invoke;
    v43[3] = &unk_27868A4D8;
    v43[4] = selfCopy;
    v45 = buf;
    v24 = v5;
    v44 = v24;
    [context unsafeSynchronousBlock:v43];

    v25 = *(*&buf[8] + 40);
    if (v25)
    {
      [(HMDHomeManager *)selfCopy sendPairingIdentity:v25 includePrivateKey:(entitlements >> 4) & 1 requestMessage:requestCopy];
    }

    else
    {
      v31 = objc_autoreleasePoolPush();
      v32 = selfCopy;
      v33 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
      {
        v34 = HMFGetLogIdentifier();
        *v54 = 138543618;
        v55 = v34;
        v56 = 2112;
        v57 = v24;
        _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve pairing identity for accessory: %@", v54, 0x16u);
      }

      objc_autoreleasePoolPop(v31);
      v35 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [requestCopy respondWithError:v35];
    }

    _Block_object_dispose(buf, 8);
  }

  else
  {
    v26 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      *buf = 138543618;
      *&buf[4] = v29;
      *&buf[12] = 2112;
      *&buf[14] = requestCopy;
      _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve identifier from message: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
    v30 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [requestCopy respondWithError:v30];
  }

LABEL_32:

  v36 = *MEMORY[0x277D85DE8];
}

void __48__HMDHomeManager__handlePairingIdentityRequest___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) homes];
  v3 = [v2 na_flatMap:&__block_literal_global_947];

  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __48__HMDHomeManager__handlePairingIdentityRequest___block_invoke_3;
  v8[3] = &unk_278685C88;
  v9 = *(a1 + 40);
  v4 = [v3 na_firstObjectPassingTest:v8];
  v5 = [v4 pairingIdentity];
  v6 = *(*(a1 + 48) + 8);
  v7 = *(v6 + 40);
  *(v6 + 40) = v5;
}

uint64_t __48__HMDHomeManager__handlePairingIdentityRequest___block_invoke_3(uint64_t a1, void *a2)
{
  v3 = [a2 pairingIdentity];
  v4 = [v3 identifier];
  v5 = *(a1 + 32);
  v6 = HMFAreStringsEqualIgnoringCase();

  return v6;
}

id __48__HMDHomeManager__handlePairingIdentityRequest___block_invoke_2(uint64_t a1, void *a2)
{
  v2 = [a2 uuid];
  v3 = [HMCContext findHomeWithModelID:v2];
  v4 = [v3 residents];

  return v4;
}

- (void)sendPairingIdentity:(id)identity includePrivateKey:(BOOL)key requestMessage:(id)message
{
  v38 = *MEMORY[0x277D85DE8];
  identityCopy = identity;
  messageCopy = message;
  if (key)
  {
    v10 = identityCopy;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v11 = v10;
    }

    else
    {
      v11 = 0;
    }

    v12 = v11;

    if (v12)
    {
      v13 = objc_alloc(MEMORY[0x277D0F8A8]);
      identifier = [v12 identifier];
      publicKey = [v12 publicKey];
      privateKey = [v12 privateKey];
      publicPairingIdentity = [v13 initWithIdentifier:identifier publicKey:publicKey privateKey:privateKey];
    }

    else
    {
      publicPairingIdentity = v10;
    }
  }

  else
  {
    publicPairingIdentity = [identityCopy publicPairingIdentity];
  }

  v18 = objc_autoreleasePoolPush();
  selfCopy = self;
  v20 = HMFGetOSLogHandle();
  v21 = os_log_type_enabled(v20, OS_LOG_TYPE_INFO);
  if (publicPairingIdentity)
  {
    if (v21)
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v22;
      v36 = 2112;
      v37 = identityCopy;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Sending the pairing identity %@ to client", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v23 = encodeRootObject();
    v24 = v23;
    if (v23)
    {
      v32 = *MEMORY[0x277CCEC20];
      v33 = v23;
      v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v33 forKeys:&v32 count:1];
      [messageCopy respondWithPayload:v25];
    }

    else
    {
      v27 = objc_autoreleasePoolPush();
      v28 = selfCopy;
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543618;
        v35 = v30;
        v36 = 2112;
        v37 = identityCopy;
        _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_ERROR, "%{public}@Unable to encode the pairing identity : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v27);
      v25 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
      [messageCopy respondWithError:v25];
    }
  }

  else
  {
    if (v21)
    {
      v26 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v26;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve pairing identity", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    v24 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    [messageCopy respondWithError:v24];
  }

  v31 = *MEMORY[0x277D85DE8];
}

- (BOOL)hasClientRequestedMediaAccessoryControl:(id)control
{
  clientIdentifier = [control clientIdentifier];
  if (clientIdentifier)
  {
    homes = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __58__HMDHomeManager_hasClientRequestedMediaAccessoryControl___block_invoke;
    v8[3] = &unk_278685BA0;
    v9 = clientIdentifier;
    v6 = [homes na_any:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

- (void)_handleRequestRuntimeStateUpdate:(id)update
{
  updateCopy = update;
  homeManagerOptions = [updateCopy homeManagerOptions];
  isEntitledForSPIAccess = [updateCopy isEntitledForSPIAccess];
  if ((homeManagerOptions & 0x18741) != 0)
  {
    v7 = isEntitledForSPIAccess;
    v8 = [(HMDHomeManager *)self hasClientRequestedMediaAccessoryControl:updateCopy];
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __51__HMDHomeManager__handleRequestRuntimeStateUpdate___block_invoke;
    v9[3] = &unk_278685C40;
    v10 = updateCopy;
    [(HMDHomeManager *)self _getRuntimeStateUpdateForHomeManager:v7 includeMediaAccessorySessionState:v8 options:homeManagerOptions includeResidentDeviceState:v7 completion:v9];
  }

  else
  {
    [updateCopy respondWithPayload:0];
  }
}

void __51__HMDHomeManager__handleRequestRuntimeStateUpdate___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = [*(a1 + 32) responseHandler];

  if (v3)
  {
    v4 = [*(a1 + 32) responseHandler];
    (v4)[2](v4, 0, v5);
  }
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke(id *a1, void *a2)
{
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 7);
  v5 = WeakRetained;
  if (WeakRetained)
  {
    v6 = [WeakRetained workQueue];
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_2;
    v7[3] = &unk_2786891E0;
    v8 = v3;
    v9 = a1[4];
    v10 = a1[5];
    v11 = a1[6];
    dispatch_async(v6, v7);
  }
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_3(uint64_t a1)
{
  if (*(a1 + 56) == 1)
  {
    v2 = *(a1 + 32);
    v3 = [*(a1 + 40) _runtimeState];
    [v2 addEntriesFromDictionary:v3];
  }

  v4 = *(a1 + 48);
  v5 = [*(a1 + 32) copy];
  (*(v4 + 16))(v4, v5);
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_2(uint64_t a1)
{
  v2 = *(a1 + 32);
  if (v2)
  {
    [*(a1 + 40) setObject:v2 forKey:*(a1 + 48)];
  }

  v3 = *(a1 + 56);

  dispatch_group_leave(v3);
}

- (id)_runtimeState
{
  v16[4] = *MEMORY[0x277D85DE8];
  currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];

  if (currentHomeUUID)
  {
    v4 = @"kCurrentHomeUUIDKey";
    v5 = @"kCurrentHomeUUIDKey";
    currentHomeUUID2 = [(HMDHomeManager *)self currentHomeUUID];
    uUIDString = [currentHomeUUID2 UUIDString];
  }

  else
  {
    v4 = @"kNoCurrentHomeKey";
    v8 = @"kNoCurrentHomeKey";
    uUIDString = MEMORY[0x277CBEC38];
  }

  v15[0] = @"kResidentCapableDeviceKey";
  v9 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentCapable](self, "isResidentCapable")}];
  v16[0] = v9;
  v15[1] = @"kResidentEnabledKey";
  v10 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentEnabled](self, "isResidentEnabled")}];
  v16[1] = v10;
  v15[2] = @"kAccessAllowedWhenLockedKey";
  v11 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isAccessAllowedWhenLocked](self, "isAccessAllowedWhenLocked")}];
  v15[3] = v4;
  v16[2] = v11;
  v16[3] = uUIDString;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v16 forKeys:v15 count:4];

  v13 = *MEMORY[0x277D85DE8];

  return v12;
}

- (void)__handleRequestFetchHomeConfiguration:(id)configuration
{
  v246[1] = *MEMORY[0x277D85DE8];
  configurationCopy = configuration;
  homeManagerOptions = [configurationCopy homeManagerOptions];
  isEntitledForSPIAccess = [configurationCopy isEntitledForSPIAccess];
  v7 = objc_autoreleasePoolPush();
  selfCopy = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    [configurationCopy clientName];
    v11 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    HMHomeManagerOptionsShortDescription();
    v13 = v12 = homeManagerOptions;
    *buf = 138543874;
    v233 = v10;
    v234 = 2112;
    v235 = v11;
    v236 = 2112;
    v237 = v13;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Received fetch from client, %@, with options: %@", buf, 0x20u);

    homeManagerOptions = v12;
  }

  objc_autoreleasePoolPop(v7);
  v14 = MEMORY[0x277CBEB38];
  v245 = *MEMORY[0x277CD02D8];
  v15 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:homeManagerOptions];
  v246[0] = v15;
  v16 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v246 forKeys:&v245 count:1];
  v17 = [v14 dictionaryWithDictionary:v16];

  v230 = 0;
  [(HMDHomeManager *)selfCopy determineDataSyncSateForHH2:&v230 homeManagerDataSyncState:0 homeManagerStatus:0];
  if ((v230 & 1) == 0)
  {
    clientIdentifier = [configurationCopy clientIdentifier];
    v19 = [clientIdentifier isEqual:*MEMORY[0x277CCFE40]];

    if (v19)
    {
      [(HMDHomeManager *)selfCopy _autoAcceptAllPendingReinvitations];
    }
  }

  v20 = objc_autoreleasePoolPush();
  v21 = selfCopy;
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
  {
    v23 = HMFGetLogIdentifier();
    HMFBooleanToString();
    v24 = configurationCopy;
    v25 = v17;
    v26 = homeManagerOptions;
    v27 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    *buf = 138543618;
    v233 = v23;
    v234 = 2112;
    v235 = v27;
    _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Handling fetch home configuration request, data sync in progress : %@", buf, 0x16u);

    homeManagerOptions = v26;
    v17 = v25;
    configurationCopy = v24;
  }

  objc_autoreleasePoolPop(v20);
  if ([configurationCopy BOOLForKey:@"kCanUseCachedHomeConfigurationKey"])
  {
    isEntitledForSPIAccess2 = [configurationCopy isEntitledForSPIAccess];
    if (isEntitledForSPIAccess2 && homeManagerOptions != -1)
    {
      v29 = objc_autoreleasePoolPush();
      v30 = v21;
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        *buf = 138543362;
        v233 = v32;
        _os_log_impl(&dword_229538000, v31, OS_LOG_TYPE_INFO, "%{public}@Client has specified partial options, not using cache", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v29);
      isEntitledForSPIAccess2 = 0;
    }

    v33 = [MEMORY[0x277CCABB0] numberWithBool:isEntitledForSPIAccess2];
    [v17 setObject:v33 forKeyedSubscript:@"kCanUseCachedHomeConfigurationKey"];

    v34 = [v17 copy];
    [configurationCopy respondWithPayload:v34];
    goto LABEL_129;
  }

  v222 = isEntitledForSPIAccess;
  v34 = [configurationCopy numberForKey:@"kConfigGenerationCounterKey"];
  v35 = [configurationCopy numberForKey:@"kHAPMetadataVersionKey"];
  v36 = v35;
  if (!v34 || !v35)
  {
    [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    v38 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    [configurationCopy respondWithError:*&v38];
    goto LABEL_128;
  }

  if (isAppleTV() && v230 == 1)
  {
    v37 = MEMORY[0x277CCA9B8];
    [(HMDHomeManager *)v21 _statusPayloadForMessage:configurationCopy];
    v38 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    v39 = [v37 hmErrorWithCode:77 userInfo:*&v38];
    [configurationCopy respondWithError:v39];

    goto LABEL_128;
  }

  v219 = homeManagerOptions;
  proxyConnection = [configurationCopy proxyConnection];
  processInfo = [proxyConnection processInfo];
  v229 = 0;
  v42 = [processInfo clientIdentifierSalt:&v229];
  v38 = COERCE_DOUBLE(v229);

  if (!v42)
  {
    v55 = objc_autoreleasePoolPush();
    v56 = v21;
    v57 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
    {
      HMFGetLogIdentifier();
      v59 = v58 = v38;
      *buf = 138543618;
      v233 = v59;
      v234 = 2112;
      v235 = v58;
      _os_log_impl(&dword_229538000, v57, OS_LOG_TYPE_ERROR, "%{public}@Cannot send out home data because client identifier salt could not be determined: %@", buf, 0x16u);

      v38 = v58;
    }

    objc_autoreleasePoolPop(v55);
    [configurationCopy respondWithError:*&v38];
    goto LABEL_127;
  }

  v213 = v42;
  [v17 setObject:v42 forKeyedSubscript:@"kIdentifierSaltKey"];
  if ([configurationCopy isEntitledForAssistantIdentifiers])
  {
    _getAssistantHashingData = [(HMDHomeManager *)v21 _getAssistantHashingData];
    [v17 setObject:_getAssistantHashingData forKeyedSubscript:*MEMORY[0x277CD0088]];
  }

  v214 = v38;
  v44 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{-[HMDHomeManager generationCounter](v21, "generationCounter")}];
  [v17 setObject:v44 forKeyedSubscript:@"kConfigGenerationCounterKey"];

  v45 = +[HMDHAPMetadata getSharedInstance];
  version = [v45 version];

  if (version)
  {
    version2 = [v45 version];
    [v17 setObject:version2 forKeyedSubscript:@"kHAPMetadataVersionKey"];
  }

  v48 = [(HMDHomeManager *)v21 _statusPayloadForMessage:configurationCopy];
  [v17 addEntriesFromDictionary:v48];

  v218 = v34;
  unsignedIntegerValue = [v34 unsignedIntegerValue];
  generationCounter = [(HMDHomeManager *)v21 generationCounter];
  v216 = v36;
  unsignedIntegerValue2 = [v36 unsignedIntegerValue];
  v217 = v45;
  version3 = [v45 version];
  unsignedIntegerValue3 = [version3 unsignedIntegerValue];

  if (v222)
  {
    v54 = ![(HMDHomeManager *)v21 cacheUseAllowed];
  }

  else
  {
    v54 = 0;
  }

  v60 = [(HMDHomeManager *)v21 hasClientRequestedMediaAccessoryControl:configurationCopy];
  v221 = v21;
  if (v54)
  {
    v209 = v230;
    v210 = v60;
    v212 = v54;
    v61 = objc_autoreleasePoolPush();
    v62 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v62, OS_LOG_TYPE_INFO))
    {
      v63 = HMFGetLogIdentifier();
      HMFBooleanToString();
      v64 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
      v65 = HMFBooleanToString();
      *buf = 138543874;
      v233 = v63;
      v234 = 2112;
      v235 = v64;
      v236 = 2112;
      v237 = v65;
      _os_log_impl(&dword_229538000, v62, OS_LOG_TYPE_INFO, "%{public}@Forcing SPI entitled client to not use cached home configuration homeCounterMatch %@  metadataVersionMatch %@", buf, 0x20u);
    }

    v208 = unsignedIntegerValue2 != unsignedIntegerValue3;

    objc_autoreleasePoolPop(v61);
    v66 = 0x277CCA000;
    v34 = v218;
    v67 = v219;
  }

  else
  {
    if (unsignedIntegerValue == generationCounter && unsignedIntegerValue2 == unsignedIntegerValue3)
    {
      v78 = objc_autoreleasePoolPush();
      v79 = v21;
      v80 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v80, OS_LOG_TYPE_DEFAULT))
      {
        v81 = HMFGetLogIdentifier();
        v82 = COERCE_DOUBLE([(HMDHomeManager *)v79 generationCounter]);
        version4 = [v217 version];
        [configurationCopy clientIdentifier];
        v84 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
        *buf = 138544130;
        v233 = v81;
        v234 = 2048;
        v235 = v82;
        v236 = 2112;
        v237 = version4;
        v238 = 2112;
        v239 = v84;
        _os_log_impl(&dword_229538000, v80, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager generation counter %lu/metadata version %@ matches the client(%@)", buf, 0x2Au);
      }

      objc_autoreleasePoolPop(v78);
      v85 = 1;
LABEL_101:
      v66 = 0x277CCA000;
      v34 = v218;
      goto LABEL_105;
    }

    v209 = v230;
    v210 = v60;
    v212 = 0;
    v208 = unsignedIntegerValue2 != unsignedIntegerValue3;
    v86 = unsignedIntegerValue == generationCounter;
    v66 = 0x277CCA000;
    v34 = v218;
    v67 = v219;
    if (v86)
    {
      goto LABEL_94;
    }
  }

  v68 = objc_autoreleasePoolPush();
  v69 = v221;
  v70 = HMFGetOSLogHandle();
  v215 = v69;
  if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
  {
    v71 = HMFGetLogIdentifier();
    v72 = COERCE_DOUBLE([(HMDHomeManager *)v215 generationCounter]);
    clientIdentifier2 = [configurationCopy clientIdentifier];
    v74 = COERCE_DOUBLE([v34 unsignedIntegerValue]);
    *buf = 138544386;
    v75 = "";
    v233 = v71;
    if (v212)
    {
      v75 = " (forced to update anyways)";
    }

    v234 = 2048;
    v235 = v72;
    v236 = 2112;
    v237 = clientIdentifier2;
    v238 = 2048;
    v239 = v74;
    v240 = 2080;
    v241 = v75;
    _os_log_impl(&dword_229538000, v70, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager generation counter %lu does not match client's (%@) value of %lu%s.", buf, 0x34u);

    v69 = v215;
    v67 = v219;
  }

  objc_autoreleasePoolPop(v68);
  if ((*&v67 & 0x19FCDLL) == 0)
  {
    if ((v67 & 0x10) != 0)
    {
      _accessoryOfCurrentDevice = [(HMDHomeManager *)v69 _accessoryOfCurrentDevice];
      [_accessoryOfCurrentDevice home];
      v93 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());

      if (v93 != 0.0)
      {
        v94 = objc_autoreleasePoolPush();
        v95 = v215;
        v96 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v96, OS_LOG_TYPE_INFO))
        {
          v97 = HMFGetLogIdentifier();
          *buf = 138543618;
          v233 = v97;
          v234 = 2112;
          v235 = v93;
          _os_log_impl(&dword_229538000, v96, OS_LOG_TYPE_INFO, "%{public}@Encoding home containing current device's accessory: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v94);
        v231 = v93;
        v98 = [MEMORY[0x277CBEA60] arrayWithObjects:&v231 count:1];
        v99 = encodeRootObjectForIncomingXPCMessage(v98, configurationCopy);
        [v17 setObject:v99 forKeyedSubscript:@"kHomeDataKey"];

        if (v222)
        {
          currentHomeUUID = [(HMDHomeManager *)v95 currentHomeUUID];
          uuid = [*&v93 uuid];
          v102 = [currentHomeUUID isEqual:uuid];

          if (v102)
          {
            currentHomeUUID2 = [(HMDHomeManager *)v95 currentHomeUUID];
            uUIDString = [currentHomeUUID2 UUIDString];
            [v17 setObject:uUIDString forKeyedSubscript:@"kCurrentHomeUUIDKey"];
          }
        }
      }
    }

    else
    {
      v87 = objc_autoreleasePoolPush();
      v88 = v69;
      v89 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v89, OS_LOG_TYPE_DEFAULT))
      {
        v90 = HMFGetLogIdentifier();
        HMHomeManagerOptionsToString();
        v91 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
        *buf = 138543618;
        v233 = v90;
        v234 = 2112;
        v235 = v91;
        _os_log_impl(&dword_229538000, v89, OS_LOG_TYPE_DEFAULT, "%{public}@Not sending home data as the client has not requested it in their options: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v87);
    }

    goto LABEL_93;
  }

  homes = [(HMDHomeManager *)v69 homes];
  v206 = v17;
  if (!isAppleTV() || ([configurationCopy isEntitledForSPIAccess] & 1) != 0)
  {
    v77 = homes;
    goto LABEL_77;
  }

  currentHomeUUID3 = [(HMDHomeManager *)v69 currentHomeUUID];
  v106 = v69;
  v107 = currentHomeUUID3;
  v108 = MEMORY[0x277CBEB18];
  homes2 = [(HMDHomeManager *)v106 homes];
  v77 = [v108 arrayWithCapacity:{objc_msgSend(homes2, "count")}];

  v227 = 0u;
  v228 = 0u;
  v225 = 0u;
  v226 = 0u;
  v110 = homes;
  v111 = [v110 countByEnumeratingWithState:&v225 objects:v244 count:16];
  if (!v111)
  {
    goto LABEL_76;
  }

  v112 = v111;
  v113 = *v226;
  do
  {
    v114 = 0;
    do
    {
      if (*v226 != v113)
      {
        objc_enumerationMutation(v110);
      }

      v115 = *(*(&v225 + 1) + 8 * v114);
      if (v107)
      {
        uuid2 = [v115 uuid];
        v117 = [uuid2 isEqual:v107];

        if ((v117 & 1) == 0)
        {
          goto LABEL_71;
        }

LABEL_70:
        [v77 addObject:v115];
        goto LABEL_71;
      }

      if ([v115 isOwnerUser])
      {
        goto LABEL_70;
      }

LABEL_71:
      ++v114;
    }

    while (v112 != v114);
    v118 = [v110 countByEnumeratingWithState:&v225 objects:v244 count:16];
    v112 = v118;
  }

  while (v118);
LABEL_76:

  v66 = 0x277CCA000uLL;
  v34 = v218;
  v69 = v215;
LABEL_77:
  v119 = [(HMDHomeManager *)v69 filterHomes:v77 isSPIEntitled:v222];

  [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
  v121 = v120;
  v211 = v119;
  v207 = encodeRootObjectForIncomingXPCMessage(v119, configurationCopy);
  incomingInvitations = [(HMDHomeManager *)v69 incomingInvitations];
  v123 = [incomingInvitations copy];
  v124 = encodeRootObjectForIncomingXPCMessage(v123, 0);

  [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
  v126 = v125;
  v127 = objc_autoreleasePoolPush();
  v128 = v69;
  v129 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v129, OS_LOG_TYPE_DEFAULT))
  {
    v130 = HMFGetLogIdentifier();
    [*(v66 + 2992) numberWithUnsignedInteger:{objc_msgSend(v211, "count")}];
    v204 = v127;
    v205 = v124;
    v131 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    v132 = *(v66 + 2992);
    homes3 = [(HMDHomeManager *)v128 homes];
    v134 = [v132 numberWithUnsignedInteger:{objc_msgSend(homes3, "count")}];
    v135 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v205, "length") + objc_msgSend(v207, "length")}];
    clientIdentifier3 = [configurationCopy clientIdentifier];
    *buf = 138544642;
    v233 = v130;
    v234 = 2112;
    v235 = v131;
    v236 = 2112;
    v237 = v134;
    v238 = 2048;
    v239 = v126 - v121;
    v240 = 2112;
    v241 = v135;
    v242 = 2112;
    v243 = clientIdentifier3;
    _os_log_impl(&dword_229538000, v129, OS_LOG_TYPE_DEFAULT, "%{public}@Number of homes - %@ / %@, Time to encode homes: %.4f s, Size: %@ bytes, client: %@", buf, 0x3Eu);

    v34 = v218;
    v127 = v204;
    v124 = v205;
  }

  objc_autoreleasePoolPop(v127);
  v17 = v206;
  [v206 setObject:v207 forKeyedSubscript:@"kHomeDataKey"];
  [v206 setObject:v124 forKeyedSubscript:@"kIncomingHomeInvitationsKey"];
  lastRemovedCurrentAccessoryUUID = [(HMDHomeManager *)v128 lastRemovedCurrentAccessoryUUID];
  uUIDString2 = [lastRemovedCurrentAccessoryUUID UUIDString];
  [v206 setObject:uUIDString2 forKeyedSubscript:*MEMORY[0x277CD0288]];

  userDefaults = [(HMDHomeManager *)v128 userDefaults];
  v140 = [userDefaults objectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v141 = v140;
  }

  else
  {
    v141 = 0;
  }

  v142 = v141;

  allKeys = [v142 allKeys];

  [v206 setObject:allKeys forKeyedSubscript:*MEMORY[0x277CD0378]];
  primaryHomeUUID = [(HMDHomeManager *)v128 primaryHomeUUID];

  if (primaryHomeUUID)
  {
    primaryHomeUUID2 = [(HMDHomeManager *)v128 primaryHomeUUID];
    firstObject = [v211 hmf_firstObjectWithUUID:primaryHomeUUID2];

    if (firstObject)
    {
      v147 = v124;
      primaryHomeUUID3 = [(HMDHomeManager *)v128 primaryHomeUUID];
      goto LABEL_87;
    }

    if ([v211 count])
    {
      v147 = v124;
      firstObject = [v211 firstObject];
      primaryHomeUUID3 = [firstObject uuid];
LABEL_87:
      v149 = primaryHomeUUID3;
      uUIDString3 = [primaryHomeUUID3 UUIDString];
      [v206 setObject:uUIDString3 forKeyedSubscript:@"kPrimaryHomeUUIDKey"];

      v124 = v147;
    }
  }

  if (v222)
  {
    currentHomeUUID4 = [(HMDHomeManager *)v128 currentHomeUUID];

    if (currentHomeUUID4)
    {
      currentHomeUUID5 = [(HMDHomeManager *)v128 currentHomeUUID];
      uUIDString4 = [currentHomeUUID5 UUIDString];
      [v206 setObject:uUIDString4 forKeyedSubscript:@"kCurrentHomeUUIDKey"];
    }

    v154 = [*(v66 + 2992) numberWithUnsignedInteger:{objc_msgSend(v211, "count")}];
    [v206 setObject:v154 forKeyedSubscript:@"kHomeCountKey"];
  }

LABEL_93:
  [(HMDHomeManager *)v215 setCacheUseAllowed:0];
  v67 = v219;
LABEL_94:
  v85 = v210 & v67 & (v209 ^ 1);
  if ((v208 | v212))
  {
    v155 = HMIsHAPMetadataNeededForHMHomeManagerOptions();
    v156 = objc_autoreleasePoolPush();
    v157 = v221;
    v158 = HMFGetOSLogHandle();
    v159 = os_log_type_enabled(v158, OS_LOG_TYPE_DEFAULT);
    if (v155)
    {
      if (v159)
      {
        v160 = HMFGetLogIdentifier();
        [v217 version];
        v161 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
        *buf = 138543874;
        v233 = v160;
        v234 = 2112;
        v235 = v161;
        v236 = 2112;
        v237 = v216;
        _os_log_impl(&dword_229538000, v158, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager HAP metadata version %@ does not match client's value of %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v156);
      [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
      v163 = v162;
      v164 = +[HMDHAPMetadata getSharedInstance];
      v165 = [v164 xpcData:{objc_msgSend(configurationCopy, "isEntitledForSPIAccess")}];
      [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
      v167 = v166;
      v168 = objc_autoreleasePoolPush();
      v169 = v157;
      v170 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v170, OS_LOG_TYPE_DEFAULT))
      {
        v171 = HMFGetLogIdentifier();
        *buf = 138543618;
        v233 = v171;
        v234 = 2048;
        v235 = v167 - v163;
        _os_log_impl(&dword_229538000, v170, OS_LOG_TYPE_DEFAULT, "%{public}@Time to encode metadata: %.4f s", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v168);
      [v17 setObject:v165 forKeyedSubscript:@"kHAPMetadataDataKey"];
      [(HMDHomeManager *)v169 setCacheUseAllowed:0];

      goto LABEL_101;
    }

    if (v159)
    {
      v172 = HMFGetLogIdentifier();
      HMHomeManagerOptionsToString();
      v173 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
      [configurationCopy clientName];
      v174 = v220 = v156;
      *buf = 138543874;
      v233 = v172;
      v234 = 2112;
      v235 = v173;
      v236 = 2112;
      v237 = v174;
      _os_log_impl(&dword_229538000, v158, OS_LOG_TYPE_DEFAULT, "%{public}@Client has not requested access to HAP accessories (options %@) - not sending metadata to [%@]", buf, 0x20u);

      v156 = v220;
    }

    objc_autoreleasePoolPop(v156);
  }

LABEL_105:
  if (v222)
  {
    v175 = @"com.apple.homekit-entitledclient.identifer";
    _runtimeState = [(HMDHomeManager *)v221 _runtimeState];
    [v17 addEntriesFromDictionary:_runtimeState];

    [v17 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:@"kCanCacheHomeConfigurationKey"];
    v177 = [*(v66 + 2992) numberWithBool:{-[HMDHomeManager cacheUseAllowed](v221, "cacheUseAllowed")}];
    [v17 setObject:v177 forKeyedSubscript:@"kCanUseCachedHomeConfigurationKey"];

    if (![(HMDHomeManager *)v221 cacheUseAllowed])
    {
      [(HMDHomeManager *)v221 setCacheUseAllowed:1];
    }

    if (v85)
    {
      [v17 setObject:MEMORY[0x277CBEC38] forKey:*MEMORY[0x277CD0350]];
    }

    clientIdentifier4 = @"com.apple.homekit-entitledclient.identifer";
  }

  else
  {
    clientIdentifier4 = [configurationCopy clientIdentifier];
  }

  v179 = v221;
  appData = [(HMDHomeManager *)v221 appData];
  v181 = [appData applicationDataForIdentifier:clientIdentifier4];
  [v17 setObject:v181 forKeyedSubscript:@"kAppDataInformationKey"];

  v182 = [*(v66 + 2992) numberWithBool:1];
  [v17 setObject:v182 forKeyedSubscript:*MEMORY[0x277CD0258]];

  hh2FrameworkSwitch = [(HMDHomeManager *)v221 hh2FrameworkSwitch];

  v184 = MEMORY[0x277CD03E8];
  if (hh2FrameworkSwitch)
  {
    hh2FrameworkSwitch2 = [(HMDHomeManager *)v221 hh2FrameworkSwitch];
    checkExistenceOfHH2SentinelZone = [hh2FrameworkSwitch2 checkExistenceOfHH2SentinelZone];

    if (checkExistenceOfHH2SentinelZone)
    {
      v187 = 1;
    }

    else
    {
      v187 = [(HMDHomeManager *)v221 isCloudKitRequiredForHH2]^ 1;
    }

    v188 = [*(v66 + 2992) numberWithBool:v187];
    [v17 setObject:v188 forKeyedSubscript:*v184];

    v179 = v221;
  }

  v189 = [*(v66 + 2992) numberWithBool:{-[HMDHomeManager isHH2MigrationInProgress](v179, "isHH2MigrationInProgress")}];
  [v17 setObject:v189 forKeyedSubscript:*MEMORY[0x277CD0220]];

  v190 = +[HMDHH2MigratorRecord lastMigrationFailure];
  [v17 setObject:v190 forKeyedSubscript:*MEMORY[0x277CD0218]];

  if (_os_feature_enabled_impl())
  {
    idsServerBag = [(HMDHomeManager *)v179 idsServerBag];
    isHH2ManualMigrationEnabled = [idsServerBag isHH2ManualMigrationEnabled];
  }

  else
  {
    isHH2ManualMigrationEnabled = 0;
  }

  mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
  v194 = [mEMORY[0x277D0F8D0] preferenceForKey:@"hh2ManualMigrationAvailableOverride"];

  value = [v194 value];

  if (value)
  {
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __56__HMDHomeManager___handleRequestFetchHomeConfiguration___block_invoke;
    block[3] = &unk_27868A750;
    block[4] = v221;
    v196 = v194;
    v224 = v196;
    if (__handleRequestFetchHomeConfiguration__onceToken != -1)
    {
      dispatch_once(&__handleRequestFetchHomeConfiguration__onceToken, block);
    }

    isHH2ManualMigrationEnabled = [v196 BOOLValue];
  }

  v197 = [*(v66 + 2992) numberWithBool:isHH2ManualMigrationEnabled];
  [v17 setObject:v197 forKeyedSubscript:*MEMORY[0x277CD0208]];

  idsServerBag2 = [(HMDHomeManager *)v221 idsServerBag];
  homeSafetySecurityEnabled = [idsServerBag2 homeSafetySecurityEnabled];

  v200 = [*(v66 + 2992) numberWithBool:homeSafetySecurityEnabled];
  [v17 setObject:v200 forKeyedSubscript:*MEMORY[0x277CD0248]];

  if ([(HMDHomeManager *)v221 isDemoModeV2WithoutCKEnabled])
  {
    [v17 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:*v184];
  }

  v201 = [*(v66 + 2992) numberWithBool:{-[HMDHomeManager shouldPostHH2UpgradeRequired](v221, "shouldPostHH2UpgradeRequired")}];
  [v17 setObject:v201 forKeyedSubscript:*MEMORY[0x277CD0380]];

  v202 = [v17 copy];
  [configurationCopy respondWithPayload:v202];

  v36 = v216;
  v42 = v213;
  v38 = v214;
LABEL_127:

LABEL_128:
LABEL_129:

  v203 = *MEMORY[0x277D85DE8];
}

void __56__HMDHomeManager___handleRequestFetchHomeConfiguration___block_invoke(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) BOOLValue];
    v8 = 138543618;
    v9 = v5;
    v10 = 1024;
    v11 = v6;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@hh2ManualMigrationAvailableOverride detected. Setting to %d", &v8, 0x12u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestFetchHomeConfiguration:(id)configuration
{
  configurationCopy = configuration;
  v4 = objc_autoreleasePoolPush();
  v5 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"homed.xpc.fetch.homeConfiguration."];
  [(HMDHomeManager *)self __handleRequestFetchHomeConfiguration:configurationCopy];

  objc_autoreleasePoolPop(v4);
}

- (id)_appleMediaAccessoryOfCurrentDevice
{
  v20 = *MEMORY[0x277D85DE8];
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  v4 = _accessoryOfCurrentDevice;
  if (_accessoryOfCurrentDevice)
  {
    v5 = _accessoryOfCurrentDevice;
    objc_opt_class();
    v6 = objc_opt_isKindOfClass() & 1;
    if (v6)
    {
      v7 = v5;
    }

    else
    {
      v7 = 0;
    }

    v8 = v7;

    if (v6)
    {
      v9 = v5;
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      selfCopy = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = HMFGetLogIdentifier();
        v16 = 138543618;
        v17 = v13;
        v18 = 2112;
        v19 = v5;
        _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_ERROR, "%{public}@Failed to get apple media accessory for current accessory: %@", &v16, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v9 = 0;
    }
  }

  else
  {
    v9 = 0;
  }

  v14 = *MEMORY[0x277D85DE8];

  return v9;
}

- (id)_accessoryOfCurrentDevice
{
  v27 = *MEMORY[0x277D85DE8];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v3 = [homes countByEnumeratingWithState:&v21 objects:v26 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v22;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v22 != v5)
        {
          objc_enumerationMutation(homes);
        }

        v7 = *(*(&v21 + 1) + 8 * i);
        v17 = 0u;
        v18 = 0u;
        v19 = 0u;
        v20 = 0u;
        accessories = [v7 accessories];
        v9 = [accessories countByEnumeratingWithState:&v17 objects:v25 count:16];
        if (v9)
        {
          v10 = v9;
          v11 = *v18;
          while (2)
          {
            for (j = 0; j != v10; ++j)
            {
              if (*v18 != v11)
              {
                objc_enumerationMutation(accessories);
              }

              v13 = *(*(&v17 + 1) + 8 * j);
              if ([v13 isCurrentAccessory])
              {
                v14 = v13;

                goto LABEL_19;
              }
            }

            v10 = [accessories countByEnumeratingWithState:&v17 objects:v25 count:16];
            if (v10)
            {
              continue;
            }

            break;
          }
        }
      }

      v4 = [homes countByEnumeratingWithState:&v21 objects:v26 count:16];
      v14 = 0;
    }

    while (v4);
  }

  else
  {
    v14 = 0;
  }

LABEL_19:

  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)filterHomes:(id)homes isSPIEntitled:(BOOL)entitled
{
  entitledCopy = entitled;
  v26 = *MEMORY[0x277D85DE8];
  homesCopy = homes;
  if (![(HMDHomeManager *)self isDemoModeV2WithoutCKEnabled])
  {
    v23[0] = MEMORY[0x277D85DD0];
    v23[1] = 3221225472;
    v23[2] = __44__HMDHomeManager_filterHomes_isSPIEntitled___block_invoke;
    v23[3] = &unk_278685BA0;
    v23[4] = self;
    v12 = [homesCopy na_filter:v23];
    v13 = v12;
    if (entitledCopy)
    {
      v14 = v12;
    }

    else
    {
      v15 = +[HMDAppleAccountSettings sharedSettings];
      isHomeEnabled = [v15 isHomeEnabled];

      if ((isHomeEnabled & 1) == 0)
      {
        v17 = objc_autoreleasePoolPush();
        selfCopy = self;
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
        {
          v20 = HMFGetLogIdentifier();
          *buf = 138543362;
          v25 = v20;
          _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@iCloud switch is disabled", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v17);
        v11 = MEMORY[0x277CBEBF8];
        goto LABEL_13;
      }

      v14 = [v13 na_filter:&__block_literal_global_931];
    }

    v11 = v14;
LABEL_13:

    goto LABEL_14;
  }

  v7 = objc_autoreleasePoolPush();
  selfCopy2 = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138543362;
    v25 = v10;
    _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Demo mode is active. Including all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  v11 = homesCopy;
LABEL_14:

  v21 = *MEMORY[0x277D85DE8];

  return v11;
}

BOOL __44__HMDHomeManager_filterHomes_isSPIEntitled___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [v3 currentUser];

  if (!v4)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 32);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543618;
      v12 = v8;
      v13 = 2112;
      v14 = v3;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@There is no current user for : %@", &v11, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = *MEMORY[0x277D85DE8];
  return v4 != 0;
}

- (id)homesToSendForNonSPIClients
{
  array = [MEMORY[0x277CBEB18] array];
  homes = [(HMDHomeManager *)self homes];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __45__HMDHomeManager_homesToSendForNonSPIClients__block_invoke;
  v8[3] = &unk_278685B78;
  v9 = array;
  v5 = array;
  [homes hmf_enumerateWithAutoreleasePoolUsingBlock:v8];

  v6 = [v5 copy];

  return v6;
}

void __45__HMDHomeManager_homesToSendForNonSPIClients__block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  if ([v3 isAccessToHomeAllowed])
  {
    [*(a1 + 32) addObject:v3];
  }
}

- (void)_notifyMetricsManagerOfConfigurationChange
{
  metricsManager = [(HMDHomeManager *)self metricsManager];
  [metricsManager homeKitConfigurationChanged];
}

- (void)_handleSEUpdatedAliroVersions
{
  v14 = *MEMORY[0x277D85DE8];
  internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v4 = objc_autoreleasePoolPush();
  selfCopy = self;
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    uUID = [internalOnlyInitializer UUID];
    v10 = 138543618;
    v11 = v7;
    v12 = 2112;
    v13 = uUID;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Handling SEUpdatedAliroVersions notification", &v10, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  [HMDAliroVersionUtilities readAndSaveAliroVersionFromSESOnHomeManager:selfCopy completionHandler:&__block_literal_global_927];

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_registerForMessages
{
  v379 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  selfCopy = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v378 = v6;
    _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_DEBUG, "%{public}@Registering for contact store change notifications", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  notificationCenter = [(HMDHomeManager *)selfCopy notificationCenter];
  [notificationCenter addObserver:selfCopy selector:sel_handleContactStoreChanged_ name:*MEMORY[0x277CBD140] object:0];

  v8 = objc_autoreleasePoolPush();
  v9 = selfCopy;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEBUG))
  {
    v11 = HMFGetLogIdentifier();
    *buf = 138543362;
    v378 = v11;
    _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_DEBUG, "%{public}@Registering remote account message filter", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [HMDRemoteAccountMessageFilter alloc];
  messageDestination = [(HMDHomeManager *)v9 messageDestination];
  v376[0] = @"kAccessHomeInviteRequestKey";
  v376[1] = @"kHomeDataSyncRequestKey";
  v376[2] = @"kHomeDataFragmentedSyncRequestKey";
  v376[3] = @"kUpdateHomeInvitationStateInternalRequestKey";
  v376[4] = @"kUserRemovedRequestKey";
  v376[5] = @"kUserResetHomeConfigRequestKey";
  v376[6] = @"kElectDeviceForIDSSessionKey";
  v376[7] = @"HMDHomeManagerSharedUserMigratedToHH2MessageKey";
  v14 = [MEMORY[0x277CBEA60] arrayWithObjects:v376 count:8];
  v15 = [(HMDRemoteAccountMessageFilter *)v12 initWithTarget:messageDestination allowedMessages:v14];

  msgFilterChain = [(HMDHomeManager *)v9 msgFilterChain];
  v307 = v15;
  [msgFilterChain addMessageFilter:v15];

  v17 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v17 setRequiresSecureMessage:0];
  [v17 setRequiresAccountMessage:0];
  [v17 setTransportRestriction:-1];
  v306 = v17;
  v18 = [v17 copy];
  [(HMDHomeManager *)v9 initHomeManagerFrameworkNotify];
  messageDispatcher = [(HMDHomeManager *)v9 messageDispatcher];
  v20 = *MEMORY[0x277CD01D8];
  v21 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v375[0] = v21;
  v22 = [HMDXPCBackgroundMessagePolicy policyWithEntitlementRequirement:0];
  v375[1] = v22;
  v299 = *MEMORY[0x277CD06C8];
  v23 = *MEMORY[0x277CD06C8];
  v300 = *MEMORY[0x277CCFE40];
  v374[0] = *MEMORY[0x277CCFE40];
  v374[1] = v23;
  v24 = [MEMORY[0x277CBEA60] arrayWithObjects:v374 count:2];
  v25 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v24];
  v375[2] = v25;
  v26 = [MEMORY[0x277CBEA60] arrayWithObjects:v375 count:3];
  [messageDispatcher registerForMessage:v20 receiver:v9 policies:v26 selector:sel__handleRequestFetchHomeConfiguration_];

  messageDispatcher2 = [(HMDHomeManager *)v9 messageDispatcher];
  v28 = *MEMORY[0x277CD2508];
  v29 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
  v373[0] = v29;
  v30 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v373[1] = v30;
  v31 = [MEMORY[0x277CBEA60] arrayWithObjects:v373 count:2];
  [messageDispatcher2 registerForMessage:v28 receiver:v9 policies:v31 selector:sel__handleRequestRemoveHome_];

  v32 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v32 setRequiresAccountMessage:1];
  v303 = v32;
  v33 = [v32 copy];
  messageDispatcher3 = [(HMDHomeManager *)v9 messageDispatcher];
  v35 = *MEMORY[0x277CD2500];
  v36 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
  v372[0] = v36;
  v305 = v33;
  v372[1] = v33;
  v37 = [MEMORY[0x277CBEA60] arrayWithObjects:v372 count:2];
  [messageDispatcher3 registerForMessage:v35 receiver:v9 policies:v37 selector:sel__handleRemoveAllUsersFromAccessories_];

  v38 = [[HMDPendingInvitedUserMessagePolicy alloc] initWithHomeManager:v9];
  messageDispatcher4 = [(HMDHomeManager *)v9 messageDispatcher];
  v304 = v38;
  v371[0] = v38;
  v308 = v18;
  v371[1] = v18;
  p_cache = &OBJC_METACLASS___HMDAccessoryFirmwareUpdateManagerWingman.cache;
  v41 = [MEMORY[0x277CBEA60] arrayWithObjects:v371 count:2];
  [messageDispatcher4 registerForMessage:@"HMDHomeManagerSharedUserMigratedToHH2MessageKey" receiver:v9 policies:v41 selector:sel__handleSharedUserMovedToHH2_];

  messageDispatcher5 = [(HMDHomeManager *)v9 messageDispatcher];
  v43 = *MEMORY[0x277CD2080];
  v44 = [HMDConfigurationMessagePolicy policyWithOperationTypes:1];
  v370[0] = v44;
  v45 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v370[1] = v45;
  v46 = [MEMORY[0x277CBEA60] arrayWithObjects:v370 count:2];
  [messageDispatcher5 registerForMessage:v43 receiver:v9 policies:v46 selector:sel__handleRequestAddHome_];

  messageDispatcher6 = [(HMDHomeManager *)v9 messageDispatcher];
  v48 = *MEMORY[0x277CD2670];
  v49 = [HMDConfigurationMessagePolicy policyWithOperationTypes:2];
  v369[0] = v49;
  v50 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v369[1] = v50;
  v51 = [MEMORY[0x277CBEA60] arrayWithObjects:v369 count:2];
  [messageDispatcher6 registerForMessage:v48 receiver:v9 policies:v51 selector:sel__handleRequestSetPrimaryHome_];

  messageDispatcher7 = [(HMDHomeManager *)v9 messageDispatcher];
  v53 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v368 = v53;
  v54 = [MEMORY[0x277CBEA60] arrayWithObjects:&v368 count:1];
  [messageDispatcher7 registerForMessage:@"kQueryHomeKitUsageStateRequestKey" receiver:v9 policies:v54 selector:sel__handleRequestIsUserUsingHomeKit_];

  v55 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v55 setRequiresSecureMessage:0];
  [v55 setAllowsAnonymousMessage:1];
  v301 = v55;
  v56 = [v55 copy];
  messageDispatcher8 = [(HMDHomeManager *)v9 messageDispatcher];
  v302 = v56;
  v367 = v56;
  v58 = [MEMORY[0x277CBEA60] arrayWithObjects:&v367 count:1];
  [messageDispatcher8 registerForMessage:@"kElectDeviceForIDSSessionKey" receiver:v9 policies:v58 selector:sel__handleElectDeviceForIDSSession_];

  v59 = +[HMDDeviceCapabilities deviceCapabilities];
  LODWORD(v58) = [v59 supportsHomeInvitation];

  if (v58)
  {
    messageDispatcher9 = [(HMDHomeManager *)v9 messageDispatcher];
    v366 = v308;
    v61 = [MEMORY[0x277CBEA60] arrayWithObjects:&v366 count:1];
    [messageDispatcher9 registerForMessage:@"kAccessHomeInviteRequestKey" receiver:v9 policies:v61 selector:sel__handleAccessHomeInvite_];
  }

  if (isAppleTV())
  {
    v62 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v62 setRequiresSecureMessage:0];
    [v62 setRequiresAccountMessage:1];
    [v62 setTransportRestriction:-1];
    v63 = [v62 copy];
    messageDispatcher10 = [(HMDHomeManager *)v9 messageDispatcher];
    v365 = v63;
    v65 = [MEMORY[0x277CBEA60] arrayWithObjects:&v365 count:1];
    [messageDispatcher10 registerForMessage:@"kAddRemoteAccessRequestKey" receiver:v9 policies:v65 selector:sel__handleAddRemoteAccessRequest_];

    messageDispatcher11 = [(HMDHomeManager *)v9 messageDispatcher];
    v364 = v63;
    v67 = [MEMORY[0x277CBEA60] arrayWithObjects:&v364 count:1];
    [messageDispatcher11 registerForMessage:@"kDoYouSeeUnpairedAccessoriesKey" receiver:v9 policies:v67 selector:sel__handleDoYouSeeUnpairedAccessories_];

    v68 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v68 setAllowsAnonymousMessage:1];
    v69 = [v68 copy];
    messageDispatcher12 = [(HMDHomeManager *)v9 messageDispatcher];
    v363 = v69;
    v71 = [MEMORY[0x277CBEA60] arrayWithObjects:&v363 count:1];
    [messageDispatcher12 registerForMessage:@"kAreYouAtHomeRequestKey" receiver:v9 policies:v71 selector:sel__handleAreYouAtHome_];

    p_cache = &OBJC_METACLASS___HMDAccessoryFirmwareUpdateManagerWingman.cache;
  }

  v72 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v72 isResidentCapable];

  if (isResidentCapable)
  {
    messageDispatcher13 = [(HMDHomeManager *)v9 messageDispatcher];
    v75 = [HMDConfigurationMessagePolicy policyWithOperationTypes:7];
    v362[0] = v75;
    v76 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v362[1] = v76;
    v77 = [MEMORY[0x277CBEA60] arrayWithObjects:v362 count:2];
    [messageDispatcher13 registerForMessage:@"kUpdateResidentEnabledOnThisDeviceRequestKey" receiver:v9 policies:v77 selector:sel__handleEnableResidentForThisDeviceRequest_];

    p_cache = (&OBJC_METACLASS___HMDAccessoryFirmwareUpdateManagerWingman + 16);
  }

  if (+[HMDDeviceCapabilities supportsDismissUserNotificationAndDialog])
  {
    v78 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v78 setRequiresSecureMessage:0];
    [v78 setRequiresAccountMessage:1];
    [v78 setTransportRestriction:-1];
    v79 = [v78 copy];
    messageDispatcher14 = [(HMDHomeManager *)v9 messageDispatcher];
    v361 = v79;
    v81 = [MEMORY[0x277CBEA60] arrayWithObjects:&v361 count:1];
    [messageDispatcher14 registerForMessage:@"kDismissBulletinInternalRequestKey" receiver:v9 policies:v81 selector:sel__handleDismissBulletinRequest_];

    messageDispatcher15 = [(HMDHomeManager *)v9 messageDispatcher];
    v360 = v79;
    v83 = [MEMORY[0x277CBEA60] arrayWithObjects:&v360 count:1];
    [messageDispatcher15 registerForMessage:@"kDismissDialogInternalRequestKey" receiver:v9 policies:v83 selector:sel__handleDismissDialogRequest_];

    p_cache = &OBJC_METACLASS___HMDAccessoryFirmwareUpdateManagerWingman.cache;
  }

  if (isiOSDevice() || isWatch())
  {
    messageDispatcher16 = [(HMDHomeManager *)v9 messageDispatcher];
    v85 = [p_cache + 148 policyWithEntitlements:5];
    v359 = v85;
    v86 = [MEMORY[0x277CBEA60] arrayWithObjects:&v359 count:1];
    [messageDispatcher16 registerForMessage:@"kUpdateAccessAllowedWhenLockedRequestKey" receiver:v9 policies:v86 selector:sel__handleAccessAllowedWhenLockedRequest_];
  }

  v87 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v87 setAllowsAnonymousMessage:1];
  v88 = [v87 copy];
  messageDispatcher17 = [(HMDHomeManager *)v9 messageDispatcher];
  v358 = v88;
  v90 = [MEMORY[0x277CBEA60] arrayWithObjects:&v358 count:1];
  [messageDispatcher17 registerForMessage:@"kUserRemovedRequestKey" receiver:v9 policies:v90 selector:sel__handleUserRemoved_];

  messageDispatcher18 = [(HMDHomeManager *)v9 messageDispatcher];
  v357 = v88;
  v92 = [MEMORY[0x277CBEA60] arrayWithObjects:&v357 count:1];
  [messageDispatcher18 registerForMessage:@"kUserResetHomeConfigRequestKey" receiver:v9 policies:v92 selector:sel__handleResetHome_];

  isWatch();
  [(HMDHomeManager *)v9 _registerForAppleMediaMessages];
  if (isiOSDevice())
  {
    v93 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v93 setRequiresSecureMessage:1];
    [v93 setRoles:2];
    v94 = [v93 copy];
    messageDispatcher19 = [(HMDHomeManager *)v9 messageDispatcher];
    v356 = v94;
    v96 = [MEMORY[0x277CBEA60] arrayWithObjects:&v356 count:1];
    [messageDispatcher19 registerForMessage:@"kRetrieveVendorIdentifierInternalKey" receiver:v9 policies:v96 selector:sel__handleRetrieveVendorIdentifier_];

    if (isInternalBuild())
    {
      messageDispatcher20 = [(HMDHomeManager *)v9 messageDispatcher];
      v98 = *MEMORY[0x277CD03B8];
      v99 = [HMDXPCMessagePolicy policyWithEntitlements:5];
      v355 = v99;
      v100 = [MEMORY[0x277CBEA60] arrayWithObjects:&v355 count:1];
      [messageDispatcher20 registerForMessage:v98 receiver:v9 policies:v100 selector:sel__handleKeyRoll_];

      messageDispatcher21 = [(HMDHomeManager *)v9 messageDispatcher];
      v102 = *MEMORY[0x277CD0338];
      v103 = [HMDXPCMessagePolicy policyWithEntitlements:5];
      v354 = v103;
      v104 = [MEMORY[0x277CBEA60] arrayWithObjects:&v354 count:1];
      [messageDispatcher21 registerForMessage:v102 receiver:v9 policies:v104 selector:sel_handleRollPreferredHH2ControllerKeyMessage_];
    }
  }

  if (isInternalBuild())
  {
    messageDispatcher22 = [(HMDHomeManager *)v9 messageDispatcher];
    v106 = *MEMORY[0x277CD00E0];
    v107 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v353 = v107;
    v108 = [MEMORY[0x277CBEA60] arrayWithObjects:&v353 count:1];
    [messageDispatcher22 registerForMessage:v106 receiver:v9 policies:v108 selector:sel_handleDeleteModelMessage_];

    messageDispatcher23 = [(HMDHomeManager *)v9 messageDispatcher];
    v110 = *MEMORY[0x277CD00A8];
    v111 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v352 = v111;
    v112 = [MEMORY[0x277CBEA60] arrayWithObjects:&v352 count:1];
    [messageDispatcher23 registerForMessage:v110 receiver:v9 policies:v112 selector:sel_handleCheckIsUsingProductionObjectModelMessage_];
  }

  [(HMDHomeManager *)v9 _registerForFrameworkSwitch];
  if (+[HMDAppleAccountSettings supportsCloudSettings])
  {
    messageDispatcher24 = [(HMDHomeManager *)v9 messageDispatcher];
    v114 = *MEMORY[0x277CD0318];
    v115 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v350[0] = v300;
    v350[1] = v299;
    v351[0] = v115;
    v116 = [MEMORY[0x277CBEA60] arrayWithObjects:v350 count:2];
    v117 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v116];
    v351[1] = v117;
    v118 = [MEMORY[0x277CBEA60] arrayWithObjects:v351 count:2];
    [messageDispatcher24 registerForMessage:v114 receiver:v9 policies:v118 selector:sel__handleQueryiCloudSwitchState_];

    messageDispatcher25 = [(HMDHomeManager *)v9 messageDispatcher];
    v120 = *MEMORY[0x277CD03C8];
    v121 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v349[0] = v121;
    v348[0] = v300;
    v348[1] = v299;
    v122 = *MEMORY[0x277CCFD78];
    v348[2] = *MEMORY[0x277CCFD68];
    v348[3] = v122;
    v348[4] = *MEMORY[0x277CD1218];
    v123 = [MEMORY[0x277CBEA60] arrayWithObjects:v348 count:5];
    v124 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v123];
    v349[1] = v124;
    v125 = [MEMORY[0x277CBEA60] arrayWithObjects:v349 count:2];
    [messageDispatcher25 registerForMessage:v120 receiver:v9 policies:v125 selector:sel__handleUpdateiCloudSwitchState_];
  }

  messageDispatcher26 = [(HMDHomeManager *)v9 messageDispatcher];
  v127 = *MEMORY[0x277CD02F8];
  v128 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v347 = v128;
  v129 = [MEMORY[0x277CBEA60] arrayWithObjects:&v347 count:1];
  [messageDispatcher26 registerForMessage:v127 receiver:v9 policies:v129 selector:sel__handleQueryHomeNamespace_];

  messageDispatcher27 = [(HMDHomeManager *)v9 messageDispatcher];
  v131 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v346 = v131;
  v132 = [MEMORY[0x277CBEA60] arrayWithObjects:&v346 count:1];
  [messageDispatcher27 registerForMessage:@"kResetConfigRequestKey" receiver:v9 policies:v132 selector:sel__handleResetConfiguration_];

  productInfo = [MEMORY[0x277D0F8E8] productInfo];
  productVariant = [productInfo productVariant];

  if (productVariant == 3)
  {
    v135 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v345 = v135;
    v136 = [MEMORY[0x277CBEA60] arrayWithObjects:&v345 count:1];

    messageDispatcher28 = [(HMDHomeManager *)v9 messageDispatcher];
    v138 = *MEMORY[0x277CD0300];
    v139 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v344 = v139;
    v140 = [MEMORY[0x277CBEA60] arrayWithObjects:&v344 count:1];
    [messageDispatcher28 registerForMessage:v138 receiver:v9 policies:v140 selector:sel__handleQueryMetadata_];

    messageDispatcher29 = [(HMDHomeManager *)v9 messageDispatcher];
    v142 = *MEMORY[0x277CD0368];
    v143 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v343 = v143;
    v144 = [MEMORY[0x277CBEA60] arrayWithObjects:&v343 count:1];
    [messageDispatcher29 registerForMessage:v142 receiver:v9 policies:v144 selector:sel__handleSetMetadata_];

    messageDispatcher30 = [(HMDHomeManager *)v9 messageDispatcher];
    v146 = *MEMORY[0x277CD0310];
    v147 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v342 = v147;
    v148 = [MEMORY[0x277CBEA60] arrayWithObjects:&v342 count:1];
    [messageDispatcher30 registerForMessage:v146 receiver:v9 policies:v148 selector:sel__handleQueryVersionInformation_];

    messageDispatcher31 = [(HMDHomeManager *)v9 messageDispatcher];
    v150 = *MEMORY[0x277CD0180];
    v151 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v341 = v151;
    v152 = [MEMORY[0x277CBEA60] arrayWithObjects:&v341 count:1];
    [messageDispatcher31 registerForMessage:v150 receiver:v9 policies:v152 selector:sel__handleDumpState_];

    messageDispatcher32 = [(HMDHomeManager *)v9 messageDispatcher];
    [messageDispatcher32 registerForMessage:*MEMORY[0x277CD01C0] receiver:v9 policies:v136 selector:sel__handleDiagnosticInfo_];

    messageDispatcher33 = [(HMDHomeManager *)v9 messageDispatcher];
    [messageDispatcher33 registerForMessage:*MEMORY[0x277CD02C0] receiver:v9 policies:v136 selector:sel__handleNetworkMismatchInfo_];
  }

  messageDispatcher34 = [(HMDHomeManager *)v9 messageDispatcher];
  v156 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v340 = v156;
  v157 = [MEMORY[0x277CBEA60] arrayWithObjects:&v340 count:1];
  [messageDispatcher34 registerForMessage:@"kUpdateInvitationStateRequestKey" receiver:v9 policies:v157 selector:sel__handleRequestToUpdateHomeInvitationFromLocalUser_];

  messageDispatcher35 = [(HMDHomeManager *)v9 messageDispatcher];
  v339 = v308;
  v159 = [MEMORY[0x277CBEA60] arrayWithObjects:&v339 count:1];
  [messageDispatcher35 registerForMessage:@"kUpdateHomeInvitationStateInternalRequestKey" receiver:v9 policies:v159 selector:sel__handleRequestToUpdateHomeInvitationFromInviter_];

  messageDispatcher36 = [(HMDHomeManager *)v9 messageDispatcher];
  v161 = *MEMORY[0x277CD0360];
  v162 = [HMDConfigurationMessagePolicy policyWithOperationTypes:7];
  v338[0] = v162;
  v163 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v338[1] = v163;
  v164 = [MEMORY[0x277CBEA60] arrayWithObjects:v338 count:2];
  [messageDispatcher36 registerForMessage:v161 receiver:v9 policies:v164 selector:sel__handleSetAppData_];

  messageDispatcher37 = [(HMDHomeManager *)v9 messageDispatcher];
  v166 = +[HMDRemoteMessagePolicy defaultSecurePolicy];
  v337 = v166;
  v167 = [MEMORY[0x277CBEA60] arrayWithObjects:&v337 count:1];
  [messageDispatcher37 registerForMessage:@"kSystemLogCaptureRequestKey" receiver:v9 policies:v167 selector:sel__handleSysdiagnoseRequest_];

  if (!isWatch())
  {
    messageDispatcher38 = [(HMDHomeManager *)v9 messageDispatcher];
    v169 = *MEMORY[0x277CCFCB0];
    v170 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v336 = v170;
    v171 = [MEMORY[0x277CBEA60] arrayWithObjects:&v336 count:1];
    [messageDispatcher38 registerForMessage:v169 receiver:v9 policies:v171 selector:sel__handleDeviceSetupSessionOpen_];

    messageDispatcher39 = [(HMDHomeManager *)v9 messageDispatcher];
    v173 = *MEMORY[0x277CCFC88];
    v174 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v335 = v174;
    v175 = [MEMORY[0x277CBEA60] arrayWithObjects:&v335 count:1];
    [messageDispatcher39 registerForMessage:v173 receiver:v9 policies:v175 selector:sel__handleDeviceSetupSessionClose_];
  }

  [(HMDHomeManager *)v9 _registerForConfiguringStateMessages];
  if (isInternalBuild())
  {
    messageDispatcher40 = [(HMDHomeManager *)v9 messageDispatcher];
    v177 = *MEMORY[0x277CD0330];
    v178 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v334 = v178;
    v179 = [MEMORY[0x277CBEA60] arrayWithObjects:&v334 count:1];
    [messageDispatcher40 registerForMessage:v177 receiver:v9 policies:v179 selector:sel__handleResolveAccount_];

    messageDispatcher41 = [(HMDHomeManager *)v9 messageDispatcher];
    v181 = *MEMORY[0x277CD0320];
    v182 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v333 = v182;
    v183 = [MEMORY[0x277CBEA60] arrayWithObjects:&v333 count:1];
    [messageDispatcher41 registerForMessage:v181 receiver:v9 policies:v183 selector:sel__handleRemoveAccount_];

    messageDispatcher42 = [(HMDHomeManager *)v9 messageDispatcher];
    v185 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v332 = v185;
    v186 = [MEMORY[0x277CBEA60] arrayWithObjects:&v332 count:1];
    [messageDispatcher42 registerForMessage:@"kPingInternalRequestKey" receiver:v9 policies:v186 selector:sel__handlePing_];

    messageDispatcher43 = [(HMDHomeManager *)v9 messageDispatcher];
    v188 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v331 = v188;
    v189 = [MEMORY[0x277CBEA60] arrayWithObjects:&v331 count:1];
    [messageDispatcher43 registerForMessage:@"HomeUtilConfigTestingModeMessage" receiver:v9 policies:v189 selector:sel__handleTestModeConfigRequest_];

    messageDispatcher44 = [(HMDHomeManager *)v9 messageDispatcher];
    v191 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v330 = v191;
    v192 = [MEMORY[0x277CBEA60] arrayWithObjects:&v330 count:1];
    [messageDispatcher44 registerForMessage:@"HomeUtilSetOverridesMessage" receiver:v9 policies:v192 selector:sel__handleHomeUtilSetOverridesMessage_];

    messageDispatcher45 = [(HMDHomeManager *)v9 messageDispatcher];
    v194 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v329 = v194;
    v195 = [MEMORY[0x277CBEA60] arrayWithObjects:&v329 count:1];
    [messageDispatcher45 registerForMessage:@"HomeUtilRemoteMessageRequestMessage" receiver:v9 policies:v195 selector:sel__handleHomeUtilRemoteMessageRequest_];

    messageDispatcher46 = [(HMDHomeManager *)v9 messageDispatcher];
    v197 = *MEMORY[0x277CD03C0];
    v198 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v328 = v198;
    v199 = [MEMORY[0x277CBEA60] arrayWithObjects:&v328 count:1];
    [messageDispatcher46 registerForMessage:v197 receiver:v9 policies:v199 selector:sel__handleUpdateMobileAssetsRequest_];

    messageDispatcher47 = [(HMDHomeManager *)v9 messageDispatcher];
    v201 = *MEMORY[0x277CD00B0];
    v202 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v327 = v202;
    v203 = [MEMORY[0x277CBEA60] arrayWithObjects:&v327 count:1];
    [messageDispatcher47 registerForMessage:v201 receiver:v9 policies:v203 selector:sel__handleClearMobileAssetsInfoRequest_];
  }

  messageDispatcher48 = [(HMDHomeManager *)v9 messageDispatcher];
  v205 = *MEMORY[0x277CD0348];
  v206 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v326 = v206;
  v207 = [MEMORY[0x277CBEA60] arrayWithObjects:&v326 count:1];
  [messageDispatcher48 registerForMessage:v205 receiver:v9 policies:v207 selector:sel__handleRequestRuntimeStateUpdate_];

  messageDispatcher49 = [(HMDHomeManager *)v9 messageDispatcher];
  v209 = *MEMORY[0x277CD02E0];
  v210 = [HMDXPCMessagePolicy policyWithEntitlements:13];
  v325 = v210;
  v211 = [MEMORY[0x277CBEA60] arrayWithObjects:&v325 count:1];
  [messageDispatcher49 registerForMessage:v209 receiver:v9 policies:v211 selector:sel__handlePairingIdentityRequest_];

  messageDispatcher50 = [(HMDHomeManager *)v9 messageDispatcher];
  v213 = *MEMORY[0x277CD01C8];
  v214 = [HMDXPCMessagePolicy policyWithEntitlements:13];
  v324 = v214;
  v215 = [MEMORY[0x277CBEA60] arrayWithObjects:&v324 count:1];
  [messageDispatcher50 registerForMessage:v213 receiver:v9 policies:v215 selector:sel__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest_];

  messageDispatcher51 = [(HMDHomeManager *)v9 messageDispatcher];
  v217 = *MEMORY[0x277CD01D0];
  v218 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v323 = v218;
  v219 = [MEMORY[0x277CBEA60] arrayWithObjects:&v323 count:1];
  [messageDispatcher51 registerForMessage:v217 receiver:v9 policies:v219 selector:sel__handleFetchDevicesMessage_];

  if (isInternalBuild())
  {
    messageDispatcher52 = [(HMDHomeManager *)v9 messageDispatcher];
    v221 = *MEMORY[0x277CD0A40];
    v222 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v322 = v222;
    v223 = [MEMORY[0x277CBEA60] arrayWithObjects:&v322 count:1];
    [messageDispatcher52 registerForMessage:v221 receiver:v9 policies:v223 selector:sel__handleNetworkFirewallDumpCloudRecordsRequest_];

    messageDispatcher53 = [(HMDHomeManager *)v9 messageDispatcher];
    v225 = *MEMORY[0x277CD0A28];
    v226 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v321[0] = v226;
    v227 = [HMDConfigurationMessagePolicy policyWithOperationTypes:3];
    v321[1] = v227;
    v228 = [MEMORY[0x277CBEA60] arrayWithObjects:v321 count:2];
    [messageDispatcher53 registerForMessage:v225 receiver:v9 policies:v228 selector:sel__handleNetworkFirewallAddOverridesRequest_];

    messageDispatcher54 = [(HMDHomeManager *)v9 messageDispatcher];
    v230 = *MEMORY[0x277CD0AF8];
    v231 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v320[0] = v231;
    v232 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
    v320[1] = v232;
    v233 = [MEMORY[0x277CBEA60] arrayWithObjects:v320 count:2];
    [messageDispatcher54 registerForMessage:v230 receiver:v9 policies:v233 selector:sel__handleNetworkFirewallRemoveOverridesRequest_];

    messageDispatcher55 = [(HMDHomeManager *)v9 messageDispatcher];
    v235 = *MEMORY[0x277CD0A80];
    v236 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v319 = v236;
    v237 = [MEMORY[0x277CBEA60] arrayWithObjects:&v319 count:1];
    [messageDispatcher55 registerForMessage:v235 receiver:v9 policies:v237 selector:sel__handleNetworkFirewallDumpLocalRulesRequest_];

    messageDispatcher56 = [(HMDHomeManager *)v9 messageDispatcher];
    v239 = *MEMORY[0x277CD0AB8];
    v240 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v318 = v240;
    v241 = [MEMORY[0x277CBEA60] arrayWithObjects:&v318 count:1];
    [messageDispatcher56 registerForMessage:v239 receiver:v9 policies:v241 selector:sel__handleNetworkFirewallDumpPairedMetadataRequest_];

    messageDispatcher57 = [(HMDHomeManager *)v9 messageDispatcher];
    v243 = *MEMORY[0x277CD0AF0];
    v244 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v317[0] = v244;
    v245 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
    v317[1] = v245;
    v246 = [MEMORY[0x277CBEA60] arrayWithObjects:v317 count:2];
    [messageDispatcher57 registerForMessage:v243 receiver:v9 policies:v246 selector:sel__handleNetworkFirewallRemoveLocalRulesRequest_];

    messageDispatcher58 = [(HMDHomeManager *)v9 messageDispatcher];
    v248 = *MEMORY[0x277CD0AE8];
    v249 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v316 = v249;
    v250 = [MEMORY[0x277CBEA60] arrayWithObjects:&v316 count:1];
    [messageDispatcher58 registerForMessage:v248 receiver:v9 policies:v250 selector:sel__handleNetworkFirewallFetchCloudChangesRequest_];

    messageDispatcher59 = [(HMDHomeManager *)v9 messageDispatcher];
    v252 = *MEMORY[0x277CD00D0];
    v253 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v315 = v253;
    v254 = [MEMORY[0x277CBEA60] arrayWithObjects:&v315 count:1];
    [messageDispatcher59 registerForMessage:v252 receiver:v9 policies:v254 selector:sel__handleGetTLVForJSON_];
  }

  messageDispatcher60 = [(HMDHomeManager *)v9 messageDispatcher];
  v256 = *MEMORY[0x277CD0198];
  v257 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v314 = v257;
  v258 = [MEMORY[0x277CBEA60] arrayWithObjects:&v314 count:1];
  [messageDispatcher60 registerForMessage:v256 receiver:v9 policies:v258 selector:sel__handleEnableUARPPacketCaptureRequest_];

  if (isInternalBuild())
  {
    messageDispatcher61 = [(HMDHomeManager *)v9 messageDispatcher];
    v260 = *MEMORY[0x277CD0158];
    v261 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v313 = v261;
    v262 = [MEMORY[0x277CBEA60] arrayWithObjects:&v313 count:1];
    [messageDispatcher61 registerForMessage:v260 receiver:v9 policies:v262 selector:sel__handleDumpDatabase_];
  }

  if (isInternalBuild())
  {
    messageDispatcher62 = [(HMDHomeManager *)v9 messageDispatcher];
    v264 = *MEMORY[0x277CD02F0];
    v265 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v312 = v265;
    v266 = [MEMORY[0x277CBEA60] arrayWithObjects:&v312 count:1];
    [messageDispatcher62 registerForMessage:v264 receiver:v9 policies:v266 selector:sel__handlePrepareForDiagnosticExtension_];
  }

  userCloudShareManager = [(HMDHomeManager *)v9 userCloudShareManager];
  messageDispatcher63 = [(HMDHomeManager *)v9 messageDispatcher];
  [userCloudShareManager configureWithMessageDispatcher:messageDispatcher63];

  messageDispatcher64 = [(HMDHomeManager *)v9 messageDispatcher];
  v270 = *MEMORY[0x277CD00C8];
  v271 = [HMDXPCMessagePolicy policyWithEntitlements:261];
  v311 = v271;
  v272 = [MEMORY[0x277CBEA60] arrayWithObjects:&v311 count:1];
  [messageDispatcher64 registerForMessage:v270 receiver:v9 policies:v272 selector:sel__handleConnectivityInfoRequest_];

  userDeviceCapabilitiesRequestManager = [(HMDHomeManager *)v9 userDeviceCapabilitiesRequestManager];
  [userDeviceCapabilitiesRequestManager registerForMessages];

  v274 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v274 setRequiresSecureMessage:0];
  [v274 setRequiresAccountMessage:1];
  [v274 setTransportRestriction:1];
  messageDispatcher65 = [(HMDHomeManager *)v9 messageDispatcher];
  v276 = [v274 copy];
  v310 = v276;
  v277 = [MEMORY[0x277CBEA60] arrayWithObjects:&v310 count:1];
  [messageDispatcher65 registerForMessage:@"HMDInvitationForwardMessage" receiver:v9 policies:v277 selector:sel__handleForwardedSharedUserInvitationAcceptance_];

  if (isInternalBuild())
  {
    messageDispatcher66 = [(HMDHomeManager *)v9 messageDispatcher];
    v279 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v309 = v279;
    v280 = [MEMORY[0x277CBEA60] arrayWithObjects:&v309 count:1];
    [messageDispatcher66 registerForMessage:@"HomeUtil.Command.Wallet" receiver:v9 policies:v280 selector:sel__handleHomeUtilCommandWalletMessage_];
  }

  [(HMDHomeManager *)v9 _registerForMediaSystemHintsMessages];
  notificationCenter2 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter2 addObserver:v9 selector:sel_dataSyncInProgressUpdatedNotification_ name:@"kCloudDataSyncInProgressUpdatedNotification" object:0];

  notificationCenter3 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter3 addObserver:v9 selector:sel_handleVendorInfoUpdated_ name:@"kHMDVendorInfoUpdatedNotification" object:0];

  notificationCenter4 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter4 addObserver:v9 selector:sel_auditDuplicatePreviouslyAddedAccessory_ name:@"HMDHomeThisOwnerDeviceAddedAccessoryNotification" object:0];

  notificationCenter5 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter5 addObserver:v9 selector:sel___handleAppleAccountUpdated_ name:@"HMDAppleAccountManagerAccountUpdatedNotification" object:0];

  notificationCenter6 = [(HMDHomeManager *)v9 notificationCenter];
  v286 = +[HMDAccountRegistry sharedRegistry];
  [notificationCenter6 addObserver:v9 selector:sel___accountRegistryAddedAccount_ name:@"HMDAccountRegistryAddedAccountNotification" object:v286];

  notificationCenter7 = [(HMDHomeManager *)v9 notificationCenter];
  v288 = +[HMDAccountRegistry sharedRegistry];
  [notificationCenter7 addObserver:v9 selector:sel___accountRegistryRemovedAccount_ name:@"HMDAccountRegistryRemovedAccountNotification" object:v288];

  notificationCenter8 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter8 addObserver:v9 selector:sel___accountAddedDevice_ name:@"HMDAccountAddedDeviceNotification" object:0];

  notificationCenter9 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter9 addObserver:v9 selector:sel___handleDeviceUpdatedNotification_ name:@"HMDDeviceUpdatedNotification" object:0];

  notificationCenter10 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter10 addObserver:v9 selector:sel___accountRemovedDevice_ name:@"HMDAccountRemovedDeviceNotification" object:0];

  notificationCenter11 = [(HMDHomeManager *)v9 notificationCenter];
  [notificationCenter11 addObserver:v9 selector:sel___handleHMDFMFStatusUpdateNotification_ name:@"HMDFMFStatusUpdateNotification" object:0];

  notificationCenter12 = [(HMDHomeManager *)v9 notificationCenter];
  messageDispatcher67 = [(HMDHomeManager *)v9 messageDispatcher];
  [notificationCenter12 addObserver:v9 selector:sel__handleRemoteSessionTornDownNotification_ name:@"HMDMessageDispatcherRemoteSessionTornDownNotification" object:messageDispatcher67];

  defaultCenter = [MEMORY[0x277CCA9A0] defaultCenter];
  [defaultCenter addObserver:v9 selector:sel__handleSEUpdatedAliroVersions name:@"com.apple.secureelementservice.acwg.event.versions.did.update" object:0];

  v296 = [MEMORY[0x277CBEB98] setWithArray:&unk_283E75CB0];
  memoryMonitor = [MEMORY[0x277D0F810] memoryMonitor];
  [memoryMonitor addObserver:v9 debounceInterval:v296 events:0.0];
  [(HMDHomeManager *)v9 registerNotificationsForPowerManagement];
  [(HMDHomeManager *)v9 configureForWalletKey];

  v298 = *MEMORY[0x277D85DE8];
}

- (BOOL)_setPrimaryHome:(id)home idsDataSync:(BOOL)sync
{
  syncCopy = sync;
  v30 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];
  v8 = homeCopy;
  homes = [(HMDHomeManager *)self homes];
  v10 = [homes count];

  if (v10)
  {
    if (!v8)
    {
      goto LABEL_5;
    }

    if (syncCopy)
    {
      isWatch();
LABEL_5:
      homes2 = [(HMDHomeManager *)self homes];
      v12 = [homes2 hmf_firstObjectWithUUID:primaryHomeUUID];

      if (!v12)
      {
        homes3 = [(HMDHomeManager *)self homes];
        firstObject = [homes3 firstObject];

        uuid = [firstObject uuid];

        v16 = HMFEqualObjects();
        if ((v16 & 1) == 0)
        {
          goto LABEL_12;
        }

LABEL_9:
        v17 = 0;
        goto LABEL_15;
      }

LABEL_11:
      v17 = 0;
      uuid = v8;
      goto LABEL_15;
    }

    uuid = v8;
    if (HMFEqualObjects())
    {
      goto LABEL_11;
    }
  }

  else
  {

    uuid = 0;
    if (HMFEqualObjects())
    {
      goto LABEL_9;
    }
  }

LABEL_12:
  v18 = objc_autoreleasePoolPush();
  selfCopy = self;
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    v24 = 138543874;
    v25 = v21;
    v26 = 2112;
    v27 = primaryHomeUUID;
    v28 = 2112;
    v29 = uuid;
    _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Updating the primary home from %@ to %@", &v24, 0x20u);
  }

  objc_autoreleasePoolPop(v18);
  [(HMDHomeManager *)selfCopy setPrimaryHomeUUID:uuid];
  [(HMDHomeManager *)selfCopy _updateCurrentHomeIfNecessary];
  v17 = 1;
LABEL_15:

  v22 = *MEMORY[0x277D85DE8];
  return v17;
}

- (BOOL)_associateAccessories:(id)accessories withHomes:(id)homes
{
  v48 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  homesCopy = homes;
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  v38 = 0u;
  v39 = 0u;
  v40 = 0u;
  v41 = 0u;
  v7 = accessoriesCopy;
  v8 = [v7 countByEnumeratingWithState:&v38 objects:v47 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = 0;
    v11 = *v39;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v39 != v11)
        {
          objc_enumerationMutation(v7);
        }

        v13 = *(*(&v38 + 1) + 8 * i);
        home = [v13 home];
        uuid = [home uuid];

        if (uuid)
        {
          array = [dictionary hmf_mutableArrayForKey:uuid];
          if (!array)
          {
            array = [MEMORY[0x277CBEB18] array];
            [dictionary setObject:array forKey:uuid];
          }

          [array addObject:v13];
        }

        else
        {
          v17 = objc_autoreleasePoolPush();
          v18 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
          {
            v19 = HMFGetLogIdentifier();
            *buf = 138543618;
            v44 = v19;
            v45 = 2112;
            v46 = v13;
            _os_log_impl(&dword_229538000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@###### Unassociated accessory %@ - dropping", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v17);
          v10 = 1;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v38 objects:v47 count:16];
    }

    while (v9);
  }

  else
  {
    v10 = 0;
  }

  v36 = 0u;
  v37 = 0u;
  v34 = 0u;
  v35 = 0u;
  v20 = homesCopy;
  v21 = [v20 countByEnumeratingWithState:&v34 objects:v42 count:16];
  if (v21)
  {
    v22 = v21;
    v23 = *v35;
    do
    {
      for (j = 0; j != v22; ++j)
      {
        if (*v35 != v23)
        {
          objc_enumerationMutation(v20);
        }

        v25 = *(*(&v34 + 1) + 8 * j);
        accessories = [v25 accessories];
        v27 = [accessories count];

        if (!v27)
        {
          uuid2 = [v25 uuid];
          v29 = [dictionary hmf_mutableArrayForKey:uuid2];

          [v25 setAccessories:v29];
          uuid3 = [v25 uuid];
          [dictionary removeObjectForKey:uuid3];
        }
      }

      v22 = [v20 countByEnumeratingWithState:&v34 objects:v42 count:16];
    }

    while (v22);
  }

  v31 = *MEMORY[0x277D85DE8];
  return v10 & 1;
}

- (void)_auditKeychainEntries
{
  v80 = *MEMORY[0x277D85DE8];
  dictionary = [MEMORY[0x277CBEB38] dictionary];
  selfCopy = self;
  v69 = 0u;
  v70 = 0u;
  v71 = 0u;
  v72 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v54 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
  if (v54)
  {
    v53 = *v70;
    do
    {
      v3 = 0;
      do
      {
        if (*v70 != v53)
        {
          objc_enumerationMutation(obj);
        }

        v55 = v3;
        v4 = *(*(&v69 + 1) + 8 * v3);
        v65 = 0u;
        v66 = 0u;
        v67 = 0u;
        v68 = 0u;
        accessories = [v4 accessories];
        v5 = [accessories countByEnumeratingWithState:&v65 objects:v78 count:16];
        if (v5)
        {
          v6 = v5;
          v7 = *v66;
          do
          {
            for (i = 0; i != v6; ++i)
            {
              if (*v66 != v7)
              {
                objc_enumerationMutation(accessories);
              }

              v9 = *(*(&v65 + 1) + 8 * i);
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v10 = v9;
              }

              else
              {
                v10 = 0;
              }

              v11 = v10;

              if (!v11)
              {
                v16 = v9;
                objc_opt_class();
                if (objc_opt_isKindOfClass())
                {
                  v17 = v16;
                }

                else
                {
                  v17 = 0;
                }

                v13 = v17;

                if (v13)
                {
                  identifier = [v13 identifier];

                  if (!identifier)
                  {
                    v19 = objc_autoreleasePoolPush();
                    v20 = selfCopy;
                    v21 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
                    {
                      v22 = HMFGetLogIdentifier();
                      *buf = 138543618;
                      v75 = v22;
                      v76 = 2112;
                      v77 = v13;
                      _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to add accessory %@ to the audit accessory list since identifier is nil", buf, 0x16u);
                    }

                    objc_autoreleasePoolPop(v19);
                  }
                }

                goto LABEL_27;
              }

              pairingUsername = [v11 pairingUsername];
              if (pairingUsername || ([v11 identifier], (pairingUsername = objc_claimAutoreleasedReturnValue()) != 0))
              {
                v13 = pairingUsername;
                publicKey = [v11 publicKey];

                if (publicKey)
                {
                  publicKey2 = [v11 publicKey];
                  [dictionary setObject:publicKey2 forKey:v13];

LABEL_27:
                  goto LABEL_34;
                }

                v23 = objc_autoreleasePoolPush();
                v24 = selfCopy;
                v25 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
                {
                  v26 = HMFGetLogIdentifier();
                  name = [v11 name];
                  *buf = 138543618;
                  v75 = v26;
                  v76 = 2112;
                  v77 = name;
                  _os_log_impl(&dword_229538000, v25, OS_LOG_TYPE_ERROR, "%{public}@A HAP accessory '%@' with a public key - removing from list of of keychain entries", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v23);
              }

              else
              {
                v28 = objc_autoreleasePoolPush();
                v29 = selfCopy;
                v30 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
                {
                  v31 = HMFGetLogIdentifier();
                  name2 = [v11 name];
                  *buf = 138543618;
                  v75 = v31;
                  v76 = 2112;
                  v77 = name2;
                  _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to add accessory %@ to the audit accessory list for keychain cleanup", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v28);
              }

LABEL_34:
            }

            v6 = [accessories countByEnumeratingWithState:&v65 objects:v78 count:16];
          }

          while (v6);
        }

        v3 = v55 + 1;
      }

      while (v55 + 1 != v54);
      v54 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
    }

    while (v54);
  }

  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v34 = [systemStore auditKeysOfManagedAccessories:dictionary];
  v35 = v34;
  if (v34)
  {
    v56 = v34;
    v57 = systemStore;
    v63 = 0u;
    v64 = 0u;
    v61 = 0u;
    v62 = 0u;
    v36 = v34;
    v37 = [v36 countByEnumeratingWithState:&v61 objects:v73 count:16];
    if (v37)
    {
      v38 = v37;
      v39 = *v62;
      do
      {
        for (j = 0; j != v38; ++j)
        {
          if (*v62 != v39)
          {
            objc_enumerationMutation(v36);
          }

          v41 = *(*(&v61 + 1) + 8 * j);
          v42 = objc_autoreleasePoolPush();
          v43 = selfCopy;
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
          {
            v45 = HMFGetLogIdentifier();
            v46 = [v41 description];
            *buf = 138543618;
            v75 = v45;
            v76 = 2112;
            v77 = v46;
            _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Removed spurious keychain entry: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v42);
        }

        v38 = [v36 countByEnumeratingWithState:&v61 objects:v73 count:16];
      }

      while (v38);
    }

    v35 = v56;
    systemStore = v57;
  }

  else
  {
    v47 = objc_autoreleasePoolPush();
    v48 = selfCopy;
    v49 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      v50 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v50;
      _os_log_impl(&dword_229538000, v49, OS_LOG_TYPE_DEFAULT, "%{public}@Audit keychain entries failed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v47);
  }

  v51 = *MEMORY[0x277D85DE8];
}

- (id)_deviceForIdentifier:(id)identifier
{
  v22 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v5 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:identifierCopy];
  if (v5)
  {
    v19 = 0u;
    v20 = 0u;
    v17 = 0u;
    v18 = 0u;
    appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
    account = [appleAccountManager account];
    devices = [account devices];

    v9 = [devices countByEnumeratingWithState:&v17 objects:v21 count:16];
    if (v9)
    {
      v10 = *v18;
      while (2)
      {
        for (i = 0; i != v9; i = i + 1)
        {
          if (*v18 != v10)
          {
            objc_enumerationMutation(devices);
          }

          v12 = *(*(&v17 + 1) + 8 * i);
          identifier = [v12 identifier];
          v14 = [v5 isEqual:identifier];

          if (v14)
          {
            v9 = v12;
            goto LABEL_12;
          }
        }

        v9 = [devices countByEnumeratingWithState:&v17 objects:v21 count:16];
        if (v9)
        {
          continue;
        }

        break;
      }
    }

LABEL_12:
  }

  else
  {
    v9 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v9;
}

- (id)_filterAccessories:(id)accessories inHome:(id)home
{
  v25 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  homeCopy = home;
  array = [MEMORY[0x277CBEB18] array];
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v7 = accessoriesCopy;
  v8 = [v7 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v21;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v21 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v20 + 1) + 8 * i);
        home = [v12 home];
        uuid = [home uuid];
        uuid2 = [homeCopy uuid];
        v16 = [uuid isEqual:uuid2];

        if (v16)
        {
          [array addObject:v12];
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v9);
  }

  v17 = *MEMORY[0x277D85DE8];

  return array;
}

- (id)_filterAccessories:(id)accessories withIdentifiers:(id)identifiers
{
  v26 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  identifiersCopy = identifiers;
  v20 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(accessoriesCopy, "count")}];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v7 = accessoriesCopy;
  v8 = [v7 countByEnumeratingWithState:&v21 objects:v25 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v22;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v22 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v21 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v13 = v12;
        }

        else
        {
          v13 = 0;
        }

        v14 = v13;

        if (v14)
        {
          uniqueIdentifier = [v14 uniqueIdentifier];
          v16 = [identifiersCopy containsObject:uniqueIdentifier];

          if (v16)
          {
            [v20 addObject:v12];
          }
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v21 objects:v25 count:16];
    }

    while (v9);
  }

  v17 = [v20 copy];
  v18 = *MEMORY[0x277D85DE8];

  return v17;
}

- (id)identifiersOfAccessories:(id)accessories
{
  v22 = *MEMORY[0x277D85DE8];
  accessoriesCopy = accessories;
  v4 = [MEMORY[0x277CBEB58] set];
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v5 = accessoriesCopy;
  v6 = [v5 countByEnumeratingWithState:&v17 objects:v21 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v18;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v18 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v17 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v11 = v10;
        }

        else
        {
          v11 = 0;
        }

        v12 = v11;

        if (v12)
        {
          uniqueIdentifier = [v12 uniqueIdentifier];
          [v4 addObject:uniqueIdentifier];
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v17 objects:v21 count:16];
    }

    while (v7);
  }

  v14 = [v4 copy];
  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)identifiersOfAccessoriesForHome:(id)home
{
  accessories = [home accessories];
  v5 = [(HMDHomeManager *)self identifiersOfAccessories:accessories];

  return v5;
}

- (id)mediaSystemForAppleMediaAccessory:(id)accessory
{
  v19 = *MEMORY[0x277D85DE8];
  accessoryCopy = accessory;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(homes);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) mediaSystemForAppleMediaAccessory:accessoryCopy];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (id)destinationIdentifierForMediaSystem:(id)system role:(unint64_t)role
{
  v45 = *MEMORY[0x277D85DE8];
  systemCopy = system;
  v34 = 0u;
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  components = [systemCopy components];
  v8 = [components countByEnumeratingWithState:&v34 objects:v44 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v35;
LABEL_3:
    v11 = 0;
    while (1)
    {
      if (*v35 != v10)
      {
        objc_enumerationMutation(components);
      }

      v12 = *(*(&v34 + 1) + 8 * v11);
      role = [v12 role];
      type = [role type];

      if (type == role)
      {
        break;
      }

      if (v9 == ++v11)
      {
        v9 = [components countByEnumeratingWithState:&v34 objects:v44 count:16];
        if (v9)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v15 = v12;

    if (!v15)
    {
      goto LABEL_16;
    }

    accessory = [v15 accessory];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v17 = accessory;
    }

    else
    {
      v17 = 0;
    }

    v18 = v17;

    audioDestination = [v18 audioDestination];
    uniqueIdentifier = [audioDestination uniqueIdentifier];

    if (uniqueIdentifier)
    {
      v21 = uniqueIdentifier;
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      selfCopy = self;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
      {
        v31 = HMFGetLogIdentifier();
        *buf = 138543874;
        v39 = v31;
        v40 = 2112;
        v41 = v15;
        v42 = 2112;
        v43 = v18;
        _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to get destination identifier on component: %@ accessory: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v28);
    }
  }

  else
  {
LABEL_9:

LABEL_16:
    v22 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
    {
      v25 = HMFGetLogIdentifier();
      v26 = HMMediaSystemRoleTypeAsString();
      components2 = [systemCopy components];
      *buf = 138543874;
      v39 = v25;
      v40 = 2112;
      v41 = v26;
      v42 = 2112;
      v43 = components2;
      _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_ERROR, "%{public}@Failed to get destination identifier due to no component with role: %@ components: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v22);
    uniqueIdentifier = 0;
  }

  v32 = *MEMORY[0x277D85DE8];

  return uniqueIdentifier;
}

- (void)saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:(id)accessory
{
  v23 = *MEMORY[0x277D85DE8];
  accessoryCopy = accessory;
  home = [accessoryCopy home];
  uuid = [home uuid];

  userDefaults = [(HMDHomeManager *)self userDefaults];
  v8 = userDefaults;
  if (uuid && userDefaults)
  {
    v9 = [HMDMediaGroupsStageManager alloc];
    userDefaults2 = [(HMDHomeManager *)self userDefaults];
    v11 = [(HMDMediaGroupsStageManager *)v9 initWithIdentifier:uuid userDefaults:userDefaults2];

    [(HMDMediaGroupsStageManager *)v11 saveAssociatedGroupDataForLegacyCurrentAccessory:accessoryCopy];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    selfCopy = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      v17 = 138543874;
      v18 = v15;
      v19 = 2112;
      v20 = uuid;
      v21 = 2112;
      v22 = v8;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@Failed to save associated group data due to missing homeUUID: %@ userDefaults: %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalStereoPairDataForCurrentMediaSystem:(id)system
{
  v45 = *MEMORY[0x277D85DE8];
  systemCopy = system;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v38 = v8;
    v39 = 2112;
    v40 = systemCopy;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Migrating current media system: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  configuredName = [systemCopy configuredName];
  v10 = configuredName;
  if (configuredName)
  {
    roomNameSentinel = configuredName;
  }

  else
  {
    roomNameSentinel = [MEMORY[0x277CD1C08] roomNameSentinel];
  }

  v12 = roomNameSentinel;
  audioDestination = [systemCopy audioDestination];
  audioGroupIdentifier = [audioDestination audioGroupIdentifier];

  v15 = [(HMDHomeManager *)selfCopy destinationIdentifierForMediaSystem:systemCopy role:1];
  v16 = [(HMDHomeManager *)selfCopy destinationIdentifierForMediaSystem:systemCopy role:2];
  home = [systemCopy home];
  uuid = [home uuid];

  if (v15 && v16 && uuid)
  {
    v34 = audioGroupIdentifier;
    v19 = v12;
    v20 = objc_alloc(MEMORY[0x277CD1C08]);
    uuid2 = [systemCopy uuid];
    v22 = [v20 initWithIdentifier:uuid2 parentIdentifier:uuid name:v12 defaultName:v10 == 0 associatedGroupIdentifier:v34 leftDestinationIdentifier:v15 rightDestinationIdentifier:v16];

    mediaGroupParticipantDataLocalStorage = [(HMDHomeManager *)selfCopy mediaGroupParticipantDataLocalStorage];
    uuid3 = [systemCopy uuid];
    [mediaGroupParticipantDataLocalStorage updateAudioGroupIdentifier:uuid3];

    mediaGroupParticipantDataLocalStorage2 = [(HMDHomeManager *)selfCopy mediaGroupParticipantDataLocalStorage];
    encodeToProtoBufferData = [v22 encodeToProtoBufferData];
    v36 = encodeToProtoBufferData;
    v27 = [MEMORY[0x277CBEA60] arrayWithObjects:&v36 count:1];
    [mediaGroupParticipantDataLocalStorage2 updateBackupGroupData:v27];

    v12 = v19;
    audioGroupIdentifier = v34;
  }

  else
  {
    v28 = objc_autoreleasePoolPush();
    v29 = selfCopy;
    v30 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      HMFGetLogIdentifier();
      v35 = audioGroupIdentifier;
      v32 = v31 = v12;
      *buf = 138544130;
      v38 = v32;
      v39 = 2112;
      v40 = v15;
      v41 = 2112;
      v42 = v16;
      v43 = 2112;
      v44 = uuid;
      _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to migrate current media system due to missing group data dependencies leftDestinationIdentifier: %@ rightDestinationIdentifier: %@ homeIdentifier: %@", buf, 0x2Au);

      v12 = v31;
      audioGroupIdentifier = v35;
    }

    objc_autoreleasePoolPop(v28);
  }

  v33 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalHomeTheaterDataForCurrentAccessory:(id)accessory currentMediaSystem:(id)system
{
  v28 = *MEMORY[0x277D85DE8];
  accessoryCopy = accessory;
  systemCopy = system;
  audioDestinationControllerData = [accessoryCopy audioDestinationControllerData];
  if (audioDestinationControllerData)
  {
    v9 = objc_autoreleasePoolPush();
    selfCopy = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v24 = 138543618;
      v25 = v12;
      v26 = 2112;
      v27 = audioDestinationControllerData;
      _os_log_impl(&dword_229538000, v11, OS_LOG_TYPE_INFO, "%{public}@Migrating current destination controller data: %@", &v24, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    mediaGroupParticipantDataLocalStorage = [(HMDHomeManager *)selfCopy mediaGroupParticipantDataLocalStorage];
    [mediaGroupParticipantDataLocalStorage updateDestinationControllerData:audioDestinationControllerData];
  }

  audioDestination = [accessoryCopy audioDestination];
  v15 = [audioDestination mutableCopy];

  if (v15)
  {
    uuid = [systemCopy uuid];
    if (uuid)
    {
      [v15 setAudioGroupIdentifier:uuid];
    }

    else
    {
      audioGroupIdentifier = [v15 audioGroupIdentifier];
      [v15 setAudioGroupIdentifier:audioGroupIdentifier];
    }

    v18 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      v24 = 138543618;
      v25 = v21;
      v26 = 2112;
      v27 = v15;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Migrating current destination: %@", &v24, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    mediaGroupParticipantDataLocalStorage2 = [(HMDHomeManager *)selfCopy2 mediaGroupParticipantDataLocalStorage];
    [mediaGroupParticipantDataLocalStorage2 updateMediaDestination:v15];
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalMediaGroupParticipantData
{
  v14 = *MEMORY[0x277D85DE8];
  _appleMediaAccessoryOfCurrentDevice = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
  if (_appleMediaAccessoryOfCurrentDevice)
  {
    v4 = [(HMDHomeManager *)self mediaSystemForAppleMediaAccessory:_appleMediaAccessoryOfCurrentDevice];
    v5 = objc_autoreleasePoolPush();
    selfCopy = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = _appleMediaAccessoryOfCurrentDevice;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Migrating local media group participant data for current accessory: %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [(HMDHomeManager *)selfCopy migrateLocalHomeTheaterDataForCurrentAccessory:_appleMediaAccessoryOfCurrentDevice currentMediaSystem:v4];
    if (v4)
    {
      [(HMDHomeManager *)selfCopy migrateLocalStereoPairDataForCurrentMediaSystem:v4];
    }

    [(HMDHomeManager *)selfCopy saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:_appleMediaAccessoryOfCurrentDevice];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)initializeMediaGroupParticipantDataLocalStorage
{
  v26 = *MEMORY[0x277D85DE8];
  uuid = [(HMDHomeManager *)self uuid];
  userDefaults = [(HMDHomeManager *)self userDefaults];
  eventForwarder = [(HMDHomeManager *)self eventForwarder];
  eventStoreReadHandle = [(HMDHomeManager *)self eventStoreReadHandle];
  v7 = eventStoreReadHandle;
  if (uuid && userDefaults && eventForwarder && eventStoreReadHandle)
  {
    v8 = objc_alloc_init(HMDMediaGroupsAggregatorBackupReceiver);
    v9 = [[HMDMediaGroupParticipantLocalDataStorage alloc] initWithIdentifier:uuid backUpReciever:v8 userDefaults:userDefaults eventForwarder:eventForwarder eventStoreReadHandle:v7];
    [(HMDMediaGroupsAggregatorBackupReceiver *)v8 setDelegate:v9];
    [(HMDMediaGroupParticipantLocalDataStorage *)v9 setDataSource:self];
    [(HMDMediaGroupParticipantLocalDataStorage *)v9 setDelegate:self];
    mediaGroupParticipantDataLocalStorage = self->_mediaGroupParticipantDataLocalStorage;
    self->_mediaGroupParticipantDataLocalStorage = v9;
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    selfCopy = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v16 = 138544386;
      v17 = v14;
      v18 = 2112;
      v19 = uuid;
      v20 = 2112;
      v21 = userDefaults;
      v22 = 2112;
      v23 = eventForwarder;
      v24 = 2112;
      v25 = v7;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to configure media group participant data local storage with dependencies homeManagerUUID: %@ userDefaults: %@ eventForwarder: %@ eventStoreReadHandle: %@", &v16, 0x34u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (BOOL)_configureHomesImpl:(id)impl uncommittedTransactions:(id)transactions
{
  v80 = *MEMORY[0x277D85DE8];
  implCopy = impl;
  transactionsCopy = transactions;
  [(HMDHomeManager *)self setHomes:implCopy];
  v7 = [HMDNameValidator alloc];
  uuid = [(HMDHomeManager *)self uuid];
  v9 = [(HMDNameValidator *)v7 initWithUUID:uuid];
  [(HMDHomeManager *)self setNameValidator:v9];

  notificationCenter = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter removeObserver:self name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:0];

  array = [MEMORY[0x277CBEB18] array];
  [HMDAliroVersionUtilities readAliroVersionIntoMemoryOnHomeManager:self];
  [HMDAliroVersionUtilities readAndSaveAliroVersionFromSESOnHomeManager:self completionHandler:&__block_literal_global_706];
  isResidentEnabled = [(HMDHomeManager *)self isResidentEnabled];
  v69 = 0u;
  v70 = 0u;
  v71 = 0u;
  v72 = 0u;
  obj = implCopy;
  v11 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
  if (!v11)
  {
    LOBYTE(v14) = 0;
    goto LABEL_35;
  }

  v13 = v11;
  v14 = 0;
  v15 = *v70;
  *&v12 = 138543618;
  v60 = v12;
  selfCopy = self;
  do
  {
    v16 = 0;
    do
    {
      if (*v70 != v15)
      {
        objc_enumerationMutation(obj);
      }

      v17 = *(*(&v69 + 1) + 8 * v16);
      v18 = objc_autoreleasePoolPush();
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v68 = v18;
        v19 = v17;
        v20 = objc_autoreleasePoolPush();
        v21 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v22 = v13;
          v23 = v15;
          v25 = v24 = v14;
          name = [v19 name];
          ownerName = [v19 ownerName];
          *buf = 138543874;
          v74 = v25;
          v75 = 2112;
          v76 = name;
          v77 = 2112;
          v78 = ownerName;
          _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_INFO, "%{public}@Found home %@ with administrator %@", buf, 0x20u);

          v14 = v24;
          v15 = v23;
          v13 = v22;
          self = selfCopy;
        }

        objc_autoreleasePoolPop(v20);
        nameValidator = [(HMDHomeManager *)self nameValidator];
        uuid2 = [v19 uuid];
        v30 = [nameValidator addNamespace:uuid2];

        v14 |= [v19 configureWithHomeManager:self accessoriesPresent:array uncommittedTransactions:transactionsCopy source:0];
        name2 = [v19 name];
        uuid3 = [(HMDHomeManager *)self uuid];
        v33 = [(HMDHomeManager *)self addName:name2 namespace:uuid3];

        uuid4 = [v19 uuid];
        -[HMDHomeManager _updateHome:configurationVersion:](self, "_updateHome:configurationVersion:", uuid4, [v19 configurationVersion]);

        if ([v19 isOwnerUser] && (+[HMDDeviceCapabilities deviceCapabilities](HMDDeviceCapabilities, "deviceCapabilities"), v35 = objc_claimAutoreleasedReturnValue(), v36 = objc_msgSend(v35, "isResidentCapable"), v35, v36))
        {
          v64 = v14;
          notificationCenter2 = [(HMDHomeManager *)self notificationCenter];
          [notificationCenter2 addObserver:self selector:sel_handleHomeCurrentDeviceResidentEligibleNotification_ name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:v19];

          appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
          device = [appleAccountManager device];

          capabilitiesController = [(HMDHomeManager *)self capabilitiesController];
          currentResidentCapabilities = [capabilitiesController currentResidentCapabilities];
          if (currentResidentCapabilities && [(HMDHomeManager *)self isResidentEnabled])
          {
            hasReachableAccessories = [v19 hasReachableAccessories];

            if (hasReachableAccessories)
            {
              residentCapableDevices = [v19 residentCapableDevices];
              v44 = device;
              v45 = [residentCapableDevices containsObject:device];

              v14 = v64;
              if ((v45 & 1) == 0)
              {
                [v19 addResidentCapableDevice:v44];
                context = objc_autoreleasePoolPush();
                selfCopy2 = HMFGetOSLogHandle();
                v64 = 1;
                if (os_log_type_enabled(&selfCopy2->super.super, OS_LOG_TYPE_INFO))
                {
                  v47 = HMFGetLogIdentifier();
                  name3 = [v44 name];
                  name4 = [v19 name];
                  *buf = 138543874;
                  v74 = v47;
                  v75 = 2112;
                  v76 = name3;
                  v77 = 2112;
                  v78 = name4;
                  v64 = 1;
                  _os_log_impl(&dword_229538000, &selfCopy2->super.super, OS_LOG_TYPE_INFO, "%{public}@Configuration changed: add resident capable device %@ to %@", buf, 0x20u);
                }

                goto LABEL_25;
              }

              goto LABEL_26;
            }
          }

          else
          {
          }

          v14 = v64;
          if ([(HMDHomeManager *)self isResidentEnabled])
          {
            v44 = device;
            goto LABEL_26;
          }

          residentCapableDevices2 = [v19 residentCapableDevices];
          v44 = device;
          v51 = [residentCapableDevices2 containsObject:device];

          if (v51)
          {
            context = objc_autoreleasePoolPush();
            selfCopy2 = self;
            v52 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v52, OS_LOG_TYPE_INFO))
            {
              v53 = HMFGetLogIdentifier();
              *buf = v60;
              v74 = v53;
              v75 = 2112;
              v76 = v19;
              _os_log_impl(&dword_229538000, v52, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in home, %@, enabling ourselves as a resident device", buf, 0x16u);
            }

            isResidentEnabled = 1;
LABEL_25:
            v18 = v68;

            objc_autoreleasePoolPop(context);
            v14 = v64;
          }

          else
          {
LABEL_26:
            v18 = v68;
          }
        }

        else
        {
          v18 = v68;
        }
      }

      objc_autoreleasePoolPop(v18);
      ++v16;
    }

    while (v13 != v16);
    v54 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
    v13 = v54;
  }

  while (v54);
LABEL_35:

  isResidentEnabled2 = [(HMDHomeManager *)self isResidentEnabled];
  v56 = isResidentEnabled;
  if (v56 != isResidentEnabled2)
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:v56 forceNotify:0 message:0];
  }

  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  [idsServerBag configure];

  [(HMDHomeManager *)self _readAccessAllowedWhenLockedSettingFromLocalStore];
  [(HMDHomeManager *)self _checkForSelfRemoval];

  v58 = *MEMORY[0x277D85DE8];
  return v14 & 1;
}

- (BOOL)_configureHomes:(id)homes uncommittedTransactions:(id)transactions
{
  v25 = *MEMORY[0x277D85DE8];
  homesCopy = homes;
  transactionsCopy = transactions;
  [(HMDHomeManager *)self startLocalTransport];
  v8 = dispatch_group_create();
  dispatch_group_enter(v8);
  v9 = +[HMDLocation sharedManager];
  v19[0] = MEMORY[0x277D85DD0];
  v19[1] = 3221225472;
  v19[2] = __58__HMDHomeManager__configureHomes_uncommittedTransactions___block_invoke;
  v19[3] = &unk_27868A728;
  v10 = v8;
  v20 = v10;
  [v9 beingConfigured:1 completionHandler:v19];

  dispatch_group_wait(v10, 0xFFFFFFFFFFFFFFFFLL);
  v11 = [(HMDHomeManager *)self _configureHomesImpl:homesCopy uncommittedTransactions:transactionsCopy];
  v12 = objc_autoreleasePoolPush();
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v15 = HMFBooleanToString();
    *buf = 138543618;
    v22 = v14;
    v23 = 2112;
    v24 = v15;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Configured homes with result: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  v16 = +[HMDLocation sharedManager];
  [v16 beingConfigured:0 completionHandler:0];

  v17 = *MEMORY[0x277D85DE8];
  return v11;
}

- (id)_checkActionSetNameConflict:(id)conflict withNamespaceUUIDs:(id)ds
{
  v40 = *MEMORY[0x277D85DE8];
  conflictCopy = conflict;
  dsCopy = ds;
  nameValidator = [(HMDHomeManager *)self nameValidator];
  v25 = conflictCopy;
  v9 = [nameValidator despaceName:conflictCopy];

  v36 = 0u;
  v37 = 0u;
  v34 = 0u;
  v35 = 0u;
  obj = dsCopy;
  v28 = [obj countByEnumeratingWithState:&v34 objects:v39 count:16];
  if (!v28)
  {
    v21 = 0;
    goto LABEL_24;
  }

  v27 = *v35;
  while (2)
  {
    for (i = 0; i != v28; ++i)
    {
      if (*v35 != v27)
      {
        objc_enumerationMutation(obj);
      }

      v11 = [(HMDHomeManager *)self _homeWithUUID:*(*(&v34 + 1) + 8 * i)];
      if (!v11)
      {
        v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        v22 = 0;
LABEL_23:

        goto LABEL_24;
      }

      v32 = 0u;
      v33 = 0u;
      v30 = 0u;
      v31 = 0u;
      v29 = v11;
      actionSets = [v11 actionSets];
      v13 = [actionSets countByEnumeratingWithState:&v30 objects:v38 count:16];
      if (v13)
      {
        v14 = v13;
        v15 = *v31;
LABEL_9:
        v16 = 0;
        while (1)
        {
          if (*v31 != v15)
          {
            objc_enumerationMutation(actionSets);
          }

          v17 = *(*(&v30 + 1) + 8 * v16);
          nameValidator2 = [(HMDHomeManager *)self nameValidator];
          name = [v17 name];
          v20 = [nameValidator2 despaceName:name];

          if ([v9 isEqualToString:v20])
          {
            break;
          }

          if (v14 == ++v16)
          {
            v14 = [actionSets countByEnumeratingWithState:&v30 objects:v38 count:16];
            if (v14)
            {
              goto LABEL_9;
            }

            goto LABEL_15;
          }
        }

        v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:31];

        if (!v21)
        {
          goto LABEL_17;
        }

        v22 = v29;
        goto LABEL_23;
      }

LABEL_15:

LABEL_17:
    }

    v21 = 0;
    v28 = [obj countByEnumeratingWithState:&v34 objects:v39 count:16];
    if (v28)
    {
      continue;
    }

    break;
  }

LABEL_24:

  v23 = *MEMORY[0x277D85DE8];

  return v21;
}

- (id)_checkNameConflict:(id)conflict withNamespaceUUIDs:(id)ds
{
  v22 = *MEMORY[0x277D85DE8];
  conflictCopy = conflict;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  dsCopy = ds;
  v8 = [dsCopy countByEnumeratingWithState:&v17 objects:v21 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v18;
LABEL_3:
    v11 = 0;
    while (1)
    {
      if (*v18 != v10)
      {
        objc_enumerationMutation(dsCopy);
      }

      v12 = *(*(&v17 + 1) + 8 * v11);
      nameValidator = [(HMDHomeManager *)self nameValidator];
      v14 = [nameValidator checkForConflict:conflictCopy namespace:v12];

      if (v14)
      {
        break;
      }

      if (v9 == ++v11)
      {
        v9 = [dsCopy countByEnumeratingWithState:&v17 objects:v21 count:16];
        if (v9)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }
  }

  else
  {
LABEL_9:
    v14 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)messageDestination
{
  v3 = objc_alloc(MEMORY[0x277D0F820]);
  messageTargetUUID = [(HMDHomeManager *)self messageTargetUUID];
  v5 = [v3 initWithTarget:messageTargetUUID];

  return v5;
}

- (void)accessoriesAreLocallyReachableOnTransientDevice:(BOOL)device forHome:(id)home
{
  homeCopy = home;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __74__HMDHomeManager_accessoriesAreLocallyReachableOnTransientDevice_forHome___block_invoke;
  block[3] = &unk_278688BD0;
  deviceCopy = device;
  block[4] = self;
  v10 = homeCopy;
  v8 = homeCopy;
  dispatch_async(workQueue, block);
}

- (void)_setUniqueDeviceIdSalt:(id)salt
{
  v11 = *MEMORY[0x277D85DE8];
  saltCopy = salt;
  v5 = objc_autoreleasePoolPush();
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v7;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Saving the device identifier salt", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kUniqueDeviceIdentifierSaltkey" value:saltCopy applicationIdentifier:*MEMORY[0x277CD0028]];

  v8 = *MEMORY[0x277D85DE8];
}

- (BOOL)_updateAccessoriesConfigured
{
  v122 = *MEMORY[0x277D85DE8];
  if (![(HMDHomeManager *)self hasLoadedData])
  {
    v24 = 0;
    goto LABEL_104;
  }

  v114 = 0u;
  v115 = 0u;
  v112 = 0u;
  v113 = 0u;
  selfCopy = self;
  obj = [(HMDHomeManager *)self homes];
  v102 = [obj countByEnumeratingWithState:&v112 objects:v121 count:16];
  if (!v102)
  {
    v106 = 0;
    v107 = 0;
    v3 = 0;
    v104 = 0;
    v4 = 0;
    goto LABEL_46;
  }

  v106 = 0;
  v107 = 0;
  v3 = 0;
  v104 = 0;
  v4 = 0;
  v101 = *v113;
  do
  {
    for (i = 0; i != v102; ++i)
    {
      if (*v113 != v101)
      {
        objc_enumerationMutation(obj);
      }

      v6 = *(*(&v112 + 1) + 8 * i);
      v108 = 0u;
      v109 = 0u;
      v110 = 0u;
      v111 = 0u;
      v105 = v6;
      accessories = [v6 accessories];
      v8 = [accessories countByEnumeratingWithState:&v108 objects:v120 count:16];
      if (v8)
      {
        v9 = v8;
        v103 = i;
        v10 = *v109;
        while (1)
        {
          for (j = 0; j != v9; ++j)
          {
            if (*v109 != v10)
            {
              objc_enumerationMutation(accessories);
            }

            v12 = *(*(&v108 + 1) + 8 * j);
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v13 = v12;
            }

            else
            {
              v13 = 0;
            }

            v14 = v13;

            if (v14)
            {
              v15 = v12;
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v16 = v15;
              }

              else
              {
                v16 = 0;
              }

              v17 = v16;

              if ([v17 isHomePod])
              {
                homePodVariant = [v17 homePodVariant];
                if (homePodVariant > 1)
                {
                  if (homePodVariant == 2)
                  {
                    LOBYTE(v104) = 1;
                    goto LABEL_31;
                  }

                  if (homePodVariant != 3)
                  {
                    goto LABEL_31;
                  }
                }

                else if (homePodVariant)
                {
                  if (homePodVariant == 1)
                  {
                    v19 = 1;
                  }

                  else
                  {
                    v19 = v106;
                  }

                  LODWORD(v106) = v19;
LABEL_31:
                  if ([v17 requiresHomeAppForManagement])
                  {
                    HIDWORD(v106) |= [v105 isOwnerUser];
                  }

                  LOBYTE(v107) = 1;
LABEL_34:

                  goto LABEL_35;
                }

                BYTE4(v104) = 1;
                goto LABEL_31;
              }

              HIDWORD(v107) |= [v17 isAppleTV];
              goto LABEL_34;
            }

LABEL_35:
            v20 = v12;
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v21 = v20;
            }

            else
            {
              v21 = 0;
            }

            v22 = v21;

            hasTelevisionService = [v22 hasTelevisionService];
            v3 |= hasTelevisionService;
          }

          v9 = [accessories countByEnumeratingWithState:&v108 objects:v120 count:16];
          if (!v9)
          {
            v4 = 1;
            i = v103;
            break;
          }
        }
      }
    }

    v102 = [obj countByEnumeratingWithState:&v112 objects:v121 count:16];
  }

  while (v102);
LABEL_46:

  v24 = v107 ^ HMHomeManagerAreAnySpeakersConfigured();
  if (v24)
  {
    v25 = objc_autoreleasePoolPush();
    v26 = selfCopy;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      v29 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v28;
      v118 = 2112;
      v119 = v29;
      _os_log_impl(&dword_229538000, v27, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for speakers configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v30 = MEMORY[0x277CBED10];
    if (v107)
    {
      v30 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v26 _setHomeConfigurationKey:*MEMORY[0x277CD26C0] value:*v30];
    v31 = objc_autoreleasePoolPush();
    v32 = v26;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v34;
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_DEFAULT, "%{public}@Posting speakers configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v31);
    darwinNotificationProvider = [(HMDHomeManager *)v32 darwinNotificationProvider];
    [darwinNotificationProvider notifyPost:*MEMORY[0x277CD0390]];
  }

  if ((v104 & 1) != areAnyHomePodMiniConfigured())
  {
    v36 = objc_autoreleasePoolPush();
    v37 = selfCopy;
    v38 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
    {
      v39 = HMFGetLogIdentifier();
      v40 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v39;
      v118 = 2112;
      v119 = v40;
      _os_log_impl(&dword_229538000, v38, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for HomePod Mini configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v36);
    v41 = MEMORY[0x277CBED10];
    if (v104)
    {
      v41 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v37 _setHomeConfigurationKey:*MEMORY[0x277CD04C8] value:*v41];
    v42 = objc_autoreleasePoolPush();
    v43 = v37;
    v44 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
    {
      v45 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v45;
      _os_log_impl(&dword_229538000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Posting HomePod Mini configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v42);
    darwinNotificationProvider2 = [(HMDHomeManager *)v43 darwinNotificationProvider];
    [darwinNotificationProvider2 notifyPost:*MEMORY[0x277CD0238]];

    v24 = 1;
  }

  if ((BYTE4(v104) & 1) != areAnyLargeHomePodConfigured())
  {
    v47 = objc_autoreleasePoolPush();
    v48 = selfCopy;
    v49 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_INFO))
    {
      v50 = HMFGetLogIdentifier();
      v51 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v50;
      v118 = 2112;
      v119 = v51;
      _os_log_impl(&dword_229538000, v49, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for 2nd Gen HomePods configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v47);
    v52 = MEMORY[0x277CBED10];
    if ((v104 & 0x100000000) != 0)
    {
      v52 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v48 _setHomeConfigurationKey:*MEMORY[0x277CD0760] value:*v52];
    v53 = objc_autoreleasePoolPush();
    v54 = v48;
    v55 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      v56 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v56;
      _os_log_impl(&dword_229538000, v55, OS_LOG_TYPE_DEFAULT, "%{public}@Posting 2nd Gen HomePods configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v53);
    darwinNotificationProvider3 = [(HMDHomeManager *)v54 darwinNotificationProvider];
    [darwinNotificationProvider3 notifyPost:*MEMORY[0x277CD0280]];

    v24 = 1;
  }

  if ((v106 & 1) != areAnyHomePodsConfigured())
  {
    v58 = objc_autoreleasePoolPush();
    v59 = selfCopy;
    v60 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_INFO))
    {
      v61 = HMFGetLogIdentifier();
      v62 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v61;
      v118 = 2112;
      v119 = v62;
      _os_log_impl(&dword_229538000, v60, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for HomePods configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v58);
    v63 = MEMORY[0x277CBED10];
    if (v106)
    {
      v63 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v59 _setHomeConfigurationKey:*MEMORY[0x277CD04D8] value:*v63];
    v64 = objc_autoreleasePoolPush();
    v65 = v59;
    v66 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
    {
      v67 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v67;
      _os_log_impl(&dword_229538000, v66, OS_LOG_TYPE_DEFAULT, "%{public}@Posting HomePods present configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v64);
    darwinNotificationProvider4 = [(HMDHomeManager *)v65 darwinNotificationProvider];
    [darwinNotificationProvider4 notifyPost:*MEMORY[0x277CD0240]];

    v24 = 1;
  }

  [(HMDHomeManager *)selfCopy setHomePodsPresent:v107 & 1 inOwnedHomes:BYTE4(v106) & 1];
  if ((v3 & 1) != HMHomeManagerAreAnyTelevisionAccessoriesConfigured())
  {
    v69 = objc_autoreleasePoolPush();
    v70 = selfCopy;
    v71 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v71, OS_LOG_TYPE_INFO))
    {
      v72 = HMFGetLogIdentifier();
      v73 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v72;
      v118 = 2112;
      v119 = v73;
      _os_log_impl(&dword_229538000, v71, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for televisions configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v69);
    v74 = MEMORY[0x277CBED10];
    if (v3)
    {
      v74 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v70 _setHomeConfigurationKey:*MEMORY[0x277CD1228] value:*v74];
    if (v3)
    {
      v75 = objc_autoreleasePoolPush();
      v76 = v70;
      v77 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
      {
        v78 = HMFGetLogIdentifier();
        *buf = 138543362;
        v117 = v78;
        _os_log_impl(&dword_229538000, v77, OS_LOG_TYPE_DEFAULT, "%{public}@Posting Television accessories added notification", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v75);
      darwinNotificationProvider5 = [(HMDHomeManager *)v76 darwinNotificationProvider];
      [darwinNotificationProvider5 notifyPost:*MEMORY[0x277CD03A8]];
    }

    v24 = 1;
  }

  if ((BYTE4(v107) & 1) != HMHomeManagerAreAnyAppleTVAccessoriesConfigured())
  {
    v80 = objc_autoreleasePoolPush();
    v81 = selfCopy;
    v82 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v82, OS_LOG_TYPE_INFO))
    {
      v83 = HMFGetLogIdentifier();
      v84 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v83;
      v118 = 2112;
      v119 = v84;
      _os_log_impl(&dword_229538000, v82, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for Apple TV accessories configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v80);
    v85 = MEMORY[0x277CBED10];
    if ((v107 & 0x100000000) != 0)
    {
      v85 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v81 _setHomeConfigurationKey:*MEMORY[0x277CCF248] value:*v85];
    if ((v107 & 0x100000000) != 0)
    {
      v86 = objc_autoreleasePoolPush();
      v87 = v81;
      v88 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
      {
        v89 = HMFGetLogIdentifier();
        *buf = 138543362;
        v117 = v89;
        _os_log_impl(&dword_229538000, v88, OS_LOG_TYPE_DEFAULT, "%{public}@Posting Apple TV accessories added notification", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v86);
      darwinNotificationProvider6 = [(HMDHomeManager *)v87 darwinNotificationProvider];
      [darwinNotificationProvider6 notifyPost:*MEMORY[0x277CD0080]];
    }

    v24 = 1;
  }

  if ((v4 & 1) != HMHomeManagerAreAnyAccessoriesConfigured())
  {
    v91 = objc_autoreleasePoolPush();
    v92 = selfCopy;
    v93 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v93, OS_LOG_TYPE_INFO))
    {
      v94 = HMFGetLogIdentifier();
      v95 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v94;
      v118 = 2112;
      v119 = v95;
      _os_log_impl(&dword_229538000, v93, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for accessories configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v91);
    v96 = MEMORY[0x277CBED10];
    if (v4)
    {
      v96 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v92 _setHomeConfigurationKey:*MEMORY[0x277CD1F80] value:*v96];
    v24 = 1;
  }

LABEL_104:
  v97 = *MEMORY[0x277D85DE8];
  return v24 & 1;
}

- (void)_updatePreferencesAndPostNotificationIfNecessary
{
  if ([(HMDHomeManager *)self _updateAccessoriesConfigured])
  {

    [(HMDHomeManager *)self _postPreferencesChangedNotification];
  }
}

- (void)_postPreferencesChangedNotification
{
  v10 = *MEMORY[0x277D85DE8];
  if (self)
  {
    v2 = objc_autoreleasePoolPush();
    selfCopy = self;
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = HMFGetLogIdentifier();
      v8 = 138543362;
      v9 = v5;
      _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Posting preferences changed notification", &v8, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    darwinNotificationProvider = [selfCopy darwinNotificationProvider];
    [darwinNotificationProvider notifyPost:*MEMORY[0x277CD02E8]];
  }

  v7 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager_setHomePodsPresent_inOwnedHomes___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = v6;
  if (v3)
  {
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v9 = *(a1 + 40);
      v10 = IXStringForAppRemovability();
      v17 = 138543874;
      v18 = v8;
      v19 = 2112;
      v20 = v10;
      v21 = 2112;
      v22 = v3;
      v11 = "%{public}@Failed to set Home app removability to %@: %@";
      v12 = v7;
      v13 = OS_LOG_TYPE_ERROR;
      v14 = 32;
LABEL_6:
      _os_log_impl(&dword_229538000, v12, v13, v11, &v17, v14);
    }
  }

  else if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v15 = *(a1 + 40);
    v10 = IXStringForAppRemovability();
    v17 = 138543618;
    v18 = v8;
    v19 = 2112;
    v20 = v10;
    v11 = "%{public}@Successfully set Home app removability to %@";
    v12 = v7;
    v13 = OS_LOG_TYPE_INFO;
    v14 = 22;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v4);
  v16 = *MEMORY[0x277D85DE8];
}

- (void)updateHomeKitInUsePreferences
{
  v23 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasLoadedData])
  {
    _updateIncomingInvitesPresent = [(HMDHomeManager *)self _updateIncomingInvitesPresent];
    _updatePreferencesForConfiguredHomes = [(HMDHomeManager *)self _updatePreferencesForConfiguredHomes];
    _updatePreferencesForCurrentHome = [(HMDHomeManager *)self _updatePreferencesForCurrentHome];
    _updateAccessoriesConfigured = [(HMDHomeManager *)self _updateAccessoriesConfigured];
    v7 = _updateAccessoriesConfigured;
    if (_updateIncomingInvitesPresent || _updatePreferencesForConfiguredHomes || _updatePreferencesForCurrentHome || _updateAccessoriesConfigured)
    {
      v8 = objc_autoreleasePoolPush();
      selfCopy = self;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        v13 = 138544386;
        v14 = v11;
        v15 = 1024;
        v16 = _updateIncomingInvitesPresent;
        v17 = 1024;
        v18 = _updatePreferencesForConfiguredHomes;
        v19 = 1024;
        v20 = _updatePreferencesForCurrentHome;
        v21 = 1024;
        v22 = v7;
        _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Posting preferences changed notification due to change in incomingInvites: %{BOOL}d homes: %{BOOL}d}, currentHome: %{BOOL}d, accessoriesConfigured: %{BOOL}d", &v13, 0x24u);
      }

      objc_autoreleasePoolPop(v8);
      [(HMDHomeManager *)selfCopy _postPreferencesChangedNotification];
    }
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (BOOL)_updateIncomingInvitesPresent
{
  hasLoadedData = [(HMDHomeManager *)self hasLoadedData];
  if (hasLoadedData)
  {
    v4 = areIncomingInvitesPresent();
    incomingInvitations = [(HMDHomeManager *)self incomingInvitations];
    v6 = [incomingInvitations count];

    v7 = +[HMDBulletinBoard sharedBulletinBoard];
    [v7 refreshHomeBadgeNumber];

    if (v4 == (v6 != 0))
    {
      LOBYTE(hasLoadedData) = 0;
    }

    else
    {
      v8 = MEMORY[0x277CBED10];
      if (v6)
      {
        v8 = MEMORY[0x277CBED28];
      }

      [(HMDHomeManager *)self _setHomeConfigurationKey:*MEMORY[0x277CD23E0] value:*v8];
      LOBYTE(hasLoadedData) = 1;
    }
  }

  return hasLoadedData;
}

- (BOOL)_updatePreferencesForCurrentHome
{
  v27 = *MEMORY[0x277D85DE8];
  hasLoadedData = [(HMDHomeManager *)self hasLoadedData];
  if (hasLoadedData)
  {
    v5 = objc_alloc(MEMORY[0x277D0F770]);
    v6 = MEMORY[0x277CCACA8];
    v7 = MEMORY[0x22AAD2510](self, a2);
    8310 = [v6 stringWithFormat:@"%@, %s:%ld", v7, "/Library/Caches/com.apple.xbs/Sources/HomeKit_executables/Sources/homed/HomeManager/HMDHomeManager.m", 8310];
    currentActivity = [MEMORY[0x277D0F770] currentActivity];
    v22 = [v5 initWithName:8310 parent:currentActivity];

    currentHomeUUID = [(HMDHomeManager *)self currentHomeUUID];
    if (currentHomeUUID)
    {
      currentHomeUUID2 = [(HMDHomeManager *)self currentHomeUUID];
      v12 = spiClientIdentifierForUUID(currentHomeUUID2);
    }

    else
    {
      v12 = 0;
    }

    v13 = HMHomeManagerCurrentHomeSPIClientIdentifier();
    v14 = HMFEqualObjects();
    if ((v14 & 1) == 0)
    {
      v15 = objc_autoreleasePoolPush();
      selfCopy = self;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543618;
        v24 = v18;
        v25 = 2112;
        v26 = v12;
        _os_log_impl(&dword_229538000, v17, OS_LOG_TYPE_INFO, "%{public}@Setting the preference for current home SPI client identifier: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v15);
      uUIDString = [v12 UUIDString];
      [(HMDHomeManager *)selfCopy _setHomeConfigurationKey:*MEMORY[0x277CCFC40] value:uUIDString];
    }

    __HMFActivityScopeLeave();
    LOBYTE(hasLoadedData) = v14 ^ 1;
  }

  v20 = *MEMORY[0x277D85DE8];
  return hasLoadedData;
}

- (BOOL)_updatePreferencesForConfiguredHomes
{
  v39 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasLoadedData])
  {
    v4 = objc_alloc(MEMORY[0x277D0F770]);
    v5 = MEMORY[0x277CCACA8];
    v6 = MEMORY[0x22AAD2510](self, a2);
    8270 = [v5 stringWithFormat:@"%@, %s:%ld", v6, "/Library/Caches/com.apple.xbs/Sources/HomeKit_executables/Sources/homed/HomeManager/HMDHomeManager.m", 8270];
    currentActivity = [MEMORY[0x277D0F770] currentActivity];
    v34 = [v4 initWithName:8270 parent:currentActivity];

    homes = [(HMDHomeManager *)self homes];
    v10 = [homes count];

    v11 = HMHomeManagerConfiguredHomesCount();
    v12 = v10 != v11;
    if (v10 != v11)
    {
      v13 = objc_autoreleasePoolPush();
      selfCopy = self;
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543618;
        v36 = v16;
        v37 = 2048;
        v38 = v10;
        _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for configured homes count: %lu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v13);
      v17 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v10];
      [(HMDHomeManager *)selfCopy _setHomeConfigurationKey:*MEMORY[0x277CCFC38] value:v17];
      v18 = v10 > v11;
      v19 = objc_autoreleasePoolPush();
      v20 = selfCopy;
      if (v18)
      {
        v21 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          v22 = HMFGetLogIdentifier();
          *buf = 138543362;
          v36 = v22;
          _os_log_impl(&dword_229538000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Posting configured home added notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        darwinNotificationProvider = [(HMDHomeManager *)v20 darwinNotificationProvider];
        [darwinNotificationProvider notifyPost:*MEMORY[0x277CD00B8]];
      }

      else
      {
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v36 = v25;
          _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_DEFAULT, "%{public}@Posting configured home removed notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        darwinNotificationProvider = [(HMDHomeManager *)v20 darwinNotificationProvider];
        [darwinNotificationProvider notifyPost:*MEMORY[0x277CD00C0]];
      }
    }

    if ((v10 != 0) != areHomesConfigured())
    {
      v26 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v28 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
      {
        v29 = HMFGetLogIdentifier();
        v30 = HMFBooleanToString();
        *buf = 138543618;
        v36 = v29;
        v37 = 2112;
        v38 = v30;
        _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for are homes configured: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v26);
      v31 = MEMORY[0x277CBED10];
      if (v10)
      {
        v31 = MEMORY[0x277CBED28];
      }

      [(HMDHomeManager *)selfCopy2 _setHomeConfigurationKey:*MEMORY[0x277CCF250] value:*v31];
      v12 = 1;
    }

    __HMFActivityScopeLeave();
  }

  else
  {
    v12 = 0;
  }

  v32 = *MEMORY[0x277D85DE8];
  return v12;
}

- (id)replaceName:(id)name withNewName:(id)newName inNamespaces:(id)namespaces
{
  namespacesCopy = namespaces;
  newNameCopy = newName;
  nameCopy = name;
  nameValidator = [(HMDHomeManager *)self nameValidator];
  v12 = [nameValidator replaceName:nameCopy withNewName:newNameCopy inNamespaces:namespacesCopy];

  return v12;
}

- (id)removeName:(id)name namespace:(id)namespace
{
  namespaceCopy = namespace;
  nameCopy = name;
  nameValidator = [(HMDHomeManager *)self nameValidator];
  v9 = [nameValidator removeName:nameCopy namespace:namespaceCopy];

  return v9;
}

- (id)addName:(id)name namespace:(id)namespace
{
  namespaceCopy = namespace;
  nameCopy = name;
  nameValidator = [(HMDHomeManager *)self nameValidator];
  v9 = [nameValidator addName:nameCopy namespace:namespaceCopy];

  return v9;
}

- (id)_homeFromEventIdentifier:(id)identifier
{
  v4 = [identifier componentsSeparatedByString:@"/"];
  firstObject = [v4 firstObject];
  v6 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:firstObject];
  v7 = [(HMDHomeManager *)self _homeWithUUID:v6];

  return v7;
}

- (id)_zoneInformationWithUUID:(id)d
{
  dCopy = d;
  cloudZones = [(HMDHomeManager *)self cloudZones];
  v6 = [cloudZones hmf_firstObjectWithUUID:dCopy];

  return v6;
}

- (id)_homeWithZoneID:(id)d
{
  dCopy = d;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes hmf_firstObjectWithZoneID:dCopy];

  return v6;
}

- (id)_homeWithAssistantIdentifier:(id)identifier
{
  identifierCopy = identifier;
  if (identifierCopy)
  {
    homes = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __47__HMDHomeManager__homeWithAssistantIdentifier___block_invoke;
    v8[3] = &unk_278685B20;
    v9 = identifierCopy;
    v6 = [homes hmf_objectPassingTest:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

uint64_t __47__HMDHomeManager__homeWithAssistantIdentifier___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 urlString];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homeWithUniqueIdentifier:(id)identifier forClientIdentifierSalt:(id)salt
{
  identifierCopy = identifier;
  saltCopy = salt;
  homes = [(HMDHomeManager *)self homes];
  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __68__HMDHomeManager__homeWithUniqueIdentifier_forClientIdentifierSalt___block_invoke;
  v13[3] = &unk_278685B48;
  v14 = saltCopy;
  v15 = identifierCopy;
  v9 = identifierCopy;
  v10 = saltCopy;
  v11 = [homes na_firstObjectPassingTest:v13];

  return v11;
}

uint64_t __68__HMDHomeManager__homeWithUniqueIdentifier_forClientIdentifierSalt___block_invoke(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCAD78];
  v4 = [a2 uuid];
  v5 = [v3 hm_deriveUUIDFromBaseUUID:v4 identifierSalt:*(a1 + 32)];

  v6 = [v5 isEqual:*(a1 + 40)];
  return v6;
}

- (id)_homeWithUUID:(id)d
{
  dCopy = d;
  if (dCopy)
  {
    homes = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __32__HMDHomeManager__homeWithUUID___block_invoke;
    v8[3] = &unk_278685B20;
    v9 = dCopy;
    v6 = [homes hmf_objectPassingTest:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

uint64_t __32__HMDHomeManager__homeWithUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homesWithName:(id)name
{
  nameCopy = name;
  homes = [(HMDHomeManager *)self homes];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __33__HMDHomeManager__homesWithName___block_invoke;
  v9[3] = &unk_278685B20;
  v10 = nameCopy;
  v6 = nameCopy;
  v7 = [homes hmf_objectsPassingTest:v9];

  return v7;
}

uint64_t __33__HMDHomeManager__homesWithName___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 name];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homeWithName:(id)name
{
  nameCopy = name;
  homes = [(HMDHomeManager *)self homes];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __32__HMDHomeManager__homeWithName___block_invoke;
  v9[3] = &unk_278685B20;
  v10 = nameCopy;
  v6 = nameCopy;
  v7 = [homes hmf_objectPassingTest:v9];

  return v7;
}

uint64_t __32__HMDHomeManager__homeWithName___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 name];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (BOOL)checkConflictInHomeNamespaceWithName:(id)name options:(unint64_t)options namespaceUUID:(id)d error:(id *)error
{
  optionsCopy = options;
  v34 = *MEMORY[0x277D85DE8];
  nameCopy = name;
  dCopy = d;
  v12 = objc_alloc_init(MEMORY[0x277CBEB18]);
  if ((optionsCopy & 0xD) != 0)
  {
    if (optionsCopy)
    {
      nameValidator = [(HMDHomeManager *)self nameValidator];
      v14 = [nameValidator validateName:nameCopy];

      if (v14)
      {
        if (error)
        {
          v15 = v14;
          *error = v14;
        }

        goto LABEL_30;
      }
    }

    if (dCopy)
    {
      [v12 addObject:dCopy];
      if ((optionsCopy & 4) == 0)
      {
        goto LABEL_25;
      }
    }

    else if ((optionsCopy & 2) != 0)
    {
      v28 = nameCopy;
      v31 = 0u;
      v32 = 0u;
      v29 = 0u;
      v30 = 0u;
      homes = [(HMDHomeManager *)self homes];
      v19 = [homes countByEnumeratingWithState:&v29 objects:v33 count:16];
      if (v19)
      {
        v20 = v19;
        v21 = *v30;
        do
        {
          for (i = 0; i != v20; ++i)
          {
            if (*v30 != v21)
            {
              objc_enumerationMutation(homes);
            }

            uuid = [*(*(&v29 + 1) + 8 * i) uuid];
            [v12 addObject:uuid];
          }

          v20 = [homes countByEnumeratingWithState:&v29 objects:v33 count:16];
        }

        while (v20);
      }

      nameCopy = v28;
      if ((optionsCopy & 4) == 0)
      {
        goto LABEL_25;
      }

      uuid2 = [(HMDHomeManager *)self uuid];
      [v12 addObject:uuid2];
    }

    else
    {
      uuid3 = [(HMDHomeManager *)self uuid];
      [v12 addObject:uuid3];

      if ((optionsCopy & 4) == 0)
      {
        goto LABEL_25;
      }
    }

    v25 = [(HMDHomeManager *)self _checkNameConflict:nameCopy withNamespaceUUIDs:v12];
    if (v25)
    {
LABEL_27:
      if (error)
      {
        v25 = v25;
        *error = v25;
      }

      goto LABEL_30;
    }

LABEL_25:
    if ((optionsCopy & 8) == 0 || ([(HMDHomeManager *)self _checkActionSetNameConflict:nameCopy withNamespaceUUIDs:v12], (v25 = objc_claimAutoreleasedReturnValue()) == 0))
    {
      v16 = 1;
      goto LABEL_32;
    }

    goto LABEL_27;
  }

  if (!error)
  {
LABEL_30:
    v16 = 0;
    goto LABEL_32;
  }

  [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  *error = v16 = 0;
LABEL_32:

  v26 = *MEMORY[0x277D85DE8];
  return v16;
}

- (void)_handleQueryHomeNamespace:(id)namespace
{
  v40 = *MEMORY[0x277D85DE8];
  namespaceCopy = namespace;
  v5 = [namespaceCopy stringForKey:*MEMORY[0x277CD0308]];
  if (!v5)
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      messagePayload = [namespaceCopy messagePayload];
      *buf = 138543618;
      v35 = v16;
      v36 = 2112;
      v37 = messagePayload;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@No name found in query home namespace message payload: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 20;
    goto LABEL_9;
  }

  v6 = HMMaxLengthForNaming();
  if ([v5 length] > v6)
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_ERROR, "%{public}@New name is longer than the pre-defined max length", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 46;
LABEL_9:
    v18 = [v11 hmErrorWithCode:v12];
    [namespaceCopy respondWithError:v18];
    goto LABEL_18;
  }

  v19 = [namespaceCopy numberForKey:*MEMORY[0x277CD02B8]];
  unsignedIntegerValue = [v19 unsignedIntegerValue];

  v18 = [namespaceCopy uuidForKey:*MEMORY[0x277CD0640]];
  v21 = objc_autoreleasePoolPush();
  selfCopy3 = self;
  v23 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
  {
    v24 = HMFGetLogIdentifier();
    v25 = HMHomeManagerNameValidationOptionsToString();
    *buf = 138543874;
    v35 = v24;
    v36 = 2112;
    v37 = v18;
    v38 = 2112;
    v39 = v25;
    _os_log_impl(&dword_229538000, v23, OS_LOG_TYPE_INFO, "%{public}@Validating name for home UUID %@ with options: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v21);
  v33 = 0;
  v26 = [(HMDHomeManager *)selfCopy3 checkConflictInHomeNamespaceWithName:v5 options:unsignedIntegerValue namespaceUUID:v18 error:&v33];
  v27 = v33;
  if (v26)
  {
    [namespaceCopy respondWithSuccess];
  }

  else
  {
    v28 = objc_autoreleasePoolPush();
    v29 = selfCopy3;
    v30 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v31;
      v36 = 2112;
      v37 = v27;
      _os_log_impl(&dword_229538000, v30, OS_LOG_TYPE_ERROR, "%{public}@Name validation failed: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v28);
    [namespaceCopy respondWithError:v27];
  }

LABEL_18:
  v32 = *MEMORY[0x277D85DE8];
}

- (void)_stopTrackingRemovedHomeUserMergeId:(id)id
{
  v14 = *MEMORY[0x277D85DE8];
  idCopy = id;
  os_unfair_lock_lock_with_options();
  if (idCopy && [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:idCopy])
  {
    [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes removeObject:idCopy];
    v5 = objc_autoreleasePoolPush();
    selfCopy = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = idCopy;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Removing user with mergeID %@ from list of mergeIDs of homes removed locally", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  os_unfair_lock_unlock(&self->_lock);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_trackRemovedHomeUserMergeId:(id)id
{
  v14 = *MEMORY[0x277D85DE8];
  idCopy = id;
  os_unfair_lock_lock_with_options();
  if (idCopy && ([(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:idCopy]& 1) == 0)
  {
    [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes addObject:idCopy];
    v5 = objc_autoreleasePoolPush();
    selfCopy = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = idCopy;
      _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Adding user with mergeID %@ to mergeID of homes removed locally", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  os_unfair_lock_unlock(&self->_lock);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)removeHome:(id)home
{
  homeCopy = home;
  os_unfair_lock_lock_with_options();
  [(NSMutableArray *)self->_homes removeObject:homeCopy];
  os_unfair_lock_unlock(&self->_lock);
}

- (void)addHome:(id)home
{
  homeCopy = home;
  os_unfair_lock_lock_with_options();
  [(NSMutableArray *)self->_homes addObject:homeCopy];
  os_unfair_lock_unlock(&self->_lock);
}

- (void)setHomes:(id)homes
{
  homesCopy = homes;
  os_unfair_lock_lock_with_options();
  v4 = [homesCopy mutableCopy];
  homes = self->_homes;
  self->_homes = v4;

  os_unfair_lock_unlock(&self->_lock);
}

- (void)setCurrentHomeUUID:(id)d
{
  dCopy = d;
  os_unfair_lock_lock_with_options();
  overrideCurrentHomeUUIDToNil = self->_overrideCurrentHomeUUIDToNil;
  currentHomeUUIDOverride = dCopy;
  if (overrideCurrentHomeUUIDToNil)
  {
    if (([(HMFBoolean *)overrideCurrentHomeUUIDToNil BOOLValue]& 1) != 0)
    {
      currentHomeUUIDOverride = 0;
    }

    else
    {
      currentHomeUUIDOverride = self->_currentHomeUUIDOverride;
    }
  }

  objc_storeStrong(&self->_currentHomeUUID, currentHomeUUIDOverride);
  os_unfair_lock_unlock(&self->_lock);
}

- (NSUUID)currentHomeUUID
{
  os_unfair_lock_lock_with_options();
  v3 = self->_currentHomeUUID;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)setOverrideCurrentHomeUUIDToNil:(id)nil
{
  nilCopy = nil;
  os_unfair_lock_lock_with_options();
  overrideCurrentHomeUUIDToNil = self->_overrideCurrentHomeUUIDToNil;
  self->_overrideCurrentHomeUUIDToNil = nilCopy;

  os_unfair_lock_unlock(&self->_lock);
}

- (HMFBoolean)overrideCurrentHomeUUIDToNil
{
  os_unfair_lock_lock_with_options();
  v3 = self->_overrideCurrentHomeUUIDToNil;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)setCurrentHomeUUIDOverride:(id)override
{
  overrideCopy = override;
  os_unfair_lock_lock_with_options();
  currentHomeUUIDOverride = self->_currentHomeUUIDOverride;
  self->_currentHomeUUIDOverride = overrideCopy;

  os_unfair_lock_unlock(&self->_lock);
}

- (NSUUID)currentHomeUUIDOverride
{
  os_unfair_lock_lock_with_options();
  v3 = self->_currentHomeUUIDOverride;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)sendUnsecureMessage:(id)message target:(id)target userID:(id)d responseQueue:(id)queue responseHandler:(id)handler
{
  v38 = *MEMORY[0x277D85DE8];
  messageCopy = message;
  targetCopy = target;
  dCopy = d;
  queueCopy = queue;
  handlerCopy = handler;
  v17 = [HMDMessageDispatcher destinationWithTarget:targetCopy userID:dCopy destination:0 multicast:1];
  if (v17)
  {
    [messageCopy setDestination:v17];
    responseHandler = [messageCopy responseHandler];

    if (handlerCopy && !responseHandler)
    {
      v27[0] = MEMORY[0x277D85DD0];
      v27[1] = 3221225472;
      v27[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_2;
      v27[3] = &unk_278685AF8;
      v28 = queueCopy;
      v29 = handlerCopy;
      [messageCopy setResponseHandler:v27];
    }

    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    [messageDispatcher sendMessage:messageCopy completionHandler:0];
    goto LABEL_11;
  }

  v20 = objc_autoreleasePoolPush();
  selfCopy = self;
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = HMFGetLogIdentifier();
    [messageCopy shortDescription];
    v24 = v26 = v20;
    *buf = 138543874;
    v33 = v23;
    v34 = 2112;
    v35 = v24;
    v36 = 2112;
    v37 = dCopy;
    _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot send unsecure message %@: could not create message destination for userID: %@", buf, 0x20u);

    v20 = v26;
  }

  objc_autoreleasePoolPop(v20);
  if (queueCopy && handlerCopy)
  {
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke;
    block[3] = &unk_278688B80;
    v31 = handlerCopy;
    dispatch_async(queueCopy, block);
    messageDispatcher = v31;
LABEL_11:
  }

  v25 = *MEMORY[0x277D85DE8];
}

void __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke(uint64_t a1)
{
  v1 = *(a1 + 32);
  v2 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  (*(v1 + 16))(v1, v2, 0);
}

void __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = *(a1 + 32);
  if (v7)
  {
    v8 = *(a1 + 40);
    if (v8)
    {
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_3;
      block[3] = &unk_278689F98;
      v12 = v8;
      v10 = v5;
      v11 = v6;
      dispatch_async(v7, block);
    }
  }
}

- (void)sendSecureMessage:(id)message target:(id)target userID:(id)d destination:(id)destination responseQueue:(id)queue responseHandler:(id)handler
{
  handlerCopy = handler;
  queueCopy = queue;
  destinationCopy = destination;
  dCopy = d;
  targetCopy = target;
  messageCopy = message;
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  [messageDispatcher sendSecureMessage:messageCopy target:targetCopy userID:dCopy destination:destinationCopy responseQueue:queueCopy responseHandler:handlerCopy];
}

- (void)electDeviceForUser:(id)user destination:(id)destination deviceCapabilities:(id)capabilities responseTimeout:(double)timeout queue:(id)queue completionHandler:(id)handler
{
  handlerCopy = handler;
  queueCopy = queue;
  capabilitiesCopy = capabilities;
  destinationCopy = destination;
  userCopy = user;
  userDeviceCapabilitiesRequestManager = [(HMDHomeManager *)self userDeviceCapabilitiesRequestManager];
  [userDeviceCapabilitiesRequestManager electDeviceForUserID:userCopy destination:destinationCopy deviceCapabilities:capabilitiesCopy responseTimeout:queueCopy responseQueue:handlerCopy completionHandler:timeout];
}

- (void)electDeviceForHH1User:(id)user destination:(id)destination deviceCapabilities:(id)capabilities queue:(id)queue completionHandler:(id)handler
{
  handlerCopy = handler;
  queueCopy = queue;
  capabilitiesCopy = capabilities;
  destinationCopy = destination;
  userCopy = user;
  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  [messageDispatcher electDeviceForHH1User:userCopy destination:destinationCopy deviceCapabilities:capabilitiesCopy responseTimeout:queueCopy responseQueue:handlerCopy responseHandler:0.0];
}

- (void)sendUserRemoved:(id)removed fromHome:(id)home pairingUsername:(id)username pushToCloud:(BOOL)cloud completionHandler:(id)handler
{
  removedCopy = removed;
  homeCopy = home;
  usernameCopy = username;
  handlerCopy = handler;
  objc_initWeak(&location, self);
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __89__HMDHomeManager_sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke;
  block[3] = &unk_278685AD0;
  objc_copyWeak(&v26, &location);
  v22 = removedCopy;
  v23 = homeCopy;
  cloudCopy = cloud;
  v24 = usernameCopy;
  v25 = handlerCopy;
  v17 = handlerCopy;
  v18 = usernameCopy;
  v19 = homeCopy;
  v20 = removedCopy;
  dispatch_async(workQueue, block);

  objc_destroyWeak(&v26);
  objc_destroyWeak(&location);
}

void __89__HMDHomeManager_sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  [WeakRetained _sendUserRemoved:*(a1 + 32) fromHome:*(a1 + 40) pairingUsername:*(a1 + 48) pushToCloud:*(a1 + 72) completionHandler:*(a1 + 56)];
}

- (void)sendUserAdded:(id)added destination:(id)destination toHome:(id)home
{
  addedCopy = added;
  destinationCopy = destination;
  homeCopy = home;
  objc_initWeak(&location, self);
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_sendUserAdded_destination_toHome___block_invoke;
  block[3] = &unk_278687568;
  objc_copyWeak(&v19, &location);
  v16 = addedCopy;
  v17 = destinationCopy;
  v18 = homeCopy;
  v12 = homeCopy;
  v13 = destinationCopy;
  v14 = addedCopy;
  dispatch_async(workQueue, block);

  objc_destroyWeak(&v19);
  objc_destroyWeak(&location);
}

void __51__HMDHomeManager_sendUserAdded_destination_toHome___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  [WeakRetained _sendUserAdded:*(a1 + 32) destination:*(a1 + 40) toHome:*(a1 + 48)];
}

- (void)notifyClientsOfUserSettingsChangeWithReason:(id)reason sourceUUID:(id)d
{
  v6 = MEMORY[0x277CCAB98];
  dCopy = d;
  reasonCopy = reason;
  defaultCenter = [v6 defaultCenter];
  [defaultCenter postNotificationName:@"HMDUserSettingsUpdatedNotificationKey" object:0];

  [(HMDHomeManager *)self updateGenerationCounterWithReason:reasonCopy sourceUUID:dCopy shouldNotifyClients:1];
}

- (void)_notifyXPCClientsOfHomeConfigurationChange
{
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  [(HMDHomeManager *)self _updatePreferencesAndPostNotificationIfNecessary];
  if ([(HMDHomeManager *)self _shouldNotifyClientsAboutGenerationCounterUpdate])
  {
    v4 = MEMORY[0x277D0F818];
    messageDestination = [(HMDHomeManager *)self messageDestination];
    v9 = [v4 messageWithName:@"kHomesDidUpdateNotificationKey" qualityOfService:9 destination:messageDestination payload:0];

    messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
    [messageDispatcher sendMessage:v9];

    logEventSubmitter = [(HMDHomeManager *)self logEventSubmitter];
    v8 = objc_alloc_init(HMDNotifyXPCClientsOfHomeConfigurationChangeLogEvent);
    [logEventSubmitter submitLogEvent:v8];

    [(HMDHomeManager *)self _notifyMetricsManagerOfConfigurationChange];
    logAndPostNotification(@"HMDHomeManagerNotifiedXPCClientsOfHomeConfigurationChangeNotification", self, 0);
  }
}

- (void)_updateGenerationCounterWithReason:(id)reason sourceUUID:(id)d shouldNotifyClients:(BOOL)clients
{
  clientsCopy = clients;
  v36 = *MEMORY[0x277D85DE8];
  reasonCopy = reason;
  dCopy = d;
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  v11 = objc_autoreleasePoolPush();
  selfCopy = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v26 = 138544386;
    v27 = v14;
    v28 = 2048;
    v29 = [(HMDHomeManager *)selfCopy generationCounter]+ 1;
    v30 = 1024;
    v31 = clientsCopy;
    v32 = 2114;
    v33 = reasonCopy;
    v34 = 2114;
    v35 = dCopy;
    _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_INFO, "%{public}@Updating generation counter to %llu (shouldNotifyClients is %d): %{public}@-%{public}@", &v26, 0x30u);
  }

  objc_autoreleasePoolPop(v11);
  [(HMDHomeManager *)selfCopy setGenerationCounter:[(HMDHomeManager *)selfCopy generationCounter]+ 1];
  userDefaults = [(HMDHomeManager *)selfCopy userDefaults];
  [userDefaults setInteger:-[HMDHomeManager generationCounter](selfCopy forKey:{"generationCounter"), @"HMDHomeManagerGenerationCounter"}];

  if ([(HMDHomeManager *)selfCopy generationCounterToken]!= -1 && [(HMDHomeManager *)selfCopy _shouldNotifyClientsAboutGenerationCounterUpdate])
  {
    darwinNotificationProvider = [(HMDHomeManager *)selfCopy darwinNotificationProvider];
    [darwinNotificationProvider notifySetState:-[HMDHomeManager generationCounterToken](selfCopy state:{"generationCounterToken"), -[HMDHomeManager generationCounter](selfCopy, "generationCounter")}];

    darwinNotificationProvider2 = [(HMDHomeManager *)selfCopy darwinNotificationProvider];
    [darwinNotificationProvider2 notifyPost:*MEMORY[0x277CD0200]];
  }

  if ([(HMDHomeManager *)selfCopy postSyncDataUpdatedNotification])
  {
    [(HMDHomeManager *)selfCopy setPostSyncDataUpdatedNotification:0];
    v18 = objc_autoreleasePoolPush();
    v19 = selfCopy;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      v26 = 138543362;
      v27 = v21;
      _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Posting sync data updated notification after updating generation counter", &v26, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    notify_post(*MEMORY[0x277CCF2C8]);
  }

  logEventSubmitter = [(HMDHomeManager *)selfCopy logEventSubmitter];
  v23 = objc_alloc_init(HMDIncrementGenerationCounterLogEvent);
  [logEventSubmitter submitLogEvent:v23];

  if (clientsCopy)
  {
    debounceHomesUpdateTimer = [(HMDHomeManager *)selfCopy debounceHomesUpdateTimer];
    [debounceHomesUpdateTimer resume];
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (void)updateGenerationCounterWithReason:(id)reason sourceUUID:(id)d shouldNotifyClients:(BOOL)clients
{
  reasonCopy = reason;
  dCopy = d;
  workQueue = [(HMDHomeManager *)self workQueue];
  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __83__HMDHomeManager_updateGenerationCounterWithReason_sourceUUID_shouldNotifyClients___block_invoke;
  v13[3] = &unk_278685AA8;
  v13[4] = self;
  v14 = reasonCopy;
  v15 = dCopy;
  clientsCopy = clients;
  v11 = dCopy;
  v12 = reasonCopy;
  dispatch_async(workQueue, v13);
}

- (void)setGenerationCounter:(unint64_t)counter
{
  os_unfair_lock_lock_with_options();
  self->_generationCounter = counter;

  os_unfair_lock_unlock(&self->_lock);
}

- (unint64_t)generationCounter
{
  os_unfair_lock_lock_with_options();
  generationCounter = self->_generationCounter;
  os_unfair_lock_unlock(&self->_lock);
  return generationCounter;
}

- (void)setAccessAllowedWhenLocked:(BOOL)locked
{
  os_unfair_lock_lock_with_options();
  self->_accessAllowedWhenLocked = locked;

  os_unfair_lock_unlock(&self->_lock);
}

- (BOOL)isAccessAllowedWhenLocked
{
  os_unfair_lock_lock_with_options();
  accessAllowedWhenLocked = self->_accessAllowedWhenLocked;
  os_unfair_lock_unlock(&self->_lock);
  return accessAllowedWhenLocked;
}

- (BOOL)shouldClearDeviceSetupFollowUp
{
  currentAccessoryUUID = [(HMDHomeManager *)self currentAccessoryUUID];
  if (currentAccessoryUUID)
  {
    v4 = 1;
  }

  else
  {
    lastRemovedCurrentAccessoryUUID = [(HMDHomeManager *)self lastRemovedCurrentAccessoryUUID];
    if (lastRemovedCurrentAccessoryUUID)
    {
      v4 = 1;
    }

    else
    {
      appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
      device = [appleAccountManager device];
      if (device && [(HMDHomeManager *)self deviceAccountHasSettled]&& [(HMDHomeManager *)self firstCloudKitImportComplete]&& [(HMDHomeManager *)self hasManatee])
      {
        appleAccountManager2 = [(HMDHomeManager *)self appleAccountManager];
        accountContext = [appleAccountManager2 accountContext];
        v4 = accountContext == 0;
      }

      else
      {
        v4 = 1;
      }
    }
  }

  return v4;
}

- (void)postFinishSetupForCurrentAccessoryFollowUpIfNeeded
{
  workQueue = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(workQueue);

  if (isAppleTV())
  {
    if (![(HMDHomeManager *)self startupHasCompleted])
    {
      objc_initWeak(&location, self);
      startupCompleted = [(HMDHomeManager *)self startupCompleted];
      v9[0] = MEMORY[0x277D85DD0];
      v9[1] = 3221225472;
      v9[2] = __68__HMDHomeManager_postFinishSetupForCurrentAccessoryFollowUpIfNeeded__block_invoke;
      v9[3] = &unk_278685A80;
      objc_copyWeak(&v10, &location);
      v6 = [startupCompleted then:v9];

      objc_destroyWeak(&v10);
      objc_destroyWeak(&location);
      return;
    }

    if (![(HMDHomeManager *)self initialPCSStatusFetchCompleted])
    {
      return;
    }

    if ([(HMDHomeManager *)self shouldClearDeviceSetupFollowUp])
    {
      v8 = +[HMDDeviceSetupManager sharedManager];
      followUpManager = [v8 followUpManager];
      [followUpManager stopAdvertising:1];
    }

    else
    {
      lastRemovedCurrentAccessoryUUID = [(HMDHomeManager *)self lastRemovedCurrentAccessoryUUID];

      if (lastRemovedCurrentAccessoryUUID)
      {
        return;
      }

      v8 = +[HMDDeviceSetupManager sharedManager];
      followUpManager = [v8 followUpManager];
      [followUpManager startAdvertising:1];
    }
  }
}

uint64_t __68__HMDHomeManager_postFinishSetupForCurrentAccessoryFollowUpIfNeeded__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = WeakRetained;
  if (WeakRetained)
  {
    v3 = [WeakRetained workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __68__HMDHomeManager_postFinishSetupForCurrentAccessoryFollowUpIfNeeded__block_invoke_2;
    block[3] = &unk_27868A728;
    block[4] = v2;
    dispatch_async(v3, block);
  }

  return 1;
}

- (void)dataSyncInProgressUpdatedNotification:(id)notification
{
  notificationCopy = notification;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __56__HMDHomeManager_dataSyncInProgressUpdatedNotification___block_invoke;
  v7[3] = &unk_27868A750;
  v8 = notificationCopy;
  selfCopy = self;
  v6 = notificationCopy;
  dispatch_async(workQueue, v7);
}

uint64_t __56__HMDHomeManager_dataSyncInProgressUpdatedNotification___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 hmf_BOOLForKey:@"HMDHH2FirstCKImportFinished"];

  if (v3)
  {
    [*(a1 + 40) hh2FirstCKImportFinished];
    v4 = [*(a1 + 40) currentAccessorySetupMetricDispatcher];
    [v4 markSetupEndStage:13 error:0];

    v5 = +[HMDUser allLastUserSyncDataArchives];
    if ([v5 count])
    {
      v6 = [[HMDHomeManagerHH2SharedUserLastSyncManager alloc] initWithHomeManager:*(a1 + 40) archivePaths:v5];
      [*(a1 + 40) setSharedUserLastSyncManager:v6];

      v7 = [*(a1 + 40) sharedUserLastSyncManager];
      [v7 configure];
    }

    [*(a1 + 40) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
    [*(a1 + 40) scheduleAddACWGKeysOperationIfAllowed];
  }

  v8 = *(a1 + 40);

  return [v8 _notifyClientsOfUpdatedStatus];
}

- (void)_removePendingDataSyncAcksForUser:(id)user forHome:(id)home
{
  v32 = *MEMORY[0x277D85DE8];
  userCopy = user;
  homeCopy = home;
  uUIDString = [homeCopy UUIDString];
  pendingDataSyncAcks = [(HMDHomeManager *)self pendingDataSyncAcks];
  v10 = [pendingDataSyncAcks objectForKeyedSubscript:uUIDString];

  if (v10)
  {
    [v10 removeObject:userCopy];
    if (![v10 count])
    {
      v11 = shouldLogPrivateInformation();
      v12 = @"...";
      if (v11)
      {
        v12 = userCopy;
      }

      v13 = v12;
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        uUIDString2 = [homeCopy UUIDString];
        v26 = 138543874;
        v27 = v16;
        v28 = 2112;
        v29 = v13;
        v30 = 2112;
        v31 = uUIDString2;
        _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Removing pending data sync ack for user %@ for data corresponding to home %@", &v26, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      pendingDataSyncAcks2 = [(HMDHomeManager *)self pendingDataSyncAcks];
      [pendingDataSyncAcks2 removeObjectForKey:uUIDString];
    }
  }

  v19 = objc_autoreleasePoolPush();
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    pendingDataSyncAcks3 = [(HMDHomeManager *)self pendingDataSyncAcks];
    v26 = 138543618;
    v27 = v21;
    v28 = 2112;
    v29 = pendingDataSyncAcks3;
    _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@Remaining pending data sync acks %@", &v26, 0x16u);
  }

  objc_autoreleasePoolPop(v19);
  pendingDataSyncAcks4 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v24 = [HMDPersistentStore archiveIDSDataSyncJournal:pendingDataSyncAcks4];

  v25 = *MEMORY[0x277D85DE8];
}

- (void)_addPendingDataSyncAcksForUser:(id)user forHome:(id)home
{
  v28 = *MEMORY[0x277D85DE8];
  userCopy = user;
  homeCopy = home;
  v8 = shouldLogPrivateInformation();
  v9 = @"...";
  if (v8)
  {
    v9 = userCopy;
  }

  v10 = v9;
  v11 = objc_autoreleasePoolPush();
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    uUIDString = [homeCopy UUIDString];
    v22 = 138543874;
    v23 = v13;
    v24 = 2112;
    v25 = v10;
    v26 = 2112;
    v27 = uUIDString;
    _os_log_impl(&dword_229538000, v12, OS_LOG_TYPE_INFO, "%{public}@Adding pending data sync ack for user %@ for data corresponding to home %@", &v22, 0x20u);
  }

  objc_autoreleasePoolPop(v11);
  uUIDString2 = [homeCopy UUIDString];
  pendingDataSyncAcks = [(HMDHomeManager *)self pendingDataSyncAcks];
  v17 = [pendingDataSyncAcks objectForKeyedSubscript:uUIDString2];

  if (!v17)
  {
    v17 = [MEMORY[0x277CBEB58] set];
    pendingDataSyncAcks2 = [(HMDHomeManager *)self pendingDataSyncAcks];
    [pendingDataSyncAcks2 setObject:v17 forKeyedSubscript:uUIDString2];
  }

  [v17 addObject:userCopy];
  pendingDataSyncAcks3 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v20 = [HMDPersistentStore archiveIDSDataSyncJournal:pendingDataSyncAcks3];

  v21 = *MEMORY[0x277D85DE8];
}

- (void)pushMetadataToAllWatches
{
  v18 = *MEMORY[0x277D85DE8];
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  associatedWatchPeers = [(HMDHomeManager *)self associatedWatchPeers];
  v4 = [associatedWatchPeers countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v14;
    do
    {
      v7 = 0;
      do
      {
        if (*v14 != v6)
        {
          objc_enumerationMutation(associatedWatchPeers);
        }

        v8 = *(*(&v13 + 1) + 8 * v7);
        associatedWatchPeers2 = [(HMDHomeManager *)self associatedWatchPeers];
        v10 = [associatedWatchPeers2 objectForKey:v8];
        metadataConfig = [v10 metadataConfig];
        [(HMDHomeManager *)self checkAndPushMetadataToUser:v8 destination:v8 userInfo:metadataConfig];

        ++v7;
      }

      while (v5 != v7);
      v5 = [associatedWatchPeers countByEnumeratingWithState:&v13 objects:v17 count:16];
    }

    while (v5);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_pushMetadataChangesToUsers
{
  v68[1] = *MEMORY[0x277D85DE8];
  isWatch();
  v37 = +[HMDHAPMetadata getSharedInstance];
  if (v37)
  {
    _getListOfUsersToPushMetadataChangesTo = [(HMDHomeManager *)self _getListOfUsersToPushMetadataChangesTo];
    if ([_getListOfUsersToPushMetadataChangesTo count] || (-[HMDHomeManager associatedWatchPeers](self, "associatedWatchPeers"), v3 = objc_claimAutoreleasedReturnValue(), v4 = objc_msgSend(v3, "count"), v3, v4))
    {
      v67 = @"kRequestedCapabilitiesKey";
      v65[0] = @"kMetadataInfoVersionKey";
      version = [v37 version];
      v66[0] = version;
      v65[1] = @"kMetadataInfoSchemaVersionKey";
      schemaVersion = [v37 schemaVersion];
      v66[1] = schemaVersion;
      v65[2] = @"kMetadataInfoCompletenessKey";
      v7 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v37, "incomplete") ^ 1}];
      v66[2] = v7;
      v65[3] = @"kHomedVersionKey";
      v8 = homedVersion;
      v66[3] = v8;
      v9 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v66 forKeys:v65 count:4];
      v68[0] = v9;
      v39 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v68 forKeys:&v67 count:1];

      v61 = @"kDeviceClassTypeKey";
      v62 = @"kDeviceClassTypeTransient";
      v63[0] = @"kRequiredCapabilitiesKey";
      v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v62 forKeys:&v61 count:1];
      v63[1] = @"kRequestedCapabilitiesKey";
      v64[0] = v10;
      v59[0] = @"kMetadataInfoVersionKey";
      version2 = [v37 version];
      v60[0] = version2;
      v59[1] = @"kMetadataInfoSchemaVersionKey";
      schemaVersion2 = [v37 schemaVersion];
      v60[1] = schemaVersion2;
      v59[2] = @"kMetadataInfoCompletenessKey";
      v13 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v37, "incomplete") ^ 1}];
      v60[2] = v13;
      v59[3] = @"kHomedVersionKey";
      v14 = homedVersion;
      v60[3] = v14;
      v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v60 forKeys:v59 count:4];
      v64[1] = v15;
      v38 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v64 forKeys:v63 count:2];

      objc_initWeak(&location, self);
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v16 = _getListOfUsersToPushMetadataChangesTo;
      v17 = [v16 countByEnumeratingWithState:&v47 objects:v58 count:16];
      if (v17)
      {
        v40 = *v48;
        do
        {
          v41 = v17;
          for (i = 0; i != v41; ++i)
          {
            if (*v48 != v40)
            {
              objc_enumerationMutation(v16);
            }

            v19 = *(*(&v47 + 1) + 8 * i);
            if ([v16 hmf_BOOLForKey:v19])
            {
              v20 = v19;
              v21 = v39;
            }

            else
            {
              v20 = 0;
              v21 = v38;
            }

            v22 = v21;
            v23 = objc_autoreleasePoolPush();
            v24 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
            {
              v25 = HMFGetLogIdentifier();
              *buf = 138543874;
              v53 = v25;
              v54 = 2112;
              v55 = v19;
              v56 = 2112;
              v57 = v20;
              _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Preparing for metadata push to user: %@ with destination: %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v23);
            workQueue = [(HMDHomeManager *)self workQueue];
            v42[0] = MEMORY[0x277D85DD0];
            v42[1] = 3221225472;
            v42[2] = __45__HMDHomeManager__pushMetadataChangesToUsers__block_invoke;
            v42[3] = &unk_278685A58;
            objc_copyWeak(&v46, &location);
            v27 = v16;
            v43 = v27;
            v44 = v19;
            selfCopy = self;
            [(HMDHomeManager *)self electDeviceForUser:v19 destination:v20 deviceCapabilities:v22 queue:workQueue completionHandler:v42];

            objc_destroyWeak(&v46);
          }

          v17 = [v27 countByEnumeratingWithState:&v47 objects:v58 count:16];
        }

        while (v17);
      }

      objc_destroyWeak(&location);
    }

    else
    {
      v32 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543362;
        v53 = v35;
        _os_log_impl(&dword_229538000, v34, OS_LOG_TYPE_INFO, "%{public}@Not pushing metadata changes to anybody as either there are no users or there are no associated watches with this account.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
    }
  }

  else
  {
    v28 = objc_autoreleasePoolPush();
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543362;
      v53 = v30;
      _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_ERROR, "%{public}@No metadata to push changes to shared users.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v28);
  }

  v31 = *MEMORY[0x277D85DE8];
}

void __45__HMDHomeManager__pushMetadataChangesToUsers__block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v26 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v11 = WeakRetained;
  if (!v7 && WeakRetained && [*(a1 + 32) hmf_BOOLForKey:*(a1 + 40)])
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 48);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = *(a1 + 40);
      v22 = 138543618;
      v23 = v15;
      v24 = 2112;
      v25 = v16;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Pushing metadata changes to shared user: %@", &v22, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v19 = a1 + 40;
    v17 = *(a1 + 40);
    v18 = *(v19 + 8);
    v20 = [v8 destination];
    [v18 checkAndPushMetadataToUser:v17 destination:v20 userInfo:v9];
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (id)_getListOfUsersToPushMetadataChangesTo
{
  v45 = *MEMORY[0x277D85DE8];
  systemStore = [MEMORY[0x277CFEC78] systemStore];
  v41 = 0;
  v42 = 0;
  [systemStore getControllerPublicKey:0 secretKey:0 username:&v42 allowCreation:0 error:&v41];
  v4 = v42;
  v27 = v41;

  dictionary = [MEMORY[0x277CBEB38] dictionary];
  v37 = 0u;
  v38 = 0u;
  v39 = 0u;
  v40 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v6 = [obj countByEnumeratingWithState:&v37 objects:v44 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v38;
    v9 = MEMORY[0x277CBEC38];
    v28 = *v38;
    v29 = v4;
    do
    {
      v10 = 0;
      v30 = v7;
      do
      {
        if (*v38 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v11 = *(*(&v37 + 1) + 8 * v10);
        ownerName = [v11 ownerName];
        v13 = [ownerName isEqualToString:v4];

        if (v13)
        {
          v32 = v10;
          v35 = 0u;
          v36 = 0u;
          v33 = 0u;
          v34 = 0u;
          users = [v11 users];
          v15 = [users countByEnumeratingWithState:&v33 objects:v43 count:16];
          if (v15)
          {
            v16 = v15;
            v17 = *v34;
            do
            {
              for (i = 0; i != v16; ++i)
              {
                if (*v34 != v17)
                {
                  objc_enumerationMutation(users);
                }

                v19 = *(*(&v33 + 1) + 8 * i);
                userID = [v19 userID];

                if (userID)
                {
                  v21 = v9;
                  if (([v19 isRemoteGateway] & 1) != 0 || (objc_msgSend(v11, "currentUser"), v22 = objc_claimAutoreleasedReturnValue(), v23 = objc_msgSend(v19, "isEqual:", v22), v22, v21 = MEMORY[0x277CBEC28], (v23 & 1) == 0))
                  {
                    userID2 = [v19 userID];
                    [dictionary setObject:v21 forKeyedSubscript:userID2];
                  }
                }
              }

              v16 = [users countByEnumeratingWithState:&v33 objects:v43 count:16];
            }

            while (v16);
          }

          v8 = v28;
          v4 = v29;
          v7 = v30;
          v10 = v32;
        }

        ++v10;
      }

      while (v10 != v7);
      v7 = [obj countByEnumeratingWithState:&v37 objects:v44 count:16];
    }

    while (v7);
  }

  v25 = *MEMORY[0x277D85DE8];

  return dictionary;
}

- (void)checkAndPushMetadataToUser:(id)user destination:(id)destination userInfo:(id)info
{
  v93[1] = *MEMORY[0x277D85DE8];
  userCopy = user;
  destinationCopy = destination;
  infoCopy = info;
  isWatch();
  v9 = +[HMDHAPMetadata getSharedInstance];
  v60 = [infoCopy hmf_numberForKey:@"kMetadataInfoVersionKey"];
  v10 = [infoCopy hmf_numberForKey:@"kMetadataInfoSchemaVersionKey"];
  v11 = v10;
  if (!v9 || !v10 || !v60)
  {
    goto LABEL_30;
  }

  schemaVersion = [v9 schemaVersion];
  if ([schemaVersion isEqualToNumber:v11])
  {
    version = [v9 version];
    unsignedIntegerValue = [version unsignedIntegerValue];
    v15 = unsignedIntegerValue > [v60 unsignedIntegerValue];
  }

  else
  {
    v15 = 0;
  }

  v16 = [infoCopy hmf_numberForKey:@"kMetadataInfoCompletenessKey"];
  v17 = v16;
  if (!v16)
  {
    [v9 incomplete];
    goto LABEL_17;
  }

  bOOLValue = [v16 BOOLValue];
  if ([v9 incomplete] & 1) != 0 || (bOOLValue)
  {
LABEL_17:

    if (!v15)
    {
      goto LABEL_30;
    }

    goto LABEL_18;
  }

  schemaVersion2 = [v9 schemaVersion];
  if (([schemaVersion2 isEqualToNumber:v11] & 1) == 0)
  {

    goto LABEL_17;
  }

  version2 = [v9 version];
  unsignedIntegerValue2 = [version2 unsignedIntegerValue];
  unsignedIntegerValue3 = [v60 unsignedIntegerValue];

  if (unsignedIntegerValue2 != unsignedIntegerValue3)
  {
    goto LABEL_17;
  }

  v23 = objc_autoreleasePoolPush();
  v24 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
  {
    v25 = HMFGetLogIdentifier();
    *buf = 138543362;
    v75 = v25;
    _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_INFO, "%{public}@Remote metadata is incomplete, local metadata is complete - sending...", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v23);
LABEL_18:
  v26 = objc_autoreleasePoolPush();
  selfCopy = self;
  v28 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
  {
    v29 = HMFGetLogIdentifier();
    *buf = 138543362;
    v75 = v29;
    _os_log_impl(&dword_229538000, v28, OS_LOG_TYPE_DEFAULT, "%{public}@Push metadata changes to the user", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v26);
  context = objc_autoreleasePoolPush();
  v68 = 0;
  v69 = &v68;
  v70 = 0x3032000000;
  v71 = __Block_byref_object_copy__254244;
  v72 = __Block_byref_object_dispose__254245;
  v73 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-metadata"];
  v56 = [infoCopy hmf_numberForKey:@"kHomedVersionKey"];
  v30 = [HMDHAPMetadata isHomedVersionSupported:?];
  v31 = objc_autoreleasePoolPush();
  if (v30)
  {
    v32 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
    {
      v33 = HMFGetLogIdentifier();
      *buf = 138543874;
      v75 = v33;
      v76 = 2112;
      v77 = userCopy;
      v78 = 2112;
      v79 = v56;
      _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_INFO, "%{public}@Push metadata dictionary to user %@ as its version %@ is supported.", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v31);
    v34 = MEMORY[0x277CCAAB0];
    v35 = +[HMDPersistentStore loadPlainMetadataDictionary];
    v36 = [v34 archivedDataWithRootObject:v35 requiringSecureCoding:1 error:0];

    hmd_compressedData = [v36 hmd_compressedData];

    v37 = +[HMDHAPMetadataModel metadataModelObjectUUID];
    uUIDString = [v37 UUIDString];
    v65[0] = MEMORY[0x277D85DD0];
    v65[1] = 3221225472;
    v65[2] = __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke;
    v65[3] = &unk_278685A08;
    v66 = userCopy;
    v67 = &v68;
    [(HMDHomeManager *)selfCopy sendFragmentedMessageForData:hmd_compressedData objectUUID:uUIDString withMessageName:@"kMetadataDataSyncRequestKey" toUser:v66 destination:destinationCopy completionHandler:v65];

    v39 = v66;
  }

  else
  {
    v40 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_INFO))
    {
      v41 = HMFGetLogIdentifier();
      *buf = 138543874;
      v75 = v41;
      v76 = 2112;
      v77 = userCopy;
      v78 = 2112;
      v79 = v56;
      _os_log_impl(&dword_229538000, v40, OS_LOG_TYPE_INFO, "%{public}@Sending old metadata data to %@ as it is a legacy device %@.", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v31);
    hmd_compressedData = +[HMDHAPMetadata legacyV3DataForIDS];
    v42 = MEMORY[0x277D0F818];
    v92 = @"kHAPMetadataDataKey";
    v93[0] = hmd_compressedData;
    v43 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v93 forKeys:&v92 count:1];
    v39 = [v42 internalMessageWithName:@"kMetadataDataSyncRequestKey" messagePayload:v43];

    objc_initWeak(buf, selfCopy);
    messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
    uuid = [(HMDHomeManager *)selfCopy uuid];
    workQueue = [(HMDHomeManager *)selfCopy workQueue];
    v61[0] = MEMORY[0x277D85DD0];
    v61[1] = 3221225472;
    v61[2] = __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke_680;
    v61[3] = &unk_278685A30;
    objc_copyWeak(&v64, buf);
    v62 = userCopy;
    v63 = &v68;
    [messageDispatcher sendSecureMessage:v39 target:uuid userID:v62 destination:destinationCopy responseQueue:workQueue responseHandler:v61];

    objc_destroyWeak(&v64);
    objc_destroyWeak(buf);
  }

  v47 = objc_autoreleasePoolPush();
  v48 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v48, OS_LOG_TYPE_INFO))
  {
    v49 = HMFGetLogIdentifier();
    v50 = [hmd_compressedData length];
    schemaVersion3 = [v9 schemaVersion];
    version3 = [v9 version];
    v53 = v69[5];
    *buf = 138545410;
    v75 = v49;
    v76 = 2048;
    v77 = v50;
    v78 = 2112;
    v79 = userCopy;
    v80 = 2112;
    v81 = destinationCopy;
    v82 = 2112;
    v83 = schemaVersion3;
    v84 = 2112;
    v85 = version3;
    v86 = 2112;
    v87 = v11;
    v88 = 2112;
    v89 = v60;
    v90 = 2112;
    v91 = v53;
    _os_log_impl(&dword_229538000, v48, OS_LOG_TYPE_INFO, "%{public}@Pushing metadata(%lu bytes) change to user %@ (%@) - local %@/%@  remote %@/%@ - creating transaction %@", buf, 0x5Cu);
  }

  objc_autoreleasePoolPop(v47);
  _Block_object_dispose(&v68, 8);

  objc_autoreleasePoolPop(context);
LABEL_30:

  v54 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v18 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if ([v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
  {
    v7 = objc_autoreleasePoolPush();
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v10 = *(a1 + 32);
      v14 = 138543618;
      v15 = v9;
      v16 = 2112;
      v17 = v10;
      _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Received sync from user %@ for metadata update", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
  }

  v11 = *(*(a1 + 40) + 8);
  v12 = *(v11 + 40);
  *(v11 + 40) = 0;

  v13 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke_680(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained && [v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
  {
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *(a1 + 32);
      v15 = 138543618;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Received sync from user %@ for metadata update", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = *(*(a1 + 40) + 8);
  v13 = *(v12 + 40);
  *(v12 + 40) = 0;

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_pushChangesForHH2SharedUserLastSync:(id)sync completion:(id)completion
{
  v100 = *MEMORY[0x277D85DE8];
  syncCopy = sync;
  completionCopy = completion;
  v72 = syncCopy;
  homeUUID = [syncCopy homeUUID];
  v67 = [(HMDHomeManager *)self _homeWithUUID:homeUUID];

  if (v67)
  {
    v81 = 0u;
    v82 = 0u;
    v79 = 0u;
    v80 = 0u;
    obj = [v67 users];
    v7 = [obj countByEnumeratingWithState:&v79 objects:v99 count:16];
    if (v7)
    {
      v70 = *v80;
LABEL_4:
      v8 = 0;
      while (1)
      {
        if (*v80 != v70)
        {
          objc_enumerationMutation(obj);
        }

        v9 = *(*(&v79 + 1) + 8 * v8);
        uuid = [v9 uuid];
        user = [v72 user];
        uuid2 = [user uuid];
        if ([uuid isEqual:uuid2])
        {
          break;
        }

        user2 = [v72 user];
        userID = [user2 userID];
        userID2 = [v9 userID];
        v16 = [userID isEqual:userID2];

        if (v16)
        {
          goto LABEL_16;
        }

        if (v7 == ++v8)
        {
          v7 = [obj countByEnumeratingWithState:&v79 objects:v99 count:16];
          if (v7)
          {
            goto LABEL_4;
          }

          goto LABEL_11;
        }
      }

LABEL_16:
      v23 = v9;

      if (!v23)
      {
        goto LABEL_20;
      }

      v24 = objc_autoreleasePoolPush();
      selfCopy = self;
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
      {
        v27 = HMFGetLogIdentifier();
        homeUUID2 = [v72 homeUUID];
        user3 = [v72 user];
        *buf = 138543874;
        *&buf[4] = v27;
        *&buf[12] = 2112;
        *&buf[14] = homeUUID2;
        *&buf[22] = 2112;
        v96 = user3;
        _os_log_impl(&dword_229538000, v26, OS_LOG_TYPE_INFO, "%{public}@Do not send because user completed invite for home %@ for hh2 last user data sync %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v24);
      completionCopy[2](completionCopy, 1);
    }

    else
    {
LABEL_11:

LABEL_20:
      context = objc_autoreleasePoolPush();
      *buf = 0;
      *&buf[8] = buf;
      *&buf[16] = 0x3032000000;
      v96 = __Block_byref_object_copy__254244;
      v97 = __Block_byref_object_dispose__254245;
      v98 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-home-to-hh2-last-user-sync"];
      v71 = +[HMDHAPMetadata getSharedInstance];
      v30 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      if (v71)
      {
        HMFGetOSLogHandle();
        v32 = obja = selfCopy2;
        if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
        {
          v33 = HMFGetLogIdentifier();
          homeUUID3 = [v72 homeUUID];
          user4 = [v72 user];
          *v89 = 138543874;
          v90 = v33;
          v91 = 2112;
          v92 = homeUUID3;
          v93 = 2112;
          v94 = user4;
          _os_log_impl(&dword_229538000, v32, OS_LOG_TYPE_INFO, "%{public}@Pushing last sync home data changes to home: %@ and users: %@", v89, 0x20u);
        }

        objc_autoreleasePoolPop(v30);
        v87[0] = @"kRequiredCapabilitiesKey";
        v85[0] = @"kDeviceClassTypeKey";
        v85[1] = @"kHomedVersionKey";
        v86[0] = @"kDeviceClassTypeTransient";
        v36 = MEMORY[0x277CCABB0];
        v66 = +[HMDHomeKitVersion version10];
        versionString = [v66 versionString];
        [versionString doubleValue];
        v61 = [v36 numberWithDouble:?];
        v86[1] = v61;
        v37 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v86 forKeys:v85 count:2];
        v87[1] = @"kRequestedCapabilitiesKey";
        v88[0] = v37;
        v83[0] = @"kHomedVersionKey";
        v38 = homedVersion;
        v84[0] = v38;
        v84[1] = &unk_283E75C98;
        v39 = *MEMORY[0x277CD0640];
        v83[1] = @"kHomedSupportedFeaturesKey";
        v83[2] = v39;
        uuid3 = [v67 uuid];
        uUIDString = [uuid3 UUIDString];
        v84[2] = uUIDString;
        v83[3] = @"kHomeConfigurationVersionKey";
        v42 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v67, "configurationVersion")}];
        v84[3] = v42;
        v83[4] = @"kMetadataInfoVersionKey";
        version = [v71 version];
        v84[4] = version;
        v83[5] = @"kMetadataInfoSchemaVersionKey";
        schemaVersion = [v71 schemaVersion];
        v84[5] = schemaVersion;
        v83[6] = @"kMetadataInfoCompletenessKey";
        v45 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v71, "incomplete") ^ 1}];
        v84[6] = v45;
        v46 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v84 forKeys:v83 count:7];
        v88[1] = v46;
        v60 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v88 forKeys:v87 count:2];

        user5 = [v72 user];
        account = [user5 account];

        if (account)
        {
          v49 = +[HMDIdentityRegistry sharedRegistry];
          user6 = [v72 user];
          pairingIdentity = [user6 pairingIdentity];
          user7 = [v72 user];
          [v49 registerIdentity:pairingIdentity account:account object:user7];
        }

        objc_initWeak(v89, obja);
        user8 = [v72 user];
        userID3 = [user8 userID];
        workQueue = [(HMDHomeManager *)obja workQueue];
        v73[0] = MEMORY[0x277D85DD0];
        v73[1] = 3221225472;
        v73[2] = __66__HMDHomeManager__pushChangesForHH2SharedUserLastSync_completion___block_invoke;
        v73[3] = &unk_2786859E0;
        objc_copyWeak(&v78, v89);
        v74 = v72;
        v76 = completionCopy;
        v77 = buf;
        v75 = v67;
        [(HMDHomeManager *)obja electDeviceForHH1User:userID3 destination:0 deviceCapabilities:v60 queue:workQueue completionHandler:v73];

        objc_destroyWeak(&v78);
        objc_destroyWeak(v89);
      }

      else
      {
        HMFGetOSLogHandle();
        v57 = v56 = selfCopy2;
        if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
        {
          v58 = HMFGetLogIdentifier();
          *v89 = 138543362;
          v90 = v58;
          _os_log_impl(&dword_229538000, v57, OS_LOG_TYPE_ERROR, "%{public}@No metadata to push changes for home", v89, 0xCu);
        }

        objc_autoreleasePoolPop(v30);
        completionCopy[2](completionCopy, 0);
      }

      _Block_object_dispose(buf, 8);
      objc_autoreleasePoolPop(context);
    }
  }

  else
  {
    v17 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      homeUUID4 = [v72 homeUUID];
      user9 = [v72 user];
      *buf = 138543874;
      *&buf[4] = v20;
      *&buf[12] = 2112;
      *&buf[14] = homeUUID4;
      *&buf[22] = 2112;
      v96 = user9;
      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Do not send because home no longer exists %@ for hh2 last user data sync %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
    completionCopy[2](completionCopy, 1);
  }

  v59 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager__pushChangesForHH2SharedUserLastSync_completion___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v61 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v46 = a3;
  v45 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  v9 = WeakRetained;
  v44 = v7;
  v47 = WeakRetained;
  if (v7 || !WeakRetained)
  {
    v27 = objc_autoreleasePoolPush();
    v28 = v9;
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v30 = HMFGetLogIdentifier();
      v31 = [*(a1 + 32) homeUUID];
      v32 = [*(a1 + 32) user];
      *buf = 138543874;
      v56 = v30;
      v57 = 2112;
      v58 = v31;
      v59 = 2112;
      v60 = v32;
      _os_log_impl(&dword_229538000, v29, OS_LOG_TYPE_ERROR, "%{public}@Failed to elect a device for last sync to home: %@ and users: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v27);
    (*(*(a1 + 48) + 16))();
    v33 = *(*(a1 + 56) + 8);
    v11 = *(v33 + 40);
    *(v33 + 40) = 0;
  }

  else
  {
    v10 = [*(a1 + 32) archive];
    v11 = v10;
    if (v10)
    {
      v53 = @"kHomeDataKey";
      v54 = v10;
      v42 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v54 forKeys:&v53 count:1];
      v43 = [MEMORY[0x277D0F818] internalMessageWithName:@"kHomeDataSyncRequestKey" messagePayload:v42];
      v12 = objc_autoreleasePoolPush();
      v13 = v47;
      v14 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
      {
        v15 = HMFGetLogIdentifier();
        v16 = [v43 dataForKey:@"kHomeDataKey"];
        v17 = [v16 length];
        v18 = [*(a1 + 32) user];
        *buf = 138543874;
        v56 = v15;
        v57 = 2048;
        v58 = v17;
        v59 = 2112;
        v60 = v18;
        _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Pushing last sync home data changes (%ld bytes) to user: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v12);
      v41 = [v43 dataForKey:@"kHomeDataKey"];
      v19 = [*(a1 + 40) uuid];
      v20 = [v19 UUIDString];
      v21 = [v43 name];
      v22 = [*(a1 + 32) user];
      v23 = [v22 userID];
      v24 = [v46 destination];
      v48[0] = MEMORY[0x277D85DD0];
      v48[1] = 3221225472;
      v48[2] = __66__HMDHomeManager__pushChangesForHH2SharedUserLastSync_completion___block_invoke_674;
      v48[3] = &unk_2786859B8;
      objc_copyWeak(&v52, (a1 + 64));
      v49 = *(a1 + 32);
      v25 = *(a1 + 48);
      v26 = *(a1 + 56);
      v50 = v25;
      v51 = v26;
      [v13 sendFragmentedMessageForData:v41 objectUUID:v20 withMessageName:v21 toUser:v23 destination:v24 completionHandler:v48];

      objc_destroyWeak(&v52);
    }

    else
    {
      v34 = objc_autoreleasePoolPush();
      v35 = v47;
      v36 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
      {
        v37 = HMFGetLogIdentifier();
        v38 = [*(a1 + 32) homeUUID];
        v39 = [*(a1 + 32) user];
        *buf = 138543874;
        v56 = v37;
        v57 = 2112;
        v58 = v38;
        v59 = 2112;
        v60 = v39;
        _os_log_impl(&dword_229538000, v36, OS_LOG_TYPE_ERROR, "%{public}@Failed to get archive for home %@, user: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v34);
      (*(*(a1 + 48) + 16))();
      v11 = 0;
    }
  }

  v40 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager__pushChangesForHH2SharedUserLastSync_completion___block_invoke_674(uint64_t a1, void *a2, void *a3)
{
  v33 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = WeakRetained;
    v10 = HMFGetOSLogHandle();
    v11 = os_log_type_enabled(v10, OS_LOG_TYPE_INFO);
    if (v5)
    {
      if (v11)
      {
        v12 = HMFGetLogIdentifier();
        v13 = [*(a1 + 32) homeUUID];
        v14 = [*(a1 + 32) user];
        v25 = 138544130;
        v26 = v12;
        v27 = 2112;
        v28 = v13;
        v29 = 2112;
        v30 = v14;
        v31 = 2112;
        v32 = v5;
        v15 = "%{public}@Failed to push last sync home data changes to home: %@ and users: %@ with error %@";
        v16 = v10;
        v17 = 42;
LABEL_7:
        _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_INFO, v15, &v25, v17);
      }
    }

    else if (v11)
    {
      v12 = HMFGetLogIdentifier();
      v13 = [*(a1 + 32) homeUUID];
      v14 = [*(a1 + 32) user];
      v25 = 138543874;
      v26 = v12;
      v27 = 2112;
      v28 = v13;
      v29 = 2112;
      v30 = v14;
      v15 = "%{public}@Pushed last sync home data changes to home: %@ and users: %@";
      v16 = v10;
      v17 = 32;
      goto LABEL_7;
    }

    objc_autoreleasePoolPop(v8);
    (*(*(a1 + 40) + 16))(*(a1 + 40), v5 == 0, v18, v19, v20, v21);
  }

  v22 = *(*(a1 + 48) + 8);
  v23 = *(v22 + 40);
  *(v22 + 40) = 0;

  v24 = *MEMORY[0x277D85DE8];
}

- (void)pushChangesForHH2SharedUserLastSync:(id)sync completion:(id)completion
{
  syncCopy = sync;
  completionCopy = completion;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __65__HMDHomeManager_pushChangesForHH2SharedUserLastSync_completion___block_invoke;
  block[3] = &unk_278689F98;
  block[4] = self;
  v12 = syncCopy;
  v13 = completionCopy;
  v9 = completionCopy;
  v10 = syncCopy;
  dispatch_async(workQueue, block);
}

- (id)_compressHomeData:(id)data
{
  v10[1] = *MEMORY[0x277D85DE8];
  v3 = [data objectForKey:@"kHomeDataKey"];
  v4 = v3;
  if (v3)
  {
    v9 = @"kHomeDataKey";
    hmd_compressedData = [v3 hmd_compressedData];
    v10[0] = hmd_compressedData;
    v6 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v10 forKeys:&v9 count:1];
  }

  else
  {
    v6 = 0;
  }

  v7 = *MEMORY[0x277D85DE8];

  return v6;
}

- (id)generatePayloadFromHome:(id)home forAdmin:(BOOL)admin user:(id)user supportedFeatures:(id)features
{
  adminCopy = admin;
  v41[4] = *MEMORY[0x277D85DE8];
  homeCopy = home;
  userCopy = user;
  featuresCopy = features;
  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];

  v14 = 0x277CBE000uLL;
  if (primaryHomeUUID)
  {
    v40[0] = @"kAccessoriesDataBlobKey";
    hapAccessoriesForLegacyDataBlobEncoding = [homeCopy hapAccessoriesForLegacyDataBlobEncoding];
    v41[0] = hapAccessoriesForLegacyDataBlobEncoding;
    v40[1] = @"kPrimaryHomeUUIDKey";
    primaryHomeUUID2 = [(HMDHomeManager *)self primaryHomeUUID];
    uUIDString = [primaryHomeUUID2 UUIDString];
    v41[1] = uUIDString;
    v41[2] = homeCopy;
    v40[2] = @"kHomeDataBlobKey";
    v40[3] = @"kHomeDataVersionKey";
    v41[3] = &unk_283E74E88;
    v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v41 forKeys:v40 count:4];
  }

  else
  {
    v38[0] = @"kAccessoriesDataBlobKey";
    hapAccessoriesForLegacyDataBlobEncoding = [homeCopy hapAccessoriesForLegacyDataBlobEncoding];
    v39[0] = hapAccessoriesForLegacyDataBlobEncoding;
    v39[1] = homeCopy;
    v38[1] = @"kHomeDataBlobKey";
    v38[2] = @"kHomeDataVersionKey";
    v39[2] = &unk_283E74E88;
    v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v39 forKeys:v38 count:3];
  }

  v19 = objc_autoreleasePoolPush();
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v35 = v21;
    v36 = 2112;
    v37 = userCopy;
    _os_log_impl(&dword_229538000, v20, OS_LOG_TYPE_INFO, "%{public}@generatePayloadFromHome: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v19);
  if (adminCopy)
  {
    v22 = v18;
    v23 = userCopy;
    v24 = featuresCopy;
    v25 = objc_autoreleasePoolPush();
    v26 = [[HMDRemoteKeyedArchiver alloc] initForWritingWithRemoteDeviceIsOnSameAccount:0 remoteGateway:0 remoteUserIsAdministrator:1 user:v23 supportedFeatures:v24];
    [v26 encodeObject:v22 forKey:*MEMORY[0x277CCA308]];
    [v26 finishEncoding];
    encodedData = [v26 encodedData];

    v28 = v25;
    v14 = 0x277CBE000;
    objc_autoreleasePoolPop(v28);
  }

  else
  {
    encodedData = encodeRootObjectForRemote(v18, userCopy, featuresCopy);
  }

  v32 = @"kHomeDataKey";
  v33 = encodedData;
  v29 = [*(v14 + 2752) dictionaryWithObjects:&v33 forKeys:&v32 count:1];

  v30 = *MEMORY[0x277D85DE8];

  return v29;
}

- (id)generateDataForSharedHomeModel:(id)model
{
  v10[3] = *MEMORY[0x277D85DE8];
  v9[0] = @"kAccessoriesDataBlobKey";
  modelCopy = model;
  hapAccessoriesForLegacyDataBlobEncoding = [modelCopy hapAccessoriesForLegacyDataBlobEncoding];
  v10[0] = hapAccessoriesForLegacyDataBlobEncoding;
  v10[1] = modelCopy;
  v9[1] = @"kHomeDataBlobKey";
  v9[2] = @"kHomeDataVersionKey";
  v10[2] = &unk_283E74E88;
  v5 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v10 forKeys:v9 count:3];

  v6 = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v5, 1, 0);

  v7 = *MEMORY[0x277D85DE8];

  return v6;
}

- (id)_prepareDataForDevicesOnSameAccountForHome:(id)home remoteGateway:(BOOL)gateway isAtLeastV4:(BOOL)v4 migrateToHH2:(BOOL)h2
{
  h2Copy = h2;
  v4Copy = v4;
  gatewayCopy = gateway;
  v26[1] = *MEMORY[0x277D85DE8];
  v10 = MEMORY[0x277CBEB38];
  homeCopy = home;
  dictionary = [v10 dictionary];
  hapAccessoriesForLegacyDataBlobEncoding = [homeCopy hapAccessoriesForLegacyDataBlobEncoding];
  [dictionary setObject:hapAccessoriesForLegacyDataBlobEncoding forKeyedSubscript:@"kAccessoriesDataBlobKey"];

  [dictionary setObject:homeCopy forKeyedSubscript:@"kHomeDataBlobKey"];
  [dictionary setObject:&unk_283E74E88 forKeyedSubscript:@"kHomeDataVersionKey"];
  primaryHomeUUID = [(HMDHomeManager *)self primaryHomeUUID];
  uUIDString = [primaryHomeUUID UUIDString];
  [dictionary setObject:uUIDString forKeyedSubscript:@"kPrimaryHomeUUIDKey"];

  v16 = [dictionary copy];
  v17 = v16;
  if (gatewayCopy)
  {
    v18 = v16;
    v19 = objc_autoreleasePoolPush();
    v20 = [[HMDRemoteKeyedArchiver alloc] initForWritingWithRemoteDeviceIsOnSameAccount:1 remoteGateway:1 remoteUserIsAdministrator:0 user:0 supportedFeatures:0];
    [v20 encodeObject:v18 forKey:*MEMORY[0x277CCA308]];
    [v20 finishEncoding];
    encodedData = [v20 encodedData];

    objc_autoreleasePoolPop(v19);
  }

  else
  {
    encodedData = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v16, v4Copy, h2Copy);
  }

  v25 = @"kHomeDataKey";
  v26[0] = encodedData;
  v22 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v26 forKeys:&v25 count:1];

  v23 = *MEMORY[0x277D85DE8];

  return v22;
}

- (unsigned)_nextTransactionIdentifier
{
  nextRequestTransactionIdentifier = self->_nextRequestTransactionIdentifier;
  self->_nextRequestTransactionIdentifier = nextRequestTransactionIdentifier + 1;
  return nextRequestTransactionIdentifier;
}

- (void)_pushUserRemovedForHome:(id)home
{
  v40 = *MEMORY[0x277D85DE8];
  homeCopy = home;
  removedUsers = [homeCopy removedUsers];
  v6 = objc_autoreleasePoolPush();
  selfCopy = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543618;
    v37 = v9;
    v38 = 2112;
    v39 = removedUsers;
    _os_log_impl(&dword_229538000, v8, OS_LOG_TYPE_INFO, "%{public}@Attempting to resend remove message to removed users: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  v33 = 0u;
  v34 = 0u;
  v31 = 0u;
  v32 = 0u;
  obj = removedUsers;
  v10 = [obj countByEnumeratingWithState:&v31 objects:v35 count:16];
  if (v10)
  {
    v11 = *v32;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v32 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v31 + 1) + 8 * i);
        if ([v13 isExpired])
        {
          v14 = objc_autoreleasePoolPush();
          v15 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
          {
            v16 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v16;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@Removed user has expired: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v14);
          [homeCopy removeRemovedUser:v13];
        }

        else if ([v13 isRemovalInProgress])
        {
          v17 = objc_autoreleasePoolPush();
          v18 = selfCopy;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v20;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Skipping resending message to user whose removal is already in progress: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v17);
        }

        else
        {
          [v13 setRemovalInProgress:1];
          v21 = objc_autoreleasePoolPush();
          v22 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
          {
            v23 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v23;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_INFO, "%{public}@Resending message to removed user: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v21);
          objc_initWeak(buf, homeCopy);
          user = [v13 user];
          user2 = [v13 user];
          pairingUsername = [user2 pairingUsername];
          v29[0] = MEMORY[0x277D85DD0];
          v29[1] = 3221225472;
          v29[2] = __42__HMDHomeManager__pushUserRemovedForHome___block_invoke;
          v29[3] = &unk_278689460;
          v29[4] = v13;
          objc_copyWeak(&v30, buf);
          v29[5] = selfCopy;
          [(HMDHomeManager *)selfCopy sendUserRemoved:user fromHome:homeCopy pairingUsername:pairingUsername pushToCloud:0 completionHandler:v29];

          objc_destroyWeak(&v30);
          objc_destroyWeak(buf);
        }
      }

      v10 = [obj countByEnumeratingWithState:&v31 objects:v35 count:16];
    }

    while (v10);
  }

  v27 = *MEMORY[0x277D85DE8];
}

void __42__HMDHomeManager__pushUserRemovedForHome___block_invoke(id *a1, void *a2, void *a3)
{
  v29 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  [a1[4] setRemovalInProgress:0];
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  if (!WeakRetained)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = a1[5];
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v20 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v20;
      v21 = "%{public}@Lost reference to home during removed user removal message";
      v22 = v19;
      v23 = 12;
LABEL_15:
      _os_log_impl(&dword_229538000, v22, OS_LOG_TYPE_ERROR, v21, &v25, v23);
    }

LABEL_16:

    objc_autoreleasePoolPop(v17);
    goto LABEL_17;
  }

  if (v5 && [v5 code] != 2)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = a1[5];
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v20 = HMFGetLogIdentifier();
      v25 = 138543618;
      v26 = v20;
      v27 = 2112;
      v28 = v5;
      v21 = "%{public}@Unable to remove the removed user: %@";
      v22 = v19;
      v23 = 22;
      goto LABEL_15;
    }

    goto LABEL_16;
  }

  if ([v5 code] == 2)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = a1[5];
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v25 = 138543618;
      v26 = v11;
      v27 = 2112;
      v28 = v5;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Treating user removed message error as success: %@", &v25, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = objc_autoreleasePoolPush();
  v13 = a1[5];
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    v16 = a1[4];
    v25 = 138543618;
    v26 = v15;
    v27 = 2112;
    v28 = v16;
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_INFO, "%{public}@Successfully removed the removed user: %@", &v25, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  [WeakRetained removeRemovedUser:a1[4]];
LABEL_17:

  v24 = *MEMORY[0x277D85DE8];
}

- (id)_userPushCachedGetDeviceForUser:(id)user
{
  userCopy = user;
  uuid = [userCopy uuid];

  if (!uuid)
  {
    device = 0;
    goto LABEL_9;
  }

  userPushCacheMap = [(HMDHomeManager *)self userPushCacheMap];
  uuid2 = [userCopy uuid];
  v8 = [userPushCacheMap objectForKeyedSubscript:uuid2];

  if (v8)
  {
    if (![v8 isExpired])
    {
      device = [v8 device];
      goto LABEL_8;
    }

    userPushCacheMap2 = [(HMDHomeManager *)self userPushCacheMap];
    uuid3 = [userCopy uuid];
    [userPushCacheMap2 setObject:0 forKeyedSubscript:uuid3];
  }

  device = 0;
LABEL_8:

LABEL_9:

  return device;
}

- (void)_updateUserPushCachedForUser:(id)user device:(id)device
{
  v23 = *MEMORY[0x277D85DE8];
  userCopy = user;
  deviceCopy = device;
  uuid = [userCopy uuid];

  if (deviceCopy && uuid)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = HMFGetLogIdentifier();
      userID = [userCopy userID];
      v17 = 138543874;
      v18 = v11;
      v19 = 2112;
      v20 = userID;
      v21 = 2112;
      v22 = deviceCopy;
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Caching destination device for %@ to %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v9);
    v13 = [[HMDUserPushCache alloc] initWithDevice:deviceCopy];
    userPushCacheMap = [(HMDHomeManager *)self userPushCacheMap];
    uuid2 = [userCopy uuid];
    [userPushCacheMap setObject:v13 forKeyedSubscript:uuid2];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)updateUserPushCachedForUser:(id)user device:(id)device
{
  userCopy = user;
  deviceCopy = device;
  workQueue = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __53__HMDHomeManager_updateUserPushCachedForUser_device___block_invoke;
  block[3] = &unk_27868A010;
  block[4] = self;
  v12 = userCopy;
  v13 = deviceCopy;
  v9 = deviceCopy;
  v10 = userCopy;
  dispatch_async(workQueue, block);
}

- (int64_t)numberOfAccessoryWithNewFirmwareAvailable
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v3 = [homes countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = 0;
    v6 = *v12;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(homes);
        }

        namesOfServicesWithNewFirmwareAvailableInHome = [*(*(&v11 + 1) + 8 * i) namesOfServicesWithNewFirmwareAvailableInHome];
        v5 += [namesOfServicesWithNewFirmwareAvailableInHome count];
      }

      v4 = [homes countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v4);
  }

  else
  {
    v5 = 0;
  }

  v9 = *MEMORY[0x277D85DE8];
  return v5;
}

- (BOOL)hasHAPAccessoryInAnyHome
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v3 = [homes countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v3)
  {
    v4 = *v11;
    while (2)
    {
      for (i = 0; i != v3; ++i)
      {
        if (*v11 != v4)
        {
          objc_enumerationMutation(homes);
        }

        hapAccessories = [*(*(&v10 + 1) + 8 * i) hapAccessories];
        v7 = [hapAccessories count];

        if (v7)
        {
          LOBYTE(v3) = 1;
          goto LABEL_11;
        }
      }

      v3 = [homes countByEnumeratingWithState:&v10 objects:v14 count:16];
      if (v3)
      {
        continue;
      }

      break;
    }
  }

LABEL_11:

  v8 = *MEMORY[0x277D85DE8];
  return v3;
}

- (id)pairedAccessories
{
  v17 = *MEMORY[0x277D85DE8];
  array = [MEMORY[0x277CBEB18] array];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v5 = [homes countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(homes);
        }

        accessories = [*(*(&v12 + 1) + 8 * i) accessories];
        [array addObjectsFromArray:accessories];
      }

      v6 = [homes countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v6);
  }

  v10 = *MEMORY[0x277D85DE8];

  return array;
}

- (id)accessoriesMatchingIdentifier:(id)identifier
{
  v31 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  if (identifierCopy)
  {
    array = [MEMORY[0x277CBEB18] array];
    v25 = 0u;
    v26 = 0u;
    v27 = 0u;
    v28 = 0u;
    obj = [(HMDHomeManager *)self homes];
    v20 = [obj countByEnumeratingWithState:&v25 objects:v30 count:16];
    if (v20)
    {
      v19 = *v26;
      do
      {
        for (i = 0; i != v20; ++i)
        {
          if (*v26 != v19)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v25 + 1) + 8 * i);
          v21 = 0u;
          v22 = 0u;
          v23 = 0u;
          v24 = 0u;
          accessories = [v7 accessories];
          v9 = [accessories countByEnumeratingWithState:&v21 objects:v29 count:16];
          if (v9)
          {
            v10 = v9;
            v11 = *v22;
            do
            {
              for (j = 0; j != v10; ++j)
              {
                if (*v22 != v11)
                {
                  objc_enumerationMutation(accessories);
                }

                v13 = *(*(&v21 + 1) + 8 * j);
                identifier = [v13 identifier];
                v15 = [identifierCopy isEqual:identifier];

                if (v15)
                {
                  [array addObject:v13];
                }
              }

              v10 = [accessories countByEnumeratingWithState:&v21 objects:v29 count:16];
            }

            while (v10);
          }
        }

        v20 = [obj countByEnumeratingWithState:&v25 objects:v30 count:16];
      }

      while (v20);
    }
  }

  else
  {
    array = MEMORY[0x277CBEBF8];
  }

  v16 = *MEMORY[0x277D85DE8];

  return array;
}

- (NSDate)lastSoftwareUpdateDate
{
  metricsManager = [(HMDHomeManager *)self metricsManager];
  deviceStateManager = [metricsManager deviceStateManager];
  lastSoftwareUpdateDate = [deviceStateManager lastSoftwareUpdateDate];

  return lastSoftwareUpdateDate;
}

- (BOOL)isActive
{
  connectionsManager = [(HMDHomeManager *)self connectionsManager];
  hasActiveConnections = [connectionsManager hasActiveConnections];

  return hasActiveConnections;
}

- (BOOL)badCDPState
{
  v2 = +[HMDCoreDataCloudTransform sharedInstance];
  badCDPState = [v2 badCDPState];

  return badCDPState;
}

- (void)accountAvailabilityChanged:(id)changed
{
  v15 = *MEMORY[0x277D85DE8];
  changedCopy = changed;
  v5 = objc_autoreleasePoolPush();
  selfCopy = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    name = [changedCopy name];
    v11 = 138543618;
    v12 = v8;
    v13 = 2114;
    v14 = name;
    _os_log_impl(&dword_229538000, v7, OS_LOG_TYPE_INFO, "%{public}@Received account availability changed notification: %{public}@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)selfCopy fetchAndUpdatePCSStatus];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)fetchAndUpdatePCSStatus
{
  v3 = getCKContainer();
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke;
  v4[3] = &unk_278685988;
  v4[4] = self;
  [v3 accountInfoWithCompletionHandler:v4];
}

void __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke_2;
  block[3] = &unk_27868A010;
  block[4] = *(a1 + 32);
  v11 = v5;
  v12 = v6;
  v8 = v6;
  v9 = v5;
  dispatch_async(v7, block);
}

void __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke_2(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  if (([*(a1 + 32) initialPCSStatusFetchCompleted] & 1) == 0)
  {
    [*(a1 + 32) setInitialPCSStatusFetchCompleted:1];
  }

  if (*(a1 + 40))
  {
    v2 = [*(a1 + 32) pcsEnabled];
    [*(a1 + 32) setPcsEnabled:{(objc_msgSend(*(a1 + 40), "deviceToDeviceEncryptionAvailability") >> 1) & 1}];
    if ([*(a1 + 32) pcsEnabled])
    {
      v3 = *(*(a1 + 32) + 16);
      if (os_signpost_enabled(v3))
      {
        LOWORD(v17) = 0;
        _os_signpost_emit_with_name_impl(&dword_229538000, v3, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "ManateeAvailable", "", &v17, 2u);
      }
    }

    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v8 = [*(a1 + 32) pcsEnabled];
      v9 = @"Disabled";
      if (v8)
      {
        v10 = @"Enabled";
      }

      else
      {
        v10 = @"Disabled";
      }

      v17 = 138543874;
      v18 = v7;
      v20 = v10;
      v19 = 2112;
      if (v2)
      {
        v9 = @"Enabled";
      }

      v21 = 2112;
      v22 = v9;
      _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@Current PCS status: %@, Old PCS Status: %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v4);
    if (v2 != [*(a1 + 32) pcsEnabled])
    {
      logAndPostNotification(@"HMDHomeManagerPCSStatusChangedNotification", *(a1 + 32), 0);
      [*(a1 + 32) pcsEnabledDidChange];
      [*(a1 + 32) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
    }
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 32);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v15 = *(a1 + 48);
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v15;
      _os_log_impl(&dword_229538000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to fetch account info: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)startWithCompletionHandler:(id)handler
{
  handlerCopy = handler;
  workQueue = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __45__HMDHomeManager_startWithCompletionHandler___block_invoke;
  v7[3] = &unk_27868A7A0;
  v7[4] = self;
  v8 = handlerCopy;
  v6 = handlerCopy;
  dispatch_async(workQueue, v7);
}

void __45__HMDHomeManager_startWithCompletionHandler___block_invoke(uint64_t a1)
{
  v38 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) appleAccountManager];
  v3 = [v2 device];

  if (v3)
  {
    v4 = [*(a1 + 32) capabilitiesController];
    v5 = [v4 currentResidentCapabilities];
    if (v5)
    {
      v6 = v5;
      v7 = [*(a1 + 32) residentEnabledState];

      if (!v7)
      {
        v8 = [v3 productInfo];
        v9 = [v8 productClass];

        if (v9 == 3)
        {
          v33 = 0u;
          v34 = 0u;
          v31 = 0u;
          v32 = 0u;
          v10 = [*(a1 + 32) homes];
          v11 = [v10 countByEnumeratingWithState:&v31 objects:v37 count:16];
          if (v11)
          {
            v12 = *v32;
            while (2)
            {
              for (i = 0; i != v11; ++i)
              {
                if (*v32 != v12)
                {
                  objc_enumerationMutation(v10);
                }

                v14 = *(*(&v31 + 1) + 8 * i);
                if ([v14 isOwnerUser])
                {
                  v15 = [v14 residentCapableDevices];
                  v16 = [v15 containsObject:v3];

                  if (v16)
                  {
                    v17 = objc_autoreleasePoolPush();
                    v18 = *(a1 + 32);
                    v19 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
                    {
                      v20 = HMFGetLogIdentifier();
                      *buf = 138543362;
                      v36 = v20;
                      _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in one or more homes, enabling ourselves as a resident device", buf, 0xCu);
                    }

                    objc_autoreleasePoolPop(v17);
                    v11 = 1;
                    goto LABEL_20;
                  }
                }
              }

              v11 = [v10 countByEnumeratingWithState:&v31 objects:v37 count:16];
              if (v11)
              {
                continue;
              }

              break;
            }
          }

LABEL_20:
        }

        else
        {
          v11 = 1;
        }

        [*(a1 + 32) _updateResidentEnabledOnThisDevice:v11 forceNotify:0 message:0];
      }
    }

    else
    {
    }
  }

  v21 = *(a1 + 32);
  if (v21[43])
  {
    v22 = [v21 notificationCenter];
    [v22 addObserver:*(a1 + 32) selector:sel___handleCompanionUpdated_ name:@"HMDCompanionManagerUpdatedCompanionNotification" object:*(*(a1 + 32) + 344)];

    [*(a1 + 32) _checkAndInformCompanionDevice];
    v21 = *(a1 + 32);
  }

  v23 = [v21 chipXPCListener];
  [v23 start];

  v24 = [*(a1 + 32) matterXPCListener];
  [v24 start];

  v25 = [*(a1 + 32) demoModeManager];
  [v25 configure];

  v26 = *(a1 + 40);
  if (v26)
  {
    (*(v26 + 16))();
  }

  v27 = dispatch_walltime(0, 300000000000);
  v28 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __45__HMDHomeManager_startWithCompletionHandler___block_invoke_607;
  block[3] = &unk_27868A728;
  block[4] = *(a1 + 32);
  dispatch_after(v27, v28, block);

  v29 = *MEMORY[0x277D85DE8];
}

uint64_t __45__HMDHomeManager_startWithCompletionHandler___block_invoke_607(uint64_t a1)
{
  [*(a1 + 32) checkAndProcessHH2UpgradeRecommendation];
  v2 = *(a1 + 32);

  return [v2 postHH2AutoMigratedSuccessBulletinIfNeeded];
}

- (id)accessoryWithIDSIdentifier:(id)identifier
{
  v32 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v21 = [homes countByEnumeratingWithState:&v26 objects:v31 count:16];
  if (v21)
  {
    v6 = *v27;
    v20 = *v27;
    do
    {
      for (i = 0; i != v21; ++i)
      {
        if (*v27 != v6)
        {
          objc_enumerationMutation(homes);
        }

        v8 = *(*(&v26 + 1) + 8 * i);
        v22 = 0u;
        v23 = 0u;
        v24 = 0u;
        v25 = 0u;
        appleMediaAccessories = [v8 appleMediaAccessories];
        v10 = [appleMediaAccessories countByEnumeratingWithState:&v22 objects:v30 count:16];
        if (v10)
        {
          v11 = v10;
          v12 = *v23;
          while (2)
          {
            for (j = 0; j != v11; ++j)
            {
              if (*v23 != v12)
              {
                objc_enumerationMutation(appleMediaAccessories);
              }

              v14 = *(*(&v22 + 1) + 8 * j);
              idsIdentifier = [v14 idsIdentifier];
              v16 = [idsIdentifier hmf_isEqualToUUID:identifierCopy];

              if (v16)
              {
                v17 = v14;

                goto LABEL_19;
              }
            }

            v11 = [appleMediaAccessories countByEnumeratingWithState:&v22 objects:v30 count:16];
            if (v11)
            {
              continue;
            }

            break;
          }
        }

        v6 = v20;
      }

      v17 = 0;
      v21 = [homes countByEnumeratingWithState:&v26 objects:v31 count:16];
    }

    while (v21);
  }

  else
  {
    v17 = 0;
  }

LABEL_19:

  v18 = *MEMORY[0x277D85DE8];

  return v17;
}

- (id)accessoryWithUUID:(id)d
{
  v19 = *MEMORY[0x277D85DE8];
  dCopy = d;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  homes = [(HMDHomeManager *)self homes];
  v6 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(homes);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) accessoryWithUUID:dCopy];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [homes countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (void)_updateHomesDiscoveredBonjourServicesMetrics
{
  v28[2] = *MEMORY[0x277D85DE8];
  if (!isWatch())
  {
    bonjourBrowser = [(HMDHomeManager *)self bonjourBrowser];

    if (!bonjourBrowser)
    {
      v4 = [HMDBonjourBrowserHelper alloc];
      v28[0] = @"_sleep-proxy._udp.";
      v28[1] = @"_meshcop._udp.";
      v5 = [MEMORY[0x277CBEA60] arrayWithObjects:v28 count:2];
      workQueue = [(HMDHomeManager *)self workQueue];
      v7 = [(HMDBonjourBrowserHelper *)v4 initWithServicesOfTypes:v5 browsingTimeInterval:workQueue browsingPeriodicity:20.0 workQueue:0.0];
      [(HMDHomeManager *)self setBonjourBrowser:v7];
    }
  }

  bonjourBrowser2 = [(HMDHomeManager *)self bonjourBrowser];
  if (bonjourBrowser2)
  {
    homes = [(HMDHomeManager *)self homes];
    if ([homes count])
    {
      bonjourBrowser3 = [(HMDHomeManager *)self bonjourBrowser];
      isStarted = [bonjourBrowser3 isStarted];

      if ((isStarted & 1) == 0)
      {
        bonjourBrowserHelperLastCompletionDate = [(HMDHomeManager *)self bonjourBrowserHelperLastCompletionDate];

        if (!bonjourBrowserHelperLastCompletionDate)
        {
          goto LABEL_9;
        }

        date = [MEMORY[0x277CBEAA8] date];
        bonjourBrowserHelperLastCompletionDate2 = [(HMDHomeManager *)self bonjourBrowserHelperLastCompletionDate];
        [date timeIntervalSinceDate:bonjourBrowserHelperLastCompletionDate2];
        v16 = v15;

        mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
        v18 = [mEMORY[0x277D0F8D0] preferenceForKey:@"hapBonjourBrowserHelperPeriod"];
        numberValue = [v18 numberValue];
        [numberValue doubleValue];
        v21 = v20;

        if (v16 >= v21)
        {
LABEL_9:
          objc_initWeak(&location, self);
          bonjourBrowser4 = [(HMDHomeManager *)self bonjourBrowser];
          v25[0] = MEMORY[0x277D85DD0];
          v25[1] = 3221225472;
          v25[2] = __62__HMDHomeManager__updateHomesDiscoveredBonjourServicesMetrics__block_invoke;
          v25[3] = &unk_278688A18;
          objc_copyWeak(&v26, &location);
          [bonjourBrowser4 startWithBrowsingCompletion:v25];

          date2 = [MEMORY[0x277CBEAA8] date];
          [(HMDHomeManager *)self setBonjourBrowserHelperLastCompletionDate:date2];

          objc_destroyWeak(&v26);
          objc_destroyWeak(&location);
        }
      }
    }

    else
    {
    }
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __62__HMDHomeManager__updateHomesDiscoveredBonjourServicesMetrics__block_invoke(uint64_t a1, uint64_t a2)
{
  v24 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v4 = WeakRetained;
  if (!a2)
  {
    v5 = MEMORY[0x277CCABB0];
    v6 = [WeakRetained bonjourBrowser];
    v7 = [v5 numberWithUnsignedInteger:{objc_msgSend(v6, "discoveredServicesCountForServiceType:", @"_meshcop._udp."}];

    v8 = MEMORY[0x277CCABB0];
    v9 = [v4 bonjourBrowser];
    v10 = [v8 numberWithUnsignedInteger:{objc_msgSend(v9, "discoveredServicesCountForServiceType:", @"_sleep-proxy._udp."}];

    v21 = 0u;
    v22 = 0u;
    v19 = 0u;
    v20 = 0u;
    v11 = [v4 homes];
    v12 = [v11 countByEnumeratingWithState:&v19 objects:v23 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v20;
      do
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v20 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v19 + 1) + 8 * i);
          if ([v16 homeLocation] == 1)
          {
            [v16 setAvailableBorderRouters:v7];
            [v16 setAvailableBSPsCount:v10];
          }
        }

        v13 = [v11 countByEnumeratingWithState:&v19 objects:v23 count:16];
      }

      while (v13);
    }
  }

  v17 = [v4 bonjourBrowser];
  [v17 stop];

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_monitorMemoryUsage
{
  memoryTracker = [(HMDHomeManager *)self memoryTracker];
  [memoryTracker trackMemoryUsageWithReason:1];
}

- (void)_auditIDSSentInvitations
{
  v30 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CBEB58] set];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  selfCopy = self;
  homes = [(HMDHomeManager *)self homes];
  v5 = [homes countByEnumeratingWithState:&v24 objects:v29 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v25;
    do
    {
      v8 = 0;
      do
      {
        if (*v25 != v7)
        {
          objc_enumerationMutation(homes);
        }

        v9 = *(*(&v24 + 1) + 8 * v8);
        v20 = 0u;
        v21 = 0u;
        v22 = 0u;
        v23 = 0u;
        outgoingInvitations = [v9 outgoingInvitations];
        v11 = [outgoingInvitations countByEnumeratingWithState:&v20 objects:v28 count:16];
        if (v11)
        {
          v12 = v11;
          v13 = *v21;
          do
          {
            v14 = 0;
            do
            {
              if (*v21 != v13)
              {
                objc_enumerationMutation(outgoingInvitations);
              }

              idsInvitationUUID = [*(*(&v20 + 1) + 8 * v14) idsInvitationUUID];
              if (idsInvitationUUID)
              {
                [v3 addObject:idsInvitationUUID];
              }

              ++v14;
            }

            while (v12 != v14);
            v12 = [outgoingInvitations countByEnumeratingWithState:&v20 objects:v28 count:16];
          }

          while (v12);
        }

        ++v8;
      }

      while (v8 != v6);
      v6 = [homes countByEnumeratingWithState:&v24 objects:v29 count:16];
    }

    while (v6);
  }

  idsInvitationManager = [(HMDHomeManager *)selfCopy idsInvitationManager];
  v17 = [v3 copy];
  [idsInvitationManager auditIDSSentInvitationsUsingCurrentInvitationUUIDs:v17];

  v18 = *MEMORY[0x277D85DE8];
}

- (void)scheduleAddACWGKeysOperationIfAllowed
{
  v35 = *MEMORY[0x277D85DE8];
  internalOnlyInitializer = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v4 = objc_autoreleasePoolPush();
  selfCopy = self;
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    uUID = [internalOnlyInitializer UUID];
    _os_feature_enabled_impl();
    v9 = HMFBooleanToString();
    [(HMDHomeManager *)selfCopy isFirstCloudImportComplete];
    v10 = HMFBooleanToString();
    [(HMDHomeManager *)selfCopy hasFinishedStartingUp];
    v11 = HMFBooleanToString();
    [(HMDHomeManager *)selfCopy didCreateAddACWGKeysOperation];
    v12 = HMFBooleanToString();
    v23 = 138544642;
    v24 = v7;
    v25 = 2112;
    v26 = uUID;
    v27 = 2112;
    v28 = v9;
    v29 = 2112;
    v30 = v10;
    v31 = 2112;
    v32 = v11;
    v33 = 2112;
    v34 = v12;
    _os_log_impl(&dword_229538000, v6, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] scheduleAddACWGKeysOperationIfAllowed with HM_FEATURE_UWB_ENABLED: %@, isFirstCloudImportComplete: %@, hasFinishedStartingUp: %@, didCreateAddACWGKeysOperation: %@", &v23, 0x3Eu);
  }

  objc_autoreleasePoolPop(v4);
  if (_os_feature_enabled_impl() && [(HMDHomeManager *)selfCopy isFirstCloudImportComplete]&& [(HMDHomeManager *)selfCopy hasFinishedStartingUp]&& ![(HMDHomeManager *)selfCopy didCreateAddACWGKeysOperation])
  {
    v13 = objc_autoreleasePoolPush();
    v14 = selfCopy;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      v16 = HMFGetLogIdentifier();
      uUID2 = [internalOnlyInitializer UUID];
      v23 = 138543618;
      v24 = v16;
      v25 = 2112;
      v26 = uUID2;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Creating addACWGKeysOperation", &v23, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v18 = [_TtC13HomeKitDaemon35AddACWGKeysToExistingHomesOperation alloc];
    v19 = [(HMDBackgroundOperation *)v18 initWithUserData:MEMORY[0x277CBEC10]];
    [(AddACWGKeysToExistingHomesOperation *)v19 setFlow:internalOnlyInitializer];
    bgOpsManager = [(HMDHomeManager *)v14 bgOpsManager];
    [bgOpsManager addOperation:v19];

    bgOpsManager2 = [(HMDHomeManager *)v14 bgOpsManager];
    [bgOpsManager2 evaluateOperations];

    [(HMDHomeManager *)v14 setDidCreateAddACWGKeysOperation:1];
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (void)_loadMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry uncommittedTransactions:(id)self0 reloadData:(BOOL)self1
{
  v454[1] = *MEMORY[0x277D85DE8];
  dispatcherCopy = dispatcher;
  browserCopy = browser;
  chainCopy = chain;
  dataCopy = data;
  registryCopy = registry;
  accountRegistryCopy = accountRegistry;
  transactionsCopy = transactions;
  v421 = dataCopy;
  v19 = &OBJC_IVAR___HMDMediaAccessoryAdvertisement__lock;
  v20 = 0x277CBE000;
  v418 = accountRegistryCopy;
  if (reloadData)
  {
    goto LABEL_35;
  }

  v21 = [[HMDSyncOperationManager alloc] initWithClientQueue:self->_workQueue dataSource:self];
  syncManager = self->_syncManager;
  self->_syncManager = v21;

  v23 = [[HMDCloudAccount alloc] initWithClientQueue:self->_workQueue];
  cloudAccount = self->_cloudAccount;
  self->_cloudAccount = v23;

  dictionary = [MEMORY[0x277CBEB38] dictionary];
  userPushCacheMap = self->_userPushCacheMap;
  self->_userPushCacheMap = dictionary;

  v27 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:10.0];
  watchPushDelayTimer = self->_watchPushDelayTimer;
  self->_watchPushDelayTimer = v27;

  [(HMFTimer *)self->_watchPushDelayTimer setDelegate:self];
  v29 = self->_watchPushDelayTimer;
  workQueue = [(HMDHomeManager *)self workQueue];
  [(HMFTimer *)v29 setDelegateQueue:workQueue];

  objc_storeStrong(&self->_messageDispatcher, dispatcher);
  v31 = [[HMDBiomeLogEventObserver alloc] initWithBiomeEventManager:self->_biomeEventManager dataSource:self];
  biomeLogEventObserver = self->_biomeLogEventObserver;
  self->_biomeLogEventObserver = v31;

  [(HMDWalletKeyStepUpFailureListener *)self->_stepUpFailureListener configure];
  v33 = [[HMDCompositeSettingsControllerManager alloc] initWithDataSource:self];
  compositeSettingsControllerManager = self->_compositeSettingsControllerManager;
  self->_compositeSettingsControllerManager = v33;

  v35 = [[HMDSiriEndpointOnboardingManager alloc] initWithDataSource:self];
  siriEndpointOnboardingManager = self->_siriEndpointOnboardingManager;
  self->_siriEndpointOnboardingManager = v35;

  v37 = objc_autoreleasePoolPush();
  selfCopy = self;
  v39 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
  {
    v40 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v40;
    _os_log_impl(&dword_229538000, v39, OS_LOG_TYPE_INFO, "%{public}@Creating event router broker", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v37);
  v41 = objc_alloc(MEMORY[0x277D174B8]);
  v42 = eventStorePath;
  v43 = [v41 initWithFileName:v42];
  lastEventStore = selfCopy->_lastEventStore;
  selfCopy->_lastEventStore = v43;

  if (([(HMELastEventStore *)selfCopy->_lastEventStore startup]& 1) != 0)
  {
    v45 = [[HMDLastEventStoreController alloc] initWithWithEventStore:selfCopy->_lastEventStore];
    lastEventStoreController = selfCopy->_lastEventStoreController;
    selfCopy->_lastEventStoreController = v45;
  }

  else
  {
    v47 = objc_autoreleasePoolPush();
    v48 = selfCopy;
    v49 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_FAULT))
    {
      v50 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v50;
      _os_log_impl(&dword_229538000, v49, OS_LOG_TYPE_FAULT, "%{public}@Unable to start event store", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v47);
  }

  v51 = objc_alloc(MEMORY[0x277D17498]);
  workQueue2 = [(HMDHomeManager *)selfCopy workQueue];
  v53 = [v51 initWithQueue:workQueue2 dataSource:selfCopy storeReadHandle:selfCopy->_lastEventStore logCategory:"Router.RegistrationForwarding" identifier:0];
  registrationForwardingEventRouter = selfCopy->_registrationForwardingEventRouter;
  selfCopy->_registrationForwardingEventRouter = v53;

  v55 = objc_alloc(MEMORY[0x277D174C0]);
  workQueue3 = [(HMDHomeManager *)selfCopy workQueue];
  v57 = [v55 initWithQueue:workQueue3 storeReadHandle:selfCopy->_lastEventStore storeWriteHandle:selfCopy->_lastEventStore logCategory:"Router.LocalMemory"];
  memoryEventRouter = selfCopy->_memoryEventRouter;
  selfCopy->_memoryEventRouter = v57;

  [(HMEMemoryEventBus *)selfCopy->_memoryEventRouter setDataSource:selfCopy];
  v59 = selfCopy->_memoryEventRouter;
  if (objc_opt_respondsToSelector())
  {
    v60 = selfCopy->_registrationForwardingEventRouter;
    synchronousSubscriptionProvider = [(HMEMemoryEventBus *)selfCopy->_memoryEventRouter synchronousSubscriptionProvider];
    [(HMEDelegatingEventRouter *)v60 registerSubRouter:synchronousSubscriptionProvider];
  }

  v62 = [HMDLoggingEventForwarder alloc];
  v63 = selfCopy->_memoryEventRouter;
  logEventSubmitter = [(HMDHomeManager *)selfCopy logEventSubmitter];
  v65 = [(HMDLoggingEventForwarder *)v62 initWithEventForwarder:v63 logEventSubmitter:logEventSubmitter];
  loggingMemoryEventForwarder = selfCopy->_loggingMemoryEventForwarder;
  selfCopy->_loggingMemoryEventForwarder = v65;

  [(HMDHomeManager *)selfCopy initializeMediaGroupParticipantDataLocalStorage];
  if (![(HMDHomeManager *)selfCopy isResidentCapable])
  {
    v67 = [HMDRemoteEventRouterAssertionController alloc];
    workQueue4 = [(HMDHomeManager *)selfCopy workQueue];
    notificationCenter = [(HMDHomeManager *)selfCopy notificationCenter];
    v70 = [(HMDRemoteEventRouterAssertionController *)v67 initWithQueue:workQueue4 notificationCenter:notificationCenter];
    [(HMDHomeManager *)selfCopy setEventRouterAssertionController:v70];

    eventRouterAssertionController = [(HMDHomeManager *)selfCopy eventRouterAssertionController];
    [eventRouterAssertionController configure];
  }

  objc_storeStrong(&selfCopy->_accessoryBrowserInternal, browser);
  [(HMDAccessoryBrowser *)selfCopy->_accessoryBrowserInternal setUnpairedAccessoryManagerDelegate:selfCopy];
  v72 = [MEMORY[0x277CBEB58] set];
  pendingHomesBeingRemoved = selfCopy->_pendingHomesBeingRemoved;
  selfCopy->_pendingHomesBeingRemoved = v72;

  v74 = objc_alloc_init(HMDPowerManager);
  powerManager = selfCopy->_powerManager;
  selfCopy->_powerManager = v74;

  selfCopy->_accountActive = 0;
  selfCopy->_accountStatusFailedDueToNetworkFailure = 0;
  selfCopy->_uploadToCloudIsPending = 0;
  selfCopy->_uploadHomeDataToCloud = 0;
  objc_storeStrong(&selfCopy->_identityRegistry, registry);
  cloudOperationRetryTimer = selfCopy->_cloudOperationRetryTimer;
  selfCopy->_cloudOperationRetryTimer = 0;

  selfCopy->_lastAnswerForShouldCloudSyncData = 0;
  objc_storeStrong(&selfCopy->_msgFilterChain, chain);
  selfCopy->_cloudOperationRetryCount = 0;
  selfCopy->_backOffOperationInProgress = 0;
  objc_storeStrong(&selfCopy->_accountRegistry, accountRegistry);
  [(HMDHomeManager *)selfCopy _migrateUniqueIdentifierPrefsIfNeeded];
  v77 = +[HMDAppleAccountSettings sharedSettings];
  [v77 synchronize];

  selfCopy->_companionReachable = 0;
  v78 = +[HMDWatchSystemState sharedState];
  if (+[HMDDeviceCapabilities isCompanionCapable])
  {
    v79 = [HMDPairedSync alloc];
    workQueue5 = [(HMDHomeManager *)selfCopy workQueue];
    v81 = [(HMDPairedSync *)v79 initWithQueue:workQueue5];
    pairedSync = selfCopy->_pairedSync;
    selfCopy->_pairedSync = v81;

    v83 = &OBJC_IVAR___HMDHomeManager__watchManager;
    v84 = off_278666380;
LABEL_17:
    sharedManager = [(__objc2_class *)*v84 sharedManager];
    v88 = *v83;
    v89 = *(&selfCopy->super.super.isa + v88);
    *(&selfCopy->super.super.isa + v88) = sharedManager;

    goto LABEL_18;
  }

  productInfo = [MEMORY[0x277D0F8E8] productInfo];
  productPlatform = [productInfo productPlatform];

  if (productPlatform == 3)
  {
    v83 = &OBJC_IVAR___HMDHomeManager__companionManager;
    v84 = off_2786660F0;
    goto LABEL_17;
  }

LABEL_18:
  if (+[HMDSoftwareUpdateManager isSupported])
  {
    v90 = objc_alloc_init(HMDSoftwareUpdateManager);
    softwareUpdateManager = selfCopy->_softwareUpdateManager;
    selfCopy->_softwareUpdateManager = v90;
  }

  selfCopy->_uploadMetadataToCloud = 0;
  selfCopy->_cloudkitAccountStatusDetermined = 0;
  selfCopy->_generationCounter = 0;
  if (selfCopy->_generationCounterToken == -1)
  {
    darwinNotificationProvider = [(HMDHomeManager *)selfCopy darwinNotificationProvider];
    v93 = [darwinNotificationProvider notifyRegisterCheck:*MEMORY[0x277CD0200] outToken:&selfCopy->_generationCounterToken];

    if (!v93)
    {
      v438 = 0;
      darwinNotificationProvider2 = [(HMDHomeManager *)selfCopy darwinNotificationProvider];
      [darwinNotificationProvider2 notifyGetState:selfCopy->_generationCounterToken state:&v438];

      if (!v438)
      {
        v95 = objc_autoreleasePoolPush();
        v96 = selfCopy;
        v97 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v97, OS_LOG_TYPE_DEFAULT))
        {
          v98 = HMFGetLogIdentifier();
          *buf = 138543362;
          *&buf[4] = v98;
          _os_log_impl(&dword_229538000, v97, OS_LOG_TYPE_DEFAULT, "%{public}@Generation counter for notification token is zero - refreshing from persisted configuration", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v95);
        userDefaults = [(HMDHomeManager *)v96 userDefaults];
        v438 = [userDefaults integerForKey:@"HMDHomeManagerGenerationCounter"];

        if (!v438)
        {
          v100 = objc_autoreleasePoolPush();
          v101 = v96;
          v102 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v102, OS_LOG_TYPE_DEFAULT))
          {
            v103 = HMFGetLogIdentifier();
            *buf = 138543362;
            *&buf[4] = v103;
            _os_log_impl(&dword_229538000, v102, OS_LOG_TYPE_DEFAULT, "%{public}@Persisted generation counter is zero - need to invalidate client caches", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v100);
        }
      }

      v104 = objc_autoreleasePoolPush();
      v105 = selfCopy;
      v106 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v106, OS_LOG_TYPE_DEFAULT))
      {
        v107 = HMFGetLogIdentifier();
        *buf = 138543618;
        *&buf[4] = v107;
        *&buf[12] = 2048;
        *&buf[14] = v438;
        _os_log_impl(&dword_229538000, v106, OS_LOG_TYPE_DEFAULT, "%{public}@Initializing with generation counter %llu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v104);
      selfCopy->_generationCounter = v438;
    }
  }

  v108 = [MEMORY[0x277CBEB58] set];
  unassociatedRemotePeers = selfCopy->_unassociatedRemotePeers;
  selfCopy->_unassociatedRemotePeers = v108;

  dictionary2 = [MEMORY[0x277CBEB38] dictionary];
  associatedRemotePeers = selfCopy->_associatedRemotePeers;
  selfCopy->_associatedRemotePeers = dictionary2;

  dictionary3 = [MEMORY[0x277CBEB38] dictionary];
  associatedWatchPeers = selfCopy->_associatedWatchPeers;
  selfCopy->_associatedWatchPeers = dictionary3;

  dictionary4 = [MEMORY[0x277CBEB38] dictionary];
  watchSyncStateMap = selfCopy->_watchSyncStateMap;
  selfCopy->_watchSyncStateMap = dictionary4;

  v116 = [MEMORY[0x277CBEB58] set];
  fullSyncedWatchPeers = selfCopy->_fullSyncedWatchPeers;
  selfCopy->_fullSyncedWatchPeers = v116;

  dictionary5 = [MEMORY[0x277CBEB38] dictionary];
  watchSyncRetryContextBySyncIdentifier = selfCopy->_watchSyncRetryContextBySyncIdentifier;
  selfCopy->_watchSyncRetryContextBySyncIdentifier = dictionary5;

  strongToStrongObjectsMapTable = [MEMORY[0x277CCAB00] strongToStrongObjectsMapTable];
  watchSyncRetryContextByRetryTimer = selfCopy->_watchSyncRetryContextByRetryTimer;
  selfCopy->_watchSyncRetryContextByRetryTimer = strongToStrongObjectsMapTable;

  array = [MEMORY[0x277CBEB18] array];
  pendingResponsesForAccessoryFinder = selfCopy->_pendingResponsesForAccessoryFinder;
  selfCopy->_pendingResponsesForAccessoryFinder = array;

  dictionary6 = [MEMORY[0x277CBEB38] dictionary];
  pendingRemoteSessions = selfCopy->_pendingRemoteSessions;
  selfCopy->_pendingRemoteSessions = dictionary6;

  v126 = [MEMORY[0x277CBEB58] set];
  pendingResidentSetupSessions = selfCopy->_pendingResidentSetupSessions;
  selfCopy->_pendingResidentSetupSessions = v126;

  v128 = HMDispatchQueueNameString();
  uTF8String = [v128 UTF8String];
  v130 = dispatch_queue_attr_make_with_autorelease_frequency(0, DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM);
  v131 = dispatch_queue_create(uTF8String, v130);
  clientConnectionQueue = selfCopy->_clientConnectionQueue;
  selfCopy->_clientConnectionQueue = v131;

  v133 = [[HMDClientConnection alloc] initWithHomeManager:selfCopy queue:selfCopy->_clientConnectionQueue messageDispatcher:self->_messageDispatcher];
  clientConnection = selfCopy->_clientConnection;
  selfCopy->_clientConnection = v133;

  v135 = [[HMDAssistantGather alloc] initWithHomeManager:selfCopy queue:selfCopy->_clientConnectionQueue];
  gatherer = selfCopy->_gatherer;
  selfCopy->_gatherer = v135;

  _getAssistantHashingData = [(HMDHomeManager *)selfCopy _getAssistantHashingData];
  [(HMDHomeManager *)selfCopy _setAssistantHashingData:_getAssistantHashingData];

  v138 = +[HMDLaunchHandler sharedHandler];
  [v138 removePersistentRelaunchRegistrationsIfNecessary];

  dictionary7 = [MEMORY[0x277CBEB38] dictionary];
  pendingFragmentationStream = selfCopy->_pendingFragmentationStream;
  selfCopy->_pendingFragmentationStream = dictionary7;

  v141 = +[HMDPersistentStore unarchiveIDSDataSyncJournal];
  pendingDataSyncAcks = selfCopy->_pendingDataSyncAcks;
  selfCopy->_pendingDataSyncAcks = v141;

  selfCopy->_ignoreFirstTimeReachabilityChanged = 1;
  v143 = [MEMORY[0x277CBEB58] set];
  dialogCancelationContexts = selfCopy->_dialogCancelationContexts;
  selfCopy->_dialogCancelationContexts = v143;

  v145 = +[HMDLocation sharedManager];
  locationHandler = selfCopy->_locationHandler;
  selfCopy->_locationHandler = v145;

  [(HMDHomeManager *)selfCopy startFindMyHandler];
  selfCopy->_needToCleanUpKeys = 0;
  v147 = [HMDCHIPDataSource alloc];
  dataSource = [(HMDHomeManager *)selfCopy dataSource];
  threadClientFactory = [dataSource threadClientFactory];
  v150 = [(HMDCHIPDataSource *)v147 initWithHomeManager:selfCopy threadClientFactory:threadClientFactory];
  chipDataSource = selfCopy->_chipDataSource;
  selfCopy->_chipDataSource = v150;

  v152 = [[HMDAccessorySetupManager alloc] initWithWorkQueue:self->_workQueue homeManager:selfCopy];
  accessorySetupManager = selfCopy->_accessorySetupManager;
  selfCopy->_accessorySetupManager = v152;

  [(HMDAccessorySetupManager *)selfCopy->_accessorySetupManager configure];
  v154 = [HMDAccessorySetupCoordinator alloc];
  workQueue = self->_workQueue;
  messageDispatcher = [(HMDAccessorySetupManager *)selfCopy->_accessorySetupManager messageDispatcher];
  chipAccessoryServerBrowser = [(HMDAccessoryBrowser *)selfCopy->_accessoryBrowserInternal chipAccessoryServerBrowser];
  v158 = [(HMDAccessorySetupCoordinator *)v154 initWithWorkQueue:workQueue messageDispatcher:messageDispatcher chipAccessoryServerBrowser:chipAccessoryServerBrowser chipDataSource:selfCopy->_chipDataSource];
  accessorySetupCoordinator = selfCopy->_accessorySetupCoordinator;
  selfCopy->_accessorySetupCoordinator = v158;

  [(HMDAccessorySetupCoordinator *)selfCopy->_accessorySetupCoordinator configure];
  [(HMDAccessorySetupManager *)selfCopy->_accessorySetupManager setAccessorySetupCoordinator:selfCopy->_accessorySetupCoordinator];
  v160 = [[HMDMTSPairingServer alloc] initWithAccessoryBrowser:browserCopy];
  v161 = [[HMDMTSDeviceSetupServer alloc] initWithAccessorySetupManager:selfCopy->_accessorySetupManager];
  v162 = 0;
  if (_os_feature_enabled_impl())
  {
    v163 = [HMDMTSNetworkCredentialServer alloc];
    chipAccessoryServerBrowser2 = [browserCopy chipAccessoryServerBrowser];
    systemCommissionerPairingManager = [chipAccessoryServerBrowser2 systemCommissionerPairingManager];
    v162 = [(HMDMTSNetworkCredentialServer *)v163 initWithSystemCommissionerPairingManager:systemCommissionerPairingManager];
  }

  v166 = [[HMDMTSAuthorizationServer alloc] initWithAccountManager:selfCopy->_appleAccountManager];
  v167 = [[HMDMTSXPCServer alloc] initWithPairingServer:v160 deviceSetupServer:v161 networkCredentialServer:v162 authorizationServer:v166];
  mtsXPCServer = selfCopy->_mtsXPCServer;
  selfCopy->_mtsXPCServer = v167;

  [(HMDMTSXPCServer *)selfCopy->_mtsXPCServer start];
  v169 = [HMDCameraRecordingLoadBalancer alloc];
  v170 = objc_alloc_init(MEMORY[0x277D14DC8]);
  v171 = [(HMDCameraRecordingLoadBalancer *)v169 initWithHomeManager:selfCopy resourceUsageMonitor:v170];
  cameraLoadBalancer = selfCopy->_cameraLoadBalancer;
  selfCopy->_cameraLoadBalancer = v171;

  [(HMDCameraRecordingLoadBalancer *)selfCopy->_cameraLoadBalancer start];
  v173 = [[HMDCameraClipsQuotaMessenger alloc] initWithWorkQueue:self->_workQueue messageDispatcher:self->_messageDispatcher];
  cameraClipsQuotaMessenger = selfCopy->_cameraClipsQuotaMessenger;
  selfCopy->_cameraClipsQuotaMessenger = v173;

  [(HMDCameraClipsQuotaMessenger *)selfCopy->_cameraClipsQuotaMessenger configure];
  dataCopy = v421;
  accountRegistryCopy = v418;
  v20 = 0x277CBE000uLL;
  v19 = &OBJC_IVAR___HMDMediaAccessoryAdvertisement__lock;
LABEL_35:
  v175 = [[HMDMicroLocationManager alloc] initWithLocationManager:*(&self->super.super.isa + v19[568])];
  microLocationManager = self->_microLocationManager;
  self->_microLocationManager = v175;

  v177 = [[HMDMicroLocationLogEventObserver alloc] initWithDataSource:self microLocationManager:self->_microLocationManager];
  microLocationLogEventObserver = self->_microLocationLogEventObserver;
  self->_microLocationLogEventObserver = v177;

  self->_siriSyncNotificationTime = 0;
  v179 = [[HMDIDSInvitationManager alloc] initWithHomeManager:self messageDispatcher:dispatcherCopy queue:self->_clientConnectionQueue remoteAccountManager:self->_remoteAccountManager];
  idsInvitationManager = self->_idsInvitationManager;
  self->_idsInvitationManager = v179;

  v181 = [[HMDUserDeviceCapabilitiesRequestManager alloc] initWithHomeManager:self accountRegistry:accountRegistryCopy messageDispatcher:dispatcherCopy];
  userDeviceCapabilitiesRequestManager = self->_userDeviceCapabilitiesRequestManager;
  self->_userDeviceCapabilitiesRequestManager = v181;

  v183 = [MEMORY[0x277CBEB58] set];
  mergeIDsOfUsersOfRemovedSharedHomes = self->_mergeIDsOfUsersOfRemovedSharedHomes;
  self->_mergeIDsOfUsersOfRemovedSharedHomes = v183;

  self->_homeDataLoadedFromArchive = 0;
  self->_accessAllowedWhenLocked = isiOSDevice();
  v185 = [MEMORY[0x277CBEB58] set];
  unprocessedOperationModelIdentifiers = self->_unprocessedOperationModelIdentifiers;
  self->_unprocessedOperationModelIdentifiers = v185;

  primaryHomeUUID = self->_primaryHomeUUID;
  self->_primaryHomeUUID = 0;

  self->_homeManagerZoneFirstFetch = 1;
  array2 = [*(v20 + 2840) array];
  cloudZones = self->_cloudZones;
  self->_cloudZones = array2;

  dataTag = self->_dataTag;
  self->_dataTag = 0;

  array3 = [*(v20 + 2840) array];
  uuidsOfRemovedHomes = self->_uuidsOfRemovedHomes;
  self->_uuidsOfRemovedHomes = array3;

  self->_residentEnabledState = 0;
  v193 = getAssistantConfigurationVersion();
  self->_assistantGenerationCounter = [v193 unsignedIntegerValue];

  self->_homeDatabaseSize = 0;
  uUIDsOfRemovedHomes = [dataCopy UUIDsOfRemovedHomes];
  if (uUIDsOfRemovedHomes)
  {
    v195 = uUIDsOfRemovedHomes;
    isWatch();

    v196 = *(v20 + 2840);
    uUIDsOfRemovedHomes2 = [dataCopy UUIDsOfRemovedHomes];
    v198 = [v196 arrayWithArray:uUIDsOfRemovedHomes2];
    v199 = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = v198;
  }

  else
  {
    array4 = [*(v20 + 2840) array];
    uUIDsOfRemovedHomes2 = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = array4;
  }

  v201 = +[HMDDeviceCapabilities deviceCapabilities];
  supportsFirmwareUpdate = [v201 supportsFirmwareUpdate];

  if (supportsFirmwareUpdate)
  {
    v203 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v205 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v205, OS_LOG_TYPE_DEBUG))
    {
      v206 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v206;
      _os_log_impl(&dword_229538000, v205, OS_LOG_TYPE_DEBUG, "%{public}@Starting AccessoryFirmwareUpdateManager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v203);
    v207 = [[HMDAccessoryFirmwareUpdateManager alloc] initWithHomeManager:selfCopy2];
    accessoryFirmwareUpdateManager = selfCopy2->_accessoryFirmwareUpdateManager;
    selfCopy2->_accessoryFirmwareUpdateManager = v207;
  }

  if ((_os_feature_enabled_impl() & 1) != 0 || CFPreferencesGetAppBooleanValue(@"MatterOTA", @"/Library/Managed Preferences/mobile/com.apple.homed.plist", 0))
  {
    v209 = [[HMDMatterSoftwareUpdateProviderDelegate alloc] initWithHomeManager:self accessoryFirmwareUpdateManager:self->_accessoryFirmwareUpdateManager];
    matterSoftwareUpdateProviderDelegate = self->_matterSoftwareUpdateProviderDelegate;
    self->_matterSoftwareUpdateProviderDelegate = v209;
  }

  if (self->_residentEnabledState == 1)
  {
    productInfo2 = [MEMORY[0x277D0F8E8] productInfo];
    productClass = [productInfo2 productClass];

    if (productClass == 4)
    {
      v213 = objc_autoreleasePoolPush();
      selfCopy3 = self;
      v215 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v215, OS_LOG_TYPE_DEFAULT))
      {
        v216 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v216;
        _os_log_impl(&dword_229538000, v215, OS_LOG_TYPE_DEFAULT, "%{public}@Force enabling as a resident", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v213);
      self->_residentEnabledState = 2;
    }
  }

  if (reloadData)
  {
    uuid = [(HMDHomeManager *)self uuid];
    [(HMDHomeManager *)self updateGenerationCounterWithReason:@"ReloadHomeData" sourceUUID:uuid shouldNotifyClients:0];
    v419 = 0;
  }

  else
  {
    HMFUptime();
    v219 = v218;
    v220 = objc_autoreleasePoolPush();
    selfCopy4 = self;
    v222 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v222, OS_LOG_TYPE_DEBUG))
    {
      v223 = HMFGetLogIdentifier();
      *buf = 138544386;
      *&buf[4] = v223;
      *&buf[12] = 2114;
      *&buf[14] = @"homeManagerInitStart";
      *&buf[22] = 2112;
      v444 = @"Start backing store setup";
      v445 = 2114;
      v446 = @"state";
      v447 = 2112;
      v448 = @"homeManagerLoadingBackingStore";
      _os_log_impl(&dword_229538000, v222, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v220);
    mEMORY[0x277D17DE8] = [MEMORY[0x277D17DE8] sharedInstance];
    v225 = objc_alloc(MEMORY[0x277D17DF8]);
    v453 = @"state";
    v454[0] = @"homeManagerLoadingBackingStore";
    v226 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v454 forKeys:&v453 count:1];
    v227 = [v225 initWithTag:@"homeManagerInitStart" data:v226];
    currentTagProcessorList = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8] submitTaggedEvent:v227 processorList:currentTagProcessorList];

    dataSource2 = [(HMDHomeManager *)selfCopy4 dataSource];
    v437 = 0;
    v230 = [dataSource2 createBackingStoreForHomeManager:selfCopy4 error:&v437];
    uuid = v437;
    backingStore = selfCopy4->_backingStore;
    selfCopy4->_backingStore = v230;

    if (!selfCopy4->_backingStore)
    {
      v410 = objc_autoreleasePoolPush();
      v411 = selfCopy4;
      v412 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v412, OS_LOG_TYPE_FAULT))
      {
        v413 = HMFGetLogIdentifier();
        *buf = 138543618;
        *&buf[4] = v413;
        *&buf[12] = 2112;
        *&buf[14] = uuid;
        _os_log_impl(&dword_229538000, v412, OS_LOG_TYPE_FAULT, "%{public}@Unable to open Home Manager BackingStore zone. Unsurvivable: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v410);
      _Exit(1);
    }

    backingStore = [(HMDHomeManager *)selfCopy4 backingStore];
    v419 = [HMDHomeManager setupCoreDataUsingBackingStore:backingStore];

    v233 = [[HMDHomeManagerObjectLookup alloc] initWithHomeManager:selfCopy4];
    backingStore2 = [(HMDHomeManager *)selfCopy4 backingStore];
    [backingStore2 setLookup:v233];

    backingStore3 = [(HMDHomeManager *)selfCopy4 backingStore];
    [backingStore3 setHomeManager:selfCopy4];

    remoteAccountManager = [(HMDHomeManager *)selfCopy4 remoteAccountManager];
    [remoteAccountManager setBackingStore:selfCopy4->_backingStore];

    v237 = objc_autoreleasePoolPush();
    v238 = selfCopy4;
    v239 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v239, OS_LOG_TYPE_INFO))
    {
      v240 = HMFGetLogIdentifier();
      v241 = MEMORY[0x277CCACA8];
      HMFUptime();
      v219 = [v241 stringWithFormat:@"%.3f", v242 - v219];
      *buf = 138544898;
      *&buf[4] = v240;
      *&buf[12] = 2114;
      *&buf[14] = @"homeManagerInitStart";
      *&buf[22] = 2112;
      v444 = @"Backing store setup done";
      v445 = 2114;
      v446 = @"state";
      v447 = 2112;
      v448 = @"homeManagerLoadedBackingStore";
      v449 = 2114;
      v450 = @"duration";
      v451 = 2112;
      v452 = v219;
      _os_log_impl(&dword_229538000, v239, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
    }

    objc_autoreleasePoolPop(v237);
    mEMORY[0x277D17DE8]2 = [MEMORY[0x277D17DE8] sharedInstance];
    v245 = objc_alloc(MEMORY[0x277D17DF8]);
    v246 = MEMORY[0x277CCACA8];
    HMFUptime();
    v2192 = [v246 stringWithFormat:@"%.3f", v247 - v219];
    v249 = HMDTaggedLoggingCreateDictionary();
    v250 = [v245 initWithTag:@"homeManagerInitStart" data:{v249, @"state", @"homeManagerLoadedBackingStore", @"duration", v2192}];
    currentTagProcessorList2 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]2 submitTaggedEvent:v250 processorList:currentTagProcessorList2];

    v238->_accountActive = 1;
    [(HMDHomeManager *)v238 _registerForMessages];
    [(HMDHomeManager *)v238 __checkForBootTimeLogout];
    dataCopy = v421;
  }

  v252 = objc_alloc_init(HMDIDSServerBag);
  [(HMDHomeManager *)self setIdsServerBag:v252];

  idsServerBag = [(HMDHomeManager *)self idsServerBag];
  [idsServerBag setDelegate:self];

  if ([(HMDHomeManager *)self _configureHomes:MEMORY[0x277CBEBF8] uncommittedTransactions:transactionsCopy])
  {
    _HMFPreconditionFailure();
  }

  v254 = [HMDApplicationData alloc];
  applicationData = [dataCopy applicationData];
  dictionary8 = [applicationData dictionary];
  v257 = [(HMDApplicationData *)v254 initWithDictionary:dictionary8 parentUUID:self->_uuid];
  appData = self->_appData;
  self->_appData = v257;

  if (reloadData)
  {
    [(HMDHomeManager *)self updatePowerAssertion];
    accessories = [dataCopy accessories];
    v260 = [accessories count];

    if (v260)
    {
      accessoryBrowserInternal = [(HMDHomeManager *)self accessoryBrowserInternal];
      [accessoryBrowserInternal startDiscoveringPairedAccessories];
    }
  }

  else
  {
    [(HMDPowerManager *)self->_powerManager start];
    [(HMDHomeManager *)self updatePowerAssertion];
    [(HMDHomeManager *)self _monitorReachability];
    v262 = objc_autoreleasePoolPush();
    selfCopy5 = self;
    v264 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v264, OS_LOG_TYPE_INFO))
    {
      v265 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v265;
      _os_log_impl(&dword_229538000, v264, OS_LOG_TYPE_INFO, "%{public}@Starting the mobile asset manager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v262);
    backingStore4 = [(HMDHomeManager *)selfCopy5 backingStore];
    context = [backingStore4 context];
    v268 = [HMDMobileAssetManagerFactory makeInstanceWithContext:context];
    mobileAssetManager = selfCopy5->_mobileAssetManager;
    selfCopy5->_mobileAssetManager = v268;

    mobileAssetManager = [(HMDHomeManager *)selfCopy5 mobileAssetManager];
    v436[0] = MEMORY[0x277D85DD0];
    v436[1] = 3221225472;
    v436[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke;
    v436[3] = &unk_27868A728;
    v436[4] = selfCopy5;
    [mobileAssetManager startWithCompletion:v436];

    notificationCenter2 = [(HMDHomeManager *)selfCopy5 notificationCenter];
    [notificationCenter2 addObserver:selfCopy5 selector:sel_accountAvailabilityChanged_ name:*MEMORY[0x277CBBF00] object:0];

    v272 = +[HMDXPCMessageTransport defaultTransport];
    queue = [v272 queue];
    messageTargetUUID = [(HMDHomeManager *)selfCopy5 messageTargetUUID];
    logEventSubmitter2 = [(HMDHomeManager *)selfCopy5 logEventSubmitter];
    v276 = [HMDHomeManagerXPCClientConnectionsManagerFactory makeInstanceWithQueue:queue messageDispatcher:dispatcherCopy messageTargetUUID:messageTargetUUID accessoryBrowser:browserCopy logEventSubmitter:logEventSubmitter2];
    connectionsManager = selfCopy5->_connectionsManager;
    selfCopy5->_connectionsManager = v276;

    [(HMDHomeManagerXPCClientConnectionsManager *)selfCopy5->_connectionsManager configure];
    accessories2 = [dataCopy accessories];
    v279 = [accessories2 count] != 0;

    [(HMDAccessoryBrowser *)selfCopy5->_accessoryBrowserInternal activate:v279];
    if (isiOSDevice())
    {
      v280 = objc_alloc(MEMORY[0x277D0F920]);
      v281 = [v280 initWithTimeInterval:4 options:checkRemoteAccessTimeout];
      remoteAccessHealthMonitorTimer = selfCopy5->_remoteAccessHealthMonitorTimer;
      selfCopy5->_remoteAccessHealthMonitorTimer = v281;

      [(HMFTimer *)selfCopy5->_remoteAccessHealthMonitorTimer setDelegate:selfCopy5];
      v283 = selfCopy5->_remoteAccessHealthMonitorTimer;
      workQueue6 = [(HMDHomeManager *)selfCopy5 workQueue];
      [(HMFTimer *)v283 setDelegateQueue:workQueue6];

      [(HMFTimer *)selfCopy5->_remoteAccessHealthMonitorTimer resume];
    }
  }

  residentMesh = self->_residentMesh;
  self->_residentMesh = 0;

  v286 = +[HMDDeviceCapabilities deviceCapabilities];
  isResidentCapable = [v286 isResidentCapable];

  if (isResidentCapable)
  {
    v288 = objc_autoreleasePoolPush();
    selfCopy6 = self;
    v290 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v290, OS_LOG_TYPE_DEFAULT))
    {
      v291 = HMFGetLogIdentifier();
      [(HMDHomeManager *)selfCopy6 isResidentEnabled];
      v292 = HMFBooleanToString();
      *buf = 138543618;
      *&buf[4] = v291;
      *&buf[12] = 2112;
      *&buf[14] = v292;
      _os_log_impl(&dword_229538000, v290, OS_LOG_TYPE_DEFAULT, "%{public}@Initialize resident mesh: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v288);
    v293 = [[HMDResidentMesh alloc] initWithHomeManager:selfCopy6 residentEnabled:[(HMDHomeManager *)selfCopy6 isResidentEnabled]];
    v294 = self->_residentMesh;
    self->_residentMesh = v293;
  }

  v295 = objc_autoreleasePoolPush();
  selfCopy7 = self;
  v297 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v297, OS_LOG_TYPE_INFO))
  {
    v298 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v298;
    _os_log_impl(&dword_229538000, v297, OS_LOG_TYPE_INFO, "%{public}@Refreshing display names of the users and invites", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v295);
  [(HMDHomeManager *)selfCopy7 _handleContactStoreChanged];
  if (hasAssistantHashingKeyChanged())
  {
    v434 = 0u;
    v435 = 0u;
    v432 = 0u;
    v433 = 0u;
    homes = [(HMDHomeManager *)selfCopy7 homes];
    v300 = [homes countByEnumeratingWithState:&v432 objects:v442 count:16];
    if (v300)
    {
      v301 = v300;
      v302 = *v433;
      do
      {
        for (i = 0; i != v301; ++i)
        {
          if (*v433 != v302)
          {
            objc_enumerationMutation(homes);
          }

          [*(*(&v432 + 1) + 8 * i) resetAccessoryHashedRouteIdentifiers];
        }

        v301 = [homes countByEnumeratingWithState:&v432 objects:v442 count:16];
      }

      while (v301);
    }

    [(HMDHomeManager *)selfCopy7 assistantSyncDataChanged:@"HMDAssistantEncryptionKeyChanged"];
  }

  else
  {
    workQueue7 = [(HMDHomeManager *)selfCopy7 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_579;
    block[3] = &unk_27868A728;
    block[4] = selfCopy7;
    dispatch_async(workQueue7, block);
  }

  v429 = 0u;
  v430 = 0u;
  v427 = 0u;
  v428 = 0u;
  homes2 = [(HMDHomeManager *)selfCopy7 homes];
  v306 = [homes2 countByEnumeratingWithState:&v427 objects:v441 count:16];
  if (v306)
  {
    v307 = v306;
    v308 = *v428;
    do
    {
      for (j = 0; j != v307; ++j)
      {
        if (*v428 != v308)
        {
          objc_enumerationMutation(homes2);
        }

        [*(*(&v427 + 1) + 8 * j) updateLightProfilesSettingsWithRequiresHomeNotificationsEnabled:1];
      }

      v307 = [homes2 countByEnumeratingWithState:&v427 objects:v441 count:16];
    }

    while (v307);
  }

  mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
  v311 = [mEMORY[0x277D0F8D0] preferenceForKey:@"memoryMonitorPeriod"];
  numberValue = [v311 numberValue];

  v313 = objc_alloc(MEMORY[0x277D0F920]);
  v422 = numberValue;
  [numberValue doubleValue];
  v314 = [v313 initWithTimeInterval:12 options:?];
  [(HMDHomeManager *)selfCopy7 setMemoryMonitorLogEventTimer:v314];

  memoryMonitorLogEventTimer = [(HMDHomeManager *)selfCopy7 memoryMonitorLogEventTimer];
  [memoryMonitorLogEventTimer setDelegate:selfCopy7];

  memoryMonitorLogEventTimer2 = [(HMDHomeManager *)selfCopy7 memoryMonitorLogEventTimer];
  workQueue8 = [(HMDHomeManager *)selfCopy7 workQueue];
  [memoryMonitorLogEventTimer2 setDelegateQueue:workQueue8];

  memoryMonitorLogEventTimer3 = [(HMDHomeManager *)selfCopy7 memoryMonitorLogEventTimer];
  [memoryMonitorLogEventTimer3 resume];

  v319 = [HMDPredictionSubscriber alloc];
  workQueue9 = [(HMDHomeManager *)selfCopy7 workQueue];
  messageDispatcher2 = [(HMDHomeManager *)selfCopy7 messageDispatcher];
  v322 = [(HMDPredictionSubscriber *)v319 initWithWorkQueue:workQueue9 messageDispatcher:messageDispatcher2 notificationBackend:0];
  [(HMDHomeManager *)selfCopy7 setPredictionSubscriber:v322];

  predictionSubscriber = [(HMDHomeManager *)selfCopy7 predictionSubscriber];
  [predictionSubscriber setDataSource:selfCopy7];

  predictionSubscriber2 = [(HMDHomeManager *)selfCopy7 predictionSubscriber];
  [predictionSubscriber2 configure];

  if (selfCopy7)
  {
    metricsManager = [(HMDHomeManager *)selfCopy7 metricsManager];
    logEventDispatcher = [metricsManager logEventDispatcher];
    biomeLogEventObserver = [(HMDHomeManager *)selfCopy7 biomeLogEventObserver];
    *buf = objc_opt_class();
    *&buf[8] = objc_opt_class();
    *&buf[16] = objc_opt_class();
    v328 = [MEMORY[0x277CBEA60] arrayWithObjects:buf count:3];
    [logEventDispatcher addObserver:biomeLogEventObserver forEventClasses:v328];

    metricsManager2 = [(HMDHomeManager *)selfCopy7 metricsManager];
    logEventDispatcher2 = [metricsManager2 logEventDispatcher];
    microLocationLogEventObserver = [(HMDHomeManager *)selfCopy7 microLocationLogEventObserver];
    *buf = objc_opt_class();
    *&buf[8] = objc_opt_class();
    *&buf[16] = objc_opt_class();
    v332 = [MEMORY[0x277CBEA60] arrayWithObjects:buf count:3];
    [logEventDispatcher2 addObserver:microLocationLogEventObserver forEventClasses:v332];
  }

  [(HMDHomeManager *)selfCopy7 _notifyMetricsManagerOfConfigurationChange];
  if ([(HMDHomeManager *)selfCopy7 isResidentEnabled])
  {
    v333 = objc_autoreleasePoolPush();
    v334 = selfCopy7;
    v335 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v335, OS_LOG_TYPE_INFO))
    {
      v336 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v336;
      _os_log_impl(&dword_229538000, v335, OS_LOG_TYPE_INFO, "%{public}@Resident is enabled. Create multi user settings metric event dispatcher, and register for daily event.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v333);
    v337 = [HMDMultiUserSettingsMetricsEventDispatcher alloc];
    uuid = self->_uuid;
    metricsManager3 = [v334 metricsManager];
    logEventSubmitter3 = [metricsManager3 logEventSubmitter];
    metricsManager4 = [v334 metricsManager];
    dailyScheduler = [metricsManager4 dailyScheduler];
    v343 = [(HMDMultiUserSettingsMetricsEventDispatcher *)v337 initWithIdentifier:uuid logEventSubmitter:logEventSubmitter3 dailyScheduler:dailyScheduler];
    v344 = v334[70];
    v334[70] = v343;

    [v334[70] setDataSource:v334];
    [v334[70] registerForDailyMultiUserSettingsEvents];
  }

  v345 = objc_autoreleasePoolPush();
  v346 = [HMDAppleAccessoryPairingController alloc];
  v347 = [HMDAppleAccessoryPairingControllerDataSource alloc];
  backingStore5 = [(HMDHomeManager *)selfCopy7 backingStore];
  context2 = [backingStore5 context];
  v350 = [(HMDAppleAccessoryPairingControllerDataSource *)v347 initWithContext:context2];
  v351 = [(HMDAppleAccessoryPairingController *)v346 initWithHomeManager:selfCopy7 dataSource:v350];
  legacyAccessoryPairingController = selfCopy7->_legacyAccessoryPairingController;
  selfCopy7->_legacyAccessoryPairingController = v351;

  legacyAccessoryPairingController = [(HMDHomeManager *)selfCopy7 legacyAccessoryPairingController];
  [legacyAccessoryPairingController start];

  objc_autoreleasePoolPop(v345);
  [(HMDHomeManager *)selfCopy7 performInitialGraphLoad:v419];
  HMFUptime();
  v355 = v354;
  v356 = objc_autoreleasePoolPush();
  v357 = selfCopy7;
  v358 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v358, OS_LOG_TYPE_DEBUG))
  {
    v359 = HMFGetLogIdentifier();
    *buf = 138544386;
    *&buf[4] = v359;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v444 = @"Handling Home invitations";
    v445 = 2114;
    v446 = @"state";
    v447 = 2112;
    v448 = @"homeManagerHandlingInvites";
    _os_log_impl(&dword_229538000, v358, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v356);
  mEMORY[0x277D17DE8]3 = [MEMORY[0x277D17DE8] sharedInstance];
  v361 = objc_alloc(MEMORY[0x277D17DF8]);
  v439 = @"state";
  v440 = @"homeManagerHandlingInvites";
  v362 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v440 forKeys:&v439 count:1];
  v363 = [v361 initWithTag:@"homeManagerInitStart" data:v362];
  currentTagProcessorList3 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [mEMORY[0x277D17DE8]3 submitTaggedEvent:v363 processorList:currentTagProcessorList3];

  [(HMDHomeManager *)v357 _pruneExpiredIncomingInvitations];
  [(HMDHomeManager *)v357 _pruneExpiredHomesAwaitingAutoAccept];
  [(HMDHomeManager *)v357 _pruneExpiredHomesNotYetMigrated];
  v365 = objc_autoreleasePoolPush();
  v366 = v357;
  v367 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v367, OS_LOG_TYPE_INFO))
  {
    v368 = HMFGetLogIdentifier();
    v369 = MEMORY[0x277CCACA8];
    HMFUptime();
    v355 = [v369 stringWithFormat:@"%.3f", v370 - v355];
    *buf = 138544898;
    *&buf[4] = v368;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v444 = @"Handled Home invitations";
    v445 = 2114;
    v446 = @"state";
    v447 = 2112;
    v448 = @"homeManagerHandledInvites";
    v449 = 2114;
    v450 = @"duration";
    v451 = 2112;
    v452 = v355;
    _os_log_impl(&dword_229538000, v367, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
  }

  objc_autoreleasePoolPop(v365);
  mEMORY[0x277D17DE8]4 = [MEMORY[0x277D17DE8] sharedInstance];
  v373 = objc_alloc(MEMORY[0x277D17DF8]);
  v374 = MEMORY[0x277CCACA8];
  HMFUptime();
  v3552 = [v374 stringWithFormat:@"%.3f", v375 - v355];
  v377 = HMDTaggedLoggingCreateDictionary();
  v378 = [v373 initWithTag:@"homeManagerInitStart" data:{v377, @"state", @"homeManagerHandledInvites", @"duration", v3552}];
  currentTagProcessorList4 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [mEMORY[0x277D17DE8]4 submitTaggedEvent:v378 processorList:currentTagProcessorList4];

  [v366 _auditIDSSentInvitations];
  obj = [HMDXPCEventRouterServer alloc];
  messageTargetUUID2 = [v366 messageTargetUUID];
  v380 = *MEMORY[0x277CD01A8];
  v381 = *MEMORY[0x277CD01B0];
  messageDispatcher3 = [v366 messageDispatcher];
  workQueue10 = [v366 workQueue];
  notificationCenter3 = [v366 notificationCenter];
  registrationForwardingEventRouter = [v366 registrationForwardingEventRouter];
  memoryEventRouter = [v366 memoryEventRouter];
  lastEventStore = [v366 lastEventStore];
  v388 = [(HMDXPCEventRouterServer *)obj initWithMessageUUID:messageTargetUUID2 dataSource:v366 changeRegistrationsMessageName:v380 updateEventsMessageName:v381 messageDispatcher:messageDispatcher3 queue:workQueue10 notificationCenter:notificationCenter3 subscriptionProvider:registrationForwardingEventRouter registrationEventRouter:memoryEventRouter storeReadHandle:lastEventStore];
  [v366 setEventRouterXPCServer:v388];

  eventRouterXPCServer = [v366 eventRouterXPCServer];
  [eventRouterXPCServer configure];

  v390 = +[HMDDeviceCapabilities deviceCapabilities];
  LODWORD(workQueue10) = [v390 isResidentCapable];

  if (workQueue10)
  {
    v391 = objc_autoreleasePoolPush();
    v392 = v366;
    v393 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v393, OS_LOG_TYPE_INFO))
    {
      v394 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v394;
      _os_log_impl(&dword_229538000, v393, OS_LOG_TYPE_INFO, "%{public}@Creating siriEndPointSettingsSyncManager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v391);
    v395 = [HMDSiriEndpointSettingsSyncManager alloc];
    memoryEventRouter2 = [v392 memoryEventRouter];
    notificationCenter4 = [v392 notificationCenter];
    workQueue11 = [v392 workQueue];
    v399 = [(HMDSiriEndpointSettingsSyncManager *)v395 initWithDataSource:v392 subscriptionProvider:memoryEventRouter2 notificationCenter:notificationCenter4 workQueue:workQueue11];
    [v392 setSiriEndPointSettingsSyncManager:v399];

    siriEndPointSettingsSyncManager = [v392 siriEndPointSettingsSyncManager];
    [siriEndPointSettingsSyncManager configure];
  }

  v401 = +[HMDIDSServiceManager sharedManager];
  workQueue12 = [v366 workQueue];
  v426[0] = MEMORY[0x277D85DD0];
  v426[1] = 3221225472;
  v426[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_593;
  v426[3] = &unk_278685960;
  v426[4] = v366;
  [v401 retrieveFirewallWithQueue:workQueue12 completion:v426];

  [v366 setHasLoadedData:1];
  logAndPostNotification(@"HMDHomeManagerHomeDataLoadedNotification", v366, 0);
  [v366 autoAddWalletKeysOncePerDeviceSetup];
  [v366 updateHomeKitInUsePreferences];
  capabilitiesController = [v366 capabilitiesController];
  [capabilitiesController didFinishConfiguringHomes];

  v404 = [[HMDWidgetTimelineRefresher alloc] initWithHomeManager:v366];
  v405 = v366[74];
  v366[74] = v404;

  [v366[74] configure];
  [v366 _maybeMessageOwnersOfFrameworkSwitch];
  [v366 requestAccessoryBrowsing];
  workQueue13 = [v366 workQueue];
  v425[0] = MEMORY[0x277D85DD0];
  v425[1] = 3221225472;
  v425[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_598;
  v425[3] = &unk_27868A728;
  v425[4] = v366;
  dispatch_async(workQueue13, v425);

  pairedAccessories = [v366 pairedAccessories];
  [HMDCameraSnapshotManager cleanStaleSnapshotDirectoriesUsingCurrentAccessories:pairedAccessories];

  [v366 _maybeConfigureDuplicateUserModelChecker];
  [v366 configureSwiftExtensions];
  featuresDataSource = [v366 featuresDataSource];
  LODWORD(pairedAccessories) = [featuresDataSource isPlannerSupportEnabled];

  if (pairedAccessories)
  {
    [v366 startIndexing];
  }

  if ([v366 isDemoModeV2Active] && isDemoModeV2Locked())
  {
    [v366 deregisterForMessagesInDemoModeV2];
  }

  v409 = *MEMORY[0x277D85DE8];
}

void __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v5;
    _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_INFO, "%{public}@Finished starting the mobile asset manager", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *MEMORY[0x277D85DE8];
}

void __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_593(uint64_t a1, void *a2, void *a3)
{
  v23 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v5)
  {
    v7 = [HMDIDSFirewallManagerContext alloc];
    v8 = *(a1 + 32);
    v9 = [MEMORY[0x277CCAB98] defaultCenter];
    v10 = [*(a1 + 32) workQueue];
    v11 = [(HMDIDSFirewallManagerContext *)v7 initWithHomeManager:v8 IDSFirewall:v5 notificationCenter:v9 workQueue:v10];

    v12 = [[HMDIDSFirewallManager alloc] initWithContext:v11];
    [*(a1 + 32) setIdsFirewallManager:v12];

    v13 = [*(a1 + 32) idsFirewallManager];
    [v13 start];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = *(a1 + 32);
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v17;
      v21 = 2112;
      v22 = v6;
      _os_log_impl(&dword_229538000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to retrieve IDSFirewall with error: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)requestAccessoryBrowsing
{
  v19 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasLoadedData]&& [(HMDHomeManager *)self hasAccessoryBrowsingBeenRequested])
  {
    v3 = objc_autoreleasePoolPush();
    selfCopy = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v13 = 138543362;
      v14 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Start discovering paired accessories", &v13, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    accessoryBrowser = [(HMDHomeManager *)selfCopy accessoryBrowser];
    [accessoryBrowser startDiscoveringPairedAccessories];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    selfCopy2 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v13 = 138543874;
      v14 = v11;
      v15 = 1024;
      hasLoadedData = [(HMDHomeManager *)selfCopy2 hasLoadedData];
      v17 = 1024;
      hasAccessoryBrowsingBeenRequested = [(HMDHomeManager *)selfCopy2 hasAccessoryBrowsingBeenRequested];
      _os_log_impl(&dword_229538000, v10, OS_LOG_TYPE_INFO, "%{public}@Deferring discovery of paired accessories: hasLoadedData %d browsing requested %d", &v13, 0x18u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_migrateUniqueIdentifierPrefsIfNeeded
{
  v9[4] = *MEMORY[0x277D85DE8];
  v2 = *MEMORY[0x277CD20B8];
  v9[0] = @"kAssistantTeamIdentifier";
  v9[1] = v2;
  v9[2] = *MEMORY[0x277CD20C0];
  v9[3] = @"kUniqueDeviceIdentifierSaltkey";
  v3 = [MEMORY[0x277CBEA60] arrayWithObjects:v9 count:4];
  v4 = *MEMORY[0x277CD0030];
  v5 = *MEMORY[0x277CBF040];
  v6 = *MEMORY[0x277CBF010];
  v7 = CFPreferencesCopyMultiple(v3, *MEMORY[0x277CD0030], *MEMORY[0x277CBF040], *MEMORY[0x277CBF010]);
  if ([(__CFDictionary *)v7 count])
  {
    CFPreferencesSetMultiple(0, v3, v4, v5, v6);
    CFPreferencesSetMultiple(v7, 0, *MEMORY[0x277CD0028], v5, v6);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (id)settingsControllerForAccessoryUUID:(id)d homeUUID:(id)iD
{
  iDCopy = iD;
  dCopy = d;
  _accessoryOfCurrentDevice = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v9 = _accessoryOfCurrentDevice;
  }

  else
  {
    v9 = 0;
  }

  v10 = v9;

  uuid = [v10 uuid];
  v12 = [uuid hmf_isEqualToUUID:dCopy];

  if (v12)
  {
    home = [v10 home];
    uuid2 = [home uuid];
    v15 = [uuid2 hmf_isEqualToUUID:iDCopy];

    if (v15)
    {
      currentAccessorySettingsController = [v10 currentAccessorySettingsController];
      goto LABEL_9;
    }
  }

  else
  {
  }

  currentAccessorySettingsController = 0;
LABEL_9:

  return currentAccessorySettingsController;
}

- (id)languageListProviderForHomeUUID:(id)d
{
  v3 = [(HMDHomeManager *)self _homeWithUUID:d];
  unifiedLanguageValueListSettingDataProvider = [v3 unifiedLanguageValueListSettingDataProvider];

  return unifiedLanguageValueListSettingDataProvider;
}

- (NSString)currentEventSource
{
  appleAccountManager = [(HMDHomeManager *)self appleAccountManager];
  device = [appleAccountManager device];

  if (device)
  {
    identifier = [device identifier];
    uUIDString = [identifier UUIDString];
  }

  else
  {
    identifier = [MEMORY[0x277CCAD78] UUID];
    uUIDString2 = [identifier UUIDString];
    uUIDString = [@"DeviceNotDetermined." stringByAppendingString:uUIDString2];
  }

  return uUIDString;
}

- (void)invalidate
{
  notificationCenter = [(HMDHomeManager *)self notificationCenter];
  [notificationCenter removeObserver:self];

  messageDispatcher = [(HMDHomeManager *)self messageDispatcher];
  [messageDispatcher deregisterReceiver:self];

  if (self->_generationCounterToken != -1)
  {
    darwinNotificationProvider = [(HMDHomeManager *)self darwinNotificationProvider];
    [darwinNotificationProvider notifyCancel:self->_generationCounterToken];
  }

  [(HMDHomeManager *)self deregisterForSignificantTimeChangeNotification];
}

- (void)dealloc
{
  [(HMDHomeManager *)self invalidate];
  v3.receiver = self;
  v3.super_class = HMDHomeManager;
  [(HMDHomeManager *)&v3 dealloc];
}

- (HMDHomeManager)initWithMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry metricsManager:(id)self0 darwinNotificationProvider:(id)self1 notificationCenter:(id)self2 dataSource:(id)self3 appleAccountManager:(id)self4 remoteAccountManager:(id)self5 userDefaults:(id)self6 hmdUserDefaults:(id)self7 biomeEventManager:(id)self8 logEventSubmitter:(id)self9 widgetConfigurationReader:(id)reader configuringStateController:(id)controller diagnosticInfoController:(id)infoController currentAccessorySetupMetricDispatcher:(id)metricDispatcher uncommittedTransactions:(id)transactions featuresDataSource:(id)dataSource
{
  failedCopy = failed;
  v276[1] = *MEMORY[0x277D85DE8];
  dispatcherCopy = dispatcher;
  browserCopy = browser;
  chainCopy = chain;
  dataCopy = data;
  registryCopy = registry;
  accountRegistryCopy = accountRegistry;
  managerCopy = manager;
  providerCopy = provider;
  centerCopy = center;
  sourceCopy = source;
  accountManagerCopy = accountManager;
  remoteAccountManagerCopy = remoteAccountManager;
  defaultsCopy = defaults;
  userDefaultsCopy = userDefaults;
  eventManagerCopy = eventManager;
  submitterCopy = submitter;
  readerCopy = reader;
  controllerCopy = controller;
  infoControllerCopy = infoController;
  metricDispatcherCopy = metricDispatcher;
  transactionsCopy = transactions;
  dataSourceCopy = dataSource;
  HMFUptime();
  v29 = v28;
  v30 = [(HMDHomeManager *)self init];
  if (v30)
  {
    v31 = objc_autoreleasePoolPush();
    v223 = v30;
    v32 = v30;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138544386;
      v254 = v34;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Initializing HomeManager";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"start";
      _os_log_impl(&dword_229538000, v33, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v31);
    mEMORY[0x277D17DE8] = [MEMORY[0x277D17DE8] sharedInstance];
    v36 = objc_alloc(MEMORY[0x277D17DF8]);
    v275 = @"state";
    v276[0] = @"start";
    v37 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v276 forKeys:&v275 count:1];
    v38 = [v36 initWithTag:@"homeManagerInitStart" data:v37];
    currentTagProcessorList = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8] submitTaggedEvent:v38 processorList:currentTagProcessorList];

    [managerCopy setHomeManager:v32];
    objc_storeStrong(&v32->_metricsManager, manager);
    objc_storeStrong(&v32->_darwinNotificationProvider, provider);
    objc_storeStrong(&v32->_notificationCenter, center);
    objc_storeStrong(&v32->_appleAccountManager, accountManager);
    objc_storeStrong(&v32->_remoteAccountManager, remoteAccountManager);
    objc_storeStrong(&v32->_userDefaults, defaults);
    objc_storeStrong(&v32->_hmdUserDefaults, userDefaults);
    objc_storeStrong(&v32->_biomeEventManager, eventManager);
    objc_storeStrong(&v32->_logEventSubmitter, submitter);
    objc_storeStrong(&v32->_widgetConfigurationReader, reader);
    objc_storeStrong(&v32->_configuringStateController, controller);
    objc_storeStrong(&v32->_appleMediaAccessoryDiagnosticInfoController, infoController);
    objc_storeStrong(&v32->_currentAccessorySetupMetricDispatcher, metricDispatcher);
    objc_storeStrong(&v32->_dataSource, source);
    objc_storeStrong(&v32->_featuresDataSource, dataSource);
    v32->_hh2MigrationInProgress = 0;
    v40 = +[HMDBackingStoreSingleton sharedInstance];
    [v40 setHomeManager:v32];

    v41 = HMFGetOSLogHandle();
    logger = v32->_logger;
    v32->_logger = v41;

    dispatch_suspend(v32->_workQueue);
    [(HMDHomeManager *)v32 initHomeManagerStartup];
    v32->_generationCounterToken = -1;
    v43 = [(NSUserDefaults *)v32->_userDefaults objectForKey:@"HMDCurrentAccessorySetupStartUptimeKey"];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v44 = v43;
    }

    else
    {
      v44 = 0;
    }

    v45 = v44;

    if (v45)
    {
      [v45 doubleValue];
      v47 = v46;
      if (fabs(v46) >= 2.22044605e-16)
      {
        v48 = (clock_gettime_nsec_np(_CLOCK_MONOTONIC_RAW) / 0x3B9ACA00);
        v49 = objc_autoreleasePoolPush();
        v50 = v32;
        v51 = HMFGetOSLogHandle();
        v52 = os_log_type_enabled(v51, OS_LOG_TYPE_INFO);
        if (v47 <= v48)
        {
          if (v52)
          {
            v54 = HMFGetLogIdentifier();
            *buf = 138543618;
            v254 = v54;
            v255 = 2048;
            v256 = *&v47;
            _os_log_impl(&dword_229538000, v51, OS_LOG_TYPE_INFO, "%{public}@Loaded stored current accessory setup timestamp: %f", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v49);
          os_unfair_lock_lock_with_options();
          *&v50[36]._os_unfair_lock_opaque = v47;
          os_unfair_lock_unlock(v50 + 12);
        }

        else
        {
          if (v52)
          {
            v53 = HMFGetLogIdentifier();
            *buf = 138543362;
            v254 = v53;
            _os_log_impl(&dword_229538000, v51, OS_LOG_TYPE_INFO, "%{public}@Resetting current accessory setup timestamp to 0 as a reboot was detected", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v49);
          [(os_unfair_lock_s *)v50 setSetupStartTimestamp:0.0];
        }
      }
    }

    v55 = [(NSUserDefaults *)v32->_userDefaults objectForKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v56 = v55;
    }

    else
    {
      v56 = 0;
    }

    v57 = v56;

    if (v57)
    {
      [v57 doubleValue];
      v59 = v58;
      if (fabs(v58) >= 2.22044605e-16)
      {
        v60 = (clock_gettime_nsec_np(_CLOCK_MONOTONIC_RAW) / 0x3B9ACA00);
        v61 = objc_autoreleasePoolPush();
        v62 = v32;
        v63 = HMFGetOSLogHandle();
        v64 = os_log_type_enabled(v63, OS_LOG_TYPE_INFO);
        if (v59 <= v60)
        {
          if (v64)
          {
            v66 = HMFGetLogIdentifier();
            *buf = 138543618;
            v254 = v66;
            v255 = 2048;
            v256 = *&v59;
            _os_log_impl(&dword_229538000, v63, OS_LOG_TYPE_INFO, "%{public}@Loaded stored current accessory setup end timestamp: %f", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v61);
          os_unfair_lock_lock_with_options();
          *&v62[38]._os_unfair_lock_opaque = v59;
          os_unfair_lock_unlock(v62 + 12);
        }

        else
        {
          if (v64)
          {
            v65 = HMFGetLogIdentifier();
            *buf = 138543362;
            v254 = v65;
            _os_log_impl(&dword_229538000, v63, OS_LOG_TYPE_INFO, "%{public}@Resetting current accessory setup end timestamp to 0 as a reboot was detected", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v61);
          [(os_unfair_lock_s *)v62 setSetupEndTimestamp:0.0];
        }
      }
    }

    if ([(HMDHomeManager *)v32 firstCloudKitImportComplete])
    {
      currentAccessorySetupMetricDispatcher = [(HMDHomeManager *)v32 currentAccessorySetupMetricDispatcher];
      [currentAccessorySetupMetricDispatcher markSetupEndStage:13 error:0];
    }

    v68 = [[HMDUserCloudShareManager alloc] initWithHomeManager:v32];
    userCloudShareManager = v32->_userCloudShareManager;
    v32->_userCloudShareManager = v68;

    v70 = [[HMDMultiUserStatusController alloc] initWithQueue:v32->_workQueue delegate:v32];
    multiUserStatusController = v32->_multiUserStatusController;
    v32->_multiUserStatusController = v70;

    v72 = objc_alloc_init(HMDIDSServerBag);
    idsServerBag = v32->_idsServerBag;
    v32->_idsServerBag = v72;

    [(HMDIDSServerBag *)v32->_idsServerBag setDelegate:v32];
    featuresDataSource = [(HMDHomeManager *)v32 featuresDataSource];
    isDemoModeV2Enabled = [featuresDataSource isDemoModeV2Enabled];

    if (isDemoModeV2Enabled)
    {
      v76 = [HMDDemoModeManagerFactory demoManagerWithHomeManager:v32 messageDispatcher:dispatcherCopy];
      demoModeManager = v32->_demoModeManager;
      v32->_demoModeManager = v76;
    }

    else
    {
      v78 = objc_autoreleasePoolPush();
      v79 = v32;
      v80 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v80, OS_LOG_TYPE_INFO))
      {
        v81 = HMFGetLogIdentifier();
        v82 = demoModeV2Status();
        *buf = 138543618;
        v254 = v81;
        v255 = 2112;
        v256 = v82;
        _os_log_impl(&dword_229538000, v80, OS_LOG_TYPE_INFO, "%{public}@Demo mode V2 is disabled: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v78);
    }

    v83 = [[HMDCapabilitiesController alloc] initWithQueue:v32->_workQueue dataSource:v32];
    capabilitiesController = v32->_capabilitiesController;
    v32->_capabilitiesController = v83;

    v85 = objc_alloc_init(HMDMemoryUtilizationTracker);
    memoryTracker = v32->_memoryTracker;
    v32->_memoryTracker = v85;

    userDefaults = [(HMDHomeManager *)v32 userDefaults];
    v88 = [userDefaults stringForKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

    if (v88)
    {
      v89 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v88];
      lastRemovedCurrentAccessoryUUID = v32->_lastRemovedCurrentAccessoryUUID;
      v32->_lastRemovedCurrentAccessoryUUID = v89;
    }

    v239 = v88;
    v91 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:5.0];
    debounceHomesUpdateTimer = v32->_debounceHomesUpdateTimer;
    v32->_debounceHomesUpdateTimer = v91;

    [(HMFTimer *)v32->_debounceHomesUpdateTimer setDelegate:v32];
    v93 = v32->_debounceHomesUpdateTimer;
    workQueue = [(HMDHomeManager *)v32 workQueue];
    [(HMFTimer *)v93 setDelegateQueue:workQueue];

    mEMORY[0x277D0F8D0] = [MEMORY[0x277D0F8D0] sharedPreferences];
    v96 = [mEMORY[0x277D0F8D0] preferenceForKey:@"assistantSyncDataCoalescePeriodMilliseconds"];
    numberValue = [v96 numberValue];

    v238 = numberValue;
    [numberValue doubleValue];
    v99 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:v98 / 1000.0];
    debounceRegenerateAssistantSyncDataTimer = v32->_debounceRegenerateAssistantSyncDataTimer;
    v32->_debounceRegenerateAssistantSyncDataTimer = v99;

    [(HMFTimer *)v32->_debounceRegenerateAssistantSyncDataTimer setDelegate:v32];
    v101 = v32->_debounceRegenerateAssistantSyncDataTimer;
    workQueue2 = [(HMDHomeManager *)v32 workQueue];
    [(HMFTimer *)v101 setDelegateQueue:workQueue2];

    HMFUptime();
    v104 = v103;
    v105 = objc_autoreleasePoolPush();
    v106 = v32;
    v107 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v107, OS_LOG_TYPE_DEBUG))
    {
      v108 = HMFGetLogIdentifier();
      *buf = 138544386;
      v254 = v108;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Initialize HH2 FW switch";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerHH2FWSwitch";
      _os_log_impl(&dword_229538000, v107, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v105);
    mEMORY[0x277D17DE8]2 = [MEMORY[0x277D17DE8] sharedInstance];
    v110 = objc_alloc(MEMORY[0x277D17DF8]);
    v273 = @"state";
    v274 = @"homeManagerHH2FWSwitch";
    v111 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v274 forKeys:&v273 count:1];
    v112 = [v110 initWithTag:@"homeManagerInitStart" data:v111];
    currentTagProcessorList2 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]2 submitTaggedEvent:v112 processorList:currentTagProcessorList2];

    v114 = objc_autoreleasePoolPush();
    [(HMDHomeManager *)v106 initializeHH2FrameworkSwitch];
    v115 = +[HMDDeviceSetupManager sharedManager];
    followUpManager = [v115 followUpManager];
    [followUpManager stopAdvertising:2];

    notificationCenter = [(HMDHomeManager *)v106 notificationCenter];
    [notificationCenter addObserver:v106 selector:sel__handleHH2SentinelZonePresent_ name:@"HMDHomeManagerHH2SentinelZonePresent" object:0];

    v118 = objc_autoreleasePoolPush();
    v119 = v106;
    v120 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v120, OS_LOG_TYPE_INFO))
    {
      v121 = HMFGetLogIdentifier();
      v122 = MEMORY[0x277CCACA8];
      HMFUptime();
      v104 = [v122 stringWithFormat:@"%.3f", v123 - v104];
      *buf = 138544898;
      v254 = v121;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Initialized HH2 FW switch";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerHH2FWSwitchDone";
      v263 = 2114;
      v264 = @"duration";
      v265 = 2112;
      v266 = v104;
      _os_log_impl(&dword_229538000, v120, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
    }

    objc_autoreleasePoolPop(v118);
    mEMORY[0x277D17DE8]3 = [MEMORY[0x277D17DE8] sharedInstance];
    v126 = objc_alloc(MEMORY[0x277D17DF8]);
    v127 = MEMORY[0x277CCACA8];
    HMFUptime();
    v1042 = [v127 stringWithFormat:@"%.3f", v128 - v104];
    v130 = HMDTaggedLoggingCreateDictionary();
    v131 = [v126 initWithTag:@"homeManagerInitStart" data:{v130, @"state", @"homeManagerHH2FWSwitchDone", @"duration", v1042}];
    currentTagProcessorList3 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]3 submitTaggedEvent:v131 processorList:currentTagProcessorList3];

    objc_autoreleasePoolPop(v114);
    HMFUptime();
    v134 = v133;
    v135 = objc_autoreleasePoolPush();
    v136 = v119;
    v137 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v137, OS_LOG_TYPE_DEBUG))
    {
      v138 = HMFGetLogIdentifier();
      *buf = 138544386;
      v254 = v138;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Loading Home Manager";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerLoading";
      _os_log_impl(&dword_229538000, v137, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v135);
    mEMORY[0x277D17DE8]4 = [MEMORY[0x277D17DE8] sharedInstance];
    v140 = objc_alloc(MEMORY[0x277D17DF8]);
    v271 = @"state";
    v272 = @"homeManagerLoading";
    v141 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v272 forKeys:&v271 count:1];
    v142 = [v140 initWithTag:@"homeManagerInitStart" data:v141];
    currentTagProcessorList4 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]4 submitTaggedEvent:v142 processorList:currentTagProcessorList4];

    v144 = objc_autoreleasePoolPush();
    LOBYTE(v220) = 0;
    [(HMDHomeManager *)v136 _loadMessageDispatcher:dispatcherCopy accessoryBrowser:browserCopy messageFilterChain:chainCopy homeData:dataCopy localDataDecryptionFailed:failedCopy identityRegistry:registryCopy accountRegistry:accountRegistryCopy uncommittedTransactions:transactionsCopy reloadData:v220];
    objc_autoreleasePoolPop(v144);
    v145 = objc_autoreleasePoolPush();
    v146 = v136;
    v147 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v147, OS_LOG_TYPE_INFO))
    {
      v148 = HMFGetLogIdentifier();
      v149 = MEMORY[0x277CCACA8];
      HMFUptime();
      v134 = [v149 stringWithFormat:@"%.3f", v150 - v134];
      v152 = MEMORY[0x277CCABB0];
      homes = [(HMDHomeManager *)v146 homes];
      v154 = [v152 numberWithUnsignedInteger:{objc_msgSend(homes, "count")}];
      *buf = 138545410;
      v254 = v148;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Loaded Home Manager, resuming work queue";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerLoaded";
      v263 = 2114;
      v264 = @"duration";
      v265 = 2112;
      v266 = v134;
      v267 = 2114;
      v268 = @"homesCount";
      v269 = 2112;
      v270 = v154;
      _os_log_impl(&dword_229538000, v147, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x5Cu);
    }

    objc_autoreleasePoolPop(v145);
    mEMORY[0x277D17DE8]5 = [MEMORY[0x277D17DE8] sharedInstance];
    v156 = objc_alloc(MEMORY[0x277D17DF8]);
    v157 = MEMORY[0x277CCACA8];
    HMFUptime();
    v1342 = [v157 stringWithFormat:@"%.3f", v158 - v134];
    v160 = MEMORY[0x277CCABB0];
    homes2 = [(HMDHomeManager *)v146 homes];
    v162 = [v160 numberWithUnsignedInteger:{objc_msgSend(homes2, "count")}];
    v163 = HMDTaggedLoggingCreateDictionary();
    v164 = [v156 initWithTag:@"homeManagerInitStart" data:{v163, @"state", @"homeManagerLoaded", @"duration", v1342, @"homesCount", v162}];
    currentTagProcessorList5 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]5 submitTaggedEvent:v164 processorList:currentTagProcessorList5];

    dispatch_resume(v32->_workQueue);
    notificationCenter2 = [(HMDHomeManager *)v146 notificationCenter];
    [notificationCenter2 addObserver:v146 selector:sel_cloudHomeSettingsUpdated_ name:@"HMDAppleAccountSettingsHomeStateUpdatedNotification" object:0];

    notificationCenter3 = [(HMDHomeManager *)v146 notificationCenter];
    [notificationCenter3 addObserver:v146 selector:sel___handleDeviceCapabilitiesUpdated_ name:@"HMDDeviceCapabilitiiesUpdatedNotification" object:0];

    notificationCenter4 = [(HMDHomeManager *)v146 notificationCenter];
    appleAccountManager = [(HMDHomeManager *)v146 appleAccountManager];
    [notificationCenter4 addObserver:v146 selector:sel___handleUpdatedCurrentDevice_ name:@"HMDAppleAccountManagerDeviceUpdatedNotification" object:appleAccountManager];

    notificationCenter5 = [(HMDHomeManager *)v146 notificationCenter];
    [notificationCenter5 addObserver:v146 selector:sel__handleCurrentAccessoryRemovedNotification_ name:@"HMDHomeManagerDidRemoveCurrentAccessoryNotification" object:0];

    notificationCenter6 = [(HMDHomeManager *)v146 notificationCenter];
    [notificationCenter6 addObserver:v146 selector:sel__handleCurrentAccessoryAddedNotification_ name:@"HMDHomeManagerDidAddCurrentAccessoryNotification" object:0];

    notificationCenter7 = [(HMDHomeManager *)v146 notificationCenter];
    [notificationCenter7 addObserver:v146 selector:sel_handleHomeManagerHasFinishedStartingUp_ name:@"HMDHomeManagerHasFinishedStartingUpNotification" object:0];

    [(HMDHomeManager *)v146 registerForNPSPreferenceChanges];
    [(HMDHomeManager *)v146 checkForRemotePeers];
    [(HMDHomeManager *)v146 registerForSignificantTimeChangeNotification];
    v173 = +[HMDAppleAccountManager sharedManager];
    LODWORD(v164) = [v173 isLoggedInToPrimaryAccount];

    if (v164)
    {
      bgOpsManager = [(HMDHomeManager *)v146 bgOpsManager];
      [bgOpsManager scheduleHH2KeyRollIfNecessary];

      bgOpsManager2 = [(HMDHomeManager *)v146 bgOpsManager];
      [HMDBackgroundOperationManagerHelper makeSureToCreateBackUpOfHH2KeysIfNecessary:bgOpsManager2];
    }

    v176 = [HMDSharedUserProfilePhotoManager alloc];
    v177 = +[HMDCoreDataCloudTransform sharedInstance];
    v178 = [(HMDSharedUserProfilePhotoManager *)v176 initWithCloudTransform:v177 delegate:v146];

    [(HMDSharedUserProfilePhotoManager *)v178 configure];
    v179 = objc_autoreleasePoolPush();
    v180 = v146;
    v181 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v181, OS_LOG_TYPE_DEBUG))
    {
      v182 = HMFGetLogIdentifier();
      *buf = 138544386;
      v254 = v182;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Fetch and update PCS status";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerFetchPCS";
      _os_log_impl(&dword_229538000, v181, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v179);
    mEMORY[0x277D17DE8]6 = [MEMORY[0x277D17DE8] sharedInstance];
    v184 = objc_alloc(MEMORY[0x277D17DF8]);
    v251 = @"state";
    v252 = @"homeManagerFetchPCS";
    v185 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v252 forKeys:&v251 count:1];
    v186 = [v184 initWithTag:@"homeManagerInitStart" data:v185];
    currentTagProcessorList6 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]6 submitTaggedEvent:v186 processorList:currentTagProcessorList6];

    [(HMDHomeManager *)v180 fetchAndUpdatePCSStatus];
    v188 = objc_autoreleasePoolPush();
    v189 = v180;
    v190 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v190, OS_LOG_TYPE_INFO))
    {
      v191 = HMFGetLogIdentifier();
      *buf = 138544386;
      v254 = v191;
      v255 = 2114;
      v256 = @"homeManagerInitStart";
      v257 = 2112;
      v258 = @"Fetched and updated PCS status";
      v259 = 2114;
      v260 = @"state";
      v261 = 2112;
      v262 = @"homeManagerFetchedPCS";
      _os_log_impl(&dword_229538000, v190, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v188);
    mEMORY[0x277D17DE8]7 = [MEMORY[0x277D17DE8] sharedInstance];
    v193 = objc_alloc(MEMORY[0x277D17DF8]);
    v249 = @"state";
    v250 = @"homeManagerFetchedPCS";
    v194 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v250 forKeys:&v249 count:1];
    v195 = [v193 initWithTag:@"homeManagerInitStart" data:v194];
    currentTagProcessorList7 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [mEMORY[0x277D17DE8]7 submitTaggedEvent:v195 processorList:currentTagProcessorList7];

    v30 = v223;
  }

  v197 = objc_autoreleasePoolPush();
  v198 = v30;
  v199 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v199, OS_LOG_TYPE_INFO))
  {
    v200 = HMFGetLogIdentifier();
    v201 = MEMORY[0x277CCACA8];
    HMFUptime();
    v203 = [v201 stringWithFormat:@"%.3f", v202 - v29];
    v204 = MEMORY[0x277CCABB0];
    homes3 = [(HMDHomeManager *)v198 homes];
    v206 = [v204 numberWithUnsignedInteger:{objc_msgSend(homes3, "count")}];
    *buf = 138545410;
    v254 = v200;
    v255 = 2114;
    v256 = @"homeManagerInitDone";
    v257 = 2112;
    v258 = @"Initialized HomeManager";
    v259 = 2114;
    v260 = @"state";
    v261 = 2112;
    v262 = @"end";
    v263 = 2114;
    v264 = @"duration";
    v265 = 2112;
    v266 = v203;
    v267 = 2114;
    v268 = @"homesCount";
    v269 = 2112;
    v270 = v206;
    _os_log_impl(&dword_229538000, v199, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x5Cu);
  }

  objc_autoreleasePoolPop(v197);
  mEMORY[0x277D17DE8]8 = [MEMORY[0x277D17DE8] sharedInstance];
  v208 = objc_alloc(MEMORY[0x277D17DF8]);
  v209 = MEMORY[0x277CCACA8];
  HMFUptime();
  v211 = [v209 stringWithFormat:@"%.3f", v210 - v29];
  v212 = MEMORY[0x277CCABB0];
  homes4 = [(HMDHomeManager *)v198 homes];
  v214 = [v212 numberWithUnsignedInteger:{objc_msgSend(homes4, "count")}];
  v215 = HMDTaggedLoggingCreateDictionary();
  v216 = [v208 initWithTag:@"homeManagerInitDone" data:{v215, @"state", @"end", @"duration", v211, @"homesCount", v214}];
  currentTagProcessorList8 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [mEMORY[0x277D17DE8]8 submitTaggedEvent:v216 processorList:currentTagProcessorList8];

  v218 = *MEMORY[0x277D85DE8];
  return v198;
}

- (HMDHomeManager)initWithMessageDispatcher:(id)dispatcher accessoryBrowser:(id)browser messageFilterChain:(id)chain homeData:(id)data localDataDecryptionFailed:(BOOL)failed identityRegistry:(id)registry accountRegistry:(id)accountRegistry metricsManager:(id)self0 configuringStateController:(id)self1 diagnosticInfoController:(id)self2 currentAccessorySetupMetricDispatcher:(id)self3 uncommittedTransactions:(id)self4 featuresDataSource:(id)self5
{
  failedCopy = failed;
  sourceCopy = source;
  transactionsCopy = transactions;
  metricDispatcherCopy = metricDispatcher;
  infoControllerCopy = infoController;
  controllerCopy = controller;
  managerCopy = manager;
  accountRegistryCopy = accountRegistry;
  registryCopy = registry;
  dataCopy = data;
  chainCopy = chain;
  browserCopy = browser;
  dispatcherCopy = dispatcher;
  v44 = [[HMDHomeManagerDataSource alloc] initWithBackingStoreFactory:&__block_literal_global_255128 wifiManagerFactory:&__block_literal_global_413 threadClientFactory:0];
  v42 = objc_alloc_init(MEMORY[0x277CD19C0]);
  defaultCenter = [MEMORY[0x277CCAB98] defaultCenter];
  v39 = +[HMDAppleAccountManager sharedManager];
  v38 = +[HMDRemoteAccountManager sharedManager];
  standardUserDefaults = [MEMORY[0x277CBEBD0] standardUserDefaults];
  v25 = +[HMDUserDefaults protectedUserDefaults];
  v24 = objc_alloc_init(HMDBiomeEventManager);
  logEventSubmitter = [managerCopy logEventSubmitter];
  v22 = objc_alloc_init(HMDWidgetConfigurationReader);
  v37 = [(HMDHomeManager *)self initWithMessageDispatcher:dispatcherCopy accessoryBrowser:browserCopy messageFilterChain:chainCopy homeData:dataCopy localDataDecryptionFailed:failedCopy identityRegistry:registryCopy accountRegistry:accountRegistryCopy metricsManager:managerCopy darwinNotificationProvider:v42 notificationCenter:defaultCenter dataSource:v44 appleAccountManager:v39 remoteAccountManager:v38 userDefaults:standardUserDefaults hmdUserDefaults:v25 biomeEventManager:v24 logEventSubmitter:logEventSubmitter widgetConfigurationReader:v22 configuringStateController:controllerCopy diagnosticInfoController:infoControllerCopy currentAccessorySetupMetricDispatcher:metricDispatcherCopy uncommittedTransactions:transactionsCopy featuresDataSource:sourceCopy];

  return v37;
}

- (HMDHomeManager)init
{
  v34.receiver = self;
  v34.super_class = HMDHomeManager;
  v2 = [(HMDHomeManager *)&v34 init];
  if (v2)
  {
    v3 = dispatch_queue_attr_make_with_autorelease_frequency(0, DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM);
    v4 = dispatch_queue_create("com.apple.hmd.hmgr", v3);
    workQueue = v2->_workQueue;
    v2->_workQueue = v4;

    v6 = [objc_alloc(MEMORY[0x277D0F7A8]) initWithQueue:v2->_workQueue alwaysDispatch:1];
    workContext = v2->_workContext;
    v2->_workContext = v6;

    v2->_lock._os_unfair_lock_opaque = 0;
    v8 = objc_alloc(MEMORY[0x277CCAD78]);
    v9 = [v8 initWithUUIDString:*MEMORY[0x277CD23C8]];
    uuid = v2->_uuid;
    v2->_uuid = v9;

    array = [MEMORY[0x277CBEB18] array];
    homes = v2->_homes;
    v2->_homes = array;

    strongToStrongObjectsMapTable = [MEMORY[0x277CCAB00] strongToStrongObjectsMapTable];
    homeUUIDsByWalletKeyAssertionXPCConnection = v2->_homeUUIDsByWalletKeyAssertionXPCConnection;
    v2->_homeUUIDsByWalletKeyAssertionXPCConnection = strongToStrongObjectsMapTable;

    dictionary = [MEMORY[0x277CBEB38] dictionary];
    currentHomeConfigurations = v2->_currentHomeConfigurations;
    v2->_currentHomeConfigurations = dictionary;

    standardUserDefaults = [MEMORY[0x277CBEBD0] standardUserDefaults];
    userDefaults = v2->_userDefaults;
    v2->_userDefaults = standardUserDefaults;

    v19 = [[HMDCHIPXPCListener alloc] initWithHomeManager:v2];
    chipXPCListener = v2->_chipXPCListener;
    v2->_chipXPCListener = v19;

    v21 = objc_alloc_init(HMDFileManager);
    fileManager = v2->_fileManager;
    v2->_fileManager = v21;

    v23 = [[HMDMatterXPCListener alloc] initWithHomeManager:v2];
    matterXPCListener = v2->_matterXPCListener;
    v2->_matterXPCListener = v23;

    v25 = [[HMDWalletKeyStepUpFailureListener alloc] initWithHomeManager:v2];
    stepUpFailureListener = v2->_stepUpFailureListener;
    v2->_stepUpFailureListener = v25;

    v27 = [[HMDBackgroundOperationManager alloc] initWithHomeManager:v2];
    bgOpsManager = v2->_bgOpsManager;
    v2->_bgOpsManager = v27;

    v2->_hasAccessoryBrowsingBeenRequested = 0;
    v29 = +[HMDFMFHandlerFactory sharedHandler];
    fmfHandler = v2->_fmfHandler;
    v2->_fmfHandler = v29;

    array2 = [MEMORY[0x277CBEB18] array];
    deviceSetupSessions = v2->_deviceSetupSessions;
    v2->_deviceSetupSessions = array2;

    [(HMDHomeManager *)v2 initSwiftExtensions];
  }

  return v2;
}

+ (id)emptyModelObjectWithChangeType:(unint64_t)type homeManagerUUID:(id)d
{
  dCopy = d;
  v6 = [(HMDBackingStoreModelObject *)[HMDHomeManagerModel alloc] initWithObjectChangeType:type uuid:dCopy parentUUID:0];

  return v6;
}

+ (id)getAllBackingStoreObjects:(int64_t)objects primaryHomeUUID:(id)d cloudZone:(id)zone appData:(id)data
{
  dCopy = d;
  zoneCopy = zone;
  dataCopy = data;
  array = [MEMORY[0x277CBEB18] array];
  v13 = objc_alloc(MEMORY[0x277CCAD78]);
  v14 = [v13 initWithUUIDString:*MEMORY[0x277CD23C8]];
  v15 = [objc_opt_class() emptyModelObjectWithChangeType:1 homeManagerUUID:v14];
  if (dCopy)
  {
    uUIDString = [dCopy UUIDString];
    [v15 setPrimaryHomeUUID:uUIDString];
  }

  v17 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:zoneCopy];
  [v15 setCloudZoneInformation:v17];

  [array addObject:v15];
  if (objects >= 3 && dataCopy)
  {
    v18 = [dataCopy modelObjectWithChangeType:1];
    [array addObject:v18];
  }

  return array;
}

+ (id)allowedClassesForAccessAllowedWhenLockedArchive
{
  v10 = *MEMORY[0x277D85DE8];
  v2 = MEMORY[0x277CBEB98];
  v7 = objc_opt_class();
  v8 = objc_opt_class();
  v9 = objc_opt_class();
  v3 = [MEMORY[0x277CBEA60] arrayWithObjects:&v7 count:3];
  v4 = [v2 setWithArray:{v3, v7, v8}];

  v5 = *MEMORY[0x277D85DE8];

  return v4;
}

+ (id)remotePeerDeviceAddress:(id)address
{
  v3 = IDSCopyIDForDevice();
  if (v3)
  {
    v4 = [objc_alloc(MEMORY[0x277CCAB68]) initWithString:v3];
    [v4 replaceOccurrencesOfString:@"self-token" withString:@"token" options:1 range:{0, objc_msgSend(v4, "length")}];
  }

  else
  {
    v4 = 0;
  }

  return v4;
}

+ (id)saltForDeviceSpecificIdentifier
{
  v2 = uniqueDeviceId;
  hm_generateSHA1 = [v2 hm_generateSHA1];

  return hm_generateSHA1;
}

+ (id)createIdentifierSalt:(id)salt deviceSpecific:(BOOL)specific
{
  saltCopy = salt;
  isWatch();
  v5 = +[HMDHomeManager saltForDeviceSpecificIdentifier];
  if (v5)
  {
    v6 = [saltCopy mutableCopy];
    [v6 appendData:v5];
    hm_generateSHA1 = [v6 hm_generateSHA1];
  }

  else
  {
    hm_generateSHA1 = 0;
  }

  return hm_generateSHA1;
}

+ (id)_getIntentGroupClientIdentifierSalt
{
  v2 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:@"F28CD9BC-565D-4CA8-980A-6B1680D76593"];
  hm_convertToData = [v2 hm_convertToData];

  return hm_convertToData;
}

+ (id)deriveIntentGroupIdentifierFromBaseUUID:(id)d
{
  v3 = MEMORY[0x277CCAD78];
  dCopy = d;
  v5 = +[HMDHomeManager _getIntentGroupClientIdentifierSalt];
  v6 = [v3 hm_deriveUUIDFromBaseUUID:dCopy identifierSalt:v5];

  return v6;
}

+ (id)getUniqueDeviceIdSalt
{
  v2 = CFPreferencesCopyAppValue(@"kUniqueDeviceIdentifierSaltkey", *MEMORY[0x277CD0028]);
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  return v3;
}

+ (BOOL)doesSaveReasonNotAffectLocalData:(id)data
{
  v3 = doesSaveReasonNotAffectLocalData__onceToken;
  dataCopy = data;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonNotAffectLocalData__onceToken, &__block_literal_global_658);
  }

  v5 = [doesSaveReasonNotAffectLocalData___noLocalReason containsObject:dataCopy];

  return v5;
}

void __51__HMDHomeManager_doesSaveReasonNotAffectLocalData___block_invoke()
{
  v5[1] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = @"MetadataUpdate";
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:1];
  v2 = [v0 setWithArray:v1];
  v3 = doesSaveReasonNotAffectLocalData___noLocalReason;
  doesSaveReasonNotAffectLocalData___noLocalReason = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)shouldIgnoreExpectedConfigurationVersionUpdateForReason:(id)reason
{
  v3 = shouldIgnoreExpectedConfigurationVersionUpdateForReason__pred;
  reasonCopy = reason;
  if (v3 != -1)
  {
    dispatch_once(&shouldIgnoreExpectedConfigurationVersionUpdateForReason__pred, &__block_literal_global_656);
  }

  v5 = [shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons containsObject:reasonCopy];

  return v5;
}

void __74__HMDHomeManager_shouldIgnoreExpectedConfigurationVersionUpdateForReason___block_invoke()
{
  v5[2] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = @"userUserIDUpdated";
  v5[1] = @"userUpdateAccountIdentifier";
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:2];
  v2 = [v0 setWithArray:v1];
  v3 = shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons;
  shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)shouldIncrementGenerationCounterForReason:(id)reason
{
  v3 = shouldIncrementGenerationCounterForReason__onceToken;
  reasonCopy = reason;
  if (v3 != -1)
  {
    dispatch_once(&shouldIncrementGenerationCounterForReason__onceToken, &__block_literal_global_654);
  }

  v5 = [shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons containsObject:reasonCopy];

  return v5 ^ 1;
}

void __60__HMDHomeManager_shouldIncrementGenerationCounterForReason___block_invoke()
{
  v6[5] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v6[0] = @"HMDApplicationTerminatedSaveReason";
  v6[1] = @"kModifyCharacterisiticNotificationsRequestKey";
  v1 = *MEMORY[0x277CD2188];
  v6[2] = @"lastSyncedHomeConfigVersion";
  v6[3] = v1;
  v6[4] = *MEMORY[0x277CD21D0];
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v6 count:5];
  v3 = [v0 setWithArray:v2];
  v4 = shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons;
  shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons = v3;

  v5 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonRequireForceSyncToWatch:(id)watch
{
  v3 = doesSaveReasonRequireForceSyncToWatch__pred;
  watchCopy = watch;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonRequireForceSyncToWatch__pred, &__block_literal_global_652);
  }

  v5 = [doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons containsObject:watchCopy];

  return v5;
}

void __56__HMDHomeManager_doesSaveReasonRequireForceSyncToWatch___block_invoke()
{
  v5[1] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = *MEMORY[0x277CD12D0];
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:1];
  v2 = [v0 setWithArray:v1];
  v3 = doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons;
  doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonAffectOnlyLocalData:(id)data
{
  v3 = doesSaveReasonAffectOnlyLocalData__pred;
  dataCopy = data;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonAffectOnlyLocalData__pred, &__block_literal_global_650_255169);
  }

  v5 = [doesSaveReasonAffectOnlyLocalData___localReason containsObject:dataCopy];

  return v5;
}

void __52__HMDHomeManager_doesSaveReasonAffectOnlyLocalData___block_invoke()
{
  v8[37] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v8[0] = @"kTriggerFiredNotificationKey";
  v8[1] = @"triggerSourceInternalMessage";
  v8[2] = @"kResetConfigRequestKey";
  v8[3] = @"kModifyCharacterisiticNotificationsRequestKey";
  v8[4] = @"kCharacteristicEnableNotificationRequestKey";
  v8[5] = @"Incoming invitations updated";
  v8[6] = @"kAccessHomeInviteRequestKey";
  v8[7] = @"kDismissBulletinInternalRequestKey";
  v8[8] = @"kDismissDialogInternalRequestKey";
  v8[9] = @"kApplicationVendorIDStoreUpdate";
  v1 = *MEMORY[0x277CCFEE0];
  v8[10] = *MEMORY[0x277CD20D0];
  v8[11] = v1;
  v8[12] = *MEMORY[0x277CD2348];
  v8[13] = @"HMDApplicationTerminatedSaveReason";
  v8[14] = @"kSearchForNewAccessoriesRequestKey";
  v8[15] = @"kUpdateAccessAllowedWhenLockedRequestKey";
  v8[16] = @"kBulletinBoardNotificationUpdateNotificationKey";
  v8[17] = @"HMDBulletinBoardNotificationServiceGroupUpdatedSaveReason";
  v2 = *MEMORY[0x277CD21D0];
  v8[18] = *MEMORY[0x277CD2188];
  v8[19] = v2;
  v8[20] = @"kTransactionUpdate";
  v8[21] = @"HMDHomePresenceMonitorUpdatedReason";
  v8[22] = @"userDisplayNameUpdated";
  v8[23] = @"lastSyncedHomeConfigVersion";
  v8[24] = @"AccessoryHasSymptomsHandlerUpdated";
  v8[25] = @"Update Shared Home Source Version";
  v8[26] = @"HMDHAPAccessoryUpdateCameraProfileNotificationSettingsReason";
  v8[27] = @"HMDHAPAccessorySaveAuthMethodReason";
  v8[28] = @"Upgraded To HH2";
  v8[29] = @"HMDAccessorySoftwareUpdate";
  v3 = *MEMORY[0x277CD12D0];
  v8[30] = *MEMORY[0x277CCE9E8];
  v8[31] = v3;
  v8[32] = @"HMDHAPAccessoryWoLUpdateLocallyLabel";
  v8[33] = @"HMDHAPAccessoryUpdateHasPostedBulletinForWalletKeyOnboardingReason";
  v8[34] = @"HMDAppleMediaAccessoryWiFiMACLocalOnlyUpdateLabel";
  v8[35] = @"Add Accessory Locally";
  v8[36] = *MEMORY[0x277CD1FA8];
  v4 = [MEMORY[0x277CBEA60] arrayWithObjects:v8 count:37];
  v5 = [v0 setWithArray:v4];
  v6 = doesSaveReasonAffectOnlyLocalData___localReason;
  doesSaveReasonAffectOnlyLocalData___localReason = v5;

  v7 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonAffectHomeManager:(id)manager
{
  v3 = doesSaveReasonAffectHomeManager__pred;
  managerCopy = manager;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonAffectHomeManager__pred, &__block_literal_global_647);
  }

  v5 = [doesSaveReasonAffectHomeManager___homeManagerReason containsObject:managerCopy];

  return v5;
}

void __50__HMDHomeManager_doesSaveReasonAffectHomeManager___block_invoke()
{
  v6[23] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v1 = *MEMORY[0x277CD2508];
  v6[0] = *MEMORY[0x277CD2080];
  v6[1] = v1;
  v6[2] = *MEMORY[0x277CD2500];
  v6[3] = @"kHomeManagerUpdatedKey";
  v6[4] = @"kHomeManagerCloudZoneAddedKey";
  v6[5] = @"kHomeManagerCloudZoneRemovedKey";
  v6[6] = *MEMORY[0x277CD2670];
  v6[7] = @"kUserRemovedRequestKey";
  v6[8] = @"kUserManagementOperationAddedKey";
  v6[9] = @"kUserManagementOperationRemovedKey";
  v6[10] = @"kHomeDataSyncRequestKey";
  v6[11] = @"kHomeDataFragmentedSyncRequestKey";
  v6[12] = *MEMORY[0x277CD0360];
  v6[13] = @"MetadataUpdate";
  v6[14] = @"Object registration";
  v6[15] = @"Add Account";
  v6[16] = @"Update Devices";
  v6[17] = @"Update Handles";
  v6[18] = @"Remove Account";
  v6[19] = @"Update Device Name";
  v6[20] = @"Update Device";
  v6[21] = @"device pushback";
  v6[22] = @"accountHandle pushback";
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v6 count:23];
  v3 = [v0 setWithArray:v2];
  v4 = doesSaveReasonAffectHomeManager___homeManagerReason;
  doesSaveReasonAffectHomeManager___homeManagerReason = v3;

  v5 = *MEMORY[0x277D85DE8];
}

+ (id)convertSaveReasonToTransactionReason:(id)reason
{
  reasonCopy = reason;
  if (reasonCopy)
  {
    if (convertSaveReasonToTransactionReason__pred != -1)
    {
      dispatch_once(&convertSaveReasonToTransactionReason__pred, &__block_literal_global_645);
    }

    v4 = [convertSaveReasonToTransactionReason___reasonMap objectForKey:reasonCopy];
    v5 = v4;
    if (v4)
    {
      v6 = v4;
    }

    else
    {
      v6 = reasonCopy;
    }

    v7 = v6;
  }

  else
  {
    v7 = @"kUnknownSaveReason";
  }

  return v7;
}

void __55__HMDHomeManager_convertSaveReasonToTransactionReason___block_invoke()
{
  v4[3] = *MEMORY[0x277D85DE8];
  v3[0] = @"kRemoteUsersDeregistered";
  v3[1] = @"kAddEventTriggerRequestKey";
  v4[0] = @"kRemoveUserRequestKey";
  v4[1] = @"kAddTriggerRequestKey";
  v3[2] = @"kAddTimerTriggerRequestKey";
  v4[2] = @"kAddTriggerRequestKey";
  v0 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v4 forKeys:v3 count:3];
  v1 = convertSaveReasonToTransactionReason___reasonMap;
  convertSaveReasonToTransactionReason___reasonMap = v0;

  v2 = *MEMORY[0x277D85DE8];
}

+ (void)removeAccessoryCacheForIdentifier:(id)identifier
{
  v3 = MEMORY[0x277CCAA00];
  identifierCopy = identifier;
  defaultManager = [v3 defaultManager];
  v5 = getBLEAccessoryCachePath();
  identifierCopy = [v5 stringByAppendingFormat:@"/%@", identifierCopy];

  [defaultManager removeItemAtPath:identifierCopy error:0];
}

+ (id)getAccessoryCacheForIdentifier:(id)identifier
{
  v28 = *MEMORY[0x277D85DE8];
  identifierCopy = identifier;
  v4 = getBLEAccessoryCachePath();
  identifierCopy = [v4 stringByAppendingFormat:@"/%@", identifierCopy];

  v21 = 0;
  v6 = [MEMORY[0x277CBEA90] dataWithContentsOfFile:identifierCopy options:2 error:&v21];
  v7 = v21;
  v8 = v7;
  if (v6)
  {

    v20 = 0;
    v9 = [MEMORY[0x277CCAAC8] unarchivedObjectOfClass:objc_opt_class() fromData:v6 error:&v20];
    v8 = v20;
    if (v9)
    {
      goto LABEL_13;
    }

    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_10;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543618;
    v23 = v12;
    v24 = 2112;
    v25 = v8;
    v13 = "%{public}@Failed to unarchive accessory cache from data: %@";
    v14 = v11;
    v15 = 22;
    goto LABEL_9;
  }

  domain = [v7 domain];
  if (![domain isEqualToString:*MEMORY[0x277CCA050]])
  {

    goto LABEL_12;
  }

  code = [v8 code];

  if (code != 260)
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
LABEL_10:

      objc_autoreleasePoolPop(v10);
      goto LABEL_12;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543874;
    v23 = v12;
    v24 = 2112;
    v25 = identifierCopy;
    v26 = 2112;
    v27 = v8;
    v13 = "%{public}@Unable to load contents of cache file %@ - error %@";
    v14 = v11;
    v15 = 32;
LABEL_9:
    _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, v13, buf, v15);

    goto LABEL_10;
  }

LABEL_12:
  v9 = 0;
LABEL_13:

  v18 = *MEMORY[0x277D85DE8];

  return v9;
}

+ (void)saveAccessoryCache:(id)cache forIdentifier:(id)identifier
{
  v21 = *MEMORY[0x277D85DE8];
  cacheCopy = cache;
  identifierCopy = identifier;
  v7 = objc_autoreleasePoolPush();
  v8 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.btle-cache-save."];
  v9 = getBLEAccessoryCachePath();
  identifierCopy = [v9 stringByAppendingFormat:@"/%@", identifierCopy];

  v11 = [MEMORY[0x277CCAAB0] archivedDataWithRootObject:cacheCopy requiringSecureCoding:1 error:0];
  v12 = v11;
  if (!v11 || ([v11 writeToFile:identifierCopy atomically:1] & 1) == 0)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v18 = v15;
      v19 = 2112;
      v20 = identifierCopy;
      _os_log_impl(&dword_229538000, v14, OS_LOG_TYPE_ERROR, "%{public}@Failed caching to file: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  objc_autoreleasePoolPop(v7);
  v16 = *MEMORY[0x277D85DE8];
}

void __29__HMDHomeManager_logCategory__block_invoke()
{
  v0 = *MEMORY[0x277D0F1A8];
  v1 = HMFCreateOSLogHandle();
  v2 = logCategory__hmf_once_v15_255195;
  logCategory__hmf_once_v15_255195 = v1;
}

- (void)_handleTestHH2Migration:(id)migration
{
  v14 = *MEMORY[0x277D85DE8];
  migrationCopy = migration;
  if ((isInternalBuild() & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
    {
      v10 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_FAULT, "%{public}@Not sure how this message made it through isInternalBuild checks. DEBUG THIS!!!", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v5 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    goto LABEL_7;
  }

  v5 = -[HMDHomeManager writeMigrationRecordWithShouldSkipKeyRollOperations:forceMigrationFailureForTesting:migrateFromTestDirectory:dryRun:isAutoMigration:](self, "writeMigrationRecordWithShouldSkipKeyRollOperations:forceMigrationFailureForTesting:migrateFromTestDirectory:dryRun:isAutoMigration:", 1, 0, 1, [migrationCopy BOOLForKey:*MEMORY[0x277CD0210]], 0);
  if (v5)
  {
LABEL_7:
    [migrationCopy respondWithError:v5];
    goto LABEL_8;
  }

  [HMDResetConfigPostCleanup writePostCleanupRecordToRemoveAllCoreDataFilesWithReason:4];
  hh2FrameworkSwitch = [(HMDHomeManager *)self hh2FrameworkSwitch];
  [hh2FrameworkSwitch switchToHH2AndRelaunchHomed];

  [migrationCopy respondWithSuccess];
LABEL_8:

  v11 = *MEMORY[0x277D85DE8];
}

- (void)waitForHH2SentinelZoneToBeRemoved
{
  hh2FrameworkSwitch = [(HMDHomeManager *)self hh2FrameworkSwitch];
  [hh2FrameworkSwitch waitForHH2SentinelZoneToBeRemoved];
}

- (void)_handleSwitchSetupMode:(id)mode
{
  v33 = *MEMORY[0x277D85DE8];
  modeCopy = mode;
  if (_os_feature_enabled_impl())
  {
    v5 = *MEMORY[0x277CD0370];
    v6 = [modeCopy numberForKey:*MEMORY[0x277CD0370]];
    if (v6)
    {
      v7 = v6;
      integerValue = [v6 integerValue];
      keyExistsAndHasValidFormat[0] = 0;
      AppIntegerValue = CFPreferencesGetAppIntegerValue(@"HHTTSUMode", @"com.apple.homed", keyExistsAndHasValidFormat);
      if (keyExistsAndHasValidFormat[0])
      {
        v10 = AppIntegerValue;
      }

      else
      {
        v10 = 0;
      }

      hh2FrameworkSwitch = [(HMDHomeManager *)self hh2FrameworkSwitch];
      v12 = [hh2FrameworkSwitch switchToSetupMode:integerValue];

      if (v12)
      {
        [modeCopy respondWithSuccess];
      }

      else
      {
        v22 = objc_autoreleasePoolPush();
        selfCopy = self;
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          v25 = HMFGetLogIdentifier();
          *keyExistsAndHasValidFormat = 138543362;
          v32 = v25;
          _os_log_impl(&dword_229538000, v24, OS_LOG_TYPE_DEFAULT, "%{public}@Mode switch will result in a change do not callback message.", keyExistsAndHasValidFormat, 0xCu);
        }

        objc_autoreleasePoolPop(v22);
        v26 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{v10, v5}];
        v30 = v26;
        v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v30 forKeys:&v29 count:1];
        [modeCopy respondWithPayload:v27];
      }
    }

    else
    {
      v17 = objc_autoreleasePoolPush();
      selfCopy2 = self;
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *keyExistsAndHasValidFormat = 138543362;
        v32 = v20;
        _os_log_impl(&dword_229538000, v19, OS_LOG_TYPE_ERROR, "%{public}@No setup mode in request", keyExistsAndHasValidFormat, 0xCu);
      }

      objc_autoreleasePoolPop(v17);
      v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [modeCopy respondWithError:v21];

      v7 = 0;
    }
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    selfCopy3 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *keyExistsAndHasValidFormat = 138543362;
      v32 = v16;
      _os_log_impl(&dword_229538000, v15, OS_LOG_TYPE_ERROR, "%{public}@Setup mode is not enabled Failing", keyExistsAndHasValidFormat, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
    [modeCopy respondWithError:v7];
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchSetupMode:(id)mode
{
  v9[1] = *MEMORY[0x277D85DE8];
  v8 = *MEMORY[0x277CD0370];
  v3 = MEMORY[0x277CCABB0];
  modeCopy = mode;
  v5 = [v3 numberWithBool:1];
  v9[0] = v5;
  v6 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v9 forKeys:&v8 count:1];
  [modeCopy respondWithPayload:v6];

  v7 = *MEMORY[0x277D85DE8];
}

- (void)_registerForFrameworkSwitch
{
  v20 = *MEMORY[0x277D85DE8];
  if (isInternalBuild())
  {
    v3 = objc_autoreleasePoolPush();
    selfCopy = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v19 = v6;
      _os_log_impl(&dword_229538000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for test HH2 migration request message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    messageDispatcher = [(HMDHomeManager *)selfCopy messageDispatcher];
    v8 = *MEMORY[0x277CD03B0];
    v9 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v17 = v9;
    v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v17 count:1];
    [messageDispatcher registerForMessage:v8 receiver:selfCopy policies:v10 selector:sel__handleTestHH2Migration_];
  }

  messageDispatcher2 = [(HMDHomeManager *)self messageDispatcher];
  v12 = *MEMORY[0x277CD01E0];
  v13 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v16 = v13;
  v14 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
  [messageDispatcher2 registerForMessage:v12 receiver:self policies:v14 selector:sel__handleFetchSetupMode_];

  v15 = *MEMORY[0x277D85DE8];
}

- (void)initializeHH2FrameworkSwitch
{
  v19 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self isDemoModeV2Active])
  {
    v3 = [HMDHH2FrameworkSwitch alloc];
    demoModeDataSource = [(HMDHomeManager *)self demoModeDataSource];
    frameworkSwitchDataSource = [demoModeDataSource frameworkSwitchDataSource];
    v5 = [(HMDHH2FrameworkSwitch *)v3 initWithAutoSwitch:0 homeManager:self dataSource:frameworkSwitchDataSource callBeforeFrameworkSwitch:0];
    [(HMDHomeManager *)self setHh2FrameworkSwitch:v5];

    v6 = *MEMORY[0x277D85DE8];
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    selfCopy = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v10;
      _os_log_impl(&dword_229538000, v9, OS_LOG_TYPE_INFO, "%{public}@Initializing framework switch with auto switch enabled", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    objc_initWeak(buf, selfCopy);
    v11 = [HMDHH2FrameworkSwitch alloc];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __66__HMDHomeManager_HH2FrameworkSwitch__initializeHH2FrameworkSwitch__block_invoke;
    v15[3] = &unk_278688860;
    objc_copyWeak(&v16, buf);
    v12 = [(HMDHH2FrameworkSwitch *)v11 initWithAutoSwitch:1 homeManager:selfCopy dataSource:0 callBeforeFrameworkSwitch:v15];
    [(HMDHomeManager *)selfCopy setHh2FrameworkSwitch:v12];

    objc_destroyWeak(&v16);
    objc_destroyWeak(buf);
    v13 = *MEMORY[0x277D85DE8];
  }
}

id __66__HMDHomeManager_HH2FrameworkSwitch__initializeHH2FrameworkSwitch__block_invoke(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (!WeakRetained)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = objc_opt_class();
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = HMFGetLogIdentifier();
      v10 = 138543362;
      v11 = v5;
      _os_log_impl(&dword_229538000, v4, OS_LOG_TYPE_ERROR, "%{public}@Home manager died before framework switch completed", &v10, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    v6 = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  v7 = [MEMORY[0x277D0F7C0] futureWithNoValue];

  v8 = *MEMORY[0x277D85DE8];

  return v7;
}

@end