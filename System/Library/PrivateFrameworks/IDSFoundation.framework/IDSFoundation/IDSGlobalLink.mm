@interface IDSGlobalLink
+ (Class)getGLClassWithOptions:(id)a3;
- (BOOL)_IsExtIPDiscoveryNeeded:(sockaddr *)a3 candidatePairList:(id)a4;
- (BOOL)_addCandidate:(id)a3 isRemoteCandidate:(BOOL)a4;
- (BOOL)_findTriedCandidatePairForSession:(id)a3 wantOnlyCell:(BOOL)a4 wantOnlyNonCell:(BOOL)a5;
- (BOOL)_getPacketBufferSendInfo:(id *)a3 channelNumber:(unsigned __int16 *)a4 transport:(int64_t *)a5 glLinkProtocol:(int64_t *)a6;
- (BOOL)_getSessionParticipants:(id)a3 relaySessionID:(id)a4 options:(id)a5;
- (BOOL)_getSessionStreamInfo:(id)a3 relaySessionID:(id)a4 options:(id)a5;
- (BOOL)_glLinkProtocolIsNWLink:(int64_t)a3;
- (BOOL)_handleRemapping:(id)a3 errorCode:(unsigned __int16)a4 reconnectQUIC:(BOOL)a5;
- (BOOL)_hasActiveAllocbindFailoverTimerForSessionID:(id)a3;
- (BOOL)_hasCandidatePairInState:(unint64_t)a3 anotherState:(unint64_t)a4 relayCandidatePairsOnly:(BOOL)a5 excludeSelfAlloc:(BOOL)a6;
- (BOOL)_hasConnectedP2pLink;
- (BOOL)_hasStunRequest:(id)a3;
- (BOOL)_interfaceName:(id)a3 missingFrom:(id)a4;
- (BOOL)_isAcceptedRelaySessionForAllocationRequestID:(id)a3 acceptedRelaySessionID:(id)a4;
- (BOOL)_isCLAT46Interface:(sockaddr *)a3;
- (BOOL)_isCellularInterfaceForCandidatePair:(id)a3 localAddress:(sockaddr *)a4;
- (BOOL)_isExtIPDiscoveryDone;
- (BOOL)_isInterfaceConstrainedWithInterfaceIndex:(unsigned int)a3;
- (BOOL)_isInterfaceDelegatedWithInterfaceIndex:(unsigned int)a3;
- (BOOL)_isInterfaceExpensiveWithInterfaceIndex:(unsigned int)a3;
- (BOOL)_isNWPathFlagsChanged:(id)a3 existingPath:(unsigned __int16 *)a4;
- (BOOL)_isSessionAccepted:(id)a3;
- (BOOL)_isSharedQRSession:(id)a3;
- (BOOL)_isSlicedCellularInterfaceActive:(unsigned int)a3;
- (BOOL)_isUsingSameRATCandidatePair:(id)a3 transportScoreCard:(id)a4;
- (BOOL)_localIsQualityMetadataSupported;
- (BOOL)_processAllocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processBindingRequest:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processBindingResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processChannelDataCommandMessage:(id *)a3 remoteRelayLinkID:(unsigned __int16)a4 channelNumber:(unsigned __int16)a5 fromDeviceUniqueID:(id)a6 cbuuid:(id)a7 arrivalTime:(double)a8;
- (BOOL)_processDataIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processDiagnosticIndication:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5;
- (BOOL)_processGoAwayIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processIncomingIndicationData:(char *)a3 length:(int)a4 candidatePairToken:(id)a5 arrivalTime:(double)a6 remoteRelayLinkID:(unsigned __int16)a7;
- (BOOL)_processNWLinkAllocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processProtoPacket:(id *)a3 fromDeviceUniqueID:(id)a4 cbuuid:(id)a5 arrivalTime:(double)a6 headerOverhead:(unint64_t)a7;
- (BOOL)_processQUICDiagnosticIndication:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5;
- (BOOL)_processQUICGoAwayIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processQUICReallocIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processQUICUnallocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processReallocIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_processRemovedLocalAddressList:(id)a3;
- (BOOL)_processStunPacket:(id *)a3 fromDeviceUniqueID:(id)a4 cbuuid:(id)a5 arrivalTime:(double)a6 headerOverhead:(unint64_t)a7;
- (BOOL)_processUnallocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9;
- (BOOL)_qrLinkLimitExceededWithNewLinkType:(unsigned __int8)a3 cellularRelayLinkCount:(unsigned __int16)a4 wifiRelayLinkCount:(unsigned __int16)a5;
- (BOOL)_qrMaterialExchangePutMaterial:(id)a3 completionHandler:(id)a4;
- (BOOL)_requestSelfAllocationForInterfaceAddress:(id)a3;
- (BOOL)_sendChannelConfigRequestToQR:(id)a3;
- (BOOL)_sendInfoRequest:(id)a3 relaySessionID:(id)a4;
- (BOOL)_setupNewQRLinkIfNecessary:(id)a3;
- (BOOL)_shouldSkipCommand:(int64_t)a3 withCandidatePair:(id)a4 connectionDataCounter:(int)a5 relayInterfaceCounter:(int)a6;
- (BOOL)_shouldUseP2PTLE;
- (BOOL)_shouldUseQRTLE;
- (BOOL)_skipCommandMessage:(int64_t)a3 candidatePair:(id)a4 timeNow:(double)a5;
- (BOOL)_synthesizeNAT64ForAddress:(sockaddr *)a3 withPrefix:(id *)a4 toAddress:(sockaddr *)a5;
- (BOOL)_triggerSymptomsWithCandidatePairToken:(id)a3 subType:(id)a4 subTypeContext:(id)a5 duration:(unsigned __int16)a6;
- (BOOL)_triggerSymptomsWithType:(id)a3 subType:(id)a4 subTypeContext:(id)a5 duration:(unsigned __int16)a6;
- (BOOL)hasReachableInterface:(unint64_t)a3;
- (BOOL)isCandidatePairConstrained:(id)a3;
- (BOOL)isCandidatePairDelegated:(id)a3;
- (BOOL)link:(id)a3 didReceivePacket:(id *)a4 fromDeviceUniqueID:(id)a5 cbuuid:(id)a6;
- (BOOL)receiveNoSessionStateForCandidatePair:(id)a3 didLocalExternalAddressChange:(BOOL)a4;
- (IDSGlobalLink)initWithDeviceUniqueID:(id)a3 cbuuid:(id)a4;
- (IDSLinkDelegate)alternateDelegate;
- (IDSLinkDelegate)delegate;
- (NSString)linkTypeString;
- (char)allocateLinkID;
- (double)_startTimeForProtoRequest:(unint64_t)a3;
- (double)_startTimeForStunRequest:(id)a3;
- (id)_addSocketAndInterfaceAddress:(unint64_t)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5;
- (id)_addSocketAndInterfaceAddressWithNWLink:(BOOL)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5;
- (id)_convergeSharedSessions:(id)a3;
- (id)_convergeSharedSessionsWithoutLinkEngine:(id)a3;
- (id)_createCommandData:(int64_t)a3 options:(id)a4 candidatePair:(id)a5;
- (id)_createIDSContextBlobMaterialProto:(id)a3;
- (id)_createInterfaceAddressArray:(unint64_t)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5;
- (id)_createInterfaceAddressArrayWithNWLink:(BOOL)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5;
- (id)_ensureSessionWithSessionInfo:(id)a3 sessionInfoDict:(id)a4 localInterfacePreference:(int)a5;
- (id)_filterNonSlicedLocalCandidates:(id)a3;
- (id)_findCandidatePairWithRelaySessionID:(id)a3;
- (id)_getAllocbindReportingDataBlob:(id)a3;
- (id)_getCandidatePairsWithSessionID:(id)a3 inState:(unint64_t)a4;
- (id)_getLink:(int)a3 stunTransport:(int64_t)a4 glLinkProtocol:(int64_t)a5;
- (id)_getLocalAttribute:(id)a3;
- (id)_getRemoteAttribute:(id)a3;
- (id)_interfaceNameForInterfaceIndex:(unsigned int)a3;
- (id)_interfaceNameForInterfaceIndexIncludingVPN:(unsigned int)a3;
- (id)_linkIDsForSession:(id)a3;
- (id)_localCandidatesForRelaySession:(id)a3;
- (id)_remoteCandidatesForRelaySession:(id)a3;
- (id)_tokenForProtoRequest:(unint64_t)a3;
- (id)_translateLinkTransportTypeWhenH2Enabled:(id)a3;
- (id)_transportInterfaceToString:(int64_t)a3;
- (id)allLinkEngines;
- (id)copyLinkStatsDict;
- (id)createLinkCycleForCandidatePair:(id)a3;
- (id)generateLinkReport:(double)a3 isCurrentLink:(BOOL)a4;
- (id)interfaceNameForCandidatePair:(id)a3;
- (id)linkEngineForSessionInfo:(id)a3;
- (id)p2pLinkEngine;
- (id)tagForCandidatePair:(id)a3 glLinkProtocol:(int64_t)a4;
- (int)_getExpensiveLinkFlagsForCandidatePair:(id)a3;
- (int)_knownRemoteAvailableInterfaces;
- (int64_t)_localCapabilityFlags;
- (int64_t)_sendPacketBuffer:(id *)a3 stunTransport:(int64_t)a4 glLinkProtocol:(int64_t)a5 token:(id)a6 linkID:(char)a7 delegatedLinkID:(char)a8;
- (int64_t)_sendProtoMessage:(id)a3 candidatePair:(id)a4;
- (int64_t)_sendStunMessage:(id)a3 candidatePair:(id)a4;
- (int64_t)_sendStunMessage:(id)a3 sourceIfIndex:(int)a4 source:(const sockaddr *)a5 destination:(sockaddr *)a6 stunTransport:(int64_t)a7 glLinkProtocol:(int64_t)a8 token:(id)a9 linkID:(char)a10 delegatedLinkID:(char)a11 MTULimit:(int)a12;
- (int64_t)getAllocBindErrorCodeForSessionID:(id)a3;
- (tagIDSQRSendInfo)sendInfoForCandidatePair:(id)a3;
- (unint64_t)_prepareOutgoingChannelData:(id *)a3 arraySize:(int)a4 channelNumber:(unsigned __int16)a5 candidatePair:(id)a6 linkID:(char)a7 delegatedLinkID:(char *)a8 stunTransport:(int64_t)a9;
- (unint64_t)_sendChannelDataPacketBuffer:(id *)a3 candidatePair:(id)a4;
- (unint64_t)createAliasForParticipantID:(unint64_t)a3 salt:(id)a4 relayGroupID:(id)a5;
- (unint64_t)defaultLinkType;
- (unint64_t)headerOverhead;
- (unint64_t)participantIDForAlias:(unint64_t)a3 salt:(id)a4 relayGroupID:(id)a5;
- (unint64_t)sendPacketBuffer:(id *)a3 toDeviceUniqueID:(id)a4 cbuuid:(id)a5;
- (unint64_t)sendPacketBufferArray:(id *)a3 arraySize:(int)a4 toDeviceUniqueID:(id)a5 cbuuid:(id)a6;
- (unsigned)_getExternalIPAddressRAT:(id)a3;
- (unsigned)_getNewLinkType:(id)a3 remoteInterface:(int *)a4;
- (void)_addQRAAWDBlock:(id)a3 allocateRequestTime:(double)a4 inferredExternalRAT:(unsigned int)a5 stunTransport:(int64_t)a6 relayProviderType:(int64_t)a7 idsSessionID:(id)a8 reportingDataBlob:(id)a9 isInitiator:(BOOL)a10 serverSoftwareVersion:(id)a11;
- (void)_addStunCheckPair:(id)a3 isRemoteCandidate:(BOOL)a4 excludeLocalAddress:(sockaddr *)a5;
- (void)_attemptP2PNegotiationForSTUNMessage:(id)a3 candidatePair:(id)a4 completionHandler:(id)a5;
- (void)_buildQrExperiments;
- (void)_callDisconnectCompletionHandler:(id)a3;
- (void)_connectNWLink:(id)a3 disconnectAfterUse:(BOOL)a4 connectedHandler:(id)a5;
- (void)_connectNWTCPLink:(id)a3 disconnectAfterUse:(BOOL)a4 connectedHandler:(id)a5;
- (void)_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:(id)a3 remoteCandidate:(id)a4 glLinkProtocol:(int64_t)a5;
- (void)_connectWithSessionInfo:(id)a3 interfaceAddress:(id)a4 joinSession:(BOOL)a5 allocbindFailover:(BOOL)a6 completionHandler:(id)a7 withLocalInterfacePreference:(int)a8;
- (void)_convergeSharedSessionsWithLinkEngine:(id)a3;
- (void)_deinitialieSendInfoForCandidatePair:(id)a3;
- (void)_delayProcessingCellularInterfaces:(id)a3;
- (void)_didReceiveRequestToPurgeRegistration;
- (void)_discardAllCandidatePairs:(BOOL)a3;
- (void)_discardCandidatePairsWithOption:(BOOL)a3 isReinitiating:(BOOL)a4;
- (void)_discardNonAcceptedCandidatePairs;
- (void)_discardNonSlicedP2PCandidatePairs;
- (void)_discardSelfAllocateCandidatePairs;
- (void)_disconnectPluginConnectionsForParticipantID:(unint64_t)a3 andPurgeRegistration:(BOOL)a4;
- (void)_finishPacketLog;
- (void)_flushPacketLogTick;
- (void)_generateTransportScoreCard;
- (void)_getAndProcessDatablobsFromReceivedMaterials:(id)a3;
- (void)_getNAT64PrefixForInterface:(int)a3 interfaceName:(id)a4 completionBlock:(id)a5;
- (void)_getP2PNegotiationForCandidatePair:(id)a3 completionBlock:(id)a4;
- (void)_handleActivityTimer;
- (void)_handleAllocbindFailoverTimer:(id)a3 failoverTimerOnCandidatePair:(id)a4 onInterface:(int)a5;
- (void)_handleAllocbindFailoverTimerWithTransportScoreCards:(id)a3 failoverTimerOnCandidatePair:(id)a4 onInterface:(int)a5;
- (void)_handleDisconnect:(BOOL)a3;
- (void)_handleDisconnectTimer;
- (void)_handleNewRATChange;
- (void)_handleSelfAllocationTimeout:(id)a3;
- (void)_handle_cellular_path:(id)a3 nwEndPoind:(id)a4;
- (void)_handle_wifi_path:(id)a3 nwEndPoind:(id)a4;
- (void)_initializeSendInfoForCandidatePair:(id)a3;
- (void)_markLinkAsUsed:(id)a3;
- (void)_nominateCandidatePair:(id)a3;
- (void)_notifyCandidatePairConnected:(id)a3;
- (void)_notifyCandidatePairDisconnected:(id)a3 withReason:(unsigned __int8)a4;
- (void)_notifyDefaultUnderlyingLinkChanged:(id)a3 error:(int64_t)a4;
- (void)_notifyLinkDisconnectedWithError:(int64_t)a3 reason:(unsigned __int8)a4;
- (void)_notifyLinkEngineCandidatePairDidConnect:(id)a3;
- (void)_notifyQRSessionConnected:(id)a3;
- (void)_notifySessionInfoReceived:(id)a3 relayGroupID:(id)a4 relaySessionID:(id)a5 status:(unsigned int)a6;
- (void)_parseActiveExperiments:(id)a3;
- (void)_parseClientUUID:(id)a3;
- (void)_processCommandConnected:(id)a3 candidatePairToken:(id)a4;
- (void)_processCommandConnectionData:(id)a3 candidatePairToken:(id)a4;
- (void)_processCommandDisconnected:(id)a3 candidatePairToken:(id)a4;
- (void)_processCommandHeartbeat:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5 remoteRelayLinkID:(unsigned __int16)a6;
- (void)_processCommandNominate:(id)a3 candidatePairToken:(id)a4;
- (void)_processCommandTestPacket:(id)a3 candidatePairToken:(id)a4 remoteRelayLinkID:(unsigned __int16)a5;
- (void)_processDataOnReallocChannel:(unsigned __int16)a3 localAddress:(sockaddr *)a4 remoteAddress:(sockaddr *)a5;
- (void)_processDelayedCellularInterfaces;
- (void)_processNewLocalAddressList:(id)a3;
- (void)_processNewRemoteCandidates:(id)a3;
- (void)_processReallocChannelData:(id *)a3 channelNumber:(unsigned __int16)a4 fromDeviceUniqueID:(id)a5 cbuuid:(id)a6 arrivalTime:(double)a7;
- (void)_processRemoteCandidates:(id)a3;
- (void)_processRemoteLinkUUID:(id)a3 candidatePair:(id)a4;
- (void)_processRemovedRemoteCandidates:(id)a3;
- (void)_processXORMappedAddress:(id)a3 arrivalTime:(double)a4;
- (void)_receiveP2PNegotiationBlob:(id)a3 attemptID:(unint64_t)a4 remoteIDSConnectionID:(unsigned int)a5 remoteAVCConnectionID:(unsigned int)a6 candidatePair:(id)a7 completionHandler:(id)a8;
- (void)_removeChannelFromChannelToCandidatePair:(id)a3;
- (void)_removePacketNotificationFilter;
- (void)_removeProtoRequest:(unint64_t)a3 status:(unsigned int)a4;
- (void)_removeStunRequest:(id)a3;
- (void)_reportAWDAllocateTime;
- (void)_reportNoSessionState:(id)a3 errorCode:(unsigned __int16)a4;
- (void)_reportSessionSetupTime;
- (void)_requestNewTwoWayQRAllocation:(id)a3;
- (void)_requestNonUDPRelayAllocation:(int64_t)a3 relaySessionID:(id)a4;
- (void)_saveProtoRequest:(id)a3 token:(id)a4 path:(id)a5;
- (void)_saveStunRequest:(id)a3 startTime:(double)a4 token:(id)a5;
- (void)_schedulePacketLogFlush;
- (void)_selectStunTransport:(int64_t *)a3 andInterfaceAddress:(id *)a4 forRelaySessionID:(id)a5 preferIPv4:(BOOL)a6 wantOnlyCell:(BOOL)a7 wantOnlyNonCell:(BOOL)a8 isValidSA:(BOOL)a9;
- (void)_sendAllocbindForCandidatePair:(id)a3 session:(id)a4 glLinkProtocol:(int64_t)a5;
- (void)_sendAllocbindRequest:(id)a3 stunMessage:(id)a4 isRealloc:(BOOL)a5 inResponseToNoSessionState:(BOOL)a6;
- (void)_sendAllocbindRequestForExtIP:(id)a3 startTime:(double)a4;
- (void)_sendBindingRequest:(id)a3 stunMessage:(id)a4;
- (void)_sendChannelDataCommandMessage:(int64_t)a3 packetBuffer:(id *)a4 options:(id)a5 candidatePair:(id)a6;
- (void)_sendChannelDataCommandMessage:(int64_t)a3 packetBuffer:(id *)a4 options:(id)a5 candidatePairToken:(id)a6;
- (void)_sendCommandMessage:(int64_t)a3 stunMessage:(id)a4 options:(id)a5 candidatePair:(id)a6;
- (void)_sendCommandMessage:(int64_t)a3 stunMessage:(id)a4 options:(id)a5 candidatePairToken:(id)a6;
- (void)_sendConnectionDataWithRemovedAddressList:(id)a3;
- (void)_sendInfoRequestForCandidatePair:(id)a3 glLinkProtocol:(int64_t)a4;
- (void)_sendNowConnectionDataWithRemovedAddressList:(id)a3;
- (void)_sendQUICAllocbindRequest:(id)a3 isRealloc:(BOOL)a4 inResponseToNoSessionState:(BOOL)a5 shouldConnectLinkFirst:(BOOL)a6 isPendingInResponseToNoSessionState:(BOOL)a7;
- (void)_sendQUICUnallocbindRequest:(id)a3 reason:(unsigned __int8)a4;
- (void)_sendSKEDataToSucceededCandidatePairs;
- (void)_sendSKEDataWithSelectedCandidatePair;
- (void)_sendSessionDisconnectedCommand;
- (void)_sendSyntheticPacket:(id)a3 candidatePair:(id)a4;
- (void)_sendUnallocbindRequest:(id)a3 stunMessage:(id)a4 reason:(unsigned __int8)a5;
- (void)_sendUnallocbindRequestTimeOut:(id)a3 stunMessage:(id)a4 reason:(unsigned __int8)a5;
- (void)_setCandidatePairConnected:(id)a3;
- (void)_setChannelToCandidatePair:(id)a3 localAddress:(sockaddr *)a4 remoteAddress:(sockaddr *)a5 channelNumber:(unsigned __int16)a6;
- (void)_setFirstDefaultCandidatePair:(id)a3;
- (void)_setLinkMetricsAttributesForCandidatePair:(id)a3;
- (void)_setLinkMetricsAttributesForCandidatePair:(id)a3 linkAttributes:(id)a4;
- (void)_setRemoteGlobalLinkVersionWithCommand:(int64_t)a3 receivedRemoteVersion:(BOOL)a4 versionValue:(unsigned __int16)a5 receivedSKE:(BOOL)a6;
- (void)_setupRelayConnectionForNetworkAddressChanges;
- (void)_setupRelayConnectionForNetworkAddressChangesHelper;
- (void)_startActivityTimer;
- (void)_startAllocbindFailoverTimerOnCandidatePair:(id)a3 delay:(int)a4;
- (void)_startDisconnectTimer;
- (void)_startExtIPDiscovery;
- (void)_stopActivityTimer;
- (void)_stopAllocbindFailoverTimer:(id)a3;
- (void)_stopDisconnectTimer;
- (void)_stopProbingOnLinkID:(char)a3;
- (void)_updateAllLinks;
- (void)_updateCandidatePair:(id)a3 newLocalPort:(unsigned __int16)a4;
- (void)_updateDefaultCandidatePair:(id)a3;
- (void)_updateInterfaceAddressesWithAddList:(id)a3 removeList:(id)a4;
- (void)_updateLinkIDForPlugin:(id)a3;
- (void)_updateLinksForSession:(id)a3;
- (void)_updateNominatedCandidatePair:(id)a3;
- (void)_updateSendStatsWithResult:(unint64_t)a3 bytesSent:(int64_t)a4 packetsSent:(int)a5 linkID:(char)a6 delegatedLinkID:(char)a7 token:(id)a8 isClientData:(BOOL)a9 sendTime:(double)a10 stunTransport:(int64_t)a11 packetBuffer:(id *)a12;
- (void)candidatePair:(id)a3 didAddQREvent:(id)a4;
- (void)candidatePair:(id)a3 didReceiveGetMaterialResponse:(id)a4;
- (void)candidatePair:(id)a3 didReceiveMappedParticipantsDict:(id)a4 forLinkID:(char)a5;
- (void)candidatePair:(id)a3 didReceiveParticipantUpdate:(id)a4 status:(unsigned __int16)a5;
- (void)candidatePair:(id)a3 didReceivePluginControlEvent:(unint64_t)a4 operation:(unsigned __int8)a5 transactionID:(id)a6;
- (void)candidatePair:(id)a3 didReceivePluginRegistration:(unint64_t)a4 pluginName:(id)a5;
- (void)candidatePair:(id)a3 didReceivePluginUnregistration:(unint64_t)a4 pluginName:(id)a5;
- (void)candidatePair:(id)a3 didReceivePutMaterialIndication:(id)a4;
- (void)candidatePair:(id)a3 didReceivePutMaterialResponse:(id)a4 forTxId:(unint64_t)a5;
- (void)candidatePair:(id)a3 didReceiveSessionInfo:(id)a4 status:(unsigned int)a5;
- (void)candidatePair:(id)a3 didReceiveSessionStats:(id)a4 success:(BOOL)a5;
- (void)candidatePair:(id)a3 didReceiveStunErrorResponse:(int64_t)a4 errorCode:(unsigned __int16)a5 didLocalExternalAddressChange:(BOOL)a6;
- (void)candidatePairDidReceiveInfoResponse:(id)a3;
- (void)configureGLExperimentsWithSessionInfo:(id)a3;
- (void)connectRelayLinkFromCandidate:(id)a3 toCandidate:(id)a4 withUniqueID:(id)a5 relaySessionID:(id)a6 glLinkProtocol:(int64_t)a7 replacesLinkWithUniqueID:(id)a8;
- (void)currentCellularSignalStrength:(int *)a3 signalStrength:(int *)a4 signalGrade:(int *)a5;
- (void)dealloc;
- (void)didReceiveFirstDataOnCandidatePair:(id)a3;
- (void)disconnectIdleQUICConnectionForCandidatePair:(id)a3;
- (void)disconnectRelayLinkWithUniqueID:(id)a3 glLinkProtocol:(int64_t)a4;
- (void)disconnectWithCompletionHandler:(id)a3 isReinitiating:(BOOL)a4;
- (void)dropIPPackets:(char)a3 payloadArray:(id)a4;
- (void)flushLinkProbingStatus:(id)a3;
- (void)freeLinkID:(char)a3;
- (void)getSessionInfo:(id)a3 relaySessionID:(id)a4 requestType:(int64_t)a5 options:(id)a6;
- (void)handleCellularRATChange;
- (void)handleNetworkAddressChanges:(BOOL)a3 hasIPv6AddressChange:(BOOL)a4;
- (void)importLinkEngineQualityMeasurementDelta:(id)a3 sourceName:(id)a4 completionHandler:(id)a5;
- (void)importQualityMeasurementDelta:(id)a3 sourceName:(id)a4 completionHandler:(id)a5;
- (void)invalidate;
- (void)link:(id)a3 pathMTUDidChange:(unsigned __int16)a4 connectionInfo:(id)a5;
- (void)linkEngineDidRemoveLinkWithUniqueID:(id)a3;
- (void)linkTransactionIDMismatchDetected:(id)a3;
- (void)linksQualityDeltaSince:(id)a3 completionHandler:(id)a4;
- (void)qrMaterialExchangePutMaterial:(id)a3 completionHandler:(id)a4;
- (void)queryLinkProbingStatus:(id)a3;
- (void)receiveBlockedIndicationWithReason:(unsigned int)a3;
- (void)receiveErrorIndicationWithCode:(unsigned int)a3;
- (void)receiveIdleClientErrorForCandidatePair:(id)a3;
- (void)receiveKeyMaterials:(id)a3;
- (void)reconnectRelayLinkWithUniqueID:(id)a3 glLinkProtocol:(int64_t)a4;
- (void)registerP2PCandidatePairWithLinkEngine:(id)a3;
- (void)registerPluginWithOptions:(id)a3 relayGroupID:(id)a4;
- (void)reportLinkEvent:(id)a3 linkID:(unsigned __int8)a4;
- (void)requestChildConnectionIDForLinkID:(char)a3 relayGroupID:(id)a4;
- (void)requestMaterialsForSession:(id)a3 participantIDs:(id)a4 materialType:(int)a5;
- (void)requestPathMTUEvaluationForLinkID:(char)a3;
- (void)sendAllocbindRequest:(id)a3 isRealloc:(BOOL)a4 inResponseToNoSessionState:(BOOL)a5 reconnectQUIC:(BOOL)a6;
- (void)sendConnectedLinkInfoToAVC;
- (void)sendStatsRequest:(id)a3;
- (void)sendStatsRequestForClient:(id)a3;
- (void)sendTestPacketChannelDataMessage:(id)a3 candidatePair:(id)a4;
- (void)sendTestPacketCommandMessage:(id)a3 candidatePair:(id)a4;
- (void)setAcceptedRelaySession:(id)a3 options:(id)a4;
- (void)setClientUniquePID:(unint64_t)a3;
- (void)setForceTCPFallbackOnCell:(BOOL)a3;
- (void)setForceTCPFallbackOnWiFi:(BOOL)a3;
- (void)setLinkSelectionStrategy:(id)a3;
- (void)setPacketNotificationFilter:(char)a3 uniqueTag:(unsigned int)a4 isEnabled:(BOOL)a5;
- (void)setReceivedRemoteDeviceVersion:(BOOL)a3;
- (void)setRemoteDeviceVersion:(unsigned int)a3;
- (void)setUpP2PQUICPodConnectionsForCandidatePair:(id)a3 attemptID:(unint64_t)a4 completionHandler:(id)a5;
- (void)setWiFiAssistState:(BOOL)a3;
- (void)startLinkProbing:(id)a3;
- (void)startNewAllocationFromInterface:(int)a3 toInterface:(int)a4;
- (void)startWithOptions:(id)a3;
- (void)stopKeepAlive:(id)a3;
- (void)stopLinkProbing:(id)a3;
- (void)updateProtocolQualityOfService:(char)a3 isGood:(BOOL)a4;
- (void)updateSessionParticipants:(id)a3 relaySessionID:(id)a4 participants:(id)a5;
@end

@implementation IDSGlobalLink

- (IDSGlobalLink)initWithDeviceUniqueID:(id)a3 cbuuid:(id)a4
{
  v93 = *MEMORY[0x1E69E9840];
  v74 = a3;
  v75 = a4;
  v85.receiver = self;
  v85.super_class = IDSGlobalLink;
  v78 = [(IDSGlobalLink *)&v85 init];
  if (v78)
  {
    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7B6A940;
    aBlock[3] = &unk_1E77E0B20;
    v7 = v78;
    v84 = v7;
    v77 = _Block_copy(aBlock);
    objc_storeStrong(&v7->_deviceUniqueID, a3);
    objc_storeStrong(&v7->_cbuuid, a4);
    v8 = [[IDSUDPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    udpLink = v7->_udpLink;
    v7->_udpLink = v8;

    [(IDSUDPLink *)v7->_udpLink setDelegate:v7];
    v10 = [[IDSUDPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    udpLinkv6 = v7->_udpLinkv6;
    v7->_udpLinkv6 = v10;

    [(IDSUDPLink *)v7->_udpLinkv6 setDelegate:v7];
    v12 = [[IDSTCPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid isSSL:0 getPacketLength:v77];
    tcpLink = v7->_tcpLink;
    v7->_tcpLink = v12;

    [(IDSTCPLink *)v7->_tcpLink setDelegate:v7];
    v14 = [[IDSTCPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid isSSL:1 getPacketLength:v77];
    tcpSSLLink = v7->_tcpSSLLink;
    v7->_tcpSSLLink = v14;

    [(IDSTCPLink *)v7->_tcpSSLLink setDelegate:v7];
    v16 = [[IDSNWLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    nwLink = v7->_nwLink;
    v7->_nwLink = v16;

    [(IDSNWLink *)v7->_nwLink setDelegate:v7];
    v7->_previousReportTime = ids_monotonic_time();
    v18 = +[IDSServerBag sharedInstance];
    v19 = [v18 objectForKey:@"ids-fallback-to-tcp-first"];
    v7->_shouldFallbackToTCPFirst = [v19 BOOLValue];

    v20 = +[IDSServerBag sharedInstance];
    v21 = [v20 objectForKey:@"ids-disable-pure-link-feature"];
    v7->_disablePureLinkFeature = [v21 BOOLValue];

    v22 = +[IDSServerBag sharedInstance];
    v73 = [v22 objectForKey:@"ids-expensive-quality-metrics-portion" ofClass:objc_opt_class()];

    if (v73)
    {
      [v73 floatValue];
      v24 = v23;
    }

    else
    {
      v24 = 0.1;
    }

    v25 = [MEMORY[0x1E69A60F0] sharedInstance];
    v26 = [v25 isInternalInstall];

    if (v26)
    {
      v27 = arc4random() < (v24 * 4294967300.0);
    }

    else
    {
      v27 = 0;
    }

    v7->_recordExpensiveQualityMetrics = IMGetDomainBoolForKeyWithDefaultValue();
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      if (v7->_recordExpensiveQualityMetrics)
      {
        v29 = @"YES";
      }

      else
      {
        v29 = @"NO";
      }

      *buf = 138412802;
      v88 = v29;
      if (v27)
      {
        v30 = @"YES";
      }

      else
      {
        v30 = @"NO";
      }

      v89 = 2112;
      v90 = v30;
      v91 = 2048;
      v92 = v24;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v31 = v7->_recordExpensiveQualityMetrics ? @"YES" : @"NO";
      v32 = v27 ? @"YES" : @"NO";
      v72 = v24;
      v69 = v31;
      v71 = v32;
      _IDSLogTransport(@"GL", @"IDS", @"initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)");
      if (_IDSShouldLog())
      {
        if (v7->_recordExpensiveQualityMetrics)
        {
          v33 = @"YES";
        }

        else
        {
          v33 = @"NO";
        }

        v72 = v24;
        v69 = v33;
        v71 = v32;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)");
      }
    }

    v34 = [MEMORY[0x1E695DF90] dictionary];
    debugDelayByTag = v7->_debugDelayByTag;
    v7->_debugDelayByTag = v34;

    v76 = MEMORY[0x1AC562F80](@"com.apple.ids", @"glDelay");
    if (v76)
    {
      v36 = [v76 componentsSeparatedByString:{@", "}];
      v81 = 0u;
      v82 = 0u;
      v79 = 0u;
      v80 = 0u;
      v37 = [v36 countByEnumeratingWithState:&v79 objects:v86 count:16];
      if (v37)
      {
        v38 = *v80;
        do
        {
          for (i = 0; i != v37; ++i)
          {
            if (*v80 != v38)
            {
              objc_enumerationMutation(v36);
            }

            v40 = [*(*(&v79 + 1) + 8 * i) componentsSeparatedByString:@"="];
            if ([v40 count])
            {
              v41 = [v40 objectAtIndexedSubscript:0];
              v42 = -1.0;
              if ([v40 count] >= 2)
              {
                v43 = [v40 objectAtIndexedSubscript:1];
                [v43 doubleValue];
                v42 = v44;
              }

              v45 = [MEMORY[0x1E696AD98] numberWithDouble:v42];
              [(NSMutableDictionary *)v7->_debugDelayByTag setObject:v45 forKeyedSubscript:v41];
            }
          }

          v37 = [v36 countByEnumeratingWithState:&v79 objects:v86 count:16];
        }

        while (v37);
      }
    }

    IDSSimpleUInt16List_Init(&v7->_channelNumberList, 16);
    IDSSimpleUInt16List_Init(&v7->_reallocChannelList, 16);
    v7->_natMappingTimeout = 35.0;
    v7->_nat64PrefixCache = IDSNAT64PrefixCacheCreate();
    IDSQRSendInfoList_Init(&v7->_sendInfoList, 4);
    v7->_remoteGlobalLinkVersion = -1;
    v46 = objc_alloc_init(MEMORY[0x1E695DF70]);
    activeProbingLinkIDs = v7->_activeProbingLinkIDs;
    v7->_activeProbingLinkIDs = v46;

    v48 = objc_alloc_init(MEMORY[0x1E695DF90]);
    pluginParticipantIDs = v7->_pluginParticipantIDs;
    v7->_pluginParticipantIDs = v48;

    v50 = objc_alloc_init(MEMORY[0x1E695DF90]);
    pluginNameToPluginOptionsDict = v7->_pluginNameToPluginOptionsDict;
    v7->_pluginNameToPluginOptionsDict = v50;

    v52 = objc_alloc_init(MEMORY[0x1E695DF90]);
    putMaterialReqTxIdToCompletionBlock = v7->_putMaterialReqTxIdToCompletionBlock;
    v7->_putMaterialReqTxIdToCompletionBlock = v52;

    v54 = [MEMORY[0x1E695DF70] array];
    unusedLinkIDs = v7->_unusedLinkIDs;
    v7->_unusedLinkIDs = v54;

    v56 = IMGetDomainIntForKey();
    if (v56 < 1)
    {
      v56 = 127;
    }

    v7->_maxLinkID = v56;
    v57 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      maxLinkID = v7->_maxLinkID;
      *buf = 67109120;
      LODWORD(v88) = maxLinkID;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "initWithDeviceUniqueID: setting max link ID to %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v70 = v7->_maxLinkID;
        _IDSLogTransport(@"GL", @"IDS", @"initWithDeviceUniqueID: setting max link ID to %d");
        if (_IDSShouldLog())
        {
          v70 = v7->_maxLinkID;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"initWithDeviceUniqueID: setting max link ID to %d");
        }
      }
    }

    v59 = [MEMORY[0x1E695DFA8] set];
    usedLocalConnectionIDs = v7->_usedLocalConnectionIDs;
    v7->_usedLocalConnectionIDs = v59;

    v61 = [MEMORY[0x1E695DFA8] set];
    usedLinks = v7->_usedLinks;
    v7->_usedLinks = v61;

    v63 = [MEMORY[0x1E695DF90] dictionary];
    sessionsByID = v7->_sessionsByID;
    v7->_sessionsByID = v63;

    v65 = [MEMORY[0x1E695DF90] dictionary];
    linkEngineIDToCandidatePair = v7->_linkEngineIDToCandidatePair;
    v7->_linkEngineIDToCandidatePair = v65;

    v67 = _os_feature_enabled_impl();
    v7->_shouldUsePathMTUDiscovery = sub_1A7B69448("PathMTUDiscovery", v67);
  }

  return v78;
}

- (void)dealloc
{
  v7 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v6 = self;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "Dealloc IDSGlobalLink %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"Dealloc IDSGlobalLink %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Dealloc IDSGlobalLink %@.");
      }
    }
  }

  IDSSimpleUInt16List_Destroy(&self->_channelNumberList.listSize);
  IDSSimpleUInt16List_Destroy(&self->_reallocChannelList.listSize);
  IDSNAT64PrefixCacheDestroy(self->_nat64PrefixCache);
  IDSQRSendInfoList_Destroy(self->_sendInfoList);
  self->_cellularSlicingFlags = 0;
  v4.receiver = self;
  v4.super_class = IDSGlobalLink;
  [(IDSGlobalLink *)&v4 dealloc];
}

- (void)invalidate
{
  v84 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v83 = self;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "Invalidate IDSGlobalLink %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v69 = self;
      _IDSLogTransport(@"GL", @"IDS", @"Invalidate IDSGlobalLink %@.");
      if (_IDSShouldLog())
      {
        v69 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Invalidate IDSGlobalLink %@.");
      }
    }
  }

  [(IDSUDPLink *)self->_udpLink invalidate];
  [(IDSUDPLink *)self->_udpLinkv6 invalidate];
  [(IDSTCPLink *)self->_tcpLink invalidate];
  [(IDSTCPLink *)self->_tcpSSLLink invalidate];
  [(IDSNWLink *)self->_nwLink invalidate];
  [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0];
  quicMaterialExchangeProvider = self->_quicMaterialExchangeProvider;
  if (quicMaterialExchangeProvider)
  {
    [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider invalidate];
    v5 = self->_quicMaterialExchangeProvider;
  }

  else
  {
    v5 = 0;
  }

  self->_quicMaterialExchangeProvider = 0;

  [(NSMutableDictionary *)self->_tokenToCandidatePairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA2E0];
  if (self->_maxLinkID >= 1)
  {
    v6 = 0;
    candidatePairs = self->_candidatePairs;
    do
    {
      v8 = candidatePairs[v6];
      [(IDSStunCandidatePair *)v8 invalidate];
      v9 = candidatePairs[v6];
      candidatePairs[v6] = 0;

      ++v6;
    }

    while (v6 < self->_maxLinkID);
  }

  [(NSMutableDictionary *)self->_channelToCandidatePairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA300];
  [(NSMutableDictionary *)self->_tokenToStunCheckPairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA320];
  tokenToCandidatePairs = self->_tokenToCandidatePairs;
  self->_tokenToCandidatePairs = 0;

  channelToCandidatePairs = self->_channelToCandidatePairs;
  self->_channelToCandidatePairs = 0;

  tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
  self->_tokenToStunCheckPairs = 0;

  reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
  self->_reallocNewCandidatePairToOldCandidatePair = 0;

  retryCountPerLinkType = self->_retryCountPerLinkType;
  self->_retryCountPerLinkType = 0;

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  self->_transactionIDToRequestMetadata = 0;

  startTimeToStunReqID = self->_startTimeToStunReqID;
  self->_startTimeToStunReqID = 0;

  tokenToStunReqID = self->_tokenToStunReqID;
  self->_tokenToStunReqID = 0;

  tokenToReallocBlocks = self->_tokenToReallocBlocks;
  self->_tokenToReallocBlocks = 0;

  localCandidateList = self->_localCandidateList;
  self->_localCandidateList = 0;

  remoteCandidateList = self->_remoteCandidateList;
  self->_remoteCandidateList = 0;

  nonAcceptedQRSessions = self->_nonAcceptedQRSessions;
  self->_nonAcceptedQRSessions = 0;

  delayedCellInterfaces = self->_delayedCellInterfaces;
  self->_delayedCellInterfaces = 0;

  allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  self->_allocateTimeReportBlocks = 0;

  qraBlocks = self->_qraBlocks;
  self->_qraBlocks = 0;

  selfAllocateRequestIDs = self->_selfAllocateRequestIDs;
  self->_selfAllocateRequestIDs = 0;

  connectReadyHandler = self->_connectReadyHandler;
  self->_connectReadyHandler = 0;

  connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
  self->_connectingCandidatePairSessionInfo = 0;

  unallocbindRequestToReason = self->_unallocbindRequestToReason;
  self->_unallocbindRequestToReason = 0;

  connectedLinkIDs = self->_connectedLinkIDs;
  self->_connectedLinkIDs = 0;

  activeProbingLinkIDs = self->_activeProbingLinkIDs;
  self->_activeProbingLinkIDs = 0;

  pluginParticipantIDs = self->_pluginParticipantIDs;
  self->_pluginParticipantIDs = 0;

  pluginNameToPluginOptionsDict = self->_pluginNameToPluginOptionsDict;
  self->_pluginNameToPluginOptionsDict = 0;

  linkIDToStatsData = self->_linkIDToStatsData;
  self->_linkIDToStatsData = 0;

  putMaterialReqTxIdToCompletionBlock = self->_putMaterialReqTxIdToCompletionBlock;
  self->_putMaterialReqTxIdToCompletionBlock = 0;

  p2pNegotiatorProvider = self->_p2pNegotiatorProvider;
  self->_p2pNegotiatorProvider = 0;

  linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
  self->_linkIDToReorderedPackets = 0;

  linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
  self->_linkIDToRequestTimeStampAndRTT = 0;

  linkIDToHBCounter = self->_linkIDToHBCounter;
  self->_linkIDToHBCounter = 0;

  usedLinks = self->_usedLinks;
  self->_usedLinks = 0;

  avcDataBlob = self->_avcDataBlob;
  self->_avcDataBlob = 0;

  QRServerDataBlob = self->_QRServerDataBlob;
  self->_QRServerDataBlob = 0;

  [(IDSGlobalLink *)self _stopDisconnectTimer];
  [(IDSGlobalLink *)self _stopActivityTimer];
  nw_path_evaluator_cancel();
  wifiPathEvaluator = self->_wifiPathEvaluator;
  self->_wifiPathEvaluator = 0;

  nw_path_evaluator_cancel();
  cellularPathEvaluator = self->_cellularPathEvaluator;
  self->_cellularPathEvaluator = 0;

  self->_remoteDeviceVersion = 0;
  v44 = +[IDSCellularLinkMonitor sharedInstance];
  [v44 setRemoteDeviceVersion:self->_remoteDeviceVersion];

  disconnectCompletionHandler = self->_disconnectCompletionHandler;
  if (disconnectCompletionHandler)
  {
    v46 = _Block_copy(disconnectCompletionHandler);
    v47 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7B6B30C;
    block[3] = &unk_1E77E0B48;
    v79 = v46;
    v48 = v46;
    v49 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
    dispatch_async(v47, v49);

    v50 = self->_disconnectCompletionHandler;
  }

  else
  {
    v50 = 0;
  }

  self->_disconnectCompletionHandler = 0;

  qualityMeasurer = self->_qualityMeasurer;
  self->_qualityMeasurer = 0;

  packetLog = self->_packetLog;
  self->_packetLog = 0;

  v76 = 0u;
  v77 = 0u;
  v74 = 0u;
  v75 = 0u;
  v53 = self->_sessionsByID;
  v54 = [(NSMutableDictionary *)v53 countByEnumeratingWithState:&v74 objects:v81 count:16];
  if (v54)
  {
    v55 = *v75;
    do
    {
      v56 = 0;
      do
      {
        if (*v75 != v55)
        {
          objc_enumerationMutation(v53);
        }

        v57 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v74 + 1) + 8 * v56)];
        v58 = [v57 linkEngine];
        [v58 invalidate];

        v59 = [v57 linkEngine];
        [v59 unregisterEngine];

        ++v56;
      }

      while (v54 != v56);
      v54 = [(NSMutableDictionary *)v53 countByEnumeratingWithState:&v74 objects:v81 count:16];
    }

    while (v54);
  }

  p2pLinkEngine = self->_p2pLinkEngine;
  if (p2pLinkEngine)
  {
    [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine setAllowOngoingTasks:0];
    [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine invalidate];
    [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine unregisterEngine];
    v61 = self->_p2pLinkEngine;
    self->_p2pLinkEngine = 0;
  }

  if (self->_useLinkSelection)
  {
    packetDeduplicator = self->_packetDeduplicator;
    self->_packetDeduplicator = 0;
  }

  v72 = 0u;
  v73 = 0u;
  v70 = 0u;
  v71 = 0u;
  v63 = [(NSMutableDictionary *)self->_sessionsByID allValues];
  v64 = [v63 countByEnumeratingWithState:&v70 objects:v80 count:16];
  if (v64)
  {
    v65 = *v71;
    do
    {
      v66 = 0;
      do
      {
        if (*v71 != v65)
        {
          objc_enumerationMutation(v63);
        }

        [*(*(&v70 + 1) + 8 * v66++) invalidate];
      }

      while (v64 != v66);
      v64 = [v63 countByEnumeratingWithState:&v70 objects:v80 count:16];
    }

    while (v64);
  }

  sessionsByID = self->_sessionsByID;
  self->_sessionsByID = 0;

  linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
  self->_linkEngineIDToCandidatePair = 0;
}

- (id)_getLink:(int)a3 stunTransport:(int64_t)a4 glLinkProtocol:(int64_t)a5
{
  if (a5)
  {
    v5 = a5 & 0xF0;
    v6 = 48;
    if (v5 != 16 && v5 != 32)
    {
      if (v5 == 48)
      {
        v6 = 40;
      }

      else if ((a5 & 0xF) == 1)
      {
        v9 = 24;
        if (a3 == 2)
        {
          v9 = 16;
        }

        v6 = 48;
        if (!self->_QUICForQREnabled)
        {
          v6 = v9;
        }
      }

      else
      {
        v6 = 32;
      }
    }

    return *(&self->super.isa + v6);
  }

  if (a4 == 4)
  {
    v7 = !self->_H2FallbackEnabled;
    v6 = 40;
    v8 = 32;
LABEL_15:
    if (!v7)
    {
      v6 = v8;
    }

    return *(&self->super.isa + v6);
  }

  if (a4 == 3)
  {
    v7 = !self->_H2FallbackEnabled;
    v6 = 32;
    v8 = 48;
    goto LABEL_15;
  }

  v10 = 24;
  if (a3 == 2)
  {
    v10 = 16;
  }

  if (self->_QUICForQREnabled)
  {
    v6 = 48;
  }

  else
  {
    v6 = v10;
  }

  return *(&self->super.isa + v6);
}

- (void)_callDisconnectCompletionHandler:(id)a3
{
  v23 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = _Block_copy(self->_disconnectCompletionHandler);
    *buf = 134218242;
    v20 = v6;
    v21 = 2112;
    v22 = v4;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "call disconnect completion handler %p error:%@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v14 = _Block_copy(self->_disconnectCompletionHandler);
      _IDSLogTransport(@"GL", @"IDS", @"call disconnect completion handler %p error:%@");

      if (_IDSShouldLog())
      {
        v15 = _Block_copy(self->_disconnectCompletionHandler);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"call disconnect completion handler %p error:%@");
      }
    }
  }

  v7 = _Block_copy(self->_disconnectCompletionHandler);
  if (v7)
  {
    v8 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7B6B66C;
    block[3] = &unk_1E77DD0F0;
    v18 = v7;
    v17 = v4;
    v9 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
    dispatch_async(v8, v9);

    disconnectCompletionHandler = self->_disconnectCompletionHandler;
    self->_disconnectCompletionHandler = 0;

    v11 = v18;
LABEL_11:

    goto LABEL_12;
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v13 = objc_opt_respondsToSelector();

  if (v13)
  {
    v11 = objc_loadWeakRetained(&self->_delegate);
    [v11 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
    goto LABEL_11;
  }

LABEL_12:
}

- (id)_createInterfaceAddressArray:(unint64_t)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5
{
  v5 = a5;
  v6 = a4;
  v33 = *MEMORY[0x1E69E9840];
  v9 = 24;
  if (!a3)
  {
    v9 = 16;
  }

  v10 = *(&self->super.isa + v9);
  if (!self->_startPort)
  {
    goto LABEL_23;
  }

  v11 = self->_startPort + LOWORD(self->_portRange) - 1;
  v12 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    startPort = self->_startPort;
    *buf = 67109632;
    *v32 = startPort;
    *&v32[4] = 1024;
    *&v32[6] = v11;
    *&v32[10] = 1024;
    *&v32[12] = a3;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "use port range [%u, %u] for IPVersion %d.", buf, 0x14u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
  {
    v29 = v11;
    v30 = a3;
    v28 = self->_startPort;
    _IDSLogV(0, @"IDSFoundation", @"GL", @"use port range [%u, %u] for IPVersion %d.");
  }

  v14 = self->_startPort;
  if (v14 >= v11)
  {
LABEL_12:
    [v10 setPort:{0, v28}];
    [v10 setCellularPort:0];
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = self->_startPort;
      v19 = "IPv6";
      *buf = 67109634;
      if (!a3)
      {
        v19 = "IPv4";
      }

      *v32 = v18;
      *&v32[4] = 1024;
      *&v32[6] = v11;
      *&v32[10] = 2080;
      *&v32[12] = v19;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "all tries failed to bind port range [%u,%u] for %s, trying random port.", buf, 0x18u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v20 = a3 ? "IPv6" : "IPv4";
      v29 = v11;
      v30 = v20;
      v28 = self->_startPort;
      _IDSLogTransport(@"GL", @"IDS", @"all tries failed to bind port range [%u,%u] for %s, trying random port.");
      if (_IDSShouldLog())
      {
        v29 = v11;
        v30 = v20;
        v28 = self->_startPort;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"all tries failed to bind port range [%u,%u] for %s, trying random port.");
      }
    }

LABEL_23:
    v16 = [v10 newSocketWithIPVersion:a3 wantsAWDL:0 wantsWiFi:v6 wantsCellular:v5 clientUUID:{self->_clientUUID, v28, v29, v30}];
    if (v16)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        v22 = "IPv6";
        if (!a3)
        {
          v22 = "IPv4";
        }

        *buf = 136315138;
        *v32 = v22;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "bind to random port succeeded for %s.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"bind to random port succeeded for %s.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to random port succeeded for %s.");
          }
        }
      }
    }

    else
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed binding to random port, remove socket.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed binding to random port, remove socket.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed binding to random port, remove socket.");
          }
        }
      }

      [v10 removeSocket];
    }

    goto LABEL_47;
  }

  while (1)
  {
    [v10 setPort:{v14, v28, v29, v30}];
    v15 = v14 + 1;
    [v10 setCellularPort:(v14 + 1)];
    v16 = [v10 newSocketWithIPVersion:a3 wantsAWDL:0 wantsWiFi:v6 wantsCellular:v5 clientUUID:self->_clientUUID];
    if (v16)
    {
      break;
    }

    [v10 removeSocket];
    LOWORD(v14) = v14 + 1;
    if (v11 <= v15)
    {
      goto LABEL_12;
    }
  }

  v24 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    v25 = "IPv6";
    if (!a3)
    {
      v25 = "IPv4";
    }

    *buf = 67109378;
    *v32 = v14;
    *&v32[4] = 2080;
    *&v32[6] = v25;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "bind to udp port %u succeeded for %s.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"bind to udp port %u succeeded for %s.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to udp port %u succeeded for %s.");
      }
    }
  }

LABEL_47:
  v26 = v16;

  return v26;
}

- (void)_delayProcessingCellularInterfaces:(id)a3
{
  v55 = *MEMORY[0x1E69E9840];
  theArray = a3;
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  v4 = [v3 dataUsable];

  if (!v4)
  {
    v34 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v42 = 0u;
    v43 = 0u;
    v44 = 0u;
    v45 = 0u;
    obj = theArray;
    v17 = [(__CFArray *)obj countByEnumeratingWithState:&v42 objects:v51 count:16];
    if (!v17)
    {
      goto LABEL_56;
    }

    v36 = *v43;
    while (1)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v43 != v36)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v42 + 1) + 8 * i);
        if ([(NSMutableArray *)v19 isCellular])
        {
          if (v34 && v19)
          {
            CFArrayAppendValue(v34, v19);
          }

          v20 = [(NSMutableArray *)v19 address];
          v21 = [v20 sa];

          v40 = 0u;
          v41 = 0u;
          v38 = 0u;
          v39 = 0u;
          v22 = self->_delayedCellInterfaces;
          v23 = [(NSMutableArray *)v22 countByEnumeratingWithState:&v38 objects:v50 count:16];
          if (v23)
          {
            v24 = *v39;
            while (2)
            {
              for (j = 0; j != v23; ++j)
              {
                if (*v39 != v24)
                {
                  objc_enumerationMutation(v22);
                }

                v26 = [*(*(&v38 + 1) + 8 * j) address];
                v27 = [v26 sa];

                if (IsSameSA(v21, v27))
                {

                  goto LABEL_54;
                }
              }

              v23 = [(NSMutableArray *)v22 countByEnumeratingWithState:&v38 objects:v50 count:16];
              if (v23)
              {
                continue;
              }

              break;
            }
          }

          delayedCellInterfaces = self->_delayedCellInterfaces;
          if (delayedCellInterfaces)
          {
            if (!v19)
            {
              goto LABEL_48;
            }
          }

          else
          {
            v29 = objc_alloc_init(MEMORY[0x1E695DF70]);
            v30 = self->_delayedCellInterfaces;
            self->_delayedCellInterfaces = v29;

            delayedCellInterfaces = self->_delayedCellInterfaces;
            if (!v19)
            {
LABEL_48:
              v31 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v54 = v19;
                _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "delay processing cell interface %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v32 = v19;
                  _IDSLogTransport(@"GL", @"IDS", @"delay processing cell interface %@.");
                  if (_IDSShouldLog())
                  {
                    v32 = v19;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing cell interface %@.");
                  }
                }
              }

              continue;
            }
          }

          if (delayedCellInterfaces)
          {
            CFArrayAppendValue(delayedCellInterfaces, v19);
          }

          goto LABEL_48;
        }

LABEL_54:
        ;
      }

      v17 = [(__CFArray *)obj countByEnumeratingWithState:&v42 objects:v51 count:16];
      if (!v17)
      {
LABEL_56:

        [(__CFArray *)obj removeObjectsInArray:v34];
        v16 = v34;
        goto LABEL_57;
      }
    }
  }

  if (self->_delayedCellInterfaces)
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v6 = self->_delayedCellInterfaces;
      *buf = 138412290;
      v54 = v6;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "add delayed cell interfaces: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v32 = self->_delayedCellInterfaces;
        _IDSLogTransport(@"GL", @"IDS", @"add delayed cell interfaces: %@.");
        if (_IDSShouldLog())
        {
          v32 = self->_delayedCellInterfaces;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"add delayed cell interfaces: %@.");
        }
      }
    }

    v48 = 0u;
    v49 = 0u;
    v46 = 0u;
    v47 = 0u;
    v7 = self->_delayedCellInterfaces;
    v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v46 objects:v52 count:16];
    if (v8)
    {
      v9 = *v47;
      do
      {
        for (k = 0; k != v8; ++k)
        {
          if (*v47 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = *(*(&v46 + 1) + 8 * k);
          v12 = [(__CFArray *)theArray containsObject:v11, v32];
          if (v11)
          {
            v13 = theArray == 0;
          }

          else
          {
            v13 = 1;
          }

          if (((v13 | v12) & 1) == 0)
          {
            CFArrayAppendValue(theArray, v11);
          }

          if ([v11 IPVersion] == 1)
          {
            v14 = [v11 index];
            v15 = [v11 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:v14 interfaceName:v15 completionBlock:0];
          }
        }

        v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v46 objects:v52 count:16];
      }

      while (v8);
    }

    v16 = self->_delayedCellInterfaces;
    self->_delayedCellInterfaces = 0;
LABEL_57:
  }
}

- (void)_getNAT64PrefixForInterface:(int)a3 interfaceName:(id)a4 completionBlock:(id)a5
{
  v19 = *MEMORY[0x1E69E9840];
  v8 = a4;
  v9 = a5;
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v16 = v8;
    v17 = 1024;
    v18 = a3;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "[%@:%d] needs nat64 prefix.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"[%@:%d] needs nat64 prefix.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"[%@:%d] needs nat64 prefix.");
      }
    }
  }

  if (IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, a3))
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v16) = a3;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "nat64 prefix cache hit for if:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"nat64 prefix cache hit for if:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"nat64 prefix cache hit for if:%d.");
        }
      }
    }

    self->_hasPendingAllocation = 0;
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v16) = a3;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "waiting nat64 prefix for if:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"waiting nat64 prefix for if:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"waiting nat64 prefix for if:%d.");
        }
      }
    }

    *buf = a3;
    v13 = im_primary_queue();
    v14 = v9;
    nw_nat64_copy_prefixes_async();
  }
}

- (BOOL)_synthesizeNAT64ForAddress:(sockaddr *)a3 withPrefix:(id *)a4 toAddress:(sockaddr *)a5
{
  v33 = *MEMORY[0x1E69E9840];
  *&v5 = 0xAAAAAAAAAAAAAAAALL;
  *(&v5 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v31 = v5;
  v32 = v5;
  v29 = v5;
  v30 = v5;
  v27 = v5;
  v28 = v5;
  *__str = v5;
  v26 = v5;
  v23 = v5;
  v24 = v5;
  v21 = v5;
  v22 = v5;
  v19 = v5;
  v20 = v5;
  *v17 = v5;
  v18 = v5;
  if (a4)
  {
    if (a3->sa_family == 2)
    {
      if (nw_nat64_synthesize_v6())
      {
        *&a5->sa_len = 7708;
        *a5->sa_data = *a3->sa_data;
        SAToIPPortString(__str, 0x80uLL, a3);
        SAToIPPortString(v17, 0x80uLL, a5);
        v8 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315394;
          v14 = __str;
          v15 = 2080;
          v16 = v17;
          _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.");
            }
          }
        }
      }

      LOBYTE(v9) = 1;
      return v9;
    }

    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: address is not AF_INET", buf, 2u);
    }

    v9 = os_log_shim_legacy_logging_enabled();
    if (v9)
    {
      v9 = _IDSShouldLogTransport();
      if (v9)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: address is not AF_INET");
        v9 = _IDSShouldLog();
        if (v9)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: address is not AF_INET");
          goto LABEL_23;
        }
      }
    }
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.", buf, 2u);
    }

    v9 = os_log_shim_legacy_logging_enabled();
    if (v9)
    {
      v9 = _IDSShouldLogTransport();
      if (v9)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.");
        v9 = _IDSShouldLog();
        if (v9)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.");
LABEL_23:
          LOBYTE(v9) = 0;
        }
      }
    }
  }

  return v9;
}

- (id)_addSocketAndInterfaceAddress:(unint64_t)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5
{
  v29 = *MEMORY[0x1E69E9840];
  v7 = [(IDSGlobalLink *)self _createInterfaceAddressArray:a3 wantsWiFi:a4 wantsCellular:a5];
  v8 = [v7 mutableCopy];

  if (v8)
  {
    v9 = +[IDSCellularLinkMonitor sharedInstance];
    v10 = [v9 dataUsable];

    if ((v10 & 1) == 0)
    {
      [(IDSGlobalLink *)self _delayProcessingCellularInterfaces:v8];
    }

    if (a3 == 1)
    {
      v24 = 0u;
      v25 = 0u;
      v22 = 0u;
      v23 = 0u;
      v11 = v8;
      v12 = [v11 countByEnumeratingWithState:&v22 objects:v26 count:16];
      if (v12)
      {
        v13 = *v23;
        do
        {
          for (i = 0; i != v12; ++i)
          {
            if (*v23 != v13)
            {
              objc_enumerationMutation(v11);
            }

            v15 = *(*(&v22 + 1) + 8 * i);
            v16 = [v15 index];
            v17 = [v15 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:v16 interfaceName:v17 completionBlock:0];
          }

          v12 = [v11 countByEnumeratingWithState:&v22 objects:v26 count:16];
        }

        while (v12);
      }
    }

    if ([v8 count])
    {
      [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:v8 removeList:0];
    }

    v18 = v8;
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = "IPv6";
      if (!a3)
      {
        v20 = "IPv4";
      }

      *buf = 136315138;
      v28 = v20;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed to create interface address array for %s.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to create interface address array for %s.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create interface address array for %s.");
        }
      }
    }
  }

  return v8;
}

- (void)_parseClientUUID:(id)a3
{
  v14 = *MEMORY[0x1E69E9840];
  v4 = a3;
  uuid_clear(self->_clientUUID);
  if (v4)
  {
    v5 = [v4 UUIDString];
    v6 = v5;
    if (v5)
    {
      v7 = [v5 UTF8String];
      v8 = v7;
      if (v7 && !uuid_parse(v7, self->_clientUUID))
      {
        v11 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315138;
          v13 = v8;
          _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Client UUID: %s", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"Client UUID: %s");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Client UUID: %s");
            }
          }
        }
      }

      else
      {
        v9 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
        {
          v10 = "null";
          if (v8)
          {
            v10 = v8;
          }

          *buf = 136315138;
          v13 = v10;
          _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "Invalid client UUID: %s", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"Invalid client UUID: %s");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Invalid client UUID: %s");
            }
          }
        }
      }
    }
  }
}

+ (Class)getGLClassWithOptions:(id)a3
{
  v3 = a3;
  Value = 0;
  if (v3 && @"gl-option-client-type")
  {
    Value = CFDictionaryGetValue(v3, @"gl-option-client-type");
  }

  v5 = [Value unsignedIntValue];
  v6 = 0;
  if (v3 && @"is-multiway-key")
  {
    v6 = CFDictionaryGetValue(v3, @"is-multiway-key");
  }

  v7 = [v6 BOOLValue];
  if (v5 > 4)
  {
    if ((v5 - 5) >= 2 && v5 != 100)
    {
      goto LABEL_32;
    }

    goto LABEL_16;
  }

  if (v5 == 1)
  {
LABEL_16:
    if (!v7)
    {
      v11 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        *v17 = 0;
        _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for FT", v17, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v10 = @"Selecting GlobalLink for FT";
          _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for FT");
          if (_IDSShouldLog())
          {
            goto LABEL_37;
          }
        }
      }

      goto LABEL_38;
    }

    v8 = OSLogHandleForTransportCategory();
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_20;
    }

    *buf = 0;
    v9 = buf;
    goto LABEL_19;
  }

  if (v5 != 2 || !v7)
  {
LABEL_32:
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *v15 = 0;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for NonFT", v15, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v10 = @"Selecting GlobalLink for NonFT";
        _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for NonFT");
        if (_IDSShouldLog())
        {
          goto LABEL_37;
        }
      }
    }

    goto LABEL_38;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v16 = 0;
    v9 = &v16;
LABEL_19:
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for GFT", v9, 2u);
  }

LABEL_20:

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v10 = @"Selecting GlobalLink for GFT";
      _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for GFT");
      if (_IDSShouldLog())
      {
LABEL_37:
        _IDSLogV(0, @"IDSFoundation", @"GL", v10);
      }
    }
  }

LABEL_38:
  v13 = objc_opt_class();

  return v13;
}

- (void)startWithOptions:(id)a3
{
  v214 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_opt_class();
  theDict = v4;
  if (v5 == objc_opt_class())
  {
    v20 = [MEMORY[0x1E696AE30] processInfo];
    v21 = [v20 processName];
    IMLogSimulateCrashForProcess();

    goto LABEL_452;
  }

  Value = 0;
  self->_hasStarted = 1;
  if (v4 && @"gl-option-metrics-collector-key")
  {
    Value = CFDictionaryGetValue(v4, @"gl-option-metrics-collector-key");
  }

  p_metricsCollector = &self->_metricsCollector;
  objc_storeStrong(&self->_metricsCollector, Value);
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = *p_metricsCollector;
    *buf = 138412290;
    *v203 = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "startWithOptions: MetricsCollector: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v180 = *p_metricsCollector;
      _IDSLogTransport(@"GL", @"IDS", @"startWithOptions: MetricsCollector: %@");
      if (_IDSShouldLog())
      {
        v180 = *p_metricsCollector;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"startWithOptions: MetricsCollector: %@");
      }
    }
  }

  [*p_metricsCollector globalLinkStart];
  v10 = [MEMORY[0x1E69A60F0] sharedInstance];
  [v10 isInternalInstall];
  v11 = IMGetDomainBoolForKeyWithDefaultValue();

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = @"NO";
    if (v11)
    {
      v13 = @"YES";
    }

    *buf = 138412290;
    *v203 = v13;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Packet timestamp logs enabled: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v14 = v11 ? @"YES" : @"NO";
    v181 = v14;
    _IDSLogTransport(@"GL", @"IDS", @"Packet timestamp logs enabled: %@");
    if (_IDSShouldLog())
    {
      v181 = v14;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"Packet timestamp logs enabled: %@");
    }
  }

  if (((self->_packetLog == 0) & v11) == 1)
  {
    v15 = [[IDSObjCPacketLog alloc] initWithSessionID:self->_cbuuid processName:@"GL"];
    packetLog = self->_packetLog;
    self->_packetLog = v15;
  }

  v17 = v4 != 0;
  [(IDSGlobalLink *)self _schedulePacketLogFlush];
  if (@"gl-option-p2p-negotiator-key")
  {
    v18 = v17;
  }

  else
  {
    v18 = 0;
  }

  if (v18)
  {
    v19 = CFDictionaryGetValue(theDict, @"gl-option-p2p-negotiator-key");
  }

  else
  {
    v19 = 0;
  }

  objc_storeStrong(&self->_p2pNegotiatorProvider, v19);
  if (@"gl-option-disallow-wifi")
  {
    v22 = theDict != 0;
  }

  else
  {
    v22 = 0;
  }

  if (v22)
  {
    v23 = CFDictionaryGetValue(theDict, @"gl-option-disallow-wifi");
  }

  else
  {
    v23 = 0;
  }

  v199 = [v23 BOOLValue];
  self->_disallowWiFi = v199;
  if (v199)
  {
    v24 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "client disallows WiFi.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client disallows WiFi.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client disallows WiFi.");
        }
      }
    }
  }

  v25 = 0;
  if (theDict && @"gl-option-disallow-cellular")
  {
    v25 = CFDictionaryGetValue(theDict, @"gl-option-disallow-cellular");
  }

  v198 = [v25 BOOLValue];
  self->_disallowCellular = v198;
  if (v198)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "client disallows Cellular.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client disallows Cellular.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client disallows Cellular.");
        }
      }
    }
  }

  else
  {
    v27 = +[IDSCellularLinkMonitor sharedInstance];
    [v27 reset];

    v28 = +[IDSCellularLinkMonitor sharedInstance];
    [v28 setRemoteDeviceVersion:self->_remoteDeviceVersion];
  }

  v29 = 0;
  if (theDict && @"gl-option-prefer-cellular-for-call-setup")
  {
    v29 = CFDictionaryGetValue(theDict, @"gl-option-prefer-cellular-for-call-setup");
  }

  v30 = [v29 BOOLValue];
  self->_preferCellularForCallSetup = v30;
  if (v30)
  {
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "client prefers using cellular for call setup.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client prefers using cellular for call setup.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers using cellular for call setup.");
        }
      }
    }
  }

  v32 = 0;
  v33 = theDict;
  if (theDict && @"gl-option-client-type")
  {
    v32 = CFDictionaryGetValue(theDict, @"gl-option-client-type");
    v33 = theDict;
  }

  v34 = v33 != 0;
  self->_clientType = [v32 unsignedIntValue];
  if (@"gl-option-is-gft-service")
  {
    v35 = v34;
  }

  else
  {
    v35 = 0;
  }

  if (v35)
  {
    v36 = CFDictionaryGetValue(theDict, @"gl-option-is-gft-service");
  }

  else
  {
    v36 = 0;
  }

  self->_isAutoDisconnectSupportedForGFTService = [v36 BOOLValue];
  if (@"gs-is-lightweight-participant-key")
  {
    v37 = theDict != 0;
  }

  else
  {
    v37 = 0;
  }

  if (v37)
  {
    v38 = CFDictionaryGetValue(theDict, @"gs-is-lightweight-participant-key");
  }

  else
  {
    v38 = 0;
  }

  self->_isLightweightParticipant = [v38 BOOLValue];
  if (@"participant-data-key")
  {
    v39 = theDict != 0;
  }

  else
  {
    v39 = 0;
  }

  if (v39)
  {
    v40 = CFDictionaryGetValue(theDict, @"participant-data-key");
  }

  else
  {
    v40 = 0;
  }

  objc_storeStrong(&self->_avcDataBlob, v40);
  v41 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
  {
    v42 = @"NO";
    if (self->_isLightweightParticipant)
    {
      v43 = @"YES";
    }

    else
    {
      v43 = @"NO";
    }

    avcDataBlob = self->_avcDataBlob;
    if (self->_isAutoDisconnectSupportedForGFTService)
    {
      v42 = @"YES";
    }

    *buf = 138412802;
    *v203 = v43;
    *&v203[8] = 2112;
    *&v203[10] = avcDataBlob;
    v204 = 2112;
    v205 = v42;
    _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v45 = self->_isLightweightParticipant ? @"YES" : @"NO";
    v46 = self->_isAutoDisconnectSupportedForGFTService ? @"YES" : @"NO";
    v188 = self->_avcDataBlob;
    v191 = v46;
    v182 = v45;
    _IDSLogTransport(@"GL", @"IDS", @"_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@");
    if (_IDSShouldLog())
    {
      if (self->_isLightweightParticipant)
      {
        v47 = @"YES";
      }

      else
      {
        v47 = @"NO";
      }

      if (self->_isAutoDisconnectSupportedForGFTService)
      {
        v48 = @"YES";
      }

      else
      {
        v48 = @"NO";
      }

      v188 = self->_avcDataBlob;
      v191 = v48;
      v182 = v47;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@");
    }
  }

  v49 = 0;
  if (theDict && @"gl-option-enable-ske")
  {
    v49 = CFDictionaryGetValue(theDict, @"gl-option-enable-ske");
  }

  if ([v49 BOOLValue])
  {
    self->_enableSKE = 1;
    v50 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "Enable SKE for FaceTime call.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Enable SKE for FaceTime call.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Enable SKE for FaceTime call.");
        }
      }
    }
  }

  else
  {
    self->_enableSKE = IMGetDomainBoolForKey();
    v51 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_enableSKE)
      {
        v52 = @"YES";
      }

      else
      {
        v52 = @"NO";
      }

      *buf = 138412290;
      *v203 = v52;
      _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "Found EnableSKE user defaults, enable SKE for FaceTime: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v53 = self->_enableSKE ? @"YES" : @"NO";
      v183 = v53;
      _IDSLogTransport(@"GL", @"IDS", @"Found EnableSKE user defaults, enable SKE for FaceTime: %@.");
      if (_IDSShouldLog())
      {
        if (self->_enableSKE)
        {
          v54 = @"YES";
        }

        else
        {
          v54 = @"NO";
        }

        v183 = v54;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Found EnableSKE user defaults, enable SKE for FaceTime: %@.");
      }
    }
  }

  v55 = [IDSServerBag sharedInstanceForBagType:0, v183];
  v56 = [v55 objectForKey:@"reduce-cellular-usage"];
  self->_reduceCellularUsage = [v56 BOOLValue];

  if (self->_reduceCellularUsage)
  {
    v57 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "Default set to reduce cellular data usage", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Default set to reduce cellular data usage");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Default set to reduce cellular data usage");
        }
      }
    }
  }

  v58 = [IDSServerBag sharedInstanceForBagType:0];
  v59 = [v58 objectForKey:@"reduce-relay-link-creation"];
  self->_reduceRelayLinkCreation = [v59 BOOLValue];

  if (self->_reduceRelayLinkCreation)
  {
    v60 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "Default set to reduce relay link creation to 2.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Default set to reduce relay link creation to 2.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Default set to reduce relay link creation to 2.");
        }
      }
    }
  }

  self->_delayQUICDisconnectionAfterInfo = IMGetCachedDomainIntForKeyWithDefaultValue();
  v61 = +[IDSServerBag sharedInstance];
  v197 = [v61 objectForKey:@"ids-quic-disconnection-delay-after-info-2"];

  if (v197)
  {
    [v197 doubleValue];
    self->_delayQUICDisconnectionAfterInfo = v62;
  }

  v63 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
  {
    delayQUICDisconnectionAfterInfo = self->_delayQUICDisconnectionAfterInfo;
    *buf = 134218242;
    *v203 = delayQUICDisconnectionAfterInfo;
    *&v203[8] = 2112;
    *&v203[10] = v197;
    _os_log_impl(&dword_1A7AD9000, v63, OS_LOG_TYPE_DEFAULT, "QUIC disconnection delay after info request is set to %.1lf (from serverBag: %@)", buf, 0x16u);
  }

  v65 = IMGetDomainBoolForKeyWithDefaultValue();
  v66 = +[IDSServerBag sharedInstance];
  v195 = [v66 objectForKey:@"ids-rtencryption-mkm-over-qr-enabled-v2"];

  if (v195)
  {
    v67 = [v195 BOOLValue];
  }

  else
  {
    v67 = v65;
  }

  self->_shouldAcceptIncomingMKMOverQR = v67;
  v68 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_shouldAcceptIncomingMKMOverQR)
    {
      v69 = @"enabled";
    }

    else
    {
      v69 = @"disabled";
    }

    v70 = [v195 BOOLValue];
    v71 = @"NO";
    if (v70)
    {
      v72 = @"YES";
    }

    else
    {
      v72 = @"NO";
    }

    *buf = 138412802;
    *v203 = v69;
    *&v203[8] = 2112;
    *&v203[10] = v72;
    if (v65)
    {
      v71 = @"YES";
    }

    v204 = 2112;
    v205 = v71;
    _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "Accepting MKM over QR %@ - serverBag: %@, defaults: %@", buf, 0x20u);
  }

  self->_islocalCellAttributeInexpensive = IMGetDomainBoolForKey();
  if (@"client-uuid")
  {
    v73 = theDict != 0;
  }

  else
  {
    v73 = 0;
  }

  if (v73)
  {
    v74 = CFDictionaryGetValue(theDict, @"client-uuid");
  }

  else
  {
    v74 = 0;
  }

  v192 = v74;
  [(IDSGlobalLink *)self _parseClientUUID:?];
  self->_QRIPv6Enabled = 1;
  v75 = _os_feature_enabled_impl();
  v76 = +[IDSServerBag sharedInstance];
  v194 = [v76 objectForKey:@"ids-quic-for-qr-enabled"];

  if (v75)
  {
    if (v194)
    {
      v77 = [v194 BOOLValue];
    }

    else
    {
      v77 = 1;
    }
  }

  else
  {
    v77 = 0;
  }

  self->_QUICForQREnabled = v77;
  v78 = +[IDSServerBag sharedInstance];
  v196 = [v78 objectForKey:@"ids-quic-for-qr-enabled-for-twoway"];

  if (@"qat")
  {
    v79 = theDict != 0;
  }

  else
  {
    v79 = 0;
  }

  if (v79)
  {
    v80 = CFDictionaryGetValue(theDict, @"qat");
  }

  else
  {
    v80 = 0;
  }

  v81 = [v80 intValue];
  v82 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    *v203 = v81;
    *&v203[4] = 2112;
    *&v203[6] = v196;
    _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v184 = v81;
      v189 = v196;
      _IDSLogTransport(@"GL", @"IDS", @"QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@");
      if (_IDSShouldLog())
      {
        v184 = v81;
        v189 = v196;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@");
      }
    }
  }

  if (v81 == 1 && v196 && ([v196 BOOLValue] & 1) == 0)
  {
    v83 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN");
        }
      }
    }

    self->_QUICForQREnabled = 0;
  }

  v84 = IMGetDomainBoolForKey();
  if (v84)
  {
    self->_QUICForQREnabled = 1;
  }

  v85 = [IDSServerBag sharedInstance:v184];
  v193 = [v85 objectForKey:@"ids-h2-fallback-enabled"];

  v86 = _os_feature_enabled_impl();
  if (self->_QUICForQREnabled & v86)
  {
    if (v193)
    {
      v87 = [v193 BOOLValue];
    }

    else
    {
      v87 = 1;
    }
  }

  else
  {
    v87 = 0;
  }

  self->_H2FallbackEnabled = v87;
  self->_H2FallbackEnabled = IMGetDomainBoolForKeyWithDefaultValue();
  v88 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_QUICForQREnabled)
    {
      v89 = @"enabled";
    }

    else
    {
      v89 = @"disabled";
    }

    if (v194)
    {
      if ([v194 BOOLValue])
      {
        v90 = @"YES";
      }

      else
      {
        v90 = @"NO";
      }
    }

    else
    {
      v90 = @"missing";
    }

    if (v75)
    {
      v91 = @"YES";
    }

    else
    {
      v91 = @"NO";
    }

    if (v84)
    {
      v92 = @"YES";
    }

    else
    {
      v92 = @"NO";
    }

    if (self->_H2FallbackEnabled)
    {
      v93 = @"YES";
    }

    else
    {
      v93 = @"NO";
    }

    if (v86)
    {
      v94 = @"YES";
    }

    else
    {
      v94 = @"NO";
    }

    if (v193)
    {
      if ([v193 BOOLValue])
      {
        v95 = @"YES";
      }

      else
      {
        v95 = @"NO";
      }
    }

    else
    {
      v95 = @"missing";
    }

    *buf = 138413826;
    *v203 = v89;
    *&v203[8] = 2112;
    *&v203[10] = v90;
    v204 = 2112;
    v205 = v91;
    v206 = 2112;
    v207 = v92;
    v208 = 2112;
    v209 = v93;
    v210 = 2112;
    v211 = v94;
    v212 = 2112;
    v213 = v95;
    _os_log_impl(&dword_1A7AD9000, v88, OS_LOG_TYPE_DEFAULT, "QUIC for QR %@ - serverBag: %@, feature-flag: %@, forceEnableQUICForQR: %@, _H2FallbackEnabled: %@, H2 feature-flag: %@, H2 server bag: %@", buf, 0x48u);
  }

  if (@"gl-option-preferred-address-family")
  {
    v96 = theDict != 0;
  }

  else
  {
    v96 = 0;
  }

  if (v96)
  {
    v97 = CFDictionaryGetValue(theDict, @"gl-option-preferred-address-family");
  }

  else
  {
    v97 = 0;
  }

  v98 = [v97 unsignedIntValue];
  v99 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v99, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *v203 = v98;
    _os_log_impl(&dword_1A7AD9000, v99, OS_LOG_TYPE_DEFAULT, "QR preferredAddressFamily from server: %d", buf, 8u);
  }

  v100 = IMGetCachedDomainIntForKeyWithDefaultValue();
  v101 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *v203 = v100;
    _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "QR preferredAddressFamily after reading from defaults: %d", buf, 8u);
  }

  if (@"gl-option-force-ipv6")
  {
    v102 = theDict != 0;
  }

  else
  {
    v102 = 0;
  }

  if (v102)
  {
    v103 = CFDictionaryGetValue(theDict, @"gl-option-force-ipv6");
  }

  else
  {
    v103 = 0;
  }

  self->_forceIPv6 = [v103 BOOLValue];
  if (self->_QUICForQREnabled)
  {
    if (v100 == 1)
    {
      v104 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v104, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v104, OS_LOG_TYPE_DEFAULT, "client prefers IPv4, disable IPv6.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"client prefers IPv4, disable IPv6.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers IPv4, disable IPv6.");
          }
        }
      }

      self->_QRIPv6Enabled = 0;
    }

    else
    {
      v107 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v107, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v107, OS_LOG_TYPE_DEFAULT, "Add IPv6 address to the interface", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"Add IPv6 address to the interface");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Add IPv6 address to the interface");
          }
        }
      }
    }

    v108 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddressWithNWLink:self->_QRIPv6Enabled wantsWiFi:v199 ^ 1u wantsCellular:v198 ^ 1u];
  }

  else
  {
    v105 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:0 wantsWiFi:v199 ^ 1u wantsCellular:v198 ^ 1u];
    if (v100 == 1)
    {
      v106 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v106, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v106, OS_LOG_TYPE_DEFAULT, "client prefers IPv4, disable IPv6.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"client prefers IPv4, disable IPv6.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers IPv4, disable IPv6.");
          }
        }
      }

      self->_QRIPv6Enabled = 0;
    }

    else
    {
      v109 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "Add IPv6 address to the interface", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"Add IPv6 address to the interface");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Add IPv6 address to the interface");
          }
        }
      }

      v110 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:1 wantsWiFi:v199 ^ 1u wantsCellular:v198 ^ 1u];
    }
  }

  v111 = +[IDSServerBag sharedInstance];
  v112 = [v111 objectForKey:@"allow-quic-0rtt"];

  if (v112)
  {
    v113 = [v112 BOOLValue];
    v114 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
    {
      v115 = @"NO";
      if (v113)
      {
        v115 = @"YES";
      }

      *buf = 138412290;
      *v203 = v115;
      _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "shouldEnable0RTT: got server bag value: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v116 = v113 ? @"YES" : @"NO";
      v185 = v116;
      _IDSLogTransport(@"GL", @"IDS", @"shouldEnable0RTT: got server bag value: %@");
      if (_IDSShouldLog())
      {
        v185 = v116;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"shouldEnable0RTT: got server bag value: %@");
      }
    }
  }

  v117 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_shouldEnable0RTT = v117;
  v118 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v118, OS_LOG_TYPE_DEFAULT))
  {
    v119 = @"NO";
    if (v117)
    {
      v119 = @"YES";
    }

    *buf = 138412546;
    *v203 = v119;
    *&v203[8] = 2112;
    *&v203[10] = @"YES";
    _os_log_impl(&dword_1A7AD9000, v118, OS_LOG_TYPE_DEFAULT, "_shouldEnable0RTT: %@ (Default: %@)", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v120 = v117 ? @"YES" : @"NO";
    v185 = v120;
    v190 = @"YES";
    _IDSLogTransport(@"GL", @"IDS", @"_shouldEnable0RTT: %@ (Default: %@)");
    if (_IDSShouldLog())
    {
      v185 = v120;
      v190 = @"YES";
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldEnable0RTT: %@ (Default: %@)");
    }
  }

  v121 = 0;
  if (theDict && @"gs-tle-enabled-key")
  {
    v121 = CFDictionaryGetValue(theDict, @"gs-tle-enabled-key");
  }

  self->_isTLEEnabled = [v121 BOOLValue];
  v122 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v122, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isTLEEnabled)
    {
      v123 = @"YES";
    }

    else
    {
      v123 = @"NO";
    }

    *buf = 138412290;
    *v203 = v123;
    _os_log_impl(&dword_1A7AD9000, v122, OS_LOG_TYPE_DEFAULT, "_isTLEEnabled: %@ based on TU passed feature flag", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v124 = self->_isTLEEnabled ? @"YES" : @"NO";
    v186 = v124;
    _IDSLogTransport(@"GL", @"IDS", @"_isTLEEnabled: %@ based on TU passed feature flag");
    if (_IDSShouldLog())
    {
      if (self->_isTLEEnabled)
      {
        v125 = @"YES";
      }

      else
      {
        v125 = @"NO";
      }

      v186 = v125;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isTLEEnabled: %@ based on TU passed feature flag");
    }
  }

  v126 = 0;
  if (theDict && @"gs-partial-tle-u-plus-one-enabled-key")
  {
    v126 = CFDictionaryGetValue(theDict, @"gs-partial-tle-u-plus-one-enabled-key");
  }

  self->_isPartialTLEUPlusOneEnabled = [v126 BOOLValue];
  v127 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v127, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isPartialTLEUPlusOneEnabled)
    {
      v128 = @"YES";
    }

    else
    {
      v128 = @"NO";
    }

    *buf = 138412290;
    *v203 = v128;
    _os_log_impl(&dword_1A7AD9000, v127, OS_LOG_TYPE_DEFAULT, "_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v129 = self->_isPartialTLEUPlusOneEnabled ? @"YES" : @"NO";
    v187 = v129;
    _IDSLogTransport(@"GL", @"IDS", @"_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag");
    if (_IDSShouldLog())
    {
      if (self->_isPartialTLEUPlusOneEnabled)
      {
        v130 = @"YES";
      }

      else
      {
        v130 = @"NO";
      }

      v187 = v130;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag");
    }
  }

  v131 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_forceTLE = v131;
  v132 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT))
  {
    v133 = @"NO";
    if (v131)
    {
      v133 = @"YES";
    }

    *buf = 138412290;
    *v203 = v133;
    _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "forceTLE: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v134 = v131 ? @"YES" : @"NO";
    v187 = v134;
    _IDSLogTransport(@"GL", @"IDS", @"forceTLE: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v134;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"forceTLE: %@ based on defaults");
    }
  }

  v135 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_forceP2PTLE = v135;
  v136 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
  {
    v137 = @"NO";
    if (v135)
    {
      v137 = @"YES";
    }

    *buf = 138412290;
    *v203 = v137;
    _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "forceP2PTLE: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v138 = v135 ? @"YES" : @"NO";
    v187 = v138;
    _IDSLogTransport(@"GL", @"IDS", @"forceP2PTLE: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v138;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"forceP2PTLE: %@ based on defaults");
    }
  }

  v139 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowTLEOverCellular = v139;
  v140 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v140, OS_LOG_TYPE_DEFAULT))
  {
    v141 = @"NO";
    if (v139)
    {
      v141 = @"YES";
    }

    *buf = 138412290;
    *v203 = v141;
    _os_log_impl(&dword_1A7AD9000, v140, OS_LOG_TYPE_DEFAULT, "allowTLEOverCellular: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v142 = v139 ? @"YES" : @"NO";
    v187 = v142;
    _IDSLogTransport(@"GL", @"IDS", @"allowTLEOverCellular: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v142;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"allowTLEOverCellular: %@ based on defaults");
    }
  }

  v143 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowTLEOverVRLinks = v143;
  v144 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v144, OS_LOG_TYPE_DEFAULT))
  {
    v145 = @"NO";
    if (v143)
    {
      v145 = @"YES";
    }

    *buf = 138412290;
    *v203 = v145;
    _os_log_impl(&dword_1A7AD9000, v144, OS_LOG_TYPE_DEFAULT, "allowTLEOverVRLinks: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v146 = v143 ? @"YES" : @"NO";
    v187 = v146;
    _IDSLogTransport(@"GL", @"IDS", @"allowTLEOverVRLinks: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v146;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"allowTLEOverVRLinks: %@ based on defaults");
    }
  }

  keyExistsAndHasValidFormat = 0;
  v147 = CFPreferencesGetAppBooleanValue(@"serverTestOptionTLEDisabled", @"com.apple.ids", &keyExistsAndHasValidFormat) != 0;
  v148 = keyExistsAndHasValidFormat;
  if (((keyExistsAndHasValidFormat == 0) & v131) == 1)
  {
    v147 = 0;
    v148 = 1;
    keyExistsAndHasValidFormat = 1;
  }

  self->_shouldOverrideServerTestOptionTLEDisabled = v148 != 0;
  self->_serverTestOptionTLEDisabled = v147;
  self->_disableDirectDatapath = IMGetDomainBoolForKeyWithDefaultValue();
  v149 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_disableDirectDatapath)
    {
      v150 = @"YES";
    }

    else
    {
      v150 = @"NO";
    }

    *buf = 138412290;
    *v203 = v150;
    _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "direct datapath: _disableDirectDatapath: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v151 = self->_disableDirectDatapath ? @"YES" : @"NO";
    v187 = v151;
    _IDSLogTransport(@"GL", @"IDS", @"direct datapath: _disableDirectDatapath: %@ based on defaults");
    if (_IDSShouldLog())
    {
      if (self->_disableDirectDatapath)
      {
        v152 = @"YES";
      }

      else
      {
        v152 = @"NO";
      }

      v187 = v152;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"direct datapath: _disableDirectDatapath: %@ based on defaults");
    }
  }

  v153 = +[IDSNWLink isSkywalkDemuxSupported];
  if ((v153 & 1) == 0)
  {
    self->_disableDirectDatapath = 1;
    v154 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v154, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v154, OS_LOG_TYPE_DEFAULT, "direct datapath: NO because Skywalk Demux is not supported", buf, 2u);
    }

    v153 = os_log_shim_legacy_logging_enabled();
    if (v153)
    {
      v153 = _IDSShouldLogTransport();
      if (v153)
      {
        _IDSLogTransport(@"GL", @"IDS", @"direct datapath: NO because Skywalk Demux is not supported");
        v153 = _IDSShouldLog();
        if (v153)
        {
          v153 = _IDSLogV(0, @"IDSFoundation", @"GL", @"direct datapath: NO because Skywalk Demux is not supported");
        }
      }
    }
  }

  if ((v199 & 1) == 0)
  {
    self->_wifiNWPathFlags = -1;
    v155 = MEMORY[0x1AC564230](v153);
    nw_parameters_set_required_interface_type(v155, nw_interface_type_wifi);
    evaluator_for_endpoint = nw_path_create_evaluator_for_endpoint();
    wifiPathEvaluator = self->_wifiPathEvaluator;
    self->_wifiPathEvaluator = evaluator_for_endpoint;

    v158 = im_primary_queue();
    nw_path_evaluator_set_update_handler();
  }

  if ((v198 & 1) == 0)
  {
    self->_cellularNWPathFlags = -1;
    v159 = MEMORY[0x1AC564230](v153);
    nw_parameters_set_required_interface_type(v159, nw_interface_type_cellular);
    v160 = nw_path_create_evaluator_for_endpoint();
    cellularPathEvaluator = self->_cellularPathEvaluator;
    self->_cellularPathEvaluator = v160;

    v162 = im_primary_queue();
    nw_path_evaluator_set_update_handler();
  }

  self->_allowOnlyOneQR = 0;
  if (IMGetDomainBoolForKey())
  {
    self->_allowP2P = 0;
LABEL_413:
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
LABEL_417:

      goto LABEL_418;
    }

    *buf = 0;
    v165 = "forceQuickRelay or disableP2PLinks default is set to YES.";
    goto LABEL_415;
  }

  v163 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowP2P = v163 ^ 1;
  if (((v163 ^ 1) & 1) == 0)
  {
    goto LABEL_413;
  }

  v178 = 0;
  if (theDict && @"gl-option-forcerelay")
  {
    v178 = CFDictionaryGetValue(theDict, @"gl-option-forcerelay");
  }

  if ([v178 BOOLValue])
  {
    *&self->_allowOnlyOneQR = 1;
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_417;
    }

    *buf = 0;
    v165 = "forceRelay option is set to YES.";
LABEL_415:
    v166 = v164;
    v167 = 2;
LABEL_416:
    _os_log_impl(&dword_1A7AD9000, v166, OS_LOG_TYPE_DEFAULT, v165, buf, v167);
    goto LABEL_417;
  }

  if (!self->_clientType)
  {
    *&self->_allowOnlyOneQR = 1;
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_417;
    }

    clientType = self->_clientType;
    *buf = 67109120;
    *v203 = clientType;
    v165 = "use forceQuickRelay for client: %d.";
    v166 = v164;
    v167 = 8;
    goto LABEL_416;
  }

LABEL_418:
  v168 = 0;
  if (theDict && @"gs-force-tcp-fallback-on-wifi-key")
  {
    v168 = CFDictionaryGetValue(theDict, @"gs-force-tcp-fallback-on-wifi-key");
  }

  self->_forceTCPFallbackOnWiFi = [v168 BOOLValue];
  if (@"gs-force-tcp-fallback-on-cell-key")
  {
    v169 = theDict != 0;
  }

  else
  {
    v169 = 0;
  }

  if (v169)
  {
    v170 = CFDictionaryGetValue(theDict, @"gs-force-tcp-fallback-on-cell-key");
  }

  else
  {
    v170 = 0;
  }

  self->_forceTCPFallbackOnCell = [v170 BOOLValue];
  if (@"gs-shortmki-enabled-key")
  {
    v171 = theDict != 0;
  }

  else
  {
    v171 = 0;
  }

  if (v171)
  {
    v172 = CFDictionaryGetValue(theDict, @"gs-shortmki-enabled-key");
  }

  else
  {
    v172 = 0;
  }

  self->_isShortMKIEnabled = [v172 BOOLValue];
  if (@"gs-gecko-enabled-key")
  {
    v173 = theDict != 0;
  }

  else
  {
    v173 = 0;
  }

  if (v173)
  {
    v174 = CFDictionaryGetValue(theDict, @"gs-gecko-enabled-key");
  }

  else
  {
    v174 = 0;
  }

  self->_isGeckoEnabled = [v174 BOOLValue];
  *&self->_callModeUpdateGenerationCounter = 0x100000001;
  if (@"gs-started-as-u-plus-one-key")
  {
    v175 = theDict != 0;
  }

  else
  {
    v175 = 0;
  }

  if (v175)
  {
    v176 = CFDictionaryGetValue(theDict, @"gs-started-as-u-plus-one-key");
  }

  else
  {
    v176 = 0;
  }

  if ([v176 BOOLValue])
  {
    [(IDSGlobalLink *)self setIsUPlusOneSession:1];
    self->_shouldReportAcceptDelay = 1;
  }

  else
  {
    [(IDSGlobalLink *)self setIsUPlusOneSession:0];
  }

  v177 = 0;
  if (theDict && @"gl-option-qra-blocks")
  {
    v177 = CFDictionaryGetValue(theDict, @"gl-option-qra-blocks");
  }

  objc_storeStrong(&self->_qraBlocks, v177);
  self->_calleeAcceptTime = ids_monotonic_time();
  self->_delayFirstConnectionData = IMGetDomainIntForKey();

LABEL_452:
}

- (BOOL)_isNWPathFlagsChanged:(id)a3 existingPath:(unsigned __int16 *)a4
{
  v22 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = v5;
  if (!v5)
  {
    v11 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "invalid path, return", v19, 2u);
    }

    goto LABEL_20;
  }

  v7 = MEMORY[0x1AC564440](v5);
  v8 = +[IDSFoundationLog GlobalLink];
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT);
  if (v7)
  {
    if (v9)
    {
      LOWORD(v19[0]) = 0;
      v10 = 2;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Constrained", v19, 2u);
    }

    else
    {
      v10 = 2;
    }
  }

  else
  {
    if (v9)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Not constrained", v19, 2u);
    }

    v10 = 0;
  }

  v12 = MEMORY[0x1AC564450](v6);
  v13 = +[IDSFoundationLog GlobalLink];
  v14 = os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
  if (v12)
  {
    if (v14)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Expensive", v19, 2u);
    }

    v10 |= 1u;
  }

  else
  {
    if (v14)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Inexpensive", v19, 2u);
    }
  }

  if (v10 == *a4)
  {
LABEL_20:
    v15 = 0;
    goto LABEL_24;
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = *a4;
    v19[0] = 67109376;
    v19[1] = v17;
    v20 = 1024;
    v21 = v10;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: existingPath: %u changed to curNWPathFlags: %u", v19, 0xEu);
  }

  *a4 = v10;
  v15 = 1;
LABEL_24:

  return v15;
}

- (void)_handle_wifi_path:(id)a3 nwEndPoind:(id)a4
{
  v16 = *MEMORY[0x1E69E9840];
  if (self->_state != 4)
  {
    v9 = [IDSFoundationLog GlobalLink:a3];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v11 = _IDSLinkStateStrings[self->_state];
      v12 = 138412546;
      v13 = idsSessionID;
      v14 = 2080;
      v15 = v11;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_handle_wifi_path: Session with IDSSessionID: %@ is not connected, state [%s].", &v12, 0x16u);
    }

    goto LABEL_9;
  }

  if ([(IDSGlobalLink *)self _isNWPathFlagsChanged:a3 existingPath:&self->_wifiNWPathFlags])
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      wifiNWPathFlags = self->_wifiNWPathFlags;
      v12 = 67109120;
      LODWORD(v13) = wifiNWPathFlags;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_handle_wifi_path: for _wifiNWPathFlags: %u", &v12, 8u);
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v8 = objc_opt_respondsToSelector();

    if (v8)
    {
      v9 = objc_loadWeakRetained(&self->_delegate);
      [v9 link:self didWiFiNWPathFlagsChanged:self->_wifiNWPathFlags];
LABEL_9:
    }
  }
}

- (void)_handle_cellular_path:(id)a3 nwEndPoind:(id)a4
{
  v23 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = v5;
  if (self->_state != 4)
  {
    v12 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_13;
    }

    idsSessionID = self->_idsSessionID;
    v14 = _IDSLinkStateStrings[self->_state];
    v19 = 138412546;
    v20 = idsSessionID;
    v21 = 2080;
    v22 = v14;
    v15 = "_handle_cellular_path: Session with IDSSessionID: %@ is not connected, state [%s].";
    v16 = v12;
    v17 = 22;
LABEL_12:
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, v15, &v19, v17);
    goto LABEL_13;
  }

  status = nw_path_get_status(v5);
  if (status != nw_path_status_satisfied)
  {
    v18 = status;
    v12 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_13;
    }

    v19 = 67109120;
    LODWORD(v20) = v18;
    v15 = "_handle_cellular_path: nw_path_status is: %d, return";
    v16 = v12;
    v17 = 8;
    goto LABEL_12;
  }

  [(IDSGlobalLink *)self _processDelayedCellularInterfaces];
  if ([(IDSGlobalLink *)self _isNWPathFlagsChanged:v6 existingPath:&self->_cellularNWPathFlags])
  {
    v8 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      cellularNWPathFlags = self->_cellularNWPathFlags;
      v19 = 67109120;
      LODWORD(v20) = cellularNWPathFlags;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_handle_cellular_path: for _cellularNWPathFlags: %u", &v19, 8u);
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v11 = objc_opt_respondsToSelector();

    if (v11)
    {
      v12 = objc_loadWeakRetained(&self->_delegate);
      [v12 link:self didCellularNWPathFlagsChanged:self->_cellularNWPathFlags];
LABEL_13:
    }
  }
}

- (unint64_t)defaultLinkType
{
  v15 = *MEMORY[0x1E69E9840];
  v3 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v3 && !*(v3 + 1))
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "no default link is specified yet.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"no default link is specified yet.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no default link is specified yet.");
        }
      }
    }

    return 0;
  }

  else
  {
    v4 = channelForStunCandidatePair((v3 + 1), (v3 + 17), *(v3 + 132));
    channelToCandidatePairs = self->_channelToCandidatePairs;
    if (channelToCandidatePairs && v4 && (v6 = CFDictionaryGetValue(channelToCandidatePairs, v4)) != 0)
    {
      v7 = v6;
      v8 = [v6 local];
      if ([v8 isCellularStunCandidate])
      {
        v9 = 4;
      }

      else
      {
        v9 = 3;
      }
    }

    else
    {
      v10 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v14 = v4;
        _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "failed to find default link for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find default link for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find default link for %@.");
          }
        }
      }

      v9 = 0;
    }
  }

  return v9;
}

- (BOOL)hasReachableInterface:(unint64_t)a3
{
  v16 = *MEMORY[0x1E69E9840];
  if (a3)
  {
    v3 = 30;
  }

  else
  {
    v3 = 2;
  }

  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v5)
  {
    v6 = *v12;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v4);
        }

        v8 = [*(*(&v11 + 1) + 8 * i) address];
        v9 = v8;
        if (v8 && v3 == *([v8 sa] + 1))
        {

          LOBYTE(v5) = 1;
          goto LABEL_15;
        }
      }

      v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v11 objects:v15 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

LABEL_15:

  return v5;
}

- (void)_addQRAAWDBlock:(id)a3 allocateRequestTime:(double)a4 inferredExternalRAT:(unsigned int)a5 stunTransport:(int64_t)a6 relayProviderType:(int64_t)a7 idsSessionID:(id)a8 reportingDataBlob:(id)a9 isInitiator:(BOOL)a10 serverSoftwareVersion:(id)a11
{
  v17 = a3;
  v18 = a8;
  v19 = a9;
  v20 = a11;
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B70D74;
  aBlock[3] = &unk_1E77E0BE8;
  v41 = a10;
  v37 = a4;
  v40 = a5;
  v21 = v17;
  v32 = v21;
  v22 = v20;
  v33 = v22;
  v34 = self;
  v38 = a7;
  v39 = a6;
  v23 = v18;
  v35 = v23;
  v24 = v19;
  v36 = v24;
  v25 = _Block_copy(aBlock);
  v26 = [v25 copy];

  allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  if (!allocateTimeReportBlocks)
  {
    v28 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v29 = self->_allocateTimeReportBlocks;
    self->_allocateTimeReportBlocks = v28;

    allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  }

  if (allocateTimeReportBlocks && v26)
  {
    CFArrayAppendValue(allocateTimeReportBlocks, v26);
  }
}

- (unsigned)_getExternalIPAddressRAT:(id)a3
{
  v4 = a3;
  v5 = [v4 length];
  if (v5 == 16)
  {
    memset(&v11[1], 170, 20);
    v11[0] = 0xAAAAAAAAAAAAAAAALL;
    *&v11[1] = *[v4 bytes];
    v9 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    RATForIPv6Address = GLUtilGetRATForIPv6Address(v11, v9);
  }

  else if (v5 == 4)
  {
    LODWORD(v11[0]) = 0;
    [v4 getBytes:v11 length:4];
    v6 = v11[0];
    v7 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    RATForIPv6Address = GLUtilGetRATForIPv4Address(v6, v7);
  }

  else
  {
    RATForIPv6Address = 10;
  }

  return RATForIPv6Address;
}

- (BOOL)_isAcceptedRelaySessionForAllocationRequestID:(id)a3 acceptedRelaySessionID:(id)a4
{
  v6 = a4;
  v7 = (([(NSMutableArray *)self->_targetedAllocations containsObject:a3]& 1) != 0 || [(NSString *)self->_acceptedRelaySessionID isEqualToString:v6]) && self->_isInitiator;

  return v7;
}

- (void)_connectNWTCPLink:(id)a3 disconnectAfterUse:(BOOL)a4 connectedHandler:(id)a5
{
  v8 = a3;
  v27 = a5;
  v34[0] = 0;
  v9 = [v8 local];
  v10 = [v9 index];

  v11 = [v8 local];
  v12 = [v11 address];

  v13 = *(v12 + 1);
  if (v13 == 30 || v13 == 2)
  {
    *(v12 + 2) = 0;
  }

  v15 = [v8 remote];
  v16 = [v15 external];

  [v8 setIsQUIC:1];
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B714AC;
  aBlock[3] = &unk_1E77E0C10;
  v17 = v8;
  v33 = v17;
  v18 = _Block_copy(aBlock);
  if (!a4)
  {
    [v17 setState:1];
  }

  if (IMGetDomainBoolForKey())
  {
    v19 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "forceH2FallbackToTCP enabled, fallback to TCP STUN", buf, 2u);
    }
  }

  else
  {
    nwLink = self->_nwLink;
    v25 = [v17 sessionID];
    v20 = [v17 relaySessionToken];
    v21 = [v17 relaySessionKey];
    v28[0] = MEMORY[0x1E69E9820];
    v28[1] = 3221225472;
    v28[2] = sub_1A7B71580;
    v28[3] = &unk_1E77E0C38;
    v28[4] = self;
    v22 = v17;
    v29 = v22;
    v30 = v27;
    LOBYTE(v24) = a4;
    v23 = [(IDSNWLink *)nwLink connectTCP:v10 localAddress:v12 remoteAddress:v16 clientUUID:self->_clientUUID sessionID:v25 relaySessionToken:v20 relaySessionKey:v21 randomSaltBlock:v18 newLocalPort:v34 disconnectAfterUse:v24 readyHandler:v28];

    if (v23 && v34[0])
    {
      [(IDSGlobalLink *)self _updateCandidatePair:v22 newLocalPort:?];
    }
  }
}

- (void)_connectNWLink:(id)a3 disconnectAfterUse:(BOOL)a4 connectedHandler:(id)a5
{
  v63 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v46 = a5;
  v54 = 0;
  v9 = [v8 local];
  v45 = [v9 index];

  v10 = [v8 local];
  v44 = [v10 address];

  v11 = [v8 remote];
  v43 = [v11 external];

  [v8 setIsQUIC:1];
  if (self->_ftPowerOptimizationEnabled && [v8 isRelayStunCandidatePair])
  {
    v12 = [v8 local];
    if ([v12 isCellularStunCandidate])
    {
      v13 = [v8 isQUIC];

      if (v13)
      {
        [v8 switchToOptimizedStatsInterval];
      }
    }

    else
    {
    }
  }

  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B71F9C;
  aBlock[3] = &unk_1E77E0C10;
  v14 = v8;
  v53 = v14;
  v15 = _Block_copy(aBlock);
  if (!a4)
  {
    [v14 setState:1];
  }

  v16 = IMGetDomainBoolForKey();
  v17 = IMGetDomainBoolForKey();
  v18 = v17;
  if (v16)
  {
    v19 = 0;
    if ((v17 & 1) == 0)
    {
LABEL_11:
      forceTCPFallbackOnCell = self->_forceTCPFallbackOnCell;
      goto LABEL_14;
    }
  }

  else
  {
    v19 = !self->_forceTCPFallbackOnWiFi;
    if ((v17 & 1) == 0)
    {
      goto LABEL_11;
    }
  }

  forceTCPFallbackOnCell = 1;
LABEL_14:
  v21 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    v22 = @"NO";
    if (v16)
    {
      v23 = @"YES";
    }

    else
    {
      v23 = @"NO";
    }

    v24 = self->_forceTCPFallbackOnCell;
    if (self->_forceTCPFallbackOnWiFi)
    {
      v25 = @"YES";
    }

    else
    {
      v25 = @"NO";
    }

    *buf = 138413058;
    v56 = v23;
    if (v18)
    {
      v26 = @"YES";
    }

    else
    {
      v26 = @"NO";
    }

    v57 = 2112;
    v58 = v25;
    if (v24)
    {
      v22 = @"YES";
    }

    v59 = 2112;
    v60 = v26;
    v61 = 2112;
    v62 = v22;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "connectNWLink forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
  }

  v27 = [v14 local];
  v28 = [v27 isCellularStunCandidate];

  if ((v19 | v28))
  {
    if (forceTCPFallbackOnCell & v28)
    {
      v29 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        v30 = "forceTCPFallbackOnWiFi is set, dont connect via cellular interface";
LABEL_33:
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, v30, buf, 2u);
      }
    }

    else
    {
      nwLink = self->_nwLink;
      v41 = [v14 sessionID];
      v40 = [v14 relaySessionToken];
      v31 = [v14 relaySessionKey];
      v32 = [v14 pskTransportParameters];
      v33 = [v14 pskH3Settings];
      v34 = v15;
      shouldEnable0RTT = self->_shouldEnable0RTT;
      shouldUsePathMTUDiscovery = self->_shouldUsePathMTUDiscovery;
      v47[0] = MEMORY[0x1E69E9820];
      v47[1] = 3221225472;
      v47[2] = sub_1A7B72070;
      v47[3] = &unk_1E77E0C60;
      v51 = a4;
      v39 = v14;
      v48 = v39;
      v49 = self;
      v50 = v46;
      BYTE2(v38) = shouldUsePathMTUDiscovery;
      BYTE1(v38) = shouldEnable0RTT;
      v15 = v34;
      LOBYTE(v38) = a4;
      v37 = [IDSNWLink connect:"connect:localAddress:remoteAddress:clientUUID:sessionID:relaySessionToken:relaySessionKey:randomSaltBlock:pskTransportParameters:pskH3Settings:newLocalPort:disconnectAfterUse:holdUntilFirstPacketReady:usePathMTUDiscovery:readyHandler:" localAddress:v45 remoteAddress:v44 clientUUID:v43 sessionID:self->_clientUUID relaySessionToken:v41 relaySessionKey:v40 randomSaltBlock:v31 pskTransportParameters:v34 pskH3Settings:v32 newLocalPort:v33 disconnectAfterUse:&v54 holdUntilFirstPacketReady:v38 usePathMTUDiscovery:v47 readyHandler:?];

      if (v37 && v54)
      {
        [(IDSGlobalLink *)self _updateCandidatePair:v39 newLocalPort:?];
      }

      v29 = v48;
    }
  }

  else
  {
    v29 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v30 = "forceTCPFallbackOnWiFi is set, dont connect via WiFi interface";
      goto LABEL_33;
    }
  }
}

- (void)setLinkSelectionStrategy:(id)a3
{
  v11 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = v5;
  if (self->_isLinkSelectionStrategyLockedIn)
  {
    v7 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.");
        }
      }
    }
  }

  else if (v5 && (IMGetDomainBoolForKeyWithDefaultValue() & 1) == 0)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v10 = v6;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Setting Link Selection Strategy: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Setting Link Selection Strategy: %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting Link Selection Strategy: %@");
        }
      }
    }

    objc_storeStrong(&self->_linkSelectionStrategy, a3);
  }
}

- (id)allLinkEngines
{
  v19 = *MEMORY[0x1E69E9840];
  v3 = [MEMORY[0x1E695DFA8] set];
  v4 = v3;
  if (self->_p2pLinkEngine)
  {
    [v3 addObject:?];
  }

  v16 = 0u;
  v17 = 0u;
  v14 = 0u;
  v15 = 0u;
  v5 = [(NSMutableDictionary *)self->_sessionsByID allValues];
  v6 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v14 + 1) + 8 * i);
        v11 = [v10 linkEngine];

        if (v11)
        {
          v12 = [v10 linkEngine];
          [v4 addObject:v12];
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
    }

    while (v7);
  }

  return v4;
}

- (id)_localCandidatesForRelaySession:(id)a3
{
  v38 = *MEMORY[0x1E69E9840];
  v4 = [a3 linkEngine];
  v5 = [v4 tag];
  v6 = v5;
  v7 = &stru_1F1AC8480;
  if (v5)
  {
    v7 = v5;
  }

  v26 = v7;

  if (self->_state < 5)
  {
    v25 = [MEMORY[0x1E695DF70] array];
    v27 = 0u;
    v28 = 0u;
    v29 = 0u;
    v30 = 0u;
    v8 = self->_interfaceAddressArray;
    v10 = [(NSMutableArray *)v8 countByEnumeratingWithState:&v27 objects:v31 count:16];
    if (!v10)
    {
      goto LABEL_29;
    }

    v11 = v10;
    v12 = *v28;
    while (1)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v28 != v12)
        {
          objc_enumerationMutation(v8);
        }

        v14 = *(*(&v27 + 1) + 8 * i);
        v15 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          v33 = v26;
          v34 = 2112;
          v35 = v14;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: checking %@", buf, 0x16u);
        }

        v16 = [(IDSGlobalLink *)v14 address];
        valid = IsValidSA([v16 sa]);

        if (valid)
        {
          v18 = [(IDSGlobalLink *)v14 address];
          if (*([v18 sa] + 1) == 2)
          {
            v19 = [(IDSGlobalLink *)v14 clat46];

            if (v19)
            {
              v20 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412546;
                v33 = v26;
                v34 = 2112;
                v35 = v14;
                _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: skipping clat46 ipv4 address %@", buf, 0x16u);
              }

              goto LABEL_26;
            }
          }

          else
          {
          }

          v20 = GLUtilCreateLocalCandidateForLinkEngine(v14);
          [v20 setPrefix:IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, [(IDSGlobalLink *)v14 index])];
          v23 = 0;
          if (self->_cellInterfaceName)
          {
            if ([v20 isCellularStunCandidate])
            {
              v21 = [v20 interfaceName];
              v22 = [v21 isEqualToIgnoringCase:self->_cellInterfaceName];

              if (v22)
              {
                v23 = 1;
              }
            }
          }

          [v20 setIsSlicedInterface:v23];
          [v25 addObject:v20];
LABEL_26:

          continue;
        }
      }

      v11 = [(NSMutableArray *)v8 countByEnumeratingWithState:&v27 objects:v31 count:16];
      if (!v11)
      {
        goto LABEL_29;
      }
    }
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(&v8->super.super, OS_LOG_TYPE_DEFAULT))
  {
    v9 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    v33 = v26;
    v34 = 2112;
    v35 = self;
    v36 = 2080;
    v37 = v9;
    _os_log_impl(&dword_1A7AD9000, &v8->super.super, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: %@ is in [%s] state, should have no active links.", buf, 0x20u);
  }

  v25 = MEMORY[0x1E695E0F0];
LABEL_29:

  return v25;
}

- (id)_remoteCandidatesForRelaySession:(id)a3
{
  v72 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 linkEngine];
  v6 = [v5 tag];
  v7 = v6;
  v8 = &stru_1F1AC8480;
  if (v6)
  {
    v8 = v6;
  }

  v44 = v8;

  if (self->_state < 5)
  {
    v70 = 0u;
    v71 = 0u;
    v68 = 0u;
    v69 = 0u;
    v66 = 0u;
    v67 = 0u;
    memset(buf, 0, sizeof(buf));
    memset(v64, 0, sizeof(v64));
    v12 = [v4 serverAddress];
    v13 = [v4 serverAddressV6];
    if (IMGetDomainBoolForKeyWithDefaultValue())
    {
      v14 = 0;
    }

    else
    {
      v14 = v13;
    }

    if (v12)
    {
      __memcpy_chk();
    }

    if (v14)
    {
      __memcpy_chk();
    }

    v43 = [MEMORY[0x1E695DF70] array];
    if (IsValidSA(v12))
    {
      v15 = GLUtilCreateRelayCandidateForLinkEngine(buf, 0, 0);
      [v43 addObject:v15];
    }

    if (IsValidSA(v14))
    {
      v16 = GLUtilCreateRelayCandidateForLinkEngine(v64, 0, 0);
      [v43 addObject:v16];
    }

    else
    {
      v53 = 0u;
      v54 = 0u;
      v51 = 0u;
      v52 = 0u;
      v16 = self->_interfaceAddressArray;
      v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v51 objects:v63 count:16];
      if (v17)
      {
        v18 = *v52;
        do
        {
          v19 = 0;
          do
          {
            if (*v52 != v18)
            {
              objc_enumerationMutation(v16);
            }

            v20 = *(*(&v51 + 1) + 8 * v19);
            v21 = [v20 address];
            if (IsValidSA([v21 sa]))
            {
              v22 = [v20 address];
              v23 = *([v22 sa] + 1) == 30;

              if (v23)
              {
                FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, [v20 index]);
                if (FirstPrefix)
                {
                  v25 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
                  {
                    v26 = [v20 index];
                    *v56 = 138412546;
                    *&v56[4] = v44;
                    *&v56[12] = 1024;
                    *&v56[14] = v26;
                    _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d", v56, 0x12u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v41 = v44;
                      v42 = [v20 index];
                      _IDSLogTransport(@"GL", @"IDS", @"_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d");
                      if (_IDSShouldLog())
                      {
                        v27 = [v20 index];
                        v41 = v44;
                        v42 = v27;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d");
                      }
                    }
                  }

                  *&v28 = 0xAAAAAAAAAAAAAAAALL;
                  *(&v28 + 1) = 0xAAAAAAAAAAAAAAAALL;
                  v61 = v28;
                  v62 = v28;
                  v59 = v28;
                  v60 = v28;
                  v57 = v28;
                  v58 = v28;
                  *v56 = v28;
                  *&v56[16] = v28;
                  if ([(IDSGlobalLink *)self _synthesizeNAT64ForAddress:buf withPrefix:FirstPrefix toAddress:v56, v41, v42])
                  {
                    v29 = GLUtilCreateRelayCandidateForLinkEngine(v56, 1, [v20 index]);
                    [v29 setIsNAT64:1];
                    [v29 setPrefix:FirstPrefix];
                    [v43 addObject:v29];
                  }
                }

                else
                {
                  v30 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
                  {
                    v31 = [v20 index];
                    *v56 = 138412546;
                    *&v56[4] = v44;
                    *&v56[12] = 1024;
                    *&v56[14] = v31;
                    _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.", v56, 0x12u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v41 = v44;
                      v42 = [v20 index];
                      _IDSLogTransport(@"GL", @"IDS", @"_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.");
                      if (_IDSShouldLog())
                      {
                        v32 = [v20 index];
                        v41 = v44;
                        v42 = v32;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.");
                      }
                    }
                  }

                  aBlock[0] = MEMORY[0x1E69E9820];
                  aBlock[1] = 3221225472;
                  aBlock[2] = sub_1A7B734A0;
                  aBlock[3] = &unk_1E77E0C88;
                  aBlock[4] = self;
                  v50 = v4;
                  v33 = _Block_copy(aBlock);
                  v34 = [v20 index];
                  v35 = [v20 name];
                  [(IDSGlobalLink *)self _getNAT64PrefixForInterface:v34 interfaceName:v35 completionBlock:v33];
                }
              }
            }

            else
            {
            }

            ++v19;
          }

          while (v17 != v19);
          v36 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v51 objects:v63 count:16];
          v17 = v36;
        }

        while (v36);
      }
    }

    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    v46 = 0u;
    v11 = v43;
    v37 = [v11 countByEnumeratingWithState:&v45 objects:v55 count:16];
    if (v37)
    {
      v38 = *v46;
      do
      {
        for (i = 0; i != v37; ++i)
        {
          if (*v46 != v38)
          {
            objc_enumerationMutation(v11);
          }

          [*(*(&v45 + 1) + 8 * i) setIsRealloc:{objc_msgSend(v4, "hasReceivedReallocIndication", v41, v42)}];
        }

        v37 = [v11 countByEnumeratingWithState:&v45 objects:v55 count:16];
      }

      while (v37);
    }
  }

  else
  {
    v9 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      *&buf[4] = v44;
      *&buf[12] = 2112;
      *&buf[14] = self;
      *&buf[22] = 2080;
      *&buf[24] = v10;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: %@ is in [%s] state, should have no active links.", buf, 0x20u);
    }

    v11 = MEMORY[0x1E695E0F0];
  }

  return v11;
}

- (int)_knownRemoteAvailableInterfaces
{
  v16 = *MEMORY[0x1E69E9840];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v2 = self->_remoteCandidateList;
  v3 = [(NSMutableArray *)v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = 0;
    v6 = *v12;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v2);
        }

        v8 = *(*(&v11 + 1) + 8 * i);
        if (([v8 linkFlags] & 4) == 0)
        {
          if ([v8 isCellularStunCandidate])
          {
            v9 = 1;
          }

          else
          {
            v9 = 2;
          }

          v5 |= v9;
        }
      }

      v4 = [(NSMutableArray *)v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v4);
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (BOOL)_isSessionAccepted:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = v4;
  if (self->_remoteAcceptedDevicePushTokens)
  {
    v26 = 0u;
    v27 = 0u;
    v24 = 0u;
    v25 = 0u;
    v6 = [v4 remotePushTokens];
    v7 = [v6 countByEnumeratingWithState:&v24 objects:v29 count:16];
    if (v7)
    {
      v8 = v7;
      v9 = *v25;
      v19 = *v25;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v25 != v9)
          {
            objc_enumerationMutation(v6);
          }

          v11 = *(*(&v24 + 1) + 8 * i);
          v20 = 0u;
          v21 = 0u;
          v22 = 0u;
          v23 = 0u;
          v12 = self->_remoteAcceptedDevicePushTokens;
          v13 = [(NSArray *)v12 countByEnumeratingWithState:&v20 objects:v28 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v21;
            while (2)
            {
              for (j = 0; j != v14; ++j)
              {
                if (*v21 != v15)
                {
                  objc_enumerationMutation(v12);
                }

                if ([v11 isEqualToPushToken:*(*(&v20 + 1) + 8 * j)])
                {

                  v17 = 1;
                  goto LABEL_21;
                }
              }

              v14 = [(NSArray *)v12 countByEnumeratingWithState:&v20 objects:v28 count:16];
              if (v14)
              {
                continue;
              }

              break;
            }
          }

          v9 = v19;
        }

        v8 = [v6 countByEnumeratingWithState:&v24 objects:v29 count:16];
        v17 = 0;
      }

      while (v8);
    }

    else
    {
      v17 = 0;
    }

LABEL_21:
  }

  else
  {
    v17 = 0;
  }

  return v17;
}

- (void)_updateLinksForSession:(id)a3
{
  v123 = *MEMORY[0x1E69E9840];
  v104 = a3;
  v4 = [v104 linkEngine];
  v5 = [v4 tag];
  v6 = v5;
  v7 = &stru_1F1AC8480;
  if (v5)
  {
    v7 = v5;
  }

  v103 = v7;

  [(IDSGlobalLink *)self _willUpdateLinksForSession:v104];
  remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
  if (!remoteAcceptedDevicePushTokens || ![(NSArray *)remoteAcceptedDevicePushTokens count])
  {
    v16 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v104 qrSessionID];
      v18 = [v104 sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = v17;
      v119 = 2048;
      v120 = [v18 allocateType];
      _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted", buf, 0x20u);
    }

    if (!os_log_shim_legacy_logging_enabled() || !_IDSShouldLogTransport())
    {
      v14 = 0;
      goto LABEL_28;
    }

    v19 = [v104 qrSessionID];
    v20 = [v104 sessionInfo];
    v89 = v19;
    v93 = [v20 allocateType];
    v85 = v103;
    _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted");

    v14 = 0;
    if ((_IDSShouldLog() & 1) == 0)
    {
      goto LABEL_28;
    }

    v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted";
    goto LABEL_25;
  }

  if ([(IDSGlobalLink *)self _isSessionAccepted:v104])
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = [v104 qrSessionID];
      v11 = [v104 sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = v10;
      v119 = 2048;
      v120 = [v11 allocateType];
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v12 = [v104 qrSessionID];
      v13 = [v104 sessionInfo];
      v89 = v12;
      v93 = [v13 allocateType];
      v85 = v103;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted");

      v14 = 1;
      if ((_IDSShouldLog() & 1) == 0)
      {
        goto LABEL_28;
      }

      v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted";
LABEL_25:
      v26 = [v104 qrSessionID];
      v27 = [v104 sessionInfo];
      v89 = v26;
      v93 = [v27 allocateType];
      v85 = v103;
      _IDSLogV(0, @"IDSFoundation", @"GL", v15);

      goto LABEL_28;
    }

    v14 = 1;
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v22 = [v104 qrSessionID];
      v23 = [v104 sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = v22;
      v119 = 2048;
      v120 = [v23 allocateType];
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v24 = [v104 qrSessionID];
      v25 = [v104 sessionInfo];
      v89 = v24;
      v93 = [v25 allocateType];
      v85 = v103;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted");

      v14 = 2;
      if ((_IDSShouldLog() & 1) == 0)
      {
        goto LABEL_28;
      }

      v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted";
      goto LABEL_25;
    }

    v14 = 2;
  }

LABEL_28:
  [v104 setAcceptStatus:{v14, v85, v89, v93}];
  v102 = [(IDSGlobalLink *)self _localCandidatesForRelaySession:v104];
  v28 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
  {
    v29 = [v104 qrSessionID];
    v30 = [v104 sessionInfo];
    v31 = [v30 allocateType];
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = v29;
    v119 = 2048;
    v120 = v31;
    v121 = 2112;
    v122 = v102;
    _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@", buf, 0x2Au);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v32 = [v104 qrSessionID];
      v33 = [v104 sessionInfo];
      v94 = [v33 allocateType];
      v97 = v102;
      v86 = v103;
      v90 = v32;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@");

      if (_IDSShouldLog())
      {
        v34 = [v104 qrSessionID];
        v35 = [v104 sessionInfo];
        v94 = [v35 allocateType];
        v97 = v102;
        v86 = v103;
        v90 = v34;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@");
      }
    }
  }

  v101 = [(IDSGlobalLink *)self _remoteCandidatesForRelaySession:v104, v86, v90, v94, v97];
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    v37 = [v104 qrSessionID];
    v38 = [v104 sessionInfo];
    v39 = [v38 allocateType];
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = v37;
    v119 = 2048;
    v120 = v39;
    v121 = 2112;
    v122 = v101;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@", buf, 0x2Au);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v40 = [v104 qrSessionID];
      v41 = [v104 sessionInfo];
      v95 = [v41 allocateType];
      v98 = v101;
      v87 = v103;
      v91 = v40;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@");

      if (_IDSShouldLog())
      {
        v42 = [v104 qrSessionID];
        v43 = [v104 sessionInfo];
        v95 = [v43 allocateType];
        v98 = v101;
        v87 = v103;
        v91 = v42;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@");
      }
    }
  }

  v44 = [v104 sessionInfo];
  v45 = [v44 ipPreference] == 1 || (IMGetDomainBoolForKey() & 1) != 0 || self->_forceIPv6;

  v46 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
  {
    v47 = [v104 sessionInfo];
    if ([v47 ipPreference] == 1)
    {
      v48 = @"YES";
    }

    else
    {
      v48 = @"NO";
    }

    if (IMGetDomainBoolForKey())
    {
      v49 = @"YES";
    }

    else
    {
      v49 = @"NO";
    }

    if (self->_forceIPv6)
    {
      v50 = @"YES";
    }

    else
    {
      v50 = @"NO";
    }

    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = v48;
    v119 = 2112;
    v120 = v49;
    v121 = 2112;
    v122 = v50;
    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: force IPv6 options server: %@; default: %@; manual: %@", buf, 0x2Au);
  }

  v51 = [v104 linkEngine];
  [v51 setIsQUICAndH2Enabled:self->_QUICForQREnabled];
  [v51 setShouldPreferIPv6:v45];
  v52 = [v104 sessionInfo];
  v53 = [v52 idsSessionID];
  [v51 setIdsSessionID:v53];

  v54 = [v104 sessionInfo];
  v55 = [v54 relaySessionID];
  [v51 setQrSessionID:v55];

  [v51 setRelayConnectionBehavior:{objc_msgSend(v104, "desiredRelayConnectionBehavior")}];
  [v51 setAllowOngoingTasks:{objc_msgSend(v104, "shouldLinkEngineAllowOngoingTasks")}];
  v56 = !self->_H2FallbackEnabled && self->_shouldFallbackToTCPFirst;
  [v51 setShouldFallbackToTCPFirst:v56];
  [v51 setIsH2Enabled:self->_H2FallbackEnabled];
  v57 = [v51 relayLinkProvider];
  [v57 setLocalCandidates:v102];

  v58 = [v104 sessionInfo];
  v59 = [v58 allocateType] == 3;

  if (v59)
  {
    v60 = [v51 relayLinkProvider];
    v61 = [v104 sessionInfo];
    v62 = [v61 relaySessionID];
    [v60 setRemoteCandidates:v101 withRelaySessionID:v62];
  }

  else
  {
    v63 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
    v60 = v63;
    if (v63)
    {
      v111 = 0u;
      v112 = 0u;
      v109 = 0u;
      v110 = 0u;
      v64 = 0;
      v65 = [v63 countByEnumeratingWithState:&v109 objects:v114 count:16];
      if (v65)
      {
        v66 = *v110;
        do
        {
          for (i = 0; i != v65; ++i)
          {
            if (*v110 != v66)
            {
              objc_enumerationMutation(v60);
            }

            if ([*(*(&v109 + 1) + 8 * i) isCellular])
            {
              v68 = 1;
            }

            else
            {
              v68 = 2;
            }

            v64 = v68 | v64;
          }

          v65 = [v60 countByEnumeratingWithState:&v109 objects:v114 count:16];
        }

        while (v65);
      }

      v100 = [(IDSGlobalLink *)self _knownRemoteAvailableInterfaces];
    }

    else
    {
      v100 = 0;
      v64 = 0;
    }

    v107 = 0u;
    v108 = 0u;
    v105 = 0u;
    v106 = 0u;
    v69 = v102;
    v70 = [(__CFString *)v69 countByEnumeratingWithState:&v105 objects:v113 count:16];
    if (v70)
    {
      v71 = *v106;
      do
      {
        for (j = 0; j != v70; ++j)
        {
          if (*v106 != v71)
          {
            objc_enumerationMutation(v69);
          }

          v73 = *(*(&v105 + 1) + 8 * j);
          if ([v73 isNAT64] && objc_msgSend(v73, "prefix"))
          {
            v74 = objc_alloc_init(IDSNAT64PrefixWrapper);
            v75 = [v73 prefix];
            [(IDSNAT64PrefixWrapper *)v74 setPrefix:*v75, v75[1]];
            [0 addObject:v74];
          }
        }

        v70 = [(__CFString *)v69 countByEnumeratingWithState:&v105 objects:v113 count:16];
      }

      while (v70);
    }

    [v51 setAvailableInterfaceTypesWithLocalTypes:v64 remoteTypes:v100];
  }

  v76 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v76, OS_LOG_TYPE_DEFAULT))
  {
    v77 = [v104 qrSessionID];
    v78 = [v104 sessionInfo];
    v79 = [v78 allocateType];
    v80 = qos_class_self();
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = v77;
    v119 = 2048;
    v120 = v79;
    v121 = 1024;
    LODWORD(v122) = v80;
    _os_log_impl(&dword_1A7AD9000, v76, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v81 = [v104 qrSessionID];
      v82 = [v104 sessionInfo];
      v96 = [v82 allocateType];
      v99 = qos_class_self();
      v88 = v103;
      v92 = v81;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...");

      if (_IDSShouldLog())
      {
        v83 = [v104 qrSessionID];
        v84 = [v104 sessionInfo];
        v96 = [v84 allocateType];
        v99 = qos_class_self();
        v88 = v103;
        v92 = v83;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...");
      }
    }
  }

  [v51 scheduleUpdate];
}

- (void)_updateAllLinks
{
  v14 = *MEMORY[0x1E69E9840];
  v9 = 0u;
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v3 = self->_sessionsByID;
  v4 = [(NSMutableDictionary *)v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v10;
    do
    {
      v7 = 0;
      do
      {
        if (*v10 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v9 + 1) + 8 * v7), v9];
        [(IDSGlobalLink *)self _updateLinksForSession:v8];

        ++v7;
      }

      while (v5 != v7);
      v5 = [(NSMutableDictionary *)v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
    }

    while (v5);
  }
}

- (void)_sendAllocbindForCandidatePair:(id)a3 session:(id)a4 glLinkProtocol:(int64_t)a5
{
  v95 = *MEMORY[0x1E69E9840];
  v81 = a3;
  v82 = a4;
  v8 = [v82 linkEngine];
  v9 = [v8 tag];
  v10 = v9;
  v11 = &stru_1F1AC8480;
  if (v9)
  {
    v11 = v9;
  }

  v80 = v11;

  v12 = ids_monotonic_time();
  v13 = [v81 local];

  if (v13)
  {
    v14 = [v81 local];
    v77 = [v14 radioAccessTechnology];
  }

  else
  {
    v77 = 10;
  }

  v15 = [v82 sessionInfoDict];
  if (v15)
  {
    v16 = @"allocate-time" == 0;
  }

  else
  {
    v16 = 1;
  }

  v17 = !v16;
  if (!v16)
  {
    v5 = [v82 sessionInfoDict];
    CFDictionaryGetValue(v5, @"allocate-time");
  }

  objc_opt_class();
  isKindOfClass = objc_opt_isKindOfClass();
  if (v17)
  {
  }

  v19 = 0.0;
  if (isKindOfClass)
  {
    v20 = [v82 sessionInfoDict];
    if (v20 != 0 && @"allocate-time" != 0)
    {
      v21 = [v82 sessionInfoDict];
      [CFDictionaryGetValue(v21 @"allocate-time")];
      v19 = v22;
    }

    else
    {
      [0 doubleValue];
      v19 = v23;
    }
  }

  v24 = [v82 sessionInfoDict];
  v79 = [v24 objectForKeyedSubscript:@"qrbv"];

  v25 = [v82 sessionInfo];
  v26 = [v25 allocateRequestID];
  v27 = [v81 remote];
  v28 = [v27 transport];
  v29 = [v82 sessionInfo];
  v30 = [v29 relayServerProviderType];
  idsSessionID = self->_idsSessionID;
  v32 = [v82 sessionInfo];
  v33 = [v32 reportingDataBlob];
  LOBYTE(v70) = self->_isInitiator;
  [(IDSGlobalLink *)self _addQRAAWDBlock:v26 allocateRequestTime:v77 inferredExternalRAT:v28 stunTransport:v30 relayProviderType:idsSessionID idsSessionID:v33 reportingDataBlob:v19 isInitiator:v70 serverSoftwareVersion:v79];

  if (self->_isInitiator)
  {
    if (self->_inviteSentTime == 0.0)
    {
      v34 = [v82 sessionInfoDict];
      if (v34 && @"gl-option-invite-sent-time")
      {
        v35 = [v82 sessionInfoDict];
        [CFDictionaryGetValue(v35 @"gl-option-invite-sent-time")];
        self->_inviteSentTime = v36;
      }

      else
      {
        [0 doubleValue];
        self->_inviteSentTime = v40;
      }
    }
  }

  else
  {
    if (self->_inviteRecvTime == 0.0)
    {
      v37 = [v82 sessionInfoDict];
      if (v37 && @"gl-option-invite-recv-time")
      {
        v38 = [v82 sessionInfoDict];
        [CFDictionaryGetValue(v38 @"gl-option-invite-recv-time")];
        self->_inviteRecvTime = v39;
      }

      else
      {
        [0 doubleValue];
        self->_inviteRecvTime = v41;
      }
    }

    v42 = [v82 sessionInfoDict];
    if (v42 && @"gl-option-use-secure-control-message")
    {
      v43 = [v82 sessionInfoDict];
      v44 = [CFDictionaryGetValue(v43 @"gl-option-use-secure-control-message")];
    }

    else
    {
      v44 = [0 BOOLValue];
    }

    if (!self->_useSecureControlMessage && v44)
    {
      self->_useSecureControlMessage = v44;
      v45 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v86 = v80;
        _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.");
          if (_IDSShouldLog())
          {
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.");
          }
        }
      }
    }
  }

  if (self->_allocbindStartTime == 0.0)
  {
    self->_allocbindStartTime = v12;
    if (self->_isInitiator)
    {
      v46 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        inviteSentTime = self->_inviteSentTime;
        allocbindStartTime = self->_allocbindStartTime;
        *buf = 138412802;
        v86 = v80;
        v87 = 2048;
        v88 = inviteSentTime;
        v89 = 2048;
        v90 = allocbindStartTime;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v73 = self->_inviteSentTime;
          v74 = self->_allocbindStartTime;
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.");
          if (_IDSShouldLog())
          {
            v73 = self->_inviteSentTime;
            v74 = self->_allocbindStartTime;
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.");
          }
        }
      }
    }

    else
    {
      if (self->_isUPlusOneSession)
      {
        self->_calleeAcceptTime = ids_monotonic_time();
        v12 = self->_allocbindStartTime;
      }

      v49 = ntpTime32(v12);
      self->_acceptDelayU32 = v49 - ntpTime32(self->_inviteRecvTime);
      v50 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
      {
        inviteRecvTime = self->_inviteRecvTime;
        v52 = self->_allocbindStartTime;
        acceptDelayU32 = self->_acceptDelayU32;
        *buf = 138413314;
        v86 = v80;
        v87 = 2048;
        v88 = inviteRecvTime;
        v89 = 2048;
        v90 = v52;
        v91 = 1024;
        *v92 = acceptDelayU32;
        *&v92[4] = 2048;
        *&v92[6] = v52 - inviteRecvTime;
        _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f", buf, 0x30u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v76 = self->_allocbindStartTime - self->_inviteRecvTime;
          v75 = self->_acceptDelayU32;
          v73 = self->_inviteRecvTime;
          v74 = self->_allocbindStartTime;
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
          if (_IDSShouldLog())
          {
            v76 = self->_allocbindStartTime - self->_inviteRecvTime;
            v75 = self->_acceptDelayU32;
            v73 = self->_inviteRecvTime;
            v74 = self->_allocbindStartTime;
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
          }
        }
      }
    }
  }

  metricsCollector = self->_metricsCollector;
  v55 = [v81 local];
  v56 = [v55 interfaceName];
  [(IDSGFTMetricsCollector *)metricsCollector willSendAllocbindRequestThroughInterface:v56];

  v57 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v58 = "Initiator";
    }

    else
    {
      v58 = "Receiver";
    }

    v59 = [(IDSGlobalLink *)self tagForCandidatePair:v81 glLinkProtocol:a5];
    v60 = [v82 idsSessionID];
    v61 = [v82 qrSessionID];
    v62 = [v81 isAcceptedRelaySession];
    v63 = @"NO";
    *buf = 138413570;
    v86 = v80;
    v87 = 2080;
    if (v62)
    {
      v63 = @"YES";
    }

    v88 = *&v58;
    v89 = 2112;
    v90 = *&v59;
    v91 = 2112;
    *v92 = v60;
    *&v92[8] = 2112;
    *&v92[10] = v61;
    v93 = 2112;
    v94 = v63;
    _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: *** Connect as %s, tag: %@, IDSSessionID: %@, QRSessionID: %@, Accepted: %@.", buf, 0x3Eu);
  }

  self->_hasPendingAllocation = 0;
  v64 = a5 & 0xF0;
  if (v64 == 32)
  {
    v67 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending over H2...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending over H2...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending over H2...");
        }
      }
    }

    v83[0] = MEMORY[0x1E69E9820];
    v83[1] = 3221225472;
    v83[2] = sub_1A7B75424;
    v83[3] = &unk_1E77E0C88;
    v83[4] = self;
    v84 = v81;
    [(IDSGlobalLink *)self _connectNWTCPLink:v84 disconnectAfterUse:0 connectedHandler:v83];
  }

  else if (v64 == 16)
  {
    v65 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending over H3...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending over H3...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending over H3...");
        }
      }
    }

    v66 = [v81 candidatePairToken];
    -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", v66, [v81 isRealloc], 0, 1, objc_msgSend(v81, "pendingNoSessionStateAllocbind"));
  }

  else
  {
    v68 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending STUN...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending STUN...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending STUN...");
        }
      }
    }

    [v81 setIsQUIC:{0, v72}];
    v69 = [v81 candidatePairToken];
    -[IDSGlobalLink _sendAllocbindRequest:stunMessage:isRealloc:inResponseToNoSessionState:](self, "_sendAllocbindRequest:stunMessage:isRealloc:inResponseToNoSessionState:", v69, 0, [v81 isRealloc], objc_msgSend(v81, "pendingNoSessionStateAllocbind"));
  }

  [(IDSGlobalLink *)self _reportAWDAllocateTime];
}

- (void)_sendInfoRequestForCandidatePair:(id)a3 glLinkProtocol:(int64_t)a4
{
  v4 = a4;
  v20 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = [v6 linkEngine];
  if (v7)
  {
    v8 = [v6 linkEngine];
    v9 = [v8 tag];
  }

  else
  {
    v9 = &stru_1F1AC8480;
  }

  if ((v4 & 0xF0) == 0x20)
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending over H2...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending over H2...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending over H2...");
        }
      }
    }

    v14[0] = MEMORY[0x1E69E9820];
    v14[1] = 3221225472;
    v14[2] = sub_1A7B758EC;
    v14[3] = &unk_1E77E0818;
    v15 = v6;
    [(IDSGlobalLink *)self _connectNWTCPLink:v15 disconnectAfterUse:1 connectedHandler:v14];
  }

  else if ((v4 & 0xF0) == 0x10)
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending over H3...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending over H3...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending over H3...");
        }
      }
    }

    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = sub_1A7B758E4;
    v16[3] = &unk_1E77E0818;
    v17 = v6;
    [(IDSGlobalLink *)self _connectNWLink:v17 disconnectAfterUse:1 connectedHandler:v16];
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending STUN...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v13 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending STUN...");
        if (_IDSShouldLog())
        {
          v13 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending STUN...");
        }
      }
    }

    [v6 setIsQUIC:{0, v13}];
    [v6 sendInfoRequest:0];
  }
}

- (id)tagForCandidatePair:(id)a3 glLinkProtocol:(int64_t)a4
{
  v4 = a4 & 0xF0;
  switch(v4)
  {
    case 16:
      v5 = @"h3";
      break;
    case 48:
      v5 = @"fakeTLS";
      break;
    case 32:
      v5 = @"h2";
      break;
    default:
      v5 = @"none";
      break;
  }

  v6 = a4 & 0xF00;
  v7 = @"unknown";
  switch(v6)
  {
    case 256:
      v8 = @"ids-relay";
      break;
    case 768:
      v8 = @"ids-p2p";
      break;
    case 512:
      v8 = @"ids-vr";
      break;
    default:
      v8 = @"unknown";
      break;
  }

  if ((a4 & 0xF) == 2)
  {
    v7 = @"tcp";
  }

  if ((a4 & 0xF) == 1)
  {
    v9 = @"udp";
  }

  else
  {
    v9 = v7;
  }

  v10 = a3;
  v11 = [v10 local];
  if (*([v11 address] + 1) == 2)
  {
    v12 = @"ipv4";
  }

  else
  {
    v12 = @"ipv6";
  }

  v13 = v12;

  v14 = [v10 local];

  v15 = [v14 interfaceName];

  v16 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%@.%@.%@.%@.%@", v15, v13, v9, v5, v8];

  return v16;
}

- (BOOL)_glLinkProtocolIsNWLink:(int64_t)a3
{
  result = 1;
  if ((a3 & 0xF0) != 0x10 && (a3 & 0xF0) != 0x20 && ((a3 & 0xF) != 1 || !self->_QUICForQREnabled))
  {
    return 0;
  }

  return result;
}

- (void)_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:(id)a3 remoteCandidate:(id)a4 glLinkProtocol:(int64_t)a5
{
  v39 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = [(IDSGlobalLink *)self _glLinkProtocolIsTCPRelay:a5];
  v11 = [(IDSGlobalLink *)self _glLinkProtocolIsFakeTLS:a5];
  if (v11 || v10)
  {
    if (v10 || v11)
    {
      v12 = 40;
      if (v10)
      {
        v12 = 32;
      }

      v13 = *(&self->super.isa + v12);
    }

    else
    {
      v13 = 0;
    }

    v14 = [v13 connect:objc_msgSend(v8 localAddress:"index") portRange:objc_msgSend(v8 remoteAddress:"address") clientUUID:LOWORD(self->_portRange) completionHandler:{objc_msgSend(v9, "external"), self->_clientUUID, 0}];
    if (v14)
    {
      v15 = v14;
      *&v16 = 0xAAAAAAAAAAAAAAAALL;
      *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v37 = v16;
      v38 = v16;
      v35 = v16;
      v36 = v16;
      v33 = v16;
      v34 = v16;
      *__str = v16;
      v32 = v16;
      SAToIPPortString(__str, 0x80uLL, [v8 address]);
      memcpy([v8 address], v15, *v15);
      *&v17 = 0xAAAAAAAAAAAAAAAALL;
      *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v29 = v17;
      v30 = v17;
      v27 = v17;
      v28 = v17;
      v25 = v17;
      v26 = v17;
      *v23 = v17;
      v24 = v17;
      SAToIPPortString(v23, 0x80uLL, [v8 address]);
      v18 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v19 = 136315394;
        v20 = __str;
        v21 = 2080;
        v22 = v23;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded: TCP connection: change the local address from %s to: %s", &v19, 0x16u);
      }
    }
  }
}

- (void)connectRelayLinkFromCandidate:(id)a3 toCandidate:(id)a4 withUniqueID:(id)a5 relaySessionID:(id)a6 glLinkProtocol:(int64_t)a7 replacesLinkWithUniqueID:(id)a8
{
  v148 = *MEMORY[0x1E69E9840];
  v125 = a3;
  v127 = a4;
  v128 = a5;
  v13 = a6;
  v126 = a8;
  v124 = v13;
  v14 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v13];
  v15 = v14;
  if (v14)
  {
    v16 = [v14 linkEngine];
    v17 = [v16 tag];
    v18 = v17;
    v19 = &stru_1F1AC8480;
    if (v17)
    {
      v19 = v17;
    }

    v20 = v19;

    v21 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v22 = [v127 isRealloc];
      *buf = 138413826;
      v23 = @"NO";
      v135 = v20;
      v136 = 2112;
      if (v22)
      {
        v23 = @"YES";
      }

      v137 = v128;
      v138 = 2112;
      v139 = v124;
      v140 = 2112;
      v141 = v125;
      v142 = 2112;
      v143 = v127;
      v144 = 2112;
      v145 = v126;
      v146 = 2112;
      v147 = v23;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: %@ relaySessionID=%@ fromCandidate:%@ toCandidate:%@ replacesLinkWithUniqueID:%@ isRealloc:%@", buf, 0x48u);
    }

    v24 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:v128];
    if (!v24)
    {
      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v135 = v20;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: creating candidate pair...", buf, 0xCu);
      }

      [(IDSGlobalLink *)self _connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:v125 remoteCandidate:v127 glLinkProtocol:a7];
      v26 = [v15 qrSessionID];
      v24 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v125 remoteCandidate:v127 sessionID:v26 delegate:self];

      [v24 setLinkUniqueName:v128];
      [v24 setGlLinkProtocol:a7];
      [v24 setReplacesLinkWithUniqueName:v126];
      v27 = [v24 remote];
      v28 = [v27 isRealloc];
      if (v126)
      {
        v29 = v28;
      }

      else
      {
        v29 = 0;
      }

      if (v29)
      {
        v30 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v135 = v20;
          _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: setting isRealloc=YES", buf, 0xCu);
        }

        [v24 setIsRealloc:1];
        [v24 setPendingRealloc:1];
      }

      v31 = [(IDSGlobalLink *)self tagForCandidatePair:v24 glLinkProtocol:a7];
      v131 = 0u;
      v132 = 0u;
      v129 = 0u;
      v130 = 0u;
      v32 = self->_debugDelayByTag;
      v33 = [(NSMutableDictionary *)v32 countByEnumeratingWithState:&v129 objects:v133 count:16];
      if (v33)
      {
        v34 = *v130;
        while (2)
        {
          for (i = 0; i != v33; ++i)
          {
            if (*v130 != v34)
            {
              objc_enumerationMutation(v32);
            }

            v36 = *(*(&v129 + 1) + 8 * i);
            if ([(IDSGlobalLink *)v31 containsString:v36])
            {
              v37 = [(NSMutableDictionary *)self->_debugDelayByTag objectForKeyedSubscript:v36];
              v38 = v37;
              if (v37)
              {
                [v37 doubleValue];
                [v24 setDebugDelay:?];
              }

              goto LABEL_32;
            }
          }

          v33 = [(NSMutableDictionary *)v32 countByEnumeratingWithState:&v129 objects:v133 count:16];
          if (v33)
          {
            continue;
          }

          break;
        }
      }

LABEL_32:

      v39 = [v15 sessionInfo];
      v40 = [v39 allocateRequestID];
      v41 = [v15 sessionInfo];
      v42 = [v41 relaySessionID];
      v43 = [(IDSGlobalLink *)self _isAcceptedRelaySessionForAllocationRequestID:v40 acceptedRelaySessionID:v42];

      if (self->_isSessionAcceptedWithNoCandidatePair && self->_acceptedRelaySessionID && self->_isInitiator)
      {
        self->_isSessionAcceptedWithNoCandidatePair = 0;
        v43 = 1;
      }

      [v24 setIsAcceptedRelaySession:v43];
      v44 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412802;
        v135 = v20;
        v136 = 2112;
        v137 = v31;
        v138 = 2112;
        v139 = v24;
        _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v107 = v31;
          v111 = v24;
          v105 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@");
          if (_IDSShouldLog())
          {
            v107 = v31;
            v111 = v24;
            v105 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@");
          }
        }
      }

      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      if (!tokenToCandidatePairs)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v47 = self->_tokenToCandidatePairs;
        self->_tokenToCandidatePairs = Mutable;

        tokenToCandidatePairs = self->_tokenToCandidatePairs;
      }

      v48 = [v24 candidatePairToken];
      [(NSMutableDictionary *)tokenToCandidatePairs setObject:v24 forKeyedSubscript:v48];

      [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair setObject:v24 forKeyedSubscript:v128];
      v49 = [v15 linkEngine];
      [v24 setLinkEngine:v49];

      v50 = [v15 sessionInfo];
      LODWORD(v48) = [v50 allocateType] == 3;

      if (v48)
      {
        v51 = [v15 sessionInfoDict];
        [v24 updateURIToParticipantIDMapping:v51];
      }
    }

    v52 = [v24 local];
    v53 = [v52 isCellularStunCandidate];

    if (v53)
    {
      v54 = [v24 local];
      [v54 setCellularSlicingFlags:self->_cellularSlicingFlags];
    }

    v55 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      v56 = [v15 sessionInfo];
      *buf = 138412546;
      v135 = v20;
      v136 = 2112;
      v137 = v56;
      _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        [v15 sessionInfo];
        v107 = v105 = v20;
        _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@");

        if (_IDSShouldLog())
        {
          [v15 sessionInfo];
          v107 = v105 = v20;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@");
        }
      }
    }

    v57 = [v15 sessionInfo];
    v58 = [v15 sessionInfoDict];
    [v24 setPropertiesWithRelaySessionInfo:v57 sessionInfoDict:v58 enableSKE:self->_enableSKE];

    v59 = [v15 sessionToken];
    [v24 setRelaySessionToken:v59];

    self->_hasPendingAllocation = 0;
    v60 = [v24 state];
    v61 = v60;
    if (v60 <= 4 && ((1 << v60) & 0x1A) != 0)
    {
      v62 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
      {
        v63 = [v24 candidatePairToken];
        v64 = (&_IDSStunCandidatePairStateStrings)[v61];
        *buf = 138412802;
        v135 = v20;
        v136 = 2112;
        v137 = v63;
        v138 = 2080;
        v139 = v64;
        _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v109 = [v24 candidatePairToken];
          v112 = (&_IDSStunCandidatePairStateStrings)[v61];
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]");

          if (_IDSShouldLog())
          {
            v110 = [v24 candidatePairToken];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]");
          }
        }
      }
    }

    else if ([v15 wantsToJoin])
    {
      if (self->_state <= 1)
      {
        v65 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
        {
          v66 = _IDSLinkStateStrings[self->_state];
          *buf = 138413058;
          v135 = v20;
          v136 = 2112;
          v137 = self;
          v138 = 2080;
          v139 = v66;
          v140 = 2080;
          v141 = off_1EB2B3E60[0];
          _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).", buf, 0x2Au);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v111 = _IDSLinkStateStrings[self->_state];
            v113 = off_1EB2B3E60[0];
            v106 = v20;
            v108 = self;
            _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).");
            if (_IDSShouldLog())
            {
              v111 = _IDSLinkStateStrings[self->_state];
              v113 = off_1EB2B3E60[0];
              v106 = v20;
              v108 = self;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).");
            }
          }
        }

        self->_state = 2;
      }

      v67 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
      {
        v68 = [v24 candidatePairToken];
        v69 = [v15 sessionToken];
        v115 = [v69 length];
        v117 = [v15 sessionInfo];
        v70 = [v117 relaySessionKey];
        v71 = [v70 length];
        v72 = [v15 sessionInfo];
        v73 = [v72 participantID];
        *buf = 138413314;
        v135 = v20;
        v136 = 2112;
        v137 = v68;
        v138 = 2048;
        v139 = v115;
        v140 = 2048;
        v141 = v71;
        v142 = 2048;
        v143 = v73;
        _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)", buf, 0x34u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v74 = [v24 candidatePairToken];
          v118 = [v15 sessionToken];
          v75 = [v118 length];
          v76 = [v15 sessionInfo];
          v77 = [v76 relaySessionKey];
          v78 = [v77 length];
          v79 = [v15 sessionInfo];
          v113 = v78;
          v114 = [v79 participantID];
          v108 = v74;
          v111 = v75;
          v106 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");

          if (_IDSShouldLog())
          {
            v80 = [v24 candidatePairToken];
            v119 = [v15 sessionToken];
            v81 = [v119 length];
            v82 = [v15 sessionInfo];
            v83 = [v82 relaySessionKey];
            v84 = [v83 length];
            v85 = [v15 sessionInfo];
            v113 = v84;
            v114 = [v85 participantID];
            v108 = v80;
            v111 = v81;
            v106 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");
          }
        }
      }

      [(IDSGlobalLink *)self _sendAllocbindForCandidatePair:v24 session:v15 glLinkProtocol:a7, v106, v108, v111, v113, v114];
    }

    else if ([v15 wantsInfo])
    {
      v86 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v86, OS_LOG_TYPE_DEFAULT))
      {
        v87 = [v24 candidatePairToken];
        v88 = [v15 sessionToken];
        v116 = [v88 length];
        v120 = [v15 sessionInfo];
        v89 = [v120 relaySessionKey];
        v90 = [v89 length];
        v91 = [v15 sessionInfo];
        v92 = [v91 participantID];
        *buf = 138413314;
        v135 = v20;
        v136 = 2112;
        v137 = v87;
        v138 = 2048;
        v139 = v116;
        v140 = 2048;
        v141 = v90;
        v142 = 2048;
        v143 = v92;
        _os_log_impl(&dword_1A7AD9000, v86, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)", buf, 0x34u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v93 = [v24 candidatePairToken];
          v121 = [v15 sessionToken];
          v94 = [v121 length];
          v95 = [v15 sessionInfo];
          v96 = [v95 relaySessionKey];
          v97 = [v96 length];
          v98 = [v15 sessionInfo];
          v113 = v97;
          v114 = [v98 participantID];
          v108 = v93;
          v111 = v94;
          v106 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");

          if (_IDSShouldLog())
          {
            v99 = [v24 candidatePairToken];
            v122 = [v15 sessionToken];
            v100 = [v122 length];
            v101 = [v15 sessionInfo];
            v102 = [v101 relaySessionKey];
            v103 = [v102 length];
            v104 = [v15 sessionInfo];
            v113 = v103;
            v114 = [v104 participantID];
            v108 = v99;
            v111 = v100;
            v106 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");
          }
        }
      }

      [(IDSGlobalLink *)self _sendInfoRequestForCandidatePair:v24 glLinkProtocol:a7, v106, v108, v111, v113, v114];
    }
  }

  else
  {
    v20 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E148A0();
    }
  }
}

- (void)disconnectRelayLinkWithUniqueID:(id)a3 glLinkProtocol:(int64_t)a4
{
  v14 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v13 = v6;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "disconnectRelayLinkWithUniqueID: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v11 = v6;
      _IDSLogTransport(@"GL", @"IDS", @"disconnectRelayLinkWithUniqueID: %@");
      if (_IDSShouldLog())
      {
        v11 = v6;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnectRelayLinkWithUniqueID: %@");
      }
    }
  }

  v8 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:v6, v11];
  if (v8)
  {
    v9 = [(IDSGlobalLink *)self _glLinkProtocolIsNWLink:a4];
    v10 = [v8 candidatePairToken];
    if (v9)
    {
      [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:v10 reason:8];
    }

    else
    {
      [(IDSGlobalLink *)self _sendUnallocbindRequest:v10 stunMessage:0 reason:8];
    }
  }
}

- (void)linkEngineDidRemoveLinkWithUniqueID:(id)a3
{
  v9 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v8 = v4;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "linkEngineDidRemoveLinkWithUniqueID: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v6 = v4;
      _IDSLogTransport(@"GL", @"IDS", @"linkEngineDidRemoveLinkWithUniqueID: %@");
      if (_IDSShouldLog())
      {
        v6 = v4;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkEngineDidRemoveLinkWithUniqueID: %@");
      }
    }
  }

  [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair setObject:0 forKeyedSubscript:v4, v6];
}

- (void)reconnectRelayLinkWithUniqueID:(id)a3 glLinkProtocol:(int64_t)a4
{
  v23 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:v6];
  if (v7)
  {
    v8 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = [v7 pendingNoSessionStateAllocbind];
      v10 = @"NO";
      if (v9)
      {
        v10 = @"YES";
      }

      *buf = 138412290;
      v18 = v10;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "reconnectRelayLinkWithUniqueID: pendingNoSessionStateAllocbind = %@", buf, 0xCu);
    }

    if (([v7 pendingNoSessionStateAllocbind] & 1) == 0)
    {
      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v7 withReason:5];
      [(IDSGlobalLink *)self _removeChannelFromChannelToCandidatePair:v7];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v7 withReason:5];
      }

      v11 = [v7 state];
      [v7 setState:1];
      [v7 setChannelNumber:0];
      [v7 setLinkID:0];
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = (&_IDSStunCandidatePairStateStrings)[v11];
        *buf = 136315650;
        v18 = v13;
        v19 = 2080;
        v20 = off_1EB2B43B0;
        v21 = 2112;
        v22 = v7;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v15 = off_1EB2B43B0;
          v16 = v7;
          v14 = (&_IDSStunCandidatePairStateStrings)[v11];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v15 = off_1EB2B43B0;
            v16 = v7;
            v14 = (&_IDSStunCandidatePairStateStrings)[v11];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      [(IDSGlobalLink *)self sendAllocbindRequest:v7 isRealloc:0 inResponseToNoSessionState:1 reconnectQUIC:[(IDSGlobalLink *)self _glLinkProtocolIsNWLink:a4, v14, v15, v16]];
      [v7 setPendingNoSessionState:1];
    }
  }
}

- (void)_reportNoSessionState:(id)a3 errorCode:(unsigned __int16)a4
{
  v8 = GLUCreateQRNoSessionStateEvent(a3, 237, a4);
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didAddQREvent:v8];
  }
}

- (id)linkEngineForSessionInfo:(id)a3
{
  v4 = a3;
  v5 = [IDSGLLinkEngine alloc];
  v6 = [[IDSWeakGLLinkConnector alloc] initWithGLLinkConnector:self];
  v7 = [v4 allocateType];
  v8 = [v4 isInitiator];
  useLinkSelection = self->_useLinkSelection;
  recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
  v11 = [(IDSGlobalLink *)self _accessLinkSelectionStrategy];
  v12 = [IDSServerBag sharedInstanceForBagType:0];
  v13 = [(IDSGLLinkEngine *)v5 initWithLinkConnector:v6 allocateType:v7 isInitiator:v8 useLinkSelection:useLinkSelection recordExpensiveQualityMetrics:recordExpensiveQualityMetrics linkSelectionStrategy:v11 serverBag:v12 timeFn:&unk_1F1AAA340];

  v14 = [v4 relaySessionID];
  [(IDSGLLinkEngine *)v13 setQrSessionID:v14];

  v15 = [v4 idsSessionID];
  [(IDSGLLinkEngine *)v13 setIdsSessionID:v15];

  v16 = MEMORY[0x1E696AEC0];
  v17 = [v4 idsSessionID];
  v18 = [v4 relaySessionID];

  v19 = [v16 stringWithFormat:@"GroupSession idsSessionID=%@ qrSessionID=%@", v17, v18];
  [(IDSGLLinkEngine *)v13 setTag:v19];

  [(IDSGLLinkEngine *)v13 registerEngine];

  return v13;
}

- (id)p2pLinkEngine
{
  if (self->_useLinkEngine)
  {
    v20 = v6;
    v21 = v5;
    v22 = v4;
    v23 = v3;
    v24 = v2;
    p2pLinkEngine = self->_p2pLinkEngine;
    if (!p2pLinkEngine)
    {
      v12 = [IDSGLP2PLinkEngineHandle alloc];
      useLinkSelection = self->_useLinkSelection;
      recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
      v15 = [IDSServerBag sharedInstanceForBagType:0];
      v16 = [(IDSGLP2PLinkEngineHandle *)v12 initUsingLinkSelection:useLinkSelection recordingExpensiveQualityMetrics:recordExpensiveQualityMetrics serverBag:v15 timeFn:&unk_1F1AAA360];
      v17 = self->_p2pLinkEngine;
      self->_p2pLinkEngine = v16;

      [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine registerEngine];
      p2pLinkEngine = self->_p2pLinkEngine;
    }

    [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine setAllowOngoingTasks:self->_allowP2P, v7, v20, v21, v22, v23, v24, v8];
    v18 = self->_p2pLinkEngine;
  }

  else
  {
    v18 = 0;
  }

  return v18;
}

- (void)startNewAllocationFromInterface:(int)a3 toInterface:(int)a4
{
  if (!self->_hasPendingAllocation)
  {
    v5 = a3;
    v7 = [(IDSGlobalLink *)self _knownRemoteAvailableInterfaces];
    v8 = v5 & 2;
    if ((a4 & 1) == 0 || v8 == 0)
    {
      v10 = 0;
    }

    else
    {
      v10 = 2;
    }

    if ((a4 & 1 & v5) != 0)
    {
      v11 = 8;
    }

    else
    {
      v11 = v10;
    }

    if ((v8 & a4) != 0)
    {
      v12 = 1;
    }

    else
    {
      v12 = v11;
    }

    self->_hasPendingAllocation = 1;
    v13 = im_primary_queue();
    v14[0] = MEMORY[0x1E69E9820];
    v14[1] = 3221225472;
    v14[2] = sub_1A7B777B4;
    v14[3] = &unk_1E77E0CB0;
    v14[4] = self;
    v16 = v12;
    v15 = v7;
    dispatch_async(v13, v14);
  }
}

- (id)_ensureSessionWithSessionInfo:(id)a3 sessionInfoDict:(id)a4 localInterfacePreference:(int)a5
{
  v5 = *&a5;
  v48 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  sessionsByID = self->_sessionsByID;
  v11 = [v8 relaySessionID];
  v12 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v11];

  v13 = +[IDSFoundationLog GlobalLink];
  v14 = os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
  if (v12)
  {
    if (v14)
    {
      v15 = [(IDSGlobalLinkSession *)v12 linkEngine];
      v16 = [v15 tag];
      v17 = v16;
      if (v16)
      {
        v18 = v16;
      }

      else
      {
        v18 = &stru_1F1AC8480;
      }

      v19 = [v8 relaySessionID];
      *buf = 138412546;
      v45 = v18;
      v46 = 2112;
      v47 = v19;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_ensureSessionWithSessionInfo[%@]: updating session info for session %@", buf, 0x16u);
    }

    [(IDSGlobalLinkSession *)v12 setSessionInfo:v8 sessionInfoDict:v9];
  }

  else
  {
    if (v14)
    {
      v20 = [v8 relaySessionID];
      *buf = 138412546;
      v45 = v20;
      v46 = 2048;
      v47 = [v8 allocateType];
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "creating IDSGlobalLinkSession for relaySessionID: %@ allocateType: %ld", buf, 0x16u);
    }

    v36 = self;
    v21 = [(IDSGlobalLink *)self linkEngineForSessionInfo:v8];
    v37 = v9;
    v12 = [[IDSGlobalLinkSession alloc] initWithSessionInfo:v8 sessionInfoDict:v9 linkEngine:v21];
    [(IDSGlobalLinkSession *)v12 setLocalInterfacePreference:v5];
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v38 = v8;
    v22 = [v8 allocatedPushTokens];
    v23 = [v22 countByEnumeratingWithState:&v39 objects:v43 count:16];
    if (v23)
    {
      v24 = v23;
      v25 = *v40;
      do
      {
        for (i = 0; i != v24; ++i)
        {
          if (*v40 != v25)
          {
            objc_enumerationMutation(v22);
          }

          v27 = *(*(&v39 + 1) + 8 * i);
          v28 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
          {
            v29 = [v21 tag];
            v30 = v29;
            *buf = 138412546;
            v31 = &stru_1F1AC8480;
            if (v29)
            {
              v31 = v29;
            }

            v45 = v31;
            v46 = 2112;
            v47 = v27;
            _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "_ensureSessionWithSessionInfo[%@]: session has push token %@", buf, 0x16u);
          }

          v32 = [(IDSGlobalLinkSession *)v12 remotePushTokens];
          [v32 addObject:v27];
        }

        v24 = [v22 countByEnumeratingWithState:&v39 objects:v43 count:16];
      }

      while (v24);
    }

    v33 = v36->_sessionsByID;
    v8 = v38;
    v34 = [v38 relaySessionID];
    [(NSMutableDictionary *)v33 setObject:v12 forKeyedSubscript:v34];

    [(IDSGlobalLink *)v36 _didCreateSession:v12];
    v9 = v37;
  }

  return v12;
}

- (void)configureGLExperimentsWithSessionInfo:(id)a3
{
  v53 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if (self->_areGLExperimentsLockedIn)
  {
    goto LABEL_71;
  }

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: Configuring GL experiments...", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: Configuring GL experiments...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: Configuring GL experiments...");
      }
    }
  }

  v6 = MEMORY[0x1AC562F80](@"com.apple.ids", @"x-force-session-exp");
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v48 = v6;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: qrForceExperiment: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v42 = v6;
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: qrForceExperiment: %@");
      if (_IDSShouldLog())
      {
        v42 = v6;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: qrForceExperiment: %@");
      }
    }
  }

  if (!self->_hasUseLinkEngineBeenProgramaticallyOverriden)
  {
    qrSessionExperiments = self->_qrSessionExperiments;
    v10 = _os_feature_enabled_impl();
    v8 = sub_1A7B69680(@"idsle", 1, qrSessionExperiments, v6, "LinkEngine", v10);
    self->_useLinkEngine = v8;
    if (!v8)
    {
      goto LABEL_19;
    }

LABEL_18:
    v11 = self->_qrSessionExperiments;
    v12 = _os_feature_enabled_impl();
    LOBYTE(v8) = sub_1A7B69680(@"idsls", 1, v11, v6, "LinkSelection", v12);
    goto LABEL_19;
  }

  if (self->_useLinkEngine)
  {
    goto LABEL_18;
  }

  LOBYTE(v8) = 0;
LABEL_19:
  self->_useLinkSelection = v8;
  self->_ftPowerOptimizationForceEnabled = sub_1A7B69680(@"idscel", 0, self->_qrSessionExperiments, v6, "CellularPowerOptimization", 1);
  v13 = [v4 objectForKeyedSubscript:@"gl-allow-expensive-metrics"];
  v14 = [v13 BOOLValue];

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = @"NO";
    recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
    if (self->_recordExpensiveQualityMetrics)
    {
      v18 = @"YES";
    }

    else
    {
      v18 = @"NO";
    }

    if (v14)
    {
      v19 = @"YES";
    }

    else
    {
      v19 = @"NO";
    }

    *buf = 138412802;
    v48 = v18;
    v49 = 2112;
    v50 = v19;
    if ((recordExpensiveQualityMetrics & v14) != 0)
    {
      v16 = @"YES";
    }

    v51 = 2112;
    v52 = v16;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v20 = self->_recordExpensiveQualityMetrics ? @"YES" : @"NO";
    v21 = v14 ? @"YES" : @"NO";
    v22 = (self->_recordExpensiveQualityMetrics & v14) != 0 ? @"YES" : @"NO";
    v43 = v21;
    v44 = v22;
    v42 = v20;
    _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@");
    if (_IDSShouldLog())
    {
      if (self->_recordExpensiveQualityMetrics)
      {
        v23 = @"YES";
      }

      else
      {
        v23 = @"NO";
      }

      if ((self->_recordExpensiveQualityMetrics & v14) != 0)
      {
        v24 = @"YES";
      }

      else
      {
        v24 = @"NO";
      }

      v43 = v21;
      v44 = v24;
      v42 = v23;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@");
    }
  }

  self->_recordExpensiveQualityMetrics &= v14;
  if (self->_useLinkSelection)
  {
    v25 = objc_alloc_init(IDSPacketDeduplicator);
    packetDeduplicator = self->_packetDeduplicator;
    self->_packetDeduplicator = v25;

    v27 = +[IDSLinkSelectionStrategy defaultStrategy];
    linkSelectionStrategy = self->_linkSelectionStrategy;
    self->_linkSelectionStrategy = v27;

    if (IMGetDomainBoolForKeyWithDefaultValue())
    {
      v29 = [IDSLinkSelectionStrategy adaptiveWithAllowedOverheadPerPacket:16 allowedPacketsPerSecond:1.0];
      v30 = self->_linkSelectionStrategy;
      self->_linkSelectionStrategy = v29;
    }

    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = self->_linkSelectionStrategy;
      *buf = 138412290;
      v48 = v32;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: Link selection strategy: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v42 = self->_linkSelectionStrategy;
        _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: Link selection strategy: %@");
        if (_IDSShouldLog())
        {
          v42 = self->_linkSelectionStrategy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: Link selection strategy: %@");
        }
      }
    }
  }

  else
  {
    v33 = [[IDSLinksQualityMeasurer alloc] initWithTimeFn:&unk_1F1AAA380];
    qualityMeasurer = self->_qualityMeasurer;
    self->_qualityMeasurer = v33;

    v35 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: start capturing quality metrics...", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: start capturing quality metrics...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: start capturing quality metrics...");
        }
      }
    }

    [(IDSLinksQualityMeasurer *)self->_qualityMeasurer startCapturingBasicStats:1 sendBursts:self->_recordExpensiveQualityMetrics completionHandler:&unk_1F1AAA3A0, v42, v43, v44];
  }

  v45[0] = @"idsle";
  v36 = [MEMORY[0x1E696AD98] numberWithBool:{self->_useLinkEngine, v42}];
  v45[1] = @"idsls";
  v46[0] = v36;
  v37 = [MEMORY[0x1E696AD98] numberWithBool:self->_useLinkSelection];
  v46[1] = v37;
  v38 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v46 forKeys:v45 count:2];
  glComputedSessionExperiments = self->_glComputedSessionExperiments;
  self->_glComputedSessionExperiments = v38;

  v40 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
  {
    v41 = self->_glComputedSessionExperiments;
    *buf = 138412290;
    v48 = v41;
    _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: computed session experiments: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: computed session experiments: %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: computed session experiments: %@");
      }
    }
  }

  self->_areGLExperimentsLockedIn = 1;

LABEL_71:
}

- (void)_connectWithSessionInfo:(id)a3 interfaceAddress:(id)a4 joinSession:(BOOL)a5 allocbindFailover:(BOOL)a6 completionHandler:(id)a7 withLocalInterfacePreference:(int)a8
{
  v340 = a5;
  v9 = a6;
  v396 = *MEMORY[0x1E69E9840];
  v12 = a3;
  v342 = a4;
  aBlock = a7;
  if (self->_acceptedRelaySessionID)
  {
    v13 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:?];
    v14 = v13;
    if (v13 && ([v13 linkEngine], v15 = objc_claimAutoreleasedReturnValue(), v15, v15))
    {
      v16 = MEMORY[0x1E696AEC0];
      v17 = [v14 linkEngine];
      v18 = [v17 tag];
      v19 = [v16 stringWithFormat:@"[%@] ", v18];
    }

    else
    {
      v19 = &stru_1F1AC8480;
    }
  }

  else
  {
    v19 = &stru_1F1AC8480;
  }

  if (!self->_cellularSlicingFlags)
  {
    v20 = [v12 objectForKeyedSubscript:@"gl-option-session-cell-slicing-flags"];
    self->_cellularSlicingFlags = [v20 unsignedIntValue];
  }

  state = self->_state;
  if (state < 5)
  {
    if (state >= 2 && !v340)
    {
      v22 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        v24 = _IDSLinkStateStrings[self->_state];
        *buf = 138412802;
        *&buf[4] = self;
        *&buf[12] = 2112;
        *&buf[14] = v19;
        *&buf[22] = 2080;
        *&buf[24] = v24;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "%@%@ is in [%s] state, skip sending info request.", buf, 0x20u);
      }

      goto LABEL_13;
    }

    v395 = 0u;
    v394 = 0u;
    v392 = 0u;
    v393 = 0u;
    v390 = 0u;
    v391 = 0u;
    memset(buf, 0, sizeof(buf));
    memset(v388, 0, sizeof(v388));
    v25 = objc_alloc_init(IDSQuickRelaySessionInfo);
    v26 = [(IDSQuickRelaySessionInfo *)v25 parseSessionInfo:v12];
    v27 = [(IDSQuickRelaySessionInfo *)v25 groupID];

    if (v27)
    {
      v28 = [(IDSQuickRelaySessionInfo *)v25 groupID];
      groupID = self->_groupID;
      self->_groupID = v28;
    }

    else
    {
      v30 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412290;
        *&v383[4] = v19;
        _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: groupID nil in session info.", v383, 0xCu);
      }
    }

    v31 = [(IDSQuickRelaySessionInfo *)v25 qrSessionExperiments];
    qrSessionExperiments = self->_qrSessionExperiments;
    self->_qrSessionExperiments = v31;

    [(IDSGlobalLink *)self configureGLExperimentsWithSessionInfo:v12];
    if (self->_ftPowerOptimizationForceEnabled)
    {
      v33 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412290;
        *&v383[4] = v19;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled is enabled by com.apple.ids default", v383, 0xCu);
      }

      self->_ftPowerOptimizationEnabled = 1;
      [(IDSNWLink *)self->_nwLink setFtPowerOptimizationEnabled:self->_ftPowerOptimizationForceEnabled];
    }

    else
    {
      v34 = [v12 objectForKey:@"idscel"];
      v35 = v34 == 0;

      if (v35)
      {
        v38 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled nil in session info", v383, 0xCu);
        }
      }

      else
      {
        v36 = [(IDSQuickRelaySessionInfo *)v25 ftPowerOptimizationEnabled];
        self->_ftPowerOptimizationEnabled = v36;
        if (v36)
        {
          v37 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = v19;
            _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled is enabled by session info", v383, 0xCu);
          }

          [(IDSNWLink *)self->_nwLink setFtPowerOptimizationEnabled:self->_ftPowerOptimizationEnabled];
        }
      }
    }

    if (IMGetDomainBoolForKeyWithDefaultValue() && [(IDSQuickRelaySessionInfo *)v25 allocateType]== 3)
    {
      v39 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 0;
        _os_log_impl(&dword_1A7AD9000, v39, OS_LOG_TYPE_DEFAULT, "shared sessions disabled.", v383, 2u);
      }

      goto LABEL_520;
    }

    v40 = [(IDSQuickRelaySessionInfo *)v25 allocateType];
    v338 = 0;
    if (self->_useLinkEngine && v40 != 2)
    {
      v338 = [(IDSGlobalLink *)self _ensureSessionWithSessionInfo:v25 sessionInfoDict:v12 localInterfacePreference:a8];
      if ([v338 wantsToJoin]&& !v340)
      {
        v41 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: we are already joining session, ignore connect request here", v383, 0xCu);
        }

        goto LABEL_519;
      }

      if (v340)
      {
        [v338 setWantsToJoin:1];
      }

      else if (([v338 wantsToJoin]& 1) == 0)
      {
        [v338 setWantsInfo:1];
      }

      v42 = [v338 sessionInfoDict];
      v43 = [v42 copy];

      v371[1] = MEMORY[0x1E69E9820];
      v371[2] = 3221225472;
      v371[3] = sub_1A7B7CACC;
      v371[4] = &unk_1E77E0C88;
      v372 = v19;
      v373 = v43;
      cut_dispatch_log_queue();
    }

    v333 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:1];
    if (v26)
    {
      if (self->_networkAddressChangeTimer)
      {
        v44 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
        {
          networkAddressChangeTimer = self->_networkAddressChangeTimer;
          *v383 = 134218240;
          *&v383[4] = v26;
          *&v383[12] = 2048;
          *&v383[14] = networkAddressChangeTimer;
          _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "error code = %ld, interface change timer: %p", v383, 0x16u);
        }

        goto LABEL_519;
      }

      if (!v333 || !v9)
      {
        v77 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
        {
          v78 = @"NO";
          if (v333)
          {
            v79 = @"YES";
          }

          else
          {
            v79 = @"NO";
          }

          *v383 = 134218498;
          *&v383[4] = v26;
          *&v383[12] = 2112;
          *&v383[14] = v79;
          if (v9)
          {
            v78 = @"YES";
          }

          *&v383[22] = 2112;
          *&v383[24] = v78;
          _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "error code = %ld, hasConnectedCandidatePair = %@, allocbindFailover = %@", v383, 0x20u);
        }

        sub_1A7B7CB88(aBlock, v26, @"Invalid session info");
        goto LABEL_519;
      }
    }

    if (!self->_avcDataBlob)
    {
      v46 = [(IDSQuickRelaySessionInfo *)v25 avcDataBlob];
      v47 = v46 == 0;

      if (!v47)
      {
        v48 = [(IDSQuickRelaySessionInfo *)v25 avcDataBlob];
        avcDataBlob = self->_avcDataBlob;
        self->_avcDataBlob = v48;

        v50 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
        {
          v51 = self->_avcDataBlob;
          *v383 = 138412546;
          *&v383[4] = v19;
          *&v383[12] = 2112;
          *&v383[14] = v51;
          _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: _avcDataBlob: %@", v383, 0x16u);
        }
      }
    }

    v52 = [(IDSQuickRelaySessionInfo *)v25 quicMaterialExchangeProvider];

    if (v52)
    {
      v53 = [(IDSQuickRelaySessionInfo *)v25 quicMaterialExchangeProvider];
      quicMaterialExchangeProvider = self->_quicMaterialExchangeProvider;
      self->_quicMaterialExchangeProvider = v53;

      [(IDSGroupQUICMaterialExchangeProvider *)self->_quicMaterialExchangeProvider addHandler:self];
    }

    if ([(IDSQuickRelaySessionInfo *)v25 h2FallbackDisabled]&& self->_H2FallbackEnabled)
    {
      self->_H2FallbackEnabled = 0;
      v55 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
      {
        v56 = @"NO";
        if (self->_H2FallbackEnabled)
        {
          v56 = @"YES";
        }

        *v383 = 138412546;
        *&v383[4] = v19;
        *&v383[12] = 2112;
        *&v383[14] = v56;
        _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: set _H2FallbackEnabled to %@", v383, 0x16u);
      }
    }

    self->_H2FallbackEnabled = IMGetDomainBoolForKeyWithDefaultValue();
    v57 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      v58 = @"NO";
      if (self->_H2FallbackEnabled)
      {
        v58 = @"YES";
      }

      *v383 = 138412546;
      *&v383[4] = v19;
      *&v383[12] = 2112;
      *&v383[14] = v58;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: _H2FallbackEnabled after reading forceH2FallbackEnabled: %@", v383, 0x16u);
    }

    v337 = [(IDSQuickRelaySessionInfo *)v25 allocateType];
    v336 = [(IDSQuickRelaySessionInfo *)v25 allocateRequestID];
    if (v337 == 3 && v340)
    {
      self->_sharedSessionJoined = 1;
      v59 = ids_monotonic_time();
    }

    else
    {
      v59 = ids_monotonic_time();
      if (v337 == 2)
      {
        if ([(NSMutableArray *)self->_selfAllocateRequestIDs containsObject:v336])
        {
          v60 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412546;
            *&v383[4] = v19;
            *&v383[12] = 2112;
            *&v383[14] = v336;
            _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "%@receive self allocate response for request %@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = &v19->isa;
              v311 = v336;
              _IDSLogTransport(@"GL", @"IDS", @"%@receive self allocate response for request %@.");
              if (_IDSShouldLog())
              {
                p_isa = &v19->isa;
                v311 = v336;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"%@receive self allocate response for request %@.");
              }
            }
          }

          [(IDSGlobalLink *)self _sendAllocbindRequestForExtIP:v25 startTime:v59, p_isa, v311];
          [(NSMutableArray *)self->_selfAllocateRequestIDs removeObject:v336];
          if ([(NSMutableArray *)self->_selfAllocateRequestIDs count])
          {
            v61 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v61, OS_LOG_TYPE_DEFAULT))
            {
              v62 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
              *v383 = 138412546;
              *&v383[4] = v19;
              *&v383[12] = 2048;
              *&v383[14] = v62;
              _os_log_impl(&dword_1A7AD9000, v61, OS_LOG_TYPE_DEFAULT, "%@selfAllocation count = %lu", v383, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v312 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
                _IDSLogTransport(@"GL", @"IDS", @"%@selfAllocation count = %lu");
                if (_IDSShouldLog())
                {
                  [(NSMutableArray *)self->_selfAllocateRequestIDs count:v19];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@selfAllocation count = %lu");
                }
              }
            }
          }

          else
          {
            self->_hasPendingSelfAllocation = 0;
            [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
          }
        }

        else
        {
          v82 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412546;
            *&v383[4] = v19;
            *&v383[12] = 2112;
            *&v383[14] = v336;
            _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "%@receive self allocate response for unknown request %@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"%@receive self allocate response for unknown request %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"%@receive self allocate response for unknown request %@.");
              }
            }
          }
        }

        goto LABEL_518;
      }
    }

    self->_isInitiator = [(IDSQuickRelaySessionInfo *)v25 isInitiator];
    self->_uplinkNackDisabled = [(IDSQuickRelaySessionInfo *)v25 uplinkNackDisabled];
    self->_conversationShouldUseP2PTLEAccordingToServer = [(IDSQuickRelaySessionInfo *)v25 transportLayerEncryptionDisabled];
    self->_ipDiscoveryDisabled = [(IDSQuickRelaySessionInfo *)v25 ipDiscoveryDisabled];
    if (self->_useLinkEngine)
    {
      if (!self->_idsSessionID)
      {
        v63 = [(IDSQuickRelaySessionInfo *)v25 idsSessionID];
        idsSessionID = self->_idsSessionID;
        self->_idsSessionID = v63;

        memset(v378, 170, 16);
        v65 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:self->_idsSessionID];
        [v65 getUUIDBytes:v378];

        v66 = [MEMORY[0x1E695DEF0] dataWithBytes:v378 length:16];
        controlMessageKey = self->_controlMessageKey;
        self->_controlMessageKey = v66;

        v68 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
        {
          v69 = self->_idsSessionID;
          cbuuid = self->_cbuuid;
          *v383 = 138412802;
          *&v383[4] = v19;
          *&v383[12] = 2112;
          *&v383[14] = v69;
          *&v383[22] = 2112;
          *&v383[24] = cbuuid;
          _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "%@update ids-session-id:%@ for cbuuid:%@.", v383, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v311 = self->_idsSessionID;
            v316 = self->_cbuuid;
            p_isa = &v19->isa;
            _IDSLogTransport(@"GL", @"IDS", @"%@update ids-session-id:%@ for cbuuid:%@.");
            if (_IDSShouldLog())
            {
              v311 = self->_idsSessionID;
              v316 = self->_cbuuid;
              p_isa = &v19->isa;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"%@update ids-session-id:%@ for cbuuid:%@.");
            }
          }
        }
      }

      v71 = [(IDSGlobalLink *)self _localCandidatesForRelaySession:v338, p_isa, v311, v316];
      v72 = [v71 count] == 0;

      if (v72)
      {
        v80 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v80, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v80, OS_LOG_TYPE_DEFAULT, "%@Found no local interface available for QR.", v383, 0xCu);
        }

        if (!v333)
        {
          sub_1A7B7CB88(aBlock, 6, @"No local interface available");
          if (self->_clientType == 6)
          {
            v81 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v81, OS_LOG_TYPE_DEFAULT))
            {
              *v383 = 138412290;
              *&v383[4] = v19;
              _os_log_impl(&dword_1A7AD9000, v81, OS_LOG_TYPE_DEFAULT, "%@Found no local interface available for QR. - gathering ABC with packet capture", v383, 0xCu);
            }

            [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"NoLocalNetwork" duration:15];
          }
        }
      }

      else
      {
        if (aBlock)
        {
          v73 = _Block_copy(aBlock);
          connectReadyHandler = self->_connectReadyHandler;
          self->_connectReadyHandler = v73;
        }

        [(IDSGlobalLink *)self _updateLinksForSession:v338];
      }

      goto LABEL_518;
    }

    key = [(IDSQuickRelaySessionInfo *)v25 relaySessionID];
    v329 = [(IDSQuickRelaySessionInfo *)v25 relaySessionToken];
    v328 = [(IDSQuickRelaySessionInfo *)v25 relaySessionKey];
    v321 = [(IDSQuickRelaySessionInfo *)v25 participantID];
    [(IDSQuickRelaySessionInfo *)v25 serverAddress];
    [(IDSQuickRelaySessionInfo *)v25 serverAddressIPv6];
    __memcpy_chk();
    __memcpy_chk();
    valid = IsValidSA(v388);
    acceptedRelaySessionID = self->_acceptedRelaySessionID;
    v76 = [(IDSQuickRelaySessionInfo *)v25 ipPreference]== 1 || (IMGetDomainBoolForKey() & 1) != 0 || self->_forceIPv6;
    v330 = v76;
    v83 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
    {
      if ([(IDSQuickRelaySessionInfo *)v25 ipPreference]== 1)
      {
        v84 = @"YES";
      }

      else
      {
        v84 = @"NO";
      }

      if (IMGetDomainBoolForKey())
      {
        v85 = @"YES";
      }

      else
      {
        v85 = @"NO";
      }

      if (self->_forceIPv6)
      {
        v86 = @"YES";
      }

      else
      {
        v86 = @"NO";
      }

      *v383 = 138412802;
      *&v383[4] = v84;
      *&v383[12] = 2112;
      *&v383[14] = v85;
      *&v383[22] = 2112;
      *&v383[24] = v86;
      _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "force IPv6 options server: %@; default: %@; manual: %@", v383, 0x20u);
    }

    if (self->_disablePureLinkFeature)
    {
      v87 = 2.0;
    }

    else
    {
      v87 = 1.0;
    }

    v88 = +[IDSServerBag sharedInstance];
    v89 = [v88 objectForKey:@"disable-transport-score-cards"];
    v90 = [v89 BOOLValue];

    if (v337 != 3 && !v9)
    {
      v91 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      HasNonSharedRelayCandidatePair = GLUtilHasNonSharedRelayCandidatePair(key, v91);

      if (HasNonSharedRelayCandidatePair)
      {
        v93 = +[IDSServerBag sharedInstance];
        v324 = [v93 objectForKey:@"ids-disallow-receiver-fallback"];

        if ([v324 BOOLValue])
        {
          v94 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = key;
            v95 = "disallowReceiverFallbackBagValue enabled: relay session %@ already exists, ignore.";
LABEL_154:
            _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, v95, v383, 0xCu);
            goto LABEL_155;
          }

          goto LABEL_155;
        }

        if (self->_isInitiator)
        {
          v94 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = key;
            v95 = "relay session %@ already exists, ignore.";
            goto LABEL_154;
          }

LABEL_155:

LABEL_517:
LABEL_518:

LABEL_519:
          v39 = v338;
LABEL_520:

          goto LABEL_521;
        }
      }
    }

    v96 = v342;
    if (!v342)
    {
      v97 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v97, OS_LOG_TYPE_DEFAULT))
      {
        interfaceAddressArray = self->_interfaceAddressArray;
        *v383 = 138412290;
        *&v383[4] = interfaceAddressArray;
        _os_log_impl(&dword_1A7AD9000, v97, OS_LOG_TYPE_DEFAULT, "current available interfaces: %@.", v383, 0xCu);
      }

      v96 = 0;
    }

    if (!v9)
    {
      if (!self->_connectingCandidatePairSessionInfo)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
        self->_connectingCandidatePairSessionInfo = Mutable;
      }

      v101 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412546;
        *&v383[4] = key;
        *&v383[12] = 2112;
        *&v383[14] = @"NO";
        _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "add relaySessionID: %@, allocbindFailover: %@", v383, 0x16u);
      }

      v102 = [v12 copy];
      if (v102)
      {
        CFDictionarySetValue(self->_connectingCandidatePairSessionInfo, key, v102);
      }

      else
      {
        v103 = MEMORY[0x1E69E9C10];
        v104 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v103, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14910();
        }
      }

      v96 = v342;
    }

    v371[0] = 0;
    if (((v337 == 3) & (v90 ^ 1 | v330)) != 0)
    {
      if (v96)
      {
        v105 = acceptedRelaySessionID != 0;
        v106 = [(IDSQuickRelaySessionInfo *)v25 linkProtocol];
        isInitiator = self->_isInitiator;
        v108 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        v371[0] = GLUtilSelectStunTransport(key, v106, 1, isInitiator, v105, v9, v108, self->_state);

        if ((v371[0] - 3) <= 1 && self->_state == 4)
        {
          v109 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
          {
            v110 = (&_IDSStunTransportStrings)[v371[0]];
            *v383 = 136315650;
            *&v383[4] = v110;
            *&v383[12] = 2112;
            *&v383[14] = key;
            *&v383[22] = 2112;
            *&v383[24] = v336;
            _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "skip %s for session %@, alloc reqID %@ link is connected.", v383, 0x20u);
          }

LABEL_178:

          goto LABEL_517;
        }

        v117 = v342;
        goto LABEL_195;
      }

      v370 = 0;
      [(IDSGlobalLink *)self _selectStunTransport:v371 andInterfaceAddress:&v370 forRelaySessionID:key preferIPv4:!v330 isValidSA:valid];
      v117 = v370;
    }

    else
    {
      v111 = acceptedRelaySessionID != 0;
      v112 = [(IDSQuickRelaySessionInfo *)v25 linkProtocol];
      v113 = self->_isInitiator;
      v114 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v371[0] = GLUtilSelectStunTransport(key, v112, v337 == 3, v113, v111, v9, v114, self->_state);

      v115 = v371[0];
      if ((v371[0] - 3) <= 1 && self->_state == 4)
      {
        v109 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
        {
          v116 = (&_IDSStunTransportStrings)[v371[0]];
          *v383 = 136315650;
          *&v383[4] = v116;
          *&v383[12] = 2112;
          *&v383[14] = key;
          *&v383[22] = 2112;
          *&v383[24] = v336;
          _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "skip %s for session %@, alloc reqID %@, link is connected.", v383, 0x20u);
        }

        goto LABEL_178;
      }

      v117 = v342;
      if (v342)
      {
LABEL_195:
        v342 = v117;
        v334 = [v117 index];
        v125 = [v342 address];
        v126 = *([v125 sa] + 1);

        v127 = (v330 || !self->_disablePureLinkFeature) && valid;
        v128 = v126 == 30 && v127;
        v129 = buf;
        if (v128)
        {
          v129 = v388;
        }

        v323 = v129;
        v322 = v127;
        if (!self->_H2FallbackEnabled)
        {
          v325 = v371[0];
          goto LABEL_221;
        }

        if (v371[0] == 3)
        {
          v130 = 4;
        }

        else
        {
          if (v371[0] != 4)
          {
            v325 = v371[0];
            goto LABEL_218;
          }

          v130 = 3;
        }

        v325 = v130;
LABEL_218:
        v136 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
        {
          v137 = (&_IDSStunTransportStrings)[v371[0]];
          v138 = (&_IDSStunTransportStrings)[v325];
          *v383 = 136315394;
          *&v383[4] = v137;
          *&v383[12] = 2080;
          *&v383[14] = v138;
          _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "current stunTransport is: %s, actualSelectedTransport is: %s", v383, 0x16u);
        }

LABEL_221:
        v139 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v139, OS_LOG_TYPE_DEFAULT))
        {
          if (v126 == 30)
          {
            v140 = "v6";
          }

          else
          {
            v140 = "v4";
          }

          v141 = [v342 name];
          v142 = (&_IDSStunTransportStrings)[v325];
          v143 = [(IDSQuickRelaySessionInfo *)v25 isInternal];
          v144 = "prod";
          *v383 = 136316674;
          *&v383[4] = v140;
          *&v383[12] = 2112;
          if (v143)
          {
            v144 = "carry";
          }

          *&v383[14] = v141;
          v145 = @"NO";
          *&v383[24] = v142;
          *&v383[22] = 2080;
          if (valid)
          {
            v145 = @"YES";
          }

          *v384 = 2112;
          *&v384[2] = v336;
          *&v384[10] = 2080;
          *&v384[12] = v144;
          *&v384[20] = 1024;
          *&v384[22] = v322;
          *&v384[26] = 2112;
          *&v384[28] = v145;
          _os_log_impl(&dword_1A7AD9000, v139, OS_LOG_TYPE_DEFAULT, "selected %s interface [%@] for [%s] allocation %@, %s QR server, isConnectToQRIPv6Enabled = %d, isValidSA = %@", v383, 0x44u);
        }

        metricsCollector = self->_metricsCollector;
        v147 = [v342 name];
        [(IDSGFTMetricsCollector *)metricsCollector selectedLocalInterface:v147];

        if (v322 || v126 != 30)
        {
          FirstPrefix = 0;
        }

        else
        {
          FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, v334);
          if (!FirstPrefix)
          {
            v184 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v184, OS_LOG_TYPE_DEFAULT))
            {
              v185 = [v342 index];
              *v383 = 67109120;
              *&v383[4] = v185;
              _os_log_impl(&dword_1A7AD9000, v184, OS_LOG_TYPE_DEFAULT, "delay connectWithSessionInfo for if:%d nat64 prefix.", v383, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v303 = [v342 index];
                _IDSLogTransport(@"GL", @"IDS", @"delay connectWithSessionInfo for if:%d nat64 prefix.");
                if (_IDSShouldLog())
                {
                  [v342 index];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"delay connectWithSessionInfo for if:%d nat64 prefix.");
                }
              }
            }

            v364[0] = MEMORY[0x1E69E9820];
            v364[1] = 3221225472;
            v364[2] = sub_1A7B7CCA0;
            v364[3] = &unk_1E77E0CD8;
            v364[4] = self;
            v365 = v12;
            v342 = v342;
            v366 = v342;
            v369 = v340;
            v367 = aBlock;
            v368 = a8;
            v186 = _Block_copy(v364);
            v187 = [v342 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:v334 interfaceName:v187 completionBlock:v186];

            goto LABEL_517;
          }

          v149 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 67109120;
            *&v383[4] = v334;
            _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "nat64 prefix cache hit for if:%d", v383, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = v334;
              _IDSLogTransport(@"GL", @"IDS", @"nat64 prefix cache hit for if:%d");
              if (_IDSShouldLog())
              {
                p_isa = v334;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"nat64 prefix cache hit for if:%d");
              }
            }
          }
        }

        if (!self->_idsSessionID)
        {
          v150 = [(IDSQuickRelaySessionInfo *)v25 idsSessionID];
          v151 = self->_idsSessionID;
          self->_idsSessionID = v150;

          memset(v378, 170, 16);
          v152 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:self->_idsSessionID];
          [v152 getUUIDBytes:v378];

          v153 = [MEMORY[0x1E695DEF0] dataWithBytes:v378 length:16];
          v154 = self->_controlMessageKey;
          self->_controlMessageKey = v153;

          v155 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v155, OS_LOG_TYPE_DEFAULT))
          {
            v156 = self->_idsSessionID;
            v157 = self->_cbuuid;
            *v383 = 138412546;
            *&v383[4] = v156;
            *&v383[12] = 2112;
            *&v383[14] = v157;
            _os_log_impl(&dword_1A7AD9000, v155, OS_LOG_TYPE_DEFAULT, "update ids-session-id:%@ for cbuuid:%@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = self->_idsSessionID;
              v311 = self->_cbuuid;
              _IDSLogTransport(@"GL", @"IDS", @"update ids-session-id:%@ for cbuuid:%@.");
              if (_IDSShouldLog())
              {
                p_isa = self->_idsSessionID;
                v311 = self->_cbuuid;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"update ids-session-id:%@ for cbuuid:%@.");
              }
            }
          }
        }

        v327 = [(IDSGlobalLink *)self _isAcceptedRelaySessionForAllocationRequestID:v336 acceptedRelaySessionID:key, p_isa, v311];
        if ((v371[0] - 3) > 1)
        {
          goto LABEL_316;
        }

        Value = 0;
        if (v12 && @"link-protocol")
        {
          Value = CFDictionaryGetValue(v12, @"link-protocol");
        }

        if (v325 == [Value intValue])
        {
          if (!v128)
          {
LABEL_264:
            v163 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v163, OS_LOG_TYPE_DEFAULT))
            {
              v164 = (&_IDSStunTransportStrings)[v325];
              v165 = bswap32(*&buf[2]) >> 16;
              if (self->_QUICForQREnabled)
              {
                v166 = @"YES";
              }

              else
              {
                v166 = @"NO";
              }

              *v383 = 67109634;
              *&v383[4] = v165;
              *&v383[8] = 2080;
              *&v383[10] = v164;
              *&v383[18] = 2112;
              *&v383[20] = v166;
              _os_log_impl(&dword_1A7AD9000, v163, OS_LOG_TYPE_DEFAULT, "use port %u for %s, _QUICForQREnabled: %@", v383, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v167 = bswap32(*&buf[2]) >> 16;
              v168 = self->_QUICForQREnabled ? @"YES" : @"NO";
              v313 = (&_IDSStunTransportStrings)[v325];
              v316 = v168;
              v302 = v167;
              _IDSLogTransport(@"GL", @"IDS", @"use port %u for %s, _QUICForQREnabled: %@");
              if (_IDSShouldLog())
              {
                v169 = bswap32(*&buf[2]) >> 16;
                if (self->_QUICForQREnabled)
                {
                  v170 = @"YES";
                }

                else
                {
                  v170 = @"NO";
                }

                v313 = (&_IDSStunTransportStrings)[v325];
                v316 = v170;
                v302 = v169;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"use port %u for %s, _QUICForQREnabled: %@");
              }
            }

            goto LABEL_279;
          }
        }

        else
        {
          if (v325 == 3)
          {
            v159 = 80;
          }

          else
          {
            v159 = 443;
          }

          v160 = __rev16(v159);
          *&buf[2] = v160;
          if (!v128)
          {
            goto LABEL_264;
          }

          WORD1(v388[0]) = v160;
        }

        v161 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v161, OS_LOG_TYPE_DEFAULT))
        {
          v162 = (&_IDSStunTransportStrings)[v325];
          *v383 = 67109378;
          *&v383[4] = bswap32(WORD1(v388[0])) >> 16;
          *&v383[8] = 2080;
          *&v383[10] = v162;
          _os_log_impl(&dword_1A7AD9000, v161, OS_LOG_TYPE_DEFAULT, "IPv6 only: use port %u for %s.", v383, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v302 = bswap32(WORD1(v388[0])) >> 16;
            v313 = (&_IDSStunTransportStrings)[v325];
            _IDSLogTransport(@"GL", @"IDS", @"IPv6 only: use port %u for %s.");
            if (_IDSShouldLog())
            {
              v302 = bswap32(WORD1(v388[0])) >> 16;
              v313 = (&_IDSStunTransportStrings)[v325];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"IPv6 only: use port %u for %s.");
            }
          }
        }

LABEL_279:
        if (self->_H2FallbackEnabled)
        {
          if (v325 == 3)
          {
            v320 = self->_tcpLink;
            v171 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v171, OS_LOG_TYPE_DEFAULT))
            {
              tcpLink = self->_tcpLink;
              *v383 = 138412290;
              *&v383[4] = tcpLink;
              _os_log_impl(&dword_1A7AD9000, v171, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: Use tcpLink since H2 is blocked: %@", v383, 0xCu);
            }

            v173 = [v342 address];
            v174 = -[IDSTCPLink connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:](v320, "connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:", v334, [v173 sa], LOWORD(self->_portRange), v323, self->_clientUUID, 0);

            if (!v174)
            {
              goto LABEL_315;
            }

            *&v175 = 0xAAAAAAAAAAAAAAAALL;
            *(&v175 + 1) = 0xAAAAAAAAAAAAAAAALL;
            v386 = v175;
            v387 = v175;
            *&v384[32] = v175;
            v385 = v175;
            *v384 = v175;
            *&v384[16] = v175;
            *v383 = v175;
            *&v383[16] = v175;
            v176 = [v342 address];
            SAToIPPortString(v383, 0x80uLL, [v176 sa]);

            v177 = [v342 address];
            memcpy([v177 sa], v174, v174->sa_len);

            *&v178 = 0xAAAAAAAAAAAAAAAALL;
            *(&v178 + 1) = 0xAAAAAAAAAAAAAAAALL;
            v381 = v178;
            v382 = v178;
            v379 = v178;
            v380 = v178;
            *&v378[32] = v178;
            *&v378[48] = v178;
            *v378 = v178;
            *&v378[16] = v178;
            v179 = [v342 address];
            SAToIPPortString(v378, 0x80uLL, [v179 sa]);

            v180 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v180, OS_LOG_TYPE_DEFAULT))
            {
              *v374 = 136315394;
              v375 = v383;
              v376 = 2080;
              v377 = v378;
              _os_log_impl(&dword_1A7AD9000, v180, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: TCP connection: change the local address from %s to: %s", v374, 0x16u);
            }

            goto LABEL_314;
          }

LABEL_316:
          *&v197 = 0xAAAAAAAAAAAAAAAALL;
          *(&v197 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v386 = v197;
          v387 = v197;
          *&v384[32] = v197;
          v385 = v197;
          *v384 = v197;
          *&v384[16] = v197;
          v198 = FirstPrefix == 0 || v128;
          *v383 = v197;
          *&v383[16] = v197;
          if (FirstPrefix == 0 || v128 || ![(IDSGlobalLink *)self _synthesizeNAT64ForAddress:v323 withPrefix:FirstPrefix toAddress:v383])
          {
            v199 = v323;
          }

          else
          {
            v199 = v383;
          }

          v200 = [v342 address];
          v335 = tokenForStunCandidatePair([v200 sa], v199, key);

          tokenToCandidatePairs = self->_tokenToCandidatePairs;
          if (tokenToCandidatePairs)
          {
            if (v335)
            {
              v202 = CFDictionaryGetValue(tokenToCandidatePairs, v335);
              if (v202)
              {
                v203 = v202;
                v204 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v204, OS_LOG_TYPE_DEFAULT))
                {
                  *v378 = 138412546;
                  *&v378[4] = v25;
                  *&v378[12] = 2112;
                  *&v378[14] = v12;
                  _os_log_impl(&dword_1A7AD9000, v204, OS_LOG_TYPE_DEFAULT, "setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@", v378, 0x16u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v304 = v25;
                    v313 = v12;
                    _IDSLogTransport(@"GL", @"IDS", @"setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@");
                    if (_IDSShouldLog())
                    {
                      v304 = v25;
                      v313 = v12;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@");
                    }
                  }
                }

                v205 = [v203 state];
                v206 = v205;
                if (v205 <= 4 && ((1 << v205) & 0x1A) != 0)
                {
                  v207 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v207, OS_LOG_TYPE_DEFAULT))
                  {
                    v208 = (&_IDSStunCandidatePairStateStrings)[v206];
                    *v378 = 138412546;
                    *&v378[4] = v335;
                    *&v378[12] = 2080;
                    *&v378[14] = v208;
                    _os_log_impl(&dword_1A7AD9000, v207, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, state [%s]", v378, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v305 = v335;
                      v313 = (&_IDSStunCandidatePairStateStrings)[v206];
                      _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, state [%s]");
                      if (_IDSShouldLog())
                      {
                        v305 = v335;
                        v313 = (&_IDSStunCandidatePairStateStrings)[v206];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, state [%s]");
                      }
                    }
                  }
                }

                else
                {
                  [v203 setPropertiesWithRelaySessionInfo:v25 sessionInfoDict:v12 enableSKE:self->_enableSKE];
                }

                if (v206 <= 4)
                {
                  v226 = v203;
                  if (((1 << v206) & 0x1A) != 0)
                  {
LABEL_516:

                    goto LABEL_517;
                  }

LABEL_365:
                  v227 = v226;
                  v228 = [v226 local];
                  v229 = [v228 isCellularStunCandidate];

                  if (v229)
                  {
                    v230 = [v227 local];
                    [v230 setCellularSlicingFlags:self->_cellularSlicingFlags];
                  }

                  v231 = [v342 clat46];
                  v232 = [v227 local];
                  [v232 setIsCLAT46:v231];

                  [v227 setIsConnectToQRIPv6Enabled:v330];
                  if (v340)
                  {
                    v233 = [v227 local];

                    if (v233)
                    {
                      v234 = [v227 local];
                      v235 = [v234 radioAccessTechnology];
                    }

                    else
                    {
                      v235 = 10;
                    }

                    if (v12)
                    {
                      v238 = @"allocate-time" == 0;
                    }

                    else
                    {
                      v238 = 1;
                    }

                    v239 = !v238;
                    if (!v238)
                    {
                      CFDictionaryGetValue(v12, @"allocate-time");
                    }

                    objc_opt_class();
                    v240 = 0.0;
                    if (objc_opt_isKindOfClass())
                    {
                      if (v239)
                      {
                        v241 = CFDictionaryGetValue(v12, @"allocate-time");
                      }

                      else
                      {
                        v241 = 0;
                      }

                      [v241 doubleValue];
                      v240 = v242;
                    }

                    v331 = [v12 objectForKeyedSubscript:@"qrbv"];
                    v243 = v371[0];
                    v244 = [(IDSQuickRelaySessionInfo *)v25 relayServerProviderType];
                    v245 = self->_idsSessionID;
                    v246 = [(IDSQuickRelaySessionInfo *)v25 reportingDataBlob];
                    LOBYTE(v306) = self->_isInitiator;
                    [(IDSGlobalLink *)self _addQRAAWDBlock:v336 allocateRequestTime:v235 inferredExternalRAT:v243 stunTransport:v244 relayProviderType:v245 idsSessionID:v246 reportingDataBlob:v240 isInitiator:v306 serverSoftwareVersion:v331];

                    if (self->_isInitiator)
                    {
                      if (self->_inviteSentTime == 0.0)
                      {
                        v247 = 0;
                        if (v12 && @"gl-option-invite-sent-time")
                        {
                          v247 = CFDictionaryGetValue(v12, @"gl-option-invite-sent-time");
                        }

                        [v247 doubleValue];
                        self->_inviteSentTime = v248;
                      }
                    }

                    else
                    {
                      if (self->_inviteRecvTime == 0.0)
                      {
                        v249 = 0;
                        if (v12 && @"gl-option-invite-recv-time")
                        {
                          v249 = CFDictionaryGetValue(v12, @"gl-option-invite-recv-time");
                        }

                        [v249 doubleValue];
                        self->_inviteRecvTime = v250;
                      }

                      v251 = 0;
                      if (v12 && @"gl-option-use-secure-control-message")
                      {
                        v251 = CFDictionaryGetValue(v12, @"gl-option-use-secure-control-message");
                      }

                      v252 = [v251 BOOLValue];
                      if (!self->_useSecureControlMessage && ((v252 ^ 1) & 1) == 0)
                      {
                        self->_useSecureControlMessage = v252;
                        v253 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v253, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v253, OS_LOG_TYPE_DEFAULT, "enable secure control message for Receiver.", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"enable secure control message for Receiver.");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"enable secure control message for Receiver.");
                            }
                          }
                        }
                      }
                    }

                    if (self->_allocbindStartTime == 0.0)
                    {
                      self->_allocbindStartTime = v59;
                      if (self->_isInitiator)
                      {
                        v254 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v254, OS_LOG_TYPE_DEFAULT))
                        {
                          inviteSentTime = self->_inviteSentTime;
                          allocbindStartTime = self->_allocbindStartTime;
                          *v378 = 134218240;
                          *&v378[4] = inviteSentTime;
                          *&v378[12] = 2048;
                          *&v378[14] = allocbindStartTime;
                          _os_log_impl(&dword_1A7AD9000, v254, OS_LOG_TYPE_DEFAULT, "invite sent: %.6f, allocbind start: %.6f.", v378, 0x16u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            v309 = self->_inviteSentTime;
                            v314 = self->_allocbindStartTime;
                            _IDSLogTransport(@"GL", @"IDS", @"invite sent: %.6f, allocbind start: %.6f.");
                            if (_IDSShouldLog())
                            {
                              v309 = self->_inviteSentTime;
                              v314 = self->_allocbindStartTime;
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"invite sent: %.6f, allocbind start: %.6f.");
                            }
                          }
                        }
                      }

                      else
                      {
                        if (self->_isUPlusOneSession)
                        {
                          self->_calleeAcceptTime = ids_monotonic_time();
                          v59 = self->_allocbindStartTime;
                        }

                        v257 = ntpTime32(v59);
                        self->_acceptDelayU32 = v257 - ntpTime32(self->_inviteRecvTime);
                        v258 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v258, OS_LOG_TYPE_DEFAULT))
                        {
                          inviteRecvTime = self->_inviteRecvTime;
                          v260 = self->_allocbindStartTime;
                          acceptDelayU32 = self->_acceptDelayU32;
                          *v378 = 134218752;
                          *&v378[4] = inviteRecvTime;
                          *&v378[12] = 2048;
                          *&v378[14] = v260;
                          *&v378[22] = 1024;
                          *&v378[24] = acceptDelayU32;
                          *&v378[28] = 2048;
                          *&v378[30] = v260 - inviteRecvTime;
                          _os_log_impl(&dword_1A7AD9000, v258, OS_LOG_TYPE_DEFAULT, "invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f", v378, 0x26u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            v318 = self->_allocbindStartTime - self->_inviteRecvTime;
                            v316 = self->_acceptDelayU32;
                            v309 = self->_inviteRecvTime;
                            v314 = self->_allocbindStartTime;
                            _IDSLogTransport(@"GL", @"IDS", @"invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
                            if (_IDSShouldLog())
                            {
                              v318 = self->_allocbindStartTime - self->_inviteRecvTime;
                              v316 = self->_acceptDelayU32;
                              v309 = self->_inviteRecvTime;
                              v314 = self->_allocbindStartTime;
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
                            }
                          }
                        }
                      }
                    }

                    v262 = self->_metricsCollector;
                    v263 = [v342 name];
                    [(IDSGFTMetricsCollector *)v262 willSendAllocbindRequestThroughInterface:v263];

                    v264 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v264, OS_LOG_TYPE_DEFAULT))
                    {
                      if (self->_isInitiator)
                      {
                        v265 = "Initiator";
                      }

                      else
                      {
                        v265 = "Receiver";
                      }

                      v266 = (&_IDSStunTransportStrings)[v325];
                      v267 = self->_idsSessionID;
                      v268 = [(IDSQuickRelaySessionInfo *)v25 relaySessionID];
                      v269 = v268;
                      *v378 = 136316162;
                      v270 = @"NO";
                      *&v378[4] = v265;
                      *&v378[12] = 2080;
                      if (v327)
                      {
                        v270 = @"YES";
                      }

                      *&v378[14] = v266;
                      *&v378[22] = 2112;
                      *&v378[24] = v267;
                      *&v378[32] = 2112;
                      *&v378[34] = v268;
                      *&v378[42] = 2112;
                      *&v378[44] = v270;
                      _os_log_impl(&dword_1A7AD9000, v264, OS_LOG_TYPE_DEFAULT, "*** Connect as %s, actualSelectedTransport: %s, IDSSessionID: %@, QRSessionID: %@, Accepted: %@.", v378, 0x34u);
                    }

                    self->_hasPendingAllocation = 0;
                    if (self->_state <= 1)
                    {
                      v271 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v271, OS_LOG_TYPE_DEFAULT))
                      {
                        v272 = _IDSLinkStateStrings[self->_state];
                        *v378 = 138412802;
                        *&v378[4] = self;
                        *&v378[12] = 2080;
                        *&v378[14] = v272;
                        *&v378[22] = 2080;
                        *&v378[24] = off_1EB2B3E60[0];
                        _os_log_impl(&dword_1A7AD9000, v271, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", v378, 0x20u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          v315 = _IDSLinkStateStrings[self->_state];
                          v317 = off_1EB2B3E60[0];
                          v310 = self;
                          _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
                          if (_IDSShouldLog())
                          {
                            v315 = _IDSLinkStateStrings[self->_state];
                            v317 = off_1EB2B3E60[0];
                            v310 = self;
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
                          }
                        }
                      }

                      self->_state = 2;
                    }

                    v273 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v273, OS_LOG_TYPE_DEFAULT))
                    {
                      v274 = [v329 length];
                      v275 = [v328 length];
                      *v378 = 138413058;
                      *&v378[4] = v335;
                      *&v378[12] = 2048;
                      *&v378[14] = v274;
                      *&v378[22] = 2048;
                      *&v378[24] = v275;
                      *&v378[32] = 2048;
                      *&v378[34] = v321;
                      _os_log_impl(&dword_1A7AD9000, v273, OS_LOG_TYPE_DEFAULT, "start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu", v378, 0x2Au);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v276 = [v329 length];
                        v317 = [v328 length];
                        v319 = v321;
                        v310 = v335;
                        v315 = v276;
                        _IDSLogTransport(@"GL", @"IDS", @"start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu");
                        if (_IDSShouldLog())
                        {
                          v277 = [v329 length];
                          v317 = [v328 length];
                          v319 = v321;
                          v310 = v335;
                          v315 = v277;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu");
                        }
                      }
                    }

                    if (aBlock)
                    {
                      v278 = _Block_copy(aBlock);
                      v279 = self->_connectReadyHandler;
                      self->_connectReadyHandler = v278;
                    }

                    if (self->_QUICForQREnabled)
                    {
                      if (v325 == 2)
                      {
                        v280 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v280, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v280, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using QUIC", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using QUIC");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using QUIC");
                            }
                          }
                        }

                        v281 = [v227 candidatePairToken];
                        -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", v281, 0, 0, 1, [v227 pendingNoSessionStateAllocbind]);

                        goto LABEL_473;
                      }

                      if (self->_H2FallbackEnabled && v325 == 4)
                      {
                        v284 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v284, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v284, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using H2", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using H2");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using H2");
                            }
                          }
                        }

                        v352[0] = MEMORY[0x1E69E9820];
                        v352[1] = 3221225472;
                        v352[2] = sub_1A7B7CCCC;
                        v352[3] = &unk_1E77E0C88;
                        v352[4] = self;
                        v353 = v227;
                        [(IDSGlobalLink *)self _connectNWTCPLink:v353 disconnectAfterUse:0 connectedHandler:v352];

LABEL_473:
                        [(IDSGlobalLink *)self _reportAWDAllocateTime];
                        if (v337 == 3)
                        {
                          [v227 updateURIToParticipantIDMapping:v12];
                        }

                        *v374 = -1431655766;
                        if (self->_shouldFallbackToTCPFirst)
                        {
                          if (v371[0] != 3)
                          {
                            if (v371[0] == 2)
                            {
                              goto LABEL_496;
                            }

                            goto LABEL_481;
                          }
                        }

                        else
                        {
                          if (v371[0] == 4)
                          {
LABEL_496:
                            v289 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
                            GLUtilGetLinkInformation(key, 3, v374, 0, v289);

                            v286 = v371[0];
                            v287 = *v374 == 0;
                            v288 = 3;
LABEL_497:
                            if (v287)
                            {
                              v283 = v288;
                            }

                            else
                            {
                              v283 = v286;
                            }

                            goto LABEL_500;
                          }

                          if (v371[0] != 2)
                          {
LABEL_481:
                            v283 = 0;
LABEL_500:
                            if (!v322 && GLUtilHasVPNInterfaceForSelectedAddress(v342, self->_interfaceAddressArray))
                            {
                              v87 = 1.0;
                            }

                            if (v337 == 3 || v283 && v283 != v371[0])
                            {
                              v290 = +[IDSServerBag sharedInstance];
                              v291 = [v290 objectForKey:@"ids-tcp-fallback-disabled-for-two-way"];

                              if (v337 == 1 && [v291 BOOLValue])
                              {
                                v292 = +[IDSFoundationLog GlobalLink];
                                if (os_log_type_enabled(v292, OS_LOG_TYPE_DEFAULT))
                                {
                                  v293 = (&_IDSStunTransportStrings)[v283];
                                  *v378 = 136315138;
                                  *&v378[4] = v293;
                                  _os_log_impl(&dword_1A7AD9000, v292, OS_LOG_TYPE_DEFAULT, "Two way allocation: don't fallback to %s due to server bag configurations", v378, 0xCu);
                                }
                              }

                              else
                              {
                                v294 = +[IDSFoundationLog GlobalLink];
                                if (os_log_type_enabled(v294, OS_LOG_TYPE_DEFAULT))
                                {
                                  v295 = (&_IDSStunTransportStrings)[v283];
                                  *v378 = 136315650;
                                  *&v378[4] = v295;
                                  *&v378[12] = 2112;
                                  *&v378[14] = key;
                                  *&v378[22] = 2048;
                                  *&v378[24] = v87;
                                  _os_log_impl(&dword_1A7AD9000, v294, OS_LOG_TYPE_DEFAULT, "scheduled [%s] for session %@ after %.2f second(s).", v378, 0x20u);
                                }

                                v343[0] = MEMORY[0x1E69E9820];
                                v343[1] = 3221225472;
                                v343[2] = sub_1A7B7CD3C;
                                v343[3] = &unk_1E77E0D00;
                                v344 = v227;
                                v345 = key;
                                v346 = self;
                                v349 = v283;
                                v347 = v12;
                                v351 = v340;
                                v348 = aBlock;
                                v350 = a8;
                                IDSTransportThreadAddBlockAfter(v343, v87);

                                v292 = v344;
                              }
                            }

                            goto LABEL_515;
                          }
                        }

                        v285 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
                        GLUtilGetLinkInformation(key, 4, v374, 0, v285);

                        v286 = v371[0];
                        v287 = *v374 == 0;
                        v288 = 4;
                        goto LABEL_497;
                      }

                      v296 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v296, OS_LOG_TYPE_DEFAULT))
                      {
                        v297 = @"NO";
                        v298 = (&_IDSStunTransportStrings)[v325];
                        if (self->_H2FallbackEnabled)
                        {
                          v297 = @"YES";
                        }

                        *v378 = 138412546;
                        *&v378[4] = v297;
                        *&v378[12] = 2080;
                        *&v378[14] = v298;
                        _os_log_impl(&dword_1A7AD9000, v296, OS_LOG_TYPE_DEFAULT, "_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN", v378, 0x16u);
                      }

                      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                      {
                        v299 = self->_H2FallbackEnabled ? @"YES" : @"NO";
                        v310 = v299;
                        v315 = (&_IDSStunTransportStrings)[v325];
                        _IDSLogTransport(@"GL", @"IDS", @"_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN");
                        if (_IDSShouldLog())
                        {
                          if (self->_H2FallbackEnabled)
                          {
                            v300 = @"YES";
                          }

                          else
                          {
                            v300 = @"NO";
                          }

                          v310 = v300;
                          v315 = (&_IDSStunTransportStrings)[v325];
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN");
                        }
                      }
                    }

                    else
                    {
                      v282 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v282, OS_LOG_TYPE_DEFAULT))
                      {
                        *v378 = 0;
                        _os_log_impl(&dword_1A7AD9000, v282, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using STUN", v378, 2u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using STUN");
                          if (_IDSShouldLog())
                          {
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using STUN");
                          }
                        }
                      }
                    }

                    [v227 setIsQUIC:{0, v310, v315, v317, v319}];
                    [(IDSGlobalLink *)self _sendAllocbindRequest:v335 stunMessage:0 isRealloc:0 inResponseToNoSessionState:0];
                    goto LABEL_473;
                  }

                  v236 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v236, OS_LOG_TYPE_DEFAULT))
                  {
                    v237 = [(IDSQuickRelaySessionInfo *)v25 groupID];
                    *v378 = 138412546;
                    *&v378[4] = v237;
                    *&v378[12] = 2112;
                    *&v378[14] = key;
                    _os_log_impl(&dword_1A7AD9000, v236, OS_LOG_TYPE_DEFAULT, "send info request for active participants for group %@, session %@.", v378, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v307 = [(IDSQuickRelaySessionInfo *)v25 groupID];
                      _IDSLogTransport(@"GL", @"IDS", @"send info request for active participants for group %@, session %@.");

                      if (_IDSShouldLog())
                      {
                        v308 = [(IDSQuickRelaySessionInfo *)v25 groupID:v307];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"send info request for active participants for group %@, session %@.");
                      }
                    }
                  }

                  if (self->_QUICForQREnabled)
                  {
                    if (v371[0] == 2)
                    {
                      v359 = MEMORY[0x1E69E9820];
                      v360 = 3221225472;
                      v361 = sub_1A7B7CCBC;
                      v362 = &unk_1E77E0818;
                      v363 = v227;
                      v227 = v363;
                      [IDSGlobalLink _connectNWLink:"_connectNWLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];

LABEL_515:
                      v226 = v227;
                      goto LABEL_516;
                    }

                    if (self->_H2FallbackEnabled)
                    {
                      v354 = MEMORY[0x1E69E9820];
                      v355 = 3221225472;
                      v356 = sub_1A7B7CCC4;
                      v357 = &unk_1E77E0818;
                      v358 = v227;
                      v227 = v358;
                      [IDSGlobalLink _connectNWTCPLink:"_connectNWTCPLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];

                      goto LABEL_515;
                    }
                  }

                  [v227 setIsQUIC:0];
                  [v227 sendInfoRequest:0];
                  goto LABEL_515;
                }

LABEL_364:
                v226 = v203;
                goto LABEL_365;
              }
            }
          }

          if (self->_isSessionAcceptedWithNoCandidatePair)
          {
            v209 = self->_isInitiator;
            v210 = v342;
            if (self->_acceptedRelaySessionID && self->_isInitiator)
            {
              self->_isSessionAcceptedWithNoCandidatePair = 0;
              v327 = 1;
              GLUtilCreateRelayCandidatePair(v25, v12, v342, v323, 1u, 1, self->_enableSKE, v371[0], self);
              v211 = LABEL_343:;
              v212 = v211;
              if (!v198)
              {
                v213 = [v211 local];
                [v213 setPrefix:FirstPrefix];

                [v212 synthesizeNat64WithPrefix];
                [v212 setIsNAT64:1];
                v214 = [v212 candidatePairToken];

                v335 = v214;
              }

              v215 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v215, OS_LOG_TYPE_DEFAULT))
              {
                v216 = [v212 candidatePairToken];
                v217 = v216;
                v218 = @"NO";
                if (v327)
                {
                  v218 = @"YES";
                }

                *v378 = 138412546;
                *&v378[4] = v216;
                *&v378[12] = 2112;
                *&v378[14] = v218;
                _os_log_impl(&dword_1A7AD9000, v215, OS_LOG_TYPE_DEFAULT, "create relay candidate pair, token: %@, isAcceptedRelaySession = %@", v378, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
              {
                v219 = [v212 candidatePairToken];
                v220 = v327 ? @"YES" : @"NO";
                v305 = v219;
                v313 = v220;
                _IDSLogTransport(@"GL", @"IDS", @"create relay candidate pair, token: %@, isAcceptedRelaySession = %@");

                if (_IDSShouldLog())
                {
                  v305 = [v212 candidatePairToken];
                  v313 = v220;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"create relay candidate pair, token: %@, isAcceptedRelaySession = %@");
                }
              }

              if (!self->_tokenToCandidatePairs)
              {
                v221 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                v222 = self->_tokenToCandidatePairs;
                self->_tokenToCandidatePairs = v221;
              }

              v223 = v212;
              if (v223)
              {
                v203 = v223;
                CFDictionarySetValue(self->_tokenToCandidatePairs, v335, v223);
              }

              else
              {
                v203 = 0;
                v224 = MEMORY[0x1E69E9C10];
                v225 = MEMORY[0x1E69E9C10];
                if (os_log_type_enabled(v224, OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E1498C();
                }
              }

              goto LABEL_364;
            }
          }

          else
          {
            v209 = self->_isInitiator;
            v210 = v342;
          }

          GLUtilCreateRelayCandidatePair(v25, v12, v210, v323, v327, v209, self->_enableSKE, v371[0], self);
          goto LABEL_343;
        }

        if (v325 == 4)
        {
          v320 = self->_tcpSSLLink;
          v181 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v181, OS_LOG_TYPE_DEFAULT))
          {
            tcpSSLLink = self->_tcpSSLLink;
            *v383 = 138412290;
            *&v383[4] = tcpSSLLink;
            v183 = "_connectWithSessionInfo: Use tcpSSLLink: %@";
            goto LABEL_308;
          }
        }

        else
        {
          if (v325 != 3)
          {
            v320 = 0;
            goto LABEL_311;
          }

          v320 = self->_tcpLink;
          v181 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v181, OS_LOG_TYPE_DEFAULT))
          {
            v182 = self->_tcpLink;
            *v383 = 138412290;
            *&v383[4] = v182;
            v183 = "_connectWithSessionInfo: Use tcpLink: %@";
LABEL_308:
            _os_log_impl(&dword_1A7AD9000, v181, OS_LOG_TYPE_DEFAULT, v183, v383, 0xCu);
          }
        }

LABEL_311:
        v190 = [v342 address];
        v191 = -[IDSTCPLink connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:](v320, "connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:", v334, [v190 sa], LOWORD(self->_portRange), v323, self->_clientUUID, 0);

        if (!v191)
        {
LABEL_315:

          goto LABEL_316;
        }

        *&v192 = 0xAAAAAAAAAAAAAAAALL;
        *(&v192 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v386 = v192;
        v387 = v192;
        *&v384[32] = v192;
        v385 = v192;
        *v384 = v192;
        *&v384[16] = v192;
        *v383 = v192;
        *&v383[16] = v192;
        v193 = [v342 address];
        SAToIPPortString(v383, 0x80uLL, [v193 sa]);

        v194 = [v342 address];
        memcpy([v194 sa], v191, v191->sa_len);

        *&v195 = 0xAAAAAAAAAAAAAAAALL;
        *(&v195 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v381 = v195;
        v382 = v195;
        v379 = v195;
        v380 = v195;
        *&v378[32] = v195;
        *&v378[48] = v195;
        *v378 = v195;
        *&v378[16] = v195;
        v196 = [v342 address];
        SAToIPPortString(v378, 0x80uLL, [v196 sa]);

        v180 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v180, OS_LOG_TYPE_DEFAULT))
        {
          *v374 = 136315394;
          v375 = v383;
          v376 = 2080;
          v377 = v378;
          _os_log_impl(&dword_1A7AD9000, v180, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: TCP connection: change the local address from %s to: %s", v374, 0x16u);
        }

LABEL_314:

        goto LABEL_315;
      }

      if (self->_isInitiator)
      {
        v118 = 0;
      }

      else
      {
        v119 = [v12 objectForKey:@"qia"];
        v118 = [v119 intValue];

        v115 = v371[0];
      }

      preferCellularForCallSetup = self->_preferCellularForCallSetup;
      v121 = self->_interfaceAddressArray;
      v122 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      if (v337 == 3)
      {
        v123 = key;
      }

      else
      {
        v123 = 0;
      }

      v124 = GLUtilSelectInterface(v115, preferCellularForCallSetup, v121, v122, v123, v118, v330, a8);

      v117 = v124;
    }

    if (!v117)
    {
      if (self->_networkAddressChangeTimer)
      {
        v131 = 1;
      }

      else
      {
        v131 = v340;
      }

      v132 = +[IDSFoundationLog GlobalLink];
      v133 = os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT);
      if (v131)
      {
        if (v133)
        {
          v134 = @"NO";
          v135 = self->_networkAddressChangeTimer;
          if (v340)
          {
            v134 = @"YES";
          }

          *v383 = 134218242;
          *&v383[4] = v135;
          *&v383[12] = 2112;
          *&v383[14] = v134;
          _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "No local interface available; _networkAddressChangeTimer = %p, joinSession = %@", v383, 0x16u);
        }
      }

      else
      {
        if (v133)
        {
          *v383 = 0;
          _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "Found no local interface available for QR.", v383, 2u);
        }

        if (!v333)
        {
          sub_1A7B7CB88(aBlock, 6, @"No local interface available");
          if (self->_clientType == 6)
          {
            v188 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v188, OS_LOG_TYPE_DEFAULT))
            {
              *v383 = 0;
              _os_log_impl(&dword_1A7AD9000, v188, OS_LOG_TYPE_DEFAULT, "Found no local interface available for QR. - gathering ABC with packet capture", v383, 2u);
            }

            [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"NoLocalNetwork" duration:15];
          }
        }
      }

      v342 = 0;
      goto LABEL_517;
    }

    goto LABEL_195;
  }

  v22 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    *&buf[4] = self;
    *&buf[12] = 2112;
    *&buf[14] = v19;
    *&buf[22] = 2080;
    *&buf[24] = v23;
    _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "%@%@ is in [%s] state, skip connecting to QR.", buf, 0x20u);
  }

LABEL_13:

LABEL_521:
}

- (void)_selectStunTransport:(int64_t *)a3 andInterfaceAddress:(id *)a4 forRelaySessionID:(id)a5 preferIPv4:(BOOL)a6 wantOnlyCell:(BOOL)a7 wantOnlyNonCell:(BOOL)a8 isValidSA:(BOOL)a9
{
  v9 = a8;
  v123 = a7;
  v10 = a6;
  v197 = *MEMORY[0x1E69E9840];
  v12 = a5;
  allocationsToTransportScoreCards = self->_allocationsToTransportScoreCards;
  if (!allocationsToTransportScoreCards)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v15 = self->_allocationsToTransportScoreCards;
    self->_allocationsToTransportScoreCards = Mutable;

    allocationsToTransportScoreCards = self->_allocationsToTransportScoreCards;
  }

  v16 = [(NSDictionary *)allocationsToTransportScoreCards objectForKeyedSubscript:v12];
  if (!v16)
  {
    v16 = [objc_alloc(MEMORY[0x1E695DF70]) initWithArray:self->_transportScoreCards copyItems:1];
    if (v16)
    {
      CFDictionarySetValue(self->_allocationsToTransportScoreCards, v12, v16);
    }

    else
    {
      v17 = MEMORY[0x1E69E9C10];
      v18 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14A08();
      }
    }
  }

  v125 = v9;
  v129 = v10;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v172 = 0u;
  v173 = 0u;
  v174 = 0u;
  obj = v175 = 0u;
  v19 = [obj countByEnumeratingWithState:&v172 objects:v196 count:16];
  if (v19)
  {
    v20 = v19;
    v21 = *v173;
    do
    {
      v22 = 0;
      do
      {
        if (*v173 != v21)
        {
          objc_enumerationMutation(obj);
        }

        v23 = *(*(&v172 + 1) + 8 * v22);
        if ([v23 isRelayStunCandidatePair])
        {
          v24 = [v23 sessionID];
          if ([v24 isEqualToString:v12])
          {
            v25 = [v23 isSelfQRSession];

            if ((v25 & 1) == 0)
            {
              v26 = [v23 state];
              if (v26 > 4 || (v29 = v26, v30 = [v23 isDisconnecting], !v29) || v30)
              {
                if ([v16 count])
                {
                  v27 = 0;
                  do
                  {
                    v28 = [v16 objectAtIndexedSubscript:v27];
                    if ([(IDSGlobalLink *)self _isUsingSameRATCandidatePair:v23 transportScoreCard:v28])
                    {
                      v28[36] = 0;
                    }

                    ++v27;
                  }

                  while ([v16 count] > v27);
                }
              }
            }
          }

          else
          {
          }
        }

        ++v22;
      }

      while (v22 != v20);
      v31 = [obj countByEnumeratingWithState:&v172 objects:v196 count:16];
      v20 = v31;
    }

    while (v31);
  }

  v136 = v12;

  if (!a9)
  {
    v170 = 0u;
    v171 = 0u;
    v168 = 0u;
    v169 = 0u;
    v126 = v16;
    v133 = [v126 countByEnumeratingWithState:&v168 objects:v195 count:16];
    if (v133)
    {
      v130 = *v169;
      do
      {
        for (i = 0; i != v133; i = i + 1)
        {
          if (*v169 != v130)
          {
            objc_enumerationMutation(v126);
          }

          v33 = *(*(&v168 + 1) + 8 * i);
          v164 = 0u;
          v165 = 0u;
          v166 = 0u;
          v167 = 0u;
          v34 = self->_interfaceAddressArray;
          v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v164 objects:v194 count:16];
          if (v35)
          {
            v36 = v35;
            v37 = *v165;
            do
            {
              for (j = 0; j != v36; ++j)
              {
                if (*v165 != v37)
                {
                  objc_enumerationMutation(v34);
                }

                v39 = *(*(&v164 + 1) + 8 * j);
                if ([v39 index] == *(v33 + 32))
                {
                  v40 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v39 index]);
                  v41 = [v39 IPVersion];
                  if (*(v33 + 37) == 1 && v41 == 1 && v40 != *(v33 + 24) < 4)
                  {
                    *(v33 + 36) = (GLUGetExtendedFlagsForInterface(v39) & 0x1000) == 0;
                  }
                }
              }

              v36 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v164 objects:v194 count:16];
            }

            while (v36);
          }
        }

        v133 = [v126 countByEnumeratingWithState:&v168 objects:v195 count:16];
      }

      while (v133);
    }
  }

  v162 = 0u;
  v163 = 0u;
  v160 = 0u;
  v161 = 0u;
  v134 = obj;
  v42 = [v134 countByEnumeratingWithState:&v160 objects:v193 count:16];
  if (v42)
  {
    v43 = v42;
    obja = *v161;
    do
    {
      for (k = 0; k != v43; ++k)
      {
        if (*v161 != obja)
        {
          objc_enumerationMutation(v134);
        }

        v45 = *(*(&v160 + 1) + 8 * k);
        if ([v45 isRelayStunCandidatePair])
        {
          v46 = [v45 sessionID];
          if ([v46 isEqualToString:v136])
          {
            v47 = [v45 isSelfQRSession];

            if ((v47 & 1) == 0 && ([v45 state] - 1) <= 1)
            {
              v48 = [v45 local];
              v49 = [v48 index];

              v127 = [(IDSGlobalLink *)self _isInterfaceDelegatedWithInterfaceIndex:v49];
              v50 = [v45 local];
              v51 = *([v50 address] + 1);

              if ([v16 count])
              {
                v52 = 0;
                v131 = v51 == 30;
                do
                {
                  v53 = [v16 objectAtIndexedSubscript:v52];
                  v54 = v53;
                  if (*(v53 + 32) == v49)
                  {
                    v55 = *(v53 + 16);
                    v56 = [v45 local];
                    if (v55 == [v56 transport] && *(v54 + 37) == v131)
                    {
                      v57 = *(v54 + 24) < 4;

                      if (v127 != v57)
                      {
                        *(v54 + 36) = 1;
                      }
                    }

                    else
                    {
                    }
                  }

                  ++v52;
                }

                while ([v16 count] > v52);
              }
            }
          }

          else
          {
          }
        }
      }

      v43 = [v134 countByEnumeratingWithState:&v160 objects:v193 count:16];
    }

    while (v43);
  }

  v158 = 0u;
  v159 = 0u;
  v156 = 0u;
  v157 = 0u;
  v135 = v134;
  v58 = [v135 countByEnumeratingWithState:&v156 objects:v192 count:16];
  v59 = v129;
  if (v58)
  {
    v60 = v58;
    v61 = *v157;
    do
    {
      for (m = 0; m != v60; ++m)
      {
        if (*v157 != v61)
        {
          objc_enumerationMutation(v135);
        }

        v63 = *(*(&v156 + 1) + 8 * m);
        if ([v63 isRelayStunCandidatePair] && (objc_msgSend(v63, "isDisconnecting") & 1) == 0)
        {
          v64 = [v63 sessionID];
          if ([v64 isEqualToString:v136])
          {
            v65 = [v63 isSelfQRSession];

            if ((v65 & 1) == 0 && ([v63 state] - 3) <= 1 && objc_msgSend(v16, "count"))
            {
              v66 = 0;
              do
              {
                v67 = [v16 objectAtIndexedSubscript:v66];
                if ([(IDSGlobalLink *)self _isUsingSameRATCandidatePair:v63 transportScoreCard:v67])
                {
                  v67[36] = 1;
                }

                ++v66;
              }

              while ([v16 count] > v66);
            }
          }

          else
          {
          }
        }
      }

      v60 = [v135 countByEnumeratingWithState:&v156 objects:v192 count:16];
    }

    while (v60);
  }

  v68 = v125;
  v69 = v123;
  if (self->_cellInterfaceName)
  {
    v154 = 0u;
    v155 = 0u;
    v152 = 0u;
    v153 = 0u;
    v70 = v135;
    v71 = [v70 countByEnumeratingWithState:&v152 objects:v191 count:16];
    if (v71)
    {
      v72 = v71;
      v73 = *v153;
      do
      {
        for (n = 0; n != v72; ++n)
        {
          if (*v153 != v73)
          {
            objc_enumerationMutation(v70);
          }

          v75 = *(*(&v152 + 1) + 8 * n);
          if ([v75 isRelayStunCandidatePair])
          {
            v76 = [v75 sessionID];
            if ([v76 isEqualToString:v136])
            {
              v77 = [v75 isSelfQRSession];

              if (v77)
              {
                continue;
              }

              v78 = [v75 local];
              v76 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [v78 index]);

              v79 = [v75 local];
              if ([v79 isCellularStunCandidate])
              {
                v80 = [v76 isEqualToIgnoringCase:self->_cellInterfaceName];

                if (v80)
                {

                  v59 = v129;
                  v68 = v125;
                  v69 = v123;
                  goto LABEL_119;
                }
              }

              else
              {
              }
            }
          }
        }

        v72 = [v70 countByEnumeratingWithState:&v152 objects:v191 count:16];
      }

      while (v72);
    }

    v59 = v129;
    v68 = v125;
    v69 = v123;
    if ([v16 count])
    {
      v81 = 0;
      do
      {
        v82 = [v16 objectAtIndexedSubscript:v81];
        v83 = *(v82 + 24);
        if (v83 == 6 || v83 == 3)
        {
          *(v82 + 36) = 0;
        }

        ++v81;
      }

      while ([v16 count] > v81);
    }
  }

LABEL_119:
  v150 = 0u;
  v151 = 0u;
  v148 = 0u;
  v149 = 0u;
  v85 = v16;
  v86 = [v85 countByEnumeratingWithState:&v148 objects:v190 count:16];
  if (v86)
  {
    v87 = v86;
    v124 = 0;
    v88 = 0;
    v89 = *v149;
    do
    {
      for (ii = 0; ii != v87; ++ii)
      {
        if (*v149 != v89)
        {
          objc_enumerationMutation(v85);
        }

        v91 = *(*(&v148 + 1) + 8 * ii);
        if (v69)
        {
          v92 = *(v91 + 24);
          if (v92 != 6 && v92 != 3)
          {
            continue;
          }
        }

        if (v68)
        {
          v94 = *(v91 + 24);
          if (v94 == 3 || v94 == 6)
          {
            continue;
          }
        }

        if ((*(v91 + 36) & 1) == 0)
        {
          v96 = *(v91 + 8);
          if (v59)
          {
            if (*(v91 + 37) == 1)
            {
              v96 >>= 2;
            }

            else
            {
              v96 *= 4;
            }
          }

          if (v96 > v88)
          {
            v97 = v91;

            v124 = v97;
            v88 = v96;
          }
        }
      }

      v87 = [v85 countByEnumeratingWithState:&v148 objects:v190 count:16];
    }

    while (v87);
  }

  else
  {
    v124 = 0;
  }

  v98 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v98, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v98, OS_LOG_TYPE_DEFAULT, "\t========== TransportScoreCards ==========", buf, 2u);
  }

  v146 = 0u;
  v147 = 0u;
  v144 = 0u;
  v145 = 0u;
  v132 = v85;
  v99 = [v132 countByEnumeratingWithState:&v144 objects:v189 count:16];
  if (v99)
  {
    v100 = v99;
    v101 = *v145;
    v128 = *v145;
    do
    {
      for (jj = 0; jj != v100; ++jj)
      {
        if (*v145 != v101)
        {
          objc_enumerationMutation(v132);
        }

        v103 = *(*(&v144 + 1) + 8 * jj);
        v104 = *(v103 + 8);
        if (v59)
        {
          if (*(v103 + 37) == 1)
          {
            v104 >>= 2;
          }

          else
          {
            v104 *= 4;
          }
        }

        v105 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
        {
          v106 = v100;
          if (*(v103 + 37))
          {
            v107 = @"YES";
          }

          else
          {
            v107 = @"NO";
          }

          objb = *(v103 + 32);
          v108 = (&_IDSStunTransportStrings)[*(v103 + 16)];
          v109 = [(IDSGlobalLink *)self _transportInterfaceToString:*(v103 + 24)];
          v110 = v109;
          v111 = @"NO";
          if (*(v103 + 36))
          {
            v111 = @"YES";
          }

          *buf = 138413570;
          v178 = v107;
          v100 = v106;
          v179 = 1024;
          v180 = objb;
          v59 = v129;
          v181 = 2080;
          v182 = v108;
          v183 = 2112;
          v184 = v109;
          v185 = 2112;
          v186 = v111;
          v187 = 2048;
          v188 = v104;
          _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "IPV6 = %@, interfaceIndex = %u, stunTransport = %s, transportInterface = %@, alreadySelected = %@, score = %llu", buf, 0x3Au);

          v101 = v128;
        }
      }

      v100 = [v132 countByEnumeratingWithState:&v144 objects:v189 count:16];
    }

    while (v100);
  }

  v112 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v112, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v112, OS_LOG_TYPE_DEFAULT, "\t==========================================", buf, 2u);
  }

  if (v124)
  {
    *a3 = v124[2];
    v140 = 0u;
    v141 = 0u;
    v142 = 0u;
    v143 = 0u;
    v113 = self->_interfaceAddressArray;
    v114 = [(NSMutableArray *)v113 countByEnumeratingWithState:&v140 objects:v176 count:16];
    if (v114)
    {
      v115 = v114;
      v116 = *v141;
      while (2)
      {
        for (kk = 0; kk != v115; ++kk)
        {
          if (*v141 != v116)
          {
            objc_enumerationMutation(v113);
          }

          v118 = *(*(&v140 + 1) + 8 * kk);
          if ([v118 index] == *(v124 + 8))
          {
            v119 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v118 index]);
            if (*(v124 + 37) == ([v118 IPVersion] == 1) && v119 != v124[3] < 4)
            {
              v120 = v118;
              *a4 = v118;
              goto LABEL_181;
            }
          }
        }

        v115 = [(NSMutableArray *)v113 countByEnumeratingWithState:&v140 objects:v176 count:16];
        if (v115)
        {
          continue;
        }

        break;
      }
    }

LABEL_181:
  }
}

- (void)disconnectWithCompletionHandler:(id)a3 isReinitiating:(BOOL)a4
{
  v4 = a4;
  v76 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    idsSessionID = self->_idsSessionID;
    *buf = 138412546;
    v68 = self;
    v69 = 2112;
    v70 = idsSessionID;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "Disconnecting IDSGlobalLink %@ with IDSSessionID: %@", buf, 0x16u);
  }

  if (self->_useLinkEngine)
  {
    remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
    self->_remoteAcceptedDevicePushTokens = 0;

    v65 = 0u;
    v66 = 0u;
    v63 = 0u;
    v64 = 0u;
    v10 = self->_sessionsByID;
    v11 = [(NSMutableDictionary *)v10 countByEnumeratingWithState:&v63 objects:v75 count:16];
    if (v11)
    {
      v12 = *v64;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v64 != v12)
          {
            objc_enumerationMutation(v10);
          }

          v14 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v63 + 1) + 8 * i)];
          [v14 reset];
        }

        v11 = [(NSMutableDictionary *)v10 countByEnumeratingWithState:&v63 objects:v75 count:16];
      }

      while (v11);
    }

    v15 = [(IDSGlobalLink *)self allLinkEngines];
    v61 = 0u;
    v62 = 0u;
    v59 = 0u;
    v60 = 0u;
    v16 = [v15 countByEnumeratingWithState:&v59 objects:v74 count:16];
    if (v16)
    {
      v17 = *v60;
      do
      {
        for (j = 0; j != v16; ++j)
        {
          if (*v60 != v17)
          {
            objc_enumerationMutation(v15);
          }

          [*(*(&v59 + 1) + 8 * j) setAllowOngoingTasks:0];
        }

        v16 = [v15 countByEnumeratingWithState:&v59 objects:v74 count:16];
      }

      while (v16);
    }

    [(IDSGlobalLink *)self _updateAllLinks];
  }

  state = self->_state;
  if (state > 3)
  {
    if (state == 4)
    {
      v28 = _Block_copy(v6);
      disconnectCompletionHandler = self->_disconnectCompletionHandler;
      self->_disconnectCompletionHandler = v28;

      [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
      if (self->_state != 5)
      {
        v30 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
        {
          v31 = _IDSLinkStateStrings[self->_state];
          *buf = 138412802;
          v68 = self;
          v69 = 2080;
          v70 = v31;
          v71 = 2080;
          v72 = off_1EB2B3E78[0];
          _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v49 = _IDSLinkStateStrings[self->_state];
            v50 = off_1EB2B3E78[0];
            v48 = self;
            _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
            if (_IDSShouldLog())
            {
              v49 = _IDSLinkStateStrings[self->_state];
              v50 = off_1EB2B3E78[0];
              v48 = self;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
            }
          }
        }

        self->_state = 5;
      }

      [(IDSGlobalLink *)self _removePacketNotificationFilter:v48];
    }

    else
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        v33 = _IDSLinkStateStrings[self->_state];
        *buf = 136315138;
        v68 = v33;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "session is already disconnecting, state[%s].", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"session is already disconnecting, state[%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"session is already disconnecting, state[%s].");
          }
        }
      }

      if (v6)
      {
        v34 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B7E5A4;
        block[3] = &unk_1E77E0B48;
        v52 = v6;
        v35 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
        dispatch_async(v34, v35);
      }
    }
  }

  else
  {
    v20 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v21 = self->_idsSessionID;
      v22 = _IDSLinkStateStrings[self->_state];
      *buf = 138412546;
      v68 = v21;
      v69 = 2080;
      v70 = v22;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Session with IDSSessionID: %@ is not connected, state [%s].", buf, 0x16u);
    }

    self->_state = 6;
    if (self->_allocbindEndTime > 0.0)
    {
      v57 = 0u;
      v58 = 0u;
      v55 = 0u;
      v56 = 0u;
      v23 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v24 = [v23 countByEnumeratingWithState:&v55 objects:v73 count:16];
      if (v24)
      {
        v25 = *v56;
        while (2)
        {
          for (k = 0; k != v24; ++k)
          {
            if (*v56 != v25)
            {
              objc_enumerationMutation(v23);
            }

            v27 = *(*(&v55 + 1) + 8 * k);
            if ([v27 state] == 3)
            {
              v36 = [v27 local];
              v37 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
              {
                v38 = (&_IDSStunTransportStrings)[[v36 transport]];
                *buf = 136315394;
                v68 = v38;
                v69 = 1024;
                LODWORD(v70) = 21;
                _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v48 = (&_IDSStunTransportStrings)[[v36 transport]];
                  v49 = 21;
                  _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
                  if (_IDSShouldLog())
                  {
                    v48 = (&_IDSStunTransportStrings)[[v36 transport]];
                    v49 = 21;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
                  }
                }
              }

              GLUtilReportAWDClientTimerEvent(305, 21, v27, self->_enableSKE, self->_isInitiator, 0.0);
              v39 = GLUCreateQRClientTimeEvent(305, 21, v27, self->_timeBase, 0.0);
              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              v41 = objc_opt_respondsToSelector();

              if (v41)
              {
                v42 = objc_loadWeakRetained(&self->_delegate);
                [v42 link:self didAddQREvent:v39];
              }

              goto LABEL_59;
            }
          }

          v24 = [v23 countByEnumeratingWithState:&v55 objects:v73 count:16];
          if (v24)
          {
            continue;
          }

          break;
        }
      }

LABEL_59:
    }

    [(IDSGlobalLink *)self _discardCandidatePairsWithOption:1 isReinitiating:v4, v48, v49];
    if (v6)
    {
      v43 = im_primary_queue();
      v53[0] = MEMORY[0x1E69E9820];
      v53[1] = 3221225472;
      v53[2] = sub_1A7B7E590;
      v53[3] = &unk_1E77E0B48;
      v54 = v6;
      v44 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, v53);
      dispatch_async(v43, v44);
    }

    else
    {
      v45 = objc_loadWeakRetained(&self->_delegate);
      v46 = objc_opt_respondsToSelector();

      if (v46)
      {
        v47 = objc_loadWeakRetained(&self->_delegate);
        [v47 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
      }
    }
  }
}

- (void)setClientUniquePID:(unint64_t)a3
{
  v8 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = 134217984;
    v7 = a3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Got client unique PID %llu", &v6, 0xCu);
  }

  self->_clientUniquePID = a3;
}

- (void)requestChildConnectionIDForLinkID:(char)a3 relayGroupID:(id)a4
{
  v4 = a3;
  v52 = *MEMORY[0x1E69E9840];
  v6 = a4;
  if (self->_QUICForQREnabled && !self->_disableDirectDatapath)
  {
    v7 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v49) = v4;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "requestChildConnectionIDForLinkID called for linkID %d", buf, 8u);
    }

    v8 = GLUtilGetCandidatePairByLinkID(v4, self->_sendInfoList, self->_candidatePairs, self->_maxLinkID, self->_channelToCandidatePairs);
    if ([v8 isVirtualRelayStunCandidatePair])
    {
      v9 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        LODWORD(v49) = v4;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "requestChildConnectionIDForLinkID linkID %d is for a virtual link", buf, 8u);
      }
    }

    else
    {
      HIDWORD(v37) = v4;
      v47 = v6;
      if ([v8 isRelayStunCandidatePair])
      {
        v10 = 5;
      }

      else
      {
        v10 = 0;
      }

      nwLink = self->_nwLink;
      v45 = v10;
      v11 = [v8 local];
      v40 = [v11 address];
      v12 = [v8 remote];
      v13 = [v12 external];
      clientUniquePID = self->_clientUniquePID;
      v15 = [v8 sessionID];
      v16 = [v8 isRelayStunCandidatePair];
      v17 = [v8 kindSuffix];
      v18 = [v8 local];
      LOBYTE(v37) = [v18 isCellularStunCandidate];
      v9 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:v40 remoteAddress:v13 clientUniquePID:clientUniquePID sessionID:v15 type:v45 isRelay:v16 protocolStackSuffix:v17 isCellular:v37];

      if ([v8 isRelayStunCandidatePair])
      {
        v44 = [(IDSGlobalLink *)self _shouldUseQRTLE];
        v41 = self->_nwLink;
        v46 = [v8 local];
        v19 = [v46 address];
        v20 = [v8 remote];
        v21 = [v20 external];
        v22 = self->_clientUniquePID;
        v23 = [v8 sessionID];
        v24 = [v8 kindSuffix];
        v25 = [v8 local];
        LOBYTE(v38) = [v25 isCellularStunCandidate];
        [(IDSNWLink *)v41 connectionInfoForLocalAddress:v19 remoteAddress:v21 clientUniquePID:v22 sessionID:v23 type:7 isRelay:1 protocolStackSuffix:v24 isCellular:v38];
      }

      else
      {
        v44 = [(IDSGlobalLink *)self _shouldUseP2PTLE];
        v42 = self->_nwLink;
        v46 = [v8 local];
        v26 = [v46 address];
        v20 = [v8 remote];
        v27 = [v20 external];
        v28 = self->_clientUniquePID;
        v23 = [v8 sessionID];
        v24 = [v8 kindSuffix];
        v25 = [v8 local];
        LOBYTE(v38) = [v25 isCellularStunCandidate];
        [(IDSNWLink *)v42 connectionInfoForLocalAddress:v26 remoteAddress:v27 clientUniquePID:v28 sessionID:v23 type:9 isRelay:0 protocolStackSuffix:v24 isCellular:v38];
      }
      v29 = ;

      v30 = [MEMORY[0x1E695DF90] dictionary];
      if (v9)
      {
        v31 = GLUtilConnectionDictionaryForNWConnectionInfo(v9, 1);
        [v30 setObject:v31 forKeyedSubscript:@"udp"];
      }

      if (v29)
      {
        v32 = GLUtilConnectionDictionaryForNWConnectionInfo(v29, v44);
        [v30 setObject:v32 forKeyedSubscript:@"qpod"];
      }

      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v34 = objc_opt_respondsToSelector();

      if (v34)
      {
        v35 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          v49 = v30;
          v50 = 1024;
          v51 = v39;
          _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "Send child connections %@ for linkID %d", buf, 0x12u);
        }

        v36 = objc_loadWeakRetained(&self->_delegate);
        [v36 link:self didReceiveChildConnections:v30 forLinkID:v39];
      }

      v6 = v47;
    }
  }
}

- (void)_updateDefaultCandidatePair:(id)a3
{
  v47 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v36 = self;
  v5 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  v37 = v4;
  if (v5)
  {
    v6 = v5;
    if (*(v5 + 1))
    {
      [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v40 = 0u;
      v41 = 0u;
      v38 = 0u;
      v7 = v39 = 0u;
      v8 = [v7 countByEnumeratingWithState:&v38 objects:v46 count:16];
      if (v8)
      {
        v9 = *v39;
        do
        {
          for (i = 0; i != v8; ++i)
          {
            if (*v39 != v9)
            {
              objc_enumerationMutation(v7);
            }

            v11 = *(*(&v38 + 1) + 8 * i);
            v12 = [v11 local];
            v13 = [v12 address];

            v14 = [v11 remote];
            v15 = [v14 external];

            v16 = [v11 channelNumber];
            if (IsSameSA(v13, (v6 + 1)) && IsSameSA(v15, (v6 + 17)) && *(v6 + 132) == v16)
            {
              [v11 setIsActive:0];
              [v11 setLastOutgoingPacketTime:v6[38]];
              [v11 setLastIncomingPacketTime:v6[39]];
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v43 = v11;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "deactivate candidate pair %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v34 = v11;
                  _IDSLogTransport(@"GL", @"IDS", @"deactivate candidate pair %@.");
                  if (_IDSShouldLog())
                  {
                    v34 = v11;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"deactivate candidate pair %@.");
                  }
                }
              }
            }
          }

          v8 = [v7 countByEnumeratingWithState:&v38 objects:v46 count:16];
        }

        while (v8);
      }

      v4 = v37;
    }

    IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(v36->_sendInfoList, v4, 0);
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = [v37 linkID];
      *buf = 138412546;
      v43 = v37;
      v44 = 1024;
      v45 = v19;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v34 = v37;
        v35 = [v37 linkID];
        _IDSLogTransport(@"GL", @"IDS", @"_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.");
        if (_IDSShouldLog())
        {
          v20 = [v37 linkID];
          v34 = v37;
          v35 = v20;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.");
        }
      }
    }

    [v37 setIsActive:{1, v34, v35}];
    if (([v37 isNominated] & 1) == 0)
    {
      [v37 setIsNominated:1];
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v43 = v37;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "set nominated flag for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"set nominated flag for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"set nominated flag for %@.");
          }
        }
      }
    }

    v22 = v37;
    if (v36->_useLinkSelection)
    {
      v23 = [v37 linkEngine];
      v22 = v37;
      if (v23)
      {
        v24 = [v37 linkEngine];
        v25 = [v24 idsPrimarySecondaryLinkSelector];
        v26 = v25 == 0;

        v22 = v37;
        if (!v26)
        {
          v27 = [v37 linkEngine];
          v28 = [v27 idsPrimarySecondaryLinkSelector];
          defaultLinkSelector = v36->_defaultLinkSelector;
          v36->_defaultLinkSelector = v28;

LABEL_43:
          v22 = v37;
        }
      }
    }
  }

  else
  {
    v30 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_updateDefaultCandidatePair failed due to invalid list.", buf, 2u);
    }

    v31 = os_log_shim_legacy_logging_enabled();
    v22 = v37;
    if (v31)
    {
      v32 = _IDSShouldLogTransport();
      v22 = v37;
      if (v32)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_updateDefaultCandidatePair failed due to invalid list.");
        v33 = _IDSShouldLog();
        v22 = v37;
        if (v33)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateDefaultCandidatePair failed due to invalid list.");
          goto LABEL_43;
        }
      }
    }
  }
}

- (BOOL)_hasCandidatePairInState:(unint64_t)a3 anotherState:(unint64_t)a4 relayCandidatePairsOnly:(BOOL)a5 excludeSelfAlloc:(BOOL)a6
{
  v6 = a6;
  v7 = a5;
  v32 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v10 = v26 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v24;
    while (2)
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v24 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v23 + 1) + 8 * i);
        if ((!v6 || [*(*(&v23 + 1) + 8 * i) allocateType] != 2) && (!v7 || objc_msgSend(v15, "isRelayStunCandidatePair")))
        {
          v16 = [v15 state];
          if (v16 == a3 || v16 == a4)
          {
            v19 = v16;
            v20 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              v21 = (&_IDSStunCandidatePairStateStrings)[v19];
              *buf = 136315394;
              v28 = v21;
              v29 = 2112;
              v30 = v15;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Found a CandidatePair in state: %s for %@", buf, 0x16u);
            }

            v18 = 1;
            goto LABEL_20;
          }
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
      if (v12)
      {
        continue;
      }

      break;
    }
  }

  v18 = 0;
LABEL_20:

  return v18;
}

- (id)_getCandidatePairsWithSessionID:(id)a3 inState:(unint64_t)a4
{
  v24 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = [MEMORY[0x1E695DF70] array];
  v8 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v19 objects:v23 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v20;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v20 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v19 + 1) + 8 * i);
        v14 = [v13 state];
        if ([v13 isRelayStunCandidatePair])
        {
          v15 = v14 == a4;
        }

        else
        {
          v15 = 0;
        }

        if (v15)
        {
          v16 = [v13 sessionID];
          v17 = [v16 isEqualToString:v6];

          if (v17)
          {
            [v7 addObject:v13];
          }
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v19 objects:v23 count:16];
    }

    while (v10);
  }

  return v7;
}

- (void)_discardCandidatePairsWithOption:(BOOL)a3 isReinitiating:(BOOL)a4
{
  v4 = a4;
  v5 = a3;
  v35 = *MEMORY[0x1E69E9840];
  v7 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = @"NO";
    if (v5)
    {
      v10 = @"YES";
    }

    else
    {
      v10 = @"NO";
    }

    if (v4)
    {
      v9 = @"YES";
    }

    *buf = 138412546;
    v32 = v10;
    v33 = 2112;
    v34 = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v11 = v5 ? @"YES" : @"NO";
    v12 = v4 ? @"YES" : @"NO";
    v24 = v11;
    v25 = v12;
    _IDSLogTransport(@"GL", @"IDS", @"_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).");
    if (_IDSShouldLog())
    {
      v24 = v11;
      v25 = v12;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).");
    }
  }

  v28 = 0u;
  v29 = 0u;
  v26 = 0u;
  v27 = 0u;
  v13 = v7;
  v14 = [v13 countByEnumeratingWithState:&v26 objects:v30 count:16];
  if (v14)
  {
    v15 = *v27;
    if (v4)
    {
      v16 = 12;
    }

    else
    {
      v16 = 11;
    }

    do
    {
      v17 = 0;
      do
      {
        if (*v27 != v15)
        {
          objc_enumerationMutation(v13);
        }

        v18 = *(*(&v26 + 1) + 8 * v17);
        v19 = [(__CFString *)v18 state:v24];
        if ([(__CFString *)v18 isRelayStunCandidatePair])
        {
          if (v5 && v19 <= 4)
          {
            v20 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v32 = v18;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "disconnect relay candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v24 = v18;
                _IDSLogTransport(@"GL", @"IDS", @"disconnect relay candidate pair %@.");
                if (_IDSShouldLog())
                {
                  v24 = v18;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect relay candidate pair %@.");
                }
              }
            }

            [(__CFString *)v18 stopSessionConnectedTimer];
            [(__CFString *)v18 stopSessionConvergenceTimer];
            v21 = [(__CFString *)v18 isQUIC];
            v22 = [(__CFString *)v18 candidatePairToken];
            if (v21)
            {
              [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:v22 reason:v16];
            }

            else
            {
              [(IDSGlobalLink *)self _sendUnallocbindRequest:v22 stunMessage:0 reason:v16];
            }
          }
        }

        else
        {
          [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v18 withReason:11];
        }

        ++v17;
      }

      while (v14 != v17);
      v23 = [v13 countByEnumeratingWithState:&v26 objects:v30 count:16];
      v14 = v23;
    }

    while (v23);
  }
}

- (void)_discardAllCandidatePairs:(BOOL)a3
{
  v3 = a3;
  v22 = *MEMORY[0x1E69E9840];
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (v3)
    {
      v6 = @"YES";
    }

    *buf = 138412290;
    v21 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "discard all candidate pairs isReinitiating: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v7 = v3 ? @"YES" : @"NO";
    v14 = v7;
    _IDSLogTransport(@"GL", @"IDS", @"discard all candidate pairs isReinitiating: %@");
    if (_IDSShouldLog())
    {
      v14 = v7;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"discard all candidate pairs isReinitiating: %@");
    }
  }

  if (self->_useLinkEngine)
  {
    remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
    self->_remoteAcceptedDevicePushTokens = 0;

    v17 = 0u;
    v18 = 0u;
    v15 = 0u;
    v16 = 0u;
    v9 = self->_sessionsByID;
    v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v15 objects:v19 count:16];
    if (v10)
    {
      v11 = *v16;
      do
      {
        v12 = 0;
        do
        {
          if (*v16 != v11)
          {
            objc_enumerationMutation(v9);
          }

          v13 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v15 + 1) + 8 * v12), v14];
          [v13 reset];

          ++v12;
        }

        while (v10 != v12);
        v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v15 objects:v19 count:16];
      }

      while (v10);
    }

    [(IDSGlobalLink *)self _updateAllLinks];
  }

  [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:v3, v14];
  if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0])
  {
    [(IDSGlobalLink *)self _discardCandidatePairsWithOption:1 isReinitiating:v3];
  }

  else
  {
    [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:11];
  }
}

- (void)_discardNonAcceptedCandidatePairs
{
  v65 = *MEMORY[0x1E69E9840];
  if (self->_isInitiator)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "start to discard non-accepted candidate pairs.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"start to discard non-accepted candidate pairs.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"start to discard non-accepted candidate pairs.");
        }
      }
    }

    v52 = 0u;
    v53 = 0u;
    v50 = 0u;
    v51 = 0u;
    obj = self->_nonAcceptedQRSessions;
    v37 = [(NSMutableArray *)obj countByEnumeratingWithState:&v50 objects:v64 count:16];
    if (v37)
    {
      v36 = *v51;
      do
      {
        for (i = 0; i != v37; ++i)
        {
          if (*v51 != v36)
          {
            objc_enumerationMutation(obj);
          }

          v41 = *(*(&v50 + 1) + 8 * i);
          if ([v41 isRelayStunCandidatePair])
          {
            v4 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
            {
              v5 = [v41 candidatePairToken];
              *buf = 138412290;
              v55 = v5;
              _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "disconnect non-accepted relay candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v34 = [v41 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"disconnect non-accepted relay candidate pair %@.");

                if (_IDSShouldLog())
                {
                  v34 = [v41 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect non-accepted relay candidate pair %@.");
                }
              }
            }

            v6 = [v41 sessionID];
            v7 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:v6 inState:3];

            v48 = 0u;
            v49 = 0u;
            v46 = 0u;
            v47 = 0u;
            v40 = v7;
            v8 = [v40 countByEnumeratingWithState:&v46 objects:v63 count:16];
            if (v8)
            {
              v9 = *v47;
              do
              {
                for (j = 0; j != v8; ++j)
                {
                  if (*v47 != v9)
                  {
                    objc_enumerationMutation(v40);
                  }

                  v11 = *(*(&v46 + 1) + 8 * j);
                  v12 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
                  {
                    v13 = [v41 sessionID];
                    *buf = 138412546;
                    v55 = v11;
                    v56 = 2112;
                    v57 = v13;
                    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_discardNonAcceptedCandidatePairs: found succeeded candidate pair %@ with the same QRSessionID %@, send unallocbind request", buf, 0x16u);
                  }

                  v14 = [v11 isQUIC];
                  v15 = [v11 candidatePairToken];
                  if (v14)
                  {
                    [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:v15 reason:8];
                  }

                  else
                  {
                    [(IDSGlobalLink *)self _sendUnallocbindRequest:v15 stunMessage:0 reason:8];
                  }
                }

                v8 = [v40 countByEnumeratingWithState:&v46 objects:v63 count:16];
              }

              while (v8);
            }

            v16 = [v41 sessionID];
            v17 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:v16 inState:1];

            v44 = 0u;
            v45 = 0u;
            v42 = 0u;
            v43 = 0u;
            v39 = v17;
            v18 = [v39 countByEnumeratingWithState:&v42 objects:v62 count:16];
            if (v18)
            {
              v19 = *v43;
              do
              {
                for (k = 0; k != v18; ++k)
                {
                  if (*v43 != v19)
                  {
                    objc_enumerationMutation(v39);
                  }

                  v21 = *(*(&v42 + 1) + 8 * k);
                  v22 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
                  {
                    v23 = [v41 sessionID];
                    v24 = (&_IDSStunCandidatePairStateStrings)[[v21 state]];
                    *buf = 138413058;
                    v55 = v21;
                    v56 = 2112;
                    v57 = v23;
                    v58 = 2080;
                    v59 = v24;
                    v60 = 2080;
                    v61 = off_1EB2B43D8;
                    _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_discardNonAcceptedCandidatePairs: found inProgress candidate pair %@ with the same QRSessionID %@, update state (%s->%s)", buf, 0x2Au);
                  }

                  [v21 setState:6];
                  if (self->_useLinkEngine)
                  {
                    v25 = [v21 linkEngine];
                    v26 = [v21 linkUniqueName];
                    [v25 linkDidDisconnect:v26];
                  }

                  if ([v21 isQUIC])
                  {
                    v27 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
                    {
                      v28 = [v41 candidatePairToken];
                      *buf = 138412290;
                      v55 = v28;
                      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "Disconnecting discarded in-progress QUIC connection %@", buf, 0xCu);
                    }

                    nwLink = self->_nwLink;
                    v30 = [v21 sessionID];
                    v31 = [v21 local];
                    v32 = [v31 address];
                    v33 = [v21 remote];
                    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", v30, v32, [v33 external], 1, 5.0);
                  }
                }

                v18 = [v39 countByEnumeratingWithState:&v42 objects:v62 count:16];
              }

              while (v18);
            }
          }
        }

        v37 = [(NSMutableArray *)obj countByEnumeratingWithState:&v50 objects:v64 count:16];
      }

      while (v37);
    }

    [(NSMutableArray *)self->_nonAcceptedQRSessions removeAllObjects];
  }
}

- (void)_discardSelfAllocateCandidatePairs
{
  v20 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v15 = 0u;
  v16 = 0u;
  v13 = 0u;
  v3 = v14 = 0u;
  v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
  if (v4)
  {
    v5 = *v14;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v14 != v5)
        {
          objc_enumerationMutation(v3);
        }

        v7 = *(*(&v13 + 1) + 8 * i);
        if ([v7 isRelayStunCandidatePair] && objc_msgSend(v7, "allocateType") == 2)
        {
          v8 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
          {
            v9 = [v7 candidatePairToken];
            *buf = 138412290;
            v18 = v9;
            _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "disconnect self allocate candidate pair %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v12 = [v7 candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"disconnect self allocate candidate pair %@.");

              if (_IDSShouldLog())
              {
                v12 = [v7 candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect self allocate candidate pair %@.");
              }
            }
          }

          v10 = [v7 isQUIC];
          v11 = [v7 candidatePairToken];
          if (v10)
          {
            [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:v11 reason:0];
          }

          else
          {
            [(IDSGlobalLink *)self _sendUnallocbindRequest:v11 stunMessage:0 reason:0];
          }
        }
      }

      v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
    }

    while (v4);
  }
}

- (void)_removePacketNotificationFilter
{
  v29 = *MEMORY[0x1E69E9840];
  v3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v4 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v4)
  {
    v5 = v4;
    v24 = 0u;
    v25 = 0u;
    v22 = 0u;
    v23 = 0u;
    v6 = v3;
    v7 = [v6 countByEnumeratingWithState:&v22 objects:v28 count:16];
    if (v7)
    {
      v8 = *v23;
      while (2)
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v23 != v8)
          {
            objc_enumerationMutation(v6);
          }

          v10 = *(*(&v22 + 1) + 8 * i);
          v11 = [v10 local];
          v12 = [v11 address];

          v13 = [v10 remote];
          v14 = [v13 external];

          v15 = [v10 local];
          if ([v15 isCellularStunCandidate] && IsSameSA(v12, (v5 + 1)))
          {
            v16 = IsSameSA(v14, (v5 + 17));

            if (v16)
            {
              v18 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v27 = v10;
                _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "remove packet notification filter for %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v21 = v10;
                  _IDSLogTransport(@"GL", @"IDS", @"remove packet notification filter for %@.");
                  if (_IDSShouldLog())
                  {
                    v21 = v10;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"remove packet notification filter for %@.");
                  }
                }
              }

              v20 = +[IDSCellularLinkMonitor sharedInstance];
              [v20 removePacketNotificationFilter];

              goto LABEL_28;
            }
          }

          else
          {
          }
        }

        v7 = [v6 countByEnumeratingWithState:&v22 objects:v28 count:16];
        if (v7)
        {
          continue;
        }

        break;
      }
    }

LABEL_28:
  }

  else
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "_removePacketNotificationFilter failed due to invalid default link.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_removePacketNotificationFilter failed due to invalid default link.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_removePacketNotificationFilter failed due to invalid default link.");
        }
      }
    }
  }
}

- (void)_sendSessionDisconnectedCommand
{
  v20 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v15 = 0u;
  v16 = 0u;
  v13 = 0u;
  v3 = v14 = 0u;
  v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
  if (v4)
  {
    v5 = *v14;
LABEL_3:
    v6 = 0;
    while (1)
    {
      if (*v14 != v5)
      {
        objc_enumerationMutation(v3);
      }

      v7 = *(*(&v13 + 1) + 8 * v6);
      if ([v7 isActive])
      {
        break;
      }

      if (v4 == ++v6)
      {
        v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
        if (v4)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v8 = v7;

    if (!v8)
    {
      goto LABEL_18;
    }

    v9 = [v8 candidatePairToken];
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v18 = v9;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "send session disconnected using %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v12 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"send session disconnected using %@.");
        if (_IDSShouldLog())
        {
          v12 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send session disconnected using %@.");
        }
      }
    }

    [(IDSGlobalLink *)self _sendCommandMessage:2 stunMessage:0 options:0 candidatePairToken:v9, v12];
  }

  else
  {
LABEL_9:

LABEL_18:
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair to send session disconnected command.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair to send session disconnected command.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair to send session disconnected command.");
        }
      }
    }
  }
}

- (void)_setChannelToCandidatePair:(id)a3 localAddress:(sockaddr *)a4 remoteAddress:(sockaddr *)a5 channelNumber:(unsigned __int16)a6
{
  v6 = a6;
  v20 = *MEMORY[0x1E69E9840];
  v10 = a3;
  if (!self->_channelToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    channelToCandidatePairs = self->_channelToCandidatePairs;
    self->_channelToCandidatePairs = Mutable;
  }

  v13 = channelForStunCandidatePair(a4, a5, v6);
  v14 = v10;
  if (v14)
  {
    CFDictionarySetValue(self->_channelToCandidatePairs, v13, v14);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E14A84();
  }

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v17 = v13;
    v18 = 2112;
    v19 = v14;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "set channel %@ for %@.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"set channel %@ for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"set channel %@ for %@.");
      }
    }
  }
}

- (char)allocateLinkID
{
  v18 = *MEMORY[0x1E69E9840];
  v2 = self->_linkIDCounter + 1;
  self->_linkIDCounter = v2;
  v3 = v2;
  if (self->_maxLinkID >= v2)
  {
LABEL_15:
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v15 = v3;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: linkID %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: linkID %d");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: linkID %d");
        }
      }
    }

    return v3;
  }

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    maxLinkID = self->_maxLinkID;
    *buf = 67109376;
    v15 = v2;
    v16 = 1024;
    v17 = maxLinkID;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v12 = v2;
      v13 = self->_maxLinkID;
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse");
      if (_IDSShouldLog())
      {
        v12 = v2;
        v13 = self->_maxLinkID;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse");
      }
    }
  }

  if ([(NSMutableArray *)self->_unusedLinkIDs count:v12])
  {
    v7 = [(NSMutableArray *)self->_unusedLinkIDs firstObject];
    v3 = [v7 intValue];

    [(NSMutableArray *)self->_unusedLinkIDs removeFirstObject];
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v15 = v3;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: reusing linkID %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: reusing linkID %d");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: reusing linkID %d");
        }
      }
    }

    goto LABEL_15;
  }

  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: could not find a linkID to reuse", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: could not find a linkID to reuse");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: could not find a linkID to reuse");
      }
    }
  }

  [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:255 reason:10];
  return -1;
}

- (void)freeLinkID:(char)a3
{
  v3 = a3;
  unusedLinkIDs = self->_unusedLinkIDs;
  v6 = [MEMORY[0x1E696AD98] numberWithChar:?];
  v7 = [(NSMutableArray *)unusedLinkIDs containsObject:v6];

  if (v3 >= 1 && (v7 & 1) == 0)
  {
    v8 = self->_unusedLinkIDs;
    v9 = [MEMORY[0x1E696AD98] numberWithChar:v3];
    [(NSMutableArray *)v8 addObject:v9];
  }
}

- (void)_initializeSendInfoForCandidatePair:(id)a3
{
  v11 = a3;
  v5 = [v11 isVirtualRelayStunCandidatePair];
  v6 = [(IDSGlobalLink *)self allocateLinkID];
  [v11 setLinkID:v6];
  v7 = [v11 linkEngine];
  v8 = [v11 linkID];
  v9 = [v11 linkUniqueName];
  [v7 setIDSLinkID:v8 forLinkWithUniqueID:v9];

  if ((v6 & 0x80000000) == 0 || self->_maxLinkID > v6)
  {
    objc_storeStrong(&self->_candidatePairs[v6], a3);
  }

  IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, v11, v6);
  v10 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v10 && !((*v10 != 0) | v5 & 1))
  {
    IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, v11, 0);
  }
}

- (void)_deinitialieSendInfoForCandidatePair:(id)a3
{
  v4 = a3;
  -[IDSGlobalLink freeLinkID:](self, "freeLinkID:", [v4 linkID]);
  [v4 setLinkID:0];
}

- (void)_setCandidatePairConnected:(id)a3
{
  v82 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = v4;
  if (v4)
  {
    v6 = [v4 isVirtualRelayStunCandidatePair];
    if (self->_linkConnectTime == 0.0 && self->_isUPlusOneSession && v6 & 1 | (([v5 isRelayStunCandidatePair] & 1) == 0))
    {
      self->_linkConnectTime = ids_monotonic_time();
    }

    [(IDSGlobalLink *)self _initializeSendInfoForCandidatePair:v5];
    v7 = [v5 linkID];
    if (!(v6 & 1 | (([v5 isSharedQRSession] & 1) == 0)))
    {
      [(IDSGlobalLink *)self _updateLinkIDForPlugin:v5];
    }

    if ((v6 & 1) == 0)
    {
      if ([v5 isSharedQRSession])
      {
        qraBlocks = self->_qraBlocks;
        if (qraBlocks)
        {
          qraCONBlock = qraBlocks->_qraCONBlock;
          if (qraCONBlock)
          {
            cbuuid = self->_cbuuid;
            v11 = [v5 sessionID];
            qraCONBlock[2](qraCONBlock, cbuuid, v11);
          }
        }
      }
    }

    if (self->_ftPowerOptimizationEnabled)
    {
      [(IDSGlobalLink *)self _sendChannelConfigRequestToQR:v5];
    }

    v12 = [(IDSGlobalLink *)self _getLocalAttribute:v5];
    v65 = [(IDSGlobalLink *)self _getRemoteAttribute:v5];
    if ((v6 & 1) != 0 || ![v5 isRelayStunCandidatePair])
    {
      [(IDSGFTMetricsCollector *)self->_metricsCollector didConnectUnderlyingE2ELink];
    }

    else
    {
      [(IDSGFTMetricsCollector *)self->_metricsCollector didConnectUnderlyingRelayLink];
    }

    if (IMGetDomainBoolForKey() && self->_isUPlusOneSession && !GLUtilUnderPerformanceTesting(v5, v6))
    {
      goto LABEL_38;
    }

    qualityMeasurer = self->_qualityMeasurer;
    v14 = [v5 testableLink];
    v15 = [v5 uniqueID];
    [(IDSLinksQualityMeasurer *)qualityMeasurer addLink:v14 uniqueID:v15 completionHandler:&unk_1F1AAA3C0];

    v16 = [v5 linkEngine];
    if (v16)
    {
      v17 = [v5 linkUniqueName];

      if (v17)
      {
        v18 = [v5 linkEngine];
        v19 = [v5 testableLink];
        v20 = [v5 linkUniqueName];
        [v18 setTestableLink:v19 forLinkWithUniqueID:v20];

        v21 = [v5 linkEngine];
        v22 = [v5 linkUniqueName];
        v23 = [v21 packetQualityHandlerForLinkWithUniqueName:v22];

        if (v23)
        {
          [v5 setQualityHandler:v23];
          v24 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412546;
            *v75 = v23;
            *&v75[8] = 2112;
            *&v75[10] = v5;
            _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: handler %@ for candidatePair %@", buf, 0x16u);
          }
        }
      }
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v26 = objc_opt_respondsToSelector();

    if ((v26 & 1) == 0)
    {
LABEL_38:
      v64 = v12;
LABEL_68:

      goto LABEL_69;
    }

    if (v6)
    {
      v63 = @"VR ";
    }

    else
    {
      v28 = [v5 isRelayStunCandidatePair];
      v29 = @"P2P";
      if (v28)
      {
        v29 = @"RLY";
      }

      v63 = v29;
      if ([v5 isRelayStunCandidatePair])
      {
        v30 = [v5 local];
        v31 = GLUtilStunTransportToProtocol([v30 transport], self->_H2FallbackEnabled);

        v32 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          idsSessionID = self->_idsSessionID;
          v34 = [v5 sessionID];
          *buf = 67110402;
          *v75 = v7;
          *&v75[4] = 2112;
          *&v75[6] = v63;
          *&v75[14] = 2112;
          *&v75[16] = v31;
          v76 = 2112;
          v77 = idsSessionID;
          v78 = 2112;
          v79 = v34;
          v80 = 2112;
          v81 = v5;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Send link connected (%d) %@ using %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x3Au);
        }

        v35 = [v5 local];
        v36 = [v35 transport];

        v37 = GLUtilStunTransportToLinkType(v36, self->_H2FallbackEnabled);
        if (v37 > 331)
        {
          if (v37 == 332)
          {
            [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingTCPSTUN];
          }

          else if (v37 == 333)
          {
            [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingFakeTLS];
          }
        }

        else if (v37 == 313)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingQUIC];
        }

        else if (v37 == 331)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingHTTP2];
        }

        goto LABEL_50;
      }
    }

    v31 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v38 = self->_idsSessionID;
      v39 = [v5 sessionID];
      *buf = 67110146;
      *v75 = v7;
      *&v75[4] = 2112;
      *&v75[6] = v63;
      *&v75[14] = 2112;
      *&v75[16] = v38;
      v76 = 2112;
      v77 = v39;
      v78 = 2112;
      v79 = v5;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "Send link connected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x30u);
    }

LABEL_50:

    nwLink = self->_nwLink;
    if (nwLink)
    {
      [(IDSNWLink *)nwLink logConnectionTree];
    }

    v64 = [(IDSGlobalLink *)self _translateLinkTransportTypeWhenH2Enabled:v12];

    v41 = objc_loadWeakRetained(&self->_delegate);
    v42 = [v5 linkUUID];
    [v41 link:self didConnectUnderlyingLink:v7 linkUUID:v42 localAttributes:v64 remoteAttributes:v65];

    if (self->_connectedLinkIDs || (v43 = objc_alloc_init(MEMORY[0x1E695DF70]), v44 = self->_connectedLinkIDs, self->_connectedLinkIDs = v43, v44, self->_connectedLinkIDs))
    {
      v45 = [MEMORY[0x1E696AD98] numberWithInt:v7];
      v46 = v45 == 0;

      if (!v46)
      {
        connectedLinkIDs = self->_connectedLinkIDs;
        v48 = [MEMORY[0x1E696AD98] numberWithInt:v7];
        CFArrayAppendValue(connectedLinkIDs, v48);
      }
    }

    [(IDSGlobalLink *)self _resetRetryCountForCandidatePair:v5];
    [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedWithH2FallbackEnabled:self->_H2FallbackEnabled];
    v71 = 0u;
    v72 = 0u;
    v69 = 0u;
    v70 = 0u;
    v49 = [v5 connections];
    v50 = [v49 countByEnumeratingWithState:&v69 objects:v73 count:16];
    if (v50)
    {
      v51 = *v70;
      do
      {
        for (i = 0; i != v50; ++i)
        {
          if (*v70 != v51)
          {
            objc_enumerationMutation(v49);
          }

          v53 = *(*(&v69 + 1) + 8 * i);
          v54 = [v5 connections];
          v55 = [v54 objectForKeyedSubscript:v53];

          v56 = [v5 linkMetrics];
          v57 = [v55 objectForKeyedSubscript:@"protocol-stack"];
          [v56 linkConnectedWithProtocolStack:v57];
        }

        v50 = [v49 countByEnumeratingWithState:&v69 objects:v73 count:16];
      }

      while (v50);
    }

    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v5];
    v58 = GLUCreateLinkConnectedEvent(v5, self->_H2FallbackEnabled);
    v59 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v75 = v58;
      _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "added qrLinkConnectedEvent: %@", buf, 0xCu);
    }

    v60 = objc_loadWeakRetained(&self->_delegate);
    v61 = objc_opt_respondsToSelector();

    if (v61)
    {
      v62 = objc_loadWeakRetained(&self->_delegate);
      [v62 link:self didAddQREvent:v58];
    }

    objc_initWeak(buf, self);
    v66[0] = MEMORY[0x1E69E9820];
    v66[1] = 3221225472;
    v66[2] = sub_1A7B81E00;
    v66[3] = &unk_1E77E0D28;
    objc_copyWeak(&v68, buf);
    v67 = v5;
    IDSTransportThreadAddBlock(v66);

    objc_destroyWeak(&v68);
    objc_destroyWeak(buf);

    goto LABEL_68;
  }

  v27 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: invalid candidatePair", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: invalid candidatePair");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: invalid candidatePair");
      }
    }
  }

LABEL_69:
}

- (id)_translateLinkTransportTypeWhenH2Enabled:(id)a3
{
  v16 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = v4;
  if (!self->_H2FallbackEnabled)
  {
    goto LABEL_7;
  }

  v6 = [v4 objectForKey:@"gl-attr-transport"];
  v7 = [v6 unsignedCharValue];

  if (v7 == 3)
  {
    v8 = 5;
  }

  else
  {
    if (v7 != 4)
    {
LABEL_7:
      v9 = v5;
      goto LABEL_8;
    }

    v8 = 3;
  }

  if (v8 == v7)
  {
    goto LABEL_7;
  }

  v11 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    v13[0] = 67109376;
    v13[1] = v7;
    v14 = 1024;
    v15 = v8;
    _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_translateLinkTransportTypeWhenH2Enabled: %d -> %d", v13, 0xEu);
  }

  v9 = [v5 mutableCopy];
  v12 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:v8];
  if (v12)
  {
    CFDictionarySetValue(v9, @"gl-attr-transport", v12);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E14B00();
  }

LABEL_8:

  return v9;
}

- (void)_setLinkMetricsAttributesForCandidatePair:(id)a3 linkAttributes:(id)a4
{
  v23 = a3;
  v5 = a4;
  if (v23)
  {
    if ([v23 isVirtualRelayStunCandidatePair])
    {
      v6 = @"VR ";
    }

    else if ([v23 isRelayStunCandidatePair])
    {
      v6 = @"RLY";
    }

    else
    {
      v6 = @"P2P";
    }

    [v5 setLinkType:v6];
    v7 = [v23 connections];
    v8 = [v7 objectForKeyedSubscript:@"qpod"];

    v9 = [v23 connections];
    v10 = [v9 objectForKeyedSubscript:@"udp"];

    if (v8 && ([v8 objectForKeyedSubscript:@"allow-outgoing"], v11 = objc_claimAutoreleasedReturnValue(), v12 = objc_msgSend(v11, "BOOLValue"), v11, v12))
    {
      v13 = [v8 objectForKeyedSubscript:@"protocol-stack"];
      [v5 setChannelDataProtocolStack:v13];

      [v5 setIsTLEEnabled:1];
    }

    else if (v10)
    {
      v14 = [v10 objectForKeyedSubscript:@"protocol-stack"];
      [v5 setChannelDataProtocolStack:v14];
    }

    v15 = [v23 connections];
    v16 = [v15 objectForKeyedSubscript:@"qr"];

    if (v16 && [v23 isRelayStunCandidatePair])
    {
      v17 = [v16 objectForKeyedSubscript:@"protocol-stack"];
      [v5 setRelayProtocolStack:v17];
    }

    v18 = [v23 local];
    [v5 setLocalRAT:{objc_msgSend(v18, "radioAccessTechnology")}];

    v19 = [v23 remote];
    [v5 setRemoteRAT:{objc_msgSend(v19, "radioAccessTechnology")}];

    v20 = [v23 local];
    if (*([v20 address] + 1) == 30)
    {
      v21 = 6;
    }

    else
    {
      v21 = 4;
    }

    [v5 setIPVersion:v21];

    v22 = [v23 linkEngine];
    [v5 setIsLinkEngineLink:v22 != 0];
  }
}

- (void)_setLinkMetricsAttributesForCandidatePair:(id)a3
{
  if (a3)
  {
    v4 = a3;
    v5 = [v4 linkMetrics];
    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v4 linkAttributes:v5];
  }
}

- (void)_updateLinkIDForPlugin:(id)a3
{
  v43 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = v4;
  linkIDForPlugin = self->_linkIDForPlugin;
  if (!self->_linkIDForPlugin)
  {
    self->_linkIDForPlugin = [(IDSStunCandidatePair *)v4 linkID];
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v19;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v34 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d");
        if (_IDSShouldLog())
        {
          v34 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d");
        }
      }
    }

    v8 = 0;
    v17 = v5;
LABEL_43:
    if (![(IDSStunCandidatePair *)v5 isNewlyJoined])
    {
      goto LABEL_50;
    }

    goto LABEL_44;
  }

  if ((linkIDForPlugin & 0x80) != 0 || self->_maxLinkID <= linkIDForPlugin)
  {
    v7 = 0;
  }

  else
  {
    v7 = self->_candidatePairs[self->_linkIDForPlugin];
  }

  v8 = v7;
  v9 = [(IDSStunCandidatePair *)v8 local];
  v10 = [v9 isCellularStunCandidate];

  v11 = [(IDSStunCandidatePair *)v5 local];
  v12 = [v11 isCellularStunCandidate];

  if ((!v10 || v12) && [(IDSStunCandidatePair *)v8 state]== 4 && self->_linkIDForPlugin == [(IDSStunCandidatePair *)v8 linkID])
  {
    v13 = [(IDSStunCandidatePair *)v5 sessionID];
    v14 = [(IDSStunCandidatePair *)v8 sessionID];
    if ([v13 isEqualToString:v14])
    {

LABEL_33:
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        v27 = self->_linkIDForPlugin;
        *buf = 67109120;
        v40 = v27;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to existing %d", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v34 = self->_linkIDForPlugin;
          _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to existing %d");
          if (_IDSShouldLog())
          {
            v34 = self->_linkIDForPlugin;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to existing %d");
          }
        }
      }

      v17 = v8;

      goto LABEL_40;
    }

    [(IDSStunCandidatePair *)v5 allocateTime];
    v21 = v20;
    [(IDSStunCandidatePair *)v8 allocateTime];
    v23 = v22;

    if (v21 <= v23)
    {
      goto LABEL_33;
    }

    self->_linkIDForPlugin = [(IDSStunCandidatePair *)v5 linkID];
    v24 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
    {
      v25 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v25;
      _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d, after convergence", buf, 8u);
    }

    v17 = v5;
    if (os_log_shim_legacy_logging_enabled())
    {
      v17 = v5;
      if (_IDSShouldLogTransport())
      {
        v34 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d, after convergence");
        v17 = v5;
        if (_IDSShouldLog())
        {
          v34 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d, after convergence");
          goto LABEL_18;
        }
      }
    }
  }

  else
  {
    self->_linkIDForPlugin = [(IDSStunCandidatePair *)v5 linkID];
    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v16 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v16;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to new link %d", buf, 8u);
    }

    v17 = v5;
    if (os_log_shim_legacy_logging_enabled())
    {
      v17 = v5;
      if (_IDSShouldLogTransport())
      {
        v34 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to new link %d");
        v17 = v5;
        if (_IDSShouldLog())
        {
          v34 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to new link %d");
LABEL_18:
          v17 = v5;
        }
      }
    }
  }

LABEL_40:
  if (!v8)
  {
    goto LABEL_43;
  }

  if (!self->_linkIDForPlugin)
  {
    goto LABEL_43;
  }

  v28 = self->_linkIDForPlugin;
  if (v28 == [(IDSStunCandidatePair *)v8 linkID])
  {
    goto LABEL_43;
  }

LABEL_44:
  [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
  v29 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
  {
    v30 = [(IDSStunCandidatePair *)v8 linkID];
    v31 = [(IDSStunCandidatePair *)v5 linkID];
    *buf = 67109376;
    v40 = v30;
    v41 = 1024;
    v42 = v31;
    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v34 = [(IDSStunCandidatePair *)v8 linkID];
      v35 = [(IDSStunCandidatePair *)v5 linkID];
      _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
      if (_IDSShouldLog())
      {
        v34 = [(IDSStunCandidatePair *)v8 linkID:v34];
        v35 = [(IDSStunCandidatePair *)v5 linkID];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
      }
    }
  }

LABEL_50:
  if ([(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict count:v34])
  {
    pluginNameToPluginOptionsDict = self->_pluginNameToPluginOptionsDict;
    v36[0] = MEMORY[0x1E69E9820];
    v36[1] = 3221225472;
    v36[2] = sub_1A7B82B78;
    v36[3] = &unk_1E77E0D50;
    v37 = v5;
    v38 = v17;
    [(NSMutableDictionary *)pluginNameToPluginOptionsDict enumerateKeysAndObjectsUsingBlock:v36];
  }

  else
  {
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "No plugin requests found.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"No plugin requests found.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"No plugin requests found.");
        }
      }
    }
  }
}

- (void)_notifyCandidatePairConnected:(id)a3
{
  v12 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if (v4)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (tokenToCandidatePairs && (v6 = CFDictionaryGetValue(tokenToCandidatePairs, v4)) != 0)
    {
      v7 = v6;
      [(IDSGlobalLink *)self _setCandidatePairConnected:v6];
      if (self->_linkIDCounter == 1)
      {
        [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:v4 error:0];
      }

      if (self->_delayedConnData)
      {
        v8 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "connection data is delayed, send it now.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"connection data is delayed, send it now.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data is delayed, send it now.");
            }
          }
        }

        [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
      }
    }

    else
    {
      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v11 = v4;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
          }
        }
      }

      v7 = 0;
    }
  }
}

- (void)_notifyCandidatePairDisconnected:(id)a3 withReason:(unsigned __int8)a4
{
  v4 = a4;
  v88 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = v6;
  if (v6)
  {
    v8 = [v6 state];
    v9 = [v7 linkID];
    v74 = [v7 linkUUID];
    if ([v7 isVirtualRelayStunCandidatePair])
    {
      v10 = @"VR ";
    }

    else
    {
      v11 = [v7 isRelayStunCandidatePair];
      v10 = @"P2P";
      if (v11)
      {
        v10 = @"RLY";
      }
    }

    v12 = v10;
    if (v8 == 6)
    {
      goto LABEL_90;
    }

    [v7 setState:6];
    v73 = v12;
    if (v4 != 5 && self->_useLinkEngine)
    {
      v13 = [v7 linkEngine];
      v14 = [v7 linkUniqueName];
      [v13 linkDidDisconnect:v14];
    }

    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v16 = (&_IDSStunCandidatePairStateStrings)[v8];
      *buf = 136315650;
      *v81 = v16;
      *&v81[8] = 2080;
      *&v81[10] = off_1EB2B43D8;
      *&v81[18] = 2112;
      *&v81[20] = v7;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v69 = off_1EB2B43D8;
        v70 = v7;
        v67 = (&_IDSStunCandidatePairStateStrings)[v8];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v69 = off_1EB2B43D8;
          v70 = v7;
          v67 = (&_IDSStunCandidatePairStateStrings)[v8];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    if ([v7 isQUIC] && ((v4 != 5) & (objc_msgSend(v7, "isVirtualRelayStunCandidatePair") ^ 1)) == 1)
    {
      v17 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = [v7 candidatePairToken];
        *buf = 138412290;
        *v81 = v18;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Disconnecting QUIC connection %@", buf, 0xCu);
      }

      if (v4 == 1)
      {
        v19 = 0.0;
      }

      else
      {
        v19 = 5.0;
      }

      nwLink = self->_nwLink;
      v21 = [v7 sessionID];
      v22 = [v7 local];
      v23 = [v22 address];
      v24 = [v7 remote];
      -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", v21, v23, [v24 external], 1, v19);
    }

    else
    {
      if ([v7 isRelayStunCandidatePair] & 1) != 0 || (objc_msgSend(v7, "isVirtualRelayStunCandidatePair"))
      {
LABEL_30:
        if (self->_QUICForQREnabled && ([v7 isVirtualRelayStunCandidatePair] & 1) == 0 && !self->_disableDirectDatapath)
        {
          v28 = self->_nwLink;
          v29 = [v7 sessionID];
          v30 = [v7 local];
          v31 = [v30 address];
          v32 = [v7 remote];
          -[IDSNWLink removeChildConnectionEvaluatorForSessionID:localAddress:remoteAddress:isRelay:](v28, "removeChildConnectionEvaluatorForSessionID:localAddress:remoteAddress:isRelay:", v29, v31, [v32 external], objc_msgSend(v7, "isRelayStunCandidatePair"));
        }

        if (v9 <= 0)
        {
          v50 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v81 = v7;
            _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "skip sending link disconnected with linkID 0 for %@.", buf, 0xCu);
          }

          v12 = v73;
          if (!os_log_shim_legacy_logging_enabled())
          {
            goto LABEL_90;
          }

          v12 = v73;
          if (!_IDSShouldLogTransport())
          {
            goto LABEL_90;
          }

          _IDSLogTransport(@"GL", @"IDS", @"skip sending link disconnected with linkID 0 for %@.");
          v12 = v73;
          if (!_IDSShouldLog())
          {
            goto LABEL_90;
          }

          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip sending link disconnected with linkID 0 for %@.");
        }

        else
        {
          if ([v7 isSharedQRSession])
          {
            qraBlocks = self->_qraBlocks;
            if (qraBlocks)
            {
              qraDISBlock = qraBlocks->_qraDISBlock;
              if (qraDISBlock)
              {
                cbuuid = self->_cbuuid;
                v36 = [v7 sessionID];
                qraDISBlock[2](qraDISBlock, cbuuid, v36);
              }
            }
          }

          if (self->_p2pLinkEngine)
          {
            if ([v7 isP2P])
            {
              v37 = [v7 linkUniqueName];
              v38 = v37 == 0;

              if (!v38)
              {
                p2pLinkEngine = self->_p2pLinkEngine;
                v40 = [v7 linkUniqueName];
                [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine removeLinkWithUniqueName:v40];
              }
            }
          }

          qualityMeasurer = self->_qualityMeasurer;
          v42 = [v7 testableLink];
          [(IDSLinksQualityMeasurer *)qualityMeasurer removeLink:v42 completionHandler:&unk_1F1AAA3E0];

          WeakRetained = objc_loadWeakRetained(&self->_delegate);
          LOBYTE(qualityMeasurer) = objc_opt_respondsToSelector();

          if (qualityMeasurer)
          {
            v44 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
            {
              idsSessionID = self->_idsSessionID;
              v45 = [v7 sessionID];
              v46 = [v7 candidatePairToken];
              if (qword_1EB2B89E8 != -1)
              {
                sub_1A7E14B7C();
              }

              if ([qword_1EB2B89F0 count] > v4)
              {
                v47 = MEMORY[0x1E696AEC0];
                v48 = [qword_1EB2B89F0 objectAtIndex:v4];
                v49 = [v47 stringWithFormat:@"%@ (%d)", v48, v4];
              }

              else
              {
                if (byte_1EB2B89F8 == 1)
                {
                  if (isRunningTests())
                  {
                    throwsIDSAbortException();
                  }

                  abort();
                }

                v49 = 0;
              }

              *buf = 67110658;
              *v81 = v9;
              *&v81[4] = 2112;
              *&v81[6] = v73;
              *&v81[14] = 2112;
              *&v81[16] = idsSessionID;
              *&v81[24] = 2112;
              *&v81[26] = v45;
              v82 = 2112;
              v83 = v46;
              v84 = 2112;
              v85 = v74;
              v86 = 2112;
              v87 = v49;
              _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "Send link disconnected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@ linkUUID:%@, reason: %@", buf, 0x44u);
            }

            v51 = self->_nwLink;
            if (v51)
            {
              [(IDSNWLink *)v51 logConnectionTree];
            }

            v52 = objc_loadWeakRetained(&self->_delegate);
            [v52 link:self didDisconnectUnderlyingLinkID:v9 linkUUID:v74 reason:v4];

            connectedLinkIDs = self->_connectedLinkIDs;
            v54 = [MEMORY[0x1E696AD98] numberWithInt:v9];
            [(NSMutableArray *)connectedLinkIDs removeObject:v54];

            [(IDSGlobalLink *)self _stopProbingOnLinkID:v9];
          }

          v55 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          if (*v55 == v9)
          {
            *v55 = 0;
            v56 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109120;
              *v81 = v9;
              _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "default link is disconnected, reset default link %d.", buf, 8u);
            }
          }

          if (self->_linkIDForPlugin == v9)
          {
            v57 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
            linkIDForPlugin = self->_linkIDForPlugin;
            v75 = 0u;
            v76 = 0u;
            v77 = 0u;
            v78 = 0u;
            v58 = v57;
            v59 = [v58 countByEnumeratingWithState:&v75 objects:v79 count:16];
            if (v59)
            {
              v60 = *v76;
LABEL_70:
              v61 = 0;
              while (1)
              {
                if (*v76 != v60)
                {
                  objc_enumerationMutation(v58);
                }

                v62 = *(*(&v75 + 1) + 8 * v61);
                if ([v62 isSharedQRSession])
                {
                  if (([v62 isVirtualRelayStunCandidatePair] & 1) == 0 && objc_msgSend(v62, "state") == 4)
                  {
                    self->_linkIDForPlugin = [v62 linkID];
                    v63 = [v62 local];
                    v64 = [v63 isCellularStunCandidate];

                    if (!v64)
                    {
                      break;
                    }
                  }
                }

                if (v59 == ++v61)
                {
                  v59 = [v58 countByEnumeratingWithState:&v75 objects:v79 count:16];
                  if (v59)
                  {
                    goto LABEL_70;
                  }

                  break;
                }
              }
            }

            if (linkIDForPlugin == self->_linkIDForPlugin)
            {
              self->_linkIDForPlugin = 0;
            }

            v65 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
            {
              v66 = self->_linkIDForPlugin;
              *buf = 67109120;
              *v81 = v66;
              _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d", buf, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v68 = self->_linkIDForPlugin;
                _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d");
                if (_IDSShouldLog())
                {
                  v68 = self->_linkIDForPlugin;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d");
                }
              }
            }
          }

          [(IDSGlobalLink *)self freeLinkID:v9, v68];
        }

        v12 = v73;
LABEL_90:

        goto LABEL_91;
      }

      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109634;
        *v81 = v9;
        *&v81[4] = 2112;
        *&v81[6] = v73;
        *&v81[14] = 2112;
        *&v81[16] = v7;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "Disconnecting connection for link (%d) %@ (candidate pair: %@)", buf, 0x1Cu);
      }

      v26 = self->_nwLink;
      v21 = [v7 sessionID];
      v22 = [v7 local];
      v27 = [v22 address];
      v24 = [v7 remote];
      -[IDSNWLink disconnectP2PWithSessionID:localAddress:remoteAddress:](v26, "disconnectP2PWithSessionID:localAddress:remoteAddress:", v21, v27, [v24 external]);
    }

    goto LABEL_30;
  }

LABEL_91:
}

- (void)_notifyDefaultUnderlyingLinkChanged:(id)a3 error:(int64_t)a4
{
  *&v18[5] = *MEMORY[0x1E69E9840];
  v6 = a3;
  if (v6 && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v8 = CFDictionaryGetValue(tokenToCandidatePairs, v6)) != 0)
  {
    v9 = v8;
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v11 = objc_opt_respondsToSelector();

    if (v11)
    {
      v12 = [v9 linkID];
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109376;
        v18[0] = v12;
        LOWORD(v18[1]) = 1024;
        *(&v18[1] + 2) = a4;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "send default link changed (link:%d, error:%d).", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send default link changed (link:%d, error:%d).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send default link changed (link:%d, error:%d).");
          }
        }
      }

      v14 = a4 == 0;
      v15 = objc_loadWeakRetained(&self->_delegate);
      [v15 link:self didDefaultUnderlyingLinkChangeSucceeded:v14 currentDefaultLinkID:v12];
    }
  }

  else
  {
    v16 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v18 = v6;
      _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
        }
      }
    }

    v9 = 0;
  }
}

- (void)_finishPacketLog
{
  packetLog = self->_packetLog;
  if (packetLog)
  {
    [(IDSObjCPacketLog *)packetLog finish];
    v4 = self->_packetLog;
    self->_packetLog = 0;

    MEMORY[0x1EEE66B58](IDSObjCPacketLogManager, sel_clean);
  }
}

- (void)_notifyLinkDisconnectedWithError:(int64_t)a3 reason:(unsigned __int8)a4
{
  v72 = *MEMORY[0x1E69E9840];
  if (self->_state == 6)
  {
    return;
  }

  v4 = a4;
  v5 = a3;
  v6 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412802;
    v68 = self;
    v69 = 1024;
    *v70 = v5;
    *&v70[4] = 1024;
    *&v70[6] = v4;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "IDSGlobalLink %@ disconnected, error(%d), reason(%d).", buf, 0x18u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = a3;
      v37 = v4;
      v33 = self;
      _IDSLogTransport(@"GL", @"IDS", @"IDSGlobalLink %@ disconnected, error(%d), reason(%d).");
      if (_IDSShouldLog())
      {
        v37 = v4;
        v35 = a3;
        v33 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"IDSGlobalLink %@ disconnected, error(%d), reason(%d).");
      }
    }
  }

  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    v68 = self;
    v69 = 2080;
    *v70 = v8;
    *&v70[8] = 2080;
    v71 = off_1EB2B3E80[0];
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = _IDSLinkStateStrings[self->_state];
      v37 = off_1EB2B3E80[0];
      v33 = self;
      _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
      if (_IDSShouldLog())
      {
        v35 = _IDSLinkStateStrings[self->_state];
        v37 = off_1EB2B3E80[0];
        v33 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
      }
    }
  }

  self->_state = 6;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues:v33];
  v62 = 0u;
  v63 = 0u;
  v60 = 0u;
  obj = v61 = 0u;
  v9 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
  if (v9)
  {
    v10 = *v61;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v61 != v10)
        {
          objc_enumerationMutation(obj);
        }

        v12 = *(*(&v60 + 1) + 8 * i);
        v13 = [v12 state];
        v14 = [v12 isRelayStunCandidatePair];
        if (v13 == 5)
        {
          v15 = v14;
        }

        else
        {
          v15 = 0;
        }

        if (v15 == 1)
        {
          v16 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
          {
            v17 = [v12 candidatePairToken];
            *buf = 138412546;
            v68 = self;
            v69 = 2112;
            *v70 = v17;
            _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              [v12 candidatePairToken];
              v36 = v34 = self;
              _IDSLogTransport(@"GL", @"IDS", @"IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@");

              if (_IDSShouldLog())
              {
                [v12 candidatePairToken];
                v36 = v34 = self;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@");
              }
            }
          }

          [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v12 withReason:v4, v34, v36];
        }
      }

      v9 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
    }

    while (v9);
  }

  if (a3 == 8)
  {
    v18 = @"Unallocbind timed out.";
  }

  else
  {
    if (a3 != 24)
    {
      v39 = 0;
      goto LABEL_38;
    }

    v18 = @"Unallocbind send failure.";
  }

  v19 = MEMORY[0x1E696ABC0];
  v20 = [MEMORY[0x1E695DF20] dictionaryWithObject:v18 forKey:*MEMORY[0x1E696A578]];
  v39 = [v19 errorWithDomain:@"GlobalLink" code:a3 userInfo:v20];

LABEL_38:
  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "removing links from quality measurer...", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"removing links from quality measurer...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"removing links from quality measurer...");
      }
    }
  }

  v38 = self->_qualityMeasurer;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  [(IDSGlobalLink *)self _finishPacketLog];
  if (self->_useLinkSelection && ([MEMORY[0x1E69A60F0] sharedInstance], v23 = objc_claimAutoreleasedReturnValue(), v24 = objc_msgSend(v23, "isInternalInstall"), v23, v24))
  {
    v25 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "building LinkEngine quality report...", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"building LinkEngine quality report...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"building LinkEngine quality report...");
        }
      }
    }

    [(IDSGlobalLink *)self allLinkEngines];
    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v40 = v57 = 0u;
    v42 = [v40 countByEnumeratingWithState:&v56 objects:v65 count:16];
    if (v42)
    {
      v41 = *v57;
      do
      {
        for (j = 0; j != v42; ++j)
        {
          if (*v57 != v41)
          {
            objc_enumerationMutation(v40);
          }

          v26 = [*(*(&v56 + 1) + 8 * j) compactLinkQualityEvents];
          v54 = 0u;
          v55 = 0u;
          v52 = 0u;
          v53 = 0u;
          v27 = v26;
          v28 = [v27 countByEnumeratingWithState:&v52 objects:v64 count:16];
          if (v28)
          {
            v29 = *v53;
            do
            {
              for (k = 0; k != v28; ++k)
              {
                if (*v53 != v29)
                {
                  objc_enumerationMutation(v27);
                }

                v31 = *(*(&v52 + 1) + 8 * k);
                v32 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  v68 = v31;
                  _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "LinkEngine quality report event: %@", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                {
                  v34 = v31;
                  _IDSLogTransport(@"GL", @"IDS", @"LinkEngine quality report event: %@");
                  if (_IDSShouldLog())
                  {
                    v34 = v31;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"LinkEngine quality report event: %@");
                  }
                }

                [WeakRetained link:self didAddQREvent:{v31, v34}];
              }

              v28 = [v27 countByEnumeratingWithState:&v52 objects:v64 count:16];
            }

            while (v28);
          }
        }

        v42 = [v40 countByEnumeratingWithState:&v56 objects:v65 count:16];
      }

      while (v42);
    }

    [(IDSGlobalLink *)self _callDisconnectCompletionHandler:v39];
  }

  else if (v38)
  {
    v47[0] = MEMORY[0x1E69E9820];
    v47[1] = 3221225472;
    v47[2] = sub_1A7B84808;
    v47[3] = &unk_1E77E0DC8;
    v48 = v38;
    v49 = WeakRetained;
    v50 = self;
    v51 = v39;
    [(IDSLinksQualityMeasurer *)v48 removeAllLinksWithCompletionHandler:v47];
  }

  else
  {
    [(IDSGlobalLink *)self _callDisconnectCompletionHandler:v39];
  }
}

- (void)_reportAWDAllocateTime
{
  v21 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = _IDSLinkStateStrings[self->_state];
    *buf = 136315394;
    v18 = v4;
    v19 = 1024;
    v20 = [(IDSGlobalLink *)self _isExtIPDiscoveryDone];
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v10 = _IDSLinkStateStrings[self->_state];
      v11 = [(IDSGlobalLink *)self _isExtIPDiscoveryDone];
      _IDSLogTransport(@"GL", @"IDS", @"_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d");
      if (_IDSShouldLog())
      {
        [(IDSGlobalLink *)self _isExtIPDiscoveryDone:v10];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d");
      }
    }
  }

  if (self->_state >= 2 && [(IDSGlobalLink *)self _isExtIPDiscoveryDone])
  {
    v14 = 0u;
    v15 = 0u;
    v12 = 0u;
    v13 = 0u;
    v5 = self->_allocateTimeReportBlocks;
    v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
    if (v6)
    {
      v7 = *v13;
      do
      {
        v8 = 0;
        do
        {
          if (*v13 != v7)
          {
            objc_enumerationMutation(v5);
          }

          (*(*(*(&v12 + 1) + 8 * v8++) + 16))();
        }

        while (v6 != v8);
        v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
      }

      while (v6);
    }

    allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
    self->_allocateTimeReportBlocks = 0;
  }
}

- (void)_setFirstDefaultCandidatePair:(id)a3
{
  v5 = a3;
  v4 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v4 && (!*v4 || !v4[1]))
  {
    [(IDSGlobalLink *)self _updateDefaultCandidatePair:v5];
  }
}

- (id)_getAllocbindReportingDataBlob:(id)a3
{
  v16 = *MEMORY[0x1E69E9840];
  v3 = a3;
  bzero(v15, 0x5C0uLL);
  v8 = 0;
  if (StunUtilHasValidBinaryDataAttr(v3, 65517, v15, &v8))
  {
    v4 = [MEMORY[0x1E695DEF0] dataWithBytes:v15 length:v8];
    v5 = [v4 base64EncodedStringWithOptions:0];
    if (v5)
    {
      v6 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109634;
        v10 = v8;
        v11 = 2112;
        v12 = v4;
        v13 = 2112;
        v14 = v5;
        _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "length: %d, receive reporting data blob [%@], base64Encoded: [%@],", buf, 0x1Cu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"length: %d, receive reporting data blob [%@], base64Encoded: [%@],");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"length: %d, receive reporting data blob [%@], base64Encoded: [%@],");
          }
        }
      }
    }
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (void)_notifyLinkEngineCandidatePairDidConnect:(id)a3
{
  v4 = a3;
  v5 = v4;
  if (self->_useLinkEngine)
  {
    v6 = [v4 linkEngine];
    v7 = [v5 linkUniqueName];
    [v6 linkDidConnect:v7];
  }

  if (self->_useLinkSelection)
  {
    v8 = [v5 linkUniqueName];

    if (v8)
    {
      v9 = [v5 linkEngine];
      v10 = [v5 testableLink];
      v11 = [v5 linkUniqueName];
      [v9 setTestableLink:v10 forLinkWithUniqueID:v11];

      v12 = [v5 linkEngine];
      v13 = [v5 linkUniqueName];
      v14 = [v12 packetQualityHandlerForLinkWithUniqueName:v13];
      [v5 setQualityHandler:v14];

      v15 = [v5 qualityHandler];

      if (v15)
      {
        objc_initWeak(&location, self);
        objc_initWeak(&from, v5);
        v17 = MEMORY[0x1E69E9820];
        objc_copyWeak(&v18, &location);
        objc_copyWeak(&v19, &from);
        v16 = [v5 qualityHandler];
        [v16 setSyntheticPacketSender:&v17];

        objc_destroyWeak(&v19);
        objc_destroyWeak(&v18);
        objc_destroyWeak(&from);
        objc_destroyWeak(&location);
      }
    }
  }
}

- (BOOL)_processAllocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v138 = *MEMORY[0x1E69E9840];
  v108 = a3;
  v103 = a4;
  key = a8;
  *&v15 = 0xAAAAAAAAAAAAAAAALL;
  *(&v15 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[7] = v15;
  __str[6] = v15;
  __str[5] = v15;
  __str[4] = v15;
  __str[3] = v15;
  __str[2] = v15;
  __str[1] = v15;
  __str[0] = v15;
  v136[7] = v15;
  v136[6] = v15;
  v136[5] = v15;
  v136[4] = v15;
  v136[3] = v15;
  v136[2] = v15;
  v136[1] = v15;
  v136[0] = v15;
  v122 = 0;
  memset(__b, 170, sizeof(__b));
  v121 = 0;
  SAToIPPortString(__str, 0x80uLL, a6);
  SAToIPPortString(v136, 0x80uLL, a7);
  if (self->_allocbindEndTime == 0.0)
  {
    self->_allocbindEndTime = a9;
  }

  v104 = [v108 type];
  v16 = @"allocbind";
  if (v104 != 4064)
  {
    v16 = @"realloc";
  }

  v106 = v16;
  Value = 0;
  if (key && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, key);
  }

  v18 = Value;
  v102 = [v18 state];
  v19 = [v18 local];
  v20 = [v19 transport] == 2;

  metricsCollector = self->_metricsCollector;
  if (v20)
  {
    [(IDSGFTMetricsCollector *)metricsCollector stunAllocbindResponse];
    v22 = GLUtilConnectionDictionaryForUDPCandidatePair(v18, 1);
    v23 = @"udp";
  }

  else
  {
    [(IDSGFTMetricsCollector *)metricsCollector tcpAllocbindResponse];
    v22 = GLUtilConnectionDictionaryForTCPCandidatePair(v18, 1);
    v23 = @"tcp";
  }

  v24 = [v18 connections];
  [v24 setObject:v22 forKeyedSubscript:@"qr"];

  v25 = [v18 linkMetrics];
  [v25 receiveAllocbindResponse];

  [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v18];
  [(IDSGFTMetricsCollector *)self->_metricsCollector allocbindResponseForProtocolStack:v23];
  v119 = 0u;
  v120 = 0u;
  v118 = 0u;
  v117 = 0u;
  v26 = self->_interfaceAddressArray;
  v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v117 objects:v134 count:16];
  if (v27)
  {
    v28 = *v118;
    while (2)
    {
      for (i = 0; i != v27; ++i)
      {
        if (*v118 != v28)
        {
          objc_enumerationMutation(v26);
        }

        v30 = *(*(&v117 + 1) + 8 * i);
        if ([v30 index] == a5)
        {
          v31 = self->_metricsCollector;
          v32 = [v30 name];
          [(IDSGFTMetricsCollector *)v31 allocbindResponseFromInterface:v32];

          goto LABEL_21;
        }
      }

      v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v117 objects:v134 count:16];
      if (v27)
      {
        continue;
      }

      break;
    }
  }

LABEL_21:

  v33 = [v18 local];
  v34 = [v33 address];

  v35 = *(v34 + 1);
  if (v35 == 2)
  {
    if (IMGetDomainBoolForKey())
    {
LABEL_24:
      v36 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
      {
        if (*(v34 + 1) == 30)
        {
          v37 = "IPv6";
        }

        else
        {
          v37 = "IPv4";
        }

        *buf = 136315138;
        *&buf[4] = v37;
        _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "_processAllocbindResponse: force dropping [%s] stun allocbind response.", buf, 0xCu);
      }

      goto LABEL_89;
    }
  }

  else if (v35 == 30 && (IMGetDomainBoolForKey() & 1) != 0)
  {
    goto LABEL_24;
  }

  if (self->_state >= 5 && ([v18 pendingNoSessionStateAllocbind] & 1) == 0)
  {
    v74 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
    {
      v75 = (&_IDSStunCandidatePairStateStrings)[v102];
      v76 = [v18 pendingNoSessionStateAllocbind];
      v77 = @"NO";
      *buf = 136315650;
      *&buf[4] = v75;
      *&buf[12] = 2112;
      if (v76)
      {
        v77 = @"YES";
      }

      *&buf[14] = v77;
      *&buf[22] = 2112;
      *&buf[24] = v106;
      _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "_processAllocbindResponse: candidate pair state is [%s], pendingNoSessionStateAllocbind: %@, ignore %@ response.", buf, 0x20u);
    }

    goto LABEL_84;
  }

  if (v102 > 2)
  {
    if ([v18 pendingNoSessionStateAllocbind])
    {
      goto LABEL_41;
    }

    v74 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
    {
      v78 = (&_IDSStunCandidatePairStateStrings)[v102];
      *buf = 136315394;
      *&buf[4] = v78;
      *&buf[12] = 2112;
      *&buf[14] = v106;
      _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "candidate pair state is [%s], ignore %@ response.", buf, 0x16u);
    }

LABEL_84:

    goto LABEL_85;
  }

  allocbindStartTime = self->_allocbindStartTime;
  allocbindEndTime = self->_allocbindEndTime;
  v40 = +[IDSFoundationLog GlobalLink];
  v41 = (allocbindEndTime - allocbindStartTime) * 1000.0;
  if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
  {
    v42 = [v18 local];
    v43 = [v42 transport];
    v44 = *(v34 + 1);
    idsSessionID = self->_idsSessionID;
    v46 = [v18 sessionID];
    *buf = 138413826;
    *&buf[4] = v106;
    *&buf[12] = 2112;
    *&buf[14] = key;
    *&buf[22] = 2048;
    *&buf[24] = v41;
    LOWORD(v129) = 2048;
    *(&v129 + 2) = v43;
    WORD5(v129) = 1024;
    HIDWORD(v129) = v44;
    *v130 = 2112;
    *&v130[2] = idsSessionID;
    *&v130[10] = 2112;
    *&v130[12] = v46;
    _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "Received %@ response on %@ after %0.6lf ms over protocol: %ld family: %d IDSSessionID: %@ QRSessionID: %@", buf, 0x44u);
  }

  GLUtilReportAWDStunMessageEvent(v108, 0, v18, v41);
  v47 = [(IDSGlobalLink *)self _getAllocbindReportingDataBlob:v108];
  v48 = [v18 local];
  [v48 setAllocbindDataBlob:v47];

  v49 = GLUCreateQRStunMessageEvent(v108, 0, v18, self->_timeBase, v41);
  if (v49)
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v51 = objc_opt_respondsToSelector();

    if (v51)
    {
      v52 = objc_loadWeakRetained(&self->_delegate);
      [v52 link:self didAddQREvent:v49];
    }
  }

LABEL_41:
  *&v53 = 0xAAAAAAAAAAAAAAAALL;
  *(&v53 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v132 = v53;
  v133 = v53;
  *&v130[16] = v53;
  v131 = v53;
  v129 = v53;
  *v130 = v53;
  *buf = v53;
  *&buf[16] = v53;
  if ((StunUtilHasValidXorMappedAddress(v108, buf) & 1) == 0)
  {
    v72 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
    {
      v73 = SAToIPPortString(__str, 0x80uLL, buf);
      *v124 = 138412546;
      *v125 = v106;
      *&v125[8] = 2080;
      *v126 = v73;
      _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive %@ response with invalid xor-mapped-address [%s]", v124, 0x16u);
    }

    goto LABEL_88;
  }

  v54 = [v18 local];
  [v54 setExternal:buf];

  if ((StunUtilHasValidChannelNumber(v108, [v18 channelNumber], &v122) & 1) == 0)
  {
    v72 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
    {
      *v124 = 138412290;
      *v125 = v106;
      _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive %@ response without channel-number.", v124, 0xCu);
    }

LABEL_88:

LABEL_89:
    v79 = 0;
    goto LABEL_90;
  }

  v55 = v122;
  v56 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
  {
    v57 = [v18 channelNumber];
    *v124 = 67109634;
    *v125 = v57;
    *&v125[4] = 1024;
    *&v125[6] = v122;
    *v126 = 2112;
    *&v126[2] = key;
    _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "update channelNumber (%04x->%04x) for %@.", v124, 0x18u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v58 = [v18 channelNumber];
      v98 = v122;
      v100 = key;
      v96 = v58;
      _IDSLogTransport(@"GL", @"IDS", @"update channelNumber (%04x->%04x) for %@.");
      if (_IDSShouldLog())
      {
        v59 = [v18 channelNumber];
        v98 = v122;
        v100 = key;
        v96 = v59;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update channelNumber (%04x->%04x) for %@.");
      }
    }
  }

  v60 = bswap32(v55) >> 16;
  [v18 setChannelNumber:{v60, v96, v98, v100}];
  IDSSimpleUInt16List_AddItem(&self->_channelNumberList, v60);
  [(IDSGlobalLink *)self _setChannelToCandidatePair:v18 localAddress:a6 remoteAddress:a7 channelNumber:v60];
  if (StunUtilHasValidBinaryDataAttr(v108, 32802, __b, &v121))
  {
    v61 = objc_alloc(MEMORY[0x1E696AEC0]);
    v62 = [v61 initWithBytes:__b length:v121 encoding:4];
    v63 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
    {
      *v124 = 138412290;
      *v125 = v62;
      _os_log_impl(&dword_1A7AD9000, v63, OS_LOG_TYPE_DEFAULT, "receive software attribute [%@]", v124, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v97 = v62;
        _IDSLogTransport(@"GL", @"IDS", @"receive software attribute [%@]");
        if (_IDSShouldLog())
        {
          v97 = v62;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive software attribute [%@]");
        }
      }
    }
  }

  if (StunUtilHasValidUInt16Attr(v108, 65509, &v122))
  {
    [v18 setRelayLinkID:v122];
  }

  if (v102 > 2)
  {
    goto LABEL_127;
  }

  [v18 setState:3];
  [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v18];
  v64 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v64, OS_LOG_TYPE_DEFAULT))
  {
    v65 = (&_IDSStunCandidatePairStateStrings)[v102];
    *v124 = 136315650;
    *v125 = v65;
    *&v125[8] = 2080;
    *v126 = off_1EB2B43C0;
    *&v126[8] = 2112;
    v127 = key;
    _os_log_impl(&dword_1A7AD9000, v64, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", v124, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v99 = off_1EB2B43C0;
      v101 = key;
      v97 = (&_IDSStunCandidatePairStateStrings)[v102];
      _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
      if (_IDSShouldLog())
      {
        v99 = off_1EB2B43C0;
        v101 = key;
        v97 = (&_IDSStunCandidatePairStateStrings)[v102];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
      }
    }
  }

  if (self->_QUICForQREnabled)
  {
    [(IDSNWLink *)self->_nwLink setConnectedToQR:1];
  }

  if ([v18 relayProviderType] == 1)
  {
    [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0];
  }

  v66 = [v18 linkEngine];

  if (v66)
  {
    v67 = [v18 linkEngine];
    v68 = [v18 linkUniqueName];
    v69 = [v67 isLinkConnecting:v68];

    if ((v69 & 1) == 0)
    {
      v70 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
      {
        v71 = [v18 linkUniqueName];
        *v124 = 138412546;
        *v125 = v71;
        *&v125[8] = 2112;
        *v126 = v18;
        _os_log_impl(&dword_1A7AD9000, v70, OS_LOG_TYPE_DEFAULT, "Link Engine link no longer connecting: %@, disconnect candidate pair %@", v124, 0x16u);
      }

LABEL_132:

      v94 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
      {
        *v124 = 138412290;
        *v125 = v18;
        _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, "Disconnecting %@", v124, 0xCu);
      }

      v95 = [v18 candidatePairToken];
      [(IDSGlobalLink *)self _sendUnallocbindRequest:v95 stunMessage:0 reason:8];

      goto LABEL_85;
    }
  }

  else if ([v18 isRelayStunCandidatePair] && !(objc_msgSend(v18, "isSharedQRSession") & 1 | (v104 != 4064)))
  {
    v81 = [v18 sessionID];
    v82 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:v81 inState:4];

    v115 = 0u;
    v116 = 0u;
    v113 = 0u;
    v114 = 0u;
    v70 = v82;
    v83 = [v70 countByEnumeratingWithState:&v113 objects:v123 count:16];
    if (v83)
    {
      v84 = *v114;
      while (2)
      {
        for (j = 0; j != v83; ++j)
        {
          if (*v114 != v84)
          {
            objc_enumerationMutation(v70);
          }

          v86 = *(*(&v113 + 1) + 8 * j);
          if (v86 != v18)
          {
            v92 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v92, OS_LOG_TYPE_DEFAULT))
            {
              v93 = [v18 sessionID];
              *v124 = 138412802;
              *v125 = v86;
              *&v125[8] = 2112;
              *v126 = v93;
              *&v126[8] = 2112;
              v127 = v18;
              _os_log_impl(&dword_1A7AD9000, v92, OS_LOG_TYPE_DEFAULT, "Found another connected candidate pair %@ with the same QRSessionID %@ disconnecting %@", v124, 0x20u);
            }

            goto LABEL_132;
          }
        }

        v83 = [v70 countByEnumeratingWithState:&v113 objects:v123 count:16];
        if (v83)
        {
          continue;
        }

        break;
      }
    }
  }

  [(IDSGlobalLink *)self _setFirstDefaultCandidatePair:v18];
  if (v104 == 4064)
  {
    [(IDSGlobalLink *)self _processXORMappedAddress:v18 arrivalTime:a9];
    if ([v18 allocateType] == 2)
    {
      goto LABEL_85;
    }
  }

  else
  {
    if (([v18 hbStarted] & 1) == 0)
    {
      v87 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v87, OS_LOG_TYPE_DEFAULT))
      {
        v88 = [v18 pendingRealloc];
        v89 = @"NO";
        if (v88)
        {
          v89 = @"YES";
        }

        *v124 = 138412290;
        *v125 = v89;
        _os_log_impl(&dword_1A7AD9000, v87, OS_LOG_TYPE_DEFAULT, "receive reallocate response, send HBR (%@).", v124, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
      {
        v90 = [v18 pendingRealloc] ? @"YES" : @"NO";
        v97 = v90;
        _IDSLogTransport(@"GL", @"IDS", @"receive reallocate response, send HBR (%@).");
        if (_IDSShouldLog())
        {
          if ([v18 pendingRealloc])
          {
            v91 = @"YES";
          }

          else
          {
            v91 = @"NO";
          }

          v97 = v91;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive reallocate response, send HBR (%@).");
        }
      }

      [(IDSGlobalLink *)self _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:key, v97];
      [v18 setHbStarted:1];
    }

    if (([v18 isSharedQRSession] & 1) == 0)
    {
      goto LABEL_85;
    }
  }

  if (![(IDSGlobalLink *)self _postProcessAllocbindResponse:v108 candidatePair:v18 candidatePairToken:key])
  {
    if (self->_delaySessionConnected)
    {
      if (!self->_isInitiator)
      {
        v109[0] = MEMORY[0x1E69E9820];
        v109[1] = 3221225472;
        v109[2] = sub_1A7B867A0;
        v109[3] = &unk_1E77E0E18;
        v110 = v18;
        v111 = self;
        v112 = key;
        [v110 startSessionConnectedTimer:30 block:v109];
      }
    }

    else
    {
      [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:key];
    }

LABEL_127:
    if ([v18 pendingNoSessionStateAllocbind])
    {
      [v18 setPendingNoSessionState:0];
    }
  }

LABEL_85:
  v79 = 1;
LABEL_90:

  return v79;
}

- (BOOL)_processUnallocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v109 = *MEMORY[0x1E69E9840];
  v15 = a3;
  v88 = a4;
  v16 = a8;
  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[6] = v17;
  __str[7] = v17;
  __str[4] = v17;
  __str[5] = v17;
  __str[2] = v17;
  __str[3] = v17;
  __str[0] = v17;
  __str[1] = v17;
  v107[6] = v17;
  v107[7] = v17;
  v107[4] = v17;
  v107[5] = v17;
  v107[2] = v17;
  v107[3] = v17;
  v107[0] = v17;
  v107[1] = v17;
  memset(__b, 170, sizeof(__b));
  v93 = 0;
  SAToIPPortString(__str, 0x80uLL, a6);
  SAToIPPortString(v107, 0x80uLL, a7);
  Value = 0;
  if (v16 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v16);
  }

  v19 = Value;
  v87 = [v19 state];
  if ([v19 relayProviderType] == 1)
  {
    if (StunUtilHasValidBinaryDataAttr(v15, 65521, __b, &v93))
    {
      v20 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:__b];
      v21 = [v20 UUIDString];
      v22 = [v19 sessionID];
      v23 = [v21 isEqualToString:v22];

      if (v23)
      {

        goto LABEL_9;
      }

      v56 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
      {
        v57 = [v19 sessionID];
        *buf = 138412546;
        prots = v21;
        v96 = 2112;
        v97 = v57;
        _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with mismatched session-id %@ for %@.", buf, 0x16u);
      }
    }

    else
    {
      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        v26 = [v19 sessionID];
        *buf = 138412290;
        prots = v26;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with invalid session-id for %@.", buf, 0xCu);
      }
    }
  }

  else
  {
    v92 = 0;
    if (StunUtilHasValidChannelNumber(v15, [v19 channelNumber], &v92))
    {
LABEL_9:
      if (v87 == 6)
      {
        v24 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315138;
          prots = OBJC_PROTOCOL___IDSServerBagContentProvider.prots;
          _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with state [%s], ignore.", buf, 0xCu);
        }

        goto LABEL_91;
      }

      v28 = [v15 requestID];
      [(IDSGlobalLink *)self _startTimeForStunRequest:v28];
      v30 = v29;

      v31 = +[IDSFoundationLog GlobalLink];
      v32 = (a9 - v30) * 1000.0;
      if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
      {
        idsSessionID = self->_idsSessionID;
        v34 = [v19 sessionID];
        v35 = [v19 local];
        v36 = [v35 transport];
        v37 = [v19 local];
        v38 = *([v37 address] + 1);
        *buf = 138413570;
        prots = idsSessionID;
        v96 = 2112;
        v97 = v34;
        v98 = 2112;
        v99 = v16;
        v100 = 2048;
        v101 = v32;
        v102 = 2048;
        v103 = v36;
        v104 = 1024;
        v105 = v38;
        _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "Received unallocbind response for IDSSessionID: %@ QRSessionID: %@ on %@ after %0.6lf ms over protocol: %ld family: %d", buf, 0x3Au);
      }

      v39 = v32;
      GLUtilReportAWDStunMessageEvent(v15, 0, v19, v39);
      v40 = GLUCreateQRStunMessageEvent(v15, 0, v19, self->_timeBase, v39);
      if (v40)
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v42 = objc_opt_respondsToSelector();

        if (v42)
        {
          v43 = objc_loadWeakRetained(&self->_delegate);
          [v43 link:self didAddQREvent:v40];
        }
      }

      if (self->_state > 3)
      {
        if (self->_unallocbindRequestToReason)
        {
          v59 = [v15 requestID];
          if (v59)
          {
            unallocbindRequestToReason = self->_unallocbindRequestToReason;
            v61 = [v15 requestID];
            v62 = [CFDictionaryGetValue(unallocbindRequestToReason v61)];
          }

          else
          {
            v62 = [0 unsignedIntValue];
          }
        }

        else
        {
          v62 = [0 unsignedIntValue];
        }

        v68 = [v15 requestID];
        if (v68)
        {
          v69 = self->_unallocbindRequestToReason == 0;

          if (!v69)
          {
            v70 = self->_unallocbindRequestToReason;
            v71 = [v15 requestID];
            CFDictionaryRemoveValue(v70, v71);
          }
        }

        [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v19 withReason:v62];
        if (self->_isUPlusOneSession)
        {
          [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v19 withReason:v62];
        }

        v72 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
        v73 = v72;
        if (self->_state == 5)
        {
          [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
          if (!v73)
          {
            [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:v62];
          }
        }

        else if (!v72 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
        {
          v74 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
              }
            }
          }

          [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
        }

        goto LABEL_83;
      }

      [v19 setState:6];
      if (self->_useLinkEngine)
      {
        v44 = [v19 linkEngine];
        v45 = [v19 linkUniqueName];
        [v44 linkDidDisconnect:v45];
      }

      v46 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        v47 = (&_IDSStunCandidatePairStateStrings)[v87];
        *buf = 136315650;
        prots = v47;
        v96 = 2080;
        v97 = off_1EB2B43D8;
        v98 = 2112;
        v99 = v16;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v83 = off_1EB2B43D8;
          v85 = v16;
          v80 = (&_IDSStunCandidatePairStateStrings)[v87];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v83 = off_1EB2B43D8;
            v85 = v16;
            v80 = (&_IDSStunCandidatePairStateStrings)[v87];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0, v80, v83, v85])
      {
LABEL_83:
        if ([v19 pendingNoSessionStateAllocbind])
        {
          [v19 setState:1];
          v77 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
          {
            v78 = (&_IDSStunCandidatePairStateStrings)[v87];
            *buf = 136315650;
            prots = v78;
            v96 = 2080;
            v97 = off_1EB2B43B0;
            v98 = 2112;
            v99 = v16;
            _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.", buf, 0x20u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
              }
            }
          }
        }

        goto LABEL_90;
      }

      v86 = _Block_copy(self->_connectReadyHandler);
      v48 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v48, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        prots = self;
        _os_log_impl(&dword_1A7AD9000, v48, OS_LOG_TYPE_DEFAULT, "failed to connect GlobalLink %@ due to session connected message timed out.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v81 = self;
          _IDSLogTransport(@"GL", @"IDS", @"failed to connect GlobalLink %@ due to session connected message timed out.");
          if (_IDSShouldLog())
          {
            v81 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to connect GlobalLink %@ due to session connected message timed out.");
          }
        }
      }

      v49 = [v19 local];
      v50 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
      {
        v51 = (&_IDSStunTransportStrings)[[v49 transport]];
        *buf = 136315394;
        prots = v51;
        v96 = 1024;
        LODWORD(v97) = 22;
        _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v82 = (&_IDSStunTransportStrings)[[v49 transport]];
          v84 = 22;
          _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
          if (_IDSShouldLog())
          {
            v82 = (&_IDSStunTransportStrings)[[v49 transport]];
            v84 = 22;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
          }
        }
      }

      GLUtilReportAWDClientTimerEvent(305, 22, v19, self->_enableSKE, self->_isInitiator, 0.0);
      v52 = GLUCreateQRClientTimeEvent(305, 22, v19, self->_timeBase, 0.0);
      v53 = objc_loadWeakRetained(&self->_delegate);
      v54 = objc_opt_respondsToSelector();

      if (v54)
      {
        v55 = objc_loadWeakRetained(&self->_delegate);
        [v55 link:self didAddQREvent:v52];
      }

      if ([v19 isSelfQRSession])
      {

LABEL_90:
LABEL_91:
        v58 = 1;
        goto LABEL_92;
      }

      if (v86)
      {
        v63 = MEMORY[0x1E696ABC0];
        v64 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"SessionConnected message timed out." forKey:*MEMORY[0x1E696A578]];
        v65 = [v63 errorWithDomain:@"GlobalLink" code:9 userInfo:v64];

        v66 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B87718;
        block[3] = &unk_1E77DD0F0;
        v90 = v65;
        v91 = v86;
        v67 = v65;
        dispatch_async(v66, block);
      }

      else
      {
        v75 = objc_loadWeakRetained(&self->_delegate);
        v76 = objc_opt_respondsToSelector();

        if ((v76 & 1) == 0)
        {
LABEL_82:

          goto LABEL_83;
        }

        v67 = objc_loadWeakRetained(&self->_delegate);
        [v67 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
      }

      goto LABEL_82;
    }

    v27 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(prots) = v92;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "receive unallocbind response invalid channel-number %04x.", buf, 8u);
    }
  }

  v58 = 0;
LABEL_92:

  return v58;
}

- (BOOL)_processReallocIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  key = *&a5;
  v155 = *MEMORY[0x1E69E9840];
  v14 = a3;
  v121 = a4;
  v15 = a8;
  *&v16 = 0xAAAAAAAAAAAAAAAALL;
  *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v153 = v16;
  v154 = v16;
  v151 = v16;
  v152 = v16;
  v149 = v16;
  v150 = v16;
  *__str = v16;
  v148 = v16;
  v146 = v16;
  v145 = v16;
  v144 = v16;
  v143 = v16;
  v142 = v16;
  v141 = v16;
  v140 = v16;
  *v139 = v16;
  memset(__b, 170, sizeof(__b));
  memset(v137, 0, sizeof(v137));
  SAToIPPortString(__str, 0x80uLL, a6);
  SAToIPPortString(v139, 0x80uLL, a7);
  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *&buf[4] = v15;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive realloc indication on %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v103 = v15;
      _IDSLogTransport(@"GL", @"IDS", @"receive realloc indication on %@");
      if (_IDSShouldLog())
      {
        v103 = v15;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc indication on %@");
      }
    }
  }

  Value = 0;
  if (v15 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v15);
  }

  v19 = Value;
  v20 = [v19 local];
  v21 = [v20 transport];

  if ([v14 getAttribute:65520 attribute:__b])
  {
    v122 = [MEMORY[0x1E695DEF0] dataWithBytes:&__b[3] length:__b[2]];
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v122;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive realloc token %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v103 = v122;
        _IDSLogTransport(@"GL", @"IDS", @"receive realloc token %@");
        if (_IDSShouldLog())
        {
          v103 = v122;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc token %@");
        }
      }
    }

    if (![v14 getAttribute:22 attribute:{__b, v103}])
    {
      goto LABEL_35;
    }

    __memcpy_chk();
    v23 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = SAToIPPortString(v139, 0x80uLL, v137);
      *buf = 136315138;
      *&buf[4] = v24;
      _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive xor-relayed-address [%s].", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v104 = SAToIPPortString(v139, 0x80uLL, v137);
        _IDSLogTransport(@"GL", @"IDS", @"receive xor-relayed-address [%s].");
        if (_IDSShouldLog())
        {
          v104 = SAToIPPortString(v139, 0x80uLL, v137);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-relayed-address [%s].");
        }
      }
    }

    if ((v21 - 3) <= 1)
    {
      if (v21 == 3)
      {
        v25 = 80;
      }

      else
      {
        v25 = 443;
      }

      WORD1(v137[0]) = __rev16(v25);
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        v27 = SAToIPPortString(v139, 0x80uLL, v137);
        *buf = 134218242;
        *&buf[4] = v21;
        *&buf[12] = 2080;
        *&buf[14] = v27;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "stunTransport: %ld, xor-relayed-address [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v104 = v21;
          v108 = SAToIPPortString(v139, 0x80uLL, v137);
          _IDSLogTransport(@"GL", @"IDS", @"stunTransport: %ld, xor-relayed-address [%s].");
          if (_IDSShouldLog())
          {
            v104 = v21;
            v108 = SAToIPPortString(v139, 0x80uLL, v137);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"stunTransport: %ld, xor-relayed-address [%s].");
          }
        }
      }
    }

    if (IsValidSA(v137))
    {
LABEL_35:
      *&v28 = 0xAAAAAAAAAAAAAAAALL;
      *(&v28 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v135 = v28;
      v136 = v28;
      v133 = v28;
      v134 = v28;
      v131 = v28;
      v132 = v28;
      *buf = v28;
      *&buf[16] = v28;
      if (![v14 getAttribute:32 attribute:{__b, v104, v108}])
      {
        goto LABEL_43;
      }

      __memcpy_chk();
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *v123 = 136315138;
        *&v123[4] = SAToIPPortString(v139, 0x80uLL, buf);
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "receive xor-mapped-address [%s].", v123, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v105 = SAToIPPortString(v139, 0x80uLL, buf);
          _IDSLogTransport(@"GL", @"IDS", @"receive xor-mapped-address [%s].");
          if (_IDSShouldLog())
          {
            v105 = SAToIPPortString(v139, 0x80uLL, buf);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-mapped-address [%s].");
          }
        }
      }

      if (!IsValidSA(buf))
      {
        v44 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
        {
          *v123 = 0;
          _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_ERROR, "invalid xor-mapped-address.", v123, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          _IDSWarnV();
          _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid xor-mapped-address.");
          _IDSLogTransport(@"Warning", @"IDS", @"invalid xor-mapped-address.");
        }

        GLUtilReportAWDStunMessageEvent(v14, 4, v19, 0.0);
        v120 = GLUCreateQRStunMessageEvent(v14, 4u, v19, 0, 0.0);
        if (!v120)
        {
          goto LABEL_102;
        }

        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v46 = objc_opt_respondsToSelector();

        if ((v46 & 1) == 0)
        {
          goto LABEL_102;
        }
      }

      else
      {
LABEL_43:
        if (![v14 getAttribute:12 attribute:{__b, v105}])
        {
          goto LABEL_51;
        }

        if (bswap32(HIWORD(__b[2])) >> 16 == [v19 channelNumber])
        {
          v30 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
          {
            *v123 = 67109120;
            *&v123[4] = HIWORD(__b[2]);
            _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "receive channel-number [%04x].", v123, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v106 = HIWORD(__b[2]);
              _IDSLogTransport(@"GL", @"IDS", @"receive channel-number [%04x].");
              if (_IDSShouldLog())
              {
                v106 = HIWORD(__b[2]);
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive channel-number [%04x].");
              }
            }
          }

LABEL_51:
          v120 = [v19 sessionID];
          if (v120)
          {
            if (self->_useLinkEngine)
            {
              v31 = [v19 linkEngine];
              v116 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v120];
              if (v116 && v31)
              {
                v128 = 0u;
                v129 = 0u;
                v126 = 0u;
                v127 = 0u;
                v124 = 0u;
                v125 = 0u;
                memset(v123, 0, sizeof(v123));
                if (BYTE1(v137[0]) == 30)
                {
                  v32 = v123;
                }

                else
                {
                  v32 = v137;
                }

                if (BYTE1(v137[0]) == 30)
                {
                  v33 = v137;
                }

                else
                {
                  v33 = v123;
                }

                [v116 setServerAddress:v32];
                [v116 setServerAddressV6:v33];
                [v116 setHasReceivedReallocIndication:1];
                [v116 setSessionToken:v122];
                [(IDSGlobalLink *)self _updateLinksForSession:v116];
              }

              else
              {
                v59 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
                {
                  *v123 = 0;
                  _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "failed to process QUIC Realloc indication: no session or linkengine", v123, 2u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"failed to process QUIC Realloc indication: no session or linkengine");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process QUIC Realloc indication: no session or linkengine");
                    }
                  }
                }
              }

LABEL_164:

              GLUtilReportAWDStunMessageEvent(v14, 0, v19, 0.0);
              v31 = GLUCreateQRStunMessageEvent(v14, 0, v19, 0, 0.0);
              if (v31)
              {
                v98 = objc_loadWeakRetained(&self->_delegate);
                v99 = objc_opt_respondsToSelector();

                if (v99)
                {
                  v100 = objc_loadWeakRetained(&self->_delegate);
                  [v100 link:self didAddQREvent:v31];
                }
              }

              [(IDSGFTMetricsCollector *)self->_metricsCollector hasRealloc];
              v43 = 1;
              goto LABEL_176;
            }

            if (self->_H2FallbackEnabled)
            {
              if (v21 == 4)
              {
                v54 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
                {
                  tcpLink = self->_tcpLink;
                  *v123 = 138412290;
                  *&v123[4] = tcpLink;
                  _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: H2 enabled Use tcpLink: %@", v123, 0xCu);
                }

                [(IDSTCPLink *)self->_tcpLink connect:key localAddress:a6 portRange:LOWORD(self->_portRange) remoteAddress:v137 clientUUID:self->_clientUUID completionHandler:0];
              }
            }

            else
            {
              if (v21 == 4)
              {
                v60 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
                {
                  tcpSSLLink = self->_tcpSSLLink;
                  *v123 = 138412290;
                  *&v123[4] = tcpSSLLink;
                  _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: Use sslLink: %@", v123, 0xCu);
                }

                v56 = self->_tcpSSLLink;
              }

              else if (v21 == 3)
              {
                v56 = self->_tcpLink;
                v57 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
                {
                  v58 = self->_tcpLink;
                  *v123 = 138412290;
                  *&v123[4] = v58;
                  _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: Use tcpLink: %@", v123, 0xCu);
                }
              }

              else
              {
                v56 = 0;
              }

              [(IDSTCPLink *)v56 connect:key localAddress:a6 portRange:LOWORD(self->_portRange) remoteAddress:v137 clientUUID:self->_clientUUID completionHandler:0];
            }

            v62 = [v19 local];
            v63 = [v62 radioAccessTechnology];

            v64 = [v19 remote];
            v117 = [v64 radioAccessTechnology];

            v65 = [v19 local];
            v66 = [v65 mtu];

            v67 = [v19 remote];
            v68 = [v67 mtu];

            v113 = v21 - 3;
            if ((v21 - 3) > 1)
            {
              v31 = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:v63 mtu:v66 index:key address:a6 external:0];
              v21 = 2;
            }

            else
            {
              v31 = [IDSStunCandidate candidateWithType:3 transport:v21 radioAccessTechnology:v63 mtu:v66 index:key address:a6 external:buf];
            }

            v116 = [IDSStunCandidate candidateWithType:3 transport:v21 radioAccessTechnology:v117 mtu:v68 index:0xFFFFFFFFLL address:0 external:v137];
            v115 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v31 remoteCandidate:v116 sessionID:v120 delegate:self];
            if (a6->sa_family != 30 || BYTE1(v137[0]) != 2)
            {
LABEL_131:
              keya = [v115 candidatePairToken];
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              if (tokenToCandidatePairs && keya && (v72 = CFDictionaryGetValue(tokenToCandidatePairs, keya)) != 0)
              {
                v73 = v72;
                v74 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
                {
                  *v123 = 138412290;
                  *&v123[4] = keya;
                  _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "found existing candidate pair for %@.", v123, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v107 = keya;
                    _IDSLogTransport(@"GL", @"IDS", @"found existing candidate pair for %@.");
                    if (_IDSShouldLog())
                    {
                      v107 = keya;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"found existing candidate pair for %@.");
                    }
                  }
                }
              }

              else
              {
                v114 = [v19 channelNumber];
                IDSSimpleUInt16List_AddItem(&self->_reallocChannelList, v114);
                v75 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
                {
                  v76 = [v122 length];
                  v77 = [v19 relaySessionKey];
                  v78 = [v77 length];
                  v79 = [v19 channelNumber];
                  *v123 = 138413314;
                  *&v123[4] = v19;
                  *&v123[12] = 2048;
                  *&v123[14] = v76;
                  *&v123[22] = 2048;
                  *&v123[24] = v78;
                  LOWORD(v124) = 1024;
                  *(&v124 + 2) = __rev16(v114);
                  WORD3(v124) = 1024;
                  DWORD2(v124) = v79;
                  _os_log_impl(&dword_1A7AD9000, v75, OS_LOG_TYPE_DEFAULT, "start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).", v123, 0x2Cu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v80 = [v122 length];
                    v81 = [v19 relaySessionKey];
                    v82 = [v81 length];
                    v83 = __rev16(v114);
                    v111 = v83;
                    v112 = [v19 channelNumber];
                    v109 = v80;
                    v110 = v82;
                    v107 = v19;
                    _IDSLogTransport(@"GL", @"IDS", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");

                    if (_IDSShouldLog())
                    {
                      v84 = [v122 length];
                      v85 = [v19 relaySessionKey];
                      v86 = [v85 length];
                      v111 = v83;
                      v112 = [v19 channelNumber];
                      v109 = v84;
                      v110 = v86;
                      v107 = v19;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");
                    }
                  }
                }

                v87 = v115;
                if (v113 <= 1)
                {
                  [v87 setChannelNumber:{objc_msgSend(v19, "channelNumber")}];
                }

                [v87 setPropertiesWithReallocCandidatePair:v19 reallocToken:{v122, v107, v109, v110, v111, v112}];
                v88 = [v87 remote];
                -[IDSGlobalLink _setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:](self, "_setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:", v87, a6, [v88 external], v114);

                if (!self->_tokenToCandidatePairs)
                {
                  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                  v90 = self->_tokenToCandidatePairs;
                  self->_tokenToCandidatePairs = Mutable;
                }

                v73 = v87;
                if (v73)
                {
                  CFDictionarySetValue(self->_tokenToCandidatePairs, keya, v73);
                }

                else
                {
                  v91 = MEMORY[0x1E69E9C10];
                  v92 = MEMORY[0x1E69E9C10];
                  if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
                  {
                    sub_1A7E1498C();
                  }
                }
              }

              [v73 setIsRealloc:{1, v107}];
              [(IDSGlobalLink *)self _sendAllocbindRequest:keya stunMessage:0 isRealloc:1 inResponseToNoSessionState:0];
              if (!self->_reallocNewCandidatePairToOldCandidatePair)
              {
                v93 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
                self->_reallocNewCandidatePairToOldCandidatePair = v93;
              }

              v95 = v19;
              if (v95)
              {
                CFDictionarySetValue(self->_reallocNewCandidatePairToOldCandidatePair, keya, v95);
              }

              else
              {
                v96 = MEMORY[0x1E69E9C10];
                v97 = MEMORY[0x1E69E9C10];
                if (os_log_type_enabled(v96, OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E14BA4();
                }
              }

              goto LABEL_164;
            }

            FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, key);
            if (FirstPrefix)
            {
              v70 = [v115 local];
              [v70 setPrefix:FirstPrefix];

              [v115 synthesizeNat64WithPrefix];
              goto LABEL_131;
            }

            v101 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
            {
              *v123 = 67109120;
              *&v123[4] = key;
              _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "failed to get nat64 prefix for realloc (if:%d).", v123, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to get nat64 prefix for realloc (if:%d).");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get nat64 prefix for realloc (if:%d).");
                }
              }
            }
          }

          else
          {
            v47 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
            {
              *v123 = 138412290;
              *&v123[4] = v15;
              _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@.", v123, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@.");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@.");
                }
              }
            }

            GLUtilReportAWDStunMessageEvent(v14, 6, v19, 0.0);
            v31 = GLUCreateQRStunMessageEvent(v14, 6u, v19, 0, 0.0);
            if (v31)
            {
              v48 = objc_loadWeakRetained(&self->_delegate);
              v49 = objc_opt_respondsToSelector();

              if (v49)
              {
                v50 = objc_loadWeakRetained(&self->_delegate);
                [v50 link:self didAddQREvent:v31];
              }
            }
          }

LABEL_175:
          v43 = 0;
LABEL_176:

          goto LABEL_177;
        }

        v51 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
        {
          *v123 = 0;
          _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "channel-number mismatch in realloc indication.", v123, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"channel-number mismatch in realloc indication.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"channel-number mismatch in realloc indication.");
            }
          }
        }

        GLUtilReportAWDStunMessageEvent(v14, 5, v19, 0.0);
        v120 = GLUCreateQRStunMessageEvent(v14, 5u, v19, 0, 0.0);
        if (!v120 || (v52 = objc_loadWeakRetained(&self->_delegate), v53 = objc_opt_respondsToSelector(), v52, (v53 & 1) == 0))
        {
LABEL_102:
          v43 = 0;
LABEL_177:

          goto LABEL_178;
        }
      }

      v31 = objc_loadWeakRetained(&self->_delegate);
      [v31 link:self didAddQREvent:v120];
      goto LABEL_175;
    }

    v38 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_ERROR, "invalid realloc server address.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid realloc server address.");
      _IDSLogTransport(@"Warning", @"IDS", @"invalid realloc server address.");
    }

    GLUtilReportAWDStunMessageEvent(v14, 3, v19, 0.0);
    v39 = GLUCreateQRStunMessageEvent(v14, 3u, v19, 0, 0.0);
    if (v39)
    {
      v40 = objc_loadWeakRetained(&self->_delegate);
      v41 = objc_opt_respondsToSelector();

      if (v41)
      {
        v42 = objc_loadWeakRetained(&self->_delegate);
        [v42 link:self didAddQREvent:v39];
      }
    }
  }

  else
  {
    v34 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_ERROR, "failed to receive realloc token.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"failed to receive realloc token.");
      _IDSLogTransport(@"Warning", @"IDS", @"failed to receive realloc token.");
    }

    GLUtilReportAWDStunMessageEvent(v14, 2, v19, 0.0);
    v122 = GLUCreateQRStunMessageEvent(v14, 2u, v19, 0, 0.0);
    if (v122)
    {
      v35 = objc_loadWeakRetained(&self->_delegate);
      v36 = objc_opt_respondsToSelector();

      if (v36)
      {
        v37 = objc_loadWeakRetained(&self->_delegate);
        [v37 link:self didAddQREvent:v122];
      }
    }
  }

  v43 = 0;
LABEL_178:

  return v43;
}

- (BOOL)_processDataIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v22 = *MEMORY[0x1E69E9840];
  v13 = a3;
  v14 = a4;
  v15 = a8;
  memset(__b, 170, sizeof(__b));
  if ([v13 getAttribute:19 attribute:__b])
  {
    memset(v20, 170, 0x5D0uLL);
    if ([v13 getAttribute:65509 attribute:v20])
    {
      v16 = v20[4];
    }

    else
    {
      v16 = 0;
    }

    v17 = [(IDSGlobalLink *)self _processIncomingIndicationData:&__b[3] length:__b[2] candidatePairToken:v15 arrivalTime:v16 remoteRelayLinkID:a9];
  }

  else
  {
    v18 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v20[0] = 0;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_ERROR, "receive invalid data indication.", v20, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"receive invalid data indication.");
      _IDSLogTransport(@"Warning", @"IDS", @"receive invalid data indication.");
    }

    v17 = 0;
  }

  return v17;
}

- (BOOL)_processDiagnosticIndication:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5
{
  v28 = *MEMORY[0x1E69E9840];
  v7 = a3;
  v8 = a4;
  v9 = [MEMORY[0x1E69A60F0] sharedInstance];
  v10 = [v9 isInternalInstall];

  if (!v10)
  {
    v17 = 1;
    goto LABEL_25;
  }

  memset(__b, 170, sizeof(__b));
  v24 = 0;
  v23 = 0;
  if (!StunUtilHasValidBinaryDataAttr(v7, 65514, __b, &v24))
  {
    v18 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_ERROR, "receive invalid subtype indication.", buf, 2u);
    }

    v12 = 0;
    if ((os_log_shim_legacy_logging_enabled() & 1) == 0)
    {
      goto LABEL_24;
    }

    v19 = @"receive invalid subtype indication.";
    goto LABEL_23;
  }

  v11 = objc_alloc(MEMORY[0x1E696AEC0]);
  v12 = [v11 initWithBytes:__b length:v24 encoding:4];
  v13 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v26 = v12;
    _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "receive subtype [%@]", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v22 = v12;
      _IDSLogTransport(@"GL", @"IDS", @"receive subtype [%@]");
      if (_IDSShouldLog())
      {
        v22 = v12;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive subtype [%@]");
      }
    }
  }

  if ((StunUtilHasValidBinaryDataAttr(v7, 65515, __b, &v24) & 1) == 0)
  {
    v20 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_ERROR, "receive invalid subtype context.", buf, 2u);
    }

    if ((os_log_shim_legacy_logging_enabled() & 1) == 0)
    {
      goto LABEL_24;
    }

    v19 = @"receive invalid subtype context.";
LABEL_23:
    _IDSWarnV();
    _IDSLogV(0, @"IDSFoundation", @"Warning", v19);
    _IDSLogTransport(@"Warning", @"IDS", v19);
LABEL_24:

    v17 = 0;
    goto LABEL_25;
  }

  v14 = objc_alloc(MEMORY[0x1E696AEC0]);
  v15 = [v14 initWithBytes:__b length:v24 encoding:4];
  if (StunUtilHasValidUInt16Attr(v7, 65516, &v23))
  {
    v16 = v23;
  }

  else
  {
    v16 = 0;
  }

  v17 = [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:v8 subType:v12 subTypeContext:v15 duration:v16, v22];

LABEL_25:
  return v17;
}

- (BOOL)_triggerSymptomsWithCandidatePairToken:(id)a3 subType:(id)a4 subTypeContext:(id)a5 duration:(unsigned __int16)a6
{
  v6 = a6;
  v26[5] = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  v12 = a5;
  v13 = [MEMORY[0x1E69A60F0] sharedInstance];
  v14 = [v13 isInternalInstall];

  if (v14)
  {
    Value = 0;
    if (v10 && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v10);
    }

    v25[0] = &unk_1F1B20060;
    v25[1] = &unk_1F1B20078;
    v26[0] = @"IDSQuickRelayTwoWay";
    v26[1] = @"IDSQuickRelaySelf";
    v25[2] = &unk_1F1B20090;
    v25[3] = &unk_1F1B200A8;
    v26[2] = @"IDSQuickRelayShared";
    v26[3] = @"IDSQuickRelayKeepAlive";
    v25[4] = &unk_1F1B200C0;
    v26[4] = @"IDSQuickRelayMax";
    v16 = MEMORY[0x1E695DF20];
    v17 = Value;
    v18 = [v16 dictionaryWithObjects:v26 forKeys:v25 count:5];
    v19 = MEMORY[0x1E696AD98];
    v20 = [v17 allocateType];

    v21 = [v19 numberWithInteger:v20];
    v22 = [v18 objectForKey:v21];

    v23 = [(IDSGlobalLink *)self _triggerSymptomsWithType:v22 subType:v11 subTypeContext:v12 duration:v6];
  }

  else
  {
    v23 = 1;
  }

  return v23;
}

- (BOOL)_triggerSymptomsWithType:(id)a3 subType:(id)a4 subTypeContext:(id)a5 duration:(unsigned __int16)a6
{
  v6 = a6;
  v38[1] = *MEMORY[0x1E69E9840];
  v9 = a3;
  v10 = a4;
  v11 = a5;
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 1;
  v12 = [MEMORY[0x1E69A60F0] sharedInstance];
  v13 = [v12 isInternalInstall];

  if (v13)
  {
    v14 = objc_alloc_init(CUTWeakLinkClass());
    v15 = [v14 signatureWithDomain:@"IDSQuickRelay" type:v9 subType:v10 subtypeContext:v11 detectedProcess:@"identityservicesd" triggerThresholdValues:0];
    if (v6)
    {
      if (qword_1EB2BBCD0 != -1)
      {
        sub_1A7E14C20();
      }

      v37 = qword_1EB2BBCC0;
      v35 = qword_1EB2BBCC8;
      v16 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v6];
      v36 = v16;
      v17 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v36 forKeys:&v35 count:1];
      v38[0] = v17;
      v18 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v38 forKeys:&v37 count:1];
    }

    else
    {
      v18 = 0;
    }

    v19 = im_primary_queue();
    v25[0] = MEMORY[0x1E69E9820];
    v25[1] = 3221225472;
    v25[2] = sub_1A7B89AF4;
    v25[3] = &unk_1E77E0E60;
    v26 = v14;
    v27 = v15;
    v28 = v18;
    v29 = &v31;
    v30 = 0x402E000000000000;
    v20 = v18;
    v21 = v15;
    v22 = v14;
    dispatch_async(v19, v25);
  }

  v23 = *(v32 + 24);
  _Block_object_dispose(&v31, 8);

  return v23 & 1;
}

- (BOOL)_processGoAwayIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v64 = *MEMORY[0x1E69E9840];
  v14 = a3;
  v40 = a4;
  v15 = a8;
  memset(__b, 170, sizeof(__b));
  v41 = [v14 getAttribute:9 attribute:__b];
  if (v41)
  {
    Value = 0;
    if (v15 && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v15);
    }

    v17 = Value;
    v18 = LOWORD(__b[3]) + 100 * LOWORD(__b[2]);
    v39 = v18;
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412802;
      v58 = v15;
      v59 = 1024;
      v60 = v18;
      v61 = 2080;
      v62 = &__b[4];
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive goaway indication for %@, error_code(%u) reason(%s).", buf, 0x1Cu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v37 = v18;
        v38 = &__b[4];
        v36 = v15;
        _IDSLogTransport(@"GL", @"IDS", @"receive goaway indication for %@, error_code(%u) reason(%s).");
        if (_IDSShouldLog())
        {
          v37 = v18;
          v38 = &__b[4];
          v36 = v15;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive goaway indication for %@, error_code(%u) reason(%s).");
        }
      }
    }

    bzero(buf, 0x5C0uLL);
    v54 = 0;
    if (StunUtilHasValidBinaryDataAttr(v14, 65503, buf, &v54))
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *v55 = 67109120;
        v56 = v54;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "This goaway has QR Server data blob(%dB)", v55, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v36 = v54;
          _IDSLogTransport(@"GL", @"IDS", @"This goaway has QR Server data blob(%dB)");
          if (_IDSShouldLog())
          {
            v36 = v54;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"This goaway has QR Server data blob(%dB)");
          }
        }
      }

      if (v54 >= 1)
      {
        v21 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:?];
        v22 = MEMORY[0x1E695DF20];
        v23 = [v17 sessionID];
        v24 = [v22 dictionaryWithObject:v21 forKey:v23];
        QRServerDataBlob = self->_QRServerDataBlob;
        self->_QRServerDataBlob = v24;
      }
    }

    sessionsByID = self->_sessionsByID;
    v27 = [v17 sessionID];
    v28 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v27];

    if (self->_useLinkEngine)
    {
      if ([v28 isPendingDisconnect])
      {
LABEL_29:
        v31 = [(IDSGlobalLink *)self _getQRAllocateType];
        v32 = *&a7->sa_data[2];
        v33 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B8A79C;
        block[3] = &unk_1E77E0E88;
        v43 = v17;
        v44 = v31;
        block[4] = self;
        v45 = a9;
        v47 = v39;
        v46 = v32;
        v34 = v17;
        dispatch_async(v33, block);

        [(IDSGFTMetricsCollector *)self->_metricsCollector hasGoaway];
        goto LABEL_30;
      }

      [v28 willDisconnect];
      [(IDSGlobalLink *)self _updateLinksForSession:v28];
      v29 = v51;
      v51[0] = MEMORY[0x1E69E9820];
      v51[1] = 3221225472;
      v51[2] = sub_1A7B8A4C4;
      v51[3] = &unk_1E77E0C88;
      v52 = v28;
      v53 = self;
      [v52 startSessionGoAwayTimer:5 block:v51];
    }

    else
    {
      [v17 setIsDisconnecting:1];
      v29 = v48;
      v48[0] = MEMORY[0x1E69E9820];
      v48[1] = 3221225472;
      v48[2] = sub_1A7B8A59C;
      v48[3] = &unk_1E77E0E18;
      v48[4] = v15;
      v49 = v17;
      v50 = self;
      [v49 startSessionGoAwayTimer:5 block:v48];
    }

    goto LABEL_29;
  }

  v30 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_ERROR, "receive invalid goaway indication.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    _IDSWarnV();
    _IDSLogV(0, @"IDSFoundation", @"Warning", @"receive invalid goaway indication.");
    _IDSLogTransport(@"Warning", @"IDS", @"receive invalid goaway indication.");
  }

LABEL_30:

  return v41;
}

- (BOOL)_processStunPacket:(id *)a3 fromDeviceUniqueID:(id)a4 cbuuid:(id)a5 arrivalTime:(double)a6 headerOverhead:(unint64_t)a7
{
  v109 = *MEMORY[0x1E69E9840];
  v12 = a4;
  v13 = a5;
  v14 = [[IDSStunMessage alloc] initWithType:0];
  if ([(IDSStunMessage *)v14 read:a3->var0 inputLength:SLODWORD(a3->var2) internal:0])
  {
    v15 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v106 = v14;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "receive stun message %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      v68 = v14;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"receive stun message %@.");
    }

    v16 = [(IDSStunMessage *)v14 type];
    v17 = [(IDSStunMessage *)v14 requestID];
    if (!v17)
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "failed to get request-id for stun message.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to get request-id for stun message.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get request-id for stun message.");
          }
        }
      }

      goto LABEL_169;
    }

    [(IDSGlobalLink *)self _startTimeForStunRequest:v17];
    [(IDSStunMessage *)v14 setStartTime:?];
    tokenToStunReqID = self->_tokenToStunReqID;
    if (tokenToStunReqID)
    {
      key = CFDictionaryGetValue(tokenToStunReqID, v17);
      if (key)
      {
LABEL_49:
        if ((v16 & 0xFEFF) == 1)
        {
          if (self->_state == 4)
          {
            if (!self->_useSecureControlMessage)
            {
              v74 = 0;
              goto LABEL_107;
            }

            v26 = self->_controlMessageKey;
            v74 = 0;
LABEL_67:
            if (v26)
            {
              v73 = v26;
              if (![(IDSStunMessage *)v14 verifyMessageIntegrityWithKey:v26 inputBuffer:a3->var0 inputLength:LODWORD(a3->var2)])
              {
                v30 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109378;
                  *v106 = v16;
                  *&v106[4] = 2112;
                  *&v106[6] = key;
                  _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "stun mesasge type %04x failed message-integrity check for %@", buf, 0x12u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v69 = v16;
                    v70 = key;
                    _IDSLogTransport(@"GL", @"IDS", @"stun mesasge type %04x failed message-integrity check for %@");
                    if (_IDSShouldLog())
                    {
                      v69 = v16;
                      v70 = key;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"stun mesasge type %04x failed message-integrity check for %@");
                    }
                  }
                }

                if (v16 == 2066)
                {
                  v31 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 0;
                    _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "message integrity fails, trigger symptoms", buf, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"message integrity fails, trigger symptoms");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"message integrity fails, trigger symptoms");
                      }
                    }
                  }

                  [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:key subType:@"DiagnosticIndicationFailure" subTypeContext:@"BadIntegrity" duration:15, v69, v70];
                }

LABEL_118:
                v21 = 0;
LABEL_218:
                v36 = v73;
                goto LABEL_219;
              }

LABEL_108:
              v37 = [v74 decKey];
              v38 = [(IDSStunMessage *)v14 decryptAES128CTRStunAttributes:v37];

              if (!v38)
              {
                v40 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109120;
                  *v106 = v16;
                  _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "stun mesasge type %04x failed to decrypt - dropped", buf, 8u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"stun mesasge type %04x failed to decrypt - dropped");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"stun mesasge type %04x failed to decrypt - dropped");
                    }
                  }
                }

                goto LABEL_118;
              }

              if ([v74 isActive])
              {
                v39 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
                if (v39)
                {
                  v39[39] = a6;
                }
              }

              else
              {
                [v74 setLastIncomingPacketTime:a6];
              }

              if ([v74 linkID] >= 1)
              {
                v41 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, [v74 linkID]);
                if (v41)
                {
                  ++*(v41 + 83);
                  v41[43] += a3->var2;
                }
              }

              if (v16 <= 0xFE1u)
              {
                if (v16 <= 0x910u)
                {
                  if (v16 > 0x810u)
                  {
                    if (v16 <= 0x812u)
                    {
                      if (v16 != 2065)
                      {
                        [(IDSGlobalLink *)self _processDiagnosticIndication:v14 candidatePairToken:key arrivalTime:a6];
                      }

                      goto LABEL_215;
                    }

                    if (v16 == 2067)
                    {
                      [v74 processDataMessageErrorIndication:v14];
                      goto LABEL_215;
                    }

                    if (v16 == 2305)
                    {
                      [v74 processTestResponse:v14 arrivalTime:a6];
                      goto LABEL_215;
                    }
                  }

                  else if (v16 > 0x100u)
                  {
                    if (v16 == 257)
                    {
                      [(IDSGlobalLink *)self _processBindingResponse:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
                      goto LABEL_215;
                    }

                    if (v16 == 2064)
                    {
                      [(IDSGlobalLink *)self _processGoAwayIndication:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
                      goto LABEL_215;
                    }
                  }

                  else
                  {
                    if (v16 == 1)
                    {
                      [(IDSGlobalLink *)self _processBindingRequest:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
                      goto LABEL_215;
                    }

                    if (v16 == 23)
                    {
                      [(IDSGlobalLink *)self _processDataIndication:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
LABEL_215:
                      if ((v16 & 0x100) != 0)
                      {
                        v66 = [(IDSStunMessage *)v14 requestID];
                        [(IDSGlobalLink *)self _removeStunRequest:v66];
                      }

                      v21 = 1;
                      goto LABEL_218;
                    }
                  }

                  goto LABEL_197;
                }

                if (v16 > 0xEF6u)
                {
                  if (v16 - 4064 < 2)
                  {
                    [(IDSGlobalLink *)self _processAllocbindResponse:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
                    goto LABEL_215;
                  }

                  if (v16 == 3831)
                  {
                    [v74 processParticipantUpdateIndication:v14 arrivalTime:a6];
                    goto LABEL_215;
                  }

                  if (v16 == 3832)
                  {
                    [v74 processPluginControlIndication:v14];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (v16 > 0xEF3u)
                {
                  if (v16 == 3828)
                  {
                    [v74 processInfoIndication:v14 arrivalTime:a6];
                    goto LABEL_215;
                  }

                  if (v16 == 3829)
                  {
                    [v74 processSessionInfoIndication:v14 arrivalTime:self->_isLightweightParticipant isLightweightParticipant:a6];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (v16 != 2321)
                {
                  if (v16 == 3825)
                  {
                    v43 = *&a3->var18.__ss_pad2[64];
                    v85 = *&a3->var18.__ss_pad2[48];
                    v86 = v43;
                    v44 = *&a3->var18.__ss_pad2[96];
                    v87 = *&a3->var18.__ss_pad2[80];
                    v88 = v44;
                    v45 = *a3->var18.__ss_pad2;
                    v81 = *&a3->var18.ss_len;
                    v82 = v45;
                    v46 = *&a3->var18.__ss_pad2[32];
                    v83 = *&a3->var18.__ss_pad2[16];
                    v84 = v46;
                    v47 = *&a3->var19.ss_len;
                    v48 = *a3->var19.__ss_pad2;
                    v49 = *&a3->var19.__ss_pad2[32];
                    v91 = *&a3->var19.__ss_pad2[16];
                    v92 = v49;
                    v89 = v47;
                    v90 = v48;
                    v50 = *&a3->var19.__ss_pad2[48];
                    v51 = *&a3->var19.__ss_pad2[64];
                    v52 = *&a3->var19.__ss_pad2[96];
                    v95 = *&a3->var19.__ss_pad2[80];
                    v96 = v52;
                    v93 = v50;
                    v94 = v51;
                    var17 = a3->var17;
                    aBlock[0] = MEMORY[0x1E69E9820];
                    aBlock[1] = 3221225472;
                    aBlock[2] = sub_1A7B8C15C;
                    aBlock[3] = &unk_1E77E0EB0;
                    aBlock[4] = self;
                    v78 = v14;
                    v79 = v12;
                    v98 = var17;
                    v71 = key;
                    v80 = v71;
                    v97 = a6;
                    v54 = _Block_copy(aBlock);
                    v55 = [v74 state];
                    if (v55 > 3)
                    {
                      v54[2](v54);
                    }

                    else
                    {
                      v56 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
                      {
                        v57 = _Block_copy(v54);
                        v58 = (&_IDSStunCandidatePairStateStrings)[v55];
                        *buf = 134218498;
                        *v106 = v57;
                        *&v106[8] = 2112;
                        *&v106[10] = v71;
                        v107 = 2080;
                        v108 = v58;
                        _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "delay processing realloc block %p for %@, state [%s].", buf, 0x20u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          v59 = _Block_copy(v54);
                          _IDSLogTransport(@"GL", @"IDS", @"delay processing realloc block %p for %@, state [%s].");

                          if (_IDSShouldLog())
                          {
                            v60 = _Block_copy(v54);
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing realloc block %p for %@, state [%s].");
                          }
                        }
                      }

                      if (!self->_tokenToReallocBlocks)
                      {
                        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                        tokenToReallocBlocks = self->_tokenToReallocBlocks;
                        self->_tokenToReallocBlocks = Mutable;
                      }

                      v63 = _Block_copy(v54);
                      if (v63)
                      {
                        CFDictionarySetValue(self->_tokenToReallocBlocks, v71, v63);
                      }

                      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                      {
                        sub_1A7E14C48();
                      }
                    }

                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

LABEL_133:
                v42 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109120;
                  *v106 = v16;
                  _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "_processStunPacket, error response: messageType(%04X)", buf, 8u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v69 = v16;
                    _IDSLogTransport(@"GL", @"IDS", @"_processStunPacket, error response: messageType(%04X)");
                    if (_IDSShouldLog())
                    {
                      v69 = v16;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"_processStunPacket, error response: messageType(%04X)");
                    }
                  }
                }

                [v74 processStunErrorResponse:v14 packetBuffer:a3 headerOverhead:{a7, v69}];
                goto LABEL_215;
              }

              if (v16 <= 0xFE6u)
              {
                if (v16 > 0xFE3u)
                {
                  if (v16 == 4068)
                  {
                    [v74 processInfoResponse:v14 packetBuffer:a3 headerOverhead:a7];
                    goto LABEL_215;
                  }

                  if (v16 == 4069)
                  {
                    [v74 processSessionInfoResponse:v14 packetBuffer:a3 headerOverhead:a7 isLightweightParticipant:self->_isLightweightParticipant];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (v16 != 4066)
                {
                  if (v16 == 4067)
                  {
                    [v74 processStatsResponse:v14 arrivalTime:a6];
                    goto LABEL_215;
                  }

LABEL_197:
                  v65 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 67109120;
                    *v106 = v16;
                    _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "_processStunPacket - receive unknown STUN message type(%04X).", buf, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"_processStunPacket - receive unknown STUN message type(%04X).");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_processStunPacket - receive unknown STUN message type(%04X).");
                      }
                    }
                  }

                  goto LABEL_215;
                }
              }

              else
              {
                if (v16 - 4073 > 0xF)
                {
                  goto LABEL_193;
                }

                if (((1 << (v16 + 23)) & 0xDD80) != 0)
                {
                  goto LABEL_133;
                }

                if (v16 == 4073)
                {
                  [v74 processPutMaterialResponse:v14];
                  goto LABEL_215;
                }

                if (v16 != 4082)
                {
LABEL_193:
                  if (v16 == 4071)
                  {
                    [v74 processParticipantUpdateResponse:v14];
                    goto LABEL_215;
                  }

                  if (v16 == 4072)
                  {
                    [v74 processPluginRegistrationResponse:v14];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }
              }

              [(IDSGlobalLink *)self _processUnallocbindResponse:v14 fromDevice:v12 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:key arrivalTime:a6];
              goto LABEL_215;
            }

LABEL_107:
            v73 = 0;
            goto LABEL_108;
          }

          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            v33 = _IDSLinkStateStrings[self->_state];
            *buf = 136315394;
            *v106 = v33;
            *&v106[8] = 1024;
            *&v106[10] = v16 & 0x101;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "GL state is [%s], ignore stun message type %04x", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"GL state is [%s], ignore stun message type %04x");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"GL state is [%s], ignore stun message type %04x");
              }
            }
          }

LABEL_101:
          v36 = 0;
          v74 = 0;
          v21 = 0;
LABEL_219:

          goto LABEL_220;
        }

        tokenToCandidatePairs = self->_tokenToCandidatePairs;
        if (!tokenToCandidatePairs || !key || (v74 = CFDictionaryGetValue(tokenToCandidatePairs, key)) == 0)
        {
          tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
          if (!tokenToStunCheckPairs || !key || (v74 = CFDictionaryGetValue(tokenToStunCheckPairs, key)) == 0)
          {
            v35 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v106 = key;
              _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for incoming stun packet, candidatePairToken = %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for incoming stun packet, candidatePairToken = %@");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for incoming stun packet, candidatePairToken = %@");
                }
              }
            }

            goto LABEL_101;
          }

          v29 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "found candidate pair in stun check pair list.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"found candidate pair in stun check pair list.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"found candidate pair in stun check pair list.");
              }
            }
          }
        }

        if ((v16 & 0xFFFE) != 0xFE0)
        {
          v73 = 0;
          if (v16 > 0xFE1u)
          {
            if (v16 != 4072 && v16 != 4066)
            {
              goto LABEL_108;
            }
          }

          else if (v16 != 2066 && v16 != 3825)
          {
            goto LABEL_108;
          }
        }

        v26 = [v74 relaySessionKey];
        goto LABEL_67;
      }
    }

    if ((v16 & 0x110) != 0)
    {
      if ((v16 & 0x110) != 0x10)
      {
        v23 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          *v106 = v17;
          *&v106[8] = 1024;
          *&v106[10] = v16;
          _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "no matching request with request id %@ for stun message type %04x, ignore.", buf, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no matching request with request id %@ for stun message type %04x, ignore.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no matching request with request id %@ for stun message type %04x, ignore.");
            }
          }
        }

        v21 = 1;
        goto LABEL_220;
      }

      bzero(buf, 0x5D0uLL);
      if ([(IDSStunMessage *)v14 getAttribute:12 attribute:buf])
      {
        if (HIWORD(*&v106[4]))
        {
          keya = channelForStunCandidatePair(&a3->var18, &a3->var19, bswap32(*&v106[4]));
          Value = 0;
          if (self->_channelToCandidatePairs && keya)
          {
            Value = CFDictionaryGetValue(self->_channelToCandidatePairs, keya);
          }

          v72 = Value;
          v19 = [v72 sessionID];
          if (!v19)
          {
            v64 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v64, OS_LOG_TYPE_DEFAULT))
            {
              *v99 = 67109634;
              v100 = v16;
              v101 = 2112;
              v102 = keya;
              v103 = 2112;
              v104 = v72;
              _os_log_impl(&dword_1A7AD9000, v64, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@", v99, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@");
                }
              }
            }

            goto LABEL_169;
          }
        }

        else
        {
          v19 = self->_cbuuid;
        }

        key = tokenForStunCandidatePair(&a3->var18, &a3->var19, v19);

        if (key)
        {
          goto LABEL_49;
        }
      }

      v34 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        *v99 = 67109120;
        v100 = v16;
        _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for indication type %04x.", v99, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for indication type %04x.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for indication type %04x.");
          }
        }
      }
    }

    else
    {
      if (v16 == 1)
      {
        key = tokenForStunCandidatePair(&a3->var18, &a3->var19, self->_cbuuid);
        goto LABEL_49;
      }

      v24 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        *v106 = v16;
        _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive invalid stun request (%04x).", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"receive invalid stun request (%04x).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid stun request (%04x).");
          }
        }
      }
    }

LABEL_169:
    v21 = 0;
LABEL_220:

    goto LABEL_221;
  }

  v20 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "failed to process incoming stun message.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to process incoming stun message.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process incoming stun message.");
      }
    }
  }

  v21 = 0;
LABEL_221:

  return v21;
}

- (void)didReceiveFirstDataOnCandidatePair:(id)a3
{
  v33 = *MEMORY[0x1E69E9840];
  v5 = a3;
  [v5 setHasReceivedData:1];
  if ([v5 state] != 4)
  {
    v6 = [v5 replacesLinkWithUniqueName];
    if (v6)
    {
      v7 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:v6];
      v8 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        *v32 = v6;
        *&v32[8] = 2112;
        *&v32[10] = v7;
        _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "didReceiveFirstDataOnCandidatePair: original link: %@ %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v29 = v6;
          v30 = v7;
          _IDSLogTransport(@"GL", @"IDS", @"didReceiveFirstDataOnCandidatePair: original link: %@ %@");
          if (_IDSShouldLog())
          {
            v29 = v6;
            v30 = v7;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"didReceiveFirstDataOnCandidatePair: original link: %@ %@");
          }
        }
      }

      if (v7)
      {
        [v5 setState:4];
        [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v5];
        v9 = [v7 linkID];
        if ([v7 isSharedQRSession])
        {
          v10 = [v5 candidatePairToken];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:v10];

          if (self->_linkIDForPlugin && self->_linkIDForPlugin == v9)
          {
            self->_linkIDForPlugin = [v5 linkID];
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              v12 = [v5 linkID];
              *buf = 67109376;
              *v32 = v9;
              *&v32[4] = 1024;
              *&v32[6] = v12;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", buf, 0xEu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v29 = v9;
                v30 = [v5 linkID];
                _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
                if (_IDSShouldLog())
                {
                  v13 = [v5 linkID];
                  v29 = v9;
                  v30 = v13;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
                }
              }
            }
          }
        }

        else if (v9 < 1)
        {
          v16 = [v5 candidatePairToken];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:v16];
        }

        else
        {
          v14 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            v15 = [v7 candidatePairToken];
            *buf = 67109378;
            *v32 = v9;
            *&v32[4] = 2112;
            *&v32[6] = v15;
            _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "reuse linkID %d from original pair %@.", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              [v7 candidatePairToken];
              v30 = v29 = v9;
              _IDSLogTransport(@"GL", @"IDS", @"reuse linkID %d from original pair %@.");

              if (_IDSShouldLog())
              {
                [v7 candidatePairToken];
                v30 = v29 = v9;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"reuse linkID %d from original pair %@.");
              }
            }
          }

          [v5 setLinkID:{v9, v29, v30}];
          [v7 setLinkID:0];
          if (([v5 linkID] & 0x80000000) == 0 || self->_maxLinkID > objc_msgSend(v5, "linkID"))
          {
            objc_storeStrong(&self->_candidatePairs[[v5 linkID]], a3);
          }

          IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, v5, v9);
        }

        v17 = [v7 local];
        v18 = [v17 address];

        v19 = [v7 remote];
        v20 = [v19 external];

        v21 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
        v22 = v21;
        if (v21)
        {
          if (IsSameSA(v18, (v21 + 1)) && IsSameSA(v20, (v22 + 17)))
          {
            v23 = *(v22 + 132);
            if (v23 == [v7 channelNumber])
            {
              [(IDSGlobalLink *)self _updateDefaultCandidatePair:v5];
            }
          }
        }

        [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
        v24 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          v25 = [v5 candidatePairToken];
          *buf = 138412290;
          *v32 = v25;
          _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "realloc is done for candidatePair: %@.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v29 = [v5 candidatePairToken];
            _IDSLogTransport(@"GL", @"IDS", @"realloc is done for candidatePair: %@.");

            if (_IDSShouldLog())
            {
              v29 = [v5 candidatePairToken];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc is done for candidatePair: %@.");
            }
          }
        }
      }
    }

    else
    {
      v7 = 0;
    }

    [v5 setReplacesLinkWithUniqueName:{0, v29}];
    sessionsByID = self->_sessionsByID;
    v27 = [v5 sessionID];
    v28 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v27];

    if (v28)
    {
      [(IDSGlobalLink *)self _updateLinksForSession:v28];
    }
  }
}

- (void)_processDataOnReallocChannel:(unsigned __int16)a3 localAddress:(sockaddr *)a4 remoteAddress:(sockaddr *)a5
{
  v74 = a3;
  v124 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v82 = 0u;
  v83 = 0u;
  v80 = 0u;
  obj = v81 = 0u;
  v5 = [obj countByEnumeratingWithState:&v80 objects:v123 count:16];
  if (v5)
  {
    v67 = 0;
    v73 = 0;
    v6 = *v81;
    while (1)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v81 != v6)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v80 + 1) + 8 * i);
        if ([v8 channelNumber] == v74)
        {
          v9 = [v8 local];
          v10 = [v9 address];

          v11 = [v8 remote];
          v12 = [v11 external];

          if (!IsSameSA(v10, a4) || !IsSameSA(v12, a5) || ![v8 pendingRealloc])
          {
            if ([v8 pendingRealloc])
            {
              *&v18 = 0xAAAAAAAAAAAAAAAALL;
              *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
              v121 = v18;
              v122 = v18;
              v119 = v18;
              v120 = v18;
              v117 = v18;
              v118 = v18;
              *v116 = v18;
              *&v116[16] = v18;
              v114 = v18;
              v115 = v18;
              v112 = v18;
              v113 = v18;
              v110 = v18;
              v111 = v18;
              *v108 = v18;
              v109 = v18;
              v106 = v18;
              v107 = v18;
              v104 = v18;
              v105 = v18;
              v102 = v18;
              v103 = v18;
              *__str = v18;
              v101 = v18;
              v98 = v18;
              v99 = v18;
              v96 = v18;
              v97 = v18;
              v94 = v18;
              v95 = v18;
              *v92 = v18;
              v93 = v18;
              v19 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
              {
                v20 = SAToIPPortString(v116, 0x80uLL, v10);
                v21 = SAToIPPortString(__str, 0x80uLL, a4);
                v22 = SAToIPPortString(v108, 0x80uLL, v12);
                v23 = SAToIPPortString(v92, 0x80uLL, a5);
                *buf = 136315906;
                v85 = v20;
                v86 = 2080;
                v87 = v21;
                v88 = 2080;
                v89 = v22;
                v90 = 2080;
                v91 = v23;
                _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s", buf, 0x2Au);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v24 = SAToIPPortString(v116, 0x80uLL, v10);
                  v25 = SAToIPPortString(__str, 0x80uLL, a4);
                  v65 = SAToIPPortString(v108, 0x80uLL, v12);
                  v66 = SAToIPPortString(v92, 0x80uLL, a5);
                  v63 = v24;
                  v64 = v25;
                  _IDSLogTransport(@"GL", @"IDS", @"pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s");
                  if (_IDSShouldLog())
                  {
                    v26 = SAToIPPortString(v116, 0x80uLL, v10);
                    v27 = SAToIPPortString(__str, 0x80uLL, a4);
                    v65 = SAToIPPortString(v108, 0x80uLL, v12);
                    v66 = SAToIPPortString(v92, 0x80uLL, a5);
                    v63 = v26;
                    v64 = v27;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s");
                  }
                }
              }
            }

            goto LABEL_80;
          }

          [v8 setPendingRealloc:0];
          v13 = v8;

          if (self->_reallocNewCandidatePairToOldCandidatePair)
          {
            v14 = [v13 candidatePairToken];
            if (v14)
            {
              reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
              v16 = [v13 candidatePairToken];
              v17 = CFDictionaryGetValue(reallocNewCandidatePairToOldCandidatePair, v16);
            }

            else
            {
              v17 = 0;
            }
          }

          else
          {
            v17 = 0;
          }

          v28 = [v17 remote];
          v29 = [v28 external];

          v30 = [v13 remote];
          v31 = [v30 external];

          if (v31 && v29)
          {
            if (!IsSameSA(v29, v31))
            {
              v32 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
              {
                v33 = [v13 candidatePairToken];
                v34 = [v17 candidatePairToken];
                *v116 = 138412546;
                *&v116[4] = v33;
                *&v116[12] = 2112;
                *&v116[14] = v34;
                _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Realloc is done for: %@ remove pair: %@", v116, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v35 = [v13 candidatePairToken];
                  [v17 candidatePairToken];
                  v64 = v63 = v35;
                  _IDSLogTransport(@"GL", @"IDS", @"Realloc is done for: %@ remove pair: %@");

                  if (_IDSShouldLog())
                  {
                    v36 = [v13 candidatePairToken];
                    [v17 candidatePairToken];
                    v64 = v63 = v36;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"Realloc is done for: %@ remove pair: %@");
                  }
                }
              }

              v37 = [v13 candidatePairToken];
              if (v37)
              {
                v38 = self->_reallocNewCandidatePairToOldCandidatePair == 0;

                if (!v38)
                {
                  v39 = self->_reallocNewCandidatePairToOldCandidatePair;
                  v40 = [v13 candidatePairToken];
                  CFDictionaryRemoveValue(v39, v40);
                }
              }
            }

            v41 = [v17 local];
            v42 = [v41 address];

            v43 = [v17 remote];
            v44 = [v43 external];

            v45 = [v13 state];
            if (v45 != 4)
            {
              [v13 setState:4];
              [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v13];
              v46 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
              {
                v47 = (&_IDSStunCandidatePairStateStrings)[v45];
                *v116 = 136315650;
                *&v116[4] = v47;
                *&v116[12] = 2080;
                *&v116[14] = off_1EB2B43C8;
                *&v116[22] = 2112;
                *&v116[24] = v13;
                _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", v116, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v64 = off_1EB2B43C8;
                  v65 = v13;
                  v63 = (&_IDSStunCandidatePairStateStrings)[v45];
                  _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
                  if (_IDSShouldLog())
                  {
                    v64 = off_1EB2B43C8;
                    v65 = v13;
                    v63 = (&_IDSStunCandidatePairStateStrings)[v45];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
                  }
                }
              }

              v48 = [v17 linkID];
              if (v48 < 1 || ([v17 isSharedQRSession] & 1) != 0)
              {
                v49 = [v13 candidatePairToken];
                [(IDSGlobalLink *)self _notifyCandidatePairConnected:v49];
              }

              else
              {
                v51 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
                {
                  v52 = [v17 candidatePairToken];
                  *v116 = 67109378;
                  *&v116[4] = v48;
                  *&v116[8] = 2112;
                  *&v116[10] = v52;
                  v68 = v52;
                  _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "reuse linkID %d from original pair %@.", v116, 0x12u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    [v17 candidatePairToken];
                    v64 = v63 = v48;
                    _IDSLogTransport(@"GL", @"IDS", @"reuse linkID %d from original pair %@.");

                    if (_IDSShouldLog())
                    {
                      [v17 candidatePairToken];
                      v64 = v63 = v48;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"reuse linkID %d from original pair %@.");
                    }
                  }
                }

                [v13 setLinkID:{v48, v63}];
                [v17 setLinkID:0];
                objc_storeStrong(&self->_candidatePairs[v48], v8);
                IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, v13, v48);
              }
            }

            v53 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
            v54 = v53;
            if (v53 && IsSameSA(v42, (v53 + 1)) && IsSameSA(v44, (v54 + 17)) && *(v54 + 132) == v74)
            {
              [(IDSGlobalLink *)self _updateDefaultCandidatePair:v13];
            }

            v75[0] = MEMORY[0x1E69E9820];
            v75[1] = 3221225472;
            v75[2] = sub_1A7B8D854;
            v75[3] = &unk_1E77E0ED8;
            v55 = v17;
            v78 = v42;
            v79 = v44;
            v76 = v55;
            v77 = self;
            IDSTransportThreadAddBlockAfter(v75, 5.0);
            if (self->_linkIDForPlugin)
            {
              if ([v55 isSharedQRSession])
              {
                linkIDForPlugin = self->_linkIDForPlugin;
                if (linkIDForPlugin == [v55 linkID])
                {
                  self->_linkIDForPlugin = [v13 linkID];
                  v57 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
                  {
                    v58 = [v55 linkID];
                    v59 = [v13 linkID];
                    *v116 = 67109376;
                    *&v116[4] = v58;
                    *&v116[8] = 1024;
                    *&v116[10] = v59;
                    _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", v116, 0xEu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v63 = [v55 linkID];
                      v64 = [v13 linkID];
                      _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
                      if (_IDSShouldLog())
                      {
                        v63 = [v55 linkID];
                        v64 = [v13 linkID];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
                      }
                    }
                  }
                }
              }
            }

            [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
            v60 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
            {
              v61 = [v13 candidatePairToken];
              *v116 = 138412290;
              *&v116[4] = v61;
              _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "realloc is done for candidatePair: %@.", v116, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v63 = [v13 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"realloc is done for candidatePair: %@.");

                if (_IDSShouldLog())
                {
                  v63 = [v13 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc is done for candidatePair: %@.");
                }
              }
            }

            v67 = v13;
LABEL_80:
            v73 |= [v8 pendingRealloc];
            continue;
          }

          v50 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
          {
            *v116 = 134218240;
            *&v116[4] = v31;
            *&v116[12] = 2048;
            *&v116[14] = v29;
            _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue", v116, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v63 = v31;
              v64 = v29;
              _IDSLogTransport(@"GL", @"IDS", @"reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue");
              if (_IDSShouldLog())
              {
                v63 = v31;
                v64 = v29;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue");
              }
            }
          }

          v67 = v13;
        }
      }

      v5 = [obj countByEnumeratingWithState:&v80 objects:v123 count:16];
      if (!v5)
      {

        if (v73)
        {
          goto LABEL_93;
        }

        goto LABEL_86;
      }
    }
  }

  v67 = 0;
LABEL_86:
  if (IDSSimpleUInt16List_HasItem(&self->_reallocChannelList, v74))
  {
    IDSSimpleUInt16List_RemoveItem(&self->_reallocChannelList, v74);
    v62 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
    {
      *v116 = 67109120;
      *&v116[4] = __rev16(v74);
      _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "remove channel number %04x from reallocChannelList due to realloc time out.", v116, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"remove channel number %04x from reallocChannelList due to realloc time out.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remove channel number %04x from reallocChannelList due to realloc time out.");
        }
      }
    }
  }

LABEL_93:
}

- (void)_processReallocChannelData:(id *)a3 channelNumber:(unsigned __int16)a4 fromDeviceUniqueID:(id)a5 cbuuid:(id)a6 arrivalTime:(double)a7
{
  v8 = a4;
  v30 = *MEMORY[0x1E69E9840];
  v11 = a5;
  v12 = a6;
  *&v13 = 0xAAAAAAAAAAAAAAAALL;
  *(&v13 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v28 = v13;
  v29 = v13;
  v26 = v13;
  v27 = v13;
  v24 = v13;
  v25 = v13;
  *__str = v13;
  v23 = v13;
  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    v19 = __rev16(v8);
    v20 = 2080;
    v21 = SAToIPPortString(__str, 0x80uLL, &a3->var19);
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "process channel data on realloc channel %04x from [%s].", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v15 = __rev16(v8);
      v16 = v15;
      v17 = SAToIPPortString(__str, 0x80uLL, &a3->var19);
      _IDSLogTransport(@"GL", @"IDS", @"process channel data on realloc channel %04x from [%s].");
      if (_IDSShouldLog())
      {
        v16 = v15;
        v17 = SAToIPPortString(__str, 0x80uLL, &a3->var19);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"process channel data on realloc channel %04x from [%s].");
      }
    }
  }

  [(IDSGlobalLink *)self _processDataOnReallocChannel:v8 localAddress:&a3->var18 remoteAddress:&a3->var19, v16, v17];
}

- (void)_saveStunRequest:(id)a3 startTime:(double)a4 token:(id)a5
{
  key = a3;
  v8 = a5;
  v9 = [(NSMutableDictionary *)self->_startTimeToStunReqID allKeys];
  if (([v9 containsObject:key] & 1) == 0)
  {
    if (!self->_startTimeToStunReqID)
    {
      Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      startTimeToStunReqID = self->_startTimeToStunReqID;
      self->_startTimeToStunReqID = Mutable;
    }

    v12 = [MEMORY[0x1E696AD98] numberWithDouble:a4];
    if (v12)
    {
      CFDictionarySetValue(self->_startTimeToStunReqID, key, v12);
    }

    if (!self->_tokenToStunReqID)
    {
      v13 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      tokenToStunReqID = self->_tokenToStunReqID;
      self->_tokenToStunReqID = v13;
    }

    if (v8)
    {
      CFDictionarySetValue(self->_tokenToStunReqID, key, v8);
    }
  }
}

- (void)_removeStunRequest:(id)a3
{
  startTimeToStunReqID = self->_startTimeToStunReqID;
  v5 = a3;
  [(NSMutableDictionary *)startTimeToStunReqID removeObjectForKey:v5];
  [(NSMutableDictionary *)self->_tokenToStunReqID removeObjectForKey:v5];
}

- (BOOL)_hasStunRequest:(id)a3
{
  v4 = a3;
  v5 = [(NSMutableDictionary *)self->_startTimeToStunReqID objectForKey:v4];
  if (v5)
  {
    v6 = 1;
  }

  else
  {
    v7 = [(NSMutableDictionary *)self->_tokenToStunReqID objectForKey:v4];
    v6 = v7 != 0;
  }

  return v6;
}

- (double)_startTimeForStunRequest:(id)a3
{
  Value = 0;
  if (a3)
  {
    startTimeToStunReqID = self->_startTimeToStunReqID;
    if (startTimeToStunReqID)
    {
      Value = CFDictionaryGetValue(startTimeToStunReqID, a3);
      v3 = vars8;
    }
  }

  [Value doubleValue];
  return result;
}

- (int64_t)_sendStunMessage:(id)a3 candidatePair:(id)a4
{
  v5 = a4;
  v6 = a3;
  v7 = [v5 local];
  v23 = [v7 index];

  v8 = [v5 local];
  v9 = [v8 address];

  v10 = [v5 remote];
  v11 = [v10 external];

  v12 = [v5 local];
  v13 = [v12 transport];

  v14 = [v5 glLinkProtocol];
  v15 = [v5 linkID];
  if ([v5 isVirtualRelayStunCandidatePair])
  {
    v16 = [v5 delegatedLinkID];
  }

  else
  {
    v16 = -1;
  }

  if (v15)
  {
    v17 = v15;
  }

  else
  {
    v17 = -1;
  }

  v18 = [v5 candidatePairToken];
  v19 = [v5 local];
  HIDWORD(v22) = [v19 mtu];
  BYTE1(v22) = v16;
  LOBYTE(v22) = v17;
  v20 = [IDSGlobalLink _sendStunMessage:"_sendStunMessage:sourceIfIndex:source:destination:stunTransport:glLinkProtocol:token:linkID:delegatedLinkID:MTULimit:" sourceIfIndex:v6 source:v23 destination:v9 stunTransport:v11 glLinkProtocol:v13 token:v14 linkID:v18 delegatedLinkID:v22 MTULimit:?];

  return v20;
}

- (int64_t)_sendStunMessage:(id)a3 sourceIfIndex:(int)a4 source:(const sockaddr *)a5 destination:(sockaddr *)a6 stunTransport:(int64_t)a7 glLinkProtocol:(int64_t)a8 token:(id)a9 linkID:(char)a10 delegatedLinkID:(char)a11 MTULimit:(int)a12
{
  v61 = *MEMORY[0x1E69E9840];
  v17 = a3;
  v35 = a9;
  *&v18 = 0xAAAAAAAAAAAAAAAALL;
  *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v59 = v18;
  v60 = v18;
  v57 = v18;
  v58 = v18;
  v55 = v18;
  v56 = v18;
  *__str = v18;
  v54 = v18;
  v51 = v18;
  v52 = v18;
  v49 = v18;
  v50 = v18;
  v47 = v18;
  v48 = v18;
  *v45 = v18;
  v46 = v18;
  v19 = _IDSLinkPacketBufferCreate();
  [v17 write:*v19 outputLength:v19 + 2 remainingLength:v19[1] internal:0];
  SAToIPPortString(__str, 0x80uLL, a5);
  SAToIPPortString(v45, 0x80uLL, a6);
  v36 = [(IDSGlobalLink *)self _getLink:*(v19 + 57) stunTransport:a7 glLinkProtocol:a8];
  v20 = v19[2];
  v21 = &v20[[v36 headerOverhead]];
  if (v21 <= a12)
  {
    v32 = 0;
    v33 = 1;
  }

  else
  {
    v22 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134218496;
      v38 = [v17 type];
      v39 = 2048;
      v40 = v21;
      v41 = 1024;
      LODWORD(v42) = a12;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_sendStunMessage: 0x%lx, bytesSent: %lu, greater than MTU %d", buf, 0x1Cu);
    }

    if ([v17 type] == 3813)
    {
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5445, v19);
      v23 = -2;
      goto LABEL_28;
    }

    if ([v17 type] == 3815 || objc_msgSend(v17, "type") == 3808)
    {
      v33 = 0;
      v32 = -2;
    }

    else
    {
      v32 = 0;
      v33 = 1;
    }
  }

  v24 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "_sendStunMessage: setting up packet buffer", buf, 2u);
  }

  *(v19 + 45) = 1;
  *(v19 + 12) = a4;
  memcpy(v19 + 7, a5, a5->sa_len);
  memcpy(v19 + 23, a6, a6->sa_len);
  v23 = [(IDSGlobalLink *)self _sendPacketBuffer:v19 stunTransport:a7 glLinkProtocol:a8 token:v35 linkID:a10 delegatedLinkID:a11];
  if (v23 < 1)
  {
    v29 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      *buf = 138413058;
      v38 = v17;
      v39 = 2112;
      v40 = idsSessionID;
      v41 = 2080;
      v42 = __str;
      v43 = 2080;
      v44 = v45;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "Failed to send stun message %@ for IDSSessionID: %@ and %s-%s", buf, 0x2Au);
    }
  }

  else
  {
    if (([v17 type] & 0x110) == 0)
    {
      [v17 startTime];
      if (v25 > 0.0)
      {
        v26 = [v17 requestID];
        [v17 startTime];
        [(IDSGlobalLink *)self _saveStunRequest:v26 startTime:v35 token:?];
      }
    }

    v27 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      v28 = self->_idsSessionID;
      *buf = 138413058;
      v38 = v17;
      v39 = 2112;
      v40 = v28;
      v41 = 2080;
      v42 = __str;
      v43 = 2080;
      v44 = v45;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "send stun message %@ for IDSSessionID: %@ and %s-%s.", buf, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"send stun message %@ for IDSSessionID: %@ and %s-%s.");
    }

    if (!v33)
    {
      v23 = v32;
    }
  }

LABEL_28:

  return v23;
}

- (int64_t)_sendPacketBuffer:(id *)a3 stunTransport:(int64_t)a4 glLinkProtocol:(int64_t)a5 token:(id)a6 linkID:(char)a7 delegatedLinkID:(char)a8
{
  v8 = a8;
  v9 = a7;
  v29 = *MEMORY[0x1E69E9840];
  v14 = a6;
  v15 = [(IDSGlobalLink *)self _getLink:a3->var18.ss_family stunTransport:a4 glLinkProtocol:a5];
  v16 = v15;
  if (v8 >= 1)
  {
    a3->var16 = 1;
  }

  var2 = a3->var2;
  v18 = [v15 headerOverhead] + var2;
  _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5488, a3);
  v19 = [v16 sendPacketBuffer:a3 toDeviceUniqueID:self->_deviceUniqueID cbuuid:self->_cbuuid];
  if (v19)
  {
    v20 = v19;
    v21 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      if (v20 > 0xF)
      {
        v22 = "UnexpectedSendResult";
      }

      else
      {
        v22 = _IDSLinkSendResultStrings[v20];
      }

      *buf = 134218242;
      v26 = v18;
      v27 = 2080;
      v28 = v22;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "Failed to send packet buffer (%ldB) (error:%s).", buf, 0x16u);
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5492, a3);
    v18 = -1;
  }

  else
  {
    if (v18 >= 1)
    {
      LOBYTE(v24) = 0;
      [(IDSGlobalLink *)self _updateSendStatsWithResult:0 bytesSent:v18 packetsSent:1 linkID:v9 delegatedLinkID:v8 token:v14 isClientData:ids_monotonic_time() sendTime:v24 stunTransport:a4 packetBuffer:a3];
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5499, a3);
  }

  return v18;
}

- (id)_createIDSContextBlobMaterialProto:(id)a3
{
  v16[1] = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = objc_alloc_init(IDSQRProtoMaterialInfo);
  [(IDSQRProtoMaterialInfo *)v4 setMaterialType:7];
  v5 = [v3 copy];

  [(IDSQRProtoMaterialInfo *)v4 setMaterialContent:v5];
  v13 = 0;
  v6 = [MEMORY[0x1E695DEF0] dataWithBytes:&v13 length:4];
  [(IDSQRProtoMaterialInfo *)v4 setMaterialId:v6];
  v7 = objc_alloc_init(IDSQRProtoMaterial);
  [(IDSQRProtoMaterial *)v7 setReceiverParticipantId:0];
  v16[0] = v4;
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v16 count:1];
  v9 = [v8 mutableCopy];
  [(IDSQRProtoMaterial *)v7 setMaterialInfos:v9];

  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v15 = v7;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_createDataBlobMaterialProto: %@", buf, 0xCu);
  }

  v11 = [(IDSQRProtoMaterial *)v7 copy];

  return v11;
}

- (void)_sendAllocbindRequest:(id)a3 stunMessage:(id)a4 isRealloc:(BOOL)a5 inResponseToNoSessionState:(BOOL)a6
{
  v6 = a6;
  v7 = a5;
  v176 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  if (v10)
  {
    if (self->_state >= 5 && !v6)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = _IDSLinkStateStrings[self->_state];
        *buf = 138412546;
        *v167 = v10;
        *&v167[8] = 2080;
        *&v167[10] = v13;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, GL state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, GL state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, GL state [%s].");
          }
        }
      }

      goto LABEL_35;
    }

    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v16 = CFDictionaryGetValue(tokenToCandidatePairs, v10)) == 0)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "send allocbind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send allocbind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send allocbind request failed due to invalid candidate pair.");
          }
        }
      }

      v17 = 0;
      goto LABEL_34;
    }

    v17 = v16;
    if ([v16 isSharedQRSession] && !self->_sharedSessionHasJoined)
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "skip allocbind request, session is not yet joined!", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request, session is not yet joined!");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request, session is not yet joined!");
          }
        }
      }

      goto LABEL_34;
    }

    v18 = [v17 state];
    v19 = [v17 pendingRealloc];
    if (v18 == 2)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "in failed state, send allocbind request ignored", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"in failed state, send allocbind request ignored");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"in failed state, send allocbind request ignored");
          }
        }
      }

LABEL_34:

      goto LABEL_35;
    }

    v22 = v19;
    v23 = [v17 pendingNoSessionStateAllocbind];
    v24 = v23;
    v150 = v18;
    if (v18 < 3)
    {
      v25 = 1;
    }

    else
    {
      v25 = v7;
    }

    if ((v7 & (v22 ^ 1) & 1) != 0 || !v25 || (v6 & ~v7 & v23) != 0)
    {
      v33 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        v34 = @"allocbind";
        v35 = (&_IDSStunCandidatePairStateStrings)[v150];
        if (v7)
        {
          v34 = @"realloc";
        }

        *buf = 138413826;
        *v167 = v34;
        v36 = @"YES";
        *&v167[8] = 2112;
        *&v167[10] = v10;
        if (v22)
        {
          v37 = @"YES";
        }

        else
        {
          v37 = @"NO";
        }

        *&v167[18] = 2080;
        *&v167[20] = v35;
        if (v25)
        {
          v38 = @"NO";
        }

        else
        {
          v38 = @"YES";
        }

        v168 = 2112;
        if (v6)
        {
          v39 = @"YES";
        }

        else
        {
          v39 = @"NO";
        }

        v169 = v37;
        if ((v24 & 1) == 0)
        {
          v36 = @"NO";
        }

        v170 = 2112;
        v171 = v38;
        v172 = 2112;
        v173 = v39;
        v174 = 2112;
        v175 = v36;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@", buf, 0x48u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@");
          }
        }
      }

      goto LABEL_34;
    }

    if (!v11)
    {
      v40 = 3808;
      if (v7)
      {
        v40 = 3809;
      }

      v143 = v40;
      theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
      v41 = 0x1E696A000;
      if ((v7 & 1) == 0)
      {
        v42 = [v17 sessionID];
        v43 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        HasCandidatePairForSameSharedSession = GLUtilHasCandidatePairForSameSharedSession(v42, v43);

        if (HasCandidatePairForSameSharedSession)
        {
          v45 = 16;
        }

        else
        {
          v45 = 0;
        }

        if (v6)
        {
          v46 = v45 | 0x20;
        }

        else
        {
          v46 = v45;
        }

        v47 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v46];
        if (v47)
        {
          CFDictionarySetValue(theDict, @"gl-option-additional-binding", v47);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14CC4();
        }

        v78 = [MEMORY[0x1E696AD98] numberWithBool:self->_isShortMKIEnabled];
        if (v78)
        {
          CFDictionarySetValue(theDict, @"gs-shortmki-enabled-key", v78);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14D4C();
        }

        v79 = [v17 sessionID];
        if ([(NSDictionary *)self->_QRServerDataBlob count])
        {
          v80 = [(NSDictionary *)self->_QRServerDataBlob objectForKeyedSubscript:v79];
          v81 = v80 == 0;

          if (v81)
          {
            v82 = [(NSDictionary *)self->_QRServerDataBlob allKeys];
            v141 = [v82 firstObject];

            v83 = [(NSDictionary *)self->_QRServerDataBlob allValues];
            v149 = [v83 firstObject];

            QRServerDataBlob = self->_QRServerDataBlob;
            self->_QRServerDataBlob = 0;

            v85 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109634;
              *v167 = [v149 length];
              *&v167[4] = 2112;
              *&v167[6] = v141;
              *&v167[14] = 2112;
              *&v167[16] = v79;
              _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@", buf, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v138 = v141;
                v140 = v79;
                v136 = [v149 length];
                _IDSLogTransport(@"GL", @"IDS", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
                if (_IDSShouldLog())
                {
                  v86 = [v149 length];
                  v138 = v141;
                  v140 = v79;
                  v136 = v86;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
                }
              }
            }

            v87 = v149;
            if (v87)
            {
              CFDictionarySetValue(theDict, @"gl-option-qr-server-data-blob", v87);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              sub_1A7E14DD4();
            }
          }
        }

        v41 = 0x1E696A000uLL;
      }

      v101 = [*(v41 + 3480) numberWithBool:{self->_isLightweightParticipant, v136, v138, v140}];
      if (v101)
      {
        CFDictionarySetValue(theDict, @"gl-option-is-lightweight-participant-key", v101);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14E5C();
      }

      v102 = StunUtilCreateMessage(v143, 0, v17, theDict);
      v147 = v102;
      if (!v102)
      {
        v130 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v130, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          *v167 = v143;
          _os_log_impl(&dword_1A7AD9000, v130, OS_LOG_TYPE_DEFAULT, "failed to create stun message (%04x).", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to create stun message (%04x).");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create stun message (%04x).");
            }
          }
        }

        v11 = 0;
        goto LABEL_34;
      }

      v103 = [v102 requestID];
      [v17 addStunRequest:v103];

      v104 = [v17 encKey];
      [v147 initAES128CTR:v104];

LABEL_157:
      v105 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
      {
        if (v7)
        {
          v106 = "realloc";
        }

        else
        {
          v106 = "allocbind";
        }

        idsSessionID = self->_idsSessionID;
        v108 = [v17 sessionID];
        *buf = 136316162;
        *v167 = v106;
        *&v167[8] = 2112;
        *&v167[10] = v147;
        *&v167[18] = 2112;
        *&v167[20] = idsSessionID;
        v168 = 2112;
        v169 = v108;
        v170 = 2112;
        v171 = v10;
        _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "Send %s request %@ for IDSSessionID: %@ QRSessionID: %@ token: %@", buf, 0x34u);
      }

      v109 = [v17 local];
      v110 = [v109 transport];

      metricsCollector = self->_metricsCollector;
      theDicta = (v110 - 3);
      if (v110 == 3)
      {
        [(IDSGFTMetricsCollector *)metricsCollector tcpAllocbindRequest];
      }

      else
      {
        [(IDSGFTMetricsCollector *)metricsCollector stunAllocbindRequest];
      }

      v112 = [v17 linkMetrics];
      [v112 sendAllocbindRequest];

      [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v17];
      v113 = IMGetDomainBoolForKey();
      v114 = IMGetDomainBoolForKey();
      v115 = v114;
      v144 = (v113 & 1) == 0 && !self->_forceTCPFallbackOnWiFi;
      v142 = (v114 & 1) == 0 && !self->_forceTCPFallbackOnCell;
      v116 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
      {
        v117 = @"NO";
        if (v113)
        {
          v118 = @"YES";
        }

        else
        {
          v118 = @"NO";
        }

        forceTCPFallbackOnCell = self->_forceTCPFallbackOnCell;
        if (self->_forceTCPFallbackOnWiFi)
        {
          v120 = @"YES";
        }

        else
        {
          v120 = @"NO";
        }

        *buf = 138413058;
        *v167 = v118;
        if (v115)
        {
          v121 = @"YES";
        }

        else
        {
          v121 = @"NO";
        }

        *&v167[8] = 2112;
        *&v167[10] = v120;
        if (forceTCPFallbackOnCell)
        {
          v117 = @"YES";
        }

        *&v167[18] = 2112;
        *&v167[20] = v121;
        v168 = 2112;
        v169 = v117;
        _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "sendAllocbindRequest forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
      }

      v122 = v11 == 0;

      v123 = [v17 local];
      v124 = [v123 isCellularStunCandidate];

      aBlock[0] = MEMORY[0x1E69E9820];
      aBlock[1] = 3221225472;
      aBlock[2] = sub_1A7B90410;
      aBlock[3] = &unk_1E77E0F00;
      aBlock[4] = self;
      v11 = v147;
      v160 = v11;
      v17 = v17;
      v161 = v17;
      v162 = v122;
      v125 = _Block_copy(aBlock);
      if ((v144 | v124) & 1 | (theDicta < 0xFFFFFFFFFFFFFFFELL))
      {
        if (v142 || theDicta < 0xFFFFFFFFFFFFFFFELL || ((v124 ^ 1) & 1) != 0)
        {
          [v17 debugDelay];
          if (v131 == 0.0)
          {
            v125[2](v125);
          }

          else
          {
            v132 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT))
            {
              [v17 debugDelay];
              *buf = 134217984;
              *v167 = v133;
              _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "debugDelay is present. Delaying by %f seconds", buf, 0xCu);
            }

            [v17 debugDelay];
            if (v134 > 0.0)
            {
              v157[0] = MEMORY[0x1E69E9820];
              v157[1] = 3221225472;
              v157[2] = sub_1A7B90620;
              v157[3] = &unk_1E77E0188;
              v158 = v125;
              [v17 debugDelay];
              IDSTransportThreadAddBlockAfter(v157, v135);
            }
          }

          goto LABEL_193;
        }

        v126 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v126, OS_LOG_TYPE_DEFAULT))
        {
          v127 = (&_IDSStunTransportStrings)[v110];
          *buf = 136315138;
          *v167 = v127;
          _os_log_impl(&dword_1A7AD9000, v126, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnCell is set, skip STUN message %s", buf, 0xCu);
        }
      }

      else
      {
        v126 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v126, OS_LOG_TYPE_DEFAULT))
        {
          v128 = (&_IDSStunTransportStrings)[v110];
          *buf = 136315138;
          *v167 = v128;
          _os_log_impl(&dword_1A7AD9000, v126, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnWiFi is set, skip STUN message %s", buf, 0xCu);
        }
      }

LABEL_193:
      if (!v150)
      {
        [v17 setState:1];
        v129 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v129, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315650;
          *v167 = _IDSStunCandidatePairStateStrings;
          *&v167[8] = 2080;
          *&v167[10] = off_1EB2B43B0;
          *&v167[18] = 2112;
          *&v167[20] = v10;
          _os_log_impl(&dword_1A7AD9000, v129, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v138 = off_1EB2B43B0;
            v140 = v10;
            v136 = _IDSStunCandidatePairStateStrings;
            _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              v138 = off_1EB2B43B0;
              v140 = v10;
              v136 = _IDSStunCandidatePairStateStrings;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
            }
          }
        }

        if (([v17 isSelfQRSession] & 1) == 0)
        {
          [(IDSGlobalLink *)self _startAllocbindFailoverTimerOnCandidatePair:v17 delay:2];
        }
      }

      if (theDicta >= 0xFFFFFFFFFFFFFFFELL)
      {
        v152[0] = MEMORY[0x1E69E9820];
        v152[1] = 3221225472;
        v152[2] = sub_1A7B90630;
        v152[3] = &unk_1E77E0F28;
        v152[4] = self;
        v153 = v10;
        v154 = v11;
        v155 = v7;
        v156 = v6;
        IDSTransportThreadAddBlockAfter(v152, 1.0);
      }

      goto LABEL_34;
    }

    v26 = [v11 type];
    v27 = ids_monotonic_time();
    [v11 startTime];
    v29 = v27 - v28;
    v30 = [v17 allocateType];
    v31 = 10.0;
    if (v30 == 2)
    {
      v31 = GLUtilNATCheckTimeout();
    }

    if (v29 < v31)
    {
      v147 = v11;
      goto LABEL_157;
    }

    [v17 setState:2];
    if (self->_useLinkEngine)
    {
      linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
      v49 = [v17 linkUniqueName];
      v50 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:v49];

      if (v17 == v50)
      {
        v51 = [v17 linkEngine];
        v52 = [v17 linkUniqueName];
        [v51 linkDidFail:v52 errorCode:7 isRecoverable:0 shouldReconnect:0];
      }
    }

    v53 = [v11 requestID];
    [(IDSGlobalLink *)self _removeStunRequest:v53];

    v54 = [v11 requestID];
    [v17 removeStunRequest:v54];

    v55 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      v56 = (&_IDSStunCandidatePairStateStrings)[v150];
      *buf = 136315650;
      *v167 = v56;
      *&v167[8] = 2080;
      *&v167[10] = off_1EB2B43B8;
      *&v167[18] = 2112;
      *&v167[20] = v10;
      _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v138 = off_1EB2B43B8;
        v140 = v10;
        v136 = (&_IDSStunCandidatePairStateStrings)[v150];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v138 = off_1EB2B43B8;
          v140 = v10;
          v136 = (&_IDSStunCandidatePairStateStrings)[v150];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    v57 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0, v136, v138, v140];
    if ((v57 | [(IDSGlobalLink *)self _hasConnectingRelayCandidatePair]))
    {
LABEL_131:
      if (v30 == 2)
      {
        [v11 startTime];
        v91 = ((v27 - v90) * 1000.0);
        GLUtilReportAWDClientTimerEvent(308, 23, v17, self->_enableSKE, self->_isInitiator, v91);
        v92 = GLUCreateQRClientTimeEvent(308, 23, v17, self->_timeBase, v91);
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v94 = objc_opt_respondsToSelector();

        if (v94)
        {
          v95 = objc_loadWeakRetained(&self->_delegate);
          [v95 link:self didAddQREvent:v92];
        }

        if ([(IDSGlobalLink *)self _isExtIPDiscoveryDone])
        {
          v96 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v96, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v96, OS_LOG_TYPE_DEFAULT, "discard self allocate candidate pairs", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"discard self allocate candidate pairs");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"discard self allocate candidate pairs");
              }
            }
          }

          [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
        }

        [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
      }

      else
      {
        v97 = [v17 linkMetrics];
        [v97 allocBindRequestTimeOut];

        GLUtilReportAWDStunMessageEvent(v11, 7, v17, 0.0);
        v92 = GLUCreateQRStunMessageEvent(v11, 7u, v17, 0, 0.0);
        if (v92)
        {
          v98 = objc_loadWeakRetained(&self->_delegate);
          v99 = objc_opt_respondsToSelector();

          if (v99)
          {
            v100 = objc_loadWeakRetained(&self->_delegate);
            [v100 link:self didAddQREvent:v92];
          }
        }
      }

      [(IDSGlobalLink *)self _reportAWDAllocateTime];
      goto LABEL_34;
    }

    v151 = _Block_copy(self->_connectReadyHandler);
    v58 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v58, OS_LOG_TYPE_DEFAULT))
    {
      v59 = self->_idsSessionID;
      *buf = 138412802;
      *v167 = v59;
      *&v167[8] = 2048;
      *&v167[10] = v26;
      *&v167[18] = 2048;
      *&v167[20] = 0x4024000000000000;
      _os_log_impl(&dword_1A7AD9000, v58, OS_LOG_TYPE_DEFAULT, "Connect to QR server for IDSSessionID: %@, stun message type %ld timed out after %lf seconds.", buf, 0x20u);
    }

    v148 = [v17 local];
    v60 = [v17 sessionID];
    v61 = [(IDSGlobalLink *)self getAllocBindErrorCodeForSessionID:v60];

    v62 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
    {
      v63 = (&_IDSStunTransportStrings)[[v148 transport]];
      *buf = 136315394;
      *v167 = v63;
      *&v167[8] = 1024;
      *&v167[10] = 7;
      _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v137 = (&_IDSStunTransportStrings)[[v148 transport]];
        v139 = 7;
        _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
        if (_IDSShouldLog())
        {
          v137 = (&_IDSStunTransportStrings)[[v148 transport]];
          v139 = 7;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
        }
      }
    }

    GLUtilReportAWDClientTimerEvent(305, 7, v17, self->_enableSKE, self->_isInitiator, 0.0);
    v64 = GLUCreateQRClientTimeEvent(305, v61, v17, self->_timeBase, 0.0);
    v65 = objc_loadWeakRetained(&self->_delegate);
    v66 = objc_opt_respondsToSelector();

    if (v66)
    {
      v67 = objc_loadWeakRetained(&self->_delegate);
      [v67 link:self didAddQREvent:v64];
    }

    v68 = [IDSFoundationLog GlobalLink:v137];
    if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
    {
      v69 = [v17 participantID];
      v70 = [v17 relaySessionToken];
      v71 = [v70 base64EncodedStringWithOptions:0];
      *buf = 134218242;
      *v167 = v69;
      *&v167[8] = 2112;
      *&v167[10] = v71;
      _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "failed participant:[%16llX], token:[%@]", buf, 0x16u);
    }

    if (v151)
    {
      v72 = MEMORY[0x1E696ABC0];
      v73 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"Allocbind timed out." forKey:*MEMORY[0x1E696A578]];
      v74 = [v72 errorWithDomain:@"GlobalLink" code:7 userInfo:v73];

      v75 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7B903FC;
      block[3] = &unk_1E77DD0F0;
      v165 = v151;
      v76 = v74;
      v164 = v76;
      dispatch_async(v75, block);

      if (self->_clientType == 6)
      {
        v77 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "Stun Allocbind timed out. - gathering ABC with packet capture", buf, 2u);
        }

        [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"StunAllocbindTimedout" duration:15];
      }
    }

    else
    {
      v88 = objc_loadWeakRetained(&self->_delegate);
      v89 = objc_opt_respondsToSelector();

      if ((v89 & 1) == 0)
      {
LABEL_130:

        goto LABEL_131;
      }

      v76 = objc_loadWeakRetained(&self->_delegate);
      [v76 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_130;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "failed to send allocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send allocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send allocbind request due to invalid token.");
      }
    }
  }

LABEL_35:
}

- (void)_sendUnallocbindRequestTimeOut:(id)a3 stunMessage:(id)a4 reason:(unsigned __int8)a5
{
  v5 = a5;
  v8 = a3;
  v9 = a4;
  if (v8 && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v11 = CFDictionaryGetValue(tokenToCandidatePairs, v8)) != 0)
  {
    v12 = v11;
    if ([v11 state] != 6)
    {
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_sendUnallocbindRequestTimeOut: unallocbind request timed out.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"_sendUnallocbindRequestTimeOut: unallocbind request timed out.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendUnallocbindRequestTimeOut: unallocbind request timed out.");
          }
        }
      }

      v14 = [v9 requestID];
      [(IDSGlobalLink *)self _removeStunRequest:v14];

      v15 = [v9 requestID];
      if (v15)
      {
        unallocbindRequestToReason = self->_unallocbindRequestToReason;

        if (unallocbindRequestToReason)
        {
          v17 = self->_unallocbindRequestToReason;
          v18 = [v9 requestID];
          CFDictionaryRemoveValue(v17, v18);
        }
      }

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v12 withReason:v5];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v12 withReason:v5];
      }

      v19 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
      v20 = v19;
      if (self->_state == 5)
      {
        [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
        if (!v20)
        {
          [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:8 reason:v5];
        }
      }

      else if (!v19 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v22 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
        {
          *v27 = 0;
          _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", v27, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
            }
          }
        }

        [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
      }

      GLUtilReportAWDStunMessageEvent(v9, 8, v12, 0.0);
      v23 = GLUCreateQRStunMessageEvent(v9, 8u, v12, 0, 0.0);
      if (v23)
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v25 = objc_opt_respondsToSelector();

        if (v25)
        {
          v26 = objc_loadWeakRetained(&self->_delegate);
          [v26 link:self didAddQREvent:v23];
        }
      }
    }
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      *v29 = 0;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_sendUnallocbindRequestTimeOut: invalid candidate pair.", v29, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendUnallocbindRequestTimeOut: invalid candidate pair.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendUnallocbindRequestTimeOut: invalid candidate pair.");
        }
      }
    }

    v12 = 0;
  }
}

- (void)_sendUnallocbindRequest:(id)a3 stunMessage:(id)a4 reason:(unsigned __int8)a5
{
  v5 = a5;
  v58 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  if (self->_state >= 6)
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v53 = v11;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "skip unallocbind request, GL state (%s).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request, GL state (%s).");
        }
      }
    }

    goto LABEL_34;
  }

  if (v8)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v13 = CFDictionaryGetValue(tokenToCandidatePairs, v8)) == 0)
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        v20 = self->_tokenToCandidatePairs;
        *buf = 138412546;
        v53 = v8;
        v54 = 2112;
        v55 = v20;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          }
        }
      }

      v14 = 0;
      goto LABEL_27;
    }

    v14 = v13;
    if (([v13 isRelayStunCandidatePair] & 1) == 0)
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v53 = v8;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, not over relay.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, not over relay.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, not over relay.");
          }
        }
      }

      goto LABEL_27;
    }

    v15 = [v14 state];
    v16 = v15;
    if (v15 <= 6 && ((1 << v15) & 0x47) != 0)
    {
      v17 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = (&_IDSStunCandidatePairStateStrings)[v16];
        *buf = 138412546;
        v53 = v8;
        v54 = 2080;
        v55 = v18;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, state [%s].");
          }
        }
      }

      goto LABEL_27;
    }

    v23 = [v14 sessionID];
    if (!v23)
    {
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid relay-session-id.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid relay-session-id.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid relay-session-id.");
          }
        }
      }

      goto LABEL_88;
    }

    [v14 stopSessionConnectedTimer];
    [v14 stopSessionConvergenceTimer];
    [v14 stopSessionGoAwayTimer];
    if (v9)
    {
      v24 = ids_monotonic_time();
      [v9 startTime];
      if (v24 - v25 > 3.0)
      {
        [(IDSGlobalLink *)self _sendUnallocbindRequestTimeOut:v8 stunMessage:v9 reason:v5];
LABEL_88:

LABEL_27:
        goto LABEL_34;
      }
    }

    else
    {
      v9 = StunUtilCreateMessage(3810, 0, v14, 0);
      if (!v9)
      {
        v38 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "failed to create unallocbind message.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to create unallocbind message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create unallocbind message.");
            }
          }
        }

        v9 = 0;
        goto LABEL_88;
      }
    }

    v27 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v53 = v9;
      v54 = 2112;
      v55 = v8;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "send unallocbind request %@ for %@.", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v39 = v9;
        v41 = v8;
        _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request %@ for %@.");
        if (_IDSShouldLog())
        {
          v39 = v9;
          v41 = v8;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request %@ for %@.");
        }
      }
    }

    v28 = [(IDSGlobalLink *)self _sendStunMessage:v9 candidatePair:v14, v39, v41];
    if (v16 != 5)
    {
      [v14 setState:5];
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        v30 = (&_IDSStunCandidatePairStateStrings)[v16];
        *buf = 136315650;
        v53 = v30;
        v54 = 2080;
        v55 = off_1EB2B43D0;
        v56 = 2112;
        v57 = v8;
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v42 = off_1EB2B43D0;
          v43 = v8;
          v40 = (&_IDSStunCandidatePairStateStrings)[v16];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v42 = off_1EB2B43D0;
            v43 = v8;
            v40 = (&_IDSStunCandidatePairStateStrings)[v16];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }
    }

    if (v28 == -1 && !((self->_state != 5) | [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0]))
    {
      [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:24 reason:v5];
    }

    else
    {
      if (!self->_unallocbindRequestToReason)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        unallocbindRequestToReason = self->_unallocbindRequestToReason;
        self->_unallocbindRequestToReason = Mutable;
      }

      v33 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:{v5, v40, v42, v43}];
      if (v33)
      {
        v34 = self->_unallocbindRequestToReason;
        v35 = [v9 requestID];
        CFDictionarySetValue(v34, v35, v33);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14EE4(v9);
      }

      v36 = [v14 local];
      v37 = [v36 transport];

      if ((v37 - 1) > 1)
      {
        if ((v37 - 3) <= 1)
        {
          v44[0] = MEMORY[0x1E69E9820];
          v44[1] = 3221225472;
          v44[2] = sub_1A7B916C8;
          v44[3] = &unk_1E77E0F50;
          v44[4] = self;
          v45 = v8;
          v9 = v9;
          v46 = v9;
          v47 = v5;
          IDSTransportThreadAddBlockAfter(v44, 3.0);
        }
      }

      else if (v5 != 5 || ([v14 testOptions] & 8) == 0 || objc_msgSend(v14, "testRequestedErrorCode") != 601)
      {
        v48[0] = MEMORY[0x1E69E9820];
        v48[1] = 3221225472;
        v48[2] = sub_1A7B916B4;
        v48[3] = &unk_1E77E0F50;
        v48[4] = self;
        v49 = v8;
        v9 = v9;
        v50 = v9;
        v51 = v5;
        IDSTransportThreadAddBlockAfter(v48, 0.5);
      }
    }

    goto LABEL_88;
  }

  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid token.");
      }
    }
  }

LABEL_34:
}

- (int)_getExpensiveLinkFlagsForCandidatePair:(id)a3
{
  v4 = a3;
  v5 = [v4 local];
  v6 = -[IDSGlobalLink _isInterfaceExpensiveWithInterfaceIndex:](self, "_isInterfaceExpensiveWithInterfaceIndex:", [v5 index]);

  if (self->_islocalCellAttributeInexpensive)
  {
    v7 = [v4 local];
    v8 = [v7 isCellularStunCandidate];

    if (v8)
    {
      v6 = 0;
    }
  }

  return v6;
}

- (BOOL)_localIsQualityMetadataSupported
{
  v3 = [(IDSGlobalLink *)self _accessLinkSelectionStrategy];
  v4 = v3;
  if (!self->_useLinkEngine || (self->_useLinkSelection ? (v5 = v3 == 0) : (v5 = 1), v5))
  {
    v6 = 0;
  }

  else
  {
    v6 = [v3 wrapsPacketsWithQualityMetadata];
  }

  return v6;
}

- (int64_t)_localCapabilityFlags
{
  if (![(IDSGlobalLink *)self _localIsQualityMetadataSupported])
  {
    return 1;
  }

  v2 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT))
  {
    *v4 = 0;
    _os_log_impl(&dword_1A7AD9000, v2, OS_LOG_TYPE_DEFAULT, "_localCapabilityFlags: allow quality metadata", v4, 2u);
  }

  return 3;
}

- (id)_createCommandData:(int64_t)a3 options:(id)a4 candidatePair:(id)a5
{
  v162 = *MEMORY[0x1E69E9840];
  v150 = a4;
  v152 = a5;
  memset(__b, 170, sizeof(__b));
  v158 = 0;
  remoteGlobalLinkVersion = self->_remoteGlobalLinkVersion;
  v151 = a3;
  v9 = a3 == 1 && remoteGlobalLinkVersion > 0 || remoteGlobalLinkVersion == 0 && a3 == 32769 && !self->_isInitiator || a3 == 1 && self->_isInitiator;
  v153 = self;
  if (a3 <= 4)
  {
    switch(a3)
    {
      case 1:
        goto LABEL_54;
      case 3:
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v62 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(v152, "hbCounter")}];
        if (v62)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v62);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        v103 = [v150 objectForKey:@"gl-attr-active-probing-link-id"];
        v104 = [v103 charValue];
        v105 = [v152 isActive];
        if (v104 > 0)
        {
          v106 = 1;
        }

        else
        {
          v106 = v105;
        }

        if (v106 == 1)
        {
          *&buf[4] = 0;
          v107 = ids_monotonic_time();
          v108 = ntpTime32(v107);
          *buf = bswap32(v108);
          v109 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:12];
          if (v109)
          {
            CFDictionarySetValue(Mutable, @"gl-attr-rttreport", v109);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E1519C();
          }

          if (v104 > 0)
          {
            if (!v103 || (linkIDToRequestTimeStampAndRTT = v153->_linkIDToRequestTimeStampAndRTT) == 0 || (v125 = CFDictionaryGetValue(linkIDToRequestTimeStampAndRTT, v103)) == 0)
            {
              v125 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if ([v125 count] == 250)
            {
              [v125 removeObjectAtIndex:0];
            }

            v126 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v108];
            [v125 addObject:v126];

            if (!v153->_linkIDToRequestTimeStampAndRTT)
            {
              v127 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              v128 = v153->_linkIDToRequestTimeStampAndRTT;
              v153->_linkIDToRequestTimeStampAndRTT = v127;
            }

            if (v125)
            {
              CFDictionarySetValue(v153->_linkIDToRequestTimeStampAndRTT, v103, v125);
            }
          }
        }

        goto LABEL_241;
      case 4:
        v39 = [(IDSGlobalLink *)self _filterNonSlicedLocalCandidates:self->_localCandidateList];
        v40 = +[IDSStunConnectionDataController sharedInstance];
        v41 = [v40 dataFromCandidates:v39 token:self->_cbuuid remoteDeviceVersion:self->_remoteDeviceVersion];

        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v42 = v41;
        if (v42)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-conndata", v42);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15224();
        }

        v110 = [MEMORY[0x1E696AD98] numberWithInt:v153->_localConnDataCounter];
        if (v110)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v110);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        v111 = +[IDSStunConnectionDataController sharedInstance];
        v112 = [v111 deliveryStatus:v153->_cbuuid] == 0;

        if (v112)
        {
          v113 = +[IDSStunConnectionDataController sharedInstance];
          [v113 setDeliveryStatus:v153->_cbuuid status:1];
        }

        goto LABEL_241;
    }

LABEL_78:
    if ((a3 - 32771) > 2)
    {
      if (a3 != 33008)
      {
LABEL_243:
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        self = v153;
        goto LABEL_244;
      }

      Mutable = [v150 mutableCopy];
    }

    else
    {
      v56 = [v150 mutableCopy];
      Mutable = v56;
      if (@"gl-attr-remote-relay-link-id" && v56)
      {
        CFDictionaryRemoveValue(v56, @"gl-attr-remote-relay-link-id");
      }

      if (@"gl-attr-active-probing-link-id" && Mutable)
      {
        CFDictionaryRemoveValue(Mutable, @"gl-attr-active-probing-link-id");
        goto LABEL_244;
      }
    }

LABEL_242:
    if (!Mutable)
    {
      goto LABEL_243;
    }

LABEL_244:
    v134 = self->_controlMessageKey;
    if (v134)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-hmac", v134);
    }

    else
    {
      v135 = MEMORY[0x1E69E9C10];
      v136 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v135, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15768();
      }
    }

    v137 = [IDSGlobalLinkMessage messageWithCommand:v151 attributes:Mutable];
    [v137 write:__b outputLength:&v158];
    v117 = [MEMORY[0x1E695DEF0] dataWithBytes:__b length:v158];

    goto LABEL_250;
  }

  if (a3 <= 0x8000)
  {
    if (a3 != 5)
    {
      if (a3 == 6)
      {
        v10 = objc_alloc_init(MEMORY[0x1E695DF70]);
        v154 = 0u;
        v155 = 0u;
        v156 = 0u;
        v157 = 0u;
        v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        v12 = [v11 countByEnumeratingWithState:&v154 objects:v160 count:16];
        if (v12)
        {
          v13 = *v155;
          do
          {
            for (i = 0; i != v12; ++i)
            {
              if (*v155 != v13)
              {
                objc_enumerationMutation(v11);
              }

              v15 = *(*(&v154 + 1) + 8 * i);
              if ([(NSData *)v15 isSharedQRSession]&& [(NSData *)v15 state]== 4)
              {
                v16 = [(IDSGlobalLink *)v153 _getExpensiveLinkFlagsForCandidatePair:v15];
                v17 = [(NSData *)v15 local];
                v18 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](v153, "_isInterfaceConstrainedWithInterfaceIndex:", [v17 index]);

                if (v18)
                {
                  v19 = v16 | 2;
                }

                else
                {
                  v19 = v16;
                }

                v20 = [(NSData *)v15 local];
                v21 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](v153, "_isInterfaceDelegatedWithInterfaceIndex:", [v20 index]);

                if (v21)
                {
                  v19 |= 4u;
                }

                v22 = [(NSData *)v15 local];
                v23 = [v22 cellularSlicingFlags];

                if (v23)
                {
                  v24 = [(NSData *)v15 local];
                  v25 = [v24 cellularSlicingFlags];

                  v19 |= v25;
                }

                v26 = [(NSData *)v15 local];
                [v26 setLinkFlags:v19];

                v27 = v10 == 0;
                if (!v15)
                {
                  v27 = 1;
                }

                if (!v27)
                {
                  CFArrayAppendValue(v10, v15);
                }

                v28 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  *&buf[4] = v15;
                  _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "succeededCandidatePair: %@", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v147 = v15;
                    _IDSLogTransport(@"GL", @"IDS", @"succeededCandidatePair: %@");
                    if (_IDSShouldLog())
                    {
                      v147 = v15;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"succeededCandidatePair: %@");
                    }
                  }
                }
              }
            }

            v12 = [v11 countByEnumeratingWithState:&v154 objects:v160 count:16];
          }

          while (v12);
        }

        v29 = +[IDSStunRelayInterfaceInfoController sharedInstance];
        v30 = [v29 createRelayInterfaceInfoFromCandidatePairs:v10 token:v153->_cbuuid];

        v31 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = [(__CFArray *)v10 count];
          v33 = [v30 length];
          *buf = 134218498;
          *&buf[4] = v32;
          *&buf[12] = 2048;
          *&buf[14] = v33;
          *&buf[22] = 2112;
          *&buf[24] = v150;
          _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v34 = [(__CFArray *)v10 count];
            v148 = [v30 length];
            v149 = v150;
            v147 = v34;
            _IDSLogTransport(@"GL", @"IDS", @"candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@");
            if (_IDSShouldLog())
            {
              v35 = [(__CFArray *)v10 count:v34];
              v148 = [v30 length];
              v149 = v150;
              v147 = v35;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@");
            }
          }
        }

        Mutable = [v150 mutableCopy];
        if (!Mutable)
        {
          Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        }

        v37 = [(IDSGlobalLink *)v153 _localCapabilityFlags];
        v38 = [MEMORY[0x1E696AD98] numberWithInteger:v37];
        if (v38)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-capability", v38);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14F7C();
        }

        if (v153->_shouldReportAcceptDelay && !v153->_isInitiator)
        {
          v114 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v153->_acceptDelayU32];
          if (v114)
          {
            CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v114);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15004();
          }
        }

        v132 = v30;
        if (v132)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-relay-link-interface-info", v132);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E1508C();
        }

        v133 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v153->_localRelayInterfaceCounter];
        if (v133)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v133);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        goto LABEL_241;
      }

      goto LABEL_78;
    }

    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v57 = [MEMORY[0x1E696AD98] numberWithInt:self->_nominateCount];
    if (v57)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-counter", v57);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15114();
    }

LABEL_146:

LABEL_241:
    self = v153;
    goto LABEL_242;
  }

  if (a3 == 32774)
  {
    v58 = [v150 mutableCopy];
    Mutable = v58;
    if (@"gl-attr-remote-relay-link-id")
    {
      v59 = v58 == 0;
    }

    else
    {
      v59 = 1;
    }

    if (!v59)
    {
      CFDictionaryRemoveValue(v58, @"gl-attr-remote-relay-link-id");
    }

    if (@"gl-attr-active-probing-link-id" && Mutable)
    {
      CFDictionaryRemoveValue(Mutable, @"gl-attr-active-probing-link-id");
    }

    v60 = [(IDSGlobalLink *)self _localCapabilityFlags];
    v61 = [MEMORY[0x1E696AD98] numberWithInteger:v60];
    if (v61)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-capability", v61);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E14F7C();
    }

    if (!self->_shouldReportAcceptDelay || self->_isInitiator)
    {
      goto LABEL_242;
    }

    v57 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_acceptDelayU32];
    if (v57)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v57);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15004();
    }

    goto LABEL_146;
  }

  if (a3 != 32769)
  {
    goto LABEL_78;
  }

LABEL_54:
  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  if (!v9)
  {
LABEL_67:
    v52 = [v152 local];
    v53 = [v52 radioAccessTechnology];

    if (v153->_remoteDeviceVersion <= 2 && v53 == 9)
    {
      v54 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "RATType Wired -> NonCell due to remote version", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"RATType Wired -> NonCell due to remote version");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"RATType Wired -> NonCell due to remote version");
          }
        }
      }

      v53 = 0;
    }

    v55 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v53];
    if (v55)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-rat", v55);
    }

    else
    {
      v63 = MEMORY[0x1E69E9C10];
      v64 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v63, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15334();
      }
    }

    v65 = MEMORY[0x1E696AD98];
    v66 = [v152 local];
    v67 = [v65 numberWithInteger:{objc_msgSend(v66, "transport")}];

    if (v67)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-transport", v67);
    }

    else
    {
      v68 = MEMORY[0x1E69E9C10];
      v69 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v68, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E153BC();
      }
    }

    v70 = MEMORY[0x1E696AD98];
    v71 = [v152 local];
    v72 = [v70 numberWithUnsignedInt:{objc_msgSend(v71, "mtu")}];

    if (v72)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-mtu", v72);
    }

    else
    {
      v73 = MEMORY[0x1E69E9C10];
      v74 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15444();
      }
    }

    v75 = [(IDSGlobalLink *)v153 _localCapabilityFlags];
    v76 = [MEMORY[0x1E696AD98] numberWithInteger:v75];
    if (v76)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-capability", v76);
    }

    else
    {
      v77 = MEMORY[0x1E69E9C10];
      v78 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v77, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14F7C();
      }
    }

    v79 = [v152 local];
    v80 = +[IDSSockAddrWrapper wrapperWithSockAddr:](IDSSockAddrWrapper, "wrapperWithSockAddr:", [v79 address]);

    v81 = v80;
    if (v81)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-relayremoteaddress", v81);
    }

    else
    {
      v82 = MEMORY[0x1E69E9C10];
      v83 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v82, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E154CC();
      }
    }

    v84 = [(IDSGlobalLink *)v153 _getExpensiveLinkFlagsForCandidatePair:v152];
    v85 = [v152 local];
    v86 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](v153, "_isInterfaceConstrainedWithInterfaceIndex:", [v85 index]);

    if (v86)
    {
      v87 = v84 | 2;
    }

    else
    {
      v87 = v84;
    }

    if (v153->_remoteDeviceVersion >= 2)
    {
      v88 = [v152 local];
      v89 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](v153, "_isInterfaceDelegatedWithInterfaceIndex:", [v88 index]);

      if (v89)
      {
        v87 |= 4u;
      }
    }

    v90 = [v152 local];
    [v90 setLinkFlags:v87];

    v91 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v87];
    if (v91)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-link-flags", v91);
    }

    else
    {
      v92 = MEMORY[0x1E69E9C10];
      v93 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v92, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15554();
      }
    }

    v94 = +[IDSCellularLinkMonitor sharedInstance];
    v95 = [v94 dataSoMaskBits];

    v96 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v95];
    if (v96)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-data-so-mask", v96);
    }

    else
    {
      v97 = MEMORY[0x1E69E9C10];
      v98 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v97, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E155DC();
      }
    }

    v99 = [v152 local];
    [v99 setDataSoMask:v95];

    if ([(NSString *)v153->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
    {
      v100 = [v152 defaultRemoteDeviceCBUUID];
      v101 = @"gl-attr-remote-cbuuid";
      if (v100)
      {
        memset(buf, 170, 16);
        [v100 getUUIDBytes:buf];
        v102 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
        if (v102)
        {
          CFDictionarySetValue(Mutable, v101, v102);
        }

        else
        {
          v118 = MEMORY[0x1E69E9C10];
          v119 = MEMORY[0x1E69E9C10];
          if (os_log_type_enabled(v118, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15664();
          }
        }
      }

      else
      {
        v115 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v115, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v115, OS_LOG_TYPE_DEFAULT, "watch cbuuid is missing.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"watch cbuuid is missing.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"watch cbuuid is missing.");
            }
          }
        }
      }
    }

    if (v151 == 1)
    {
      memset(buf, 170, 16);
      v120 = [v152 linkUUID];
      [v120 getUUIDBytes:buf];

      v121 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
      if (v121)
      {
        CFDictionarySetValue(Mutable, @"gl-attr-linkuuid", v121);
      }

      else
      {
        v122 = MEMORY[0x1E69E9C10];
        v123 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v122, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E156E0();
        }
      }

      CFDictionarySetValue(Mutable, @"gl-attr-version", &unk_1F1B200D8);
    }

    goto LABEL_241;
  }

  v43 = [(NSData *)self->_skeData length];
  v44 = v43;
  if (!v43 || self->_skeToRemoteComplete)
  {
    if (!self->_isInitiator)
    {
      v45 = [v152 skeData];
      if (v45)
      {
        v46 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
        {
          v47 = [(NSData *)v45 length];
          v48 = [v152 candidatePairToken];
          *buf = 134218498;
          *&buf[4] = v45;
          *&buf[12] = 1024;
          *&buf[14] = v47;
          *&buf[18] = 2112;
          *&buf[20] = v48;
          _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "piggyback SKE data %p (%uB) for realloc pair %@.", buf, 0x1Cu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v49 = [(NSData *)v45 length];
            [v152 candidatePairToken];
            v149 = v148 = v49;
            v147 = v45;
            _IDSLogTransport(@"GL", @"IDS", @"piggyback SKE data %p (%uB) for realloc pair %@.");

            if (_IDSShouldLog())
            {
              v50 = [(NSData *)v45 length:v45];
              [v152 candidatePairToken];
              v149 = v148 = v50;
              v147 = v45;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"piggyback SKE data %p (%uB) for realloc pair %@.");
            }
          }
        }

        v51 = v45;
        CFDictionarySetValue(Mutable, @"gl-attr-skedata", v51);
      }
    }

    goto LABEL_67;
  }

  if (v43 < 0x101u)
  {
    v129 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v129, OS_LOG_TYPE_DEFAULT))
    {
      skeData = self->_skeData;
      *buf = 134218240;
      *&buf[4] = skeData;
      *&buf[12] = 1024;
      *&buf[14] = v44;
      _os_log_impl(&dword_1A7AD9000, v129, OS_LOG_TYPE_DEFAULT, "piggyback SKE data %p (%uB), send session connected.", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v147 = self->_skeData;
        v148 = v44;
        _IDSLogTransport(@"GL", @"IDS", @"piggyback SKE data %p (%uB), send session connected.");
        if (_IDSShouldLog())
        {
          v147 = self->_skeData;
          v148 = v44;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"piggyback SKE data %p (%uB), send session connected.");
        }
      }
    }

    v131 = self->_skeData;
    if (v131)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-skedata", v131);
    }

    else
    {
      v139 = MEMORY[0x1E69E9C10];
      v140 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v139, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E152AC();
      }
    }

    [v152 setSentSKEData:1];
    self->_delaySessionConnected = 0;
    if (!self->_isInitiator)
    {
      [v152 setSkeData:self->_skeData];
      v141 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_acceptDelayU32];
      if (v141)
      {
        CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v141);
      }

      else
      {
        v142 = MEMORY[0x1E69E9C10];
        v143 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v142, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15004();
        }
      }

      v144 = v151 != 32769;
      if (self->_remoteGlobalLinkVersion)
      {
        v144 = 1;
      }

      if (!v144)
      {
        v145 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v145, OS_LOG_TYPE_DEFAULT))
        {
          v146 = self->_skeData;
          *buf = 134217984;
          *&buf[4] = v146;
          _os_log_impl(&dword_1A7AD9000, v145, OS_LOG_TYPE_DEFAULT, "SKE is complete for Receiver, remove SKE data %p.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v147 = self->_skeData;
            _IDSLogTransport(@"GL", @"IDS", @"SKE is complete for Receiver, remove SKE data %p.");
            if (_IDSShouldLog())
            {
              v147 = self->_skeData;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE is complete for Receiver, remove SKE data %p.");
            }
          }
        }

        self->_skeToRemoteComplete = 1;
      }
    }

    goto LABEL_67;
  }

  v116 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *&buf[4] = v44;
    _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "SKE data is too long (%uB).", buf, 8u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"SKE data is too long (%uB).");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is too long (%uB).");
      }
    }
  }

  v117 = 0;
LABEL_250:

  return v117;
}

- (BOOL)_skipCommandMessage:(int64_t)a3 candidatePair:(id)a4 timeNow:(double)a5
{
  v19 = *MEMORY[0x1E69E9840];
  v7 = a4;
  v8 = [v7 state];
  if (v8 <= 2 && ![v7 isNominated])
  {
    goto LABEL_24;
  }

  LOBYTE(v9) = 0;
  if (a3 > 3)
  {
    switch(a3)
    {
      case 4:
        v9 = +[IDSStunConnectionDataController sharedInstance];
        v14 = [v9 deliveryStatus:self->_cbuuid];

        LOBYTE(v9) = v14 > 1;
        goto LABEL_25;
      case 5:
        if ([v7 isActive] & 1) == 0 && (objc_msgSend(v7, "isNominated"))
        {
          goto LABEL_23;
        }

        break;
      case 6:
        v10 = +[IDSStunRelayInterfaceInfoController sharedInstance];
        v11 = [v10 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

        if (v11 < 3)
        {
          goto LABEL_23;
        }

        v12 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          v13 = [v7 candidatePairToken];
          *buf = 138412290;
          v18 = v13;
          _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip command 0006 for %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          v16 = [v7 candidatePairToken];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip command 0006 for %@");
        }

        break;
      default:
        goto LABEL_25;
    }

LABEL_24:
    LOBYTE(v9) = 1;
    goto LABEL_25;
  }

  switch(a3)
  {
    case 1:
      LOBYTE(v9) = v8 != 3;
      break;
    case 2:
      LOBYTE(v9) = v8 == 6;
      break;
    case 3:
      if (([v7 pendingRealloc] & 1) == 0)
      {
        LODWORD(v9) = [v7 hbStarted] ^ 1;
        break;
      }

LABEL_23:
      LOBYTE(v9) = 0;
      break;
  }

LABEL_25:

  return v9;
}

- (BOOL)_shouldSkipCommand:(int64_t)a3 withCandidatePair:(id)a4 connectionDataCounter:(int)a5 relayInterfaceCounter:(int)a6
{
  *&v26[5] = *MEMORY[0x1E69E9840];
  v10 = a4;
  v11 = v10;
  if (a3 == 6)
  {
    v17 = +[IDSStunRelayInterfaceInfoController sharedInstance];
    v18 = [v17 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

    if ((v18 - 3) <= 0xFFFFFFFFFFFFFFFDLL)
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v26 = v11;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "relay interface info is not in progress or waiting, no need to retransmit: %@, return YES", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"relay interface info is not in progress or waiting, no need to retransmit: %@, return YES");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"relay interface info is not in progress or waiting, no need to retransmit: %@, return YES");
          }
        }
      }

      goto LABEL_43;
    }

    if ((a6 & 0x80000000) == 0 && self->_localRelayInterfaceCounter > a6)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        localRelayInterfaceCounter = self->_localRelayInterfaceCounter;
        *buf = 67109376;
        v26[0] = a6;
        LOWORD(v26[1]) = 1024;
        *(&v26[1] + 2) = localRelayInterfaceCounter;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "relayInterfaceCounter increased, skip sending old version old %d current %d", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"relayInterfaceCounter increased, skip sending old version old %d current %d");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"relayInterfaceCounter increased, skip sending old version old %d current %d");
          }
        }
      }

      goto LABEL_43;
    }

    goto LABEL_44;
  }

  if (a3 == 4)
  {
    v13 = +[IDSStunConnectionDataController sharedInstance];
    v14 = [v13 deliveryStatus:self->_cbuuid];

    if (v14 != 1)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v26 = v11;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "connection data is not in progress, no need to retransmit: %@, return YES", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"connection data is not in progress, no need to retransmit: %@, return YES");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data is not in progress, no need to retransmit: %@, return YES");
          }
        }
      }

      goto LABEL_43;
    }

    if ((a5 & 0x80000000) == 0 && self->_localConnDataCounter > a5)
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        localConnDataCounter = self->_localConnDataCounter;
        *buf = 67109376;
        v26[0] = a5;
        LOWORD(v26[1]) = 1024;
        *(&v26[1] + 2) = localConnDataCounter;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "connection data counter increased, skip sending old version old %d current %d", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"connection data counter increased, skip sending old version old %d current %d");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data counter increased, skip sending old version old %d current %d");
          }
        }
      }

      goto LABEL_43;
    }

LABEL_44:
    v23 = 0;
    goto LABEL_45;
  }

  if (a3 != 1 || !self->_enableSKE || !self->_skeToRemoteComplete || ![v10 recvConnectedAck])
  {
    goto LABEL_44;
  }

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "already received remote SKE, return YES", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"already received remote SKE, return YES");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"already received remote SKE, return YES");
      }
    }
  }

LABEL_43:
  v23 = 1;
LABEL_45:

  return v23;
}

- (void)sendTestPacketCommandMessage:(id)a3 candidatePair:(id)a4
{
  v12[1] = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if (!v6)
  {
    v6 = [MEMORY[0x1E695DEF0] data];
  }

  v11 = @"gl-attr-generic-data";
  v12[0] = v6;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v12 forKeys:&v11 count:1];
  v9 = [v8 mutableCopy];

  if ([v7 remoteRelayLinkID])
  {
    v10 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(v7, "remoteRelayLinkID")}];
    [v9 setObject:v10 forKeyedSubscript:@"gl-attr-remote-relay-link-id"];
  }

  [(IDSGlobalLink *)self _sendCommandMessage:33008 stunMessage:0 options:v9 candidatePair:v7];
}

- (void)sendTestPacketChannelDataMessage:(id)a3 candidatePair:(id)a4
{
  v6 = a3;
  v7 = a4;
  if (!v6)
  {
    v6 = [MEMORY[0x1E695DEF0] data];
  }

  v8 = _IDSLinkPacketBufferCreate();
  *(v8 + 1216) = [v7 linkID];
  v8[2] = [v6 length];
  [v6 getBytes:*v8 length:{objc_msgSend(v6, "length")}];
  *(v8 + 134) |= 0x80000u;
  if ([(IDSGlobalLink *)self _sendChannelDataPacketBuffer:v8 candidatePair:v7])
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *v10 = 0;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to send test packet to relay server", v10, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to send test packet to relay server");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send test packet to relay server");
        }
      }
    }
  }
}

- (void)_sendCommandMessage:(int64_t)a3 stunMessage:(id)a4 options:(id)a5 candidatePairToken:(id)a6
{
  v22 = *MEMORY[0x1E69E9840];
  v10 = a4;
  v11 = a5;
  v12 = a6;
  if (v12 && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v14 = CFDictionaryGetValue(tokenToCandidatePairs, v12)) != 0 || v12 && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v14 = CFDictionaryGetValue(tokenToStunCheckPairs, v12)) != 0)
  {
    v16 = v14;
LABEL_9:
    [(IDSGlobalLink *)self _sendCommandMessage:a3 stunMessage:v10 options:v11 candidatePair:v16];

    goto LABEL_10;
  }

  v16 = [(IDSGlobalLink *)self _findVirtualCandidatePair:v12];
  if (v16)
  {
    goto LABEL_9;
  }

  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    v19 = a3;
    v20 = 2112;
    v21 = v12;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "send command %04lx failed due to invalid candidate pair %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"send command %04lx failed due to invalid candidate pair %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send command %04lx failed due to invalid candidate pair %@");
      }
    }
  }

LABEL_10:
}

- (void)_sendCommandMessage:(int64_t)a3 stunMessage:(id)a4 options:(id)a5 candidatePair:(id)a6
{
  v123 = *MEMORY[0x1E69E9840];
  v10 = a4;
  v11 = a5;
  v12 = a6;
  v13 = v12;
  v108 = v11;
  v109 = v10;
  if (self->_state >= 6)
  {
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = _IDSLinkStateStrings[self->_state];
      *buf = 134218242;
      *v120 = a3;
      *&v120[8] = 2080;
      *v121 = v15;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "skip session command %04lx, GL state (%s).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip session command %04lx, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip session command %04lx, GL state (%s).");
        }
      }
    }

    goto LABEL_10;
  }

  if ([v12 isRelayStunCandidatePair])
  {
    [(IDSGlobalLink *)self _sendChannelDataCommandMessage:a3 packetBuffer:0 options:v11 candidatePair:v13];
    goto LABEL_10;
  }

  v16 = [v13 state];
  v17 = [v13 isP2P];
  v106 = v16;
  v18 = v16 - 5;
  if (v17 && v18 <= 0xFFFFFFFFFFFFFFFDLL)
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = [v13 candidatePairToken];
      v21 = (&_IDSStunCandidatePairStateStrings)[v106];
      *buf = 138412802;
      *v120 = v20;
      *&v120[8] = 2080;
      *v121 = v21;
      *&v121[8] = 1024;
      *&v121[10] = a3;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], not sending command %04x.", buf, 0x1Cu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = [v13 candidatePairToken];
        v100 = (&_IDSStunCandidatePairStateStrings)[v106];
        _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], not sending command %04x.");

        if (_IDSShouldLog())
        {
          v23 = [v13 candidatePairToken:v22];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], not sending command %04x.");
        }
      }
    }

    goto LABEL_10;
  }

  v107 = a3;
  v105 = self;
  v24 = v18 < 0xFFFFFFFFFFFFFFFELL;
  v25 = [v13 local];
  v26 = [v25 address];

  if (([v13 isRelayStunCandidatePair]& v24) != 1)
  {
LABEL_46:
    v48 = ids_monotonic_time();
    v49 = [v108 objectForKey:@"gl-attr-active-probing-link-id"];
    v50 = [v49 charValue];

    v51 = v107;
    if (!v50)
    {
      if ([(IDSGlobalLink *)v105 _skipCommandMessage:v107 candidatePair:v13 timeNow:v48])
      {
        v59 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v59, OS_LOG_TYPE_DEBUG))
        {
          v60 = [v13 candidatePairToken];
          v61 = (&_IDSStunCandidatePairStateStrings)[[v13 state]];
          *buf = 134218498;
          *v120 = v107;
          *&v120[8] = 2112;
          *v121 = v60;
          *&v121[8] = 2080;
          *&v121[10] = v61;
          _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEBUG, "skip session command %04lx for %@, state [%s].", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          v102 = [v13 candidatePairToken];
          [v13 state];
          _IDSLogV(1, @"IDSFoundation", @"GL", @"skip session command %04lx for %@, state [%s].");
        }

        goto LABEL_10;
      }

      v51 = v107;
      if (v107 == 3)
      {
        [v13 hbStartTime];
        if (v67 == 0.0)
        {
          v68 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v120 = v13;
            _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "session heartbeat request start now for %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v98 = v13;
              _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request start now for %@");
              if (_IDSShouldLog())
              {
                v98 = v13;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request start now for %@");
              }
            }
          }

          [v13 setHbStartTime:v48, v98, v99, v103, v104];
          v51 = 3;
        }

        else
        {
          v51 = 3;
          if (v48 - v67 > 60.0)
          {
            v96 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v96, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v120 = v13;
              _os_log_impl(&dword_1A7AD9000, v96, OS_LOG_TYPE_DEFAULT, "session heartbeat request message timed out, disconnect %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v98 = v13;
                _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request message timed out, disconnect %@");
                if (_IDSShouldLog())
                {
                  v98 = v13;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request message timed out, disconnect %@");
                }
              }
            }

            v97 = [v13 isQUIC:v98];
            v58 = [v13 candidatePairToken];
            if (v97)
            {
              goto LABEL_61;
            }

            goto LABEL_162;
          }
        }
      }
    }

    if (v109)
    {
      [(IDSStunMessage *)v109 startTime];
      if (v48 - v52 > 30.0)
      {
        if (v107 == 6)
        {
          v94 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, "session relay interface information message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session relay interface information message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session relay interface information message timed out.");
              }
            }
          }

          [(IDSGlobalLink *)v105 _discardKeyMaterialMessage:12, v98];
          v95 = +[IDSStunRelayInterfaceInfoController sharedInstance];
          [v95 setRelayInterfaceInfoDeliveryStatus:v105->_cbuuid status:4];

          goto LABEL_10;
        }

        if (v107 == 4)
        {
          v92 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v92, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v92, OS_LOG_TYPE_DEFAULT, "session connection data message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session connection data message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connection data message timed out.");
              }
            }
          }

          v93 = +[IDSStunConnectionDataController sharedInstance];
          [v93 setDeliveryStatus:v105->_cbuuid status:3];

          goto LABEL_10;
        }

        if (v107 != 1)
        {
          goto LABEL_10;
        }

        v53 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v53, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *v120 = v13;
          _os_log_impl(&dword_1A7AD9000, v53, OS_LOG_TYPE_DEFAULT, "session connected message timed out, disconnect %@.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v98 = v13;
            _IDSLogTransport(@"GL", @"IDS", @"session connected message timed out, disconnect %@.");
            if (_IDSShouldLog())
            {
              v98 = v13;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message timed out, disconnect %@.");
            }
          }
        }

        v54 = [v13 linkEngine];

        if (v54)
        {
          v55 = [v13 linkEngine];
          v56 = [v13 linkUniqueName];
          [v55 linkDidFail:v56 errorCode:9 isRecoverable:0 shouldReconnect:0];
        }

        v57 = [v13 isQUIC];
        v58 = [v13 candidatePairToken];
        if (v57)
        {
LABEL_61:
          [(IDSGlobalLink *)v105 _sendQUICUnallocbindRequest:v58 reason:9];

          goto LABEL_10;
        }

LABEL_162:
        [(IDSGlobalLink *)v105 _sendUnallocbindRequest:v58 stunMessage:0 reason:9];

        goto LABEL_10;
      }

      if ((v107 & 0xFFFFFFFFFFFF7FFFLL) == 4 && v108 || (v107 & 0xFFFFFFFFFFFF7FFFLL) == 6 && v108)
      {
        v69 = [v108 objectForKey:@"gl-attr-counter"];
        [v69 intValue];
      }

      if ([IDSGlobalLink _shouldSkipCommand:v105 withCandidatePair:"_shouldSkipCommand:withCandidatePair:connectionDataCounter:relayInterfaceCounter:" connectionDataCounter:v98 relayInterfaceCounter:?])
      {
        goto LABEL_10;
      }
    }

    else
    {
      v62 = [(IDSGlobalLink *)v105 _createCommandData:v51 options:v108 candidatePair:v13];
      if (!v62)
      {
        v70 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 134217984;
          *v120 = v107;
          _os_log_impl(&dword_1A7AD9000, v70, OS_LOG_TYPE_DEFAULT, "failed to get indication data, skip session command (%04lx) message.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to get indication data, skip session command (%04lx) message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get indication data, skip session command (%04lx) message.");
            }
          }
        }

        v109 = 0;
        goto LABEL_10;
      }

      if ([v13 isRelayStunCandidatePair])
      {
        v63 = 22;
      }

      else
      {
        v63 = 23;
      }

      v109 = [[IDSStunMessage alloc] initWithType:v63];
      v64 = [v13 channelNumber];
      v65 = objc_alloc_init(MEMORY[0x1E695DF90]);
      v66 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:__rev16(v64)];
      if (v66)
      {
        CFDictionarySetValue(v65, @"ids-stun-attribute-channelnumber", v66);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E157F0();
      }

      CFDictionarySetValue(v65, @"ids-stun-attribute-data", v62);
      v71 = [v108 objectForKey:@"gl-attr-remote-relay-link-id"];
      if (v71)
      {
        CFDictionarySetValue(v65, @"ids-stun-attribute-relay-link-id", v71);
      }

      [(IDSStunMessage *)v109 setTransactionID:0 attributes:v65];
      [(IDSStunMessage *)v109 setStartTime:v48];
    }

    v72 = +[IDSFoundationLog GlobalLink];
    v73 = os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT);
    if (v50 <= 0)
    {
      if (v73)
      {
        v79 = [(IDSStunMessage *)v109 type];
        v80 = [v13 candidatePairToken];
        idsSessionID = v105->_idsSessionID;
        v82 = [v13 sessionID];
        *buf = 67110146;
        *v120 = v107;
        *&v120[4] = 1024;
        *&v120[6] = v79;
        *v121 = 2112;
        *&v121[2] = v80;
        *&v121[10] = 2112;
        *&v121[12] = idsSessionID;
        *&v121[20] = 2112;
        *&v121[22] = v82;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "Send command %04x (stun:%04x) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x2Cu);
      }
    }

    else
    {
      if (v73)
      {
        v74 = [(IDSStunMessage *)v109 type];
        v75 = [v13 candidatePairToken];
        v76 = v105->_idsSessionID;
        v77 = [v13 sessionID];
        *buf = 67110402;
        *v120 = v107;
        *&v120[4] = 1024;
        *&v120[6] = v50;
        *v121 = 1024;
        *&v121[2] = v74;
        *&v121[6] = 2112;
        *&v121[8] = v75;
        *&v121[16] = 2112;
        *&v121[18] = v76;
        *&v121[26] = 2112;
        *&v121[28] = v77;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "Send command %04x (active probing on link %d) (stun:%04x) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x32u);
      }

      if (v105->_maxLinkID <= v50)
      {
        v78 = 0;
      }

      else
      {
        v78 = v105->_candidatePairs[v50];
      }

      v72 = v13;
      v13 = v78;
    }

    [(IDSGlobalLink *)v105 _sendStunMessage:v109 candidatePair:v13];
    v83 = 0;
    v84 = v107;
    if (v107 != 3 && (v107 & 0x8000) == 0)
    {
      v83 = v109;
    }

    v85 = v50 > 0 && v107 == 3;
    if (v85 || (v107 & 0x8000) != 0)
    {
LABEL_152:

      goto LABEL_10;
    }

    v86 = 1.0;
    if (v107 != 6 && v107 != 1)
    {
      v89 = v108;
      goto LABEL_151;
    }

    [(IDSStunMessage *)v109 startTime];
    if (v48 - v87 < 2.0)
    {
      v88 = v105->_allocbindEndTime - v105->_allocbindStartTime;
      v84 = v107;
      v89 = v108;
      if (v88 <= 0.0)
      {
LABEL_151:
        v110[0] = MEMORY[0x1E69E9820];
        v110[1] = 3221225472;
        v110[2] = sub_1A7B9556C;
        v110[3] = &unk_1E77E0F78;
        v110[4] = v105;
        v114 = v84;
        v111 = v83;
        v112 = v89;
        v113 = v13;
        IDSTransportThreadAddBlockAfter(v110, v86);

        goto LABEL_152;
      }

      v90 = v88 + v88;
      if (v88 + v88 > 0.2)
      {
        v90 = 0.2;
      }

      if (v90 >= 0.05)
      {
        v86 = v90;
      }

      else
      {
        v86 = 0.05;
      }

      v91 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v91, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134218240;
        *v120 = v86;
        *&v120[8] = 2048;
        *v121 = v88;
        _os_log_impl(&dword_1A7AD9000, v91, OS_LOG_TYPE_DEFAULT, "use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
          }
        }
      }
    }

    v84 = v107;
    v89 = v108;
    goto LABEL_151;
  }

  v117 = 0u;
  v118 = 0u;
  v115 = 0u;
  v116 = 0u;
  v27 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = [v27 countByEnumeratingWithState:&v115 objects:v122 count:16];
  if (v28)
  {
    v29 = *v116;
    while (2)
    {
      for (i = 0; i != v28; ++i)
      {
        if (*v116 != v29)
        {
          objc_enumerationMutation(v27);
        }

        v31 = *(*(&v115 + 1) + 8 * i);
        v32 = [v31 local];
        v33 = [v32 address];

        v34 = [v31 sessionID];
        v35 = [v13 sessionID];
        if ([v34 isEqualToString:v35] && (objc_msgSend(v31, "state") == 3 || objc_msgSend(v31, "state") == 4))
        {
          v36 = IsSameSA(v26, v33);

          if (v36)
          {
            v42 = [v13 candidatePairToken];
            v43 = [v31 candidatePairToken];
            v44 = v31;

            v45 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
            {
              v47 = (&_IDSStunCandidatePairStateStrings)[v106];
              *buf = 138413058;
              *v120 = v42;
              *&v120[8] = 2080;
              *v121 = v47;
              *&v121[8] = 1024;
              *&v121[10] = v107;
              *&v121[14] = 2112;
              *&v121[16] = v43;
              _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], send command %04x using %@.", buf, 0x26u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v103 = v107;
                v104 = v43;
                v98 = v42;
                v99 = (&_IDSStunCandidatePairStateStrings)[v106];
                _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], send command %04x using %@.");
                if (_IDSShouldLog())
                {
                  v103 = v107;
                  v104 = v43;
                  v98 = v42;
                  v99 = (&_IDSStunCandidatePairStateStrings)[v106];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], send command %04x using %@.");
                }
              }
            }

            v13 = v44;
            goto LABEL_46;
          }
        }

        else
        {
        }
      }

      v28 = [v27 countByEnumeratingWithState:&v115 objects:v122 count:16];
      if (v28)
      {
        continue;
      }

      break;
    }
  }

  v37 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
  {
    v38 = [v13 candidatePairToken];
    v39 = (&_IDSStunCandidatePairStateStrings)[v106];
    *buf = 138412802;
    *v120 = v38;
    *&v120[8] = 2080;
    *v121 = v39;
    *&v121[8] = 1024;
    *&v121[10] = v107;
    _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], Found no other connected candidate pair to send command %04x", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v40 = [v13 candidatePairToken];
      v101 = (&_IDSStunCandidatePairStateStrings)[v106];
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");

      if (_IDSShouldLog())
      {
        v41 = [v13 candidatePairToken:v40];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");
      }
    }
  }

LABEL_10:
}

- (BOOL)_processIncomingIndicationData:(char *)a3 length:(int)a4 candidatePairToken:(id)a5 arrivalTime:(double)a6 remoteRelayLinkID:(unsigned __int16)a7
{
  v7 = a7;
  v9 = *&a4;
  v32 = *MEMORY[0x1E69E9840];
  v12 = a5;
  v13 = [IDSGlobalLinkMessage messageWithBuffer:a3 length:v9];
  v14 = [v13 command];
  if (!self->_useSecureControlMessage || ([v13 verifyHMacDigestWithKey:self->_controlMessageKey inputBuffer:a3 inputLength:v9] & 1) != 0)
  {
    Value = 0;
    if (v12 && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v12);
    }

    v16 = Value;
    v17 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v19 = [v16 sessionID];
      *buf = 67109890;
      v25 = v14;
      v26 = 2112;
      v27 = v12;
      v28 = 2112;
      v29 = idsSessionID;
      v30 = 2112;
      v31 = v19;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Received command %04x on %@ for IDSSessionID: %@ QRSessionID: %@", buf, 0x26u);
    }

    if (v14 <= 0x8000)
    {
      if (v14 > 3)
      {
        if (v14 == 4)
        {
LABEL_35:
          [(IDSGlobalLink *)self _processCommandConnectionData:v13 candidatePairToken:v12];
          goto LABEL_40;
        }

        if (v14 == 5)
        {
LABEL_38:
          [(IDSGlobalLink *)self _processCommandNominate:v13 candidatePairToken:v12];
          goto LABEL_40;
        }

        if (v14 != 6)
        {
          goto LABEL_42;
        }

        goto LABEL_37;
      }

      if (v14 != 1)
      {
        if (v14 != 2)
        {
          if (v14 != 3)
          {
            goto LABEL_42;
          }

LABEL_27:
          [(IDSGlobalLink *)self _processCommandHeartbeat:v13 candidatePairToken:v12 arrivalTime:v7 remoteRelayLinkID:a6];
LABEL_40:

          v21 = 1;
          goto LABEL_41;
        }

LABEL_39:
        [(IDSGlobalLink *)self _processCommandDisconnected:v13 candidatePairToken:v12];
        goto LABEL_40;
      }
    }

    else
    {
      if (v14 > 32771)
      {
        if (v14 <= 32773)
        {
          if (v14 != 32772)
          {
            goto LABEL_38;
          }

          goto LABEL_35;
        }

        if (v14 != 32774)
        {
          if (v14 == 33008)
          {
            [(IDSGlobalLink *)self _processCommandTestPacket:v13 candidatePairToken:v12 remoteRelayLinkID:v7];
            goto LABEL_40;
          }

LABEL_42:
          v23 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 67109120;
            v25 = v14;
            _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive invalid command %04x.", buf, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"receive invalid command %04x.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid command %04x.");
              }
            }
          }

          goto LABEL_40;
        }

LABEL_37:
        [(IDSGlobalLink *)self _processCommandRelayInterfaceInfo:v13 candidatePairToken:v12];
        goto LABEL_40;
      }

      if (v14 != 32769)
      {
        if (v14 != 32770)
        {
          goto LABEL_27;
        }

        goto LABEL_39;
      }
    }

    [(IDSGlobalLink *)self _processCommandConnected:v13 candidatePairToken:v12];
    goto LABEL_40;
  }

  v20 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    v25 = v14;
    v26 = 2112;
    v27 = v12;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "failed to verify HMac, drop command %04x for %@.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to verify HMac, drop command %04x for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to verify HMac, drop command %04x for %@.");
      }
    }
  }

  v21 = 0;
LABEL_41:

  return v21;
}

- (void)_notifyQRSessionConnected:(id)a3
{
  v74 = *MEMORY[0x1E69E9840];
  v60 = a3;
  key = [(IDSGlobalLink *)v60 candidatePairToken];
  v3 = [(IDSGlobalLink *)v60 state];
  v4 = v3;
  if (v3 <= 2)
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "receive session connected message before allocbind response.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive session connected message before allocbind response.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive session connected message before allocbind response.");
        }
      }
    }

LABEL_15:
    v8 = self;
    if (self->_state == 4)
    {
      if (!self->_allowOnlyOneQR)
      {
        v57 = 0;
LABEL_54:
        if (v4 <= 3)
        {
          [(IDSGlobalLink *)v60 setState:4];
          [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v60];
          v30 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
          {
            v31 = (&_IDSStunCandidatePairStateStrings)[v4];
            *buf = 136315650;
            v69 = v31;
            v70 = 2080;
            v71 = off_1EB2B43C8;
            v72 = 2112;
            v73 = key;
            _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v55 = off_1EB2B43C8;
              v56 = key;
              v54 = (&_IDSStunCandidatePairStateStrings)[v4];
              _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
              if (_IDSShouldLog())
              {
                v55 = off_1EB2B43C8;
                v56 = key;
                v54 = (&_IDSStunCandidatePairStateStrings)[v4];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
              }
            }
          }

          [(IDSGlobalLink *)v60 stopSessionConnectedTimer:v54];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:key];
          if ([(IDSGlobalLink *)v60 isRelayStunCandidatePair]&& ([(IDSGlobalLink *)v60 isSharedQRSession]& 1) == 0)
          {
            v32 = [(IDSGlobalLink *)v60 sessionID];
            v33 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:v32 inState:3];

            v63 = 0u;
            v64 = 0u;
            v61 = 0u;
            v62 = 0u;
            v34 = v33;
            v35 = [v34 countByEnumeratingWithState:&v61 objects:v67 count:16];
            if (v35)
            {
              v36 = *v62;
              do
              {
                for (i = 0; i != v35; ++i)
                {
                  if (*v62 != v36)
                  {
                    objc_enumerationMutation(v34);
                  }

                  v38 = *(*(&v61 + 1) + 8 * i);
                  v39 = [(IDSGlobalLink *)v38 isRealloc];
                  if (v38 == v60)
                  {
                    v40 = 1;
                  }

                  else
                  {
                    v40 = v39;
                  }

                  if ((v40 & 1) == 0)
                  {
                    v41 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
                    {
                      v42 = [(IDSGlobalLink *)v38 sessionID];
                      *buf = 138412546;
                      v69 = v38;
                      v70 = 2112;
                      v71 = v42;
                      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "Found another succeeded candidate pair %@ with the same QRSessionID %@, disconnecting", buf, 0x16u);
                    }

                    v43 = [(IDSGlobalLink *)v38 isQUIC];
                    v44 = [(IDSGlobalLink *)v38 candidatePairToken];
                    if (v43)
                    {
                      [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:v44 reason:8];
                    }

                    else
                    {
                      [(IDSGlobalLink *)self _sendUnallocbindRequest:v44 stunMessage:0 reason:8];
                    }
                  }
                }

                v35 = [v34 countByEnumeratingWithState:&v61 objects:v67 count:16];
              }

              while (v35);
            }
          }

          Value = 0;
          if (self->_tokenToReallocBlocks && key)
          {
            Value = CFDictionaryGetValue(self->_tokenToReallocBlocks, key);
          }

          v46 = _Block_copy(Value);
          if (v46)
          {
            v47 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
            {
              v48 = _Block_copy(v46);
              *buf = 134218242;
              v69 = v48;
              v70 = 2112;
              v71 = key;
              _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "process delayed realloc block %p for %@.", buf, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v54 = _Block_copy(v46);
                v55 = key;
                _IDSLogTransport(@"GL", @"IDS", @"process delayed realloc block %p for %@.");

                if (_IDSShouldLog())
                {
                  v54 = _Block_copy(v46);
                  v55 = key;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"process delayed realloc block %p for %@.");
                }
              }
            }

            v46[2](v46);
            if (key)
            {
              tokenToReallocBlocks = self->_tokenToReallocBlocks;
              if (tokenToReallocBlocks)
              {
                CFDictionaryRemoveValue(tokenToReallocBlocks, key);
              }
            }
          }

          v8 = self;
        }

        if (v57)
        {
          [(IDSGlobalLink *)v8 _notifyDefaultUnderlyingLinkChanged:key error:0];
          v8 = self;
        }

        [(IDSGlobalLink *)v8 _selectBetterDefaultCandidatePair:v60, v54, v55];
        v50 = [(IDSGlobalLink *)self _convergeSharedSessions:v60];
        v51 = [v50 count] == 0;

        if (!v51)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector hasConvergence];
        }

        if ([(IDSGlobalLink *)v60 isRelayStunCandidatePair])
        {
          v52 = +[IDSStunConnectionDataController sharedInstance];
          v53 = [v52 deliveryStatus:self->_cbuuid];

          if (v53 <= 1)
          {
            [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
          }
        }

        goto LABEL_102;
      }

      if (![(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v57 = 0;
        goto LABEL_53;
      }

      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        cbuuid = self->_cbuuid;
        *buf = 138412546;
        v69 = v60;
        v70 = 2112;
        v71 = cbuuid;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "candidate pair %@ is connected but GL is already connected, override for %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v54 = v60;
          v55 = self->_cbuuid;
          _IDSLogTransport(@"GL", @"IDS", @"candidate pair %@ is connected but GL is already connected, override for %@");
          if (_IDSShouldLog())
          {
            v54 = v60;
            v55 = self->_cbuuid;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"candidate pair %@ is connected but GL is already connected, override for %@");
          }
        }
      }

      [(IDSGlobalLink *)self _updateDefaultCandidatePair:v60, v54, v55];
      v11 = 1;
LABEL_52:
      v57 = v11;
LABEL_53:
      v8 = self;
      goto LABEL_54;
    }

    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      v69 = self;
      v70 = 2080;
      v71 = v13;
      v72 = 2080;
      v73 = off_1EB2B3E70[0];
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v55 = _IDSLinkStateStrings[self->_state];
        v56 = off_1EB2B3E70[0];
        v54 = self;
        _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
        if (_IDSShouldLog())
        {
          v55 = _IDSLinkStateStrings[self->_state];
          v56 = off_1EB2B3E70[0];
          v54 = self;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
        }
      }
    }

    v14 = self;
    self->_state = 4;
    if (!self->_isUPlusOneSession)
    {
      v15 = ids_monotonic_time();
      v14 = self;
      self->_linkConnectTime = v15;
    }

    [(IDSGlobalLink *)v14 _stopAllocbindFailoverTimer:0, v54, v55, v56];
    v16 = [MEMORY[0x1E69A60F0] sharedInstance];
    v17 = [v16 isInternalInstall];

    if (v17)
    {
      [(IDSGlobalLink *)v60 setTestOptionsFromUserDefaults];
    }

    v18 = _Block_copy(self->_connectReadyHandler);
    if (v18)
    {
      v19 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7B96780;
      block[3] = &unk_1E77E0B48;
      v66 = v18;
      v20 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS|DISPATCH_BLOCK_ASSIGN_CURRENT, QOS_CLASS_USER_INTERACTIVE, 0, block);
      dispatch_async(v19, v20);

      v21 = v66;
    }

    else
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v23 = objc_opt_respondsToSelector();

      if ((v23 & 1) == 0)
      {
LABEL_41:
        v24 = objc_loadWeakRetained(&self->_delegate);
        [v24 link:self didConnectForDeviceUniqueID:self->_deviceUniqueID cbuuid:self->_cbuuid];

        v25 = [(IDSGlobalLink *)v60 isActive];
        if ((v25 & 1) == 0)
        {
          v26 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
          {
            v27 = [(IDSGlobalLink *)v60 candidatePairToken];
            *buf = 138412290;
            v69 = v27;
            _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "default candidate pair is not connected, switch to %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v54 = [(IDSGlobalLink *)v60 candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"default candidate pair is not connected, switch to %@.");

              if (_IDSShouldLog())
              {
                v54 = [(IDSGlobalLink *)v60 candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"default candidate pair is not connected, switch to %@.");
              }
            }
          }

          [(IDSGlobalLink *)self _updateDefaultCandidatePair:v60, v54];
        }

        v28 = self;
        if (self->_skeToRemoteComplete)
        {
          skeData = self->_skeData;
          self->_skeData = 0;

          v28 = self;
        }

        [(IDSGlobalLink *)v28 _discardNonAcceptedCandidatePairs];
        [(IDSGlobalLink *)self _startActivityTimer];
        [(IDSGlobalLink *)self _startExtIPDiscovery];

        v11 = v25 ^ 1;
        goto LABEL_52;
      }

      v21 = objc_loadWeakRetained(&self->_delegate);
      [v21 link:self didConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_41;
  }

  if (v3 - 5 > 1)
  {
    goto LABEL_15;
  }

  v6 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = (&_IDSStunCandidatePairStateStrings)[v4];
    *buf = 138412546;
    v69 = key;
    v70 = 2080;
    v71 = v7;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], ignore session connected.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], ignore session connected.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], ignore session connected.");
      }
    }
  }

LABEL_102:
}

- (void)_setRemoteGlobalLinkVersionWithCommand:(int64_t)a3 receivedRemoteVersion:(BOOL)a4 versionValue:(unsigned __int16)a5 receivedSKE:(BOOL)a6
{
  if (a4)
  {
    goto LABEL_9;
  }

  if (!self->_isInitiator)
  {
    if (a3 != 1)
    {
      return;
    }

    goto LABEL_8;
  }

  if (a3 == 32769 && self->_enableSKE && a6)
  {
LABEL_8:
    a5 = 0;
LABEL_9:
    self->_remoteGlobalLinkVersion = a5;
  }
}

- (void)_processCommandConnected:(id)a3 candidatePairToken:(id)a4
{
  v154 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v134 = [v6 command];
  if (v7)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (tokenToCandidatePairs)
    {
      v9 = CFDictionaryGetValue(tokenToCandidatePairs, v7);
      if (v9)
      {
        v10 = v9;
        if ([v9 pendingRealloc])
        {
          v11 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
          {
            buf[0] = 67109378;
            buf[1] = v134;
            LOWORD(v153[0]) = 2112;
            *(v153 + 2) = v7;
            _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receive session connected command %04x on realloc pair %@, ignore.", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"receive session connected command %04x on realloc pair %@, ignore.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive session connected command %04x on realloc pair %@, ignore.");
              }
            }
          }

          goto LABEL_18;
        }

        bzero(buf, 0x410uLL);
        if ([v6 getAttribute:4 attribute:buf])
        {
          v13 = [MEMORY[0x1E695DEF0] dataWithBytes:&v153[1] length:v153[0]];
          v14 = [v13 length];
          v15 = v14;
          if (v14)
          {
            enableSKE = self->_enableSKE;
          }

          else
          {
            enableSKE = 0;
          }

          if (enableSKE)
          {
            if (self->_recvRemoteSKEData)
            {
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                LOWORD(v147) = 0;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "already received remote SKE data, ignore.", &v147, 2u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"already received remote SKE data, ignore.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"already received remote SKE data, ignore.");
                  }
                }
              }
            }

            else
            {
              self->_recvRemoteSKEData = 1;
              [v10 setRecvSKEData:1];
              v26 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
              {
                v147 = 67109120;
                *v148 = v15;
                _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "receive new remote SKE data %u bytes.", &v147, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v124 = v15;
                  _IDSLogTransport(@"GL", @"IDS", @"receive new remote SKE data %u bytes.");
                  if (_IDSShouldLog())
                  {
                    v124 = v15;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new remote SKE data %u bytes.");
                  }
                }
              }

              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              [WeakRetained link:self didReceiveSKEData:v13];

              if (!self->_isInitiator)
              {
                self->_skeStartTime = ids_monotonic_time();
                if (self->_skeData)
                {
                  self->_delaySessionConnected = 0;
                  v28 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
                  {
                    LOWORD(v147) = 0;
                    _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "SKE data is ready, need to send SKE", &v147, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"SKE data is ready, need to send SKE");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is ready, need to send SKE");
                      }
                    }
                  }
                }

                else
                {
                  self->_delaySessionConnected = 1;
                  v29 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
                  {
                    LOWORD(v147) = 0;
                    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "SKE data is not ready, delay session connected.", &v147, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"SKE data is not ready, delay session connected.");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is not ready, delay session connected.");
                      }
                    }
                  }
                }
              }
            }
          }

          else
          {
            v18 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
            {
              v19 = @"NO";
              skeToRemoteComplete = self->_skeToRemoteComplete;
              if (self->_enableSKE)
              {
                v21 = @"YES";
              }

              else
              {
                v21 = @"NO";
              }

              v147 = 67109634;
              if (skeToRemoteComplete)
              {
                v19 = @"YES";
              }

              *v148 = v15;
              *&v148[4] = 2112;
              *&v148[6] = v21;
              v149 = 2112;
              v150 = v19;
              _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "ignore SKE data %uB (EnableSKE %@, SKEComplete %@).", &v147, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v22 = self->_enableSKE ? @"YES" : @"NO";
              v23 = self->_skeToRemoteComplete ? @"YES" : @"NO";
              v127 = v22;
              v130 = v23;
              v124 = v15;
              _IDSLogTransport(@"GL", @"IDS", @"ignore SKE data %uB (EnableSKE %@, SKEComplete %@).");
              if (_IDSShouldLog())
              {
                if (self->_enableSKE)
                {
                  v24 = @"YES";
                }

                else
                {
                  v24 = @"NO";
                }

                if (self->_skeToRemoteComplete)
                {
                  v25 = @"YES";
                }

                else
                {
                  v25 = @"NO";
                }

                v127 = v24;
                v130 = v25;
                v124 = v15;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"ignore SKE data %uB (EnableSKE %@, SKEComplete %@).");
              }
            }
          }
        }

        else
        {
          enableSKE = 0;
        }

        v136 = 0;
        v135 = 0;
        v151 = 0uLL;
        if (v134 == 1)
        {
          HasValidUInt16Attr = GLUtilHasValidUInt16Attr(v6, 18, &v135);
          v31 = v135;
        }

        else
        {
          v31 = 0;
          HasValidUInt16Attr = 0;
        }

        [(IDSGlobalLink *)self _setRemoteGlobalLinkVersionWithCommand:v134 receivedRemoteVersion:HasValidUInt16Attr versionValue:v31 receivedSKE:enableSKE, v124, v127, v130];
        if (GLUtilHasValidUInt32Attr(v6, 7, &v136))
        {
          v32 = v136;
          self->_acceptDelayU32 = v136;
          v33 = vcvtd_n_f64_u32(v32, 0x10uLL) + HIWORD(v32);
          v34 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
          {
            acceptDelayU32 = self->_acceptDelayU32;
            v147 = 67109376;
            *v148 = acceptDelayU32;
            *&v148[4] = 2048;
            *&v148[6] = v33;
            _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "receive accept delay: %08x/%.6f", &v147, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v128 = v33;
              v125 = self->_acceptDelayU32;
              _IDSLogTransport(@"GL", @"IDS", @"receive accept delay: %08x/%.6f");
              if (_IDSShouldLog())
              {
                v128 = v33;
                v125 = self->_acceptDelayU32;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive accept delay: %08x/%.6f");
              }
            }
          }
        }

        if (GLUtilHasValidUInt16Attr(v6, 2, &v135))
        {
          v36 = [v10 remote];
          v37 = v36;
          if (v135 <= 4u)
          {
            v38 = v135;
          }

          else
          {
            v38 = 0;
          }

          [v36 updateTransport:{v38, v125, *&v128}];
        }

        if (GLUtilHasValidUInt16Attr(v6, 5, &v135))
        {
          v39 = [v10 remote];
          v40 = v39;
          v41 = v135 >= 0xAu ? 10 : v135;
          [v39 setRadioAccessTechnology:{v41, v125}];

          v42 = [v10 linkEngine];
          if (v42)
          {
            v43 = [v10 linkUniqueName];
            v44 = v43 == 0;

            if (!v44)
            {
              v45 = [v10 linkEngine];
              v46 = [v10 linkUniqueName];
              if (v135 >= 0xAu)
              {
                v47 = 10;
              }

              else
              {
                v47 = v135;
              }

              [v45 setRemoteRATForLink:v46 rat:v47];

              v48 = [v10 linkEngine];
              [v48 scheduleUpdate];
            }
          }
        }

        if (GLUtilHasValidUInt16Attr(v6, 6, &v135))
        {
          v49 = [v10 remote];
          [v49 setMtu:v135];
        }

        if (GLUtilHasValidUInt16Attr(v6, 12, &v135))
        {
          if (self->_remoteCapabilityFlag != v135)
          {
            self->_remoteCapabilityFlag = v135;
            v50 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
            {
              remoteCapabilityFlag_low = LOWORD(self->_remoteCapabilityFlag);
              v147 = 67109120;
              *v148 = remoteCapabilityFlag_low;
              _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "update remote capability: %04X.", &v147, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v125 = LOWORD(self->_remoteCapabilityFlag);
                _IDSLogTransport(@"GL", @"IDS", @"update remote capability: %04X.");
                if (_IDSShouldLog())
                {
                  v125 = LOWORD(self->_remoteCapabilityFlag);
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"update remote capability: %04X.");
                }
              }
            }
          }

          if ((v135 & 2) != 0)
          {
            v53 = [(IDSGlobalLink *)self _localIsQualityMetadataSupported];
            v54 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
            {
              v55 = @"NO";
              if (v53)
              {
                v55 = @"YES";
              }

              v147 = 138412290;
              *v148 = v55;
              _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "remote has quality metadata capability; local: %@", &v147, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v56 = v53 ? @"YES" : @"NO";
              v125 = v56;
              _IDSLogTransport(@"GL", @"IDS", @"remote has quality metadata capability; local: %@");
              if (_IDSShouldLog())
              {
                v125 = v56;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"remote has quality metadata capability; local: %@");
              }
            }
          }

          else
          {
            v52 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
            {
              LOWORD(v147) = 0;
              _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "remote does not have quality metadata capability", &v147, 2u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"remote does not have quality metadata capability");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remote does not have quality metadata capability");
                }
              }
            }

            v53 = 0;
          }

          [v10 setUseQualityMetadata:{v53, v125}];
        }

        v57 = GLUtilHasValidUInt16Attr(v6, 19, &v135);
        if (v135)
        {
          v58 = v57;
        }

        else
        {
          v58 = 0;
        }

        if (v58 == 1)
        {
          v59 = [v10 remote];
          [v59 setLinkFlags:v135];
        }

        HasValidUInt32Attr = GLUtilHasValidUInt32Attr(v6, 20, &v136);
        if (v136)
        {
          v61 = HasValidUInt32Attr;
        }

        else
        {
          v61 = 0;
        }

        if (v61 == 1)
        {
          v62 = [v10 remote];
          [v62 setDataSoMask:v136];
        }

        bzero(&v147, 0x410uLL);
        if ([v6 getAttribute:8 attribute:&v147])
        {
          v63 = [v10 relayRemote];
          v64 = [v63 address];

          *&v65 = 0xAAAAAAAAAAAAAAAALL;
          *(&v65 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v145 = v65;
          v146 = v65;
          v143 = v65;
          v144 = v65;
          *&v141[32] = v65;
          v142 = v65;
          *v141 = v65;
          *&v141[16] = v65;
          if (IsValidSA(&v148[4]) && (!v64 || !IsSameSA(&v148[4], v64)))
          {
            v66 = [v10 remote];
            v67 = [v66 transport];
            v68 = [v10 remote];
            v69 = [v68 radioAccessTechnology];
            v70 = [v10 remote];
            v71 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 3, v67, v69, [v70 mtu], 0xFFFFFFFFLL, &v148[4], &v148[4]);

            [v10 setRelayRemote:v71];
            v72 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
            {
              v73 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
              *v137 = 136315394;
              v138 = v73;
              v139 = 2112;
              v140 = v7;
              _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive relay-remote-address %s for %@.", v137, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v125 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
                v128 = *&v7;
                _IDSLogTransport(@"GL", @"IDS", @"receive relay-remote-address %s for %@.");
                if (_IDSShouldLog())
                {
                  v125 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
                  v128 = *&v7;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"receive relay-remote-address %s for %@.");
                }
              }
            }
          }
        }

        v74 = GLUtilHasValidUUIDAttr(v6, 11, &v151);
        if (!v75)
        {
LABEL_164:
          if (![(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA", v74, v125, *&v128])
          {
            goto LABEL_176;
          }

          v81 = [v10 defaultRemoteDeviceCBUUID];
          GLUtilHasValidUUIDAttr(v6, 13, &v151);
          if (v82)
          {
            v83 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&v151];
            if (v83)
            {
              v84 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v84, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 138412546;
                *&v141[4] = v83;
                *&v141[12] = 1024;
                *&v141[14] = 13;
                _os_log_impl(&dword_1A7AD9000, v84, OS_LOG_TYPE_DEFAULT, "receive watch cbuuid: %@, attr(%04x).", v141, 0x12u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v126 = v83;
                  v129 = 13;
                  _IDSLogTransport(@"GL", @"IDS", @"receive watch cbuuid: %@, attr(%04x).");
                  if (_IDSShouldLog())
                  {
                    v126 = v83;
                    v129 = 13;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"receive watch cbuuid: %@, attr(%04x).");
                  }
                }
              }

              if ([v81 isEqual:{v83, v126, v129}])
              {

                goto LABEL_175;
              }

              v123 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v123, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 138412802;
                *&v141[4] = v83;
                *&v141[12] = 2112;
                *&v141[14] = v81;
                *&v141[22] = 1024;
                *&v141[24] = v134;
                _os_log_impl(&dword_1A7AD9000, v123, OS_LOG_TYPE_DEFAULT, "watch cbuuid mismatch (%@, %@), reject session command %04x.", v141, 0x1Cu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"watch cbuuid mismatch (%@, %@), reject session command %04x.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"watch cbuuid mismatch (%@, %@), reject session command %04x.");
                  }
                }
              }
            }

            else
            {
              v122 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v122, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 67109120;
                *&v141[4] = v134;
                _os_log_impl(&dword_1A7AD9000, v122, OS_LOG_TYPE_DEFAULT, "recieve invalid watch cbuuid, reject session command %04x.", v141, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"recieve invalid watch cbuuid, reject session command %04x.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"recieve invalid watch cbuuid, reject session command %04x.");
                  }
                }
              }
            }

            goto LABEL_18;
          }

LABEL_175:

LABEL_176:
          v85 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
          {
            v86 = [v10 remote];
            v87 = (&_IDSStunTransportStrings)[[v86 transport]];
            v88 = [v10 remote];
            v89 = IDSRadioAccessTechnologyToString([v88 radioAccessTechnology]);
            v90 = [v10 remote];
            v91 = [v90 mtu];
            v92 = LOWORD(self->_remoteCapabilityFlag);
            remoteGlobalLinkVersion = self->_remoteGlobalLinkVersion;
            *v141 = 136316162;
            *&v141[4] = v87;
            *&v141[12] = 2080;
            *&v141[14] = v89;
            *&v141[22] = 1024;
            *&v141[24] = v91;
            *&v141[28] = 1024;
            *&v141[30] = v92;
            *&v141[34] = 1024;
            *&v141[36] = remoteGlobalLinkVersion;
            _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "session connected message payload (%s/%s/%d/%04X/%d).", v141, 0x28u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v94 = [v10 remote];
              v95 = (&_IDSStunTransportStrings)[[v94 transport]];
              v96 = [v10 remote];
              v97 = IDSRadioAccessTechnologyToString([v96 radioAccessTechnology]);
              v98 = [v10 remote];
              v99 = [v98 mtu];
              v132 = LOWORD(self->_remoteCapabilityFlag);
              v133 = self->_remoteGlobalLinkVersion;
              v129 = v97;
              v131 = v99;
              v126 = v95;
              _IDSLogTransport(@"GL", @"IDS", @"session connected message payload (%s/%s/%d/%04X/%d).");

              if (_IDSShouldLog())
              {
                v100 = [v10 remote];
                v101 = (&_IDSStunTransportStrings)[[v100 transport]];
                v102 = [v10 remote];
                v103 = IDSRadioAccessTechnologyToString([v102 radioAccessTechnology]);
                v104 = [v10 remote];
                v105 = [v104 mtu];
                v132 = LOWORD(self->_remoteCapabilityFlag);
                v133 = self->_remoteGlobalLinkVersion;
                v129 = v103;
                v131 = v105;
                v126 = v101;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message payload (%s/%s/%d/%04X/%d).");
              }
            }
          }

          if (v134 != 1)
          {
            if (v134 == 32769)
            {
              v109 = self->_enableSKE;
              if (v109)
              {
                self->_skeToRemoteComplete = 1;
              }

              [v10 setRecvConnectedAck:{1, v126, v129, v131, v132, v133}];
              v107 = !v109;
            }

            else
            {
              v107 = 0;
            }

LABEL_201:
            if (self->_enableSKE)
            {
              v107 = self->_recvRemoteSKEData && self->_skeToRemoteComplete;
            }

            if (self->_remoteGlobalLinkVersion >= 2)
            {
              v110 = [v10 recvConnected];
            }

            else
            {
              v110 = 1;
            }

            v111 = [v10 recvConnectedAck];
            if (v107)
            {
              v112 = v111;
              if (v110 & v111)
              {
                v113 = 1;
LABEL_221:
                v116 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
                {
                  v117 = @"NO";
                  if (self->_enableSKE)
                  {
                    v118 = @"YES";
                  }

                  else
                  {
                    v118 = @"NO";
                  }

                  recvRemoteSKEData = self->_recvRemoteSKEData;
                  if (self->_skeToRemoteComplete)
                  {
                    v120 = @"YES";
                  }

                  else
                  {
                    v120 = @"NO";
                  }

                  *v141 = 138413058;
                  if (recvRemoteSKEData)
                  {
                    v121 = @"YES";
                  }

                  else
                  {
                    v121 = @"NO";
                  }

                  *&v141[4] = v118;
                  *&v141[12] = 2112;
                  if (v113)
                  {
                    v117 = @"YES";
                  }

                  *&v141[14] = v120;
                  *&v141[22] = 2112;
                  *&v141[24] = v121;
                  *&v141[32] = 2112;
                  *&v141[34] = v117;
                  _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@", v141, 0x2Au);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@");
                    }
                  }
                }

                if (v113)
                {
                  [(IDSGlobalLink *)self _notifyQRSessionConnected:v10];
                  [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:0];
                }

                goto LABEL_18;
              }

              v114 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
              {
                v115 = @"NO";
                if (v112)
                {
                  v115 = @"YES";
                }

                *v141 = 138412290;
                *&v141[4] = v115;
                _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "still not finished Connected command exchange. recvConnectedAck = %@", v141, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"still not finished Connected command exchange. recvConnectedAck = %@");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"still not finished Connected command exchange. recvConnectedAck = %@");
                  }
                }
              }
            }

            v113 = 0;
            goto LABEL_221;
          }

          v106 = self->_remoteGlobalLinkVersion;
          v107 = v106 == 0;
          if (!v106)
          {
            if (self->_isInitiator || self->_delaySessionConnected)
            {
              v107 = 0;
LABEL_200:
              [v10 setRecvConnected:{1, v126}];
              goto LABEL_201;
            }

            [(IDSGlobalLink *)self _sendCommandMessage:32769 stunMessage:0 options:0 candidatePairToken:v7];
            [v10 setRecvConnectedAck:1];
            v106 = self->_remoteGlobalLinkVersion;
          }

          if (v106 >= 1)
          {
            if (self->_isInitiator || self->_delaySessionConnected || !self->_enableSKE || self->_skeToRemoteComplete || [v10 sentSKEData])
            {
              v108 = 32769;
            }

            else
            {
              v108 = 1;
            }

            [(IDSGlobalLink *)self _sendCommandMessage:v108 stunMessage:0 options:0 candidatePairToken:v7, v126, v129, v131, v132, v133];
          }

          goto LABEL_200;
        }

        v76 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&v151];
        if (v76)
        {
          v77 = [v10 linkUUID];
          if (([v76 isEqual:v77] & 1) == 0)
          {
            isInitiator = self->_isInitiator;

            if (isInitiator)
            {
              goto LABEL_163;
            }

            [v10 setLinkUUID:v76];
            v79 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
            {
              v80 = [v10 candidatePairToken];
              *v141 = 138412546;
              *&v141[4] = v76;
              *&v141[12] = 2112;
              *&v141[14] = v80;
              _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "update linkUUID %@ for %@.", v141, 0x16u);
            }

            if (!os_log_shim_legacy_logging_enabled())
            {
              goto LABEL_163;
            }

            if (!_IDSShouldLogTransport())
            {
              goto LABEL_163;
            }

            [v10 candidatePairToken];
            v125 = v76;
            v128 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
            _IDSLogTransport(@"GL", @"IDS", @"update linkUUID %@ for %@.");

            if (!_IDSShouldLog())
            {
              goto LABEL_163;
            }

            v77 = [v10 candidatePairToken];
            v125 = v76;
            v128 = *&v77;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update linkUUID %@ for %@.");
          }
        }

LABEL_163:

        goto LABEL_164;
      }
    }
  }

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    LOWORD(buf[0]) = 0;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair.");
      }
    }
  }

  v10 = 0;
LABEL_18:
}

- (void)_processCommandDisconnected:(id)a3 candidatePairToken:(id)a4
{
  v24 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = [v6 command];
  Value = 0;
  if (v7 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v7);
  }

  v10 = Value;
  v11 = v10;
  if (v8 == 2)
  {
    [v10 setRecvDisconnected:1];
    [(IDSGlobalLink *)self _sendCommandMessage:32770 stunMessage:0 options:0 candidatePairToken:v7];
    if (self->_allowOnlyOneQR && self->_state <= 4)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v19 = self;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Disconnecting IDSGlobalLink %@, remote side is disconnecting.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v15 = self;
          _IDSLogTransport(@"GL", @"IDS", @"Disconnecting IDSGlobalLink %@, remote side is disconnecting.");
          if (_IDSShouldLog())
          {
            v15 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Disconnecting IDSGlobalLink %@, remote side is disconnecting.");
          }
        }
      }

      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        v14 = _IDSLinkStateStrings[self->_state];
        *buf = 138412802;
        v19 = self;
        v20 = 2080;
        v21 = v14;
        v22 = 2080;
        v23 = off_1EB2B3E78[0];
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "update GL %@ state (%s->%s).", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v16 = _IDSLinkStateStrings[self->_state];
          v17 = off_1EB2B3E78[0];
          v15 = self;
          _IDSLogTransport(@"GL", @"IDS", @"update GL %@ state (%s->%s).");
          if (_IDSShouldLog())
          {
            v16 = _IDSLinkStateStrings[self->_state];
            v17 = off_1EB2B3E78[0];
            v15 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL %@ state (%s->%s).");
          }
        }
      }

      self->_state = 5;
      [(IDSGlobalLink *)self _sendCommandMessage:2 stunMessage:0 options:0 candidatePairToken:v7, v15, v16, v17];
      [(IDSGlobalLink *)self _startDisconnectTimer];
    }
  }

  else
  {
    [v10 setRecvDisconnectedAck:1];
  }

  if ([v11 recvDisconnected] && objc_msgSend(v11, "recvDisconnectedAck"))
  {
    [(IDSGlobalLink *)self _stopDisconnectTimer];
    [(IDSGlobalLink *)self _discardAllCandidatePairs:0];
  }
}

- (void)_processCommandHeartbeat:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5 remoteRelayLinkID:(unsigned __int16)a6
{
  v6 = a6;
  v97 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  v12 = [v10 command];
  Value = 0;
  v73 = self;
  if (v11 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v11);
  }

  v72 = v11;
  v14 = Value;
  bzero(v95, 0x410uLL);
  if ([v10 getAttribute:1 attribute:v95])
  {
    v15 = v96;
  }

  else
  {
    v15 = 0;
  }

  bzero(v91, 0x410uLL);
  v16 = 0;
  v17 = 0;
  v18 = 0;
  v19 = 0;
  if ([v10 getAttribute:10 attribute:v91])
  {
    v17 = ntpTime32(a5);
    v18 = bswap32(v93);
    v19 = bswap32(v92);
    v16 = bswap32(v94);
  }

  v71 = v10;
  if (v6)
  {
    v20 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v14 relayLinkID], v6);
    v21 = 0;
    if (v73->_localRemoteRelayLinkIDToVirtualCandidatePairs && v20)
    {
      v21 = CFDictionaryGetValue(v73->_localRemoteRelayLinkIDToVirtualCandidatePairs, v20);
    }

    v22 = [v21 linkID];
  }

  else
  {
    v22 = [v14 linkID];
  }

  if (v12 == 32771)
  {
    v26 = [v14 linkEngine];

    if (v26)
    {
      if (([v14 hasReceivedData] & 1) == 0)
      {
        [(IDSGlobalLink *)v73 didReceiveFirstDataOnCandidatePair:v14];
      }
    }

    else if ([v14 pendingRealloc])
    {
      v27 = [v14 local];
      v28 = [v27 address];

      v29 = [v14 remote];
      v30 = [v29 external];

      -[IDSGlobalLink _processDataOnReallocChannel:localAddress:remoteAddress:](v73, "_processDataOnReallocChannel:localAddress:remoteAddress:", [v14 channelNumber], v28, v30);
    }

    if (v18)
    {
      v31 = vcvtd_n_f64_u32((v17 - (v16 + v18)), 0x10uLL) + ((v17 - (v16 + v18)) >> 16);
      v32 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        v33 = [v14 isActive];
        *buf = 67110658;
        v34 = @"NO";
        *v81 = v22;
        *&v81[4] = 1024;
        if (v33)
        {
          v34 = @"YES";
        }

        *&v81[6] = v15;
        v82 = 2112;
        *v83 = v34;
        *&v83[8] = 1024;
        *v84 = v17;
        *&v84[4] = 1024;
        v85 = v18;
        v86 = 1024;
        v87 = v16;
        v88 = 2048;
        v89 = v31;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "receive rtt response on link %d (counter:%04x active:%@ a:%08x e:%08x, d:%08x), rtt:%.6f sec).", buf, 0x34u);
      }
    }

    else
    {
      v31 = 0.0;
    }

    if (v22 < 1)
    {
      goto LABEL_68;
    }

    v35 = [MEMORY[0x1E696AD98] numberWithChar:v22];
    v36 = 0;
    if (v73->_linkIDToHBCounter && v35)
    {
      v36 = CFDictionaryGetValue(v73->_linkIDToHBCounter, v35);
    }

    v37 = [v36 unsignedShortValue];
    if (v15 - v37 >= 0x8000)
    {
      if (v37 == v15)
      {
LABEL_50:
        v43 = 0;
        if (v73->_linkIDToRequestTimeStampAndRTT && v35)
        {
          v43 = CFDictionaryGetValue(v73->_linkIDToRequestTimeStampAndRTT, v35);
        }

        key = v35;
        v74 = 0u;
        v75 = 0u;
        v76 = 0u;
        v77 = 0u;
        v44 = v43;
        v45 = [v44 countByEnumeratingWithState:&v74 objects:v79 count:16];
        if (v45)
        {
          v46 = v45;
          v47 = *v75;
          while (2)
          {
            for (i = 0; i != v46; ++i)
            {
              if (*v75 != v47)
              {
                objc_enumerationMutation(v44);
              }

              v49 = *(*(&v74 + 1) + 8 * i);
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v50 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v18];
                v51 = [v49 isEqualToNumber:v50];

                if (v51)
                {
                  v52 = [v44 indexOfObject:v49];
                  v53 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v18];
                  v78[0] = v53;
                  v54 = [MEMORY[0x1E696AD98] numberWithDouble:v31];
                  v78[1] = v54;
                  v55 = [MEMORY[0x1E695DEC8] arrayWithObjects:v78 count:2];
                  [v44 replaceObjectAtIndex:v52 withObject:v55];

                  if (!v73->_linkIDToRequestTimeStampAndRTT)
                  {
                    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                    linkIDToRequestTimeStampAndRTT = v73->_linkIDToRequestTimeStampAndRTT;
                    v73->_linkIDToRequestTimeStampAndRTT = Mutable;
                  }

                  if (v44)
                  {
                    CFDictionarySetValue(v73->_linkIDToRequestTimeStampAndRTT, key, v44);
                  }

                  goto LABEL_67;
                }
              }
            }

            v46 = [v44 countByEnumeratingWithState:&v74 objects:v79 count:{16, key, v71}];
            if (v46)
            {
              continue;
            }

            break;
          }
        }

LABEL_67:

LABEL_68:
        if (v14 && [v14 hbStarted])
        {
          [v14 setHbStarted:0];
          [v14 setHbStartTime:0.0];
          v58 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v58, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v81 = v72;
            _os_log_impl(&dword_1A7AD9000, v58, OS_LOG_TYPE_DEFAULT, "stop HB request for %@.", buf, 0xCu);
          }

          if ([v14 isActive])
          {
            if (v31 > 0.0)
            {
              v59 = v31 * 1000.0;
              GLUtilReportAWDActiveLinkRTT(v14, v73->_enableSKE, v73->_isInitiator, v59);
              v24 = GLUCreateQRActiveLinkRTTEvent(v14, v59);
              WeakRetained = objc_loadWeakRetained(&v73->_delegate);
              v61 = objc_opt_respondsToSelector();

              if (v61)
              {
                v62 = objc_loadWeakRetained(&v73->_delegate);
                [v62 link:v73 didAddQREvent:v24];
              }

              goto LABEL_99;
            }
          }
        }

        goto LABEL_100;
      }

      v39 = 0;
      p_linkIDToReorderedPackets = &v73->_linkIDToReorderedPackets;
      if (v73->_linkIDToReorderedPackets && v35)
      {
        v39 = CFDictionaryGetValue(v73->_linkIDToReorderedPackets, v35);
      }

      v15 = [v39 unsignedShortValue] + 1;
    }

    else
    {
      p_linkIDToReorderedPackets = &v73->_linkIDToHBCounter;
    }

    if (!*p_linkIDToReorderedPackets)
    {
      v40 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v41 = *p_linkIDToReorderedPackets;
      *p_linkIDToReorderedPackets = v40;
    }

    v42 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v15];
    if (v42)
    {
      CFDictionarySetValue(*p_linkIDToReorderedPackets, v35, v42);
    }

    goto LABEL_50;
  }

  if (v12 == 3)
  {
    v23 = v15;
    if (v15)
    {
      v24 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v25 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v15];
      if (v25)
      {
        CFDictionarySetValue(v24, @"gl-attr-counter", v25);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15878();
      }

      if (!v19)
      {
        goto LABEL_88;
      }
    }

    else
    {
      v24 = 0;
      if (!v19)
      {
LABEL_88:
        if (v6)
        {
          v68 = [MEMORY[0x1E696AD98] numberWithChar:v22];
          if (v68)
          {
            CFDictionarySetValue(v24, @"gl-attr-active-probing-link-id", v68);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15988();
          }

          v69 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v6];
          if (v69)
          {
            CFDictionarySetValue(v24, @"gl-attr-remote-relay-link-id", v69);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15A10();
          }
        }

        [(IDSGlobalLink *)v73 _sendCommandMessage:32771 stunMessage:0 options:v24 candidatePairToken:v72];
LABEL_99:

        goto LABEL_100;
      }
    }

    v90[0] = 0;
    v90[1] = bswap32(v19);
    v63 = ids_monotonic_time();
    v64 = ntpTime32(v63);
    v65 = v64 - ntpTime32(a5);
    v90[2] = bswap32(v65);
    if (!v24)
    {
      v24 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    }

    v66 = [MEMORY[0x1E695DEF0] dataWithBytes:v90 length:12];
    if (v66)
    {
      CFDictionarySetValue(v24, @"gl-attr-rttreport", v66);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15900();
    }

    v67 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67110144;
      *v81 = v22;
      *&v81[4] = 1024;
      *&v81[6] = v23;
      v82 = 1024;
      *v83 = v19;
      *&v83[4] = 1024;
      *&v83[6] = v19;
      *v84 = 1024;
      *&v84[2] = v65;
      _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "receive rtt request on link %d (counter:%04x m:%08x), send resp (e:%08x d:%08x).", buf, 0x20u);
    }

    goto LABEL_88;
  }

LABEL_100:
}

- (void)_processCommandConnectionData:(id)a3 candidatePairToken:(id)a4
{
  __b[129] = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v34 = 0;
  if (GLUtilHasValidUInt16Attr(v6, 1, &v34))
  {
    if (self->_isUPlusOneSession && !self->_receivedRemoteDeviceVersion)
    {
      v19 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        LOWORD(__b[0]) = 0;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "[U+1] no remote device version received yet. Saving incoming ConnectionData[Ack] for later", __b, 2u);
      }

      objc_initWeak(__b, self);
      aBlock[0] = MEMORY[0x1E69E9820];
      aBlock[1] = 3221225472;
      aBlock[2] = sub_1A7B995F8;
      aBlock[3] = &unk_1E77E0FA0;
      objc_copyWeak(&v33, __b);
      v31 = v6;
      v32 = v7;
      v20 = _Block_copy(aBlock);
      pendingCommandConnectionDataBlock = self->_pendingCommandConnectionDataBlock;
      self->_pendingCommandConnectionDataBlock = v20;

      objc_destroyWeak(&v33);
      objc_destroyWeak(__b);
    }

    else if ([v6 command] == 4)
    {
      memset(__b, 170, 0x400uLL);
      v29 = 0;
      if (GLUtilHasValidBinaryDataAttr(v6, 3, __b, &v29))
      {
        v8 = MEMORY[0x1E695DF20];
        v9 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v34];
        v10 = [v8 dictionaryWithObject:v9 forKey:@"gl-attr-counter"];

        [(IDSGlobalLink *)self _sendCommandMessage:32772 stunMessage:0 options:v10 candidatePairToken:v7];
        if (self->_allowP2P || self->_useLinkEngine)
        {
          if (self->_remoteConnDataCounter < v34)
          {
            self->_remoteConnDataCounter = v34;
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109376;
              v36 = v34;
              v37 = 2048;
              v38 = v29;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receive connection data(count:%u, length:%zdB).", buf, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v27 = v34;
                v28 = v29;
                _IDSLogTransport(@"GL", @"IDS", @"receive connection data(count:%u, length:%zdB).");
                if (_IDSShouldLog())
                {
                  v27 = v34;
                  v28 = v29;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"receive connection data(count:%u, length:%zdB).");
                }
              }
            }

            v12 = [IDSStunConnectionDataController sharedInstance:v27];
            v13 = [MEMORY[0x1E695DEF0] dataWithBytes:__b length:v29];
            v14 = [v12 candidatesFromData:v13 token:self->_cbuuid];

            [(IDSGlobalLink *)self _processRemoteCandidates:v14];
            [(IDSGlobalLink *)self _setupRelayConnectionForNetworkAddressChanges];
            goto LABEL_38;
          }

          v14 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 67109120;
            v36 = v34;
            v24 = "receive old conn data(count:%u), ignore.";
            v25 = v14;
            v26 = 8;
LABEL_37:
            _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, v24, buf, v26);
          }
        }

        else
        {
          v14 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            v24 = "P2P is not allowed, skip processing remote connection data.";
            v25 = v14;
            v26 = 2;
            goto LABEL_37;
          }
        }

LABEL_38:

        goto LABEL_19;
      }

      v22 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid data.", buf, 2u);
      }
    }

    else
    {
      v16 = self->_localConnDataCounter > v34;
      v17 = +[IDSFoundationLog GlobalLink];
      v18 = os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT);
      if (v16)
      {
        if (v18)
        {
          LODWORD(__b[0]) = 67109120;
          HIDWORD(__b[0]) = v34;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive connection data ack(count:%u), ignore.", __b, 8u);
        }
      }

      else
      {
        if (v18)
        {
          LODWORD(__b[0]) = 67109120;
          HIDWORD(__b[0]) = v34;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive connection data ack(count:%u).", __b, 8u);
        }

        v23 = +[IDSStunConnectionDataController sharedInstance];
        [v23 setDeliveryStatus:self->_cbuuid status:2];
      }
    }
  }

  else
  {
    v15 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      LOWORD(__b[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid counter.", __b, 2u);
    }
  }

LABEL_19:
}

- (void)_processCommandNominate:(id)a3 candidatePairToken:(id)a4
{
  v33 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = [v6 command];
  bzero(v31, 0x410uLL);
  if ([v6 getAttribute:1 attribute:v31])
  {
    v9 = v32;
    if (v7 && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v11 = CFDictionaryGetValue(tokenToCandidatePairs, v7)) != 0)
    {
      v12 = v11;
      v13 = 1;
    }

    else
    {
      if (!v7 || (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) == 0 || (v16 = CFDictionaryGetValue(tokenToStunCheckPairs, v7)) == 0)
      {
        v18 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109378;
          v28 = v8;
          v29 = 2112;
          v30 = v7;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "failed to process session command %04x due to invalid candidate pair for %@.", buf, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to process session command %04x due to invalid candidate pair for %@.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process session command %04x due to invalid candidate pair for %@.");
            }
          }
        }

        v12 = 0;
        goto LABEL_31;
      }

      v12 = v16;
      v13 = 0;
    }

    if (v8 == 5)
    {
      if (self->_isInitiator)
      {
        v17 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive nomination while being Initiator, this shouldn't happen.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive nomination while being Initiator, this shouldn't happen.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination while being Initiator, this shouldn't happen.");
            }
          }
        }
      }

      else if (self->_nominateCount <= v9)
      {
        v23 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive new nomination #%d.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v26 = v9;
            _IDSLogTransport(@"GL", @"IDS", @"receive new nomination #%d.");
            if (_IDSShouldLog())
            {
              v26 = v9;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new nomination #%d.");
            }
          }
        }

        self->_nominateCount = v9;
        [(IDSGlobalLink *)self _updateNominatedCandidatePair:v7, v26];
        v24 = objc_alloc_init(MEMORY[0x1E695DF90]);
        v25 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v9];
        if (v25)
        {
          CFDictionarySetValue(v24, @"gl-attr-counter", v25);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15878();
        }

        [(IDSGlobalLink *)self _sendCommandMessage:32773 stunMessage:0 options:v24 candidatePairToken:v7];
        if (v13 && ([v12 isActive] & 1) == 0)
        {
          [(IDSGlobalLink *)self _updateDefaultCandidatePair:v12];
          [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:v7 error:0];
        }
      }

      else
      {
        v20 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "receive old nomination #%d.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive old nomination #%d.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive old nomination #%d.");
            }
          }
        }
      }
    }

    else if (self->_isInitiator)
    {
      if (self->_nominateCount == v9)
      {
        v19 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "nomination #%d is accepted.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"nomination #%d is accepted.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"nomination #%d is accepted.");
            }
          }
        }

        if (v13 && ([v12 isActive] & 1) == 0)
        {
          [(IDSGlobalLink *)self _updateDefaultCandidatePair:v12];
          [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:v7 error:0];
        }
      }

      else
      {
        v22 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive nomination #%d ack, ignore.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive nomination #%d ack, ignore.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination #%d ack, ignore.");
            }
          }
        }
      }
    }

    else
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "receive nomination ack while being Receiver, this shouldn't happen.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"receive nomination ack while being Receiver, this shouldn't happen.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination ack while being Receiver, this shouldn't happen.");
          }
        }
      }
    }

LABEL_31:

    goto LABEL_32;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    v28 = v8;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "missing nominate count in command %04x.", buf, 8u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"missing nominate count in command %04x.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"missing nominate count in command %04x.");
      }
    }
  }

LABEL_32:
}

- (void)_processCommandTestPacket:(id)a3 candidatePairToken:(id)a4 remoteRelayLinkID:(unsigned __int16)a5
{
  v5 = a5;
  v32 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:v9];
  if (v10 || v9 && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v10 = CFDictionaryGetValue(tokenToStunCheckPairs, v9)) != 0)
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = v5;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "test packet remote relay link id: %u", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v24 = v5;
        _IDSLogTransport(@"GL", @"IDS", @"test packet remote relay link id: %u");
        if (_IDSShouldLog())
        {
          v24 = v5;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"test packet remote relay link id: %u");
        }
      }
    }

    if (v5 && (localRemoteRelayLinkIDForVirtualStunCandidatePair([v10 relayLinkID], v5), v12 = objc_claimAutoreleasedReturnValue(), -[NSMutableDictionary objectForKeyedSubscript:](self->_localRemoteRelayLinkIDToVirtualCandidatePairs, "objectForKeyedSubscript:", v12), v13 = objc_claimAutoreleasedReturnValue(), v10, v12, (v10 = v13) == 0))
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *&buf[4] = v9;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to process command test packet due to invalid VR candidate pair for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to process command test packet due to invalid VR candidate pair for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process command test packet due to invalid VR candidate pair for %@.");
          }
        }
      }
    }

    else
    {
      memset(buf, 170, 0x400uLL);
      v26 = 0;
      if (GLUtilHasValidBinaryDataAttr(v8, 15, buf, &v26))
      {
        v14 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:v26];
        v15 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          v16 = [v14 length];
          *v27 = 134218242;
          v28 = v16;
          v29 = 2112;
          v30 = v9;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Received %lu byte test packet for candidate pair for %@.", v27, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v24 = [v14 length];
            v25 = v9;
            _IDSLogTransport(@"GL", @"IDS", @"Received %lu byte test packet for candidate pair for %@.");
            if (_IDSShouldLog())
            {
              v24 = [v14 length:v24];
              v25 = v9;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Received %lu byte test packet for candidate pair for %@.");
            }
          }
        }

        [v10 receiveLinkTestStatsPacket:{v14, v24, v25}];
        if (self->_useLinkSelection)
        {
          v17 = [v10 linkEngine];
          v18 = v17 == 0;

          if (!v18)
          {
            v19 = [v10 linkEngine];
            v20 = [v10 linkUniqueName];
            [v19 didReceiveStatsTestPacketWithPayload:v14 linkName:v20 completionHandler:&unk_1F1AAA460];
          }
        }
      }

      else
      {
        v14 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
        {
          *v27 = 0;
          _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid data.", v27, 2u);
        }
      }
    }
  }

  else
  {
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v9;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "failed to process command test packet due to invalid candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to process command test packet due to invalid candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process command test packet due to invalid candidate pair for %@.");
        }
      }
    }
  }
}

- (void)_sendConnectionDataWithRemovedAddressList:(id)a3
{
  v12 = *MEMORY[0x1E69E9840];
  v4 = a3;
  delayFirstConnectionData = self->_delayFirstConnectionData;
  if (delayFirstConnectionData < 1)
  {
    if (!delayFirstConnectionData)
    {
      [(IDSGlobalLink *)self _sendNowConnectionDataWithRemovedAddressList:v4];
    }
  }

  else
  {
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = self->_delayFirstConnectionData;
      *buf = 134217984;
      v11 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "delaying first connection data transmission by %lu ms", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"delaying first connection data transmission by %lu ms");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"delaying first connection data transmission by %lu ms");
        }
      }
    }

    v8[0] = MEMORY[0x1E69E9820];
    v8[1] = 3221225472;
    v8[2] = sub_1A7B9A700;
    v8[3] = &unk_1E77E0250;
    v8[4] = self;
    v9 = v4;
    IDSTransportThreadAddBlockAfter(v8, self->_delayFirstConnectionData / 1000.0);
    self->_delayFirstConnectionData = -self->_delayFirstConnectionData;
  }
}

- (void)_sendNowConnectionDataWithRemovedAddressList:(id)a3
{
  v57 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v41 = v4;
  if (self->_allowP2P || self->_useLinkEngine)
  {
    v44 = self;
    self->_delayedConnData = 1;
    v49 = 0u;
    v50 = 0u;
    v51 = 0u;
    v52 = 0u;
    v5 = v4;
    v6 = [v5 countByEnumeratingWithState:&v49 objects:v56 count:16];
    v7 = 0;
    if (v6)
    {
      v8 = *v50;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v50 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v49 + 1) + 8 * i);
          v11 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index", v39, v40)}];
          v12 = [v7 containsObject:v11];

          if ((v12 & 1) == 0)
          {
            if (v7 || (v7 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              v13 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index")}];
              v14 = v13 == 0;

              if (!v14)
              {
                v15 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index")}];
                CFArrayAppendValue(v7, v15);
              }
            }

            v16 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
            {
              v17 = [v10 name];
              v18 = [v10 index];
              *buf = 138412546;
              *v55 = v17;
              *&v55[8] = 1024;
              *&v55[10] = v18;
              _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "removed if_index [%@:%d].", buf, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v39 = [v10 name];
                v40 = [v10 index];
                _IDSLogTransport(@"GL", @"IDS", @"removed if_index [%@:%d].");

                if (_IDSShouldLog())
                {
                  v39 = [v10 name];
                  v40 = [v10 index];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"removed if_index [%@:%d].");
                }
              }
            }
          }
        }

        v6 = [v5 countByEnumeratingWithState:&v49 objects:v56 count:16];
      }

      while (v6);
    }

    [(NSMutableDictionary *)v44->_tokenToCandidatePairs allValues];
    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    obj = v46 = 0u;
    v19 = [obj countByEnumeratingWithState:&v45 objects:v53 count:16];
    if (!v19)
    {
      v42 = 0;
      goto LABEL_46;
    }

    v20 = 0;
    v42 = 0;
    v21 = *v46;
    while (1)
    {
      for (j = 0; j != v19; ++j)
      {
        if (*v46 != v21)
        {
          objc_enumerationMutation(obj);
        }

        v23 = *(*(&v45 + 1) + 8 * j);
        v24 = [v23 local];
        v25 = [v24 index];

        v26 = [v23 state];
        v27 = [MEMORY[0x1E696AD98] numberWithInt:v25];
        v28 = [v7 containsObject:v27];

        if ((v28 & 1) == 0)
        {
          if ([v23 isRelayStunCandidatePair])
          {
            if (v26 != 4)
            {
              continue;
            }
          }

          else if (v26 != 3)
          {
            continue;
          }

          v29 = [v23 candidatePairToken];

          if ((v20 & 1) == 0)
          {
            v30 = +[IDSStunConnectionDataController sharedInstance];
            [v30 removeData:v44->_cbuuid];

            ++v44->_localConnDataCounter;
          }

          if (v29)
          {
            v44->_delayedConnData = 0;
            v31 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
            {
              localConnDataCounter = v44->_localConnDataCounter;
              *buf = 67109378;
              *v55 = localConnDataCounter;
              *&v55[4] = 2112;
              *&v55[6] = v29;
              _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "send connection data (count:%d) using %@.", buf, 0x12u);
            }

            v33 = v44;
            if (os_log_shim_legacy_logging_enabled())
            {
              v33 = v44;
              if (_IDSShouldLogTransport())
              {
                v39 = v44->_localConnDataCounter;
                v40 = v29;
                _IDSLogTransport(@"GL", @"IDS", @"send connection data (count:%d) using %@.");
                v33 = v44;
                if (_IDSShouldLog())
                {
                  v39 = v44->_localConnDataCounter;
                  v40 = v29;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"send connection data (count:%d) using %@.");
                  v33 = v44;
                }
              }
            }

            v34 = MEMORY[0x1E695DF20];
            v35 = [MEMORY[0x1E696AD98] numberWithInt:{v33->_localConnDataCounter, v39, v40}];
            v39 = @"gl-attr-counter";
            v40 = 0;
            v36 = [v34 dictionaryWithObjectsAndKeys:v35];

            [(IDSGlobalLink *)v44 _sendCommandMessage:4 stunMessage:0 options:v36 candidatePairToken:v29];
            v20 = 1;
            v42 = v29;
          }

          else
          {
            v42 = 0;
            v20 = 1;
          }
        }
      }

      v19 = [obj countByEnumeratingWithState:&v45 objects:v53 count:16];
      if (!v19)
      {
LABEL_46:

        if (v44->_delayedConnData)
        {
          v37 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "delay sending connection data, no link is available.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"delay sending connection data, no link is available.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"delay sending connection data, no link is available.");
              }
            }
          }
        }

        goto LABEL_54;
      }
    }
  }

  v38 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "P2P is not allowed, skip sending connection data.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"P2P is not allowed, skip sending connection data.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"P2P is not allowed, skip sending connection data.");
      }
    }
  }

LABEL_54:
}

- (void)_handleDisconnectTimer
{
  v8 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    disconnectTimer = self->_disconnectTimer;
    *buf = 134217984;
    v7 = disconnectTimer;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "disconnect timer %p fired.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v5 = self->_disconnectTimer;
      _IDSLogTransport(@"GL", @"IDS", @"disconnect timer %p fired.");
      if (_IDSShouldLog())
      {
        v5 = self->_disconnectTimer;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect timer %p fired.");
      }
    }
  }

  [(IDSGlobalLink *)self _discardAllCandidatePairs:0, v5];
  [(IDSGlobalLink *)self _stopDisconnectTimer];
}

- (void)_handleDisconnect:(BOOL)a3
{
  [(IDSGlobalLink *)self _discardAllCandidatePairs:a3];

  [(IDSGlobalLink *)self _stopDisconnectTimer];
}

- (void)_startDisconnectTimer
{
  v15 = *MEMORY[0x1E69E9840];
  disconnectTimer = self->_disconnectTimer;
  if (disconnectTimer)
  {
    dispatch_source_cancel(disconnectTimer);
  }

  v4 = im_primary_queue();
  v5 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v4);
  v6 = self->_disconnectTimer;
  self->_disconnectTimer = v5;

  v7 = self->_disconnectTimer;
  v8 = dispatch_time(0, 3000000000);
  dispatch_source_set_timer(v7, v8, 0xB2D05E00uLL, 0x5F5E100uLL);
  v9 = self->_disconnectTimer;
  handler[0] = MEMORY[0x1E69E9820];
  handler[1] = 3221225472;
  handler[2] = sub_1A7B9B294;
  handler[3] = &unk_1E77E0818;
  handler[4] = self;
  dispatch_source_set_event_handler(v9, handler);
  dispatch_resume(self->_disconnectTimer);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = self->_disconnectTimer;
    *buf = 134217984;
    v14 = v11;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "start disconnect timer %p.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    _IDSLogTransport(@"GL", @"IDS", @"start disconnect timer %p.");
    if (_IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"start disconnect timer %p.");
    }
  }
}

- (void)_stopDisconnectTimer
{
  v9 = *MEMORY[0x1E69E9840];
  disconnectTimer = self->_disconnectTimer;
  if (disconnectTimer)
  {
    dispatch_source_cancel(disconnectTimer);
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = self->_disconnectTimer;
      *buf = 134217984;
      v8 = v5;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop disconnect timer %p.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop disconnect timer %p.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop disconnect timer %p.");
      }
    }

    v6 = self->_disconnectTimer;
    self->_disconnectTimer = 0;
  }
}

- (void)_schedulePacketLogFlush
{
  if (self->_packetLog)
  {
    objc_initWeak(&location, self);
    v2[0] = MEMORY[0x1E69E9820];
    v2[1] = 3221225472;
    v2[2] = sub_1A7B9B520;
    v2[3] = &unk_1E77E0FC8;
    objc_copyWeak(&v3, &location);
    IDSTransportThreadAddBlockAfter(v2, 3.0);
    objc_destroyWeak(&v3);
    objc_destroyWeak(&location);
  }
}

- (void)_flushPacketLogTick
{
  packetLog = self->_packetLog;
  if (packetLog && self->_state <= 4)
  {
    [(IDSObjCPacketLog *)packetLog flush];

    [(IDSGlobalLink *)self _schedulePacketLogFlush];
  }
}

- (void)_handleActivityTimer
{
  v69 = *MEMORY[0x1E69E9840];
  v3 = ids_monotonic_time();
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    activityTimer = self->_activityTimer;
    *buf = 134218240;
    v63 = activityTimer;
    v64 = 2048;
    v65 = v3;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "activity timer %p fired (%.6f).", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v52 = v3;
      v50 = self->_activityTimer;
      _IDSLogTransport(@"GL", @"IDS", @"activity timer %p fired (%.6f).");
      if (_IDSShouldLog())
      {
        v52 = v3;
        v50 = self->_activityTimer;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"activity timer %p fired (%.6f).");
      }
    }
  }

  if (self->_state != 4)
  {
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v63 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "GL state is [%s], stop activity timer.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v50 = _IDSLinkStateStrings[self->_state];
        _IDSLogTransport(@"GL", @"IDS", @"GL state is [%s], stop activity timer.");
        if (_IDSShouldLog())
        {
          v50 = _IDSLinkStateStrings[self->_state];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"GL state is [%s], stop activity timer.");
        }
      }
    }

    [(IDSGlobalLink *)self _stopActivityTimer:v50];
  }

  v60 = 0u;
  v61 = 0u;
  v58 = 0u;
  v59 = 0u;
  obj = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = [obj countByEnumeratingWithState:&v58 objects:v68 count:16];
  if (!v8)
  {

    return;
  }

  v9 = *v59;
  v10 = 0.0;
  do
  {
    for (i = 0; i != v8; ++i)
    {
      if (*v59 != v9)
      {
        objc_enumerationMutation(obj);
      }

      v12 = *(*(&v58 + 1) + 8 * i);
      v13 = [v12 state];
      v14 = [v12 isActive];
      v15 = [v12 isRelayStunCandidatePair];
      v16 = [v12 isSelfQRSession];
      v17 = [v12 isSharedQRSession];
      if (((v13 - 5) < 0xFFFFFFFFFFFFFFFELL) | v16 & 1)
      {
        continue;
      }

      v18 = v17;
      v19 = [MEMORY[0x1E69A60F0] sharedInstance];
      v20 = [v19 isInternalInstall];

      if (v20)
      {
        [v12 testStartTime];
        if (v21 != 0.0)
        {
          [v12 testStartTime];
          if (v3 >= v22)
          {
            if ([v12 isQUIC])
            {
              [v12 sendQUICTestRequest];
            }

            else
            {
              [v12 sendTestRequest:0];
            }
          }
        }
      }

      [v12 lastOutgoingPacketTime];
      v56 = v23;
      [v12 lastIncomingPacketTime];
      v54 = v24;
      [v12 lastStatsReport];
      v26 = v25;
      v27 = [v12 linkID];
      v28.f64[0] = v56;
      v28.f64[1] = v54;
      v57 = v28;
      if (v27)
      {
        v29 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v27);
        v30 = v29;
        if (v29)
        {
          v55 = v29[19];
          if (v26 < v29[20].f64[0])
          {
            v26 = v29[20].f64[0];
          }

          [v12 setTotalPacketsSentOnLink:LODWORD(v29[20].f64[1])];
          [v12 setTotalPacketsReceivedOnLink:HIDWORD(v30[20].f64[1])];
          v57 = vbslq_s8(vcgtq_f64(v55, v57), v55, v57);
        }

        if (v14)
        {
LABEL_33:
          v31 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          v32 = v31;
          if (v31)
          {
            v57 = vbslq_s8(vcgtq_f64(v31[19], v57), v31[19], v57);
            if (v26 < v31[20].f64[0])
            {
              v26 = v31[20].f64[0];
            }
          }

          goto LABEL_39;
        }
      }

      else
      {
        v30 = 0;
        if (v14)
        {
          goto LABEL_33;
        }
      }

      v32 = 0;
LABEL_39:
      [v12 setLastOutgoingPacketTime:v57.f64[0]];
      [v12 setLastIncomingPacketTime:v57.f64[1]];
      if (v10 < v57.f64[1])
      {
        v10 = v57.f64[1];
      }

      if (!v15)
      {
        v40 = v57.f64[0];
        if (v57.f64[0] > 0.0)
        {
          natMappingTimeout = self->_natMappingTimeout;
          goto LABEL_57;
        }

LABEL_64:
        if (v57.f64[1] > 0.0 && v3 - v57.f64[1] >= 30.0 && ([v12 hbStarted] & 1) == 0)
        {
          v47 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
          {
            v48 = [v12 candidatePairToken];
            *buf = 138412546;
            v63 = v48;
            v64 = 2048;
            v65 = v3 - v57.f64[1];
            _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "%@ has no remote packet for %.6f sec, send HBR.", buf, 0x16u);
          }

          [(IDSGlobalLink *)self _startHB:v12];
        }

        continue;
      }

      if (v3 - v26 >= [v12 statsIntervalInSeconds])
      {
        if (v30)
        {
          v30[20].f64[0] = v3;
        }

        if (v32)
        {
          v32[20].f64[0] = v3;
        }

        [v12 setLastStatsReport:v3];
        if ([v12 isQUIC])
        {
          linkIDToStatsData = self->_linkIDToStatsData;
          v34 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-send", v27];
          v35 = [(NSMutableDictionary *)linkIDToStatsData objectForKeyedSubscript:v34];

          v36 = self->_linkIDToStatsData;
          v37 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-recv", v27];
          v38 = [(NSMutableDictionary *)v36 objectForKeyedSubscript:v37];

          if (v35 && v38)
          {
            [v35 unsignedIntValue];
            [v38 unsignedIntValue];
          }

          Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          [v12 sendQUICStatsRequestWithOptions:Mutable];
        }

        else
        {
          [v12 sendStatsRequest:0 options:0];
        }
      }

      if ((v18 & 1) == 0)
      {
        natMappingTimeout = 20.0;
        v40 = v57.f64[0];
        if (v57.f64[0] > 0.0)
        {
LABEL_57:
          v42 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
          {
            v43 = [v12 candidatePairToken];
            v44 = [v12 hbStarted];
            *buf = 138412802;
            v45 = @"NO";
            if (v44)
            {
              v45 = @"YES";
            }

            v63 = v43;
            v64 = 2048;
            v65 = v3 - v57.f64[0];
            v66 = 2112;
            v67 = v45;
            _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "%@ is idle for %.6f sec (hbStarted:%@).", buf, 0x20u);
          }

          if (v3 - v57.f64[0] >= natMappingTimeout && ([v12 hbStarted] & 1) == 0)
          {
            [v12 setHbStarted:1];
            v46 = [v12 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:v46];
          }
        }

        goto LABEL_64;
      }
    }

    v8 = [obj countByEnumeratingWithState:&v58 objects:v68 count:16];
  }

  while (v8);

  if (v10 != 0.0 && v3 - v10 >= 60.0)
  {
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v63) = 60;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "No remote packets for %d seconds.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v51 = 60;
      _IDSLogTransport(@"GL", @"IDS", @"No remote packets for %d seconds.");
      if (_IDSShouldLog())
      {
        v51 = 60;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"No remote packets for %d seconds.");
      }
    }

    [(IDSGlobalLink *)self _handleNoRemotePacket];
  }
}

- (void)_startActivityTimer
{
  v15 = *MEMORY[0x1E69E9840];
  activityTimer = self->_activityTimer;
  if (activityTimer)
  {
    dispatch_source_cancel(activityTimer);
  }

  v4 = im_primary_queue();
  v5 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v4);
  v6 = self->_activityTimer;
  self->_activityTimer = v5;

  v7 = self->_activityTimer;
  v8 = dispatch_time(0, 5000000000);
  dispatch_source_set_timer(v7, v8, 0x12A05F200uLL, 0x5F5E100uLL);
  v9 = self->_activityTimer;
  handler[0] = MEMORY[0x1E69E9820];
  handler[1] = 3221225472;
  handler[2] = sub_1A7B9C0CC;
  handler[3] = &unk_1E77E0818;
  handler[4] = self;
  dispatch_source_set_event_handler(v9, handler);
  dispatch_resume(self->_activityTimer);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = self->_activityTimer;
    *buf = 134217984;
    v14 = v11;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "start activity timer %p.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    _IDSLogTransport(@"GL", @"IDS", @"start activity timer %p.");
    if (_IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"start activity timer %p.");
    }
  }
}

- (void)_stopActivityTimer
{
  v9 = *MEMORY[0x1E69E9840];
  activityTimer = self->_activityTimer;
  if (activityTimer)
  {
    dispatch_source_cancel(activityTimer);
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = self->_activityTimer;
      *buf = 134217984;
      v8 = v5;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop activity timer %p.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop activity timer %p.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop activity timer %p.");
      }
    }

    v6 = self->_activityTimer;
    self->_activityTimer = 0;
  }
}

- (void)_addStunCheckPair:(id)a3 isRemoteCandidate:(BOOL)a4 excludeLocalAddress:(sockaddr *)a5
{
  v5 = a4;
  v77 = *MEMORY[0x1E69E9840];
  v7 = a3;
  if (!self->_allowP2P)
  {
    goto LABEL_92;
  }

  v8 = 1464;
  if (v5)
  {
    v8 = 1456;
  }

  v9 = *(&self->super.isa + v8);
  v52 = v7;
  v55 = v5;
  v54 = self;
  v47 = v9;
  if (!v5)
  {
    goto LABEL_18;
  }

  v10 = [(NSMutableArray *)v7 external];
  v11 = [(NSMutableArray *)v7 hasNATIPv4External];
  v64 = 0u;
  v65 = 0u;
  v66 = 0u;
  v67 = 0u;
  obj = self->_localCandidateList;
  v12 = [(NSMutableArray *)obj countByEnumeratingWithState:&v64 objects:v76 count:16];
  if (!v12)
  {
LABEL_17:

    v9 = v47;
LABEL_18:
    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    obj = v9;
    v53 = [(NSMutableArray *)obj countByEnumeratingWithState:&v60 objects:v75 count:16];
    if (!v53)
    {
      goto LABEL_91;
    }

    v17 = v55;
    if (!a5)
    {
      v17 = 0;
    }

    v49 = v17;
    v51 = *v61;
    while (1)
    {
      for (i = 0; i != v53; ++i)
      {
        if (*v61 != v51)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v60 + 1) + 8 * i);
        if (v55)
        {
          v20 = *(*(&v60 + 1) + 8 * i);
        }

        else
        {
          v20 = v52;
        }

        if (v55)
        {
          v21 = v52;
        }

        else
        {
          v21 = *(*(&v60 + 1) + 8 * i);
        }

        v22 = v20;
        v23 = v21;
        if ([(NSMutableArray *)v22 isCompatibleWithStunCandidate:v23]&& (!v49 || !IsSameSA([(NSMutableArray *)v22 address], a5)))
        {
          if (!v55)
          {
            v24 = [v19 external];
            v25 = [v19 hasNATIPv4External];
            v58 = 0u;
            v59 = 0u;
            v56 = 0u;
            v57 = 0u;
            v26 = v54->_localCandidateList;
            v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v56 objects:v74 count:16];
            if (v27)
            {
              v28 = *v57;
              while (2)
              {
                for (j = 0; j != v27; ++j)
                {
                  if (*v57 != v28)
                  {
                    objc_enumerationMutation(v26);
                  }

                  v30 = *(*(&v56 + 1) + 8 * j);
                  v31 = [v30 address];
                  if (v25)
                  {
                    if (IsSameIP(v31, v24))
                    {
                      goto LABEL_65;
                    }
                  }

                  else if (IsSameSA(v31, v24))
                  {
LABEL_65:
                    v41 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
                    {
                      *buf = 138412802;
                      v69 = v22;
                      v70 = 2112;
                      v71 = v23;
                      v72 = 2112;
                      v73 = v30;
                      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)", buf, 0x20u);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v45 = v23;
                        v46 = v30;
                        v44 = v22;
                        _IDSLogTransport(@"GL", @"IDS", @"skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)");
                        if (_IDSShouldLog())
                        {
                          v45 = v23;
                          v46 = v30;
                          v44 = v22;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)");
                        }
                      }
                    }

                    goto LABEL_81;
                  }
                }

                v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v56 objects:v74 count:16];
                if (v27)
                {
                  continue;
                }

                break;
              }
            }
          }

          v26 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v22 remoteCandidate:v23 sessionID:v54->_cbuuid delegate:v44];
          if (v54->_isInitiator)
          {
            v32 = [MEMORY[0x1E696AFB0] UUID];
            [(NSMutableArray *)v26 setLinkUUID:v32];
          }

          if ((-[NSMutableArray hasNATIPv4Address](v22, "hasNATIPv4Address") & 1) == 0 && [v23 hasNATIPv4External])
          {
            v33 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
            {
              v34 = [(NSMutableArray *)v26 candidatePairToken];
              *buf = 138412290;
              v69 = v34;
              _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "skip stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v44 = [(NSMutableArray *)v26 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"skip stun check pair %@.");

                if (_IDSShouldLog())
                {
                  v44 = [(NSMutableArray *)v26 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"skip stun check pair %@.");
                }
              }
            }

            goto LABEL_81;
          }

          v35 = [(NSMutableArray *)v26 candidatePairToken];
          v36 = v54;
          tokenToStunCheckPairs = v54->_tokenToStunCheckPairs;
          if (tokenToStunCheckPairs && v35)
          {
            if (!CFDictionaryGetValue(tokenToStunCheckPairs, v35))
            {
              v36 = v54;
              tokenToStunCheckPairs = v54->_tokenToStunCheckPairs;
              goto LABEL_61;
            }
          }

          else
          {
LABEL_61:
            if (!tokenToStunCheckPairs)
            {
              Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              v39 = v54->_tokenToStunCheckPairs;
              v54->_tokenToStunCheckPairs = Mutable;

              v36 = v54;
            }

            v40 = v26;
            if (v40)
            {
              CFDictionarySetValue(v36->_tokenToStunCheckPairs, v35, v40);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              *buf = 138412546;
              v69 = v35;
              v70 = 2080;
              v71 = "_tokenToStunCheckPairs";
              _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
            }

            v42 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v69 = v40;
              _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "add stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v44 = v40;
                _IDSLogTransport(@"GL", @"IDS", @"add stun check pair %@.");
                if (_IDSShouldLog())
                {
                  v44 = v40;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"add stun check pair %@.");
                }
              }
            }

            [(IDSGlobalLink *)v54 registerP2PCandidatePairWithLinkEngine:v40, v44];
            [(IDSGlobalLink *)v54 _startStunCheck:v35];
          }

LABEL_81:
        }
      }

      v53 = [(NSMutableArray *)obj countByEnumeratingWithState:&v60 objects:v75 count:16];
      if (!v53)
      {
        goto LABEL_91;
      }
    }
  }

  v13 = *v65;
LABEL_7:
  v14 = 0;
  while (1)
  {
    if (*v65 != v13)
    {
      objc_enumerationMutation(obj);
    }

    v15 = *(*(&v64 + 1) + 8 * v14);
    v16 = [v15 address];
    if (v11)
    {
      if (IsSameIP(v16, v10))
      {
        break;
      }

      goto LABEL_15;
    }

    if (IsSameSA(v16, v10) || IsSameIP([v15 external], v10))
    {
      break;
    }

LABEL_15:
    if (v12 == ++v14)
    {
      v12 = [(NSMutableArray *)obj countByEnumeratingWithState:&v64 objects:v76 count:16];
      if (!v12)
      {
        goto LABEL_17;
      }

      goto LABEL_7;
    }
  }

  v43 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v69 = v7;
    v70 = 2112;
    v71 = v15;
    _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "skip invalid remote candidate %@ (due to local candidate %@)", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip invalid remote candidate %@ (due to local candidate %@)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip invalid remote candidate %@ (due to local candidate %@)");
      }
    }
  }

LABEL_91:

  v7 = v52;
LABEL_92:
}

- (void)registerP2PCandidatePairWithLinkEngine:(id)a3
{
  v4 = a3;
  if (self->_useLinkEngine)
  {
    v7 = v4;
    v5 = [(IDSGlobalLink *)self p2pLinkEngine];
    v6 = [v5 addLinkForCandidatePair:v7];
    if (v6)
    {
      [v7 setLinkEngine:v5];
      [v7 setLinkUniqueName:v6];
    }

    v4 = v7;
  }
}

- (BOOL)_addCandidate:(id)a3 isRemoteCandidate:(BOOL)a4
{
  v4 = a4;
  v26 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = v6;
  if (!v6 || ([v6 isLinkLocalStunCandidate] & 1) != 0)
  {
    goto LABEL_3;
  }

  if (v4)
  {
    if (([(NSMutableArray *)self->_remoteCandidateList containsObject:v7]& 1) != 0)
    {
LABEL_3:
      v8 = 0;
      goto LABEL_4;
    }

    remoteCandidateList = self->_remoteCandidateList;
    if (remoteCandidateList || (v11 = objc_alloc_init(MEMORY[0x1E695DF70]), v12 = self->_remoteCandidateList, self->_remoteCandidateList = v11, v12, (remoteCandidateList = self->_remoteCandidateList) != 0))
    {
      CFArrayAppendValue(remoteCandidateList, v7);
    }

    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v23 = v7;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "add remote candidate %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"add remote candidate %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"add remote candidate %@.");
        }
      }
    }

    v8 = 1;
  }

  else
  {
    v14 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [v7 index]);
    if (self->_cellInterfaceName && [v7 isCellularStunCandidate] && (-[NSString isEqualToIgnoringCase:](self->_cellInterfaceName, "isEqualToIgnoringCase:", v14) & 1) == 0)
    {
      v20 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        cellInterfaceName = self->_cellInterfaceName;
        *buf = 138412546;
        v23 = v14;
        v24 = 2112;
        v25 = cellInterfaceName;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip adding currentInterfaceName to _localCandidateList", buf, 0x16u);
      }

      goto LABEL_3;
    }

    v15 = [(NSMutableArray *)self->_localCandidateList containsObject:v7];
    if ((v15 & 1) == 0)
    {
      if (-[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v7 index]))
      {
        [v7 setLinkFlags:{objc_msgSend(v7, "linkFlags") | 4}];
      }

      localCandidateList = self->_localCandidateList;
      if (localCandidateList || (v17 = objc_alloc_init(MEMORY[0x1E695DF70]), v18 = self->_localCandidateList, self->_localCandidateList = v17, v18, (localCandidateList = self->_localCandidateList) != 0))
      {
        CFArrayAppendValue(localCandidateList, v7);
      }

      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v23 = v7;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "add local candidate %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"add local candidate %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"add local candidate %@.");
          }
        }
      }
    }

    v8 = v15 ^ 1;
  }

LABEL_4:

  return v8;
}

- (BOOL)_hasActiveAllocbindFailoverTimerForSessionID:(id)a3
{
  v29 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = v5;
  if (v4)
  {
    v24 = 0u;
    v25 = 0u;
    v22 = 0u;
    v23 = 0u;
    v7 = v5;
    v8 = [v7 countByEnumeratingWithState:&v22 objects:v28 count:16];
    if (v8)
    {
      v9 = *v23;
      while (2)
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v23 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = *(*(&v22 + 1) + 8 * i);
          v12 = [v11 sessionID];
          v13 = [v12 isEqualToString:v4];

          if (v13)
          {
            v14 = [v11 allocbindFailoverTimer];

            if (v14)
            {
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                v18 = [v11 allocbindFailoverTimer];
                *buf = 134217984;
                v27 = v18;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "found active allocbind failover timer: %p", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v20 = [v11 allocbindFailoverTimer];
                  _IDSLogTransport(@"GL", @"IDS", @"found active allocbind failover timer: %p");

                  if (_IDSShouldLog())
                  {
                    v21 = [v11 allocbindFailoverTimer];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"found active allocbind failover timer: %p");
                  }
                }
              }

              v16 = 1;
              goto LABEL_26;
            }
          }
        }

        v8 = [v7 countByEnumeratingWithState:&v22 objects:v28 count:16];
        if (v8)
        {
          continue;
        }

        break;
      }
    }
  }

  else
  {
    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Couldn't find active allocbind failover timer due to invalid relaySessionID", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Couldn't find active allocbind failover timer due to invalid relaySessionID");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Couldn't find active allocbind failover timer due to invalid relaySessionID");
        }
      }
    }
  }

  v16 = 0;
LABEL_26:

  return v16;
}

- (void)_startAllocbindFailoverTimerOnCandidatePair:(id)a3 delay:(int)a4
{
  v37 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = v6;
  if (!self->_useLinkEngine)
  {
    v8 = [v6 local];
    v9 = [v8 isCellularStunCandidate];
    if (v9)
    {
      v10 = 2;
    }

    else
    {
      v10 = 1;
    }

    v11 = [v7 allocbindFailoverTimer];
    if (v11)
    {
    }

    else if (v9 & 1 | !self->_reduceCellularUsage)
    {
      v12 = [MEMORY[0x1E6995700] weakRefWithObject:self];
      v13 = v12;
      if (a4 < 1)
      {
        v24[0] = MEMORY[0x1E69E9820];
        v24[1] = 3221225472;
        v24[2] = sub_1A7B9D890;
        v24[3] = &unk_1E77E1040;
        v25 = v12;
        v26 = v7;
        v27 = v10;
        IDSTransportThreadAddBlock(v24);
        v20 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          v21 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          *buf = 134217984;
          v34 = v21;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "start allocbind failover now, _tokenToCandidatePairs: %lu", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v22 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
            _IDSLogTransport(@"GL", @"IDS", @"start allocbind failover now, _tokenToCandidatePairs: %lu");
            if (_IDSShouldLog())
            {
              [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind failover now, _tokenToCandidatePairs: %lu");
            }
          }
        }

        v17 = v25;
      }

      else
      {
        v14 = im_primary_queue();
        v15 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v14);

        [v7 setAllocbindFailoverTimer:v15];
        v16 = dispatch_time(0, 1000000000 * a4);
        dispatch_source_set_timer(v15, v16, 0xFFFFFFFFFFFFFFFFLL, 0x3B9ACA00uLL);
        handler[0] = MEMORY[0x1E69E9820];
        handler[1] = 3221225472;
        handler[2] = sub_1A7B9D780;
        handler[3] = &unk_1E77E1018;
        v29 = v13;
        v30 = v7;
        v17 = v15;
        v31 = v17;
        v32 = v10;
        dispatch_source_set_event_handler(v17, handler);
        dispatch_resume(v17);
        v18 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          v19 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          *buf = 134218240;
          v34 = v17;
          v35 = 2048;
          v36 = v19;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "start allocbind failover timer %p, _tokenToCandidatePairs: %lu", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v23 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
            _IDSLogTransport(@"GL", @"IDS", @"start allocbind failover timer %p, _tokenToCandidatePairs: %lu");
            if (_IDSShouldLog())
            {
              [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v17];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind failover timer %p, _tokenToCandidatePairs: %lu");
            }
          }
        }
      }
    }
  }
}

- (void)_handleAllocbindFailoverTimerWithTransportScoreCards:(id)a3 failoverTimerOnCandidatePair:(id)a4 onInterface:(int)a5
{
  v5 = *&a5;
  v63 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  if (v8)
  {
    v10 = [v8 isConnectToQRIPv6Enabled];
    v11 = [v8 isSharedQRSession];
    v12 = +[IDSServerBag sharedInstance];
    v13 = [v12 objectForKey:@"disable-transport-score-cards"];
    v14 = [v13 BOOLValue];

    v15 = v10 ^ 1u;
    if (v14 & v15 & 1) != 0 || ((v11 ^ 1))
    {
      v22 = [v8 sessionInfoDict];
      [(IDSGlobalLink *)self _handleAllocbindFailoverTimer:v22 failoverTimerOnCandidatePair:v9 onInterface:v5];
    }

    else if (self->_state < 4)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
        v25 = [(NSMutableArray *)self->_interfaceAddressArray count];
        *buf = 134218752;
        *&buf[4] = v9;
        *&buf[12] = 2048;
        *&buf[14] = v24;
        *&buf[22] = 1024;
        *&buf[24] = v5;
        *&buf[28] = 2048;
        *&buf[30] = v25;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu", buf, 0x26u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v26 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          v49 = v5;
          v50 = [(NSMutableArray *)self->_interfaceAddressArray count];
          v44 = v9;
          v47 = v26;
          _IDSLogTransport(@"GL", @"IDS", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
          if (_IDSShouldLog())
          {
            v27 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v9];
            v49 = v5;
            v50 = [(NSMutableArray *)self->_interfaceAddressArray count];
            v44 = v9;
            v47 = v27;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
          }
        }
      }

      if (v5 == 1)
      {
        v29 = 0;
        v28 = 1;
      }

      else if (v5 == 2)
      {
        v28 = 0;
        v29 = 1;
      }

      else
      {
        v29 = 0;
        v28 = 0;
      }

      v30 = [v8 sessionID];
      v31 = [(IDSGlobalLink *)self _findTriedCandidatePairForSession:v30 wantOnlyCell:v28 wantOnlyNonCell:v29];

      if (v31)
      {
        v32 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!");
            }
          }
        }
      }

      else
      {
        v33 = objc_alloc_init(IDSQuickRelaySessionInfo);
        v34 = [v8 sessionInfoDict];
        v35 = [(IDSQuickRelaySessionInfo *)v33 parseSessionInfo:v34];

        if (v35)
        {
          v36 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
          {
            v37 = [v8 sessionInfoDict];
            *buf = 134218242;
            *&buf[4] = v35;
            *&buf[12] = 2112;
            *&buf[14] = v37;
            _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "error code = %ld - parsing sessionInfo: %@", buf, 0x16u);
          }
        }

        else
        {
          [(IDSQuickRelaySessionInfo *)v33 serverAddressIPv6];
          v61 = 0u;
          v62 = 0u;
          v59 = 0u;
          v60 = 0u;
          v58 = 0u;
          memset(buf, 0, sizeof(buf));
          __memcpy_chk();
          valid = IsValidSA(buf);
          v51 = 0;
          v52 = 0;
          v39 = [v8 sessionID];
          LOBYTE(v45) = valid;
          [(IDSGlobalLink *)self _selectStunTransport:&v52 andInterfaceAddress:&v51 forRelaySessionID:v39 preferIPv4:v15 wantOnlyCell:v28 wantOnlyNonCell:v29 isValidSA:v45];
          v40 = v51;

          if (v40)
          {
            v41 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
            {
              *v53 = 67109378;
              v54 = v5;
              v55 = 2112;
              v56 = v40;
              _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@", v53, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v46 = v5;
                v48 = v40;
                _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@");
                if (_IDSShouldLog())
                {
                  v46 = v5;
                  v48 = v40;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@");
                }
              }
            }

            v42 = [v8 sessionInfoDict];
            [(IDSGlobalLink *)self _connectWithSessionInfo:v42 interfaceAddress:v40 joinSession:1 allocbindFailover:1 completionHandler:self->_connectReadyHandler withLocalInterfacePreference:0];
          }

          else
          {
            v43 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
            {
              *v53 = 0;
              _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!", v53, 2u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!");
                }
              }
            }
          }

          [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:v9];
        }
      }
    }

    else
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = _IDSLinkStateStrings[self->_state];
        v18 = [v8 sessionInfoDict];
        *buf = 134218498;
        *&buf[4] = v9;
        *&buf[12] = 2080;
        *&buf[14] = v17;
        *&buf[22] = 2048;
        *&buf[24] = v18;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v19 = _IDSLinkStateStrings[self->_state];
          [v8 sessionInfoDict];
          v49 = v47 = v19;
          v44 = v9;
          _IDSLogTransport(@"GL", @"IDS", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");

          if (_IDSShouldLog())
          {
            v20 = _IDSLinkStateStrings[self->_state];
            [v8 sessionInfoDict];
            v49 = v47 = v20;
            v44 = v9;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
          }
        }
      }

      [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0, v44, v47, v49];
    }
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!");
        }
      }
    }
  }
}

- (BOOL)_findTriedCandidatePairForSession:(id)a3 wantOnlyCell:(BOOL)a4 wantOnlyNonCell:(BOOL)a5
{
  v5 = a5;
  v6 = a4;
  v28 = *MEMORY[0x1E69E9840];
  v8 = a3;
  if (v6 == v5)
  {
    v21 = 0;
  }

  else
  {
    v25 = 0u;
    v26 = 0u;
    v23 = 0u;
    v24 = 0u;
    v9 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v10 = [v9 countByEnumeratingWithState:&v23 objects:v27 count:16];
    if (v10)
    {
      v11 = v10;
      v12 = *v24;
      while (2)
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v24 != v12)
          {
            objc_enumerationMutation(v9);
          }

          v14 = *(*(&v23 + 1) + 8 * i);
          if ([v14 isRelayStunCandidatePair])
          {
            v15 = [v14 sessionID];
            v16 = [v15 isEqual:v8];

            if (v16)
            {
              if ([v14 state] && objc_msgSend(v14, "state") <= 4)
              {
                if (v6 && ([v14 local], v17 = objc_claimAutoreleasedReturnValue(), v18 = objc_msgSend(v17, "isCellularStunCandidate"), v17, (v18 & 1) != 0) || v5 && (objc_msgSend(v14, "local"), v19 = objc_claimAutoreleasedReturnValue(), v20 = objc_msgSend(v19, "isCellularStunCandidate"), v19, !v20))
                {
                  v21 = 1;
                  goto LABEL_20;
                }
              }
            }
          }
        }

        v11 = [v9 countByEnumeratingWithState:&v23 objects:v27 count:16];
        if (v11)
        {
          continue;
        }

        break;
      }
    }

    v21 = 0;
LABEL_20:
  }

  return v21;
}

- (void)_stopAllocbindFailoverTimer:(id)a3
{
  v51 = *MEMORY[0x1E69E9840];
  v36 = a3;
  v35 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  if (v36)
  {
    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v4 = v35;
    v5 = [v4 countByEnumeratingWithState:&v37 objects:v49 count:16];
    if (v5)
    {
      v6 = *v38;
      while (2)
      {
        for (i = 0; i != v5; ++i)
        {
          if (*v38 != v6)
          {
            objc_enumerationMutation(v4);
          }

          v8 = *(*(&v37 + 1) + 8 * i);
          v9 = [v8 allocbindFailoverTimer];
          v10 = v9 == v36;

          if (v10)
          {
            v11 = [v8 allocbindFailoverTimer];
            dispatch_source_cancel(v11);

            v12 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
            {
              v13 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
              *buf = 134218240;
              v46 = v36;
              v47 = 2048;
              v48 = v13;
              _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu", buf, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v33 = v36;
                v34 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
                _IDSLogTransport(@"GL", @"IDS", @"stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu");
                if (_IDSShouldLog())
                {
                  v14 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v36];
                  v33 = v36;
                  v34 = v14;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu");
                }
              }
            }

            [v8 setAllocbindFailoverTimer:{0, v33, v34}];
            v15 = [v8 sessionID];
            if (v15)
            {
              v16 = self->_connectingCandidatePairSessionInfo == 0;

              if (!v16)
              {
                connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
                v18 = [v8 sessionID];
                CFDictionaryRemoveValue(connectingCandidatePairSessionInfo, v18);
              }
            }

            goto LABEL_43;
          }
        }

        v5 = [v4 countByEnumeratingWithState:&v37 objects:v49 count:16];
        if (v5)
        {
          continue;
        }

        break;
      }
    }
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v46 = [v35 count];
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "stop all active allocbind failover timer. # candidatePairs = %lu", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v33 = [v35 count];
        _IDSLogTransport(@"GL", @"IDS", @"stop all active allocbind failover timer. # candidatePairs = %lu");
        if (_IDSShouldLog())
        {
          v33 = [v35 count];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"stop all active allocbind failover timer. # candidatePairs = %lu");
        }
      }
    }

    v43 = 0u;
    v44 = 0u;
    v41 = 0u;
    v42 = 0u;
    v20 = v35;
    v21 = [v20 countByEnumeratingWithState:&v41 objects:v50 count:16];
    if (v21)
    {
      v22 = *v42;
      do
      {
        for (j = 0; j != v21; ++j)
        {
          if (*v42 != v22)
          {
            objc_enumerationMutation(v20);
          }

          v24 = *(*(&v41 + 1) + 8 * j);
          v25 = [v24 allocbindFailoverTimer];

          if (v25)
          {
            v26 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
            {
              v27 = [v24 allocbindFailoverTimer];
              *buf = 134217984;
              v46 = v27;
              _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "stop allocbind failover timer: %p", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v33 = [v24 allocbindFailoverTimer];
                _IDSLogTransport(@"GL", @"IDS", @"stop allocbind failover timer: %p");

                if (_IDSShouldLog())
                {
                  v33 = [v24 allocbindFailoverTimer];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"stop allocbind failover timer: %p");
                }
              }
            }

            v28 = [v24 allocbindFailoverTimer];
            dispatch_source_cancel(v28);

            [v24 setAllocbindFailoverTimer:0];
            v29 = [v24 sessionID];
            if (v29)
            {
              v30 = self->_connectingCandidatePairSessionInfo == 0;

              if (!v30)
              {
                v31 = self->_connectingCandidatePairSessionInfo;
                v32 = [v24 sessionID];
                CFDictionaryRemoveValue(v31, v32);
              }
            }
          }
        }

        v21 = [v20 countByEnumeratingWithState:&v41 objects:v50 count:16];
      }

      while (v21);
    }
  }

LABEL_43:
}

- (void)_handleAllocbindFailoverTimer:(id)a3 failoverTimerOnCandidatePair:(id)a4 onInterface:(int)a5
{
  v5 = *&a5;
  v60 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v45 = a4;
  v9 = objc_alloc_init(IDSQuickRelaySessionInfo);
  v44 = v9;
  if ([(IDSQuickRelaySessionInfo *)v9 parseSessionInfo:v8])
  {
    p_state = &self->_state;
LABEL_3:
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = _IDSLinkStateStrings[*p_state];
      *buf = 134218498;
      v57 = v45;
      v58 = 2080;
      *v59 = v12;
      *&v59[8] = 2048;
      *&v59[10] = v8;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v40 = _IDSLinkStateStrings[*p_state];
        v41 = v8;
        v39 = v45;
        _IDSLogTransport(@"GL", @"IDS", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
        if (_IDSShouldLog())
        {
          v40 = _IDSLinkStateStrings[*p_state];
          v41 = v8;
          v39 = v45;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
        }
      }
    }

    [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0, v39, v40, v41];
    goto LABEL_10;
  }

  v13 = [(IDSQuickRelaySessionInfo *)v9 relaySessionID];
  v14 = [(IDSGlobalLink *)self _findTriedCandidatePairForSession:v13 wantOnlyCell:v5 == 1 wantOnlyNonCell:v5 == 2];

  p_state = &self->_state;
  if (self->_state > 3 || v14)
  {
    goto LABEL_3;
  }

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
    v17 = [(NSMutableArray *)self->_interfaceAddressArray count];
    *buf = 134218752;
    v57 = v45;
    v58 = 2048;
    *v59 = v16;
    *&v59[8] = 1024;
    *&v59[10] = v5;
    *&v59[14] = 2048;
    *&v59[16] = v17;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v18 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v41 = v5;
      v42 = [(NSMutableArray *)self->_interfaceAddressArray count];
      v39 = v45;
      v40 = v18;
      _IDSLogTransport(@"GL", @"IDS", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
      if (_IDSShouldLog())
      {
        v19 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v45];
        v41 = v5;
        v42 = [(NSMutableArray *)self->_interfaceAddressArray count];
        v39 = v45;
        v40 = v19;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
      }
    }
  }

  v20 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
  v43 = v20;
  if (!v20)
  {
    goto LABEL_71;
  }

  if (![v20 count])
  {
    v36 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "Device does not have a second interface to retry", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Device does not have a second interface to retry");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Device does not have a second interface to retry");
        }
      }
    }

    goto LABEL_70;
  }

  v52 = 0u;
  v53 = 0u;
  v50 = 0u;
  v51 = 0u;
  v21 = v43;
  v22 = [v21 countByEnumeratingWithState:&v50 objects:v55 count:16];
  if (v22)
  {
    v23 = *v51;
    while (2)
    {
      for (i = 0; i != v22; ++i)
      {
        if (*v51 != v23)
        {
          objc_enumerationMutation(v21);
        }

        v25 = *(*(&v50 + 1) + 8 * i);
        v26 = [v25 address];
        v27 = *([v26 sa] + 1);

        if (v27 == 2)
        {
          if (v5 == 1)
          {
            if ([v25 isCellular])
            {
              goto LABEL_35;
            }
          }

          else if (v5 != 2 || ![v25 isCellular])
          {
LABEL_35:
            v28 = v25;

            if (v28)
            {
              goto LABEL_57;
            }

            goto LABEL_36;
          }
        }
      }

      v22 = [v21 countByEnumeratingWithState:&v50 objects:v55 count:16];
      if (v22)
      {
        continue;
      }

      break;
    }
  }

LABEL_36:
  v48 = 0u;
  v49 = 0u;
  v46 = 0u;
  v47 = 0u;
  v29 = v21;
  v30 = [v29 countByEnumeratingWithState:&v46 objects:v54 count:16];
  if (!v30)
  {
LABEL_49:

LABEL_64:
    v38 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v57) = v5;
      _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "Device does not have interface type: %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v39 = v5;
        _IDSLogTransport(@"GL", @"IDS", @"Device does not have interface type: %d");
        if (_IDSShouldLog())
        {
          v39 = v5;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Device does not have interface type: %d");
        }
      }
    }

    goto LABEL_70;
  }

  v31 = *v47;
LABEL_38:
  v32 = 0;
  while (1)
  {
    if (*v47 != v31)
    {
      objc_enumerationMutation(v29);
    }

    v33 = *(*(&v46 + 1) + 8 * v32);
    v34 = [v33 address];
    v35 = *([v34 sa] + 1);

    if (v35 != 30)
    {
      goto LABEL_47;
    }

    if (v5 != 1)
    {
      break;
    }

    if ([v33 isCellular])
    {
      goto LABEL_56;
    }

LABEL_47:
    if (v30 == ++v32)
    {
      v30 = [v29 countByEnumeratingWithState:&v46 objects:v54 count:16];
      if (v30)
      {
        goto LABEL_38;
      }

      goto LABEL_49;
    }
  }

  if (v5 == 2 && [v33 isCellular])
  {
    goto LABEL_47;
  }

LABEL_56:
  v28 = v33;

  if (!v28)
  {
    goto LABEL_64;
  }

LABEL_57:
  v37 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v57 = v45;
    v58 = 1024;
    *v59 = v5;
    *&v59[4] = 2112;
    *&v59[6] = v28;
    _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v40 = v5;
      v41 = v28;
      v39 = v45;
      _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@");
      if (_IDSShouldLog())
      {
        v40 = v5;
        v41 = v28;
        v39 = v45;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@");
      }
    }
  }

  [(IDSGlobalLink *)self _connectWithSessionInfo:v8 interfaceAddress:v28 joinSession:1 allocbindFailover:1 completionHandler:self->_connectReadyHandler withLocalInterfacePreference:0, v39, v40, v41];

LABEL_70:
  [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:v45, v39];
  v20 = v43;
LABEL_71:

LABEL_10:
}

- (BOOL)_isExtIPDiscoveryDone
{
  v23 = *MEMORY[0x1E69E9840];
  if (self->_hasPendingSelfAllocation)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      v4 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
      *buf = 67109120;
      LODWORD(v21) = v4;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v14 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
        _IDSLogTransport(@"GL", @"IDS", @"_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u");
        if (_IDSShouldLog())
        {
          [(NSMutableArray *)self->_selfAllocateRequestIDs count];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u");
        }
      }
    }

    return 0;
  }

  else
  {
    [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v18 = 0u;
    v19 = 0u;
    v16 = 0u;
    v6 = v17 = 0u;
    v7 = [v6 countByEnumeratingWithState:&v16 objects:v22 count:16];
    if (v7)
    {
      v8 = *v17;
      while (2)
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v17 != v8)
          {
            objc_enumerationMutation(v6);
          }

          v10 = *(*(&v16 + 1) + 8 * i);
          if ([v10 allocateType] == 2 && objc_msgSend(v10, "state") <= 1)
          {
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              v12 = [v10 state];
              *buf = 134217984;
              v21 = v12;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "[candidatePair state] = %lu", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v15 = [v10 state];
                _IDSLogTransport(@"GL", @"IDS", @"[candidatePair state] = %lu");
                if (_IDSShouldLog())
                {
                  [v10 state];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"[candidatePair state] = %lu");
                }
              }
            }

            v5 = 0;
            goto LABEL_26;
          }
        }

        v7 = [v6 countByEnumeratingWithState:&v16 objects:v22 count:16];
        if (v7)
        {
          continue;
        }

        break;
      }
    }

    v5 = 1;
LABEL_26:
  }

  return v5;
}

- (void)_handleSelfAllocationTimeout:(id)a3
{
  v9 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if ([(NSMutableArray *)self->_selfAllocateRequestIDs containsObject:v4])
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v8 = v4;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "self allocation request %@ timed out.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v6 = v4;
        _IDSLogTransport(@"GL", @"IDS", @"self allocation request %@ timed out.");
        if (_IDSShouldLog())
        {
          v6 = v4;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"self allocation request %@ timed out.");
        }
      }
    }

    [(NSMutableArray *)self->_selfAllocateRequestIDs removeObject:v4, v6];
    if (![(NSMutableArray *)self->_selfAllocateRequestIDs count])
    {
      self->_hasPendingSelfAllocation = 0;
      [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
  }
}

- (void)_processXORMappedAddress:(id)a3 arrivalTime:(double)a4
{
  v56 = *MEMORY[0x1E69E9840];
  v5 = a3;
  *&v6 = 0xAAAAAAAAAAAAAAAALL;
  *(&v6 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v54 = v6;
  v55 = v6;
  v52 = v6;
  v53 = v6;
  v50 = v6;
  v51 = v6;
  *__str = v6;
  v49 = v6;
  v46 = v6;
  v47 = v6;
  v44 = v6;
  v45 = v6;
  v42 = v6;
  v43 = v6;
  *v40 = v6;
  v41 = v6;
  v7 = [v5 local];
  v36 = [v7 address];

  v8 = [v5 local];
  v9 = [v8 external];

  SAToIPPortString(__str, 0x80uLL, v36);
  SAToIPPortString(v40, 0x80uLL, v9);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 136315394;
    *v39 = v40;
    *&v39[8] = 2080;
    *&v39[10] = __str;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "discover external address on [%s] on [%s].", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v32 = v40;
      v34 = __str;
      _IDSLogTransport(@"GL", @"IDS", @"discover external address on [%s] on [%s].");
      if (_IDSShouldLog())
      {
        v32 = v40;
        v34 = __str;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"discover external address on [%s] on [%s].");
      }
    }
  }

  v11 = [v5 local];
  v12 = [v11 radioAccessTechnology];
  v13 = [v5 local];
  v14 = [v13 mtu];
  v15 = [v5 local];
  v16 = [v15 index];
  v17 = [v5 local];
  v18 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 1, 1, v12, v14, v16, [v17 address], v9);

  v19 = [v5 local];
  [v18 setLinkFlags:{objc_msgSend(v19, "linkFlags")}];

  v20 = [v5 allocateType];
  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    v22 = [v5 allocateType];
    *buf = 67109376;
    *v39 = v20 == 2;
    *&v39[4] = 2048;
    *&v39[6] = v22;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "isSelfAllocate: %d, [candidatePair allocateType]: %ld", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v33 = (v20 == 2);
      v35 = [v5 allocateType];
      _IDSLogTransport(@"GL", @"IDS", @"isSelfAllocate: %d, [candidatePair allocateType]: %ld");
      if (_IDSShouldLog())
      {
        v23 = [v5 allocateType];
        v33 = (v20 == 2);
        v35 = v23;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"isSelfAllocate: %d, [candidatePair allocateType]: %ld");
      }
    }
  }

  if (v20 == 2)
  {
    [v5 selfAllocateStartTime];
    v25 = ((a4 - v24) * 1000.0);
    GLUtilReportAWDClientTimerEvent(308, 0, v5, self->_enableSKE, self->_isInitiator, v25);
    [(IDSGlobalLink *)self _reportAWDAllocateTime];
    v26 = GLUCreateQRClientTimeEvent(308, 0, v5, self->_timeBase, v25);
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v28 = objc_opt_respondsToSelector();

    if (v28)
    {
      v29 = objc_loadWeakRetained(&self->_delegate);
      [v29 link:self didAddQREvent:v26];
    }
  }

  if (*(v36 + 1) == *(v9 + 1))
  {
    if ([(IDSGlobalLink *)self _addCandidate:v18 isRemoteCandidate:0])
    {
      [(IDSGlobalLink *)self _addStunCheckPair:v18 isRemoteCandidate:0];
    }

    else
    {
      v31 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315138;
        *v39 = v40;
        _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "external address [%s] already exists, do not add stun check pairs", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v33 = v40;
          _IDSLogTransport(@"GL", @"IDS", @"external address [%s] already exists, do not add stun check pairs");
          if (_IDSShouldLog())
          {
            v33 = v40;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"external address [%s] already exists, do not add stun check pairs");
          }
        }
      }
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0, v33, v35];
  }

  else
  {
    v30 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "local and external addresses have mismatched family, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"local and external addresses have mismatched family, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"local and external addresses have mismatched family, ignore.");
        }
      }
    }
  }
}

- (BOOL)_IsExtIPDiscoveryNeeded:(sockaddr *)a3 candidatePairList:(id)a4
{
  v20 = *MEMORY[0x1E69E9840];
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v5 = a4;
  v6 = [v5 countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v16;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v16 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v15 + 1) + 8 * i);
        if ([v10 isRelayStunCandidatePair])
        {
          v11 = [v10 local];
          v12 = [v11 address];

          if (IsSameSA(v12, a3))
          {
            v13 = 0;
            goto LABEL_12;
          }
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v15 objects:v19 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v13 = 1;
LABEL_12:

  return v13;
}

- (void)_sendAllocbindRequestForExtIP:(id)a3 startTime:(double)a4
{
  v44 = *MEMORY[0x1E69E9840];
  v34 = a3;
  v33 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 3, 1, 10, 1400, 0xFFFFFFFFLL, 0, [v34 serverAddress]);
  v39 = 0u;
  v40 = 0u;
  v37 = 0u;
  v38 = 0u;
  obj = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v37 objects:v43 count:16];
  if (v5)
  {
    v6 = *v38;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v38 != v6)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v37 + 1) + 8 * i);
        v9 = [v8 index];
        v10 = [v8 address];
        v11 = [v10 sa];

        v12 = IsLinkLocalSA(v11);
        v13 = [v8 IPVersion];
        if ([v8 isCellular])
        {
          v14 = +[IDSCellularLinkMonitor sharedInstance];
          v15 = [v14 radioAccessTechnology];
        }

        else if ([v8 isWired])
        {
          v15 = 9;
        }

        else
        {
          v15 = 0;
        }

        if (v11)
        {
          v16 = v9 < 1;
        }

        else
        {
          v16 = 1;
        }

        v17 = v16;
        if (((v17 | v12) & 1) == 0 && v13 != 1 && ([v8 isCompanionLink] & 1) == 0)
        {
          v18 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          v19 = [(IDSGlobalLink *)self _IsExtIPDiscoveryNeeded:v11 candidatePairList:v18];

          if (v19)
          {
            v20 = [IDSStunCandidate candidateWithType:3 transport:1 radioAccessTechnology:v15 mtu:1450 index:v9 address:v11 external:v11];
            v21 = [v34 serverAddress];
            v22 = [v34 relaySessionID];
            v23 = tokenForStunCandidatePair(v11, v21, v22);

            v24 = [v34 relaySessionID];
            v25 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v20 remoteCandidate:v33 sessionID:v24 delegate:self];

            v26 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v42 = v34;
              _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v31 = v34;
                _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@");
                if (_IDSShouldLog())
                {
                  v31 = v34;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@");
                }
              }
            }

            [v25 setPropertiesWithRelaySessionInfo:v34 sessionInfoDict:0 enableSKE:{self->_enableSKE, v31}];
            [v25 setSelfAllocateStartTime:a4];
            if (!self->_tokenToCandidatePairs)
            {
              Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              self->_tokenToCandidatePairs = Mutable;
            }

            v29 = v25;
            if (v29)
            {
              CFDictionarySetValue(self->_tokenToCandidatePairs, v23, v29);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              sub_1A7E1498C();
            }

            v30 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v42 = v23;
              _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "start extIP discovery for %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v32 = v23;
                _IDSLogTransport(@"GL", @"IDS", @"start extIP discovery for %@.");
                if (_IDSShouldLog())
                {
                  v32 = v23;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"start extIP discovery for %@.");
                }
              }
            }

            [(IDSGlobalLink *)self sendAllocbindRequest:v29 isRealloc:0 inResponseToNoSessionState:0 reconnectQUIC:0, v32];

            goto LABEL_43;
          }
        }
      }

      v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v37 objects:v43 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

LABEL_43:
}

- (BOOL)_requestSelfAllocationForInterfaceAddress:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 address];
  v6 = [v5 sa];

  v7 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = [(IDSGlobalLink *)self _IsExtIPDiscoveryNeeded:v6 candidatePairList:v7];

  if (v8)
  {
    if (!self->_hasPendingSelfAllocation)
    {
      self->_hasPendingSelfAllocation = 1;
    }

    v9 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BA0650;
    block[3] = &unk_1E77E0C88;
    block[4] = self;
    v16 = v4;
    dispatch_async(v9, block);
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = [v4 address];
      *buf = 138412290;
      v18 = v11;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "no need to request self allocation for [%@].", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v13 = [v4 address];
        _IDSLogTransport(@"GL", @"IDS", @"no need to request self allocation for [%@].");

        if (_IDSShouldLog())
        {
          v14 = [v4 address];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no need to request self allocation for [%@].");
        }
      }
    }
  }

  return v8;
}

- (void)_startExtIPDiscovery
{
  v47 = *MEMORY[0x1E69E9840];
  v2 = self->_useLinkEngine && self->_useLinkSelection && self->_linkSelectionStrategy != 0;
  if (self->_allowP2P || v2)
  {
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "== start external IP discovery for all interfaces ==", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"== start external IP discovery for all interfaces ==");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"== start external IP discovery for all interfaces ==");
        }
      }
    }

    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    obj = self->_interfaceAddressArray;
    v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v39 objects:v46 count:16];
    if (v5)
    {
      v31 = 0;
      v33 = *v40;
      do
      {
        for (i = 0; i != v5; ++i)
        {
          if (*v40 != v33)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v39 + 1) + 8 * i);
          v8 = [v7 index];
          v9 = [v7 address];
          v10 = [v9 sa];

          v11 = IsLinkLocalSA(v10);
          v12 = [v7 IPVersion];
          v13 = [v7 isCompanionLink];
          if ([v7 isCellular])
          {
            v14 = +[IDSCellularLinkMonitor sharedInstance];
            v15 = [v14 radioAccessTechnology];
          }

          else if ([v7 isWired])
          {
            v15 = 9;
          }

          else
          {
            v15 = 0;
          }

          if (*(v10 + 1) == 30)
          {
            v16 = 6;
          }

          else
          {
            v16 = 5;
          }

          LocalMTU = GLUtilGetLocalMTU(v16, [v7 isCellular]);
          if (v10)
          {
            v18 = v8 < 1;
          }

          else
          {
            v18 = 1;
          }

          v19 = v18;
          if (((v19 | v11 | v13) & 1) == 0)
          {
            v20 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:v15 mtu:LocalMTU index:v8 address:v10 external:v10];
            if ([(IDSGlobalLink *)self _addCandidate:v20 isRemoteCandidate:0])
            {
              [(IDSGlobalLink *)self _addStunCheckPair:v20 isRemoteCandidate:0];
            }

            if (v12 != 1)
            {
              v21 = v31;
              if (!v31)
              {
                v21 = objc_alloc_init(MEMORY[0x1E695DF70]);
              }

              v31 = v21;
              if (v7 && v21)
              {
                CFArrayAppendValue(v21, v7);
              }
            }
          }
        }

        v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v39 objects:v46 count:16];
      }

      while (v5);
    }

    else
    {
      v31 = 0;
    }

    if ([(__CFArray *)v31 count])
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v45 = v31;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "need external IP discovery for interfaces:%@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v30 = v31;
          _IDSLogTransport(@"GL", @"IDS", @"need external IP discovery for interfaces:%@");
          if (_IDSShouldLog())
          {
            v30 = v31;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"need external IP discovery for interfaces:%@");
          }
        }
      }

      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v23 = v31;
      v24 = [(__CFArray *)v23 countByEnumeratingWithState:&v35 objects:v43 count:16];
      if (v24)
      {
        v25 = *v36;
        do
        {
          for (j = 0; j != v24; ++j)
          {
            if (*v36 != v25)
            {
              objc_enumerationMutation(v23);
            }

            [(IDSGlobalLink *)self _requestSelfAllocationForInterfaceAddress:*(*(&v35 + 1) + 8 * j), v30];
          }

          v24 = [(__CFArray *)v23 countByEnumeratingWithState:&v35 objects:v43 count:16];
        }

        while (v24);
      }
    }

    if (!self->_hasPendingSelfAllocation || (v27 = [(__CFArray *)v31 count], v28 = v31, !v27))
    {
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "external IP discovery is not needed, send connection data.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"external IP discovery is not needed, send connection data.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"external IP discovery is not needed, send connection data.");
          }
        }
      }

      [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0, v30];
      v28 = v31;
    }
  }

  else
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "skip external IP discovery because P2P is not allowed.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip external IP discovery because P2P is not allowed.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip external IP discovery because P2P is not allowed.");
      }
    }
  }
}

- (void)_processRemoteCandidates:(id)a3
{
  v80 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v40 = v3;
  if ([v3 count])
  {
    v70 = 0u;
    v71 = 0u;
    v68 = 0u;
    v69 = 0u;
    obj = v3;
    v4 = [obj countByEnumeratingWithState:&v68 objects:v77 count:16];
    if (v4)
    {
      v44 = 0;
      v5 = *v69;
      do
      {
        for (i = 0; i != v4; ++i)
        {
          if (*v69 != v5)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v68 + 1) + 8 * i);
          if (([(NSMutableArray *)self->_remoteCandidateList containsObject:v7]& 1) == 0)
          {
            v8 = v44;
            if (!v44)
            {
              v8 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v7)
            {
              v9 = v8 == 0;
            }

            else
            {
              v9 = 1;
            }

            v44 = v8;
            if (!v9)
            {
              CFArrayAppendValue(v8, v7);
            }
          }
        }

        v4 = [obj countByEnumeratingWithState:&v68 objects:v77 count:16];
      }

      while (v4);
    }

    else
    {
      v44 = 0;
    }

    if ([(__CFArray *)v44 count])
    {
      [(IDSGlobalLink *)self _processNewRemoteCandidates:v44];
    }

    v66 = 0u;
    v67 = 0u;
    v64 = 0u;
    v65 = 0u;
    v41 = self->_remoteCandidateList;
    v11 = [(NSMutableArray *)v41 countByEnumeratingWithState:&v64 objects:v76 count:16];
    v12 = 0;
    if (v11)
    {
      v42 = *v65;
      do
      {
        for (j = 0; j != v11; ++j)
        {
          if (*v65 != v42)
          {
            objc_enumerationMutation(v41);
          }

          v14 = *(*(&v64 + 1) + 8 * j);
          v60 = 0u;
          v61 = 0u;
          v62 = 0u;
          v63 = 0u;
          v15 = obj;
          v16 = [v15 countByEnumeratingWithState:&v60 objects:v75 count:16];
          if (v16)
          {
            v17 = *v61;
            while (2)
            {
              for (k = 0; k != v16; ++k)
              {
                if (*v61 != v17)
                {
                  objc_enumerationMutation(v15);
                }

                if (IsSameIP([v14 address], objc_msgSend(*(*(&v60 + 1) + 8 * k), "address")))
                {

                  goto LABEL_52;
                }
              }

              v16 = [v15 countByEnumeratingWithState:&v60 objects:v75 count:16];
              if (v16)
              {
                continue;
              }

              break;
            }
          }

          if (v12 || (v12 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
          {
            if (v14)
            {
              CFArrayAppendValue(v12, v14);
            }
          }

          v19 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v79 = v14;
            _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "Try to remove remote candidate %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v39 = v14;
              _IDSLogTransport(@"GL", @"IDS", @"Try to remove remote candidate %@.");
              if (_IDSShouldLog())
              {
                v39 = v14;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Try to remove remote candidate %@.");
              }
            }
          }

LABEL_52:
          ;
        }

        v11 = [(NSMutableArray *)v41 countByEnumeratingWithState:&v64 objects:v76 count:16];
      }

      while (v11);
    }

    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    obja = v12;
    v20 = 0;
    v21 = [(__CFArray *)obja countByEnumeratingWithState:&v56 objects:v74 count:16];
    if (v21)
    {
      v22 = *v57;
      do
      {
        for (m = 0; m != v21; ++m)
        {
          if (*v57 != v22)
          {
            objc_enumerationMutation(obja);
          }

          v24 = *(*(&v56 + 1) + 8 * m);
          if ([v24 type] == 2)
          {
            if (!v20)
            {
              v20 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v24)
            {
              v25 = v20 == 0;
            }

            else
            {
              v25 = 1;
            }

            if (!v25)
            {
              CFArrayAppendValue(v20, v24);
            }
          }
        }

        v21 = [(__CFArray *)obja countByEnumeratingWithState:&v56 objects:v74 count:16];
      }

      while (v21);
    }

    v54 = 0u;
    v55 = 0u;
    v52 = 0u;
    v53 = 0u;
    v43 = v20;
    v26 = [(__CFArray *)v43 countByEnumeratingWithState:&v52 objects:v73 count:16];
    if (v26)
    {
      v27 = *v53;
      do
      {
        for (n = 0; n != v26; ++n)
        {
          if (*v53 != v27)
          {
            objc_enumerationMutation(v43);
          }

          v29 = *(*(&v52 + 1) + 8 * n);
          v30 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          v50 = 0u;
          v51 = 0u;
          v48 = 0u;
          v49 = 0u;
          v31 = v30;
          v32 = [v31 countByEnumeratingWithState:&v48 objects:v72 count:16];
          if (v32)
          {
            v33 = *v49;
            while (2)
            {
              for (ii = 0; ii != v32; ++ii)
              {
                if (*v49 != v33)
                {
                  objc_enumerationMutation(v31);
                }

                v35 = *(*(&v48 + 1) + 8 * ii);
                if ([v35 state] == 3)
                {
                  v36 = [v35 remote];
                  v37 = IsSameSA([v36 external], objc_msgSend(v29, "external"));

                  if (v37)
                  {

                    goto LABEL_90;
                  }
                }
              }

              v32 = [v31 countByEnumeratingWithState:&v48 objects:v72 count:16];
              if (v32)
              {
                continue;
              }

              break;
            }
          }

          [(__CFArray *)obja removeObject:v29];
          v38 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v79 = v29;
            _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "Add back removed PRLX remote candidate %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v39 = v29;
              _IDSLogTransport(@"GL", @"IDS", @"Add back removed PRLX remote candidate %@");
              if (_IDSShouldLog())
              {
                v39 = v29;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Add back removed PRLX remote candidate %@");
              }
            }
          }

LABEL_90:
        }

        v26 = [(__CFArray *)v43 countByEnumeratingWithState:&v52 objects:v73 count:16];
      }

      while (v26);
    }

    [(IDSGlobalLink *)self _processRemovedRemoteCandidates:obja];
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v79 = v40;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "invalid remote candidate list %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"invalid remote candidate list %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"invalid remote candidate list %@.");
        }
      }
    }
  }
}

- (void)_updateNominatedCandidatePair:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v23 = 0u;
  v6 = [v5 countByEnumeratingWithState:&v22 objects:v29 count:16];
  if (v6)
  {
    v7 = *v23;
    do
    {
      v8 = 0;
      do
      {
        if (*v23 != v7)
        {
          objc_enumerationMutation(v5);
        }

        [*(*(&v22 + 1) + 8 * v8++) setIsNominated:0];
      }

      while (v6 != v8);
      v6 = [v5 countByEnumeratingWithState:&v22 objects:v29 count:16];
    }

    while (v6);
  }

  v9 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];

  v20 = 0u;
  v21 = 0u;
  v18 = 0u;
  v19 = 0u;
  v10 = v9;
  v11 = [v10 countByEnumeratingWithState:&v18 objects:v28 count:16];
  if (v11)
  {
    v12 = *v19;
    do
    {
      v13 = 0;
      do
      {
        if (*v19 != v12)
        {
          objc_enumerationMutation(v10);
        }

        [*(*(&v18 + 1) + 8 * v13++) setIsNominated:0];
      }

      while (v11 != v13);
      v11 = [v10 countByEnumeratingWithState:&v18 objects:v28 count:16];
    }

    while (v11);
  }

  if (!v4 || (tokenToCandidatePairs = self->_tokenToCandidatePairs) == 0 || (v15 = CFDictionaryGetValue(tokenToCandidatePairs, v4)) == 0)
  {
    Value = 0;
    if (v4 && self->_tokenToStunCheckPairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, v4);
    }

    v15 = Value;
  }

  [v15 setIsNominated:1];
  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v27 = v15;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "set nominated flag for %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"set nominated flag for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"set nominated flag for %@.");
      }
    }
  }
}

- (void)_nominateCandidatePair:(id)a3
{
  v15 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if (self->_isInitiator)
  {
    Value = 0;
    if (v4 && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v4);
    }

    v6 = Value;
    if (([v6 isSharedQRSession] & 1) == 0)
    {
      ++self->_nominateCount;
      [(IDSGlobalLink *)self _updateNominatedCandidatePair:v4];
      v7 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
      {
        nominateCount = self->_nominateCount;
        *buf = 67109378;
        v12 = nominateCount;
        v13 = 2112;
        v14 = v4;
        _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "start nomination #%d: %@.", buf, 0x12u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v9 = self->_nominateCount;
          v10 = v4;
          _IDSLogTransport(@"GL", @"IDS", @"start nomination #%d: %@.");
          if (_IDSShouldLog())
          {
            v9 = self->_nominateCount;
            v10 = v4;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"start nomination #%d: %@.");
          }
        }
      }

      [(IDSGlobalLink *)self _sendCommandMessage:5 stunMessage:0 options:0 candidatePairToken:v4, v9, v10];
    }
  }
}

- (void)_sendBindingRequest:(id)a3 stunMessage:(id)a4
{
  v69 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if (self->_state < 5)
  {
    if (!v6 || (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) == 0 || (v12 = CFDictionaryGetValue(tokenToStunCheckPairs, v6)) == 0)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send bind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send bind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send bind request failed due to invalid candidate pair.");
          }
        }
      }

      if (v7)
      {
        v49 = [(IDSStunMessage *)v7 requestID];
        [(IDSGlobalLink *)self _removeStunRequest:v49];
        v10 = 0;
      }

      else
      {
        v10 = 0;
      }

      goto LABEL_98;
    }

    v10 = v12;
    v13 = [v12 state];
    if (v13 >= 3)
    {
      v14 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v15 = (&_IDSStunCandidatePairStateStrings)[v13];
        *buf = 138412546;
        *&buf[4] = v10;
        *&buf[12] = 2080;
        *&buf[14] = v15;
        _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "skip binding request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip binding request for %@, state [%s].");
      }

      if (v7)
      {
        v48 = [(IDSStunMessage *)v7 requestID];
        [(IDSGlobalLink *)self _removeStunRequest:v48];
      }

      goto LABEL_98;
    }

    v17 = [v10 local];
    v50 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [v17 index]);

    if (self->_cellInterfaceName)
    {
      v18 = [v10 local];
      if ([v18 isCellularStunCandidate])
      {
        v19 = [(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v50];

        if ((v19 & 1) == 0)
        {
          v20 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
          {
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            *&buf[4] = v50;
            *&buf[12] = 2112;
            *&buf[14] = cellInterfaceName;
            _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip binding request on currentInterfaceName", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip binding request on currentInterfaceName");
          }

          goto LABEL_97;
        }
      }

      else
      {
      }
    }

    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BA2A48;
    aBlock[3] = &unk_1E77E1090;
    v10 = v10;
    v62 = v10;
    v63 = self;
    v65 = v13;
    v22 = v6;
    v64 = v22;
    v23 = _Block_copy(aBlock);
    if (v7)
    {
      [(IDSStunMessage *)v7 startTime];
      v25 = v24;
      if (ids_monotonic_time() - v24 <= 60.0)
      {
        [v10 triggeredCheckTime];
        if (v39 <= v25)
        {
          v23[2](v23, v7);
        }

        else
        {
          v40 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = v7;
            _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "cancel binding request %@ with triggered check", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"cancel binding request %@ with triggered check");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"cancel binding request %@ with triggered check");
              }
            }
          }

          v58[0] = MEMORY[0x1E69E9820];
          v58[1] = 3221225472;
          v58[2] = sub_1A7BA2FC8;
          v58[3] = &unk_1E77E1068;
          v58[4] = self;
          v59 = v22;
          v7 = v7;
          v60 = v7;
          v41 = ids_monotonic_time();
          IDSTransportThreadAddBlockAfter(v58, v25 + 60.0 - v41 + 0.1);
        }
      }

      else
      {
        [v10 setState:2];
        if (self->_useLinkEngine)
        {
          linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
          v27 = [v10 linkUniqueName];
          v28 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:v27];
          LODWORD(linkEngineIDToCandidatePair) = v10 == v28;

          if (linkEngineIDToCandidatePair)
          {
            v29 = [v10 linkEngine];
            v30 = [v10 linkUniqueName];
            [v29 linkDidFail:v30 errorCode:44 isRecoverable:0 shouldReconnect:0];
          }
        }

        v31 = [(IDSStunMessage *)v7 requestID];
        [(IDSGlobalLink *)self _removeStunRequest:v31];

        v32 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          v33 = (&_IDSStunCandidatePairStateStrings)[v13];
          *buf = 138412802;
          *&buf[4] = v10;
          *&buf[12] = 2080;
          *&buf[14] = v33;
          v67 = 2080;
          v68 = off_1EB2B43B8;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "binding request %@ timed out, update state (%s->%s).", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"binding request %@ timed out, update state (%s->%s).");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"binding request %@ timed out, update state (%s->%s).");
            }
          }
        }
      }

      goto LABEL_96;
    }

    v7 = [[IDSStunMessage alloc] initWithType:1];
    v34 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v35 = [v10 local];
    v36 = [v35 radioAccessTechnology];

    if (self->_remoteDeviceVersion <= 2 && v36 == 9)
    {
      v37 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "RATType Wired -> NonCell due to remote version", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"RATType Wired -> NonCell due to remote version");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"RATType Wired -> NonCell due to remote version");
          }
        }
      }

      v36 = 0;
    }

    v38 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v36];
    if (v38)
    {
      CFDictionarySetValue(v34, @"ids-stun-attribute-cellrat", v38);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15A98();
    }

    v42 = self->_controlMessageKey;
    if (v42)
    {
      CFDictionarySetValue(v34, @"ids-stun-attribute-messageintegrity", v42);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15B20();
    }

    if (self->_isInitiator && (self->_remoteCapabilityFlag & 1) != 0)
    {
      memset(buf, 170, 16);
      v43 = [v10 linkUUID];
      [v43 getUUIDBytes:buf];

      v44 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
      if (v44)
      {
        CFDictionarySetValue(v34, @"ids-stun-attribute-linkuuid", v44);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15BA8();
      }
    }

    if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
    {
      goto LABEL_86;
    }

    v45 = [v10 local];
    if ([v45 isCellularStunCandidate])
    {
      allowTLEOverCellular = self->_allowTLEOverCellular;

      if (!allowTLEOverCellular)
      {
LABEL_86:
        [(IDSStunMessage *)v7 setTransactionID:0 attributes:v34];
        [(IDSStunMessage *)v7 setStartTime:ids_monotonic_time()];
        v23[2](v23, v7);
LABEL_95:

LABEL_96:
LABEL_97:

        goto LABEL_98;
      }
    }

    else
    {
    }

    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v22;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "getting p2p negotiation for: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"getting p2p negotiation for: %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"getting p2p negotiation for: %@");
        }
      }
    }

    v51[0] = MEMORY[0x1E69E9820];
    v51[1] = 3221225472;
    v51[2] = sub_1A7BA2FD8;
    v51[3] = &unk_1E77E10B8;
    v52 = v22;
    v53 = v10;
    v54 = self;
    v55 = v34;
    v56 = v7;
    v57 = v23;
    [(IDSGlobalLink *)self _getP2PNegotiationForCandidatePair:v53 completionBlock:v51];

    goto LABEL_95;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = _IDSLinkStateStrings[self->_state];
    *buf = 136315138;
    *&buf[4] = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "skip bind request, GL state [%s].", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip bind request, GL state [%s].");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip bind request, GL state [%s].");
      }
    }
  }

  if (v7)
  {
    v10 = [(IDSStunMessage *)v7 requestID];
    [(IDSGlobalLink *)self _removeStunRequest:v10];
LABEL_98:
  }
}

- (BOOL)_shouldUseP2PTLE
{
  v8 = *MEMORY[0x1E69E9840];
  forceP2PTLE = self->_forceP2PTLE;
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = @"NO";
    if (forceP2PTLE)
    {
      v4 = @"YES";
    }

    *buf = 138412290;
    v7 = v4;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_shouldUseP2PTLE: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_shouldUseP2PTLE: %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldUseP2PTLE: %@");
      }
    }
  }

  return forceP2PTLE;
}

- (BOOL)_shouldUseQRTLE
{
  v16 = *MEMORY[0x1E69E9840];
  v3 = self->_isTLEEnabled || self->_forceTLE;
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = @"NO";
    if (v3)
    {
      v6 = @"YES";
    }

    else
    {
      v6 = @"NO";
    }

    forceTLE = self->_forceTLE;
    if (self->_isTLEEnabled)
    {
      v8 = @"YES";
    }

    else
    {
      v8 = @"NO";
    }

    *buf = 138412802;
    v11 = v6;
    v12 = 2112;
    if (forceTLE)
    {
      v5 = @"YES";
    }

    v13 = v8;
    v14 = 2112;
    v15 = v5;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)");
      }
    }
  }

  return v3;
}

- (void)_getP2PNegotiationForCandidatePair:(id)a3 completionBlock:(id)a4
{
  v19 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    p2pNegotiatorProvider = self->_p2pNegotiatorProvider;
    *buf = 138412290;
    v18 = p2pNegotiatorProvider;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "getting p2p negotiator from %@...", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"getting p2p negotiator from %@...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"getting p2p negotiator from %@...");
      }
    }
  }

  v10 = self->_p2pNegotiatorProvider;
  groupID = self->_groupID;
  v14[0] = MEMORY[0x1E69E9820];
  v14[1] = 3221225472;
  v14[2] = sub_1A7BA38B4;
  v14[3] = &unk_1E77E1108;
  v15 = v6;
  v16 = v7;
  v12 = v7;
  v13 = v6;
  [(IDSGlobalLinkP2PKeyNegotiatorProvider *)v10 negotiatorForGroup:groupID completionHandler:v14];
}

- (void)_processRemoteLinkUUID:(id)a3 candidatePair:(id)a4
{
  v21 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = v7;
  if (self->_isInitiator)
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "receive linkUUID from Receiver, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive linkUUID from Receiver, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive linkUUID from Receiver, ignore.");
        }
      }
    }
  }

  else if (v6)
  {
    v10 = [v7 linkUUID];
    v11 = [v6 isEqual:v10];

    if ((v11 & 1) == 0)
    {
      [v8 setLinkUUID:v6];
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = [v8 candidatePairToken];
        *buf = 138412546;
        v18 = v6;
        v19 = 2112;
        v20 = v13;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_processRemoteLinkUUID: update linkUUID %@ for %@.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v15 = [v8 candidatePairToken];
          _IDSLogTransport(@"GL", @"IDS", @"_processRemoteLinkUUID: update linkUUID %@ for %@.");

          if (_IDSShouldLog())
          {
            v16 = [v8 candidatePairToken];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_processRemoteLinkUUID: update linkUUID %@ for %@.");
          }
        }
      }
    }
  }

  else
  {
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "receive invalid linkUUID, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive invalid linkUUID, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid linkUUID, ignore.");
        }
      }
    }
  }
}

- (BOOL)_isCellularInterfaceForCandidatePair:(id)a3 localAddress:(sockaddr *)a4
{
  v28 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = v6;
  if (v6)
  {
    v8 = [v6 local];
    if ([v8 radioAccessTechnology])
    {
      v9 = [v7 local];
      v10 = [v9 radioAccessTechnology] != 9;
    }

    else
    {
      v10 = 0;
    }
  }

  else
  {
    v25 = 0u;
    v26 = 0u;
    v23 = 0u;
    v24 = 0u;
    v11 = self->_interfaceAddressArray;
    v12 = [(NSMutableArray *)v11 countByEnumeratingWithState:&v23 objects:v27 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v24;
      while (2)
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v24 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v23 + 1) + 8 * i);
          v17 = [v16 address];
          v18 = IsSameSA([v17 sa], a4);

          if (v18 && [v16 isCellular])
          {
            v20 = +[IDSCellularLinkMonitor sharedInstance];
            v19 = [v20 radioAccessTechnology];

            goto LABEL_17;
          }
        }

        v13 = [(NSMutableArray *)v11 countByEnumeratingWithState:&v23 objects:v27 count:16];
        if (v13)
        {
          continue;
        }

        break;
      }
    }

    v19 = 0;
LABEL_17:

    if (v19)
    {
      v21 = v19 == 9;
    }

    else
    {
      v21 = 1;
    }

    v10 = !v21;
  }

  return v10;
}

- (BOOL)_processBindingRequest:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v10 = *&a5;
  v171 = *MEMORY[0x1E69E9840];
  v96 = a3;
  v93 = a4;
  key = a8;
  *&v13 = 0xAAAAAAAAAAAAAAAALL;
  *(&v13 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v169 = v13;
  v170 = v13;
  v167 = v13;
  v168 = v13;
  v165 = v13;
  v166 = v13;
  *__str = v13;
  v164 = v13;
  v162 = v13;
  v161 = v13;
  v160 = v13;
  v159 = v13;
  v158 = v13;
  v157 = v13;
  v156 = v13;
  *v155 = v13;
  memset(__b, 170, sizeof(__b));
  *&v14 = 0xAAAAAAAAAAAAAAAALL;
  *(&v14 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v153[7] = v14;
  v153[6] = v14;
  v153[5] = v14;
  v153[4] = v14;
  v153[3] = v14;
  v153[2] = v14;
  v153[1] = v14;
  v153[0] = v14;
  v152 = v14;
  v151 = v14;
  v150 = v14;
  v148 = v14;
  v149 = v14;
  v146 = v14;
  v147 = v14;
  v144 = v14;
  v145 = v14;
  v142 = v14;
  v143 = v14;
  v140 = v14;
  v141 = v14;
  v138 = v14;
  v139 = v14;
  v137 = v14;
  __memcpy_chk();
  __memcpy_chk();
  SAToIPPortString(__str, 0x80uLL, &v145);
  SAToIPPortString(v155, 0x80uLL, &v137);
  v15 = [v96 requestID];
  v94 = [(IDSGlobalLink *)self _hasStunRequest:v15];

  if (!v94)
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138413058;
      *&buf[4] = v96;
      *&buf[12] = 2080;
      *&buf[14] = v155;
      *&buf[22] = 2080;
      v134 = __str;
      LOWORD(v135) = 1024;
      *(&v135 + 2) = v10;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive binding request %@ from %s on %s(%u)", buf, 0x26u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v85 = __str;
        v86 = v10;
        v84 = v155;
        v80 = v96;
        _IDSLogTransport(@"GL", @"IDS", @"receive binding request %@ from %s on %s(%u)");
        if (_IDSShouldLog())
        {
          v85 = __str;
          v86 = v10;
          v84 = v155;
          v80 = v96;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive binding request %@ from %s on %s(%u)");
        }
      }
    }

    __memcpy_chk();
    Value = 0;
    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x3032000000;
    v134 = sub_1A7BA55D8;
    v135 = sub_1A7BA55E8;
    if (key && self->_tokenToStunCheckPairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, key);
    }

    v136 = Value;
    v91 = [*(*&buf[8] + 40) linkUUID];
    v104[0] = 0;
    v104[1] = v104;
    v104[2] = 0x3032000000;
    v104[3] = sub_1A7BA55D8;
    v104[4] = sub_1A7BA55E8;
    v105 = [[IDSStunMessage alloc] initWithType:257];
    v19 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v20 = [IDSSockAddrWrapper wrapperWithSockAddr:v153];
    if (v20)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-xormappedaddress", v20);
    }

    else
    {
      v21 = MEMORY[0x1E69E9C10];
      v22 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15DC8();
      }

      v20 = 0;
    }

    v89 = v20;

    v23 = self->_controlMessageKey;
    if (v23)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-messageintegrity", v23);
    }

    else
    {
      v24 = MEMORY[0x1E69E9C10];
      v25 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15B20();
      }
    }

    v26 = !self->_islocalCellAttributeInexpensive && [(IDSGlobalLink *)self _isInterfaceExpensiveWithInterfaceIndex:v10];
    if ([(IDSGlobalLink *)self _isInterfaceConstrainedWithInterfaceIndex:v10, v80, v84, v85, v86])
    {
      v26 |= 2u;
    }

    if (self->_remoteDeviceVersion >= 2 && [(IDSGlobalLink *)self _isInterfaceDelegatedWithInterfaceIndex:v10])
    {
      v26 |= 4u;
    }

    if ([(IDSGlobalLink *)self _isCLAT46Interface:&v145])
    {
      v27 = v26 | 8;
    }

    else
    {
      v27 = v26;
    }

    if ([(IDSGlobalLink *)self _isCellularInterfaceForCandidatePair:*(*&buf[8] + 40) localAddress:&v145]&& (v27 = v27 | self->_cellularSlicingFlags, [(IDSGlobalLink *)self _isSlicedCellularInterfaceActive:v10]))
    {
      v27 = v27 | 0x80;
    }

    else if (!v27)
    {
      goto LABEL_48;
    }

    v28 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v27];
    if (v28)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-link-attributes", v28);
    }

    else
    {
      v29 = MEMORY[0x1E69E9C10];
      v30 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15E50();
      }
    }

LABEL_48:
    if ([(IDSGlobalLink *)self _isCellularInterfaceForCandidatePair:*(*&buf[8] + 40) localAddress:&v145])
    {
      v31 = +[IDSCellularLinkMonitor sharedInstance];
      v32 = [v31 dataSoMaskBits];

      v33 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v32];
      if (v33)
      {
        CFDictionarySetValue(v19, @"ids-stun-attribute-data-so-masks-attributes", v33);
      }

      else
      {
        v34 = MEMORY[0x1E69E9C10];
        v35 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15ED8();
        }
      }
    }

    if (self->_isInitiator && (self->_remoteCapabilityFlag & 1) != 0)
    {
      v36 = v91;
      if (!v91)
      {
        v36 = [MEMORY[0x1E696AFB0] UUID];
      }

      memset(v132, 170, sizeof(v132));
      v91 = v36;
      [v36 getUUIDBytes:v132];
      v37 = [MEMORY[0x1E695DEF0] dataWithBytes:v132 length:16];
      if (v37)
      {
        CFDictionarySetValue(v19, @"ids-stun-attribute-linkuuid", v37);
      }

      else
      {
        v38 = MEMORY[0x1E69E9C10];
        v39 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15BA8();
        }
      }
    }

    v40 = [MEMORY[0x1E696AEC0] stringWithCString:__str encoding:4];
    v41 = [MEMORY[0x1E696AEC0] stringWithCString:v155 encoding:4];
    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BA55F0;
    aBlock[3] = &unk_1E77E1130;
    v113 = buf;
    aBlock[4] = self;
    v119 = v149;
    v120 = v150;
    v121 = v151;
    v122 = v152;
    v115 = v145;
    v116 = v146;
    v117 = v147;
    v118 = v148;
    v125 = v139;
    v126 = v140;
    v123 = v137;
    v124 = v138;
    v129 = v143;
    v130 = v144;
    v127 = v141;
    v128 = v142;
    v114 = v104;
    v42 = v96;
    v108 = v42;
    v90 = v19;
    v109 = v90;
    v88 = v40;
    v110 = v88;
    v43 = v41;
    v111 = v43;
    v131 = v10;
    v87 = key;
    v112 = v87;
    v92 = _Block_copy(aBlock);
    if ([v42 getAttribute:32775 attribute:__b])
    {
      if (__b[2] >= 0xAu)
      {
        v44 = 10;
      }

      else
      {
        v44 = __b[2];
      }

      v45 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
      {
        v46 = IDSRadioAccessTechnologyToString(v44);
        *v132 = 136315138;
        *&v132[4] = v46;
        _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "receive remote cellular RAT [%s].", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v81 = IDSRadioAccessTechnologyToString(v44);
          _IDSLogTransport(@"GL", @"IDS", @"receive remote cellular RAT [%s].");
          if (_IDSShouldLog())
          {
            v81 = IDSRadioAccessTechnologyToString(v44);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive remote cellular RAT [%s].");
          }
        }
      }
    }

    else
    {
      v44 = 0;
    }

    v47 = *(*&buf[8] + 40);
    if (!v47)
    {
      if (BYTE1(v137) == 30)
      {
        v48 = 6;
      }

      else
      {
        v48 = 5;
      }

      if (v44)
      {
        v49 = v44 == 9;
      }

      else
      {
        v49 = 1;
      }

      v50 = !v49;
      v51 = [IDSStunCandidate candidateWithType:2 transport:1 radioAccessTechnology:v44 mtu:GLUtilGetLocalMTU(v48 index:v50) address:0xFFFFFFFFLL external:&v137, &v137];
      v52 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
      {
        *v132 = 138412290;
        *&v132[4] = v51;
        _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "discover remote prlx candidate %@.", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v82 = v51;
          _IDSLogTransport(@"GL", @"IDS", @"discover remote prlx candidate %@.");
          if (_IDSShouldLog())
          {
            v82 = v51;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"discover remote prlx candidate %@.");
          }
        }
      }

      if ([(IDSGlobalLink *)self _addCandidate:v51 isRemoteCandidate:1, v82])
      {
        [(IDSGlobalLink *)self _addStunCheckPair:v51 isRemoteCandidate:1 excludeLocalAddress:&v145];
      }

      v102 = 0u;
      v103 = 0u;
      v100 = 0u;
      v101 = 0u;
      v53 = self->_interfaceAddressArray;
      v54 = [(NSMutableArray *)v53 countByEnumeratingWithState:&v100 objects:v106 count:16];
      if (v54)
      {
        v55 = v43;
        v56 = *v101;
        while (2)
        {
          for (i = 0; i != v54; ++i)
          {
            if (*v101 != v56)
            {
              objc_enumerationMutation(v53);
            }

            v58 = *(*(&v100 + 1) + 8 * i);
            if ([v58 index] == v10)
            {
              v43 = v55;
              if ([v58 isCellular])
              {
                v59 = +[IDSCellularLinkMonitor sharedInstance];
                v54 = [v59 radioAccessTechnology];
              }

              else if ([v58 isWired])
              {
                v54 = 9;
              }

              else
              {
                v54 = 0;
              }

              goto LABEL_108;
            }
          }

          v54 = [(NSMutableArray *)v53 countByEnumeratingWithState:&v100 objects:v106 count:16];
          if (v54)
          {
            continue;
          }

          break;
        }

        v43 = v55;
      }

LABEL_108:

      if (v54)
      {
        v60 = v54 == 9;
      }

      else
      {
        v60 = 1;
      }

      v61 = !v60;
      if (BYTE1(v145) == 30)
      {
        v62 = 6;
      }

      else
      {
        v62 = 5;
      }

      v63 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:v54 mtu:GLUtilGetLocalMTU(v62 index:v61) address:v10 external:&v145, &v145];
      [(IDSGlobalLink *)self _addCandidate:v63 isRemoteCandidate:0];
      v64 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v63 remoteCandidate:v51 sessionID:self->_cbuuid delegate:self];
      v65 = *(*&buf[8] + 40);
      *(*&buf[8] + 40) = v64;

      if (self->_isInitiator)
      {
        v66 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
        {
          *v132 = 138412290;
          *&v132[4] = v91;
          _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, "use linkUUID %@ for triggered check.", v132, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v83 = v91;
            _IDSLogTransport(@"GL", @"IDS", @"use linkUUID %@ for triggered check.");
            if (_IDSShouldLog())
            {
              v83 = v91;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"use linkUUID %@ for triggered check.");
            }
          }
        }

        [*(*&buf[8] + 40) setLinkUUID:{v91, v83}];
      }

      if (!self->_tokenToStunCheckPairs)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
        self->_tokenToStunCheckPairs = Mutable;
      }

      v69 = *(*&buf[8] + 40);
      if (v69)
      {
        CFDictionarySetValue(self->_tokenToStunCheckPairs, v87, v69);
      }

      else
      {
        v70 = MEMORY[0x1E69E9C10];
        v71 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v70, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15F60();
        }
      }

      v72 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
      {
        v73 = *(*&buf[8] + 40);
        *v132 = 138412290;
        *&v132[4] = v73;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "add stun check pair %@.", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v83 = *(*&buf[8] + 40);
          _IDSLogTransport(@"GL", @"IDS", @"add stun check pair %@.");
          if (_IDSShouldLog())
          {
            v83 = *(*&buf[8] + 40);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"add stun check pair %@.");
          }
        }
      }

      [(IDSGlobalLink *)self registerP2PCandidatePairWithLinkEngine:*(*&buf[8] + 40), v83];

      v47 = *(*&buf[8] + 40);
    }

    v74 = [v47 linkMetrics];
    [v74 receiveBindingRequest];

    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:*(*&buf[8] + 40)];
    if ([v42 getAttribute:32776 attribute:__b])
    {
      v75 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&__b[3]];
      [(IDSGlobalLink *)self _processRemoteLinkUUID:v75 candidatePair:*(*&buf[8] + 40)];
    }

    if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
    {
      goto LABEL_144;
    }

    v76 = [*(*&buf[8] + 40) local];
    if ([v76 isCellularStunCandidate])
    {
      allowTLEOverCellular = self->_allowTLEOverCellular;

      if (!allowTLEOverCellular)
      {
LABEL_144:
        v92[2]();
LABEL_147:

        _Block_object_dispose(v104, 8);
        _Block_object_dispose(buf, 8);

        goto LABEL_148;
      }
    }

    else
    {
    }

    v78 = *(*&buf[8] + 40);
    v97[0] = MEMORY[0x1E69E9820];
    v97[1] = 3221225472;
    v97[2] = sub_1A7BA5890;
    v97[3] = &unk_1E77E1158;
    v98 = v90;
    v99 = v92;
    [(IDSGlobalLink *)self _attemptP2PNegotiationForSTUNMessage:v42 candidatePair:v78 completionHandler:v97];

    goto LABEL_147;
  }

  v16 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138413058;
    *&buf[4] = v96;
    *&buf[12] = 2080;
    *&buf[14] = v155;
    *&buf[22] = 2080;
    v134 = __str;
    LOWORD(v135) = 1024;
    *(&v135 + 2) = v10;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "ignoring self binding request %@ from %s on %s(%u)", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"ignoring self binding request %@ from %s on %s(%u)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"ignoring self binding request %@ from %s on %s(%u)");
      }
    }
  }

LABEL_148:

  return !v94;
}

- (void)_attemptP2PNegotiationForSTUNMessage:(id)a3 candidatePair:(id)a4 completionHandler:(id)a5
{
  v31 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  nextP2PNegotiationAttempt = self->_nextP2PNegotiationAttempt;
  self->_nextP2PNegotiationAttempt = nextP2PNegotiationAttempt + 1;
  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    *&buf[4] = nextP2PNegotiationAttempt;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v20 = nextP2PNegotiationAttempt;
      _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]");
      if (_IDSShouldLog())
      {
        v20 = nextP2PNegotiationAttempt;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]");
      }
    }
  }

  if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
  {
    goto LABEL_10;
  }

  v13 = [v9 local];
  if ([v13 isCellularStunCandidate])
  {
    allowTLEOverCellular = self->_allowTLEOverCellular;

    if (!allowTLEOverCellular)
    {
LABEL_10:
      (*(v10 + 2))(v10, 0, 0);
      goto LABEL_35;
    }
  }

  else
  {
  }

  memset(buf, 170, 0x5D0uLL);
  if ([v8 getAttribute:36866 attribute:buf])
  {
    v15 = *&buf[8];
  }

  else
  {
    v15 = 0;
  }

  if ([v8 getAttribute:36867 attribute:buf])
  {
    v16 = *&buf[8];
  }

  else
  {
    v16 = 0;
  }

  if (v15 && v16 && [v8 getAttribute:36865 attribute:buf])
  {
    v17 = [MEMORY[0x1E695DEF0] dataWithBytes:&buf[12] length:*&buf[8]];
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      *v24 = 134218498;
      v25 = nextP2PNegotiationAttempt;
      v26 = 2112;
      v27 = v17;
      v28 = 2112;
      v29 = v9;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@", v24, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = v17;
        v23 = v9;
        v21 = nextP2PNegotiationAttempt;
        _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@");
        if (_IDSShouldLog())
        {
          v22 = v17;
          v23 = v9;
          v21 = nextP2PNegotiationAttempt;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@");
        }
      }
    }

    [(IDSGlobalLink *)self _receiveP2PNegotiationBlob:v17 attemptID:nextP2PNegotiationAttempt remoteIDSConnectionID:v16 remoteAVCConnectionID:v15 candidatePair:v9 completionHandler:v10, v21, v22, v23];
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *v24 = 134217984;
      v25 = nextP2PNegotiationAttempt;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message", v24, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message");
        }
      }
    }

    (*(v10 + 2))(v10, 0, 0);
  }

LABEL_35:
}

- (void)_receiveP2PNegotiationBlob:(id)a3 attemptID:(unint64_t)a4 remoteIDSConnectionID:(unsigned int)a5 remoteAVCConnectionID:(unsigned int)a6 candidatePair:(id)a7 completionHandler:(id)a8
{
  v14 = a3;
  v15 = a7;
  v16 = a8;
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = sub_1A7BA6044;
  v20[3] = &unk_1E77E11F8;
  v21 = v15;
  v22 = v14;
  v24 = v16;
  v25 = a4;
  v26 = a6;
  v27 = a5;
  v23 = self;
  v17 = v16;
  v18 = v14;
  v19 = v15;
  [(IDSGlobalLink *)self _getP2PNegotiationForCandidatePair:v19 completionBlock:v20];
}

- (void)setUpP2PQUICPodConnectionsForCandidatePair:(id)a3 attemptID:(unint64_t)a4 completionHandler:(id)a5
{
  v21 = *MEMORY[0x1E69E9840];
  v7 = a3;
  v8 = a5;
  nwLink = self->_nwLink;
  cbuuid = self->_cbuuid;
  v11 = [v7 local];
  v12 = [v11 address];
  v13 = [v7 remote];
  v14 = [v13 address];
  v15 = [v7 QUICConnectionIDs];
  v16 = [v7 p2pNegotiatedKeys];
  LOBYTE(nwLink) = -[IDSNWLink createQUICPodP2PConnectionsForSession:localAddress:remoteAddress:quicConnectionIDs:negotiatedKeys:channelNumber:completionHandler:](nwLink, "createQUICPodP2PConnectionsForSession:localAddress:remoteAddress:quicConnectionIDs:negotiatedKeys:channelNumber:completionHandler:", cbuuid, v12, v14, v15, v16, [v7 channelNumber], v8);

  if ((nwLink & 1) == 0)
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v20 = a4;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections");
        }
      }
    }
  }
}

- (BOOL)_processBindingResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v11 = *&a5;
  v137 = *MEMORY[0x1E69E9840];
  v14 = a3;
  v59 = a4;
  v15 = a8;
  *&v16 = 0xAAAAAAAAAAAAAAAALL;
  *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v135 = v16;
  v136 = v16;
  v133 = v16;
  v134 = v16;
  v131 = v16;
  v132 = v16;
  v129 = v16;
  v130 = v16;
  v128 = v16;
  v127 = v16;
  v126 = v16;
  v125 = v16;
  v124 = v16;
  v123 = v16;
  v122 = v16;
  v121 = v16;
  __memcpy_chk();
  __memcpy_chk();
  v64 = 0;
  v65 = &v64;
  v66 = 0x2020000000;
  v67 = &v129;
  v60 = 0;
  v61 = &v60;
  v62 = 0x2020000000;
  v63 = &v121;
  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v120 = v17;
  v119 = v17;
  v118 = v17;
  v117 = v17;
  v116 = v17;
  v115 = v17;
  v114 = v17;
  *__str = v17;
  v112 = v17;
  v111 = v17;
  v110 = v17;
  v109 = v17;
  v108 = v17;
  v107 = v17;
  v106 = v17;
  *v105 = v17;
  memset(__b, 170, sizeof(__b));
  *&v18 = 0xAAAAAAAAAAAAAAAALL;
  *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v103[6] = v18;
  v103[7] = v18;
  v103[4] = v18;
  v103[5] = v18;
  v103[2] = v18;
  v103[3] = v18;
  v103[0] = v18;
  v103[1] = v18;
  SAToIPPortString(__str, 0x80uLL, &v129);
  SAToIPPortString(v105, 0x80uLL, v61[3]);
  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138413058;
    v96 = v14;
    v97 = 2080;
    v98 = v105;
    v99 = 2080;
    v100 = __str;
    v101 = 1024;
    v102 = v11;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive binding response %@ from %s on %s(%u)", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v56 = __str;
      v57 = v11;
      v52 = v14;
      v55 = v105;
      _IDSLogTransport(@"GL", @"IDS", @"receive binding response %@ from %s on %s(%u)");
      if (_IDSShouldLog())
      {
        v56 = __str;
        v57 = v11;
        v52 = v14;
        v55 = v105;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive binding response %@ from %s on %s(%u)");
      }
    }
  }

  Value = 0;
  if (v15 && self->_tokenToStunCheckPairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, v15);
  }

  v21 = Value;
  v22 = [v21 linkMetrics];
  [v22 receiveBindingResponse];

  [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v21];
  if (!v21)
  {
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v96 = v15;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
        }
      }
    }

    goto LABEL_47;
  }

  if ([v14 getAttribute:32776 attribute:__b])
  {
    v23 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&__b[3]];
    [(IDSGlobalLink *)self _processRemoteLinkUUID:v23 candidatePair:v21];
  }

  if (([v14 getAttribute:32 attribute:{__b, v52, v55, v56, v57}] & 1) == 0)
  {
    v29 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "failed to receive xor-mapped-address.", buf, 2u);
    }

    if (!os_log_shim_legacy_logging_enabled())
    {
      goto LABEL_47;
    }

    if (!_IDSShouldLogTransport())
    {
      goto LABEL_47;
    }

    _IDSLogTransport(@"GL", @"IDS", @"failed to receive xor-mapped-address.");
    if ((_IDSShouldLog() & 1) == 0)
    {
      goto LABEL_47;
    }

    v30 = @"failed to receive xor-mapped-address.";
    goto LABEL_46;
  }

  __memcpy_chk();
  if (!IsValidSA(v103))
  {
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "receive invalid xor-mapped-address.", buf, 2u);
    }

    if (!os_log_shim_legacy_logging_enabled())
    {
      goto LABEL_47;
    }

    if (!_IDSShouldLogTransport())
    {
      goto LABEL_47;
    }

    _IDSLogTransport(@"GL", @"IDS", @"receive invalid xor-mapped-address.");
    if (!_IDSShouldLog())
    {
      goto LABEL_47;
    }

    v30 = @"receive invalid xor-mapped-address.";
LABEL_46:
    _IDSLogV(0, @"IDSFoundation", @"GL", v30);
LABEL_47:
    v32 = 0;
    goto LABEL_48;
  }

  v24 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    v25 = SAToIPPortString(v105, 0x80uLL, v103);
    *buf = 136315138;
    v96 = v25;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive xor-mapped-address [%s].", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v53 = SAToIPPortString(v105, 0x80uLL, v103);
      _IDSLogTransport(@"GL", @"IDS", @"receive xor-mapped-address [%s].");
      if (_IDSShouldLog())
      {
        v53 = SAToIPPortString(v105, 0x80uLL, v103);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-mapped-address [%s].");
      }
    }
  }

  v26 = [v14 getAttribute:32803 attribute:{__b, v53}];
  if (__b[2])
  {
    v27 = v26;
  }

  else
  {
    v27 = 0;
  }

  if (v27 != 1)
  {
    goto LABEL_27;
  }

  if ((__b[2] & 0x80) != 0)
  {
    v58 = __b[2] & 0x7F | 0x80;
    goto LABEL_50;
  }

  v58 = __b[2] & 0x7F;
  if ((__b[2] & 0x7F) != 0)
  {
LABEL_50:
    v34 = [v21 remote];
    [v34 setLinkFlags:v58];

    goto LABEL_51;
  }

LABEL_27:
  LOWORD(v58) = 0;
LABEL_51:
  v35 = [v14 getAttribute:32804 attribute:__b];
  v36 = __b[2];
  if (__b[2])
  {
    v37 = v35;
  }

  else
  {
    v37 = 0;
  }

  if (v37 == 1)
  {
    v38 = [v21 remote];
    [v38 setDataSoMask:v36];
  }

  else
  {
    LODWORD(v36) = 0;
  }

  v39 = [v21 local];
  v40 = [v39 external];

  if (IsSameSA(v40, v103))
  {
    v41 = 0;
    v42 = 0;
  }

  else
  {
    v43 = [v21 local];
    v44 = [v43 radioAccessTechnology];

    v45 = [v21 local];
    v46 = [v45 mtu];

    v41 = [IDSStunCandidate candidateWithType:2 transport:1 radioAccessTechnology:v44 mtu:v46 index:v11 address:v65[3] external:v103];
    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v96 = v41;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "discover local prlx candidate %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v54 = v41;
        _IDSLogTransport(@"GL", @"IDS", @"discover local prlx candidate %@.");
        if (_IDSShouldLog())
        {
          v54 = v41;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"discover local prlx candidate %@.");
        }
      }
    }

    v42 = [(IDSGlobalLink *)self _addCandidate:v41 isRemoteCandidate:0, v54];
    v48 = [v21 local];
    [v41 setIsCLAT46:{objc_msgSend(v48, "isCLAT46")}];

    v49 = [v21 local];
    [v41 setCellularSlicingFlags:{objc_msgSend(v49, "cellularSlicingFlags")}];
  }

  v68[0] = MEMORY[0x1E69E9820];
  v68[1] = 3221225472;
  v68[2] = sub_1A7BA7680;
  v68[3] = &unk_1E77E1220;
  v79 = v133;
  v80 = v134;
  v81 = v135;
  v82 = v136;
  v75 = v129;
  v76 = v130;
  v77 = v131;
  v78 = v132;
  v73 = &v64;
  v74 = &v60;
  v89 = v127;
  v90 = v128;
  v87 = v125;
  v88 = v126;
  v85 = v123;
  v86 = v124;
  v83 = v121;
  v84 = v122;
  v50 = v21;
  v69 = v50;
  v70 = self;
  v71 = v15;
  v94 = v42;
  v51 = v41;
  v72 = v51;
  v93 = v58;
  v92 = v36;
  v91 = a9;
  [(IDSGlobalLink *)self _attemptP2PNegotiationForSTUNMessage:v14 candidatePair:v50 completionHandler:v68];

  v32 = 1;
LABEL_48:

  _Block_object_dispose(&v60, 8);
  _Block_object_dispose(&v64, 8);

  return v32;
}

- (void)_discardNonSlicedP2PCandidatePairs
{
  v45 = *MEMORY[0x1E69E9840];
  if (self->_cellInterfaceName)
  {
    v3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v32 = 0u;
    v33 = 0u;
    v34 = 0u;
    v35 = 0u;
    v4 = [v3 countByEnumeratingWithState:&v32 objects:v44 count:16];
    if (!v4)
    {
      goto LABEL_21;
    }

    v6 = v4;
    v7 = *v33;
    v26 = v29;
    v8 = 0x1E77DB000uLL;
    *&v5 = 138413058;
    v25 = v5;
    v27 = v3;
    while (1)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v33 != v7)
        {
          objc_enumerationMutation(v3);
        }

        v10 = *(*(&v32 + 1) + 8 * i);
        v11 = [v10 local];
        v12 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [v11 index]);

        if (([v10 isRelayStunCandidatePair] & 1) == 0)
        {
          v13 = [v10 local];
          if ([v13 isCellularStunCandidate])
          {
            v14 = [(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v12];

            if (v14)
            {
              goto LABEL_19;
            }

            v15 = [*(v8 + 3824) sharedInstanceForBagType:0];
            v13 = [v15 objectForKey:@"ids-delay-for-cellular-default-and-slicing"];

            if (v13 && (objc_opt_class(), (objc_opt_isKindOfClass() & 1) != 0))
            {
              v16 = [v13 unsignedIntegerValue];
              v17 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                cellInterfaceName = self->_cellInterfaceName;
                *buf = v25;
                v37 = v12;
                v38 = 2112;
                v39 = cellInterfaceName;
                v40 = 2112;
                v41 = v10;
                v42 = 1024;
                v43 = v16;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ will discard existing pair: %@ in %u seconds.", buf, 0x26u);
              }

              v19 = [MEMORY[0x1E6995700] weakRefWithObject:self];
              v20 = dispatch_time(0, 1000000000 * v16);
              v21 = im_primary_queue();
              block[0] = MEMORY[0x1E69E9820];
              block[1] = 3221225472;
              v29[0] = sub_1A7BA8744;
              v29[1] = &unk_1E77E0C88;
              v30 = v19;
              v31 = v10;
              v22 = v19;
              dispatch_after(v20, v21, block);

              v3 = v27;
              v8 = 0x1E77DB000;
            }

            else
            {
              v23 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
              {
                v24 = self->_cellInterfaceName;
                *buf = 138412802;
                v37 = v12;
                v38 = 2112;
                v39 = v24;
                v40 = 2112;
                v41 = v10;
                _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ discard existing pair: %@.", buf, 0x20u);
              }

              [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
              [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v10 withReason:13];
            }
          }
        }

LABEL_19:
      }

      v6 = [v3 countByEnumeratingWithState:&v32 objects:v44 count:16];
      if (!v6)
      {
LABEL_21:

        return;
      }
    }
  }
}

- (id)_filterNonSlicedLocalCandidates:(id)a3
{
  v28 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v6 = v4;
  v7 = [v6 countByEnumeratingWithState:&v19 objects:v27 count:16];
  if (v7)
  {
    v8 = *v20;
    do
    {
      v9 = 0;
      do
      {
        if (*v20 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v19 + 1) + 8 * v9);
        v11 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v24 = v10;
          _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_filterNonSlicedLocalCandidates: checking %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v17 = v10;
            _IDSLogTransport(@"GL", @"IDS", @"_filterNonSlicedLocalCandidates: checking %@");
            if (_IDSShouldLog())
            {
              v17 = v10;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_filterNonSlicedLocalCandidates: checking %@");
            }
          }
        }

        v12 = [(IDSGlobalLink *)self _interfaceNameForInterfaceIndexIncludingVPN:[(NSString *)v10 index:v17]];
        if (self->_cellInterfaceName && [(NSString *)v10 isCellularStunCandidate]&& ([(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v12]& 1) == 0)
        {
          v13 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
          {
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            v24 = cellInterfaceName;
            v25 = 2112;
            v26 = v12;
            _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_filterNonSlicedLocalCandidates: skipping because %@ does not match %@", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v17 = self->_cellInterfaceName;
              v18 = v12;
              _IDSLogTransport(@"GL", @"IDS", @"_filterNonSlicedLocalCandidates: skipping because %@ does not match %@");
              if (_IDSShouldLog())
              {
                v17 = self->_cellInterfaceName;
                v18 = v12;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_filterNonSlicedLocalCandidates: skipping because %@ does not match %@");
              }
            }
          }
        }

        else if (v5 && v10)
        {
          CFArrayAppendValue(v5, v10);
        }

        ++v9;
      }

      while (v7 != v9);
      v15 = [v6 countByEnumeratingWithState:&v19 objects:v27 count:16];
      v7 = v15;
    }

    while (v15);
  }

  return v5;
}

- (void)_updateInterfaceAddressesWithAddList:(id)a3 removeList:(id)a4
{
  v25 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if (!self->_interfaceAddressArray)
  {
    v8 = objc_alloc_init(MEMORY[0x1E695DF70]);
    interfaceAddressArray = self->_interfaceAddressArray;
    self->_interfaceAddressArray = v8;
  }

  if ([v6 count])
  {
    [(NSMutableArray *)self->_interfaceAddressArray addObjectsFromArray:v6];
  }

  if ([v7 count])
  {
    [(NSMutableArray *)self->_interfaceAddressArray removeObjectsInArray:v7];
  }

  v20 = 0u;
  v21 = 0u;
  v18 = 0u;
  v19 = 0u;
  v10 = self->_interfaceAddressArray;
  v11 = [(NSMutableArray *)v10 countByEnumeratingWithState:&v18 objects:v24 count:16];
  if (v11)
  {
    v12 = 0;
    v13 = *v19;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v19 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v18 + 1) + 8 * i);
        if ([v15 isCellular])
        {
          if (!v12)
          {
            v12 = objc_alloc_init(MEMORY[0x1E696AD50]);
          }

          [v12 addIndex:{objc_msgSend(v15, "index")}];
        }
      }

      v11 = [(NSMutableArray *)v10 countByEnumeratingWithState:&v18 objects:v24 count:16];
    }

    while (v11);

    if (v12)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v23 = v12;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "current cellular interface indices: %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v17 = v12;
          _IDSLogTransport(@"GL", @"IDS", @"current cellular interface indices: %@");
          if (_IDSShouldLog())
          {
            v17 = v12;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"current cellular interface indices: %@");
          }
        }
      }

      [(IDSUDPLink *)self->_udpLink setCellularInterfaceIndices:v12, v17];
      [(IDSUDPLink *)self->_udpLinkv6 setCellularInterfaceIndices:v12];
      [(IDSTCPLink *)self->_tcpLink setCellularInterfaceIndices:v12];
      [(IDSTCPLink *)self->_tcpSSLLink setCellularInterfaceIndices:v12];
      [(IDSNWLink *)self->_nwLink setCellularInterfaceIndices:v12];
    }
  }

  else
  {

    v12 = 0;
  }

  [(IDSGlobalLink *)self _generateTransportScoreCard];
  [(IDSGlobalLink *)self _updateAllLinks];
}

- (void)_generateTransportScoreCard
{
  v57 = *MEMORY[0x1E69E9840];
  transportScoreCards = self->_transportScoreCards;
  if (!transportScoreCards)
  {
    v4 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v5 = self->_transportScoreCards;
    self->_transportScoreCards = v4;

    transportScoreCards = self->_transportScoreCards;
  }

  [(NSMutableArray *)transportScoreCards removeAllObjects];
  v49 = 0u;
  v50 = 0u;
  v47 = 0u;
  v48 = 0u;
  obj = self->_interfaceAddressArray;
  v41 = [(NSMutableArray *)obj countByEnumeratingWithState:&v47 objects:v56 count:16];
  if (v41)
  {
    v40 = *v48;
    do
    {
      v6 = 0;
      do
      {
        if (*v48 != v40)
        {
          v7 = v6;
          objc_enumerationMutation(obj);
          v6 = v7;
        }

        v42 = v6;
        v8 = *(*(&v47 + 1) + 8 * v6);
        if ([v8 IPVersion] || !objc_msgSend(v8, "clat46") || self->_disablePureLinkFeature)
        {
          if (!self->_cellInterfaceName || ![v8 isCellular] || (objc_msgSend(v8, "name"), v9 = objc_claimAutoreleasedReturnValue(), v10 = objc_msgSend(v9, "isEqualToIgnoringCase:", self->_cellInterfaceName), v9, (v10 & 1) != 0))
          {
            v11 = [v8 index];
            v12 = [v8 delegatedName];

            v13 = [v8 isWired];
            if (v12)
            {
              if (v13)
              {
                v14 = 31;
                v15 = 4;
                goto LABEL_30;
              }

              v16 = [v8 isCellular];
              v17 = v16 == 0;
              if (v16)
              {
                v14 = 1;
              }

              else
              {
                v14 = 25;
              }

              v18 = 5;
LABEL_27:
              if (v17)
              {
                v15 = v18;
              }

              else
              {
                v15 = v18 + 1;
              }

              goto LABEL_30;
            }

            if ((v13 & 1) == 0)
            {
              v19 = [v8 isCellular];
              v17 = v19 == 0;
              if (v19)
              {
                v14 = 3;
              }

              else
              {
                v14 = 27;
              }

              v18 = 2;
              goto LABEL_27;
            }

            v14 = 33;
            v15 = 1;
LABEL_30:
            v20 = [v8 IPVersion];
            if (v20 == 1)
            {
              v14 *= 4;
            }

            else
            {
              [v8 IPVersion];
            }

            v21 = v20 == 1;
            v22 = 2;
            while (2)
            {
              if (v22 == 4)
              {
                shouldFallbackToTCPFirst = !self->_shouldFallbackToTCPFirst;
              }

              else
              {
                if (v22 != 3)
                {
                  if (v22 == 2)
                  {
                    v23 = 100 * v14;
                  }

                  else
                  {
                    v23 = v14;
                  }

LABEL_42:
                  v25 = objc_alloc_init(IDSTransportScoreCard);
                  v25->score = v23;
                  v25->stunTransport = v22;
                  v25->transportInterface = v15;
                  v25->interfaceIndex = v11;
                  v25->alreadySelected = 0;
                  v25->isIPv6 = v21;
                  [(NSMutableArray *)self->_transportScoreCards addObject:v25];

                  if (++v22 == 5)
                  {
                    v26 = [(NSDictionary *)self->_allocationsToTransportScoreCards allKeys];
                    v45 = 0u;
                    v46 = 0u;
                    v43 = 0u;
                    v44 = 0u;
                    v27 = [v26 countByEnumeratingWithState:&v43 objects:v51 count:16];
                    if (v27)
                    {
                      v28 = *v44;
                      do
                      {
                        for (i = 0; i != v27; ++i)
                        {
                          if (*v44 != v28)
                          {
                            objc_enumerationMutation(v26);
                          }

                          v30 = *(*(&v43 + 1) + 8 * i);
                          v31 = [objc_alloc(MEMORY[0x1E695DF70]) initWithArray:self->_transportScoreCards copyItems:1];
                          if (v31)
                          {
                            CFDictionarySetValue(self->_allocationsToTransportScoreCards, v30, v31);
                          }

                          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                          {
                            *buf = 138412546;
                            v53 = v30;
                            v54 = 2080;
                            v55 = "_allocationsToTransportScoreCards";
                            _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
                          }
                        }

                        v27 = [v26 countByEnumeratingWithState:&v43 objects:v51 count:16];
                      }

                      while (v27);
                    }

                    goto LABEL_55;
                  }

                  continue;
                }

                shouldFallbackToTCPFirst = self->_shouldFallbackToTCPFirst;
              }

              break;
            }

            v23 = v14 << shouldFallbackToTCPFirst;
            goto LABEL_42;
          }

          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            v33 = [v8 name];
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            v53 = v33;
            v54 = 2112;
            v55 = cellInterfaceName;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v37 = [v8 name];
              v38 = self->_cellInterfaceName;
              _IDSLogTransport(@"GL", @"IDS", @"Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!");

              if (_IDSShouldLog())
              {
                v37 = [v8 name];
                v38 = self->_cellInterfaceName;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!");
              }
            }
          }
        }

        else
        {
          v35 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v53 = v8;
            _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v37 = v8;
              _IDSLogTransport(@"GL", @"IDS", @"_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!");
              if (_IDSShouldLog())
              {
                v37 = v8;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!");
              }
            }
          }
        }

LABEL_55:
        v6 = v42 + 1;
      }

      while (v42 + 1 != v41);
      v36 = [(NSMutableArray *)obj countByEnumeratingWithState:&v47 objects:v56 count:16];
      v41 = v36;
    }

    while (v36);
  }
}

- (BOOL)_isUsingSameRATCandidatePair:(id)a3 transportScoreCard:(id)a4
{
  v5 = a3;
  v6 = a4;
  v7 = [v5 local];
  if ([v7 radioAccessTechnology] == 9)
  {
    v8 = v6[3];
    if (v8 == 1)
    {
      goto LABEL_21;
    }

    if (v8 == 4)
    {
      goto LABEL_24;
    }
  }

  else
  {
  }

  v7 = [v5 local];
  if ([v7 radioAccessTechnology])
  {

LABEL_8:
    v7 = [v5 local];
    if ([v7 radioAccessTechnology])
    {
      v9 = [v5 local];
      if ([v9 radioAccessTechnology] > 8)
      {
        LOBYTE(v8) = 0;
      }

      else
      {
        v10 = v6[3];
        LOBYTE(v8) = v10 == 3 || v10 == 6;
      }
    }

    else
    {
      LOBYTE(v8) = 0;
    }

    goto LABEL_21;
  }

  v12 = v6[3];
  if (v12 != 2)
  {

    if (v12 == 5)
    {
LABEL_24:
      LOBYTE(v8) = 1;
      goto LABEL_22;
    }

    goto LABEL_8;
  }

  LOBYTE(v8) = 1;
LABEL_21:

LABEL_22:
  return v8;
}

- (id)_transportInterfaceToString:(int64_t)a3
{
  if (a3 > 6)
  {
    return 0;
  }

  else
  {
    return off_1E77E13D0[a3];
  }
}

- (BOOL)_processRemovedLocalAddressList:(id)a3
{
  v88 = *MEMORY[0x1E69E9840];
  v76 = 0u;
  v77 = 0u;
  v78 = 0u;
  v79 = 0u;
  obj = a3;
  v58 = [obj countByEnumeratingWithState:&v76 objects:v87 count:16];
  if (v58)
  {
    v62 = 0;
    theArray = 0;
    v61 = 0;
    v3 = 0;
    v4 = 0;
    v57 = *v77;
    do
    {
      v5 = 0;
      do
      {
        if (*v77 != v57)
        {
          v6 = v5;
          objc_enumerationMutation(obj);
          v5 = v6;
        }

        v59 = v5;
        v7 = [*(*(&v76 + 1) + 8 * v5) address];
        v8 = [v7 sa];

        v9 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];

        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v10 = v9;
        v11 = [v10 countByEnumeratingWithState:&v72 objects:v86 count:16];
        if (v11)
        {
          v12 = *v73;
          do
          {
            for (i = 0; i != v11; ++i)
            {
              if (*v73 != v12)
              {
                objc_enumerationMutation(v10);
              }

              v14 = *(*(&v72 + 1) + 8 * i);
              v15 = [v14 local];
              v16 = IsSameIP(v8, [v15 address]);

              if (v16)
              {
                if (v4 || (v4 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
                {
                  v17 = [v14 candidatePairToken];
                  v18 = v17 == 0;

                  if (!v18)
                  {
                    v19 = [v14 candidatePairToken];
                    CFArrayAppendValue(v4, v19);
                  }
                }

                v20 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
                {
                  v21 = [v14 candidatePairToken];
                  *buf = 138412290;
                  v81 = v21;
                  _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "remove candidate pair %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v53 = [v14 candidatePairToken];
                    _IDSLogTransport(@"GL", @"IDS", @"remove candidate pair %@.");

                    if (_IDSShouldLog())
                    {
                      v53 = [v14 candidatePairToken];
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove candidate pair %@.");
                    }
                  }
                }

                [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v14 withReason:1, v53];
                LOBYTE(v62) = [v14 isActive] | v62;
                HIDWORD(v62) |= [v14 isNominated];
              }
            }

            v11 = [v10 countByEnumeratingWithState:&v72 objects:v86 count:16];
          }

          while (v11);
        }

        v22 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];

        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v61 = v22;
        v23 = [v61 countByEnumeratingWithState:&v68 objects:v85 count:16];
        if (v23)
        {
          v24 = *v69;
          do
          {
            for (j = 0; j != v23; ++j)
            {
              if (*v69 != v24)
              {
                objc_enumerationMutation(v61);
              }

              v26 = *(*(&v68 + 1) + 8 * j);
              v27 = [v26 local];
              v28 = IsSameIP(v8, [v27 address]);

              if (v28)
              {
                if (theArray || (theArray = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
                {
                  v29 = [v26 candidatePairToken];
                  v30 = v29 == 0;

                  if (!v30)
                  {
                    v31 = [v26 candidatePairToken];
                    CFArrayAppendValue(theArray, v31);
                  }
                }

                else
                {
                  theArray = 0;
                }

                v32 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
                {
                  v33 = [v26 candidatePairToken];
                  *buf = 138412290;
                  v81 = v33;
                  _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "remove stun check pair %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v53 = [v26 candidatePairToken];
                    _IDSLogTransport(@"GL", @"IDS", @"remove stun check pair %@.");

                    if (_IDSShouldLog())
                    {
                      v53 = [v26 candidatePairToken];
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove stun check pair %@.");
                    }
                  }
                }
              }
            }

            v23 = [v61 countByEnumeratingWithState:&v68 objects:v85 count:16];
          }

          while (v23);
        }

        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v34 = self->_localCandidateList;
        v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v64 objects:v84 count:16];
        if (v35)
        {
          v36 = *v65;
          do
          {
            for (k = 0; k != v35; ++k)
            {
              if (*v65 != v36)
              {
                objc_enumerationMutation(v34);
              }

              v38 = *(*(&v64 + 1) + 8 * k);
              if (IsSameIP(v8, [v38 address]))
              {
                if (!v3)
                {
                  v3 = objc_alloc_init(MEMORY[0x1E695DF70]);
                }

                if (v38)
                {
                  v39 = v3 == 0;
                }

                else
                {
                  v39 = 1;
                }

                if (!v39)
                {
                  CFArrayAppendValue(v3, v38);
                }

                v40 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  v81 = v38;
                  _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "remove local candidate %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v53 = v38;
                    _IDSLogTransport(@"GL", @"IDS", @"remove local candidate %@.");
                    if (_IDSShouldLog())
                    {
                      v53 = v38;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove local candidate %@.");
                    }
                  }
                }
              }
            }

            v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v64 objects:v84 count:16];
          }

          while (v35);
        }

        v5 = v59 + 1;
      }

      while (v59 + 1 != v58);
      v58 = [obj countByEnumeratingWithState:&v76 objects:v87 count:16];
    }

    while (v58);
  }

  else
  {
    v62 = 0;
    theArray = 0;
    v61 = 0;
    v3 = 0;
    v4 = 0;
  }

  if ([(__CFArray *)v4 count])
  {
    [(NSMutableDictionary *)self->_tokenToCandidatePairs removeObjectsForKeys:v4];
    v41 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
    {
      v42 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      *buf = 138412290;
      v81 = v42;
      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "remaining candidate pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v53 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining candidate pairs: %@.");

        if (_IDSShouldLog())
        {
          v53 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining candidate pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)theArray count])
  {
    [(NSMutableDictionary *)self->_tokenToStunCheckPairs removeObjectsForKeys:theArray];
    v43 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
    {
      v44 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
      *buf = 138412290;
      v81 = v44;
      _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "remaining stun check pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v54 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining stun check pairs: %@.");

        if (_IDSShouldLog())
        {
          v54 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining stun check pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)v3 count])
  {
    [(NSMutableArray *)self->_localCandidateList removeObjectsInArray:v3];
    v45 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
    {
      localCandidateList = self->_localCandidateList;
      *buf = 138412290;
      v81 = localCandidateList;
      _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "remaining local candidates: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v55 = self->_localCandidateList;
        _IDSLogTransport(@"GL", @"IDS", @"remaining local candidates: %@.");
        if (_IDSShouldLog())
        {
          v55 = self->_localCandidateList;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining local candidates: %@.");
        }
      }
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:obj, v55];
  }

  [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:0 removeList:obj];
  v47 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
  {
    interfaceAddressArray = self->_interfaceAddressArray;
    *buf = 138412290;
    v81 = interfaceAddressArray;
    _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "remaining local address list: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"remaining local address list: %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining local address list: %@.");
      }
    }
  }

  if ((v62 | BYTE4(v62)))
  {
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      v50 = @"NO";
      if (v62)
      {
        v51 = @"YES";
      }

      else
      {
        v51 = @"NO";
      }

      if ((v62 & 0x100000000) != 0)
      {
        v50 = @"YES";
      }

      *buf = 138412546;
      v81 = v51;
      v82 = 2112;
      v83 = v50;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "default/nominated link is removed(default:%@, nominated:%@).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"default/nominated link is removed(default:%@, nominated:%@).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"default/nominated link is removed(default:%@, nominated:%@).");
        }
      }
    }
  }

  return (v62 | BYTE4(v62)) & 1;
}

- (void)_processNewLocalAddressList:(id)a3
{
  v43 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v33 = self;
  [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:v4 removeList:0];
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    interfaceAddressArray = self->_interfaceAddressArray;
    *buf = 138412290;
    v42 = interfaceAddressArray;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "current local address list: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v29 = self->_interfaceAddressArray;
      _IDSLogTransport(@"GL", @"IDS", @"current local address list: %@.");
      if (_IDSShouldLog())
      {
        v29 = self->_interfaceAddressArray;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"current local address list: %@.");
      }
    }
  }

  v38 = 0u;
  v39 = 0u;
  v36 = 0u;
  v37 = 0u;
  obj = v4;
  v35 = [obj countByEnumeratingWithState:&v36 objects:v40 count:16];
  if (!v35)
  {

    v32 = 0;
LABEL_43:
    v27 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "no new valid local address is found, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"no new valid local address is found, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no new valid local address is found, ignore.");
        }
      }
    }

    goto LABEL_57;
  }

  v32 = 0;
  v7 = 0;
  v30 = 1;
  v34 = *v37;
  do
  {
    for (i = 0; i != v35; ++i)
    {
      if (*v37 != v34)
      {
        objc_enumerationMutation(obj);
      }

      v9 = *(*(&v36 + 1) + 8 * i);
      v10 = [v9 address];
      v11 = v10 == 0;

      if (!v11)
      {
        v12 = [v9 address];
        v13 = IsLinkLocalSA([v12 sa]);

        if (!v13)
        {
          v14 = [v9 address];
          v15 = *([v14 sa] + 1);

          v16 = [v9 isCellular];
          if (v16)
          {
            v17 = +[IDSCellularLinkMonitor sharedInstance];
            LODWORD(v18) = [v17 radioAccessTechnology];

            if (v18 >= 0xA)
            {
              v18 = 10;
            }

            else
            {
              v18 = v18;
            }
          }

          else if ([v9 isWired])
          {
            v18 = 9;
          }

          else
          {
            v18 = 0;
          }

          if (v15 == 30)
          {
            v19 = 6;
          }

          else
          {
            v19 = 5;
          }

          LocalMTU = GLUtilGetLocalMTU(v19, v16);
          v21 = [v9 index];
          v22 = [v9 address];
          v23 = [v22 sa];
          v24 = [v9 address];
          v29 = [v24 sa];
          v25 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:v18 mtu:LocalMTU index:v21 address:v23 external:?];

          if ([(IDSGlobalLink *)v33 _addCandidate:v25 isRemoteCandidate:0])
          {
            [(IDSGlobalLink *)v33 _addStunCheckPair:v25 isRemoteCandidate:0];
          }

          if (v15 != 30)
          {
            if (v33->_allowP2P)
            {
              [(IDSGlobalLink *)v33 _requestSelfAllocationForInterfaceAddress:v9];
            }

            v30 = 0;
          }

          v7 = 1;
          v32 = v25;
        }
      }
    }

    v35 = [obj countByEnumeratingWithState:&v36 objects:v40 count:16];
  }

  while (v35);

  if ((v7 & 1) == 0)
  {
    goto LABEL_43;
  }

  if (v30)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "new address list is IPv6 only, send connection data.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"new address list is IPv6 only, send connection data.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"new address list is IPv6 only, send connection data.");
        }
      }
    }

LABEL_56:
    [(IDSGlobalLink *)v33 _sendConnectionDataWithRemovedAddressList:0];
    goto LABEL_57;
  }

  if (!v33->_allowP2P)
  {
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "p2p is disabled, so send connection data immediately.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"p2p is disabled, so send connection data immediately.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"p2p is disabled, so send connection data immediately.");
        }
      }
    }

    goto LABEL_56;
  }

LABEL_57:
}

- (BOOL)_isSlicedCellularInterfaceActive:(unsigned int)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v15;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v15 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v14 + 1) + 8 * i);
        if ([v9 index] == a3)
        {
          v11 = +[IDSCellularLinkMonitor sharedInstance];
          v12 = [v9 name];
          v10 = [v11 isSlicedCellularInterfaceActive:v12];

          goto LABEL_11;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v10 = 0;
LABEL_11:

  return v10;
}

- (BOOL)_isCLAT46Interface:(sockaddr *)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v15;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v15 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v14 + 1) + 8 * i);
        v10 = [v9 address];
        v11 = [v10 sa];

        if (IsSameSA(v11, a3) && [v9 clat46] && a3->sa_family == 2)
        {
          v12 = 1;
          goto LABEL_13;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v12 = 0;
LABEL_13:

  return v12;
}

- (BOOL)_isInterfaceExpensiveWithInterfaceIndex:(unsigned int)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v12 + 1) + 8 * i);
        if ([v9 index] == a3)
        {
          v10 = [v9 expensive];
          goto LABEL_11;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v10 = 0;
LABEL_11:

  return v10;
}

- (BOOL)_isInterfaceConstrainedWithInterfaceIndex:(unsigned int)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v12 + 1) + 8 * i);
        if ([v9 index] == a3 && (objc_msgSend(v9, "constrained") & 1) != 0)
        {
          v10 = 1;
          goto LABEL_12;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v10 = 0;
LABEL_12:

  return v10;
}

- (BOOL)_isInterfaceDelegatedWithInterfaceIndex:(unsigned int)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v14;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        if ([v9 index] == a3)
        {
          v10 = [v9 delegatedName];

          if (v10)
          {
            v11 = 1;
            goto LABEL_12;
          }
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v13 objects:v17 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_12:

  return v11;
}

- (id)_interfaceNameForInterfaceIndex:(unsigned int)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    v8 = &stru_1F1AC8480;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v10 = *(*(&v12 + 1) + 8 * i);
        if ([v10 index] == a3)
        {
          v8 = [v10 name];
          goto LABEL_12;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v8 = &stru_1F1AC8480;
  }

LABEL_12:

  return v8;
}

- (id)_interfaceNameForInterfaceIndexIncludingVPN:(unsigned int)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v5 = self->_interfaceAddressArray;
  v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v24 objects:v29 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v25;
LABEL_3:
    v9 = 0;
    while (1)
    {
      if (*v25 != v8)
      {
        objc_enumerationMutation(v5);
      }

      v10 = *(*(&v24 + 1) + 8 * v9);
      if ([v10 index] == a3)
      {
        break;
      }

      if (v7 == ++v9)
      {
        v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v24 objects:v29 count:16];
        if (v7)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v11 = [v10 name];
    v13 = [v10 delegatedIndex];

    if (!v13)
    {
      v12 = v11;
      goto LABEL_23;
    }

    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v5 = self->_interfaceAddressArray;
    v14 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v20 objects:v28 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v21;
      while (2)
      {
        for (i = 0; i != v15; ++i)
        {
          if (*v21 != v16)
          {
            objc_enumerationMutation(v5);
          }

          v18 = *(*(&v20 + 1) + 8 * i);
          if ([v18 index] == v13)
          {
            v12 = [v18 name];

            goto LABEL_21;
          }
        }

        v15 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v20 objects:v28 count:16];
        if (v15)
        {
          continue;
        }

        break;
      }
    }

    v12 = v11;
  }

  else
  {
LABEL_9:
    v11 = 0;
    v12 = 0;
  }

LABEL_21:

LABEL_23:

  return v12;
}

- (void)_processRemovedRemoteCandidates:(id)a3
{
  v61 = *MEMORY[0x1E69E9840];
  v43 = a3;
  v41 = self;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v54 = 0u;
  v55 = 0u;
  v52 = 0u;
  obj = v53 = 0u;
  v4 = [obj countByEnumeratingWithState:&v52 objects:v60 count:16];
  if (v4)
  {
    theArray = 0;
    v42 = *v53;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v53 != v42)
        {
          objc_enumerationMutation(obj);
        }

        v6 = *(*(&v52 + 1) + 8 * i);
        v7 = [v6 candidatePairToken];
        if ([v6 isRelayStunCandidatePair])
        {
          v8 = [v6 relayRemote];
          v9 = [v8 address];

          v50 = 0u;
          v51 = 0u;
          v48 = 0u;
          v49 = 0u;
          v10 = v43;
          v11 = [v10 countByEnumeratingWithState:&v48 objects:v59 count:16];
          if (v11)
          {
            v12 = *v49;
            while (2)
            {
              for (j = 0; j != v11; ++j)
              {
                if (*v49 != v12)
                {
                  objc_enumerationMutation(v10);
                }

                v14 = [*(*(&v48 + 1) + 8 * j) address];
                if (v14 != 0 && v9 != 0 && IsSameIP(v14, v9))
                {
                  v16 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412290;
                    v58 = v7;
                    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "remote interface is removed, disconnect relay candidate pair %@.", buf, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v35 = v7;
                      _IDSLogTransport(@"GL", @"IDS", @"remote interface is removed, disconnect relay candidate pair %@.");
                      if (_IDSShouldLog())
                      {
                        v35 = v7;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"remote interface is removed, disconnect relay candidate pair %@.");
                      }
                    }
                  }

                  if ([v6 isQUIC])
                  {
                    [(IDSGlobalLink *)v41 _sendQUICUnallocbindRequest:v7 reason:2];
                  }

                  else
                  {
                    [(IDSGlobalLink *)v41 _sendUnallocbindRequest:v7 stunMessage:0 reason:2];
                  }

                  goto LABEL_38;
                }
              }

              v11 = [v10 countByEnumeratingWithState:&v48 objects:v59 count:16];
              if (v11)
              {
                continue;
              }

              break;
            }
          }
        }

        else
        {
          v10 = [v6 remote];
          if ([v43 containsObject:v10])
          {
            [(IDSGlobalLink *)v41 _notifyCandidatePairDisconnected:v6 withReason:2];
            v15 = theArray;
            if (theArray || (v15 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              if (v7)
              {
                CFArrayAppendValue(v15, v7);
              }
            }

            theArray = v15;
            v17 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v58 = v7;
              _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "remove candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v35 = v7;
                _IDSLogTransport(@"GL", @"IDS", @"remove candidate pair %@.");
                if (_IDSShouldLog())
                {
                  v35 = v7;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remove candidate pair %@.");
                }
              }
            }
          }
        }

LABEL_38:
      }

      v4 = [obj countByEnumeratingWithState:&v52 objects:v60 count:16];
    }

    while (v4);
  }

  else
  {
    theArray = 0;
  }

  v18 = [(NSMutableDictionary *)v41->_tokenToStunCheckPairs allValues];

  v46 = 0u;
  v47 = 0u;
  v44 = 0u;
  v45 = 0u;
  v19 = v18;
  v20 = 0;
  v21 = [v19 countByEnumeratingWithState:&v44 objects:v56 count:16];
  if (v21)
  {
    v22 = *v45;
    do
    {
      for (k = 0; k != v21; ++k)
      {
        if (*v45 != v22)
        {
          objc_enumerationMutation(v19);
        }

        v24 = *(*(&v44 + 1) + 8 * k);
        if (([v24 isRelayStunCandidatePair] & 1) == 0)
        {
          v25 = [v24 remote];
          v26 = [v43 containsObject:v25];

          if (v26)
          {
            v27 = [v24 candidatePairToken];
            if (v20 || (v20 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              if (v27)
              {
                CFArrayAppendValue(v20, v27);
              }
            }

            v28 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v58 = v27;
              _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "remove stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v35 = v27;
                _IDSLogTransport(@"GL", @"IDS", @"remove stun check pair %@.");
                if (_IDSShouldLog())
                {
                  v35 = v27;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remove stun check pair %@.");
                }
              }
            }
          }
        }
      }

      v21 = [v19 countByEnumeratingWithState:&v44 objects:v56 count:16];
    }

    while (v21);
  }

  if ([v43 count])
  {
    [(NSMutableArray *)v41->_remoteCandidateList removeObjectsInArray:v43];
  }

  v29 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
  {
    remoteCandidateList = v41->_remoteCandidateList;
    *buf = 138412290;
    v58 = remoteCandidateList;
    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "remaining remote candidates: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = v41->_remoteCandidateList;
      _IDSLogTransport(@"GL", @"IDS", @"remaining remote candidates: %@.");
      if (_IDSShouldLog())
      {
        v35 = v41->_remoteCandidateList;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining remote candidates: %@.");
      }
    }
  }

  if ([(__CFArray *)theArray count])
  {
    [(NSMutableDictionary *)v41->_tokenToCandidatePairs removeObjectsForKeys:theArray];
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = [(NSMutableDictionary *)v41->_tokenToCandidatePairs allValues];
      *buf = 138412290;
      v58 = v32;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "remaining candidate pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v36 = [(NSMutableDictionary *)v41->_tokenToCandidatePairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining candidate pairs: %@.");

        if (_IDSShouldLog())
        {
          v36 = [(NSMutableDictionary *)v41->_tokenToCandidatePairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining candidate pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)v20 count])
  {
    [(NSMutableDictionary *)v41->_tokenToStunCheckPairs removeObjectsForKeys:v20];
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = [(NSMutableDictionary *)v41->_tokenToStunCheckPairs allValues];
      *buf = 138412290;
      v58 = v34;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "remaining stun check pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v37 = [(NSMutableDictionary *)v41->_tokenToStunCheckPairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining stun check pairs: %@.");

        if (_IDSShouldLog())
        {
          v38 = [(NSMutableDictionary *)v41->_tokenToStunCheckPairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining stun check pairs: %@.");
        }
      }
    }
  }
}

- (void)_processNewRemoteCandidates:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v18 = v4;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "new remote candidates %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v11 = v4;
      _IDSLogTransport(@"GL", @"IDS", @"new remote candidates %@.");
      if (_IDSShouldLog())
      {
        v11 = v4;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"new remote candidates %@.");
      }
    }
  }

  v14 = 0u;
  v15 = 0u;
  v12 = 0u;
  v13 = 0u;
  v6 = v4;
  v7 = [v6 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v7)
  {
    v8 = *v13;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v13 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v12 + 1) + 8 * i);
        if ([(IDSGlobalLink *)self _addCandidate:v10 isRemoteCandidate:1, v11])
        {
          [(IDSGlobalLink *)self _addStunCheckPair:v10 isRemoteCandidate:1];
        }
      }

      v7 = [v6 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v7);
  }
}

- (void)_setupRelayConnectionForNetworkAddressChangesHelper
{
  objc_initWeak(&location, self);
  v2[0] = MEMORY[0x1E69E9820];
  v2[1] = 3221225472;
  v2[2] = sub_1A7BAC058;
  v2[3] = &unk_1E77E0FC8;
  objc_copyWeak(&v3, &location);
  IDSTransportThreadAddBlock(v2);
  objc_destroyWeak(&v3);
  objc_destroyWeak(&location);
}

- (void)_setupRelayConnectionForNetworkAddressChanges
{
  v67 = *MEMORY[0x1E69E9840];
  [(IDSGlobalLink *)self _updateAllLinks];
  v50 = self;
  v3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v49 = GLUtilGetSharedSessionIDs(v3);

  if ([v49 count])
  {
    v4 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v61) = [v49 count];
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "set up new QR link for %d shared session(s).", buf, 8u);
    }

    v57 = 0u;
    v58 = 0u;
    v55 = 0u;
    v56 = 0u;
    v5 = v49;
    v6 = [v5 countByEnumeratingWithState:&v55 objects:v66 count:16];
    if (v6)
    {
      v7 = *v56;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v56 != v7)
          {
            objc_enumerationMutation(v5);
          }

          v9 = *(*(&v55 + 1) + 8 * i);
          v10 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v61 = v9;
            _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "set up new QR link for shared session %@.", buf, 0xCu);
          }

          v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          HasSharedRelayCandidatePairSucceededOrConnected = GLUtilHasSharedRelayCandidatePairSucceededOrConnected(v9, v11);

          if (HasSharedRelayCandidatePairSucceededOrConnected)
          {
            [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:v9];
          }
        }

        v6 = [v5 countByEnumeratingWithState:&v55 objects:v66 count:16];
      }

      while (v6);
    }
  }

  else if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:1])
  {
    if (self->_allowOnlyOneQR)
    {
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "skip set up new relay link because only one QR link is allowed.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip set up new relay link because only one QR link is allowed.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip set up new relay link because only one QR link is allowed.");
          }
        }
      }
    }

    else
    {
      v18 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "set up new QR link additionally with existing connected pair", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"set up new QR link additionally with existing connected pair");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"set up new QR link additionally with existing connected pair");
          }
        }
      }

      [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:0];
    }
  }

  else if (self->_allowOnlyOneQR)
  {
    if (!self->_connectReadyHandler)
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v15 = objc_opt_respondsToSelector();

      if (v15)
      {
        v16 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v61 = self;
          _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "all links are removed due to interface change, disconnect %@ immediately.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"all links are removed due to interface change, disconnect %@ immediately.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"all links are removed due to interface change, disconnect %@ immediately.");
            }
          }
        }

        v17 = objc_loadWeakRetained(&self->_delegate);
        [v17 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
      }
    }
  }

  else if (GLUtilHasDefaultInterface(self->_interfaceAddressArray))
  {
    v19 = [(IDSGlobalLink *)self _hasActiveAllocbindFailoverTimerForSessionID:self->_acceptedRelaySessionID];
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v21 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v22 = @"NO";
      v23 = _IDSLinkStateStrings[self->_state];
      if (v19)
      {
        v22 = @"YES";
      }

      *buf = 134218498;
      v61 = v21;
      v62 = 2112;
      v63 = v22;
      v64 = 2080;
      v65 = v23;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v25 = v19 ? @"YES" : @"NO";
      v47 = v25;
      v48 = _IDSLinkStateStrings[v50->_state];
      v46 = v24;
      _IDSLogTransport(@"GL", @"IDS", @"all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s");
      if (_IDSShouldLog())
      {
        v26 = [(NSMutableDictionary *)v50->_tokenToCandidatePairs count:v46];
        v47 = v25;
        v48 = _IDSLinkStateStrings[v50->_state];
        v46 = v26;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s");
      }
    }

    if (v19 || v50->_state == 2)
    {
      v27 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        acceptedRelaySessionID = v50->_acceptedRelaySessionID;
        *buf = 138412290;
        v61 = acceptedRelaySessionID;
        _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "try to reconnect to the QR server, accepted relay sessionID: %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v46 = v50->_acceptedRelaySessionID;
          _IDSLogTransport(@"GL", @"IDS", @"try to reconnect to the QR server, accepted relay sessionID: %@");
          if (_IDSShouldLog())
          {
            v46 = v50->_acceptedRelaySessionID;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"try to reconnect to the QR server, accepted relay sessionID: %@");
          }
        }
      }

      connectingCandidatePairSessionInfo = v50->_connectingCandidatePairSessionInfo;
      if (connectingCandidatePairSessionInfo && (v30 = v50->_acceptedRelaySessionID) != 0 && (v31 = CFDictionaryGetValue(connectingCandidatePairSessionInfo, v30)) != 0)
      {
        v32 = v31;
        [(NSMutableDictionary *)v50->_tokenToCandidatePairs allValues];
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v33 = v52 = 0u;
        v34 = [v33 countByEnumeratingWithState:&v51 objects:v59 count:16];
        if (v34)
        {
          v35 = *v52;
LABEL_67:
          v36 = 0;
          while (1)
          {
            if (*v52 != v35)
            {
              objc_enumerationMutation(v33);
            }

            v37 = *(*(&v51 + 1) + 8 * v36);
            v38 = [v37 sessionID];
            v39 = [v38 isEqualToString:v50->_acceptedRelaySessionID];

            if (v39)
            {
              break;
            }

            if (v34 == ++v36)
            {
              v34 = [v33 countByEnumeratingWithState:&v51 objects:v59 count:16];
              if (v34)
              {
                goto LABEL_67;
              }

              goto LABEL_73;
            }
          }

          v44 = v37;

          if (!v44)
          {
            goto LABEL_94;
          }

          if (v50->_useLinkEngine)
          {
            [(IDSGlobalLink *)v50 _updateAllLinks];
          }

          else
          {
            [(IDSGlobalLink *)v50 _handleAllocbindFailoverTimerWithTransportScoreCards:v44 failoverTimerOnCandidatePair:0 onInterface:0];
          }
        }

        else
        {
LABEL_73:

LABEL_94:
          v45 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "couldn't find candidatePair for accepted session, return", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"couldn't find candidatePair for accepted session, return");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"couldn't find candidatePair for accepted session, return");
              }
            }
          }
        }
      }

      else
      {
        v41 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "couldn't find accepted session, return", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"couldn't find accepted session, return");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"couldn't find accepted session, return");
            }
          }
        }
      }
    }

    else
    {
      v42 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
      {
        v43 = _IDSLinkStateStrings[v50->_state];
        *buf = 136315138;
        v61 = v43;
        _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "state = %s, try to setup New QR Link ", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v46 = _IDSLinkStateStrings[v50->_state];
          _IDSLogTransport(@"GL", @"IDS", @"state = %s, try to setup New QR Link ");
          if (_IDSShouldLog())
          {
            v46 = _IDSLinkStateStrings[v50->_state];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"state = %s, try to setup New QR Link ");
          }
        }
      }

      [(IDSGlobalLink *)v50 _setupNewQRLinkIfNecessary:0, v46, v47, v48];
    }
  }

  else
  {
    v40 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "default interface is not ready, skip setting up QR link.", buf, 2u);
    }
  }
}

- (void)handleNetworkAddressChanges:(BOOL)a3 hasIPv6AddressChange:(BOOL)a4
{
  v4 = a4;
  v79 = *MEMORY[0x1E69E9840];
  v61 = a3;
  if (a3 || a4)
  {
    if (self->_hasStarted)
    {
      v60 = a4;
      v5 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
      {
        v6 = @"NO";
        if (v61)
        {
          v7 = @"YES";
        }

        else
        {
          v7 = @"NO";
        }

        if (v4)
        {
          v6 = @"YES";
        }

        *buf = 138412546;
        v76 = v7;
        v77 = 2112;
        v78 = v6;
        _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "handleNetworkAddressChange (IPv4:%@, IPv6:%@).", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
      {
        v8 = v61 ? @"YES" : @"NO";
        v9 = v60 ? @"YES" : @"NO";
        v54 = v8;
        v56 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"handleNetworkAddressChange (IPv4:%@, IPv6:%@).");
        if (_IDSShouldLog())
        {
          v54 = v8;
          v56 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"handleNetworkAddressChange (IPv4:%@, IPv6:%@).");
        }
      }

      v10 = self;
      v11 = !self->_disallowWiFi;
      v12 = !self->_disallowCellular;
      if (self->_QUICForQREnabled)
      {
        if (![(IDSNWLink *)self->_nwLink hasListener])
        {
          v16 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddressWithNWLink:self->_QRIPv6Enabled wantsWiFi:v11 wantsCellular:v12];
          v14 = [v16 mutableCopy];

          v10 = self;
          v13 = self->_interfaceAddressArray;
          v58 = 0;
          goto LABEL_44;
        }

        v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
        v58 = [(IDSNWLink *)self->_nwLink copyCurrentNetworkInterfaces];
        [(NSMutableArray *)v13 addObjectsFromArray:v58];
        v14 = 0;
        goto LABEL_43;
      }

      if (v61)
      {
        if ([(IDSUDPLink *)self->_udpLink socket]!= -1)
        {
          v58 = [(IDSUDPLink *)self->_udpLink copyCurrentNetworkInterfaces];
          v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
          [(NSMutableArray *)v13 addObjectsFromArray:v58];
          v14 = 0;
          v10 = self;
LABEL_37:
          if (!v60)
          {
            goto LABEL_44;
          }

          if ([(IDSUDPLink *)v10->_udpLinkv6 socket]== -1)
          {
            v19 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:1 wantsWiFi:v11 wantsCellular:v12];
            v20 = [v19 mutableCopy];

            v21 = self->_interfaceAddressArray;
            v14 = v20;
            v13 = v21;
          }

          else
          {
            v18 = [(IDSUDPLink *)self->_udpLinkv6 copyCurrentNetworkInterfaces];

            if (!v13)
            {
              v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            [(NSMutableArray *)v13 addObjectsFromArray:v18, v54, v56];
            v58 = v18;
          }

LABEL_43:
          v10 = self;
LABEL_44:
          [(IDSGlobalLink *)v10 _delayProcessingCellularInterfaces:v13, v54];
          v63 = [IDSInterfaceAddress addressesFromInterfaceAddresses:v13];
          v22 = [IDSInterfaceAddress addressesFromInterfaceAddresses:self->_interfaceAddressArray];
          v71 = 0u;
          v72 = 0u;
          v69 = 0u;
          v70 = 0u;
          obj = v13;
          v23 = [(NSMutableArray *)obj countByEnumeratingWithState:&v69 objects:v74 count:16];
          if (v23)
          {
            v24 = *v70;
            do
            {
              for (i = 0; i != v23; ++i)
              {
                if (*v70 != v24)
                {
                  objc_enumerationMutation(obj);
                }

                v26 = *(*(&v69 + 1) + 8 * i);
                v27 = [v26 address];
                v28 = [v22 containsObject:v27];

                if ((v28 & 1) == 0)
                {
                  if (!v14)
                  {
                    v14 = objc_alloc_init(MEMORY[0x1E695DF70]);
                  }

                  if (v26)
                  {
                    v29 = v14 == 0;
                  }

                  else
                  {
                    v29 = 1;
                  }

                  if (!v29)
                  {
                    CFArrayAppendValue(v14, v26);
                  }
                }
              }

              v23 = [(NSMutableArray *)obj countByEnumeratingWithState:&v69 objects:v74 count:16];
            }

            while (v23);
          }

          v57 = [v14 count];
          if (v57)
          {
            v30 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v76 = v14;
              _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "new local address list: %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v55 = v14;
                _IDSLogTransport(@"GL", @"IDS", @"new local address list: %@");
                if (_IDSShouldLog())
                {
                  v55 = v14;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"new local address list: %@");
                }
              }
            }

            [(IDSGlobalLink *)self _processNewLocalAddressList:v14, v55];
          }

          v67 = 0u;
          v68 = 0u;
          v65 = 0u;
          v66 = 0u;
          v31 = self->_interfaceAddressArray;
          v32 = 0;
          v33 = [(NSMutableArray *)v31 countByEnumeratingWithState:&v65 objects:v73 count:16];
          if (v33)
          {
            v34 = *v66;
            do
            {
              for (j = 0; j != v33; ++j)
              {
                if (*v66 != v34)
                {
                  objc_enumerationMutation(v31);
                }

                v36 = *(*(&v65 + 1) + 8 * j);
                v37 = [v36 address];
                v38 = [v63 containsObject:v37];

                if ((v38 & 1) == 0)
                {
                  v39 = [v36 address];
                  v40 = *([v39 sa] + 1);

                  v41 = v40 == 2 && v61;
                  v42 = v40 == 30 && v60;
                  if (v41 || v42)
                  {
                    if (v32)
                    {
                      if (!v36)
                      {
                        continue;
                      }
                    }

                    else
                    {
                      v32 = objc_alloc_init(MEMORY[0x1E695DF70]);
                      if (!v36)
                      {
                        continue;
                      }
                    }

                    if (v32)
                    {
                      CFArrayAppendValue(v32, v36);
                    }
                  }
                }
              }

              v33 = [(NSMutableArray *)v31 countByEnumeratingWithState:&v65 objects:v73 count:16];
            }

            while (v33);
          }

          if ([(__CFArray *)v32 count])
          {
            v43 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v76 = v32;
              _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "removed local address list: %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v55 = v32;
                _IDSLogTransport(@"GL", @"IDS", @"removed local address list: %@.");
                if (_IDSShouldLog())
                {
                  v55 = v32;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"removed local address list: %@.");
                }
              }
            }

            [(IDSGlobalLink *)self _processRemovedLocalAddressList:v32, v55];
          }

          else if (!v57)
          {
LABEL_105:

            return;
          }

          if (self->_networkAddressChangeTimer)
          {
            v44 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
            {
              networkAddressChangeTimer = self->_networkAddressChangeTimer;
              *buf = 134217984;
              v76 = networkAddressChangeTimer;
              _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "delay set up new QR link already scheduled on timer: %p", buf, 0xCu);
            }
          }

          else
          {
            v46 = im_primary_queue();
            v47 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v46);
            v48 = self->_networkAddressChangeTimer;
            self->_networkAddressChangeTimer = v47;

            v49 = self->_networkAddressChangeTimer;
            v50 = dispatch_time(0, 2000000000);
            dispatch_source_set_timer(v49, v50, 0x77359400uLL, 0x5F5E100uLL);
            v51 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
            {
              v52 = self->_networkAddressChangeTimer;
              *buf = 134218240;
              v76 = 0x4000000000000000;
              v77 = 2048;
              v78 = v52;
              _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "delay set up new QR link for %.3f sec timer: %p", buf, 0x16u);
            }

            v53 = self->_networkAddressChangeTimer;
            handler[0] = MEMORY[0x1E69E9820];
            handler[1] = 3221225472;
            handler[2] = sub_1A7BAD790;
            handler[3] = &unk_1E77E0818;
            handler[4] = self;
            dispatch_source_set_event_handler(v53, handler);
            dispatch_resume(self->_networkAddressChangeTimer);
          }

          goto LABEL_105;
        }

        v17 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:0 wantsWiFi:v11 wantsCellular:v12];
        v14 = [v17 mutableCopy];

        v10 = self;
        v13 = self->_interfaceAddressArray;
      }

      else
      {
        v14 = 0;
        v13 = 0;
      }

      v58 = 0;
      goto LABEL_37;
    }

    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "handleNetworkAddressChange: _hasStarted is no; return.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"handleNetworkAddressChange: _hasStarted is no; return.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"handleNetworkAddressChange: _hasStarted is no; return.");
        }
      }
    }
  }
}

- (BOOL)_interfaceName:(id)a3 missingFrom:(id)a4
{
  v20 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v7 = [v6 countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v16;
    v10 = 1;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v16 != v9)
        {
          objc_enumerationMutation(v6);
        }

        v12 = [*(*(&v15 + 1) + 8 * i) name];
        v13 = [v12 isEqualToIgnoringCase:v5];

        v10 &= v13 ^ 1;
      }

      v8 = [v6 countByEnumeratingWithState:&v15 objects:v19 count:16];
    }

    while (v8);
  }

  else
  {
    v10 = 1;
  }

  return v10;
}

- (void)_processDelayedCellularInterfaces
{
  v9 = *MEMORY[0x1E69E9840];
  if (self->_delayedCellInterfaces)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      delayedCellInterfaces = self->_delayedCellInterfaces;
      *buf = 138412290;
      v8 = delayedCellInterfaces;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "process delayed cell interfaces:%@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v6 = self->_delayedCellInterfaces;
      _IDSLogTransport(@"GL", @"IDS", @"process delayed cell interfaces:%@");
      if (_IDSShouldLog())
      {
        v6 = self->_delayedCellInterfaces;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"process delayed cell interfaces:%@");
      }
    }

    [(IDSGlobalLink *)self _processNewLocalAddressList:self->_delayedCellInterfaces, v6];
    [(IDSGlobalLink *)self _setupRelayConnectionForNetworkAddressChanges];
    v5 = self->_delayedCellInterfaces;
    self->_delayedCellInterfaces = 0;
  }
}

- (void)_handleNewRATChange
{
  v13 = *MEMORY[0x1E69E9840];
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  v4 = [v3 radioAccessTechnology];

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 136315138;
    v12 = IDSRadioAccessTechnologyToString(v4);
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "handle cellular RAT change (newRAT:%s).", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(v4);
      _IDSLogTransport(@"GL", @"IDS", @"handle cellular RAT change (newRAT:%s).");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(v4);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"handle cellular RAT change (newRAT:%s).");
      }
    }
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v7 = objc_opt_respondsToSelector();

  if (v7)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = IDSRadioAccessTechnologyToString(v4);
      *buf = 136315138;
      v12 = v9;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "send didRATChange, newRAT:%s.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(v4);
      _IDSLogTransport(@"GL", @"IDS", @"send didRATChange, newRAT:%s.");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(v4);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send didRATChange, newRAT:%s.");
      }
    }

    v10 = objc_loadWeakRetained(&self->_delegate);
    [v10 link:self didRATChange:v4];
  }
}

- (void)handleCellularRATChange
{
  v33 = *MEMORY[0x1E69E9840];
  [(IDSGlobalLink *)self _handleNewRATChange];
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  v4 = [v3 cellularMTU];

  if (v4)
  {
    v27 = 0u;
    v28 = 0u;
    v25 = 0u;
    v26 = 0u;
    v5 = self->_localCandidateList;
    v6 = 0;
    v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v25 objects:v32 count:16];
    if (v7)
    {
      v8 = *v26;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v26 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v25 + 1) + 8 * i);
          if ([v10 isCellularStunCandidate] && objc_msgSend(v10, "mtu") != v4)
          {
            [v10 setMtu:v4];
            v6 = 1;
          }
        }

        v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v25 objects:v32 count:16];
      }

      while (v7);
    }

    [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v23 = 0u;
    v24 = 0u;
    v21 = 0u;
    v11 = v22 = 0u;
    v12 = [v11 countByEnumeratingWithState:&v21 objects:v31 count:16];
    if (v12)
    {
      v13 = *v22;
      do
      {
        for (j = 0; j != v12; ++j)
        {
          if (*v22 != v13)
          {
            objc_enumerationMutation(v11);
          }

          v15 = [*(*(&v21 + 1) + 8 * j) local];
          if ([v15 isCellularStunCandidate] && objc_msgSend(v15, "mtu") != v4)
          {
            [v15 setMtu:v4];
          }
        }

        v12 = [v11 countByEnumeratingWithState:&v21 objects:v31 count:16];
      }

      while (v12);
    }

    if (v6)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        v30 = v4;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send cellular MTU change event with new MTU %uB.", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v20 = v4;
          _IDSLogTransport(@"GL", @"IDS", @"send cellular MTU change event with new MTU %uB.");
          if (_IDSShouldLog())
          {
            v20 = v4;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send cellular MTU change event with new MTU %uB.");
          }
        }
      }

      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v18 = objc_opt_respondsToSelector();

      if (v18)
      {
        v19 = objc_loadWeakRetained(&self->_delegate);
        [v19 link:self didCellularMTUChange:v4];
      }
    }
  }

  [(IDSGlobalLink *)self _processDelayedCellularInterfaces];
}

- (unint64_t)headerOverhead
{
  v2 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (!v2)
  {
    return 255;
  }

  v3 = 4 * (*(v2 + 132) != 0);
  v4 = *(v2 + 9);
  if (v4 == 30)
  {
    return (v3 | 0x30);
  }

  else if (v4 == 2)
  {
    return (v3 + 28);
  }

  else
  {
    return 255;
  }
}

- (NSString)linkTypeString
{
  v2 = [(IDSGlobalLink *)self defaultLinkType];
  v3 = @"GlobalLink";
  if (v2 == 4)
  {
    v3 = @"GlobalLink-WWAN";
  }

  if (v2 == 3)
  {
    return @"GlobalLink-WiFi";
  }

  else
  {
    return &v3->isa;
  }
}

- (id)copyLinkStatsDict
{
  v3 = objc_alloc(MEMORY[0x1E695DF20]);
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalBytesReceived];
  v5 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalBytesSent];
  v6 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalPacketsReceived];
  v7 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalPacketsSent];
  v8 = [v3 initWithObjectsAndKeys:{v4, @"bytesReceived", v5, @"bytesSent", v6, @"packetsReceived", v7, @"packetsSent", 0}];

  return v8;
}

- (void)_reportSessionSetupTime
{
  v90 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isUPlusOneSession)
    {
      v4 = @"YES";
    }

    else
    {
      v4 = @"NO";
    }

    *buf = 138412290;
    *v80 = v4;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_reportSessionSetupTime (U+1:%@)", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v6 = self->_isUPlusOneSession ? @"YES" : @"NO";
    v69 = v6;
    _IDSLogTransport(@"GL", @"IDS", @"_reportSessionSetupTime (U+1:%@)");
    if (_IDSShouldLog())
    {
      if (self->_isUPlusOneSession)
      {
        v7 = @"YES";
      }

      else
      {
        v7 = @"NO";
      }

      v69 = v7;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_reportSessionSetupTime (U+1:%@)");
    }
  }

  v5.i64[0] = *&self->_allocbindEndTime;
  if (self->_isInitiator && ((skeStartTime = self->_skeStartTime, skeStartTime > 0.0) || self->_isUPlusOneSession && (skeStartTime = self->_remoteJoinedUPlusOneTime, skeStartTime > 0.0)))
  {
    p_firstClientPacketTime = &self->_firstClientPacketTime;
    v10 = *&self->_linkConnectTime;
    v11 = vdupq_lane_s64(*&v10.f64[0], 0);
    v11.f64[0] = skeStartTime;
    v74 = vmovn_s64(vcvtq_s64_f64(vmulq_f64(vsubq_f64(v10, v11), vdupq_n_s64(0x408F400000000000uLL))));
  }

  else
  {
    p_firstClientPacketTime = &self->_firstClientPacketTime;
    v74 = vmovn_s64(vcvtq_s64_f64(vmulq_f64(vsubq_f64(*&self->_linkConnectTime, vzip1q_s64(v5, *&self->_linkConnectTime)), vdupq_n_s64(0x408F400000000000uLL))));
    if (!self->_isInitiator)
    {
LABEL_23:
      v12 = ((self->_firstDataReceivedTime - *v5.i64) * 1000.0);
      goto LABEL_25;
    }
  }

  if (self->_isSecondOrLaterParticipant)
  {
    goto LABEL_23;
  }

  v12 = 0;
LABEL_25:
  allocbindEndTime = self->_allocbindEndTime;
  if (self->_maxLinkID >= 2)
  {
    v13 = self->_candidatePairs[1];
  }

  else
  {
    v13 = 0;
  }

  allocbindStartTime = self->_allocbindStartTime;
  v15 = v13;
  v16 = [(IDSStunCandidatePair *)v15 local];
  v17 = [v16 radioAccessTechnology];

  if (v17 >= 0xA)
  {
    v18 = 10;
  }

  else
  {
    v18 = v17;
  }

  v73 = v18;
  v19 = [(IDSStunCandidatePair *)v15 remote];
  v20 = [v19 radioAccessTechnology];

  if (v20 >= 0xA)
  {
    v21 = 10;
  }

  else
  {
    v21 = v20;
  }

  v72 = v21;
  v77 = 0u;
  v78 = 0u;
  v75 = 0u;
  v76 = 0u;
  v22 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = [v22 countByEnumeratingWithState:&v75 objects:v89 count:16];
  if (v23)
  {
    v24 = *v76;
    while (2)
    {
      for (i = 0; i != v23; ++i)
      {
        if (*v76 != v24)
        {
          objc_enumerationMutation(v22);
        }

        if ([*(*(&v75 + 1) + 8 * i) pendingRealloc])
        {
          v71 = 1;
          goto LABEL_44;
        }
      }

      v23 = [v22 countByEnumeratingWithState:&v75 objects:v89 count:16];
      if (v23)
      {
        continue;
      }

      break;
    }
  }

  v71 = 0;
LABEL_44:

  if (v12 >= 1)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *v80 = v12;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "received data duration: %d ms", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"received data duration: %d ms");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"received data duration: %d ms");
        }
      }
    }

    v27 = GLUCreateQRClientTimeEvent(310, 0, v15, self->_timeBase, v12);
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v29 = objc_opt_respondsToSelector();

    if (v29)
    {
      v30 = objc_loadWeakRetained(&self->_delegate);
      [v30 link:self didAddQREvent:v27];
    }
  }

  if (self->_isInitiator)
  {
    remoteJoinedUPlusOneTime = self->_skeStartTime;
    if (remoteJoinedUPlusOneTime != 0.0 && remoteJoinedUPlusOneTime < self->_allocbindEndTime)
    {
      v33 = ((*p_firstClientPacketTime - remoteJoinedUPlusOneTime) * 1000.0);
    }

    else
    {
      v33 = vadd_s32(vdup_lane_s32(v74, 1), v74).u32[0];
    }

    v46 = vcvtd_n_f64_u32(self->_acceptDelayU32, 0x10uLL) + HIWORD(self->_acceptDelayU32);
    if (remoteJoinedUPlusOneTime == 0.0)
    {
      if (!self->_isUPlusOneSession || (remoteJoinedUPlusOneTime = self->_remoteJoinedUPlusOneTime, remoteJoinedUPlusOneTime <= 0.0))
      {
        remoteJoinedUPlusOneTime = self->_allocbindEndTime;
      }
    }

    v45 = ((remoteJoinedUPlusOneTime - self->_inviteSentTime - v46) * 1000.0);
    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_isInitiator)
      {
        v48 = @"YES";
      }

      else
      {
        v48 = @"NO";
      }

      v49 = IDSRadioAccessTechnologyToString(v73);
      v50 = IDSRadioAccessTechnologyToString(v72);
      if (v71)
      {
        v51 = @"YES";
      }

      else
      {
        v51 = @"NO";
      }

      *buf = 67110914;
      *v80 = v33;
      *&v80[4] = 2112;
      *&v80[6] = v48;
      *&v80[14] = 2080;
      *&v80[16] = v49;
      *&v80[24] = 2080;
      *&v80[26] = v50;
      *&v80[34] = 1024;
      *&v80[36] = v45;
      v81 = 1024;
      v82 = v74.i32[0];
      v83 = 1024;
      v84 = v74.i32[1];
      v85 = 2112;
      v86[0] = v51;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).", buf, 0x42u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        IDSRadioAccessTechnologyToString(v73);
        IDSRadioAccessTechnologyToString(v72);
        _IDSLogTransport(@"GL", @"IDS", @"got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
        if (_IDSShouldLog())
        {
          IDSRadioAccessTechnologyToString(v73);
          IDSRadioAccessTechnologyToString(v72);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
        }
      }
    }

    v41 = objc_loadWeakRetained(&self->_delegate);
    v87 = @"gl-attr-acceptdelay";
    v44 = [MEMORY[0x1E696AD98] numberWithDouble:v46 * 1000.0];
    v88 = v44;
    v52 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v88 forKeys:&v87 count:1];
    [v41 link:self didReceiveReportEvent:v52];

    goto LABEL_93;
  }

  v34 = ((allocbindEndTime - allocbindStartTime) * 1000.0);
  v33 = v74.i32[1] + v74.i32[0] + v34;
  v35 = ((self->_firstDataReceivedTime - self->_calleeAcceptTime) * 1000.0);
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v37 = @"YES";
    }

    else
    {
      v37 = @"NO";
    }

    v38 = IDSRadioAccessTechnologyToString(v73);
    v39 = IDSRadioAccessTechnologyToString(v72);
    if (v71)
    {
      v40 = @"YES";
    }

    else
    {
      v40 = @"NO";
    }

    *buf = 67111170;
    *v80 = v74.i32[1] + v74.i32[0] + v34;
    *&v80[4] = 1024;
    *&v80[6] = v35;
    *&v80[10] = 2112;
    *&v80[12] = v37;
    *&v80[20] = 2080;
    *&v80[22] = v38;
    *&v80[30] = 2080;
    *&v80[32] = v39;
    v81 = 1024;
    v82 = ((allocbindEndTime - allocbindStartTime) * 1000.0);
    v83 = 1024;
    v84 = v74.i32[0];
    v85 = 1024;
    LODWORD(v86[0]) = v74.i32[1];
    WORD2(v86[0]) = 2112;
    *(v86 + 6) = v40;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).", buf, 0x48u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(v73);
      IDSRadioAccessTechnologyToString(v72);
      _IDSLogTransport(@"GL", @"IDS", @"got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(v73);
        IDSRadioAccessTechnologyToString(v72);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
      }
    }
  }

  if (v35 >= 1)
  {
    v41 = GLUCreateQRClientTimeEvent(302, 0, v15, self->_timeBase, v35);
    v42 = objc_loadWeakRetained(&self->_delegate);
    v43 = objc_opt_respondsToSelector();

    if ((v43 & 1) == 0)
    {
      v45 = 0;
      goto LABEL_94;
    }

    v44 = objc_loadWeakRetained(&self->_delegate);
    [v44 link:self didAddQREvent:v41];
    v45 = 0;
LABEL_93:

LABEL_94:
    goto LABEL_95;
  }

  v45 = 0;
LABEL_95:
  if (v33 >= 1)
  {
    GLUtilReportAWDClientTimerEvent(301, 0, v15, self->_enableSKE, self->_isInitiator, v33);
    v53 = GLUCreateQRClientTimeEvent(301, 0, v15, self->_timeBase, v33);
    v54 = objc_loadWeakRetained(&self->_delegate);
    v55 = objc_opt_respondsToSelector();

    if (v55)
    {
      v56 = objc_loadWeakRetained(&self->_delegate);
      [v56 link:self didAddQREvent:v53];
    }
  }

  if (v74.i32[0] >= 1)
  {
    GLUtilReportAWDClientTimerEvent(305, 0, v15, self->_enableSKE, self->_isInitiator, v74.u32[0]);
    v57 = GLUCreateQRClientTimeEvent(305, 0, v15, self->_timeBase, v74.u32[0]);
    v58 = objc_loadWeakRetained(&self->_delegate);
    v59 = objc_opt_respondsToSelector();

    if (v59)
    {
      v60 = objc_loadWeakRetained(&self->_delegate);
      [v60 link:self didAddQREvent:v57];
    }
  }

  if (v74.i32[1] >= 1)
  {
    GLUtilReportAWDClientTimerEvent(303, 0, v15, self->_enableSKE, self->_isInitiator, v74.u32[1]);
    v61 = GLUCreateQRClientTimeEvent(303, 0, v15, self->_timeBase, v74.u32[1]);
    v62 = objc_loadWeakRetained(&self->_delegate);
    v63 = objc_opt_respondsToSelector();

    if (v63)
    {
      v64 = objc_loadWeakRetained(&self->_delegate);
      [v64 link:self didAddQREvent:v61];
    }
  }

  if (self->_isInitiator && v45 >= 1)
  {
    GLUtilReportAWDClientTimerEvent(306, 0, v15, self->_enableSKE, 1u, v45);
    v65 = GLUCreateQRClientTimeEvent(306, 0, v15, self->_timeBase, v45);
    v66 = objc_loadWeakRetained(&self->_delegate);
    v67 = objc_opt_respondsToSelector();

    if (v67)
    {
      v68 = objc_loadWeakRetained(&self->_delegate);
      [v68 link:self didAddQREvent:v65];
    }
  }
}

- (BOOL)_getPacketBufferSendInfo:(id *)a3 channelNumber:(unsigned __int16 *)a4 transport:(int64_t *)a5 glLinkProtocol:(int64_t *)a6
{
  v17 = *MEMORY[0x1E69E9840];
  v10 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, a3->var25);
  v11 = v10;
  if (v10)
  {
    a3->var16 = *(v10 + 266);
    a3->var17 = *(v10 + 1);
    memcpy(&a3->var18, v10 + 1, *(v10 + 8));
    memcpy(&a3->var19, v11 + 17, *(v11 + 136));
    if (a4)
    {
      *a4 = *(v11 + 132);
    }

    if (a5)
    {
      *a5 = v11[34];
    }

    if (a6)
    {
      *a6 = v11[35];
    }
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      var25 = a3->var25;
      *buf = 67109120;
      v16 = var25;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_getPacketBufferSendInfo failed due to invalid linkID: %d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_getPacketBufferSendInfo failed due to invalid linkID: %d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_getPacketBufferSendInfo failed due to invalid linkID: %d.");
        }
      }
    }
  }

  return v11 != 0;
}

- (void)_updateSendStatsWithResult:(unint64_t)a3 bytesSent:(int64_t)a4 packetsSent:(int)a5 linkID:(char)a6 delegatedLinkID:(char)a7 token:(id)a8 isClientData:(BOOL)a9 sendTime:(double)a10 stunTransport:(int64_t)a11 packetBuffer:(id *)a12
{
  v13 = a7;
  v14 = a6;
  v63 = *MEMORY[0x1E69E9840];
  v19 = a8;
  if (a3)
  {
    v20 = +[IDSFoundationLog GlobalLink];
    v21 = os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT);
    if (v13 == -1)
    {
      if (v21)
      {
        v34 = GLUtilStunTransportChar(a11);
        v35 = _IDSLinkSendResultStrings[a3];
        var37 = a12->var37;
        if (a12->var38)
        {
          v37 = "qpod";
        }

        else
        {
          v37 = "udp";
        }

        v55 = 134219522;
        v56 = a4;
        v57 = 1024;
        v58 = a5;
        v59 = 1024;
        v60 = v34;
        v61 = 1024;
        *v62 = v14;
        *&v62[4] = 2080;
        *&v62[6] = v37;
        *&v62[14] = 2048;
        *&v62[16] = var37;
        *&v62[24] = 2080;
        *&v62[26] = v35;
        v26 = "GLW failed %zdB/%1d (%c %d  %s [C%llu]) (%s)";
        v27 = v20;
        v28 = 60;
        goto LABEL_27;
      }
    }

    else if (v21)
    {
      v22 = GLUtilStunTransportChar(a11);
      v23 = _IDSLinkSendResultStrings[a3];
      v24 = a12->var37;
      if (a12->var38)
      {
        v25 = "qpod";
      }

      else
      {
        v25 = "udp";
      }

      v55 = 134219778;
      v56 = a4;
      v57 = 1024;
      v58 = a5;
      v59 = 1024;
      v60 = v22;
      v61 = 1024;
      *v62 = v14;
      *&v62[4] = 1024;
      *&v62[6] = v13;
      *&v62[10] = 2080;
      *&v62[12] = v25;
      *&v62[20] = 2048;
      *&v62[22] = v24;
      *&v62[30] = 2080;
      *&v62[32] = v23;
      v26 = "GLW failed %zdB/%1d (%c %d/%d  %s [C%llu]) (%s)";
      v27 = v20;
      v28 = 66;
LABEL_27:
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, v26, &v55, v28);
    }

    goto LABEL_51;
  }

  self->_totalPacketsSent += a5;
  self->_totalBytesSent += a4;
  v29 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v14);
  if (v13 == -1)
  {
    v30 = v14;
  }

  else
  {
    v30 = v13;
  }

  v31 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v30);
  if (v31)
  {
    v31[38] = a10;
    *(v31 + 82) += a5;
    *(v31 + 42) += a4;
  }

  if (v29 && v29 != v31)
  {
    v29[38] = a10;
    *(v29 + 82) += a5;
    *(v29 + 42) += a4;
  }

  if (!a9)
  {
    Value = 0;
    if (v19 && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v19);
    }

    [Value setLastOutgoingPacketTime:a10];
    v39 = +[IDSFoundationLog GlobalLink];
    v40 = os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT);
    if (v13 == -1)
    {
      if (v40)
      {
        v48 = GLUtilStunTransportChar(a11);
        var38 = a12->var38;
        v50 = a12->var37;
        v55 = 134219010;
        if (var38)
        {
          v51 = "qpod";
        }

        else
        {
          v51 = "udp";
        }

        v56 = a4;
        v57 = 1024;
        v58 = v48;
        v59 = 1024;
        v60 = v14;
        v61 = 2080;
        *v62 = v51;
        *&v62[8] = 2048;
        *&v62[10] = v50;
        v45 = "NCD %zdB (%c %d  %s [C%llu])";
        v46 = v39;
        v47 = 44;
        goto LABEL_43;
      }
    }

    else if (v40)
    {
      v41 = GLUtilStunTransportChar(a11);
      v42 = a12->var38;
      v43 = a12->var37;
      v55 = 134219266;
      if (v42)
      {
        v44 = "qpod";
      }

      else
      {
        v44 = "udp";
      }

      v56 = a4;
      v57 = 1024;
      v58 = v41;
      v59 = 1024;
      v60 = v14;
      v61 = 1024;
      *v62 = v13;
      *&v62[4] = 2080;
      *&v62[6] = v44;
      *&v62[14] = 2048;
      *&v62[16] = v43;
      v45 = "NCD %zdB (%c %d/%d  %s [C%llu])";
      v46 = v39;
      v47 = 50;
LABEL_43:
      _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, v45, &v55, v47);
    }

    goto LABEL_51;
  }

  if (v29 && !*(v29 + 82))
  {
    v32 = *v29;
    if ((v32 & 0x80000000) != 0 || v32 >= self->_maxLinkID)
    {
      v33 = 0;
    }

    else
    {
      v33 = self->_candidatePairs[v32];
    }

    v52 = [(IDSStunCandidatePair *)v33 linkMetrics];
    [v52 event:@"glr"];
  }

  kdebug_trace();
  [(IDSGlobalLink *)self reportLinkMetricsForLinkID:v14 lastPacketReceivedTime:0.0 lastPacketSentTime:ids_monotonic_time()];
  if (v29)
  {
    packetLog = self->_packetLog;
    if (packetLog)
    {
      v54 = sub_1A7BAF110(a12, v14, v13, packetLog, v29);
      if (v54)
      {
        [(IDSObjCPacketLog *)self->_packetLog recordPacketsWithPacketLogID:v54 kind:0 bytes:a4 packetCount:a5];
      }
    }
  }

LABEL_51:
}

- (unint64_t)_prepareOutgoingChannelData:(id *)a3 arraySize:(int)a4 channelNumber:(unsigned __int16)a5 candidatePair:(id)a6 linkID:(char)a7 delegatedLinkID:(char *)a8 stunTransport:(int64_t)a9
{
  v63 = a7;
  v9 = a5;
  v13 = a6;
  v65 = a4;
  if (a4 >= 1)
  {
    v14 = a4;
    v15 = a3;
    do
    {
      if ((*(*v15 + 517) & 1) != 0 || (*(*v15 + 537) & 4) != 0)
      {
        if (self->_isPartialTLEUPlusOneEnabled && (-[IDSStunCandidatePair connections](v13, "connections"), v16 = v13, v17 = objc_claimAutoreleasedReturnValue(), [v17 objectForKeyedSubscript:@"qpod"], v18 = objc_claimAutoreleasedReturnValue(), v18, v17, v13 = v16, v18))
        {
          v19 = *v15;
          *(v19 + 1305) = 1;
          *(v19 + 517) = 0;
          *(v19 + 134) &= ~0x400u;
        }

        else if (!v9)
        {
          v22 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(&v22->super, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E161B0();
          }

          v47 = 12;
          goto LABEL_73;
        }
      }

      ++v15;
      --v14;
    }

    while (v14);
  }

  if (!v9)
  {
    v47 = 0;
    goto LABEL_74;
  }

  if (!v13 || (v63 & 0x80000000) == 0)
  {
    v20 = GLUtilGetCandidatePairByLinkID(v63, self->_sendInfoList, self->_candidatePairs, self->_maxLinkID, self->_channelToCandidatePairs);

    v13 = v20;
  }

  v21 = v65;
  v13 = v13;
  v22 = v13;
  if (![(IDSStunCandidatePair *)v13 isVirtualRelayStunCandidatePair])
  {
    goto LABEL_22;
  }

  v23 = [(IDSStunCandidatePair *)v13 delegatedLinkID];
  *a8 = v23;
  if (v23 < 0 || self->_maxLinkID <= v23)
  {

    goto LABEL_51;
  }

  v22 = self->_candidatePairs[v23];

  if (!v22)
  {
LABEL_51:
    v48 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16140();
    }

    if (v65 >= 1)
    {
      v49 = v65;
      v47 = 9;
      do
      {
        v50 = *a3++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10180, v50);
        --v49;
      }

      while (v49);
      v22 = 0;
      goto LABEL_73;
    }

    v22 = 0;
LABEL_58:
    v47 = 9;
    goto LABEL_73;
  }

  if ((v9 & 0xF0) != 0x60)
  {
    v56 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v56, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16058();
    }

    if (v65 >= 1)
    {
      v57 = v65;
      v47 = 9;
      do
      {
        v58 = *a3++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10194, v58);
        --v57;
      }

      while (v57);
      goto LABEL_73;
    }

    goto LABEL_58;
  }

  v24 = [(IDSStunCandidatePair *)v13 remoteRelayLinkID];
  if (v65 < 1)
  {
    goto LABEL_66;
  }

  v25 = v65;
  v26 = a3;
  do
  {
    v27 = *v26++;
    *(v27 + 524) = v24;
    *(v27 + 520) = 1;
    --v25;
  }

  while (v25);
LABEL_22:
  if (v65 < 1)
  {
    goto LABEL_66;
  }

  v64 = v13;
  v28 = 0;
  v29 = v65;
  do
  {
    v30 = a3[v28];
    if (*(v30 + 536))
    {
      StunUtilGetMappedParticipantID(v30, 0, v22, 0);
    }

    ++v28;
  }

  while (v65 != v28);
  for (i = 0; i != v65; ++i)
  {
    v32 = a3[i];
    if ((*(v32 + 537) & 4) == 0)
    {
      continue;
    }

    v33 = *v32;
    v34 = *(v32 + 2);
    v35 = [(IDSStunCandidatePair *)v22 hbhEncKey];
    v36 = IDSHBHEncryptDataWithKey(v33, v34, v35);

    if (!v36)
    {
      v51 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16104();
      }

      v47 = 11;
      do
      {
        v52 = *a3++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10213, v52);
        --v29;
      }

      while (v29);
      goto LABEL_72;
    }

    v37 = *(a3[i] + 1);
    if (v37 < [v36 length])
    {
      v53 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v53, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E160C8();
      }

      do
      {
        v54 = *a3++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10220, v54);
        --v29;
      }

      while (v29);

      v47 = 4;
LABEL_72:
      v13 = v64;
      goto LABEL_73;
    }

    v38 = [v36 length];
    v39 = a3[i];
    *(v39 + 2) = v38;
    memcpy(*v39, [v36 bytes], *(a3[i] + 2));
  }

  if ((v9 & 0xF0) != 0x60)
  {
    v13 = v64;
LABEL_65:
    v21 = v65;
    goto LABEL_66;
  }

  v40 = *(*a3 + 535);
  v41 = *(*a3 + 134);
  v13 = v64;
  if (![(IDSStunCandidatePair *)v22 useQualityMetadata]|| (v40 & 1) != 0 || (v41 & 0x80000) != 0)
  {
    goto LABEL_65;
  }

  v21 = v65;
  v42 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "QualityMonitor: packet is neither command nor echo", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"QualityMonitor: packet is neither command nor echo");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"QualityMonitor: packet is neither command nor echo");
      }
    }
  }

  v43 = [(IDSStunCandidatePair *)v22 qualityHandler];
  v44 = v43;
  if (v43)
  {
    v45 = *a3;
    if (*(*a3 + 1306) == 1)
    {
      v46 = *(v45 + 1308);
    }

    else
    {
      v46 = -1;
    }

    v60 = [v43 prependQualityBytesToPacketIfNeeded:**a3 packetHeadroomStart:v45 + 1310 deduplicationID:v46];
    v61 = **a3;
    if (v60 != v61)
    {
      IDSLinkPacketBufferAddBufferStart(*a3, v60 - v61);
    }
  }

  else
  {
    v59 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
    {
      *v66 = 0;
      _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "QualityMonitor: no quality handler", v66, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"QualityMonitor: no quality handler");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"QualityMonitor: no quality handler");
        }
      }
    }
  }

LABEL_66:
  StunUtilPrepareOutgoingChannelData(v9, a3, v21, a9);
  v47 = 0;
LABEL_73:

LABEL_74:
  return v47;
}

- (unint64_t)_sendChannelDataPacketBuffer:(id *)a3 candidatePair:(id)a4
{
  v28 = *MEMORY[0x1E69E9840];
  v25 = a3;
  v6 = a4;
  v7 = [v6 channelNumber];
  v8 = [v6 local];
  v9 = [v8 transport];

  v10 = ids_monotonic_time();
  v11 = [v6 local];
  v12 = [v11 index];

  v13 = [v6 local];
  v14 = [v13 address];

  v15 = [v6 remote];
  v16 = [v15 external];

  if (v14 && v16)
  {
    a3->var17 = v12;
    memcpy(&a3->var18, v14, *v14);
    memcpy(&a3->var19, v16, *v16);
    a3->var16 = [v6 isVirtualRelayStunCandidatePair];
    v17 = -[IDSGlobalLink _getLink:stunTransport:glLinkProtocol:](self, "_getLink:stunTransport:glLinkProtocol:", a3->var18.ss_family, v9, [v6 glLinkProtocol]);
    v18 = [v6 linkID];
    if (v18)
    {
      v19 = v18;
    }

    else
    {
      v19 = 0xFFFFFFFFLL;
    }

    buf[0] = -1;
    v20 = [(IDSGlobalLink *)self _prepareOutgoingChannelData:&v25 arraySize:1 channelNumber:v7 candidatePair:v6 linkID:v19 delegatedLinkID:buf stunTransport:v9];
    if (!v20)
    {
      _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10284, v25);
      var2 = v25->var2;
      v20 = [v17 sendPacketBuffer:? toDeviceUniqueID:? cbuuid:?];
      LOBYTE(v24) = 1;
      [(IDSGlobalLink *)self _updateSendStatsWithResult:v20 bytesSent:var2 packetsSent:1 linkID:v19 delegatedLinkID:buf[0] token:0 isClientData:v10 sendTime:v24 stunTransport:v9 packetBuffer:v25];
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10288, v25);
    }
  }

  else
  {
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v27 = v6;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_sendChannelDataPacketBuffer no local or remote IP %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendChannelDataPacketBuffer no local or remote IP %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendChannelDataPacketBuffer no local or remote IP %@");
        }
      }
    }

    v20 = 9;
  }

  return v20;
}

- (void)_sendSyntheticPacket:(id)a3 candidatePair:(id)a4
{
  v15 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if ([v7 useQualityMetadata])
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v12 = v6;
      v13 = 2112;
      v14 = v7;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Sending synthetic packet with data %@ on candidate pair %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Sending synthetic packet with data %@ on candidate pair %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending synthetic packet with data %@ on candidate pair %@");
        }
      }
    }

    v9 = _IDSLinkPacketBufferCreate();
    *(v9 + 1216) = [v7 linkID];
    v10 = [v6 length];
    v9[2] = v10;
    [v6 getBytes:*v9 length:v10];
    *(v9 + 111) = 1;
    if ([v7 remoteRelayLinkID])
    {
      *(v9 + 130) = 1;
      *(v9 + 262) = [v7 remoteRelayLinkID];
    }

    *(v9 + 153) = ids_monotonic_time();
    [(IDSGlobalLink *)self _sendChannelDataPacketBuffer:v9 candidatePair:v7];
  }
}

- (unint64_t)sendPacketBuffer:(id *)a3 toDeviceUniqueID:(id)a4 cbuuid:(id)a5
{
  v33 = *MEMORY[0x1E69E9840];
  v8 = a4;
  v9 = a5;
  v10 = ids_monotonic_time();
  if (self->_firstClientPacketTime == 0.0 && (!self->_isUPlusOneSession || a3->var2 >= 11))
  {
    self->_firstClientPacketTime = v10;
    self->_reportClientPacketTime = 1;
    v11 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_reportDataReceivedTime)
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v28 = 138412290;
      *v29 = v12;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "sendPacketBuffer: _firstDataReceivedTime _reportDataReceivedTime: %@", &v28, 0xCu);
    }

    if (self->_reportDataReceivedTime)
    {
      [(IDSGlobalLink *)self _reportSessionSetupTime];
      self->_reportClientPacketTime = 0;
    }
  }

  v13 = a3->var25 <= 0 && (a3->var23 < 1 || !a3->var24[0].var19 && (a3->var24[0].var20 & 0x80000) == 0);
  v14 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEBUG))
  {
    defaultLinkSelector = self->_defaultLinkSelector;
    v16 = @"NO";
    var25 = a3->var25;
    if (v13)
    {
      v16 = @"YES";
    }

    v28 = 134218498;
    *v29 = defaultLinkSelector;
    *&v29[8] = 2112;
    v30 = v16;
    v31 = 1024;
    v32 = var25;
    _os_log_debug_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEBUG, "sendPacketBuffer: _defaultLinkSelector: %p; should use link selection: %@; linkID: %d", &v28, 0x1Cu);
  }

  v18 = !v13;
  if (!self->_defaultLinkSelector)
  {
    v18 = 1;
  }

  if (v18)
  {
    if (!a3->var25 && (a3->var24[0].var20 & 0x4000) != 0)
    {
      a3->var25 = self->_linkIDForPlugin;
    }

    v24 = sub_1A7E14668(self, a3, v8, v9, v10);
  }

  else
  {
    a3->var40 = 1;
    nextPacketDeduplicationID = self->_nextPacketDeduplicationID;
    a3->var41 = nextPacketDeduplicationID;
    if (((nextPacketDeduplicationID + 1) & 0xF800) != 0)
    {
      v20 = 0;
    }

    else
    {
      v20 = nextPacketDeduplicationID + 1;
    }

    self->_nextPacketDeduplicationID = v20;
    v21 = [(IDSLinkSelectorPrimarySecondary *)self->_defaultLinkSelector primaryLinkID];
    v22 = [(IDSLinkSelectorPrimarySecondary *)self->_defaultLinkSelector duplicationLinkID];
    if (v22 < 1)
    {
      v23 = 0;
    }

    else
    {
      v23 = _IDSLinkPacketBufferClone("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10379, a3);
      *(v23 + 1216) = v22;
    }

    v25 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEBUG))
    {
      var41 = a3->var41;
      v28 = 67109632;
      *v29 = var41;
      *&v29[4] = 1024;
      *&v29[6] = v21;
      LOWORD(v30) = 1024;
      *(&v30 + 2) = v22;
      _os_log_debug_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEBUG, "sendPacketBuffer: using link selection; adding deduplication ID %d; primary link ID: %d; duplication link ID: %d", &v28, 0x14u);
    }

    a3->var25 = v21;
    v24 = sub_1A7E14668(self, a3, v8, v9, v10);
    if (v23)
    {
      sub_1A7E14668(self, v23, v8, v9, v10);
    }
  }

  return v24;
}

- (unint64_t)sendPacketBufferArray:(id *)a3 arraySize:(int)a4 toDeviceUniqueID:(id)a5 cbuuid:(id)a6
{
  v7 = *&a4;
  v10 = a5;
  v11 = a6;
  if (v7 == 1)
  {
    v12 = [(IDSGlobalLink *)self sendPacketBuffer:*a3 toDeviceUniqueID:v10 cbuuid:v11];
  }

  else if ((v7 - 9) > 0xFFFFFFF7)
  {
    v15 = *a3;
    _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10448, *a3);
    v30 = 0;
    v28 = 0xAAAAAAAAAAAAAAAALL;
    v29 = 0;
    v16 = ids_monotonic_time();
    if ([(IDSGlobalLink *)self _getPacketBufferSendInfo:v15 channelNumber:&v30 transport:&v29 glLinkProtocol:&v28])
    {
      v17 = [(IDSGlobalLink *)self _getLink:*(v15 + 57) stunTransport:v29 glLinkProtocol:v28];
      v27 = -1;
      v18 = *(v15 + 1216);
      if ((v18 & 0x80000000) != 0 || self->_maxLinkID <= v18)
      {
        v19 = 0;
      }

      else
      {
        v19 = self->_candidatePairs[*(v15 + 1216)];
      }

      v21 = [(IDSGlobalLink *)self _prepareOutgoingChannelData:a3 arraySize:v7 channelNumber:v30 candidatePair:v19 linkID:v18 delegatedLinkID:&v27 stunTransport:v29];
      if (v21)
      {
        v12 = v21;
        v22 = 10472;
      }

      else
      {
        v23 = 0;
        v24 = 0;
        do
        {
          v24 += *(a3[v23++] + 2);
        }

        while (v7 != v23);
        v12 = [v17 sendPacketBufferArray:a3 arraySize:v7 toDeviceUniqueID:v10 cbuuid:v11];
        LOBYTE(v26) = 1;
        [(IDSGlobalLink *)self _updateSendStatsWithResult:v12 bytesSent:v24 packetsSent:v7 linkID:v18 delegatedLinkID:v27 token:0 isClientData:v16 sendTime:v26 stunTransport:v29 packetBuffer:v15];
        v22 = 10483;
      }

      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", v22, v15);
    }

    else
    {
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10457, v15);
      v7 = v7;
      v12 = 9;
      do
      {
        v20 = *a3++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10460, v20);
        --v7;
      }

      while (v7);
    }
  }

  else if (v7 < 1)
  {
    v12 = 9;
  }

  else
  {
    v13 = v7;
    v12 = 9;
    do
    {
      v14 = *a3++;
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10442, v14);
      --v13;
    }

    while (v13);
  }

  return v12;
}

- (id)generateLinkReport:(double)a3 isCurrentLink:(BOOL)a4
{
  previousReportTime = self->_previousReportTime;
  if (previousReportTime == 0.0)
  {
    v13 = 0;
  }

  else
  {
    v7 = a3 - previousReportTime;
    v8 = self->_totalBytesSent - self->_previousBytesSent;
    v9 = self->_totalBytesReceived - self->_previousBytesReceived;
    if (a4)
    {
      v10 = 42;
    }

    else
    {
      v10 = 32;
    }

    v26 = v10;
    v27 = MEMORY[0x1E696AEC0];
    state = self->_state;
    if (state > 6)
    {
      v12 = "UnexpectedState";
    }

    else
    {
      v12 = _IDSLinkStateStrings[state];
    }

    v25 = v12;
    v24 = self->_totalPacketsSent - self->_previousPacketsSent;
    v14 = formattedBytes(v8);
    v15 = formattedSpeed(((8 * v8) / v7 + 0.5));
    totalPacketsSent = self->_totalPacketsSent;
    v17 = formattedBytes(self->_totalBytesSent);
    v18 = self->_totalPacketsReceived - self->_previousPacketsReceived;
    v19 = formattedBytes(v9);
    v20 = formattedSpeed(((8 * v9) / v7 + 0.5));
    totalPacketsReceived = self->_totalPacketsReceived;
    v22 = formattedBytes(self->_totalBytesReceived);
    v13 = [v27 stringWithFormat:@"%c GlobalLink(%s) Tx %6llu pkts %@B %@bps     %6llu pkts %@B\n                        Rx %6llu pkts %@B %@bps     %6llu pkts %@B\n", v26, v25, v24, v14, v15, totalPacketsSent, v17, v18, v19, v20, totalPacketsReceived, v22];
  }

  self->_previousReportTime = a3;
  *&self->_previousBytesSent = *&self->_totalBytesSent;
  *&self->_previousBytesReceived = *&self->_totalBytesReceived;

  return v13;
}

- (void)_sendSKEDataWithSelectedCandidatePair
{
  v71 = *MEMORY[0x1E69E9840];
  v46 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  if (!self->_isInitiator)
  {
    v53 = 0uLL;
    v54 = 0uLL;
    v51 = 0uLL;
    v52 = 0uLL;
    v23 = v46;
    v24 = [v23 countByEnumeratingWithState:&v51 objects:v59 count:16];
    if (v24)
    {
      v25 = *v52;
LABEL_53:
      v26 = 0;
      while (1)
      {
        if (*v52 != v25)
        {
          objc_enumerationMutation(v23);
        }

        v27 = *(*(&v51 + 1) + 8 * v26);
        if ([v27 recvSKEData])
        {
          break;
        }

        if (v24 == ++v26)
        {
          v24 = [v23 countByEnumeratingWithState:&v51 objects:v59 count:16];
          if (v24)
          {
            goto LABEL_53;
          }

          goto LABEL_59;
        }
      }

      v20 = v27;

      if (!v20)
      {
        goto LABEL_83;
      }

      goto LABEL_61;
    }

    goto LABEL_59;
  }

  v57 = 0uLL;
  v58 = 0uLL;
  v55 = 0uLL;
  v56 = 0uLL;
  obj = v46;
  v2 = [obj countByEnumeratingWithState:&v55 objects:v70 count:16];
  if (!v2)
  {
LABEL_59:

    goto LABEL_83;
  }

  v48 = 0;
  v50 = *v56;
LABEL_4:
  v3 = 0;
  while (1)
  {
    if (*v56 != v50)
    {
      objc_enumerationMutation(obj);
    }

    v4 = *(*(&v55 + 1) + 8 * v3);
    v5 = [(__CFString *)v4 state];
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)v4 isAcceptedRelaySession])
      {
        v7 = @"YES";
      }

      else
      {
        v7 = @"NO";
      }

      v8 = [(__CFString *)v4 pendingRealloc];
      v9 = [(__CFString *)v4 sentSKEData];
      *buf = 136316162;
      if (v8)
      {
        v10 = @"YES";
      }

      else
      {
        v10 = @"NO";
      }

      v61 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
      if (v9)
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      v62 = 2112;
      v63 = v4;
      v64 = 2112;
      v65 = v7;
      v66 = 2112;
      v67 = v10;
      v68 = 2112;
      v69 = v11;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v12 = [(__CFString *)v4 isAcceptedRelaySession]? @"YES" : @"NO";
      v13 = [(__CFString *)v4 pendingRealloc]? @"YES" : @"NO";
      v14 = [(__CFString *)v4 sentSKEData]? @"YES" : @"NO";
      v44 = v13;
      v45 = v14;
      v42 = v4;
      v43 = v12;
      v41 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
      _IDSLogTransport(@"GL", @"IDS", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      if (_IDSShouldLog())
      {
        if ([(__CFString *)v4 isAcceptedRelaySession:"[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]"])
        {
          v15 = @"YES";
        }

        else
        {
          v15 = @"NO";
        }

        if ([(__CFString *)v4 pendingRealloc])
        {
          v16 = @"YES";
        }

        else
        {
          v16 = @"NO";
        }

        if ([(__CFString *)v4 sentSKEData])
        {
          v17 = @"YES";
        }

        else
        {
          v17 = @"NO";
        }

        v44 = v16;
        v45 = v17;
        v42 = v4;
        v43 = v15;
        v41 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      }
    }

    if ([(__CFString *)v4 isAcceptedRelaySession:v41]&& ([(__CFString *)v4 pendingRealloc]& 1) == 0)
    {
      v18 = [(__CFString *)v4 sentSKEData];
      v19 = (v5 - 5) < 0xFFFFFFFFFFFFFFFELL ? 1 : v18;
      if ((v19 & 1) == 0)
      {
        v20 = v4;

        v21 = [(__CFString *)v20 local];
        v22 = [v21 isCellularStunCandidate];

        v48 = v20;
        if (!v22)
        {
          break;
        }
      }
    }

    if (v2 == ++v3)
    {
      v2 = [obj countByEnumeratingWithState:&v55 objects:v70 count:16];
      v20 = v48;
      if (v2)
      {
        goto LABEL_4;
      }

      break;
    }
  }

  if (v20)
  {
    [(__CFString *)v20 setSentSKEData:1];
LABEL_61:
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      v29 = [(__CFString *)v20 candidatePairToken];
      *buf = 138412290;
      v61 = v29;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "send SKE data using %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v41 = [(__CFString *)v20 candidatePairToken];
        _IDSLogTransport(@"GL", @"IDS", @"send SKE data using %@.");

        if (_IDSShouldLog())
        {
          v41 = [(__CFString *)v20 candidatePairToken];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send SKE data using %@.");
        }
      }
    }

    v30 = ids_monotonic_time() - self->_skeStartTime;
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = @"NO";
      if (self->_isInitiator)
      {
        v32 = @"YES";
      }

      *buf = 134218242;
      v61 = *&v30;
      v62 = 2112;
      v63 = v32;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v33 = self->_isInitiator ? @"YES" : @"NO";
      v42 = v33;
      v41 = *&v30;
      _IDSLogTransport(@"GL", @"IDS", @"send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
      if (_IDSShouldLog())
      {
        if (self->_isInitiator)
        {
          v34 = @"YES";
        }

        else
        {
          v34 = @"NO";
        }

        v42 = v34;
        v41 = *&v30;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
      }
    }

    if (self->_remoteGlobalLinkVersion)
    {
      v35 = [(__CFString *)v20 candidatePairToken];
      [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:v35];
    }

    else
    {
      isInitiator = self->_isInitiator;
      if (isInitiator)
      {
        v39 = 1;
      }

      else
      {
        v39 = 32769;
      }

      v40 = [(__CFString *)v20 candidatePairToken:v41];
      [(IDSGlobalLink *)self _sendCommandMessage:v39 stunMessage:0 options:0 candidatePairToken:v40];

      if (!isInitiator)
      {
        [(IDSGlobalLink *)self _notifyQRSessionConnected:v20];
      }
    }

    goto LABEL_93;
  }

LABEL_83:
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v37 = @"YES";
    }

    else
    {
      v37 = @"NO";
    }

    *buf = 138412290;
    v61 = v37;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "failed to select candidate pair to send SKE data (isInitiator:%@).", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to select candidate pair to send SKE data (isInitiator:%@).");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to select candidate pair to send SKE data (isInitiator:%@).");
      }
    }
  }

  v20 = 0;
LABEL_93:
}

- (void)_sendSKEDataToSucceededCandidatePairs
{
  v81 = *MEMORY[0x1E69E9840];
  v50 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v52 = [MEMORY[0x1E695DF70] array];
  if (!self->_isInitiator)
  {
    v62 = 0uLL;
    v63 = 0uLL;
    v60 = 0uLL;
    v61 = 0uLL;
    v21 = v50;
    v24 = [(__CFString *)v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
    if (v24)
    {
      v25 = *v61;
      do
      {
        for (i = 0; i != v24; ++i)
        {
          if (*v61 != v25)
          {
            objc_enumerationMutation(v21);
          }

          v27 = *(*(&v60 + 1) + 8 * i);
          if ([v27 recvSKEData] && objc_msgSend(v27, "state") == 3)
          {
            [v52 addObject:v27];
          }
        }

        v24 = [(__CFString *)v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
      }

      while (v24);
    }

    goto LABEL_63;
  }

  v66 = 0uLL;
  v67 = 0uLL;
  v64 = 0uLL;
  v65 = 0uLL;
  obj = v50;
  v3 = [(__CFString *)obj countByEnumeratingWithState:&v64 objects:v80 count:16];
  if (!v3)
  {
    v21 = obj;
    goto LABEL_63;
  }

  v51 = 0;
  v54 = *v65;
LABEL_4:
  v4 = 0;
  while (1)
  {
    if (*v65 != v54)
    {
      objc_enumerationMutation(obj);
    }

    v5 = *(*(&v64 + 1) + 8 * v4);
    v6 = [(__CFString *)v5 state];
    v7 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)v5 isAcceptedRelaySession])
      {
        v8 = @"YES";
      }

      else
      {
        v8 = @"NO";
      }

      v9 = [(__CFString *)v5 pendingRealloc];
      v10 = [(__CFString *)v5 sentSKEData];
      *buf = 136316162;
      if (v9)
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      v71 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
      if (v10)
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v72 = 2112;
      v73 = v5;
      v74 = 2112;
      v75 = v8;
      v76 = 2112;
      v77 = v11;
      v78 = 2112;
      v79 = v12;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v13 = [(__CFString *)v5 isAcceptedRelaySession]? @"YES" : @"NO";
      v14 = [(__CFString *)v5 pendingRealloc]? @"YES" : @"NO";
      v15 = [(__CFString *)v5 sentSKEData]? @"YES" : @"NO";
      v48 = v14;
      v49 = v15;
      v46 = v5;
      v47 = v13;
      v45 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
      _IDSLogTransport(@"GL", @"IDS", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      if (_IDSShouldLog())
      {
        if ([(__CFString *)v5 isAcceptedRelaySession:"[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]"])
        {
          v16 = @"YES";
        }

        else
        {
          v16 = @"NO";
        }

        if ([(__CFString *)v5 pendingRealloc])
        {
          v17 = @"YES";
        }

        else
        {
          v17 = @"NO";
        }

        if ([(__CFString *)v5 sentSKEData])
        {
          v18 = @"YES";
        }

        else
        {
          v18 = @"NO";
        }

        v48 = v17;
        v49 = v18;
        v46 = v5;
        v47 = v16;
        v45 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      }
    }

    if ([(__CFString *)v5 isAcceptedRelaySession:v45]&& ([(__CFString *)v5 pendingRealloc]& 1) == 0)
    {
      v19 = [(__CFString *)v5 sentSKEData];
      v20 = (v6 - 5) < 0xFFFFFFFFFFFFFFFELL ? 1 : v19;
      if ((v20 & 1) == 0)
      {
        v21 = v5;

        v22 = [(__CFString *)v21 local];
        v23 = [v22 isCellularStunCandidate];

        v51 = v21;
        if (!v23)
        {
          break;
        }
      }
    }

    if (v3 == ++v4)
    {
      v3 = [(__CFString *)obj countByEnumeratingWithState:&v64 objects:v80 count:16];
      v21 = v51;
      if (v3)
      {
        goto LABEL_4;
      }

      break;
    }
  }

  if (v21)
  {
    [(__CFString *)v21 setSentSKEData:1];
    [v52 addObject:v21];
LABEL_63:
  }

  if ([v52 count])
  {
    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    v55 = v52;
    v28 = [v55 countByEnumeratingWithState:&v56 objects:v68 count:16];
    if (v28)
    {
      v29 = *v57;
      do
      {
        for (j = 0; j != v28; ++j)
        {
          if (*v57 != v29)
          {
            objc_enumerationMutation(v55);
          }

          v31 = *(*(&v56 + 1) + 8 * j);
          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            v33 = [v31 candidatePairToken];
            *buf = 138412290;
            v71 = v33;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v45 = [v31 candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.");

              if (_IDSShouldLog())
              {
                v45 = [v31 candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.");
              }
            }
          }

          v34 = ids_monotonic_time() - self->_skeStartTime;
          v35 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
          {
            v36 = @"NO";
            if (self->_isInitiator)
            {
              v36 = @"YES";
            }

            *buf = 134218242;
            v71 = *&v34;
            v72 = 2112;
            v73 = v36;
            _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
          {
            v37 = @"NO";
            if (self->_isInitiator)
            {
              v37 = @"YES";
            }

            v46 = v37;
            v45 = *&v34;
            _IDSLogTransport(@"GL", @"IDS", @"_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
            if (_IDSShouldLog())
            {
              v38 = @"NO";
              if (self->_isInitiator)
              {
                v38 = @"YES";
              }

              v46 = v38;
              v45 = *&v34;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
            }
          }

          if (self->_remoteGlobalLinkVersion)
          {
            v39 = [v31 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:v39];
          }

          else
          {
            isInitiator = self->_isInitiator;
            if (isInitiator)
            {
              v41 = 1;
            }

            else
            {
              v41 = 32769;
            }

            v42 = [v31 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:v41 stunMessage:0 options:0 candidatePairToken:v42];

            if (!isInitiator)
            {
              [(IDSGlobalLink *)self _notifyQRSessionConnected:v31];
            }
          }
        }

        v28 = [v55 countByEnumeratingWithState:&v56 objects:v68 count:16];
      }

      while (v28);
    }
  }

  else
  {
    v43 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_isInitiator)
      {
        v44 = @"YES";
      }

      else
      {
        v44 = @"NO";
      }

      *buf = 138412290;
      v71 = v44;
      _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "failed to get candidate pair to send SKE data (isInitiator:%@).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to get candidate pair to send SKE data (isInitiator:%@).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get candidate pair to send SKE data (isInitiator:%@).");
        }
      }
    }
  }
}

- (void)_requestNonUDPRelayAllocation:(int64_t)a3 relaySessionID:(id)a4
{
  v6 = a4;
  v7 = v6;
  if ((a3 - 5) >= 0xFFFFFFFFFFFFFFFELL)
  {
    shouldFallbackToTCPFirst = self->_shouldFallbackToTCPFirst;
    if (a3 == 3)
    {
      v9 = 3;
    }

    else
    {
      v9 = 5;
    }

    if (a3 == 4)
    {
      v10 = 3;
    }

    else
    {
      v10 = 5;
    }

    v12[0] = MEMORY[0x1E69E9820];
    v12[1] = 3221225472;
    v12[2] = sub_1A7BB1CB8;
    v12[3] = &unk_1E77E0750;
    if (shouldFallbackToTCPFirst)
    {
      v11 = v9;
    }

    else
    {
      v11 = v10;
    }

    v12[4] = self;
    v14 = a3;
    v13 = v6;
    IDSTransportThreadAddBlockAfter(v12, v11);
  }
}

- (void)setAcceptedRelaySession:(id)a3 options:(id)a4
{
  v78 = *MEMORY[0x1E69E9840];
  v7 = a3;
  theDict = a4;
  if (self->_isInitiator)
  {
    if (v7)
    {
      acceptedRelaySessionID = self->_acceptedRelaySessionID;
      v63 = self;
      objc_storeStrong(&self->_acceptedRelaySessionID, a3);
      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
        *buf = 138412546;
        v75 = v7;
        v76 = 2048;
        v77 = v10;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v56 = v7;
          v58 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          _IDSLogTransport(@"GL", @"IDS", @"receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu");
          if (_IDSShouldLog())
          {
            v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v7];
            v56 = v7;
            v58 = v11;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu");
          }
        }
      }

      v61 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v7, v56, v58];
      if (v61)
      {
        v12 = [v61 remotePushTokens];
        v13 = [v12 copy];
        remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
        self->_remoteAcceptedDevicePushTokens = v13;

        v15 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          v16 = self->_remoteAcceptedDevicePushTokens;
          *buf = 138412290;
          v75 = v16;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "remote accepted device push tokens: %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v57 = self->_remoteAcceptedDevicePushTokens;
            _IDSLogTransport(@"GL", @"IDS", @"remote accepted device push tokens: %@");
            if (_IDSShouldLog())
            {
              v57 = self->_remoteAcceptedDevicePushTokens;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"remote accepted device push tokens: %@");
            }
          }
        }

        [(IDSGlobalLink *)self _updateAllLinks];
      }

      Value = 0;
      if (theDict && @"gl-option-use-secure-control-message")
      {
        Value = CFDictionaryGetValue(theDict, @"gl-option-use-secure-control-message");
      }

      v18 = [Value BOOLValue];
      if (!self->_useSecureControlMessage && ((v18 ^ 1) & 1) == 0)
      {
        self->_useSecureControlMessage = v18;
        v19 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "enable secure control message for Initiator.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"enable secure control message for Initiator.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"enable secure control message for Initiator.");
            }
          }
        }
      }

      v20 = ids_monotonic_time();
      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      self->_skeStartTime = v20;
      v60 = [(NSMutableDictionary *)tokenToCandidatePairs allValues];
      if (![(NSMutableDictionary *)self->_tokenToCandidatePairs count])
      {
        v36 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "No valid candiate pair, _isSessionAccepted yes", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"No valid candiate pair, _isSessionAccepted yes");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"No valid candiate pair, _isSessionAccepted yes");
            }
          }
        }

        v23 = 0;
        self->_isSessionAcceptedWithNoCandidatePair = 1;
LABEL_95:
        if (self->_skeData)
        {
          v54 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
          {
            skeData = self->_skeData;
            *buf = 134217984;
            v75 = skeData;
            _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "found saved SKE data %p, send it immediately.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v57 = v63->_skeData;
              _IDSLogTransport(@"GL", @"IDS", @"found saved SKE data %p, send it immediately.");
              if (_IDSShouldLog())
              {
                v57 = v63->_skeData;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"found saved SKE data %p, send it immediately.");
              }
            }
          }

          [(IDSGlobalLink *)v63 _sendSKEDataWithSelectedCandidatePair];
          self = v63;
        }

        if (v23 == 2)
        {
          [(IDSGlobalLink *)self _requestNonUDPRelayAllocation:3 relaySessionID:v7];
          [(IDSGlobalLink *)v63 _requestNonUDPRelayAllocation:4 relaySessionID:v7];
        }

        goto LABEL_106;
      }

      if (acceptedRelaySessionID)
      {
        v66 = 0uLL;
        v67 = 0uLL;
        v64 = 0uLL;
        v65 = 0uLL;
        v22 = v60;
        v23 = 0;
        v24 = [v22 countByEnumeratingWithState:&v64 objects:v72 count:16];
        if (v24)
        {
          v25 = *v65;
          do
          {
            for (i = 0; i != v24; ++i)
            {
              if (*v65 != v25)
              {
                objc_enumerationMutation(v22);
              }

              v27 = *(*(&v64 + 1) + 8 * i);
              if ([v27 isRelayStunCandidatePair])
              {
                v28 = [v27 sessionID];
                v29 = [v28 isEqualToString:v7];

                if (v29)
                {
                  [v27 setIsAcceptedRelaySession:1];
                  v30 = [v27 local];
                  v23 = [v30 transport];

                  v31 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
                  {
                    v32 = [v27 candidatePairToken];
                    v33 = (&_IDSStunTransportStrings)[v23];
                    *buf = 138412546;
                    v75 = v32;
                    v76 = 2080;
                    v77 = v33;
                    _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "new relay candidate pair %@ is accepted, transport: %s.", buf, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v57 = [v27 candidatePairToken];
                      v59 = (&_IDSStunTransportStrings)[v23];
                      _IDSLogTransport(@"GL", @"IDS", @"new relay candidate pair %@ is accepted, transport: %s.");

                      if (_IDSShouldLog())
                      {
                        v57 = [v27 candidatePairToken];
                        v59 = (&_IDSStunTransportStrings)[v23];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"new relay candidate pair %@ is accepted, transport: %s.");
                      }
                    }
                  }
                }
              }
            }

            v24 = [v22 countByEnumeratingWithState:&v64 objects:v72 count:16];
          }

          while (v24);
        }

LABEL_94:
        self = v63;
        goto LABEL_95;
      }

      v70 = 0uLL;
      v71 = 0uLL;
      v68 = 0uLL;
      v69 = 0uLL;
      v37 = v60;
      v23 = 0;
      v38 = [v37 countByEnumeratingWithState:&v68 objects:v73 count:16];
      if (!v38)
      {
        goto LABEL_93;
      }

      v39 = *v69;
LABEL_67:
      v40 = 0;
      while (1)
      {
        if (*v69 != v39)
        {
          objc_enumerationMutation(v37);
        }

        v41 = *(*(&v68 + 1) + 8 * v40);
        if (![v41 isRelayStunCandidatePair])
        {
          goto LABEL_91;
        }

        v42 = [v41 sessionID];
        v43 = [v42 isEqualToString:v7];

        if (!v43)
        {
          break;
        }

        [v41 setIsAcceptedRelaySession:1];
        v44 = [v41 local];
        v23 = [v44 transport];

        v45 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
        {
          v46 = [v41 candidatePairToken];
          v47 = (&_IDSStunTransportStrings)[v23];
          *buf = 138412546;
          v75 = v46;
          v76 = 2080;
          v77 = v47;
          _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "relay candidate pair %@ is accepted, transport: %s.", buf, 0x16u);
        }

        if (!os_log_shim_legacy_logging_enabled())
        {
          goto LABEL_91;
        }

        if (!_IDSShouldLogTransport())
        {
          goto LABEL_91;
        }

        v57 = [v41 candidatePairToken];
        v59 = (&_IDSStunTransportStrings)[v23];
        _IDSLogTransport(@"GL", @"IDS", @"relay candidate pair %@ is accepted, transport: %s.");

        if (!_IDSShouldLog())
        {
          goto LABEL_91;
        }

        v48 = [v41 candidatePairToken];
        v57 = v48;
        v59 = (&_IDSStunTransportStrings)[v23];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"relay candidate pair %@ is accepted, transport: %s.");
LABEL_90:

LABEL_91:
        if (v38 == ++v40)
        {
          v38 = [v37 countByEnumeratingWithState:&v68 objects:v73 count:16];
          if (!v38)
          {
LABEL_93:

            goto LABEL_94;
          }

          goto LABEL_67;
        }
      }

      nonAcceptedQRSessions = v63->_nonAcceptedQRSessions;
      if (nonAcceptedQRSessions)
      {
        if (!v41)
        {
          goto LABEL_84;
        }
      }

      else
      {
        v50 = objc_alloc_init(MEMORY[0x1E695DF70]);
        v51 = v63->_nonAcceptedQRSessions;
        v63->_nonAcceptedQRSessions = v50;

        nonAcceptedQRSessions = v63->_nonAcceptedQRSessions;
        if (!v41)
        {
LABEL_84:
          v52 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
          {
            v53 = [v41 candidatePairToken];
            *buf = 138412290;
            v75 = v53;
            _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "relay candidate pair %@ is not accepted, added to remove list.", buf, 0xCu);
          }

          if (!os_log_shim_legacy_logging_enabled())
          {
            goto LABEL_91;
          }

          if (!_IDSShouldLogTransport())
          {
            goto LABEL_91;
          }

          v57 = [v41 candidatePairToken];
          _IDSLogTransport(@"GL", @"IDS", @"relay candidate pair %@ is not accepted, added to remove list.");

          if (!_IDSShouldLog())
          {
            goto LABEL_91;
          }

          v48 = [v41 candidatePairToken];
          v57 = v48;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"relay candidate pair %@ is not accepted, added to remove list.");
          goto LABEL_90;
        }
      }

      if (nonAcceptedQRSessions)
      {
        CFArrayAppendValue(nonAcceptedQRSessions, v41);
      }

      goto LABEL_84;
    }

    v35 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "setAcceptedRelaySession failed due to invalid relay-session-id.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setAcceptedRelaySession failed due to invalid relay-session-id.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setAcceptedRelaySession failed due to invalid relay-session-id.");
        }
      }
    }
  }

  else
  {
    v34 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "setAcceptedRelaySession failed, not Initiator.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setAcceptedRelaySession failed, not Initiator.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setAcceptedRelaySession failed, not Initiator.");
        }
      }
    }
  }

LABEL_106:
}

- (void)requestMaterialsForSession:(id)a3 participantIDs:(id)a4 materialType:(int)a5
{
  v21 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = IMGetDomainBoolForKey();
  v11 = +[IDSFoundationLog GlobalLink];
  v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);
  if (v10)
  {
    if (v12)
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: ignoring because DisableQUICMaterialRecovery is set", buf, 2u);
    }
  }

  else
  {
    if (v12)
    {
      *buf = 67109378;
      v18 = a5;
      v19 = 2112;
      v20 = v8;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: Trying to request material of type %d over active QUIC link for IDSSessionID: %@", buf, 0x12u);
    }

    if (self->_quicMaterialExchangeProvider)
    {
      v14[0] = MEMORY[0x1E69E9820];
      v14[1] = 3221225472;
      v14[2] = sub_1A7BB3484;
      v14[3] = &unk_1E77E1040;
      v14[4] = self;
      v15 = v9;
      v16 = a5;
      IDSTransportThreadAddBlock(v14);
    }

    else
    {
      v13 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: SME disabled", buf, 2u);
      }
    }
  }
}

- (BOOL)_qrMaterialExchangePutMaterial:(id)a3 completionHandler:(id)a4
{
  v78 = *MEMORY[0x1E69E9840];
  v53 = a3;
  v6 = a4;
  v7 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    idsSessionID = self->_idsSessionID;
    *buf = 138412546;
    v75 = v53;
    v76 = 2112;
    v77 = idsSessionID;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: Trying to send material %@ over active QUIC link for IDSSessionID: %@", buf, 0x16u);
  }

  if (self->_linkIDForPlugin)
  {
    v66 = 0u;
    v67 = 0u;
    v64 = 0u;
    v65 = 0u;
    v9 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v10 = [v9 countByEnumeratingWithState:&v64 objects:v73 count:16];
    aBlock = v6;
    if (v10)
    {
      v11 = v10;
      obj = self;
      v12 = 0;
      v13 = *v65;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v65 != v13)
          {
            objc_enumerationMutation(v9);
          }

          v15 = *(*(&v64 + 1) + 8 * i);
          v16 = [v15 state];
          if ([v15 isActualRelayStunCandidatePair])
          {
            if ([v15 isQUIC] && v16 == 4)
            {
              v18 = [IDSQRProtoMessage alloc];
              v71 = @"gl-option-materials-key";
              v72 = v53;
              v19 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v72 forKeys:&v71 count:1];
              v20 = [(IDSQRProtoMessage *)v18 initWithType:24 candidatePair:v15 options:v19];

              v21 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v75 = v15;
                _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: send quic message on %@", buf, 0xCu);
              }

              v22 = [v15 sendQUICPutMaterialRequest:v20];
              v12 |= v22;
              v6 = aBlock;
              if (aBlock && v22)
              {
                putMaterialReqTxIdToCompletionBlock = obj->_putMaterialReqTxIdToCompletionBlock;
                v24 = _Block_copy(aBlock);
                v25 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{-[IDSQRProtoMessage transactionID](v20, "transactionID")}];
                [(NSMutableDictionary *)putMaterialReqTxIdToCompletionBlock setObject:v24 forKey:v25];

                v6 = aBlock;
                v12 = 1;
              }
            }
          }
        }

        v11 = [v9 countByEnumeratingWithState:&v64 objects:v73 count:16];
      }

      while (v11);

      self = obj;
      if (v12)
      {
        v26 = 1;
        goto LABEL_54;
      }
    }

    else
    {
    }

    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    v29 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v30 = [v29 countByEnumeratingWithState:&v60 objects:v70 count:16];
    if (v30)
    {
      v31 = v30;
      v28 = 0;
      v32 = *v61;
      v48 = *v61;
      v49 = v29;
      do
      {
        v33 = 0;
        v50 = v31;
        do
        {
          if (*v61 != v32)
          {
            objc_enumerationMutation(v29);
          }

          v34 = *(*(&v60 + 1) + 8 * v33);
          v35 = [v34 state];
          if ([v34 isActualRelayStunCandidatePair] && (objc_msgSend(v34, "isQUIC") & 1) == 0 && v35 == 4)
          {
            v51 = v33;
            v58 = 0u;
            v59 = 0u;
            v56 = 0u;
            v57 = 0u;
            obja = v53;
            v36 = [obja countByEnumeratingWithState:&v56 objects:v69 count:16];
            if (v36)
            {
              v37 = v36;
              v38 = *v57;
              do
              {
                for (j = 0; j != v37; ++j)
                {
                  if (*v57 != v38)
                  {
                    objc_enumerationMutation(obja);
                  }

                  v40 = *(*(&v56 + 1) + 8 * j);
                  v41 = objc_alloc_init(MEMORY[0x1E695DF90]);
                  v42 = objc_alloc_init(IDSQRProtoPutMaterialMaterials);
                  v68 = v40;
                  v43 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v68 count:1];
                  v44 = [v43 mutableCopy];
                  [(IDSQRProtoPutMaterialMaterials *)v42 setMaterials:v44];

                  v45 = [(IDSQRProtoPutMaterialMaterials *)v42 data];
                  [v41 setObject:v45 forKeyedSubscript:@"gl-option-materials-key"];

                  v46 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412546;
                    v75 = v34;
                    v76 = 2112;
                    v77 = v40;
                    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: send stun message on %@ for key material %@", buf, 0x16u);
                  }

                  [v34 sendPutMaterialRequest:0 options:v41];
                }

                v37 = [obja countByEnumeratingWithState:&v56 objects:v69 count:16];
              }

              while (v37);
            }

            v28 = 1;
            v32 = v48;
            v29 = v49;
            v31 = v50;
            v33 = v51;
          }

          ++v33;
        }

        while (v33 != v31);
        v31 = [v29 countByEnumeratingWithState:&v60 objects:v70 count:16];
      }

      while (v31);
    }

    else
    {
      v28 = 0;
    }

    v26 = v28;
    v6 = aBlock;
    if (aBlock)
    {
LABEL_53:
      (*(v6 + 2))(v6, v28 & 1);
      v26 = v28;
    }
  }

  else
  {
    v27 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: no active QUIC link", buf, 2u);
    }

    v28 = 0;
    v26 = 0;
    if (v6)
    {
      goto LABEL_53;
    }
  }

LABEL_54:

  return v26 & 1;
}

- (void)qrMaterialExchangePutMaterial:(id)a3 completionHandler:(id)a4
{
  v6 = a3;
  v7 = a4;
  v10[0] = MEMORY[0x1E69E9820];
  v10[1] = 3221225472;
  v10[2] = sub_1A7BB3E10;
  v10[3] = &unk_1E77E1270;
  v10[4] = self;
  v11 = v6;
  v12 = v7;
  v8 = v7;
  v9 = v6;
  IDSTransportThreadAddBlock(v10);
}

- (id)_getLocalAttribute:(id)a3
{
  v214 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v6 = [v4 uniqueID];
  [v5 setObject:v6 forKeyedSubscript:@"gl-attr-uniqueid"];

  v7 = [v4 isVirtualRelayStunCandidatePair];
  v8 = [v4 local];
  v9 = [v8 transport];

  v193 = v7;
  if (v9 == 2)
  {
    v10 = 4;
  }

  else
  {
    v11 = [v4 local];
    v12 = [v11 transport];

    if (v12 == 3)
    {
      v10 = 896;
    }

    else
    {
      v10 = 0;
    }
  }

  v13 = [v4 local];
  v14 = [v13 address];

  *&v15 = 0xAAAAAAAAAAAAAAAALL;
  *(&v15 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v212 = v15;
  v213 = v15;
  v210 = v15;
  v211 = v15;
  v208 = v15;
  v209 = v15;
  *__str = v15;
  v207 = v15;
  SAToIPPortString(__str, 0x80uLL, v14);
  v16 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", __str];
  if (v16)
  {
    CFDictionarySetValue(v5, @"gl-attr-local-address-key", v16);
  }

  else
  {
    v17 = MEMORY[0x1E69E9C10];
    v18 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E161EC();
    }
  }

  v19 = *(v14 + 1);
  v20 = v10 | 1;
  v21 = 1;
  if (v19 != 2)
  {
    v20 = v10;
    v21 = 0;
  }

  v22 = v19 == 30;
  if (v19 == 30)
  {
    v23 = v10 | 2;
  }

  else
  {
    v23 = v20;
  }

  v199 = v23;
  if (v22)
  {
    v24 = 2;
  }

  else
  {
    v24 = v21;
  }

  theDict = v5;
  if ([v4 isRelayStunCandidatePair])
  {
    v25 = [v4 local];
    v26 = [v25 transport];
  }

  else
  {
    v26 = 1;
  }

  v27 = [v4 local];
  v198 = [v27 mtu];

  v28 = [(IDSGlobalLink *)self _getExpensiveLinkFlagsForCandidatePair:v4];
  v29 = [v4 local];
  v30 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](self, "_isInterfaceConstrainedWithInterfaceIndex:", [v29 index]);

  if (v30)
  {
    v31 = v28 | 2;
  }

  else
  {
    v31 = v28;
  }

  if (self->_remoteDeviceVersion >= 2)
  {
    v32 = [v4 local];
    v33 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v32 index]);

    if (v33)
    {
      v31 |= 4u;
    }
  }

  v34 = [v4 remote];
  [v34 linkFlags];

  v35 = *(v14 + 1);
  if (v35 == 2)
  {
    v36 = [v4 local];
    v37 = [v36 isCLAT46];

    v35 = *(v14 + 1);
  }

  else
  {
    v37 = 0;
  }

  v197 = v16;
  v38 = v31;
  if (v35 == 30)
  {
    if ([v4 isNAT64])
    {
      v38 = v31 | 0x10;
    }

    else
    {
      v38 = v31;
    }
  }

  if (v37)
  {
    v39 = v31 | 8;
  }

  else
  {
    v39 = v38;
  }

  v40 = +[IDSCellularLinkMonitor sharedInstance];
  v189 = [v40 dataSoMaskBits];

  v41 = [v4 local];
  v42 = [v41 radioAccessTechnology];

  if (v42)
  {
    v43 = v42 == 9;
  }

  else
  {
    v43 = 1;
  }

  v44 = !v43;
  v188 = v44;
  v45 = [v4 relayProviderType];
  v191 = [v4 relaySessionToken];
  v195 = [v4 relaySessionKey];
  v46 = [v4 local];
  v201 = self;
  v47 = -[IDSGlobalLink _interfaceNameForInterfaceIndex:](self, "_interfaceNameForInterfaceIndex:", [v46 index]);

  v48 = [v4 local];
  v49 = v39 | [v48 cellularSlicingFlags];

  v50 = +[IDSCellularLinkMonitor sharedInstance];
  v51 = [v50 isSlicedCellularInterfaceActive:v47];

  if (v51)
  {
    LOWORD(v49) = v49 | 0x80;
    v52 = [v4 local];
    [v52 setCellularSlicingFlags:v49];
  }

  v53 = [MEMORY[0x1E696AD98] numberWithInteger:v24];
  v54 = theDict;
  if (v53)
  {
    CFDictionarySetValue(theDict, @"gl-attr-ipfamily", v53);
  }

  else
  {
    v55 = MEMORY[0x1E69E9C10];
    v56 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v55, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16274();
    }
  }

  v57 = [MEMORY[0x1E696AD98] numberWithInteger:v26];
  if (v57)
  {
    CFDictionarySetValue(theDict, @"gl-attr-transport", v57);
  }

  else
  {
    v58 = MEMORY[0x1E69E9C10];
    v59 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E162FC();
    }
  }

  v60 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v42];
  if (v60)
  {
    CFDictionarySetValue(theDict, @"gl-attr-rat", v60);
  }

  else
  {
    v61 = MEMORY[0x1E69E9C10];
    v62 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v61, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16384();
    }
  }

  v63 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v49];
  if (v63)
  {
    CFDictionarySetValue(theDict, @"gl-attr-link-flags", v63);
  }

  else
  {
    v64 = MEMORY[0x1E69E9C10];
    v65 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v64, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1640C();
    }
  }

  v66 = [MEMORY[0x1E696AD98] numberWithChar:{objc_msgSend(v4, "delegatedLinkID")}];
  if (v66)
  {
    CFDictionarySetValue(theDict, @"gl-attr-delegated-link-id", v66);
  }

  else
  {
    v67 = MEMORY[0x1E69E9C10];
    v68 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v67, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16494();
    }
  }

  v69 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(v4, "relayLinkID")}];
  if (v69)
  {
    CFDictionarySetValue(theDict, @"gl-attr-local-relay-link-id", v69);
  }

  else
  {
    v70 = MEMORY[0x1E69E9C10];
    v71 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v70, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1651C();
    }
  }

  v72 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(v4, "remoteRelayLinkID")}];
  if (v72)
  {
    CFDictionarySetValue(theDict, @"gl-attr-remote-relay-link-id", v72);
  }

  else
  {
    v73 = MEMORY[0x1E69E9C10];
    v74 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E165A4();
    }
  }

  if (v42 && v42 != 9)
  {
    v75 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v189];
    if (v75)
    {
      CFDictionarySetValue(theDict, @"gl-attr-data-so-mask", v75);
    }

    else
    {
      v76 = MEMORY[0x1E69E9C10];
      v77 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v76, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E1662C();
      }
    }
  }

  v78 = [MEMORY[0x1E696AD98] numberWithInteger:v45];
  if (v78)
  {
    CFDictionarySetValue(theDict, @"qr-server-provider", v78);
  }

  else
  {
    v79 = MEMORY[0x1E69E9C10];
    v80 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v79, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E166B4();
    }
  }

  v81 = v191;
  if (v81)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessiontoken", v81);
  }

  else
  {
    v82 = MEMORY[0x1E69E9C10];
    v83 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v82, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1673C();
    }
  }

  v84 = v195;
  if (v84)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessionkey", v84);
  }

  else
  {
    v85 = MEMORY[0x1E69E9C10];
    v86 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v85, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E167C4();
    }
  }

  v87 = [v4 sessionID];
  if (v87)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessionid", v87);
  }

  else
  {
    v88 = MEMORY[0x1E69E9C10];
    v89 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v88, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1684C();
    }
  }

  v90 = [MEMORY[0x1E696AD98] numberWithBool:{objc_msgSend(v4, "serverIsDegraded")}];
  if (v90)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-serverdegraded", v90);
  }

  else
  {
    v91 = MEMORY[0x1E69E9C10];
    v92 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E168D4();
    }
  }

  v93 = [MEMORY[0x1E696AD98] numberWithBool:v193];
  if (v93)
  {
    CFDictionarySetValue(theDict, @"gl-attr-is-virtual-link", v93);
  }

  else
  {
    v94 = MEMORY[0x1E69E9C10];
    v95 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v94, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1695C();
    }
  }

  v196 = v84;

  v96 = v47;
  if (v96)
  {
    CFDictionarySetValue(theDict, @"gl-attr-interface-name", v96);
    v97 = v201;
  }

  else
  {
    v98 = MEMORY[0x1E69E9C10];
    v99 = MEMORY[0x1E69E9C10];
    v97 = v201;
    if (os_log_type_enabled(v98, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E169E4();
    }
  }

  v100 = v199;

  if (v97->_QUICForQREnabled)
  {
    v101 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
    {
      if (v193)
      {
        v102 = @"YES";
      }

      else
      {
        v102 = @"NO";
      }

      *buf = 138412802;
      *v203 = v4;
      *&v203[8] = 2112;
      *&v203[10] = v102;
      v204 = 1024;
      v205 = [v4 delegatedLinkID];
      _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "Setting up child connection for candidatepair %@ isVirtualRelayLink %@ delegatedLinkID %d", buf, 0x1Cu);
    }

    if ((v193 & 1) != 0 || v97->_disableDirectDatapath)
    {
      clientUniquePID = 0;
    }

    else
    {
      clientUniquePID = v97->_clientUniquePID;
    }

    v186 = v96;
    v187 = v81;
    if ([v4 isVirtualRelayStunCandidatePair])
    {
      v104 = [(IDSGlobalLink *)v97 _shouldUseVRTLE];
    }

    else if ([v4 isRelayStunCandidatePair])
    {
      v104 = [(IDSGlobalLink *)v97 _shouldUseQRTLE];
    }

    else
    {
      v104 = [(IDSGlobalLink *)v97 _shouldUseP2PTLE];
    }

    v190 = v104;
    nwLink = v97->_nwLink;
    v106 = [v4 local];
    v107 = [v106 address];
    v108 = [v4 remote];
    v109 = [v108 external];
    v110 = [v4 sessionID];
    v111 = [v4 isRelayStunCandidatePair];
    v112 = [v4 kindSuffix];
    v113 = [v4 local];
    LOBYTE(v183) = [v113 isCellularStunCandidate];
    v194 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:v107 remoteAddress:v109 clientUniquePID:clientUniquePID sessionID:v110 type:0 isRelay:v111 protocolStackSuffix:v112 isCellular:v183];

    if (([v4 isRelayStunCandidatePair] & 1) != 0 || objc_msgSend(v4, "isVirtualRelayStunCandidatePair"))
    {
      v114 = v201->_nwLink;
      v115 = [v4 local];
      v116 = [v115 address];
      v117 = [v4 remote];
      v118 = [v117 external];
      v119 = [v4 sessionID];
      v120 = [v4 kindSuffix];
      v121 = [v4 local];
      LOBYTE(v184) = [v121 isCellularStunCandidate];
      [(IDSNWLink *)v114 connectionInfoForLocalAddress:v116 remoteAddress:v118 clientUniquePID:clientUniquePID sessionID:v119 type:7 isRelay:1 protocolStackSuffix:v120 isCellular:v184];
    }

    else
    {
      v122 = v201->_nwLink;
      v115 = [v4 local];
      v123 = [v115 address];
      v117 = [v4 remote];
      v124 = [v117 external];
      v119 = [v4 sessionID];
      v120 = [v4 kindSuffix];
      v121 = [v4 local];
      LOBYTE(v184) = [v121 isCellularStunCandidate];
      [(IDSNWLink *)v122 connectionInfoForLocalAddress:v123 remoteAddress:v124 clientUniquePID:clientUniquePID sessionID:v119 type:9 isRelay:0 protocolStackSuffix:v120 isCellular:v184];
    }
    v125 = ;

    v97 = v201;
    v81 = v187;
    if ([v4 isRelayStunCandidatePair])
    {
      v126 = v201->_nwLink;
      v127 = [v4 local];
      v128 = [v127 address];
      v129 = [v4 remote];
      v130 = [v129 external];
      v131 = [v4 sessionID];
      v132 = [v4 kindSuffix];
      LOBYTE(v185) = v188;
      v133 = [(IDSNWLink *)v126 connectionInfoForLocalAddress:v128 remoteAddress:v130 clientUniquePID:0 sessionID:v131 type:5 isRelay:1 protocolStackSuffix:v132 isCellular:v185];

      v134 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v134, OS_LOG_TYPE_DEFAULT))
      {
        v135 = [v133 protocolStackDescription];
        *buf = 138412290;
        *v203 = v135;
        _os_log_impl(&dword_1A7AD9000, v134, OS_LOG_TYPE_DEFAULT, "relay control connection has protocol stack: %@", buf, 0xCu);
      }

      v136 = [v133 protocolStackDescription];
      v97 = v201;
      if (v136)
      {
        CFDictionarySetValue(theDict, @"gl-relay-protocol-stack", v136);
      }

      else
      {
        v137 = MEMORY[0x1E69E9C10];
        v138 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v137, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E16A6C();
        }
      }
    }

    v139 = [v4 isP2P];
    v54 = theDict;
    v96 = v186;
    if (v125 != 0 && v190)
    {
      v140 = v194;
      if ((v139 & 1) != 0 || [v4 isVirtualRelayStunCandidatePair])
      {
        v198 -= GLUtilGetLinkOverhead(8u);
      }
    }

    else
    {
      v140 = v194;
    }

    v141 = [MEMORY[0x1E695DF90] dictionary];
    if (v140)
    {
      v142 = GLUtilConnectionDictionaryForNWConnectionInfo(v140, 1);
      [v141 setObject:v142 forKeyedSubscript:@"udp"];
    }

    if (v125)
    {
      v143 = [MEMORY[0x1E696AD98] numberWithBool:v97->_isPartialTLEUPlusOneEnabled];
      if (v143)
      {
        CFDictionarySetValue(theDict, @"gl-attr-partial-tle-uplusone-enabled", v143);
      }

      else
      {
        v144 = MEMORY[0x1E69E9C10];
        v145 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v144, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E16AF4();
        }
      }

      v146 = GLUtilConnectionDictionaryForNWConnectionInfo(v125, v190);
      [v141 setObject:v146 forKeyedSubscript:@"qpod"];
    }

    v147 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v147, OS_LOG_TYPE_DEFAULT))
    {
      v148 = [v4 linkID];
      *buf = 67109378;
      *v203 = v148;
      *&v203[4] = 2112;
      *&v203[6] = v141;
      _os_log_impl(&dword_1A7AD9000, v147, OS_LOG_TYPE_DEFAULT, "connections for link %d: %@", buf, 0x12u);
    }

    v149 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(v4, "channelNumber")}];
    if (v149)
    {
      CFDictionarySetValue(theDict, @"gl-attr-linkchannelnumber", v149);
    }

    else
    {
      v150 = MEMORY[0x1E69E9C10];
      v151 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v150, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16B7C();
      }
    }

    v152 = [v4 hbhEncKey];
    if (v152)
    {
      CFDictionarySetValue(theDict, @"gl-attr-hbhenckey", v152);
    }

    else
    {
      v153 = MEMORY[0x1E69E9C10];
      v154 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v153, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16C04();
      }
    }

    v155 = [v4 hbhDecKey];
    if (v155)
    {
      CFDictionarySetValue(theDict, @"gl-attr-hbhdeckey", v155);
    }

    else
    {
      v156 = MEMORY[0x1E69E9C10];
      v157 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v156, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16C8C();
      }
    }

    v158 = v141;
    if (v158)
    {
      CFDictionarySetValue(theDict, @"gl-attr-connections", v158);
      v159 = v194;
    }

    else
    {
      v160 = MEMORY[0x1E69E9C10];
      v161 = MEMORY[0x1E69E9C10];
      v162 = os_log_type_enabled(v160, OS_LOG_TYPE_ERROR);
      v159 = v194;
      if (v162)
      {
        sub_1A7E16D14();
      }
    }

    v100 = v199;
    if (v125 != 0 && v190)
    {
      v100 = v199 | 8;
      v103 = 16;
    }

    else
    {
      v103 = 32;
    }
  }

  else
  {
    v103 = 32;
  }

  if (([v4 isVirtualRelayStunCandidatePair] & 1) != 0 || objc_msgSend(v4, "isRelayStunCandidatePair"))
  {
    v100 |= v103;
  }

  if ([v4 isVirtualRelayStunCandidatePair])
  {
    v100 |= 0x40u;
  }

  v163 = [MEMORY[0x1E695DF70] array];
  v164 = v163;
  if (v97->_useLinkEngine)
  {
    [v163 addObject:@"le"];
  }

  v165 = v97->_qrExperiments;
  if (v165)
  {
    CFDictionarySetValue(v54, @"gl-attr-qr-experiments", v165);
    v166 = v196;
  }

  else
  {
    v167 = MEMORY[0x1E69E9C10];
    v168 = MEMORY[0x1E69E9C10];
    v166 = v196;
    if (os_log_type_enabled(v167, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16D9C();
    }
  }

  v169 = v164;
  if (v169)
  {
    CFDictionarySetValue(v54, @"ff", v169);
  }

  else
  {
    v170 = MEMORY[0x1E69E9C10];
    v171 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v170, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16E24();
    }
  }

  v172 = [v4 linkUniqueName];
  if (v172)
  {
    CFDictionarySetValue(v54, @"leid", v172);
  }

  else
  {
    v173 = MEMORY[0x1E69E9C10];
    v174 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v173, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16EAC();
    }
  }

  v175 = [MEMORY[0x1E696AD98] numberWithInt:v198];
  if (v175)
  {
    CFDictionarySetValue(v54, @"gl-attr-mtu", v175);
  }

  else
  {
    v176 = MEMORY[0x1E69E9C10];
    v177 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v176, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16F34();
    }
  }

  v178 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:GLUtilGetLinkOverhead(v100)];
  if (v178)
  {
    CFDictionarySetValue(v54, @"gl-attr-constant-overhead", v178);
  }

  else
  {
    v179 = MEMORY[0x1E69E9C10];
    v180 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v179, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16FBC();
    }
  }

  v181 = [(__CFDictionary *)v54 copy];

  return v181;
}

- (id)_getRemoteAttribute:(id)a3
{
  v74 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v6 = [v4 isVirtualRelayStunCandidatePair];
  v7 = [v4 remote];
  v8 = [v7 transport];

  if (v8 == 2)
  {
    v9 = 4;
  }

  else
  {
    v10 = [v4 remote];
    v11 = [v10 transport];

    if (v11 == 3)
    {
      v9 = 896;
    }

    else
    {
      v9 = 0;
    }
  }

  v12 = [v4 remote];
  v13 = [v12 external];

  *&v14 = 0xAAAAAAAAAAAAAAAALL;
  *(&v14 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v72 = v14;
  v73 = v14;
  v70 = v14;
  v71 = v14;
  v68 = v14;
  v69 = v14;
  *__str = v14;
  v67 = v14;
  SAToIPPortString(__str, 0x80uLL, v13);
  v15 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", __str];
  if (v15)
  {
    CFDictionarySetValue(v5, @"gl-attr-remote-address-key", v15);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17044();
  }

  v16 = *(v13 + 1);
  v17 = v9 | 1;
  v18 = 1;
  if (v16 != 2)
  {
    v17 = v9;
    v18 = 0;
  }

  v19 = v16 == 30;
  if (v16 == 30)
  {
    v20 = v9 | 2;
  }

  else
  {
    v20 = v17;
  }

  v62 = v20;
  if (v19)
  {
    v21 = 2;
  }

  else
  {
    v21 = v18;
  }

  v63 = v21;
  if ([v4 isRelayStunCandidatePair])
  {
    v22 = [v4 local];
    v64 = [v22 transport];
  }

  else
  {
    v64 = 1;
  }

  v23 = [v4 remote];
  v65 = [v23 mtu];

  if (self->_QUICForQREnabled)
  {
    if ([v4 isVirtualRelayStunCandidatePair])
    {
      v24 = [(IDSGlobalLink *)self _shouldUseVRTLE];
    }

    else if ([v4 isRelayStunCandidatePair])
    {
      v24 = [(IDSGlobalLink *)self _shouldUseQRTLE];
    }

    else
    {
      v24 = [(IDSGlobalLink *)self _shouldUseP2PTLE];
    }

    v58 = v24;
    v59 = v6;
    v61 = v15;
    v60 = self;
    if (([v4 isRelayStunCandidatePair] & 1) != 0 || objc_msgSend(v4, "isVirtualRelayStunCandidatePair"))
    {
      nwLink = self->_nwLink;
      v27 = [v4 local];
      v28 = [v27 address];
      v29 = [v4 remote];
      v30 = [v29 external];
      v31 = [v4 sessionID];
      v32 = [v4 kindSuffix];
      v33 = [v4 local];
      LOBYTE(v57) = [v33 isCellularStunCandidate];
      [(IDSNWLink *)nwLink connectionInfoForLocalAddress:v28 remoteAddress:v30 clientUniquePID:0 sessionID:v31 type:7 isRelay:1 protocolStackSuffix:v32 isCellular:v57];
    }

    else
    {
      v34 = self->_nwLink;
      v27 = [v4 local];
      v35 = [v27 address];
      v29 = [v4 remote];
      v36 = [v29 external];
      v31 = [v4 sessionID];
      v32 = [v4 kindSuffix];
      v33 = [v4 local];
      LOBYTE(v57) = [v33 isCellularStunCandidate];
      [(IDSNWLink *)v34 connectionInfoForLocalAddress:v35 remoteAddress:v36 clientUniquePID:0 sessionID:v31 type:9 isRelay:0 protocolStackSuffix:v32 isCellular:v57];
    }
    v37 = ;

    v38 = [v4 isP2P];
    v25 = v37 != 0 && v58;
    if (v25 == 1)
    {
      self = v60;
      v6 = v59;
      if ((v38 & 1) != 0 || [v4 isVirtualRelayStunCandidatePair])
      {
        v65 -= GLUtilGetLinkOverhead(8u);
      }
    }

    else
    {
      self = v60;
      v6 = v59;
    }

    v15 = v61;
  }

  else
  {
    v25 = 0;
  }

  v39 = [v4 remote];
  v40 = [v39 linkFlags];

  if ((v6 & 1) == 0 && self->_remoteDeviceVersion < 2)
  {
    v40 &= ~4u;
  }

  v41 = [v4 remote];
  v42 = [v41 dataSoMask];

  v43 = [v4 remote];
  v44 = [v43 radioAccessTechnology];

  if (v25)
  {
    v45 = v62 | 8;
  }

  else
  {
    v45 = v62;
  }

  if (([v4 isVirtualRelayStunCandidatePair] & 1) != 0 || objc_msgSend(v4, "isRelayStunCandidatePair"))
  {
    if (v25)
    {
      v46 = 16;
    }

    else
    {
      v46 = 32;
    }

    v45 |= v46;
  }

  if ([v4 isVirtualRelayStunCandidatePair])
  {
    v47 = v45 | 0x40;
  }

  else
  {
    v47 = v45;
  }

  v48 = [MEMORY[0x1E696AD98] numberWithInteger:v63];
  if (v48)
  {
    CFDictionarySetValue(v5, @"gl-attr-ipfamily", v48);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E170CC();
  }

  v49 = [MEMORY[0x1E696AD98] numberWithInteger:v64];
  if (v49)
  {
    CFDictionarySetValue(v5, @"gl-attr-transport", v49);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17154();
  }

  v50 = [MEMORY[0x1E696AD98] numberWithInt:v65];
  if (v50)
  {
    CFDictionarySetValue(v5, @"gl-attr-mtu", v50);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E171DC();
  }

  v51 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:GLUtilGetLinkOverhead(v47)];
  if (v51)
  {
    CFDictionarySetValue(v5, @"gl-attr-constant-overhead", v51);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17264();
  }

  v52 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v44];
  if (v52)
  {
    CFDictionarySetValue(v5, @"gl-attr-rat", v52);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E172EC();
  }

  v53 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v40];
  if (v53)
  {
    CFDictionarySetValue(v5, @"gl-attr-link-flags", v53);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17374();
  }

  if (v44 && v44 != 9)
  {
    v54 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v42];
    if (v54)
    {
      CFDictionarySetValue(v5, @"gl-attr-data-so-mask", v54);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E173FC();
    }
  }

  v55 = [(__CFDictionary *)v5 copy];

  return v55;
}

- (void)sendConnectedLinkInfoToAVC
{
  v53 = *MEMORY[0x1E69E9840];
  v3 = [(NSMutableArray *)self->_connectedLinkIDs copy];
  v4 = 0x1E77DB000uLL;
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *v45 = v3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "sendConnectedLinkInfoToAVC: current connected links: %@", buf, 0xCu);
  }

  v42 = 0u;
  v43 = 0u;
  v40 = 0u;
  v41 = 0u;
  v6 = v3;
  v36 = [v6 countByEnumeratingWithState:&v40 objects:v52 count:16];
  if (v36)
  {
    v8 = *v41;
    *&v7 = 67109378;
    v35 = v7;
    do
    {
      for (i = 0; i != v36; ++i)
      {
        if (*v41 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v40 + 1) + 8 * i);
        if (([v10 intValue] & 0x80000000) != 0 || objc_msgSend(v10, "intValue") >= self->_maxLinkID)
        {
          v11 = 0;
        }

        else
        {
          v11 = self->_candidatePairs[[v10 intValue]];
        }

        v12 = v11;
        v13 = [(IDSStunCandidatePair *)v12 isVirtualRelayStunCandidatePair];
        v14 = [(IDSGlobalLink *)self _getLocalAttribute:v12];
        v38 = [(IDSGlobalLink *)self _getRemoteAttribute:v12];
        v39 = [v10 charValue];
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v16 = objc_opt_respondsToSelector();

        if (v16)
        {
          v17 = @"VR";
          if (!v13)
          {
            v18 = [(IDSStunCandidatePair *)v12 isRelayStunCandidatePair];
            v17 = @"P2P";
            if (v18)
            {
              v17 = @"RLY";
            }
          }

          v37 = v17;
          v19 = [*(v4 + 2592) GlobalLink];
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = v8;
            v21 = v6;
            v22 = v4;
            idsSessionID = self->_idsSessionID;
            v24 = [(IDSStunCandidatePair *)v12 sessionID];
            *buf = 67110146;
            *v45 = v39;
            *&v45[4] = 2112;
            *&v45[6] = v37;
            v46 = 2112;
            v47 = idsSessionID;
            v4 = v22;
            v6 = v21;
            v8 = v20;
            v48 = 2112;
            v49 = v24;
            v50 = 2112;
            v51 = v12;
            _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "Send link cached connected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x30u);
          }

          v25 = [(IDSGlobalLink *)self _translateLinkTransportTypeWhenH2Enabled:v14];

          v26 = objc_loadWeakRetained(&self->_delegate);
          v27 = [(IDSStunCandidatePair *)v12 linkUUID];
          v28 = v38;
          [v26 link:self didConnectUnderlyingLink:v39 linkUUID:v27 localAttributes:v25 remoteAttributes:v38];

          v14 = v25;
        }

        else
        {
          v28 = v38;
        }

        v29 = objc_loadWeakRetained(&self->_delegate);
        v30 = objc_opt_respondsToSelector();

        if (v30)
        {
          v31 = [*(v4 + 2592) GlobalLink];
          if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
          {
            v32 = [(IDSStunCandidatePair *)v12 participantIDMap];
            *buf = v35;
            *v45 = v39;
            *&v45[4] = 2112;
            *&v45[6] = v32;
            _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "Send updated participantID cached map for link: %d, map: %@", buf, 0x12u);
          }

          v33 = objc_loadWeakRetained(&self->_delegate);
          v34 = [(IDSStunCandidatePair *)v12 participantIDMap];
          [v33 link:self didReceiveMappedParticipantsDict:v34 forLinkID:v39];
        }
      }

      v36 = [v6 countByEnumeratingWithState:&v40 objects:v52 count:16];
    }

    while (v36);
  }
}

- (void)reportLinkEvent:(id)a3 linkID:(unsigned __int8)a4
{
  v4 = a4;
  v15 = *MEMORY[0x1E69E9840];
  v6 = a3;
  if (self->_maxLinkID > v4 && (v7 = self->_candidatePairs[v4]) != 0)
  {
    p_super = &v7->super;
    v9 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v11 = 138412546;
      v12 = v6;
      v13 = 2112;
      v14 = p_super;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "reportLinkEvent: eventName: %@, candidate pair: %@", &v11, 0x16u);
    }

    v10 = [p_super linkMetrics];
    [v10 event:v6];
  }

  else
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_DEFAULT))
    {
      v11 = 67109120;
      LODWORD(v12) = v4;
      _os_log_impl(&dword_1A7AD9000, p_super, OS_LOG_TYPE_DEFAULT, "reportLinkEvent: no candidate pair found for linkID %d", &v11, 8u);
    }
  }
}

- (void)setPacketNotificationFilter:(char)a3 uniqueTag:(unsigned int)a4 isEnabled:(BOOL)a5
{
  v5 = a3;
  v67 = *MEMORY[0x1E69E9840];
  if (self->_state < 5 || !a5)
  {
    if (a3 < 0 || self->_maxLinkID <= a3 || (v8 = a5, v9 = *&a4, (v10 = self->_candidatePairs[a3]) == 0))
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        *&buf[4] = v5;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
          }
        }
      }

      v11 = 0;
    }

    else
    {
      v11 = v10;
      if ([(IDSStunCandidatePair *)v10 state]< 5)
      {
        v16 = [(IDSStunCandidatePair *)v11 local];
        v17 = [v16 address];

        v18 = [(IDSStunCandidatePair *)v11 remote];
        v19 = [v18 external];

        if (v8)
        {
          v48 = v19;
          self->_basebandPacketChannelNumber = [(IDSStunCandidatePair *)v11 channelNumber];
          self->_basebandPacketLinkID = v5;
          if (self->_clientType == 5)
          {
            v20 = 1;
          }

          else
          {
            v20 = 2;
          }

          v46 = v20;
          v21 = [(IDSStunCandidatePair *)v11 local];
          v22 = [v21 index];

          v55 = 0u;
          v56 = 0u;
          v53 = 0u;
          v54 = 0u;
          v23 = self->_interfaceAddressArray;
          v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v53 objects:v66 count:16];
          if (v24)
          {
            v25 = *v54;
LABEL_37:
            v26 = 0;
            while (1)
            {
              if (*v54 != v25)
              {
                objc_enumerationMutation(v23);
              }

              v27 = *(*(&v53 + 1) + 8 * v26);
              if ([v27 index] == v22)
              {
                break;
              }

              if (v24 == ++v26)
              {
                v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v53 objects:v66 count:16];
                if (v24)
                {
                  goto LABEL_37;
                }

                goto LABEL_43;
              }
            }

            v47 = [v27 name];
            v30 = [v27 delegatedIndex];

            if (!v30)
            {
              v28 = v47;
              goto LABEL_66;
            }

            v51 = 0u;
            v52 = 0u;
            v49 = 0u;
            v50 = 0u;
            v23 = self->_interfaceAddressArray;
            v31 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v49 objects:v65 count:16];
            if (v31)
            {
              v32 = *v50;
LABEL_48:
              v33 = 0;
              while (1)
              {
                if (*v50 != v32)
                {
                  objc_enumerationMutation(v23);
                }

                v34 = *(*(&v49 + 1) + 8 * v33);
                if ([v34 index] == v30)
                {
                  break;
                }

                if (v31 == ++v33)
                {
                  v31 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v49 objects:v65 count:16];
                  if (v31)
                  {
                    goto LABEL_48;
                  }

                  goto LABEL_63;
                }
              }

              if (![v34 isCellular])
              {
                goto LABEL_63;
              }

              v35 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
              {
                v36 = [v34 name];
                *buf = 138412546;
                *&buf[4] = v47;
                *&buf[12] = 2112;
                *&buf[14] = v36;
                _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "setPacketNotificationFilter: overriding source interface [%@] with [%@]", buf, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  [v34 name];
                  v45 = v44 = v47;
                  _IDSLogTransport(@"GL", @"IDS", @"setPacketNotificationFilter: overriding source interface [%@] with [%@]");

                  if (_IDSShouldLog())
                  {
                    [v34 name];
                    v45 = v44 = v47;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"setPacketNotificationFilter: overriding source interface [%@] with [%@]");
                  }
                }
              }

              v28 = [v34 name];

              v37 = [v34 address];
              v17 = [v37 sa];
            }

            else
            {
LABEL_63:
              v28 = v47;
            }
          }

          else
          {
LABEL_43:
            v47 = 0;
            v28 = 0;
          }

LABEL_66:
          *&v38 = 0xAAAAAAAAAAAAAAAALL;
          *(&v38 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v63 = v38;
          v64 = v38;
          v61 = v38;
          v62 = v38;
          v59 = v38;
          v60 = v38;
          *buf = v38;
          *&buf[16] = v38;
          v57[6] = v38;
          v57[7] = v38;
          v57[4] = v38;
          v57[5] = v38;
          v57[2] = v38;
          v57[3] = v38;
          v57[0] = v38;
          v57[1] = v38;
          if (self->_QUICForQREnabled)
          {
            nwLink = self->_nwLink;
            v40 = [(IDSStunCandidatePair *)v11 sessionID];
            v41 = [(IDSNWLink *)nwLink getEffectiveSourceAddress:buf fromSourceAddress:v17 effectiveDestinationAddress:v57 fromDestinationAddress:v48 sessionID:v40 isQRConnection:[(IDSStunCandidatePair *)v11 isRelayStunCandidatePair]];

            v42 = v48;
            if (v41)
            {
              v42 = v57;
            }

            v48 = v42;
            if (v41)
            {
              v17 = buf;
            }
          }

          v43 = +[IDSCellularLinkMonitor sharedInstance];
          [v43 setPacketNotificationFilter:v17 remote:v48 uniqueTag:v9 callType:v46 ifname:v28];
        }

        else
        {
          v29 = +[IDSCellularLinkMonitor sharedInstance];
          [v29 removePacketNotificationFilter];

          self->_basebandPacketChannelNumber = 0;
          self->_basebandPacketLinkID = 0;
        }
      }

      else
      {
        v12 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          *&buf[4] = v5;
          _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "candidate pair for linkID:%d has been already disconnected.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"candidate pair for linkID:%d has been already disconnected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"candidate pair for linkID:%d has been already disconnected.");
            }
          }
        }
      }
    }
  }

  else
  {
    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = v5;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "GL link already disconnected - not setting packet notification filter for link %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"GL link already disconnected - not setting packet notification filter for link %d");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"GL link already disconnected - not setting packet notification filter for link %d");
      }
    }
  }
}

- (void)dropIPPackets:(char)a3 payloadArray:(id)a4
{
  v4 = a3;
  v59 = *MEMORY[0x1E69E9840];
  v6 = a4;
  if (v4 < 0 || self->_maxLinkID <= v4 || (v7 = self->_candidatePairs[v4]) == 0)
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = v4;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
        }
      }
    }
  }

  else
  {
    v8 = v7;
    if ([(IDSStunCandidatePair *)v7 isSharedQRSession])
    {
      v38 = [(IDSStunCandidatePair *)v8 channelNumber];
    }

    else
    {
      v38 = 0;
    }

    v10 = [(IDSStunCandidatePair *)v8 local];
    v11 = [v10 address];

    v12 = [(IDSStunCandidatePair *)v8 remote];
    v40 = [v12 external];

    v13 = [(IDSStunCandidatePair *)v8 local];
    v14 = [v13 index];

    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    v46 = 0u;
    v15 = self->_interfaceAddressArray;
    v16 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v45 objects:v58 count:16];
    if (v16)
    {
      v17 = *v46;
LABEL_15:
      v18 = 0;
      while (1)
      {
        if (*v46 != v17)
        {
          objc_enumerationMutation(v15);
        }

        v19 = *(*(&v45 + 1) + 8 * v18);
        if ([v19 index] == v14)
        {
          break;
        }

        if (v16 == ++v18)
        {
          v16 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v45 objects:v58 count:16];
          if (v16)
          {
            goto LABEL_15;
          }

          goto LABEL_21;
        }
      }

      v39 = [v19 name];
      v21 = [v19 delegatedIndex];

      if (!v21)
      {
        v20 = v39;
        goto LABEL_43;
      }

      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v15 = self->_interfaceAddressArray;
      v22 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v41 objects:v57 count:16];
      if (v22)
      {
        v23 = *v42;
LABEL_25:
        v24 = 0;
        while (1)
        {
          if (*v42 != v23)
          {
            objc_enumerationMutation(v15);
          }

          v25 = *(*(&v41 + 1) + 8 * v24);
          if ([v25 index] == v21)
          {
            break;
          }

          if (v22 == ++v24)
          {
            v22 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v41 objects:v57 count:16];
            if (v22)
            {
              goto LABEL_25;
            }

            goto LABEL_40;
          }
        }

        if (![v25 isCellular])
        {
          goto LABEL_40;
        }

        v26 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
        {
          v27 = [v25 name];
          *buf = 138412546;
          *&buf[4] = v39;
          *&buf[12] = 2112;
          *&buf[14] = v27;
          _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "dropIPPackets: overriding source interface [%@] with [%@]", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            [v25 name];
            v37 = v36 = v39;
            _IDSLogTransport(@"GL", @"IDS", @"dropIPPackets: overriding source interface [%@] with [%@]");

            if (_IDSShouldLog())
            {
              [v25 name];
              v37 = v36 = v39;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"dropIPPackets: overriding source interface [%@] with [%@]");
            }
          }
        }

        v20 = [v25 name];

        v28 = [v25 address];
        v11 = [v28 sa];
      }

      else
      {
LABEL_40:
        v20 = v39;
      }
    }

    else
    {
LABEL_21:
      v39 = 0;
      v20 = 0;
    }

LABEL_43:
    *&v29 = 0xAAAAAAAAAAAAAAAALL;
    *(&v29 + 1) = 0xAAAAAAAAAAAAAAAALL;
    v55 = v29;
    v56 = v29;
    v53 = v29;
    v54 = v29;
    v51 = v29;
    v52 = v29;
    *buf = v29;
    *&buf[16] = v29;
    v49[6] = v29;
    v49[7] = v29;
    v49[4] = v29;
    v49[5] = v29;
    v49[2] = v29;
    v49[3] = v29;
    v49[0] = v29;
    v49[1] = v29;
    if (self->_QUICForQREnabled)
    {
      nwLink = self->_nwLink;
      v31 = [(IDSStunCandidatePair *)v8 sessionID];
      v32 = [(IDSNWLink *)nwLink getEffectiveSourceAddress:buf fromSourceAddress:v11 effectiveDestinationAddress:v49 fromDestinationAddress:v40 sessionID:v31 isQRConnection:[(IDSStunCandidatePair *)v8 isRelayStunCandidatePair]];

      v33 = v40;
      if (v32)
      {
        v33 = v49;
      }

      v40 = v33;
      if (v32)
      {
        v11 = buf;
      }
    }

    v34 = +[IDSCellularLinkMonitor sharedInstance];
    v35 = [(IDSStunCandidatePair *)v8 local];
    [v34 dropIPPackets:v6 localAddress:v11 remoteAddress:v40 isRelay:objc_msgSend(v35 channelNumberMSB:"isRelayStunCandidate") ifname:{v38, v20}];
  }
}

- (void)updateProtocolQualityOfService:(char)a3 isGood:(BOOL)a4
{
  v4 = a3;
  v12 = *MEMORY[0x1E69E9840];
  if (a3 < 0 || self->_maxLinkID <= a3 || (v5 = a4, (v9 = self->_candidatePairs[a3]) == 0))
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v11 = v4;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
        }
      }
    }
  }

  else
  {
    v6 = +[IDSCellularLinkMonitor sharedInstance];
    v7 = [(IDSStunCandidatePair *)v9 local];
    [v6 updateProtocolQualityOfService:v5 localAddress:{objc_msgSend(v7, "address")}];
  }
}

- (void)stopKeepAlive:(id)a3
{
  v7 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v6 = v3;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop heart beat for linkIDs:%@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop heart beat for linkIDs:%@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop heart beat for linkIDs:%@");
      }
    }
  }
}

- (void)currentCellularSignalStrength:(int *)a3 signalStrength:(int *)a4 signalGrade:(int *)a5
{
  if (a3 && a4 && a5)
  {
    v9 = +[IDSCellularLinkMonitor sharedInstance];
    [v9 currentCellularSignalStrength:a3 signalStrength:a4 signalGrade:a5];
  }

  else
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "currentCellularSignalStrength failed due to invalid parameter.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"currentCellularSignalStrength failed due to invalid parameter.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"currentCellularSignalStrength failed due to invalid parameter.");
        }
      }
    }
  }
}

- (void)setWiFiAssistState:(BOOL)a3
{
  v3 = a3;
  [(IDSUDPLink *)self->_udpLink setWiFiAssistState:?];
  [(IDSUDPLink *)self->_udpLinkv6 setWiFiAssistState:v3];
  [(IDSTCPLink *)self->_tcpLink setWiFiAssistState:v3];
  [(IDSTCPLink *)self->_tcpSSLLink setWiFiAssistState:v3];
  nwLink = self->_nwLink;

  [(IDSNWLink *)nwLink setWiFiAssistState:v3];
}

- (void)startLinkProbing:(id)a3
{
  v53 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v6 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v8 = [v7 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v8)
    {
      connectedLinkIDs = self->_connectedLinkIDs;
      goto LABEL_8;
    }
  }

  else
  {
  }

  connectedLinkIDs = 0;
  if (v4 && @"ids-extchannel-probing-link-ids-key")
  {
    connectedLinkIDs = CFDictionaryGetValue(v4, @"ids-extchannel-probing-link-ids-key");
  }

LABEL_8:
  v43 = 0u;
  v44 = 0u;
  v45 = 0u;
  v46 = 0u;
  v10 = [connectedLinkIDs copy];
  v11 = [v10 countByEnumeratingWithState:&v43 objects:v52 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v44;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v44 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v43 + 1) + 8 * i);
        if (([(NSMutableArray *)self->_activeProbingLinkIDs containsObject:v15]& 1) == 0)
        {
          [(NSMutableArray *)v5 addObject:v15];
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v43 objects:v52 count:16];
    }

    while (v12);
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v48 = v5;
    v49 = 2112;
    *v50 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "startLinkProbing: add new probing linkIDs: %@, to activeProbingLinkIDs: %@", buf, 0x16u);
  }

  [(NSMutableArray *)self->_activeProbingLinkIDs addObjectsFromArray:v5];
  Value = 0;
  if (v4 && @"ids-extchannel-probing-timeout-key")
  {
    Value = CFDictionaryGetValue(v4, @"ids-extchannel-probing-timeout-key");
  }

  v19 = [Value unsignedIntValue];
  v20 = 0;
  self->_probingTimeout = v19;
  v38 = v10;
  if (v4 && @"ids-extchannel-probing-interval-key")
  {
    v20 = CFDictionaryGetValue(v4, @"ids-extchannel-probing-interval-key");
  }

  v21 = [v20 unsignedIntValue];
  if (v21)
  {
    v22 = v21;
    v36 = v5;
    v37 = v4;
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v23 = v5;
    v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v39 objects:v51 count:16];
    if (v24)
    {
      v25 = v24;
      v26 = 0;
      v27 = *v40;
      do
      {
        for (j = 0; j != v25; ++j)
        {
          if (*v40 != v27)
          {
            objc_enumerationMutation(v23);
          }

          v29 = *(*(&v39 + 1) + 8 * j);
          if (([v29 intValue] & 0x80000000) != 0 || objc_msgSend(v29, "intValue") >= self->_maxLinkID)
          {
            v30 = 0;
          }

          else
          {
            v30 = self->_candidatePairs[[v29 intValue]];
          }

          v31 = v30;
          if ([(IDSStunCandidatePair *)v31 isSharedQRSession])
          {
            v32 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v48 = v31;
              _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "startLinkProbing: skipped shared QR session %@", buf, 0xCu);
            }

            if (!v26)
            {
              v26 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v29 && v26)
            {
              CFArrayAppendValue(v26, v29);
            }
          }

          else
          {
            [(IDSStunCandidatePair *)v31 startLinkProbingTimer:v22];
          }
        }

        v25 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v39 objects:v51 count:16];
      }

      while (v25);
    }

    else
    {
      v26 = 0;
    }

    [(NSMutableArray *)self->_activeProbingLinkIDs removeObjectsInArray:v26];
    v33 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = self->_activeProbingLinkIDs;
      probingTimeout = self->_probingTimeout;
      *buf = 138412802;
      v48 = v34;
      v49 = 1024;
      *v50 = v22;
      *&v50[4] = 1024;
      *&v50[6] = probingTimeout;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "startLinkProbing: activeProbingLinkIDs: %@, probingInterval: %u, _probingTimeout: %u", buf, 0x18u);
    }

    v5 = v36;
    v4 = v37;
  }

  else
  {
    v26 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17484();
    }
  }
}

- (void)stopLinkProbing:(id)a3
{
  v28 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v7)
    {
      v8 = [(NSMutableArray *)self->_activeProbingLinkIDs copy];
      goto LABEL_9;
    }
  }

  else
  {
  }

  Value = 0;
  if (v4 && @"ids-extchannel-probing-link-ids-key")
  {
    Value = CFDictionaryGetValue(v4, @"ids-extchannel-probing-link-ids-key");
  }

  v8 = Value;
LABEL_9:
  v21 = 0u;
  v22 = 0u;
  v19 = 0u;
  v20 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v19 objects:v27 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v20;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v20 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v19 + 1) + 8 * i);
        if (([v15 intValue] & 0x80000000) != 0 || objc_msgSend(v15, "intValue") >= self->_maxLinkID)
        {
          v16 = 0;
        }

        else
        {
          v16 = self->_candidatePairs[[v15 intValue]];
        }

        [(IDSStunCandidatePair *)v16 stopLinkProbingTimer];
      }

      v12 = [v10 countByEnumeratingWithState:&v19 objects:v27 count:16];
    }

    while (v12);
  }

  [(NSMutableArray *)self->_activeProbingLinkIDs removeObjectsInArray:v10];
  v17 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v24 = v10;
    v25 = 2112;
    v26 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "stopLinkProbing: linkIDs: %@, activeProbingLinkIDs: %@", buf, 0x16u);
  }
}

- (void)_stopProbingOnLinkID:(char)a3
{
  v3 = a3;
  v14 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    v13 = v3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_stopProbingOnLinkID: %d", buf, 8u);
  }

  v10 = @"ids-extchannel-probing-link-ids-key";
  v6 = [MEMORY[0x1E696AD98] numberWithChar:v3];
  v9 = v6;
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v9 count:1];
  v11 = v7;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v11 forKeys:&v10 count:1];
  [(IDSGlobalLink *)self stopLinkProbing:v8];
}

- (void)queryLinkProbingStatus:(id)a3
{
  v118 = *MEMORY[0x1E69E9840];
  v4 = a3;
  theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
  v5 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  v81 = v4;
  if ((objc_opt_isKindOfClass() & 1) == 0)
  {

LABEL_5:
    Value = 0;
    if (v4 && @"ids-extchannel-probing-link-ids-key")
    {
      Value = CFDictionaryGetValue(v4, @"ids-extchannel-probing-link-ids-key");
    }

    v8 = Value;
    goto LABEL_9;
  }

  v6 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

  if (!v7)
  {
    goto LABEL_5;
  }

  v8 = [(NSMutableArray *)self->_connectedLinkIDs copy];
LABEL_9:
  v10 = v8;
  v11 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v108 = v10;
    _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: linkIDs: %@", buf, 0xCu);
  }

  v103 = 0u;
  v104 = 0u;
  v101 = 0u;
  v102 = 0u;
  v12 = v10;
  v13 = [(__CFString *)v12 countByEnumeratingWithState:&v101 objects:v117 count:16];
  if (!v13)
  {
    v15 = 0;
    goto LABEL_107;
  }

  v14 = v13;
  v15 = 0;
  candidatePairs = self->_candidatePairs;
  v16 = *v102;
  v83 = *v102;
  v84 = v12;
  v94 = self;
  do
  {
    v17 = 0;
    v86 = v14;
    do
    {
      if (*v102 != v16)
      {
        objc_enumerationMutation(v12);
      }

      v18 = *(*(&v101 + 1) + 8 * v17);
      if (([v18 intValue] & 0x80000000) != 0 || objc_msgSend(v18, "intValue") >= self->_maxLinkID)
      {
        v19 = 0;
      }

      else
      {
        v19 = candidatePairs[[v18 intValue]];
      }

      v20 = v19;
      v91 = [(__CFString *)v20 candidatePairToken];
      if ([(__CFString *)v20 isSharedQRSession])
      {
        v21 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v108 = v20;
          _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: skipped shared QR session %@", buf, 0xCu);
        }

        if (!v15)
        {
          v15 = objc_alloc_init(MEMORY[0x1E695DF70]);
        }

        if (v18 && v15)
        {
          CFArrayAppendValue(v15, v18);
        }

        goto LABEL_100;
      }

      linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
      if (v18)
      {
        v23 = linkIDToRequestTimeStampAndRTT == 0;
      }

      else
      {
        v23 = 1;
      }

      if (v23)
      {
        v24 = 0;
      }

      else
      {
        v24 = CFDictionaryGetValue(linkIDToRequestTimeStampAndRTT, v18);
      }

      v25 = v24;
      v26 = [v25 objectAtIndexedSubscript:0];
      objc_opt_class();
      isKindOfClass = objc_opt_isKindOfClass();

      v28 = [v25 objectAtIndexedSubscript:0];
      v29 = v28;
      v89 = v15;
      if (isKindOfClass)
      {
        v30 = [v28 unsignedIntValue];
      }

      else
      {
        v31 = [v28 objectAtIndexedSubscript:0];
        v30 = [v31 unsignedIntValue];
      }

      v87 = v20;

      v32 = ((vcvtd_n_f64_u32(v30, 0x10uLL) + HIWORD(v30)) * 1000.0);
      v33 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        v34 = [v25 count];
        v35 = [v25 objectAtIndexedSubscript:0];
        *buf = 138413314;
        v108 = v91;
        v109 = 2112;
        v110 = v18;
        v111 = 1024;
        v112 = v32;
        v113 = 2048;
        v114 = v34;
        v115 = 2112;
        v116 = v35;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: candidatePairToken %@, linkID: %@, baseRequestTimeStampInMS: %u, requestTimeStampAndRTTs count: %lu, requestTimeStampAndRTTs: %@ ...", buf, 0x30u);
      }

      key = v18;
      v88 = v17;

      v96 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v92 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v36 = ids_monotonic_time();
      v37 = ntpTime32(v36);
      v97 = 0u;
      v98 = 0u;
      v99 = 0u;
      v100 = 0u;
      obj = v25;
      v38 = [obj countByEnumeratingWithState:&v97 objects:v106 count:16];
      if (!v38)
      {
        v40 = 0;
        v41 = 0;
        goto LABEL_64;
      }

      v39 = v38;
      v40 = 0;
      v41 = 0;
      v93 = ((vcvtd_n_f64_u32(v37, 0x10uLL) + HIWORD(v37)) * 1000.0);
      v42 = *v98;
      do
      {
        v43 = 0;
        do
        {
          if (*v98 != v42)
          {
            objc_enumerationMutation(obj);
          }

          v44 = *(*(&v97 + 1) + 8 * v43);
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            v45 = [v44 unsignedIntValue];
            v46 = ((vcvtd_n_f64_u32(v45, 0x10uLL) + HIWORD(v45)) * 1000.0);
            if (v93 - v46 < v94->_probingTimeout)
            {
              [v92 addObject:v44];
              goto LABEL_54;
            }

            v49 = v46 - v32;
            if (v46 - v32 >= 0x10000)
            {
              v44 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                LODWORD(v108) = v49;
                _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: ProbingTimeout: differenceInMS: %u is out of scope", buf, 8u);
              }

              LOWORD(v44) = -1;
              LOWORD(v49) = -1;
            }

            else
            {
              LOWORD(v44) = -1;
            }
          }

          else
          {
            v47 = [v44 objectAtIndexedSubscript:0];
            v48 = [v47 unsignedIntValue];

            v49 = ((vcvtd_n_f64_u32(v48, 0x10uLL) + HIWORD(v48)) * 1000.0) - v32;
            if (v49 >= 0x10000)
            {
              v50 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                LODWORD(v108) = v49;
                _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: differenceInMS: %u is out of scope", buf, 8u);
              }

              LOWORD(v49) = -1;
            }

            ++v40;
            v51 = [v44 objectAtIndexedSubscript:1];
            [v51 doubleValue];
            LODWORD(v44) = (v52 * 1000.0);

            if (v44 >= 0x10000)
            {
              LOWORD(v44) = -2;
            }
          }

          ++v41;
          v53 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v49];
          v105[0] = v53;
          v54 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v44];
          v105[1] = v54;
          v55 = [MEMORY[0x1E695DEC8] arrayWithObjects:v105 count:2];
          [v96 addObject:v55];

LABEL_54:
          ++v43;
        }

        while (v39 != v43);
        v56 = [obj countByEnumeratingWithState:&v97 objects:v106 count:16];
        v39 = v56;
      }

      while (v56);
LABEL_64:

      v57 = 0;
      if (key)
      {
        self = v94;
        if (v94->_linkIDToReorderedPackets)
        {
          v57 = CFDictionaryGetValue(v94->_linkIDToReorderedPackets, key);
        }
      }

      else
      {
        self = v94;
      }

      v58 = v57;
      Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v60 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v32];
      if (v60)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-time-stamp-key", v60);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-time-stamp-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v61 = v58;
      if (v61)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-reordered-packets-key", v61);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-number-reordered-packets-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v62 = v96;
      if (v62)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-probing-request-offset-rtt-key", v62);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-probing-request-offset-rtt-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v63 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v41];
      if (v63)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-requests-key", v63);
        v17 = v88;
      }

      else
      {
        v17 = v88;
        if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v108 = @"ids-extchannel-number-requests-key";
          v109 = 2080;
          v110 = "linkStatus";
          _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
        }
      }

      v64 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v40];
      if (v64)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-response-key", v64);
        v65 = key;
        v66 = v92;
      }

      else
      {
        v65 = key;
        v66 = v92;
        if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v108 = @"ids-extchannel-number-response-key";
          v109 = 2080;
          v110 = "linkStatus";
          _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
        }
      }

      [(__CFDictionary *)theDict setObject:Mutable forKeyedSubscript:v65];
      if (v65)
      {
        linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
        if (linkIDToReorderedPackets)
        {
          CFDictionaryRemoveValue(linkIDToReorderedPackets, v65);
        }

        v68 = self->_linkIDToRequestTimeStampAndRTT;
        if (v68)
        {
          CFDictionaryRemoveValue(v68, v65);
        }
      }

      if ([v66 count])
      {
        v69 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v69, OS_LOG_TYPE_DEFAULT))
        {
          v70 = [v66 count];
          *buf = 134217984;
          v108 = v70;
          _os_log_impl(&dword_1A7AD9000, v69, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: remainingTimeStamp count: %lu", buf, 0xCu);
        }

        if (self->_linkIDToRequestTimeStampAndRTT)
        {
          if (v66)
          {
            goto LABEL_98;
          }
        }

        else
        {
          v71 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          v72 = self->_linkIDToRequestTimeStampAndRTT;
          self->_linkIDToRequestTimeStampAndRTT = v71;

          if (v66)
          {
LABEL_98:
            CFDictionarySetValue(self->_linkIDToRequestTimeStampAndRTT, v65, v66);
          }
        }
      }

      v15 = v89;
      v16 = v83;
      v12 = v84;
      v14 = v86;
      v20 = v87;
LABEL_100:

      ++v17;
    }

    while (v17 != v14);
    v73 = [(__CFString *)v12 countByEnumeratingWithState:&v101 objects:v117 count:16];
    v14 = v73;
  }

  while (v73);
LABEL_107:

  if ([(__CFArray *)v15 count])
  {
    v74 = [(__CFString *)v12 mutableCopy];
    [v74 removeObjectsInArray:v15];
    v75 = [MEMORY[0x1E695DEC8] arrayWithArray:v74];

    v12 = v75;
  }

  if (!theDict)
  {
    theDict = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  }

  v76 = v12;
  if (v76)
  {
    CFDictionarySetValue(theDict, v80, v76);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E174C0();
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v78 = objc_opt_respondsToSelector();

  if (v78)
  {
    v79 = objc_loadWeakRetained(&self->_delegate);
    [v79 link:self didGetLinkProbingStatus:theDict];
  }
}

- (void)flushLinkProbingStatus:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [v4 objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v7)
    {
      v8 = [(NSMutableArray *)self->_connectedLinkIDs copy];
      goto LABEL_9;
    }
  }

  else
  {
  }

  Value = 0;
  if (v4 && @"ids-extchannel-probing-link-ids-key")
  {
    Value = CFDictionaryGetValue(v4, @"ids-extchannel-probing-link-ids-key");
  }

  v8 = Value;
LABEL_9:
  v23 = 0u;
  v24 = 0u;
  v21 = 0u;
  v22 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v21 objects:v29 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v22;
    do
    {
      v14 = 0;
      do
      {
        if (*v22 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v21 + 1) + 8 * v14);
        if (v15)
        {
          linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
          if (linkIDToReorderedPackets)
          {
            CFDictionaryRemoveValue(linkIDToReorderedPackets, *(*(&v21 + 1) + 8 * v14));
          }

          linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
          if (linkIDToRequestTimeStampAndRTT)
          {
            CFDictionaryRemoveValue(linkIDToRequestTimeStampAndRTT, v15);
          }

          linkIDToHBCounter = self->_linkIDToHBCounter;
          if (linkIDToHBCounter)
          {
            CFDictionaryRemoveValue(linkIDToHBCounter, v15);
          }
        }

        ++v14;
      }

      while (v12 != v14);
      v12 = [v10 countByEnumeratingWithState:&v21 objects:v29 count:16];
    }

    while (v12);
  }

  v19 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v26 = v10;
    v27 = 2112;
    v28 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "flushLinkProbingStatus: linkIDs: %@, activeProbingLinkIDs: %@", buf, 0x16u);
  }
}

- (void)sendStatsRequestForClient:(id)a3
{
  v20 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 objectForKeyedSubscript:@"linkid-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [v4 objectForKeyedSubscript:@"ids-extchannel-stat-identifier-key"];
    objc_opt_class();
    isKindOfClass = objc_opt_isKindOfClass();

    if (isKindOfClass)
    {
      Value = 0;
      if (v4 && @"linkid-key")
      {
        Value = CFDictionaryGetValue(v4, @"linkid-key");
      }

      v9 = Value;
      v10 = 0;
      if (v4 && @"ids-extchannel-stat-identifier-key")
      {
        v10 = CFDictionaryGetValue(v4, @"ids-extchannel-stat-identifier-key");
      }

      v11 = v10;
      v12 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = 138412546;
        v17 = v9;
        v18 = 2112;
        v19 = v11;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "sendStatsRequestForClient: linkID: %@, statIdentifier: %@", &v16, 0x16u);
      }

      if (([v9 intValue]& 0x80000000) != 0 || [v9 intValue]>= self->_maxLinkID || (v13 = self->_candidatePairs[[v9 intValue]]) == 0)
      {
        p_super = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E175E8();
        }
      }

      else
      {
        p_super = &v13->super;
        if ([(IDSStunCandidatePair *)v13 isRelayStunCandidatePair])
        {
          [p_super setLastStatsReport:ids_monotonic_time()];
          if ([p_super isQUIC])
          {
            [p_super sendQUICStatsRequestWithOptions:v4];
          }

          else
          {
            [p_super sendStatsRequest:0 options:v4];
          }
        }

        else
        {
          v15 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E17578();
          }
        }
      }

      goto LABEL_23;
    }
  }

  else
  {
  }

  v9 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    sub_1A7E1753C();
  }

LABEL_23:
}

- (void)sendStatsRequest:(id)a3
{
  v37 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = ids_monotonic_time();
  if (!self->_linkIDToStatsData)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    linkIDToStatsData = self->_linkIDToStatsData;
    self->_linkIDToStatsData = Mutable;
  }

  v8 = [v4 mutableCopy];
  v9 = self->_linkIDToStatsData;
  self->_linkIDToStatsData = v8;

  v34 = 0u;
  v35 = 0u;
  v32 = 0u;
  v33 = 0u;
  obj = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = [obj countByEnumeratingWithState:&v32 objects:v36 count:16];
  if (v10)
  {
    v11 = v10;
    v31 = *v33;
    v29 = v4;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v33 != v31)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v32 + 1) + 8 * i);
        v14 = [v13 state];
        v15 = [v13 isRelayStunCandidatePair];
        v16 = [v13 isSelfQRSession];
        v17 = [v4 objectForKeyedSubscript:@"report-p2p-session-key"];
        v18 = [v17 BOOLValue];

        if ((v14 - 5) >= 0xFFFFFFFFFFFFFFFELL && (v16 & 1) == 0)
        {
          [v13 lastStatsReport];
          if (v5 - v19 >= [v13 statsIntervalInSeconds])
          {
            v20 = [v13 linkID];
            v21 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-send", v20];
            v22 = [v4 objectForKeyedSubscript:v21];

            v23 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-recv", v20];
            v24 = [v4 objectForKeyedSubscript:v23];

            if (v22 && v24)
            {
              [v22 unsignedIntValue];
              [v24 unsignedIntValue];
              if ((v15 & 1) == 0)
              {
                v4 = v29;
                goto LABEL_21;
              }

LABEL_16:
              if ([v13 isQUIC])
              {
                v25 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                v4 = v29;
                v26 = [v29 objectForKeyedSubscript:@"report-p2p-session-key"];
                [(__CFDictionary *)v25 setObject:v26 forKeyedSubscript:@"report-p2p-session-key"];

                [v13 setLastStatsReport:v5];
                [v13 sendQUICStatsRequestWithOptions:v25];

                v18 = 0;
              }

              else
              {
                [v13 setLastStatsReport:v5];
                [v13 sendStatsRequest:0 options:0];
                v4 = v29;
              }

LABEL_21:
            }

            else
            {
              if ((v18 & v15) == 1)
              {
                goto LABEL_16;
              }

              v4 = v29;
              if (!v18)
              {
                continue;
              }

              v18 = 1;
            }
          }

          if ((v18 & v15) == 1 && [v13 isQUIC])
          {
            v27 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
            v28 = [MEMORY[0x1E696AD98] numberWithBool:1];
            [(__CFDictionary *)v27 setObject:v28 forKeyedSubscript:@"report-p2p-session-key"];

            [v13 setLastStatsReport:v5];
            [v13 sendQUICStatsRequestWithOptions:v27];
          }

          continue;
        }
      }

      v11 = [obj countByEnumeratingWithState:&v32 objects:v36 count:16];
    }

    while (v11);
  }
}

- (void)setReceivedRemoteDeviceVersion:(BOOL)a3
{
  v3 = a3;
  v22 = *MEMORY[0x1E69E9840];
  receivedRemoteDeviceVersion = self->_receivedRemoteDeviceVersion;
  v6 = +[IDSFoundationLog GlobalLink];
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);
  if (receivedRemoteDeviceVersion == v3)
  {
    if (v7)
    {
      v8 = @"NO";
      if (self->_receivedRemoteDeviceVersion)
      {
        v9 = @"YES";
      }

      else
      {
        v9 = @"NO";
      }

      if (v3)
      {
        v8 = @"YES";
      }

      v18 = 138412546;
      v19 = v9;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: _receivedRemoteDeviceVersion: %@ is the same as receivedRemoteDeviceVersion: %@", &v18, 0x16u);
    }

    goto LABEL_22;
  }

  if (v7)
  {
    v10 = @"NO";
    if (v3)
    {
      v10 = @"YES";
    }

    v18 = 138412290;
    v19 = v10;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "setReceivedRemoteDeviceVersion: %@", &v18, 0xCu);
  }

  self->_receivedRemoteDeviceVersion = v3;
  if (v3)
  {
    v11 = +[IDSStunRelayInterfaceInfoController sharedInstance];
    v12 = [v11 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

    if (v12 == 1)
    {
      [(IDSGlobalLink *)self _sendRelayInterfaceInfo:0];
    }

    v13 = +[IDSStunConnectionDataController sharedInstance];
    v14 = [v13 deliveryStatus:self->_cbuuid];

    if (!v14)
    {
      [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
    }

    pendingCommandConnectionDataBlock = self->_pendingCommandConnectionDataBlock;
    if (pendingCommandConnectionDataBlock)
    {
      pendingCommandConnectionDataBlock[2]();
      v16 = self->_pendingCommandConnectionDataBlock;
      self->_pendingCommandConnectionDataBlock = 0;
    }

    pendingCommandRelayInterfaceInfoBlock = self->_pendingCommandRelayInterfaceInfoBlock;
    if (pendingCommandRelayInterfaceInfoBlock)
    {
      pendingCommandRelayInterfaceInfoBlock[2]();
      v6 = self->_pendingCommandRelayInterfaceInfoBlock;
      self->_pendingCommandRelayInterfaceInfoBlock = 0;
LABEL_22:
    }
  }
}

- (void)setRemoteDeviceVersion:(unsigned int)a3
{
  v3 = *&a3;
  v40 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    LODWORD(v38) = v3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: version: %u", buf, 8u);
  }

  self->_remoteDeviceVersion = v3;
  v6 = +[IDSCellularLinkMonitor sharedInstance];
  [v6 setRemoteDeviceVersion:v3];

  [(IDSGlobalLink *)self setReceivedRemoteDeviceVersion:1];
  if (self->_remoteDeviceVersion == 1)
  {
    v34 = 0u;
    v35 = 0u;
    v32 = 0u;
    v33 = 0u;
    v7 = self->_localCandidateList;
    v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v32 objects:v39 count:16];
    if (v8)
    {
      v10 = v8;
      v11 = *v33;
      *&v9 = 138412290;
      v26 = v9;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v33 != v11)
          {
            objc_enumerationMutation(v7);
          }

          v13 = *(*(&v32 + 1) + 8 * i);
          if ([v13 radioAccessTechnology] == 8)
          {
            [v13 setRadioAccessTechnology:5];
            v14 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v26;
              v38 = v13;
              _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: update local %@ local RAT from NR to LTE", buf, 0xCu);
            }
          }
        }

        v10 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v32 objects:v39 count:16];
      }

      while (v10);
    }

    v15 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v28 = 0u;
    v29 = 0u;
    v30 = 0u;
    v31 = 0u;
    v16 = [v15 countByEnumeratingWithState:&v28 objects:v36 count:16];
    if (v16)
    {
      v18 = v16;
      v19 = *v29;
      *&v17 = 138412290;
      v27 = v17;
      do
      {
        for (j = 0; j != v18; ++j)
        {
          if (*v29 != v19)
          {
            objc_enumerationMutation(v15);
          }

          v21 = *(*(&v28 + 1) + 8 * j);
          v22 = [v21 local];
          v23 = [v22 radioAccessTechnology];

          if (v23 == 8)
          {
            v24 = [v21 local];
            [v24 setRadioAccessTechnology:5];

            v25 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v27;
              v38 = v21;
              _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: update candidate pair %@ local RAT from NR to LTE", buf, 0xCu);
            }
          }
        }

        v18 = [v15 countByEnumeratingWithState:&v28 objects:v36 count:16];
      }

      while (v18);
    }
  }
}

- (void)requestPathMTUEvaluationForLinkID:(char)a3
{
  if (self->_nwLink)
  {
    if (a3 < 0 || self->_maxLinkID <= a3 || (v4 = self->_candidatePairs[a3]) == 0)
    {
      v5 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: no candidate pair", buf, 2u);
      }

      v4 = 0;
    }

    if (![(IDSStunCandidatePair *)v4 isRelayStunCandidatePair]&& ![(IDSStunCandidatePair *)v4 isVirtualRelayStunCandidatePair])
    {
      v6 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
      {
        *v13 = 0;
        _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: is not a relay link", v13, 2u);
      }
    }

    nwLink = self->_nwLink;
    v8 = [(IDSStunCandidatePair *)v4 local];
    v9 = [v8 address];
    v10 = [(IDSStunCandidatePair *)v4 remote];
    v11 = [v10 external];
    v12 = [(IDSStunCandidatePair *)v4 sessionID];
    [(IDSNWLink *)nwLink requestPathMTUEvaluationForLocalAddress:v9 remoteAddress:v11 sessionID:v12 type:5];
  }

  else
  {
    v4 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(&v4->super, OS_LOG_TYPE_DEFAULT))
    {
      *v15 = 0;
      _os_log_impl(&dword_1A7AD9000, &v4->super, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: no NWLink.", v15, 2u);
    }
  }
}

- (BOOL)_sendInfoRequest:(id)a3 relaySessionID:(id)a4
{
  v34 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v24 = self;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v8 = v28 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v25 objects:v33 count:16];
  if (!v9)
  {
    goto LABEL_14;
  }

  v10 = v9;
  v11 = *v26;
  while (2)
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v26 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v25 + 1) + 8 * i);
      v14 = [v13 groupID];
      if (![v14 isEqualToString:v6])
      {
        goto LABEL_11;
      }

      v15 = [v13 sessionID];
      if (([v15 isEqualToString:v7] & 1) == 0)
      {

LABEL_11:
        continue;
      }

      v16 = [v13 state];

      if (v16 == 4)
      {
        v20 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          v22 = [v13 linkID];
          *buf = 67109634;
          *v30 = v22;
          *&v30[4] = 2112;
          *&v30[6] = v6;
          *&v30[14] = 2112;
          *&v30[16] = v7;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "send info request using link %d for group %@, session %@.", buf, 0x1Cu);
        }

        if ([v13 isQUIC])
        {
          [v13 sendQUICInfoRequest];
        }

        else
        {
          [v13 sendInfoRequest:0];
        }

        v19 = 1;
        v17 = v8;
        goto LABEL_24;
      }
    }

    v10 = [v8 countByEnumeratingWithState:&v25 objects:v33 count:16];
    if (v10)
    {
      continue;
    }

    break;
  }

LABEL_14:

  if (v24->_state < 2)
  {
    v19 = 0;
  }

  else
  {
    v17 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = _IDSLinkStateStrings[v24->_state];
      *buf = 138413058;
      *v30 = v24;
      *&v30[8] = 2080;
      *&v30[10] = v18;
      *&v30[18] = 2112;
      *&v30[20] = v6;
      v31 = 2112;
      v32 = v7;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "%@ is in [%s] state, skip sending info request for group %@, session %@.", buf, 0x2Au);
    }

    v19 = 0;
LABEL_24:
  }

  return v19;
}

- (BOOL)_getSessionParticipants:(id)a3 relaySessionID:(id)a4 options:(id)a5
{
  v44 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v33 = self;
  v34 = a5;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v37 = 0u;
  v38 = 0u;
  v35 = 0u;
  v10 = v36 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v35 objects:v43 count:16];
  if (!v11)
  {
    goto LABEL_14;
  }

  v12 = *v36;
  while (2)
  {
    for (i = 0; i != v11; ++i)
    {
      if (*v36 != v12)
      {
        objc_enumerationMutation(v10);
      }

      v14 = *(*(&v35 + 1) + 8 * i);
      v15 = [v14 groupID];
      if (![v15 isEqualToString:v8])
      {
        goto LABEL_11;
      }

      v16 = [v14 sessionID];
      if (([v16 isEqualToString:v9] & 1) == 0)
      {

LABEL_11:
        continue;
      }

      v17 = [v14 state] == 4;

      if (v17)
      {
        v21 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          v23 = [v14 linkID];
          *buf = 67109634;
          *v40 = v23;
          *&v40[4] = 2112;
          *&v40[6] = v8;
          *&v40[14] = 2112;
          *&v40[16] = v9;
          _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "request participants session-info using link %d for group %@, session %@.", buf, 0x1Cu);
        }

        v24 = objc_alloc_init(MEMORY[0x1E695DF90]);
        CFDictionarySetValue(v24, @"gl-option-sessioninfo-request-type", &unk_1F1B20060);
        v25 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v14, "nextSessionInfoReqID")}];
        if (v25)
        {
          CFDictionarySetValue(v24, @"gl-option-sessioninfo-request-id", v25);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17658();
        }

        v26 = [v34 objectForKey:@"gl-option-sessioninfo-command-flag"];
        v27 = [v26 unsignedIntValue];

        if (v27)
        {
          v28 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v27];
          if (v28)
          {
            CFDictionarySetValue(v24, @"gl-option-sessioninfo-command-flag", v28);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E176E0();
          }
        }

        if ([v14 isQUIC])
        {
          [v14 sendQUICSessionInfoRequestWithOptions:v24];
        }

        else
        {
          [v14 sendSessionInfoRequest:0 options:v24];
        }

        goto LABEL_43;
      }
    }

    v11 = [v10 countByEnumeratingWithState:&v35 objects:v43 count:16];
    if (v11)
    {
      continue;
    }

    break;
  }

LABEL_14:

  if (v34)
  {
    if (v33->_state >= 2)
    {
      v18 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v19 = _IDSLinkStateStrings[v33->_state];
        *buf = 138413058;
        *v40 = v33;
        *&v40[8] = 2080;
        *&v40[10] = v19;
        *&v40[18] = 2112;
        *&v40[20] = v8;
        v41 = 2112;
        v42 = v9;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "%@ is in [%s] state, skip sending session-info request for group %@, session %@.", buf, 0x2Au);
      }

      goto LABEL_19;
    }

    v29 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      *v40 = v8;
      *&v40[8] = 2112;
      *&v40[10] = v9;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "trying cached response for group %@, session %@.", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v31 = v8;
        v32 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"trying cached response for group %@, session %@.");
        if (_IDSShouldLog())
        {
          v31 = v8;
          v32 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"trying cached response for group %@, session %@.");
        }
      }
    }

    [(IDSGlobalLink *)v33 connectWithSessionInfo:v34 interfaceAddress:0 joinSession:0 completionHandler:0 withLocalInterfacePreference:0, v31, v32];
LABEL_43:
    v20 = 1;
  }

  else
  {
LABEL_19:
    v20 = 0;
  }

  return v20;
}

- (BOOL)_getSessionStreamInfo:(id)a3 relaySessionID:(id)a4 options:(id)a5
{
  v68 = *MEMORY[0x1E69E9840];
  v57 = a3;
  v56 = a4;
  v8 = a5;
  Value = 0;
  if (v8 && @"gl-option-linkid")
  {
    Value = CFDictionaryGetValue(v8, @"gl-option-linkid");
  }

  v10 = [Value intValue];
  v11 = 0;
  if (v8 && @"gl-option-sessioninfo-link-id-to-query")
  {
    v11 = CFDictionaryGetValue(v8, @"gl-option-sessioninfo-link-id-to-query");
  }

  v12 = [v11 intValue];
  v13 = v12;
  v14 = v12;
  if ((v12 & 0x80) != 0 || v14 >= self->_maxLinkID)
  {
    v15 = 0;
  }

  else
  {
    v15 = self->_candidatePairs[v12];
  }

  v54 = [(IDSStunCandidatePair *)v15 relayLinkID];
  v16 = 0;
  if (v8 && @"stream-info-generation-counter")
  {
    v16 = CFDictionaryGetValue(v8, @"stream-info-generation-counter");
  }

  v55 = [v16 unsignedIntValue];
  if (v13 << 24)
  {
    if ((v14 & 0x80000000) == 0 && v14 < self->_maxLinkID)
    {
      v17 = v13;
LABEL_21:
      v18 = self->_candidatePairs[v17];
      goto LABEL_23;
    }
  }

  else if ((v10 & 0x80) == 0 && v10 < self->_maxLinkID)
  {
    v17 = v10;
    goto LABEL_21;
  }

  v18 = 0;
LABEL_23:
  v19 = [(IDSStunCandidatePair *)v18 nextSessionInfoReqID];
  v20 = +[IDSFoundationLog GlobalLink];
  v53 = v19;
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67110658;
    *v59 = v55;
    *&v59[4] = 1024;
    *&v59[6] = v10;
    LOWORD(v60) = 1024;
    *(&v60 + 2) = v14;
    HIWORD(v60) = 1024;
    v61 = v54;
    v62 = 1024;
    v63 = v19;
    v64 = 2112;
    v65 = v57;
    v66 = 2112;
    v67 = v56;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "request session info (gc:%u, linkID:%1d, linkIDToQuery:%1d, relayLinkID:%04x, reqID:%08x) for group %@, session %@.", buf, 0x34u);
  }

  if (v10 < 0 || v10 >= self->_maxLinkID)
  {
    v21 = 0;
  }

  else
  {
    v21 = self->_candidatePairs[v10];
  }

  v22 = v21;
  if ((v14 & 0x80000000) != 0 || v14 >= self->_maxLinkID)
  {
    v23 = 0;
  }

  else
  {
    v23 = self->_candidatePairs[v13];
  }

  v24 = v23;
  if (![(IDSStunCandidatePair *)v22 isSharedQRSession]|| ![(IDSStunCandidatePair *)v24 isSharedQRSession])
  {
    v30 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      *v59 = v22;
      *&v59[8] = 2112;
      v60 = v24;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "try to query with invalid candidate pairs: %@, %@ return", buf, 0x16u);
    }

    goto LABEL_43;
  }

  v25 = [(IDSStunCandidatePair *)v22 remote];
  if (![v25 external])
  {
    goto LABEL_48;
  }

  v26 = [(IDSStunCandidatePair *)v24 remote];
  if (![v26 external])
  {
LABEL_47:

LABEL_48:
    goto LABEL_49;
  }

  v52 = [(IDSStunCandidatePair *)v22 remote];
  v27 = *([v52 external] + 1);
  v28 = [(IDSStunCandidatePair *)v24 remote];
  if (v27 != *([v28 external] + 1))
  {

    goto LABEL_47;
  }

  v51 = [(IDSStunCandidatePair *)v22 remote];
  v50 = [v51 external];
  v29 = [(IDSStunCandidatePair *)v24 remote];
  LOBYTE(v50) = IsSameSA(v50, [v29 external]);

  if ((v50 & 1) == 0)
  {
    v30 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      v31 = [(IDSStunCandidatePair *)v22 remote];
      v32 = [(IDSStunCandidatePair *)v24 remote];
      *buf = 138412546;
      *v59 = v31;
      *&v59[8] = 2112;
      v60 = v32;
      v33 = "linkID's server: %@ is different from linkIDToQuery's server: %@, return";
LABEL_55:
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, v33, buf, 0x16u);

      goto LABEL_43;
    }

    goto LABEL_43;
  }

LABEL_49:
  v36 = [(IDSStunCandidatePair *)v22 sessionID];
  v37 = [(IDSStunCandidatePair *)v24 sessionID];
  v38 = [v36 isEqualToString:v37];

  if (v38)
  {
    if (!v22)
    {
      v34 = 0;
      goto LABEL_45;
    }

    v30 = objc_alloc_init(MEMORY[0x1E695DF90]);
    CFDictionarySetValue(v30, @"gl-option-sessioninfo-request-type", &unk_1F1B20078);
    v39 = [MEMORY[0x1E696AD98] numberWithChar:v14];
    if (v39)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-link-id-to-query", v39);
      v40 = v53;
    }

    else
    {
      v40 = v53;
      if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E176E0();
      }
    }

    v41 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v54];
    if (v41)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-relay-link-id", v41);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1775C();
    }

    v42 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v40];
    if (v42)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-request-id", v42);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17658();
    }

    v43 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v55];
    if (v43)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-generation-counter", v43);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E177E4();
    }

    if (v8 && @"stream-info-published-streams" && (v44 = CFDictionaryGetValue(v8, @"stream-info-published-streams")) != 0)
    {
      v45 = v44;
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-published-streams", v44);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1786C();
      if (!v8)
      {
        goto LABEL_81;
      }
    }

    else if (!v8)
    {
      goto LABEL_81;
    }

    if (@"stream-info-subscribed-streams")
    {
      v46 = CFDictionaryGetValue(v8, @"stream-info-subscribed-streams");
      if (v46)
      {
        v47 = v46;
        CFDictionarySetValue(v30, @"gl-option-sessioninfo-subscribed-streams", v46);

LABEL_83:
        if (@"stream-info-max-concurrent-streams")
        {
          v48 = CFDictionaryGetValue(v8, @"stream-info-max-concurrent-streams");
          if (v48)
          {
            v49 = v48;
            CFDictionarySetValue(v30, @"gl-option-sessioninfo-max-concurrent-streams", v48);
          }
        }

        goto LABEL_86;
      }
    }

LABEL_81:
    if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E178F4();
      if (v8)
      {
        goto LABEL_83;
      }
    }

    else if (v8)
    {
      goto LABEL_83;
    }

LABEL_86:
    if ([(IDSStunCandidatePair *)v22 isQUIC])
    {
      [(IDSStunCandidatePair *)v22 sendQUICSessionInfoRequestWithOptions:v30];
    }

    else
    {
      [(IDSStunCandidatePair *)v22 sendSessionInfoRequest:0 options:v30];
    }

    v34 = 1;
    goto LABEL_44;
  }

  v30 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
  {
    v31 = [(IDSStunCandidatePair *)v22 sessionID];
    v32 = [(IDSStunCandidatePair *)v24 sessionID];
    *buf = 138412546;
    *v59 = v31;
    *&v59[8] = 2112;
    v60 = v32;
    v33 = "linkID's session %@, linkIDToQuery's session: %@ are different, return";
    goto LABEL_55;
  }

LABEL_43:
  v34 = 0;
LABEL_44:

LABEL_45:
  return v34;
}

- (void)getSessionInfo:(id)a3 relaySessionID:(id)a4 requestType:(int64_t)a5 options:(id)a6
{
  v23 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  v12 = a6;
  v13 = v12;
  if (a5 == 2)
  {
    if ([(IDSGlobalLink *)self _getSessionStreamInfo:v10 relaySessionID:v11 options:v12])
    {
      goto LABEL_12;
    }
  }

  else if (a5 == 1)
  {
    v14 = [v12 objectForKey:@"gl-option-info-request-type"];
    v15 = [v14 unsignedIntegerValue];

    if (v15 == 1)
    {
      if ([(IDSGlobalLink *)self _sendInfoRequest:v10 relaySessionID:v11])
      {
        goto LABEL_12;
      }
    }

    else if ([(IDSGlobalLink *)self _getSessionParticipants:v10 relaySessionID:v11 options:v13])
    {
      goto LABEL_12;
    }
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = 138412802;
    v18 = v10;
    v19 = 2112;
    v20 = v11;
    v21 = 1024;
    v22 = a5;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "get session info failed for group %@, session %@, request-type %d.", &v17, 0x1Cu);
  }

  [(IDSGlobalLink *)self _notifySessionInfoReceived:0 relayGroupID:v10 relaySessionID:v11 status:5];
LABEL_12:
}

- (void)updateSessionParticipants:(id)a3 relaySessionID:(id)a4 participants:(id)a5
{
  v32 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v22 = a5;
  v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
  if (v11)
  {
    v13 = v11;
    v14 = *v24;
    *&v12 = 138412546;
    v21 = v12;
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v24 != v14)
        {
          objc_enumerationMutation(v10);
        }

        v16 = *(*(&v23 + 1) + 8 * i);
        v17 = [v16 sessionID];
        if ([v17 isEqualToString:v9])
        {
          v18 = [v16 groupID];
          v19 = [v18 isEqualToString:v8];

          if (v19)
          {
            v20 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v21;
              v28 = v8;
              v29 = 2112;
              v30 = v9;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "updateSessionParticipants for group %@, session %@.", buf, 0x16u);
            }

            [v16 updateParticipantIDMap:v22];
          }
        }

        else
        {
        }
      }

      v13 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
    }

    while (v13);
  }
}

- (void)registerPluginWithOptions:(id)a3 relayGroupID:(id)a4
{
  v24 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  linkIDForPlugin = self->_linkIDForPlugin;
  if (linkIDForPlugin < 0 || self->_maxLinkID <= linkIDForPlugin)
  {
    v9 = 0;
  }

  else
  {
    v9 = self->_candidatePairs[self->_linkIDForPlugin];
  }

  v10 = v9;
  Value = 0;
  if (v6 && @"gl-option-plugin-name")
  {
    Value = CFDictionaryGetValue(v6, @"gl-option-plugin-name");
  }

  [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict setObject:v6 forKey:Value];
  v12 = [(IDSStunCandidatePair *)v10 groupID];
  if ([v12 isEqualToString:v7] && -[IDSStunCandidatePair state](v10, "state") == 4)
  {
    v13 = [(IDSStunCandidatePair *)v10 isSharedQRSession];

    if (v13)
    {
      v14 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v18 = 138412546;
        v19 = v7;
        v20 = 2112;
        v21 = v6;
        _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "Register plugin for group %@ and options %@", &v18, 0x16u);
      }

      if ([(IDSStunCandidatePair *)v10 isQUIC])
      {
        [(IDSStunCandidatePair *)v10 sendQUICPluginRegistrationRequestWithOptions:v6];
      }

      else
      {
        [(IDSStunCandidatePair *)v10 sendQRPluginRegistrationRequest:0 options:v6];
      }

      goto LABEL_19;
    }
  }

  else
  {
  }

  v15 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [(__CFDictionary *)v6 objectForKeyedSubscript:@"gl-option-plugin-name"];
    v17 = self->_linkIDForPlugin;
    v18 = 138412802;
    v19 = v16;
    v20 = 2112;
    v21 = v7;
    v22 = 1024;
    v23 = v17;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "FAILED: Register plugin %@ for group %@. linkID %d is not for a valid link", &v18, 0x1Cu);
  }

LABEL_19:
}

- (void)setForceTCPFallbackOnWiFi:(BOOL)a3
{
  v3 = a3;
  v9 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (v3)
    {
      v6 = @"YES";
    }

    v7 = 138412290;
    v8 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Setting ForceTCPFallbackOnWiFi %@", &v7, 0xCu);
  }

  self->_forceTCPFallbackOnWiFi = v3;
}

- (void)setForceTCPFallbackOnCell:(BOOL)a3
{
  v3 = a3;
  v9 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (v3)
    {
      v6 = @"YES";
    }

    v7 = 138412290;
    v8 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Setting ForceTCPFallbackOnCell %@", &v7, 0xCu);
  }

  self->_forceTCPFallbackOnCell = v3;
}

- (unint64_t)createAliasForParticipantID:(unint64_t)a3 salt:(id)a4 relayGroupID:(id)a5
{
  v31 = *MEMORY[0x1E69E9840];
  v8 = a4;
  v9 = a5;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v10 = v25 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v22 objects:v30 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v23;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v23 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v22 + 1) + 8 * i);
        v16 = [v15 groupID];
        if ([v16 isEqualToString:v9] && objc_msgSend(v15, "state") == 4)
        {
          v17 = [v15 isSharedQRSession];

          if (v17)
          {
            v18 = [v15 createAliasForParticipantID:a3 salt:v8];
            if (v18)
            {
              v19 = v18;
              v20 = v10;
              goto LABEL_17;
            }
          }
        }

        else
        {
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v22 objects:v30 count:16];
    }

    while (v12);
  }

  v20 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    v27 = a3;
    v28 = 2112;
    v29 = v8;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "createAliasForParticipantID could not find participantID %llu salt %@", buf, 0x16u);
  }

  v19 = 0;
LABEL_17:

  return v19;
}

- (unint64_t)participantIDForAlias:(unint64_t)a3 salt:(id)a4 relayGroupID:(id)a5
{
  v26 = a3;
  v39 = *MEMORY[0x1E69E9840];
  v27 = a4;
  v7 = a5;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v8 = v31 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v28 objects:v38 count:16];
  if (!v9)
  {
    goto LABEL_20;
  }

  v10 = v9;
  v11 = *v29;
  do
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v29 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v28 + 1) + 8 * i);
      v14 = [v13 groupID];
      if (![v14 isEqualToString:v7] || objc_msgSend(v13, "state") != 4)
      {

LABEL_12:
        v17 = [v13 groupID];
        v18 = [v17 isEqualToString:v7];

        if (v18)
        {
          v19 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = [v13 state];
            v21 = [v13 isSharedQRSession];
            *buf = 134218242;
            v22 = @"NO";
            if (v21)
            {
              v22 = @"YES";
            }

            v33 = v20;
            v34 = 2112;
            v35 = v22;
            _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "participantIDForAlias: found candidate pair with state: %lu, isSharedSession: %@", buf, 0x16u);
          }
        }

        continue;
      }

      v15 = [v13 isSharedQRSession];

      if (!v15)
      {
        goto LABEL_12;
      }

      v16 = [v13 participantIDForAlias:v26 salt:v27];
      if (v16)
      {
        v23 = v16;
        v24 = v8;
        goto LABEL_23;
      }
    }

    v10 = [v8 countByEnumeratingWithState:&v28 objects:v38 count:16];
  }

  while (v10);
LABEL_20:

  v24 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v33 = v26;
    v34 = 2112;
    v35 = v27;
    v36 = 2112;
    v37 = v7;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "participantIDForAlias could not find candidate pair that matches the alias %llu salt %@, for %@", buf, 0x20u);
  }

  v23 = 0;
LABEL_23:

  return v23;
}

- (void)linksQualityDeltaSince:(id)a3 completionHandler:(id)a4
{
  v6 = a4;
  qualityMeasurer = self->_qualityMeasurer;
  v9[0] = MEMORY[0x1E69E9820];
  v9[1] = 3221225472;
  v9[2] = sub_1A7BBB638;
  v9[3] = &unk_1E77E1298;
  v10 = v6;
  v8 = v6;
  [(IDSLinksQualityMeasurer *)qualityMeasurer deltaSince:a3 completionHandler:v9];
}

- (void)importQualityMeasurementDelta:(id)a3 sourceName:(id)a4 completionHandler:(id)a5
{
  v8 = a5;
  qualityMeasurer = self->_qualityMeasurer;
  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = sub_1A7BBB6F8;
  v11[3] = &unk_1E77E0B48;
  v12 = v8;
  v10 = v8;
  [(IDSLinksQualityMeasurer *)qualityMeasurer importDelta:a3 sourceName:a4 completionHandler:v11];
}

- (void)importLinkEngineQualityMeasurementDelta:(id)a3 sourceName:(id)a4 completionHandler:(id)a5
{
  v29 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v21 = a5;
  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "importLinkEngineQualityMeasurementDelta: collecting LinkEngines...", buf, 2u);
  }

  v11 = [(IDSGlobalLink *)self allLinkEngines];
  v12 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = [v11 count];
    *buf = 134217984;
    v28 = v13;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "importLinkEngineQualityMeasurementDelta: collected %lu LinkEngines...", buf, 0xCu);
  }

  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v23 = 0u;
  v14 = v11;
  v15 = [v14 countByEnumeratingWithState:&v22 objects:v26 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v23;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v23 != v17)
        {
          objc_enumerationMutation(v14);
        }

        v19 = *(*(&v22 + 1) + 8 * i);
        v20 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v28 = v19;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "... importing into %@", buf, 0xCu);
        }

        [v19 importQualityDelta:v8 source:v9];
      }

      v16 = [v14 countByEnumeratingWithState:&v22 objects:v26 count:16];
    }

    while (v16);
  }

  v21[2](v21);
}

- (BOOL)link:(id)a3 didReceivePacket:(id *)a4 fromDeviceUniqueID:(id)a5 cbuuid:(id)a6
{
  v147 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a5;
  v12 = a6;
  if (a4)
  {
    var2 = a4->var2;
    if (!var2 && a4->var35 == 200)
    {
      LOBYTE(a4) = 0;
      goto LABEL_199;
    }

    v14 = vdupq_n_s64(1uLL);
    v14.i64[0] = a4->var2;
    *&self->_totalBytesReceived = vaddq_s64(*&self->_totalBytesReceived, v14);
    v15 = ids_monotonic_time();
    if (a4->var13)
    {
      LOBYTE(a4) = -[IDSGlobalLink _processProtoPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:](self, "_processProtoPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:", a4, v11, v12, [v10 headerOverhead], v15);
      goto LABEL_199;
    }

    var36 = a4->var36;
    if (a4->var2 > 3 || a4->var36)
    {
      if (a4->var36)
      {
        if (IDSSimpleUInt16List_HasItem(&self->_channelNumberList, a4->var36))
        {
          v121 = (var36 & 0xF0) == 96;
          v17 = StunUtilProcessIncomingChannelDataWithoutChannelHeader(a4, (var36 & 0xF0) == 96, LOWORD(a4->var2));
LABEL_14:
          v18 = v17;
          key = channelForStunCandidatePair(&a4->var18, &a4->var19, var36);
          channelToCandidatePairs = self->_channelToCandidatePairs;
          if (channelToCandidatePairs && key)
          {
            v20 = CFDictionaryGetValue(channelToCandidatePairs, key);
            p_var14 = &a4->var24[0].var14;
            if (a4->var24[0].var14 >= 1 && v20)
            {
              v111 = v20;
              v22 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v20 relayLinkID], a4->var24[0].var15[0]);
              localRemoteRelayLinkIDToVirtualCandidatePairs = self->_localRemoteRelayLinkIDToVirtualCandidatePairs;
              if (localRemoteRelayLinkIDToVirtualCandidatePairs && v22 && (v24 = CFDictionaryGetValue(localRemoteRelayLinkIDToVirtualCandidatePairs, v22)) != 0)
              {
                __src = v24;
                v25 = [v24 linkID];
                if (v25 < 1)
                {
                  v26 = 0;
                }

                else
                {
                  v26 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v25);
                }

                if (v26)
                {
                  ++*(v26 + 83);
                  v26[43] += var2;
                }
              }

              else
              {

                __src = 0;
              }

              p_var14 = &a4->var24[0].var14;
              v29 = v111;
              if ((v18 & 1) == 0)
              {
                goto LABEL_207;
              }

LABEL_35:
              if (a4->var23 >= 1)
              {
                if (a4->var24[0].var19)
                {
                  if (*p_var14 < 1)
                  {
                    v30 = 0;
                  }

                  else
                  {
                    v30 = a4->var24[0].var15[0];
                  }

                  v73 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v73, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 67109120;
                    *&buf[4] = v30;
                    _os_log_impl(&dword_1A7AD9000, v73, OS_LOG_TYPE_DEFAULT, "received command message with remote relay linkID %u", buf, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v110 = v30;
                      _IDSLogTransport(@"GL", @"IDS", @"received command message with remote relay linkID %u");
                      if (_IDSShouldLog())
                      {
                        v110 = v30;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"received command message with remote relay linkID %u");
                      }
                    }
                  }

                  LOBYTE(a4) = [(IDSGlobalLink *)self _processChannelDataCommandMessage:a4 remoteRelayLinkID:v30 channelNumber:var36 fromDeviceUniqueID:v11 cbuuid:v12 arrivalTime:v15, v110];
                  goto LABEL_214;
                }

                if ((a4->var24[0].var20 & 0x80000) != 0)
                {
                  v62 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 0;
                    _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "received echo packet", buf, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"received echo packet");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"received echo packet");
                      }
                    }
                  }

                  v63 = [MEMORY[0x1E695DEF0] dataWithBytes:a4->var0 length:a4->var2];
                  [v29 receiveLinkTestStatsPacket:v63];
                  if (self->_useLinkSelection)
                  {
                    v64 = [v29 linkEngine];
                    v65 = v64 == 0;

                    if (!v65)
                    {
                      v66 = [v29 linkEngine];
                      v67 = [v29 linkUniqueName];
                      [v66 didReceiveStatsTestPacketWithPayload:v63 linkName:v67 completionHandler:&unk_1F1AAA480];
                    }
                  }

                  goto LABEL_213;
                }
              }

              v53 = [__src linkEngine];

              if (v53)
              {
                v54 = __src;
                v55 = v29;
                if (([__src hasReceivedData] & 1) == 0)
                {
                  [(IDSGlobalLink *)self didReceiveFirstDataOnCandidatePair:__src];
                }
              }

              else
              {
                v55 = v29;
                v54 = __src;
                if (IDSSimpleUInt16List_HasItem(&self->_reallocChannelList, var36))
                {
                  [(IDSGlobalLink *)self _processReallocChannelData:a4 channelNumber:var36 fromDeviceUniqueID:v11 cbuuid:v12 arrivalTime:v15];
                }
              }

              if ([v54 useQualityMetadata])
              {
                v56 = [v54 qualityHandler];
                v57 = [v56 readQualityBytesFromPacketReturingDeduplicationID:a4->var0 packetEnd:&a4->var0[a4->var2]];

                if ((v57 & 0x80) == 0)
                {
                  a4->var41 = v57 & 0x7F;
                  a4->var40 = 1;
                  packetDeduplicator = self->_packetDeduplicator;
                  if (packetDeduplicator)
                  {
                    if (![(IDSPacketDeduplicator *)packetDeduplicator markPacketAsReceivedWithSequenceNumber:?])
                    {
LABEL_213:
                      LOBYTE(a4) = 1;
LABEL_214:

                      goto LABEL_199;
                    }
                  }
                }

                StunUtilSkipQualityMetadata(a4);
                v55 = v29;
                v54 = __src;
              }

              goto LABEL_44;
            }
          }

          else
          {
            v20 = 0;
            p_var14 = &a4->var24[0].var14;
          }

          v29 = v20;
          __src = v29;
          if ((v18 & 1) == 0)
          {
LABEL_207:
            v108 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v108, OS_LOG_TYPE_DEFAULT))
            {
              v109 = a4->var2;
              *buf = 134217984;
              *&buf[4] = v109;
              _os_log_impl(&dword_1A7AD9000, v108, OS_LOG_TYPE_DEFAULT, "drop channel data (%zdB).", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"drop channel data (%zdB).");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"drop channel data (%zdB).");
                }
              }
            }

            goto LABEL_213;
          }

          goto LABEL_35;
        }
      }

      else
      {
        var36 = *a4->var0;
        if (IDSSimpleUInt16List_HasItem(&self->_channelNumberList, *a4->var0))
        {
          v121 = (var36 & 0xF0) == 96;
          v17 = StunUtilProcessIncomingChannelData(a4, (var36 & 0xF0) == 96);
          goto LABEL_14;
        }
      }

      if ((var36 & 0xC0) != 0)
      {
        if (self->_shouldProcessBasebandNotification && a4->var2 >= 4 && *a4->var0 == -272716322)
        {
          LODWORD(var36) = self->_basebandPacketChannelNumber;
          v27 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEBUG, "receive baseband notification packet.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
          {
            _IDSLogV(1, @"IDSFoundation", @"GL", @"receive baseband notification packet.");
          }

          v121 = 0;
          v28 = 1;
          goto LABEL_45;
        }
      }

      else if (a4->var2 >= 20 && *(a4->var0 + 1) == 1118048801)
      {
        -[IDSGlobalLink _processStunPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:](self, "_processStunPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:", a4, v11, v12, [v10 headerOverhead], v15);
        LODWORD(var36) = 0;
        v121 = 0;
        v28 = 0;
        v31 = 0;
        goto LABEL_46;
      }

      LODWORD(var36) = 0;
    }

    v121 = 0;
LABEL_44:
    v28 = 0;
LABEL_45:
    v31 = 1;
LABEL_46:
    v32 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
    v33 = v32;
    if (v32)
    {
      v34 = IsSameSA((v32 + 1), &a4->var18);
      if (v34)
      {
        v34 = IsSameSA((v33 + 17), &a4->var19);
      }

      if (!v31)
      {
        goto LABEL_198;
      }
    }

    else
    {
      v34 = 0;
      if (!v31)
      {
LABEL_198:
        LOBYTE(a4) = 1;
        goto LABEL_199;
      }
    }

    var14 = a4->var24[0].var14;
    if (v34 && *(v33 + 132) == var36 && var14 <= 0)
    {
      if (v33)
      {
        v36 = v28;
      }

      else
      {
        v36 = 1;
      }

      if ((v36 & 1) == 0)
      {
        v33[39] = v15;
      }

      if (self->_supportChannelData)
      {
        v37 = *v33;
        a4->var25 = *v33;
        if (v121)
        {
          if ((v37 & 0x80) != 0 || v37 >= self->_maxLinkID)
          {
            v38 = 0;
          }

          else
          {
            v38 = self->_candidatePairs[v37];
          }

          keya = v38;
          v68 = [(IDSStunCandidatePair *)keya capabilityFlags];
          var23 = a4->var23;
          if (var23 >= 1)
          {
            v70 = v68;
            v71 = 0;
            v72 = 536;
            do
            {
              if (v70 & 8) != 0 && (*(&a4->var0 + v72))
              {
                StunUtilGetMappedParticipantID(a4, v71, keya, 1);
                var23 = a4->var23;
              }

              ++v71;
              v72 += 96;
            }

            while (v71 < var23);
          }

          __srcb = -1;
LABEL_153:

          v39 = __srcb;
          if ((v28 & 1) == 0)
          {
            goto LABEL_154;
          }

          goto LABEL_195;
        }
      }

LABEL_66:
      v39 = -1;
      if ((v28 & 1) == 0)
      {
LABEL_154:
        var25 = a4->var25;
        __srcc = v39;
        if (var25 < 1)
        {
          v83 = 0;
        }

        else
        {
          v83 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, var25);
          v39 = __srcc;
        }

        keyb = v39;
        if (v39 < 1)
        {
          v84 = 0;
        }

        else
        {
          v84 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v39);
        }

        if (v84)
        {
          v85 = v84;
        }

        else
        {
          v85 = v83;
        }

        if (v85)
        {
          if ((v85[88] & 1) == 0)
          {
            *(v85 + 352) = 1;
            v86 = *v85;
            if ((v86 & 0x80000000) == 0 && v86 < self->_maxLinkID)
            {
              v87 = self->_candidatePairs[v86];
              if (v87)
              {
                v88 = v87;
                v89 = [(IDSStunCandidatePair *)v87 linkMetrics];
                [v89 event:@"glr"];
              }
            }
          }
        }

        kdebug_trace();
        if (self->_firstDataReceivedTime == 0.0 && a4->var2 >= 1)
        {
          self->_reportDataReceivedTime = 1;
          self->_firstDataReceivedTime = v15;
          v90 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v90, OS_LOG_TYPE_DEFAULT))
          {
            if (self->_reportClientPacketTime)
            {
              v91 = @"YES";
            }

            else
            {
              v91 = @"NO";
            }

            *buf = 138412290;
            *&buf[4] = v91;
            _os_log_impl(&dword_1A7AD9000, v90, OS_LOG_TYPE_DEFAULT, "didReceivePacket: _firstDataReceivedTime, _reportClientPacketTime: %@", buf, 0xCu);
          }

          if (self->_reportClientPacketTime)
          {
            [(IDSGlobalLink *)self _reportSessionSetupTime];
            self->_reportDataReceivedTime = 0;
          }
        }

        if (v121)
        {
          v92 = a4->var25;
          if (v92 < 0 || self->_maxLinkID <= v92)
          {
            v93 = 0;
          }

          else
          {
            v93 = self->_candidatePairs[a4->var25];
          }

          v94 = v93;
          if ((a4->var24[0].var20 & 0x400) != 0)
          {
            var0 = a4->var0;
            v96 = a4->var2;
            v122 = v94;
            v97 = [(IDSStunCandidatePair *)v94 hbhDecKey];
            v98 = IDSHBHDecryptDataWithKey(var0, v96, v97);

            if (!v98)
            {
              v107 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v107, OS_LOG_TYPE_ERROR))
              {
                sub_1A7E1797C();
              }

              goto LABEL_198;
            }

            a4->var2 = [v98 length];
            v99 = a4->var0;
            v100 = v98;
            memcpy(v99, [v98 bytes], a4->var2);

            v94 = v122;
          }
        }

        [(IDSGlobalLink *)self reportLinkMetricsForLinkID:a4->var25 lastPacketReceivedTime:ids_monotonic_time() lastPacketSentTime:0.0];
        packetLog = self->_packetLog;
        v102 = v85 == 0;
        if (!packetLog)
        {
          v102 = 1;
        }

        v39 = __srcc;
        if (!v102)
        {
          v103 = keyb < 1 ? 0 : a4->var25;
          v104 = sub_1A7BAF110(a4, *v85, v103, packetLog, v85);
          v39 = __srcc;
          if (v104)
          {
            [(IDSObjCPacketLog *)self->_packetLog recordPacketsWithPacketLogID:v104 kind:1 bytes:var2 packetCount:1];
            v39 = __srcc;
          }
        }
      }

LABEL_195:
      if (v39 != -1)
      {
        a4->var25 = v39;
      }

      a4->var6 = 1;
      a4->var28 = v15;
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      [WeakRetained link:self didReceivePacket:a4 fromDeviceUniqueID:v11 cbuuid:v12];

      goto LABEL_198;
    }

    if (a4->var15)
    {
      goto LABEL_66;
    }

    keya = channelForStunCandidatePair(&a4->var18, &a4->var19, var36);
    v40 = self->_channelToCandidatePairs;
    if (v40)
    {
      if (keya)
      {
        v41 = CFDictionaryGetValue(v40, keya);
        if (v41)
        {
          if ((v28 & 1) == 0)
          {
            v42 = v41;
            [v41 setLastIncomingPacketTime:v15];
            v41 = v42;
          }

          goto LABEL_73;
        }
      }
    }

    if (v28)
    {
      basebandPacketLinkID = self->_basebandPacketLinkID;
      if (self->_basebandPacketLinkID)
      {
        if (basebandPacketLinkID < 0 || self->_maxLinkID <= basebandPacketLinkID)
        {
          v50 = 0;
        }

        else
        {
          v49 = self->_candidatePairs[self->_basebandPacketLinkID];
          v50 = v49;
          if (v49)
          {
            __srca = [(IDSStunCandidatePair *)v49 remote];
            if (IsSameSA([__srca external], &a4->var19))
            {
              v51 = [(IDSStunCandidatePair *)v50 channelNumber]== var36;

              if (v51)
              {
                v52 = [(IDSStunCandidatePair *)v50 local];
                __srcd = [v52 address];

                memcpy(&a4->var18, __srcd, *__srcd);
                a4->var25 = self->_basebandPacketLinkID;

                v41 = 0;
LABEL_73:
                if (!self->_supportChannelData)
                {
                  __srcb = -1;
LABEL_152:

                  goto LABEL_153;
                }

                v112 = v41;
                a4->var25 = [v41 linkID];
                if (var14 < 1)
                {
                  v47 = -1;
LABEL_144:
                  v41 = v112;
                  __srcb = v47;
                  if (v121)
                  {
                    v77 = [v112 capabilityFlags];
                    v78 = a4->var23;
                    if (v78 >= 1)
                    {
                      v79 = v77;
                      v80 = 0;
                      v81 = 536;
                      do
                      {
                        if (v79 & 8) != 0 && (*(&a4->var0 + v81))
                        {
                          StunUtilGetMappedParticipantID(a4, v80, v112, 1);
                          v78 = a4->var23;
                        }

                        ++v80;
                        v81 += 96;
                      }

                      while (v80 < v78);
                    }

                    v41 = v112;
                  }

                  goto LABEL_152;
                }

                v43 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v112 relayLinkID], a4->var24[0].var15[0]);
                v44 = self->_localRemoteRelayLinkIDToVirtualCandidatePairs;
                if (v44)
                {
                  if (v43)
                  {
                    v45 = CFDictionaryGetValue(v44, v43);
                    if (v45)
                    {
                      v46 = v45;
                      v47 = [v45 linkID];

                      goto LABEL_144;
                    }
                  }
                }

                *&v74 = 0xAAAAAAAAAAAAAAAALL;
                *(&v74 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v145 = v74;
                v146 = v74;
                v143 = v74;
                v144 = v74;
                v141 = v74;
                v142 = v74;
                *buf = v74;
                v140 = v74;
                v137 = v74;
                v138 = v74;
                v135 = v74;
                v136 = v74;
                v133 = v74;
                v134 = v74;
                *__str = v74;
                v132 = v74;
                v75 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
                {
                  v76 = a4->var2;
                  *v123 = 134218754;
                  v124 = v76;
                  v125 = 2112;
                  v126 = keya;
                  v127 = 2080;
                  v128 = SAToIPPortString(__str, 0x80uLL, &a4->var18);
                  v129 = 2080;
                  v130 = SAToIPPortString(buf, 0x80uLL, &a4->var19);
                  _os_log_impl(&dword_1A7AD9000, v75, OS_LOG_TYPE_DEFAULT, "No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]", v123, 0x2Au);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    SAToIPPortString(__str, 0x80uLL, &a4->var18);
                    SAToIPPortString(buf, 0x80uLL, &a4->var19);
                    _IDSLogTransport(@"GL", @"IDS", @"No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
                    if (_IDSShouldLog())
                    {
                      SAToIPPortString(__str, 0x80uLL, &a4->var18);
                      SAToIPPortString(buf, 0x80uLL, &a4->var19);
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
                    }
                  }
                }

                goto LABEL_142;
              }
            }

            else
            {
            }
          }
        }
      }
    }

    *&v59 = 0xAAAAAAAAAAAAAAAALL;
    *(&v59 + 1) = 0xAAAAAAAAAAAAAAAALL;
    v145 = v59;
    v146 = v59;
    v143 = v59;
    v144 = v59;
    v141 = v59;
    v142 = v59;
    *buf = v59;
    v140 = v59;
    v137 = v59;
    v138 = v59;
    v135 = v59;
    v136 = v59;
    v133 = v59;
    v134 = v59;
    *__str = v59;
    v132 = v59;
    v60 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
    {
      v61 = a4->var2;
      *v123 = 134218754;
      v124 = v61;
      v125 = 2112;
      v126 = keya;
      v127 = 2080;
      v128 = SAToIPPortString(__str, 0x80uLL, &a4->var18);
      v129 = 2080;
      v130 = SAToIPPortString(buf, 0x80uLL, &a4->var19);
      _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]", v123, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        SAToIPPortString(__str, 0x80uLL, &a4->var18);
        SAToIPPortString(buf, 0x80uLL, &a4->var19);
        _IDSLogTransport(@"GL", @"IDS", @"drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
        if (_IDSShouldLog())
        {
          SAToIPPortString(__str, 0x80uLL, &a4->var18);
          SAToIPPortString(buf, 0x80uLL, &a4->var19);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
        }
      }
    }

LABEL_142:

    goto LABEL_198;
  }

LABEL_199:

  return a4;
}

- (void)linkTransactionIDMismatchDetected:(id)a3
{
  [(IDSGFTMetricsCollector *)self->_metricsCollector transactionIDMismatchDetected];

  [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:&stru_1F1AC8480 subType:@"NWLinkError" subTypeContext:@"transactionIDMismatch" duration:15];
}

- (void)link:(id)a3 pathMTUDidChange:(unsigned __int16)a4 connectionInfo:(id)a5
{
  v6 = a4;
  v40 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a5;
  v10 = [v9 localAddress];
  v11 = [v9 remoteAddress];
  if (v10)
  {
    v12 = v11;
    if (v11)
    {
      v13 = [v9 sessionID];
      v14 = tokenForStunCandidatePair(v10, v12, v13);

      v15 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:v14];
      if (v14)
      {
        v16 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109634;
          *v37 = v6;
          *&v37[4] = 1024;
          *&v37[6] = [v15 linkID];
          v38 = 2112;
          v39 = v15;
          _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@", buf, 0x18u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v32 = [v15 linkID];
            v34 = v15;
            v30 = v6;
            _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@");
            if (_IDSShouldLog())
            {
              v32 = [v15 linkID];
              v34 = v15;
              v30 = v6;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@");
            }
          }
        }

        if ([v15 pathMTU] != v6)
        {
          v17 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
          {
            v18 = [v15 pathMTU];
            v19 = [v15 linkID];
            *buf = 67109632;
            *v37 = v18;
            *&v37[4] = 1024;
            *&v37[6] = v6;
            v38 = 1024;
            LODWORD(v39) = v19;
            _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d", buf, 0x14u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v20 = [v15 pathMTU];
              v33 = v6;
              v35 = [v15 linkID];
              v31 = v20;
              _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d");
              if (_IDSShouldLog())
              {
                v21 = [v15 pathMTU];
                v33 = v6;
                v35 = [v15 linkID];
                v31 = v21;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d");
              }
            }
          }

          v22 = -[IDSGFTMetricsCollector mtuChange:previous:](self->_metricsCollector, "mtuChange:previous:", v6, [v15 pathMTU]);
          [v15 setPathMTU:v6];
          [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v15 linkAttributes:v22];
        }

        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v24 = objc_opt_respondsToSelector();

        if (v24)
        {
          v25 = objc_loadWeakRetained(&self->_delegate);
          [v25 link:self pathMTUDidChange:v6 forLinkID:{objc_msgSend(v15, "linkID")}];
        }

        else
        {
          v29 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: delegate does not implement pathMTUDidChange", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: delegate does not implement pathMTUDidChange");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: delegate does not implement pathMTUDidChange");
              }
            }
          }
        }
      }

      else
      {
        v28 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *v37 = 0;
          _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no candidate pair found for token %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no candidate pair found for token %@");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no candidate pair found for token %@");
            }
          }
        }
      }
    }

    else
    {
      v27 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no remote address on connectionInfo", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no remote address on connectionInfo");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no remote address on connectionInfo");
          }
        }
      }
    }
  }

  else
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no local address on connectionInfo", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no local address on connectionInfo");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no local address on connectionInfo");
        }
      }
    }
  }
}

- (BOOL)_qrLinkLimitExceededWithNewLinkType:(unsigned __int8)a3 cellularRelayLinkCount:(unsigned __int16)a4 wifiRelayLinkCount:(unsigned __int16)a5
{
  if (self->_reduceRelayLinkCreation || self->_reduceCellularUsage)
  {
    v5 = 2;
  }

  else
  {
    v5 = 8;
  }

  if (a5 + a4 >= v5)
  {
    return 1;
  }

  v6 = a3 == 4 || a3 == 8;
  if (v6 && a4 < 2u)
  {
    return 0;
  }

  return (a3 - 3) < 0xFFFFFFFE || a5 > 1u;
}

- (unsigned)_getNewLinkType:(id)a3 remoteInterface:(int *)a4
{
  v91 = *MEMORY[0x1E69E9840];
  v70 = a3;
  v67 = a4;
  *a4 = 0;
  v6 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
  v7 = v6;
  if (!v6)
  {
    LOBYTE(v15) = 0;
    goto LABEL_82;
  }

  v81 = 0u;
  v82 = 0u;
  v79 = 0u;
  v80 = 0u;
  v8 = [v6 countByEnumeratingWithState:&v79 objects:v90 count:16];
  if (v8)
  {
    v9 = v8;
    v69 = 0;
    v10 = *v80;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v80 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v79 + 1) + 8 * i);
        v13 = [v12 delegatedName];

        if (!v13)
        {
          if ([v12 isCellular])
          {
            v14 = 1;
          }

          else
          {
            v14 = 2;
          }

          v69 |= v14;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v79 objects:v90 count:16];
    }

    while (v9);
  }

  else
  {
    v69 = 0;
  }

  v77 = 0u;
  v78 = 0u;
  v75 = 0u;
  v76 = 0u;
  v16 = self->_remoteCandidateList;
  v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v75 objects:v89 count:16];
  if (v17)
  {
    v18 = v17;
    v19 = *v76;
    do
    {
      for (j = 0; j != v18; ++j)
      {
        if (*v76 != v19)
        {
          objc_enumerationMutation(v16);
        }

        v21 = *(*(&v75 + 1) + 8 * j);
        if (([v21 linkFlags] & 4) == 0)
        {
          if ([v21 isCellularStunCandidate])
          {
            v22 = 1;
          }

          else
          {
            v22 = 2;
          }

          *v67 |= v22;
        }
      }

      v18 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v75 objects:v89 count:16];
    }

    while (v18);
  }

  v65 = v7;

  v73 = 0u;
  v74 = 0u;
  v71 = 0u;
  v72 = 0u;
  v66 = self;
  v23 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = [v23 countByEnumeratingWithState:&v71 objects:v88 count:16];
  if (!v24)
  {
    v68 = 0;
    v26 = 0;
    v27 = 0;
    goto LABEL_65;
  }

  v25 = v24;
  v68 = 0;
  v26 = 0;
  v27 = 0;
  v28 = *v72;
  do
  {
    v29 = 0;
    do
    {
      if (*v72 != v28)
      {
        objc_enumerationMutation(v23);
      }

      v30 = *(*(&v71 + 1) + 8 * v29);
      v31 = [v30 state];
      v32 = [v30 isRelayStunCandidatePair];
      v33 = v32;
      if (v70)
      {
        if (v31 == 4)
        {
          v34 = v32;
        }

        else
        {
          v34 = 0;
        }

        if (v34 != 1)
        {
          goto LABEL_55;
        }

        v35 = [v30 sessionID];
        v36 = [v70 isEqualToString:v35];

        if ((v36 & 1) == 0)
        {
          goto LABEL_55;
        }
      }

      else if (v32)
      {
        if (v31 != 4)
        {
          goto LABEL_55;
        }
      }

      else if (v31 != 3)
      {
        goto LABEL_55;
      }

      v37 = [v30 local];
      v38 = [v37 isCellularStunCandidate];

      v39 = [v30 remote];
      v40 = [v39 isCellularStunCandidate];

      if (v40)
      {
        v41 = 8;
      }

      else
      {
        v41 = 4;
      }

      if (v40)
      {
        v42 = 2;
      }

      else
      {
        v42 = 1;
      }

      if (v38)
      {
        v43 = 0;
      }

      else
      {
        v43 = v33;
      }

      v68 += v43;
      if (v38)
      {
        v44 = v33;
      }

      else
      {
        v44 = 0;
      }

      v26 += v44;
      if (!v38)
      {
        v41 = v42;
      }

      v27 |= v41;
LABEL_55:
      ++v29;
    }

    while (v25 != v29);
    v45 = [v23 countByEnumeratingWithState:&v71 objects:v88 count:16];
    v25 = v45;
  }

  while (v45);
LABEL_65:

  v46 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
  {
    v47 = GLUtilInterfaceTypeListToString(v69);
    v48 = GLUtilInterfaceTypeListToString(*v67);
    v49 = GLUtilLinkTypeListToString(v27);
    *buf = 138412802;
    *v84 = v47;
    *&v84[8] = 2112;
    v85 = v48;
    v86 = 2112;
    v87 = v49;
    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "current interface types L:%@, R:%@, link types: %@.", buf, 0x20u);
  }

  retryCountPerLinkType = v66->_retryCountPerLinkType;
  if (!retryCountPerLinkType)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v52 = v66->_retryCountPerLinkType;
    v66->_retryCountPerLinkType = Mutable;

    retryCountPerLinkType = v66->_retryCountPerLinkType;
  }

  v53 = GLUtilNewQRLinkType(v27, v69, *v67, retryCountPerLinkType);
  if (v53)
  {
    v15 = v53;
    if ([(IDSGlobalLink *)v66 _qrLinkLimitExceededWithNewLinkType:v53 cellularRelayLinkCount:v26 wifiRelayLinkCount:v68])
    {
      v54 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109376;
        *v84 = v26;
        *&v84[4] = 1024;
        *&v84[6] = v68;
        v55 = "skip set up new QR link, exceeded limit cellularLinkcount: %d wifiLinkCount: %d";
        v56 = v54;
        v57 = 14;
        goto LABEL_75;
      }

      goto LABEL_76;
    }

    v58 = v66->_retryCountPerLinkType;
    v59 = [MEMORY[0x1E696AD98] numberWithInt:v15];
    v54 = [(NSMutableDictionary *)v58 objectForKey:v59];

    v7 = v65;
    if (v54)
    {
      v60 = [v54 intValue]+ 1;
    }

    else
    {
      v60 = 1;
    }

    v61 = v66->_retryCountPerLinkType;
    v62 = [MEMORY[0x1E696AD98] numberWithInt:v60];
    v63 = [MEMORY[0x1E696AD98] numberWithInt:v15];
    [(NSMutableDictionary *)v61 setObject:v62 forKey:v63];
  }

  else
  {
    v54 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v55 = "set up new QR link is not needed.";
      v56 = v54;
      v57 = 2;
LABEL_75:
      _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, v55, buf, v57);
    }

LABEL_76:
    LOBYTE(v15) = 0;
    v7 = v65;
  }

LABEL_82:
  return v15;
}

- (id)_findCandidatePairWithRelaySessionID:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v5 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = [v5 countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v6)
  {
    v7 = *v14;
    while (2)
    {
      for (i = 0; i != v6; i = i + 1)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(v5);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        if (([v9 isVirtualRelayStunCandidatePair] & 1) == 0)
        {
          if ([v9 isRelayStunCandidatePair])
          {
            v10 = [v9 sessionID];
            v11 = [v4 isEqualToString:v10];

            if (v11)
            {
              v6 = v9;
              goto LABEL_13;
            }
          }
        }
      }

      v6 = [v5 countByEnumeratingWithState:&v13 objects:v17 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

LABEL_13:

  return v6;
}

- (BOOL)_isSharedQRSession:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v5 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = [v5 countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v6)
  {
    v7 = *v14;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(v5);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        v10 = [v9 sessionID];
        if ([v4 isEqualToString:v10])
        {
          v11 = [v9 isSharedQRSession];

          if (v11)
          {
            LOBYTE(v6) = 1;
            goto LABEL_12;
          }
        }

        else
        {
        }
      }

      v6 = [v5 countByEnumeratingWithState:&v13 objects:v17 count:16];
    }

    while (v6);
  }

LABEL_12:

  return v6;
}

- (void)_requestNewTwoWayQRAllocation:(id)a3
{
  v12 = -1431655766;
  v4 = [(IDSGlobalLink *)self _getNewLinkType:a3 remoteInterface:&v12];
  if (v4)
  {
    v5 = v4;
    self->_hasPendingAllocation = 1;
    v6 = im_primary_queue();
    v8[0] = MEMORY[0x1E69E9820];
    v8[1] = 3221225472;
    v8[2] = sub_1A7BBDDBC;
    v8[3] = &unk_1E77E0CB0;
    v9 = v12;
    v8[4] = self;
    v10 = v5;
    dispatch_async(v6, v8);
  }

  else
  {
    v7 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, no more QR link is required or not possible", buf, 2u);
    }
  }
}

- (BOOL)_setupNewQRLinkIfNecessary:(id)a3
{
  v24 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if (self->_useLinkEngine)
  {
    [(IDSGlobalLink *)self _updateAllLinks];
LABEL_15:
    v8 = 0;
    goto LABEL_16;
  }

  if (![(IDSGlobalLink *)self _isSharedQRSession:v4]|| !self->_sharedSessionJoined)
  {
    if (self->_state == 4)
    {
      goto LABEL_6;
    }

LABEL_12:
    v6 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v19 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, GL state [%s].", buf, 0xCu);
    }

    goto LABEL_15;
  }

  if (self->_state > 4)
  {
    goto LABEL_12;
  }

LABEL_6:
  if (!self->_allowConcurrentQRSetup && [(IDSGlobalLink *)self _hasCandidatePairInState:1 anotherState:3 relayCandidatePairsOnly:1 excludeSelfAlloc:1])
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, concurrent QR setup not allowed with a connecting candidate pair.", buf, 2u);
    }

    goto LABEL_15;
  }

  if (v4)
  {
    v10 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v12 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      v19 = v4;
      v20 = 2112;
      v21 = idsSessionID;
      v22 = 2080;
      v23 = v12;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "set up new QR link for %@, ids-sesion-id %@, GL state [%s].", buf, 0x20u);
    }

    v13 = [(IDSGlobalLink *)self _findCandidatePairWithRelaySessionID:v4];
    v14 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v4;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "found candidate pair for QR session %@.", buf, 0xCu);
    }

    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = sub_1A7BBE380;
    v16[3] = &unk_1E77E0250;
    v16[4] = self;
    v17 = v13;
    v15 = v13;
    IDSTransportThreadAddBlock(v16);
  }

  v8 = 1;
LABEL_16:

  return v8;
}

- (id)_convergeSharedSessions:(id)a3
{
  v4 = a3;
  if ([v4 isSharedQRSession])
  {
    if (self->_useLinkEngine)
    {
      [(IDSGlobalLink *)self _convergeSharedSessionsWithLinkEngine:v4];
      v5 = MEMORY[0x1E695E0F0];
    }

    else
    {
      v5 = [(IDSGlobalLink *)self _convergeSharedSessionsWithoutLinkEngine:v4];
    }
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (id)_linkIDsForSession:(id)a3
{
  v21 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [MEMORY[0x1E695DF70] array];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v6 = self->_tokenToCandidatePairs;
  v7 = [(NSMutableDictionary *)v6 countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v17;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v17 != v9)
        {
          objc_enumerationMutation(v6);
        }

        v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:*(*(&v16 + 1) + 8 * i), v16];
        v12 = [v11 sessionID];
        v13 = [v4 qrSessionID];

        if (v12 == v13)
        {
          v14 = [MEMORY[0x1E696AD98] numberWithChar:{objc_msgSend(v11, "linkID")}];
          [v5 addObject:v14];
        }
      }

      v8 = [(NSMutableDictionary *)v6 countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v8);
  }

  return v5;
}

- (void)_convergeSharedSessionsWithLinkEngine:(id)a3
{
  v70 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 sessionID];
  v6 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v5];
  v7 = v6;
  if (v6)
  {
    v52 = v5;
    v53 = v4;
    v51 = v6;
    v8 = v6;
    v64 = 0u;
    v65 = 0u;
    v66 = 0u;
    v67 = 0u;
    v9 = self->_sessionsByID;
    v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v64 objects:v69 count:16];
    v50 = v8;
    if (!v10)
    {
      goto LABEL_21;
    }

    v11 = v10;
    v12 = *v65;
    v54 = v9;
    while (1)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v65 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v64 + 1) + 8 * i);
        v15 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v14];
        v16 = [v15 sessionInfo];
        v17 = [v16 allocateType];

        v18 = v17 != 3 || v15 == v8;
        if (!v18 && [v15 wantsToBeConnected])
        {
          v19 = [v8 sessionInfo];
          [v19 allocateTime];
          v21 = v20;
          v22 = [v15 sessionInfo];
          [v22 allocateTime];
          v24 = v23;

          if (v21 >= v24)
          {
            v26 = [v8 sessionInfo];
            [v26 allocateTime];
            v28 = v27;
            v29 = [v15 sessionInfo];
            [v29 allocateTime];
            v31 = v30;

            if (v28 != v31)
            {
              goto LABEL_19;
            }

            v32 = objc_alloc(MEMORY[0x1E696AFB0]);
            v33 = [v8 qrSessionID];
            v34 = [v32 initWithUUIDString:v33];

            v35 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:v14];
            if ([v34 compare:v35]!= 1)
            {
              v36 = v15;

              v8 = v36;
            }

            v25 = v8;

            v8 = v34;
            v9 = v54;
          }

          else
          {
            v25 = v15;
          }

          v8 = v25;
        }

LABEL_19:
      }

      v11 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v64 objects:v69 count:16];
      if (!v11)
      {
LABEL_21:

        v37 = [MEMORY[0x1E695DFA8] set];
        v60 = 0u;
        v61 = 0u;
        v62 = 0u;
        v63 = 0u;
        v38 = self->_sessionsByID;
        v39 = [(NSMutableDictionary *)v38 countByEnumeratingWithState:&v60 objects:v68 count:16];
        if (v39)
        {
          v40 = v39;
          v41 = 0;
          v42 = *v61;
          do
          {
            for (j = 0; j != v40; ++j)
            {
              if (*v61 != v42)
              {
                objc_enumerationMutation(v38);
              }

              v44 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v60 + 1) + 8 * j)];
              v45 = v44;
              if (v44 != v8)
              {
                [v44 willDisconnect];
                [(IDSGlobalLink *)self _updateLinksForSession:v45];
                v57[0] = MEMORY[0x1E69E9820];
                v57[1] = 3221225472;
                v57[2] = sub_1A7BBEB20;
                v57[3] = &unk_1E77E0C88;
                v46 = v45;
                v58 = v46;
                v59 = self;
                [v46 startSessionConvergenceTimer:5 block:v57];
                v47 = [(IDSGlobalLink *)self _linkIDsForSession:v46];
                [v37 addObjectsFromArray:v47];

                v41 = 1;
              }
            }

            v40 = [(NSMutableDictionary *)v38 countByEnumeratingWithState:&v60 objects:v68 count:16];
          }

          while (v40);

          v4 = v53;
          if (v41)
          {
            v55[0] = MEMORY[0x1E69E9820];
            v55[1] = 3221225472;
            v55[2] = sub_1A7BBEB5C;
            v55[3] = &unk_1E77E0250;
            v55[4] = self;
            v56 = v53;
            IDSTransportThreadAddBlockAfter(v55, 8.0);
          }
        }

        else
        {

          v4 = v53;
        }

        v5 = v52;
        if (v8 == v50)
        {
          if (self->_linkIDForPlugin)
          {
            v48 = [MEMORY[0x1E696AD98] numberWithChar:?];
            v49 = [v37 containsObject:v48];

            if (v49)
            {
              self->_linkIDForPlugin = [v4 linkID];
              [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
            }
          }
        }

        v7 = v51;
        goto LABEL_37;
      }
    }
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
  {
    sub_1A7E179B8();
  }

LABEL_37:
}

- (id)_convergeSharedSessionsWithoutLinkEngine:(id)a3
{
  v66 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if (![v4 isSharedQRSession])
  {
    v45 = 0;
    goto LABEL_54;
  }

  v5 = [v4 sessionID];
  v6 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  HasDifferentSharedRelayCandidatePair = GLUtilHasDifferentSharedRelayCandidatePair(v5, v6);

  if (!HasDifferentSharedRelayCandidatePair)
  {
    v45 = 0;
    goto LABEL_53;
  }

  v45 = objc_alloc_init(MEMORY[0x1E695DF70]);
  if (!v45)
  {
    v45 = objc_alloc_init(MEMORY[0x1E695DF70]);
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *v64 = v5;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: start session convergence for session %@.", buf, 0xCu);
  }

  v60 = 0u;
  v61 = 0u;
  v58 = 0u;
  v59 = 0u;
  v9 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = [v9 countByEnumeratingWithState:&v58 objects:v65 count:16];
  v47 = self;
  if (!v10)
  {
    v44 = 0;
    goto LABEL_39;
  }

  v11 = v10;
  v46 = 0;
  v44 = 0;
  v12 = *v59;
  do
  {
    for (i = 0; i != v11; ++i)
    {
      if (*v59 != v12)
      {
        objc_enumerationMutation(v9);
      }

      v14 = *(*(&v58 + 1) + 8 * i);
      if ([v14 isSharedQRSession])
      {
        v15 = [v14 sessionID];
        if (([v15 isEqualToString:v5]& 1) != 0)
        {
          goto LABEL_14;
        }

        v16 = [v14 state];

        if (v16 == 4)
        {
          [v4 allocateTime];
          v18 = v17;
          [v14 allocateTime];
          if (v18 >= v19 && (([v4 allocateTime], v21 = v20, objc_msgSend(v14, "allocateTime"), v21 != v22) || (v23 = objc_msgSend(objc_alloc(MEMORY[0x1E696AFB0]), "initWithUUIDString:", v5), v24 = objc_alloc(MEMORY[0x1E696AFB0]), objc_msgSend(v14, "sessionID"), v25 = objc_claimAutoreleasedReturnValue(), v26 = objc_msgSend(v24, "initWithUUIDString:", v25), v25, v27 = objc_msgSend(v23, "compare:", v26), v26, v23, v28 = v27 == 1, self = v47, v28)))
          {
            v29 = v5;
            if (([v14 isDisconnecting] & 1) == 0)
            {
              [v45 addObject:v14];
            }

            if (self->_linkIDForPlugin)
            {
              linkIDForPlugin = self->_linkIDForPlugin;
              if (linkIDForPlugin == [v14 linkID])
              {
                self->_linkIDForPlugin = [v4 linkID];
                v15 = +[IDSFoundationLog GlobalLink];
                v5 = v29;
                if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
                {
                  v31 = [v14 linkID];
                  v32 = self->_linkIDForPlugin;
                  *buf = 67109376;
                  *v64 = v31;
                  *&v64[4] = 1024;
                  *&v64[6] = v32;
                  _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: linkID for Plugin is now changed from %d to %d", buf, 0xEu);
                }

                v44 = 1;
LABEL_14:

                continue;
              }
            }

            v5 = v29;
          }

          else
          {
            v46 = 1;
          }
        }
      }
    }

    v11 = [v9 countByEnumeratingWithState:&v58 objects:v65 count:16];
  }

  while (v11);

  if (v46)
  {
    v9 = [v4 candidatePairToken];
    v33 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v64 = v9;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: Should remove the current candidatePair %@.", buf, 0xCu);
    }

    if (([v4 isDisconnecting] & 1) == 0)
    {
      [v45 addObject:v4];
    }

LABEL_39:
  }

  if ([v45 count])
  {
    v56 = 0u;
    v57 = 0u;
    v54 = 0u;
    v55 = 0u;
    v34 = v45;
    v35 = [v34 countByEnumeratingWithState:&v54 objects:v62 count:16];
    if (v35)
    {
      v36 = v35;
      v37 = *v55;
      do
      {
        for (j = 0; j != v36; ++j)
        {
          if (*v55 != v37)
          {
            objc_enumerationMutation(v34);
          }

          v39 = *(*(&v54 + 1) + 8 * j);
          v40 = [v39 candidatePairToken];
          v41 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v64 = v40;
            _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: Setting timer to disconnect candidatePairToken %@ for convergence.", buf, 0xCu);
          }

          v50[0] = MEMORY[0x1E69E9820];
          v50[1] = 3221225472;
          v50[2] = sub_1A7BBF2A8;
          v50[3] = &unk_1E77E0E18;
          v51 = v40;
          v52 = v39;
          v53 = v47;
          v42 = v40;
          [v39 startSessionConvergenceTimer:5 block:v50];
        }

        v36 = [v34 countByEnumeratingWithState:&v54 objects:v62 count:16];
      }

      while (v36);
    }

    v48[0] = MEMORY[0x1E69E9820];
    v48[1] = 3221225472;
    v48[2] = sub_1A7BBF394;
    v48[3] = &unk_1E77E0250;
    self = v47;
    v48[4] = v47;
    v49 = v4;
    IDSTransportThreadAddBlockAfter(v48, 8.0);
  }

  if (v44)
  {
    [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
  }

LABEL_53:

LABEL_54:

  return v45;
}

- (void)_notifySessionInfoReceived:(id)a3 relayGroupID:(id)a4 relaySessionID:(id)a5 status:(unsigned int)a6
{
  v6 = *&a6;
  v27 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  v12 = a5;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v14 = objc_opt_respondsToSelector();

  if (v14)
  {
    v15 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v19 = 138413058;
      v20 = v11;
      v21 = 2112;
      v22 = v12;
      v23 = 1024;
      v24 = v6;
      v25 = 2112;
      v26 = v10;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "notify session-info received for group %@, session %@, status: %u: %@.", &v19, 0x26u);
    }

    v16 = objc_loadWeakRetained(&self->_delegate);
    [v16 link:self didReceiveSessionInfo:v10 relayGroupID:v11 relaySessionID:v12 status:v6];
  }

  if (v10)
  {
    if (self->_isUPlusOneSession)
    {
      v17 = [v10 objectForKeyedSubscript:@"gl-option-sessioninfo-response-participants-key"];
      v18 = [v17 count];

      if (v18 == 2)
      {
        if (self->_remoteJoinedUPlusOneTime == 0.0)
        {
          self->_remoteJoinedUPlusOneTime = ids_monotonic_time();
        }

        [(IDSGlobalLink *)self _enableE2E];
      }
    }
  }
}

- (void)candidatePair:(id)a3 didReceiveSessionInfo:(id)a4 status:(unsigned int)a5
{
  v5 = *&a5;
  sessionsByID = self->_sessionsByID;
  v9 = a4;
  v10 = a3;
  v11 = [v10 sessionID];
  v14 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v11];

  if (v14)
  {
    [v14 setWantsInfo:0];
    [(IDSGlobalLink *)self _updateLinksForSession:v14];
  }

  v12 = [v10 groupID];
  v13 = [v10 sessionID];

  [(IDSGlobalLink *)self _notifySessionInfoReceived:v9 relayGroupID:v12 relaySessionID:v13 status:v5];
}

- (void)candidatePair:(id)a3 didReceiveSessionStats:(id)a4 success:(BOOL)a5
{
  v5 = a5;
  v33 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v11 = objc_opt_respondsToSelector();

  if (v11)
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = [v8 groupID];
      v14 = [v8 sessionID];
      v15 = v14;
      v16 = @"NO";
      *buf = 138413058;
      v26 = v13;
      if (v5)
      {
        v16 = @"YES";
      }

      v27 = 2112;
      v28 = v14;
      v29 = 2112;
      v30 = v16;
      v31 = 2112;
      v32 = v9;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "notify session stats received for group %@, session %@, success:%@: %@.", buf, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v17 = [v8 groupID];
      v18 = [v8 sessionID];
      if (v5)
      {
        v19 = @"YES";
      }

      else
      {
        v19 = @"NO";
      }

      _IDSLogTransport(@"GL", @"IDS", @"notify session stats received for group %@, session %@, success:%@: %@.");

      if (_IDSShouldLog())
      {
        v20 = [v8 groupID];
        v24 = [v8 sessionID];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"notify session stats received for group %@, session %@, success:%@: %@.");
      }
    }

    v21 = objc_loadWeakRetained(&self->_delegate);
    v22 = [v8 groupID];
    v23 = [v8 sessionID];
    [v21 link:self didReceiveSessionStats:v9 relayGroupID:v22 relaySessionID:v23 success:v5];
  }
}

- (void)_removeChannelFromChannelToCandidatePair:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 local];
  v6 = [v5 address];

  v7 = [v4 remote];
  v8 = [v7 external];

  v9 = channelForStunCandidatePair(v6, v8, [v4 channelNumber]);
  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v14 = 138412546;
    v15 = v9;
    v16 = 2112;
    v17 = v4;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "remove channel %@ from _channelToCandidatePairs for candidatePair: %@", &v14, 0x16u);
  }

  if (!self->_channelToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    channelToCandidatePairs = self->_channelToCandidatePairs;
    self->_channelToCandidatePairs = Mutable;
  }

  if (v9)
  {
    v13 = self->_channelToCandidatePairs;
    if (v13)
    {
      CFDictionaryRemoveValue(v13, v9);
    }
  }
}

- (void)_markLinkAsUsed:(id)a3
{
  v13 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v11 = 138412290;
    v12 = v4;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_markLinkAsUsed: marking link as used: %@", &v11, 0xCu);
  }

  v6 = objc_alloc_init(IDSGLUsedLink);
  v7 = [v4 local];
  v8 = [v7 externalAddressString];
  [(IDSGLUsedLink *)v6 setLocalIP:v8];

  v9 = [v4 remote];
  v10 = [v9 externalAddressString];
  [(IDSGLUsedLink *)v6 setServerIP:v10];

  -[IDSGLUsedLink setLinkID:](v6, "setLinkID:", [v4 relayLinkID]);
  [(NSMutableSet *)self->_usedLinks addObject:v6];
}

- (BOOL)_handleRemapping:(id)a3 errorCode:(unsigned __int16)a4 reconnectQUIC:(BOOL)a5
{
  v5 = a5;
  v6 = a4;
  v41 = *MEMORY[0x1E69E9840];
  v8 = a3;
  [(IDSGlobalLink *)self _markLinkAsUsed:v8];
  v9 = [(__CFString *)v8 state];
  if (v5 || ((v26 = v9, v27 = [(__CFString *)v8 hasNoSessionStateTestOptions], v26 > 4) ? (v28 = v27) : (v28 = 0), (v28 & 1) != 0 || v26 - 2 <= 2))
  {
    v10 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)v8 pendingNoSessionStateAllocbind])
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      *buf = 134218754;
      if ([(__CFString *)v8 hasNoSessionStateTestOptions])
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v34 = v6;
      if (v5)
      {
        v13 = @"YES";
      }

      else
      {
        v13 = @"NO";
      }

      v35 = 2112;
      v36 = v11;
      v37 = 2112;
      v38 = v12;
      v39 = 2112;
      v40 = v13;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_handleRemapping: error code: %ld, pendingNoSessionStateAllocbind = %@, hasNoSessionStateTestOptions = %@, reconnectQUIC = %@", buf, 0x2Au);
    }

    if (([(__CFString *)v8 pendingNoSessionStateAllocbind]& 1) == 0)
    {
      v14 = GLUCreateQRNoSessionStateEvent(v8, 237, v6);
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v16 = objc_opt_respondsToSelector();

      if (v16)
      {
        v17 = objc_loadWeakRetained(&self->_delegate);
        [v17 link:self didAddQREvent:v14];
      }

      if (v6 == 699)
      {
        v18 = objc_loadWeakRetained(&self->_delegate);
        v19 = objc_opt_respondsToSelector();

        if (v19)
        {
          v20 = objc_loadWeakRetained(&self->_delegate);
          v21 = [(__CFString *)v8 sessionInfoDict];
          [v20 link:self reportNoSessionState:v21];
        }
      }

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v8 withReason:5];
      [(IDSGlobalLink *)self _removeChannelFromChannelToCandidatePair:v8];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v8 withReason:5];
      }

      v22 = [(__CFString *)v8 state];
      [(__CFString *)v8 setState:1];
      [(__CFString *)v8 setChannelNumber:0];
      [(__CFString *)v8 setLinkID:0];
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = (&_IDSStunCandidatePairStateStrings)[v22];
        *buf = 136315650;
        v34 = v24;
        v35 = 2080;
        v36 = off_1EB2B43B0;
        v37 = 2112;
        v38 = v8;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v31 = off_1EB2B43B0;
          v32 = v8;
          v30 = (&_IDSStunCandidatePairStateStrings)[v22];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v31 = off_1EB2B43B0;
            v32 = v8;
            v30 = (&_IDSStunCandidatePairStateStrings)[v22];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      [(IDSGlobalLink *)self sendAllocbindRequest:v8 isRealloc:0 inResponseToNoSessionState:1 reconnectQUIC:v5, v30, v31, v32];
      [(__CFString *)v8 setPendingNoSessionState:1];
    }

    v25 = 1;
  }

  else
  {
    v25 = 0;
  }

  return v25;
}

- (BOOL)_hasConnectedP2pLink
{
  v15 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = 0u;
  v9 = 0u;
  v10 = 0u;
  v2 = v11 = 0u;
  v3 = [v2 countByEnumeratingWithState:&v8 objects:v14 count:16];
  if (v3)
  {
    v4 = *v9;
    while (2)
    {
      for (i = 0; i != v3; i = (i + 1))
      {
        if (*v9 != v4)
        {
          objc_enumerationMutation(v2);
        }

        v6 = *(*(&v8 + 1) + 8 * i);
        if (([v6 state] == 3 || objc_msgSend(v6, "state") == 4) && (objc_msgSend(v6, "isRelayStunCandidatePair") & 1) == 0)
        {
          v3 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v13 = v6;
            _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "has connected P2P link: %@", buf, 0xCu);
          }

          LOBYTE(v3) = 1;
          goto LABEL_15;
        }
      }

      v3 = [v2 countByEnumeratingWithState:&v8 objects:v14 count:16];
      if (v3)
      {
        continue;
      }

      break;
    }
  }

LABEL_15:

  return v3;
}

- (void)candidatePair:(id)a3 didReceiveStunErrorResponse:(int64_t)a4 errorCode:(unsigned __int16)a5 didLocalExternalAddressChange:(BOOL)a6
{
  v6 = a6;
  v7 = a5;
  v10 = a3;
  v11 = v10;
  if (a4 != 4080)
  {
    if (v7 == 602)
    {
      if (!self->_isUPlusOneSession || ![(IDSGlobalLink *)self _hasConnectedP2pLink])
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v22 = objc_opt_respondsToSelector();

        if ((v22 & 1) == 0)
        {
          goto LABEL_36;
        }

        v23 = objc_loadWeakRetained(&self->_delegate);
        [v23 terminateCallDueToIdleClientForLink:self];
LABEL_33:

        goto LABEL_36;
      }

      if (self->_useLinkEngine)
      {
        linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
        v18 = [v11 linkUniqueName];
        v19 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:v18];

        if (v19 != v11)
        {
          goto LABEL_36;
        }

        [(IDSGlobalLink *)self _markLinkAsUsed:v11];
        [(IDSGlobalLink *)self _reportNoSessionState:v11 errorCode:602];
        v15 = [v11 linkEngine];
        v20 = [v11 linkUniqueName];
        [v15 linkDidFail:v20 errorCode:602 isRecoverable:1 shouldReconnect:1];

        goto LABEL_13;
      }

      v27 = self;
      v28 = v11;
      v29 = 602;
      v26 = 1;
    }

    else
    {
      if (v7 != 601)
      {
        goto LABEL_36;
      }

      if (self->_useLinkEngine)
      {
        v12 = self->_linkEngineIDToCandidatePair;
        v13 = [v10 linkUniqueName];
        v14 = [(NSMutableDictionary *)v12 objectForKeyedSubscript:v13];

        if (v14 != v11)
        {
          goto LABEL_36;
        }

        [(IDSGlobalLink *)self _markLinkAsUsed:v11];
        [(IDSGlobalLink *)self _reportNoSessionState:v11 errorCode:601];
        v15 = [v11 linkEngine];
        v16 = [v11 linkUniqueName];
        [v15 linkDidFail:v16 errorCode:601 isRecoverable:1 shouldReconnect:!v6];

LABEL_13:
        goto LABEL_36;
      }

      v26 = !v6;
      v27 = self;
      v28 = v11;
      v29 = 601;
    }

    [(IDSGlobalLink *)v27 _handleRemapping:v28 errorCode:v29 reconnectQUIC:v26];
    goto LABEL_36;
  }

  if (![v10 isSharedQRSession])
  {
    goto LABEL_36;
  }

  if (v7 <= 607)
  {
    if (v7 != 441)
    {
      if (v7 != 486)
      {
        if (v7 != 603)
        {
          goto LABEL_36;
        }

        goto LABEL_27;
      }

      v24 = self;
      v25 = 52;
LABEL_35:
      [(IDSGlobalLink *)v24 receiveBlockedIndicationWithReason:v25];
      goto LABEL_36;
    }

    [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
    v30 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BC0584;
    block[3] = &unk_1E77E12C0;
    v32 = v11;
    v33 = self;
    v34 = 441;
    dispatch_async(v30, block);

    goto LABEL_36;
  }

  switch(v7)
  {
    case 608:
      [(IDSGlobalLink *)self receiveBlockedIndicationWithReason:49];
      v23 = [v11 candidatePairToken];
      [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:v23 subType:@"DiagnosticRemoveParticipant" subTypeContext:@"NotUploadKeys" duration:15];
      goto LABEL_33;
    case 611:
LABEL_27:
      if (v7 == 603)
      {
        v25 = 44;
      }

      else
      {
        v25 = 46;
      }

      v24 = self;
      goto LABEL_35;
    case 613:
      v24 = self;
      v25 = 50;
      goto LABEL_35;
  }

LABEL_36:
}

- (void)candidatePair:(id)a3 didAddQREvent:(id)a4
{
  v8 = a4;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didAddQREvent:v8];
  }
}

- (void)candidatePair:(id)a3 didReceiveParticipantUpdate:(id)a4 status:(unsigned __int16)a5
{
  v5 = a5;
  v12 = a4;
  v7 = [v12 objectForKey:@"ids-stun-attribute-session-state-type"];
  v8 = [v7 unsignedShortValue];

  if (v5 && (v8 - 7) <= 1)
  {
    self->_isLightweightParticipant = v8 != 7;
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v10 = objc_opt_respondsToSelector();

  if (v10)
  {
    v11 = objc_loadWeakRetained(&self->_delegate);
    [v11 link:self didReceiveParticipantUpdate:v12 status:v5];
  }
}

- (void)candidatePair:(id)a3 didReceivePluginRegistration:(unint64_t)a4 pluginName:(id)a5
{
  v34 = *MEMORY[0x1E69E9840];
  v7 = a3;
  v25 = a5;
  v8 = [v7 groupID];
  v26 = v7;
  v9 = [v7 sessionID];
  v24 = self;
  v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v28 objects:v33 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v29;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v29 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v28 + 1) + 8 * i);
        v16 = [v15 sessionID];
        if ([v16 isEqualToString:v9])
        {
          v17 = [v15 groupID];
          if ([v17 isEqualToString:v8] && objc_msgSend(v15, "state") == 4)
          {
            v18 = [v15 isSharedQRSession];

            if (!v18)
            {
              continue;
            }

            v16 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a4];
            v32 = v16;
            v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v32 count:1];
            [v15 updateParticipantIDMap:v17];
          }
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v28 objects:v33 count:16];
    }

    while (v12);
  }

  if (v25)
  {
    pluginParticipantIDs = v24->_pluginParticipantIDs;
    v20 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a4];
    [(NSMutableDictionary *)pluginParticipantIDs setObject:v25 forKey:v20];
  }

  WeakRetained = objc_loadWeakRetained(&v24->_delegate);
  v22 = objc_opt_respondsToSelector();

  if (v22)
  {
    v23 = objc_loadWeakRetained(&v24->_delegate);
    [v23 link:v24 didReceivePluginRegistration:a4 pluginName:v25];
  }

  if (v24->_linkIDForPlugin != [v26 linkID])
  {
    [(IDSGlobalLink *)v24 _didReceiveRequestToPurgeRegistration];
  }
}

- (void)candidatePair:(id)a3 didReceivePluginUnregistration:(unint64_t)a4 pluginName:(id)a5
{
  v34 = *MEMORY[0x1E69E9840];
  v7 = a3;
  v25 = a5;
  v8 = [v7 groupID];
  v26 = v7;
  v9 = [v7 sessionID];
  v24 = self;
  v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v28 objects:v33 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v29;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v29 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v28 + 1) + 8 * i);
        v16 = [v15 sessionID];
        if ([v16 isEqualToString:v9])
        {
          v17 = [v15 groupID];
          if ([v17 isEqualToString:v8] && objc_msgSend(v15, "state") == 4)
          {
            v18 = [v15 isSharedQRSession];

            if (!v18)
            {
              continue;
            }

            v16 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a4];
            v32 = v16;
            v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v32 count:1];
            [v15 removeFromParticipantIDMap:v17];
          }
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v28 objects:v33 count:16];
    }

    while (v12);
  }

  if (v25)
  {
    pluginParticipantIDs = v24->_pluginParticipantIDs;
    v20 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a4];
    [(NSMutableDictionary *)pluginParticipantIDs removeObjectForKey:v20];

    [(NSMutableDictionary *)v24->_pluginNameToPluginOptionsDict removeObjectForKey:v25];
  }

  WeakRetained = objc_loadWeakRetained(&v24->_delegate);
  v22 = objc_opt_respondsToSelector();

  if (v22)
  {
    v23 = objc_loadWeakRetained(&v24->_delegate);
    [v23 link:v24 didReceivePluginUnregistration:a4 pluginName:v25];
  }
}

- (void)candidatePair:(id)a3 didReceivePluginControlEvent:(unint64_t)a4 operation:(unsigned __int8)a5 transactionID:(id)a6
{
  v7 = a5;
  v19 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a6;
  v12 = v11;
  if (v7 != 2)
  {
    goto LABEL_13;
  }

  if (!v11)
  {
LABEL_12:
    [(IDSGlobalLink *)self _disconnectPluginConnectionsForParticipantID:a4 andPurgeRegistration:0];
    goto LABEL_13;
  }

  if (([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs containsObject:v11]& 1) == 0)
  {
    if ([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs count]>= 0x14)
    {
      do
      {
        [(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs removeObjectAtIndex:0];
      }

      while ([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs count]> 0x13);
    }

    pluginControlDisconnectRecentTransactionIDs = self->_pluginControlDisconnectRecentTransactionIDs;
    if (!pluginControlDisconnectRecentTransactionIDs)
    {
      v15 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v16 = self->_pluginControlDisconnectRecentTransactionIDs;
      self->_pluginControlDisconnectRecentTransactionIDs = v15;

      pluginControlDisconnectRecentTransactionIDs = self->_pluginControlDisconnectRecentTransactionIDs;
    }

    [(NSMutableArray *)pluginControlDisconnectRecentTransactionIDs addObject:v12];
    goto LABEL_12;
  }

  v13 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v17 = 138412290;
    v18 = v12;
    _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "PluginControl indication event has duplicate transactionID %@ - dropped", &v17, 0xCu);
  }

LABEL_13:
}

- (void)candidatePair:(id)a3 didReceiveMappedParticipantsDict:(id)a4 forLinkID:(char)a5
{
  v5 = a5;
  v10 = a4;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v8 = objc_opt_respondsToSelector();

  if (v8)
  {
    v9 = objc_loadWeakRetained(&self->_delegate);
    [v9 link:self didReceiveMappedParticipantsDict:v10 forLinkID:v5];
  }
}

- (void)candidatePair:(id)a3 didReceivePutMaterialIndication:(id)a4
{
  v5 = a4;
  if (IMGetDomainBoolForKey())
  {
    v6 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      *v9 = 0;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "didReceivePutMaterialIndication: ignoring because DisableQUICMaterialIndication is set", v9, 2u);
    }
  }

  else
  {
    v7 = [v5 materials];
    [(IDSGlobalLink *)self _getAndProcessDatablobsFromReceivedMaterials:v7];
    v8 = [v5 materials];
    [(IDSGlobalLink *)self receiveKeyMaterials:v8];
  }
}

- (void)candidatePair:(id)a3 didReceiveGetMaterialResponse:(id)a4
{
  v5 = a4;
  v6 = [v5 materials];
  [(IDSGlobalLink *)self _getAndProcessDatablobsFromReceivedMaterials:v6];

  v7 = [v5 materials];

  [(IDSGlobalLink *)self receiveKeyMaterials:v7];
}

- (void)receiveKeyMaterials:(id)a3
{
  v34 = *MEMORY[0x1E69E9840];
  v4 = a3;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    v19 = v4;
    obj = v4;
    v7 = [obj countByEnumeratingWithState:&v26 objects:v33 count:16];
    if (v7)
    {
      v8 = v7;
      v21 = *v27;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v27 != v21)
          {
            objc_enumerationMutation(obj);
          }

          v10 = *(*(&v26 + 1) + 8 * i);
          v11 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v32 = v10;
            _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receiveKeyMaterials received material: %@", buf, 0xCu);
          }

          v24 = 0u;
          v25 = 0u;
          v22 = 0u;
          v23 = 0u;
          v12 = [v10 materialInfos];
          v13 = [v12 countByEnumeratingWithState:&v22 objects:v30 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v23;
            do
            {
              for (j = 0; j != v14; ++j)
              {
                if (*v23 != v15)
                {
                  objc_enumerationMutation(v12);
                }

                v17 = *(*(&v22 + 1) + 8 * j);
                v18 = objc_loadWeakRetained(&self->_delegate);
                [v18 link:self didReceiveMaterialInfo:v17 material:v10];
              }

              v14 = [v12 countByEnumeratingWithState:&v22 objects:v30 count:16];
            }

            while (v14);
          }
        }

        v8 = [obj countByEnumeratingWithState:&v26 objects:v33 count:16];
      }

      while (v8);
    }

    v4 = v19;
  }
}

- (void)candidatePair:(id)a3 didReceivePutMaterialResponse:(id)a4 forTxId:(unint64_t)a5
{
  putMaterialReqTxIdToCompletionBlock = self->_putMaterialReqTxIdToCompletionBlock;
  v9 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a5];
  v13 = [(NSMutableDictionary *)putMaterialReqTxIdToCompletionBlock objectForKeyedSubscript:v9];

  v10 = v13;
  if (v13)
  {
    (*(v13 + 16))(v13, a4 != 0);
    v11 = self->_putMaterialReqTxIdToCompletionBlock;
    v12 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a5];
    [(NSMutableDictionary *)v11 removeObjectForKey:v12];

    v10 = v13;
  }
}

- (void)_didReceiveRequestToPurgeRegistration
{
  v15 = *MEMORY[0x1E69E9840];
  v3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v4 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v11;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v11 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v10 + 1) + 8 * i);
        if ([v8 state] == 4 && objc_msgSend(v8, "isSharedQRSession"))
        {
          v9 = [(NSMutableDictionary *)self->_pluginParticipantIDs allKeys];
          [v8 removeFromParticipantIDMap:v9];
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v5);
  }

  [(IDSGlobalLink *)self _disconnectPluginConnectionsForParticipantID:0 andPurgeRegistration:1];
}

- (void)_disconnectPluginConnectionsForParticipantID:(unint64_t)a3 andPurgeRegistration:(BOOL)a4
{
  v4 = a4;
  v42 = *MEMORY[0x1E69E9840];
  v7 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v8 = v7;
  pluginParticipantIDs = self->_pluginParticipantIDs;
  if (a3)
  {
    v10 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
    v11 = [(NSMutableDictionary *)pluginParticipantIDs objectForKeyedSubscript:v10];

    if (v11)
    {
      v12 = self->_pluginParticipantIDs;
      v13 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
      v14 = [(NSMutableDictionary *)v12 objectForKeyedSubscript:v13];
      v15 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
      [v8 setObject:v14 forKey:v15];

      if (v4)
      {
        v16 = self->_pluginParticipantIDs;
        v17 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
        [(NSMutableDictionary *)v16 removeObjectForKey:v17];

        [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict removeObjectForKey:v11];
      }
    }

    else
    {
      v23 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v41 = a3;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "_disconnectPluginConnectionsForParticipantID cannot find pluginName for participantID %llu", buf, 0xCu);
      }
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v25 = objc_opt_respondsToSelector();

    if (v25)
    {
      v26 = objc_loadWeakRetained(&self->_delegate);
      v27 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
      v39 = v27;
      v28 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v39 count:1];
      [v26 link:self didReceivePluginDisconnect:v28];
    }
  }

  else
  {
    v34 = MEMORY[0x1E69E9820];
    v35 = 3221225472;
    v36 = sub_1A7BC1900;
    v37 = &unk_1E77E12E8;
    v18 = v7;
    v38 = v18;
    [(NSMutableDictionary *)pluginParticipantIDs enumerateKeysAndObjectsUsingBlock:&v34];
    if (v4)
    {
      [(NSMutableDictionary *)self->_pluginParticipantIDs removeAllObjects:v34];
      [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict removeAllObjects];
    }

    v19 = objc_loadWeakRetained(&self->_delegate);
    v20 = objc_opt_respondsToSelector();

    if (v20)
    {
      v21 = objc_loadWeakRetained(&self->_delegate);
      v22 = [v18 allKeys];
      [v21 link:self didReceivePluginDisconnect:v22];
    }

    v11 = v38;
  }

  if (v4)
  {
    if ([v8 count])
    {
      v29 = objc_loadWeakRetained(&self->_delegate);
      v30 = objc_opt_respondsToSelector();

      if (v30)
      {
        v31 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = [v8 count];
          *buf = 134217984;
          v41 = v32;
          _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "didReceiveRequestToPurgeRegistration for %lu plugins.", buf, 0xCu);
        }

        v33 = objc_loadWeakRetained(&self->_delegate);
        [v33 link:self didReceiveRequestToPurgeRegistration:v8];
      }
    }
  }
}

- (void)disconnectIdleQUICConnectionForCandidatePair:(id)a3
{
  v14 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if ([v4 isQUIC] && objc_msgSend(v4, "state") <= 2)
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v6 = [v4 candidatePairToken];
      v12 = 138412290;
      v13 = v6;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Disconnecting QUIC connection %@ after Info request", &v12, 0xCu);
    }

    nwLink = self->_nwLink;
    v8 = [v4 sessionID];
    v9 = [v4 local];
    v10 = [v9 address];
    v11 = [v4 remote];
    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", v8, v10, [v11 external], 0, self->_delayQUICDisconnectionAfterInfo);
  }
}

- (void)candidatePairDidReceiveInfoResponse:(id)a3
{
  v4 = a3;
  sessionsByID = self->_sessionsByID;
  v10 = v4;
  v6 = [v4 sessionID];
  v7 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v6];

  if (v7)
  {
    [v7 setWantsInfo:0];
  }

  v8 = [v10 linkEngine];
  if (v8)
  {
    v9 = [v10 linkUniqueName];
    [v8 linkDidDisconnect:v9];
  }
}

- (void)sendAllocbindRequest:(id)a3 isRealloc:(BOOL)a4 inResponseToNoSessionState:(BOOL)a5 reconnectQUIC:(BOOL)a6
{
  v6 = a6;
  v7 = a5;
  v8 = a4;
  v32 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = [v10 candidatePairToken];
  if ([v10 isQUIC])
  {
    v12 = [v10 pendingNoSessionStateAllocbind];
    if (v6)
    {
      v20 = v12;
      v21 = v6;
      v13 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        v14 = [v10 candidatePairToken];
        *buf = 138412290;
        v31 = v14;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "Disconnecting NWLink for candidate pair reconnect: %@", buf, 0xCu);
      }

      nwLink = self->_nwLink;
      v16 = [v10 sessionID];
      v17 = [v10 local];
      v18 = [v17 address];
      v19 = [v10 remote];
      -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", v16, v18, [v19 external], 1, 0.0);

      v22[0] = MEMORY[0x1E69E9820];
      v22[1] = 3221225472;
      v22[2] = sub_1A7BC1E04;
      v22[3] = &unk_1E77E0FF0;
      v23 = v10;
      v24 = self;
      v25 = v11;
      v26 = v8;
      v27 = v7;
      v28 = v21;
      v29 = v20;
      IDSTransportThreadAddBlockAfter(v22, 0.5);
    }

    else
    {
      [(IDSGlobalLink *)self _sendQUICAllocbindRequest:v11 isRealloc:v8 inResponseToNoSessionState:v7 shouldConnectLinkFirst:0 isPendingInResponseToNoSessionState:v12];
    }
  }

  else
  {
    [(IDSGlobalLink *)self _sendAllocbindRequest:v11 stunMessage:0 isRealloc:v8 inResponseToNoSessionState:v7];
  }
}

- (BOOL)receiveNoSessionStateForCandidatePair:(id)a3 didLocalExternalAddressChange:(BOOL)a4
{
  v4 = a4;
  v6 = a3;
  v7 = v6;
  if (self->_useLinkEngine)
  {
    linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
    v9 = [v6 linkUniqueName];
    v10 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:v9];

    if (v10 == v7)
    {
      [(IDSGlobalLink *)self _markLinkAsUsed:v7];
      [(IDSGlobalLink *)self _reportNoSessionState:v7 errorCode:601];
      v12 = [v7 linkEngine];
      v13 = [v7 linkUniqueName];
      v11 = 1;
      [v12 linkDidFail:v13 errorCode:601 isRecoverable:1 shouldReconnect:!v4];
    }

    else
    {
      v11 = 1;
    }
  }

  else
  {
    v11 = [(IDSGlobalLink *)self _handleRemapping:v6 errorCode:601 reconnectQUIC:!v4];
  }

  return v11;
}

- (void)receiveIdleClientErrorForCandidatePair:(id)a3
{
  v12 = a3;
  if (self->_isUPlusOneSession && [(IDSGlobalLink *)self _hasConnectedP2pLink])
  {
    if (self->_useLinkEngine)
    {
      linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
      v5 = [v12 linkUniqueName];
      v6 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:v5];

      if (v6 == v12)
      {
        [(IDSGlobalLink *)self _markLinkAsUsed:v12];
        [(IDSGlobalLink *)self _reportNoSessionState:v12 errorCode:602];
        v7 = [v12 linkEngine];
        v8 = [v12 linkUniqueName];
        [v7 linkDidFail:v8 errorCode:602 isRecoverable:1 shouldReconnect:1];
      }
    }

    else
    {
      [(IDSGlobalLink *)self _handleRemapping:v12 errorCode:602 reconnectQUIC:1];
    }
  }

  else
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v10 = objc_opt_respondsToSelector();

    if (v10)
    {
      v11 = objc_loadWeakRetained(&self->_delegate);
      [v11 terminateCallDueToIdleClientForLink:self];
    }
  }
}

- (void)receiveBlockedIndicationWithReason:(unsigned int)a3
{
  v3 = *&a3;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 didReceiveBlockedIndicationForLink:self reason:v3];
  }
}

- (void)receiveErrorIndicationWithCode:(unsigned int)a3
{
  v3 = *&a3;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didReceiveErrorIndicationWithCode:v3];
  }
}

- (id)createLinkCycleForCandidatePair:(id)a3
{
  v4 = a3;
  if (([v4 isRelayStunCandidatePair] & 1) == 0 && (objc_msgSend(v4, "isVirtualRelayStunCandidatePair") & 1) == 0)
  {
    if (self->_tokenToStunCheckPairs)
    {
      v5 = [v4 local];
      v6 = [v5 address];
      v7 = [v4 remote];
      v8 = tokenForStunCandidatePair(v6, [v7 address], self->_cbuuid);
      if (v8)
      {
        tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
        v10 = [v4 local];
        v11 = [v10 address];
        v12 = [v4 remote];
        v13 = tokenForStunCandidatePair(v11, [v12 address], self->_cbuuid);
        v14 = CFDictionaryGetValue(tokenToStunCheckPairs, v13);
      }

      else
      {
        v14 = 0;
      }

      if (v14)
      {
        v15 = [v14 linkMetrics];

        if (v15)
        {
          v16 = [v14 linkMetrics];

          goto LABEL_13;
        }
      }
    }

    else
    {
      v14 = 0;
    }
  }

  v16 = [(IDSGFTMetricsCollector *)self->_metricsCollector createLinkCycle];
LABEL_13:

  return v16;
}

- (id)interfaceNameForCandidatePair:(id)a3
{
  v4 = [a3 local];
  v5 = -[IDSGlobalLink _interfaceNameForInterfaceIndex:](self, "_interfaceNameForInterfaceIndex:", [v4 index]);

  return v5;
}

- (tagIDSQRSendInfo)sendInfoForCandidatePair:(id)a3
{
  sendInfoList = self->_sendInfoList;
  v4 = [a3 linkID];

  return IDSQRSendInfoList_ItemAtIndex(sendInfoList, v4);
}

- (BOOL)isCandidatePairConstrained:(id)a3
{
  v4 = [a3 local];
  LOBYTE(self) = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](self, "_isInterfaceConstrainedWithInterfaceIndex:", [v4 index]);

  return self;
}

- (BOOL)isCandidatePairDelegated:(id)a3
{
  v4 = [a3 local];
  LOBYTE(self) = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v4 index]);

  return self;
}

- (id)_createInterfaceAddressArrayWithNWLink:(BOOL)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5
{
  v5 = a5;
  v6 = a4;
  *&v27[5] = *MEMORY[0x1E69E9840];
  if (!self->_startPort)
  {
LABEL_22:
    v12 = [(IDSNWLink *)self->_nwLink newListenerWithClientUUID:self->_clientUUID wantsWiFi:v6 wantsCellular:v5, v22, v24];
    if (v12)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = [(IDSNWLink *)self->_nwLink port];
        v18 = [(IDSNWLink *)self->_nwLink cellularPort];
        *buf = 67109376;
        v27[0] = v17;
        LOWORD(v27[1]) = 1024;
        *(&v27[1] + 2) = v18;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "bind to random ports(%u,%u) succeeded", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v23 = [(IDSNWLink *)self->_nwLink port];
          v25 = [(IDSNWLink *)self->_nwLink cellularPort];
          _IDSLogTransport(@"GL", @"IDS", @"bind to random ports(%u,%u) succeeded");
          if (_IDSShouldLog())
          {
            [(IDSNWLink *)self->_nwLink port:v23];
            [(IDSNWLink *)self->_nwLink cellularPort];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to random ports(%u,%u) succeeded");
          }
        }
      }
    }

    else
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed binding to random port, remove listeners.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed binding to random port, remove listeners.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed binding to random port, remove listeners.");
          }
        }
      }

      [(IDSNWLink *)self->_nwLink cleanup];
    }

    goto LABEL_36;
  }

  v8 = self->_startPort + LOWORD(self->_portRange) - 1;
  v9 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    startPort = self->_startPort;
    *buf = 67109376;
    v27[0] = startPort;
    LOWORD(v27[1]) = 1024;
    *(&v27[1] + 2) = v8;
    _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "use port range [%u, %u]", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
  {
    v22 = self->_startPort;
    v24 = v8;
    _IDSLogV(0, @"IDSFoundation", @"GL", @"use port range [%u, %u]");
  }

  v11 = self->_startPort;
  if (v11 >= v8)
  {
LABEL_16:
    [(IDSNWLink *)self->_nwLink setPort:0, v22];
    [(IDSNWLink *)self->_nwLink setCellularPort:0];
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = self->_startPort;
      *buf = 67109376;
      v27[0] = v15;
      LOWORD(v27[1]) = 1024;
      *(&v27[1] + 2) = v8;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "all tries failed to bind port range [%u,%u], trying random port.", buf, 0xEu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = self->_startPort;
        v24 = v8;
        _IDSLogTransport(@"GL", @"IDS", @"all tries failed to bind port range [%u,%u], trying random port.");
        if (_IDSShouldLog())
        {
          v22 = self->_startPort;
          v24 = v8;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"all tries failed to bind port range [%u,%u], trying random port.");
        }
      }
    }

    goto LABEL_22;
  }

  while (1)
  {
    [(IDSNWLink *)self->_nwLink setPort:v11, v22, v24];
    [(IDSNWLink *)self->_nwLink setCellularPort:(v11 + 1)];
    v12 = [(IDSNWLink *)self->_nwLink newListenerWithClientUUID:self->_clientUUID wantsWiFi:v6 wantsCellular:v5];
    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v27 = v12;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "Interface address array = %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = v12;
        _IDSLogTransport(@"GL", @"IDS", @"Interface address array = %@");
        if (_IDSShouldLog())
        {
          v22 = v12;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Interface address array = %@");
        }
      }
    }

    if (v12)
    {
      break;
    }

    LOWORD(v11) = v11 + 2;
    if (v8 <= v11)
    {
      goto LABEL_16;
    }
  }

LABEL_36:
  v20 = v12;

  return v20;
}

- (id)_addSocketAndInterfaceAddressWithNWLink:(BOOL)a3 wantsWiFi:(BOOL)a4 wantsCellular:(BOOL)a5
{
  v5 = a3;
  v27 = *MEMORY[0x1E69E9840];
  v7 = [(IDSGlobalLink *)self _createInterfaceAddressArrayWithNWLink:a3 wantsWiFi:a4 wantsCellular:a5];
  v8 = [v7 mutableCopy];

  if (v8)
  {
    [(IDSGlobalLink *)self _delayProcessingCellularInterfaces:v8];
    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v9 = v8;
    v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
    if (v10)
    {
      v11 = *v21;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v21 != v11)
          {
            objc_enumerationMutation(v9);
          }

          v13 = *(*(&v20 + 1) + 8 * i);
          if ([v13 IPVersion] == 1)
          {
            v14 = [v13 index];
            v15 = [v13 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:v14 interfaceName:v15 completionBlock:0];
          }
        }

        v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
      }

      while (v10);
    }

    if ([v9 count])
    {
      [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:v9 removeList:0];
    }

    v16 = v9;
  }

  else
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = @"NO";
      if (v5)
      {
        v18 = @"YES";
      }

      *buf = 138412290;
      v26 = v18;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "failed to create interface address array enableIPv6 %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to create interface address array enableIPv6 %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create interface address array enableIPv6 %@.");
        }
      }
    }
  }

  return v8;
}

- (void)_getAndProcessDatablobsFromReceivedMaterials:(id)a3
{
  v40 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v39 = v3;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "_getAndProcessDatablobsFromReceivedMaterials: materials: %@", buf, 0xCu);
  }

  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v35 = 0u;
  obj = v3;
  v26 = [(__CFDictionary *)obj countByEnumeratingWithState:&v32 objects:v37 count:16];
  if (v26)
  {
    v25 = *v33;
    do
    {
      v6 = 0;
      do
      {
        if (*v33 != v25)
        {
          objc_enumerationMutation(obj);
        }

        v27 = v6;
        v7 = [*(*(&v32 + 1) + 8 * v6) materialInfos];
        v28 = 0u;
        v29 = 0u;
        v30 = 0u;
        v31 = 0u;
        v8 = [v7 countByEnumeratingWithState:&v28 objects:v36 count:16];
        if (v8)
        {
          v9 = v8;
          v10 = *v29;
          do
          {
            for (i = 0; i != v9; ++i)
            {
              if (*v29 != v10)
              {
                objc_enumerationMutation(v7);
              }

              v12 = *(*(&v28 + 1) + 8 * i);
              v13 = [v12 materialType];
              v14 = [v12 materialContent];
              if (v13 == 12 || v13 == 6)
              {
                v16 = [MEMORY[0x1E696AD98] numberWithInt:v13];
                v17 = [(__CFDictionary *)Mutable objectForKey:v16];

                if (!v17)
                {
                  v17 = objc_alloc_init(MEMORY[0x1E695DF70]);
                }

                [v17 addObject:v14];
                v18 = [MEMORY[0x1E696AD98] numberWithInt:v13];
                [(__CFDictionary *)Mutable setObject:v17 forKey:v18];
              }
            }

            v9 = [v7 countByEnumeratingWithState:&v28 objects:v36 count:16];
          }

          while (v9);
        }

        v6 = v27 + 1;
      }

      while (v27 + 1 != v26);
      v26 = [(__CFDictionary *)obj countByEnumeratingWithState:&v32 objects:v37 count:16];
    }

    while (v26);
  }

  v19 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v39 = Mutable;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "_getAndProcessDatablobsFromReceivedMaterials: typeToEncryptedDataBlobs: %@", buf, 0xCu);
  }

  if ([(__CFDictionary *)Mutable count])
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v21 = objc_opt_respondsToSelector();

    if (v21)
    {
      v22 = objc_loadWeakRetained(&self->_delegate);
      [v22 link:self didReceiveEncryptedDataBlobs:Mutable];
    }
  }
}

- (void)_parseActiveExperiments:(id)a3
{
  v29 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v5 = v3;
  v6 = [v5 countByEnumeratingWithState:&v22 objects:v28 count:16];
  if (!v6)
  {
    goto LABEL_23;
  }

  v7 = v6;
  v8 = *v23;
  while (2)
  {
    v9 = 0;
    do
    {
      if (*v23 != v8)
      {
        objc_enumerationMutation(v5);
      }

      v10 = *(*(&v22 + 1) + 8 * v9);
      v11 = [v10 experimentName];

      if (!v11)
      {
        v18 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v27[0] = v10;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "Experiment name is not set in IDSQRProtoChannelExperiment: %@. Skipping...", buf, 0xCu);
        }

        goto LABEL_23;
      }

      v12 = [v10 experimentName];
      v13 = [v10 testValue];
      if (v13 == 3)
      {
        v15 = [MEMORY[0x1E696AD98] numberWithInt:{objc_msgSend(v10, "int32Value")}];
        goto LABEL_13;
      }

      v14 = v13;
      if (v13 == 2)
      {
        v15 = [v10 stringValue];
        goto LABEL_13;
      }

      if (v13 == 1)
      {
        v15 = [MEMORY[0x1E696AD98] numberWithBool:{objc_msgSend(v10, "BOOLValue")}];
LABEL_13:
        v16 = v15;
        [v4 setObject:v15 forKey:v12];
        goto LABEL_14;
      }

      v16 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109378;
        LODWORD(v27[0]) = v14;
        WORD2(v27[0]) = 2112;
        *(v27 + 6) = v10;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "Received unknown IDSQRProtoChannelExperiment_TestValue: %d in IDSQRProtoChannelExperiment: %@", buf, 0x12u);
      }

LABEL_14:

      ++v9;
    }

    while (v7 != v9);
    v17 = [v5 countByEnumeratingWithState:&v22 objects:v28 count:16];
    v7 = v17;
    if (v17)
    {
      continue;
    }

    break;
  }

LABEL_23:

  v19 = [v4 copy];
  qrChannelExperiments = self->_qrChannelExperiments;
  self->_qrChannelExperiments = v19;
}

- (void)_buildQrExperiments
{
  v46 = *MEMORY[0x1E69E9840];
  v3 = objc_alloc_init(MEMORY[0x1E695DF90]);
  if ([(NSDictionary *)self->_qrSessionExperiments count])
  {
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v4 = self->_qrSessionExperiments;
    v5 = [(NSDictionary *)v4 countByEnumeratingWithState:&v39 objects:v45 count:16];
    if (v5)
    {
      v6 = v5;
      v7 = *v40;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v40 != v7)
          {
            objc_enumerationMutation(v4);
          }

          v9 = *(*(&v39 + 1) + 8 * i);
          v10 = [(NSDictionary *)self->_qrSessionExperiments objectForKey:v9];
          v11 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrse_%@", v9];
          [v3 setObject:v10 forKey:v11];
        }

        v6 = [(NSDictionary *)v4 countByEnumeratingWithState:&v39 objects:v45 count:16];
      }

      while (v6);
    }
  }

  if ([(NSDictionary *)self->_qrChannelExperiments count])
  {
    v37 = 0u;
    v38 = 0u;
    v35 = 0u;
    v36 = 0u;
    v12 = self->_qrChannelExperiments;
    v13 = [(NSDictionary *)v12 countByEnumeratingWithState:&v35 objects:v44 count:16];
    if (v13)
    {
      v14 = v13;
      v15 = *v36;
      do
      {
        for (j = 0; j != v14; ++j)
        {
          if (*v36 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v17 = *(*(&v35 + 1) + 8 * j);
          v18 = [(NSDictionary *)self->_qrChannelExperiments objectForKey:v17];
          v19 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrce_%@", v17];
          [v3 setObject:v18 forKey:v19];
        }

        v14 = [(NSDictionary *)v12 countByEnumeratingWithState:&v35 objects:v44 count:16];
      }

      while (v14);
    }
  }

  glComputedSessionExperiments = self->_glComputedSessionExperiments;
  if (glComputedSessionExperiments)
  {
    v33 = 0u;
    v34 = 0u;
    v31 = 0u;
    v32 = 0u;
    v21 = glComputedSessionExperiments;
    v22 = [(NSDictionary *)v21 countByEnumeratingWithState:&v31 objects:v43 count:16];
    if (v22)
    {
      v23 = v22;
      v24 = *v32;
      do
      {
        for (k = 0; k != v23; ++k)
        {
          if (*v32 != v24)
          {
            objc_enumerationMutation(v21);
          }

          v26 = *(*(&v31 + 1) + 8 * k);
          v27 = [(NSDictionary *)self->_glComputedSessionExperiments objectForKeyedSubscript:v26];
          v28 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrse_%@", v26];
          [v3 setObject:v27 forKeyedSubscript:v28];
        }

        v23 = [(NSDictionary *)v21 countByEnumeratingWithState:&v31 objects:v43 count:16];
      }

      while (v23);
    }
  }

  v29 = [v3 copy];
  qrExperiments = self->_qrExperiments;
  self->_qrExperiments = v29;
}

- (BOOL)_processNWLinkAllocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v223 = *MEMORY[0x1E69E9840];
  v177 = a3;
  v173 = a4;
  key = a8;
  if (self->_allocbindEndTime == 0.0)
  {
    self->_allocbindEndTime = a9;
  }

  [(IDSGFTMetricsCollector *)self->_metricsCollector quicAllocbindResponse];
  v200 = 0u;
  v201 = 0u;
  v198 = 0u;
  v199 = 0u;
  v180 = self;
  v16 = self->_interfaceAddressArray;
  v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v198 objects:v222 count:16];
  if (v17)
  {
    v18 = *v199;
    while (2)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v199 != v18)
        {
          objc_enumerationMutation(v16);
        }

        v20 = *(*(&v198 + 1) + 8 * i);
        if ([v20 index] == a5)
        {
          metricsCollector = v180->_metricsCollector;
          v22 = [v20 name];
          [(IDSGFTMetricsCollector *)metricsCollector allocbindResponseFromInterface:v22];

          goto LABEL_13;
        }
      }

      v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v198 objects:v222 count:16];
      if (v17)
      {
        continue;
      }

      break;
    }
  }

LABEL_13:

  v23 = [v177 messageType];
  v24 = v23;
  if (v23 >= 0x29)
  {
    v174 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", v23];
  }

  else
  {
    v174 = off_1E77E1408[v23];
  }

  v178 = [v177 allocbindResponse];
  if (v178)
  {
    Value = 0;
    if (key && v180->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(v180->_tokenToCandidatePairs, key);
    }

    v181 = Value;
    v172 = [v181 state];
    nwLink = v180->_nwLink;
    v27 = [v181 sessionID];
    v28 = [v181 kindSuffix];
    v29 = [v181 local];
    LOBYTE(v162) = [v29 isCellularStunCandidate];
    v175 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:a6 remoteAddress:a7 clientUniquePID:0 sessionID:v27 type:5 isRelay:1 protocolStackSuffix:v28 isCellular:v162];

    v30 = v180->_metricsCollector;
    v31 = [v175 protocolStackDescription];
    [(IDSGFTMetricsCollector *)v30 allocbindResponseForProtocolStack:v31];

    v32 = GLUtilConnectionDictionaryForNWConnectionInfo(v175, 1);
    v33 = [v181 connections];
    [v33 setObject:v32 forKeyedSubscript:@"qr"];

    v34 = [v181 linkMetrics];
    [v34 receiveAllocbindResponse];

    [(IDSGlobalLink *)v180 _setLinkMetricsAttributesForCandidatePair:v181];
    v35 = [v181 local];
    v36 = [v35 address];

    v37 = *(v36 + 1);
    if (v37 == 2)
    {
      if (IMGetDomainBoolForKey())
      {
LABEL_23:
        v38 = +[IDSFoundationLog GlobalLink];
        v39 = v38;
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          if (*(v36 + 1) == 30)
          {
            v40 = "IPv6";
          }

          else
          {
            v40 = "IPv4";
          }

          v41 = [v177 transactionID];
          *buf = 136315394;
          *&buf[4] = v40;
          *&buf[12] = 2048;
          *&buf[14] = v41;
          v39 = v38;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "_processNWLinkAllocbindResponse: force dropping [%s] quic allocbind response %llu.", buf, 0x16u);
        }

        v42 = 0;
        goto LABEL_225;
      }
    }

    else if (v37 == 30 && (IMGetDomainBoolForKey() & 1) != 0)
    {
      goto LABEL_23;
    }

    if (-[NSObject removeProtoRequest:](v181, "removeProtoRequest:", [v177 transactionID]))
    {
      v169 = [v181 isRealloc];
      if (v180->_state < 5 || ([v181 pendingNoSessionStateAllocbind]& 1) != 0)
      {
        v171 = [v178 materials];
        [(IDSGlobalLink *)v180 _getAndProcessDatablobsFromReceivedMaterials:v171];
        if (v172 > 2)
        {
          if (([v181 pendingNoSessionStateAllocbind]& 1) == 0)
          {
            v80 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v80, OS_LOG_TYPE_DEFAULT))
            {
              v81 = (&_IDSStunCandidatePairStateStrings)[v172];
              *buf = 136315394;
              *&buf[4] = v81;
              *&buf[12] = 2112;
              *&buf[14] = v174;
              _os_log_impl(&dword_1A7AD9000, v80, OS_LOG_TYPE_DEFAULT, "candidate pair state is [%s], ignore %@", buf, 0x16u);
            }

            v42 = 1;
            goto LABEL_224;
          }
        }

        else
        {
          allocbindStartTime = v180->_allocbindStartTime;
          allocbindEndTime = v180->_allocbindEndTime;
          v46 = +[IDSFoundationLog GlobalLink];
          v47 = (allocbindEndTime - allocbindStartTime) * 1000.0;
          if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
          {
            v48 = [v181 local];
            v49 = [v48 transport];
            v50 = *(v36 + 1);
            idsSessionID = v180->_idsSessionID;
            v52 = [v181 sessionID];
            *buf = 138413826;
            *&buf[4] = v174;
            *&buf[12] = 2112;
            *&buf[14] = key;
            *&buf[22] = 2048;
            *&buf[24] = v47;
            LOWORD(v216) = 2048;
            *(&v216 + 2) = v49;
            WORD5(v216) = 1024;
            HIDWORD(v216) = v50;
            *v217 = 2112;
            *&v217[2] = idsSessionID;
            *&v217[10] = 2112;
            *&v217[12] = v52;
            _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "Received %@ on %@ after %0.6lf ms over protocol: %ld family: %d IDSSessionID: %@ QRSessionID: %@", buf, 0x44u);
          }

          v53 = stunMessageTypeFromProtoMessageType(v24, v169);
          GLUtilReportAWDStunMessageEventWithType(v53, 0, v181, v47);
          v54 = [v178 reportingDataBlob];
          v55 = [v181 local];
          v56 = [v54 base64EncodedStringWithOptions:0];
          [v55 setAllocbindDataBlob:v56];

          v57 = [v181 local];
          v58 = [v178 software];
          [v57 setServerSoftwareVersion:v58];

          v59 = GLUCreateQRStunMessageEventWithType(v53, 0, v181, v180->_timeBase, v47);
          if (v59)
          {
            WeakRetained = objc_loadWeakRetained(&v180->_delegate);
            v61 = objc_opt_respondsToSelector();

            if (v61)
            {
              v62 = objc_loadWeakRetained(&v180->_delegate);
              [v62 link:v180 didAddQREvent:v59];
            }
          }
        }

        v170 = [v178 clientAddress];
        if ([v170 length])
        {
          v68 = [v181 local];
          [v68 setExternalAddress:v170];

          v69 = [v178 channelId];
          v70 = v69;
          if (v69)
          {
            v71 = [v181 channelNumber];
            v72 = bswap32(v69) >> 16;
            if (!v71)
            {
              v82 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109634;
                *&buf[4] = 0;
                *&buf[8] = 1024;
                *&buf[10] = v70;
                *&buf[14] = 2112;
                *&buf[16] = key;
                _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "update channelNumber (%04x->%04x) for %@", buf, 0x18u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v163 = v70;
                  v165 = key;
                  v158 = 0;
                  _IDSLogTransport(@"GL", @"IDS", @"update channelNumber (%04x->%04x) for %@");
                  if (_IDSShouldLog())
                  {
                    v163 = v70;
                    v165 = key;
                    v158 = 0;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update channelNumber (%04x->%04x) for %@");
                  }
                }
              }

              [v181 setChannelNumber:v72, v158, v163, v165];
LABEL_78:
              IDSSimpleUInt16List_AddItem(&v180->_channelNumberList, v72);
              [(IDSGlobalLink *)v180 _setChannelToCandidatePair:v181 localAddress:a6 remoteAddress:a7 channelNumber:v72];
              v83 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
              {
                v84 = [v178 participantType];
                v85 = @"lightweight";
                if ((v84 & 1) == 0)
                {
                  v85 = @"normal";
                }

                *buf = 138412290;
                *&buf[4] = v85;
                _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "server reports this client is a %@ participant", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
              {
                v86 = ([v178 participantType] & 1) != 0 ? @"lightweight" : @"normal";
                v158 = v86;
                _IDSLogTransport(@"GL", @"IDS", @"server reports this client is a %@ participant");
                if (_IDSShouldLog())
                {
                  if ([v178 participantType])
                  {
                    v87 = @"lightweight";
                  }

                  else
                  {
                    v87 = @"normal";
                  }

                  v158 = v87;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"server reports this client is a %@ participant");
                }
              }

              v88 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
              {
                v89 = [v178 software];
                *buf = 138412290;
                *&buf[4] = v89;
                _os_log_impl(&dword_1A7AD9000, v88, OS_LOG_TYPE_DEFAULT, "received QR server build version %@", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v158 = [v178 software];
                  _IDSLogTransport(@"GL", @"IDS", @"received QR server build version %@");

                  if (_IDSShouldLog())
                  {
                    v158 = [v178 software];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"received QR server build version %@");
                  }
                }
              }

              -[NSObject setRelayLinkID:](v181, "setRelayLinkID:", [v178 linkId]);
              [v178 quicConnectionInfos];
              v196 = 0u;
              v197 = 0u;
              v194 = 0u;
              obj = v195 = 0u;
              v90 = [obj countByEnumeratingWithState:&v194 objects:v221 count:16];
              if (v90)
              {
                v91 = *v195;
                do
                {
                  for (j = 0; j != v90; ++j)
                  {
                    if (*v195 != v91)
                    {
                      objc_enumerationMutation(obj);
                    }

                    v93 = *(*(&v194 + 1) + 8 * j);
                    v94 = [v93 quicConnectionId];
                    v95 = [v93 quicConnectionType];
                    v96 = [v181 QUICConnectionIDs];
                    v97 = v96;
                    if (v95 == 1)
                    {
                      [v96 setRemoteIDSConnectionIDData:v94];
                    }

                    else if (v95)
                    {
                      v98 = +[IDSFoundationLog GlobalLink];
                      if (os_log_type_enabled(v98, OS_LOG_TYPE_DEFAULT))
                      {
                        *buf = 67109378;
                        *&buf[4] = v95;
                        *&buf[8] = 2112;
                        *&buf[10] = v93;
                        _os_log_impl(&dword_1A7AD9000, v98, OS_LOG_TYPE_DEFAULT, "Received unknown QuicConnectionType: %d in QuicConnectionInfo: %@", buf, 0x12u);
                      }
                    }

                    else
                    {
                      [v96 setRemoteAVCConnectionIDData:v94];
                    }
                  }

                  v90 = [obj countByEnumeratingWithState:&v194 objects:v221 count:16];
                }

                while (v90);
              }

              if ([(IDSGlobalLink *)v180 _shouldUseQRTLE])
              {
                v99 = [v181 local];
                if ([v99 isCellularStunCandidate])
                {
                  allowTLEOverCellular = v180->_allowTLEOverCellular;

                  if (!allowTLEOverCellular)
                  {
                    goto LABEL_154;
                  }
                }

                else
                {
                }

                v102 = [v181 QUICConnectionIDs];
                v103 = [v102 isComplete];

                if (v103)
                {
                  v104 = [v181 sessionID];
                  v105 = [v181 local];
                  v106 = [v105 address];

                  v107 = [v181 remote];
                  v108 = [v107 external];

                  v109 = [v181 QUICConnectionIDs];
                  v110 = [v181 channelNumber];
                  if ([(IDSNWLink *)v180->_nwLink createQUICPodQRConnectionsForSession:v104 localAddress:v106 remoteAddress:v108 quicConnectionIDs:v109 channelNumber:v110])
                  {
                    *&v111 = 0xAAAAAAAAAAAAAAAALL;
                    *(&v111 + 1) = 0xAAAAAAAAAAAAAAAALL;
                    v219 = v111;
                    v220 = v111;
                    *&v217[16] = v111;
                    v218 = v111;
                    v216 = v111;
                    *v217 = v111;
                    *buf = v111;
                    *&buf[16] = v111;
                    __str[6] = v111;
                    __str[7] = v111;
                    __str[4] = v111;
                    __str[5] = v111;
                    __str[2] = v111;
                    __str[3] = v111;
                    __str[0] = v111;
                    __str[1] = v111;
                    SAToIPPortString(buf, 0x80uLL, v106);
                    SAToIPPortString(__str, 0x80uLL, v108);
                    v112 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v112, OS_LOG_TYPE_DEFAULT))
                    {
                      *v204 = 138413314;
                      v205 = v104;
                      v206 = 2080;
                      v207 = buf;
                      v208 = 2080;
                      v209 = __str;
                      v210 = 2112;
                      v211 = v109;
                      v212 = 1024;
                      v213 = __rev16(v110);
                      _os_log_impl(&dword_1A7AD9000, v112, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded", v204, 0x30u);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v113 = __rev16(v110);
                        v167 = v109;
                        v168 = v113;
                        v165 = __str;
                        v159 = v104;
                        v163 = buf;
                        _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded");
                        if (_IDSShouldLog())
                        {
                          v167 = v109;
                          v168 = v113;
                          v165 = __str;
                          v159 = v104;
                          v163 = buf;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded");
                        }
                      }
                    }
                  }

                  else
                  {
                    v116 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
                    {
                      v117 = [v181 sessionID];
                      *buf = 138412290;
                      *&buf[4] = v117;
                      _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@) failed", buf, 0xCu);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v159 = [v181 sessionID];
                        _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@) failed");

                        if (_IDSShouldLog())
                        {
                          v159 = [v181 sessionID];
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@) failed");
                        }
                      }
                    }

                    if (v180->_clientType == 6)
                    {
                      v118 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v118, OS_LOG_TYPE_DEFAULT))
                      {
                        v119 = [v181 sessionID];
                        *buf = 138412290;
                        *&buf[4] = v119;
                        _os_log_impl(&dword_1A7AD9000, v118, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@) failed, triggering ABC", buf, 0xCu);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          v159 = [v181 sessionID];
                          _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@) failed, triggering ABC");

                          if (_IDSShouldLog())
                          {
                            v159 = [v181 sessionID];
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@) failed, triggering ABC");
                          }
                        }
                      }

                      [(IDSGlobalLink *)v180 _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"TLE" subTypeContext:@"SetupFailed" duration:0, v159];
                    }
                  }

                  goto LABEL_153;
                }

                v114 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
                {
                  v115 = [v181 QUICConnectionIDs];
                  *buf = 138412290;
                  *&buf[4] = v115;
                  _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "QUIC connectionIDs not available for TLE (%@)", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v159 = [v181 QUICConnectionIDs];
                    _IDSLogTransport(@"GL", @"IDS", @"QUIC connectionIDs not available for TLE (%@)");

                    if (_IDSShouldLog())
                    {
                      v104 = [v181 QUICConnectionIDs];
                      v159 = v104;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"QUIC connectionIDs not available for TLE (%@)");
LABEL_153:
                    }
                  }
                }
              }

LABEL_154:
              v120 = [v178 activeExperiments];
              [(IDSGlobalLink *)v180 _parseActiveExperiments:v120];

              [(IDSGlobalLink *)v180 _buildQrExperiments];
              v121 = [MEMORY[0x1E695DFA8] set];
              if ([v178 ackedStaleLinkIdsCount])
              {
                v122 = 0;
                do
                {
                  v123 = *([v178 ackedStaleLinkIds] + 4 * v122);
                  v124 = objc_alloc_init(IDSGLUsedLink);
                  [(IDSGLUsedLink *)v124 setLinkID:v123];
                  v125 = [v178 clientAddress];
                  [(IDSGLUsedLink *)v124 setLocalIP:v125];

                  v126 = [v181 remote];
                  v127 = [v126 externalAddressString];
                  [(IDSGLUsedLink *)v124 setServerIP:v127];

                  [v121 addObject:v124];
                  ++v122;
                }

                while ([v178 ackedStaleLinkIdsCount] > v122);
              }

              v192 = 0u;
              v193 = 0u;
              v191 = 0u;
              v190 = 0u;
              v128 = v121;
              v129 = [v128 countByEnumeratingWithState:&v190 objects:v203 count:16];
              if (v129)
              {
                v130 = *v191;
                do
                {
                  for (k = 0; k != v129; ++k)
                  {
                    if (*v191 != v130)
                    {
                      objc_enumerationMutation(v128);
                    }

                    [(NSMutableSet *)v180->_usedLinks removeObject:*(*(&v190 + 1) + 8 * k)];
                  }

                  v129 = [v128 countByEnumeratingWithState:&v190 objects:v203 count:16];
                }

                while (v129);
              }

              v132 = [v178 materials];
              [(IDSGlobalLink *)v180 receiveKeyMaterials:v132];

              quicMaterialExchangeProvider = v180->_quicMaterialExchangeProvider;
              if (quicMaterialExchangeProvider)
              {
                [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider sendDesiredMaterialsIfNeeded];
              }

              if (v172 > 2)
              {
                goto LABEL_220;
              }

              [v181 setState:3];
              [(IDSGlobalLink *)v180 _notifyLinkEngineCandidatePairDidConnect:v181];
              v134 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v134, OS_LOG_TYPE_DEFAULT))
              {
                v135 = (&_IDSStunCandidatePairStateStrings)[v172];
                *buf = 136315650;
                *&buf[4] = v135;
                *&buf[12] = 2080;
                *&buf[14] = off_1EB2B43C0;
                *&buf[22] = 2112;
                *&buf[24] = key;
                _os_log_impl(&dword_1A7AD9000, v134, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v164 = off_1EB2B43C0;
                  v166 = key;
                  v160 = (&_IDSStunCandidatePairStateStrings)[v172];
                  _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
                  if (_IDSShouldLog())
                  {
                    v164 = off_1EB2B43C0;
                    v166 = key;
                    v160 = (&_IDSStunCandidatePairStateStrings)[v172];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
                  }
                }
              }

              v136 = [v181 linkEngine:v160];

              if (v136)
              {
                v137 = [v181 linkEngine];
                v138 = [v181 linkUniqueName];
                v139 = [v137 isLinkConnecting:v138];

                if ((v139 & 1) == 0)
                {
                  v140 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v140, OS_LOG_TYPE_DEFAULT))
                  {
                    v141 = [v181 linkUniqueName];
                    *buf = 138412546;
                    *&buf[4] = v141;
                    *&buf[12] = 2112;
                    *&buf[14] = v181;
                    _os_log_impl(&dword_1A7AD9000, v140, OS_LOG_TYPE_DEFAULT, "Link Engine link no longer connecting: %@, disconnect candidate pair %@", buf, 0x16u);
                  }

LABEL_191:

                  v151 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v151, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412290;
                    *&buf[4] = v181;
                    _os_log_impl(&dword_1A7AD9000, v151, OS_LOG_TYPE_DEFAULT, "Disconnecting %@", buf, 0xCu);
                  }

                  [(IDSGlobalLink *)v180 _sendQUICUnallocbindRequest:key reason:8];
                }
              }

              else if ([v181 isRelayStunCandidatePair]&& (([v181 isSharedQRSession]| v169) & 1) == 0)
              {
                v142 = [v181 sessionID];
                v143 = [(IDSGlobalLink *)v180 _getCandidatePairsWithSessionID:v142 inState:4];

                v188 = 0u;
                v189 = 0u;
                v186 = 0u;
                v187 = 0u;
                v140 = v143;
                v144 = [v140 countByEnumeratingWithState:&v186 objects:v202 count:16];
                if (v144)
                {
                  v145 = *v187;
                  while (2)
                  {
                    v146 = 0;
                    v147 = v181;
                    do
                    {
                      if (*v187 != v145)
                      {
                        objc_enumerationMutation(v140);
                        v147 = v181;
                      }

                      v148 = *(*(&v186 + 1) + 8 * v146);
                      if (v148 != v147)
                      {
                        v149 = +[IDSFoundationLog GlobalLink];
                        if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
                        {
                          v150 = [v181 sessionID];
                          *buf = 138412802;
                          *&buf[4] = v148;
                          *&buf[12] = 2112;
                          *&buf[14] = v150;
                          *&buf[22] = 2112;
                          *&buf[24] = v181;
                          _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "Found another connected candidate pair %@ with the same QRSessionID %@ disconnecting %@", buf, 0x20u);
                        }

                        goto LABEL_191;
                      }

                      ++v146;
                    }

                    while (v144 != v146);
                    v144 = [v140 countByEnumeratingWithState:&v186 objects:v202 count:16];
                    if (v144)
                    {
                      continue;
                    }

                    break;
                  }
                }
              }

              [(IDSGlobalLink *)v180 _setFirstDefaultCandidatePair:v181];
              if (v169)
              {
                if (([v181 hbStarted]& 1) == 0)
                {
                  v152 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v152, OS_LOG_TYPE_DEFAULT))
                  {
                    v153 = [v181 pendingRealloc];
                    v154 = @"NO";
                    if (v153)
                    {
                      v154 = @"YES";
                    }

                    *buf = 138412290;
                    *&buf[4] = v154;
                    _os_log_impl(&dword_1A7AD9000, v152, OS_LOG_TYPE_DEFAULT, "receive reallocate response, send HBR (%@).", buf, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                  {
                    v155 = [v181 pendingRealloc]? @"YES" : @"NO";
                    v161 = v155;
                    _IDSLogTransport(@"GL", @"IDS", @"receive reallocate response, send HBR (%@).");
                    if (_IDSShouldLog())
                    {
                      if ([v181 pendingRealloc])
                      {
                        v156 = @"YES";
                      }

                      else
                      {
                        v156 = @"NO";
                      }

                      v161 = v156;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"receive reallocate response, send HBR (%@).");
                    }
                  }

                  [(IDSGlobalLink *)v180 _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:key, v161];
                  [v181 setHbStarted:1];
                }

                if (([v181 isSharedQRSession]& 1) == 0)
                {
                  goto LABEL_222;
                }
              }

              else
              {
                [(IDSGlobalLink *)v180 _processXORMappedAddress:v181 arrivalTime:a9];
                if ([v181 allocateType]== 2)
                {
                  [(IDSGlobalLink *)v180 _sendQUICUnallocbindRequest:key reason:0];
                  goto LABEL_222;
                }
              }

              if (![(IDSGlobalLink *)v180 _postProcessQUICAllocbindResponse:v178 candidatePair:v181])
              {
                if (v180->_delaySessionConnected)
                {
                  if (!v180->_isInitiator)
                  {
                    v182[0] = MEMORY[0x1E69E9820];
                    v182[1] = 3221225472;
                    v182[2] = sub_1A7BC56F8;
                    v182[3] = &unk_1E77E0E18;
                    v183 = v181;
                    v184 = v180;
                    v185 = key;
                    [v183 startSessionConnectedTimer:30 block:v182];
                  }
                }

                else
                {
                  [(IDSGlobalLink *)v180 _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:key];
                }

LABEL_220:
                if ([v181 pendingNoSessionStateAllocbind])
                {
                  [v181 setPendingNoSessionState:0];
                }
              }

LABEL_222:

              v42 = 1;
              goto LABEL_223;
            }

            v73 = __rev16(v71);
            if (v69 == v73)
            {
              v74 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                *&buf[4] = v70;
                _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "channelNumber unchanged (%04x)", buf, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v158 = v70;
                  _IDSLogTransport(@"GL", @"IDS", @"channelNumber unchanged (%04x)");
                  if (_IDSShouldLog())
                  {
                    v158 = v70;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"channelNumber unchanged (%04x)");
                  }
                }
              }

              goto LABEL_78;
            }

            v101 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109376;
              *&buf[4] = v73;
              *&buf[8] = 1024;
              *&buf[10] = v70;
              _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "channelNumber mismatch (%04x->%04x)", buf, 0xEu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"channelNumber mismatch (%04x->%04x)");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"channelNumber mismatch (%04x->%04x)");
                }
              }
            }

LABEL_122:
            v42 = 0;
LABEL_223:
            v80 = v170;
LABEL_224:

            v39 = v171;
            goto LABEL_225;
          }

          v79 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = v174;
            _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "receive %@ without channel-number", buf, 0xCu);
          }
        }

        else
        {
          v79 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = v174;
            _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "receive %@ with invalid client address", buf, 0xCu);
          }
        }

        goto LABEL_122;
      }

      v75 = +[IDSFoundationLog GlobalLink];
      v39 = v75;
      if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
      {
        v76 = (&_IDSStunCandidatePairStateStrings)[v172];
        v77 = [v181 pendingNoSessionStateAllocbind];
        v78 = @"NO";
        *buf = 136315650;
        *&buf[4] = v76;
        *&buf[12] = 2112;
        if (v77)
        {
          v78 = @"YES";
        }

        *&buf[14] = v78;
        *&buf[22] = 2112;
        *&buf[24] = v174;
        v65 = "_processNWLinkAllocbindResponse: candidate pair state is [%s], pendingNoSessionStateAllocbind: %@, ignore %@";
        v39 = v75;
        v66 = v75;
        v67 = 32;
        goto LABEL_45;
      }
    }

    else
    {
      v63 = +[IDSFoundationLog GlobalLink];
      v39 = v63;
      if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
      {
        v64 = [v177 transactionID];
        *buf = 134217984;
        *&buf[4] = v64;
        v65 = "_processNWLinkAllocbindResponse: %llu not pending proto request";
        v39 = v63;
        v66 = v63;
        v67 = 12;
LABEL_45:
        _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, v65, buf, v67);
      }
    }

    v42 = 1;
LABEL_225:

    v43 = v181;
    goto LABEL_226;
  }

  v43 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *&buf[4] = v174;
    _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "invalid %@ received", buf, 0xCu);
  }

  v42 = 0;
LABEL_226:

  return v42;
}

- (BOOL)_processQUICUnallocbindResponse:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remmoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v103 = *MEMORY[0x1E69E9840];
  v13 = a3;
  v86 = a4;
  v14 = a8;
  Value = 0;
  if (v14 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v14);
  }

  v87 = v14;
  v16 = Value;
  v17 = [v16 state];
  if ([v16 removeProtoRequest:{objc_msgSend(v13, "transactionID")}])
  {
    if (v17 == 6)
    {
      v18 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315138;
        prots = OBJC_PROTOCOL___IDSServerBagContentProvider.prots;
        v19 = "receive unallocbind response with state [%s], ignore.";
LABEL_10:
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, v19, buf, 0xCu);
        goto LABEL_78;
      }

      goto LABEL_78;
    }

    v84 = v17;
    [v13 startTime];
    v21 = v20;
    v22 = +[IDSFoundationLog GlobalLink];
    v23 = (a9 - v21) * 1000.0;
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v25 = [v16 sessionID];
      v26 = [v16 local];
      v27 = [v26 transport];
      v28 = [v16 local];
      v29 = *([v28 address] + 1);
      *buf = 138413570;
      prots = idsSessionID;
      v93 = 2112;
      v94 = v25;
      v95 = 2112;
      v96 = v87;
      v97 = 2048;
      v98 = v23;
      v99 = 2048;
      v100 = v27;
      v101 = 1024;
      v102 = v29;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "Received unallocbind response for IDSSessionID: %@ QRSessionID: %@ on %@ after %0.6lf ms over protocol: %ld family: %d", buf, 0x3Au);
    }

    v30 = stunMessageTypeFromProtoMessageType([v13 messageType], 0);
    v31 = v23;
    GLUtilReportAWDStunMessageEventWithType(v30, 0, v16, v31);
    v32 = [v13 unallocbindResponse];
    v18 = [v32 reportingDataBlob];

    v33 = [v16 local];
    v34 = [v18 base64EncodedStringWithOptions:0];
    [v33 setAllocbindDataBlob:v34];

    v85 = GLUCreateQRStunMessageEventWithType(v30, 0, v16, self->_timeBase, v31);
    if (v85)
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v36 = objc_opt_respondsToSelector();

      if (v36)
      {
        v37 = objc_loadWeakRetained(&self->_delegate);
        [v37 link:self didAddQREvent:v85];
      }
    }

    if (self->_state > 3)
    {
      v57 = [v13 transactionID];
      if (self->_unallocbindRequestToReason)
      {
        v58 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:v57];
        if (v58)
        {
          unallocbindRequestToReason = self->_unallocbindRequestToReason;
          v60 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:v57];
          v61 = [CFDictionaryGetValue(unallocbindRequestToReason v60)];
        }

        else
        {
          v61 = [0 unsignedIntValue];
        }
      }

      else
      {
        v61 = [0 unsignedIntValue];
      }

      v67 = self->_unallocbindRequestToReason;
      v68 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:v57];
      [(NSMutableDictionary *)v67 removeObjectForKey:v68];

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v16 withReason:v61];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v16 withReason:v61];
      }

      v69 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
      v70 = v69;
      if (self->_state == 5)
      {
        [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
        if (!v70)
        {
          [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:v61];
        }
      }

      else if (!v69 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v71 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v71, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
            }
          }
        }

        [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
      }

      goto LABEL_70;
    }

    [v16 setState:6];
    if (self->_useLinkEngine)
    {
      v38 = [v16 linkEngine];
      v39 = [v16 linkUniqueName];
      [v38 linkDidDisconnect:v39];
    }

    v40 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      v41 = (&_IDSStunCandidatePairStateStrings)[v84];
      *buf = 136315650;
      prots = v41;
      v93 = 2080;
      v94 = off_1EB2B43D8;
      v95 = 2112;
      v96 = v87;
      _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v80 = off_1EB2B43D8;
        v82 = v87;
        v77 = (&_IDSStunCandidatePairStateStrings)[v84];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v80 = off_1EB2B43D8;
          v82 = v87;
          v77 = (&_IDSStunCandidatePairStateStrings)[v84];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    v42 = [IDSFoundationLog GlobalLink:v77];
    if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
    {
      v43 = [v16 candidatePairToken];
      *buf = 138412290;
      prots = v43;
      _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "Disconnecting unconnected QUIC connection %@ after successful unallocbind response", buf, 0xCu);
    }

    nwLink = self->_nwLink;
    v45 = [v16 sessionID];
    v46 = [v16 local];
    v47 = [v46 address];
    v48 = [v16 remote];
    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", v45, v47, [v48 external], 1, 5.0);

    if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0])
    {
LABEL_70:
      if ([v16 pendingNoSessionStateAllocbind])
      {
        [v16 setState:1];
        v74 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
        {
          v75 = (&_IDSStunCandidatePairStateStrings)[v84];
          *buf = 136315650;
          prots = v75;
          v93 = 2080;
          v94 = off_1EB2B43B0;
          v95 = 2112;
          v96 = v87;
          _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
            }
          }
        }
      }

      goto LABEL_77;
    }

    v83 = _Block_copy(self->_connectReadyHandler);
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      prots = self;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "failed to connect GlobalLink %@ due to session connected message timed out.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v78 = self;
        _IDSLogTransport(@"GL", @"IDS", @"failed to connect GlobalLink %@ due to session connected message timed out.");
        if (_IDSShouldLog())
        {
          v78 = self;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to connect GlobalLink %@ due to session connected message timed out.");
        }
      }
    }

    v50 = [v16 local];
    v51 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
    {
      v52 = (&_IDSStunTransportStrings)[[v50 transport]];
      *buf = 136315394;
      prots = v52;
      v93 = 1024;
      LODWORD(v94) = 22;
      _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v79 = (&_IDSStunTransportStrings)[[v50 transport]];
        v81 = 22;
        _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
        if (_IDSShouldLog())
        {
          v79 = (&_IDSStunTransportStrings)[[v50 transport]];
          v81 = 22;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
        }
      }
    }

    GLUtilReportAWDClientTimerEvent(305, 22, v16, self->_enableSKE, self->_isInitiator, 0.0);
    v53 = GLUCreateQRClientTimeEvent(305, 22, v16, self->_timeBase, 0.0);
    v54 = objc_loadWeakRetained(&self->_delegate);
    v55 = objc_opt_respondsToSelector();

    if (v55)
    {
      v56 = objc_loadWeakRetained(&self->_delegate);
      [v56 link:self didAddQREvent:v53];
    }

    if ([v16 isSelfQRSession])
    {

LABEL_77:
      goto LABEL_78;
    }

    if (v83)
    {
      v62 = MEMORY[0x1E696ABC0];
      v63 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"SessionConnected message timed out." forKey:*MEMORY[0x1E696A578]];
      v64 = [v62 errorWithDomain:@"GlobalLink" code:9 userInfo:v63];

      v65 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7BC65C4;
      block[3] = &unk_1E77DD0F0;
      v89 = v64;
      v90 = v83;
      v66 = v64;
      dispatch_async(v65, block);
    }

    else
    {
      v72 = objc_loadWeakRetained(&self->_delegate);
      v73 = objc_opt_respondsToSelector();

      if ((v73 & 1) == 0)
      {
LABEL_69:

        goto LABEL_70;
      }

      v66 = objc_loadWeakRetained(&self->_delegate);
      [v66 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_69;
  }

  v18 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    prots = [v13 transactionID];
    v19 = "_processQUICUnallocbindResponse: %llu not pending proto request";
    goto LABEL_10;
  }

LABEL_78:

  return 1;
}

- (BOOL)_processQUICReallocIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v11 = *&a5;
  v151 = *MEMORY[0x1E69E9840];
  v14 = a3;
  v116 = a4;
  v15 = a8;
  Value = 0;
  if (v15 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v15);
  }

  v17 = Value;
  v18 = [v14 reallocateIndication];
  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    v20 = [v18 txnId];
    *buf = 134218242;
    *&buf[4] = v20;
    *&buf[12] = 2112;
    *&buf[14] = v15;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive realloc indication(%llu) on %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v88 = [v18 txnId];
      v92 = v15;
      _IDSLogTransport(@"GL", @"IDS", @"receive realloc indication(%llu) on %@");
      if (_IDSShouldLog())
      {
        v88 = [v18 txnId];
        v92 = v15;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc indication(%llu) on %@");
      }
    }
  }

  if (v18)
  {
    v21 = stunMessageTypeFromProtoMessageType([v14 messageType], 0);
    v117 = [v18 reallocateToken];
    if ([v117 length])
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *&buf[4] = v117;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive realloc token %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v88 = v117;
          _IDSLogTransport(@"GL", @"IDS", @"receive realloc token %@");
          if (_IDSShouldLog())
          {
            v88 = v117;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc token %@");
          }
        }
      }

      v115 = [v18 clientAddress];
      v114 = [v18 serverAddress];
      *&v23 = 0xAAAAAAAAAAAAAAAALL;
      *(&v23 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v149 = v23;
      v150 = v23;
      v147 = v23;
      v148 = v23;
      v145 = v23;
      v146 = v23;
      *buf = v23;
      *&buf[16] = v23;
      v24 = IPPortStringToSA(v114, buf);
      if (IsValidSA(v24))
      {
        v25 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
        {
          *v136 = 138412290;
          *&v136[4] = v114;
          _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "receive new relay server address [%@].", v136, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v89 = v114;
            _IDSLogTransport(@"GL", @"IDS", @"receive new relay server address [%@].");
            if (_IDSShouldLog())
            {
              v89 = v114;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new relay server address [%@].");
            }
          }
        }

        *&v26 = 0xAAAAAAAAAAAAAAAALL;
        *(&v26 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v142 = v26;
        v143 = v26;
        v140 = v26;
        v141 = v26;
        v138 = v26;
        v139 = v26;
        *v136 = v26;
        v137 = v26;
        v27 = IPPortStringToSA(v115, v136);
        if (IsValidSA(v27))
        {
          v28 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
          {
            *v129 = 138412290;
            *&v129[4] = v115;
            _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "receive client address [%@].", v129, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v89 = v115;
              _IDSLogTransport(@"GL", @"IDS", @"receive client address [%@].");
              if (_IDSShouldLog())
              {
                v89 = v115;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive client address [%@].");
              }
            }
          }

          v113 = [v17 sessionID];
          if (v113)
          {
            v112 = [v17 linkEngine];
            v110 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v113];
            if (v112)
            {
              if (v110)
              {
                v134 = 0u;
                v135 = 0u;
                v132 = 0u;
                v133 = 0u;
                v130 = 0u;
                v131 = 0u;
                memset(v129, 0, sizeof(v129));
                if (buf[1] == 30)
                {
                  v29 = v129;
                }

                else
                {
                  v29 = buf;
                }

                if (buf[1] == 30)
                {
                  v30 = buf;
                }

                else
                {
                  v30 = v129;
                }

                [v110 setServerAddress:v29];
                [v110 setServerAddressV6:v30];
                *&v31 = 0xAAAAAAAAAAAAAAAALL;
                *(&v31 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v128[6] = v31;
                v128[7] = v31;
                v128[4] = v31;
                v128[5] = v31;
                v128[2] = v31;
                v128[3] = v31;
                v128[0] = v31;
                v128[1] = v31;
                v32 = [v18 serverIpAddressV4];
                v33 = IPPortStringToSA(v32, v128);

                if (IsValidSA(v33))
                {
                  v34 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
                  {
                    v35 = SAToIPString(v33);
                    *v120 = 138412290;
                    *&v120[4] = v35;
                    _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "realloc provided explicit ipv4 address: %@", v120, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v90 = SAToIPString(v33);
                      _IDSLogTransport(@"GL", @"IDS", @"realloc provided explicit ipv4 address: %@");

                      if (_IDSShouldLog())
                      {
                        v90 = SAToIPString(v33);
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc provided explicit ipv4 address: %@");
                      }
                    }
                  }

                  [v110 setServerAddress:{v128, v90}];
                }

                *&v36 = 0xAAAAAAAAAAAAAAAALL;
                *(&v36 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v126 = v36;
                v127 = v36;
                v124 = v36;
                v125 = v36;
                v122 = v36;
                v123 = v36;
                *v120 = v36;
                v121 = v36;
                v37 = [v18 serverIpAddressV6];
                v38 = IPPortStringToSA(v37, v120);

                if (IsValidSA(v38))
                {
                  v39 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
                  {
                    v40 = SAToIPString(v38);
                    *v118 = 138412290;
                    v119 = v40;
                    _os_log_impl(&dword_1A7AD9000, v39, OS_LOG_TYPE_DEFAULT, "realloc provided explicit ipv6 address: %@", v118, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v90 = SAToIPString(v38);
                      _IDSLogTransport(@"GL", @"IDS", @"realloc provided explicit ipv6 address: %@");

                      if (_IDSShouldLog())
                      {
                        v90 = SAToIPString(v38);
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc provided explicit ipv6 address: %@");
                      }
                    }
                  }

                  [v110 setServerAddressV6:{v120, v90}];
                }

                [v110 setHasReceivedReallocIndication:1];
                [v110 setSessionToken:v117];
                [(IDSGlobalLink *)self _updateLinksForSession:v110];
              }

              else
              {
                v67 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
                {
                  *v129 = 0;
                  _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "failed to process QUIC Realloc indication: no session", v129, 2u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"failed to process QUIC Realloc indication: no session");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process QUIC Realloc indication: no session");
                    }
                  }
                }
              }
            }

            else
            {
              v57 = [v17 local];
              v108 = [v57 radioAccessTechnology];

              v58 = [v17 remote];
              keya = [v58 radioAccessTechnology];

              v59 = [v17 local];
              v104 = [v59 mtu];

              v60 = [v17 remote];
              v102 = [v60 mtu];

              v109 = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:v108 mtu:v104 index:v11 address:a6 external:0];
              v103 = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:keya mtu:v102 index:0xFFFFFFFFLL address:0 external:buf];
              v105 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v109 remoteCandidate:v103 sessionID:v113 delegate:self];
              if (a6->sa_family == 30 && buf[1] == 2)
              {
                FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, v11);
                if (!FirstPrefix)
                {
                  v87 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v87, OS_LOG_TYPE_DEFAULT))
                  {
                    *v129 = 67109120;
                    *&v129[4] = v11;
                    _os_log_impl(&dword_1A7AD9000, v87, OS_LOG_TYPE_DEFAULT, "failed to get nat64 prefix for realloc (if:%d).", v129, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"failed to get nat64 prefix for realloc (if:%d).");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get nat64 prefix for realloc (if:%d).");
                      }
                    }
                  }

                  v42 = 0;
                  goto LABEL_143;
                }

                v62 = [v105 local];
                [v62 setPrefix:FirstPrefix];

                [v105 synthesizeNat64WithPrefix];
              }

              key = [v105 candidatePairToken];
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              if (tokenToCandidatePairs && key && (v64 = CFDictionaryGetValue(tokenToCandidatePairs, key)) != 0)
              {
                v65 = v64;
                v66 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
                {
                  *v129 = 138412290;
                  *&v129[4] = key;
                  _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, "found existing candidate pair for %@.", v129, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v91 = key;
                    _IDSLogTransport(@"GL", @"IDS", @"found existing candidate pair for %@.");
                    if (_IDSShouldLog())
                    {
                      v91 = key;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"found existing candidate pair for %@.");
                    }
                  }
                }
              }

              else
              {
                v68 = [v17 channelNumber];
                IDSSimpleUInt16List_AddItem(&self->_reallocChannelList, v68);
                v69 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v69, OS_LOG_TYPE_DEFAULT))
                {
                  v97 = [v117 length];
                  v99 = [v17 relaySessionKey];
                  v70 = [v99 length];
                  v71 = [v17 channelNumber];
                  *v129 = 138413314;
                  *&v129[4] = v17;
                  *&v129[12] = 2048;
                  *&v129[14] = v97;
                  *&v129[22] = 2048;
                  *&v129[24] = v70;
                  LOWORD(v130) = 1024;
                  *(&v130 + 2) = __rev16(v68);
                  WORD3(v130) = 1024;
                  DWORD2(v130) = v71;
                  _os_log_impl(&dword_1A7AD9000, v69, OS_LOG_TYPE_DEFAULT, "start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).", v129, 0x2Cu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v100 = [v117 length];
                    v72 = [v17 relaySessionKey];
                    v73 = [v72 length];
                    v96 = [v17 channelNumber];
                    v98 = __rev16(v68);
                    v94 = v73;
                    v95 = v98;
                    v91 = v17;
                    v93 = v100;
                    _IDSLogTransport(@"GL", @"IDS", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");

                    if (_IDSShouldLog())
                    {
                      v101 = [v117 length];
                      v74 = [v17 relaySessionKey];
                      v75 = [v74 length];
                      v95 = v98;
                      v96 = [v17 channelNumber];
                      v93 = v101;
                      v94 = v75;
                      v91 = v17;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");
                    }
                  }
                }

                v76 = v105;
                [v76 setPropertiesWithReallocCandidatePair:v17 reallocToken:v117];
                v77 = [v76 remote];
                -[IDSGlobalLink _setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:](self, "_setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:", v76, a6, [v77 external], v68);

                if (!self->_tokenToCandidatePairs)
                {
                  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                  v79 = self->_tokenToCandidatePairs;
                  self->_tokenToCandidatePairs = Mutable;
                }

                v65 = v76;
                if (v65)
                {
                  CFDictionarySetValue(self->_tokenToCandidatePairs, key, v65);
                }

                else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E1498C();
                }
              }

              [v65 setIsRealloc:{1, v91, v93, v94, v95, v96}];
              -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", key, 1, 0, 1, [v65 pendingNoSessionStateAllocbind]);
              if (!self->_reallocNewCandidatePairToOldCandidatePair)
              {
                v80 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
                self->_reallocNewCandidatePairToOldCandidatePair = v80;
              }

              v82 = v17;
              if (v82)
              {
                CFDictionarySetValue(self->_reallocNewCandidatePairToOldCandidatePair, key, v82);
              }

              else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
              {
                sub_1A7E14BA4();
              }
            }

            GLUtilReportAWDStunMessageEventWithType(v21, 0, v17, 0.0);
            v109 = GLUCreateQRStunMessageEventWithType(v21, 0, v17, 0, 0.0);
            if (v109)
            {
              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              v84 = objc_opt_respondsToSelector();

              if (v84)
              {
                v85 = objc_loadWeakRetained(&self->_delegate);
                [v85 link:self didAddQREvent:v109];
              }
            }

            [(IDSGFTMetricsCollector *)self->_metricsCollector hasRealloc];
            v42 = 1;
LABEL_143:

            goto LABEL_145;
          }

          v54 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
          {
            *v129 = 138412290;
            *&v129[4] = v15;
            _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@.", v129, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@.");
              }
            }
          }

          GLUtilReportAWDStunMessageEventWithType(v21, 6, v17, 0.0);
          v112 = GLUCreateQRStunMessageEventWithType(v21, 6u, v17, 0, 0.0);
          if (v112)
          {
            v55 = objc_loadWeakRetained(&self->_delegate);
            v56 = objc_opt_respondsToSelector();

            if (v56)
            {
              v111 = objc_loadWeakRetained(&self->_delegate);
              [v111 link:self didAddQREvent:v112];
              v42 = 0;

LABEL_145:
              goto LABEL_146;
            }
          }
        }

        else
        {
          v51 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
          {
            *v129 = 0;
            _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_ERROR, "invalid client address.", v129, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            _IDSWarnV();
            _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid client address.");
            _IDSLogTransport(@"Warning", @"IDS", @"invalid client address.");
          }

          GLUtilReportAWDStunMessageEventWithType(v21, 4, v17, 0.0);
          v113 = GLUCreateQRStunMessageEventWithType(v21, 4u, v17, 0, 0.0);
          if (!v113 || (v52 = objc_loadWeakRetained(&self->_delegate), v53 = objc_opt_respondsToSelector(), v52, (v53 & 1) == 0))
          {
            v42 = 0;
LABEL_146:

            goto LABEL_147;
          }

          v112 = objc_loadWeakRetained(&self->_delegate);
          [v112 link:self didAddQREvent:v113];
        }

        v42 = 0;
        goto LABEL_145;
      }

      v46 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
      {
        *v136 = 0;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_ERROR, "invalid realloc server address.", v136, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        _IDSWarnV();
        _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid realloc server address.");
        _IDSLogTransport(@"Warning", @"IDS", @"invalid realloc server address.");
      }

      GLUtilReportAWDStunMessageEventWithType(v21, 3, v17, 0.0);
      v47 = GLUCreateQRStunMessageEventWithType(v21, 3u, v17, 0, 0.0);
      if (v47)
      {
        v48 = objc_loadWeakRetained(&self->_delegate);
        v49 = objc_opt_respondsToSelector();

        if (v49)
        {
          v50 = objc_loadWeakRetained(&self->_delegate);
          [v50 link:self didAddQREvent:v47];
        }
      }
    }

    else
    {
      v43 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v43, OS_LOG_TYPE_ERROR))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_ERROR, "failed to receive realloc token.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        _IDSWarnV();
        _IDSLogV(0, @"IDSFoundation", @"Warning", @"failed to receive realloc token.");
        _IDSLogTransport(@"Warning", @"IDS", @"failed to receive realloc token.");
      }

      GLUtilReportAWDStunMessageEventWithType(v21, 2, v17, 0.0);
      v115 = GLUCreateQRStunMessageEventWithType(v21, 2u, v17, 0, 0.0);
      if (!v115 || (v44 = objc_loadWeakRetained(&self->_delegate), v45 = objc_opt_respondsToSelector(), v44, (v45 & 1) == 0))
      {
        v42 = 0;
LABEL_148:

        goto LABEL_149;
      }

      v114 = objc_loadWeakRetained(&self->_delegate);
      [v114 link:self didAddQREvent:v115];
    }

    v42 = 0;
LABEL_147:

    goto LABEL_148;
  }

  v41 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_processReallocIndication failed due to invalid reallocateIndication.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_processReallocIndication failed due to invalid reallocateIndication.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_processReallocIndication failed due to invalid reallocateIndication.");
      }
    }
  }

  v42 = 0;
LABEL_149:

  return v42;
}

- (BOOL)_processQUICDiagnosticIndication:(id)a3 candidatePairToken:(id)a4 arrivalTime:(double)a5
{
  v29 = *MEMORY[0x1E69E9840];
  v7 = a3;
  v8 = a4;
  v9 = [MEMORY[0x1E69A60F0] sharedInstance];
  v10 = [v9 isInternalInstall];

  if (v10)
  {
    v11 = [v7 diagnosticIndication];
    v12 = v11;
    if (v11)
    {
      v13 = [v11 failureSubtype];
      v14 = [v12 failureSubtypeContext];
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134218498;
        v24 = [v12 txnId];
        v25 = 2112;
        v26 = v13;
        v27 = 2112;
        v28 = v14;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "receive diagnostic indication(%llu) subtype [%@] context [%@}", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v21 = v13;
          v22 = v14;
          v20 = [v12 txnId];
          _IDSLogTransport(@"GL", @"IDS", @"receive diagnostic indication(%llu) subtype [%@] context [%@}");
          if (_IDSShouldLog())
          {
            v16 = [v12 txnId];
            v21 = v13;
            v22 = v14;
            v20 = v16;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive diagnostic indication(%llu) subtype [%@] context [%@}");
          }
        }
      }

      v17 = -[IDSGlobalLink _triggerSymptomsWithCandidatePairToken:subType:subTypeContext:duration:](self, "_triggerSymptomsWithCandidatePairToken:subType:subTypeContext:duration:", v8, v13, v14, [v12 packetsRecordDuration]);
    }

    else
    {
      v18 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_processDiagnosticIndication failed due to invalid diagnosticIndication.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"_processDiagnosticIndication failed due to invalid diagnosticIndication.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_processDiagnosticIndication failed due to invalid diagnosticIndication.");
          }
        }
      }

      v17 = 0;
    }
  }

  else
  {
    v17 = 1;
  }

  return v17;
}

- (BOOL)_processQUICGoAwayIndication:(id)a3 fromDevice:(id)a4 localIfIndex:(unsigned int)a5 localAddress:(sockaddr *)a6 remoteAddress:(sockaddr *)a7 candidatePairToken:(id)a8 arrivalTime:(double)a9
{
  v67 = *MEMORY[0x1E69E9840];
  v14 = a3;
  v46 = a4;
  v15 = a8;
  Value = 0;
  if (v15 && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, v15);
  }

  v17 = Value;
  v45 = v14;
  v18 = [v14 goAwayIndication];
  v19 = v18;
  if (v18)
  {
    v43 = [v18 reasonCode];
    v44 = [v19 reasonString];
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134218754;
      v60 = [v19 txnId];
      v61 = 2112;
      v62 = v15;
      v63 = 1024;
      v64 = v43;
      v65 = 2112;
      v66 = v44;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "receive goaway indication(%llu) for %@, error_code(%u) reason(%@).", buf, 0x26u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v41 = v43;
        v42 = v44;
        v38 = [v19 txnId];
        v40 = v15;
        _IDSLogTransport(@"GL", @"IDS", @"receive goaway indication(%llu) for %@, error_code(%u) reason(%@).");
        if (_IDSShouldLog())
        {
          v21 = [v19 txnId];
          v41 = v43;
          v42 = v44;
          v38 = v21;
          v40 = v15;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive goaway indication(%llu) for %@, error_code(%u) reason(%@).");
        }
      }
    }

    v22 = [v19 serverBlob];
    if ([v22 length])
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = [v22 length];
        *buf = 134217984;
        v60 = v24;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "This goaway has QR Server data blob(%luB)", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v39 = [v22 length];
          _IDSLogTransport(@"GL", @"IDS", @"This goaway has QR Server data blob(%luB)");
          if (_IDSShouldLog())
          {
            v39 = [v22 length];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"This goaway has QR Server data blob(%luB)");
          }
        }
      }

      v25 = MEMORY[0x1E695DF20];
      v26 = [v17 sessionID];
      v27 = [v25 dictionaryWithObject:v22 forKey:v26];
      QRServerDataBlob = self->_QRServerDataBlob;
      self->_QRServerDataBlob = v27;
    }

    [(IDSGroupQUICMaterialExchangeProvider *)self->_quicMaterialExchangeProvider invalidate];
    if (self->_useLinkEngine)
    {
      sessionsByID = self->_sessionsByID;
      v30 = [v17 sessionID];
      v31 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:v30];

      if ([v31 wantsToBeConnected])
      {
        [v31 willDisconnect];
        v32 = [v31 linkEngine];
        [v32 scheduleUpdate];

        v57[0] = MEMORY[0x1E69E9820];
        v57[1] = 3221225472;
        v57[2] = sub_1A7BC85DC;
        v57[3] = &unk_1E77E0818;
        v31 = v31;
        v58 = v31;
        [v31 startSessionGoAwayTimer:5 block:v57];
      }
    }

    else
    {
      [v17 setIsDisconnecting:1];
      v53[0] = MEMORY[0x1E69E9820];
      v53[1] = 3221225472;
      v53[2] = sub_1A7BC86C4;
      v53[3] = &unk_1E77E0E18;
      v54 = v15;
      v55 = v17;
      v56 = self;
      [v55 startSessionGoAwayTimer:5 block:v53];

      v31 = v54;
    }

    v34 = [(IDSGlobalLink *)self _getQRAllocateType];
    v35 = *&a7->sa_data[2];
    v36 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BC88C0;
    block[3] = &unk_1E77E0E88;
    block[4] = self;
    v49 = v34;
    v48 = v17;
    v50 = a9;
    v52 = v43;
    v51 = v35;
    dispatch_async(v36, block);

    [(IDSGFTMetricsCollector *)self->_metricsCollector hasGoaway];
  }

  else
  {
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_processGoAwayIndication failed due to invalid goAwayIndication.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_processGoAwayIndication failed due to invalid goAwayIndication.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_processGoAwayIndication failed due to invalid goAwayIndication.");
        }
      }
    }
  }

  return v19 != 0;
}

- (BOOL)_processProtoPacket:(id *)a3 fromDeviceUniqueID:(id)a4 cbuuid:(id)a5 arrivalTime:(double)a6 headerOverhead:(unint64_t)a7
{
  v103 = *MEMORY[0x1E69E9840];
  v60 = a4;
  v59 = a5;
  var31 = a3->var31;
  if (a3->var35 && a3->var34 != 7)
  {
    p_super = 0;
LABEL_9:
    var34 = a3->var34;
    v13 = @"error_response";
    goto LABEL_10;
  }

  v13 = [MEMORY[0x1E695DEF0] dataWithBytesNoCopy:a3->var0 length:a3->var2 freeWhenDone:0];
  if (!v13)
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17B00();
    }

    goto LABEL_43;
  }

  v14 = [[IDSQRProtoMessage alloc] initWithData:v13];
  if (!v14)
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17A64(v13, p_super);
    }

    goto LABEL_43;
  }

  p_super = &v14->super;

  if (a3->var35)
  {
    goto LABEL_9;
  }

  v16 = [p_super messageType];
  var34 = v16;
  if (v16 >= 0x29)
  {
    v13 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", v16];
  }

  else
  {
    v13 = off_1E77E1408[v16];
  }

  [p_super setTransactionID:var31];
LABEL_10:
  v18 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
  {
    var35 = a3->var35;
    *buf = 138413314;
    *&buf[4] = v13;
    *&buf[12] = 1024;
    *&buf[14] = var34;
    *&buf[18] = 2048;
    *&buf[20] = var31;
    *&buf[28] = 1024;
    *&buf[30] = var35;
    *&buf[34] = 2112;
    *&buf[36] = p_super;
    _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "received %@[%d](%llu) error %u proto message %@", buf, 0x2Cu);
  }

  [(IDSGlobalLink *)self _startTimeForProtoRequest:var31];
  v21 = v20;
  [p_super setStartTime:?];
  v22 = [(IDSGlobalLink *)self _tokenForProtoRequest:var31];
  if (v22)
  {
    goto LABEL_17;
  }

  if (var34 <= 0x24 && ((1 << var34) & 0x1084027218) != 0)
  {
    v23 = a3->var32;
    if (v23)
    {
      v24 = v23;
      v22 = tokenForStunCandidatePair(&a3->var18, &a3->var19, v23);

LABEL_17:
      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      if (tokenToCandidatePairs && v22 && (v26 = CFDictionaryGetValue(tokenToCandidatePairs, v22)) != 0)
      {
        v27 = v26;
        if ([v26 isActive])
        {
          v28 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          if (v28)
          {
            v28[39] = a6;
          }
        }

        else
        {
          [v27 setLastIncomingPacketTime:a6];
        }

        -[IDSGlobalLink didReceiveProtobufPacketForLinkID:](self, "didReceiveProtobufPacketForLinkID:", [v27 linkID]);
        switch(var34)
        {
          case 1u:
          case 5u:
          case 7u:
          case 0xAu:
          case 0xFu:
          case 0x12u:
          case 0x14u:
          case 0x16u:
            v31 = [v27 processQUICErrorResponse:p_super packetBuffer:a3 startTime:a7 headerOverhead:v21];
            goto LABEL_87;
          case 2u:
            v31 = [(IDSGlobalLink *)self _processNWLinkAllocbindResponse:p_super fromDevice:v60 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:v22 arrivalTime:a6];
            goto LABEL_87;
          case 3u:
            v30 = [(IDSGlobalLink *)self _processQUICDiagnosticIndication:p_super candidatePairToken:v22 arrivalTime:a6];

            goto LABEL_92;
          case 4u:
            v30 = [(IDSGlobalLink *)self _processQUICGoAwayIndication:p_super fromDevice:v60 localIfIndex:a3->var17 localAddress:&a3->var18 remoteAddress:&a3->var19 candidatePairToken:v22 arrivalTime:a6];

            goto LABEL_92;
          case 6u:
            v31 = [v27 processQUICInfoResponse:p_super receivedBytes:a3->var2 + a7];
            goto LABEL_87;
          case 8u:
            v31 = [v27 processQUICParticipantUpdateResponse:p_super];
            goto LABEL_87;
          case 9u:
            v30 = [v27 processQUICParticipantUpdateIndication:p_super];

            goto LABEL_92;
          case 0xBu:
            v31 = [v27 processQUICPluginRegistrationResponse:p_super];
            goto LABEL_87;
          case 0xCu:
            v30 = [v27 processQUICPluginControlIndication:p_super];

            goto LABEL_92;
          case 0xDu:
            v30 = [v27 processQUICErrorIndication:p_super];

            goto LABEL_92;
          case 0xEu:
            v34 = *&a3->var18.__ss_pad2[64];
            v99 = *&a3->var18.__ss_pad2[48];
            v100 = v34;
            v35 = *&a3->var18.__ss_pad2[96];
            v101 = *&a3->var18.__ss_pad2[80];
            v102 = v35;
            v36 = *a3->var18.__ss_pad2;
            *buf = *&a3->var18.ss_len;
            *&buf[16] = v36;
            v37 = *&a3->var18.__ss_pad2[32];
            *&buf[32] = *&a3->var18.__ss_pad2[16];
            v98 = v37;
            v38 = *&a3->var19.__ss_pad2[64];
            v39 = *&a3->var19.__ss_pad2[80];
            v93 = *&a3->var19.__ss_pad2[48];
            v94 = v38;
            v40 = *&a3->var19.__ss_pad2[96];
            v95 = v39;
            v96 = v40;
            v41 = *a3->var19.__ss_pad2;
            v89 = *&a3->var19.ss_len;
            v90 = v41;
            v42 = *&a3->var19.__ss_pad2[32];
            v91 = *&a3->var19.__ss_pad2[16];
            v92 = v42;
            var17 = a3->var17;
            aBlock[0] = MEMORY[0x1E69E9820];
            aBlock[1] = 3221225472;
            aBlock[2] = sub_1A7BC96D4;
            aBlock[3] = &unk_1E77E0EB0;
            aBlock[4] = self;
            v68 = p_super;
            v69 = v60;
            v88 = var17;
            v75 = v99;
            v76 = v100;
            v77 = v101;
            v78 = v102;
            v71 = *buf;
            v72 = *&buf[16];
            v73 = *&buf[32];
            v74 = v98;
            v85 = v95;
            v86 = v96;
            v83 = v93;
            v84 = v94;
            v81 = v91;
            v82 = v92;
            v79 = v89;
            v80 = v90;
            v44 = v22;
            v70 = v44;
            v87 = a6;
            v45 = _Block_copy(aBlock);
            v46 = [v27 state];
            if (v46 > 3)
            {
              v45[2](v45);
            }

            else
            {
              v47 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
              {
                v48 = _Block_copy(v45);
                v49 = (&_IDSStunCandidatePairStateStrings)[v46];
                *v61 = 134218498;
                v62 = v48;
                v63 = 2112;
                v64 = v44;
                v65 = 2080;
                v66 = v49;
                _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "delay processing realloc block %p for %@, state [%s].", v61, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v50 = _Block_copy(v45);
                  _IDSLogTransport(@"GL", @"IDS", @"delay processing realloc block %p for %@, state [%s].");

                  if (_IDSShouldLog())
                  {
                    v51 = _Block_copy(v45);
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing realloc block %p for %@, state [%s].");
                  }
                }
              }

              if (!self->_tokenToReallocBlocks)
              {
                Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                tokenToReallocBlocks = self->_tokenToReallocBlocks;
                self->_tokenToReallocBlocks = Mutable;
              }

              v54 = _Block_copy(v45);
              if (v54)
              {
                CFDictionarySetValue(self->_tokenToReallocBlocks, v44, v54);
              }

              else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
              {
                sub_1A7E14C48();
              }
            }

            v30 = 1;
            goto LABEL_92;
          case 0x10u:
            v31 = [v27 processQUICSessionInfoResponse:p_super receivedBytes:a3->var2 + a7 isLightweightParticipant:self->_isLightweightParticipant];
            goto LABEL_87;
          case 0x11u:
            v30 = [v27 processQUICSessionInfoIndication:p_super arrivalTime:self->_isLightweightParticipant isLightweightParticipant:a6];

            goto LABEL_92;
          case 0x13u:
            v31 = [v27 processQUICStatsResponse:p_super arrivalTime:a6];
            goto LABEL_87;
          case 0x15u:
            v31 = [v27 processQUICTestResponse:p_super arrivalTime:a6];
            goto LABEL_87;
          case 0x17u:
            v31 = [(IDSGlobalLink *)self _processQUICUnallocbindResponse:p_super fromDevice:v60 localIfIndex:a3->var17 localAddress:&a3->var18 remmoteAddress:&a3->var19 candidatePairToken:v22 arrivalTime:a6];
            goto LABEL_87;
          case 0x19u:
            v31 = [v27 processQUICPutMaterialResponse:p_super];
            goto LABEL_87;
          case 0x1Au:
            v30 = [v27 processQUICPutMaterialIndication:p_super];

            goto LABEL_92;
          case 0x1Cu:
            v31 = [v27 processQUICGetMaterialResponse:p_super];
            goto LABEL_87;
          case 0x1Du:
          case 0x20u:
            v31 = [(IDSGlobalLink *)self _processReliableUnicastRegistrationErrorResponse:p_super packetBuffer:a3 startTime:v27 candidatePair:v21];
            goto LABEL_87;
          case 0x1Eu:
            v31 = [(IDSGlobalLink *)self _processRegisterResponse:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x1Fu:
            v31 = [(IDSGlobalLink *)self _processRegisterIndication:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x21u:
            v31 = [(IDSGlobalLink *)self _processRegisterAckResponse:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x26u:
            v31 = [v27 processQUICCallModeUpdateResponse:p_super];
            goto LABEL_87;
          case 0x28u:
            v31 = [v27 processQUICChannelConfigResponse:p_super];
LABEL_87:
            v30 = v31;
            break;
          default:
            v58 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
            {
              sub_1A7E179F4();
            }

            v30 = 0;
            break;
        }

        v55 = a3->var35;
        if (v55)
        {
          v56 = v55;
        }

        else
        {
          v56 = 200;
        }

        [(IDSGlobalLink *)self _removeProtoRequest:var31 status:v56];
      }

      else
      {
        v29 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *&buf[4] = v22;
          _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for incoming proto message, candidagePairToken = %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for incoming proto message, candidagePairToken = %@");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for incoming proto message, candidagePairToken = %@");
            }
          }
        }

        v30 = 0;
      }

LABEL_92:

      goto LABEL_93;
    }

    v32 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v13;
      _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@");
        }
      }
    }

LABEL_43:
    v30 = 0;
    goto LABEL_93;
  }

  v33 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    *&buf[4] = var31;
    *&buf[12] = 2112;
    *&buf[14] = v13;
    _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "no matching request with QUIC transactionID %llu for %@ proto message, ignore.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"no matching request with QUIC transactionID %llu for %@ proto message, ignore.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"no matching request with QUIC transactionID %llu for %@ proto message, ignore.");
      }
    }
  }

  v30 = 1;
LABEL_93:

  return v30;
}

- (void)_updateCandidatePair:(id)a3 newLocalPort:(unsigned __int16)a4
{
  v4 = a4;
  v6 = a3;
  tokenToCandidatePairs = self->_tokenToCandidatePairs;
  v8 = [v6 candidatePairToken];
  [(NSMutableDictionary *)tokenToCandidatePairs removeObjectForKey:v8];

  v9 = [v6 local];
  [v9 setLocalPort:v4];

  if (!self->_tokenToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v11 = self->_tokenToCandidatePairs;
    self->_tokenToCandidatePairs = Mutable;
  }

  v12 = v6;
  v13 = v12;
  if (v12)
  {
    v14 = self->_tokenToCandidatePairs;
    v15 = [v12 candidatePairToken];
    CFDictionarySetValue(v14, v15, v13);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17B3C();
  }
}

- (void)_saveProtoRequest:(id)a3 token:(id)a4 path:(id)a5
{
  v42 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = [v8 transactionID];
  [v8 startTime];
  v13 = v12;
  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v37 = v11;
    v38 = 2048;
    v39 = v13;
    v40 = 2112;
    v41 = v9;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "_saveProtoRequest %llu %.3f for %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = v9;
      v34 = v13;
      v33 = v11;
      _IDSLogTransport(@"GL", @"IDS", @"_saveProtoRequest %llu %.3f for %@");
      if (_IDSShouldLog())
      {
        v35 = v9;
        v34 = v13;
        v33 = v11;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_saveProtoRequest %llu %.3f for %@");
      }
    }
  }

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  if (!transactionIDToRequestMetadata)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v17 = self->_transactionIDToRequestMetadata;
    self->_transactionIDToRequestMetadata = Mutable;

    transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  }

  v18 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{v11, v33, *&v34, v35}];
  v19 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v18];

  if (!v19)
  {
    metricsCollector = self->_metricsCollector;
    v21 = [v8 messageType];
    if (v21 >= 0x29)
    {
      v22 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", v21];
    }

    else
    {
      v22 = off_1E77E1408[v21];
    }

    v23 = [(IDSGFTMetricsCollector *)metricsCollector request:v22];

    v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:v9];
    v25 = v24;
    if (v24)
    {
      v26 = [v24 local];
      v27 = [v26 radioAccessTechnology];

      v28 = [v25 linkID];
    }

    else
    {
      v28 = 0;
      v27 = 10;
    }

    v29 = [[IDSGlobalLinkRequestMetadata alloc] initWithStartTime:v10 path:v9 token:v28 linkID:v27 localRAT:v23 metricsRequest:v13];
    v19 = v29;
    if (v29)
    {
      v30 = self->_transactionIDToRequestMetadata;
      v31 = MEMORY[0x1E696AD98];
      v32 = v29;
      CFDictionarySetValue(v30, [v31 numberWithUnsignedLongLong:v11], v32);
    }
  }
}

- (void)_removeProtoRequest:(unint64_t)a3 status:(unsigned int)a4
{
  v4 = *&a4;
  v48 = *MEMORY[0x1E69E9840];
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v37 = a3;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "_removeProtoRequest %llu", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v29 = a3;
      _IDSLogTransport(@"GL", @"IDS", @"_removeProtoRequest %llu");
      if (_IDSShouldLog())
      {
        v29 = a3;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_removeProtoRequest %llu");
      }
    }
  }

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v9 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{a3, v29}];
  v10 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v9];

  if (v10)
  {
    v11 = [v10 metricsRequest];
    [v11 receivedResponse:v4];

    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = [v10 path];
      v14 = ids_monotonic_time();
      [v10 startTime];
      v16 = v15;
      v17 = [v10 linkID];
      v18 = IDSRadioAccessTechnologyToString([v10 localRAT]);
      *buf = 138413570;
      v37 = v13;
      v38 = 2048;
      v39 = a3;
      v40 = 1024;
      v41 = v4;
      v42 = 2048;
      v43 = v14 - v16;
      v44 = 1024;
      v45 = v17;
      v46 = 2080;
      v47 = v18;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)", buf, 0x36u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v19 = [v10 path];
        v20 = ids_monotonic_time();
        [v10 startTime];
        v22 = v21;
        v34 = [v10 linkID];
        v35 = IDSRadioAccessTechnologyToString([v10 localRAT]);
        v33 = v20 - v22;
        v31 = a3;
        v32 = v4;
        v30 = v19;
        _IDSLogTransport(@"GL", @"IDS", @"%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)");

        if (_IDSShouldLog())
        {
          v23 = [v10 path];
          v24 = ids_monotonic_time();
          [v10 startTime];
          v26 = v25;
          v34 = [v10 linkID];
          v35 = IDSRadioAccessTechnologyToString([v10 localRAT]);
          v33 = v24 - v26;
          v31 = a3;
          v32 = v4;
          v30 = v23;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)");
        }
      }
    }

    v27 = self->_transactionIDToRequestMetadata;
    v28 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{a3, v30, v31, v32, *&v33, v34, v35}];
    [(NSMutableDictionary *)v27 removeObjectForKey:v28];
  }
}

- (double)_startTimeForProtoRequest:(unint64_t)a3
{
  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
  v5 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v4];

  [v5 startTime];
  v7 = v6;

  return v7;
}

- (id)_tokenForProtoRequest:(unint64_t)a3
{
  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:a3];
  v5 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v4];

  v6 = [v5 token];

  return v6;
}

- (int64_t)_sendProtoMessage:(id)a3 candidatePair:(id)a4
{
  v55 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  v7 = [v6 local];
  v32 = [v7 index];

  v8 = [v6 local];
  v9 = [v8 address];

  v10 = [v6 remote];
  v11 = [v10 external];

  v12 = [v6 local];
  v31 = [v12 transport];

  v13 = [v6 glLinkProtocol];
  v34 = [v6 candidatePairToken];
  __buf = 0xAAAAAAAAAAAAAAAALL;
  arc4random_buf(&__buf, 8uLL);
  [v5 setTransactionID:__buf];
  v14 = [v6 linkID];
  if (v14)
  {
    v15 = v14;
  }

  else
  {
    v15 = -1;
  }

  if ([v6 isVirtualRelayStunCandidatePair])
  {
    v16 = [v6 delegatedLinkID];
  }

  else
  {
    v16 = -1;
  }

  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[6] = v17;
  __str[7] = v17;
  __str[4] = v17;
  __str[5] = v17;
  __str[2] = v17;
  __str[3] = v17;
  __str[0] = v17;
  __str[1] = v17;
  v52 = v17;
  v53 = v17;
  v50 = v17;
  v51 = v17;
  v48 = v17;
  v49 = v17;
  *v46 = v17;
  v47 = v17;
  SAToIPPortString(__str, 0x80uLL, v9);
  SAToIPPortString(v46, 0x80uLL, v11);
  v18 = [v5 data];
  v19 = [v18 length];
  v20 = _IDSLinkPacketBufferCreateWithSize("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 14537, [v18 length]);
  [v18 getBytes:*v20 length:v19];
  v20[2] = v19;
  *(v20 + 44) = 1;
  v20[157] = __buf;
  if ([v5 messageType] == 1 && (objc_msgSend(v6, "isRealloc") & 1) != 0)
  {
    v21 = 14;
  }

  else
  {
    v21 = [v5 messageType];
  }

  *(v20 + 320) = v21;
  v22 = [v6 sessionID];
  v23 = v20[158];
  v20[158] = v22;

  *(v20 + 12) = v32;
  memcpy(v20 + 7, v9, *v9);
  memcpy(v20 + 23, v11, *v11);
  v24 = [(IDSGlobalLink *)self _sendPacketBuffer:v20 stunTransport:v31 glLinkProtocol:v13 token:v34 linkID:v15 delegatedLinkID:v16];
  if (v24 < 1)
  {
    v28 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      *buf = 138413058;
      v37 = v5;
      v38 = 2112;
      v39 = idsSessionID;
      v40 = 2080;
      v41 = __str;
      v42 = 2080;
      v43 = v46;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "Failed to send proto message %@ for IDSSessionID: %@ and %s-%s", buf, 0x2Au);
    }
  }

  else
  {
    v25 = +[IDSNWLink descriptionForMessageType:](IDSNWLink, "descriptionForMessageType:", [v5 messageType]);
    [(IDSGlobalLink *)self _saveProtoRequest:v5 token:v34 path:v25];

    v26 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      v27 = self->_idsSessionID;
      *buf = 138413314;
      v37 = v5;
      v38 = 2048;
      v39 = __buf;
      v40 = 2112;
      v41 = v27;
      v42 = 2080;
      v43 = __str;
      v44 = 2080;
      v45 = v46;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "send proto message %@ (%llu) for IDSSessionID: %@ and %s-%s.", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"send proto message %@ (%llu) for IDSSessionID: %@ and %s-%s.");
    }
  }

  return v24;
}

- (void)_sendQUICAllocbindRequest:(id)a3 isRealloc:(BOOL)a4 inResponseToNoSessionState:(BOOL)a5 shouldConnectLinkFirst:(BOOL)a6 isPendingInResponseToNoSessionState:(BOOL)a7
{
  v7 = a7;
  v8 = a6;
  v9 = a5;
  v10 = a4;
  v212 = *MEMORY[0x1E69E9840];
  key = a3;
  if (key)
  {
    if (self->_state >= 5 && !v9)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = _IDSLinkStateStrings[self->_state];
        *buf = 138412546;
        *v203 = key;
        *&v203[8] = 2080;
        *&v203[10] = v13;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, GL state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, GL state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, GL state [%s].");
          }
        }
      }

      goto LABEL_35;
    }

    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v171 = v10, v172 = self, v16 = CFDictionaryGetValue(tokenToCandidatePairs, key), v17 = v10, !v16))
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "send allocbind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send allocbind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send allocbind request failed due to invalid candidate pair.");
          }
        }
      }

      v18 = 0;
      goto LABEL_34;
    }

    v18 = v16;
    if ([v16 isSharedQRSession] && !self->_sharedSessionHasJoined)
    {
      v24 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "skip allocbind request, session is not yet joined!", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request, session is not yet joined!");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request, session is not yet joined!");
          }
        }
      }

      goto LABEL_34;
    }

    if (v8)
    {
      v196[1] = MEMORY[0x1E69E9820];
      v196[2] = 3221225472;
      v196[3] = sub_1A7BCC1A4;
      v196[4] = &unk_1E77E1310;
      v196[5] = self;
      v197 = v18;
      v198 = v10;
      v199 = v9;
      v200 = v7;
      v18 = v197;
      [IDSGlobalLink _connectNWLink:"_connectNWLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];
      if (([v197 isSelfQRSession] & 1) == 0)
      {
        if ([v197 isSharedQRSession])
        {
          v19 = 0;
        }

        else
        {
          v19 = 2;
        }

        [(IDSGlobalLink *)self _startAllocbindFailoverTimerOnCandidatePair:v197 delay:v19];
      }

      goto LABEL_34;
    }

    v21 = [v18 state];
    v22 = [v18 pendingRealloc];
    if (v21 == 2)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "in failed state, send allocbind request ignored", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"in failed state, send allocbind request ignored");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"in failed state, send allocbind request ignored");
          }
        }
      }

      goto LABEL_34;
    }

    v25 = v22;
    if (v21 < 3)
    {
      v10 = 1;
    }

    if ((v7 & ~v17 & v9 & 1) != 0 || (v17 & (v22 ^ 1) & 1) != 0 || !v10)
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        v33 = @"allocbind";
        v34 = (&_IDSStunCandidatePairStateStrings)[v21];
        if (v17)
        {
          v33 = @"realloc";
        }

        *buf = 138413826;
        *v203 = v33;
        v35 = @"YES";
        *&v203[8] = 2112;
        *&v203[10] = key;
        if (v25)
        {
          v36 = @"YES";
        }

        else
        {
          v36 = @"NO";
        }

        *&v203[18] = 2080;
        *&v203[20] = v34;
        if (v10)
        {
          v37 = @"NO";
        }

        else
        {
          v37 = @"YES";
        }

        v204 = 2112;
        if (v9)
        {
          v38 = @"YES";
        }

        else
        {
          v38 = @"NO";
        }

        v205 = v36;
        if (!v7)
        {
          v35 = @"NO";
        }

        v206 = 2112;
        v207 = v37;
        v208 = 2112;
        v209 = v38;
        v210 = 2112;
        v211 = v35;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@", buf, 0x48u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@");
          }
        }
      }

      goto LABEL_34;
    }

    v168 = v21;
    v167 = stunMessageTypeFromProtoMessageType(1, v17);
    v169 = v18;
    theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
    v26 = [v18 sessionID];
    v27 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    HasCandidatePairForSameSharedSession = GLUtilHasCandidatePairForSameSharedSession(v26, v27);

    if (HasCandidatePairForSameSharedSession)
    {
      v29 = 16;
    }

    else
    {
      v29 = 0;
    }

    if (v9)
    {
      v30 = v29 | 0x20;
    }

    else
    {
      v30 = v29;
    }

    v31 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v30];
    if (v31)
    {
      CFDictionarySetValue(theDict, @"gl-option-additional-binding", v31);
    }

    else
    {
      v39 = MEMORY[0x1E69E9C10];
      v40 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v39, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14CC4();
      }
    }

    if ([(IDSGlobalLink *)v172 _shouldUseQRTLE])
    {
      v41 = [v18 local];
      if ([v41 isCellularStunCandidate])
      {
        allowTLEOverCellular = v172->_allowTLEOverCellular;

        if (!allowTLEOverCellular)
        {
          goto LABEL_101;
        }
      }

      else
      {
      }

      v43 = objc_alloc_init(IDSQUICConnectionIDs);
      v44 = [(NSMutableSet *)v172->_usedLocalConnectionIDs copy];
      v196[0] = v44;
      v45 = [(IDSQUICConnectionIDs *)v43 generateLocalIDs:v196];
      v46 = v196[0];

      [(NSMutableSet *)v172->_usedLocalConnectionIDs addObjectsFromArray:v45];
      [v18 setQUICConnectionIDs:v43];
      v47 = [(IDSQUICConnectionIDs *)v43 localAVCConnectionIDData];
      if (v47)
      {
        CFDictionarySetValue(theDict, @"gl-option-qr-connection-id-avc-key", v47);
      }

      else
      {
        v48 = MEMORY[0x1E69E9C10];
        v49 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17BD4();
        }
      }

      v50 = [(IDSQUICConnectionIDs *)v43 localIDSConnectionIDData];
      if (v50)
      {
        CFDictionarySetValue(theDict, @"gl-option-qr-connection-id-ids-key", v50);
      }

      else
      {
        v51 = MEMORY[0x1E69E9C10];
        v52 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17C5C();
        }
      }
    }

LABEL_101:
    v53 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isShortMKIEnabled];
    if (v53)
    {
      CFDictionarySetValue(theDict, @"gs-shortmki-enabled-key", v53);
    }

    else
    {
      v54 = MEMORY[0x1E69E9C10];
      v55 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v54, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17CE4();
      }
    }

    v56 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isTLEEnabled];
    if (v56)
    {
      CFDictionarySetValue(theDict, @"gs-tle-enabled-key", v56);
    }

    else
    {
      v57 = MEMORY[0x1E69E9C10];
      v58 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17D6C();
      }
    }

    v59 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isPartialTLEUPlusOneEnabled];
    if (v59)
    {
      CFDictionarySetValue(theDict, @"gs-enable-qpod-vr", v59);
    }

    else
    {
      v60 = MEMORY[0x1E69E9C10];
      v61 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17DF4();
      }
    }

    v62 = v172;
    if (v172->_clientType == 6)
    {
      v63 = objc_alloc_init(IDSQRProtoCallModeUpdateInfo);
      [(IDSQRProtoCallModeUpdateInfo *)v63 setModeGenCounter:v172->_callModeUpdateGenerationCounter];
      if (v172->_isUPlusOneSession)
      {
        v64 = 1;
      }

      else
      {
        v64 = 2;
      }

      [(IDSQRProtoCallModeUpdateInfo *)v63 setFacetimeMode:v64];
      v65 = v63;
      if (v65)
      {
        CFDictionarySetValue(theDict, @"gs-started-as-u-plus-one-key", v65);
      }

      else
      {
        v66 = MEMORY[0x1E69E9C10];
        v67 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v66, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17E7C();
        }
      }

      if (_os_feature_enabled_impl())
      {
        CFDictionarySetValue(theDict, @"gs-dl-participantid-removal-supported-key", MEMORY[0x1E695E118]);
      }

      v62 = v172;
    }

    pluginNameToPluginOptionsDict = v62->_pluginNameToPluginOptionsDict;
    if (pluginNameToPluginOptionsDict && [(NSMutableDictionary *)pluginNameToPluginOptionsDict count])
    {
      v69 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v70 = v172->_pluginNameToPluginOptionsDict;
      v194[0] = MEMORY[0x1E69E9820];
      v194[1] = 3221225472;
      v194[2] = sub_1A7BCC20C;
      v194[3] = &unk_1E77E1338;
      v71 = v69;
      v195 = v71;
      [(NSMutableDictionary *)v70 enumerateKeysAndObjectsUsingBlock:v194];
      v72 = v71;
      if (v72)
      {
        CFDictionarySetValue(theDict, @"gl-option-fast-plugin-request-key", v72);
      }

      else
      {
        v73 = MEMORY[0x1E69E9C10];
        v74 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17F04();
        }
      }
    }

    v75 = [MEMORY[0x1E696AD98] numberWithBool:v172->_shouldOverrideServerTestOptionTLEDisabled];
    if (v75)
    {
      CFDictionarySetValue(theDict, @"gl-option-should-override-server-test-option-tle-disabled", v75);
    }

    else
    {
      v76 = MEMORY[0x1E69E9C10];
      v77 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v76, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17F8C();
      }
    }

    v78 = [MEMORY[0x1E696AD98] numberWithBool:v172->_serverTestOptionTLEDisabled];
    if (v78)
    {
      CFDictionarySetValue(theDict, @"gl-option-server-test-option-tle-disabled", v78);
    }

    else
    {
      v79 = MEMORY[0x1E69E9C10];
      v80 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v79, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18014();
      }
    }

    v81 = [v169 sessionID];
    if ([(NSDictionary *)v172->_QRServerDataBlob count])
    {
      v82 = [(NSDictionary *)v172->_QRServerDataBlob objectForKeyedSubscript:v81];
      v83 = v82 == 0;

      if (v83)
      {
        v84 = [(NSDictionary *)v172->_QRServerDataBlob allKeys];
        v85 = [v84 firstObject];

        v86 = [(NSDictionary *)v172->_QRServerDataBlob allValues];
        v87 = [v86 firstObject];

        QRServerDataBlob = v172->_QRServerDataBlob;
        v172->_QRServerDataBlob = 0;

        v89 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v89, OS_LOG_TYPE_DEFAULT))
        {
          v90 = [v87 length];
          *buf = 67109634;
          *v203 = v90;
          *&v203[4] = 2112;
          *&v203[6] = v85;
          *&v203[14] = 2112;
          *&v203[16] = v81;
          _os_log_impl(&dword_1A7AD9000, v89, OS_LOG_TYPE_DEFAULT, "Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@", buf, 0x1Cu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v165 = v85;
            v166 = v81;
            v162 = [v87 length];
            _IDSLogTransport(@"GL", @"IDS", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
            if (_IDSShouldLog())
            {
              v91 = [v87 length];
              v165 = v85;
              v166 = v81;
              v162 = v91;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
            }
          }
        }

        v92 = v87;
        if (v92)
        {
          CFDictionarySetValue(theDict, @"gl-option-qr-server-data-blob", v92);
        }

        else
        {
          v93 = MEMORY[0x1E69E9C10];
          v94 = MEMORY[0x1E69E9C10];
          if (os_log_type_enabled(v93, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E1809C();
          }
        }
      }
    }

    v95 = v172;
    if (v172->_idsContextBlob)
    {
      v96 = [(IDSGlobalLink *)v172 _createIDSContextBlobMaterialProto:?];
      if (v96)
      {
        CFDictionarySetValue(theDict, @"gl-option-ids-context-blob-key", v96);
      }

      else
      {
        v97 = MEMORY[0x1E69E9C10];
        v98 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v97, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E18124();
        }
      }

      v95 = v172;
    }

    if (v95->_state != 4)
    {
      CFDictionarySetValue(theDict, @"gl-option-ids-context-reason-key", &unk_1F1B200F0);
      v95 = v172;
    }

    v99 = v95->_qrSessionExperiments;
    if (v99)
    {
      CFDictionarySetValue(theDict, @"gl-option-qr-session-experiments", v99);
    }

    else
    {
      v100 = MEMORY[0x1E69E9C10];
      v101 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v100, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E181AC();
      }
    }

    v102 = v172;
    quicMaterialExchangeProvider = v172->_quicMaterialExchangeProvider;
    if (quicMaterialExchangeProvider)
    {
      v104 = [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider takeAllCurrentMaterials];
      v105 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v203 = v104;
        _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "IDSGlobalLinkOptionMaterialsKey: %@", buf, 0xCu);
      }

      [(__CFDictionary *)theDict setObject:v104 forKeyedSubscript:@"gl-option-materials-key"];
      if (v172->_isAutoDisconnectSupportedForGFTService)
      {
        if (v172->_isLightweightParticipant)
        {
          goto LABEL_187;
        }

        v106 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v106, OS_LOG_TYPE_DEFAULT))
        {
          v107 = @"NO";
          if (v172->_isAutoDisconnectSupportedForGFTService)
          {
            v108 = @"YES";
          }

          else
          {
            v108 = @"NO";
          }

          if (v172->_isLightweightParticipant)
          {
            v107 = @"YES";
          }

          *buf = 138412546;
          *v203 = v108;
          *&v203[8] = 2112;
          *&v203[10] = v107;
          _os_log_impl(&dword_1A7AD9000, v106, OS_LOG_TYPE_DEFAULT, "_isAutoDisconnectSupportedForGFTService: %@, _isLightweightParticipant: %@", buf, 0x16u);
        }

        [(__CFDictionary *)theDict setObject:MEMORY[0x1E695E118] forKeyedSubscript:@"gl-option-should-auto-disconnect-for-standard-participant"];
        if (v172->_isAutoDisconnectSupportedForGFTService)
        {
LABEL_187:
          [(__CFDictionary *)theDict setObject:MEMORY[0x1E695E118] forKeyedSubscript:@"gl-option-is-facetime-session", v162, v165, v166];
        }
      }

      v102 = v172;
    }

    v109 = [MEMORY[0x1E696AD98] numberWithBool:{v102->_isLightweightParticipant, v162}];
    if (v109)
    {
      CFDictionarySetValue(theDict, @"gl-option-is-lightweight-participant-key", v109);
    }

    else
    {
      v110 = MEMORY[0x1E69E9C10];
      v111 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v110, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18234();
      }
    }

    v112 = [MEMORY[0x1E696AD98] numberWithBool:v172->_uplinkNackDisabled];
    if (v112)
    {
      CFDictionarySetValue(theDict, @"gl-option-uplink-nack-disabled", v112);
    }

    else
    {
      v113 = MEMORY[0x1E69E9C10];
      v114 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v113, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E182BC();
      }
    }

    v192 = 0u;
    v193 = 0u;
    v190 = 0u;
    v191 = 0u;
    v115 = v172->_usedLinks;
    v116 = [(NSMutableSet *)v115 countByEnumeratingWithState:&v190 objects:v201 count:16];
    if (v116)
    {
      v117 = *v191;
      do
      {
        for (i = 0; i != v116; ++i)
        {
          if (*v191 != v117)
          {
            objc_enumerationMutation(v115);
          }

          v119 = *(*(&v190 + 1) + 8 * i);
          v120 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v120, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v203 = v119;
            _os_log_impl(&dword_1A7AD9000, v120, OS_LOG_TYPE_DEFAULT, "adding stale link to allocbind request: %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v163 = v119;
              _IDSLogTransport(@"GL", @"IDS", @"adding stale link to allocbind request: %@");
              if (_IDSShouldLog())
              {
                v163 = v119;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"adding stale link to allocbind request: %@");
              }
            }
          }
        }

        v116 = [(NSMutableSet *)v115 countByEnumeratingWithState:&v190 objects:v201 count:16];
      }

      while (v116);
    }

    v121 = v172->_usedLinks;
    if (v121)
    {
      CFDictionarySetValue(theDict, @"gl-option-used-links", v121);
    }

    else
    {
      v122 = MEMORY[0x1E69E9C10];
      v123 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v122, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18344();
      }
    }

    v124 = [[IDSQRProtoMessage alloc] initWithType:1 candidatePair:v169 options:theDict];
    if (!v124)
    {
      v136 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v203 = @"allocbind_request";
        _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "failed to create proto message (%@).", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to create proto message (%@).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create proto message (%@).");
          }
        }
      }

      goto LABEL_265;
    }

    v125 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v125, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = v172->_idsSessionID;
      v127 = [v169 sessionID];
      *buf = 138413314;
      *v203 = @"allocbind_request";
      *&v203[8] = 2112;
      *&v203[10] = v124;
      *&v203[18] = 2112;
      *&v203[20] = idsSessionID;
      v204 = 2112;
      v205 = v127;
      v206 = 2112;
      v207 = key;
      _os_log_impl(&dword_1A7AD9000, v125, OS_LOG_TYPE_DEFAULT, "Send %@ %@ for IDSSessionID: %@ QRSessionID: %@ token: %@", buf, 0x34u);
    }

    [(IDSGFTMetricsCollector *)v172->_metricsCollector quicAllocbindRequest];
    v128 = [v169 linkMetrics];
    [v128 sendAllocbindRequest];

    [(IDSGlobalLink *)v172 _setLinkMetricsAttributesForCandidatePair:v169];
    v129 = [v169 local];
    v130 = [v129 transport];

    v131 = IMGetDomainBoolForKey();
    v132 = IMGetDomainBoolForKey();
    v133 = v132;
    if (v131)
    {
      v134 = 0;
      v135 = v172;
    }

    else
    {
      v135 = v172;
      v134 = !v172->_forceTCPFallbackOnWiFi;
    }

    v137 = (v132 & 1) == 0 && !v135->_forceTCPFallbackOnCell;
    v138 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v138, OS_LOG_TYPE_DEFAULT))
    {
      v139 = @"NO";
      if (v131)
      {
        v140 = @"YES";
      }

      else
      {
        v140 = @"NO";
      }

      forceTCPFallbackOnCell = v172->_forceTCPFallbackOnCell;
      if (v172->_forceTCPFallbackOnWiFi)
      {
        v142 = @"YES";
      }

      else
      {
        v142 = @"NO";
      }

      *buf = 138413058;
      *v203 = v140;
      if (v133)
      {
        v143 = @"YES";
      }

      else
      {
        v143 = @"NO";
      }

      *&v203[8] = 2112;
      *&v203[10] = v142;
      if (forceTCPFallbackOnCell)
      {
        v139 = @"YES";
      }

      *&v203[18] = 2112;
      *&v203[20] = v143;
      v204 = 2112;
      v205 = v139;
      _os_log_impl(&dword_1A7AD9000, v138, OS_LOG_TYPE_DEFAULT, "sendQUICAllocbindRequest forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
    }

    v144 = [v169 local];
    v145 = [v144 isCellularStunCandidate];

    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BCC2FC;
    aBlock[3] = &unk_1E77E0E18;
    aBlock[4] = v172;
    v146 = v124;
    v188 = v146;
    v147 = v169;
    v189 = v147;
    v148 = _Block_copy(aBlock);
    if ((v134 | v145) & 1 | ((v130 - 3) < 0xFFFFFFFFFFFFFFFELL))
    {
      if (v137 || (v130 - 3) < 0xFFFFFFFFFFFFFFFELL || ((v145 ^ 1) & 1) != 0)
      {
        [v147 debugDelay];
        if (v157 == 0.0)
        {
          v148[2](v148);
        }

        else
        {
          v158 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v158, OS_LOG_TYPE_DEFAULT))
          {
            [v147 debugDelay];
            *buf = 134217984;
            *v203 = v159;
            _os_log_impl(&dword_1A7AD9000, v158, OS_LOG_TYPE_DEFAULT, "debugDelay is present. Delaying by %f seconds", buf, 0xCu);
          }

          [v147 debugDelay];
          if (v160 > 0.0)
          {
            v185[0] = MEMORY[0x1E69E9820];
            v185[1] = 3221225472;
            v185[2] = sub_1A7BCC348;
            v185[3] = &unk_1E77E0188;
            v186 = v148;
            [v147 debugDelay];
            IDSTransportThreadAddBlockAfter(v185, v161);
          }
        }

        goto LABEL_254;
      }

      v149 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
      {
        v150 = (&_IDSStunTransportStrings)[v130];
        *buf = 136315138;
        *v203 = v150;
        _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnCell is set, skip message %s", buf, 0xCu);
      }
    }

    else
    {
      v149 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
      {
        v151 = (&_IDSStunTransportStrings)[v130];
        *buf = 136315138;
        *v203 = v151;
        _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnWiFi is set, skip message %s", buf, 0xCu);
      }
    }

LABEL_254:
    if (!v168)
    {
      [v147 setState:1];
      v152 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v152, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315650;
        *v203 = _IDSStunCandidatePairStateStrings;
        *&v203[8] = 2080;
        *&v203[10] = off_1EB2B43B0;
        *&v203[18] = 2112;
        *&v203[20] = key;
        _os_log_impl(&dword_1A7AD9000, v152, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v165 = off_1EB2B43B0;
          v166 = key;
          v164 = _IDSStunCandidatePairStateStrings;
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v165 = off_1EB2B43B0;
            v166 = key;
            v164 = _IDSStunCandidatePairStateStrings;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      v153 = [v147 allocateType];
      v154 = 10.0;
      v155 = v153 == 2;
      if (v153 == 2)
      {
        v154 = GLUtilNATCheckTimeout();
      }

      v156 = [(IDSQRProtoMessage *)v146 transactionID];
      v174[0] = MEMORY[0x1E69E9820];
      v174[1] = 3221225472;
      v174[2] = sub_1A7BCC358;
      v174[3] = &unk_1E77E1360;
      v175 = v147;
      v176 = v172;
      v179 = v156;
      v180 = 0;
      v177 = key;
      v183 = v171;
      v181 = v154;
      v184 = v155;
      v178 = v146;
      v182 = v167;
      IDSTransportThreadAddBlockAfter(v174, v154);
    }

LABEL_265:
    v18 = v169;
LABEL_34:

    goto LABEL_35;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "failed to send allocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send allocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send allocbind request due to invalid token.");
      }
    }
  }

LABEL_35:
}

- (void)_sendQUICUnallocbindRequest:(id)a3 reason:(unsigned __int8)a4
{
  v4 = a4;
  v53 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = v6;
  if (self->_state >= 6)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v48 = v9;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "skip unallocbind request, GL state (%s).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request, GL state (%s).");
        }
      }
    }

    goto LABEL_34;
  }

  if (v6)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v11 = CFDictionaryGetValue(tokenToCandidatePairs, v7)) == 0)
    {
      v17 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = self->_tokenToCandidatePairs;
        *buf = 138412546;
        v48 = v7;
        v49 = 2112;
        v50 = v18;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          }
        }
      }

      v12 = 0;
      goto LABEL_27;
    }

    v12 = v11;
    if (([v11 isRelayStunCandidatePair] & 1) == 0)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v48 = v7;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, not over relay.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, not over relay.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, not over relay.");
          }
        }
      }

      goto LABEL_27;
    }

    v13 = [v12 state];
    v14 = v13;
    if (v13 <= 6 && ((1 << v13) & 0x47) != 0)
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        v16 = (&_IDSStunCandidatePairStateStrings)[v14];
        *buf = 138412546;
        v48 = v7;
        v49 = 2080;
        v50 = v16;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, state [%s].");
          }
        }
      }

      goto LABEL_27;
    }

    v40 = [v12 sessionID];
    if (!v40)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid relay-session-id.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid relay-session-id.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid relay-session-id.");
          }
        }
      }

      goto LABEL_91;
    }

    [v12 stopSessionConnectedTimer];
    [v12 stopSessionConvergenceTimer];
    [v12 stopSessionGoAwayTimer];
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    if (self->_idsContextBlob)
    {
      v22 = [(IDSGlobalLink *)self _createIDSContextBlobMaterialProto:?];
      if (v22)
      {
        CFDictionarySetValue(Mutable, @"gl-option-ids-context-blob-key", v22);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18124();
      }
    }

    if (v4 == 12)
    {
      v24 = &unk_1F1B20108;
    }

    else if (v4 == 4)
    {
      v24 = &unk_1F1B20120;
    }

    else
    {
      if (![v12 isSharedQRSession] || self->_sharedSessionHasJoined)
      {
        goto LABEL_59;
      }

      v24 = &unk_1F1B200F0;
    }

    CFDictionarySetValue(Mutable, @"gl-option-ids-context-reason-key", v24);
LABEL_59:
    v25 = [[IDSQRProtoMessage alloc] initWithType:22 candidatePair:v12 options:Mutable];
    if (v25)
    {
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        v48 = v25;
        v49 = 2112;
        v50 = v7;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "send unallocbind request %@ for %@.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v35 = v25;
          v37 = v7;
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request %@ for %@.");
          if (_IDSShouldLog())
          {
            v35 = v25;
            v37 = v7;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request %@ for %@.");
          }
        }
      }

      v27 = [(IDSGlobalLink *)self _sendProtoMessage:v25 candidatePair:v12, v35, v37];
      [v12 addProtoRequest:{-[IDSQRProtoMessage transactionID](v25, "transactionID")}];
      if (v14 != 5)
      {
        [v12 setState:5];
        v28 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          v29 = (&_IDSStunCandidatePairStateStrings)[v14];
          *buf = 136315650;
          v48 = v29;
          v49 = 2080;
          v50 = off_1EB2B43D0;
          v51 = 2112;
          v52 = v7;
          _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v38 = off_1EB2B43D0;
            v39 = v7;
            v36 = (&_IDSStunCandidatePairStateStrings)[v14];
            _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              v38 = off_1EB2B43D0;
              v39 = v7;
              v36 = (&_IDSStunCandidatePairStateStrings)[v14];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
            }
          }
        }
      }

      if (v27 == -1 && !((self->_state != 5) | [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0]))
      {
        [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:24 reason:v4];
      }

      else
      {
        v30 = [(IDSQRProtoMessage *)v25 transactionID:v36];
        if (!self->_unallocbindRequestToReason)
        {
          v31 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          unallocbindRequestToReason = self->_unallocbindRequestToReason;
          self->_unallocbindRequestToReason = v31;
        }

        v33 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:v4];
        if (v33)
        {
          CFDictionarySetValue(self->_unallocbindRequestToReason, [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:v30], v33);
        }

        v41[0] = MEMORY[0x1E69E9820];
        v41[1] = 3221225472;
        v41[2] = sub_1A7BCDA2C;
        v41[3] = &unk_1E77E1388;
        v42 = v12;
        v43 = self;
        v44 = v30;
        v46 = v4;
        v45 = 22;
        IDSTransportThreadAddBlockAfter(v41, 3.0);
      }
    }

    else
    {
      v34 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v48 = @"unallocbind_request";
        _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "failed to create proto message (%@)", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to create proto message (%@)");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create proto message (%@)");
          }
        }
      }
    }

LABEL_91:
LABEL_27:

    goto LABEL_34;
  }

  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid token.");
      }
    }
  }

LABEL_34:
}

- (void)_sendChannelDataCommandMessage:(int64_t)a3 packetBuffer:(id *)a4 options:(id)a5 candidatePairToken:(id)a6
{
  v21 = *MEMORY[0x1E69E9840];
  v10 = a5;
  v11 = a6;
  if (v11 && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v13 = CFDictionaryGetValue(tokenToCandidatePairs, v11)) != 0 || v11 && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v13 = CFDictionaryGetValue(tokenToStunCheckPairs, v11)) != 0)
  {
    v15 = v13;
LABEL_9:
    [(IDSGlobalLink *)self _sendChannelDataCommandMessage:a3 packetBuffer:a4 options:v10 candidatePair:v15];

    goto LABEL_10;
  }

  v15 = [(IDSGlobalLink *)self _findVirtualCandidatePair:v11];
  if (v15)
  {
    goto LABEL_9;
  }

  v16 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    v18 = a3;
    v19 = 2112;
    v20 = v11;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send command %04lx failed due to invalid candidate pair %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"send command %04lx failed due to invalid candidate pair %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send command %04lx failed due to invalid candidate pair %@");
      }
    }
  }

  _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15015, a4);
LABEL_10:
}

- (void)_sendChannelDataCommandMessage:(int64_t)a3 packetBuffer:(id *)a4 options:(id)a5 candidatePair:(id)a6
{
  v111 = *MEMORY[0x1E69E9840];
  v98 = a5;
  v10 = a6;
  v11 = v10;
  v96 = self;
  v97 = a3;
  if (self->_state >= 6)
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = _IDSLinkStateStrings[self->_state];
      *buf = 134218242;
      *v109 = a3;
      *&v109[8] = 2080;
      *&v109[10] = v13;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip session command %04lx, GL state (%s).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip session command %04lx, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip session command %04lx, GL state (%s).");
        }
      }
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15027, a4);
    goto LABEL_9;
  }

  v95 = a4;
  v94 = [v10 state];
  v14 = [v11 local];
  v15 = [v14 address];

  if (![v11 isRelayStunCandidatePair]|| (v94 - 5) > 0xFFFFFFFFFFFFFFFDLL)
  {
LABEL_39:
    v37 = ids_monotonic_time();
    v38 = [v98 objectForKey:@"gl-attr-active-probing-link-id"];
    v39 = [v38 charValue];

    v40 = v97;
    if (!v39)
    {
      if ([(IDSGlobalLink *)v96 _skipCommandMessage:v97 candidatePair:v11 timeNow:v37])
      {
        v48 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v48, OS_LOG_TYPE_DEBUG))
        {
          v49 = [v11 candidatePairToken];
          v50 = (&_IDSStunCandidatePairStateStrings)[[v11 state]];
          *buf = 134218498;
          *v109 = v97;
          *&v109[8] = 2112;
          *&v109[10] = v49;
          *&v109[18] = 2080;
          *&v109[20] = v50;
          _os_log_impl(&dword_1A7AD9000, v48, OS_LOG_TYPE_DEBUG, "skip session command %04lx for %@, state [%s].", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          v91 = [v11 candidatePairToken];
          [v11 state];
          _IDSLogV(1, @"IDSFoundation", @"GL", @"skip session command %04lx for %@, state [%s].");
        }

        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15065, v95);
        goto LABEL_9;
      }

      v40 = v97;
      if (v97 == 3)
      {
        [v11 hbStartTime];
        if (v60 == 0.0)
        {
          v61 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v61, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v109 = v11;
            _os_log_impl(&dword_1A7AD9000, v61, OS_LOG_TYPE_DEFAULT, "session heartbeat request start now for %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v88 = v11;
              _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request start now for %@");
              if (_IDSShouldLog())
              {
                v88 = v11;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request start now for %@");
              }
            }
          }

          [v11 setHbStartTime:v37, v88, v89, v92, v93];
          v40 = 3;
        }

        else
        {
          v40 = 3;
          if (v37 - v60 > 60.0)
          {
            v85 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v109 = v11;
              _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "session heartbeat request message timed out, disconnect %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v88 = v11;
                _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request message timed out, disconnect %@");
                if (_IDSShouldLog())
                {
                  v88 = v11;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request message timed out, disconnect %@");
                }
              }
            }

            v86 = [v11 isQUIC:v88];
            v87 = [v11 candidatePairToken];
            if (v86)
            {
              [(IDSGlobalLink *)v96 _sendQUICUnallocbindRequest:v87 reason:9];
            }

            else
            {
              [(IDSGlobalLink *)v96 _sendUnallocbindRequest:v87 stunMessage:0 reason:9];
            }

            _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15083, v95);
            goto LABEL_9;
          }
        }
      }
    }

    v41 = v95;
    if (!v95)
    {
      v51 = [(IDSGlobalLink *)v96 _createCommandData:v40 options:v98 candidatePair:v11];
      if (!v51)
      {
        v71 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 134217984;
          *v109 = v97;
          _os_log_impl(&dword_1A7AD9000, v71, OS_LOG_TYPE_DEFAULT, "failed to get indication data, skip session command (%04lx) message.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to get indication data, skip session command (%04lx) message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get indication data, skip session command (%04lx) message.");
            }
          }
        }

        goto LABEL_9;
      }

      v95 = _IDSLinkPacketBufferCreate();
      v95->var25 = [v11 linkID];
      v52 = [v51 length];
      v95->var2 = v52;
      [v51 getBytes:v95->var0 length:v52];
      v95->var23 = 1;
      v95->var24[0].var19 = 1;
      v53 = [v98 objectForKey:@"gl-attr-remote-relay-link-id"];
      v54 = v53;
      v55 = v95;
      if (v53)
      {
        v95->var24[0].var14 = 1;
        v56 = [v53 unsignedShortValue];
        v55 = v95;
        v95->var24[0].var15[0] = v56;
      }

      v55->var28 = v37;

LABEL_84:
      v62 = +[IDSFoundationLog GlobalLink];
      v63 = os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT);
      if (v39 <= 0)
      {
        if (v63)
        {
          v68 = [v11 candidatePairToken];
          idsSessionID = v96->_idsSessionID;
          v70 = [v11 sessionID];
          *buf = 67110146;
          *v109 = v97;
          *&v109[4] = 2112;
          *&v109[6] = v68;
          *&v109[14] = 2112;
          *&v109[16] = idsSessionID;
          *&v109[24] = 2112;
          *&v109[26] = v70;
          *&v109[34] = 2112;
          *&v109[36] = v11;
          _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "Send command %04x (relay) for %@ IDSSessionID: %@ QRSessionID: %@ candidatePair: %@", buf, 0x30u);
        }
      }

      else
      {
        if (v63)
        {
          v64 = [v11 candidatePairToken];
          v65 = v96->_idsSessionID;
          v66 = [v11 sessionID];
          *buf = 67110146;
          *v109 = v97;
          *&v109[4] = 1024;
          *&v109[6] = v39;
          *&v109[10] = 2112;
          *&v109[12] = v64;
          *&v109[20] = 2112;
          *&v109[22] = v65;
          *&v109[30] = 2112;
          *&v109[32] = v66;
          _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "Send command %04x (active probing on link %d) (relay) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x2Cu);
        }

        if (v96->_maxLinkID <= v39)
        {
          v67 = 0;
        }

        else
        {
          v67 = v96->_candidatePairs[v39];
        }

        v62 = v11;
        v11 = v67;
      }

      v72 = 0;
      v73 = v97;
      if (v97 != 3 && (v97 & 0x8000) == 0)
      {
        v72 = _IDSLinkPacketBufferClone("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15158, v95);
        v73 = v97;
      }

      v74 = (v73 & 0x8000) == 0;
      var28 = v95->var28;
      [IDSGlobalLink _sendChannelDataPacketBuffer:v96 candidatePair:"_sendChannelDataPacketBuffer:candidatePair:"];
      v76 = v97;
      v77 = v97 == 3 && v39 > 0;
      if (!v77 && v74)
      {
        v78 = 1.0;
        if (v97 == 6 || v97 == 1)
        {
          v79 = v96;
          if (v37 - var28 < 2.0)
          {
            v80 = v96->_allocbindEndTime - v96->_allocbindStartTime;
            if (v80 > 0.0)
            {
              v81 = v80 + v80;
              if (v80 + v80 > 0.2)
              {
                v81 = 0.2;
              }

              if (v81 >= 0.05)
              {
                v78 = v81;
              }

              else
              {
                v78 = 0.05;
              }

              v82 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 134218240;
                *v109 = v78;
                *&v109[8] = 2048;
                *&v109[10] = v80;
                _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.", buf, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
                  }
                }
              }

              v79 = v96;
              v76 = v97;
            }
          }
        }

        else
        {
          v79 = v96;
        }

        v99[0] = MEMORY[0x1E69E9820];
        v99[1] = 3221225472;
        v99[2] = sub_1A7BCF388;
        v99[3] = &unk_1E77E13B0;
        v99[4] = v79;
        v102 = v76;
        v103 = v72;
        v100 = v98;
        v11 = v11;
        v101 = v11;
        IDSTransportThreadAddBlockAfter(v99, v78);
      }

      goto LABEL_9;
    }

    if (v37 - v95->var28 > 30.0)
    {
      switch(v40)
      {
        case 6:
          v84 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v84, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v84, OS_LOG_TYPE_DEFAULT, "session relay interface information message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session relay interface information message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session relay interface information message timed out.");
              }
            }
          }

          [(IDSGlobalLink *)v96 _discardKeyMaterialMessage:12, v88];
          v47 = +[IDSStunRelayInterfaceInfoController sharedInstance];
          [v47 setRelayInterfaceInfoDeliveryStatus:v96->_cbuuid status:4];
          break;
        case 4:
          v83 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "session connection data message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session connection data message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connection data message timed out.");
              }
            }
          }

          v47 = +[IDSStunConnectionDataController sharedInstance];
          [v47 setDeliveryStatus:v96->_cbuuid status:3];
          break;
        case 1:
          v42 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v109 = v11;
            _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "session connected message timed out, disconnect %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v88 = v11;
              _IDSLogTransport(@"GL", @"IDS", @"session connected message timed out, disconnect %@.");
              if (_IDSShouldLog())
              {
                v88 = v11;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message timed out, disconnect %@.");
              }
            }
          }

          v43 = [v11 linkEngine];

          if (v43)
          {
            v44 = [v11 linkEngine];
            v45 = [v11 linkUniqueName];
            [v44 linkDidFail:v45 errorCode:9 isRecoverable:0 shouldReconnect:0];
          }

          v46 = [v11 isQUIC];
          v47 = [v11 candidatePairToken];
          if (v46)
          {
            [(IDSGlobalLink *)v96 _sendQUICUnallocbindRequest:v47 reason:9];
          }

          else
          {
            [(IDSGlobalLink *)v96 _sendUnallocbindRequest:v47 stunMessage:0 reason:9];
          }

          break;
        default:
LABEL_150:
          _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15109, v41);
          goto LABEL_9;
      }

      v41 = v95;
      goto LABEL_150;
    }

    if ((v40 & 0xFFFFFFFFFFFF7FFFLL) == 4 && v98)
    {
      v57 = [v98 objectForKey:@"gl-attr-counter"];
      v58 = [v57 intValue];
      v59 = 0xFFFFFFFFLL;
    }

    else
    {
      v58 = 0xFFFFFFFFLL;
      v59 = 0xFFFFFFFFLL;
      if ((v40 & 0xFFFFFFFFFFFF7FFFLL) != 6 || !v98)
      {
LABEL_82:
        if ([(IDSGlobalLink *)v96 _shouldSkipCommand:v40 withCandidatePair:v11 connectionDataCounter:v58 relayInterfaceCounter:v59, v88])
        {
          _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15122, v95);
          goto LABEL_9;
        }

        goto LABEL_84;
      }

      v57 = [v98 objectForKey:@"gl-attr-counter"];
      v59 = [v57 intValue];
    }

    v40 = v97;
    goto LABEL_82;
  }

  v106 = 0u;
  v107 = 0u;
  v104 = 0u;
  v105 = 0u;
  v16 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v17 = [v16 countByEnumeratingWithState:&v104 objects:v110 count:16];
  if (v17)
  {
    v18 = *v105;
    while (2)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v105 != v18)
        {
          objc_enumerationMutation(v16);
        }

        v20 = *(*(&v104 + 1) + 8 * i);
        v21 = [v20 local];
        v22 = [v21 address];

        v23 = [v20 sessionID];
        v24 = [v11 sessionID];
        if ([v23 isEqualToString:v24] && (objc_msgSend(v20, "state") == 3 || objc_msgSend(v20, "state") == 4))
        {
          v25 = IsSameSA(v15, v22);

          if (v25)
          {
            v31 = [v11 candidatePairToken];
            v32 = [v20 candidatePairToken];
            v33 = v20;

            v34 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
            {
              v36 = (&_IDSStunCandidatePairStateStrings)[v94];
              *buf = 138413058;
              *v109 = v31;
              *&v109[8] = 2080;
              *&v109[10] = v36;
              *&v109[18] = 1024;
              *&v109[20] = v97;
              *&v109[24] = 2112;
              *&v109[26] = v32;
              _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], send command %04x using %@.", buf, 0x26u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v92 = v97;
                v93 = v32;
                v88 = v31;
                v89 = (&_IDSStunCandidatePairStateStrings)[v94];
                _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], send command %04x using %@.");
                if (_IDSShouldLog())
                {
                  v92 = v97;
                  v93 = v32;
                  v88 = v31;
                  v89 = (&_IDSStunCandidatePairStateStrings)[v94];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], send command %04x using %@.");
                }
              }
            }

            v11 = v33;
            goto LABEL_39;
          }
        }

        else
        {
        }
      }

      v17 = [v16 countByEnumeratingWithState:&v104 objects:v110 count:16];
      if (v17)
      {
        continue;
      }

      break;
    }
  }

  v26 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    v27 = [v11 candidatePairToken];
    v28 = (&_IDSStunCandidatePairStateStrings)[v94];
    *buf = 138412802;
    *v109 = v27;
    *&v109[8] = 2080;
    *&v109[10] = v28;
    *&v109[18] = 1024;
    *&v109[20] = v97;
    _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], Found no other connected candidate pair to send command %04x", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v29 = [v11 candidatePairToken];
      v90 = (&_IDSStunCandidatePairStateStrings)[v94];
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");

      if (_IDSShouldLog())
      {
        v30 = [v11 candidatePairToken:v29];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");
      }
    }
  }

  _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15054, v95);
LABEL_9:
}

- (BOOL)_processChannelDataCommandMessage:(id *)a3 remoteRelayLinkID:(unsigned __int16)a4 channelNumber:(unsigned __int16)a5 fromDeviceUniqueID:(id)a6 cbuuid:(id)a7 arrivalTime:(double)a8
{
  v10 = a5;
  v11 = a4;
  v31 = *MEMORY[0x1E69E9840];
  v14 = a6;
  v15 = a7;
  v16 = channelForStunCandidatePair(&a3->var18, &a3->var19, v10);
  channelToCandidatePairs = self->_channelToCandidatePairs;
  if (channelToCandidatePairs)
  {
    v18 = v16 == 0;
  }

  else
  {
    v18 = 1;
  }

  if (v18 || (v19 = CFDictionaryGetValue(channelToCandidatePairs, v16)) == 0)
  {
    v23 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = self->_channelToCandidatePairs;
      *buf = 138412546;
      v28 = v16;
      v29 = 2112;
      v30 = v24;
      _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@");
        }
      }
    }

    v25 = 0;
  }

  else
  {
    v20 = v19;
    v21 = [v19 candidatePairToken];
    if ([v20 isActive])
    {
      v22 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
      if (v22)
      {
        v22[39] = a8;
      }
    }

    else
    {
      [v20 setLastIncomingPacketTime:a8];
    }

    v25 = [(IDSGlobalLink *)self _processIncomingIndicationData:a3->var0 length:LODWORD(a3->var2) candidatePairToken:v21 arrivalTime:v11 remoteRelayLinkID:a8];
  }

  return v25;
}

- (int64_t)getAllocBindErrorCodeForSessionID:(id)a3
{
  v31 = *MEMORY[0x1E69E9840];
  v4 = a3;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v5 = v23 = 0u;
  v6 = [v5 countByEnumeratingWithState:&v22 objects:v30 count:16];
  if (!v6)
  {

LABEL_20:
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 136315394;
      v27 = "[IDSGlobalLink getAllocBindErrorCodeForSessionID:]";
      v28 = 2112;
      v29 = v4;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "%s: did not find candidate pairs for session %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"%s: did not find candidate pairs for session %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: did not find candidate pairs for session %@");
        }
      }
    }

    v19 = 7;
    goto LABEL_27;
  }

  v7 = 0;
  v8 = 0;
  v9 = *v23;
  do
  {
    for (i = 0; i != v6; ++i)
    {
      if (*v23 != v9)
      {
        objc_enumerationMutation(v5);
      }

      v11 = *(*(&v22 + 1) + 8 * i);
      v12 = [v11 sessionID];
      v13 = [v12 isEqualToString:v4];

      if (v13)
      {
        v14 = [v11 local];
        v15 = *([v14 address] + 1) == 30;

        if (v15)
        {
          v7 = 1;
        }

        else
        {
          v16 = [v11 local];
          v17 = *([v16 address] + 1) == 2;

          v8 |= v17;
        }
      }
    }

    v6 = [v5 countByEnumeratingWithState:&v22 objects:v30 count:16];
  }

  while (v6);

  v18 = 37;
  if ((v8 & 1 & v7) != 0)
  {
    v18 = 7;
  }

  if (v8)
  {
    v19 = v18;
  }

  else
  {
    v19 = 38;
  }

  if (((v8 | v7) & 1) == 0)
  {
    goto LABEL_20;
  }

LABEL_27:

  return v19;
}

- (BOOL)_sendChannelConfigRequestToQR:(id)a3
{
  v24 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 state];
  if (![v4 isRelayStunCandidatePair])
  {
    goto LABEL_14;
  }

  v6 = [v4 local];
  if (![v6 isCellularStunCandidate] || v5 != 4)
  {

    goto LABEL_14;
  }

  v7 = [v4 isQUIC];

  if (!v7)
  {
LABEL_14:
    v14 = 0;
    goto LABEL_15;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = [v4 candidatePairToken];
    *buf = 136315394;
    v21 = "[IDSGlobalLink _sendChannelConfigRequestToQR:]";
    v22 = 2112;
    v23 = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "%s: %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v16 = [v4 candidatePairToken];
      _IDSLogTransport(@"GL", @"IDS", @"%s: %@");

      if (_IDSShouldLog())
      {
        v17 = [v4 candidatePairToken];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: %@");
      }
    }
  }

  ++self->_channelConfigGenerationCounter;
  v10 = [IDSQRProtoMessage alloc];
  v19[0] = &unk_1F1B20138;
  v18[0] = @"gl-option-channel-config-override-idle-timeout-key";
  v18[1] = @"gl-option-channel-config-counter-key";
  v11 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_channelConfigGenerationCounter];
  v19[1] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v19 forKeys:v18 count:2];
  v13 = [(IDSQRProtoMessage *)v10 initWithType:39 candidatePair:v4 options:v12];

  if (v13)
  {
    v14 = [v4 sendQUICChannelConfigRequest:v13];
  }

  else
  {
    v14 = 0;
  }

LABEL_15:
  return v14;
}

- (IDSLinkDelegate)delegate
{
  WeakRetained = objc_loadWeakRetained(&self->_delegate);

  return WeakRetained;
}

- (IDSLinkDelegate)alternateDelegate
{
  WeakRetained = objc_loadWeakRetained(&self->_alternateDelegate);

  return WeakRetained;
}

@end