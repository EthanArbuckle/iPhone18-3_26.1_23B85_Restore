@interface IDSGlobalLink
+ (Class)getGLClassWithOptions:(id)options;
- (BOOL)_IsExtIPDiscoveryNeeded:(sockaddr *)needed candidatePairList:(id)list;
- (BOOL)_addCandidate:(id)candidate isRemoteCandidate:(BOOL)remoteCandidate;
- (BOOL)_findTriedCandidatePairForSession:(id)session wantOnlyCell:(BOOL)cell wantOnlyNonCell:(BOOL)nonCell;
- (BOOL)_getPacketBufferSendInfo:(id *)info channelNumber:(unsigned __int16 *)number transport:(int64_t *)transport glLinkProtocol:(int64_t *)protocol;
- (BOOL)_getSessionParticipants:(id)participants relaySessionID:(id)d options:(id)options;
- (BOOL)_getSessionStreamInfo:(id)info relaySessionID:(id)d options:(id)options;
- (BOOL)_glLinkProtocolIsNWLink:(int64_t)link;
- (BOOL)_handleRemapping:(id)remapping errorCode:(unsigned __int16)code reconnectQUIC:(BOOL)c;
- (BOOL)_hasActiveAllocbindFailoverTimerForSessionID:(id)d;
- (BOOL)_hasCandidatePairInState:(unint64_t)state anotherState:(unint64_t)anotherState relayCandidatePairsOnly:(BOOL)only excludeSelfAlloc:(BOOL)alloc;
- (BOOL)_hasConnectedP2pLink;
- (BOOL)_hasStunRequest:(id)request;
- (BOOL)_interfaceName:(id)name missingFrom:(id)from;
- (BOOL)_isAcceptedRelaySessionForAllocationRequestID:(id)d acceptedRelaySessionID:(id)iD;
- (BOOL)_isCLAT46Interface:(sockaddr *)interface;
- (BOOL)_isCellularInterfaceForCandidatePair:(id)pair localAddress:(sockaddr *)address;
- (BOOL)_isExtIPDiscoveryDone;
- (BOOL)_isInterfaceConstrainedWithInterfaceIndex:(unsigned int)index;
- (BOOL)_isInterfaceDelegatedWithInterfaceIndex:(unsigned int)index;
- (BOOL)_isInterfaceExpensiveWithInterfaceIndex:(unsigned int)index;
- (BOOL)_isNWPathFlagsChanged:(id)changed existingPath:(unsigned __int16 *)path;
- (BOOL)_isSessionAccepted:(id)accepted;
- (BOOL)_isSharedQRSession:(id)session;
- (BOOL)_isSlicedCellularInterfaceActive:(unsigned int)active;
- (BOOL)_isUsingSameRATCandidatePair:(id)pair transportScoreCard:(id)card;
- (BOOL)_localIsQualityMetadataSupported;
- (BOOL)_processAllocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processBindingRequest:(id)request fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processBindingResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processChannelDataCommandMessage:(id *)message remoteRelayLinkID:(unsigned __int16)d channelNumber:(unsigned __int16)number fromDeviceUniqueID:(id)iD cbuuid:(id)cbuuid arrivalTime:(double)time;
- (BOOL)_processDataIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processDiagnosticIndication:(id)indication candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processGoAwayIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processIncomingIndicationData:(char *)data length:(int)length candidatePairToken:(id)token arrivalTime:(double)time remoteRelayLinkID:(unsigned __int16)d;
- (BOOL)_processNWLinkAllocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processProtoPacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time headerOverhead:(unint64_t)overhead;
- (BOOL)_processQUICDiagnosticIndication:(id)indication candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processQUICGoAwayIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processQUICReallocIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processQUICUnallocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processReallocIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_processRemovedLocalAddressList:(id)list;
- (BOOL)_processStunPacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time headerOverhead:(unint64_t)overhead;
- (BOOL)_processUnallocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time;
- (BOOL)_qrLinkLimitExceededWithNewLinkType:(unsigned __int8)type cellularRelayLinkCount:(unsigned __int16)count wifiRelayLinkCount:(unsigned __int16)linkCount;
- (BOOL)_qrMaterialExchangePutMaterial:(id)material completionHandler:(id)handler;
- (BOOL)_requestSelfAllocationForInterfaceAddress:(id)address;
- (BOOL)_sendChannelConfigRequestToQR:(id)r;
- (BOOL)_sendInfoRequest:(id)request relaySessionID:(id)d;
- (BOOL)_setupNewQRLinkIfNecessary:(id)necessary;
- (BOOL)_shouldSkipCommand:(int64_t)command withCandidatePair:(id)pair connectionDataCounter:(int)counter relayInterfaceCounter:(int)interfaceCounter;
- (BOOL)_shouldUseP2PTLE;
- (BOOL)_shouldUseQRTLE;
- (BOOL)_skipCommandMessage:(int64_t)message candidatePair:(id)pair timeNow:(double)now;
- (BOOL)_synthesizeNAT64ForAddress:(sockaddr *)address withPrefix:(id *)prefix toAddress:(sockaddr *)toAddress;
- (BOOL)_triggerSymptomsWithCandidatePairToken:(id)token subType:(id)type subTypeContext:(id)context duration:(unsigned __int16)duration;
- (BOOL)_triggerSymptomsWithType:(id)type subType:(id)subType subTypeContext:(id)context duration:(unsigned __int16)duration;
- (BOOL)hasReachableInterface:(unint64_t)interface;
- (BOOL)isCandidatePairConstrained:(id)constrained;
- (BOOL)isCandidatePairDelegated:(id)delegated;
- (BOOL)link:(id)link didReceivePacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid;
- (BOOL)receiveNoSessionStateForCandidatePair:(id)pair didLocalExternalAddressChange:(BOOL)change;
- (IDSGlobalLink)initWithDeviceUniqueID:(id)d cbuuid:(id)cbuuid;
- (IDSLinkDelegate)alternateDelegate;
- (IDSLinkDelegate)delegate;
- (NSString)linkTypeString;
- (char)allocateLinkID;
- (double)_startTimeForProtoRequest:(unint64_t)request;
- (double)_startTimeForStunRequest:(id)request;
- (id)_addSocketAndInterfaceAddress:(unint64_t)address wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular;
- (id)_addSocketAndInterfaceAddressWithNWLink:(BOOL)link wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular;
- (id)_convergeSharedSessions:(id)sessions;
- (id)_convergeSharedSessionsWithoutLinkEngine:(id)engine;
- (id)_createCommandData:(int64_t)data options:(id)options candidatePair:(id)pair;
- (id)_createIDSContextBlobMaterialProto:(id)proto;
- (id)_createInterfaceAddressArray:(unint64_t)array wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular;
- (id)_createInterfaceAddressArrayWithNWLink:(BOOL)link wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular;
- (id)_ensureSessionWithSessionInfo:(id)info sessionInfoDict:(id)dict localInterfacePreference:(int)preference;
- (id)_filterNonSlicedLocalCandidates:(id)candidates;
- (id)_findCandidatePairWithRelaySessionID:(id)d;
- (id)_getAllocbindReportingDataBlob:(id)blob;
- (id)_getCandidatePairsWithSessionID:(id)d inState:(unint64_t)state;
- (id)_getLink:(int)link stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol;
- (id)_getLocalAttribute:(id)attribute;
- (id)_getRemoteAttribute:(id)attribute;
- (id)_interfaceNameForInterfaceIndex:(unsigned int)index;
- (id)_interfaceNameForInterfaceIndexIncludingVPN:(unsigned int)n;
- (id)_linkIDsForSession:(id)session;
- (id)_localCandidatesForRelaySession:(id)session;
- (id)_remoteCandidatesForRelaySession:(id)session;
- (id)_tokenForProtoRequest:(unint64_t)request;
- (id)_translateLinkTransportTypeWhenH2Enabled:(id)enabled;
- (id)_transportInterfaceToString:(int64_t)string;
- (id)allLinkEngines;
- (id)copyLinkStatsDict;
- (id)createLinkCycleForCandidatePair:(id)pair;
- (id)generateLinkReport:(double)report isCurrentLink:(BOOL)link;
- (id)interfaceNameForCandidatePair:(id)pair;
- (id)linkEngineForSessionInfo:(id)info;
- (id)p2pLinkEngine;
- (id)tagForCandidatePair:(id)pair glLinkProtocol:(int64_t)protocol;
- (int)_getExpensiveLinkFlagsForCandidatePair:(id)pair;
- (int)_knownRemoteAvailableInterfaces;
- (int64_t)_localCapabilityFlags;
- (int64_t)_sendPacketBuffer:(id *)buffer stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol token:(id)token linkID:(char)d delegatedLinkID:(char)iD;
- (int64_t)_sendProtoMessage:(id)message candidatePair:(id)pair;
- (int64_t)_sendStunMessage:(id)message candidatePair:(id)pair;
- (int64_t)_sendStunMessage:(id)message sourceIfIndex:(int)index source:(const sockaddr *)source destination:(sockaddr *)destination stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol token:(id)token linkID:(char)self0 delegatedLinkID:(char)self1 MTULimit:(int)self2;
- (int64_t)getAllocBindErrorCodeForSessionID:(id)d;
- (tagIDSQRSendInfo)sendInfoForCandidatePair:(id)pair;
- (unint64_t)_prepareOutgoingChannelData:(id *)data arraySize:(int)size channelNumber:(unsigned __int16)number candidatePair:(id)pair linkID:(char)d delegatedLinkID:(char *)iD stunTransport:(int64_t)transport;
- (unint64_t)_sendChannelDataPacketBuffer:(id *)buffer candidatePair:(id)pair;
- (unint64_t)createAliasForParticipantID:(unint64_t)d salt:(id)salt relayGroupID:(id)iD;
- (unint64_t)defaultLinkType;
- (unint64_t)headerOverhead;
- (unint64_t)participantIDForAlias:(unint64_t)alias salt:(id)salt relayGroupID:(id)d;
- (unint64_t)sendPacketBuffer:(id *)buffer toDeviceUniqueID:(id)d cbuuid:(id)cbuuid;
- (unint64_t)sendPacketBufferArray:(id *)array arraySize:(int)size toDeviceUniqueID:(id)d cbuuid:(id)cbuuid;
- (unsigned)_getExternalIPAddressRAT:(id)t;
- (unsigned)_getNewLinkType:(id)type remoteInterface:(int *)interface;
- (void)_addQRAAWDBlock:(id)block allocateRequestTime:(double)time inferredExternalRAT:(unsigned int)t stunTransport:(int64_t)transport relayProviderType:(int64_t)type idsSessionID:(id)d reportingDataBlob:(id)blob isInitiator:(BOOL)self0 serverSoftwareVersion:(id)self1;
- (void)_addStunCheckPair:(id)pair isRemoteCandidate:(BOOL)candidate excludeLocalAddress:(sockaddr *)address;
- (void)_attemptP2PNegotiationForSTUNMessage:(id)message candidatePair:(id)pair completionHandler:(id)handler;
- (void)_buildQrExperiments;
- (void)_callDisconnectCompletionHandler:(id)handler;
- (void)_connectNWLink:(id)link disconnectAfterUse:(BOOL)use connectedHandler:(id)handler;
- (void)_connectNWTCPLink:(id)link disconnectAfterUse:(BOOL)use connectedHandler:(id)handler;
- (void)_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:(id)needed remoteCandidate:(id)candidate glLinkProtocol:(int64_t)protocol;
- (void)_connectWithSessionInfo:(id)info interfaceAddress:(id)address joinSession:(BOOL)session allocbindFailover:(BOOL)failover completionHandler:(id)handler withLocalInterfacePreference:(int)preference;
- (void)_convergeSharedSessionsWithLinkEngine:(id)engine;
- (void)_deinitialieSendInfoForCandidatePair:(id)pair;
- (void)_delayProcessingCellularInterfaces:(id)interfaces;
- (void)_didReceiveRequestToPurgeRegistration;
- (void)_discardAllCandidatePairs:(BOOL)pairs;
- (void)_discardCandidatePairsWithOption:(BOOL)option isReinitiating:(BOOL)reinitiating;
- (void)_discardNonAcceptedCandidatePairs;
- (void)_discardNonSlicedP2PCandidatePairs;
- (void)_discardSelfAllocateCandidatePairs;
- (void)_disconnectPluginConnectionsForParticipantID:(unint64_t)d andPurgeRegistration:(BOOL)registration;
- (void)_finishPacketLog;
- (void)_flushPacketLogTick;
- (void)_generateTransportScoreCard;
- (void)_getAndProcessDatablobsFromReceivedMaterials:(id)materials;
- (void)_getNAT64PrefixForInterface:(int)interface interfaceName:(id)name completionBlock:(id)block;
- (void)_getP2PNegotiationForCandidatePair:(id)pair completionBlock:(id)block;
- (void)_handleActivityTimer;
- (void)_handleAllocbindFailoverTimer:(id)timer failoverTimerOnCandidatePair:(id)pair onInterface:(int)interface;
- (void)_handleAllocbindFailoverTimerWithTransportScoreCards:(id)cards failoverTimerOnCandidatePair:(id)pair onInterface:(int)interface;
- (void)_handleDisconnect:(BOOL)disconnect;
- (void)_handleDisconnectTimer;
- (void)_handleNewRATChange;
- (void)_handleSelfAllocationTimeout:(id)timeout;
- (void)_handle_cellular_path:(id)_handle_cellular_path nwEndPoind:(id)poind;
- (void)_handle_wifi_path:(id)_handle_wifi_path nwEndPoind:(id)poind;
- (void)_initializeSendInfoForCandidatePair:(id)pair;
- (void)_markLinkAsUsed:(id)used;
- (void)_nominateCandidatePair:(id)pair;
- (void)_notifyCandidatePairConnected:(id)connected;
- (void)_notifyCandidatePairDisconnected:(id)disconnected withReason:(unsigned __int8)reason;
- (void)_notifyDefaultUnderlyingLinkChanged:(id)changed error:(int64_t)error;
- (void)_notifyLinkDisconnectedWithError:(int64_t)error reason:(unsigned __int8)reason;
- (void)_notifyLinkEngineCandidatePairDidConnect:(id)connect;
- (void)_notifyQRSessionConnected:(id)connected;
- (void)_notifySessionInfoReceived:(id)received relayGroupID:(id)d relaySessionID:(id)iD status:(unsigned int)status;
- (void)_parseActiveExperiments:(id)experiments;
- (void)_parseClientUUID:(id)d;
- (void)_processCommandConnected:(id)connected candidatePairToken:(id)token;
- (void)_processCommandConnectionData:(id)data candidatePairToken:(id)token;
- (void)_processCommandDisconnected:(id)disconnected candidatePairToken:(id)token;
- (void)_processCommandHeartbeat:(id)heartbeat candidatePairToken:(id)token arrivalTime:(double)time remoteRelayLinkID:(unsigned __int16)d;
- (void)_processCommandNominate:(id)nominate candidatePairToken:(id)token;
- (void)_processCommandTestPacket:(id)packet candidatePairToken:(id)token remoteRelayLinkID:(unsigned __int16)d;
- (void)_processDataOnReallocChannel:(unsigned __int16)channel localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress;
- (void)_processDelayedCellularInterfaces;
- (void)_processNewLocalAddressList:(id)list;
- (void)_processNewRemoteCandidates:(id)candidates;
- (void)_processReallocChannelData:(id *)data channelNumber:(unsigned __int16)number fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time;
- (void)_processRemoteCandidates:(id)candidates;
- (void)_processRemoteLinkUUID:(id)d candidatePair:(id)pair;
- (void)_processRemovedRemoteCandidates:(id)candidates;
- (void)_processXORMappedAddress:(id)address arrivalTime:(double)time;
- (void)_receiveP2PNegotiationBlob:(id)blob attemptID:(unint64_t)d remoteIDSConnectionID:(unsigned int)iD remoteAVCConnectionID:(unsigned int)connectionID candidatePair:(id)pair completionHandler:(id)handler;
- (void)_removeChannelFromChannelToCandidatePair:(id)pair;
- (void)_removePacketNotificationFilter;
- (void)_removeProtoRequest:(unint64_t)request status:(unsigned int)status;
- (void)_removeStunRequest:(id)request;
- (void)_reportAWDAllocateTime;
- (void)_reportNoSessionState:(id)state errorCode:(unsigned __int16)code;
- (void)_reportSessionSetupTime;
- (void)_requestNewTwoWayQRAllocation:(id)allocation;
- (void)_requestNonUDPRelayAllocation:(int64_t)allocation relaySessionID:(id)d;
- (void)_saveProtoRequest:(id)request token:(id)token path:(id)path;
- (void)_saveStunRequest:(id)request startTime:(double)time token:(id)token;
- (void)_schedulePacketLogFlush;
- (void)_selectStunTransport:(int64_t *)transport andInterfaceAddress:(id *)address forRelaySessionID:(id)d preferIPv4:(BOOL)pv4 wantOnlyCell:(BOOL)cell wantOnlyNonCell:(BOOL)nonCell isValidSA:(BOOL)a;
- (void)_sendAllocbindForCandidatePair:(id)pair session:(id)session glLinkProtocol:(int64_t)protocol;
- (void)_sendAllocbindRequest:(id)request stunMessage:(id)message isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state;
- (void)_sendAllocbindRequestForExtIP:(id)p startTime:(double)time;
- (void)_sendBindingRequest:(id)request stunMessage:(id)message;
- (void)_sendChannelDataCommandMessage:(int64_t)message packetBuffer:(id *)buffer options:(id)options candidatePair:(id)pair;
- (void)_sendChannelDataCommandMessage:(int64_t)message packetBuffer:(id *)buffer options:(id)options candidatePairToken:(id)token;
- (void)_sendCommandMessage:(int64_t)message stunMessage:(id)stunMessage options:(id)options candidatePair:(id)pair;
- (void)_sendCommandMessage:(int64_t)message stunMessage:(id)stunMessage options:(id)options candidatePairToken:(id)token;
- (void)_sendConnectionDataWithRemovedAddressList:(id)list;
- (void)_sendInfoRequestForCandidatePair:(id)pair glLinkProtocol:(int64_t)protocol;
- (void)_sendNowConnectionDataWithRemovedAddressList:(id)list;
- (void)_sendQUICAllocbindRequest:(id)request isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state shouldConnectLinkFirst:(BOOL)first isPendingInResponseToNoSessionState:(BOOL)sessionState;
- (void)_sendQUICUnallocbindRequest:(id)request reason:(unsigned __int8)reason;
- (void)_sendSKEDataToSucceededCandidatePairs;
- (void)_sendSKEDataWithSelectedCandidatePair;
- (void)_sendSessionDisconnectedCommand;
- (void)_sendSyntheticPacket:(id)packet candidatePair:(id)pair;
- (void)_sendUnallocbindRequest:(id)request stunMessage:(id)message reason:(unsigned __int8)reason;
- (void)_sendUnallocbindRequestTimeOut:(id)out stunMessage:(id)message reason:(unsigned __int8)reason;
- (void)_setCandidatePairConnected:(id)connected;
- (void)_setChannelToCandidatePair:(id)pair localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress channelNumber:(unsigned __int16)number;
- (void)_setFirstDefaultCandidatePair:(id)pair;
- (void)_setLinkMetricsAttributesForCandidatePair:(id)pair;
- (void)_setLinkMetricsAttributesForCandidatePair:(id)pair linkAttributes:(id)attributes;
- (void)_setRemoteGlobalLinkVersionWithCommand:(int64_t)command receivedRemoteVersion:(BOOL)version versionValue:(unsigned __int16)value receivedSKE:(BOOL)e;
- (void)_setupRelayConnectionForNetworkAddressChanges;
- (void)_setupRelayConnectionForNetworkAddressChangesHelper;
- (void)_startActivityTimer;
- (void)_startAllocbindFailoverTimerOnCandidatePair:(id)pair delay:(int)delay;
- (void)_startDisconnectTimer;
- (void)_startExtIPDiscovery;
- (void)_stopActivityTimer;
- (void)_stopAllocbindFailoverTimer:(id)timer;
- (void)_stopDisconnectTimer;
- (void)_stopProbingOnLinkID:(char)d;
- (void)_updateAllLinks;
- (void)_updateCandidatePair:(id)pair newLocalPort:(unsigned __int16)port;
- (void)_updateDefaultCandidatePair:(id)pair;
- (void)_updateInterfaceAddressesWithAddList:(id)list removeList:(id)removeList;
- (void)_updateLinkIDForPlugin:(id)plugin;
- (void)_updateLinksForSession:(id)session;
- (void)_updateNominatedCandidatePair:(id)pair;
- (void)_updateSendStatsWithResult:(unint64_t)result bytesSent:(int64_t)sent packetsSent:(int)packetsSent linkID:(char)d delegatedLinkID:(char)iD token:(id)token isClientData:(BOOL)data sendTime:(double)self0 stunTransport:(int64_t)self1 packetBuffer:(id *)self2;
- (void)candidatePair:(id)pair didAddQREvent:(id)event;
- (void)candidatePair:(id)pair didReceiveGetMaterialResponse:(id)response;
- (void)candidatePair:(id)pair didReceiveMappedParticipantsDict:(id)dict forLinkID:(char)d;
- (void)candidatePair:(id)pair didReceiveParticipantUpdate:(id)update status:(unsigned __int16)status;
- (void)candidatePair:(id)pair didReceivePluginControlEvent:(unint64_t)event operation:(unsigned __int8)operation transactionID:(id)d;
- (void)candidatePair:(id)pair didReceivePluginRegistration:(unint64_t)registration pluginName:(id)name;
- (void)candidatePair:(id)pair didReceivePluginUnregistration:(unint64_t)unregistration pluginName:(id)name;
- (void)candidatePair:(id)pair didReceivePutMaterialIndication:(id)indication;
- (void)candidatePair:(id)pair didReceivePutMaterialResponse:(id)response forTxId:(unint64_t)id;
- (void)candidatePair:(id)pair didReceiveSessionInfo:(id)info status:(unsigned int)status;
- (void)candidatePair:(id)pair didReceiveSessionStats:(id)stats success:(BOOL)success;
- (void)candidatePair:(id)pair didReceiveStunErrorResponse:(int64_t)response errorCode:(unsigned __int16)code didLocalExternalAddressChange:(BOOL)change;
- (void)candidatePairDidReceiveInfoResponse:(id)response;
- (void)configureGLExperimentsWithSessionInfo:(id)info;
- (void)connectRelayLinkFromCandidate:(id)candidate toCandidate:(id)toCandidate withUniqueID:(id)d relaySessionID:(id)iD glLinkProtocol:(int64_t)protocol replacesLinkWithUniqueID:(id)uniqueID;
- (void)currentCellularSignalStrength:(int *)strength signalStrength:(int *)signalStrength signalGrade:(int *)grade;
- (void)dealloc;
- (void)didReceiveFirstDataOnCandidatePair:(id)pair;
- (void)disconnectIdleQUICConnectionForCandidatePair:(id)pair;
- (void)disconnectRelayLinkWithUniqueID:(id)d glLinkProtocol:(int64_t)protocol;
- (void)disconnectWithCompletionHandler:(id)handler isReinitiating:(BOOL)reinitiating;
- (void)dropIPPackets:(char)packets payloadArray:(id)array;
- (void)flushLinkProbingStatus:(id)status;
- (void)freeLinkID:(char)d;
- (void)getSessionInfo:(id)info relaySessionID:(id)d requestType:(int64_t)type options:(id)options;
- (void)handleCellularRATChange;
- (void)handleNetworkAddressChanges:(BOOL)changes hasIPv6AddressChange:(BOOL)change;
- (void)importLinkEngineQualityMeasurementDelta:(id)delta sourceName:(id)name completionHandler:(id)handler;
- (void)importQualityMeasurementDelta:(id)delta sourceName:(id)name completionHandler:(id)handler;
- (void)invalidate;
- (void)link:(id)link pathMTUDidChange:(unsigned __int16)change connectionInfo:(id)info;
- (void)linkEngineDidRemoveLinkWithUniqueID:(id)d;
- (void)linkTransactionIDMismatchDetected:(id)detected;
- (void)linksQualityDeltaSince:(id)since completionHandler:(id)handler;
- (void)qrMaterialExchangePutMaterial:(id)material completionHandler:(id)handler;
- (void)queryLinkProbingStatus:(id)status;
- (void)receiveBlockedIndicationWithReason:(unsigned int)reason;
- (void)receiveErrorIndicationWithCode:(unsigned int)code;
- (void)receiveIdleClientErrorForCandidatePair:(id)pair;
- (void)receiveKeyMaterials:(id)materials;
- (void)reconnectRelayLinkWithUniqueID:(id)d glLinkProtocol:(int64_t)protocol;
- (void)registerP2PCandidatePairWithLinkEngine:(id)engine;
- (void)registerPluginWithOptions:(id)options relayGroupID:(id)d;
- (void)reportLinkEvent:(id)event linkID:(unsigned __int8)d;
- (void)requestChildConnectionIDForLinkID:(char)d relayGroupID:(id)iD;
- (void)requestMaterialsForSession:(id)session participantIDs:(id)ds materialType:(int)type;
- (void)requestPathMTUEvaluationForLinkID:(char)d;
- (void)sendAllocbindRequest:(id)request isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state reconnectQUIC:(BOOL)c;
- (void)sendConnectedLinkInfoToAVC;
- (void)sendStatsRequest:(id)request;
- (void)sendStatsRequestForClient:(id)client;
- (void)sendTestPacketChannelDataMessage:(id)message candidatePair:(id)pair;
- (void)sendTestPacketCommandMessage:(id)message candidatePair:(id)pair;
- (void)setAcceptedRelaySession:(id)session options:(id)options;
- (void)setClientUniquePID:(unint64_t)d;
- (void)setForceTCPFallbackOnCell:(BOOL)cell;
- (void)setForceTCPFallbackOnWiFi:(BOOL)fi;
- (void)setLinkSelectionStrategy:(id)strategy;
- (void)setPacketNotificationFilter:(char)filter uniqueTag:(unsigned int)tag isEnabled:(BOOL)enabled;
- (void)setReceivedRemoteDeviceVersion:(BOOL)version;
- (void)setRemoteDeviceVersion:(unsigned int)version;
- (void)setUpP2PQUICPodConnectionsForCandidatePair:(id)pair attemptID:(unint64_t)d completionHandler:(id)handler;
- (void)setWiFiAssistState:(BOOL)state;
- (void)startLinkProbing:(id)probing;
- (void)startNewAllocationFromInterface:(int)interface toInterface:(int)toInterface;
- (void)startWithOptions:(id)options;
- (void)stopKeepAlive:(id)alive;
- (void)stopLinkProbing:(id)probing;
- (void)updateProtocolQualityOfService:(char)service isGood:(BOOL)good;
- (void)updateSessionParticipants:(id)participants relaySessionID:(id)d participants:(id)a5;
@end

@implementation IDSGlobalLink

- (IDSGlobalLink)initWithDeviceUniqueID:(id)d cbuuid:(id)cbuuid
{
  v93 = *MEMORY[0x1E69E9840];
  dCopy = d;
  cbuuidCopy = cbuuid;
  v85.receiver = self;
  v85.super_class = IDSGlobalLink;
  v78 = [(IDSGlobalLink *)&v85 init];
  if (v78)
  {
    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7B6A940;
    aBlock[3] = &unk_1E77E0B20;
    v7 = v78;
    v84 = v7;
    v77 = _Block_copy(aBlock);
    objc_storeStrong(&v7->_deviceUniqueID, d);
    objc_storeStrong(&v7->_cbuuid, cbuuid);
    v8 = [[IDSUDPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    udpLink = v7->_udpLink;
    v7->_udpLink = v8;

    [(IDSUDPLink *)v7->_udpLink setDelegate:v7];
    v10 = [[IDSUDPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    udpLinkv6 = v7->_udpLinkv6;
    v7->_udpLinkv6 = v10;

    [(IDSUDPLink *)v7->_udpLinkv6 setDelegate:v7];
    v12 = [[IDSTCPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid isSSL:0 getPacketLength:v77];
    tcpLink = v7->_tcpLink;
    v7->_tcpLink = v12;

    [(IDSTCPLink *)v7->_tcpLink setDelegate:v7];
    v14 = [[IDSTCPLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid isSSL:1 getPacketLength:v77];
    tcpSSLLink = v7->_tcpSSLLink;
    v7->_tcpSSLLink = v14;

    [(IDSTCPLink *)v7->_tcpSSLLink setDelegate:v7];
    v16 = [[IDSNWLink alloc] initWithDeviceUniqueID:v7->_deviceUniqueID cbuuid:v7->_cbuuid];
    nwLink = v7->_nwLink;
    v7->_nwLink = v16;

    [(IDSNWLink *)v7->_nwLink setDelegate:v7];
    v7->_previousReportTime = ids_monotonic_time();
    v18 = +[IDSServerBag sharedInstance];
    v19 = [v18 objectForKey:@"ids-fallback-to-tcp-first"];
    v7->_shouldFallbackToTCPFirst = [v19 BOOLValue];

    v20 = +[IDSServerBag sharedInstance];
    v21 = [v20 objectForKey:@"ids-disable-pure-link-feature"];
    v7->_disablePureLinkFeature = [v21 BOOLValue];

    v22 = +[IDSServerBag sharedInstance];
    v73 = [v22 objectForKey:@"ids-expensive-quality-metrics-portion" ofClass:objc_opt_class()];

    if (v73)
    {
      [v73 floatValue];
      v24 = v23;
    }

    else
    {
      v24 = 0.1;
    }

    mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
    isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

    if (isInternalInstall)
    {
      v27 = arc4random() < (v24 * 4294967300.0);
    }

    else
    {
      v27 = 0;
    }

    v7->_recordExpensiveQualityMetrics = IMGetDomainBoolForKeyWithDefaultValue();
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      if (v7->_recordExpensiveQualityMetrics)
      {
        v29 = @"YES";
      }

      else
      {
        v29 = @"NO";
      }

      *buf = 138412802;
      v88 = v29;
      if (v27)
      {
        v30 = @"YES";
      }

      else
      {
        v30 = @"NO";
      }

      v89 = 2112;
      v90 = v30;
      v91 = 2048;
      v92 = v24;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v31 = v7->_recordExpensiveQualityMetrics ? @"YES" : @"NO";
      v32 = v27 ? @"YES" : @"NO";
      v72 = v24;
      v69 = v31;
      v71 = v32;
      _IDSLogTransport(@"GL", @"IDS", @"initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)");
      if (_IDSShouldLog())
      {
        if (v7->_recordExpensiveQualityMetrics)
        {
          v33 = @"YES";
        }

        else
        {
          v33 = @"NO";
        }

        v72 = v24;
        v69 = v33;
        v71 = v32;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"initWithDeviceUniqueID: recordExpensiveQualityMetrics (may still be set to false later): %@ (coin flip: %@, chance: %f)");
      }
    }

    dictionary = [MEMORY[0x1E695DF90] dictionary];
    debugDelayByTag = v7->_debugDelayByTag;
    v7->_debugDelayByTag = dictionary;

    v76 = MEMORY[0x1AC562F80](@"com.apple.ids", @"glDelay");
    if (v76)
    {
      v36 = [v76 componentsSeparatedByString:{@", "}];
      v81 = 0u;
      v82 = 0u;
      v79 = 0u;
      v80 = 0u;
      v37 = [v36 countByEnumeratingWithState:&v79 objects:v86 count:16];
      if (v37)
      {
        v38 = *v80;
        do
        {
          for (i = 0; i != v37; ++i)
          {
            if (*v80 != v38)
            {
              objc_enumerationMutation(v36);
            }

            v40 = [*(*(&v79 + 1) + 8 * i) componentsSeparatedByString:@"="];
            if ([v40 count])
            {
              v41 = [v40 objectAtIndexedSubscript:0];
              v42 = -1.0;
              if ([v40 count] >= 2)
              {
                v43 = [v40 objectAtIndexedSubscript:1];
                [v43 doubleValue];
                v42 = v44;
              }

              v45 = [MEMORY[0x1E696AD98] numberWithDouble:v42];
              [(NSMutableDictionary *)v7->_debugDelayByTag setObject:v45 forKeyedSubscript:v41];
            }
          }

          v37 = [v36 countByEnumeratingWithState:&v79 objects:v86 count:16];
        }

        while (v37);
      }
    }

    IDSSimpleUInt16List_Init(&v7->_channelNumberList, 16);
    IDSSimpleUInt16List_Init(&v7->_reallocChannelList, 16);
    v7->_natMappingTimeout = 35.0;
    v7->_nat64PrefixCache = IDSNAT64PrefixCacheCreate();
    IDSQRSendInfoList_Init(&v7->_sendInfoList, 4);
    v7->_remoteGlobalLinkVersion = -1;
    v46 = objc_alloc_init(MEMORY[0x1E695DF70]);
    activeProbingLinkIDs = v7->_activeProbingLinkIDs;
    v7->_activeProbingLinkIDs = v46;

    v48 = objc_alloc_init(MEMORY[0x1E695DF90]);
    pluginParticipantIDs = v7->_pluginParticipantIDs;
    v7->_pluginParticipantIDs = v48;

    v50 = objc_alloc_init(MEMORY[0x1E695DF90]);
    pluginNameToPluginOptionsDict = v7->_pluginNameToPluginOptionsDict;
    v7->_pluginNameToPluginOptionsDict = v50;

    v52 = objc_alloc_init(MEMORY[0x1E695DF90]);
    putMaterialReqTxIdToCompletionBlock = v7->_putMaterialReqTxIdToCompletionBlock;
    v7->_putMaterialReqTxIdToCompletionBlock = v52;

    array = [MEMORY[0x1E695DF70] array];
    unusedLinkIDs = v7->_unusedLinkIDs;
    v7->_unusedLinkIDs = array;

    v56 = IMGetDomainIntForKey();
    if (v56 < 1)
    {
      v56 = 127;
    }

    v7->_maxLinkID = v56;
    v57 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      maxLinkID = v7->_maxLinkID;
      *buf = 67109120;
      LODWORD(v88) = maxLinkID;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "initWithDeviceUniqueID: setting max link ID to %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v70 = v7->_maxLinkID;
        _IDSLogTransport(@"GL", @"IDS", @"initWithDeviceUniqueID: setting max link ID to %d");
        if (_IDSShouldLog())
        {
          v70 = v7->_maxLinkID;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"initWithDeviceUniqueID: setting max link ID to %d");
        }
      }
    }

    v59 = [MEMORY[0x1E695DFA8] set];
    usedLocalConnectionIDs = v7->_usedLocalConnectionIDs;
    v7->_usedLocalConnectionIDs = v59;

    v61 = [MEMORY[0x1E695DFA8] set];
    usedLinks = v7->_usedLinks;
    v7->_usedLinks = v61;

    dictionary2 = [MEMORY[0x1E695DF90] dictionary];
    sessionsByID = v7->_sessionsByID;
    v7->_sessionsByID = dictionary2;

    dictionary3 = [MEMORY[0x1E695DF90] dictionary];
    linkEngineIDToCandidatePair = v7->_linkEngineIDToCandidatePair;
    v7->_linkEngineIDToCandidatePair = dictionary3;

    v67 = _os_feature_enabled_impl();
    v7->_shouldUsePathMTUDiscovery = sub_1A7B69448("PathMTUDiscovery", v67);
  }

  return v78;
}

- (void)dealloc
{
  v7 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    selfCopy = self;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "Dealloc IDSGlobalLink %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"Dealloc IDSGlobalLink %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Dealloc IDSGlobalLink %@.");
      }
    }
  }

  IDSSimpleUInt16List_Destroy(&self->_channelNumberList.listSize);
  IDSSimpleUInt16List_Destroy(&self->_reallocChannelList.listSize);
  IDSNAT64PrefixCacheDestroy(self->_nat64PrefixCache);
  IDSQRSendInfoList_Destroy(self->_sendInfoList);
  self->_cellularSlicingFlags = 0;
  v4.receiver = self;
  v4.super_class = IDSGlobalLink;
  [(IDSGlobalLink *)&v4 dealloc];
}

- (void)invalidate
{
  v84 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    selfCopy = self;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "Invalidate IDSGlobalLink %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      selfCopy3 = self;
      _IDSLogTransport(@"GL", @"IDS", @"Invalidate IDSGlobalLink %@.");
      if (_IDSShouldLog())
      {
        selfCopy3 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Invalidate IDSGlobalLink %@.");
      }
    }
  }

  [(IDSUDPLink *)self->_udpLink invalidate];
  [(IDSUDPLink *)self->_udpLinkv6 invalidate];
  [(IDSTCPLink *)self->_tcpLink invalidate];
  [(IDSTCPLink *)self->_tcpSSLLink invalidate];
  [(IDSNWLink *)self->_nwLink invalidate];
  [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0];
  quicMaterialExchangeProvider = self->_quicMaterialExchangeProvider;
  if (quicMaterialExchangeProvider)
  {
    [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider invalidate];
    v5 = self->_quicMaterialExchangeProvider;
  }

  else
  {
    v5 = 0;
  }

  self->_quicMaterialExchangeProvider = 0;

  [(NSMutableDictionary *)self->_tokenToCandidatePairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA2E0];
  if (self->_maxLinkID >= 1)
  {
    v6 = 0;
    candidatePairs = self->_candidatePairs;
    do
    {
      v8 = candidatePairs[v6];
      [(IDSStunCandidatePair *)v8 invalidate];
      v9 = candidatePairs[v6];
      candidatePairs[v6] = 0;

      ++v6;
    }

    while (v6 < self->_maxLinkID);
  }

  [(NSMutableDictionary *)self->_channelToCandidatePairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA300];
  [(NSMutableDictionary *)self->_tokenToStunCheckPairs enumerateKeysAndObjectsUsingBlock:&unk_1F1AAA320];
  tokenToCandidatePairs = self->_tokenToCandidatePairs;
  self->_tokenToCandidatePairs = 0;

  channelToCandidatePairs = self->_channelToCandidatePairs;
  self->_channelToCandidatePairs = 0;

  tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
  self->_tokenToStunCheckPairs = 0;

  reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
  self->_reallocNewCandidatePairToOldCandidatePair = 0;

  retryCountPerLinkType = self->_retryCountPerLinkType;
  self->_retryCountPerLinkType = 0;

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  self->_transactionIDToRequestMetadata = 0;

  startTimeToStunReqID = self->_startTimeToStunReqID;
  self->_startTimeToStunReqID = 0;

  tokenToStunReqID = self->_tokenToStunReqID;
  self->_tokenToStunReqID = 0;

  tokenToReallocBlocks = self->_tokenToReallocBlocks;
  self->_tokenToReallocBlocks = 0;

  localCandidateList = self->_localCandidateList;
  self->_localCandidateList = 0;

  remoteCandidateList = self->_remoteCandidateList;
  self->_remoteCandidateList = 0;

  nonAcceptedQRSessions = self->_nonAcceptedQRSessions;
  self->_nonAcceptedQRSessions = 0;

  delayedCellInterfaces = self->_delayedCellInterfaces;
  self->_delayedCellInterfaces = 0;

  allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  self->_allocateTimeReportBlocks = 0;

  qraBlocks = self->_qraBlocks;
  self->_qraBlocks = 0;

  selfAllocateRequestIDs = self->_selfAllocateRequestIDs;
  self->_selfAllocateRequestIDs = 0;

  connectReadyHandler = self->_connectReadyHandler;
  self->_connectReadyHandler = 0;

  connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
  self->_connectingCandidatePairSessionInfo = 0;

  unallocbindRequestToReason = self->_unallocbindRequestToReason;
  self->_unallocbindRequestToReason = 0;

  connectedLinkIDs = self->_connectedLinkIDs;
  self->_connectedLinkIDs = 0;

  activeProbingLinkIDs = self->_activeProbingLinkIDs;
  self->_activeProbingLinkIDs = 0;

  pluginParticipantIDs = self->_pluginParticipantIDs;
  self->_pluginParticipantIDs = 0;

  pluginNameToPluginOptionsDict = self->_pluginNameToPluginOptionsDict;
  self->_pluginNameToPluginOptionsDict = 0;

  linkIDToStatsData = self->_linkIDToStatsData;
  self->_linkIDToStatsData = 0;

  putMaterialReqTxIdToCompletionBlock = self->_putMaterialReqTxIdToCompletionBlock;
  self->_putMaterialReqTxIdToCompletionBlock = 0;

  p2pNegotiatorProvider = self->_p2pNegotiatorProvider;
  self->_p2pNegotiatorProvider = 0;

  linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
  self->_linkIDToReorderedPackets = 0;

  linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
  self->_linkIDToRequestTimeStampAndRTT = 0;

  linkIDToHBCounter = self->_linkIDToHBCounter;
  self->_linkIDToHBCounter = 0;

  usedLinks = self->_usedLinks;
  self->_usedLinks = 0;

  avcDataBlob = self->_avcDataBlob;
  self->_avcDataBlob = 0;

  QRServerDataBlob = self->_QRServerDataBlob;
  self->_QRServerDataBlob = 0;

  [(IDSGlobalLink *)self _stopDisconnectTimer];
  [(IDSGlobalLink *)self _stopActivityTimer];
  nw_path_evaluator_cancel();
  wifiPathEvaluator = self->_wifiPathEvaluator;
  self->_wifiPathEvaluator = 0;

  nw_path_evaluator_cancel();
  cellularPathEvaluator = self->_cellularPathEvaluator;
  self->_cellularPathEvaluator = 0;

  self->_remoteDeviceVersion = 0;
  v44 = +[IDSCellularLinkMonitor sharedInstance];
  [v44 setRemoteDeviceVersion:self->_remoteDeviceVersion];

  disconnectCompletionHandler = self->_disconnectCompletionHandler;
  if (disconnectCompletionHandler)
  {
    v46 = _Block_copy(disconnectCompletionHandler);
    v47 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7B6B30C;
    block[3] = &unk_1E77E0B48;
    v79 = v46;
    v48 = v46;
    v49 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
    dispatch_async(v47, v49);

    v50 = self->_disconnectCompletionHandler;
  }

  else
  {
    v50 = 0;
  }

  self->_disconnectCompletionHandler = 0;

  qualityMeasurer = self->_qualityMeasurer;
  self->_qualityMeasurer = 0;

  packetLog = self->_packetLog;
  self->_packetLog = 0;

  v76 = 0u;
  v77 = 0u;
  v74 = 0u;
  v75 = 0u;
  v53 = self->_sessionsByID;
  v54 = [(NSMutableDictionary *)v53 countByEnumeratingWithState:&v74 objects:v81 count:16];
  if (v54)
  {
    v55 = *v75;
    do
    {
      v56 = 0;
      do
      {
        if (*v75 != v55)
        {
          objc_enumerationMutation(v53);
        }

        v57 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v74 + 1) + 8 * v56)];
        linkEngine = [v57 linkEngine];
        [linkEngine invalidate];

        linkEngine2 = [v57 linkEngine];
        [linkEngine2 unregisterEngine];

        ++v56;
      }

      while (v54 != v56);
      v54 = [(NSMutableDictionary *)v53 countByEnumeratingWithState:&v74 objects:v81 count:16];
    }

    while (v54);
  }

  p2pLinkEngine = self->_p2pLinkEngine;
  if (p2pLinkEngine)
  {
    [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine setAllowOngoingTasks:0];
    [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine invalidate];
    [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine unregisterEngine];
    v61 = self->_p2pLinkEngine;
    self->_p2pLinkEngine = 0;
  }

  if (self->_useLinkSelection)
  {
    packetDeduplicator = self->_packetDeduplicator;
    self->_packetDeduplicator = 0;
  }

  v72 = 0u;
  v73 = 0u;
  v70 = 0u;
  v71 = 0u;
  allValues = [(NSMutableDictionary *)self->_sessionsByID allValues];
  v64 = [allValues countByEnumeratingWithState:&v70 objects:v80 count:16];
  if (v64)
  {
    v65 = *v71;
    do
    {
      v66 = 0;
      do
      {
        if (*v71 != v65)
        {
          objc_enumerationMutation(allValues);
        }

        [*(*(&v70 + 1) + 8 * v66++) invalidate];
      }

      while (v64 != v66);
      v64 = [allValues countByEnumeratingWithState:&v70 objects:v80 count:16];
    }

    while (v64);
  }

  sessionsByID = self->_sessionsByID;
  self->_sessionsByID = 0;

  linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
  self->_linkEngineIDToCandidatePair = 0;
}

- (id)_getLink:(int)link stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol
{
  if (protocol)
  {
    v5 = protocol & 0xF0;
    v6 = 48;
    if (v5 != 16 && v5 != 32)
    {
      if (v5 == 48)
      {
        v6 = 40;
      }

      else if ((protocol & 0xF) == 1)
      {
        v9 = 24;
        if (link == 2)
        {
          v9 = 16;
        }

        v6 = 48;
        if (!self->_QUICForQREnabled)
        {
          v6 = v9;
        }
      }

      else
      {
        v6 = 32;
      }
    }

    return *(&self->super.isa + v6);
  }

  if (transport == 4)
  {
    v7 = !self->_H2FallbackEnabled;
    v6 = 40;
    v8 = 32;
LABEL_15:
    if (!v7)
    {
      v6 = v8;
    }

    return *(&self->super.isa + v6);
  }

  if (transport == 3)
  {
    v7 = !self->_H2FallbackEnabled;
    v6 = 32;
    v8 = 48;
    goto LABEL_15;
  }

  v10 = 24;
  if (link == 2)
  {
    v10 = 16;
  }

  if (self->_QUICForQREnabled)
  {
    v6 = 48;
  }

  else
  {
    v6 = v10;
  }

  return *(&self->super.isa + v6);
}

- (void)_callDisconnectCompletionHandler:(id)handler
{
  v23 = *MEMORY[0x1E69E9840];
  handlerCopy = handler;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = _Block_copy(self->_disconnectCompletionHandler);
    *buf = 134218242;
    v20 = v6;
    v21 = 2112;
    v22 = handlerCopy;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "call disconnect completion handler %p error:%@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v14 = _Block_copy(self->_disconnectCompletionHandler);
      _IDSLogTransport(@"GL", @"IDS", @"call disconnect completion handler %p error:%@");

      if (_IDSShouldLog())
      {
        v15 = _Block_copy(self->_disconnectCompletionHandler);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"call disconnect completion handler %p error:%@");
      }
    }
  }

  v7 = _Block_copy(self->_disconnectCompletionHandler);
  if (v7)
  {
    v8 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7B6B66C;
    block[3] = &unk_1E77DD0F0;
    v18 = v7;
    v17 = handlerCopy;
    v9 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
    dispatch_async(v8, v9);

    disconnectCompletionHandler = self->_disconnectCompletionHandler;
    self->_disconnectCompletionHandler = 0;

    v11 = v18;
LABEL_11:

    goto LABEL_12;
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v13 = objc_opt_respondsToSelector();

  if (v13)
  {
    v11 = objc_loadWeakRetained(&self->_delegate);
    [v11 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
    goto LABEL_11;
  }

LABEL_12:
}

- (id)_createInterfaceAddressArray:(unint64_t)array wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular
{
  cellularCopy = cellular;
  fiCopy = fi;
  v33 = *MEMORY[0x1E69E9840];
  v9 = 24;
  if (!array)
  {
    v9 = 16;
  }

  v10 = *(&self->super.isa + v9);
  if (!self->_startPort)
  {
    goto LABEL_23;
  }

  v11 = self->_startPort + LOWORD(self->_portRange) - 1;
  v12 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    startPort = self->_startPort;
    *buf = 67109632;
    *v32 = startPort;
    *&v32[4] = 1024;
    *&v32[6] = v11;
    *&v32[10] = 1024;
    *&v32[12] = array;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "use port range [%u, %u] for IPVersion %d.", buf, 0x14u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
  {
    v29 = v11;
    arrayCopy = array;
    v28 = self->_startPort;
    _IDSLogV(0, @"IDSFoundation", @"GL", @"use port range [%u, %u] for IPVersion %d.");
  }

  v14 = self->_startPort;
  if (v14 >= v11)
  {
LABEL_12:
    [v10 setPort:{0, v28}];
    [v10 setCellularPort:0];
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = self->_startPort;
      v19 = "IPv6";
      *buf = 67109634;
      if (!array)
      {
        v19 = "IPv4";
      }

      *v32 = v18;
      *&v32[4] = 1024;
      *&v32[6] = v11;
      *&v32[10] = 2080;
      *&v32[12] = v19;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "all tries failed to bind port range [%u,%u] for %s, trying random port.", buf, 0x18u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v20 = array ? "IPv6" : "IPv4";
      v29 = v11;
      arrayCopy = v20;
      v28 = self->_startPort;
      _IDSLogTransport(@"GL", @"IDS", @"all tries failed to bind port range [%u,%u] for %s, trying random port.");
      if (_IDSShouldLog())
      {
        v29 = v11;
        arrayCopy = v20;
        v28 = self->_startPort;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"all tries failed to bind port range [%u,%u] for %s, trying random port.");
      }
    }

LABEL_23:
    v16 = [v10 newSocketWithIPVersion:array wantsAWDL:0 wantsWiFi:fiCopy wantsCellular:cellularCopy clientUUID:{self->_clientUUID, v28, v29, arrayCopy}];
    if (v16)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        v22 = "IPv6";
        if (!array)
        {
          v22 = "IPv4";
        }

        *buf = 136315138;
        *v32 = v22;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "bind to random port succeeded for %s.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"bind to random port succeeded for %s.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to random port succeeded for %s.");
          }
        }
      }
    }

    else
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed binding to random port, remove socket.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed binding to random port, remove socket.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed binding to random port, remove socket.");
          }
        }
      }

      [v10 removeSocket];
    }

    goto LABEL_47;
  }

  while (1)
  {
    [v10 setPort:{v14, v28, v29, arrayCopy}];
    v15 = v14 + 1;
    [v10 setCellularPort:(v14 + 1)];
    v16 = [v10 newSocketWithIPVersion:array wantsAWDL:0 wantsWiFi:fiCopy wantsCellular:cellularCopy clientUUID:self->_clientUUID];
    if (v16)
    {
      break;
    }

    [v10 removeSocket];
    LOWORD(v14) = v14 + 1;
    if (v11 <= v15)
    {
      goto LABEL_12;
    }
  }

  v24 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    v25 = "IPv6";
    if (!array)
    {
      v25 = "IPv4";
    }

    *buf = 67109378;
    *v32 = v14;
    *&v32[4] = 2080;
    *&v32[6] = v25;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "bind to udp port %u succeeded for %s.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"bind to udp port %u succeeded for %s.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to udp port %u succeeded for %s.");
      }
    }
  }

LABEL_47:
  v26 = v16;

  return v26;
}

- (void)_delayProcessingCellularInterfaces:(id)interfaces
{
  v55 = *MEMORY[0x1E69E9840];
  theArray = interfaces;
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  dataUsable = [v3 dataUsable];

  if (!dataUsable)
  {
    v34 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v42 = 0u;
    v43 = 0u;
    v44 = 0u;
    v45 = 0u;
    obj = theArray;
    v17 = [(__CFArray *)obj countByEnumeratingWithState:&v42 objects:v51 count:16];
    if (!v17)
    {
      goto LABEL_56;
    }

    v36 = *v43;
    while (1)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v43 != v36)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v42 + 1) + 8 * i);
        if ([(NSMutableArray *)v19 isCellular])
        {
          if (v34 && v19)
          {
            CFArrayAppendValue(v34, v19);
          }

          address = [(NSMutableArray *)v19 address];
          v21 = [address sa];

          v40 = 0u;
          v41 = 0u;
          v38 = 0u;
          v39 = 0u;
          v22 = self->_delayedCellInterfaces;
          v23 = [(NSMutableArray *)v22 countByEnumeratingWithState:&v38 objects:v50 count:16];
          if (v23)
          {
            v24 = *v39;
            while (2)
            {
              for (j = 0; j != v23; ++j)
              {
                if (*v39 != v24)
                {
                  objc_enumerationMutation(v22);
                }

                address2 = [*(*(&v38 + 1) + 8 * j) address];
                v27 = [address2 sa];

                if (IsSameSA(v21, v27))
                {

                  goto LABEL_54;
                }
              }

              v23 = [(NSMutableArray *)v22 countByEnumeratingWithState:&v38 objects:v50 count:16];
              if (v23)
              {
                continue;
              }

              break;
            }
          }

          delayedCellInterfaces = self->_delayedCellInterfaces;
          if (delayedCellInterfaces)
          {
            if (!v19)
            {
              goto LABEL_48;
            }
          }

          else
          {
            v29 = objc_alloc_init(MEMORY[0x1E695DF70]);
            v30 = self->_delayedCellInterfaces;
            self->_delayedCellInterfaces = v29;

            delayedCellInterfaces = self->_delayedCellInterfaces;
            if (!v19)
            {
LABEL_48:
              v31 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v54 = v19;
                _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "delay processing cell interface %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v32 = v19;
                  _IDSLogTransport(@"GL", @"IDS", @"delay processing cell interface %@.");
                  if (_IDSShouldLog())
                  {
                    v32 = v19;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing cell interface %@.");
                  }
                }
              }

              continue;
            }
          }

          if (delayedCellInterfaces)
          {
            CFArrayAppendValue(delayedCellInterfaces, v19);
          }

          goto LABEL_48;
        }

LABEL_54:
        ;
      }

      v17 = [(__CFArray *)obj countByEnumeratingWithState:&v42 objects:v51 count:16];
      if (!v17)
      {
LABEL_56:

        [(__CFArray *)obj removeObjectsInArray:v34];
        v16 = v34;
        goto LABEL_57;
      }
    }
  }

  if (self->_delayedCellInterfaces)
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v6 = self->_delayedCellInterfaces;
      *buf = 138412290;
      v54 = v6;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "add delayed cell interfaces: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v32 = self->_delayedCellInterfaces;
        _IDSLogTransport(@"GL", @"IDS", @"add delayed cell interfaces: %@.");
        if (_IDSShouldLog())
        {
          v32 = self->_delayedCellInterfaces;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"add delayed cell interfaces: %@.");
        }
      }
    }

    v48 = 0u;
    v49 = 0u;
    v46 = 0u;
    v47 = 0u;
    v7 = self->_delayedCellInterfaces;
    v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v46 objects:v52 count:16];
    if (v8)
    {
      v9 = *v47;
      do
      {
        for (k = 0; k != v8; ++k)
        {
          if (*v47 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = *(*(&v46 + 1) + 8 * k);
          v12 = [(__CFArray *)theArray containsObject:v11, v32];
          if (v11)
          {
            v13 = theArray == 0;
          }

          else
          {
            v13 = 1;
          }

          if (((v13 | v12) & 1) == 0)
          {
            CFArrayAppendValue(theArray, v11);
          }

          if ([v11 IPVersion] == 1)
          {
            index = [v11 index];
            name = [v11 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:index interfaceName:name completionBlock:0];
          }
        }

        v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v46 objects:v52 count:16];
      }

      while (v8);
    }

    v16 = self->_delayedCellInterfaces;
    self->_delayedCellInterfaces = 0;
LABEL_57:
  }
}

- (void)_getNAT64PrefixForInterface:(int)interface interfaceName:(id)name completionBlock:(id)block
{
  v19 = *MEMORY[0x1E69E9840];
  nameCopy = name;
  blockCopy = block;
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v16 = nameCopy;
    v17 = 1024;
    interfaceCopy = interface;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "[%@:%d] needs nat64 prefix.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"[%@:%d] needs nat64 prefix.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"[%@:%d] needs nat64 prefix.");
      }
    }
  }

  if (IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, interface))
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v16) = interface;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "nat64 prefix cache hit for if:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"nat64 prefix cache hit for if:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"nat64 prefix cache hit for if:%d.");
        }
      }
    }

    self->_hasPendingAllocation = 0;
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v16) = interface;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "waiting nat64 prefix for if:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"waiting nat64 prefix for if:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"waiting nat64 prefix for if:%d.");
        }
      }
    }

    *buf = interface;
    v13 = im_primary_queue();
    v14 = blockCopy;
    nw_nat64_copy_prefixes_async();
  }
}

- (BOOL)_synthesizeNAT64ForAddress:(sockaddr *)address withPrefix:(id *)prefix toAddress:(sockaddr *)toAddress
{
  v33 = *MEMORY[0x1E69E9840];
  *&v5 = 0xAAAAAAAAAAAAAAAALL;
  *(&v5 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v31 = v5;
  v32 = v5;
  v29 = v5;
  v30 = v5;
  v27 = v5;
  v28 = v5;
  *__str = v5;
  v26 = v5;
  v23 = v5;
  v24 = v5;
  v21 = v5;
  v22 = v5;
  v19 = v5;
  v20 = v5;
  *v17 = v5;
  v18 = v5;
  if (prefix)
  {
    if (address->sa_family == 2)
    {
      if (nw_nat64_synthesize_v6())
      {
        *&toAddress->sa_len = 7708;
        *toAddress->sa_data = *address->sa_data;
        SAToIPPortString(__str, 0x80uLL, address);
        SAToIPPortString(v17, 0x80uLL, toAddress);
        v8 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315394;
          v14 = __str;
          v15 = 2080;
          v16 = v17;
          _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: nat64 translation: %s -> %s.");
            }
          }
        }
      }

      LOBYTE(v9) = 1;
      return v9;
    }

    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: address is not AF_INET", buf, 2u);
    }

    v9 = os_log_shim_legacy_logging_enabled();
    if (v9)
    {
      v9 = _IDSShouldLogTransport();
      if (v9)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: address is not AF_INET");
        v9 = _IDSShouldLog();
        if (v9)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: address is not AF_INET");
          goto LABEL_23;
        }
      }
    }
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.", buf, 2u);
    }

    v9 = os_log_shim_legacy_logging_enabled();
    if (v9)
    {
      v9 = _IDSShouldLogTransport();
      if (v9)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.");
        v9 = _IDSShouldLog();
        if (v9)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_synthesizeNAT64ForAddress: nat64 translation failed due to invalid prefix.");
LABEL_23:
          LOBYTE(v9) = 0;
        }
      }
    }
  }

  return v9;
}

- (id)_addSocketAndInterfaceAddress:(unint64_t)address wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular
{
  v29 = *MEMORY[0x1E69E9840];
  v7 = [(IDSGlobalLink *)self _createInterfaceAddressArray:address wantsWiFi:fi wantsCellular:cellular];
  v8 = [v7 mutableCopy];

  if (v8)
  {
    v9 = +[IDSCellularLinkMonitor sharedInstance];
    dataUsable = [v9 dataUsable];

    if ((dataUsable & 1) == 0)
    {
      [(IDSGlobalLink *)self _delayProcessingCellularInterfaces:v8];
    }

    if (address == 1)
    {
      v24 = 0u;
      v25 = 0u;
      v22 = 0u;
      v23 = 0u;
      v11 = v8;
      v12 = [v11 countByEnumeratingWithState:&v22 objects:v26 count:16];
      if (v12)
      {
        v13 = *v23;
        do
        {
          for (i = 0; i != v12; ++i)
          {
            if (*v23 != v13)
            {
              objc_enumerationMutation(v11);
            }

            v15 = *(*(&v22 + 1) + 8 * i);
            index = [v15 index];
            name = [v15 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:index interfaceName:name completionBlock:0];
          }

          v12 = [v11 countByEnumeratingWithState:&v22 objects:v26 count:16];
        }

        while (v12);
      }
    }

    if ([v8 count])
    {
      [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:v8 removeList:0];
    }

    v18 = v8;
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = "IPv6";
      if (!address)
      {
        v20 = "IPv4";
      }

      *buf = 136315138;
      v28 = v20;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed to create interface address array for %s.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to create interface address array for %s.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create interface address array for %s.");
        }
      }
    }
  }

  return v8;
}

- (void)_parseClientUUID:(id)d
{
  v14 = *MEMORY[0x1E69E9840];
  dCopy = d;
  uuid_clear(self->_clientUUID);
  if (dCopy)
  {
    uUIDString = [dCopy UUIDString];
    v6 = uUIDString;
    if (uUIDString)
    {
      uTF8String = [uUIDString UTF8String];
      v8 = uTF8String;
      if (uTF8String && !uuid_parse(uTF8String, self->_clientUUID))
      {
        v11 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315138;
          v13 = v8;
          _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Client UUID: %s", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"Client UUID: %s");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Client UUID: %s");
            }
          }
        }
      }

      else
      {
        v9 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
        {
          v10 = "null";
          if (v8)
          {
            v10 = v8;
          }

          *buf = 136315138;
          v13 = v10;
          _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "Invalid client UUID: %s", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"Invalid client UUID: %s");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Invalid client UUID: %s");
            }
          }
        }
      }
    }
  }
}

+ (Class)getGLClassWithOptions:(id)options
{
  optionsCopy = options;
  Value = 0;
  if (optionsCopy && @"gl-option-client-type")
  {
    Value = CFDictionaryGetValue(optionsCopy, @"gl-option-client-type");
  }

  unsignedIntValue = [Value unsignedIntValue];
  v6 = 0;
  if (optionsCopy && @"is-multiway-key")
  {
    v6 = CFDictionaryGetValue(optionsCopy, @"is-multiway-key");
  }

  bOOLValue = [v6 BOOLValue];
  if (unsignedIntValue > 4)
  {
    if ((unsignedIntValue - 5) >= 2 && unsignedIntValue != 100)
    {
      goto LABEL_32;
    }

    goto LABEL_16;
  }

  if (unsignedIntValue == 1)
  {
LABEL_16:
    if (!bOOLValue)
    {
      v11 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        *v17 = 0;
        _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for FT", v17, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v10 = @"Selecting GlobalLink for FT";
          _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for FT");
          if (_IDSShouldLog())
          {
            goto LABEL_37;
          }
        }
      }

      goto LABEL_38;
    }

    v8 = OSLogHandleForTransportCategory();
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_20;
    }

    *buf = 0;
    v9 = buf;
    goto LABEL_19;
  }

  if (unsignedIntValue != 2 || !bOOLValue)
  {
LABEL_32:
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *v15 = 0;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for NonFT", v15, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v10 = @"Selecting GlobalLink for NonFT";
        _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for NonFT");
        if (_IDSShouldLog())
        {
          goto LABEL_37;
        }
      }
    }

    goto LABEL_38;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v16 = 0;
    v9 = &v16;
LABEL_19:
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Selecting GlobalLink for GFT", v9, 2u);
  }

LABEL_20:

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v10 = @"Selecting GlobalLink for GFT";
      _IDSLogTransport(@"GL", @"IDS", @"Selecting GlobalLink for GFT");
      if (_IDSShouldLog())
      {
LABEL_37:
        _IDSLogV(0, @"IDSFoundation", @"GL", v10);
      }
    }
  }

LABEL_38:
  v13 = objc_opt_class();

  return v13;
}

- (void)startWithOptions:(id)options
{
  v214 = *MEMORY[0x1E69E9840];
  optionsCopy = options;
  v5 = objc_opt_class();
  theDict = optionsCopy;
  if (v5 == objc_opt_class())
  {
    processInfo = [MEMORY[0x1E696AE30] processInfo];
    processName = [processInfo processName];
    IMLogSimulateCrashForProcess();

    goto LABEL_452;
  }

  Value = 0;
  self->_hasStarted = 1;
  if (optionsCopy && @"gl-option-metrics-collector-key")
  {
    Value = CFDictionaryGetValue(optionsCopy, @"gl-option-metrics-collector-key");
  }

  p_metricsCollector = &self->_metricsCollector;
  objc_storeStrong(&self->_metricsCollector, Value);
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = *p_metricsCollector;
    *buf = 138412290;
    *v203 = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "startWithOptions: MetricsCollector: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v180 = *p_metricsCollector;
      _IDSLogTransport(@"GL", @"IDS", @"startWithOptions: MetricsCollector: %@");
      if (_IDSShouldLog())
      {
        v180 = *p_metricsCollector;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"startWithOptions: MetricsCollector: %@");
      }
    }
  }

  [*p_metricsCollector globalLinkStart];
  mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
  [mEMORY[0x1E69A60F0] isInternalInstall];
  v11 = IMGetDomainBoolForKeyWithDefaultValue();

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = @"NO";
    if (v11)
    {
      v13 = @"YES";
    }

    *buf = 138412290;
    *v203 = v13;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Packet timestamp logs enabled: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v14 = v11 ? @"YES" : @"NO";
    v181 = v14;
    _IDSLogTransport(@"GL", @"IDS", @"Packet timestamp logs enabled: %@");
    if (_IDSShouldLog())
    {
      v181 = v14;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"Packet timestamp logs enabled: %@");
    }
  }

  if (((self->_packetLog == 0) & v11) == 1)
  {
    v15 = [[IDSObjCPacketLog alloc] initWithSessionID:self->_cbuuid processName:@"GL"];
    packetLog = self->_packetLog;
    self->_packetLog = v15;
  }

  v17 = optionsCopy != 0;
  [(IDSGlobalLink *)self _schedulePacketLogFlush];
  if (@"gl-option-p2p-negotiator-key")
  {
    v18 = v17;
  }

  else
  {
    v18 = 0;
  }

  if (v18)
  {
    v19 = CFDictionaryGetValue(theDict, @"gl-option-p2p-negotiator-key");
  }

  else
  {
    v19 = 0;
  }

  objc_storeStrong(&self->_p2pNegotiatorProvider, v19);
  if (@"gl-option-disallow-wifi")
  {
    v22 = theDict != 0;
  }

  else
  {
    v22 = 0;
  }

  if (v22)
  {
    v23 = CFDictionaryGetValue(theDict, @"gl-option-disallow-wifi");
  }

  else
  {
    v23 = 0;
  }

  bOOLValue = [v23 BOOLValue];
  self->_disallowWiFi = bOOLValue;
  if (bOOLValue)
  {
    v24 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "client disallows WiFi.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client disallows WiFi.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client disallows WiFi.");
        }
      }
    }
  }

  v25 = 0;
  if (theDict && @"gl-option-disallow-cellular")
  {
    v25 = CFDictionaryGetValue(theDict, @"gl-option-disallow-cellular");
  }

  bOOLValue2 = [v25 BOOLValue];
  self->_disallowCellular = bOOLValue2;
  if (bOOLValue2)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "client disallows Cellular.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client disallows Cellular.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client disallows Cellular.");
        }
      }
    }
  }

  else
  {
    v27 = +[IDSCellularLinkMonitor sharedInstance];
    [v27 reset];

    v28 = +[IDSCellularLinkMonitor sharedInstance];
    [v28 setRemoteDeviceVersion:self->_remoteDeviceVersion];
  }

  v29 = 0;
  if (theDict && @"gl-option-prefer-cellular-for-call-setup")
  {
    v29 = CFDictionaryGetValue(theDict, @"gl-option-prefer-cellular-for-call-setup");
  }

  bOOLValue3 = [v29 BOOLValue];
  self->_preferCellularForCallSetup = bOOLValue3;
  if (bOOLValue3)
  {
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "client prefers using cellular for call setup.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"client prefers using cellular for call setup.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers using cellular for call setup.");
        }
      }
    }
  }

  v32 = 0;
  v33 = theDict;
  if (theDict && @"gl-option-client-type")
  {
    v32 = CFDictionaryGetValue(theDict, @"gl-option-client-type");
    v33 = theDict;
  }

  v34 = v33 != 0;
  self->_clientType = [v32 unsignedIntValue];
  if (@"gl-option-is-gft-service")
  {
    v35 = v34;
  }

  else
  {
    v35 = 0;
  }

  if (v35)
  {
    v36 = CFDictionaryGetValue(theDict, @"gl-option-is-gft-service");
  }

  else
  {
    v36 = 0;
  }

  self->_isAutoDisconnectSupportedForGFTService = [v36 BOOLValue];
  if (@"gs-is-lightweight-participant-key")
  {
    v37 = theDict != 0;
  }

  else
  {
    v37 = 0;
  }

  if (v37)
  {
    v38 = CFDictionaryGetValue(theDict, @"gs-is-lightweight-participant-key");
  }

  else
  {
    v38 = 0;
  }

  self->_isLightweightParticipant = [v38 BOOLValue];
  if (@"participant-data-key")
  {
    v39 = theDict != 0;
  }

  else
  {
    v39 = 0;
  }

  if (v39)
  {
    v40 = CFDictionaryGetValue(theDict, @"participant-data-key");
  }

  else
  {
    v40 = 0;
  }

  objc_storeStrong(&self->_avcDataBlob, v40);
  v41 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
  {
    v42 = @"NO";
    if (self->_isLightweightParticipant)
    {
      v43 = @"YES";
    }

    else
    {
      v43 = @"NO";
    }

    avcDataBlob = self->_avcDataBlob;
    if (self->_isAutoDisconnectSupportedForGFTService)
    {
      v42 = @"YES";
    }

    *buf = 138412802;
    *v203 = v43;
    *&v203[8] = 2112;
    *&v203[10] = avcDataBlob;
    v204 = 2112;
    v205 = v42;
    _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v45 = self->_isLightweightParticipant ? @"YES" : @"NO";
    v46 = self->_isAutoDisconnectSupportedForGFTService ? @"YES" : @"NO";
    v188 = self->_avcDataBlob;
    v191 = v46;
    v182 = v45;
    _IDSLogTransport(@"GL", @"IDS", @"_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@");
    if (_IDSShouldLog())
    {
      if (self->_isLightweightParticipant)
      {
        v47 = @"YES";
      }

      else
      {
        v47 = @"NO";
      }

      if (self->_isAutoDisconnectSupportedForGFTService)
      {
        v48 = @"YES";
      }

      else
      {
        v48 = @"NO";
      }

      v188 = self->_avcDataBlob;
      v191 = v48;
      v182 = v47;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isLightweightParticipant: %@, avcDataBlob: %@, _isAutoDisconnectSupportedForGFTService: %@");
    }
  }

  v49 = 0;
  if (theDict && @"gl-option-enable-ske")
  {
    v49 = CFDictionaryGetValue(theDict, @"gl-option-enable-ske");
  }

  if ([v49 BOOLValue])
  {
    self->_enableSKE = 1;
    v50 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "Enable SKE for FaceTime call.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Enable SKE for FaceTime call.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Enable SKE for FaceTime call.");
        }
      }
    }
  }

  else
  {
    self->_enableSKE = IMGetDomainBoolForKey();
    v51 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_enableSKE)
      {
        v52 = @"YES";
      }

      else
      {
        v52 = @"NO";
      }

      *buf = 138412290;
      *v203 = v52;
      _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "Found EnableSKE user defaults, enable SKE for FaceTime: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v53 = self->_enableSKE ? @"YES" : @"NO";
      v183 = v53;
      _IDSLogTransport(@"GL", @"IDS", @"Found EnableSKE user defaults, enable SKE for FaceTime: %@.");
      if (_IDSShouldLog())
      {
        if (self->_enableSKE)
        {
          v54 = @"YES";
        }

        else
        {
          v54 = @"NO";
        }

        v183 = v54;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"Found EnableSKE user defaults, enable SKE for FaceTime: %@.");
      }
    }
  }

  v183 = [IDSServerBag sharedInstanceForBagType:0, v183];
  v56 = [v183 objectForKey:@"reduce-cellular-usage"];
  self->_reduceCellularUsage = [v56 BOOLValue];

  if (self->_reduceCellularUsage)
  {
    v57 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "Default set to reduce cellular data usage", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Default set to reduce cellular data usage");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Default set to reduce cellular data usage");
        }
      }
    }
  }

  v58 = [IDSServerBag sharedInstanceForBagType:0];
  v59 = [v58 objectForKey:@"reduce-relay-link-creation"];
  self->_reduceRelayLinkCreation = [v59 BOOLValue];

  if (self->_reduceRelayLinkCreation)
  {
    v60 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "Default set to reduce relay link creation to 2.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Default set to reduce relay link creation to 2.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Default set to reduce relay link creation to 2.");
        }
      }
    }
  }

  self->_delayQUICDisconnectionAfterInfo = IMGetCachedDomainIntForKeyWithDefaultValue();
  v61 = +[IDSServerBag sharedInstance];
  v197 = [v61 objectForKey:@"ids-quic-disconnection-delay-after-info-2"];

  if (v197)
  {
    [v197 doubleValue];
    self->_delayQUICDisconnectionAfterInfo = v62;
  }

  v63 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
  {
    delayQUICDisconnectionAfterInfo = self->_delayQUICDisconnectionAfterInfo;
    *buf = 134218242;
    *v203 = delayQUICDisconnectionAfterInfo;
    *&v203[8] = 2112;
    *&v203[10] = v197;
    _os_log_impl(&dword_1A7AD9000, v63, OS_LOG_TYPE_DEFAULT, "QUIC disconnection delay after info request is set to %.1lf (from serverBag: %@)", buf, 0x16u);
  }

  v65 = IMGetDomainBoolForKeyWithDefaultValue();
  v66 = +[IDSServerBag sharedInstance];
  v195 = [v66 objectForKey:@"ids-rtencryption-mkm-over-qr-enabled-v2"];

  if (v195)
  {
    bOOLValue4 = [v195 BOOLValue];
  }

  else
  {
    bOOLValue4 = v65;
  }

  self->_shouldAcceptIncomingMKMOverQR = bOOLValue4;
  v68 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_shouldAcceptIncomingMKMOverQR)
    {
      v69 = @"enabled";
    }

    else
    {
      v69 = @"disabled";
    }

    bOOLValue5 = [v195 BOOLValue];
    v71 = @"NO";
    if (bOOLValue5)
    {
      v72 = @"YES";
    }

    else
    {
      v72 = @"NO";
    }

    *buf = 138412802;
    *v203 = v69;
    *&v203[8] = 2112;
    *&v203[10] = v72;
    if (v65)
    {
      v71 = @"YES";
    }

    v204 = 2112;
    v205 = v71;
    _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "Accepting MKM over QR %@ - serverBag: %@, defaults: %@", buf, 0x20u);
  }

  self->_islocalCellAttributeInexpensive = IMGetDomainBoolForKey();
  if (@"client-uuid")
  {
    v73 = theDict != 0;
  }

  else
  {
    v73 = 0;
  }

  if (v73)
  {
    v74 = CFDictionaryGetValue(theDict, @"client-uuid");
  }

  else
  {
    v74 = 0;
  }

  v192 = v74;
  [(IDSGlobalLink *)self _parseClientUUID:?];
  self->_QRIPv6Enabled = 1;
  v75 = _os_feature_enabled_impl();
  v76 = +[IDSServerBag sharedInstance];
  v194 = [v76 objectForKey:@"ids-quic-for-qr-enabled"];

  if (v75)
  {
    if (v194)
    {
      bOOLValue6 = [v194 BOOLValue];
    }

    else
    {
      bOOLValue6 = 1;
    }
  }

  else
  {
    bOOLValue6 = 0;
  }

  self->_QUICForQREnabled = bOOLValue6;
  v78 = +[IDSServerBag sharedInstance];
  v196 = [v78 objectForKey:@"ids-quic-for-qr-enabled-for-twoway"];

  if (@"qat")
  {
    v79 = theDict != 0;
  }

  else
  {
    v79 = 0;
  }

  if (v79)
  {
    v80 = CFDictionaryGetValue(theDict, @"qat");
  }

  else
  {
    v80 = 0;
  }

  intValue = [v80 intValue];
  v82 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    *v203 = intValue;
    *&v203[4] = 2112;
    *&v203[6] = v196;
    _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v184 = intValue;
      v189 = v196;
      _IDSLogTransport(@"GL", @"IDS", @"QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@");
      if (_IDSShouldLog())
      {
        v184 = intValue;
        v189 = v196;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"QR relay allocation type = %d, server bag ids-quic-for-qr-enabled-for-twoway = %@");
      }
    }
  }

  if (intValue == 1 && v196 && ([v196 BOOLValue] & 1) == 0)
  {
    v83 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Server bag ids-quic-for-qr-enabled-for-idssession is NO and this is a TwoWay allocation. Fallback to STUN");
        }
      }
    }

    self->_QUICForQREnabled = 0;
  }

  v84 = IMGetDomainBoolForKey();
  if (v84)
  {
    self->_QUICForQREnabled = 1;
  }

  v85 = [IDSServerBag sharedInstance:v184];
  v193 = [v85 objectForKey:@"ids-h2-fallback-enabled"];

  v86 = _os_feature_enabled_impl();
  if (self->_QUICForQREnabled & v86)
  {
    if (v193)
    {
      bOOLValue7 = [v193 BOOLValue];
    }

    else
    {
      bOOLValue7 = 1;
    }
  }

  else
  {
    bOOLValue7 = 0;
  }

  self->_H2FallbackEnabled = bOOLValue7;
  self->_H2FallbackEnabled = IMGetDomainBoolForKeyWithDefaultValue();
  v88 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_QUICForQREnabled)
    {
      v89 = @"enabled";
    }

    else
    {
      v89 = @"disabled";
    }

    if (v194)
    {
      if ([v194 BOOLValue])
      {
        v90 = @"YES";
      }

      else
      {
        v90 = @"NO";
      }
    }

    else
    {
      v90 = @"missing";
    }

    if (v75)
    {
      v91 = @"YES";
    }

    else
    {
      v91 = @"NO";
    }

    if (v84)
    {
      v92 = @"YES";
    }

    else
    {
      v92 = @"NO";
    }

    if (self->_H2FallbackEnabled)
    {
      v93 = @"YES";
    }

    else
    {
      v93 = @"NO";
    }

    if (v86)
    {
      v94 = @"YES";
    }

    else
    {
      v94 = @"NO";
    }

    if (v193)
    {
      if ([v193 BOOLValue])
      {
        v95 = @"YES";
      }

      else
      {
        v95 = @"NO";
      }
    }

    else
    {
      v95 = @"missing";
    }

    *buf = 138413826;
    *v203 = v89;
    *&v203[8] = 2112;
    *&v203[10] = v90;
    v204 = 2112;
    v205 = v91;
    v206 = 2112;
    v207 = v92;
    v208 = 2112;
    v209 = v93;
    v210 = 2112;
    v211 = v94;
    v212 = 2112;
    v213 = v95;
    _os_log_impl(&dword_1A7AD9000, v88, OS_LOG_TYPE_DEFAULT, "QUIC for QR %@ - serverBag: %@, feature-flag: %@, forceEnableQUICForQR: %@, _H2FallbackEnabled: %@, H2 feature-flag: %@, H2 server bag: %@", buf, 0x48u);
  }

  if (@"gl-option-preferred-address-family")
  {
    v96 = theDict != 0;
  }

  else
  {
    v96 = 0;
  }

  if (v96)
  {
    v97 = CFDictionaryGetValue(theDict, @"gl-option-preferred-address-family");
  }

  else
  {
    v97 = 0;
  }

  unsignedIntValue = [v97 unsignedIntValue];
  v99 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v99, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *v203 = unsignedIntValue;
    _os_log_impl(&dword_1A7AD9000, v99, OS_LOG_TYPE_DEFAULT, "QR preferredAddressFamily from server: %d", buf, 8u);
  }

  v100 = IMGetCachedDomainIntForKeyWithDefaultValue();
  v101 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *v203 = v100;
    _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "QR preferredAddressFamily after reading from defaults: %d", buf, 8u);
  }

  if (@"gl-option-force-ipv6")
  {
    v102 = theDict != 0;
  }

  else
  {
    v102 = 0;
  }

  if (v102)
  {
    v103 = CFDictionaryGetValue(theDict, @"gl-option-force-ipv6");
  }

  else
  {
    v103 = 0;
  }

  self->_forceIPv6 = [v103 BOOLValue];
  if (self->_QUICForQREnabled)
  {
    if (v100 == 1)
    {
      v104 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v104, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v104, OS_LOG_TYPE_DEFAULT, "client prefers IPv4, disable IPv6.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"client prefers IPv4, disable IPv6.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers IPv4, disable IPv6.");
          }
        }
      }

      self->_QRIPv6Enabled = 0;
    }

    else
    {
      v107 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v107, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v107, OS_LOG_TYPE_DEFAULT, "Add IPv6 address to the interface", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"Add IPv6 address to the interface");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Add IPv6 address to the interface");
          }
        }
      }
    }

    v108 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddressWithNWLink:self->_QRIPv6Enabled wantsWiFi:bOOLValue ^ 1u wantsCellular:bOOLValue2 ^ 1u];
  }

  else
  {
    v105 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:0 wantsWiFi:bOOLValue ^ 1u wantsCellular:bOOLValue2 ^ 1u];
    if (v100 == 1)
    {
      v106 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v106, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v106, OS_LOG_TYPE_DEFAULT, "client prefers IPv4, disable IPv6.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"client prefers IPv4, disable IPv6.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"client prefers IPv4, disable IPv6.");
          }
        }
      }

      self->_QRIPv6Enabled = 0;
    }

    else
    {
      v109 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "Add IPv6 address to the interface", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"Add IPv6 address to the interface");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Add IPv6 address to the interface");
          }
        }
      }

      v110 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:1 wantsWiFi:bOOLValue ^ 1u wantsCellular:bOOLValue2 ^ 1u];
    }
  }

  v111 = +[IDSServerBag sharedInstance];
  v112 = [v111 objectForKey:@"allow-quic-0rtt"];

  if (v112)
  {
    bOOLValue8 = [v112 BOOLValue];
    v114 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
    {
      v115 = @"NO";
      if (bOOLValue8)
      {
        v115 = @"YES";
      }

      *buf = 138412290;
      *v203 = v115;
      _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "shouldEnable0RTT: got server bag value: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v116 = bOOLValue8 ? @"YES" : @"NO";
      v185 = v116;
      _IDSLogTransport(@"GL", @"IDS", @"shouldEnable0RTT: got server bag value: %@");
      if (_IDSShouldLog())
      {
        v185 = v116;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"shouldEnable0RTT: got server bag value: %@");
      }
    }
  }

  v117 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_shouldEnable0RTT = v117;
  v118 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v118, OS_LOG_TYPE_DEFAULT))
  {
    v119 = @"NO";
    if (v117)
    {
      v119 = @"YES";
    }

    *buf = 138412546;
    *v203 = v119;
    *&v203[8] = 2112;
    *&v203[10] = @"YES";
    _os_log_impl(&dword_1A7AD9000, v118, OS_LOG_TYPE_DEFAULT, "_shouldEnable0RTT: %@ (Default: %@)", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v120 = v117 ? @"YES" : @"NO";
    v185 = v120;
    v190 = @"YES";
    _IDSLogTransport(@"GL", @"IDS", @"_shouldEnable0RTT: %@ (Default: %@)");
    if (_IDSShouldLog())
    {
      v185 = v120;
      v190 = @"YES";
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldEnable0RTT: %@ (Default: %@)");
    }
  }

  v121 = 0;
  if (theDict && @"gs-tle-enabled-key")
  {
    v121 = CFDictionaryGetValue(theDict, @"gs-tle-enabled-key");
  }

  self->_isTLEEnabled = [v121 BOOLValue];
  v122 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v122, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isTLEEnabled)
    {
      v123 = @"YES";
    }

    else
    {
      v123 = @"NO";
    }

    *buf = 138412290;
    *v203 = v123;
    _os_log_impl(&dword_1A7AD9000, v122, OS_LOG_TYPE_DEFAULT, "_isTLEEnabled: %@ based on TU passed feature flag", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v124 = self->_isTLEEnabled ? @"YES" : @"NO";
    v186 = v124;
    _IDSLogTransport(@"GL", @"IDS", @"_isTLEEnabled: %@ based on TU passed feature flag");
    if (_IDSShouldLog())
    {
      if (self->_isTLEEnabled)
      {
        v125 = @"YES";
      }

      else
      {
        v125 = @"NO";
      }

      v186 = v125;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isTLEEnabled: %@ based on TU passed feature flag");
    }
  }

  v126 = 0;
  if (theDict && @"gs-partial-tle-u-plus-one-enabled-key")
  {
    v126 = CFDictionaryGetValue(theDict, @"gs-partial-tle-u-plus-one-enabled-key");
  }

  self->_isPartialTLEUPlusOneEnabled = [v126 BOOLValue];
  v127 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v127, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isPartialTLEUPlusOneEnabled)
    {
      v128 = @"YES";
    }

    else
    {
      v128 = @"NO";
    }

    *buf = 138412290;
    *v203 = v128;
    _os_log_impl(&dword_1A7AD9000, v127, OS_LOG_TYPE_DEFAULT, "_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v129 = self->_isPartialTLEUPlusOneEnabled ? @"YES" : @"NO";
    v187 = v129;
    _IDSLogTransport(@"GL", @"IDS", @"_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag");
    if (_IDSShouldLog())
    {
      if (self->_isPartialTLEUPlusOneEnabled)
      {
        v130 = @"YES";
      }

      else
      {
        v130 = @"NO";
      }

      v187 = v130;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_isPartialTLEUPlusOneEnabled: %@ based on TU passed feature flag");
    }
  }

  v131 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_forceTLE = v131;
  v132 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT))
  {
    v133 = @"NO";
    if (v131)
    {
      v133 = @"YES";
    }

    *buf = 138412290;
    *v203 = v133;
    _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "forceTLE: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v134 = v131 ? @"YES" : @"NO";
    v187 = v134;
    _IDSLogTransport(@"GL", @"IDS", @"forceTLE: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v134;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"forceTLE: %@ based on defaults");
    }
  }

  v135 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_forceP2PTLE = v135;
  v136 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
  {
    v137 = @"NO";
    if (v135)
    {
      v137 = @"YES";
    }

    *buf = 138412290;
    *v203 = v137;
    _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "forceP2PTLE: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v138 = v135 ? @"YES" : @"NO";
    v187 = v138;
    _IDSLogTransport(@"GL", @"IDS", @"forceP2PTLE: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v138;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"forceP2PTLE: %@ based on defaults");
    }
  }

  v139 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowTLEOverCellular = v139;
  v140 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v140, OS_LOG_TYPE_DEFAULT))
  {
    v141 = @"NO";
    if (v139)
    {
      v141 = @"YES";
    }

    *buf = 138412290;
    *v203 = v141;
    _os_log_impl(&dword_1A7AD9000, v140, OS_LOG_TYPE_DEFAULT, "allowTLEOverCellular: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v142 = v139 ? @"YES" : @"NO";
    v187 = v142;
    _IDSLogTransport(@"GL", @"IDS", @"allowTLEOverCellular: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v142;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"allowTLEOverCellular: %@ based on defaults");
    }
  }

  v143 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowTLEOverVRLinks = v143;
  v144 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v144, OS_LOG_TYPE_DEFAULT))
  {
    v145 = @"NO";
    if (v143)
    {
      v145 = @"YES";
    }

    *buf = 138412290;
    *v203 = v145;
    _os_log_impl(&dword_1A7AD9000, v144, OS_LOG_TYPE_DEFAULT, "allowTLEOverVRLinks: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v146 = v143 ? @"YES" : @"NO";
    v187 = v146;
    _IDSLogTransport(@"GL", @"IDS", @"allowTLEOverVRLinks: %@ based on defaults");
    if (_IDSShouldLog())
    {
      v187 = v146;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"allowTLEOverVRLinks: %@ based on defaults");
    }
  }

  keyExistsAndHasValidFormat = 0;
  v147 = CFPreferencesGetAppBooleanValue(@"serverTestOptionTLEDisabled", @"com.apple.ids", &keyExistsAndHasValidFormat) != 0;
  v148 = keyExistsAndHasValidFormat;
  if (((keyExistsAndHasValidFormat == 0) & v131) == 1)
  {
    v147 = 0;
    v148 = 1;
    keyExistsAndHasValidFormat = 1;
  }

  self->_shouldOverrideServerTestOptionTLEDisabled = v148 != 0;
  self->_serverTestOptionTLEDisabled = v147;
  self->_disableDirectDatapath = IMGetDomainBoolForKeyWithDefaultValue();
  v149 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_disableDirectDatapath)
    {
      v150 = @"YES";
    }

    else
    {
      v150 = @"NO";
    }

    *buf = 138412290;
    *v203 = v150;
    _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "direct datapath: _disableDirectDatapath: %@ based on defaults", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v151 = self->_disableDirectDatapath ? @"YES" : @"NO";
    v187 = v151;
    _IDSLogTransport(@"GL", @"IDS", @"direct datapath: _disableDirectDatapath: %@ based on defaults");
    if (_IDSShouldLog())
    {
      if (self->_disableDirectDatapath)
      {
        v152 = @"YES";
      }

      else
      {
        v152 = @"NO";
      }

      v187 = v152;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"direct datapath: _disableDirectDatapath: %@ based on defaults");
    }
  }

  v153 = +[IDSNWLink isSkywalkDemuxSupported];
  if ((v153 & 1) == 0)
  {
    self->_disableDirectDatapath = 1;
    v154 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v154, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v154, OS_LOG_TYPE_DEFAULT, "direct datapath: NO because Skywalk Demux is not supported", buf, 2u);
    }

    v153 = os_log_shim_legacy_logging_enabled();
    if (v153)
    {
      v153 = _IDSShouldLogTransport();
      if (v153)
      {
        _IDSLogTransport(@"GL", @"IDS", @"direct datapath: NO because Skywalk Demux is not supported");
        v153 = _IDSShouldLog();
        if (v153)
        {
          v153 = _IDSLogV(0, @"IDSFoundation", @"GL", @"direct datapath: NO because Skywalk Demux is not supported");
        }
      }
    }
  }

  if ((bOOLValue & 1) == 0)
  {
    self->_wifiNWPathFlags = -1;
    v155 = MEMORY[0x1AC564230](v153);
    nw_parameters_set_required_interface_type(v155, nw_interface_type_wifi);
    evaluator_for_endpoint = nw_path_create_evaluator_for_endpoint();
    wifiPathEvaluator = self->_wifiPathEvaluator;
    self->_wifiPathEvaluator = evaluator_for_endpoint;

    v158 = im_primary_queue();
    nw_path_evaluator_set_update_handler();
  }

  if ((bOOLValue2 & 1) == 0)
  {
    self->_cellularNWPathFlags = -1;
    v159 = MEMORY[0x1AC564230](v153);
    nw_parameters_set_required_interface_type(v159, nw_interface_type_cellular);
    v160 = nw_path_create_evaluator_for_endpoint();
    cellularPathEvaluator = self->_cellularPathEvaluator;
    self->_cellularPathEvaluator = v160;

    v162 = im_primary_queue();
    nw_path_evaluator_set_update_handler();
  }

  self->_allowOnlyOneQR = 0;
  if (IMGetDomainBoolForKey())
  {
    self->_allowP2P = 0;
LABEL_413:
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
LABEL_417:

      goto LABEL_418;
    }

    *buf = 0;
    v165 = "forceQuickRelay or disableP2PLinks default is set to YES.";
    goto LABEL_415;
  }

  v163 = IMGetDomainBoolForKeyWithDefaultValue();
  self->_allowP2P = v163 ^ 1;
  if (((v163 ^ 1) & 1) == 0)
  {
    goto LABEL_413;
  }

  v178 = 0;
  if (theDict && @"gl-option-forcerelay")
  {
    v178 = CFDictionaryGetValue(theDict, @"gl-option-forcerelay");
  }

  if ([v178 BOOLValue])
  {
    *&self->_allowOnlyOneQR = 1;
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_417;
    }

    *buf = 0;
    v165 = "forceRelay option is set to YES.";
LABEL_415:
    v166 = v164;
    v167 = 2;
LABEL_416:
    _os_log_impl(&dword_1A7AD9000, v166, OS_LOG_TYPE_DEFAULT, v165, buf, v167);
    goto LABEL_417;
  }

  if (!self->_clientType)
  {
    *&self->_allowOnlyOneQR = 1;
    v164 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_417;
    }

    clientType = self->_clientType;
    *buf = 67109120;
    *v203 = clientType;
    v165 = "use forceQuickRelay for client: %d.";
    v166 = v164;
    v167 = 8;
    goto LABEL_416;
  }

LABEL_418:
  v168 = 0;
  if (theDict && @"gs-force-tcp-fallback-on-wifi-key")
  {
    v168 = CFDictionaryGetValue(theDict, @"gs-force-tcp-fallback-on-wifi-key");
  }

  self->_forceTCPFallbackOnWiFi = [v168 BOOLValue];
  if (@"gs-force-tcp-fallback-on-cell-key")
  {
    v169 = theDict != 0;
  }

  else
  {
    v169 = 0;
  }

  if (v169)
  {
    v170 = CFDictionaryGetValue(theDict, @"gs-force-tcp-fallback-on-cell-key");
  }

  else
  {
    v170 = 0;
  }

  self->_forceTCPFallbackOnCell = [v170 BOOLValue];
  if (@"gs-shortmki-enabled-key")
  {
    v171 = theDict != 0;
  }

  else
  {
    v171 = 0;
  }

  if (v171)
  {
    v172 = CFDictionaryGetValue(theDict, @"gs-shortmki-enabled-key");
  }

  else
  {
    v172 = 0;
  }

  self->_isShortMKIEnabled = [v172 BOOLValue];
  if (@"gs-gecko-enabled-key")
  {
    v173 = theDict != 0;
  }

  else
  {
    v173 = 0;
  }

  if (v173)
  {
    v174 = CFDictionaryGetValue(theDict, @"gs-gecko-enabled-key");
  }

  else
  {
    v174 = 0;
  }

  self->_isGeckoEnabled = [v174 BOOLValue];
  *&self->_callModeUpdateGenerationCounter = 0x100000001;
  if (@"gs-started-as-u-plus-one-key")
  {
    v175 = theDict != 0;
  }

  else
  {
    v175 = 0;
  }

  if (v175)
  {
    v176 = CFDictionaryGetValue(theDict, @"gs-started-as-u-plus-one-key");
  }

  else
  {
    v176 = 0;
  }

  if ([v176 BOOLValue])
  {
    [(IDSGlobalLink *)self setIsUPlusOneSession:1];
    self->_shouldReportAcceptDelay = 1;
  }

  else
  {
    [(IDSGlobalLink *)self setIsUPlusOneSession:0];
  }

  v177 = 0;
  if (theDict && @"gl-option-qra-blocks")
  {
    v177 = CFDictionaryGetValue(theDict, @"gl-option-qra-blocks");
  }

  objc_storeStrong(&self->_qraBlocks, v177);
  self->_calleeAcceptTime = ids_monotonic_time();
  self->_delayFirstConnectionData = IMGetDomainIntForKey();

LABEL_452:
}

- (BOOL)_isNWPathFlagsChanged:(id)changed existingPath:(unsigned __int16 *)path
{
  v22 = *MEMORY[0x1E69E9840];
  changedCopy = changed;
  v6 = changedCopy;
  if (!changedCopy)
  {
    v11 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "invalid path, return", v19, 2u);
    }

    goto LABEL_20;
  }

  v7 = MEMORY[0x1AC564440](changedCopy);
  v8 = +[IDSFoundationLog GlobalLink];
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT);
  if (v7)
  {
    if (v9)
    {
      LOWORD(v19[0]) = 0;
      v10 = 2;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Constrained", v19, 2u);
    }

    else
    {
      v10 = 2;
    }
  }

  else
  {
    if (v9)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Not constrained", v19, 2u);
    }

    v10 = 0;
  }

  v12 = MEMORY[0x1AC564450](v6);
  v13 = +[IDSFoundationLog GlobalLink];
  v14 = os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
  if (v12)
  {
    if (v14)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Expensive", v19, 2u);
    }

    v10 |= 1u;
  }

  else
  {
    if (v14)
    {
      LOWORD(v19[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: Inexpensive", v19, 2u);
    }
  }

  if (v10 == *path)
  {
LABEL_20:
    v15 = 0;
    goto LABEL_24;
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = *path;
    v19[0] = 67109376;
    v19[1] = v17;
    v20 = 1024;
    v21 = v10;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "_isNWPathFlagsChanged: existingPath: %u changed to curNWPathFlags: %u", v19, 0xEu);
  }

  *path = v10;
  v15 = 1;
LABEL_24:

  return v15;
}

- (void)_handle_wifi_path:(id)_handle_wifi_path nwEndPoind:(id)poind
{
  v16 = *MEMORY[0x1E69E9840];
  if (self->_state != 4)
  {
    v9 = [IDSFoundationLog GlobalLink:_handle_wifi_path];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v11 = _IDSLinkStateStrings[self->_state];
      v12 = 138412546;
      v13 = idsSessionID;
      v14 = 2080;
      v15 = v11;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_handle_wifi_path: Session with IDSSessionID: %@ is not connected, state [%s].", &v12, 0x16u);
    }

    goto LABEL_9;
  }

  if ([(IDSGlobalLink *)self _isNWPathFlagsChanged:_handle_wifi_path existingPath:&self->_wifiNWPathFlags])
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      wifiNWPathFlags = self->_wifiNWPathFlags;
      v12 = 67109120;
      LODWORD(v13) = wifiNWPathFlags;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_handle_wifi_path: for _wifiNWPathFlags: %u", &v12, 8u);
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v8 = objc_opt_respondsToSelector();

    if (v8)
    {
      v9 = objc_loadWeakRetained(&self->_delegate);
      [v9 link:self didWiFiNWPathFlagsChanged:self->_wifiNWPathFlags];
LABEL_9:
    }
  }
}

- (void)_handle_cellular_path:(id)_handle_cellular_path nwEndPoind:(id)poind
{
  v23 = *MEMORY[0x1E69E9840];
  _handle_cellular_pathCopy = _handle_cellular_path;
  v6 = _handle_cellular_pathCopy;
  if (self->_state != 4)
  {
    v12 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_13;
    }

    idsSessionID = self->_idsSessionID;
    v14 = _IDSLinkStateStrings[self->_state];
    v19 = 138412546;
    v20 = idsSessionID;
    v21 = 2080;
    v22 = v14;
    v15 = "_handle_cellular_path: Session with IDSSessionID: %@ is not connected, state [%s].";
    v16 = v12;
    v17 = 22;
LABEL_12:
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, v15, &v19, v17);
    goto LABEL_13;
  }

  status = nw_path_get_status(_handle_cellular_pathCopy);
  if (status != nw_path_status_satisfied)
  {
    v18 = status;
    v12 = +[IDSFoundationLog GlobalLink];
    if (!os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_13;
    }

    v19 = 67109120;
    LODWORD(v20) = v18;
    v15 = "_handle_cellular_path: nw_path_status is: %d, return";
    v16 = v12;
    v17 = 8;
    goto LABEL_12;
  }

  [(IDSGlobalLink *)self _processDelayedCellularInterfaces];
  if ([(IDSGlobalLink *)self _isNWPathFlagsChanged:v6 existingPath:&self->_cellularNWPathFlags])
  {
    v8 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      cellularNWPathFlags = self->_cellularNWPathFlags;
      v19 = 67109120;
      LODWORD(v20) = cellularNWPathFlags;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_handle_cellular_path: for _cellularNWPathFlags: %u", &v19, 8u);
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v11 = objc_opt_respondsToSelector();

    if (v11)
    {
      v12 = objc_loadWeakRetained(&self->_delegate);
      [v12 link:self didCellularNWPathFlagsChanged:self->_cellularNWPathFlags];
LABEL_13:
    }
  }
}

- (unint64_t)defaultLinkType
{
  v15 = *MEMORY[0x1E69E9840];
  v3 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v3 && !*(v3 + 1))
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "no default link is specified yet.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"no default link is specified yet.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no default link is specified yet.");
        }
      }
    }

    return 0;
  }

  else
  {
    v4 = channelForStunCandidatePair((v3 + 1), (v3 + 17), *(v3 + 132));
    channelToCandidatePairs = self->_channelToCandidatePairs;
    if (channelToCandidatePairs && v4 && (v6 = CFDictionaryGetValue(channelToCandidatePairs, v4)) != 0)
    {
      v7 = v6;
      local = [v6 local];
      if ([local isCellularStunCandidate])
      {
        v9 = 4;
      }

      else
      {
        v9 = 3;
      }
    }

    else
    {
      v10 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v14 = v4;
        _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "failed to find default link for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find default link for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find default link for %@.");
          }
        }
      }

      v9 = 0;
    }
  }

  return v9;
}

- (BOOL)hasReachableInterface:(unint64_t)interface
{
  v16 = *MEMORY[0x1E69E9840];
  if (interface)
  {
    v3 = 30;
  }

  else
  {
    v3 = 2;
  }

  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v5)
  {
    v6 = *v12;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v4);
        }

        address = [*(*(&v11 + 1) + 8 * i) address];
        v9 = address;
        if (address && v3 == *([address sa] + 1))
        {

          LOBYTE(v5) = 1;
          goto LABEL_15;
        }
      }

      v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v11 objects:v15 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

LABEL_15:

  return v5;
}

- (void)_addQRAAWDBlock:(id)block allocateRequestTime:(double)time inferredExternalRAT:(unsigned int)t stunTransport:(int64_t)transport relayProviderType:(int64_t)type idsSessionID:(id)d reportingDataBlob:(id)blob isInitiator:(BOOL)self0 serverSoftwareVersion:(id)self1
{
  blockCopy = block;
  dCopy = d;
  blobCopy = blob;
  versionCopy = version;
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B70D74;
  aBlock[3] = &unk_1E77E0BE8;
  initiatorCopy = initiator;
  timeCopy = time;
  tCopy = t;
  v21 = blockCopy;
  v32 = v21;
  v22 = versionCopy;
  v33 = v22;
  selfCopy = self;
  typeCopy = type;
  transportCopy = transport;
  v23 = dCopy;
  v35 = v23;
  v24 = blobCopy;
  v36 = v24;
  v25 = _Block_copy(aBlock);
  v26 = [v25 copy];

  allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  if (!allocateTimeReportBlocks)
  {
    v28 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v29 = self->_allocateTimeReportBlocks;
    self->_allocateTimeReportBlocks = v28;

    allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
  }

  if (allocateTimeReportBlocks && v26)
  {
    CFArrayAppendValue(allocateTimeReportBlocks, v26);
  }
}

- (unsigned)_getExternalIPAddressRAT:(id)t
{
  tCopy = t;
  v5 = [tCopy length];
  if (v5 == 16)
  {
    memset(&v11[1], 170, 20);
    v11[0] = 0xAAAAAAAAAAAAAAAALL;
    *&v11[1] = *[tCopy bytes];
    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    RATForIPv6Address = GLUtilGetRATForIPv6Address(v11, allValues);
  }

  else if (v5 == 4)
  {
    LODWORD(v11[0]) = 0;
    [tCopy getBytes:v11 length:4];
    v6 = v11[0];
    allValues2 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    RATForIPv6Address = GLUtilGetRATForIPv4Address(v6, allValues2);
  }

  else
  {
    RATForIPv6Address = 10;
  }

  return RATForIPv6Address;
}

- (BOOL)_isAcceptedRelaySessionForAllocationRequestID:(id)d acceptedRelaySessionID:(id)iD
{
  iDCopy = iD;
  v7 = (([(NSMutableArray *)self->_targetedAllocations containsObject:d]& 1) != 0 || [(NSString *)self->_acceptedRelaySessionID isEqualToString:iDCopy]) && self->_isInitiator;

  return v7;
}

- (void)_connectNWTCPLink:(id)link disconnectAfterUse:(BOOL)use connectedHandler:(id)handler
{
  linkCopy = link;
  handlerCopy = handler;
  v34[0] = 0;
  local = [linkCopy local];
  index = [local index];

  local2 = [linkCopy local];
  address = [local2 address];

  v13 = *(address + 1);
  if (v13 == 30 || v13 == 2)
  {
    *(address + 2) = 0;
  }

  remote = [linkCopy remote];
  external = [remote external];

  [linkCopy setIsQUIC:1];
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B714AC;
  aBlock[3] = &unk_1E77E0C10;
  v17 = linkCopy;
  v33 = v17;
  v18 = _Block_copy(aBlock);
  if (!use)
  {
    [v17 setState:1];
  }

  if (IMGetDomainBoolForKey())
  {
    v19 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "forceH2FallbackToTCP enabled, fallback to TCP STUN", buf, 2u);
    }
  }

  else
  {
    nwLink = self->_nwLink;
    sessionID = [v17 sessionID];
    relaySessionToken = [v17 relaySessionToken];
    relaySessionKey = [v17 relaySessionKey];
    v28[0] = MEMORY[0x1E69E9820];
    v28[1] = 3221225472;
    v28[2] = sub_1A7B71580;
    v28[3] = &unk_1E77E0C38;
    v28[4] = self;
    v22 = v17;
    v29 = v22;
    v30 = handlerCopy;
    LOBYTE(v24) = use;
    v23 = [(IDSNWLink *)nwLink connectTCP:index localAddress:address remoteAddress:external clientUUID:self->_clientUUID sessionID:sessionID relaySessionToken:relaySessionToken relaySessionKey:relaySessionKey randomSaltBlock:v18 newLocalPort:v34 disconnectAfterUse:v24 readyHandler:v28];

    if (v23 && v34[0])
    {
      [(IDSGlobalLink *)self _updateCandidatePair:v22 newLocalPort:?];
    }
  }
}

- (void)_connectNWLink:(id)link disconnectAfterUse:(BOOL)use connectedHandler:(id)handler
{
  v63 = *MEMORY[0x1E69E9840];
  linkCopy = link;
  handlerCopy = handler;
  v54 = 0;
  local = [linkCopy local];
  index = [local index];

  local2 = [linkCopy local];
  address = [local2 address];

  remote = [linkCopy remote];
  external = [remote external];

  [linkCopy setIsQUIC:1];
  if (self->_ftPowerOptimizationEnabled && [linkCopy isRelayStunCandidatePair])
  {
    local3 = [linkCopy local];
    if ([local3 isCellularStunCandidate])
    {
      isQUIC = [linkCopy isQUIC];

      if (isQUIC)
      {
        [linkCopy switchToOptimizedStatsInterval];
      }
    }

    else
    {
    }
  }

  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = sub_1A7B71F9C;
  aBlock[3] = &unk_1E77E0C10;
  v14 = linkCopy;
  v53 = v14;
  v15 = _Block_copy(aBlock);
  if (!use)
  {
    [v14 setState:1];
  }

  v16 = IMGetDomainBoolForKey();
  v17 = IMGetDomainBoolForKey();
  v18 = v17;
  if (v16)
  {
    v19 = 0;
    if ((v17 & 1) == 0)
    {
LABEL_11:
      forceTCPFallbackOnCell = self->_forceTCPFallbackOnCell;
      goto LABEL_14;
    }
  }

  else
  {
    v19 = !self->_forceTCPFallbackOnWiFi;
    if ((v17 & 1) == 0)
    {
      goto LABEL_11;
    }
  }

  forceTCPFallbackOnCell = 1;
LABEL_14:
  v21 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    v22 = @"NO";
    if (v16)
    {
      v23 = @"YES";
    }

    else
    {
      v23 = @"NO";
    }

    v24 = self->_forceTCPFallbackOnCell;
    if (self->_forceTCPFallbackOnWiFi)
    {
      v25 = @"YES";
    }

    else
    {
      v25 = @"NO";
    }

    *buf = 138413058;
    v56 = v23;
    if (v18)
    {
      v26 = @"YES";
    }

    else
    {
      v26 = @"NO";
    }

    v57 = 2112;
    v58 = v25;
    if (v24)
    {
      v22 = @"YES";
    }

    v59 = 2112;
    v60 = v26;
    v61 = 2112;
    v62 = v22;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "connectNWLink forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
  }

  local4 = [v14 local];
  isCellularStunCandidate = [local4 isCellularStunCandidate];

  if ((v19 | isCellularStunCandidate))
  {
    if (forceTCPFallbackOnCell & isCellularStunCandidate)
    {
      v29 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        v30 = "forceTCPFallbackOnWiFi is set, dont connect via cellular interface";
LABEL_33:
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, v30, buf, 2u);
      }
    }

    else
    {
      nwLink = self->_nwLink;
      sessionID = [v14 sessionID];
      relaySessionToken = [v14 relaySessionToken];
      relaySessionKey = [v14 relaySessionKey];
      pskTransportParameters = [v14 pskTransportParameters];
      pskH3Settings = [v14 pskH3Settings];
      v34 = v15;
      shouldEnable0RTT = self->_shouldEnable0RTT;
      shouldUsePathMTUDiscovery = self->_shouldUsePathMTUDiscovery;
      v47[0] = MEMORY[0x1E69E9820];
      v47[1] = 3221225472;
      v47[2] = sub_1A7B72070;
      v47[3] = &unk_1E77E0C60;
      useCopy = use;
      v39 = v14;
      v48 = v39;
      selfCopy = self;
      v50 = handlerCopy;
      BYTE2(v38) = shouldUsePathMTUDiscovery;
      BYTE1(v38) = shouldEnable0RTT;
      v15 = v34;
      LOBYTE(v38) = use;
      v37 = [IDSNWLink connect:"connect:localAddress:remoteAddress:clientUUID:sessionID:relaySessionToken:relaySessionKey:randomSaltBlock:pskTransportParameters:pskH3Settings:newLocalPort:disconnectAfterUse:holdUntilFirstPacketReady:usePathMTUDiscovery:readyHandler:" localAddress:index remoteAddress:address clientUUID:external sessionID:self->_clientUUID relaySessionToken:sessionID relaySessionKey:relaySessionToken randomSaltBlock:relaySessionKey pskTransportParameters:v34 pskH3Settings:pskTransportParameters newLocalPort:pskH3Settings disconnectAfterUse:&v54 holdUntilFirstPacketReady:v38 usePathMTUDiscovery:v47 readyHandler:?];

      if (v37 && v54)
      {
        [(IDSGlobalLink *)self _updateCandidatePair:v39 newLocalPort:?];
      }

      v29 = v48;
    }
  }

  else
  {
    v29 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v30 = "forceTCPFallbackOnWiFi is set, dont connect via WiFi interface";
      goto LABEL_33;
    }
  }
}

- (void)setLinkSelectionStrategy:(id)strategy
{
  v11 = *MEMORY[0x1E69E9840];
  strategyCopy = strategy;
  v6 = strategyCopy;
  if (self->_isLinkSelectionStrategyLockedIn)
  {
    v7 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: setLinkSelectionStrategy cannot set strategy; strategy is already locked in.");
        }
      }
    }
  }

  else if (strategyCopy && (IMGetDomainBoolForKeyWithDefaultValue() & 1) == 0)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v10 = v6;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Setting Link Selection Strategy: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Setting Link Selection Strategy: %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting Link Selection Strategy: %@");
        }
      }
    }

    objc_storeStrong(&self->_linkSelectionStrategy, strategy);
  }
}

- (id)allLinkEngines
{
  v19 = *MEMORY[0x1E69E9840];
  v3 = [MEMORY[0x1E695DFA8] set];
  v4 = v3;
  if (self->_p2pLinkEngine)
  {
    [v3 addObject:?];
  }

  v16 = 0u;
  v17 = 0u;
  v14 = 0u;
  v15 = 0u;
  allValues = [(NSMutableDictionary *)self->_sessionsByID allValues];
  v6 = [allValues countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(allValues);
        }

        v10 = *(*(&v14 + 1) + 8 * i);
        linkEngine = [v10 linkEngine];

        if (linkEngine)
        {
          linkEngine2 = [v10 linkEngine];
          [v4 addObject:linkEngine2];
        }
      }

      v7 = [allValues countByEnumeratingWithState:&v14 objects:v18 count:16];
    }

    while (v7);
  }

  return v4;
}

- (id)_localCandidatesForRelaySession:(id)session
{
  v38 = *MEMORY[0x1E69E9840];
  linkEngine = [session linkEngine];
  v5 = [linkEngine tag];
  v6 = v5;
  v7 = &stru_1F1AC8480;
  if (v5)
  {
    v7 = v5;
  }

  v26 = v7;

  if (self->_state < 5)
  {
    array = [MEMORY[0x1E695DF70] array];
    v27 = 0u;
    v28 = 0u;
    v29 = 0u;
    v30 = 0u;
    v8 = self->_interfaceAddressArray;
    v10 = [(NSMutableArray *)v8 countByEnumeratingWithState:&v27 objects:v31 count:16];
    if (!v10)
    {
      goto LABEL_29;
    }

    v11 = v10;
    v12 = *v28;
    while (1)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v28 != v12)
        {
          objc_enumerationMutation(v8);
        }

        v14 = *(*(&v27 + 1) + 8 * i);
        v15 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          v33 = v26;
          v34 = 2112;
          selfCopy = v14;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: checking %@", buf, 0x16u);
        }

        address = [(IDSGlobalLink *)v14 address];
        valid = IsValidSA([address sa]);

        if (valid)
        {
          address2 = [(IDSGlobalLink *)v14 address];
          if (*([address2 sa] + 1) == 2)
          {
            clat46 = [(IDSGlobalLink *)v14 clat46];

            if (clat46)
            {
              v20 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412546;
                v33 = v26;
                v34 = 2112;
                selfCopy = v14;
                _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: skipping clat46 ipv4 address %@", buf, 0x16u);
              }

              goto LABEL_26;
            }
          }

          else
          {
          }

          v20 = GLUtilCreateLocalCandidateForLinkEngine(v14);
          [v20 setPrefix:IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, [(IDSGlobalLink *)v14 index])];
          v23 = 0;
          if (self->_cellInterfaceName)
          {
            if ([v20 isCellularStunCandidate])
            {
              interfaceName = [v20 interfaceName];
              v22 = [interfaceName isEqualToIgnoringCase:self->_cellInterfaceName];

              if (v22)
              {
                v23 = 1;
              }
            }
          }

          [v20 setIsSlicedInterface:v23];
          [array addObject:v20];
LABEL_26:

          continue;
        }
      }

      v11 = [(NSMutableArray *)v8 countByEnumeratingWithState:&v27 objects:v31 count:16];
      if (!v11)
      {
        goto LABEL_29;
      }
    }
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(&v8->super.super, OS_LOG_TYPE_DEFAULT))
  {
    v9 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    v33 = v26;
    v34 = 2112;
    selfCopy = self;
    v36 = 2080;
    v37 = v9;
    _os_log_impl(&dword_1A7AD9000, &v8->super.super, OS_LOG_TYPE_DEFAULT, "_localCandidatesForRelaySession[%@]: %@ is in [%s] state, should have no active links.", buf, 0x20u);
  }

  array = MEMORY[0x1E695E0F0];
LABEL_29:

  return array;
}

- (id)_remoteCandidatesForRelaySession:(id)session
{
  v72 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  linkEngine = [sessionCopy linkEngine];
  v6 = [linkEngine tag];
  v7 = v6;
  v8 = &stru_1F1AC8480;
  if (v6)
  {
    v8 = v6;
  }

  v44 = v8;

  if (self->_state < 5)
  {
    v70 = 0u;
    v71 = 0u;
    v68 = 0u;
    v69 = 0u;
    v66 = 0u;
    v67 = 0u;
    memset(buf, 0, sizeof(buf));
    memset(v64, 0, sizeof(v64));
    serverAddress = [sessionCopy serverAddress];
    serverAddressV6 = [sessionCopy serverAddressV6];
    if (IMGetDomainBoolForKeyWithDefaultValue())
    {
      v14 = 0;
    }

    else
    {
      v14 = serverAddressV6;
    }

    if (serverAddress)
    {
      __memcpy_chk();
    }

    if (v14)
    {
      __memcpy_chk();
    }

    array = [MEMORY[0x1E695DF70] array];
    if (IsValidSA(serverAddress))
    {
      v15 = GLUtilCreateRelayCandidateForLinkEngine(buf, 0, 0);
      [array addObject:v15];
    }

    if (IsValidSA(v14))
    {
      v16 = GLUtilCreateRelayCandidateForLinkEngine(v64, 0, 0);
      [array addObject:v16];
    }

    else
    {
      v53 = 0u;
      v54 = 0u;
      v51 = 0u;
      v52 = 0u;
      v16 = self->_interfaceAddressArray;
      v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v51 objects:v63 count:16];
      if (v17)
      {
        v18 = *v52;
        do
        {
          v19 = 0;
          do
          {
            if (*v52 != v18)
            {
              objc_enumerationMutation(v16);
            }

            v20 = *(*(&v51 + 1) + 8 * v19);
            address = [v20 address];
            if (IsValidSA([address sa]))
            {
              address2 = [v20 address];
              v23 = *([address2 sa] + 1) == 30;

              if (v23)
              {
                FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, [v20 index]);
                if (FirstPrefix)
                {
                  v25 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
                  {
                    index = [v20 index];
                    *v56 = 138412546;
                    *&v56[4] = v44;
                    *&v56[12] = 1024;
                    *&v56[14] = index;
                    _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d", v56, 0x12u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v41 = v44;
                      index2 = [v20 index];
                      _IDSLogTransport(@"GL", @"IDS", @"_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d");
                      if (_IDSShouldLog())
                      {
                        index3 = [v20 index];
                        v41 = v44;
                        index2 = index3;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_remoteCandidatesForRelaySession[%@]: nat64 prefix cache hit for if:%d");
                      }
                    }
                  }

                  *&v28 = 0xAAAAAAAAAAAAAAAALL;
                  *(&v28 + 1) = 0xAAAAAAAAAAAAAAAALL;
                  v61 = v28;
                  v62 = v28;
                  v59 = v28;
                  v60 = v28;
                  v57 = v28;
                  v58 = v28;
                  *v56 = v28;
                  *&v56[16] = v28;
                  if ([(IDSGlobalLink *)self _synthesizeNAT64ForAddress:buf withPrefix:FirstPrefix toAddress:v56, v41, index2])
                  {
                    v29 = GLUtilCreateRelayCandidateForLinkEngine(v56, 1, [v20 index]);
                    [v29 setIsNAT64:1];
                    [v29 setPrefix:FirstPrefix];
                    [array addObject:v29];
                  }
                }

                else
                {
                  v30 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
                  {
                    index4 = [v20 index];
                    *v56 = 138412546;
                    *&v56[4] = v44;
                    *&v56[12] = 1024;
                    *&v56[14] = index4;
                    _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.", v56, 0x12u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v41 = v44;
                      index2 = [v20 index];
                      _IDSLogTransport(@"GL", @"IDS", @"_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.");
                      if (_IDSShouldLog())
                      {
                        index5 = [v20 index];
                        v41 = v44;
                        index2 = index5;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_remoteCandidatesForRelaySession[%@]: delay connectWithSessionInfo for if:%d nat64 prefix.");
                      }
                    }
                  }

                  aBlock[0] = MEMORY[0x1E69E9820];
                  aBlock[1] = 3221225472;
                  aBlock[2] = sub_1A7B734A0;
                  aBlock[3] = &unk_1E77E0C88;
                  aBlock[4] = self;
                  v50 = sessionCopy;
                  v33 = _Block_copy(aBlock);
                  index6 = [v20 index];
                  name = [v20 name];
                  [(IDSGlobalLink *)self _getNAT64PrefixForInterface:index6 interfaceName:name completionBlock:v33];
                }
              }
            }

            else
            {
            }

            ++v19;
          }

          while (v17 != v19);
          v36 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v51 objects:v63 count:16];
          v17 = v36;
        }

        while (v36);
      }
    }

    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    v46 = 0u;
    v11 = array;
    v37 = [v11 countByEnumeratingWithState:&v45 objects:v55 count:16];
    if (v37)
    {
      v38 = *v46;
      do
      {
        for (i = 0; i != v37; ++i)
        {
          if (*v46 != v38)
          {
            objc_enumerationMutation(v11);
          }

          [*(*(&v45 + 1) + 8 * i) setIsRealloc:{objc_msgSend(sessionCopy, "hasReceivedReallocIndication", v41, index2)}];
        }

        v37 = [v11 countByEnumeratingWithState:&v45 objects:v55 count:16];
      }

      while (v37);
    }
  }

  else
  {
    v9 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      *&buf[4] = v44;
      *&buf[12] = 2112;
      *&buf[14] = self;
      *&buf[22] = 2080;
      *&buf[24] = v10;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_remoteCandidatesForRelaySession[%@]: %@ is in [%s] state, should have no active links.", buf, 0x20u);
    }

    v11 = MEMORY[0x1E695E0F0];
  }

  return v11;
}

- (int)_knownRemoteAvailableInterfaces
{
  v16 = *MEMORY[0x1E69E9840];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v2 = self->_remoteCandidateList;
  v3 = [(NSMutableArray *)v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = 0;
    v6 = *v12;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v2);
        }

        v8 = *(*(&v11 + 1) + 8 * i);
        if (([v8 linkFlags] & 4) == 0)
        {
          if ([v8 isCellularStunCandidate])
          {
            v9 = 1;
          }

          else
          {
            v9 = 2;
          }

          v5 |= v9;
        }
      }

      v4 = [(NSMutableArray *)v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v4);
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (BOOL)_isSessionAccepted:(id)accepted
{
  v30 = *MEMORY[0x1E69E9840];
  acceptedCopy = accepted;
  v5 = acceptedCopy;
  if (self->_remoteAcceptedDevicePushTokens)
  {
    v26 = 0u;
    v27 = 0u;
    v24 = 0u;
    v25 = 0u;
    remotePushTokens = [acceptedCopy remotePushTokens];
    v7 = [remotePushTokens countByEnumeratingWithState:&v24 objects:v29 count:16];
    if (v7)
    {
      v8 = v7;
      v9 = *v25;
      v19 = *v25;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v25 != v9)
          {
            objc_enumerationMutation(remotePushTokens);
          }

          v11 = *(*(&v24 + 1) + 8 * i);
          v20 = 0u;
          v21 = 0u;
          v22 = 0u;
          v23 = 0u;
          v12 = self->_remoteAcceptedDevicePushTokens;
          v13 = [(NSArray *)v12 countByEnumeratingWithState:&v20 objects:v28 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v21;
            while (2)
            {
              for (j = 0; j != v14; ++j)
              {
                if (*v21 != v15)
                {
                  objc_enumerationMutation(v12);
                }

                if ([v11 isEqualToPushToken:*(*(&v20 + 1) + 8 * j)])
                {

                  v17 = 1;
                  goto LABEL_21;
                }
              }

              v14 = [(NSArray *)v12 countByEnumeratingWithState:&v20 objects:v28 count:16];
              if (v14)
              {
                continue;
              }

              break;
            }
          }

          v9 = v19;
        }

        v8 = [remotePushTokens countByEnumeratingWithState:&v24 objects:v29 count:16];
        v17 = 0;
      }

      while (v8);
    }

    else
    {
      v17 = 0;
    }

LABEL_21:
  }

  else
  {
    v17 = 0;
  }

  return v17;
}

- (void)_updateLinksForSession:(id)session
{
  v123 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  linkEngine = [sessionCopy linkEngine];
  v5 = [linkEngine tag];
  v6 = v5;
  v7 = &stru_1F1AC8480;
  if (v5)
  {
    v7 = v5;
  }

  v103 = v7;

  [(IDSGlobalLink *)self _willUpdateLinksForSession:sessionCopy];
  remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
  if (!remoteAcceptedDevicePushTokens || ![(NSArray *)remoteAcceptedDevicePushTokens count])
  {
    v16 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      qrSessionID = [sessionCopy qrSessionID];
      sessionInfo = [sessionCopy sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = qrSessionID;
      v119 = 2048;
      allocateType = [sessionInfo allocateType];
      _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted", buf, 0x20u);
    }

    if (!os_log_shim_legacy_logging_enabled() || !_IDSShouldLogTransport())
    {
      v14 = 0;
      goto LABEL_28;
    }

    qrSessionID2 = [sessionCopy qrSessionID];
    sessionInfo2 = [sessionCopy sessionInfo];
    v89 = qrSessionID2;
    allocateType2 = [sessionInfo2 allocateType];
    v85 = v103;
    _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted");

    v14 = 0;
    if ((_IDSShouldLog() & 1) == 0)
    {
      goto LABEL_28;
    }

    v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is in superposition of accepted and not accepted";
    goto LABEL_25;
  }

  if ([(IDSGlobalLink *)self _isSessionAccepted:sessionCopy])
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      qrSessionID3 = [sessionCopy qrSessionID];
      sessionInfo3 = [sessionCopy sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = qrSessionID3;
      v119 = 2048;
      allocateType = [sessionInfo3 allocateType];
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      qrSessionID4 = [sessionCopy qrSessionID];
      sessionInfo4 = [sessionCopy sessionInfo];
      v89 = qrSessionID4;
      allocateType2 = [sessionInfo4 allocateType];
      v85 = v103;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted");

      v14 = 1;
      if ((_IDSShouldLog() & 1) == 0)
      {
        goto LABEL_28;
      }

      v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is accepted";
LABEL_25:
      qrSessionID5 = [sessionCopy qrSessionID];
      sessionInfo5 = [sessionCopy sessionInfo];
      v89 = qrSessionID5;
      allocateType2 = [sessionInfo5 allocateType];
      v85 = v103;
      _IDSLogV(0, @"IDSFoundation", @"GL", v15);

      goto LABEL_28;
    }

    v14 = 1;
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      qrSessionID6 = [sessionCopy qrSessionID];
      sessionInfo6 = [sessionCopy sessionInfo];
      *buf = 138412802;
      v116 = v103;
      v117 = 2112;
      v118 = qrSessionID6;
      v119 = 2048;
      allocateType = [sessionInfo6 allocateType];
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      qrSessionID7 = [sessionCopy qrSessionID];
      sessionInfo7 = [sessionCopy sessionInfo];
      v89 = qrSessionID7;
      allocateType2 = [sessionInfo7 allocateType];
      v85 = v103;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted");

      v14 = 2;
      if ((_IDSShouldLog() & 1) == 0)
      {
        goto LABEL_28;
      }

      v15 = @"_updateLinksForSession[%@]: %@ (allocateType %ld): acceptance status: session is not accepted";
      goto LABEL_25;
    }

    v14 = 2;
  }

LABEL_28:
  [sessionCopy setAcceptStatus:{v14, v85, v89, allocateType2}];
  v102 = [(IDSGlobalLink *)self _localCandidatesForRelaySession:sessionCopy];
  v28 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
  {
    qrSessionID8 = [sessionCopy qrSessionID];
    sessionInfo8 = [sessionCopy sessionInfo];
    allocateType3 = [sessionInfo8 allocateType];
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = qrSessionID8;
    v119 = 2048;
    allocateType = allocateType3;
    v121 = 2112;
    v122 = v102;
    _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@", buf, 0x2Au);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      qrSessionID9 = [sessionCopy qrSessionID];
      sessionInfo9 = [sessionCopy sessionInfo];
      allocateType4 = [sessionInfo9 allocateType];
      v97 = v102;
      v86 = v103;
      v90 = qrSessionID9;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@");

      if (_IDSShouldLog())
      {
        qrSessionID10 = [sessionCopy qrSessionID];
        sessionInfo10 = [sessionCopy sessionInfo];
        allocateType4 = [sessionInfo10 allocateType];
        v97 = v102;
        v86 = v103;
        v90 = qrSessionID10;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@]: %@ (allocateType %ld): localRelayCandidates: %@");
      }
    }
  }

  v101 = [(IDSGlobalLink *)self _remoteCandidatesForRelaySession:sessionCopy, v86, v90, allocateType4, v97];
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    qrSessionID11 = [sessionCopy qrSessionID];
    sessionInfo11 = [sessionCopy sessionInfo];
    allocateType5 = [sessionInfo11 allocateType];
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = qrSessionID11;
    v119 = 2048;
    allocateType = allocateType5;
    v121 = 2112;
    v122 = v101;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@", buf, 0x2Au);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      qrSessionID12 = [sessionCopy qrSessionID];
      sessionInfo12 = [sessionCopy sessionInfo];
      allocateType6 = [sessionInfo12 allocateType];
      v98 = v101;
      v87 = v103;
      v91 = qrSessionID12;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@");

      if (_IDSShouldLog())
      {
        qrSessionID13 = [sessionCopy qrSessionID];
        sessionInfo13 = [sessionCopy sessionInfo];
        allocateType6 = [sessionInfo13 allocateType];
        v98 = v101;
        v87 = v103;
        v91 = qrSessionID13;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@] %@ (allocateType %ld): remoteRelayCandidates: %@");
      }
    }
  }

  sessionInfo14 = [sessionCopy sessionInfo];
  v45 = [sessionInfo14 ipPreference] == 1 || (IMGetDomainBoolForKey() & 1) != 0 || self->_forceIPv6;

  v46 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
  {
    sessionInfo15 = [sessionCopy sessionInfo];
    if ([sessionInfo15 ipPreference] == 1)
    {
      v48 = @"YES";
    }

    else
    {
      v48 = @"NO";
    }

    if (IMGetDomainBoolForKey())
    {
      v49 = @"YES";
    }

    else
    {
      v49 = @"NO";
    }

    if (self->_forceIPv6)
    {
      v50 = @"YES";
    }

    else
    {
      v50 = @"NO";
    }

    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = v48;
    v119 = 2112;
    allocateType = v49;
    v121 = 2112;
    v122 = v50;
    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: force IPv6 options server: %@; default: %@; manual: %@", buf, 0x2Au);
  }

  linkEngine2 = [sessionCopy linkEngine];
  [linkEngine2 setIsQUICAndH2Enabled:self->_QUICForQREnabled];
  [linkEngine2 setShouldPreferIPv6:v45];
  sessionInfo16 = [sessionCopy sessionInfo];
  idsSessionID = [sessionInfo16 idsSessionID];
  [linkEngine2 setIdsSessionID:idsSessionID];

  sessionInfo17 = [sessionCopy sessionInfo];
  relaySessionID = [sessionInfo17 relaySessionID];
  [linkEngine2 setQrSessionID:relaySessionID];

  [linkEngine2 setRelayConnectionBehavior:{objc_msgSend(sessionCopy, "desiredRelayConnectionBehavior")}];
  [linkEngine2 setAllowOngoingTasks:{objc_msgSend(sessionCopy, "shouldLinkEngineAllowOngoingTasks")}];
  v56 = !self->_H2FallbackEnabled && self->_shouldFallbackToTCPFirst;
  [linkEngine2 setShouldFallbackToTCPFirst:v56];
  [linkEngine2 setIsH2Enabled:self->_H2FallbackEnabled];
  relayLinkProvider = [linkEngine2 relayLinkProvider];
  [relayLinkProvider setLocalCandidates:v102];

  sessionInfo18 = [sessionCopy sessionInfo];
  v59 = [sessionInfo18 allocateType] == 3;

  if (v59)
  {
    relayLinkProvider2 = [linkEngine2 relayLinkProvider];
    sessionInfo19 = [sessionCopy sessionInfo];
    relaySessionID2 = [sessionInfo19 relaySessionID];
    [relayLinkProvider2 setRemoteCandidates:v101 withRelaySessionID:relaySessionID2];
  }

  else
  {
    v63 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
    relayLinkProvider2 = v63;
    if (v63)
    {
      v111 = 0u;
      v112 = 0u;
      v109 = 0u;
      v110 = 0u;
      v64 = 0;
      v65 = [v63 countByEnumeratingWithState:&v109 objects:v114 count:16];
      if (v65)
      {
        v66 = *v110;
        do
        {
          for (i = 0; i != v65; ++i)
          {
            if (*v110 != v66)
            {
              objc_enumerationMutation(relayLinkProvider2);
            }

            if ([*(*(&v109 + 1) + 8 * i) isCellular])
            {
              v68 = 1;
            }

            else
            {
              v68 = 2;
            }

            v64 = v68 | v64;
          }

          v65 = [relayLinkProvider2 countByEnumeratingWithState:&v109 objects:v114 count:16];
        }

        while (v65);
      }

      _knownRemoteAvailableInterfaces = [(IDSGlobalLink *)self _knownRemoteAvailableInterfaces];
    }

    else
    {
      _knownRemoteAvailableInterfaces = 0;
      v64 = 0;
    }

    v107 = 0u;
    v108 = 0u;
    v105 = 0u;
    v106 = 0u;
    v69 = v102;
    v70 = [(__CFString *)v69 countByEnumeratingWithState:&v105 objects:v113 count:16];
    if (v70)
    {
      v71 = *v106;
      do
      {
        for (j = 0; j != v70; ++j)
        {
          if (*v106 != v71)
          {
            objc_enumerationMutation(v69);
          }

          v73 = *(*(&v105 + 1) + 8 * j);
          if ([v73 isNAT64] && objc_msgSend(v73, "prefix"))
          {
            v74 = objc_alloc_init(IDSNAT64PrefixWrapper);
            prefix = [v73 prefix];
            [(IDSNAT64PrefixWrapper *)v74 setPrefix:*prefix, prefix[1]];
            [0 addObject:v74];
          }
        }

        v70 = [(__CFString *)v69 countByEnumeratingWithState:&v105 objects:v113 count:16];
      }

      while (v70);
    }

    [linkEngine2 setAvailableInterfaceTypesWithLocalTypes:v64 remoteTypes:_knownRemoteAvailableInterfaces];
  }

  v76 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v76, OS_LOG_TYPE_DEFAULT))
  {
    qrSessionID14 = [sessionCopy qrSessionID];
    sessionInfo20 = [sessionCopy sessionInfo];
    allocateType7 = [sessionInfo20 allocateType];
    v80 = qos_class_self();
    *buf = 138413058;
    v116 = v103;
    v117 = 2112;
    v118 = qrSessionID14;
    v119 = 2048;
    allocateType = allocateType7;
    v121 = 1024;
    LODWORD(v122) = v80;
    _os_log_impl(&dword_1A7AD9000, v76, OS_LOG_TYPE_DEFAULT, "_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      qrSessionID15 = [sessionCopy qrSessionID];
      sessionInfo21 = [sessionCopy sessionInfo];
      allocateType8 = [sessionInfo21 allocateType];
      v99 = qos_class_self();
      v88 = v103;
      v92 = qrSessionID15;
      _IDSLogTransport(@"GL", @"IDS", @"_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...");

      if (_IDSShouldLog())
      {
        qrSessionID16 = [sessionCopy qrSessionID];
        sessionInfo22 = [sessionCopy sessionInfo];
        allocateType8 = [sessionInfo22 allocateType];
        v99 = qos_class_self();
        v88 = v103;
        v92 = qrSessionID16;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateLinksForSession[%@]: scheduling update for relaySessionID=%@ allocateType=%ld qos=%d...");
      }
    }
  }

  [linkEngine2 scheduleUpdate];
}

- (void)_updateAllLinks
{
  v14 = *MEMORY[0x1E69E9840];
  v9 = 0u;
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v3 = self->_sessionsByID;
  v4 = [(NSMutableDictionary *)v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v10;
    do
    {
      v7 = 0;
      do
      {
        if (*v10 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v9 + 1) + 8 * v7), v9];
        [(IDSGlobalLink *)self _updateLinksForSession:v8];

        ++v7;
      }

      while (v5 != v7);
      v5 = [(NSMutableDictionary *)v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
    }

    while (v5);
  }
}

- (void)_sendAllocbindForCandidatePair:(id)pair session:(id)session glLinkProtocol:(int64_t)protocol
{
  v95 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  sessionCopy = session;
  linkEngine = [sessionCopy linkEngine];
  v9 = [linkEngine tag];
  v10 = v9;
  v11 = &stru_1F1AC8480;
  if (v9)
  {
    v11 = v9;
  }

  v80 = v11;

  v12 = ids_monotonic_time();
  local = [pairCopy local];

  if (local)
  {
    local2 = [pairCopy local];
    radioAccessTechnology = [local2 radioAccessTechnology];
  }

  else
  {
    radioAccessTechnology = 10;
  }

  sessionInfoDict = [sessionCopy sessionInfoDict];
  if (sessionInfoDict)
  {
    v16 = @"allocate-time" == 0;
  }

  else
  {
    v16 = 1;
  }

  v17 = !v16;
  if (!v16)
  {
    sessionInfoDict2 = [sessionCopy sessionInfoDict];
    CFDictionaryGetValue(sessionInfoDict2, @"allocate-time");
  }

  objc_opt_class();
  isKindOfClass = objc_opt_isKindOfClass();
  if (v17)
  {
  }

  v19 = 0.0;
  if (isKindOfClass)
  {
    sessionInfoDict3 = [sessionCopy sessionInfoDict];
    if (sessionInfoDict3 != 0 && @"allocate-time" != 0)
    {
      sessionInfoDict4 = [sessionCopy sessionInfoDict];
      [CFDictionaryGetValue(sessionInfoDict4 @"allocate-time")];
      v19 = v22;
    }

    else
    {
      [0 doubleValue];
      v19 = v23;
    }
  }

  sessionInfoDict5 = [sessionCopy sessionInfoDict];
  v79 = [sessionInfoDict5 objectForKeyedSubscript:@"qrbv"];

  sessionInfo = [sessionCopy sessionInfo];
  allocateRequestID = [sessionInfo allocateRequestID];
  remote = [pairCopy remote];
  transport = [remote transport];
  sessionInfo2 = [sessionCopy sessionInfo];
  relayServerProviderType = [sessionInfo2 relayServerProviderType];
  idsSessionID = self->_idsSessionID;
  sessionInfo3 = [sessionCopy sessionInfo];
  reportingDataBlob = [sessionInfo3 reportingDataBlob];
  LOBYTE(v70) = self->_isInitiator;
  [(IDSGlobalLink *)self _addQRAAWDBlock:allocateRequestID allocateRequestTime:radioAccessTechnology inferredExternalRAT:transport stunTransport:relayServerProviderType relayProviderType:idsSessionID idsSessionID:reportingDataBlob reportingDataBlob:v19 isInitiator:v70 serverSoftwareVersion:v79];

  if (self->_isInitiator)
  {
    if (self->_inviteSentTime == 0.0)
    {
      sessionInfoDict6 = [sessionCopy sessionInfoDict];
      if (sessionInfoDict6 && @"gl-option-invite-sent-time")
      {
        sessionInfoDict7 = [sessionCopy sessionInfoDict];
        [CFDictionaryGetValue(sessionInfoDict7 @"gl-option-invite-sent-time")];
        self->_inviteSentTime = v36;
      }

      else
      {
        [0 doubleValue];
        self->_inviteSentTime = v40;
      }
    }
  }

  else
  {
    if (self->_inviteRecvTime == 0.0)
    {
      sessionInfoDict8 = [sessionCopy sessionInfoDict];
      if (sessionInfoDict8 && @"gl-option-invite-recv-time")
      {
        sessionInfoDict9 = [sessionCopy sessionInfoDict];
        [CFDictionaryGetValue(sessionInfoDict9 @"gl-option-invite-recv-time")];
        self->_inviteRecvTime = v39;
      }

      else
      {
        [0 doubleValue];
        self->_inviteRecvTime = v41;
      }
    }

    sessionInfoDict10 = [sessionCopy sessionInfoDict];
    if (sessionInfoDict10 && @"gl-option-use-secure-control-message")
    {
      sessionInfoDict11 = [sessionCopy sessionInfoDict];
      bOOLValue = [CFDictionaryGetValue(sessionInfoDict11 @"gl-option-use-secure-control-message")];
    }

    else
    {
      bOOLValue = [0 BOOLValue];
    }

    if (!self->_useSecureControlMessage && bOOLValue)
    {
      self->_useSecureControlMessage = bOOLValue;
      v45 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v86 = v80;
        _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.");
          if (_IDSShouldLog())
          {
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: enable secure control message for Receiver.");
          }
        }
      }
    }
  }

  if (self->_allocbindStartTime == 0.0)
  {
    self->_allocbindStartTime = v12;
    if (self->_isInitiator)
    {
      v46 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        inviteSentTime = self->_inviteSentTime;
        allocbindStartTime = self->_allocbindStartTime;
        *buf = 138412802;
        v86 = v80;
        v87 = 2048;
        v88 = inviteSentTime;
        v89 = 2048;
        v90 = allocbindStartTime;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v73 = self->_inviteSentTime;
          v74 = self->_allocbindStartTime;
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.");
          if (_IDSShouldLog())
          {
            v73 = self->_inviteSentTime;
            v74 = self->_allocbindStartTime;
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: invite sent: %.6f, allocbind start: %.6f.");
          }
        }
      }
    }

    else
    {
      if (self->_isUPlusOneSession)
      {
        self->_calleeAcceptTime = ids_monotonic_time();
        v12 = self->_allocbindStartTime;
      }

      v49 = ntpTime32(v12);
      self->_acceptDelayU32 = v49 - ntpTime32(self->_inviteRecvTime);
      v50 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
      {
        inviteRecvTime = self->_inviteRecvTime;
        v52 = self->_allocbindStartTime;
        acceptDelayU32 = self->_acceptDelayU32;
        *buf = 138413314;
        v86 = v80;
        v87 = 2048;
        v88 = inviteRecvTime;
        v89 = 2048;
        v90 = v52;
        v91 = 1024;
        *v92 = acceptDelayU32;
        *&v92[4] = 2048;
        *&v92[6] = v52 - inviteRecvTime;
        _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f", buf, 0x30u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v76 = self->_allocbindStartTime - self->_inviteRecvTime;
          v75 = self->_acceptDelayU32;
          v73 = self->_inviteRecvTime;
          v74 = self->_allocbindStartTime;
          v71 = v80;
          _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
          if (_IDSShouldLog())
          {
            v76 = self->_allocbindStartTime - self->_inviteRecvTime;
            v75 = self->_acceptDelayU32;
            v73 = self->_inviteRecvTime;
            v74 = self->_allocbindStartTime;
            v71 = v80;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
          }
        }
      }
    }
  }

  metricsCollector = self->_metricsCollector;
  local3 = [pairCopy local];
  interfaceName = [local3 interfaceName];
  [(IDSGFTMetricsCollector *)metricsCollector willSendAllocbindRequestThroughInterface:interfaceName];

  v57 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v58 = "Initiator";
    }

    else
    {
      v58 = "Receiver";
    }

    v59 = [(IDSGlobalLink *)self tagForCandidatePair:pairCopy glLinkProtocol:protocol];
    idsSessionID = [sessionCopy idsSessionID];
    qrSessionID = [sessionCopy qrSessionID];
    isAcceptedRelaySession = [pairCopy isAcceptedRelaySession];
    v63 = @"NO";
    *buf = 138413570;
    v86 = v80;
    v87 = 2080;
    if (isAcceptedRelaySession)
    {
      v63 = @"YES";
    }

    v88 = *&v58;
    v89 = 2112;
    v90 = *&v59;
    v91 = 2112;
    *v92 = idsSessionID;
    *&v92[8] = 2112;
    *&v92[10] = qrSessionID;
    v93 = 2112;
    v94 = v63;
    _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: *** Connect as %s, tag: %@, IDSSessionID: %@, QRSessionID: %@, Accepted: %@.", buf, 0x3Eu);
  }

  self->_hasPendingAllocation = 0;
  v64 = protocol & 0xF0;
  if (v64 == 32)
  {
    v67 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending over H2...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending over H2...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending over H2...");
        }
      }
    }

    v83[0] = MEMORY[0x1E69E9820];
    v83[1] = 3221225472;
    v83[2] = sub_1A7B75424;
    v83[3] = &unk_1E77E0C88;
    v83[4] = self;
    v84 = pairCopy;
    [(IDSGlobalLink *)self _connectNWTCPLink:v84 disconnectAfterUse:0 connectedHandler:v83];
  }

  else if (v64 == 16)
  {
    v65 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending over H3...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending over H3...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending over H3...");
        }
      }
    }

    candidatePairToken = [pairCopy candidatePairToken];
    -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", candidatePairToken, [pairCopy isRealloc], 0, 1, objc_msgSend(pairCopy, "pendingNoSessionStateAllocbind"));
  }

  else
  {
    v68 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v86 = v80;
      _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "_sendAllocbindForCandidatePair[%@]: sending STUN...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v72 = v80;
        _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindForCandidatePair[%@]: sending STUN...");
        if (_IDSShouldLog())
        {
          v72 = v80;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindForCandidatePair[%@]: sending STUN...");
        }
      }
    }

    [pairCopy setIsQUIC:{0, v72}];
    candidatePairToken2 = [pairCopy candidatePairToken];
    -[IDSGlobalLink _sendAllocbindRequest:stunMessage:isRealloc:inResponseToNoSessionState:](self, "_sendAllocbindRequest:stunMessage:isRealloc:inResponseToNoSessionState:", candidatePairToken2, 0, [pairCopy isRealloc], objc_msgSend(pairCopy, "pendingNoSessionStateAllocbind"));
  }

  [(IDSGlobalLink *)self _reportAWDAllocateTime];
}

- (void)_sendInfoRequestForCandidatePair:(id)pair glLinkProtocol:(int64_t)protocol
{
  protocolCopy = protocol;
  v20 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  linkEngine = [pairCopy linkEngine];
  if (linkEngine)
  {
    linkEngine2 = [pairCopy linkEngine];
    v9 = [linkEngine2 tag];
  }

  else
  {
    v9 = &stru_1F1AC8480;
  }

  if ((protocolCopy & 0xF0) == 0x20)
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending over H2...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending over H2...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending over H2...");
        }
      }
    }

    v14[0] = MEMORY[0x1E69E9820];
    v14[1] = 3221225472;
    v14[2] = sub_1A7B758EC;
    v14[3] = &unk_1E77E0818;
    v15 = pairCopy;
    [(IDSGlobalLink *)self _connectNWTCPLink:v15 disconnectAfterUse:1 connectedHandler:v14];
  }

  else if ((protocolCopy & 0xF0) == 0x10)
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending over H3...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending over H3...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending over H3...");
        }
      }
    }

    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = sub_1A7B758E4;
    v16[3] = &unk_1E77E0818;
    v17 = pairCopy;
    [(IDSGlobalLink *)self _connectNWLink:v17 disconnectAfterUse:1 connectedHandler:v16];
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = v9;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_sendInfoRequestForCandidatePair[%@]: sending STUN...", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v13 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"_sendInfoRequestForCandidatePair[%@]: sending STUN...");
        if (_IDSShouldLog())
        {
          v13 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendInfoRequestForCandidatePair[%@]: sending STUN...");
        }
      }
    }

    [pairCopy setIsQUIC:{0, v13}];
    [pairCopy sendInfoRequest:0];
  }
}

- (id)tagForCandidatePair:(id)pair glLinkProtocol:(int64_t)protocol
{
  v4 = protocol & 0xF0;
  switch(v4)
  {
    case 16:
      v5 = @"h3";
      break;
    case 48:
      v5 = @"fakeTLS";
      break;
    case 32:
      v5 = @"h2";
      break;
    default:
      v5 = @"none";
      break;
  }

  v6 = protocol & 0xF00;
  v7 = @"unknown";
  switch(v6)
  {
    case 256:
      v8 = @"ids-relay";
      break;
    case 768:
      v8 = @"ids-p2p";
      break;
    case 512:
      v8 = @"ids-vr";
      break;
    default:
      v8 = @"unknown";
      break;
  }

  if ((protocol & 0xF) == 2)
  {
    v7 = @"tcp";
  }

  if ((protocol & 0xF) == 1)
  {
    v9 = @"udp";
  }

  else
  {
    v9 = v7;
  }

  pairCopy = pair;
  local = [pairCopy local];
  if (*([local address] + 1) == 2)
  {
    v12 = @"ipv4";
  }

  else
  {
    v12 = @"ipv6";
  }

  v13 = v12;

  local2 = [pairCopy local];

  interfaceName = [local2 interfaceName];

  v16 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%@.%@.%@.%@.%@", interfaceName, v13, v9, v5, v8];

  return v16;
}

- (BOOL)_glLinkProtocolIsNWLink:(int64_t)link
{
  result = 1;
  if ((link & 0xF0) != 0x10 && (link & 0xF0) != 0x20 && ((link & 0xF) != 1 || !self->_QUICForQREnabled))
  {
    return 0;
  }

  return result;
}

- (void)_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:(id)needed remoteCandidate:(id)candidate glLinkProtocol:(int64_t)protocol
{
  v39 = *MEMORY[0x1E69E9840];
  neededCopy = needed;
  candidateCopy = candidate;
  v10 = [(IDSGlobalLink *)self _glLinkProtocolIsTCPRelay:protocol];
  v11 = [(IDSGlobalLink *)self _glLinkProtocolIsFakeTLS:protocol];
  if (v11 || v10)
  {
    if (v10 || v11)
    {
      v12 = 40;
      if (v10)
      {
        v12 = 32;
      }

      v13 = *(&self->super.isa + v12);
    }

    else
    {
      v13 = 0;
    }

    v14 = [v13 connect:objc_msgSend(neededCopy localAddress:"index") portRange:objc_msgSend(neededCopy remoteAddress:"address") clientUUID:LOWORD(self->_portRange) completionHandler:{objc_msgSend(candidateCopy, "external"), self->_clientUUID, 0}];
    if (v14)
    {
      v15 = v14;
      *&v16 = 0xAAAAAAAAAAAAAAAALL;
      *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v37 = v16;
      v38 = v16;
      v35 = v16;
      v36 = v16;
      v33 = v16;
      v34 = v16;
      *__str = v16;
      v32 = v16;
      SAToIPPortString(__str, 0x80uLL, [neededCopy address]);
      memcpy([neededCopy address], v15, *v15);
      *&v17 = 0xAAAAAAAAAAAAAAAALL;
      *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v29 = v17;
      v30 = v17;
      v27 = v17;
      v28 = v17;
      v25 = v17;
      v26 = v17;
      *v23 = v17;
      v24 = v17;
      SAToIPPortString(v23, 0x80uLL, [neededCopy address]);
      v18 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v19 = 136315394;
        v20 = __str;
        v21 = 2080;
        v22 = v23;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded: TCP connection: change the local address from %s to: %s", &v19, 0x16u);
      }
    }
  }
}

- (void)connectRelayLinkFromCandidate:(id)candidate toCandidate:(id)toCandidate withUniqueID:(id)d relaySessionID:(id)iD glLinkProtocol:(int64_t)protocol replacesLinkWithUniqueID:(id)uniqueID
{
  v148 = *MEMORY[0x1E69E9840];
  candidateCopy = candidate;
  toCandidateCopy = toCandidate;
  dCopy = d;
  iDCopy = iD;
  uniqueIDCopy = uniqueID;
  v124 = iDCopy;
  v14 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:iDCopy];
  v15 = v14;
  if (v14)
  {
    linkEngine = [v14 linkEngine];
    v17 = [linkEngine tag];
    v18 = v17;
    v19 = &stru_1F1AC8480;
    if (v17)
    {
      v19 = v17;
    }

    v20 = v19;

    v21 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      isRealloc = [toCandidateCopy isRealloc];
      *buf = 138413826;
      v23 = @"NO";
      v135 = v20;
      v136 = 2112;
      if (isRealloc)
      {
        v23 = @"YES";
      }

      selfCopy = dCopy;
      v138 = 2112;
      v139 = v124;
      v140 = 2112;
      v141 = candidateCopy;
      v142 = 2112;
      v143 = toCandidateCopy;
      v144 = 2112;
      v145 = uniqueIDCopy;
      v146 = 2112;
      v147 = v23;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: %@ relaySessionID=%@ fromCandidate:%@ toCandidate:%@ replacesLinkWithUniqueID:%@ isRealloc:%@", buf, 0x48u);
    }

    v24 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:dCopy];
    if (!v24)
    {
      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v135 = v20;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: creating candidate pair...", buf, 0xCu);
      }

      [(IDSGlobalLink *)self _connectTCPAndUpdateLocalCandidatePortToAvailablePortIfNeeded:candidateCopy remoteCandidate:toCandidateCopy glLinkProtocol:protocol];
      qrSessionID = [v15 qrSessionID];
      v24 = [IDSStunCandidatePair candidatePairWithLocalCandidate:candidateCopy remoteCandidate:toCandidateCopy sessionID:qrSessionID delegate:self];

      [v24 setLinkUniqueName:dCopy];
      [v24 setGlLinkProtocol:protocol];
      [v24 setReplacesLinkWithUniqueName:uniqueIDCopy];
      remote = [v24 remote];
      isRealloc2 = [remote isRealloc];
      if (uniqueIDCopy)
      {
        v29 = isRealloc2;
      }

      else
      {
        v29 = 0;
      }

      if (v29)
      {
        v30 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v135 = v20;
          _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: setting isRealloc=YES", buf, 0xCu);
        }

        [v24 setIsRealloc:1];
        [v24 setPendingRealloc:1];
      }

      v31 = [(IDSGlobalLink *)self tagForCandidatePair:v24 glLinkProtocol:protocol];
      v131 = 0u;
      v132 = 0u;
      v129 = 0u;
      v130 = 0u;
      v32 = self->_debugDelayByTag;
      v33 = [(NSMutableDictionary *)v32 countByEnumeratingWithState:&v129 objects:v133 count:16];
      if (v33)
      {
        v34 = *v130;
        while (2)
        {
          for (i = 0; i != v33; ++i)
          {
            if (*v130 != v34)
            {
              objc_enumerationMutation(v32);
            }

            v36 = *(*(&v129 + 1) + 8 * i);
            if ([(IDSGlobalLink *)v31 containsString:v36])
            {
              v37 = [(NSMutableDictionary *)self->_debugDelayByTag objectForKeyedSubscript:v36];
              v38 = v37;
              if (v37)
              {
                [v37 doubleValue];
                [v24 setDebugDelay:?];
              }

              goto LABEL_32;
            }
          }

          v33 = [(NSMutableDictionary *)v32 countByEnumeratingWithState:&v129 objects:v133 count:16];
          if (v33)
          {
            continue;
          }

          break;
        }
      }

LABEL_32:

      sessionInfo = [v15 sessionInfo];
      allocateRequestID = [sessionInfo allocateRequestID];
      sessionInfo2 = [v15 sessionInfo];
      relaySessionID = [sessionInfo2 relaySessionID];
      v43 = [(IDSGlobalLink *)self _isAcceptedRelaySessionForAllocationRequestID:allocateRequestID acceptedRelaySessionID:relaySessionID];

      if (self->_isSessionAcceptedWithNoCandidatePair && self->_acceptedRelaySessionID && self->_isInitiator)
      {
        self->_isSessionAcceptedWithNoCandidatePair = 0;
        v43 = 1;
      }

      [v24 setIsAcceptedRelaySession:v43];
      v44 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412802;
        v135 = v20;
        v136 = 2112;
        selfCopy = v31;
        v138 = 2112;
        v139 = v24;
        _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v107 = v31;
          v111 = v24;
          v105 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@");
          if (_IDSShouldLog())
          {
            v107 = v31;
            v111 = v24;
            v105 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: created candidate pair (tag: %@): %@");
          }
        }
      }

      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      if (!tokenToCandidatePairs)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v47 = self->_tokenToCandidatePairs;
        self->_tokenToCandidatePairs = Mutable;

        tokenToCandidatePairs = self->_tokenToCandidatePairs;
      }

      candidatePairToken = [v24 candidatePairToken];
      [(NSMutableDictionary *)tokenToCandidatePairs setObject:v24 forKeyedSubscript:candidatePairToken];

      [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair setObject:v24 forKeyedSubscript:dCopy];
      linkEngine2 = [v15 linkEngine];
      [v24 setLinkEngine:linkEngine2];

      sessionInfo3 = [v15 sessionInfo];
      LODWORD(candidatePairToken) = [sessionInfo3 allocateType] == 3;

      if (candidatePairToken)
      {
        sessionInfoDict = [v15 sessionInfoDict];
        [v24 updateURIToParticipantIDMapping:sessionInfoDict];
      }
    }

    local = [v24 local];
    isCellularStunCandidate = [local isCellularStunCandidate];

    if (isCellularStunCandidate)
    {
      local2 = [v24 local];
      [local2 setCellularSlicingFlags:self->_cellularSlicingFlags];
    }

    v55 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      sessionInfo4 = [v15 sessionInfo];
      *buf = 138412546;
      v135 = v20;
      v136 = 2112;
      selfCopy = sessionInfo4;
      _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        [v15 sessionInfo];
        v107 = v105 = v20;
        _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@");

        if (_IDSShouldLog())
        {
          [v15 sessionInfo];
          v107 = v105 = v20;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: setPropertiesWithRelaySessionInfo, qrSessionInfo = %@");
        }
      }
    }

    sessionInfo5 = [v15 sessionInfo];
    sessionInfoDict2 = [v15 sessionInfoDict];
    [v24 setPropertiesWithRelaySessionInfo:sessionInfo5 sessionInfoDict:sessionInfoDict2 enableSKE:self->_enableSKE];

    sessionToken = [v15 sessionToken];
    [v24 setRelaySessionToken:sessionToken];

    self->_hasPendingAllocation = 0;
    state = [v24 state];
    v61 = state;
    if (state <= 4 && ((1 << state) & 0x1A) != 0)
    {
      v62 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken2 = [v24 candidatePairToken];
        v64 = (&_IDSStunCandidatePairStateStrings)[v61];
        *buf = 138412802;
        v135 = v20;
        v136 = 2112;
        selfCopy = candidatePairToken2;
        v138 = 2080;
        v139 = v64;
        _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          candidatePairToken3 = [v24 candidatePairToken];
          v112 = (&_IDSStunCandidatePairStateStrings)[v61];
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]");

          if (_IDSShouldLog())
          {
            candidatePairToken4 = [v24 candidatePairToken];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: skip allocbind request for %@, state [%s]");
          }
        }
      }
    }

    else if ([v15 wantsToJoin])
    {
      if (self->_state <= 1)
      {
        v65 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
        {
          v66 = _IDSLinkStateStrings[self->_state];
          *buf = 138413058;
          v135 = v20;
          v136 = 2112;
          selfCopy = self;
          v138 = 2080;
          v139 = v66;
          v140 = 2080;
          v141 = off_1EB2B3E60[0];
          _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).", buf, 0x2Au);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v111 = _IDSLinkStateStrings[self->_state];
            v113 = off_1EB2B3E60[0];
            v106 = v20;
            selfCopy3 = self;
            _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).");
            if (_IDSShouldLog())
            {
              v111 = _IDSLinkStateStrings[self->_state];
              v113 = off_1EB2B3E60[0];
              v106 = v20;
              selfCopy3 = self;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: update GL: %@ state (%s->%s).");
            }
          }
        }

        self->_state = 2;
      }

      v67 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken5 = [v24 candidatePairToken];
        sessionToken2 = [v15 sessionToken];
        v115 = [sessionToken2 length];
        sessionInfo6 = [v15 sessionInfo];
        relaySessionKey = [sessionInfo6 relaySessionKey];
        v71 = [relaySessionKey length];
        sessionInfo7 = [v15 sessionInfo];
        participantID = [sessionInfo7 participantID];
        *buf = 138413314;
        v135 = v20;
        v136 = 2112;
        selfCopy = candidatePairToken5;
        v138 = 2048;
        v139 = v115;
        v140 = 2048;
        v141 = v71;
        v142 = 2048;
        v143 = participantID;
        _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)", buf, 0x34u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          candidatePairToken6 = [v24 candidatePairToken];
          sessionToken3 = [v15 sessionToken];
          v75 = [sessionToken3 length];
          sessionInfo8 = [v15 sessionInfo];
          relaySessionKey2 = [sessionInfo8 relaySessionKey];
          v78 = [relaySessionKey2 length];
          sessionInfo9 = [v15 sessionInfo];
          v113 = v78;
          participantID2 = [sessionInfo9 participantID];
          selfCopy3 = candidatePairToken6;
          v111 = v75;
          v106 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");

          if (_IDSShouldLog())
          {
            candidatePairToken7 = [v24 candidatePairToken];
            sessionToken4 = [v15 sessionToken];
            v81 = [sessionToken4 length];
            sessionInfo10 = [v15 sessionInfo];
            relaySessionKey3 = [sessionInfo10 relaySessionKey];
            v84 = [relaySessionKey3 length];
            sessionInfo11 = [v15 sessionInfo];
            v113 = v84;
            participantID2 = [sessionInfo11 participantID];
            selfCopy3 = candidatePairToken7;
            v111 = v81;
            v106 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");
          }
        }
      }

      [(IDSGlobalLink *)self _sendAllocbindForCandidatePair:v24 session:v15 glLinkProtocol:protocol, v106, selfCopy3, v111, v113, participantID2];
    }

    else if ([v15 wantsInfo])
    {
      v86 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v86, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken8 = [v24 candidatePairToken];
        sessionToken5 = [v15 sessionToken];
        v116 = [sessionToken5 length];
        sessionInfo12 = [v15 sessionInfo];
        relaySessionKey4 = [sessionInfo12 relaySessionKey];
        v90 = [relaySessionKey4 length];
        sessionInfo13 = [v15 sessionInfo];
        participantID3 = [sessionInfo13 participantID];
        *buf = 138413314;
        v135 = v20;
        v136 = 2112;
        selfCopy = candidatePairToken8;
        v138 = 2048;
        v139 = v116;
        v140 = 2048;
        v141 = v90;
        v142 = 2048;
        v143 = participantID3;
        _os_log_impl(&dword_1A7AD9000, v86, OS_LOG_TYPE_DEFAULT, "connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)", buf, 0x34u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          candidatePairToken9 = [v24 candidatePairToken];
          sessionToken6 = [v15 sessionToken];
          v94 = [sessionToken6 length];
          sessionInfo14 = [v15 sessionInfo];
          relaySessionKey5 = [sessionInfo14 relaySessionKey];
          v97 = [relaySessionKey5 length];
          sessionInfo15 = [v15 sessionInfo];
          v113 = v97;
          participantID2 = [sessionInfo15 participantID];
          selfCopy3 = candidatePairToken9;
          v111 = v94;
          v106 = v20;
          _IDSLogTransport(@"GL", @"IDS", @"connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");

          if (_IDSShouldLog())
          {
            candidatePairToken10 = [v24 candidatePairToken];
            sessionToken7 = [v15 sessionToken];
            v100 = [sessionToken7 length];
            sessionInfo16 = [v15 sessionInfo];
            relaySessionKey6 = [sessionInfo16 relaySessionKey];
            v103 = [relaySessionKey6 length];
            sessionInfo17 = [v15 sessionInfo];
            v113 = v103;
            participantID2 = [sessionInfo17 participantID];
            selfCopy3 = candidatePairToken10;
            v111 = v100;
            v106 = v20;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connectRelayLinkFromCandidate[%@]: start info for %@ (token %lu bytes, key %lu bytes), participantID:%llu (LinkEngine)");
          }
        }
      }

      [(IDSGlobalLink *)self _sendInfoRequestForCandidatePair:v24 glLinkProtocol:protocol, v106, selfCopy3, v111, v113, participantID2];
    }
  }

  else
  {
    v20 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E148A0();
    }
  }
}

- (void)disconnectRelayLinkWithUniqueID:(id)d glLinkProtocol:(int64_t)protocol
{
  v14 = *MEMORY[0x1E69E9840];
  dCopy = d;
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v13 = dCopy;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "disconnectRelayLinkWithUniqueID: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v11 = dCopy;
      _IDSLogTransport(@"GL", @"IDS", @"disconnectRelayLinkWithUniqueID: %@");
      if (_IDSShouldLog())
      {
        v11 = dCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnectRelayLinkWithUniqueID: %@");
      }
    }
  }

  v8 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:dCopy, v11];
  if (v8)
  {
    v9 = [(IDSGlobalLink *)self _glLinkProtocolIsNWLink:protocol];
    candidatePairToken = [v8 candidatePairToken];
    if (v9)
    {
      [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:candidatePairToken reason:8];
    }

    else
    {
      [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken stunMessage:0 reason:8];
    }
  }
}

- (void)linkEngineDidRemoveLinkWithUniqueID:(id)d
{
  v9 = *MEMORY[0x1E69E9840];
  dCopy = d;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v8 = dCopy;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "linkEngineDidRemoveLinkWithUniqueID: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v6 = dCopy;
      _IDSLogTransport(@"GL", @"IDS", @"linkEngineDidRemoveLinkWithUniqueID: %@");
      if (_IDSShouldLog())
      {
        v6 = dCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkEngineDidRemoveLinkWithUniqueID: %@");
      }
    }
  }

  [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair setObject:0 forKeyedSubscript:dCopy, v6];
}

- (void)reconnectRelayLinkWithUniqueID:(id)d glLinkProtocol:(int64_t)protocol
{
  v23 = *MEMORY[0x1E69E9840];
  dCopy = d;
  v7 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:dCopy];
  if (v7)
  {
    v8 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      pendingNoSessionStateAllocbind = [v7 pendingNoSessionStateAllocbind];
      v10 = @"NO";
      if (pendingNoSessionStateAllocbind)
      {
        v10 = @"YES";
      }

      *buf = 138412290;
      v18 = v10;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "reconnectRelayLinkWithUniqueID: pendingNoSessionStateAllocbind = %@", buf, 0xCu);
    }

    if (([v7 pendingNoSessionStateAllocbind] & 1) == 0)
    {
      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v7 withReason:5];
      [(IDSGlobalLink *)self _removeChannelFromChannelToCandidatePair:v7];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v7 withReason:5];
      }

      state = [v7 state];
      [v7 setState:1];
      [v7 setChannelNumber:0];
      [v7 setLinkID:0];
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = (&_IDSStunCandidatePairStateStrings)[state];
        *buf = 136315650;
        v18 = v13;
        v19 = 2080;
        v20 = off_1EB2B43B0;
        v21 = 2112;
        v22 = v7;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v15 = off_1EB2B43B0;
          v16 = v7;
          v14 = (&_IDSStunCandidatePairStateStrings)[state];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v15 = off_1EB2B43B0;
            v16 = v7;
            v14 = (&_IDSStunCandidatePairStateStrings)[state];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      [(IDSGlobalLink *)self sendAllocbindRequest:v7 isRealloc:0 inResponseToNoSessionState:1 reconnectQUIC:[(IDSGlobalLink *)self _glLinkProtocolIsNWLink:protocol, v14, v15, v16]];
      [v7 setPendingNoSessionState:1];
    }
  }
}

- (void)_reportNoSessionState:(id)state errorCode:(unsigned __int16)code
{
  v8 = GLUCreateQRNoSessionStateEvent(state, 237, code);
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didAddQREvent:v8];
  }
}

- (id)linkEngineForSessionInfo:(id)info
{
  infoCopy = info;
  v5 = [IDSGLLinkEngine alloc];
  v6 = [[IDSWeakGLLinkConnector alloc] initWithGLLinkConnector:self];
  allocateType = [infoCopy allocateType];
  isInitiator = [infoCopy isInitiator];
  useLinkSelection = self->_useLinkSelection;
  recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
  _accessLinkSelectionStrategy = [(IDSGlobalLink *)self _accessLinkSelectionStrategy];
  v12 = [IDSServerBag sharedInstanceForBagType:0];
  v13 = [(IDSGLLinkEngine *)v5 initWithLinkConnector:v6 allocateType:allocateType isInitiator:isInitiator useLinkSelection:useLinkSelection recordExpensiveQualityMetrics:recordExpensiveQualityMetrics linkSelectionStrategy:_accessLinkSelectionStrategy serverBag:v12 timeFn:&unk_1F1AAA340];

  relaySessionID = [infoCopy relaySessionID];
  [(IDSGLLinkEngine *)v13 setQrSessionID:relaySessionID];

  idsSessionID = [infoCopy idsSessionID];
  [(IDSGLLinkEngine *)v13 setIdsSessionID:idsSessionID];

  v16 = MEMORY[0x1E696AEC0];
  idsSessionID2 = [infoCopy idsSessionID];
  relaySessionID2 = [infoCopy relaySessionID];

  v19 = [v16 stringWithFormat:@"GroupSession idsSessionID=%@ qrSessionID=%@", idsSessionID2, relaySessionID2];
  [(IDSGLLinkEngine *)v13 setTag:v19];

  [(IDSGLLinkEngine *)v13 registerEngine];

  return v13;
}

- (id)p2pLinkEngine
{
  if (self->_useLinkEngine)
  {
    v20 = v6;
    v21 = v5;
    v22 = v4;
    v23 = v3;
    v24 = v2;
    p2pLinkEngine = self->_p2pLinkEngine;
    if (!p2pLinkEngine)
    {
      v12 = [IDSGLP2PLinkEngineHandle alloc];
      useLinkSelection = self->_useLinkSelection;
      recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
      v15 = [IDSServerBag sharedInstanceForBagType:0];
      v16 = [(IDSGLP2PLinkEngineHandle *)v12 initUsingLinkSelection:useLinkSelection recordingExpensiveQualityMetrics:recordExpensiveQualityMetrics serverBag:v15 timeFn:&unk_1F1AAA360];
      v17 = self->_p2pLinkEngine;
      self->_p2pLinkEngine = v16;

      [(IDSGLP2PLinkEngineHandle *)self->_p2pLinkEngine registerEngine];
      p2pLinkEngine = self->_p2pLinkEngine;
    }

    [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine setAllowOngoingTasks:self->_allowP2P, v7, v20, v21, v22, v23, v24, v8];
    v18 = self->_p2pLinkEngine;
  }

  else
  {
    v18 = 0;
  }

  return v18;
}

- (void)startNewAllocationFromInterface:(int)interface toInterface:(int)toInterface
{
  if (!self->_hasPendingAllocation)
  {
    interfaceCopy = interface;
    _knownRemoteAvailableInterfaces = [(IDSGlobalLink *)self _knownRemoteAvailableInterfaces];
    v8 = interfaceCopy & 2;
    if ((toInterface & 1) == 0 || v8 == 0)
    {
      v10 = 0;
    }

    else
    {
      v10 = 2;
    }

    if ((toInterface & 1 & interfaceCopy) != 0)
    {
      v11 = 8;
    }

    else
    {
      v11 = v10;
    }

    if ((v8 & toInterface) != 0)
    {
      v12 = 1;
    }

    else
    {
      v12 = v11;
    }

    self->_hasPendingAllocation = 1;
    v13 = im_primary_queue();
    v14[0] = MEMORY[0x1E69E9820];
    v14[1] = 3221225472;
    v14[2] = sub_1A7B777B4;
    v14[3] = &unk_1E77E0CB0;
    v14[4] = self;
    v16 = v12;
    v15 = _knownRemoteAvailableInterfaces;
    dispatch_async(v13, v14);
  }
}

- (id)_ensureSessionWithSessionInfo:(id)info sessionInfoDict:(id)dict localInterfacePreference:(int)preference
{
  v5 = *&preference;
  v48 = *MEMORY[0x1E69E9840];
  infoCopy = info;
  dictCopy = dict;
  sessionsByID = self->_sessionsByID;
  relaySessionID = [infoCopy relaySessionID];
  v12 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:relaySessionID];

  v13 = +[IDSFoundationLog GlobalLink];
  v14 = os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
  if (v12)
  {
    if (v14)
    {
      linkEngine = [(IDSGlobalLinkSession *)v12 linkEngine];
      v16 = [linkEngine tag];
      v17 = v16;
      if (v16)
      {
        v18 = v16;
      }

      else
      {
        v18 = &stru_1F1AC8480;
      }

      relaySessionID2 = [infoCopy relaySessionID];
      *buf = 138412546;
      v45 = v18;
      v46 = 2112;
      allocateType = relaySessionID2;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_ensureSessionWithSessionInfo[%@]: updating session info for session %@", buf, 0x16u);
    }

    [(IDSGlobalLinkSession *)v12 setSessionInfo:infoCopy sessionInfoDict:dictCopy];
  }

  else
  {
    if (v14)
    {
      relaySessionID3 = [infoCopy relaySessionID];
      *buf = 138412546;
      v45 = relaySessionID3;
      v46 = 2048;
      allocateType = [infoCopy allocateType];
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "creating IDSGlobalLinkSession for relaySessionID: %@ allocateType: %ld", buf, 0x16u);
    }

    selfCopy = self;
    v21 = [(IDSGlobalLink *)self linkEngineForSessionInfo:infoCopy];
    v37 = dictCopy;
    v12 = [[IDSGlobalLinkSession alloc] initWithSessionInfo:infoCopy sessionInfoDict:dictCopy linkEngine:v21];
    [(IDSGlobalLinkSession *)v12 setLocalInterfacePreference:v5];
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v38 = infoCopy;
    allocatedPushTokens = [infoCopy allocatedPushTokens];
    v23 = [allocatedPushTokens countByEnumeratingWithState:&v39 objects:v43 count:16];
    if (v23)
    {
      v24 = v23;
      v25 = *v40;
      do
      {
        for (i = 0; i != v24; ++i)
        {
          if (*v40 != v25)
          {
            objc_enumerationMutation(allocatedPushTokens);
          }

          v27 = *(*(&v39 + 1) + 8 * i);
          v28 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
          {
            v29 = [v21 tag];
            v30 = v29;
            *buf = 138412546;
            v31 = &stru_1F1AC8480;
            if (v29)
            {
              v31 = v29;
            }

            v45 = v31;
            v46 = 2112;
            allocateType = v27;
            _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "_ensureSessionWithSessionInfo[%@]: session has push token %@", buf, 0x16u);
          }

          remotePushTokens = [(IDSGlobalLinkSession *)v12 remotePushTokens];
          [remotePushTokens addObject:v27];
        }

        v24 = [allocatedPushTokens countByEnumeratingWithState:&v39 objects:v43 count:16];
      }

      while (v24);
    }

    v33 = selfCopy->_sessionsByID;
    infoCopy = v38;
    relaySessionID4 = [v38 relaySessionID];
    [(NSMutableDictionary *)v33 setObject:v12 forKeyedSubscript:relaySessionID4];

    [(IDSGlobalLink *)selfCopy _didCreateSession:v12];
    dictCopy = v37;
  }

  return v12;
}

- (void)configureGLExperimentsWithSessionInfo:(id)info
{
  v53 = *MEMORY[0x1E69E9840];
  infoCopy = info;
  if (self->_areGLExperimentsLockedIn)
  {
    goto LABEL_71;
  }

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: Configuring GL experiments...", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: Configuring GL experiments...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: Configuring GL experiments...");
      }
    }
  }

  v6 = MEMORY[0x1AC562F80](@"com.apple.ids", @"x-force-session-exp");
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v48 = v6;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: qrForceExperiment: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v42 = v6;
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: qrForceExperiment: %@");
      if (_IDSShouldLog())
      {
        v42 = v6;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: qrForceExperiment: %@");
      }
    }
  }

  if (!self->_hasUseLinkEngineBeenProgramaticallyOverriden)
  {
    qrSessionExperiments = self->_qrSessionExperiments;
    v10 = _os_feature_enabled_impl();
    v8 = sub_1A7B69680(@"idsle", 1, qrSessionExperiments, v6, "LinkEngine", v10);
    self->_useLinkEngine = v8;
    if (!v8)
    {
      goto LABEL_19;
    }

LABEL_18:
    v11 = self->_qrSessionExperiments;
    v12 = _os_feature_enabled_impl();
    LOBYTE(v8) = sub_1A7B69680(@"idsls", 1, v11, v6, "LinkSelection", v12);
    goto LABEL_19;
  }

  if (self->_useLinkEngine)
  {
    goto LABEL_18;
  }

  LOBYTE(v8) = 0;
LABEL_19:
  self->_useLinkSelection = v8;
  self->_ftPowerOptimizationForceEnabled = sub_1A7B69680(@"idscel", 0, self->_qrSessionExperiments, v6, "CellularPowerOptimization", 1);
  v13 = [infoCopy objectForKeyedSubscript:@"gl-allow-expensive-metrics"];
  bOOLValue = [v13 BOOLValue];

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = @"NO";
    recordExpensiveQualityMetrics = self->_recordExpensiveQualityMetrics;
    if (self->_recordExpensiveQualityMetrics)
    {
      v18 = @"YES";
    }

    else
    {
      v18 = @"NO";
    }

    if (bOOLValue)
    {
      v19 = @"YES";
    }

    else
    {
      v19 = @"NO";
    }

    *buf = 138412802;
    v48 = v18;
    v49 = 2112;
    v50 = v19;
    if ((recordExpensiveQualityMetrics & bOOLValue) != 0)
    {
      v16 = @"YES";
    }

    v51 = 2112;
    v52 = v16;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v20 = self->_recordExpensiveQualityMetrics ? @"YES" : @"NO";
    v21 = bOOLValue ? @"YES" : @"NO";
    v22 = (self->_recordExpensiveQualityMetrics & bOOLValue) != 0 ? @"YES" : @"NO";
    v43 = v21;
    v44 = v22;
    v42 = v20;
    _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@");
    if (_IDSShouldLog())
    {
      if (self->_recordExpensiveQualityMetrics)
      {
        v23 = @"YES";
      }

      else
      {
        v23 = @"NO";
      }

      if ((self->_recordExpensiveQualityMetrics & bOOLValue) != 0)
      {
        v24 = @"YES";
      }

      else
      {
        v24 = @"NO";
      }

      v43 = v21;
      v44 = v24;
      v42 = v23;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: recordExpensiveQualityMetrics: our value: %@; session info: %@; resolved: %@");
    }
  }

  self->_recordExpensiveQualityMetrics &= bOOLValue;
  if (self->_useLinkSelection)
  {
    v25 = objc_alloc_init(IDSPacketDeduplicator);
    packetDeduplicator = self->_packetDeduplicator;
    self->_packetDeduplicator = v25;

    v27 = +[IDSLinkSelectionStrategy defaultStrategy];
    linkSelectionStrategy = self->_linkSelectionStrategy;
    self->_linkSelectionStrategy = v27;

    if (IMGetDomainBoolForKeyWithDefaultValue())
    {
      v29 = [IDSLinkSelectionStrategy adaptiveWithAllowedOverheadPerPacket:16 allowedPacketsPerSecond:1.0];
      v30 = self->_linkSelectionStrategy;
      self->_linkSelectionStrategy = v29;
    }

    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = self->_linkSelectionStrategy;
      *buf = 138412290;
      v48 = v32;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: Link selection strategy: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v42 = self->_linkSelectionStrategy;
        _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: Link selection strategy: %@");
        if (_IDSShouldLog())
        {
          v42 = self->_linkSelectionStrategy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: Link selection strategy: %@");
        }
      }
    }
  }

  else
  {
    v33 = [[IDSLinksQualityMeasurer alloc] initWithTimeFn:&unk_1F1AAA380];
    qualityMeasurer = self->_qualityMeasurer;
    self->_qualityMeasurer = v33;

    v35 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: start capturing quality metrics...", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: start capturing quality metrics...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: start capturing quality metrics...");
        }
      }
    }

    [(IDSLinksQualityMeasurer *)self->_qualityMeasurer startCapturingBasicStats:1 sendBursts:self->_recordExpensiveQualityMetrics completionHandler:&unk_1F1AAA3A0, v42, v43, v44];
  }

  v45[0] = @"idsle";
  v36 = [MEMORY[0x1E696AD98] numberWithBool:{self->_useLinkEngine, v42}];
  v45[1] = @"idsls";
  v46[0] = v36;
  v37 = [MEMORY[0x1E696AD98] numberWithBool:self->_useLinkSelection];
  v46[1] = v37;
  v38 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v46 forKeys:v45 count:2];
  glComputedSessionExperiments = self->_glComputedSessionExperiments;
  self->_glComputedSessionExperiments = v38;

  v40 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
  {
    v41 = self->_glComputedSessionExperiments;
    *buf = 138412290;
    v48 = v41;
    _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "configureGLExperiments: computed session experiments: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"configureGLExperiments: computed session experiments: %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"configureGLExperiments: computed session experiments: %@");
      }
    }
  }

  self->_areGLExperimentsLockedIn = 1;

LABEL_71:
}

- (void)_connectWithSessionInfo:(id)info interfaceAddress:(id)address joinSession:(BOOL)session allocbindFailover:(BOOL)failover completionHandler:(id)handler withLocalInterfacePreference:(int)preference
{
  sessionCopy = session;
  failoverCopy = failover;
  v396 = *MEMORY[0x1E69E9840];
  infoCopy = info;
  addressCopy = address;
  aBlock = handler;
  if (self->_acceptedRelaySessionID)
  {
    v13 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:?];
    v14 = v13;
    if (v13 && ([v13 linkEngine], v15 = objc_claimAutoreleasedReturnValue(), v15, v15))
    {
      v16 = MEMORY[0x1E696AEC0];
      linkEngine = [v14 linkEngine];
      v18 = [linkEngine tag];
      v19 = [v16 stringWithFormat:@"[%@] ", v18];
    }

    else
    {
      v19 = &stru_1F1AC8480;
    }
  }

  else
  {
    v19 = &stru_1F1AC8480;
  }

  if (!self->_cellularSlicingFlags)
  {
    v20 = [infoCopy objectForKeyedSubscript:@"gl-option-session-cell-slicing-flags"];
    self->_cellularSlicingFlags = [v20 unsignedIntValue];
  }

  state = self->_state;
  if (state < 5)
  {
    if (state >= 2 && !sessionCopy)
    {
      v22 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        v24 = _IDSLinkStateStrings[self->_state];
        *buf = 138412802;
        *&buf[4] = self;
        *&buf[12] = 2112;
        *&buf[14] = v19;
        *&buf[22] = 2080;
        *&buf[24] = v24;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "%@%@ is in [%s] state, skip sending info request.", buf, 0x20u);
      }

      goto LABEL_13;
    }

    v395 = 0u;
    v394 = 0u;
    v392 = 0u;
    v393 = 0u;
    v390 = 0u;
    v391 = 0u;
    memset(buf, 0, sizeof(buf));
    memset(v388, 0, sizeof(v388));
    v25 = objc_alloc_init(IDSQuickRelaySessionInfo);
    v26 = [(IDSQuickRelaySessionInfo *)v25 parseSessionInfo:infoCopy];
    groupID = [(IDSQuickRelaySessionInfo *)v25 groupID];

    if (groupID)
    {
      groupID2 = [(IDSQuickRelaySessionInfo *)v25 groupID];
      groupID = self->_groupID;
      self->_groupID = groupID2;
    }

    else
    {
      v30 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412290;
        *&v383[4] = v19;
        _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: groupID nil in session info.", v383, 0xCu);
      }
    }

    qrSessionExperiments = [(IDSQuickRelaySessionInfo *)v25 qrSessionExperiments];
    qrSessionExperiments = self->_qrSessionExperiments;
    self->_qrSessionExperiments = qrSessionExperiments;

    [(IDSGlobalLink *)self configureGLExperimentsWithSessionInfo:infoCopy];
    if (self->_ftPowerOptimizationForceEnabled)
    {
      v33 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412290;
        *&v383[4] = v19;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled is enabled by com.apple.ids default", v383, 0xCu);
      }

      self->_ftPowerOptimizationEnabled = 1;
      [(IDSNWLink *)self->_nwLink setFtPowerOptimizationEnabled:self->_ftPowerOptimizationForceEnabled];
    }

    else
    {
      v34 = [infoCopy objectForKey:@"idscel"];
      v35 = v34 == 0;

      if (v35)
      {
        v38 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled nil in session info", v383, 0xCu);
        }
      }

      else
      {
        ftPowerOptimizationEnabled = [(IDSQuickRelaySessionInfo *)v25 ftPowerOptimizationEnabled];
        self->_ftPowerOptimizationEnabled = ftPowerOptimizationEnabled;
        if (ftPowerOptimizationEnabled)
        {
          v37 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = v19;
            _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: ftPowerOptimizationEnabled is enabled by session info", v383, 0xCu);
          }

          [(IDSNWLink *)self->_nwLink setFtPowerOptimizationEnabled:self->_ftPowerOptimizationEnabled];
        }
      }
    }

    if (IMGetDomainBoolForKeyWithDefaultValue() && [(IDSQuickRelaySessionInfo *)v25 allocateType]== 3)
    {
      v39 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 0;
        _os_log_impl(&dword_1A7AD9000, v39, OS_LOG_TYPE_DEFAULT, "shared sessions disabled.", v383, 2u);
      }

      goto LABEL_520;
    }

    allocateType = [(IDSQuickRelaySessionInfo *)v25 allocateType];
    v338 = 0;
    if (self->_useLinkEngine && allocateType != 2)
    {
      v338 = [(IDSGlobalLink *)self _ensureSessionWithSessionInfo:v25 sessionInfoDict:infoCopy localInterfacePreference:preference];
      if ([v338 wantsToJoin]&& !sessionCopy)
      {
        v41 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: we are already joining session, ignore connect request here", v383, 0xCu);
        }

        goto LABEL_519;
      }

      if (sessionCopy)
      {
        [v338 setWantsToJoin:1];
      }

      else if (([v338 wantsToJoin]& 1) == 0)
      {
        [v338 setWantsInfo:1];
      }

      sessionInfoDict = [v338 sessionInfoDict];
      v43 = [sessionInfoDict copy];

      v371[1] = MEMORY[0x1E69E9820];
      v371[2] = 3221225472;
      v371[3] = sub_1A7B7CACC;
      v371[4] = &unk_1E77E0C88;
      v372 = v19;
      v373 = v43;
      cut_dispatch_log_queue();
    }

    v333 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:1];
    if (v26)
    {
      if (self->_networkAddressChangeTimer)
      {
        v44 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
        {
          networkAddressChangeTimer = self->_networkAddressChangeTimer;
          *v383 = 134218240;
          *&v383[4] = v26;
          *&v383[12] = 2048;
          *&v383[14] = networkAddressChangeTimer;
          _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "error code = %ld, interface change timer: %p", v383, 0x16u);
        }

        goto LABEL_519;
      }

      if (!v333 || !failoverCopy)
      {
        v77 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
        {
          v78 = @"NO";
          if (v333)
          {
            v79 = @"YES";
          }

          else
          {
            v79 = @"NO";
          }

          *v383 = 134218498;
          *&v383[4] = v26;
          *&v383[12] = 2112;
          *&v383[14] = v79;
          if (failoverCopy)
          {
            v78 = @"YES";
          }

          *&v383[22] = 2112;
          *&v383[24] = v78;
          _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "error code = %ld, hasConnectedCandidatePair = %@, allocbindFailover = %@", v383, 0x20u);
        }

        sub_1A7B7CB88(aBlock, v26, @"Invalid session info");
        goto LABEL_519;
      }
    }

    if (!self->_avcDataBlob)
    {
      avcDataBlob = [(IDSQuickRelaySessionInfo *)v25 avcDataBlob];
      v47 = avcDataBlob == 0;

      if (!v47)
      {
        avcDataBlob2 = [(IDSQuickRelaySessionInfo *)v25 avcDataBlob];
        avcDataBlob = self->_avcDataBlob;
        self->_avcDataBlob = avcDataBlob2;

        v50 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
        {
          v51 = self->_avcDataBlob;
          *v383 = 138412546;
          *&v383[4] = v19;
          *&v383[12] = 2112;
          *&v383[14] = v51;
          _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: _avcDataBlob: %@", v383, 0x16u);
        }
      }
    }

    quicMaterialExchangeProvider = [(IDSQuickRelaySessionInfo *)v25 quicMaterialExchangeProvider];

    if (quicMaterialExchangeProvider)
    {
      quicMaterialExchangeProvider2 = [(IDSQuickRelaySessionInfo *)v25 quicMaterialExchangeProvider];
      quicMaterialExchangeProvider = self->_quicMaterialExchangeProvider;
      self->_quicMaterialExchangeProvider = quicMaterialExchangeProvider2;

      [(IDSGroupQUICMaterialExchangeProvider *)self->_quicMaterialExchangeProvider addHandler:self];
    }

    if ([(IDSQuickRelaySessionInfo *)v25 h2FallbackDisabled]&& self->_H2FallbackEnabled)
    {
      self->_H2FallbackEnabled = 0;
      v55 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
      {
        v56 = @"NO";
        if (self->_H2FallbackEnabled)
        {
          v56 = @"YES";
        }

        *v383 = 138412546;
        *&v383[4] = v19;
        *&v383[12] = 2112;
        *&v383[14] = v56;
        _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: set _H2FallbackEnabled to %@", v383, 0x16u);
      }
    }

    self->_H2FallbackEnabled = IMGetDomainBoolForKeyWithDefaultValue();
    v57 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
    {
      v58 = @"NO";
      if (self->_H2FallbackEnabled)
      {
        v58 = @"YES";
      }

      *v383 = 138412546;
      *&v383[4] = v19;
      *&v383[12] = 2112;
      *&v383[14] = v58;
      _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo%@: _H2FallbackEnabled after reading forceH2FallbackEnabled: %@", v383, 0x16u);
    }

    allocateType2 = [(IDSQuickRelaySessionInfo *)v25 allocateType];
    allocateRequestID = [(IDSQuickRelaySessionInfo *)v25 allocateRequestID];
    if (allocateType2 == 3 && sessionCopy)
    {
      self->_sharedSessionJoined = 1;
      v59 = ids_monotonic_time();
    }

    else
    {
      v59 = ids_monotonic_time();
      if (allocateType2 == 2)
      {
        if ([(NSMutableArray *)self->_selfAllocateRequestIDs containsObject:allocateRequestID])
        {
          v60 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412546;
            *&v383[4] = v19;
            *&v383[12] = 2112;
            *&v383[14] = allocateRequestID;
            _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "%@receive self allocate response for request %@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = &v19->isa;
              v311 = allocateRequestID;
              _IDSLogTransport(@"GL", @"IDS", @"%@receive self allocate response for request %@.");
              if (_IDSShouldLog())
              {
                p_isa = &v19->isa;
                v311 = allocateRequestID;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"%@receive self allocate response for request %@.");
              }
            }
          }

          [(IDSGlobalLink *)self _sendAllocbindRequestForExtIP:v25 startTime:v59, p_isa, v311];
          [(NSMutableArray *)self->_selfAllocateRequestIDs removeObject:allocateRequestID];
          if ([(NSMutableArray *)self->_selfAllocateRequestIDs count])
          {
            v61 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v61, OS_LOG_TYPE_DEFAULT))
            {
              v62 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
              *v383 = 138412546;
              *&v383[4] = v19;
              *&v383[12] = 2048;
              *&v383[14] = v62;
              _os_log_impl(&dword_1A7AD9000, v61, OS_LOG_TYPE_DEFAULT, "%@selfAllocation count = %lu", v383, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v312 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
                _IDSLogTransport(@"GL", @"IDS", @"%@selfAllocation count = %lu");
                if (_IDSShouldLog())
                {
                  [(NSMutableArray *)self->_selfAllocateRequestIDs count:v19];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@selfAllocation count = %lu");
                }
              }
            }
          }

          else
          {
            self->_hasPendingSelfAllocation = 0;
            [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
          }
        }

        else
        {
          v82 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412546;
            *&v383[4] = v19;
            *&v383[12] = 2112;
            *&v383[14] = allocateRequestID;
            _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "%@receive self allocate response for unknown request %@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"%@receive self allocate response for unknown request %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"%@receive self allocate response for unknown request %@.");
              }
            }
          }
        }

        goto LABEL_518;
      }
    }

    self->_isInitiator = [(IDSQuickRelaySessionInfo *)v25 isInitiator];
    self->_uplinkNackDisabled = [(IDSQuickRelaySessionInfo *)v25 uplinkNackDisabled];
    self->_conversationShouldUseP2PTLEAccordingToServer = [(IDSQuickRelaySessionInfo *)v25 transportLayerEncryptionDisabled];
    self->_ipDiscoveryDisabled = [(IDSQuickRelaySessionInfo *)v25 ipDiscoveryDisabled];
    if (self->_useLinkEngine)
    {
      if (!self->_idsSessionID)
      {
        idsSessionID = [(IDSQuickRelaySessionInfo *)v25 idsSessionID];
        idsSessionID = self->_idsSessionID;
        self->_idsSessionID = idsSessionID;

        memset(v378, 170, 16);
        v65 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:self->_idsSessionID];
        [v65 getUUIDBytes:v378];

        v66 = [MEMORY[0x1E695DEF0] dataWithBytes:v378 length:16];
        controlMessageKey = self->_controlMessageKey;
        self->_controlMessageKey = v66;

        v68 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
        {
          v69 = self->_idsSessionID;
          cbuuid = self->_cbuuid;
          *v383 = 138412802;
          *&v383[4] = v19;
          *&v383[12] = 2112;
          *&v383[14] = v69;
          *&v383[22] = 2112;
          *&v383[24] = cbuuid;
          _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "%@update ids-session-id:%@ for cbuuid:%@.", v383, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v311 = self->_idsSessionID;
            v316 = self->_cbuuid;
            p_isa = &v19->isa;
            _IDSLogTransport(@"GL", @"IDS", @"%@update ids-session-id:%@ for cbuuid:%@.");
            if (_IDSShouldLog())
            {
              v311 = self->_idsSessionID;
              v316 = self->_cbuuid;
              p_isa = &v19->isa;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"%@update ids-session-id:%@ for cbuuid:%@.");
            }
          }
        }
      }

      v316 = [(IDSGlobalLink *)self _localCandidatesForRelaySession:v338, p_isa, v311, v316];
      v72 = [v316 count] == 0;

      if (v72)
      {
        v80 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v80, OS_LOG_TYPE_DEFAULT))
        {
          *v383 = 138412290;
          *&v383[4] = v19;
          _os_log_impl(&dword_1A7AD9000, v80, OS_LOG_TYPE_DEFAULT, "%@Found no local interface available for QR.", v383, 0xCu);
        }

        if (!v333)
        {
          sub_1A7B7CB88(aBlock, 6, @"No local interface available");
          if (self->_clientType == 6)
          {
            v81 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v81, OS_LOG_TYPE_DEFAULT))
            {
              *v383 = 138412290;
              *&v383[4] = v19;
              _os_log_impl(&dword_1A7AD9000, v81, OS_LOG_TYPE_DEFAULT, "%@Found no local interface available for QR. - gathering ABC with packet capture", v383, 0xCu);
            }

            [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"NoLocalNetwork" duration:15];
          }
        }
      }

      else
      {
        if (aBlock)
        {
          v73 = _Block_copy(aBlock);
          connectReadyHandler = self->_connectReadyHandler;
          self->_connectReadyHandler = v73;
        }

        [(IDSGlobalLink *)self _updateLinksForSession:v338];
      }

      goto LABEL_518;
    }

    key = [(IDSQuickRelaySessionInfo *)v25 relaySessionID];
    relaySessionToken = [(IDSQuickRelaySessionInfo *)v25 relaySessionToken];
    relaySessionKey = [(IDSQuickRelaySessionInfo *)v25 relaySessionKey];
    participantID = [(IDSQuickRelaySessionInfo *)v25 participantID];
    [(IDSQuickRelaySessionInfo *)v25 serverAddress];
    [(IDSQuickRelaySessionInfo *)v25 serverAddressIPv6];
    __memcpy_chk();
    __memcpy_chk();
    valid = IsValidSA(v388);
    acceptedRelaySessionID = self->_acceptedRelaySessionID;
    v76 = [(IDSQuickRelaySessionInfo *)v25 ipPreference]== 1 || (IMGetDomainBoolForKey() & 1) != 0 || self->_forceIPv6;
    v330 = v76;
    v83 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
    {
      if ([(IDSQuickRelaySessionInfo *)v25 ipPreference]== 1)
      {
        v84 = @"YES";
      }

      else
      {
        v84 = @"NO";
      }

      if (IMGetDomainBoolForKey())
      {
        v85 = @"YES";
      }

      else
      {
        v85 = @"NO";
      }

      if (self->_forceIPv6)
      {
        v86 = @"YES";
      }

      else
      {
        v86 = @"NO";
      }

      *v383 = 138412802;
      *&v383[4] = v84;
      *&v383[12] = 2112;
      *&v383[14] = v85;
      *&v383[22] = 2112;
      *&v383[24] = v86;
      _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "force IPv6 options server: %@; default: %@; manual: %@", v383, 0x20u);
    }

    if (self->_disablePureLinkFeature)
    {
      v87 = 2.0;
    }

    else
    {
      v87 = 1.0;
    }

    v88 = +[IDSServerBag sharedInstance];
    v89 = [v88 objectForKey:@"disable-transport-score-cards"];
    bOOLValue = [v89 BOOLValue];

    if (allocateType2 != 3 && !failoverCopy)
    {
      allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      HasNonSharedRelayCandidatePair = GLUtilHasNonSharedRelayCandidatePair(key, allValues);

      if (HasNonSharedRelayCandidatePair)
      {
        v93 = +[IDSServerBag sharedInstance];
        v324 = [v93 objectForKey:@"ids-disallow-receiver-fallback"];

        if ([v324 BOOLValue])
        {
          v94 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = key;
            v95 = "disallowReceiverFallbackBagValue enabled: relay session %@ already exists, ignore.";
LABEL_154:
            _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, v95, v383, 0xCu);
            goto LABEL_155;
          }

          goto LABEL_155;
        }

        if (self->_isInitiator)
        {
          v94 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 138412290;
            *&v383[4] = key;
            v95 = "relay session %@ already exists, ignore.";
            goto LABEL_154;
          }

LABEL_155:

LABEL_517:
LABEL_518:

LABEL_519:
          v39 = v338;
LABEL_520:

          goto LABEL_521;
        }
      }
    }

    v96 = addressCopy;
    if (!addressCopy)
    {
      v97 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v97, OS_LOG_TYPE_DEFAULT))
      {
        interfaceAddressArray = self->_interfaceAddressArray;
        *v383 = 138412290;
        *&v383[4] = interfaceAddressArray;
        _os_log_impl(&dword_1A7AD9000, v97, OS_LOG_TYPE_DEFAULT, "current available interfaces: %@.", v383, 0xCu);
      }

      v96 = 0;
    }

    if (!failoverCopy)
    {
      if (!self->_connectingCandidatePairSessionInfo)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
        self->_connectingCandidatePairSessionInfo = Mutable;
      }

      v101 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
      {
        *v383 = 138412546;
        *&v383[4] = key;
        *&v383[12] = 2112;
        *&v383[14] = @"NO";
        _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "add relaySessionID: %@, allocbindFailover: %@", v383, 0x16u);
      }

      v102 = [infoCopy copy];
      if (v102)
      {
        CFDictionarySetValue(self->_connectingCandidatePairSessionInfo, key, v102);
      }

      else
      {
        v103 = MEMORY[0x1E69E9C10];
        v104 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v103, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14910();
        }
      }

      v96 = addressCopy;
    }

    v371[0] = 0;
    if (((allocateType2 == 3) & (bOOLValue ^ 1 | v330)) != 0)
    {
      if (v96)
      {
        v105 = acceptedRelaySessionID != 0;
        linkProtocol = [(IDSQuickRelaySessionInfo *)v25 linkProtocol];
        isInitiator = self->_isInitiator;
        allValues2 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        v371[0] = GLUtilSelectStunTransport(key, linkProtocol, 1, isInitiator, v105, failoverCopy, allValues2, self->_state);

        if ((v371[0] - 3) <= 1 && self->_state == 4)
        {
          v109 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
          {
            v110 = (&_IDSStunTransportStrings)[v371[0]];
            *v383 = 136315650;
            *&v383[4] = v110;
            *&v383[12] = 2112;
            *&v383[14] = key;
            *&v383[22] = 2112;
            *&v383[24] = allocateRequestID;
            _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "skip %s for session %@, alloc reqID %@ link is connected.", v383, 0x20u);
          }

LABEL_178:

          goto LABEL_517;
        }

        v117 = addressCopy;
        goto LABEL_195;
      }

      v370 = 0;
      [(IDSGlobalLink *)self _selectStunTransport:v371 andInterfaceAddress:&v370 forRelaySessionID:key preferIPv4:!v330 isValidSA:valid];
      v117 = v370;
    }

    else
    {
      v111 = acceptedRelaySessionID != 0;
      linkProtocol2 = [(IDSQuickRelaySessionInfo *)v25 linkProtocol];
      v113 = self->_isInitiator;
      allValues3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v371[0] = GLUtilSelectStunTransport(key, linkProtocol2, allocateType2 == 3, v113, v111, failoverCopy, allValues3, self->_state);

      v115 = v371[0];
      if ((v371[0] - 3) <= 1 && self->_state == 4)
      {
        v109 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v109, OS_LOG_TYPE_DEFAULT))
        {
          v116 = (&_IDSStunTransportStrings)[v371[0]];
          *v383 = 136315650;
          *&v383[4] = v116;
          *&v383[12] = 2112;
          *&v383[14] = key;
          *&v383[22] = 2112;
          *&v383[24] = allocateRequestID;
          _os_log_impl(&dword_1A7AD9000, v109, OS_LOG_TYPE_DEFAULT, "skip %s for session %@, alloc reqID %@, link is connected.", v383, 0x20u);
        }

        goto LABEL_178;
      }

      v117 = addressCopy;
      if (addressCopy)
      {
LABEL_195:
        addressCopy = v117;
        index = [v117 index];
        address = [addressCopy address];
        v126 = *([address sa] + 1);

        v127 = (v330 || !self->_disablePureLinkFeature) && valid;
        v128 = v126 == 30 && v127;
        v129 = buf;
        if (v128)
        {
          v129 = v388;
        }

        v323 = v129;
        v322 = v127;
        if (!self->_H2FallbackEnabled)
        {
          v325 = v371[0];
          goto LABEL_221;
        }

        if (v371[0] == 3)
        {
          v130 = 4;
        }

        else
        {
          if (v371[0] != 4)
          {
            v325 = v371[0];
            goto LABEL_218;
          }

          v130 = 3;
        }

        v325 = v130;
LABEL_218:
        v136 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
        {
          v137 = (&_IDSStunTransportStrings)[v371[0]];
          v138 = (&_IDSStunTransportStrings)[v325];
          *v383 = 136315394;
          *&v383[4] = v137;
          *&v383[12] = 2080;
          *&v383[14] = v138;
          _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "current stunTransport is: %s, actualSelectedTransport is: %s", v383, 0x16u);
        }

LABEL_221:
        v139 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v139, OS_LOG_TYPE_DEFAULT))
        {
          if (v126 == 30)
          {
            v140 = "v6";
          }

          else
          {
            v140 = "v4";
          }

          name = [addressCopy name];
          v142 = (&_IDSStunTransportStrings)[v325];
          isInternal = [(IDSQuickRelaySessionInfo *)v25 isInternal];
          v144 = "prod";
          *v383 = 136316674;
          *&v383[4] = v140;
          *&v383[12] = 2112;
          if (isInternal)
          {
            v144 = "carry";
          }

          *&v383[14] = name;
          v145 = @"NO";
          *&v383[24] = v142;
          *&v383[22] = 2080;
          if (valid)
          {
            v145 = @"YES";
          }

          *v384 = 2112;
          *&v384[2] = allocateRequestID;
          *&v384[10] = 2080;
          *&v384[12] = v144;
          *&v384[20] = 1024;
          *&v384[22] = v322;
          *&v384[26] = 2112;
          *&v384[28] = v145;
          _os_log_impl(&dword_1A7AD9000, v139, OS_LOG_TYPE_DEFAULT, "selected %s interface [%@] for [%s] allocation %@, %s QR server, isConnectToQRIPv6Enabled = %d, isValidSA = %@", v383, 0x44u);
        }

        metricsCollector = self->_metricsCollector;
        name2 = [addressCopy name];
        [(IDSGFTMetricsCollector *)metricsCollector selectedLocalInterface:name2];

        if (v322 || v126 != 30)
        {
          FirstPrefix = 0;
        }

        else
        {
          FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, index);
          if (!FirstPrefix)
          {
            v184 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v184, OS_LOG_TYPE_DEFAULT))
            {
              index2 = [addressCopy index];
              *v383 = 67109120;
              *&v383[4] = index2;
              _os_log_impl(&dword_1A7AD9000, v184, OS_LOG_TYPE_DEFAULT, "delay connectWithSessionInfo for if:%d nat64 prefix.", v383, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                index3 = [addressCopy index];
                _IDSLogTransport(@"GL", @"IDS", @"delay connectWithSessionInfo for if:%d nat64 prefix.");
                if (_IDSShouldLog())
                {
                  [addressCopy index];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"delay connectWithSessionInfo for if:%d nat64 prefix.");
                }
              }
            }

            v364[0] = MEMORY[0x1E69E9820];
            v364[1] = 3221225472;
            v364[2] = sub_1A7B7CCA0;
            v364[3] = &unk_1E77E0CD8;
            v364[4] = self;
            v365 = infoCopy;
            addressCopy = addressCopy;
            v366 = addressCopy;
            v369 = sessionCopy;
            v367 = aBlock;
            preferenceCopy = preference;
            v186 = _Block_copy(v364);
            name3 = [addressCopy name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:index interfaceName:name3 completionBlock:v186];

            goto LABEL_517;
          }

          v149 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
          {
            *v383 = 67109120;
            *&v383[4] = index;
            _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "nat64 prefix cache hit for if:%d", v383, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = index;
              _IDSLogTransport(@"GL", @"IDS", @"nat64 prefix cache hit for if:%d");
              if (_IDSShouldLog())
              {
                p_isa = index;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"nat64 prefix cache hit for if:%d");
              }
            }
          }
        }

        if (!self->_idsSessionID)
        {
          idsSessionID2 = [(IDSQuickRelaySessionInfo *)v25 idsSessionID];
          v151 = self->_idsSessionID;
          self->_idsSessionID = idsSessionID2;

          memset(v378, 170, 16);
          v152 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:self->_idsSessionID];
          [v152 getUUIDBytes:v378];

          v153 = [MEMORY[0x1E695DEF0] dataWithBytes:v378 length:16];
          v154 = self->_controlMessageKey;
          self->_controlMessageKey = v153;

          v155 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v155, OS_LOG_TYPE_DEFAULT))
          {
            v156 = self->_idsSessionID;
            v157 = self->_cbuuid;
            *v383 = 138412546;
            *&v383[4] = v156;
            *&v383[12] = 2112;
            *&v383[14] = v157;
            _os_log_impl(&dword_1A7AD9000, v155, OS_LOG_TYPE_DEFAULT, "update ids-session-id:%@ for cbuuid:%@.", v383, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              p_isa = self->_idsSessionID;
              v311 = self->_cbuuid;
              _IDSLogTransport(@"GL", @"IDS", @"update ids-session-id:%@ for cbuuid:%@.");
              if (_IDSShouldLog())
              {
                p_isa = self->_idsSessionID;
                v311 = self->_cbuuid;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"update ids-session-id:%@ for cbuuid:%@.");
              }
            }
          }
        }

        v311 = [(IDSGlobalLink *)self _isAcceptedRelaySessionForAllocationRequestID:allocateRequestID acceptedRelaySessionID:key, p_isa, v311];
        if ((v371[0] - 3) > 1)
        {
          goto LABEL_316;
        }

        Value = 0;
        if (infoCopy && @"link-protocol")
        {
          Value = CFDictionaryGetValue(infoCopy, @"link-protocol");
        }

        if (v325 == [Value intValue])
        {
          if (!v128)
          {
LABEL_264:
            v163 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v163, OS_LOG_TYPE_DEFAULT))
            {
              v164 = (&_IDSStunTransportStrings)[v325];
              v165 = bswap32(*&buf[2]) >> 16;
              if (self->_QUICForQREnabled)
              {
                v166 = @"YES";
              }

              else
              {
                v166 = @"NO";
              }

              *v383 = 67109634;
              *&v383[4] = v165;
              *&v383[8] = 2080;
              *&v383[10] = v164;
              *&v383[18] = 2112;
              *&v383[20] = v166;
              _os_log_impl(&dword_1A7AD9000, v163, OS_LOG_TYPE_DEFAULT, "use port %u for %s, _QUICForQREnabled: %@", v383, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v167 = bswap32(*&buf[2]) >> 16;
              v168 = self->_QUICForQREnabled ? @"YES" : @"NO";
              v313 = (&_IDSStunTransportStrings)[v325];
              v316 = v168;
              v302 = v167;
              _IDSLogTransport(@"GL", @"IDS", @"use port %u for %s, _QUICForQREnabled: %@");
              if (_IDSShouldLog())
              {
                v169 = bswap32(*&buf[2]) >> 16;
                if (self->_QUICForQREnabled)
                {
                  v170 = @"YES";
                }

                else
                {
                  v170 = @"NO";
                }

                v313 = (&_IDSStunTransportStrings)[v325];
                v316 = v170;
                v302 = v169;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"use port %u for %s, _QUICForQREnabled: %@");
              }
            }

            goto LABEL_279;
          }
        }

        else
        {
          if (v325 == 3)
          {
            v159 = 80;
          }

          else
          {
            v159 = 443;
          }

          v160 = __rev16(v159);
          *&buf[2] = v160;
          if (!v128)
          {
            goto LABEL_264;
          }

          WORD1(v388[0]) = v160;
        }

        v161 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v161, OS_LOG_TYPE_DEFAULT))
        {
          v162 = (&_IDSStunTransportStrings)[v325];
          *v383 = 67109378;
          *&v383[4] = bswap32(WORD1(v388[0])) >> 16;
          *&v383[8] = 2080;
          *&v383[10] = v162;
          _os_log_impl(&dword_1A7AD9000, v161, OS_LOG_TYPE_DEFAULT, "IPv6 only: use port %u for %s.", v383, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v302 = bswap32(WORD1(v388[0])) >> 16;
            v313 = (&_IDSStunTransportStrings)[v325];
            _IDSLogTransport(@"GL", @"IDS", @"IPv6 only: use port %u for %s.");
            if (_IDSShouldLog())
            {
              v302 = bswap32(WORD1(v388[0])) >> 16;
              v313 = (&_IDSStunTransportStrings)[v325];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"IPv6 only: use port %u for %s.");
            }
          }
        }

LABEL_279:
        if (self->_H2FallbackEnabled)
        {
          if (v325 == 3)
          {
            v320 = self->_tcpLink;
            v171 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v171, OS_LOG_TYPE_DEFAULT))
            {
              tcpLink = self->_tcpLink;
              *v383 = 138412290;
              *&v383[4] = tcpLink;
              _os_log_impl(&dword_1A7AD9000, v171, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: Use tcpLink since H2 is blocked: %@", v383, 0xCu);
            }

            address2 = [addressCopy address];
            v174 = -[IDSTCPLink connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:](v320, "connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:", index, [address2 sa], LOWORD(self->_portRange), v323, self->_clientUUID, 0);

            if (!v174)
            {
              goto LABEL_315;
            }

            *&v175 = 0xAAAAAAAAAAAAAAAALL;
            *(&v175 + 1) = 0xAAAAAAAAAAAAAAAALL;
            v386 = v175;
            v387 = v175;
            *&v384[32] = v175;
            v385 = v175;
            *v384 = v175;
            *&v384[16] = v175;
            *v383 = v175;
            *&v383[16] = v175;
            address3 = [addressCopy address];
            SAToIPPortString(v383, 0x80uLL, [address3 sa]);

            address4 = [addressCopy address];
            memcpy([address4 sa], v174, v174->sa_len);

            *&v178 = 0xAAAAAAAAAAAAAAAALL;
            *(&v178 + 1) = 0xAAAAAAAAAAAAAAAALL;
            v381 = v178;
            v382 = v178;
            v379 = v178;
            v380 = v178;
            *&v378[32] = v178;
            *&v378[48] = v178;
            *v378 = v178;
            *&v378[16] = v178;
            address5 = [addressCopy address];
            SAToIPPortString(v378, 0x80uLL, [address5 sa]);

            v180 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v180, OS_LOG_TYPE_DEFAULT))
            {
              *v374 = 136315394;
              v375 = v383;
              v376 = 2080;
              v377 = v378;
              _os_log_impl(&dword_1A7AD9000, v180, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: TCP connection: change the local address from %s to: %s", v374, 0x16u);
            }

            goto LABEL_314;
          }

LABEL_316:
          *&v197 = 0xAAAAAAAAAAAAAAAALL;
          *(&v197 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v386 = v197;
          v387 = v197;
          *&v384[32] = v197;
          v385 = v197;
          *v384 = v197;
          *&v384[16] = v197;
          v198 = FirstPrefix == 0 || v128;
          *v383 = v197;
          *&v383[16] = v197;
          if (FirstPrefix == 0 || v128 || ![(IDSGlobalLink *)self _synthesizeNAT64ForAddress:v323 withPrefix:FirstPrefix toAddress:v383])
          {
            v199 = v323;
          }

          else
          {
            v199 = v383;
          }

          address6 = [addressCopy address];
          v335 = tokenForStunCandidatePair([address6 sa], v199, key);

          tokenToCandidatePairs = self->_tokenToCandidatePairs;
          if (tokenToCandidatePairs)
          {
            if (v335)
            {
              v202 = CFDictionaryGetValue(tokenToCandidatePairs, v335);
              if (v202)
              {
                v203 = v202;
                v204 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v204, OS_LOG_TYPE_DEFAULT))
                {
                  *v378 = 138412546;
                  *&v378[4] = v25;
                  *&v378[12] = 2112;
                  *&v378[14] = infoCopy;
                  _os_log_impl(&dword_1A7AD9000, v204, OS_LOG_TYPE_DEFAULT, "setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@", v378, 0x16u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v304 = v25;
                    v313 = infoCopy;
                    _IDSLogTransport(@"GL", @"IDS", @"setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@");
                    if (_IDSShouldLog())
                    {
                      v304 = v25;
                      v313 = infoCopy;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"setPropertiesWithRelaySessionInfo: qrSessionInfo: %@, sessionInfo: %@");
                    }
                  }
                }

                state = [v203 state];
                v206 = state;
                if (state <= 4 && ((1 << state) & 0x1A) != 0)
                {
                  v207 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v207, OS_LOG_TYPE_DEFAULT))
                  {
                    v208 = (&_IDSStunCandidatePairStateStrings)[v206];
                    *v378 = 138412546;
                    *&v378[4] = v335;
                    *&v378[12] = 2080;
                    *&v378[14] = v208;
                    _os_log_impl(&dword_1A7AD9000, v207, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, state [%s]", v378, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      candidatePairToken5 = v335;
                      v313 = (&_IDSStunCandidatePairStateStrings)[v206];
                      _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, state [%s]");
                      if (_IDSShouldLog())
                      {
                        candidatePairToken5 = v335;
                        v313 = (&_IDSStunCandidatePairStateStrings)[v206];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, state [%s]");
                      }
                    }
                  }
                }

                else
                {
                  [v203 setPropertiesWithRelaySessionInfo:v25 sessionInfoDict:infoCopy enableSKE:self->_enableSKE];
                }

                if (v206 <= 4)
                {
                  v226 = v203;
                  if (((1 << v206) & 0x1A) != 0)
                  {
LABEL_516:

                    goto LABEL_517;
                  }

LABEL_365:
                  v227 = v226;
                  local = [v226 local];
                  isCellularStunCandidate = [local isCellularStunCandidate];

                  if (isCellularStunCandidate)
                  {
                    local2 = [v227 local];
                    [local2 setCellularSlicingFlags:self->_cellularSlicingFlags];
                  }

                  clat46 = [addressCopy clat46];
                  local3 = [v227 local];
                  [local3 setIsCLAT46:clat46];

                  [v227 setIsConnectToQRIPv6Enabled:v330];
                  if (sessionCopy)
                  {
                    local4 = [v227 local];

                    if (local4)
                    {
                      local5 = [v227 local];
                      radioAccessTechnology = [local5 radioAccessTechnology];
                    }

                    else
                    {
                      radioAccessTechnology = 10;
                    }

                    if (infoCopy)
                    {
                      v238 = @"allocate-time" == 0;
                    }

                    else
                    {
                      v238 = 1;
                    }

                    v239 = !v238;
                    if (!v238)
                    {
                      CFDictionaryGetValue(infoCopy, @"allocate-time");
                    }

                    objc_opt_class();
                    v240 = 0.0;
                    if (objc_opt_isKindOfClass())
                    {
                      if (v239)
                      {
                        v241 = CFDictionaryGetValue(infoCopy, @"allocate-time");
                      }

                      else
                      {
                        v241 = 0;
                      }

                      [v241 doubleValue];
                      v240 = v242;
                    }

                    v331 = [infoCopy objectForKeyedSubscript:@"qrbv"];
                    v243 = v371[0];
                    relayServerProviderType = [(IDSQuickRelaySessionInfo *)v25 relayServerProviderType];
                    v245 = self->_idsSessionID;
                    reportingDataBlob = [(IDSQuickRelaySessionInfo *)v25 reportingDataBlob];
                    LOBYTE(v306) = self->_isInitiator;
                    [(IDSGlobalLink *)self _addQRAAWDBlock:allocateRequestID allocateRequestTime:radioAccessTechnology inferredExternalRAT:v243 stunTransport:relayServerProviderType relayProviderType:v245 idsSessionID:reportingDataBlob reportingDataBlob:v240 isInitiator:v306 serverSoftwareVersion:v331];

                    if (self->_isInitiator)
                    {
                      if (self->_inviteSentTime == 0.0)
                      {
                        v247 = 0;
                        if (infoCopy && @"gl-option-invite-sent-time")
                        {
                          v247 = CFDictionaryGetValue(infoCopy, @"gl-option-invite-sent-time");
                        }

                        [v247 doubleValue];
                        self->_inviteSentTime = v248;
                      }
                    }

                    else
                    {
                      if (self->_inviteRecvTime == 0.0)
                      {
                        v249 = 0;
                        if (infoCopy && @"gl-option-invite-recv-time")
                        {
                          v249 = CFDictionaryGetValue(infoCopy, @"gl-option-invite-recv-time");
                        }

                        [v249 doubleValue];
                        self->_inviteRecvTime = v250;
                      }

                      v251 = 0;
                      if (infoCopy && @"gl-option-use-secure-control-message")
                      {
                        v251 = CFDictionaryGetValue(infoCopy, @"gl-option-use-secure-control-message");
                      }

                      bOOLValue2 = [v251 BOOLValue];
                      if (!self->_useSecureControlMessage && ((bOOLValue2 ^ 1) & 1) == 0)
                      {
                        self->_useSecureControlMessage = bOOLValue2;
                        v253 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v253, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v253, OS_LOG_TYPE_DEFAULT, "enable secure control message for Receiver.", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"enable secure control message for Receiver.");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"enable secure control message for Receiver.");
                            }
                          }
                        }
                      }
                    }

                    if (self->_allocbindStartTime == 0.0)
                    {
                      self->_allocbindStartTime = v59;
                      if (self->_isInitiator)
                      {
                        v254 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v254, OS_LOG_TYPE_DEFAULT))
                        {
                          inviteSentTime = self->_inviteSentTime;
                          allocbindStartTime = self->_allocbindStartTime;
                          *v378 = 134218240;
                          *&v378[4] = inviteSentTime;
                          *&v378[12] = 2048;
                          *&v378[14] = allocbindStartTime;
                          _os_log_impl(&dword_1A7AD9000, v254, OS_LOG_TYPE_DEFAULT, "invite sent: %.6f, allocbind start: %.6f.", v378, 0x16u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            v309 = self->_inviteSentTime;
                            v314 = self->_allocbindStartTime;
                            _IDSLogTransport(@"GL", @"IDS", @"invite sent: %.6f, allocbind start: %.6f.");
                            if (_IDSShouldLog())
                            {
                              v309 = self->_inviteSentTime;
                              v314 = self->_allocbindStartTime;
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"invite sent: %.6f, allocbind start: %.6f.");
                            }
                          }
                        }
                      }

                      else
                      {
                        if (self->_isUPlusOneSession)
                        {
                          self->_calleeAcceptTime = ids_monotonic_time();
                          v59 = self->_allocbindStartTime;
                        }

                        v257 = ntpTime32(v59);
                        self->_acceptDelayU32 = v257 - ntpTime32(self->_inviteRecvTime);
                        v258 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v258, OS_LOG_TYPE_DEFAULT))
                        {
                          inviteRecvTime = self->_inviteRecvTime;
                          v260 = self->_allocbindStartTime;
                          acceptDelayU32 = self->_acceptDelayU32;
                          *v378 = 134218752;
                          *&v378[4] = inviteRecvTime;
                          *&v378[12] = 2048;
                          *&v378[14] = v260;
                          *&v378[22] = 1024;
                          *&v378[24] = acceptDelayU32;
                          *&v378[28] = 2048;
                          *&v378[30] = v260 - inviteRecvTime;
                          _os_log_impl(&dword_1A7AD9000, v258, OS_LOG_TYPE_DEFAULT, "invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f", v378, 0x26u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            v318 = self->_allocbindStartTime - self->_inviteRecvTime;
                            v316 = self->_acceptDelayU32;
                            v309 = self->_inviteRecvTime;
                            v314 = self->_allocbindStartTime;
                            _IDSLogTransport(@"GL", @"IDS", @"invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
                            if (_IDSShouldLog())
                            {
                              v318 = self->_allocbindStartTime - self->_inviteRecvTime;
                              v316 = self->_acceptDelayU32;
                              v309 = self->_inviteRecvTime;
                              v314 = self->_allocbindStartTime;
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"invite recv: %.6f, allocbind start: %.6f, accept delay: %08x/%.6f");
                            }
                          }
                        }
                      }
                    }

                    v262 = self->_metricsCollector;
                    name4 = [addressCopy name];
                    [(IDSGFTMetricsCollector *)v262 willSendAllocbindRequestThroughInterface:name4];

                    v264 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v264, OS_LOG_TYPE_DEFAULT))
                    {
                      if (self->_isInitiator)
                      {
                        v265 = "Initiator";
                      }

                      else
                      {
                        v265 = "Receiver";
                      }

                      v266 = (&_IDSStunTransportStrings)[v325];
                      v267 = self->_idsSessionID;
                      relaySessionID = [(IDSQuickRelaySessionInfo *)v25 relaySessionID];
                      v269 = relaySessionID;
                      *v378 = 136316162;
                      v270 = @"NO";
                      *&v378[4] = v265;
                      *&v378[12] = 2080;
                      if (v311)
                      {
                        v270 = @"YES";
                      }

                      *&v378[14] = v266;
                      *&v378[22] = 2112;
                      *&v378[24] = v267;
                      *&v378[32] = 2112;
                      *&v378[34] = relaySessionID;
                      *&v378[42] = 2112;
                      *&v378[44] = v270;
                      _os_log_impl(&dword_1A7AD9000, v264, OS_LOG_TYPE_DEFAULT, "*** Connect as %s, actualSelectedTransport: %s, IDSSessionID: %@, QRSessionID: %@, Accepted: %@.", v378, 0x34u);
                    }

                    self->_hasPendingAllocation = 0;
                    if (self->_state <= 1)
                    {
                      v271 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v271, OS_LOG_TYPE_DEFAULT))
                      {
                        v272 = _IDSLinkStateStrings[self->_state];
                        *v378 = 138412802;
                        *&v378[4] = self;
                        *&v378[12] = 2080;
                        *&v378[14] = v272;
                        *&v378[22] = 2080;
                        *&v378[24] = off_1EB2B3E60[0];
                        _os_log_impl(&dword_1A7AD9000, v271, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", v378, 0x20u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          v315 = _IDSLinkStateStrings[self->_state];
                          v317 = off_1EB2B3E60[0];
                          selfCopy2 = self;
                          _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
                          if (_IDSShouldLog())
                          {
                            v315 = _IDSLinkStateStrings[self->_state];
                            v317 = off_1EB2B3E60[0];
                            selfCopy2 = self;
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
                          }
                        }
                      }

                      self->_state = 2;
                    }

                    v273 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v273, OS_LOG_TYPE_DEFAULT))
                    {
                      v274 = [relaySessionToken length];
                      v275 = [relaySessionKey length];
                      *v378 = 138413058;
                      *&v378[4] = v335;
                      *&v378[12] = 2048;
                      *&v378[14] = v274;
                      *&v378[22] = 2048;
                      *&v378[24] = v275;
                      *&v378[32] = 2048;
                      *&v378[34] = participantID;
                      _os_log_impl(&dword_1A7AD9000, v273, OS_LOG_TYPE_DEFAULT, "start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu", v378, 0x2Au);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v276 = [relaySessionToken length];
                        v317 = [relaySessionKey length];
                        v319 = participantID;
                        selfCopy2 = v335;
                        v315 = v276;
                        _IDSLogTransport(@"GL", @"IDS", @"start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu");
                        if (_IDSShouldLog())
                        {
                          v277 = [relaySessionToken length];
                          v317 = [relaySessionKey length];
                          v319 = participantID;
                          selfCopy2 = v335;
                          v315 = v277;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind for %@ (token %lu bytes, key %lu bytes), participantID:%llu");
                        }
                      }
                    }

                    if (aBlock)
                    {
                      v278 = _Block_copy(aBlock);
                      v279 = self->_connectReadyHandler;
                      self->_connectReadyHandler = v278;
                    }

                    if (self->_QUICForQREnabled)
                    {
                      if (v325 == 2)
                      {
                        v280 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v280, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v280, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using QUIC", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using QUIC");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using QUIC");
                            }
                          }
                        }

                        candidatePairToken = [v227 candidatePairToken];
                        -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", candidatePairToken, 0, 0, 1, [v227 pendingNoSessionStateAllocbind]);

                        goto LABEL_473;
                      }

                      if (self->_H2FallbackEnabled && v325 == 4)
                      {
                        v284 = OSLogHandleForTransportCategory();
                        if (os_log_type_enabled(v284, OS_LOG_TYPE_DEFAULT))
                        {
                          *v378 = 0;
                          _os_log_impl(&dword_1A7AD9000, v284, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using H2", v378, 2u);
                        }

                        if (os_log_shim_legacy_logging_enabled())
                        {
                          if (_IDSShouldLogTransport())
                          {
                            _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using H2");
                            if (_IDSShouldLog())
                            {
                              _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using H2");
                            }
                          }
                        }

                        v352[0] = MEMORY[0x1E69E9820];
                        v352[1] = 3221225472;
                        v352[2] = sub_1A7B7CCCC;
                        v352[3] = &unk_1E77E0C88;
                        v352[4] = self;
                        v353 = v227;
                        [(IDSGlobalLink *)self _connectNWTCPLink:v353 disconnectAfterUse:0 connectedHandler:v352];

LABEL_473:
                        [(IDSGlobalLink *)self _reportAWDAllocateTime];
                        if (allocateType2 == 3)
                        {
                          [v227 updateURIToParticipantIDMapping:infoCopy];
                        }

                        *v374 = -1431655766;
                        if (self->_shouldFallbackToTCPFirst)
                        {
                          if (v371[0] != 3)
                          {
                            if (v371[0] == 2)
                            {
                              goto LABEL_496;
                            }

                            goto LABEL_481;
                          }
                        }

                        else
                        {
                          if (v371[0] == 4)
                          {
LABEL_496:
                            allValues4 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
                            GLUtilGetLinkInformation(key, 3, v374, 0, allValues4);

                            v286 = v371[0];
                            v287 = *v374 == 0;
                            v288 = 3;
LABEL_497:
                            if (v287)
                            {
                              v283 = v288;
                            }

                            else
                            {
                              v283 = v286;
                            }

                            goto LABEL_500;
                          }

                          if (v371[0] != 2)
                          {
LABEL_481:
                            v283 = 0;
LABEL_500:
                            if (!v322 && GLUtilHasVPNInterfaceForSelectedAddress(addressCopy, self->_interfaceAddressArray))
                            {
                              v87 = 1.0;
                            }

                            if (allocateType2 == 3 || v283 && v283 != v371[0])
                            {
                              v290 = +[IDSServerBag sharedInstance];
                              v291 = [v290 objectForKey:@"ids-tcp-fallback-disabled-for-two-way"];

                              if (allocateType2 == 1 && [v291 BOOLValue])
                              {
                                v292 = +[IDSFoundationLog GlobalLink];
                                if (os_log_type_enabled(v292, OS_LOG_TYPE_DEFAULT))
                                {
                                  v293 = (&_IDSStunTransportStrings)[v283];
                                  *v378 = 136315138;
                                  *&v378[4] = v293;
                                  _os_log_impl(&dword_1A7AD9000, v292, OS_LOG_TYPE_DEFAULT, "Two way allocation: don't fallback to %s due to server bag configurations", v378, 0xCu);
                                }
                              }

                              else
                              {
                                v294 = +[IDSFoundationLog GlobalLink];
                                if (os_log_type_enabled(v294, OS_LOG_TYPE_DEFAULT))
                                {
                                  v295 = (&_IDSStunTransportStrings)[v283];
                                  *v378 = 136315650;
                                  *&v378[4] = v295;
                                  *&v378[12] = 2112;
                                  *&v378[14] = key;
                                  *&v378[22] = 2048;
                                  *&v378[24] = v87;
                                  _os_log_impl(&dword_1A7AD9000, v294, OS_LOG_TYPE_DEFAULT, "scheduled [%s] for session %@ after %.2f second(s).", v378, 0x20u);
                                }

                                v343[0] = MEMORY[0x1E69E9820];
                                v343[1] = 3221225472;
                                v343[2] = sub_1A7B7CD3C;
                                v343[3] = &unk_1E77E0D00;
                                v344 = v227;
                                v345 = key;
                                selfCopy3 = self;
                                v349 = v283;
                                v347 = infoCopy;
                                v351 = sessionCopy;
                                v348 = aBlock;
                                preferenceCopy2 = preference;
                                IDSTransportThreadAddBlockAfter(v343, v87);

                                v292 = v344;
                              }
                            }

                            goto LABEL_515;
                          }
                        }

                        allValues5 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
                        GLUtilGetLinkInformation(key, 4, v374, 0, allValues5);

                        v286 = v371[0];
                        v287 = *v374 == 0;
                        v288 = 4;
                        goto LABEL_497;
                      }

                      v296 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v296, OS_LOG_TYPE_DEFAULT))
                      {
                        v297 = @"NO";
                        v298 = (&_IDSStunTransportStrings)[v325];
                        if (self->_H2FallbackEnabled)
                        {
                          v297 = @"YES";
                        }

                        *v378 = 138412546;
                        *&v378[4] = v297;
                        *&v378[12] = 2080;
                        *&v378[14] = v298;
                        _os_log_impl(&dword_1A7AD9000, v296, OS_LOG_TYPE_DEFAULT, "_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN", v378, 0x16u);
                      }

                      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                      {
                        v299 = self->_H2FallbackEnabled ? @"YES" : @"NO";
                        selfCopy2 = v299;
                        v315 = (&_IDSStunTransportStrings)[v325];
                        _IDSLogTransport(@"GL", @"IDS", @"_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN");
                        if (_IDSShouldLog())
                        {
                          if (self->_H2FallbackEnabled)
                          {
                            v300 = @"YES";
                          }

                          else
                          {
                            v300 = @"NO";
                          }

                          selfCopy2 = v300;
                          v315 = (&_IDSStunTransportStrings)[v325];
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"_H2FallbackEnabled: %@, actual transport: %s, _connectWithSessionInfo: using STUN");
                        }
                      }
                    }

                    else
                    {
                      v282 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v282, OS_LOG_TYPE_DEFAULT))
                      {
                        *v378 = 0;
                        _os_log_impl(&dword_1A7AD9000, v282, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: using STUN", v378, 2u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          _IDSLogTransport(@"GL", @"IDS", @"_connectWithSessionInfo: using STUN");
                          if (_IDSShouldLog())
                          {
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"_connectWithSessionInfo: using STUN");
                          }
                        }
                      }
                    }

                    [v227 setIsQUIC:{0, selfCopy2, v315, v317, v319}];
                    [(IDSGlobalLink *)self _sendAllocbindRequest:v335 stunMessage:0 isRealloc:0 inResponseToNoSessionState:0];
                    goto LABEL_473;
                  }

                  v236 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v236, OS_LOG_TYPE_DEFAULT))
                  {
                    groupID3 = [(IDSQuickRelaySessionInfo *)v25 groupID];
                    *v378 = 138412546;
                    *&v378[4] = groupID3;
                    *&v378[12] = 2112;
                    *&v378[14] = key;
                    _os_log_impl(&dword_1A7AD9000, v236, OS_LOG_TYPE_DEFAULT, "send info request for active participants for group %@, session %@.", v378, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      groupID4 = [(IDSQuickRelaySessionInfo *)v25 groupID];
                      _IDSLogTransport(@"GL", @"IDS", @"send info request for active participants for group %@, session %@.");

                      if (_IDSShouldLog())
                      {
                        v308 = [(IDSQuickRelaySessionInfo *)v25 groupID:groupID4];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"send info request for active participants for group %@, session %@.");
                      }
                    }
                  }

                  if (self->_QUICForQREnabled)
                  {
                    if (v371[0] == 2)
                    {
                      v359 = MEMORY[0x1E69E9820];
                      v360 = 3221225472;
                      v361 = sub_1A7B7CCBC;
                      v362 = &unk_1E77E0818;
                      v363 = v227;
                      v227 = v363;
                      [IDSGlobalLink _connectNWLink:"_connectNWLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];

LABEL_515:
                      v226 = v227;
                      goto LABEL_516;
                    }

                    if (self->_H2FallbackEnabled)
                    {
                      v354 = MEMORY[0x1E69E9820];
                      v355 = 3221225472;
                      v356 = sub_1A7B7CCC4;
                      v357 = &unk_1E77E0818;
                      v358 = v227;
                      v227 = v358;
                      [IDSGlobalLink _connectNWTCPLink:"_connectNWTCPLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];

                      goto LABEL_515;
                    }
                  }

                  [v227 setIsQUIC:0];
                  [v227 sendInfoRequest:0];
                  goto LABEL_515;
                }

LABEL_364:
                v226 = v203;
                goto LABEL_365;
              }
            }
          }

          if (self->_isSessionAcceptedWithNoCandidatePair)
          {
            v209 = self->_isInitiator;
            v210 = addressCopy;
            if (self->_acceptedRelaySessionID && self->_isInitiator)
            {
              self->_isSessionAcceptedWithNoCandidatePair = 0;
              v311 = 1;
              GLUtilCreateRelayCandidatePair(v25, infoCopy, addressCopy, v323, 1u, 1, self->_enableSKE, v371[0], self);
              v211 = LABEL_343:;
              v212 = v211;
              if (!v198)
              {
                local6 = [v211 local];
                [local6 setPrefix:FirstPrefix];

                [v212 synthesizeNat64WithPrefix];
                [v212 setIsNAT64:1];
                candidatePairToken2 = [v212 candidatePairToken];

                v335 = candidatePairToken2;
              }

              v215 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v215, OS_LOG_TYPE_DEFAULT))
              {
                candidatePairToken3 = [v212 candidatePairToken];
                v217 = candidatePairToken3;
                v218 = @"NO";
                if (v311)
                {
                  v218 = @"YES";
                }

                *v378 = 138412546;
                *&v378[4] = candidatePairToken3;
                *&v378[12] = 2112;
                *&v378[14] = v218;
                _os_log_impl(&dword_1A7AD9000, v215, OS_LOG_TYPE_DEFAULT, "create relay candidate pair, token: %@, isAcceptedRelaySession = %@", v378, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
              {
                candidatePairToken4 = [v212 candidatePairToken];
                v220 = v311 ? @"YES" : @"NO";
                candidatePairToken5 = candidatePairToken4;
                v313 = v220;
                _IDSLogTransport(@"GL", @"IDS", @"create relay candidate pair, token: %@, isAcceptedRelaySession = %@");

                if (_IDSShouldLog())
                {
                  candidatePairToken5 = [v212 candidatePairToken];
                  v313 = v220;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"create relay candidate pair, token: %@, isAcceptedRelaySession = %@");
                }
              }

              if (!self->_tokenToCandidatePairs)
              {
                v221 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                v222 = self->_tokenToCandidatePairs;
                self->_tokenToCandidatePairs = v221;
              }

              v223 = v212;
              if (v223)
              {
                v203 = v223;
                CFDictionarySetValue(self->_tokenToCandidatePairs, v335, v223);
              }

              else
              {
                v203 = 0;
                v224 = MEMORY[0x1E69E9C10];
                v225 = MEMORY[0x1E69E9C10];
                if (os_log_type_enabled(v224, OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E1498C();
                }
              }

              goto LABEL_364;
            }
          }

          else
          {
            v209 = self->_isInitiator;
            v210 = addressCopy;
          }

          GLUtilCreateRelayCandidatePair(v25, infoCopy, v210, v323, v311, v209, self->_enableSKE, v371[0], self);
          goto LABEL_343;
        }

        if (v325 == 4)
        {
          v320 = self->_tcpSSLLink;
          v181 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v181, OS_LOG_TYPE_DEFAULT))
          {
            tcpSSLLink = self->_tcpSSLLink;
            *v383 = 138412290;
            *&v383[4] = tcpSSLLink;
            v183 = "_connectWithSessionInfo: Use tcpSSLLink: %@";
            goto LABEL_308;
          }
        }

        else
        {
          if (v325 != 3)
          {
            v320 = 0;
            goto LABEL_311;
          }

          v320 = self->_tcpLink;
          v181 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v181, OS_LOG_TYPE_DEFAULT))
          {
            v182 = self->_tcpLink;
            *v383 = 138412290;
            *&v383[4] = v182;
            v183 = "_connectWithSessionInfo: Use tcpLink: %@";
LABEL_308:
            _os_log_impl(&dword_1A7AD9000, v181, OS_LOG_TYPE_DEFAULT, v183, v383, 0xCu);
          }
        }

LABEL_311:
        address7 = [addressCopy address];
        v191 = -[IDSTCPLink connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:](v320, "connect:localAddress:portRange:remoteAddress:clientUUID:completionHandler:", index, [address7 sa], LOWORD(self->_portRange), v323, self->_clientUUID, 0);

        if (!v191)
        {
LABEL_315:

          goto LABEL_316;
        }

        *&v192 = 0xAAAAAAAAAAAAAAAALL;
        *(&v192 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v386 = v192;
        v387 = v192;
        *&v384[32] = v192;
        v385 = v192;
        *v384 = v192;
        *&v384[16] = v192;
        *v383 = v192;
        *&v383[16] = v192;
        address8 = [addressCopy address];
        SAToIPPortString(v383, 0x80uLL, [address8 sa]);

        address9 = [addressCopy address];
        memcpy([address9 sa], v191, v191->sa_len);

        *&v195 = 0xAAAAAAAAAAAAAAAALL;
        *(&v195 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v381 = v195;
        v382 = v195;
        v379 = v195;
        v380 = v195;
        *&v378[32] = v195;
        *&v378[48] = v195;
        *v378 = v195;
        *&v378[16] = v195;
        address10 = [addressCopy address];
        SAToIPPortString(v378, 0x80uLL, [address10 sa]);

        v180 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v180, OS_LOG_TYPE_DEFAULT))
        {
          *v374 = 136315394;
          v375 = v383;
          v376 = 2080;
          v377 = v378;
          _os_log_impl(&dword_1A7AD9000, v180, OS_LOG_TYPE_DEFAULT, "_connectWithSessionInfo: TCP connection: change the local address from %s to: %s", v374, 0x16u);
        }

LABEL_314:

        goto LABEL_315;
      }

      if (self->_isInitiator)
      {
        intValue = 0;
      }

      else
      {
        v119 = [infoCopy objectForKey:@"qia"];
        intValue = [v119 intValue];

        v115 = v371[0];
      }

      preferCellularForCallSetup = self->_preferCellularForCallSetup;
      v121 = self->_interfaceAddressArray;
      allValues6 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      if (allocateType2 == 3)
      {
        v123 = key;
      }

      else
      {
        v123 = 0;
      }

      v124 = GLUtilSelectInterface(v115, preferCellularForCallSetup, v121, allValues6, v123, intValue, v330, preference);

      v117 = v124;
    }

    if (!v117)
    {
      if (self->_networkAddressChangeTimer)
      {
        v131 = 1;
      }

      else
      {
        v131 = sessionCopy;
      }

      v132 = +[IDSFoundationLog GlobalLink];
      v133 = os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT);
      if (v131)
      {
        if (v133)
        {
          v134 = @"NO";
          v135 = self->_networkAddressChangeTimer;
          if (sessionCopy)
          {
            v134 = @"YES";
          }

          *v383 = 134218242;
          *&v383[4] = v135;
          *&v383[12] = 2112;
          *&v383[14] = v134;
          _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "No local interface available; _networkAddressChangeTimer = %p, joinSession = %@", v383, 0x16u);
        }
      }

      else
      {
        if (v133)
        {
          *v383 = 0;
          _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "Found no local interface available for QR.", v383, 2u);
        }

        if (!v333)
        {
          sub_1A7B7CB88(aBlock, 6, @"No local interface available");
          if (self->_clientType == 6)
          {
            v188 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v188, OS_LOG_TYPE_DEFAULT))
            {
              *v383 = 0;
              _os_log_impl(&dword_1A7AD9000, v188, OS_LOG_TYPE_DEFAULT, "Found no local interface available for QR. - gathering ABC with packet capture", v383, 2u);
            }

            [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"NoLocalNetwork" duration:15];
          }
        }
      }

      addressCopy = 0;
      goto LABEL_517;
    }

    goto LABEL_195;
  }

  v22 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    *&buf[4] = self;
    *&buf[12] = 2112;
    *&buf[14] = v19;
    *&buf[22] = 2080;
    *&buf[24] = v23;
    _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "%@%@ is in [%s] state, skip connecting to QR.", buf, 0x20u);
  }

LABEL_13:

LABEL_521:
}

- (void)_selectStunTransport:(int64_t *)transport andInterfaceAddress:(id *)address forRelaySessionID:(id)d preferIPv4:(BOOL)pv4 wantOnlyCell:(BOOL)cell wantOnlyNonCell:(BOOL)nonCell isValidSA:(BOOL)a
{
  nonCellCopy = nonCell;
  cellCopy = cell;
  pv4Copy = pv4;
  v197 = *MEMORY[0x1E69E9840];
  dCopy = d;
  allocationsToTransportScoreCards = self->_allocationsToTransportScoreCards;
  if (!allocationsToTransportScoreCards)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v15 = self->_allocationsToTransportScoreCards;
    self->_allocationsToTransportScoreCards = Mutable;

    allocationsToTransportScoreCards = self->_allocationsToTransportScoreCards;
  }

  v16 = [(NSDictionary *)allocationsToTransportScoreCards objectForKeyedSubscript:dCopy];
  if (!v16)
  {
    v16 = [objc_alloc(MEMORY[0x1E695DF70]) initWithArray:self->_transportScoreCards copyItems:1];
    if (v16)
    {
      CFDictionarySetValue(self->_allocationsToTransportScoreCards, dCopy, v16);
    }

    else
    {
      v17 = MEMORY[0x1E69E9C10];
      v18 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14A08();
      }
    }
  }

  v125 = nonCellCopy;
  v129 = pv4Copy;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v172 = 0u;
  v173 = 0u;
  v174 = 0u;
  obj = v175 = 0u;
  v19 = [obj countByEnumeratingWithState:&v172 objects:v196 count:16];
  if (v19)
  {
    v20 = v19;
    v21 = *v173;
    do
    {
      v22 = 0;
      do
      {
        if (*v173 != v21)
        {
          objc_enumerationMutation(obj);
        }

        v23 = *(*(&v172 + 1) + 8 * v22);
        if ([v23 isRelayStunCandidatePair])
        {
          sessionID = [v23 sessionID];
          if ([sessionID isEqualToString:dCopy])
          {
            isSelfQRSession = [v23 isSelfQRSession];

            if ((isSelfQRSession & 1) == 0)
            {
              state = [v23 state];
              if (state > 4 || (v29 = state, v30 = [v23 isDisconnecting], !v29) || v30)
              {
                if ([v16 count])
                {
                  v27 = 0;
                  do
                  {
                    v28 = [v16 objectAtIndexedSubscript:v27];
                    if ([(IDSGlobalLink *)self _isUsingSameRATCandidatePair:v23 transportScoreCard:v28])
                    {
                      v28[36] = 0;
                    }

                    ++v27;
                  }

                  while ([v16 count] > v27);
                }
              }
            }
          }

          else
          {
          }
        }

        ++v22;
      }

      while (v22 != v20);
      v31 = [obj countByEnumeratingWithState:&v172 objects:v196 count:16];
      v20 = v31;
    }

    while (v31);
  }

  v136 = dCopy;

  if (!a)
  {
    v170 = 0u;
    v171 = 0u;
    v168 = 0u;
    v169 = 0u;
    v126 = v16;
    v133 = [v126 countByEnumeratingWithState:&v168 objects:v195 count:16];
    if (v133)
    {
      v130 = *v169;
      do
      {
        for (i = 0; i != v133; i = i + 1)
        {
          if (*v169 != v130)
          {
            objc_enumerationMutation(v126);
          }

          v33 = *(*(&v168 + 1) + 8 * i);
          v164 = 0u;
          v165 = 0u;
          v166 = 0u;
          v167 = 0u;
          v34 = self->_interfaceAddressArray;
          v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v164 objects:v194 count:16];
          if (v35)
          {
            v36 = v35;
            v37 = *v165;
            do
            {
              for (j = 0; j != v36; ++j)
              {
                if (*v165 != v37)
                {
                  objc_enumerationMutation(v34);
                }

                v39 = *(*(&v164 + 1) + 8 * j);
                if ([v39 index] == *(v33 + 32))
                {
                  v40 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v39 index]);
                  iPVersion = [v39 IPVersion];
                  if (*(v33 + 37) == 1 && iPVersion == 1 && v40 != *(v33 + 24) < 4)
                  {
                    *(v33 + 36) = (GLUGetExtendedFlagsForInterface(v39) & 0x1000) == 0;
                  }
                }
              }

              v36 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v164 objects:v194 count:16];
            }

            while (v36);
          }
        }

        v133 = [v126 countByEnumeratingWithState:&v168 objects:v195 count:16];
      }

      while (v133);
    }
  }

  v162 = 0u;
  v163 = 0u;
  v160 = 0u;
  v161 = 0u;
  v134 = obj;
  v42 = [v134 countByEnumeratingWithState:&v160 objects:v193 count:16];
  if (v42)
  {
    v43 = v42;
    obja = *v161;
    do
    {
      for (k = 0; k != v43; ++k)
      {
        if (*v161 != obja)
        {
          objc_enumerationMutation(v134);
        }

        v45 = *(*(&v160 + 1) + 8 * k);
        if ([v45 isRelayStunCandidatePair])
        {
          sessionID2 = [v45 sessionID];
          if ([sessionID2 isEqualToString:v136])
          {
            isSelfQRSession2 = [v45 isSelfQRSession];

            if ((isSelfQRSession2 & 1) == 0 && ([v45 state] - 1) <= 1)
            {
              local = [v45 local];
              index = [local index];

              v127 = [(IDSGlobalLink *)self _isInterfaceDelegatedWithInterfaceIndex:index];
              local2 = [v45 local];
              v51 = *([local2 address] + 1);

              if ([v16 count])
              {
                v52 = 0;
                v131 = v51 == 30;
                do
                {
                  v53 = [v16 objectAtIndexedSubscript:v52];
                  v54 = v53;
                  if (*(v53 + 32) == index)
                  {
                    v55 = *(v53 + 16);
                    local3 = [v45 local];
                    if (v55 == [local3 transport] && *(v54 + 37) == v131)
                    {
                      v57 = *(v54 + 24) < 4;

                      if (v127 != v57)
                      {
                        *(v54 + 36) = 1;
                      }
                    }

                    else
                    {
                    }
                  }

                  ++v52;
                }

                while ([v16 count] > v52);
              }
            }
          }

          else
          {
          }
        }
      }

      v43 = [v134 countByEnumeratingWithState:&v160 objects:v193 count:16];
    }

    while (v43);
  }

  v158 = 0u;
  v159 = 0u;
  v156 = 0u;
  v157 = 0u;
  v135 = v134;
  v58 = [v135 countByEnumeratingWithState:&v156 objects:v192 count:16];
  v59 = v129;
  if (v58)
  {
    v60 = v58;
    v61 = *v157;
    do
    {
      for (m = 0; m != v60; ++m)
      {
        if (*v157 != v61)
        {
          objc_enumerationMutation(v135);
        }

        v63 = *(*(&v156 + 1) + 8 * m);
        if ([v63 isRelayStunCandidatePair] && (objc_msgSend(v63, "isDisconnecting") & 1) == 0)
        {
          sessionID3 = [v63 sessionID];
          if ([sessionID3 isEqualToString:v136])
          {
            isSelfQRSession3 = [v63 isSelfQRSession];

            if ((isSelfQRSession3 & 1) == 0 && ([v63 state] - 3) <= 1 && objc_msgSend(v16, "count"))
            {
              v66 = 0;
              do
              {
                v67 = [v16 objectAtIndexedSubscript:v66];
                if ([(IDSGlobalLink *)self _isUsingSameRATCandidatePair:v63 transportScoreCard:v67])
                {
                  v67[36] = 1;
                }

                ++v66;
              }

              while ([v16 count] > v66);
            }
          }

          else
          {
          }
        }
      }

      v60 = [v135 countByEnumeratingWithState:&v156 objects:v192 count:16];
    }

    while (v60);
  }

  v68 = v125;
  v69 = cellCopy;
  if (self->_cellInterfaceName)
  {
    v154 = 0u;
    v155 = 0u;
    v152 = 0u;
    v153 = 0u;
    v70 = v135;
    v71 = [v70 countByEnumeratingWithState:&v152 objects:v191 count:16];
    if (v71)
    {
      v72 = v71;
      v73 = *v153;
      do
      {
        for (n = 0; n != v72; ++n)
        {
          if (*v153 != v73)
          {
            objc_enumerationMutation(v70);
          }

          v75 = *(*(&v152 + 1) + 8 * n);
          if ([v75 isRelayStunCandidatePair])
          {
            sessionID4 = [v75 sessionID];
            if ([sessionID4 isEqualToString:v136])
            {
              isSelfQRSession4 = [v75 isSelfQRSession];

              if (isSelfQRSession4)
              {
                continue;
              }

              local4 = [v75 local];
              sessionID4 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [local4 index]);

              local5 = [v75 local];
              if ([local5 isCellularStunCandidate])
              {
                v80 = [sessionID4 isEqualToIgnoringCase:self->_cellInterfaceName];

                if (v80)
                {

                  v59 = v129;
                  v68 = v125;
                  v69 = cellCopy;
                  goto LABEL_119;
                }
              }

              else
              {
              }
            }
          }
        }

        v72 = [v70 countByEnumeratingWithState:&v152 objects:v191 count:16];
      }

      while (v72);
    }

    v59 = v129;
    v68 = v125;
    v69 = cellCopy;
    if ([v16 count])
    {
      v81 = 0;
      do
      {
        v82 = [v16 objectAtIndexedSubscript:v81];
        v83 = *(v82 + 24);
        if (v83 == 6 || v83 == 3)
        {
          *(v82 + 36) = 0;
        }

        ++v81;
      }

      while ([v16 count] > v81);
    }
  }

LABEL_119:
  v150 = 0u;
  v151 = 0u;
  v148 = 0u;
  v149 = 0u;
  v85 = v16;
  v86 = [v85 countByEnumeratingWithState:&v148 objects:v190 count:16];
  if (v86)
  {
    v87 = v86;
    v124 = 0;
    v88 = 0;
    v89 = *v149;
    do
    {
      for (ii = 0; ii != v87; ++ii)
      {
        if (*v149 != v89)
        {
          objc_enumerationMutation(v85);
        }

        v91 = *(*(&v148 + 1) + 8 * ii);
        if (v69)
        {
          v92 = *(v91 + 24);
          if (v92 != 6 && v92 != 3)
          {
            continue;
          }
        }

        if (v68)
        {
          v94 = *(v91 + 24);
          if (v94 == 3 || v94 == 6)
          {
            continue;
          }
        }

        if ((*(v91 + 36) & 1) == 0)
        {
          v96 = *(v91 + 8);
          if (v59)
          {
            if (*(v91 + 37) == 1)
            {
              v96 >>= 2;
            }

            else
            {
              v96 *= 4;
            }
          }

          if (v96 > v88)
          {
            v97 = v91;

            v124 = v97;
            v88 = v96;
          }
        }
      }

      v87 = [v85 countByEnumeratingWithState:&v148 objects:v190 count:16];
    }

    while (v87);
  }

  else
  {
    v124 = 0;
  }

  v98 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v98, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v98, OS_LOG_TYPE_DEFAULT, "\t========== TransportScoreCards ==========", buf, 2u);
  }

  v146 = 0u;
  v147 = 0u;
  v144 = 0u;
  v145 = 0u;
  v132 = v85;
  v99 = [v132 countByEnumeratingWithState:&v144 objects:v189 count:16];
  if (v99)
  {
    v100 = v99;
    v101 = *v145;
    v128 = *v145;
    do
    {
      for (jj = 0; jj != v100; ++jj)
      {
        if (*v145 != v101)
        {
          objc_enumerationMutation(v132);
        }

        v103 = *(*(&v144 + 1) + 8 * jj);
        v104 = *(v103 + 8);
        if (v59)
        {
          if (*(v103 + 37) == 1)
          {
            v104 >>= 2;
          }

          else
          {
            v104 *= 4;
          }
        }

        v105 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
        {
          v106 = v100;
          if (*(v103 + 37))
          {
            v107 = @"YES";
          }

          else
          {
            v107 = @"NO";
          }

          objb = *(v103 + 32);
          v108 = (&_IDSStunTransportStrings)[*(v103 + 16)];
          v109 = [(IDSGlobalLink *)self _transportInterfaceToString:*(v103 + 24)];
          v110 = v109;
          v111 = @"NO";
          if (*(v103 + 36))
          {
            v111 = @"YES";
          }

          *buf = 138413570;
          v178 = v107;
          v100 = v106;
          v179 = 1024;
          v180 = objb;
          v59 = v129;
          v181 = 2080;
          v182 = v108;
          v183 = 2112;
          v184 = v109;
          v185 = 2112;
          v186 = v111;
          v187 = 2048;
          v188 = v104;
          _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "IPV6 = %@, interfaceIndex = %u, stunTransport = %s, transportInterface = %@, alreadySelected = %@, score = %llu", buf, 0x3Au);

          v101 = v128;
        }
      }

      v100 = [v132 countByEnumeratingWithState:&v144 objects:v189 count:16];
    }

    while (v100);
  }

  v112 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v112, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v112, OS_LOG_TYPE_DEFAULT, "\t==========================================", buf, 2u);
  }

  if (v124)
  {
    *transport = v124[2];
    v140 = 0u;
    v141 = 0u;
    v142 = 0u;
    v143 = 0u;
    v113 = self->_interfaceAddressArray;
    v114 = [(NSMutableArray *)v113 countByEnumeratingWithState:&v140 objects:v176 count:16];
    if (v114)
    {
      v115 = v114;
      v116 = *v141;
      while (2)
      {
        for (kk = 0; kk != v115; ++kk)
        {
          if (*v141 != v116)
          {
            objc_enumerationMutation(v113);
          }

          v118 = *(*(&v140 + 1) + 8 * kk);
          if ([v118 index] == *(v124 + 8))
          {
            v119 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v118 index]);
            if (*(v124 + 37) == ([v118 IPVersion] == 1) && v119 != v124[3] < 4)
            {
              v120 = v118;
              *address = v118;
              goto LABEL_181;
            }
          }
        }

        v115 = [(NSMutableArray *)v113 countByEnumeratingWithState:&v140 objects:v176 count:16];
        if (v115)
        {
          continue;
        }

        break;
      }
    }

LABEL_181:
  }
}

- (void)disconnectWithCompletionHandler:(id)handler isReinitiating:(BOOL)reinitiating
{
  reinitiatingCopy = reinitiating;
  v76 = *MEMORY[0x1E69E9840];
  handlerCopy = handler;
  v7 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    idsSessionID = self->_idsSessionID;
    *buf = 138412546;
    selfCopy2 = self;
    v69 = 2112;
    v70 = idsSessionID;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "Disconnecting IDSGlobalLink %@ with IDSSessionID: %@", buf, 0x16u);
  }

  if (self->_useLinkEngine)
  {
    remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
    self->_remoteAcceptedDevicePushTokens = 0;

    v65 = 0u;
    v66 = 0u;
    v63 = 0u;
    v64 = 0u;
    v10 = self->_sessionsByID;
    v11 = [(NSMutableDictionary *)v10 countByEnumeratingWithState:&v63 objects:v75 count:16];
    if (v11)
    {
      v12 = *v64;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v64 != v12)
          {
            objc_enumerationMutation(v10);
          }

          v14 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v63 + 1) + 8 * i)];
          [v14 reset];
        }

        v11 = [(NSMutableDictionary *)v10 countByEnumeratingWithState:&v63 objects:v75 count:16];
      }

      while (v11);
    }

    allLinkEngines = [(IDSGlobalLink *)self allLinkEngines];
    v61 = 0u;
    v62 = 0u;
    v59 = 0u;
    v60 = 0u;
    v16 = [allLinkEngines countByEnumeratingWithState:&v59 objects:v74 count:16];
    if (v16)
    {
      v17 = *v60;
      do
      {
        for (j = 0; j != v16; ++j)
        {
          if (*v60 != v17)
          {
            objc_enumerationMutation(allLinkEngines);
          }

          [*(*(&v59 + 1) + 8 * j) setAllowOngoingTasks:0];
        }

        v16 = [allLinkEngines countByEnumeratingWithState:&v59 objects:v74 count:16];
      }

      while (v16);
    }

    [(IDSGlobalLink *)self _updateAllLinks];
  }

  state = self->_state;
  if (state > 3)
  {
    if (state == 4)
    {
      v28 = _Block_copy(handlerCopy);
      disconnectCompletionHandler = self->_disconnectCompletionHandler;
      self->_disconnectCompletionHandler = v28;

      [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
      if (self->_state != 5)
      {
        v30 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
        {
          v31 = _IDSLinkStateStrings[self->_state];
          *buf = 138412802;
          selfCopy2 = self;
          v69 = 2080;
          v70 = v31;
          v71 = 2080;
          v72 = off_1EB2B3E78[0];
          _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v49 = _IDSLinkStateStrings[self->_state];
            v50 = off_1EB2B3E78[0];
            selfCopy4 = self;
            _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
            if (_IDSShouldLog())
            {
              v49 = _IDSLinkStateStrings[self->_state];
              v50 = off_1EB2B3E78[0];
              selfCopy4 = self;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
            }
          }
        }

        self->_state = 5;
      }

      [(IDSGlobalLink *)self _removePacketNotificationFilter:selfCopy4];
    }

    else
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        v33 = _IDSLinkStateStrings[self->_state];
        *buf = 136315138;
        selfCopy2 = v33;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "session is already disconnecting, state[%s].", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"session is already disconnecting, state[%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"session is already disconnecting, state[%s].");
          }
        }
      }

      if (handlerCopy)
      {
        v34 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B7E5A4;
        block[3] = &unk_1E77E0B48;
        v52 = handlerCopy;
        v35 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, block);
        dispatch_async(v34, v35);
      }
    }
  }

  else
  {
    v20 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v21 = self->_idsSessionID;
      v22 = _IDSLinkStateStrings[self->_state];
      *buf = 138412546;
      selfCopy2 = v21;
      v69 = 2080;
      v70 = v22;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Session with IDSSessionID: %@ is not connected, state [%s].", buf, 0x16u);
    }

    self->_state = 6;
    if (self->_allocbindEndTime > 0.0)
    {
      v57 = 0u;
      v58 = 0u;
      v55 = 0u;
      v56 = 0u;
      allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v24 = [allValues countByEnumeratingWithState:&v55 objects:v73 count:16];
      if (v24)
      {
        v25 = *v56;
        while (2)
        {
          for (k = 0; k != v24; ++k)
          {
            if (*v56 != v25)
            {
              objc_enumerationMutation(allValues);
            }

            v27 = *(*(&v55 + 1) + 8 * k);
            if ([v27 state] == 3)
            {
              local = [v27 local];
              v37 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
              {
                v38 = (&_IDSStunTransportStrings)[[local transport]];
                *buf = 136315394;
                selfCopy2 = v38;
                v69 = 1024;
                LODWORD(v70) = 21;
                _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  selfCopy4 = (&_IDSStunTransportStrings)[[local transport]];
                  v49 = 21;
                  _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
                  if (_IDSShouldLog())
                  {
                    selfCopy4 = (&_IDSStunTransportStrings)[[local transport]];
                    v49 = 21;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
                  }
                }
              }

              GLUtilReportAWDClientTimerEvent(305, 21, v27, self->_enableSKE, self->_isInitiator, 0.0);
              v39 = GLUCreateQRClientTimeEvent(305, 21, v27, self->_timeBase, 0.0);
              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              v41 = objc_opt_respondsToSelector();

              if (v41)
              {
                v42 = objc_loadWeakRetained(&self->_delegate);
                [v42 link:self didAddQREvent:v39];
              }

              goto LABEL_59;
            }
          }

          v24 = [allValues countByEnumeratingWithState:&v55 objects:v73 count:16];
          if (v24)
          {
            continue;
          }

          break;
        }
      }

LABEL_59:
    }

    [(IDSGlobalLink *)self _discardCandidatePairsWithOption:1 isReinitiating:reinitiatingCopy, selfCopy4, v49];
    if (handlerCopy)
    {
      v43 = im_primary_queue();
      v53[0] = MEMORY[0x1E69E9820];
      v53[1] = 3221225472;
      v53[2] = sub_1A7B7E590;
      v53[3] = &unk_1E77E0B48;
      v54 = handlerCopy;
      v44 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, 0, v53);
      dispatch_async(v43, v44);
    }

    else
    {
      v45 = objc_loadWeakRetained(&self->_delegate);
      v46 = objc_opt_respondsToSelector();

      if (v46)
      {
        v47 = objc_loadWeakRetained(&self->_delegate);
        [v47 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
      }
    }
  }
}

- (void)setClientUniquePID:(unint64_t)d
{
  v8 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = 134217984;
    dCopy = d;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Got client unique PID %llu", &v6, 0xCu);
  }

  self->_clientUniquePID = d;
}

- (void)requestChildConnectionIDForLinkID:(char)d relayGroupID:(id)iD
{
  dCopy = d;
  v52 = *MEMORY[0x1E69E9840];
  iDCopy = iD;
  if (self->_QUICForQREnabled && !self->_disableDirectDatapath)
  {
    v7 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v49) = dCopy;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "requestChildConnectionIDForLinkID called for linkID %d", buf, 8u);
    }

    v8 = GLUtilGetCandidatePairByLinkID(dCopy, self->_sendInfoList, self->_candidatePairs, self->_maxLinkID, self->_channelToCandidatePairs);
    if ([v8 isVirtualRelayStunCandidatePair])
    {
      v9 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        LODWORD(v49) = dCopy;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "requestChildConnectionIDForLinkID linkID %d is for a virtual link", buf, 8u);
      }
    }

    else
    {
      HIDWORD(v37) = dCopy;
      v47 = iDCopy;
      if ([v8 isRelayStunCandidatePair])
      {
        v10 = 5;
      }

      else
      {
        v10 = 0;
      }

      nwLink = self->_nwLink;
      v45 = v10;
      local = [v8 local];
      address = [local address];
      remote = [v8 remote];
      external = [remote external];
      clientUniquePID = self->_clientUniquePID;
      sessionID = [v8 sessionID];
      isRelayStunCandidatePair = [v8 isRelayStunCandidatePair];
      kindSuffix = [v8 kindSuffix];
      local2 = [v8 local];
      LOBYTE(v37) = [local2 isCellularStunCandidate];
      v9 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:address remoteAddress:external clientUniquePID:clientUniquePID sessionID:sessionID type:v45 isRelay:isRelayStunCandidatePair protocolStackSuffix:kindSuffix isCellular:v37];

      if ([v8 isRelayStunCandidatePair])
      {
        _shouldUseQRTLE = [(IDSGlobalLink *)self _shouldUseQRTLE];
        v41 = self->_nwLink;
        local3 = [v8 local];
        address2 = [local3 address];
        remote2 = [v8 remote];
        external2 = [remote2 external];
        v22 = self->_clientUniquePID;
        sessionID2 = [v8 sessionID];
        kindSuffix2 = [v8 kindSuffix];
        local4 = [v8 local];
        LOBYTE(v38) = [local4 isCellularStunCandidate];
        [(IDSNWLink *)v41 connectionInfoForLocalAddress:address2 remoteAddress:external2 clientUniquePID:v22 sessionID:sessionID2 type:7 isRelay:1 protocolStackSuffix:kindSuffix2 isCellular:v38];
      }

      else
      {
        _shouldUseQRTLE = [(IDSGlobalLink *)self _shouldUseP2PTLE];
        v42 = self->_nwLink;
        local3 = [v8 local];
        address3 = [local3 address];
        remote2 = [v8 remote];
        external3 = [remote2 external];
        v28 = self->_clientUniquePID;
        sessionID2 = [v8 sessionID];
        kindSuffix2 = [v8 kindSuffix];
        local4 = [v8 local];
        LOBYTE(v38) = [local4 isCellularStunCandidate];
        [(IDSNWLink *)v42 connectionInfoForLocalAddress:address3 remoteAddress:external3 clientUniquePID:v28 sessionID:sessionID2 type:9 isRelay:0 protocolStackSuffix:kindSuffix2 isCellular:v38];
      }
      v29 = ;

      dictionary = [MEMORY[0x1E695DF90] dictionary];
      if (v9)
      {
        v31 = GLUtilConnectionDictionaryForNWConnectionInfo(v9, 1);
        [dictionary setObject:v31 forKeyedSubscript:@"udp"];
      }

      if (v29)
      {
        v32 = GLUtilConnectionDictionaryForNWConnectionInfo(v29, _shouldUseQRTLE);
        [dictionary setObject:v32 forKeyedSubscript:@"qpod"];
      }

      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v34 = objc_opt_respondsToSelector();

      if (v34)
      {
        v35 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          v49 = dictionary;
          v50 = 1024;
          v51 = v39;
          _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "Send child connections %@ for linkID %d", buf, 0x12u);
        }

        v36 = objc_loadWeakRetained(&self->_delegate);
        [v36 link:self didReceiveChildConnections:dictionary forLinkID:v39];
      }

      iDCopy = v47;
    }
  }
}

- (void)_updateDefaultCandidatePair:(id)pair
{
  v47 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  selfCopy = self;
  v5 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  v37 = pairCopy;
  if (v5)
  {
    v6 = v5;
    if (*(v5 + 1))
    {
      [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      v40 = 0u;
      v41 = 0u;
      v38 = 0u;
      v7 = v39 = 0u;
      v8 = [v7 countByEnumeratingWithState:&v38 objects:v46 count:16];
      if (v8)
      {
        v9 = *v39;
        do
        {
          for (i = 0; i != v8; ++i)
          {
            if (*v39 != v9)
            {
              objc_enumerationMutation(v7);
            }

            v11 = *(*(&v38 + 1) + 8 * i);
            local = [v11 local];
            address = [local address];

            remote = [v11 remote];
            external = [remote external];

            channelNumber = [v11 channelNumber];
            if (IsSameSA(address, (v6 + 1)) && IsSameSA(external, (v6 + 17)) && *(v6 + 132) == channelNumber)
            {
              [v11 setIsActive:0];
              [v11 setLastOutgoingPacketTime:v6[38]];
              [v11 setLastIncomingPacketTime:v6[39]];
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v43 = v11;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "deactivate candidate pair %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v34 = v11;
                  _IDSLogTransport(@"GL", @"IDS", @"deactivate candidate pair %@.");
                  if (_IDSShouldLog())
                  {
                    v34 = v11;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"deactivate candidate pair %@.");
                  }
                }
              }
            }
          }

          v8 = [v7 countByEnumeratingWithState:&v38 objects:v46 count:16];
        }

        while (v8);
      }

      pairCopy = v37;
    }

    IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(selfCopy->_sendInfoList, pairCopy, 0);
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      linkID = [v37 linkID];
      *buf = 138412546;
      v43 = v37;
      v44 = 1024;
      v45 = linkID;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v34 = v37;
        linkID2 = [v37 linkID];
        _IDSLogTransport(@"GL", @"IDS", @"_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.");
        if (_IDSShouldLog())
        {
          linkID3 = [v37 linkID];
          v34 = v37;
          linkID2 = linkID3;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateDefaultCandidatePair: update default sendInfo with:%@, linkID:%d.");
        }
      }
    }

    [v37 setIsActive:{1, v34, linkID2}];
    if (([v37 isNominated] & 1) == 0)
    {
      [v37 setIsNominated:1];
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v43 = v37;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "set nominated flag for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"set nominated flag for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"set nominated flag for %@.");
          }
        }
      }
    }

    v22 = v37;
    if (selfCopy->_useLinkSelection)
    {
      linkEngine = [v37 linkEngine];
      v22 = v37;
      if (linkEngine)
      {
        linkEngine2 = [v37 linkEngine];
        idsPrimarySecondaryLinkSelector = [linkEngine2 idsPrimarySecondaryLinkSelector];
        v26 = idsPrimarySecondaryLinkSelector == 0;

        v22 = v37;
        if (!v26)
        {
          linkEngine3 = [v37 linkEngine];
          idsPrimarySecondaryLinkSelector2 = [linkEngine3 idsPrimarySecondaryLinkSelector];
          defaultLinkSelector = selfCopy->_defaultLinkSelector;
          selfCopy->_defaultLinkSelector = idsPrimarySecondaryLinkSelector2;

LABEL_43:
          v22 = v37;
        }
      }
    }
  }

  else
  {
    v30 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "_updateDefaultCandidatePair failed due to invalid list.", buf, 2u);
    }

    v31 = os_log_shim_legacy_logging_enabled();
    v22 = v37;
    if (v31)
    {
      v32 = _IDSShouldLogTransport();
      v22 = v37;
      if (v32)
      {
        _IDSLogTransport(@"GL", @"IDS", @"_updateDefaultCandidatePair failed due to invalid list.");
        v33 = _IDSShouldLog();
        v22 = v37;
        if (v33)
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_updateDefaultCandidatePair failed due to invalid list.");
          goto LABEL_43;
        }
      }
    }
  }
}

- (BOOL)_hasCandidatePairInState:(unint64_t)state anotherState:(unint64_t)anotherState relayCandidatePairsOnly:(BOOL)only excludeSelfAlloc:(BOOL)alloc
{
  allocCopy = alloc;
  onlyCopy = only;
  v32 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v10 = v26 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v24;
    while (2)
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v24 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v23 + 1) + 8 * i);
        if ((!allocCopy || [*(*(&v23 + 1) + 8 * i) allocateType] != 2) && (!onlyCopy || objc_msgSend(v15, "isRelayStunCandidatePair")))
        {
          state = [v15 state];
          if (state == state || state == anotherState)
          {
            v19 = state;
            v20 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              v21 = (&_IDSStunCandidatePairStateStrings)[v19];
              *buf = 136315394;
              v28 = v21;
              v29 = 2112;
              v30 = v15;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Found a CandidatePair in state: %s for %@", buf, 0x16u);
            }

            v18 = 1;
            goto LABEL_20;
          }
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v23 objects:v31 count:16];
      if (v12)
      {
        continue;
      }

      break;
    }
  }

  v18 = 0;
LABEL_20:

  return v18;
}

- (id)_getCandidatePairsWithSessionID:(id)d inState:(unint64_t)state
{
  v24 = *MEMORY[0x1E69E9840];
  dCopy = d;
  array = [MEMORY[0x1E695DF70] array];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v9 = [allValues countByEnumeratingWithState:&v19 objects:v23 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v20;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v20 != v11)
        {
          objc_enumerationMutation(allValues);
        }

        v13 = *(*(&v19 + 1) + 8 * i);
        state = [v13 state];
        if ([v13 isRelayStunCandidatePair])
        {
          v15 = state == state;
        }

        else
        {
          v15 = 0;
        }

        if (v15)
        {
          sessionID = [v13 sessionID];
          v17 = [sessionID isEqualToString:dCopy];

          if (v17)
          {
            [array addObject:v13];
          }
        }
      }

      v10 = [allValues countByEnumeratingWithState:&v19 objects:v23 count:16];
    }

    while (v10);
  }

  return array;
}

- (void)_discardCandidatePairsWithOption:(BOOL)option isReinitiating:(BOOL)reinitiating
{
  reinitiatingCopy = reinitiating;
  optionCopy = option;
  v35 = *MEMORY[0x1E69E9840];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = @"NO";
    if (optionCopy)
    {
      v10 = @"YES";
    }

    else
    {
      v10 = @"NO";
    }

    if (reinitiatingCopy)
    {
      v9 = @"YES";
    }

    *buf = 138412546;
    v32 = v10;
    v33 = 2112;
    v34 = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v11 = optionCopy ? @"YES" : @"NO";
    v12 = reinitiatingCopy ? @"YES" : @"NO";
    v24 = v11;
    v25 = v12;
    _IDSLogTransport(@"GL", @"IDS", @"_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).");
    if (_IDSShouldLog())
    {
      v24 = v11;
      v25 = v12;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_discardCandidatePairsWithOption (includeRelay:%@) (isReinitiating:%@).");
    }
  }

  v28 = 0u;
  v29 = 0u;
  v26 = 0u;
  v27 = 0u;
  v13 = allValues;
  v14 = [v13 countByEnumeratingWithState:&v26 objects:v30 count:16];
  if (v14)
  {
    v15 = *v27;
    if (reinitiatingCopy)
    {
      v16 = 12;
    }

    else
    {
      v16 = 11;
    }

    do
    {
      v17 = 0;
      do
      {
        if (*v27 != v15)
        {
          objc_enumerationMutation(v13);
        }

        v18 = *(*(&v26 + 1) + 8 * v17);
        v19 = [(__CFString *)v18 state:v24];
        if ([(__CFString *)v18 isRelayStunCandidatePair])
        {
          if (optionCopy && v19 <= 4)
          {
            v20 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v32 = v18;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "disconnect relay candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v24 = v18;
                _IDSLogTransport(@"GL", @"IDS", @"disconnect relay candidate pair %@.");
                if (_IDSShouldLog())
                {
                  v24 = v18;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect relay candidate pair %@.");
                }
              }
            }

            [(__CFString *)v18 stopSessionConnectedTimer];
            [(__CFString *)v18 stopSessionConvergenceTimer];
            isQUIC = [(__CFString *)v18 isQUIC];
            candidatePairToken = [(__CFString *)v18 candidatePairToken];
            if (isQUIC)
            {
              [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:candidatePairToken reason:v16];
            }

            else
            {
              [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken stunMessage:0 reason:v16];
            }
          }
        }

        else
        {
          [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v18 withReason:11];
        }

        ++v17;
      }

      while (v14 != v17);
      v23 = [v13 countByEnumeratingWithState:&v26 objects:v30 count:16];
      v14 = v23;
    }

    while (v23);
  }
}

- (void)_discardAllCandidatePairs:(BOOL)pairs
{
  pairsCopy = pairs;
  v22 = *MEMORY[0x1E69E9840];
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (pairsCopy)
    {
      v6 = @"YES";
    }

    *buf = 138412290;
    v21 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "discard all candidate pairs isReinitiating: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v7 = pairsCopy ? @"YES" : @"NO";
    v14 = v7;
    _IDSLogTransport(@"GL", @"IDS", @"discard all candidate pairs isReinitiating: %@");
    if (_IDSShouldLog())
    {
      v14 = v7;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"discard all candidate pairs isReinitiating: %@");
    }
  }

  if (self->_useLinkEngine)
  {
    remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
    self->_remoteAcceptedDevicePushTokens = 0;

    v17 = 0u;
    v18 = 0u;
    v15 = 0u;
    v16 = 0u;
    v9 = self->_sessionsByID;
    v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v15 objects:v19 count:16];
    if (v10)
    {
      v11 = *v16;
      do
      {
        v12 = 0;
        do
        {
          if (*v16 != v11)
          {
            objc_enumerationMutation(v9);
          }

          v13 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v15 + 1) + 8 * v12), v14];
          [v13 reset];

          ++v12;
        }

        while (v10 != v12);
        v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v15 objects:v19 count:16];
      }

      while (v10);
    }

    [(IDSGlobalLink *)self _updateAllLinks];
  }

  [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:pairsCopy, v14];
  if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0])
  {
    [(IDSGlobalLink *)self _discardCandidatePairsWithOption:1 isReinitiating:pairsCopy];
  }

  else
  {
    [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:11];
  }
}

- (void)_discardNonAcceptedCandidatePairs
{
  v65 = *MEMORY[0x1E69E9840];
  if (self->_isInitiator)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "start to discard non-accepted candidate pairs.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"start to discard non-accepted candidate pairs.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"start to discard non-accepted candidate pairs.");
        }
      }
    }

    v52 = 0u;
    v53 = 0u;
    v50 = 0u;
    v51 = 0u;
    obj = self->_nonAcceptedQRSessions;
    v37 = [(NSMutableArray *)obj countByEnumeratingWithState:&v50 objects:v64 count:16];
    if (v37)
    {
      v36 = *v51;
      do
      {
        for (i = 0; i != v37; ++i)
        {
          if (*v51 != v36)
          {
            objc_enumerationMutation(obj);
          }

          v41 = *(*(&v50 + 1) + 8 * i);
          if ([v41 isRelayStunCandidatePair])
          {
            v4 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
            {
              candidatePairToken = [v41 candidatePairToken];
              *buf = 138412290;
              v55 = candidatePairToken;
              _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "disconnect non-accepted relay candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                candidatePairToken2 = [v41 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"disconnect non-accepted relay candidate pair %@.");

                if (_IDSShouldLog())
                {
                  candidatePairToken2 = [v41 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect non-accepted relay candidate pair %@.");
                }
              }
            }

            sessionID = [v41 sessionID];
            v7 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:sessionID inState:3];

            v48 = 0u;
            v49 = 0u;
            v46 = 0u;
            v47 = 0u;
            v40 = v7;
            v8 = [v40 countByEnumeratingWithState:&v46 objects:v63 count:16];
            if (v8)
            {
              v9 = *v47;
              do
              {
                for (j = 0; j != v8; ++j)
                {
                  if (*v47 != v9)
                  {
                    objc_enumerationMutation(v40);
                  }

                  v11 = *(*(&v46 + 1) + 8 * j);
                  v12 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
                  {
                    sessionID2 = [v41 sessionID];
                    *buf = 138412546;
                    v55 = v11;
                    v56 = 2112;
                    v57 = sessionID2;
                    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_discardNonAcceptedCandidatePairs: found succeeded candidate pair %@ with the same QRSessionID %@, send unallocbind request", buf, 0x16u);
                  }

                  isQUIC = [v11 isQUIC];
                  candidatePairToken3 = [v11 candidatePairToken];
                  if (isQUIC)
                  {
                    [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:candidatePairToken3 reason:8];
                  }

                  else
                  {
                    [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken3 stunMessage:0 reason:8];
                  }
                }

                v8 = [v40 countByEnumeratingWithState:&v46 objects:v63 count:16];
              }

              while (v8);
            }

            sessionID3 = [v41 sessionID];
            v17 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:sessionID3 inState:1];

            v44 = 0u;
            v45 = 0u;
            v42 = 0u;
            v43 = 0u;
            v39 = v17;
            v18 = [v39 countByEnumeratingWithState:&v42 objects:v62 count:16];
            if (v18)
            {
              v19 = *v43;
              do
              {
                for (k = 0; k != v18; ++k)
                {
                  if (*v43 != v19)
                  {
                    objc_enumerationMutation(v39);
                  }

                  v21 = *(*(&v42 + 1) + 8 * k);
                  v22 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
                  {
                    sessionID4 = [v41 sessionID];
                    v24 = (&_IDSStunCandidatePairStateStrings)[[v21 state]];
                    *buf = 138413058;
                    v55 = v21;
                    v56 = 2112;
                    v57 = sessionID4;
                    v58 = 2080;
                    v59 = v24;
                    v60 = 2080;
                    v61 = off_1EB2B43D8;
                    _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_discardNonAcceptedCandidatePairs: found inProgress candidate pair %@ with the same QRSessionID %@, update state (%s->%s)", buf, 0x2Au);
                  }

                  [v21 setState:6];
                  if (self->_useLinkEngine)
                  {
                    linkEngine = [v21 linkEngine];
                    linkUniqueName = [v21 linkUniqueName];
                    [linkEngine linkDidDisconnect:linkUniqueName];
                  }

                  if ([v21 isQUIC])
                  {
                    v27 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
                    {
                      candidatePairToken4 = [v41 candidatePairToken];
                      *buf = 138412290;
                      v55 = candidatePairToken4;
                      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "Disconnecting discarded in-progress QUIC connection %@", buf, 0xCu);
                    }

                    nwLink = self->_nwLink;
                    sessionID5 = [v21 sessionID];
                    local = [v21 local];
                    address = [local address];
                    remote = [v21 remote];
                    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", sessionID5, address, [remote external], 1, 5.0);
                  }
                }

                v18 = [v39 countByEnumeratingWithState:&v42 objects:v62 count:16];
              }

              while (v18);
            }
          }
        }

        v37 = [(NSMutableArray *)obj countByEnumeratingWithState:&v50 objects:v64 count:16];
      }

      while (v37);
    }

    [(NSMutableArray *)self->_nonAcceptedQRSessions removeAllObjects];
  }
}

- (void)_discardSelfAllocateCandidatePairs
{
  v20 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v15 = 0u;
  v16 = 0u;
  v13 = 0u;
  v3 = v14 = 0u;
  v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
  if (v4)
  {
    v5 = *v14;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v14 != v5)
        {
          objc_enumerationMutation(v3);
        }

        v7 = *(*(&v13 + 1) + 8 * i);
        if ([v7 isRelayStunCandidatePair] && objc_msgSend(v7, "allocateType") == 2)
        {
          v8 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken = [v7 candidatePairToken];
            *buf = 138412290;
            v18 = candidatePairToken;
            _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "disconnect self allocate candidate pair %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              candidatePairToken2 = [v7 candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"disconnect self allocate candidate pair %@.");

              if (_IDSShouldLog())
              {
                candidatePairToken2 = [v7 candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect self allocate candidate pair %@.");
              }
            }
          }

          isQUIC = [v7 isQUIC];
          candidatePairToken3 = [v7 candidatePairToken];
          if (isQUIC)
          {
            [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:candidatePairToken3 reason:0];
          }

          else
          {
            [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken3 stunMessage:0 reason:0];
          }
        }
      }

      v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
    }

    while (v4);
  }
}

- (void)_removePacketNotificationFilter
{
  v29 = *MEMORY[0x1E69E9840];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v4 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v4)
  {
    v5 = v4;
    v24 = 0u;
    v25 = 0u;
    v22 = 0u;
    v23 = 0u;
    v6 = allValues;
    v7 = [v6 countByEnumeratingWithState:&v22 objects:v28 count:16];
    if (v7)
    {
      v8 = *v23;
      while (2)
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v23 != v8)
          {
            objc_enumerationMutation(v6);
          }

          v10 = *(*(&v22 + 1) + 8 * i);
          local = [v10 local];
          address = [local address];

          remote = [v10 remote];
          external = [remote external];

          local2 = [v10 local];
          if ([local2 isCellularStunCandidate] && IsSameSA(address, (v5 + 1)))
          {
            v16 = IsSameSA(external, (v5 + 17));

            if (v16)
            {
              v18 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v27 = v10;
                _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "remove packet notification filter for %@.", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v21 = v10;
                  _IDSLogTransport(@"GL", @"IDS", @"remove packet notification filter for %@.");
                  if (_IDSShouldLog())
                  {
                    v21 = v10;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"remove packet notification filter for %@.");
                  }
                }
              }

              v20 = +[IDSCellularLinkMonitor sharedInstance];
              [v20 removePacketNotificationFilter];

              goto LABEL_28;
            }
          }

          else
          {
          }
        }

        v7 = [v6 countByEnumeratingWithState:&v22 objects:v28 count:16];
        if (v7)
        {
          continue;
        }

        break;
      }
    }

LABEL_28:
  }

  else
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "_removePacketNotificationFilter failed due to invalid default link.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_removePacketNotificationFilter failed due to invalid default link.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_removePacketNotificationFilter failed due to invalid default link.");
        }
      }
    }
  }
}

- (void)_sendSessionDisconnectedCommand
{
  v20 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v15 = 0u;
  v16 = 0u;
  v13 = 0u;
  v3 = v14 = 0u;
  v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
  if (v4)
  {
    v5 = *v14;
LABEL_3:
    v6 = 0;
    while (1)
    {
      if (*v14 != v5)
      {
        objc_enumerationMutation(v3);
      }

      v7 = *(*(&v13 + 1) + 8 * v6);
      if ([v7 isActive])
      {
        break;
      }

      if (v4 == ++v6)
      {
        v4 = [v3 countByEnumeratingWithState:&v13 objects:v19 count:16];
        if (v4)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v8 = v7;

    if (!v8)
    {
      goto LABEL_18;
    }

    candidatePairToken = [v8 candidatePairToken];
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v18 = candidatePairToken;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "send session disconnected using %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v12 = candidatePairToken;
        _IDSLogTransport(@"GL", @"IDS", @"send session disconnected using %@.");
        if (_IDSShouldLog())
        {
          v12 = candidatePairToken;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send session disconnected using %@.");
        }
      }
    }

    [(IDSGlobalLink *)self _sendCommandMessage:2 stunMessage:0 options:0 candidatePairToken:candidatePairToken, v12];
  }

  else
  {
LABEL_9:

LABEL_18:
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair to send session disconnected command.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair to send session disconnected command.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair to send session disconnected command.");
        }
      }
    }
  }
}

- (void)_setChannelToCandidatePair:(id)pair localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress channelNumber:(unsigned __int16)number
{
  numberCopy = number;
  v20 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  if (!self->_channelToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    channelToCandidatePairs = self->_channelToCandidatePairs;
    self->_channelToCandidatePairs = Mutable;
  }

  v13 = channelForStunCandidatePair(address, remoteAddress, numberCopy);
  v14 = pairCopy;
  if (v14)
  {
    CFDictionarySetValue(self->_channelToCandidatePairs, v13, v14);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E14A84();
  }

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v17 = v13;
    v18 = 2112;
    v19 = v14;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "set channel %@ for %@.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"set channel %@ for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"set channel %@ for %@.");
      }
    }
  }
}

- (char)allocateLinkID
{
  v18 = *MEMORY[0x1E69E9840];
  v2 = self->_linkIDCounter + 1;
  self->_linkIDCounter = v2;
  intValue = v2;
  if (self->_maxLinkID >= v2)
  {
LABEL_15:
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v15 = intValue;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: linkID %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: linkID %d");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: linkID %d");
        }
      }
    }

    return intValue;
  }

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    maxLinkID = self->_maxLinkID;
    *buf = 67109376;
    v15 = v2;
    v16 = 1024;
    v17 = maxLinkID;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v12 = v2;
      v13 = self->_maxLinkID;
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse");
      if (_IDSShouldLog())
      {
        v12 = v2;
        v13 = self->_maxLinkID;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: linkID %d > %d; will pick link ID to reuse");
      }
    }
  }

  if ([(NSMutableArray *)self->_unusedLinkIDs count:v12])
  {
    firstObject = [(NSMutableArray *)self->_unusedLinkIDs firstObject];
    intValue = [firstObject intValue];

    [(NSMutableArray *)self->_unusedLinkIDs removeFirstObject];
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v15 = intValue;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: reusing linkID %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: reusing linkID %d");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: reusing linkID %d");
        }
      }
    }

    goto LABEL_15;
  }

  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: could not find a linkID to reuse", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: could not find a linkID to reuse");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: could not find a linkID to reuse");
      }
    }
  }

  [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:255 reason:10];
  return -1;
}

- (void)freeLinkID:(char)d
{
  dCopy = d;
  unusedLinkIDs = self->_unusedLinkIDs;
  v6 = [MEMORY[0x1E696AD98] numberWithChar:?];
  v7 = [(NSMutableArray *)unusedLinkIDs containsObject:v6];

  if (dCopy >= 1 && (v7 & 1) == 0)
  {
    v8 = self->_unusedLinkIDs;
    v9 = [MEMORY[0x1E696AD98] numberWithChar:dCopy];
    [(NSMutableArray *)v8 addObject:v9];
  }
}

- (void)_initializeSendInfoForCandidatePair:(id)pair
{
  pairCopy = pair;
  isVirtualRelayStunCandidatePair = [pairCopy isVirtualRelayStunCandidatePair];
  allocateLinkID = [(IDSGlobalLink *)self allocateLinkID];
  [pairCopy setLinkID:allocateLinkID];
  linkEngine = [pairCopy linkEngine];
  linkID = [pairCopy linkID];
  linkUniqueName = [pairCopy linkUniqueName];
  [linkEngine setIDSLinkID:linkID forLinkWithUniqueID:linkUniqueName];

  if ((allocateLinkID & 0x80000000) == 0 || self->_maxLinkID > allocateLinkID)
  {
    objc_storeStrong(&self->_candidatePairs[allocateLinkID], pair);
  }

  IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, pairCopy, allocateLinkID);
  v10 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v10 && !((*v10 != 0) | isVirtualRelayStunCandidatePair & 1))
  {
    IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, pairCopy, 0);
  }
}

- (void)_deinitialieSendInfoForCandidatePair:(id)pair
{
  pairCopy = pair;
  -[IDSGlobalLink freeLinkID:](self, "freeLinkID:", [pairCopy linkID]);
  [pairCopy setLinkID:0];
}

- (void)_setCandidatePairConnected:(id)connected
{
  v82 = *MEMORY[0x1E69E9840];
  connectedCopy = connected;
  v5 = connectedCopy;
  if (connectedCopy)
  {
    isVirtualRelayStunCandidatePair = [connectedCopy isVirtualRelayStunCandidatePair];
    if (self->_linkConnectTime == 0.0 && self->_isUPlusOneSession && isVirtualRelayStunCandidatePair & 1 | (([v5 isRelayStunCandidatePair] & 1) == 0))
    {
      self->_linkConnectTime = ids_monotonic_time();
    }

    [(IDSGlobalLink *)self _initializeSendInfoForCandidatePair:v5];
    linkID = [v5 linkID];
    if (!(isVirtualRelayStunCandidatePair & 1 | (([v5 isSharedQRSession] & 1) == 0)))
    {
      [(IDSGlobalLink *)self _updateLinkIDForPlugin:v5];
    }

    if ((isVirtualRelayStunCandidatePair & 1) == 0)
    {
      if ([v5 isSharedQRSession])
      {
        qraBlocks = self->_qraBlocks;
        if (qraBlocks)
        {
          qraCONBlock = qraBlocks->_qraCONBlock;
          if (qraCONBlock)
          {
            cbuuid = self->_cbuuid;
            sessionID = [v5 sessionID];
            qraCONBlock[2](qraCONBlock, cbuuid, sessionID);
          }
        }
      }
    }

    if (self->_ftPowerOptimizationEnabled)
    {
      [(IDSGlobalLink *)self _sendChannelConfigRequestToQR:v5];
    }

    v12 = [(IDSGlobalLink *)self _getLocalAttribute:v5];
    v65 = [(IDSGlobalLink *)self _getRemoteAttribute:v5];
    if ((isVirtualRelayStunCandidatePair & 1) != 0 || ![v5 isRelayStunCandidatePair])
    {
      [(IDSGFTMetricsCollector *)self->_metricsCollector didConnectUnderlyingE2ELink];
    }

    else
    {
      [(IDSGFTMetricsCollector *)self->_metricsCollector didConnectUnderlyingRelayLink];
    }

    if (IMGetDomainBoolForKey() && self->_isUPlusOneSession && !GLUtilUnderPerformanceTesting(v5, isVirtualRelayStunCandidatePair))
    {
      goto LABEL_38;
    }

    qualityMeasurer = self->_qualityMeasurer;
    testableLink = [v5 testableLink];
    uniqueID = [v5 uniqueID];
    [(IDSLinksQualityMeasurer *)qualityMeasurer addLink:testableLink uniqueID:uniqueID completionHandler:&unk_1F1AAA3C0];

    linkEngine = [v5 linkEngine];
    if (linkEngine)
    {
      linkUniqueName = [v5 linkUniqueName];

      if (linkUniqueName)
      {
        linkEngine2 = [v5 linkEngine];
        testableLink2 = [v5 testableLink];
        linkUniqueName2 = [v5 linkUniqueName];
        [linkEngine2 setTestableLink:testableLink2 forLinkWithUniqueID:linkUniqueName2];

        linkEngine3 = [v5 linkEngine];
        linkUniqueName3 = [v5 linkUniqueName];
        v23 = [linkEngine3 packetQualityHandlerForLinkWithUniqueName:linkUniqueName3];

        if (v23)
        {
          [v5 setQualityHandler:v23];
          v24 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412546;
            *v75 = v23;
            *&v75[8] = 2112;
            *&v75[10] = v5;
            _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: handler %@ for candidatePair %@", buf, 0x16u);
          }
        }
      }
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v26 = objc_opt_respondsToSelector();

    if ((v26 & 1) == 0)
    {
LABEL_38:
      v64 = v12;
LABEL_68:

      goto LABEL_69;
    }

    if (isVirtualRelayStunCandidatePair)
    {
      v63 = @"VR ";
    }

    else
    {
      isRelayStunCandidatePair = [v5 isRelayStunCandidatePair];
      v29 = @"P2P";
      if (isRelayStunCandidatePair)
      {
        v29 = @"RLY";
      }

      v63 = v29;
      if ([v5 isRelayStunCandidatePair])
      {
        local = [v5 local];
        v31 = GLUtilStunTransportToProtocol([local transport], self->_H2FallbackEnabled);

        v32 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          idsSessionID = self->_idsSessionID;
          sessionID2 = [v5 sessionID];
          *buf = 67110402;
          *v75 = linkID;
          *&v75[4] = 2112;
          *&v75[6] = v63;
          *&v75[14] = 2112;
          *&v75[16] = v31;
          v76 = 2112;
          v77 = idsSessionID;
          v78 = 2112;
          v79 = sessionID2;
          v80 = 2112;
          v81 = v5;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Send link connected (%d) %@ using %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x3Au);
        }

        local2 = [v5 local];
        transport = [local2 transport];

        v37 = GLUtilStunTransportToLinkType(transport, self->_H2FallbackEnabled);
        if (v37 > 331)
        {
          if (v37 == 332)
          {
            [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingTCPSTUN];
          }

          else if (v37 == 333)
          {
            [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingFakeTLS];
          }
        }

        else if (v37 == 313)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingQUIC];
        }

        else if (v37 == 331)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedUsingHTTP2];
        }

        goto LABEL_50;
      }
    }

    v31 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v38 = self->_idsSessionID;
      sessionID3 = [v5 sessionID];
      *buf = 67110146;
      *v75 = linkID;
      *&v75[4] = 2112;
      *&v75[6] = v63;
      *&v75[14] = 2112;
      *&v75[16] = v38;
      v76 = 2112;
      v77 = sessionID3;
      v78 = 2112;
      v79 = v5;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "Send link connected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x30u);
    }

LABEL_50:

    nwLink = self->_nwLink;
    if (nwLink)
    {
      [(IDSNWLink *)nwLink logConnectionTree];
    }

    v64 = [(IDSGlobalLink *)self _translateLinkTransportTypeWhenH2Enabled:v12];

    v41 = objc_loadWeakRetained(&self->_delegate);
    linkUUID = [v5 linkUUID];
    [v41 link:self didConnectUnderlyingLink:linkID linkUUID:linkUUID localAttributes:v64 remoteAttributes:v65];

    if (self->_connectedLinkIDs || (v43 = objc_alloc_init(MEMORY[0x1E695DF70]), v44 = self->_connectedLinkIDs, self->_connectedLinkIDs = v43, v44, self->_connectedLinkIDs))
    {
      v45 = [MEMORY[0x1E696AD98] numberWithInt:linkID];
      v46 = v45 == 0;

      if (!v46)
      {
        connectedLinkIDs = self->_connectedLinkIDs;
        v48 = [MEMORY[0x1E696AD98] numberWithInt:linkID];
        CFArrayAppendValue(connectedLinkIDs, v48);
      }
    }

    [(IDSGlobalLink *)self _resetRetryCountForCandidatePair:v5];
    [(IDSGFTMetricsCollector *)self->_metricsCollector linkConnectedWithH2FallbackEnabled:self->_H2FallbackEnabled];
    v71 = 0u;
    v72 = 0u;
    v69 = 0u;
    v70 = 0u;
    connections = [v5 connections];
    v50 = [connections countByEnumeratingWithState:&v69 objects:v73 count:16];
    if (v50)
    {
      v51 = *v70;
      do
      {
        for (i = 0; i != v50; ++i)
        {
          if (*v70 != v51)
          {
            objc_enumerationMutation(connections);
          }

          v53 = *(*(&v69 + 1) + 8 * i);
          connections2 = [v5 connections];
          v55 = [connections2 objectForKeyedSubscript:v53];

          linkMetrics = [v5 linkMetrics];
          v57 = [v55 objectForKeyedSubscript:@"protocol-stack"];
          [linkMetrics linkConnectedWithProtocolStack:v57];
        }

        v50 = [connections countByEnumeratingWithState:&v69 objects:v73 count:16];
      }

      while (v50);
    }

    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v5];
    v58 = GLUCreateLinkConnectedEvent(v5, self->_H2FallbackEnabled);
    v59 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v75 = v58;
      _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "added qrLinkConnectedEvent: %@", buf, 0xCu);
    }

    v60 = objc_loadWeakRetained(&self->_delegate);
    v61 = objc_opt_respondsToSelector();

    if (v61)
    {
      v62 = objc_loadWeakRetained(&self->_delegate);
      [v62 link:self didAddQREvent:v58];
    }

    objc_initWeak(buf, self);
    v66[0] = MEMORY[0x1E69E9820];
    v66[1] = 3221225472;
    v66[2] = sub_1A7B81E00;
    v66[3] = &unk_1E77E0D28;
    objc_copyWeak(&v68, buf);
    v67 = v5;
    IDSTransportThreadAddBlock(v66);

    objc_destroyWeak(&v68);
    objc_destroyWeak(buf);

    goto LABEL_68;
  }

  v27 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "_setCandidatePairConnected: invalid candidatePair", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_setCandidatePairConnected: invalid candidatePair");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_setCandidatePairConnected: invalid candidatePair");
      }
    }
  }

LABEL_69:
}

- (id)_translateLinkTransportTypeWhenH2Enabled:(id)enabled
{
  v16 = *MEMORY[0x1E69E9840];
  enabledCopy = enabled;
  v5 = enabledCopy;
  if (!self->_H2FallbackEnabled)
  {
    goto LABEL_7;
  }

  v6 = [enabledCopy objectForKey:@"gl-attr-transport"];
  unsignedCharValue = [v6 unsignedCharValue];

  if (unsignedCharValue == 3)
  {
    v8 = 5;
  }

  else
  {
    if (unsignedCharValue != 4)
    {
LABEL_7:
      v9 = v5;
      goto LABEL_8;
    }

    v8 = 3;
  }

  if (v8 == unsignedCharValue)
  {
    goto LABEL_7;
  }

  v11 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    v13[0] = 67109376;
    v13[1] = unsignedCharValue;
    v14 = 1024;
    v15 = v8;
    _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_translateLinkTransportTypeWhenH2Enabled: %d -> %d", v13, 0xEu);
  }

  v9 = [v5 mutableCopy];
  v12 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:v8];
  if (v12)
  {
    CFDictionarySetValue(v9, @"gl-attr-transport", v12);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E14B00();
  }

LABEL_8:

  return v9;
}

- (void)_setLinkMetricsAttributesForCandidatePair:(id)pair linkAttributes:(id)attributes
{
  pairCopy = pair;
  attributesCopy = attributes;
  if (pairCopy)
  {
    if ([pairCopy isVirtualRelayStunCandidatePair])
    {
      v6 = @"VR ";
    }

    else if ([pairCopy isRelayStunCandidatePair])
    {
      v6 = @"RLY";
    }

    else
    {
      v6 = @"P2P";
    }

    [attributesCopy setLinkType:v6];
    connections = [pairCopy connections];
    v8 = [connections objectForKeyedSubscript:@"qpod"];

    connections2 = [pairCopy connections];
    v10 = [connections2 objectForKeyedSubscript:@"udp"];

    if (v8 && ([v8 objectForKeyedSubscript:@"allow-outgoing"], v11 = objc_claimAutoreleasedReturnValue(), v12 = objc_msgSend(v11, "BOOLValue"), v11, v12))
    {
      v13 = [v8 objectForKeyedSubscript:@"protocol-stack"];
      [attributesCopy setChannelDataProtocolStack:v13];

      [attributesCopy setIsTLEEnabled:1];
    }

    else if (v10)
    {
      v14 = [v10 objectForKeyedSubscript:@"protocol-stack"];
      [attributesCopy setChannelDataProtocolStack:v14];
    }

    connections3 = [pairCopy connections];
    v16 = [connections3 objectForKeyedSubscript:@"qr"];

    if (v16 && [pairCopy isRelayStunCandidatePair])
    {
      v17 = [v16 objectForKeyedSubscript:@"protocol-stack"];
      [attributesCopy setRelayProtocolStack:v17];
    }

    local = [pairCopy local];
    [attributesCopy setLocalRAT:{objc_msgSend(local, "radioAccessTechnology")}];

    remote = [pairCopy remote];
    [attributesCopy setRemoteRAT:{objc_msgSend(remote, "radioAccessTechnology")}];

    local2 = [pairCopy local];
    if (*([local2 address] + 1) == 30)
    {
      v21 = 6;
    }

    else
    {
      v21 = 4;
    }

    [attributesCopy setIPVersion:v21];

    linkEngine = [pairCopy linkEngine];
    [attributesCopy setIsLinkEngineLink:linkEngine != 0];
  }
}

- (void)_setLinkMetricsAttributesForCandidatePair:(id)pair
{
  if (pair)
  {
    pairCopy = pair;
    linkMetrics = [pairCopy linkMetrics];
    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:pairCopy linkAttributes:linkMetrics];
  }
}

- (void)_updateLinkIDForPlugin:(id)plugin
{
  v43 = *MEMORY[0x1E69E9840];
  pluginCopy = plugin;
  v5 = pluginCopy;
  linkIDForPlugin = self->_linkIDForPlugin;
  if (!self->_linkIDForPlugin)
  {
    self->_linkIDForPlugin = [(IDSStunCandidatePair *)pluginCopy linkID];
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v19;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        linkID3 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d");
        if (_IDSShouldLog())
        {
          linkID3 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d");
        }
      }
    }

    v8 = 0;
    v17 = v5;
LABEL_43:
    if (![(IDSStunCandidatePair *)v5 isNewlyJoined])
    {
      goto LABEL_50;
    }

    goto LABEL_44;
  }

  if ((linkIDForPlugin & 0x80) != 0 || self->_maxLinkID <= linkIDForPlugin)
  {
    v7 = 0;
  }

  else
  {
    v7 = self->_candidatePairs[self->_linkIDForPlugin];
  }

  v8 = v7;
  local = [(IDSStunCandidatePair *)v8 local];
  isCellularStunCandidate = [local isCellularStunCandidate];

  local2 = [(IDSStunCandidatePair *)v5 local];
  isCellularStunCandidate2 = [local2 isCellularStunCandidate];

  if ((!isCellularStunCandidate || isCellularStunCandidate2) && [(IDSStunCandidatePair *)v8 state]== 4 && self->_linkIDForPlugin == [(IDSStunCandidatePair *)v8 linkID])
  {
    sessionID = [(IDSStunCandidatePair *)v5 sessionID];
    sessionID2 = [(IDSStunCandidatePair *)v8 sessionID];
    if ([sessionID isEqualToString:sessionID2])
    {

LABEL_33:
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        v27 = self->_linkIDForPlugin;
        *buf = 67109120;
        v40 = v27;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to existing %d", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          linkID3 = self->_linkIDForPlugin;
          _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to existing %d");
          if (_IDSShouldLog())
          {
            linkID3 = self->_linkIDForPlugin;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to existing %d");
          }
        }
      }

      v17 = v8;

      goto LABEL_40;
    }

    [(IDSStunCandidatePair *)v5 allocateTime];
    v21 = v20;
    [(IDSStunCandidatePair *)v8 allocateTime];
    v23 = v22;

    if (v21 <= v23)
    {
      goto LABEL_33;
    }

    self->_linkIDForPlugin = [(IDSStunCandidatePair *)v5 linkID];
    v24 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
    {
      v25 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v25;
      _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d, after convergence", buf, 8u);
    }

    v17 = v5;
    if (os_log_shim_legacy_logging_enabled())
    {
      v17 = v5;
      if (_IDSShouldLogTransport())
      {
        linkID3 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d, after convergence");
        v17 = v5;
        if (_IDSShouldLog())
        {
          linkID3 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d, after convergence");
          goto LABEL_18;
        }
      }
    }
  }

  else
  {
    self->_linkIDForPlugin = [(IDSStunCandidatePair *)v5 linkID];
    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v16 = self->_linkIDForPlugin;
      *buf = 67109120;
      v40 = v16;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to new link %d", buf, 8u);
    }

    v17 = v5;
    if (os_log_shim_legacy_logging_enabled())
    {
      v17 = v5;
      if (_IDSShouldLogTransport())
      {
        linkID3 = self->_linkIDForPlugin;
        _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to new link %d");
        v17 = v5;
        if (_IDSShouldLog())
        {
          linkID3 = self->_linkIDForPlugin;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to new link %d");
LABEL_18:
          v17 = v5;
        }
      }
    }
  }

LABEL_40:
  if (!v8)
  {
    goto LABEL_43;
  }

  if (!self->_linkIDForPlugin)
  {
    goto LABEL_43;
  }

  v28 = self->_linkIDForPlugin;
  if (v28 == [(IDSStunCandidatePair *)v8 linkID])
  {
    goto LABEL_43;
  }

LABEL_44:
  [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
  v29 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
  {
    linkID = [(IDSStunCandidatePair *)v8 linkID];
    linkID2 = [(IDSStunCandidatePair *)v5 linkID];
    *buf = 67109376;
    v40 = linkID;
    v41 = 1024;
    v42 = linkID2;
    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      linkID3 = [(IDSStunCandidatePair *)v8 linkID];
      linkID4 = [(IDSStunCandidatePair *)v5 linkID];
      _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
      if (_IDSShouldLog())
      {
        linkID3 = [(IDSStunCandidatePair *)v8 linkID:linkID3];
        linkID4 = [(IDSStunCandidatePair *)v5 linkID];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
      }
    }
  }

LABEL_50:
  if ([(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict count:linkID3])
  {
    pluginNameToPluginOptionsDict = self->_pluginNameToPluginOptionsDict;
    v36[0] = MEMORY[0x1E69E9820];
    v36[1] = 3221225472;
    v36[2] = sub_1A7B82B78;
    v36[3] = &unk_1E77E0D50;
    v37 = v5;
    v38 = v17;
    [(NSMutableDictionary *)pluginNameToPluginOptionsDict enumerateKeysAndObjectsUsingBlock:v36];
  }

  else
  {
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "No plugin requests found.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"No plugin requests found.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"No plugin requests found.");
        }
      }
    }
  }
}

- (void)_notifyCandidatePairConnected:(id)connected
{
  v12 = *MEMORY[0x1E69E9840];
  connectedCopy = connected;
  if (connectedCopy)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (tokenToCandidatePairs && (v6 = CFDictionaryGetValue(tokenToCandidatePairs, connectedCopy)) != 0)
    {
      v7 = v6;
      [(IDSGlobalLink *)self _setCandidatePairConnected:v6];
      if (self->_linkIDCounter == 1)
      {
        [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:connectedCopy error:0];
      }

      if (self->_delayedConnData)
      {
        v8 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "connection data is delayed, send it now.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"connection data is delayed, send it now.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data is delayed, send it now.");
            }
          }
        }

        [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
      }
    }

    else
    {
      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v11 = connectedCopy;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
          }
        }
      }

      v7 = 0;
    }
  }
}

- (void)_notifyCandidatePairDisconnected:(id)disconnected withReason:(unsigned __int8)reason
{
  reasonCopy = reason;
  v88 = *MEMORY[0x1E69E9840];
  disconnectedCopy = disconnected;
  v7 = disconnectedCopy;
  if (disconnectedCopy)
  {
    state = [disconnectedCopy state];
    linkID = [v7 linkID];
    linkUUID = [v7 linkUUID];
    if ([v7 isVirtualRelayStunCandidatePair])
    {
      v10 = @"VR ";
    }

    else
    {
      isRelayStunCandidatePair = [v7 isRelayStunCandidatePair];
      v10 = @"P2P";
      if (isRelayStunCandidatePair)
      {
        v10 = @"RLY";
      }
    }

    v12 = v10;
    if (state == 6)
    {
      goto LABEL_90;
    }

    [v7 setState:6];
    v73 = v12;
    if (reasonCopy != 5 && self->_useLinkEngine)
    {
      linkEngine = [v7 linkEngine];
      linkUniqueName = [v7 linkUniqueName];
      [linkEngine linkDidDisconnect:linkUniqueName];
    }

    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v16 = (&_IDSStunCandidatePairStateStrings)[state];
      *buf = 136315650;
      *v81 = v16;
      *&v81[8] = 2080;
      *&v81[10] = off_1EB2B43D8;
      *&v81[18] = 2112;
      *&v81[20] = v7;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v69 = off_1EB2B43D8;
        v70 = v7;
        v67 = (&_IDSStunCandidatePairStateStrings)[state];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v69 = off_1EB2B43D8;
          v70 = v7;
          v67 = (&_IDSStunCandidatePairStateStrings)[state];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    if ([v7 isQUIC] && ((reasonCopy != 5) & (objc_msgSend(v7, "isVirtualRelayStunCandidatePair") ^ 1)) == 1)
    {
      v17 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken = [v7 candidatePairToken];
        *buf = 138412290;
        *v81 = candidatePairToken;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Disconnecting QUIC connection %@", buf, 0xCu);
      }

      if (reasonCopy == 1)
      {
        v19 = 0.0;
      }

      else
      {
        v19 = 5.0;
      }

      nwLink = self->_nwLink;
      sessionID = [v7 sessionID];
      local = [v7 local];
      address = [local address];
      remote = [v7 remote];
      -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", sessionID, address, [remote external], 1, v19);
    }

    else
    {
      if ([v7 isRelayStunCandidatePair] & 1) != 0 || (objc_msgSend(v7, "isVirtualRelayStunCandidatePair"))
      {
LABEL_30:
        if (self->_QUICForQREnabled && ([v7 isVirtualRelayStunCandidatePair] & 1) == 0 && !self->_disableDirectDatapath)
        {
          v28 = self->_nwLink;
          sessionID2 = [v7 sessionID];
          local2 = [v7 local];
          address2 = [local2 address];
          remote2 = [v7 remote];
          -[IDSNWLink removeChildConnectionEvaluatorForSessionID:localAddress:remoteAddress:isRelay:](v28, "removeChildConnectionEvaluatorForSessionID:localAddress:remoteAddress:isRelay:", sessionID2, address2, [remote2 external], objc_msgSend(v7, "isRelayStunCandidatePair"));
        }

        if (linkID <= 0)
        {
          v50 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v81 = v7;
            _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "skip sending link disconnected with linkID 0 for %@.", buf, 0xCu);
          }

          v12 = v73;
          if (!os_log_shim_legacy_logging_enabled())
          {
            goto LABEL_90;
          }

          v12 = v73;
          if (!_IDSShouldLogTransport())
          {
            goto LABEL_90;
          }

          _IDSLogTransport(@"GL", @"IDS", @"skip sending link disconnected with linkID 0 for %@.");
          v12 = v73;
          if (!_IDSShouldLog())
          {
            goto LABEL_90;
          }

          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip sending link disconnected with linkID 0 for %@.");
        }

        else
        {
          if ([v7 isSharedQRSession])
          {
            qraBlocks = self->_qraBlocks;
            if (qraBlocks)
            {
              qraDISBlock = qraBlocks->_qraDISBlock;
              if (qraDISBlock)
              {
                cbuuid = self->_cbuuid;
                sessionID3 = [v7 sessionID];
                qraDISBlock[2](qraDISBlock, cbuuid, sessionID3);
              }
            }
          }

          if (self->_p2pLinkEngine)
          {
            if ([v7 isP2P])
            {
              linkUniqueName2 = [v7 linkUniqueName];
              v38 = linkUniqueName2 == 0;

              if (!v38)
              {
                p2pLinkEngine = self->_p2pLinkEngine;
                linkUniqueName3 = [v7 linkUniqueName];
                [(IDSGLP2PLinkEngineHandle *)p2pLinkEngine removeLinkWithUniqueName:linkUniqueName3];
              }
            }
          }

          qualityMeasurer = self->_qualityMeasurer;
          testableLink = [v7 testableLink];
          [(IDSLinksQualityMeasurer *)qualityMeasurer removeLink:testableLink completionHandler:&unk_1F1AAA3E0];

          WeakRetained = objc_loadWeakRetained(&self->_delegate);
          LOBYTE(qualityMeasurer) = objc_opt_respondsToSelector();

          if (qualityMeasurer)
          {
            v44 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
            {
              idsSessionID = self->_idsSessionID;
              sessionID4 = [v7 sessionID];
              candidatePairToken2 = [v7 candidatePairToken];
              if (qword_1EB2B89E8 != -1)
              {
                sub_1A7E14B7C();
              }

              if ([qword_1EB2B89F0 count] > reasonCopy)
              {
                v47 = MEMORY[0x1E696AEC0];
                v48 = [qword_1EB2B89F0 objectAtIndex:reasonCopy];
                reasonCopy = [v47 stringWithFormat:@"%@ (%d)", v48, reasonCopy];
              }

              else
              {
                if (byte_1EB2B89F8 == 1)
                {
                  if (isRunningTests())
                  {
                    throwsIDSAbortException();
                  }

                  abort();
                }

                reasonCopy = 0;
              }

              *buf = 67110658;
              *v81 = linkID;
              *&v81[4] = 2112;
              *&v81[6] = v73;
              *&v81[14] = 2112;
              *&v81[16] = idsSessionID;
              *&v81[24] = 2112;
              *&v81[26] = sessionID4;
              v82 = 2112;
              v83 = candidatePairToken2;
              v84 = 2112;
              v85 = linkUUID;
              v86 = 2112;
              v87 = reasonCopy;
              _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "Send link disconnected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@ linkUUID:%@, reason: %@", buf, 0x44u);
            }

            v51 = self->_nwLink;
            if (v51)
            {
              [(IDSNWLink *)v51 logConnectionTree];
            }

            v52 = objc_loadWeakRetained(&self->_delegate);
            [v52 link:self didDisconnectUnderlyingLinkID:linkID linkUUID:linkUUID reason:reasonCopy];

            connectedLinkIDs = self->_connectedLinkIDs;
            v54 = [MEMORY[0x1E696AD98] numberWithInt:linkID];
            [(NSMutableArray *)connectedLinkIDs removeObject:v54];

            [(IDSGlobalLink *)self _stopProbingOnLinkID:linkID];
          }

          v55 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          if (*v55 == linkID)
          {
            *v55 = 0;
            v56 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109120;
              *v81 = linkID;
              _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "default link is disconnected, reset default link %d.", buf, 8u);
            }
          }

          if (self->_linkIDForPlugin == linkID)
          {
            allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
            linkIDForPlugin = self->_linkIDForPlugin;
            v75 = 0u;
            v76 = 0u;
            v77 = 0u;
            v78 = 0u;
            v58 = allValues;
            v59 = [v58 countByEnumeratingWithState:&v75 objects:v79 count:16];
            if (v59)
            {
              v60 = *v76;
LABEL_70:
              v61 = 0;
              while (1)
              {
                if (*v76 != v60)
                {
                  objc_enumerationMutation(v58);
                }

                v62 = *(*(&v75 + 1) + 8 * v61);
                if ([v62 isSharedQRSession])
                {
                  if (([v62 isVirtualRelayStunCandidatePair] & 1) == 0 && objc_msgSend(v62, "state") == 4)
                  {
                    self->_linkIDForPlugin = [v62 linkID];
                    local3 = [v62 local];
                    isCellularStunCandidate = [local3 isCellularStunCandidate];

                    if (!isCellularStunCandidate)
                    {
                      break;
                    }
                  }
                }

                if (v59 == ++v61)
                {
                  v59 = [v58 countByEnumeratingWithState:&v75 objects:v79 count:16];
                  if (v59)
                  {
                    goto LABEL_70;
                  }

                  break;
                }
              }
            }

            if (linkIDForPlugin == self->_linkIDForPlugin)
            {
              self->_linkIDForPlugin = 0;
            }

            v65 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
            {
              v66 = self->_linkIDForPlugin;
              *buf = 67109120;
              *v81 = v66;
              _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "Setting linkID for Plugin to %d", buf, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v68 = self->_linkIDForPlugin;
                _IDSLogTransport(@"GL", @"IDS", @"Setting linkID for Plugin to %d");
                if (_IDSShouldLog())
                {
                  v68 = self->_linkIDForPlugin;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"Setting linkID for Plugin to %d");
                }
              }
            }
          }

          [(IDSGlobalLink *)self freeLinkID:linkID, v68];
        }

        v12 = v73;
LABEL_90:

        goto LABEL_91;
      }

      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109634;
        *v81 = linkID;
        *&v81[4] = 2112;
        *&v81[6] = v73;
        *&v81[14] = 2112;
        *&v81[16] = v7;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "Disconnecting connection for link (%d) %@ (candidate pair: %@)", buf, 0x1Cu);
      }

      v26 = self->_nwLink;
      sessionID = [v7 sessionID];
      local = [v7 local];
      address3 = [local address];
      remote = [v7 remote];
      -[IDSNWLink disconnectP2PWithSessionID:localAddress:remoteAddress:](v26, "disconnectP2PWithSessionID:localAddress:remoteAddress:", sessionID, address3, [remote external]);
    }

    goto LABEL_30;
  }

LABEL_91:
}

- (void)_notifyDefaultUnderlyingLinkChanged:(id)changed error:(int64_t)error
{
  *&v18[5] = *MEMORY[0x1E69E9840];
  changedCopy = changed;
  if (changedCopy && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v8 = CFDictionaryGetValue(tokenToCandidatePairs, changedCopy)) != 0)
  {
    v9 = v8;
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v11 = objc_opt_respondsToSelector();

    if (v11)
    {
      linkID = [v9 linkID];
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109376;
        v18[0] = linkID;
        LOWORD(v18[1]) = 1024;
        *(&v18[1] + 2) = error;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "send default link changed (link:%d, error:%d).", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send default link changed (link:%d, error:%d).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send default link changed (link:%d, error:%d).");
          }
        }
      }

      v14 = error == 0;
      v15 = objc_loadWeakRetained(&self->_delegate);
      [v15 link:self didDefaultUnderlyingLinkChangeSucceeded:v14 currentDefaultLinkID:linkID];
    }
  }

  else
  {
    v16 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v18 = changedCopy;
      _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
        }
      }
    }

    v9 = 0;
  }
}

- (void)_finishPacketLog
{
  packetLog = self->_packetLog;
  if (packetLog)
  {
    [(IDSObjCPacketLog *)packetLog finish];
    v4 = self->_packetLog;
    self->_packetLog = 0;

    MEMORY[0x1EEE66B58](IDSObjCPacketLogManager, sel_clean);
  }
}

- (void)_notifyLinkDisconnectedWithError:(int64_t)error reason:(unsigned __int8)reason
{
  v72 = *MEMORY[0x1E69E9840];
  if (self->_state == 6)
  {
    return;
  }

  reasonCopy = reason;
  errorCopy = error;
  v6 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412802;
    selfCopy7 = self;
    v69 = 1024;
    *v70 = errorCopy;
    *&v70[4] = 1024;
    *&v70[6] = reasonCopy;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "IDSGlobalLink %@ disconnected, error(%d), reason(%d).", buf, 0x18u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      errorCopy3 = error;
      v37 = reasonCopy;
      selfCopy6 = self;
      _IDSLogTransport(@"GL", @"IDS", @"IDSGlobalLink %@ disconnected, error(%d), reason(%d).");
      if (_IDSShouldLog())
      {
        v37 = reasonCopy;
        errorCopy3 = error;
        selfCopy6 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"IDSGlobalLink %@ disconnected, error(%d), reason(%d).");
      }
    }
  }

  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = _IDSLinkStateStrings[self->_state];
    *buf = 138412802;
    selfCopy7 = self;
    v69 = 2080;
    *v70 = v8;
    *&v70[8] = 2080;
    v71 = off_1EB2B3E80[0];
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      errorCopy3 = _IDSLinkStateStrings[self->_state];
      v37 = off_1EB2B3E80[0];
      selfCopy6 = self;
      _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
      if (_IDSShouldLog())
      {
        errorCopy3 = _IDSLinkStateStrings[self->_state];
        v37 = off_1EB2B3E80[0];
        selfCopy6 = self;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
      }
    }
  }

  self->_state = 6;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues:selfCopy6];
  v62 = 0u;
  v63 = 0u;
  v60 = 0u;
  obj = v61 = 0u;
  v9 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
  if (v9)
  {
    v10 = *v61;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v61 != v10)
        {
          objc_enumerationMutation(obj);
        }

        v12 = *(*(&v60 + 1) + 8 * i);
        state = [v12 state];
        isRelayStunCandidatePair = [v12 isRelayStunCandidatePair];
        if (state == 5)
        {
          v15 = isRelayStunCandidatePair;
        }

        else
        {
          v15 = 0;
        }

        if (v15 == 1)
        {
          v16 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken = [v12 candidatePairToken];
            *buf = 138412546;
            selfCopy7 = self;
            v69 = 2112;
            *v70 = candidatePairToken;
            _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              [v12 candidatePairToken];
              v36 = v34 = self;
              _IDSLogTransport(@"GL", @"IDS", @"IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@");

              if (_IDSShouldLog())
              {
                [v12 candidatePairToken];
                v36 = v34 = self;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"IDSGlobalLink %@ disconnect disconnecting candidate pairs: %@");
              }
            }
          }

          [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v12 withReason:reasonCopy, v34, v36];
        }
      }

      v9 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
    }

    while (v9);
  }

  if (error == 8)
  {
    v18 = @"Unallocbind timed out.";
  }

  else
  {
    if (error != 24)
    {
      v39 = 0;
      goto LABEL_38;
    }

    v18 = @"Unallocbind send failure.";
  }

  v19 = MEMORY[0x1E696ABC0];
  v20 = [MEMORY[0x1E695DF20] dictionaryWithObject:v18 forKey:*MEMORY[0x1E696A578]];
  v39 = [v19 errorWithDomain:@"GlobalLink" code:error userInfo:v20];

LABEL_38:
  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "removing links from quality measurer...", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"removing links from quality measurer...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"removing links from quality measurer...");
      }
    }
  }

  v38 = self->_qualityMeasurer;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  [(IDSGlobalLink *)self _finishPacketLog];
  if (self->_useLinkSelection && ([MEMORY[0x1E69A60F0] sharedInstance], v23 = objc_claimAutoreleasedReturnValue(), v24 = objc_msgSend(v23, "isInternalInstall"), v23, v24))
  {
    v25 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "building LinkEngine quality report...", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"building LinkEngine quality report...");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"building LinkEngine quality report...");
        }
      }
    }

    [(IDSGlobalLink *)self allLinkEngines];
    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v40 = v57 = 0u;
    v42 = [v40 countByEnumeratingWithState:&v56 objects:v65 count:16];
    if (v42)
    {
      v41 = *v57;
      do
      {
        for (j = 0; j != v42; ++j)
        {
          if (*v57 != v41)
          {
            objc_enumerationMutation(v40);
          }

          compactLinkQualityEvents = [*(*(&v56 + 1) + 8 * j) compactLinkQualityEvents];
          v54 = 0u;
          v55 = 0u;
          v52 = 0u;
          v53 = 0u;
          v27 = compactLinkQualityEvents;
          v28 = [v27 countByEnumeratingWithState:&v52 objects:v64 count:16];
          if (v28)
          {
            v29 = *v53;
            do
            {
              for (k = 0; k != v28; ++k)
              {
                if (*v53 != v29)
                {
                  objc_enumerationMutation(v27);
                }

                v31 = *(*(&v52 + 1) + 8 * k);
                v32 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  selfCopy7 = v31;
                  _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "LinkEngine quality report event: %@", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                {
                  v34 = v31;
                  _IDSLogTransport(@"GL", @"IDS", @"LinkEngine quality report event: %@");
                  if (_IDSShouldLog())
                  {
                    v34 = v31;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"LinkEngine quality report event: %@");
                  }
                }

                [WeakRetained link:self didAddQREvent:{v31, v34}];
              }

              v28 = [v27 countByEnumeratingWithState:&v52 objects:v64 count:16];
            }

            while (v28);
          }
        }

        v42 = [v40 countByEnumeratingWithState:&v56 objects:v65 count:16];
      }

      while (v42);
    }

    [(IDSGlobalLink *)self _callDisconnectCompletionHandler:v39];
  }

  else if (v38)
  {
    v47[0] = MEMORY[0x1E69E9820];
    v47[1] = 3221225472;
    v47[2] = sub_1A7B84808;
    v47[3] = &unk_1E77E0DC8;
    v48 = v38;
    v49 = WeakRetained;
    selfCopy8 = self;
    v51 = v39;
    [(IDSLinksQualityMeasurer *)v48 removeAllLinksWithCompletionHandler:v47];
  }

  else
  {
    [(IDSGlobalLink *)self _callDisconnectCompletionHandler:v39];
  }
}

- (void)_reportAWDAllocateTime
{
  v21 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = _IDSLinkStateStrings[self->_state];
    *buf = 136315394;
    v18 = v4;
    v19 = 1024;
    _isExtIPDiscoveryDone = [(IDSGlobalLink *)self _isExtIPDiscoveryDone];
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v10 = _IDSLinkStateStrings[self->_state];
      _isExtIPDiscoveryDone2 = [(IDSGlobalLink *)self _isExtIPDiscoveryDone];
      _IDSLogTransport(@"GL", @"IDS", @"_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d");
      if (_IDSShouldLog())
      {
        [(IDSGlobalLink *)self _isExtIPDiscoveryDone:v10];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_reportAWDAllocateTime state:%s isExtIPDiscoveryDone:%d");
      }
    }
  }

  if (self->_state >= 2 && [(IDSGlobalLink *)self _isExtIPDiscoveryDone])
  {
    v14 = 0u;
    v15 = 0u;
    v12 = 0u;
    v13 = 0u;
    v5 = self->_allocateTimeReportBlocks;
    v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
    if (v6)
    {
      v7 = *v13;
      do
      {
        v8 = 0;
        do
        {
          if (*v13 != v7)
          {
            objc_enumerationMutation(v5);
          }

          (*(*(*(&v12 + 1) + 8 * v8++) + 16))();
        }

        while (v6 != v8);
        v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
      }

      while (v6);
    }

    allocateTimeReportBlocks = self->_allocateTimeReportBlocks;
    self->_allocateTimeReportBlocks = 0;
  }
}

- (void)_setFirstDefaultCandidatePair:(id)pair
{
  pairCopy = pair;
  v4 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (v4 && (!*v4 || !v4[1]))
  {
    [(IDSGlobalLink *)self _updateDefaultCandidatePair:pairCopy];
  }
}

- (id)_getAllocbindReportingDataBlob:(id)blob
{
  v16 = *MEMORY[0x1E69E9840];
  blobCopy = blob;
  bzero(v15, 0x5C0uLL);
  v8 = 0;
  if (StunUtilHasValidBinaryDataAttr(blobCopy, 65517, v15, &v8))
  {
    v4 = [MEMORY[0x1E695DEF0] dataWithBytes:v15 length:v8];
    v5 = [v4 base64EncodedStringWithOptions:0];
    if (v5)
    {
      v6 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109634;
        v10 = v8;
        v11 = 2112;
        v12 = v4;
        v13 = 2112;
        v14 = v5;
        _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "length: %d, receive reporting data blob [%@], base64Encoded: [%@],", buf, 0x1Cu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"length: %d, receive reporting data blob [%@], base64Encoded: [%@],");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"length: %d, receive reporting data blob [%@], base64Encoded: [%@],");
          }
        }
      }
    }
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (void)_notifyLinkEngineCandidatePairDidConnect:(id)connect
{
  connectCopy = connect;
  v5 = connectCopy;
  if (self->_useLinkEngine)
  {
    linkEngine = [connectCopy linkEngine];
    linkUniqueName = [v5 linkUniqueName];
    [linkEngine linkDidConnect:linkUniqueName];
  }

  if (self->_useLinkSelection)
  {
    linkUniqueName2 = [v5 linkUniqueName];

    if (linkUniqueName2)
    {
      linkEngine2 = [v5 linkEngine];
      testableLink = [v5 testableLink];
      linkUniqueName3 = [v5 linkUniqueName];
      [linkEngine2 setTestableLink:testableLink forLinkWithUniqueID:linkUniqueName3];

      linkEngine3 = [v5 linkEngine];
      linkUniqueName4 = [v5 linkUniqueName];
      v14 = [linkEngine3 packetQualityHandlerForLinkWithUniqueName:linkUniqueName4];
      [v5 setQualityHandler:v14];

      qualityHandler = [v5 qualityHandler];

      if (qualityHandler)
      {
        objc_initWeak(&location, self);
        objc_initWeak(&from, v5);
        v17 = MEMORY[0x1E69E9820];
        objc_copyWeak(&v18, &location);
        objc_copyWeak(&v19, &from);
        qualityHandler2 = [v5 qualityHandler];
        [qualityHandler2 setSyntheticPacketSender:&v17];

        objc_destroyWeak(&v19);
        objc_destroyWeak(&v18);
        objc_destroyWeak(&from);
        objc_destroyWeak(&location);
      }
    }
  }
}

- (BOOL)_processAllocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v138 = *MEMORY[0x1E69E9840];
  responseCopy = response;
  deviceCopy = device;
  key = token;
  *&v15 = 0xAAAAAAAAAAAAAAAALL;
  *(&v15 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[7] = v15;
  __str[6] = v15;
  __str[5] = v15;
  __str[4] = v15;
  __str[3] = v15;
  __str[2] = v15;
  __str[1] = v15;
  __str[0] = v15;
  v136[7] = v15;
  v136[6] = v15;
  v136[5] = v15;
  v136[4] = v15;
  v136[3] = v15;
  v136[2] = v15;
  v136[1] = v15;
  v136[0] = v15;
  v122 = 0;
  memset(__b, 170, sizeof(__b));
  v121 = 0;
  SAToIPPortString(__str, 0x80uLL, address);
  SAToIPPortString(v136, 0x80uLL, remmoteAddress);
  if (self->_allocbindEndTime == 0.0)
  {
    self->_allocbindEndTime = time;
  }

  type = [responseCopy type];
  v16 = @"allocbind";
  if (type != 4064)
  {
    v16 = @"realloc";
  }

  v106 = v16;
  Value = 0;
  if (key && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, key);
  }

  v18 = Value;
  state = [v18 state];
  local = [v18 local];
  v20 = [local transport] == 2;

  metricsCollector = self->_metricsCollector;
  if (v20)
  {
    [(IDSGFTMetricsCollector *)metricsCollector stunAllocbindResponse];
    v22 = GLUtilConnectionDictionaryForUDPCandidatePair(v18, 1);
    v23 = @"udp";
  }

  else
  {
    [(IDSGFTMetricsCollector *)metricsCollector tcpAllocbindResponse];
    v22 = GLUtilConnectionDictionaryForTCPCandidatePair(v18, 1);
    v23 = @"tcp";
  }

  connections = [v18 connections];
  [connections setObject:v22 forKeyedSubscript:@"qr"];

  linkMetrics = [v18 linkMetrics];
  [linkMetrics receiveAllocbindResponse];

  [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v18];
  [(IDSGFTMetricsCollector *)self->_metricsCollector allocbindResponseForProtocolStack:v23];
  v119 = 0u;
  v120 = 0u;
  v118 = 0u;
  v117 = 0u;
  v26 = self->_interfaceAddressArray;
  v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v117 objects:v134 count:16];
  if (v27)
  {
    v28 = *v118;
    while (2)
    {
      for (i = 0; i != v27; ++i)
      {
        if (*v118 != v28)
        {
          objc_enumerationMutation(v26);
        }

        v30 = *(*(&v117 + 1) + 8 * i);
        if ([v30 index] == index)
        {
          v31 = self->_metricsCollector;
          name = [v30 name];
          [(IDSGFTMetricsCollector *)v31 allocbindResponseFromInterface:name];

          goto LABEL_21;
        }
      }

      v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v117 objects:v134 count:16];
      if (v27)
      {
        continue;
      }

      break;
    }
  }

LABEL_21:

  local2 = [v18 local];
  address = [local2 address];

  v35 = *(address + 1);
  if (v35 == 2)
  {
    if (IMGetDomainBoolForKey())
    {
LABEL_24:
      v36 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
      {
        if (*(address + 1) == 30)
        {
          v37 = "IPv6";
        }

        else
        {
          v37 = "IPv4";
        }

        *buf = 136315138;
        *&buf[4] = v37;
        _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "_processAllocbindResponse: force dropping [%s] stun allocbind response.", buf, 0xCu);
      }

      goto LABEL_89;
    }
  }

  else if (v35 == 30 && (IMGetDomainBoolForKey() & 1) != 0)
  {
    goto LABEL_24;
  }

  if (self->_state >= 5 && ([v18 pendingNoSessionStateAllocbind] & 1) == 0)
  {
    v74 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
    {
      v75 = (&_IDSStunCandidatePairStateStrings)[state];
      pendingNoSessionStateAllocbind = [v18 pendingNoSessionStateAllocbind];
      v77 = @"NO";
      *buf = 136315650;
      *&buf[4] = v75;
      *&buf[12] = 2112;
      if (pendingNoSessionStateAllocbind)
      {
        v77 = @"YES";
      }

      *&buf[14] = v77;
      *&buf[22] = 2112;
      *&buf[24] = v106;
      _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "_processAllocbindResponse: candidate pair state is [%s], pendingNoSessionStateAllocbind: %@, ignore %@ response.", buf, 0x20u);
    }

    goto LABEL_84;
  }

  if (state > 2)
  {
    if ([v18 pendingNoSessionStateAllocbind])
    {
      goto LABEL_41;
    }

    v74 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
    {
      v78 = (&_IDSStunCandidatePairStateStrings)[state];
      *buf = 136315394;
      *&buf[4] = v78;
      *&buf[12] = 2112;
      *&buf[14] = v106;
      _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "candidate pair state is [%s], ignore %@ response.", buf, 0x16u);
    }

LABEL_84:

    goto LABEL_85;
  }

  allocbindStartTime = self->_allocbindStartTime;
  allocbindEndTime = self->_allocbindEndTime;
  v40 = +[IDSFoundationLog GlobalLink];
  v41 = (allocbindEndTime - allocbindStartTime) * 1000.0;
  if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
  {
    local3 = [v18 local];
    transport = [local3 transport];
    v44 = *(address + 1);
    idsSessionID = self->_idsSessionID;
    sessionID = [v18 sessionID];
    *buf = 138413826;
    *&buf[4] = v106;
    *&buf[12] = 2112;
    *&buf[14] = key;
    *&buf[22] = 2048;
    *&buf[24] = v41;
    LOWORD(v129) = 2048;
    *(&v129 + 2) = transport;
    WORD5(v129) = 1024;
    HIDWORD(v129) = v44;
    *v130 = 2112;
    *&v130[2] = idsSessionID;
    *&v130[10] = 2112;
    *&v130[12] = sessionID;
    _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "Received %@ response on %@ after %0.6lf ms over protocol: %ld family: %d IDSSessionID: %@ QRSessionID: %@", buf, 0x44u);
  }

  GLUtilReportAWDStunMessageEvent(responseCopy, 0, v18, v41);
  v47 = [(IDSGlobalLink *)self _getAllocbindReportingDataBlob:responseCopy];
  local4 = [v18 local];
  [local4 setAllocbindDataBlob:v47];

  v49 = GLUCreateQRStunMessageEvent(responseCopy, 0, v18, self->_timeBase, v41);
  if (v49)
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v51 = objc_opt_respondsToSelector();

    if (v51)
    {
      v52 = objc_loadWeakRetained(&self->_delegate);
      [v52 link:self didAddQREvent:v49];
    }
  }

LABEL_41:
  *&v53 = 0xAAAAAAAAAAAAAAAALL;
  *(&v53 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v132 = v53;
  v133 = v53;
  *&v130[16] = v53;
  v131 = v53;
  v129 = v53;
  *v130 = v53;
  *buf = v53;
  *&buf[16] = v53;
  if ((StunUtilHasValidXorMappedAddress(responseCopy, buf) & 1) == 0)
  {
    v72 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
    {
      v73 = SAToIPPortString(__str, 0x80uLL, buf);
      *v124 = 138412546;
      *v125 = v106;
      *&v125[8] = 2080;
      *v126 = v73;
      _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive %@ response with invalid xor-mapped-address [%s]", v124, 0x16u);
    }

    goto LABEL_88;
  }

  local5 = [v18 local];
  [local5 setExternal:buf];

  if ((StunUtilHasValidChannelNumber(responseCopy, [v18 channelNumber], &v122) & 1) == 0)
  {
    v72 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
    {
      *v124 = 138412290;
      *v125 = v106;
      _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive %@ response without channel-number.", v124, 0xCu);
    }

LABEL_88:

LABEL_89:
    v79 = 0;
    goto LABEL_90;
  }

  v55 = v122;
  v56 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
  {
    channelNumber = [v18 channelNumber];
    *v124 = 67109634;
    *v125 = channelNumber;
    *&v125[4] = 1024;
    *&v125[6] = v122;
    *v126 = 2112;
    *&v126[2] = key;
    _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "update channelNumber (%04x->%04x) for %@.", v124, 0x18u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      channelNumber2 = [v18 channelNumber];
      v98 = v122;
      v100 = key;
      v96 = channelNumber2;
      _IDSLogTransport(@"GL", @"IDS", @"update channelNumber (%04x->%04x) for %@.");
      if (_IDSShouldLog())
      {
        channelNumber3 = [v18 channelNumber];
        v98 = v122;
        v100 = key;
        v96 = channelNumber3;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update channelNumber (%04x->%04x) for %@.");
      }
    }
  }

  v60 = bswap32(v55) >> 16;
  [v18 setChannelNumber:{v60, v96, v98, v100}];
  IDSSimpleUInt16List_AddItem(&self->_channelNumberList, v60);
  [(IDSGlobalLink *)self _setChannelToCandidatePair:v18 localAddress:address remoteAddress:remmoteAddress channelNumber:v60];
  if (StunUtilHasValidBinaryDataAttr(responseCopy, 32802, __b, &v121))
  {
    v61 = objc_alloc(MEMORY[0x1E696AEC0]);
    v62 = [v61 initWithBytes:__b length:v121 encoding:4];
    v63 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
    {
      *v124 = 138412290;
      *v125 = v62;
      _os_log_impl(&dword_1A7AD9000, v63, OS_LOG_TYPE_DEFAULT, "receive software attribute [%@]", v124, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v97 = v62;
        _IDSLogTransport(@"GL", @"IDS", @"receive software attribute [%@]");
        if (_IDSShouldLog())
        {
          v97 = v62;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive software attribute [%@]");
        }
      }
    }
  }

  if (StunUtilHasValidUInt16Attr(responseCopy, 65509, &v122))
  {
    [v18 setRelayLinkID:v122];
  }

  if (state > 2)
  {
    goto LABEL_127;
  }

  [v18 setState:3];
  [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v18];
  v64 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v64, OS_LOG_TYPE_DEFAULT))
  {
    v65 = (&_IDSStunCandidatePairStateStrings)[state];
    *v124 = 136315650;
    *v125 = v65;
    *&v125[8] = 2080;
    *v126 = off_1EB2B43C0;
    *&v126[8] = 2112;
    v127 = key;
    _os_log_impl(&dword_1A7AD9000, v64, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", v124, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v99 = off_1EB2B43C0;
      v101 = key;
      v97 = (&_IDSStunCandidatePairStateStrings)[state];
      _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
      if (_IDSShouldLog())
      {
        v99 = off_1EB2B43C0;
        v101 = key;
        v97 = (&_IDSStunCandidatePairStateStrings)[state];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
      }
    }
  }

  if (self->_QUICForQREnabled)
  {
    [(IDSNWLink *)self->_nwLink setConnectedToQR:1];
  }

  if ([v18 relayProviderType] == 1)
  {
    [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0];
  }

  linkEngine = [v18 linkEngine];

  if (linkEngine)
  {
    linkEngine2 = [v18 linkEngine];
    linkUniqueName = [v18 linkUniqueName];
    v69 = [linkEngine2 isLinkConnecting:linkUniqueName];

    if ((v69 & 1) == 0)
    {
      v70 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
      {
        linkUniqueName2 = [v18 linkUniqueName];
        *v124 = 138412546;
        *v125 = linkUniqueName2;
        *&v125[8] = 2112;
        *v126 = v18;
        _os_log_impl(&dword_1A7AD9000, v70, OS_LOG_TYPE_DEFAULT, "Link Engine link no longer connecting: %@, disconnect candidate pair %@", v124, 0x16u);
      }

LABEL_132:

      v94 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
      {
        *v124 = 138412290;
        *v125 = v18;
        _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, "Disconnecting %@", v124, 0xCu);
      }

      candidatePairToken = [v18 candidatePairToken];
      [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken stunMessage:0 reason:8];

      goto LABEL_85;
    }
  }

  else if ([v18 isRelayStunCandidatePair] && !(objc_msgSend(v18, "isSharedQRSession") & 1 | (type != 4064)))
  {
    sessionID2 = [v18 sessionID];
    v82 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:sessionID2 inState:4];

    v115 = 0u;
    v116 = 0u;
    v113 = 0u;
    v114 = 0u;
    v70 = v82;
    v83 = [v70 countByEnumeratingWithState:&v113 objects:v123 count:16];
    if (v83)
    {
      v84 = *v114;
      while (2)
      {
        for (j = 0; j != v83; ++j)
        {
          if (*v114 != v84)
          {
            objc_enumerationMutation(v70);
          }

          v86 = *(*(&v113 + 1) + 8 * j);
          if (v86 != v18)
          {
            v92 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v92, OS_LOG_TYPE_DEFAULT))
            {
              sessionID3 = [v18 sessionID];
              *v124 = 138412802;
              *v125 = v86;
              *&v125[8] = 2112;
              *v126 = sessionID3;
              *&v126[8] = 2112;
              v127 = v18;
              _os_log_impl(&dword_1A7AD9000, v92, OS_LOG_TYPE_DEFAULT, "Found another connected candidate pair %@ with the same QRSessionID %@ disconnecting %@", v124, 0x20u);
            }

            goto LABEL_132;
          }
        }

        v83 = [v70 countByEnumeratingWithState:&v113 objects:v123 count:16];
        if (v83)
        {
          continue;
        }

        break;
      }
    }
  }

  [(IDSGlobalLink *)self _setFirstDefaultCandidatePair:v18];
  if (type == 4064)
  {
    [(IDSGlobalLink *)self _processXORMappedAddress:v18 arrivalTime:time];
    if ([v18 allocateType] == 2)
    {
      goto LABEL_85;
    }
  }

  else
  {
    if (([v18 hbStarted] & 1) == 0)
    {
      v87 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v87, OS_LOG_TYPE_DEFAULT))
      {
        pendingRealloc = [v18 pendingRealloc];
        v89 = @"NO";
        if (pendingRealloc)
        {
          v89 = @"YES";
        }

        *v124 = 138412290;
        *v125 = v89;
        _os_log_impl(&dword_1A7AD9000, v87, OS_LOG_TYPE_DEFAULT, "receive reallocate response, send HBR (%@).", v124, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
      {
        v90 = [v18 pendingRealloc] ? @"YES" : @"NO";
        v97 = v90;
        _IDSLogTransport(@"GL", @"IDS", @"receive reallocate response, send HBR (%@).");
        if (_IDSShouldLog())
        {
          if ([v18 pendingRealloc])
          {
            v91 = @"YES";
          }

          else
          {
            v91 = @"NO";
          }

          v97 = v91;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive reallocate response, send HBR (%@).");
        }
      }

      [(IDSGlobalLink *)self _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:key, v97];
      [v18 setHbStarted:1];
    }

    if (([v18 isSharedQRSession] & 1) == 0)
    {
      goto LABEL_85;
    }
  }

  if (![(IDSGlobalLink *)self _postProcessAllocbindResponse:responseCopy candidatePair:v18 candidatePairToken:key])
  {
    if (self->_delaySessionConnected)
    {
      if (!self->_isInitiator)
      {
        v109[0] = MEMORY[0x1E69E9820];
        v109[1] = 3221225472;
        v109[2] = sub_1A7B867A0;
        v109[3] = &unk_1E77E0E18;
        v110 = v18;
        selfCopy = self;
        v112 = key;
        [v110 startSessionConnectedTimer:30 block:v109];
      }
    }

    else
    {
      [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:key];
    }

LABEL_127:
    if ([v18 pendingNoSessionStateAllocbind])
    {
      [v18 setPendingNoSessionState:0];
    }
  }

LABEL_85:
  v79 = 1;
LABEL_90:

  return v79;
}

- (BOOL)_processUnallocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v109 = *MEMORY[0x1E69E9840];
  responseCopy = response;
  deviceCopy = device;
  tokenCopy = token;
  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[6] = v17;
  __str[7] = v17;
  __str[4] = v17;
  __str[5] = v17;
  __str[2] = v17;
  __str[3] = v17;
  __str[0] = v17;
  __str[1] = v17;
  v107[6] = v17;
  v107[7] = v17;
  v107[4] = v17;
  v107[5] = v17;
  v107[2] = v17;
  v107[3] = v17;
  v107[0] = v17;
  v107[1] = v17;
  memset(__b, 170, sizeof(__b));
  v93 = 0;
  SAToIPPortString(__str, 0x80uLL, address);
  SAToIPPortString(v107, 0x80uLL, remmoteAddress);
  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v19 = Value;
  state = [v19 state];
  if ([v19 relayProviderType] == 1)
  {
    if (StunUtilHasValidBinaryDataAttr(responseCopy, 65521, __b, &v93))
    {
      v20 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:__b];
      uUIDString = [v20 UUIDString];
      sessionID = [v19 sessionID];
      v23 = [uUIDString isEqualToString:sessionID];

      if (v23)
      {

        goto LABEL_9;
      }

      v56 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
      {
        sessionID2 = [v19 sessionID];
        *buf = 138412546;
        prots = uUIDString;
        v96 = 2112;
        v97 = sessionID2;
        _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with mismatched session-id %@ for %@.", buf, 0x16u);
      }
    }

    else
    {
      v25 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        sessionID3 = [v19 sessionID];
        *buf = 138412290;
        prots = sessionID3;
        _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with invalid session-id for %@.", buf, 0xCu);
      }
    }
  }

  else
  {
    v92 = 0;
    if (StunUtilHasValidChannelNumber(responseCopy, [v19 channelNumber], &v92))
    {
LABEL_9:
      if (state == 6)
      {
        v24 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315138;
          prots = OBJC_PROTOCOL___IDSServerBagContentProvider.prots;
          _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive unallocbind response with state [%s], ignore.", buf, 0xCu);
        }

        goto LABEL_91;
      }

      requestID = [responseCopy requestID];
      [(IDSGlobalLink *)self _startTimeForStunRequest:requestID];
      v30 = v29;

      v31 = +[IDSFoundationLog GlobalLink];
      v32 = (time - v30) * 1000.0;
      if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
      {
        idsSessionID = self->_idsSessionID;
        sessionID4 = [v19 sessionID];
        local = [v19 local];
        transport = [local transport];
        local2 = [v19 local];
        v38 = *([local2 address] + 1);
        *buf = 138413570;
        prots = idsSessionID;
        v96 = 2112;
        v97 = sessionID4;
        v98 = 2112;
        v99 = tokenCopy;
        v100 = 2048;
        v101 = v32;
        v102 = 2048;
        v103 = transport;
        v104 = 1024;
        v105 = v38;
        _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "Received unallocbind response for IDSSessionID: %@ QRSessionID: %@ on %@ after %0.6lf ms over protocol: %ld family: %d", buf, 0x3Au);
      }

      v39 = v32;
      GLUtilReportAWDStunMessageEvent(responseCopy, 0, v19, v39);
      v40 = GLUCreateQRStunMessageEvent(responseCopy, 0, v19, self->_timeBase, v39);
      if (v40)
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v42 = objc_opt_respondsToSelector();

        if (v42)
        {
          v43 = objc_loadWeakRetained(&self->_delegate);
          [v43 link:self didAddQREvent:v40];
        }
      }

      if (self->_state > 3)
      {
        if (self->_unallocbindRequestToReason)
        {
          requestID2 = [responseCopy requestID];
          if (requestID2)
          {
            unallocbindRequestToReason = self->_unallocbindRequestToReason;
            requestID3 = [responseCopy requestID];
            unsignedIntValue = [CFDictionaryGetValue(unallocbindRequestToReason requestID3)];
          }

          else
          {
            unsignedIntValue = [0 unsignedIntValue];
          }
        }

        else
        {
          unsignedIntValue = [0 unsignedIntValue];
        }

        requestID4 = [responseCopy requestID];
        if (requestID4)
        {
          v69 = self->_unallocbindRequestToReason == 0;

          if (!v69)
          {
            v70 = self->_unallocbindRequestToReason;
            requestID5 = [responseCopy requestID];
            CFDictionaryRemoveValue(v70, requestID5);
          }
        }

        [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v19 withReason:unsignedIntValue];
        if (self->_isUPlusOneSession)
        {
          [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v19 withReason:unsignedIntValue];
        }

        v72 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
        v73 = v72;
        if (self->_state == 5)
        {
          [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
          if (!v73)
          {
            [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:unsignedIntValue];
          }
        }

        else if (!v72 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
        {
          v74 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
              }
            }
          }

          [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
        }

        goto LABEL_83;
      }

      [v19 setState:6];
      if (self->_useLinkEngine)
      {
        linkEngine = [v19 linkEngine];
        linkUniqueName = [v19 linkUniqueName];
        [linkEngine linkDidDisconnect:linkUniqueName];
      }

      v46 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        v47 = (&_IDSStunCandidatePairStateStrings)[state];
        *buf = 136315650;
        prots = v47;
        v96 = 2080;
        v97 = off_1EB2B43D8;
        v98 = 2112;
        v99 = tokenCopy;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v83 = off_1EB2B43D8;
          v85 = tokenCopy;
          v80 = (&_IDSStunCandidatePairStateStrings)[state];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v83 = off_1EB2B43D8;
            v85 = tokenCopy;
            v80 = (&_IDSStunCandidatePairStateStrings)[state];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0, v80, v83, v85])
      {
LABEL_83:
        if ([v19 pendingNoSessionStateAllocbind])
        {
          [v19 setState:1];
          v77 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
          {
            v78 = (&_IDSStunCandidatePairStateStrings)[state];
            *buf = 136315650;
            prots = v78;
            v96 = 2080;
            v97 = off_1EB2B43B0;
            v98 = 2112;
            v99 = tokenCopy;
            _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.", buf, 0x20u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
              }
            }
          }
        }

        goto LABEL_90;
      }

      v86 = _Block_copy(self->_connectReadyHandler);
      v48 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v48, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        prots = self;
        _os_log_impl(&dword_1A7AD9000, v48, OS_LOG_TYPE_DEFAULT, "failed to connect GlobalLink %@ due to session connected message timed out.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          selfCopy2 = self;
          _IDSLogTransport(@"GL", @"IDS", @"failed to connect GlobalLink %@ due to session connected message timed out.");
          if (_IDSShouldLog())
          {
            selfCopy2 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to connect GlobalLink %@ due to session connected message timed out.");
          }
        }
      }

      local3 = [v19 local];
      v50 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
      {
        v51 = (&_IDSStunTransportStrings)[[local3 transport]];
        *buf = 136315394;
        prots = v51;
        v96 = 1024;
        LODWORD(v97) = 22;
        _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v82 = (&_IDSStunTransportStrings)[[local3 transport]];
          v84 = 22;
          _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
          if (_IDSShouldLog())
          {
            v82 = (&_IDSStunTransportStrings)[[local3 transport]];
            v84 = 22;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
          }
        }
      }

      GLUtilReportAWDClientTimerEvent(305, 22, v19, self->_enableSKE, self->_isInitiator, 0.0);
      v52 = GLUCreateQRClientTimeEvent(305, 22, v19, self->_timeBase, 0.0);
      v53 = objc_loadWeakRetained(&self->_delegate);
      v54 = objc_opt_respondsToSelector();

      if (v54)
      {
        v55 = objc_loadWeakRetained(&self->_delegate);
        [v55 link:self didAddQREvent:v52];
      }

      if ([v19 isSelfQRSession])
      {

LABEL_90:
LABEL_91:
        v58 = 1;
        goto LABEL_92;
      }

      if (v86)
      {
        v63 = MEMORY[0x1E696ABC0];
        v64 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"SessionConnected message timed out." forKey:*MEMORY[0x1E696A578]];
        v65 = [v63 errorWithDomain:@"GlobalLink" code:9 userInfo:v64];

        v66 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B87718;
        block[3] = &unk_1E77DD0F0;
        v90 = v65;
        v91 = v86;
        v67 = v65;
        dispatch_async(v66, block);
      }

      else
      {
        v75 = objc_loadWeakRetained(&self->_delegate);
        v76 = objc_opt_respondsToSelector();

        if ((v76 & 1) == 0)
        {
LABEL_82:

          goto LABEL_83;
        }

        v67 = objc_loadWeakRetained(&self->_delegate);
        [v67 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
      }

      goto LABEL_82;
    }

    v27 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(prots) = v92;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "receive unallocbind response invalid channel-number %04x.", buf, 8u);
    }
  }

  v58 = 0;
LABEL_92:

  return v58;
}

- (BOOL)_processReallocIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  key = *&index;
  v155 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  deviceCopy = device;
  tokenCopy = token;
  *&v16 = 0xAAAAAAAAAAAAAAAALL;
  *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v153 = v16;
  v154 = v16;
  v151 = v16;
  v152 = v16;
  v149 = v16;
  v150 = v16;
  *__str = v16;
  v148 = v16;
  v146 = v16;
  v145 = v16;
  v144 = v16;
  v143 = v16;
  v142 = v16;
  v141 = v16;
  v140 = v16;
  *v139 = v16;
  memset(__b, 170, sizeof(__b));
  memset(v137, 0, sizeof(v137));
  SAToIPPortString(__str, 0x80uLL, address);
  SAToIPPortString(v139, 0x80uLL, remoteAddress);
  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *&buf[4] = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive realloc indication on %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v103 = tokenCopy;
      _IDSLogTransport(@"GL", @"IDS", @"receive realloc indication on %@");
      if (_IDSShouldLog())
      {
        v103 = tokenCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc indication on %@");
      }
    }
  }

  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v19 = Value;
  local = [v19 local];
  transport = [local transport];

  if ([indicationCopy getAttribute:65520 attribute:__b])
  {
    v122 = [MEMORY[0x1E695DEF0] dataWithBytes:&__b[3] length:__b[2]];
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v122;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive realloc token %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v103 = v122;
        _IDSLogTransport(@"GL", @"IDS", @"receive realloc token %@");
        if (_IDSShouldLog())
        {
          v103 = v122;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc token %@");
        }
      }
    }

    if (![indicationCopy getAttribute:22 attribute:{__b, v103}])
    {
      goto LABEL_35;
    }

    __memcpy_chk();
    v23 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = SAToIPPortString(v139, 0x80uLL, v137);
      *buf = 136315138;
      *&buf[4] = v24;
      _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive xor-relayed-address [%s].", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v104 = SAToIPPortString(v139, 0x80uLL, v137);
        _IDSLogTransport(@"GL", @"IDS", @"receive xor-relayed-address [%s].");
        if (_IDSShouldLog())
        {
          v104 = SAToIPPortString(v139, 0x80uLL, v137);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-relayed-address [%s].");
        }
      }
    }

    if ((transport - 3) <= 1)
    {
      if (transport == 3)
      {
        v25 = 80;
      }

      else
      {
        v25 = 443;
      }

      WORD1(v137[0]) = __rev16(v25);
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        v27 = SAToIPPortString(v139, 0x80uLL, v137);
        *buf = 134218242;
        *&buf[4] = transport;
        *&buf[12] = 2080;
        *&buf[14] = v27;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "stunTransport: %ld, xor-relayed-address [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v104 = transport;
          v108 = SAToIPPortString(v139, 0x80uLL, v137);
          _IDSLogTransport(@"GL", @"IDS", @"stunTransport: %ld, xor-relayed-address [%s].");
          if (_IDSShouldLog())
          {
            v104 = transport;
            v108 = SAToIPPortString(v139, 0x80uLL, v137);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"stunTransport: %ld, xor-relayed-address [%s].");
          }
        }
      }
    }

    if (IsValidSA(v137))
    {
LABEL_35:
      *&v28 = 0xAAAAAAAAAAAAAAAALL;
      *(&v28 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v135 = v28;
      v136 = v28;
      v133 = v28;
      v134 = v28;
      v131 = v28;
      v132 = v28;
      *buf = v28;
      *&buf[16] = v28;
      if (![indicationCopy getAttribute:32 attribute:{__b, v104, v108}])
      {
        goto LABEL_43;
      }

      __memcpy_chk();
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *v123 = 136315138;
        *&v123[4] = SAToIPPortString(v139, 0x80uLL, buf);
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "receive xor-mapped-address [%s].", v123, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v105 = SAToIPPortString(v139, 0x80uLL, buf);
          _IDSLogTransport(@"GL", @"IDS", @"receive xor-mapped-address [%s].");
          if (_IDSShouldLog())
          {
            v105 = SAToIPPortString(v139, 0x80uLL, buf);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-mapped-address [%s].");
          }
        }
      }

      if (!IsValidSA(buf))
      {
        v44 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
        {
          *v123 = 0;
          _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_ERROR, "invalid xor-mapped-address.", v123, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          _IDSWarnV();
          _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid xor-mapped-address.");
          _IDSLogTransport(@"Warning", @"IDS", @"invalid xor-mapped-address.");
        }

        GLUtilReportAWDStunMessageEvent(indicationCopy, 4, v19, 0.0);
        sessionID = GLUCreateQRStunMessageEvent(indicationCopy, 4u, v19, 0, 0.0);
        if (!sessionID)
        {
          goto LABEL_102;
        }

        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v46 = objc_opt_respondsToSelector();

        if ((v46 & 1) == 0)
        {
          goto LABEL_102;
        }
      }

      else
      {
LABEL_43:
        if (![indicationCopy getAttribute:12 attribute:{__b, v105}])
        {
          goto LABEL_51;
        }

        if (bswap32(HIWORD(__b[2])) >> 16 == [v19 channelNumber])
        {
          v30 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
          {
            *v123 = 67109120;
            *&v123[4] = HIWORD(__b[2]);
            _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "receive channel-number [%04x].", v123, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v106 = HIWORD(__b[2]);
              _IDSLogTransport(@"GL", @"IDS", @"receive channel-number [%04x].");
              if (_IDSShouldLog())
              {
                v106 = HIWORD(__b[2]);
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive channel-number [%04x].");
              }
            }
          }

LABEL_51:
          sessionID = [v19 sessionID];
          if (sessionID)
          {
            if (self->_useLinkEngine)
            {
              linkEngine = [v19 linkEngine];
              v116 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:sessionID];
              if (v116 && linkEngine)
              {
                v128 = 0u;
                v129 = 0u;
                v126 = 0u;
                v127 = 0u;
                v124 = 0u;
                v125 = 0u;
                memset(v123, 0, sizeof(v123));
                if (BYTE1(v137[0]) == 30)
                {
                  v32 = v123;
                }

                else
                {
                  v32 = v137;
                }

                if (BYTE1(v137[0]) == 30)
                {
                  v33 = v137;
                }

                else
                {
                  v33 = v123;
                }

                [v116 setServerAddress:v32];
                [v116 setServerAddressV6:v33];
                [v116 setHasReceivedReallocIndication:1];
                [v116 setSessionToken:v122];
                [(IDSGlobalLink *)self _updateLinksForSession:v116];
              }

              else
              {
                v59 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
                {
                  *v123 = 0;
                  _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "failed to process QUIC Realloc indication: no session or linkengine", v123, 2u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"failed to process QUIC Realloc indication: no session or linkengine");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process QUIC Realloc indication: no session or linkengine");
                    }
                  }
                }
              }

LABEL_164:

              GLUtilReportAWDStunMessageEvent(indicationCopy, 0, v19, 0.0);
              linkEngine = GLUCreateQRStunMessageEvent(indicationCopy, 0, v19, 0, 0.0);
              if (linkEngine)
              {
                v98 = objc_loadWeakRetained(&self->_delegate);
                v99 = objc_opt_respondsToSelector();

                if (v99)
                {
                  v100 = objc_loadWeakRetained(&self->_delegate);
                  [v100 link:self didAddQREvent:linkEngine];
                }
              }

              [(IDSGFTMetricsCollector *)self->_metricsCollector hasRealloc];
              v43 = 1;
              goto LABEL_176;
            }

            if (self->_H2FallbackEnabled)
            {
              if (transport == 4)
              {
                v54 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
                {
                  tcpLink = self->_tcpLink;
                  *v123 = 138412290;
                  *&v123[4] = tcpLink;
                  _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: H2 enabled Use tcpLink: %@", v123, 0xCu);
                }

                [(IDSTCPLink *)self->_tcpLink connect:key localAddress:address portRange:LOWORD(self->_portRange) remoteAddress:v137 clientUUID:self->_clientUUID completionHandler:0];
              }
            }

            else
            {
              if (transport == 4)
              {
                v60 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
                {
                  tcpSSLLink = self->_tcpSSLLink;
                  *v123 = 138412290;
                  *&v123[4] = tcpSSLLink;
                  _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: Use sslLink: %@", v123, 0xCu);
                }

                v56 = self->_tcpSSLLink;
              }

              else if (transport == 3)
              {
                v56 = self->_tcpLink;
                v57 = +[IDSFoundationLog GlobalLink];
                if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
                {
                  v58 = self->_tcpLink;
                  *v123 = 138412290;
                  *&v123[4] = v58;
                  _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "_processReallocIndication: Use tcpLink: %@", v123, 0xCu);
                }
              }

              else
              {
                v56 = 0;
              }

              [(IDSTCPLink *)v56 connect:key localAddress:address portRange:LOWORD(self->_portRange) remoteAddress:v137 clientUUID:self->_clientUUID completionHandler:0];
            }

            local2 = [v19 local];
            radioAccessTechnology = [local2 radioAccessTechnology];

            remote = [v19 remote];
            radioAccessTechnology2 = [remote radioAccessTechnology];

            local3 = [v19 local];
            v66 = [local3 mtu];

            remote2 = [v19 remote];
            v68 = [remote2 mtu];

            v113 = transport - 3;
            if ((transport - 3) > 1)
            {
              linkEngine = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:radioAccessTechnology mtu:v66 index:key address:address external:0];
              transport = 2;
            }

            else
            {
              linkEngine = [IDSStunCandidate candidateWithType:3 transport:transport radioAccessTechnology:radioAccessTechnology mtu:v66 index:key address:address external:buf];
            }

            v116 = [IDSStunCandidate candidateWithType:3 transport:transport radioAccessTechnology:radioAccessTechnology2 mtu:v68 index:0xFFFFFFFFLL address:0 external:v137];
            v115 = [IDSStunCandidatePair candidatePairWithLocalCandidate:linkEngine remoteCandidate:v116 sessionID:sessionID delegate:self];
            if (address->sa_family != 30 || BYTE1(v137[0]) != 2)
            {
LABEL_131:
              keya = [v115 candidatePairToken];
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              if (tokenToCandidatePairs && keya && (v72 = CFDictionaryGetValue(tokenToCandidatePairs, keya)) != 0)
              {
                v73 = v72;
                v74 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
                {
                  *v123 = 138412290;
                  *&v123[4] = keya;
                  _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "found existing candidate pair for %@.", v123, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v107 = keya;
                    _IDSLogTransport(@"GL", @"IDS", @"found existing candidate pair for %@.");
                    if (_IDSShouldLog())
                    {
                      v107 = keya;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"found existing candidate pair for %@.");
                    }
                  }
                }
              }

              else
              {
                channelNumber = [v19 channelNumber];
                IDSSimpleUInt16List_AddItem(&self->_reallocChannelList, channelNumber);
                v75 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
                {
                  v76 = [v122 length];
                  relaySessionKey = [v19 relaySessionKey];
                  v78 = [relaySessionKey length];
                  channelNumber2 = [v19 channelNumber];
                  *v123 = 138413314;
                  *&v123[4] = v19;
                  *&v123[12] = 2048;
                  *&v123[14] = v76;
                  *&v123[22] = 2048;
                  *&v123[24] = v78;
                  LOWORD(v124) = 1024;
                  *(&v124 + 2) = __rev16(channelNumber);
                  WORD3(v124) = 1024;
                  DWORD2(v124) = channelNumber2;
                  _os_log_impl(&dword_1A7AD9000, v75, OS_LOG_TYPE_DEFAULT, "start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).", v123, 0x2Cu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v80 = [v122 length];
                    relaySessionKey2 = [v19 relaySessionKey];
                    v82 = [relaySessionKey2 length];
                    v83 = __rev16(channelNumber);
                    v111 = v83;
                    channelNumber3 = [v19 channelNumber];
                    v109 = v80;
                    v110 = v82;
                    v107 = v19;
                    _IDSLogTransport(@"GL", @"IDS", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");

                    if (_IDSShouldLog())
                    {
                      v84 = [v122 length];
                      relaySessionKey3 = [v19 relaySessionKey];
                      v86 = [relaySessionKey3 length];
                      v111 = v83;
                      channelNumber3 = [v19 channelNumber];
                      v109 = v84;
                      v110 = v86;
                      v107 = v19;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");
                    }
                  }
                }

                v87 = v115;
                if (v113 <= 1)
                {
                  [v87 setChannelNumber:{objc_msgSend(v19, "channelNumber")}];
                }

                [v87 setPropertiesWithReallocCandidatePair:v19 reallocToken:{v122, v107, v109, v110, v111, channelNumber3}];
                remote3 = [v87 remote];
                -[IDSGlobalLink _setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:](self, "_setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:", v87, address, [remote3 external], channelNumber);

                if (!self->_tokenToCandidatePairs)
                {
                  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                  v90 = self->_tokenToCandidatePairs;
                  self->_tokenToCandidatePairs = Mutable;
                }

                v73 = v87;
                if (v73)
                {
                  CFDictionarySetValue(self->_tokenToCandidatePairs, keya, v73);
                }

                else
                {
                  v91 = MEMORY[0x1E69E9C10];
                  v92 = MEMORY[0x1E69E9C10];
                  if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
                  {
                    sub_1A7E1498C();
                  }
                }
              }

              [v73 setIsRealloc:{1, v107}];
              [(IDSGlobalLink *)self _sendAllocbindRequest:keya stunMessage:0 isRealloc:1 inResponseToNoSessionState:0];
              if (!self->_reallocNewCandidatePairToOldCandidatePair)
              {
                v93 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
                self->_reallocNewCandidatePairToOldCandidatePair = v93;
              }

              v95 = v19;
              if (v95)
              {
                CFDictionarySetValue(self->_reallocNewCandidatePairToOldCandidatePair, keya, v95);
              }

              else
              {
                v96 = MEMORY[0x1E69E9C10];
                v97 = MEMORY[0x1E69E9C10];
                if (os_log_type_enabled(v96, OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E14BA4();
                }
              }

              goto LABEL_164;
            }

            FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, key);
            if (FirstPrefix)
            {
              local4 = [v115 local];
              [local4 setPrefix:FirstPrefix];

              [v115 synthesizeNat64WithPrefix];
              goto LABEL_131;
            }

            v101 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
            {
              *v123 = 67109120;
              *&v123[4] = key;
              _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "failed to get nat64 prefix for realloc (if:%d).", v123, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to get nat64 prefix for realloc (if:%d).");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get nat64 prefix for realloc (if:%d).");
                }
              }
            }
          }

          else
          {
            v47 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
            {
              *v123 = 138412290;
              *&v123[4] = tokenCopy;
              _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@.", v123, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@.");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@.");
                }
              }
            }

            GLUtilReportAWDStunMessageEvent(indicationCopy, 6, v19, 0.0);
            linkEngine = GLUCreateQRStunMessageEvent(indicationCopy, 6u, v19, 0, 0.0);
            if (linkEngine)
            {
              v48 = objc_loadWeakRetained(&self->_delegate);
              v49 = objc_opt_respondsToSelector();

              if (v49)
              {
                v50 = objc_loadWeakRetained(&self->_delegate);
                [v50 link:self didAddQREvent:linkEngine];
              }
            }
          }

LABEL_175:
          v43 = 0;
LABEL_176:

          goto LABEL_177;
        }

        v51 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
        {
          *v123 = 0;
          _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "channel-number mismatch in realloc indication.", v123, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"channel-number mismatch in realloc indication.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"channel-number mismatch in realloc indication.");
            }
          }
        }

        GLUtilReportAWDStunMessageEvent(indicationCopy, 5, v19, 0.0);
        sessionID = GLUCreateQRStunMessageEvent(indicationCopy, 5u, v19, 0, 0.0);
        if (!sessionID || (v52 = objc_loadWeakRetained(&self->_delegate), v53 = objc_opt_respondsToSelector(), v52, (v53 & 1) == 0))
        {
LABEL_102:
          v43 = 0;
LABEL_177:

          goto LABEL_178;
        }
      }

      linkEngine = objc_loadWeakRetained(&self->_delegate);
      [linkEngine link:self didAddQREvent:sessionID];
      goto LABEL_175;
    }

    v38 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_ERROR, "invalid realloc server address.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid realloc server address.");
      _IDSLogTransport(@"Warning", @"IDS", @"invalid realloc server address.");
    }

    GLUtilReportAWDStunMessageEvent(indicationCopy, 3, v19, 0.0);
    v39 = GLUCreateQRStunMessageEvent(indicationCopy, 3u, v19, 0, 0.0);
    if (v39)
    {
      v40 = objc_loadWeakRetained(&self->_delegate);
      v41 = objc_opt_respondsToSelector();

      if (v41)
      {
        v42 = objc_loadWeakRetained(&self->_delegate);
        [v42 link:self didAddQREvent:v39];
      }
    }
  }

  else
  {
    v34 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_ERROR, "failed to receive realloc token.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"failed to receive realloc token.");
      _IDSLogTransport(@"Warning", @"IDS", @"failed to receive realloc token.");
    }

    GLUtilReportAWDStunMessageEvent(indicationCopy, 2, v19, 0.0);
    v122 = GLUCreateQRStunMessageEvent(indicationCopy, 2u, v19, 0, 0.0);
    if (v122)
    {
      v35 = objc_loadWeakRetained(&self->_delegate);
      v36 = objc_opt_respondsToSelector();

      if (v36)
      {
        v37 = objc_loadWeakRetained(&self->_delegate);
        [v37 link:self didAddQREvent:v122];
      }
    }
  }

  v43 = 0;
LABEL_178:

  return v43;
}

- (BOOL)_processDataIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v22 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  deviceCopy = device;
  tokenCopy = token;
  memset(__b, 170, sizeof(__b));
  if ([indicationCopy getAttribute:19 attribute:__b])
  {
    memset(v20, 170, 0x5D0uLL);
    if ([indicationCopy getAttribute:65509 attribute:v20])
    {
      v16 = v20[4];
    }

    else
    {
      v16 = 0;
    }

    v17 = [(IDSGlobalLink *)self _processIncomingIndicationData:&__b[3] length:__b[2] candidatePairToken:tokenCopy arrivalTime:v16 remoteRelayLinkID:time];
  }

  else
  {
    v18 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v20[0] = 0;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_ERROR, "receive invalid data indication.", v20, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      _IDSWarnV();
      _IDSLogV(0, @"IDSFoundation", @"Warning", @"receive invalid data indication.");
      _IDSLogTransport(@"Warning", @"IDS", @"receive invalid data indication.");
    }

    v17 = 0;
  }

  return v17;
}

- (BOOL)_processDiagnosticIndication:(id)indication candidatePairToken:(id)token arrivalTime:(double)time
{
  v28 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  tokenCopy = token;
  mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
  isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

  if (!isInternalInstall)
  {
    v17 = 1;
    goto LABEL_25;
  }

  memset(__b, 170, sizeof(__b));
  v24 = 0;
  v23 = 0;
  if (!StunUtilHasValidBinaryDataAttr(indicationCopy, 65514, __b, &v24))
  {
    v18 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_ERROR, "receive invalid subtype indication.", buf, 2u);
    }

    v12 = 0;
    if ((os_log_shim_legacy_logging_enabled() & 1) == 0)
    {
      goto LABEL_24;
    }

    v19 = @"receive invalid subtype indication.";
    goto LABEL_23;
  }

  v11 = objc_alloc(MEMORY[0x1E696AEC0]);
  v12 = [v11 initWithBytes:__b length:v24 encoding:4];
  v13 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v26 = v12;
    _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "receive subtype [%@]", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v22 = v12;
      _IDSLogTransport(@"GL", @"IDS", @"receive subtype [%@]");
      if (_IDSShouldLog())
      {
        v22 = v12;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive subtype [%@]");
      }
    }
  }

  if ((StunUtilHasValidBinaryDataAttr(indicationCopy, 65515, __b, &v24) & 1) == 0)
  {
    v20 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_ERROR, "receive invalid subtype context.", buf, 2u);
    }

    if ((os_log_shim_legacy_logging_enabled() & 1) == 0)
    {
      goto LABEL_24;
    }

    v19 = @"receive invalid subtype context.";
LABEL_23:
    _IDSWarnV();
    _IDSLogV(0, @"IDSFoundation", @"Warning", v19);
    _IDSLogTransport(@"Warning", @"IDS", v19);
LABEL_24:

    v17 = 0;
    goto LABEL_25;
  }

  v14 = objc_alloc(MEMORY[0x1E696AEC0]);
  v15 = [v14 initWithBytes:__b length:v24 encoding:4];
  if (StunUtilHasValidUInt16Attr(indicationCopy, 65516, &v23))
  {
    v16 = v23;
  }

  else
  {
    v16 = 0;
  }

  v17 = [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:tokenCopy subType:v12 subTypeContext:v15 duration:v16, v22];

LABEL_25:
  return v17;
}

- (BOOL)_triggerSymptomsWithCandidatePairToken:(id)token subType:(id)type subTypeContext:(id)context duration:(unsigned __int16)duration
{
  durationCopy = duration;
  v26[5] = *MEMORY[0x1E69E9840];
  tokenCopy = token;
  typeCopy = type;
  contextCopy = context;
  mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
  isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

  if (isInternalInstall)
  {
    Value = 0;
    if (tokenCopy && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
    }

    v25[0] = &unk_1F1B20060;
    v25[1] = &unk_1F1B20078;
    v26[0] = @"IDSQuickRelayTwoWay";
    v26[1] = @"IDSQuickRelaySelf";
    v25[2] = &unk_1F1B20090;
    v25[3] = &unk_1F1B200A8;
    v26[2] = @"IDSQuickRelayShared";
    v26[3] = @"IDSQuickRelayKeepAlive";
    v25[4] = &unk_1F1B200C0;
    v26[4] = @"IDSQuickRelayMax";
    v16 = MEMORY[0x1E695DF20];
    v17 = Value;
    v18 = [v16 dictionaryWithObjects:v26 forKeys:v25 count:5];
    v19 = MEMORY[0x1E696AD98];
    allocateType = [v17 allocateType];

    v21 = [v19 numberWithInteger:allocateType];
    v22 = [v18 objectForKey:v21];

    v23 = [(IDSGlobalLink *)self _triggerSymptomsWithType:v22 subType:typeCopy subTypeContext:contextCopy duration:durationCopy];
  }

  else
  {
    v23 = 1;
  }

  return v23;
}

- (BOOL)_triggerSymptomsWithType:(id)type subType:(id)subType subTypeContext:(id)context duration:(unsigned __int16)duration
{
  durationCopy = duration;
  v38[1] = *MEMORY[0x1E69E9840];
  typeCopy = type;
  subTypeCopy = subType;
  contextCopy = context;
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 1;
  mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
  isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

  if (isInternalInstall)
  {
    v14 = objc_alloc_init(CUTWeakLinkClass());
    v15 = [v14 signatureWithDomain:@"IDSQuickRelay" type:typeCopy subType:subTypeCopy subtypeContext:contextCopy detectedProcess:@"identityservicesd" triggerThresholdValues:0];
    if (durationCopy)
    {
      if (qword_1EB2BBCD0 != -1)
      {
        sub_1A7E14C20();
      }

      v37 = qword_1EB2BBCC0;
      v35 = qword_1EB2BBCC8;
      v16 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:durationCopy];
      v36 = v16;
      v17 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v36 forKeys:&v35 count:1];
      v38[0] = v17;
      v18 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v38 forKeys:&v37 count:1];
    }

    else
    {
      v18 = 0;
    }

    v19 = im_primary_queue();
    v25[0] = MEMORY[0x1E69E9820];
    v25[1] = 3221225472;
    v25[2] = sub_1A7B89AF4;
    v25[3] = &unk_1E77E0E60;
    v26 = v14;
    v27 = v15;
    v28 = v18;
    v29 = &v31;
    v30 = 0x402E000000000000;
    v20 = v18;
    v21 = v15;
    v22 = v14;
    dispatch_async(v19, v25);
  }

  v23 = *(v32 + 24);
  _Block_object_dispose(&v31, 8);

  return v23 & 1;
}

- (BOOL)_processGoAwayIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v64 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  deviceCopy = device;
  tokenCopy = token;
  memset(__b, 170, sizeof(__b));
  v41 = [indicationCopy getAttribute:9 attribute:__b];
  if (v41)
  {
    Value = 0;
    if (tokenCopy && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
    }

    v17 = Value;
    v18 = LOWORD(__b[3]) + 100 * LOWORD(__b[2]);
    v39 = v18;
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412802;
      v58 = tokenCopy;
      v59 = 1024;
      v60 = v18;
      v61 = 2080;
      v62 = &__b[4];
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive goaway indication for %@, error_code(%u) reason(%s).", buf, 0x1Cu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v37 = v18;
        v38 = &__b[4];
        v36 = tokenCopy;
        _IDSLogTransport(@"GL", @"IDS", @"receive goaway indication for %@, error_code(%u) reason(%s).");
        if (_IDSShouldLog())
        {
          v37 = v18;
          v38 = &__b[4];
          v36 = tokenCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive goaway indication for %@, error_code(%u) reason(%s).");
        }
      }
    }

    bzero(buf, 0x5C0uLL);
    v54 = 0;
    if (StunUtilHasValidBinaryDataAttr(indicationCopy, 65503, buf, &v54))
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *v55 = 67109120;
        v56 = v54;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "This goaway has QR Server data blob(%dB)", v55, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v36 = v54;
          _IDSLogTransport(@"GL", @"IDS", @"This goaway has QR Server data blob(%dB)");
          if (_IDSShouldLog())
          {
            v36 = v54;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"This goaway has QR Server data blob(%dB)");
          }
        }
      }

      if (v54 >= 1)
      {
        v21 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:?];
        v22 = MEMORY[0x1E695DF20];
        sessionID = [v17 sessionID];
        v24 = [v22 dictionaryWithObject:v21 forKey:sessionID];
        QRServerDataBlob = self->_QRServerDataBlob;
        self->_QRServerDataBlob = v24;
      }
    }

    sessionsByID = self->_sessionsByID;
    sessionID2 = [v17 sessionID];
    v28 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:sessionID2];

    if (self->_useLinkEngine)
    {
      if ([v28 isPendingDisconnect])
      {
LABEL_29:
        _getQRAllocateType = [(IDSGlobalLink *)self _getQRAllocateType];
        v32 = *&remoteAddress->sa_data[2];
        v33 = im_primary_queue();
        block[0] = MEMORY[0x1E69E9820];
        block[1] = 3221225472;
        block[2] = sub_1A7B8A79C;
        block[3] = &unk_1E77E0E88;
        v43 = v17;
        v44 = _getQRAllocateType;
        block[4] = self;
        timeCopy = time;
        v47 = v39;
        v46 = v32;
        v34 = v17;
        dispatch_async(v33, block);

        [(IDSGFTMetricsCollector *)self->_metricsCollector hasGoaway];
        goto LABEL_30;
      }

      [v28 willDisconnect];
      [(IDSGlobalLink *)self _updateLinksForSession:v28];
      v29 = v51;
      v51[0] = MEMORY[0x1E69E9820];
      v51[1] = 3221225472;
      v51[2] = sub_1A7B8A4C4;
      v51[3] = &unk_1E77E0C88;
      v52 = v28;
      selfCopy = self;
      [v52 startSessionGoAwayTimer:5 block:v51];
    }

    else
    {
      [v17 setIsDisconnecting:1];
      v29 = v48;
      v48[0] = MEMORY[0x1E69E9820];
      v48[1] = 3221225472;
      v48[2] = sub_1A7B8A59C;
      v48[3] = &unk_1E77E0E18;
      v48[4] = tokenCopy;
      v49 = v17;
      selfCopy2 = self;
      [v49 startSessionGoAwayTimer:5 block:v48];
    }

    goto LABEL_29;
  }

  v30 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_ERROR, "receive invalid goaway indication.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    _IDSWarnV();
    _IDSLogV(0, @"IDSFoundation", @"Warning", @"receive invalid goaway indication.");
    _IDSLogTransport(@"Warning", @"IDS", @"receive invalid goaway indication.");
  }

LABEL_30:

  return v41;
}

- (BOOL)_processStunPacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time headerOverhead:(unint64_t)overhead
{
  v109 = *MEMORY[0x1E69E9840];
  dCopy = d;
  cbuuidCopy = cbuuid;
  v14 = [[IDSStunMessage alloc] initWithType:0];
  if ([(IDSStunMessage *)v14 read:packet->var0 inputLength:SLODWORD(packet->var2) internal:0])
  {
    v15 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v106 = v14;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "receive stun message %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      v68 = v14;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"receive stun message %@.");
    }

    type = [(IDSStunMessage *)v14 type];
    requestID = [(IDSStunMessage *)v14 requestID];
    if (!requestID)
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "failed to get request-id for stun message.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to get request-id for stun message.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get request-id for stun message.");
          }
        }
      }

      goto LABEL_169;
    }

    [(IDSGlobalLink *)self _startTimeForStunRequest:requestID];
    [(IDSStunMessage *)v14 setStartTime:?];
    tokenToStunReqID = self->_tokenToStunReqID;
    if (tokenToStunReqID)
    {
      key = CFDictionaryGetValue(tokenToStunReqID, requestID);
      if (key)
      {
LABEL_49:
        if ((type & 0xFEFF) == 1)
        {
          if (self->_state == 4)
          {
            if (!self->_useSecureControlMessage)
            {
              v74 = 0;
              goto LABEL_107;
            }

            relaySessionKey = self->_controlMessageKey;
            v74 = 0;
LABEL_67:
            if (relaySessionKey)
            {
              v73 = relaySessionKey;
              if (![(IDSStunMessage *)v14 verifyMessageIntegrityWithKey:relaySessionKey inputBuffer:packet->var0 inputLength:LODWORD(packet->var2)])
              {
                v30 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109378;
                  *v106 = type;
                  *&v106[4] = 2112;
                  *&v106[6] = key;
                  _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "stun mesasge type %04x failed message-integrity check for %@", buf, 0x12u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v69 = type;
                    v70 = key;
                    _IDSLogTransport(@"GL", @"IDS", @"stun mesasge type %04x failed message-integrity check for %@");
                    if (_IDSShouldLog())
                    {
                      v69 = type;
                      v70 = key;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"stun mesasge type %04x failed message-integrity check for %@");
                    }
                  }
                }

                if (type == 2066)
                {
                  v31 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 0;
                    _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "message integrity fails, trigger symptoms", buf, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"message integrity fails, trigger symptoms");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"message integrity fails, trigger symptoms");
                      }
                    }
                  }

                  [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:key subType:@"DiagnosticIndicationFailure" subTypeContext:@"BadIntegrity" duration:15, v69, v70];
                }

LABEL_118:
                v21 = 0;
LABEL_218:
                v36 = v73;
                goto LABEL_219;
              }

LABEL_108:
              decKey = [v74 decKey];
              v38 = [(IDSStunMessage *)v14 decryptAES128CTRStunAttributes:decKey];

              if (!v38)
              {
                v40 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109120;
                  *v106 = type;
                  _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "stun mesasge type %04x failed to decrypt - dropped", buf, 8u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"stun mesasge type %04x failed to decrypt - dropped");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"stun mesasge type %04x failed to decrypt - dropped");
                    }
                  }
                }

                goto LABEL_118;
              }

              if ([v74 isActive])
              {
                v39 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
                if (v39)
                {
                  v39[39] = time;
                }
              }

              else
              {
                [v74 setLastIncomingPacketTime:time];
              }

              if ([v74 linkID] >= 1)
              {
                v41 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, [v74 linkID]);
                if (v41)
                {
                  ++*(v41 + 83);
                  v41[43] += packet->var2;
                }
              }

              if (type <= 0xFE1u)
              {
                if (type <= 0x910u)
                {
                  if (type > 0x810u)
                  {
                    if (type <= 0x812u)
                    {
                      if (type != 2065)
                      {
                        [(IDSGlobalLink *)self _processDiagnosticIndication:v14 candidatePairToken:key arrivalTime:time];
                      }

                      goto LABEL_215;
                    }

                    if (type == 2067)
                    {
                      [v74 processDataMessageErrorIndication:v14];
                      goto LABEL_215;
                    }

                    if (type == 2305)
                    {
                      [v74 processTestResponse:v14 arrivalTime:time];
                      goto LABEL_215;
                    }
                  }

                  else if (type > 0x100u)
                  {
                    if (type == 257)
                    {
                      [(IDSGlobalLink *)self _processBindingResponse:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
                      goto LABEL_215;
                    }

                    if (type == 2064)
                    {
                      [(IDSGlobalLink *)self _processGoAwayIndication:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
                      goto LABEL_215;
                    }
                  }

                  else
                  {
                    if (type == 1)
                    {
                      [(IDSGlobalLink *)self _processBindingRequest:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
                      goto LABEL_215;
                    }

                    if (type == 23)
                    {
                      [(IDSGlobalLink *)self _processDataIndication:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
LABEL_215:
                      if ((type & 0x100) != 0)
                      {
                        requestID2 = [(IDSStunMessage *)v14 requestID];
                        [(IDSGlobalLink *)self _removeStunRequest:requestID2];
                      }

                      v21 = 1;
                      goto LABEL_218;
                    }
                  }

                  goto LABEL_197;
                }

                if (type > 0xEF6u)
                {
                  if (type - 4064 < 2)
                  {
                    [(IDSGlobalLink *)self _processAllocbindResponse:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
                    goto LABEL_215;
                  }

                  if (type == 3831)
                  {
                    [v74 processParticipantUpdateIndication:v14 arrivalTime:time];
                    goto LABEL_215;
                  }

                  if (type == 3832)
                  {
                    [v74 processPluginControlIndication:v14];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (type > 0xEF3u)
                {
                  if (type == 3828)
                  {
                    [v74 processInfoIndication:v14 arrivalTime:time];
                    goto LABEL_215;
                  }

                  if (type == 3829)
                  {
                    [v74 processSessionInfoIndication:v14 arrivalTime:self->_isLightweightParticipant isLightweightParticipant:time];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (type != 2321)
                {
                  if (type == 3825)
                  {
                    v43 = *&packet->var18.__ss_pad2[64];
                    v85 = *&packet->var18.__ss_pad2[48];
                    v86 = v43;
                    v44 = *&packet->var18.__ss_pad2[96];
                    v87 = *&packet->var18.__ss_pad2[80];
                    v88 = v44;
                    v45 = *packet->var18.__ss_pad2;
                    v81 = *&packet->var18.ss_len;
                    v82 = v45;
                    v46 = *&packet->var18.__ss_pad2[32];
                    v83 = *&packet->var18.__ss_pad2[16];
                    v84 = v46;
                    v47 = *&packet->var19.ss_len;
                    v48 = *packet->var19.__ss_pad2;
                    v49 = *&packet->var19.__ss_pad2[32];
                    v91 = *&packet->var19.__ss_pad2[16];
                    v92 = v49;
                    v89 = v47;
                    v90 = v48;
                    v50 = *&packet->var19.__ss_pad2[48];
                    v51 = *&packet->var19.__ss_pad2[64];
                    v52 = *&packet->var19.__ss_pad2[96];
                    v95 = *&packet->var19.__ss_pad2[80];
                    v96 = v52;
                    v93 = v50;
                    v94 = v51;
                    var17 = packet->var17;
                    aBlock[0] = MEMORY[0x1E69E9820];
                    aBlock[1] = 3221225472;
                    aBlock[2] = sub_1A7B8C15C;
                    aBlock[3] = &unk_1E77E0EB0;
                    aBlock[4] = self;
                    v78 = v14;
                    v79 = dCopy;
                    v98 = var17;
                    v71 = key;
                    v80 = v71;
                    timeCopy = time;
                    v54 = _Block_copy(aBlock);
                    state = [v74 state];
                    if (state > 3)
                    {
                      v54[2](v54);
                    }

                    else
                    {
                      v56 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v56, OS_LOG_TYPE_DEFAULT))
                      {
                        v57 = _Block_copy(v54);
                        v58 = (&_IDSStunCandidatePairStateStrings)[state];
                        *buf = 134218498;
                        *v106 = v57;
                        *&v106[8] = 2112;
                        *&v106[10] = v71;
                        v107 = 2080;
                        v108 = v58;
                        _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, "delay processing realloc block %p for %@, state [%s].", buf, 0x20u);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          v59 = _Block_copy(v54);
                          _IDSLogTransport(@"GL", @"IDS", @"delay processing realloc block %p for %@, state [%s].");

                          if (_IDSShouldLog())
                          {
                            v60 = _Block_copy(v54);
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing realloc block %p for %@, state [%s].");
                          }
                        }
                      }

                      if (!self->_tokenToReallocBlocks)
                      {
                        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                        tokenToReallocBlocks = self->_tokenToReallocBlocks;
                        self->_tokenToReallocBlocks = Mutable;
                      }

                      v63 = _Block_copy(v54);
                      if (v63)
                      {
                        CFDictionarySetValue(self->_tokenToReallocBlocks, v71, v63);
                      }

                      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                      {
                        sub_1A7E14C48();
                      }
                    }

                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

LABEL_133:
                v42 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 67109120;
                  *v106 = type;
                  _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "_processStunPacket, error response: messageType(%04X)", buf, 8u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v69 = type;
                    _IDSLogTransport(@"GL", @"IDS", @"_processStunPacket, error response: messageType(%04X)");
                    if (_IDSShouldLog())
                    {
                      v69 = type;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"_processStunPacket, error response: messageType(%04X)");
                    }
                  }
                }

                [v74 processStunErrorResponse:v14 packetBuffer:packet headerOverhead:{overhead, v69}];
                goto LABEL_215;
              }

              if (type <= 0xFE6u)
              {
                if (type > 0xFE3u)
                {
                  if (type == 4068)
                  {
                    [v74 processInfoResponse:v14 packetBuffer:packet headerOverhead:overhead];
                    goto LABEL_215;
                  }

                  if (type == 4069)
                  {
                    [v74 processSessionInfoResponse:v14 packetBuffer:packet headerOverhead:overhead isLightweightParticipant:self->_isLightweightParticipant];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }

                if (type != 4066)
                {
                  if (type == 4067)
                  {
                    [v74 processStatsResponse:v14 arrivalTime:time];
                    goto LABEL_215;
                  }

LABEL_197:
                  v65 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 67109120;
                    *v106 = type;
                    _os_log_impl(&dword_1A7AD9000, v65, OS_LOG_TYPE_DEFAULT, "_processStunPacket - receive unknown STUN message type(%04X).", buf, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"_processStunPacket - receive unknown STUN message type(%04X).");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"_processStunPacket - receive unknown STUN message type(%04X).");
                      }
                    }
                  }

                  goto LABEL_215;
                }
              }

              else
              {
                if (type - 4073 > 0xF)
                {
                  goto LABEL_193;
                }

                if (((1 << (type + 23)) & 0xDD80) != 0)
                {
                  goto LABEL_133;
                }

                if (type == 4073)
                {
                  [v74 processPutMaterialResponse:v14];
                  goto LABEL_215;
                }

                if (type != 4082)
                {
LABEL_193:
                  if (type == 4071)
                  {
                    [v74 processParticipantUpdateResponse:v14];
                    goto LABEL_215;
                  }

                  if (type == 4072)
                  {
                    [v74 processPluginRegistrationResponse:v14];
                    goto LABEL_215;
                  }

                  goto LABEL_197;
                }
              }

              [(IDSGlobalLink *)self _processUnallocbindResponse:v14 fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:key arrivalTime:time];
              goto LABEL_215;
            }

LABEL_107:
            v73 = 0;
            goto LABEL_108;
          }

          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            v33 = _IDSLinkStateStrings[self->_state];
            *buf = 136315394;
            *v106 = v33;
            *&v106[8] = 1024;
            *&v106[10] = type & 0x101;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "GL state is [%s], ignore stun message type %04x", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"GL state is [%s], ignore stun message type %04x");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"GL state is [%s], ignore stun message type %04x");
              }
            }
          }

LABEL_101:
          v36 = 0;
          v74 = 0;
          v21 = 0;
LABEL_219:

          goto LABEL_220;
        }

        tokenToCandidatePairs = self->_tokenToCandidatePairs;
        if (!tokenToCandidatePairs || !key || (v74 = CFDictionaryGetValue(tokenToCandidatePairs, key)) == 0)
        {
          tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
          if (!tokenToStunCheckPairs || !key || (v74 = CFDictionaryGetValue(tokenToStunCheckPairs, key)) == 0)
          {
            v35 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v106 = key;
              _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for incoming stun packet, candidatePairToken = %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for incoming stun packet, candidatePairToken = %@");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for incoming stun packet, candidatePairToken = %@");
                }
              }
            }

            goto LABEL_101;
          }

          v29 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "found candidate pair in stun check pair list.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"found candidate pair in stun check pair list.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"found candidate pair in stun check pair list.");
              }
            }
          }
        }

        if ((type & 0xFFFE) != 0xFE0)
        {
          v73 = 0;
          if (type > 0xFE1u)
          {
            if (type != 4072 && type != 4066)
            {
              goto LABEL_108;
            }
          }

          else if (type != 2066 && type != 3825)
          {
            goto LABEL_108;
          }
        }

        relaySessionKey = [v74 relaySessionKey];
        goto LABEL_67;
      }
    }

    if ((type & 0x110) != 0)
    {
      if ((type & 0x110) != 0x10)
      {
        v23 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412546;
          *v106 = requestID;
          *&v106[8] = 1024;
          *&v106[10] = type;
          _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "no matching request with request id %@ for stun message type %04x, ignore.", buf, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no matching request with request id %@ for stun message type %04x, ignore.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no matching request with request id %@ for stun message type %04x, ignore.");
            }
          }
        }

        v21 = 1;
        goto LABEL_220;
      }

      bzero(buf, 0x5D0uLL);
      if ([(IDSStunMessage *)v14 getAttribute:12 attribute:buf])
      {
        if (HIWORD(*&v106[4]))
        {
          keya = channelForStunCandidatePair(&packet->var18, &packet->var19, bswap32(*&v106[4]));
          Value = 0;
          if (self->_channelToCandidatePairs && keya)
          {
            Value = CFDictionaryGetValue(self->_channelToCandidatePairs, keya);
          }

          v72 = Value;
          sessionID = [v72 sessionID];
          if (!sessionID)
          {
            v64 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v64, OS_LOG_TYPE_DEFAULT))
            {
              *v99 = 67109634;
              v100 = type;
              v101 = 2112;
              v102 = keya;
              v103 = 2112;
              v104 = v72;
              _os_log_impl(&dword_1A7AD9000, v64, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@", v99, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for indication type %04x, channel %@, candidatePair: %@");
                }
              }
            }

            goto LABEL_169;
          }
        }

        else
        {
          sessionID = self->_cbuuid;
        }

        key = tokenForStunCandidatePair(&packet->var18, &packet->var19, sessionID);

        if (key)
        {
          goto LABEL_49;
        }
      }

      v34 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        *v99 = 67109120;
        v100 = type;
        _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for indication type %04x.", v99, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for indication type %04x.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for indication type %04x.");
          }
        }
      }
    }

    else
    {
      if (type == 1)
      {
        key = tokenForStunCandidatePair(&packet->var18, &packet->var19, self->_cbuuid);
        goto LABEL_49;
      }

      v24 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        *v106 = type;
        _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive invalid stun request (%04x).", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"receive invalid stun request (%04x).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid stun request (%04x).");
          }
        }
      }
    }

LABEL_169:
    v21 = 0;
LABEL_220:

    goto LABEL_221;
  }

  v20 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "failed to process incoming stun message.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to process incoming stun message.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process incoming stun message.");
      }
    }
  }

  v21 = 0;
LABEL_221:

  return v21;
}

- (void)didReceiveFirstDataOnCandidatePair:(id)pair
{
  v33 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  [pairCopy setHasReceivedData:1];
  if ([pairCopy state] != 4)
  {
    replacesLinkWithUniqueName = [pairCopy replacesLinkWithUniqueName];
    if (replacesLinkWithUniqueName)
    {
      v7 = [(NSMutableDictionary *)self->_linkEngineIDToCandidatePair objectForKeyedSubscript:replacesLinkWithUniqueName];
      v8 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        *v32 = replacesLinkWithUniqueName;
        *&v32[8] = 2112;
        *&v32[10] = v7;
        _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "didReceiveFirstDataOnCandidatePair: original link: %@ %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          candidatePairToken5 = replacesLinkWithUniqueName;
          linkID3 = v7;
          _IDSLogTransport(@"GL", @"IDS", @"didReceiveFirstDataOnCandidatePair: original link: %@ %@");
          if (_IDSShouldLog())
          {
            candidatePairToken5 = replacesLinkWithUniqueName;
            linkID3 = v7;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"didReceiveFirstDataOnCandidatePair: original link: %@ %@");
          }
        }
      }

      if (v7)
      {
        [pairCopy setState:4];
        [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:pairCopy];
        linkID = [v7 linkID];
        if ([v7 isSharedQRSession])
        {
          candidatePairToken = [pairCopy candidatePairToken];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:candidatePairToken];

          if (self->_linkIDForPlugin && self->_linkIDForPlugin == linkID)
          {
            self->_linkIDForPlugin = [pairCopy linkID];
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              linkID2 = [pairCopy linkID];
              *buf = 67109376;
              *v32 = linkID;
              *&v32[4] = 1024;
              *&v32[6] = linkID2;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", buf, 0xEu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                candidatePairToken5 = linkID;
                linkID3 = [pairCopy linkID];
                _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
                if (_IDSShouldLog())
                {
                  linkID4 = [pairCopy linkID];
                  candidatePairToken5 = linkID;
                  linkID3 = linkID4;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
                }
              }
            }
          }
        }

        else if (linkID < 1)
        {
          candidatePairToken2 = [pairCopy candidatePairToken];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:candidatePairToken2];
        }

        else
        {
          v14 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken3 = [v7 candidatePairToken];
            *buf = 67109378;
            *v32 = linkID;
            *&v32[4] = 2112;
            *&v32[6] = candidatePairToken3;
            _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "reuse linkID %d from original pair %@.", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              [v7 candidatePairToken];
              linkID3 = candidatePairToken5 = linkID;
              _IDSLogTransport(@"GL", @"IDS", @"reuse linkID %d from original pair %@.");

              if (_IDSShouldLog())
              {
                [v7 candidatePairToken];
                linkID3 = candidatePairToken5 = linkID;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"reuse linkID %d from original pair %@.");
              }
            }
          }

          [pairCopy setLinkID:{linkID, candidatePairToken5, linkID3}];
          [v7 setLinkID:0];
          if (([pairCopy linkID] & 0x80000000) == 0 || self->_maxLinkID > objc_msgSend(pairCopy, "linkID"))
          {
            objc_storeStrong(&self->_candidatePairs[[pairCopy linkID]], pair);
          }

          IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, pairCopy, linkID);
        }

        local = [v7 local];
        address = [local address];

        remote = [v7 remote];
        external = [remote external];

        v21 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
        v22 = v21;
        if (v21)
        {
          if (IsSameSA(address, (v21 + 1)) && IsSameSA(external, (v22 + 17)))
          {
            v23 = *(v22 + 132);
            if (v23 == [v7 channelNumber])
            {
              [(IDSGlobalLink *)self _updateDefaultCandidatePair:pairCopy];
            }
          }
        }

        [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
        v24 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          candidatePairToken4 = [pairCopy candidatePairToken];
          *buf = 138412290;
          *v32 = candidatePairToken4;
          _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "realloc is done for candidatePair: %@.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            candidatePairToken5 = [pairCopy candidatePairToken];
            _IDSLogTransport(@"GL", @"IDS", @"realloc is done for candidatePair: %@.");

            if (_IDSShouldLog())
            {
              candidatePairToken5 = [pairCopy candidatePairToken];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc is done for candidatePair: %@.");
            }
          }
        }
      }
    }

    else
    {
      v7 = 0;
    }

    [pairCopy setReplacesLinkWithUniqueName:{0, candidatePairToken5}];
    sessionsByID = self->_sessionsByID;
    sessionID = [pairCopy sessionID];
    v28 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:sessionID];

    if (v28)
    {
      [(IDSGlobalLink *)self _updateLinksForSession:v28];
    }
  }
}

- (void)_processDataOnReallocChannel:(unsigned __int16)channel localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress
{
  channelCopy = channel;
  v124 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v82 = 0u;
  v83 = 0u;
  v80 = 0u;
  obj = v81 = 0u;
  v5 = [obj countByEnumeratingWithState:&v80 objects:v123 count:16];
  if (v5)
  {
    v67 = 0;
    v73 = 0;
    v6 = *v81;
    while (1)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v81 != v6)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v80 + 1) + 8 * i);
        if ([v8 channelNumber] == channelCopy)
        {
          local = [v8 local];
          address = [local address];

          remote = [v8 remote];
          external = [remote external];

          if (!IsSameSA(address, address) || !IsSameSA(external, remoteAddress) || ![v8 pendingRealloc])
          {
            if ([v8 pendingRealloc])
            {
              *&v18 = 0xAAAAAAAAAAAAAAAALL;
              *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
              v121 = v18;
              v122 = v18;
              v119 = v18;
              v120 = v18;
              v117 = v18;
              v118 = v18;
              *v116 = v18;
              *&v116[16] = v18;
              v114 = v18;
              v115 = v18;
              v112 = v18;
              v113 = v18;
              v110 = v18;
              v111 = v18;
              *v108 = v18;
              v109 = v18;
              v106 = v18;
              v107 = v18;
              v104 = v18;
              v105 = v18;
              v102 = v18;
              v103 = v18;
              *__str = v18;
              v101 = v18;
              v98 = v18;
              v99 = v18;
              v96 = v18;
              v97 = v18;
              v94 = v18;
              v95 = v18;
              *v92 = v18;
              v93 = v18;
              v19 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
              {
                v20 = SAToIPPortString(v116, 0x80uLL, address);
                v21 = SAToIPPortString(__str, 0x80uLL, address);
                v22 = SAToIPPortString(v108, 0x80uLL, external);
                v23 = SAToIPPortString(v92, 0x80uLL, remoteAddress);
                *buf = 136315906;
                v85 = v20;
                v86 = 2080;
                v87 = v21;
                v88 = 2080;
                v89 = v22;
                v90 = 2080;
                v91 = v23;
                _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s", buf, 0x2Au);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v24 = SAToIPPortString(v116, 0x80uLL, address);
                  v25 = SAToIPPortString(__str, 0x80uLL, address);
                  v65 = SAToIPPortString(v108, 0x80uLL, external);
                  v66 = SAToIPPortString(v92, 0x80uLL, remoteAddress);
                  linkID4 = v24;
                  linkID5 = v25;
                  _IDSLogTransport(@"GL", @"IDS", @"pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s");
                  if (_IDSShouldLog())
                  {
                    v26 = SAToIPPortString(v116, 0x80uLL, address);
                    v27 = SAToIPPortString(__str, 0x80uLL, address);
                    v65 = SAToIPPortString(v108, 0x80uLL, external);
                    v66 = SAToIPPortString(v92, 0x80uLL, remoteAddress);
                    linkID4 = v26;
                    linkID5 = v27;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"pair local: %s, realloc local: %s, pair remote:%s, realloc remote: %s");
                  }
                }
              }
            }

            goto LABEL_80;
          }

          [v8 setPendingRealloc:0];
          v13 = v8;

          if (self->_reallocNewCandidatePairToOldCandidatePair)
          {
            candidatePairToken = [v13 candidatePairToken];
            if (candidatePairToken)
            {
              reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
              candidatePairToken2 = [v13 candidatePairToken];
              v17 = CFDictionaryGetValue(reallocNewCandidatePairToOldCandidatePair, candidatePairToken2);
            }

            else
            {
              v17 = 0;
            }
          }

          else
          {
            v17 = 0;
          }

          remote2 = [v17 remote];
          external2 = [remote2 external];

          remote3 = [v13 remote];
          external3 = [remote3 external];

          if (external3 && external2)
          {
            if (!IsSameSA(external2, external3))
            {
              v32 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
              {
                candidatePairToken3 = [v13 candidatePairToken];
                candidatePairToken4 = [v17 candidatePairToken];
                *v116 = 138412546;
                *&v116[4] = candidatePairToken3;
                *&v116[12] = 2112;
                *&v116[14] = candidatePairToken4;
                _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Realloc is done for: %@ remove pair: %@", v116, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  candidatePairToken5 = [v13 candidatePairToken];
                  [v17 candidatePairToken];
                  linkID5 = linkID4 = candidatePairToken5;
                  _IDSLogTransport(@"GL", @"IDS", @"Realloc is done for: %@ remove pair: %@");

                  if (_IDSShouldLog())
                  {
                    candidatePairToken6 = [v13 candidatePairToken];
                    [v17 candidatePairToken];
                    linkID5 = linkID4 = candidatePairToken6;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"Realloc is done for: %@ remove pair: %@");
                  }
                }
              }

              candidatePairToken7 = [v13 candidatePairToken];
              if (candidatePairToken7)
              {
                v38 = self->_reallocNewCandidatePairToOldCandidatePair == 0;

                if (!v38)
                {
                  v39 = self->_reallocNewCandidatePairToOldCandidatePair;
                  candidatePairToken8 = [v13 candidatePairToken];
                  CFDictionaryRemoveValue(v39, candidatePairToken8);
                }
              }
            }

            local2 = [v17 local];
            address2 = [local2 address];

            remote4 = [v17 remote];
            external4 = [remote4 external];

            state = [v13 state];
            if (state != 4)
            {
              [v13 setState:4];
              [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:v13];
              v46 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
              {
                v47 = (&_IDSStunCandidatePairStateStrings)[state];
                *v116 = 136315650;
                *&v116[4] = v47;
                *&v116[12] = 2080;
                *&v116[14] = off_1EB2B43C8;
                *&v116[22] = 2112;
                *&v116[24] = v13;
                _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", v116, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  linkID5 = off_1EB2B43C8;
                  v65 = v13;
                  linkID4 = (&_IDSStunCandidatePairStateStrings)[state];
                  _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
                  if (_IDSShouldLog())
                  {
                    linkID5 = off_1EB2B43C8;
                    v65 = v13;
                    linkID4 = (&_IDSStunCandidatePairStateStrings)[state];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
                  }
                }
              }

              linkID = [v17 linkID];
              if (linkID < 1 || ([v17 isSharedQRSession] & 1) != 0)
              {
                candidatePairToken9 = [v13 candidatePairToken];
                [(IDSGlobalLink *)self _notifyCandidatePairConnected:candidatePairToken9];
              }

              else
              {
                v51 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
                {
                  candidatePairToken10 = [v17 candidatePairToken];
                  *v116 = 67109378;
                  *&v116[4] = linkID;
                  *&v116[8] = 2112;
                  *&v116[10] = candidatePairToken10;
                  v68 = candidatePairToken10;
                  _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "reuse linkID %d from original pair %@.", v116, 0x12u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    [v17 candidatePairToken];
                    linkID5 = linkID4 = linkID;
                    _IDSLogTransport(@"GL", @"IDS", @"reuse linkID %d from original pair %@.");

                    if (_IDSShouldLog())
                    {
                      [v17 candidatePairToken];
                      linkID5 = linkID4 = linkID;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"reuse linkID %d from original pair %@.");
                    }
                  }
                }

                [v13 setLinkID:{linkID, linkID4}];
                [v17 setLinkID:0];
                objc_storeStrong(&self->_candidatePairs[linkID], v8);
                IDSQRSendInfoList_AddItemAtIndexFromCandidatePair(self->_sendInfoList, v13, linkID);
              }
            }

            v53 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
            v54 = v53;
            if (v53 && IsSameSA(address2, (v53 + 1)) && IsSameSA(external4, (v54 + 17)) && *(v54 + 132) == channelCopy)
            {
              [(IDSGlobalLink *)self _updateDefaultCandidatePair:v13];
            }

            v75[0] = MEMORY[0x1E69E9820];
            v75[1] = 3221225472;
            v75[2] = sub_1A7B8D854;
            v75[3] = &unk_1E77E0ED8;
            v55 = v17;
            v78 = address2;
            v79 = external4;
            v76 = v55;
            selfCopy = self;
            IDSTransportThreadAddBlockAfter(v75, 5.0);
            if (self->_linkIDForPlugin)
            {
              if ([v55 isSharedQRSession])
              {
                linkIDForPlugin = self->_linkIDForPlugin;
                if (linkIDForPlugin == [v55 linkID])
                {
                  self->_linkIDForPlugin = [v13 linkID];
                  v57 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT))
                  {
                    linkID2 = [v55 linkID];
                    linkID3 = [v13 linkID];
                    *v116 = 67109376;
                    *&v116[4] = linkID2;
                    *&v116[8] = 1024;
                    *&v116[10] = linkID3;
                    _os_log_impl(&dword_1A7AD9000, v57, OS_LOG_TYPE_DEFAULT, "linkID for Plugin is now changed from %d to %d", v116, 0xEu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      linkID4 = [v55 linkID];
                      linkID5 = [v13 linkID];
                      _IDSLogTransport(@"GL", @"IDS", @"linkID for Plugin is now changed from %d to %d");
                      if (_IDSShouldLog())
                      {
                        linkID4 = [v55 linkID];
                        linkID5 = [v13 linkID];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"linkID for Plugin is now changed from %d to %d");
                      }
                    }
                  }
                }
              }
            }

            [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
            v60 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
            {
              candidatePairToken11 = [v13 candidatePairToken];
              *v116 = 138412290;
              *&v116[4] = candidatePairToken11;
              _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "realloc is done for candidatePair: %@.", v116, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                linkID4 = [v13 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"realloc is done for candidatePair: %@.");

                if (_IDSShouldLog())
                {
                  linkID4 = [v13 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc is done for candidatePair: %@.");
                }
              }
            }

            v67 = v13;
LABEL_80:
            v73 |= [v8 pendingRealloc];
            continue;
          }

          v50 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
          {
            *v116 = 134218240;
            *&v116[4] = external3;
            *&v116[12] = 2048;
            *&v116[14] = external2;
            _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue", v116, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              linkID4 = external3;
              linkID5 = external2;
              _IDSLogTransport(@"GL", @"IDS", @"reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue");
              if (_IDSShouldLog())
              {
                linkID4 = external3;
                linkID5 = external2;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"reallocNewCandidatePairRemoteAddress: %p, reallocOldCandidatePairRemoteAddress: %p, continue");
              }
            }
          }

          v67 = v13;
        }
      }

      v5 = [obj countByEnumeratingWithState:&v80 objects:v123 count:16];
      if (!v5)
      {

        if (v73)
        {
          goto LABEL_93;
        }

        goto LABEL_86;
      }
    }
  }

  v67 = 0;
LABEL_86:
  if (IDSSimpleUInt16List_HasItem(&self->_reallocChannelList, channelCopy))
  {
    IDSSimpleUInt16List_RemoveItem(&self->_reallocChannelList, channelCopy);
    v62 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
    {
      *v116 = 67109120;
      *&v116[4] = __rev16(channelCopy);
      _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "remove channel number %04x from reallocChannelList due to realloc time out.", v116, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"remove channel number %04x from reallocChannelList due to realloc time out.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remove channel number %04x from reallocChannelList due to realloc time out.");
        }
      }
    }
  }

LABEL_93:
}

- (void)_processReallocChannelData:(id *)data channelNumber:(unsigned __int16)number fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time
{
  numberCopy = number;
  v30 = *MEMORY[0x1E69E9840];
  dCopy = d;
  cbuuidCopy = cbuuid;
  *&v13 = 0xAAAAAAAAAAAAAAAALL;
  *(&v13 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v28 = v13;
  v29 = v13;
  v26 = v13;
  v27 = v13;
  v24 = v13;
  v25 = v13;
  *__str = v13;
  v23 = v13;
  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    v19 = __rev16(numberCopy);
    v20 = 2080;
    v21 = SAToIPPortString(__str, 0x80uLL, &data->var19);
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "process channel data on realloc channel %04x from [%s].", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v15 = __rev16(numberCopy);
      v16 = v15;
      v17 = SAToIPPortString(__str, 0x80uLL, &data->var19);
      _IDSLogTransport(@"GL", @"IDS", @"process channel data on realloc channel %04x from [%s].");
      if (_IDSShouldLog())
      {
        v16 = v15;
        v17 = SAToIPPortString(__str, 0x80uLL, &data->var19);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"process channel data on realloc channel %04x from [%s].");
      }
    }
  }

  [(IDSGlobalLink *)self _processDataOnReallocChannel:numberCopy localAddress:&data->var18 remoteAddress:&data->var19, v16, v17];
}

- (void)_saveStunRequest:(id)request startTime:(double)time token:(id)token
{
  key = request;
  tokenCopy = token;
  allKeys = [(NSMutableDictionary *)self->_startTimeToStunReqID allKeys];
  if (([allKeys containsObject:key] & 1) == 0)
  {
    if (!self->_startTimeToStunReqID)
    {
      Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      startTimeToStunReqID = self->_startTimeToStunReqID;
      self->_startTimeToStunReqID = Mutable;
    }

    v12 = [MEMORY[0x1E696AD98] numberWithDouble:time];
    if (v12)
    {
      CFDictionarySetValue(self->_startTimeToStunReqID, key, v12);
    }

    if (!self->_tokenToStunReqID)
    {
      v13 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      tokenToStunReqID = self->_tokenToStunReqID;
      self->_tokenToStunReqID = v13;
    }

    if (tokenCopy)
    {
      CFDictionarySetValue(self->_tokenToStunReqID, key, tokenCopy);
    }
  }
}

- (void)_removeStunRequest:(id)request
{
  startTimeToStunReqID = self->_startTimeToStunReqID;
  requestCopy = request;
  [(NSMutableDictionary *)startTimeToStunReqID removeObjectForKey:requestCopy];
  [(NSMutableDictionary *)self->_tokenToStunReqID removeObjectForKey:requestCopy];
}

- (BOOL)_hasStunRequest:(id)request
{
  requestCopy = request;
  v5 = [(NSMutableDictionary *)self->_startTimeToStunReqID objectForKey:requestCopy];
  if (v5)
  {
    v6 = 1;
  }

  else
  {
    v7 = [(NSMutableDictionary *)self->_tokenToStunReqID objectForKey:requestCopy];
    v6 = v7 != 0;
  }

  return v6;
}

- (double)_startTimeForStunRequest:(id)request
{
  Value = 0;
  if (request)
  {
    startTimeToStunReqID = self->_startTimeToStunReqID;
    if (startTimeToStunReqID)
    {
      Value = CFDictionaryGetValue(startTimeToStunReqID, request);
      v3 = vars8;
    }
  }

  [Value doubleValue];
  return result;
}

- (int64_t)_sendStunMessage:(id)message candidatePair:(id)pair
{
  pairCopy = pair;
  messageCopy = message;
  local = [pairCopy local];
  index = [local index];

  local2 = [pairCopy local];
  address = [local2 address];

  remote = [pairCopy remote];
  external = [remote external];

  local3 = [pairCopy local];
  transport = [local3 transport];

  glLinkProtocol = [pairCopy glLinkProtocol];
  linkID = [pairCopy linkID];
  if ([pairCopy isVirtualRelayStunCandidatePair])
  {
    delegatedLinkID = [pairCopy delegatedLinkID];
  }

  else
  {
    delegatedLinkID = -1;
  }

  if (linkID)
  {
    v17 = linkID;
  }

  else
  {
    v17 = -1;
  }

  candidatePairToken = [pairCopy candidatePairToken];
  local4 = [pairCopy local];
  HIDWORD(v22) = [local4 mtu];
  BYTE1(v22) = delegatedLinkID;
  LOBYTE(v22) = v17;
  v20 = [IDSGlobalLink _sendStunMessage:"_sendStunMessage:sourceIfIndex:source:destination:stunTransport:glLinkProtocol:token:linkID:delegatedLinkID:MTULimit:" sourceIfIndex:messageCopy source:index destination:address stunTransport:external glLinkProtocol:transport token:glLinkProtocol linkID:candidatePairToken delegatedLinkID:v22 MTULimit:?];

  return v20;
}

- (int64_t)_sendStunMessage:(id)message sourceIfIndex:(int)index source:(const sockaddr *)source destination:(sockaddr *)destination stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol token:(id)token linkID:(char)self0 delegatedLinkID:(char)self1 MTULimit:(int)self2
{
  v61 = *MEMORY[0x1E69E9840];
  messageCopy = message;
  tokenCopy = token;
  *&v18 = 0xAAAAAAAAAAAAAAAALL;
  *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v59 = v18;
  v60 = v18;
  v57 = v18;
  v58 = v18;
  v55 = v18;
  v56 = v18;
  *__str = v18;
  v54 = v18;
  v51 = v18;
  v52 = v18;
  v49 = v18;
  v50 = v18;
  v47 = v18;
  v48 = v18;
  *v45 = v18;
  v46 = v18;
  v19 = _IDSLinkPacketBufferCreate();
  [messageCopy write:*v19 outputLength:v19 + 2 remainingLength:v19[1] internal:0];
  SAToIPPortString(__str, 0x80uLL, source);
  SAToIPPortString(v45, 0x80uLL, destination);
  v36 = [(IDSGlobalLink *)self _getLink:*(v19 + 57) stunTransport:transport glLinkProtocol:protocol];
  v20 = v19[2];
  v21 = &v20[[v36 headerOverhead]];
  if (v21 <= limit)
  {
    v32 = 0;
    v33 = 1;
  }

  else
  {
    v22 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134218496;
      type = [messageCopy type];
      v39 = 2048;
      v40 = v21;
      v41 = 1024;
      LODWORD(v42) = limit;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_sendStunMessage: 0x%lx, bytesSent: %lu, greater than MTU %d", buf, 0x1Cu);
    }

    if ([messageCopy type] == 3813)
    {
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5445, v19);
      v23 = -2;
      goto LABEL_28;
    }

    if ([messageCopy type] == 3815 || objc_msgSend(messageCopy, "type") == 3808)
    {
      v33 = 0;
      v32 = -2;
    }

    else
    {
      v32 = 0;
      v33 = 1;
    }
  }

  v24 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "_sendStunMessage: setting up packet buffer", buf, 2u);
  }

  *(v19 + 45) = 1;
  *(v19 + 12) = index;
  memcpy(v19 + 7, source, source->sa_len);
  memcpy(v19 + 23, destination, destination->sa_len);
  v23 = [(IDSGlobalLink *)self _sendPacketBuffer:v19 stunTransport:transport glLinkProtocol:protocol token:tokenCopy linkID:d delegatedLinkID:iD];
  if (v23 < 1)
  {
    v29 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      *buf = 138413058;
      type = messageCopy;
      v39 = 2112;
      v40 = idsSessionID;
      v41 = 2080;
      v42 = __str;
      v43 = 2080;
      v44 = v45;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "Failed to send stun message %@ for IDSSessionID: %@ and %s-%s", buf, 0x2Au);
    }
  }

  else
  {
    if (([messageCopy type] & 0x110) == 0)
    {
      [messageCopy startTime];
      if (v25 > 0.0)
      {
        requestID = [messageCopy requestID];
        [messageCopy startTime];
        [(IDSGlobalLink *)self _saveStunRequest:requestID startTime:tokenCopy token:?];
      }
    }

    v27 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      v28 = self->_idsSessionID;
      *buf = 138413058;
      type = messageCopy;
      v39 = 2112;
      v40 = v28;
      v41 = 2080;
      v42 = __str;
      v43 = 2080;
      v44 = v45;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "send stun message %@ for IDSSessionID: %@ and %s-%s.", buf, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"send stun message %@ for IDSSessionID: %@ and %s-%s.");
    }

    if (!v33)
    {
      v23 = v32;
    }
  }

LABEL_28:

  return v23;
}

- (int64_t)_sendPacketBuffer:(id *)buffer stunTransport:(int64_t)transport glLinkProtocol:(int64_t)protocol token:(id)token linkID:(char)d delegatedLinkID:(char)iD
{
  iDCopy = iD;
  dCopy = d;
  v29 = *MEMORY[0x1E69E9840];
  tokenCopy = token;
  v15 = [(IDSGlobalLink *)self _getLink:buffer->var18.ss_family stunTransport:transport glLinkProtocol:protocol];
  v16 = v15;
  if (iDCopy >= 1)
  {
    buffer->var16 = 1;
  }

  var2 = buffer->var2;
  v18 = [v15 headerOverhead] + var2;
  _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5488, buffer);
  v19 = [v16 sendPacketBuffer:buffer toDeviceUniqueID:self->_deviceUniqueID cbuuid:self->_cbuuid];
  if (v19)
  {
    v20 = v19;
    v21 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      if (v20 > 0xF)
      {
        v22 = "UnexpectedSendResult";
      }

      else
      {
        v22 = _IDSLinkSendResultStrings[v20];
      }

      *buf = 134218242;
      v26 = v18;
      v27 = 2080;
      v28 = v22;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "Failed to send packet buffer (%ldB) (error:%s).", buf, 0x16u);
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5492, buffer);
    v18 = -1;
  }

  else
  {
    if (v18 >= 1)
    {
      LOBYTE(v24) = 0;
      [(IDSGlobalLink *)self _updateSendStatsWithResult:0 bytesSent:v18 packetsSent:1 linkID:dCopy delegatedLinkID:iDCopy token:tokenCopy isClientData:ids_monotonic_time() sendTime:v24 stunTransport:transport packetBuffer:buffer];
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 5499, buffer);
  }

  return v18;
}

- (id)_createIDSContextBlobMaterialProto:(id)proto
{
  v16[1] = *MEMORY[0x1E69E9840];
  protoCopy = proto;
  v4 = objc_alloc_init(IDSQRProtoMaterialInfo);
  [(IDSQRProtoMaterialInfo *)v4 setMaterialType:7];
  v5 = [protoCopy copy];

  [(IDSQRProtoMaterialInfo *)v4 setMaterialContent:v5];
  v13 = 0;
  v6 = [MEMORY[0x1E695DEF0] dataWithBytes:&v13 length:4];
  [(IDSQRProtoMaterialInfo *)v4 setMaterialId:v6];
  v7 = objc_alloc_init(IDSQRProtoMaterial);
  [(IDSQRProtoMaterial *)v7 setReceiverParticipantId:0];
  v16[0] = v4;
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v16 count:1];
  v9 = [v8 mutableCopy];
  [(IDSQRProtoMaterial *)v7 setMaterialInfos:v9];

  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v15 = v7;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_createDataBlobMaterialProto: %@", buf, 0xCu);
  }

  v11 = [(IDSQRProtoMaterial *)v7 copy];

  return v11;
}

- (void)_sendAllocbindRequest:(id)request stunMessage:(id)message isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state
{
  stateCopy = state;
  reallocCopy = realloc;
  v176 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  messageCopy = message;
  if (requestCopy)
  {
    if (self->_state >= 5 && !stateCopy)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = _IDSLinkStateStrings[self->_state];
        *buf = 138412546;
        *v167 = requestCopy;
        *&v167[8] = 2080;
        *&v167[10] = v13;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, GL state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, GL state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, GL state [%s].");
          }
        }
      }

      goto LABEL_35;
    }

    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v16 = CFDictionaryGetValue(tokenToCandidatePairs, requestCopy)) == 0)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "send allocbind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send allocbind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send allocbind request failed due to invalid candidate pair.");
          }
        }
      }

      v17 = 0;
      goto LABEL_34;
    }

    v17 = v16;
    if ([v16 isSharedQRSession] && !self->_sharedSessionHasJoined)
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "skip allocbind request, session is not yet joined!", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request, session is not yet joined!");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request, session is not yet joined!");
          }
        }
      }

      goto LABEL_34;
    }

    state = [v17 state];
    pendingRealloc = [v17 pendingRealloc];
    if (state == 2)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "in failed state, send allocbind request ignored", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"in failed state, send allocbind request ignored");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"in failed state, send allocbind request ignored");
          }
        }
      }

LABEL_34:

      goto LABEL_35;
    }

    v22 = pendingRealloc;
    pendingNoSessionStateAllocbind = [v17 pendingNoSessionStateAllocbind];
    v24 = pendingNoSessionStateAllocbind;
    v150 = state;
    if (state < 3)
    {
      v25 = 1;
    }

    else
    {
      v25 = reallocCopy;
    }

    if ((reallocCopy & (v22 ^ 1) & 1) != 0 || !v25 || (stateCopy & ~reallocCopy & pendingNoSessionStateAllocbind) != 0)
    {
      v33 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        v34 = @"allocbind";
        v35 = (&_IDSStunCandidatePairStateStrings)[v150];
        if (reallocCopy)
        {
          v34 = @"realloc";
        }

        *buf = 138413826;
        *v167 = v34;
        v36 = @"YES";
        *&v167[8] = 2112;
        *&v167[10] = requestCopy;
        if (v22)
        {
          v37 = @"YES";
        }

        else
        {
          v37 = @"NO";
        }

        *&v167[18] = 2080;
        *&v167[20] = v35;
        if (v25)
        {
          v38 = @"NO";
        }

        else
        {
          v38 = @"YES";
        }

        v168 = 2112;
        if (stateCopy)
        {
          v39 = @"YES";
        }

        else
        {
          v39 = @"NO";
        }

        v169 = v37;
        if ((v24 & 1) == 0)
        {
          v36 = @"NO";
        }

        v170 = 2112;
        v171 = v38;
        v172 = 2112;
        v173 = v39;
        v174 = 2112;
        v175 = v36;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@", buf, 0x48u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, pendingInResponseToNoSessionState: %@");
          }
        }
      }

      goto LABEL_34;
    }

    if (!messageCopy)
    {
      v40 = 3808;
      if (reallocCopy)
      {
        v40 = 3809;
      }

      v143 = v40;
      theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
      v41 = 0x1E696A000;
      if ((reallocCopy & 1) == 0)
      {
        sessionID = [v17 sessionID];
        allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        HasCandidatePairForSameSharedSession = GLUtilHasCandidatePairForSameSharedSession(sessionID, allValues);

        if (HasCandidatePairForSameSharedSession)
        {
          v45 = 16;
        }

        else
        {
          v45 = 0;
        }

        if (stateCopy)
        {
          v46 = v45 | 0x20;
        }

        else
        {
          v46 = v45;
        }

        v47 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v46];
        if (v47)
        {
          CFDictionarySetValue(theDict, @"gl-option-additional-binding", v47);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14CC4();
        }

        v78 = [MEMORY[0x1E696AD98] numberWithBool:self->_isShortMKIEnabled];
        if (v78)
        {
          CFDictionarySetValue(theDict, @"gs-shortmki-enabled-key", v78);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14D4C();
        }

        sessionID2 = [v17 sessionID];
        if ([(NSDictionary *)self->_QRServerDataBlob count])
        {
          v80 = [(NSDictionary *)self->_QRServerDataBlob objectForKeyedSubscript:sessionID2];
          v81 = v80 == 0;

          if (v81)
          {
            allKeys = [(NSDictionary *)self->_QRServerDataBlob allKeys];
            firstObject = [allKeys firstObject];

            allValues2 = [(NSDictionary *)self->_QRServerDataBlob allValues];
            firstObject2 = [allValues2 firstObject];

            QRServerDataBlob = self->_QRServerDataBlob;
            self->_QRServerDataBlob = 0;

            v85 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109634;
              *v167 = [firstObject2 length];
              *&v167[4] = 2112;
              *&v167[6] = firstObject;
              *&v167[14] = 2112;
              *&v167[16] = sessionID2;
              _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@", buf, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v138 = firstObject;
                v140 = sessionID2;
                v136 = [firstObject2 length];
                _IDSLogTransport(@"GL", @"IDS", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
                if (_IDSShouldLog())
                {
                  v86 = [firstObject2 length];
                  v138 = firstObject;
                  v140 = sessionID2;
                  v136 = v86;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
                }
              }
            }

            v87 = firstObject2;
            if (v87)
            {
              CFDictionarySetValue(theDict, @"gl-option-qr-server-data-blob", v87);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              sub_1A7E14DD4();
            }
          }
        }

        v41 = 0x1E696A000uLL;
      }

      v101 = [*(v41 + 3480) numberWithBool:{self->_isLightweightParticipant, v136, v138, v140}];
      if (v101)
      {
        CFDictionarySetValue(theDict, @"gl-option-is-lightweight-participant-key", v101);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14E5C();
      }

      v102 = StunUtilCreateMessage(v143, 0, v17, theDict);
      v147 = v102;
      if (!v102)
      {
        v130 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v130, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          *v167 = v143;
          _os_log_impl(&dword_1A7AD9000, v130, OS_LOG_TYPE_DEFAULT, "failed to create stun message (%04x).", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to create stun message (%04x).");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create stun message (%04x).");
            }
          }
        }

        messageCopy = 0;
        goto LABEL_34;
      }

      requestID = [v102 requestID];
      [v17 addStunRequest:requestID];

      encKey = [v17 encKey];
      [v147 initAES128CTR:encKey];

LABEL_157:
      v105 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
      {
        if (reallocCopy)
        {
          v106 = "realloc";
        }

        else
        {
          v106 = "allocbind";
        }

        idsSessionID = self->_idsSessionID;
        sessionID3 = [v17 sessionID];
        *buf = 136316162;
        *v167 = v106;
        *&v167[8] = 2112;
        *&v167[10] = v147;
        *&v167[18] = 2112;
        *&v167[20] = idsSessionID;
        v168 = 2112;
        v169 = sessionID3;
        v170 = 2112;
        v171 = requestCopy;
        _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "Send %s request %@ for IDSSessionID: %@ QRSessionID: %@ token: %@", buf, 0x34u);
      }

      local = [v17 local];
      transport = [local transport];

      metricsCollector = self->_metricsCollector;
      theDicta = (transport - 3);
      if (transport == 3)
      {
        [(IDSGFTMetricsCollector *)metricsCollector tcpAllocbindRequest];
      }

      else
      {
        [(IDSGFTMetricsCollector *)metricsCollector stunAllocbindRequest];
      }

      linkMetrics = [v17 linkMetrics];
      [linkMetrics sendAllocbindRequest];

      [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v17];
      v113 = IMGetDomainBoolForKey();
      v114 = IMGetDomainBoolForKey();
      v115 = v114;
      v144 = (v113 & 1) == 0 && !self->_forceTCPFallbackOnWiFi;
      v142 = (v114 & 1) == 0 && !self->_forceTCPFallbackOnCell;
      v116 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
      {
        v117 = @"NO";
        if (v113)
        {
          v118 = @"YES";
        }

        else
        {
          v118 = @"NO";
        }

        forceTCPFallbackOnCell = self->_forceTCPFallbackOnCell;
        if (self->_forceTCPFallbackOnWiFi)
        {
          v120 = @"YES";
        }

        else
        {
          v120 = @"NO";
        }

        *buf = 138413058;
        *v167 = v118;
        if (v115)
        {
          v121 = @"YES";
        }

        else
        {
          v121 = @"NO";
        }

        *&v167[8] = 2112;
        *&v167[10] = v120;
        if (forceTCPFallbackOnCell)
        {
          v117 = @"YES";
        }

        *&v167[18] = 2112;
        *&v167[20] = v121;
        v168 = 2112;
        v169 = v117;
        _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "sendAllocbindRequest forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
      }

      v122 = messageCopy == 0;

      local2 = [v17 local];
      isCellularStunCandidate = [local2 isCellularStunCandidate];

      aBlock[0] = MEMORY[0x1E69E9820];
      aBlock[1] = 3221225472;
      aBlock[2] = sub_1A7B90410;
      aBlock[3] = &unk_1E77E0F00;
      aBlock[4] = self;
      messageCopy = v147;
      v160 = messageCopy;
      v17 = v17;
      v161 = v17;
      v162 = v122;
      v125 = _Block_copy(aBlock);
      if ((v144 | isCellularStunCandidate) & 1 | (theDicta < 0xFFFFFFFFFFFFFFFELL))
      {
        if (v142 || theDicta < 0xFFFFFFFFFFFFFFFELL || ((isCellularStunCandidate ^ 1) & 1) != 0)
        {
          [v17 debugDelay];
          if (v131 == 0.0)
          {
            v125[2](v125);
          }

          else
          {
            v132 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT))
            {
              [v17 debugDelay];
              *buf = 134217984;
              *v167 = v133;
              _os_log_impl(&dword_1A7AD9000, v132, OS_LOG_TYPE_DEFAULT, "debugDelay is present. Delaying by %f seconds", buf, 0xCu);
            }

            [v17 debugDelay];
            if (v134 > 0.0)
            {
              v157[0] = MEMORY[0x1E69E9820];
              v157[1] = 3221225472;
              v157[2] = sub_1A7B90620;
              v157[3] = &unk_1E77E0188;
              v158 = v125;
              [v17 debugDelay];
              IDSTransportThreadAddBlockAfter(v157, v135);
            }
          }

          goto LABEL_193;
        }

        v126 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v126, OS_LOG_TYPE_DEFAULT))
        {
          v127 = (&_IDSStunTransportStrings)[transport];
          *buf = 136315138;
          *v167 = v127;
          _os_log_impl(&dword_1A7AD9000, v126, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnCell is set, skip STUN message %s", buf, 0xCu);
        }
      }

      else
      {
        v126 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v126, OS_LOG_TYPE_DEFAULT))
        {
          v128 = (&_IDSStunTransportStrings)[transport];
          *buf = 136315138;
          *v167 = v128;
          _os_log_impl(&dword_1A7AD9000, v126, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnWiFi is set, skip STUN message %s", buf, 0xCu);
        }
      }

LABEL_193:
      if (!v150)
      {
        [v17 setState:1];
        v129 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v129, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 136315650;
          *v167 = _IDSStunCandidatePairStateStrings;
          *&v167[8] = 2080;
          *&v167[10] = off_1EB2B43B0;
          *&v167[18] = 2112;
          *&v167[20] = requestCopy;
          _os_log_impl(&dword_1A7AD9000, v129, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v138 = off_1EB2B43B0;
            v140 = requestCopy;
            v136 = _IDSStunCandidatePairStateStrings;
            _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              v138 = off_1EB2B43B0;
              v140 = requestCopy;
              v136 = _IDSStunCandidatePairStateStrings;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
            }
          }
        }

        if (([v17 isSelfQRSession] & 1) == 0)
        {
          [(IDSGlobalLink *)self _startAllocbindFailoverTimerOnCandidatePair:v17 delay:2];
        }
      }

      if (theDicta >= 0xFFFFFFFFFFFFFFFELL)
      {
        v152[0] = MEMORY[0x1E69E9820];
        v152[1] = 3221225472;
        v152[2] = sub_1A7B90630;
        v152[3] = &unk_1E77E0F28;
        v152[4] = self;
        v153 = requestCopy;
        v154 = messageCopy;
        v155 = reallocCopy;
        v156 = stateCopy;
        IDSTransportThreadAddBlockAfter(v152, 1.0);
      }

      goto LABEL_34;
    }

    type = [messageCopy type];
    v27 = ids_monotonic_time();
    [messageCopy startTime];
    v29 = v27 - v28;
    allocateType = [v17 allocateType];
    v31 = 10.0;
    if (allocateType == 2)
    {
      v31 = GLUtilNATCheckTimeout();
    }

    if (v29 < v31)
    {
      v147 = messageCopy;
      goto LABEL_157;
    }

    [v17 setState:2];
    if (self->_useLinkEngine)
    {
      linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
      linkUniqueName = [v17 linkUniqueName];
      v50 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:linkUniqueName];

      if (v17 == v50)
      {
        linkEngine = [v17 linkEngine];
        linkUniqueName2 = [v17 linkUniqueName];
        [linkEngine linkDidFail:linkUniqueName2 errorCode:7 isRecoverable:0 shouldReconnect:0];
      }
    }

    requestID2 = [messageCopy requestID];
    [(IDSGlobalLink *)self _removeStunRequest:requestID2];

    requestID3 = [messageCopy requestID];
    [v17 removeStunRequest:requestID3];

    v55 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      v56 = (&_IDSStunCandidatePairStateStrings)[v150];
      *buf = 136315650;
      *v167 = v56;
      *&v167[8] = 2080;
      *&v167[10] = off_1EB2B43B8;
      *&v167[18] = 2112;
      *&v167[20] = requestCopy;
      _os_log_impl(&dword_1A7AD9000, v55, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v138 = off_1EB2B43B8;
        v140 = requestCopy;
        v136 = (&_IDSStunCandidatePairStateStrings)[v150];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v138 = off_1EB2B43B8;
          v140 = requestCopy;
          v136 = (&_IDSStunCandidatePairStateStrings)[v150];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    v140 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0, v136, v138, v140];
    if ((v140 | [(IDSGlobalLink *)self _hasConnectingRelayCandidatePair]))
    {
LABEL_131:
      if (allocateType == 2)
      {
        [messageCopy startTime];
        v91 = ((v27 - v90) * 1000.0);
        GLUtilReportAWDClientTimerEvent(308, 23, v17, self->_enableSKE, self->_isInitiator, v91);
        v92 = GLUCreateQRClientTimeEvent(308, 23, v17, self->_timeBase, v91);
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v94 = objc_opt_respondsToSelector();

        if (v94)
        {
          v95 = objc_loadWeakRetained(&self->_delegate);
          [v95 link:self didAddQREvent:v92];
        }

        if ([(IDSGlobalLink *)self _isExtIPDiscoveryDone])
        {
          v96 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v96, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v96, OS_LOG_TYPE_DEFAULT, "discard self allocate candidate pairs", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"discard self allocate candidate pairs");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"discard self allocate candidate pairs");
              }
            }
          }

          [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
        }

        [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
      }

      else
      {
        linkMetrics2 = [v17 linkMetrics];
        [linkMetrics2 allocBindRequestTimeOut];

        GLUtilReportAWDStunMessageEvent(messageCopy, 7, v17, 0.0);
        v92 = GLUCreateQRStunMessageEvent(messageCopy, 7u, v17, 0, 0.0);
        if (v92)
        {
          v98 = objc_loadWeakRetained(&self->_delegate);
          v99 = objc_opt_respondsToSelector();

          if (v99)
          {
            v100 = objc_loadWeakRetained(&self->_delegate);
            [v100 link:self didAddQREvent:v92];
          }
        }
      }

      [(IDSGlobalLink *)self _reportAWDAllocateTime];
      goto LABEL_34;
    }

    v151 = _Block_copy(self->_connectReadyHandler);
    v58 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v58, OS_LOG_TYPE_DEFAULT))
    {
      v59 = self->_idsSessionID;
      *buf = 138412802;
      *v167 = v59;
      *&v167[8] = 2048;
      *&v167[10] = type;
      *&v167[18] = 2048;
      *&v167[20] = 0x4024000000000000;
      _os_log_impl(&dword_1A7AD9000, v58, OS_LOG_TYPE_DEFAULT, "Connect to QR server for IDSSessionID: %@, stun message type %ld timed out after %lf seconds.", buf, 0x20u);
    }

    local3 = [v17 local];
    sessionID4 = [v17 sessionID];
    v61 = [(IDSGlobalLink *)self getAllocBindErrorCodeForSessionID:sessionID4];

    v62 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
    {
      v63 = (&_IDSStunTransportStrings)[[local3 transport]];
      *buf = 136315394;
      *v167 = v63;
      *&v167[8] = 1024;
      *&v167[10] = 7;
      _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v137 = (&_IDSStunTransportStrings)[[local3 transport]];
        v139 = 7;
        _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
        if (_IDSShouldLog())
        {
          v137 = (&_IDSStunTransportStrings)[[local3 transport]];
          v139 = 7;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
        }
      }
    }

    GLUtilReportAWDClientTimerEvent(305, 7, v17, self->_enableSKE, self->_isInitiator, 0.0);
    v64 = GLUCreateQRClientTimeEvent(305, v61, v17, self->_timeBase, 0.0);
    v65 = objc_loadWeakRetained(&self->_delegate);
    v66 = objc_opt_respondsToSelector();

    if (v66)
    {
      v67 = objc_loadWeakRetained(&self->_delegate);
      [v67 link:self didAddQREvent:v64];
    }

    v68 = [IDSFoundationLog GlobalLink:v137];
    if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
    {
      participantID = [v17 participantID];
      relaySessionToken = [v17 relaySessionToken];
      v71 = [relaySessionToken base64EncodedStringWithOptions:0];
      *buf = 134218242;
      *v167 = participantID;
      *&v167[8] = 2112;
      *&v167[10] = v71;
      _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "failed participant:[%16llX], token:[%@]", buf, 0x16u);
    }

    if (v151)
    {
      v72 = MEMORY[0x1E696ABC0];
      v73 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"Allocbind timed out." forKey:*MEMORY[0x1E696A578]];
      v74 = [v72 errorWithDomain:@"GlobalLink" code:7 userInfo:v73];

      v75 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7B903FC;
      block[3] = &unk_1E77DD0F0;
      v165 = v151;
      v76 = v74;
      v164 = v76;
      dispatch_async(v75, block);

      if (self->_clientType == 6)
      {
        v77 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v77, OS_LOG_TYPE_DEFAULT, "Stun Allocbind timed out. - gathering ABC with packet capture", buf, 2u);
        }

        [(IDSGlobalLink *)self _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"FailedToConnect" subTypeContext:@"StunAllocbindTimedout" duration:15];
      }
    }

    else
    {
      v88 = objc_loadWeakRetained(&self->_delegate);
      v89 = objc_opt_respondsToSelector();

      if ((v89 & 1) == 0)
      {
LABEL_130:

        goto LABEL_131;
      }

      v76 = objc_loadWeakRetained(&self->_delegate);
      [v76 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_130;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "failed to send allocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send allocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send allocbind request due to invalid token.");
      }
    }
  }

LABEL_35:
}

- (void)_sendUnallocbindRequestTimeOut:(id)out stunMessage:(id)message reason:(unsigned __int8)reason
{
  reasonCopy = reason;
  outCopy = out;
  messageCopy = message;
  if (outCopy && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v11 = CFDictionaryGetValue(tokenToCandidatePairs, outCopy)) != 0)
  {
    v12 = v11;
    if ([v11 state] != 6)
    {
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_sendUnallocbindRequestTimeOut: unallocbind request timed out.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"_sendUnallocbindRequestTimeOut: unallocbind request timed out.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendUnallocbindRequestTimeOut: unallocbind request timed out.");
          }
        }
      }

      requestID = [messageCopy requestID];
      [(IDSGlobalLink *)self _removeStunRequest:requestID];

      requestID2 = [messageCopy requestID];
      if (requestID2)
      {
        unallocbindRequestToReason = self->_unallocbindRequestToReason;

        if (unallocbindRequestToReason)
        {
          v17 = self->_unallocbindRequestToReason;
          requestID3 = [messageCopy requestID];
          CFDictionaryRemoveValue(v17, requestID3);
        }
      }

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v12 withReason:reasonCopy];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v12 withReason:reasonCopy];
      }

      v19 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
      v20 = v19;
      if (self->_state == 5)
      {
        [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
        if (!v20)
        {
          [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:8 reason:reasonCopy];
        }
      }

      else if (!v19 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v22 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
        {
          *v27 = 0;
          _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", v27, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
            }
          }
        }

        [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
      }

      GLUtilReportAWDStunMessageEvent(messageCopy, 8, v12, 0.0);
      v23 = GLUCreateQRStunMessageEvent(messageCopy, 8u, v12, 0, 0.0);
      if (v23)
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v25 = objc_opt_respondsToSelector();

        if (v25)
        {
          v26 = objc_loadWeakRetained(&self->_delegate);
          [v26 link:self didAddQREvent:v23];
        }
      }
    }
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      *v29 = 0;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_sendUnallocbindRequestTimeOut: invalid candidate pair.", v29, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendUnallocbindRequestTimeOut: invalid candidate pair.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendUnallocbindRequestTimeOut: invalid candidate pair.");
        }
      }
    }

    v12 = 0;
  }
}

- (void)_sendUnallocbindRequest:(id)request stunMessage:(id)message reason:(unsigned __int8)reason
{
  reasonCopy = reason;
  v58 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  messageCopy = message;
  if (self->_state >= 6)
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v53 = v11;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "skip unallocbind request, GL state (%s).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request, GL state (%s).");
        }
      }
    }

    goto LABEL_34;
  }

  if (requestCopy)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v13 = CFDictionaryGetValue(tokenToCandidatePairs, requestCopy)) == 0)
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        v20 = self->_tokenToCandidatePairs;
        *buf = 138412546;
        v53 = requestCopy;
        v54 = 2112;
        v55 = v20;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          }
        }
      }

      v14 = 0;
      goto LABEL_27;
    }

    v14 = v13;
    if (([v13 isRelayStunCandidatePair] & 1) == 0)
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v53 = requestCopy;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, not over relay.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, not over relay.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, not over relay.");
          }
        }
      }

      goto LABEL_27;
    }

    state = [v14 state];
    v16 = state;
    if (state <= 6 && ((1 << state) & 0x47) != 0)
    {
      v17 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = (&_IDSStunCandidatePairStateStrings)[v16];
        *buf = 138412546;
        v53 = requestCopy;
        v54 = 2080;
        v55 = v18;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, state [%s].");
          }
        }
      }

      goto LABEL_27;
    }

    sessionID = [v14 sessionID];
    if (!sessionID)
    {
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid relay-session-id.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid relay-session-id.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid relay-session-id.");
          }
        }
      }

      goto LABEL_88;
    }

    [v14 stopSessionConnectedTimer];
    [v14 stopSessionConvergenceTimer];
    [v14 stopSessionGoAwayTimer];
    if (messageCopy)
    {
      v24 = ids_monotonic_time();
      [messageCopy startTime];
      if (v24 - v25 > 3.0)
      {
        [(IDSGlobalLink *)self _sendUnallocbindRequestTimeOut:requestCopy stunMessage:messageCopy reason:reasonCopy];
LABEL_88:

LABEL_27:
        goto LABEL_34;
      }
    }

    else
    {
      messageCopy = StunUtilCreateMessage(3810, 0, v14, 0);
      if (!messageCopy)
      {
        v38 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "failed to create unallocbind message.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to create unallocbind message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create unallocbind message.");
            }
          }
        }

        messageCopy = 0;
        goto LABEL_88;
      }
    }

    v27 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v53 = messageCopy;
      v54 = 2112;
      v55 = requestCopy;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "send unallocbind request %@ for %@.", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v39 = messageCopy;
        v41 = requestCopy;
        _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request %@ for %@.");
        if (_IDSShouldLog())
        {
          v39 = messageCopy;
          v41 = requestCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request %@ for %@.");
        }
      }
    }

    v28 = [(IDSGlobalLink *)self _sendStunMessage:messageCopy candidatePair:v14, v39, v41];
    if (v16 != 5)
    {
      [v14 setState:5];
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        v30 = (&_IDSStunCandidatePairStateStrings)[v16];
        *buf = 136315650;
        v53 = v30;
        v54 = 2080;
        v55 = off_1EB2B43D0;
        v56 = 2112;
        v57 = requestCopy;
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v42 = off_1EB2B43D0;
          v43 = requestCopy;
          v40 = (&_IDSStunCandidatePairStateStrings)[v16];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v42 = off_1EB2B43D0;
            v43 = requestCopy;
            v40 = (&_IDSStunCandidatePairStateStrings)[v16];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }
    }

    if (v28 == -1 && !((self->_state != 5) | [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0]))
    {
      [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:24 reason:reasonCopy];
    }

    else
    {
      if (!self->_unallocbindRequestToReason)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        unallocbindRequestToReason = self->_unallocbindRequestToReason;
        self->_unallocbindRequestToReason = Mutable;
      }

      v33 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:{reasonCopy, v40, v42, v43}];
      if (v33)
      {
        v34 = self->_unallocbindRequestToReason;
        requestID = [messageCopy requestID];
        CFDictionarySetValue(v34, requestID, v33);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14EE4(messageCopy);
      }

      local = [v14 local];
      transport = [local transport];

      if ((transport - 1) > 1)
      {
        if ((transport - 3) <= 1)
        {
          v44[0] = MEMORY[0x1E69E9820];
          v44[1] = 3221225472;
          v44[2] = sub_1A7B916C8;
          v44[3] = &unk_1E77E0F50;
          v44[4] = self;
          v45 = requestCopy;
          messageCopy = messageCopy;
          v46 = messageCopy;
          v47 = reasonCopy;
          IDSTransportThreadAddBlockAfter(v44, 3.0);
        }
      }

      else if (reasonCopy != 5 || ([v14 testOptions] & 8) == 0 || objc_msgSend(v14, "testRequestedErrorCode") != 601)
      {
        v48[0] = MEMORY[0x1E69E9820];
        v48[1] = 3221225472;
        v48[2] = sub_1A7B916B4;
        v48[3] = &unk_1E77E0F50;
        v48[4] = self;
        v49 = requestCopy;
        messageCopy = messageCopy;
        v50 = messageCopy;
        v51 = reasonCopy;
        IDSTransportThreadAddBlockAfter(v48, 0.5);
      }
    }

    goto LABEL_88;
  }

  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid token.");
      }
    }
  }

LABEL_34:
}

- (int)_getExpensiveLinkFlagsForCandidatePair:(id)pair
{
  pairCopy = pair;
  local = [pairCopy local];
  v6 = -[IDSGlobalLink _isInterfaceExpensiveWithInterfaceIndex:](self, "_isInterfaceExpensiveWithInterfaceIndex:", [local index]);

  if (self->_islocalCellAttributeInexpensive)
  {
    local2 = [pairCopy local];
    isCellularStunCandidate = [local2 isCellularStunCandidate];

    if (isCellularStunCandidate)
    {
      v6 = 0;
    }
  }

  return v6;
}

- (BOOL)_localIsQualityMetadataSupported
{
  _accessLinkSelectionStrategy = [(IDSGlobalLink *)self _accessLinkSelectionStrategy];
  v4 = _accessLinkSelectionStrategy;
  if (!self->_useLinkEngine || (self->_useLinkSelection ? (v5 = _accessLinkSelectionStrategy == 0) : (v5 = 1), v5))
  {
    wrapsPacketsWithQualityMetadata = 0;
  }

  else
  {
    wrapsPacketsWithQualityMetadata = [_accessLinkSelectionStrategy wrapsPacketsWithQualityMetadata];
  }

  return wrapsPacketsWithQualityMetadata;
}

- (int64_t)_localCapabilityFlags
{
  if (![(IDSGlobalLink *)self _localIsQualityMetadataSupported])
  {
    return 1;
  }

  v2 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT))
  {
    *v4 = 0;
    _os_log_impl(&dword_1A7AD9000, v2, OS_LOG_TYPE_DEFAULT, "_localCapabilityFlags: allow quality metadata", v4, 2u);
  }

  return 3;
}

- (id)_createCommandData:(int64_t)data options:(id)options candidatePair:(id)pair
{
  v162 = *MEMORY[0x1E69E9840];
  optionsCopy = options;
  pairCopy = pair;
  memset(__b, 170, sizeof(__b));
  v158 = 0;
  remoteGlobalLinkVersion = self->_remoteGlobalLinkVersion;
  dataCopy = data;
  v9 = data == 1 && remoteGlobalLinkVersion > 0 || remoteGlobalLinkVersion == 0 && data == 32769 && !self->_isInitiator || data == 1 && self->_isInitiator;
  selfCopy = self;
  if (data <= 4)
  {
    switch(data)
    {
      case 1:
        goto LABEL_54;
      case 3:
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v62 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(pairCopy, "hbCounter")}];
        if (v62)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v62);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        v103 = [optionsCopy objectForKey:@"gl-attr-active-probing-link-id"];
        charValue = [v103 charValue];
        isActive = [pairCopy isActive];
        if (charValue > 0)
        {
          v106 = 1;
        }

        else
        {
          v106 = isActive;
        }

        if (v106 == 1)
        {
          *&buf[4] = 0;
          v107 = ids_monotonic_time();
          v108 = ntpTime32(v107);
          *buf = bswap32(v108);
          v109 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:12];
          if (v109)
          {
            CFDictionarySetValue(Mutable, @"gl-attr-rttreport", v109);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E1519C();
          }

          if (charValue > 0)
          {
            if (!v103 || (linkIDToRequestTimeStampAndRTT = selfCopy->_linkIDToRequestTimeStampAndRTT) == 0 || (v125 = CFDictionaryGetValue(linkIDToRequestTimeStampAndRTT, v103)) == 0)
            {
              v125 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if ([v125 count] == 250)
            {
              [v125 removeObjectAtIndex:0];
            }

            v126 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v108];
            [v125 addObject:v126];

            if (!selfCopy->_linkIDToRequestTimeStampAndRTT)
            {
              v127 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              v128 = selfCopy->_linkIDToRequestTimeStampAndRTT;
              selfCopy->_linkIDToRequestTimeStampAndRTT = v127;
            }

            if (v125)
            {
              CFDictionarySetValue(selfCopy->_linkIDToRequestTimeStampAndRTT, v103, v125);
            }
          }
        }

        goto LABEL_241;
      case 4:
        v39 = [(IDSGlobalLink *)self _filterNonSlicedLocalCandidates:self->_localCandidateList];
        v40 = +[IDSStunConnectionDataController sharedInstance];
        v41 = [v40 dataFromCandidates:v39 token:self->_cbuuid remoteDeviceVersion:self->_remoteDeviceVersion];

        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        v42 = v41;
        if (v42)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-conndata", v42);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15224();
        }

        v110 = [MEMORY[0x1E696AD98] numberWithInt:selfCopy->_localConnDataCounter];
        if (v110)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v110);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        v111 = +[IDSStunConnectionDataController sharedInstance];
        v112 = [v111 deliveryStatus:selfCopy->_cbuuid] == 0;

        if (v112)
        {
          v113 = +[IDSStunConnectionDataController sharedInstance];
          [v113 setDeliveryStatus:selfCopy->_cbuuid status:1];
        }

        goto LABEL_241;
    }

LABEL_78:
    if ((data - 32771) > 2)
    {
      if (data != 33008)
      {
LABEL_243:
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        self = selfCopy;
        goto LABEL_244;
      }

      Mutable = [optionsCopy mutableCopy];
    }

    else
    {
      v56 = [optionsCopy mutableCopy];
      Mutable = v56;
      if (@"gl-attr-remote-relay-link-id" && v56)
      {
        CFDictionaryRemoveValue(v56, @"gl-attr-remote-relay-link-id");
      }

      if (@"gl-attr-active-probing-link-id" && Mutable)
      {
        CFDictionaryRemoveValue(Mutable, @"gl-attr-active-probing-link-id");
        goto LABEL_244;
      }
    }

LABEL_242:
    if (!Mutable)
    {
      goto LABEL_243;
    }

LABEL_244:
    v134 = self->_controlMessageKey;
    if (v134)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-hmac", v134);
    }

    else
    {
      v135 = MEMORY[0x1E69E9C10];
      v136 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v135, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15768();
      }
    }

    v137 = [IDSGlobalLinkMessage messageWithCommand:dataCopy attributes:Mutable];
    [v137 write:__b outputLength:&v158];
    v117 = [MEMORY[0x1E695DEF0] dataWithBytes:__b length:v158];

    goto LABEL_250;
  }

  if (data <= 0x8000)
  {
    if (data != 5)
    {
      if (data == 6)
      {
        v10 = objc_alloc_init(MEMORY[0x1E695DF70]);
        v154 = 0u;
        v155 = 0u;
        v156 = 0u;
        v157 = 0u;
        allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        v12 = [allValues countByEnumeratingWithState:&v154 objects:v160 count:16];
        if (v12)
        {
          v13 = *v155;
          do
          {
            for (i = 0; i != v12; ++i)
            {
              if (*v155 != v13)
              {
                objc_enumerationMutation(allValues);
              }

              v15 = *(*(&v154 + 1) + 8 * i);
              if ([(NSData *)v15 isSharedQRSession]&& [(NSData *)v15 state]== 4)
              {
                v16 = [(IDSGlobalLink *)selfCopy _getExpensiveLinkFlagsForCandidatePair:v15];
                local = [(NSData *)v15 local];
                v18 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](selfCopy, "_isInterfaceConstrainedWithInterfaceIndex:", [local index]);

                if (v18)
                {
                  v19 = v16 | 2;
                }

                else
                {
                  v19 = v16;
                }

                local2 = [(NSData *)v15 local];
                v21 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](selfCopy, "_isInterfaceDelegatedWithInterfaceIndex:", [local2 index]);

                if (v21)
                {
                  v19 |= 4u;
                }

                local3 = [(NSData *)v15 local];
                cellularSlicingFlags = [local3 cellularSlicingFlags];

                if (cellularSlicingFlags)
                {
                  local4 = [(NSData *)v15 local];
                  cellularSlicingFlags2 = [local4 cellularSlicingFlags];

                  v19 |= cellularSlicingFlags2;
                }

                local5 = [(NSData *)v15 local];
                [local5 setLinkFlags:v19];

                v27 = v10 == 0;
                if (!v15)
                {
                  v27 = 1;
                }

                if (!v27)
                {
                  CFArrayAppendValue(v10, v15);
                }

                v28 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  *&buf[4] = v15;
                  _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "succeededCandidatePair: %@", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v147 = v15;
                    _IDSLogTransport(@"GL", @"IDS", @"succeededCandidatePair: %@");
                    if (_IDSShouldLog())
                    {
                      v147 = v15;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"succeededCandidatePair: %@");
                    }
                  }
                }
              }
            }

            v12 = [allValues countByEnumeratingWithState:&v154 objects:v160 count:16];
          }

          while (v12);
        }

        v29 = +[IDSStunRelayInterfaceInfoController sharedInstance];
        v30 = [v29 createRelayInterfaceInfoFromCandidatePairs:v10 token:selfCopy->_cbuuid];

        v31 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = [(__CFArray *)v10 count];
          v33 = [v30 length];
          *buf = 134218498;
          *&buf[4] = v32;
          *&buf[12] = 2048;
          *&buf[14] = v33;
          *&buf[22] = 2112;
          *&buf[24] = optionsCopy;
          _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v34 = [(__CFArray *)v10 count];
            v148 = [v30 length];
            v149 = optionsCopy;
            v147 = v34;
            _IDSLogTransport(@"GL", @"IDS", @"candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@");
            if (_IDSShouldLog())
            {
              v35 = [(__CFArray *)v10 count:v34];
              v148 = [v30 length];
              v149 = optionsCopy;
              v147 = v35;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"candidatePair count: %lu, interfaceInfoRequest length: %lu options: %@");
            }
          }
        }

        Mutable = [optionsCopy mutableCopy];
        if (!Mutable)
        {
          Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        }

        _localCapabilityFlags = [(IDSGlobalLink *)selfCopy _localCapabilityFlags];
        v38 = [MEMORY[0x1E696AD98] numberWithInteger:_localCapabilityFlags];
        if (v38)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-capability", v38);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E14F7C();
        }

        if (selfCopy->_shouldReportAcceptDelay && !selfCopy->_isInitiator)
        {
          v114 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:selfCopy->_acceptDelayU32];
          if (v114)
          {
            CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v114);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15004();
          }
        }

        v132 = v30;
        if (v132)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-relay-link-interface-info", v132);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E1508C();
        }

        v133 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:selfCopy->_localRelayInterfaceCounter];
        if (v133)
        {
          CFDictionarySetValue(Mutable, @"gl-attr-counter", v133);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15114();
        }

        goto LABEL_241;
      }

      goto LABEL_78;
    }

    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v57 = [MEMORY[0x1E696AD98] numberWithInt:self->_nominateCount];
    if (v57)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-counter", v57);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15114();
    }

LABEL_146:

LABEL_241:
    self = selfCopy;
    goto LABEL_242;
  }

  if (data == 32774)
  {
    v58 = [optionsCopy mutableCopy];
    Mutable = v58;
    if (@"gl-attr-remote-relay-link-id")
    {
      v59 = v58 == 0;
    }

    else
    {
      v59 = 1;
    }

    if (!v59)
    {
      CFDictionaryRemoveValue(v58, @"gl-attr-remote-relay-link-id");
    }

    if (@"gl-attr-active-probing-link-id" && Mutable)
    {
      CFDictionaryRemoveValue(Mutable, @"gl-attr-active-probing-link-id");
    }

    _localCapabilityFlags2 = [(IDSGlobalLink *)self _localCapabilityFlags];
    v61 = [MEMORY[0x1E696AD98] numberWithInteger:_localCapabilityFlags2];
    if (v61)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-capability", v61);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E14F7C();
    }

    if (!self->_shouldReportAcceptDelay || self->_isInitiator)
    {
      goto LABEL_242;
    }

    v57 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_acceptDelayU32];
    if (v57)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v57);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15004();
    }

    goto LABEL_146;
  }

  if (data != 32769)
  {
    goto LABEL_78;
  }

LABEL_54:
  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  if (!v9)
  {
LABEL_67:
    local6 = [pairCopy local];
    radioAccessTechnology = [local6 radioAccessTechnology];

    if (selfCopy->_remoteDeviceVersion <= 2 && radioAccessTechnology == 9)
    {
      v54 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "RATType Wired -> NonCell due to remote version", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"RATType Wired -> NonCell due to remote version");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"RATType Wired -> NonCell due to remote version");
          }
        }
      }

      radioAccessTechnology = 0;
    }

    v55 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:radioAccessTechnology];
    if (v55)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-rat", v55);
    }

    else
    {
      v63 = MEMORY[0x1E69E9C10];
      v64 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v63, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15334();
      }
    }

    v65 = MEMORY[0x1E696AD98];
    local7 = [pairCopy local];
    v67 = [v65 numberWithInteger:{objc_msgSend(local7, "transport")}];

    if (v67)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-transport", v67);
    }

    else
    {
      v68 = MEMORY[0x1E69E9C10];
      v69 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v68, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E153BC();
      }
    }

    v70 = MEMORY[0x1E696AD98];
    local8 = [pairCopy local];
    v72 = [v70 numberWithUnsignedInt:{objc_msgSend(local8, "mtu")}];

    if (v72)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-mtu", v72);
    }

    else
    {
      v73 = MEMORY[0x1E69E9C10];
      v74 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15444();
      }
    }

    _localCapabilityFlags3 = [(IDSGlobalLink *)selfCopy _localCapabilityFlags];
    v76 = [MEMORY[0x1E696AD98] numberWithInteger:_localCapabilityFlags3];
    if (v76)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-capability", v76);
    }

    else
    {
      v77 = MEMORY[0x1E69E9C10];
      v78 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v77, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14F7C();
      }
    }

    local9 = [pairCopy local];
    v80 = +[IDSSockAddrWrapper wrapperWithSockAddr:](IDSSockAddrWrapper, "wrapperWithSockAddr:", [local9 address]);

    v81 = v80;
    if (v81)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-relayremoteaddress", v81);
    }

    else
    {
      v82 = MEMORY[0x1E69E9C10];
      v83 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v82, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E154CC();
      }
    }

    v84 = [(IDSGlobalLink *)selfCopy _getExpensiveLinkFlagsForCandidatePair:pairCopy];
    local10 = [pairCopy local];
    v86 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](selfCopy, "_isInterfaceConstrainedWithInterfaceIndex:", [local10 index]);

    if (v86)
    {
      v87 = v84 | 2;
    }

    else
    {
      v87 = v84;
    }

    if (selfCopy->_remoteDeviceVersion >= 2)
    {
      local11 = [pairCopy local];
      v89 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](selfCopy, "_isInterfaceDelegatedWithInterfaceIndex:", [local11 index]);

      if (v89)
      {
        v87 |= 4u;
      }
    }

    local12 = [pairCopy local];
    [local12 setLinkFlags:v87];

    v91 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v87];
    if (v91)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-link-flags", v91);
    }

    else
    {
      v92 = MEMORY[0x1E69E9C10];
      v93 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v92, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15554();
      }
    }

    v94 = +[IDSCellularLinkMonitor sharedInstance];
    dataSoMaskBits = [v94 dataSoMaskBits];

    v96 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:dataSoMaskBits];
    if (v96)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-data-so-mask", v96);
    }

    else
    {
      v97 = MEMORY[0x1E69E9C10];
      v98 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v97, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E155DC();
      }
    }

    local13 = [pairCopy local];
    [local13 setDataSoMask:dataSoMaskBits];

    if ([(NSString *)selfCopy->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
    {
      defaultRemoteDeviceCBUUID = [pairCopy defaultRemoteDeviceCBUUID];
      v101 = @"gl-attr-remote-cbuuid";
      if (defaultRemoteDeviceCBUUID)
      {
        memset(buf, 170, 16);
        [defaultRemoteDeviceCBUUID getUUIDBytes:buf];
        v102 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
        if (v102)
        {
          CFDictionarySetValue(Mutable, v101, v102);
        }

        else
        {
          v118 = MEMORY[0x1E69E9C10];
          v119 = MEMORY[0x1E69E9C10];
          if (os_log_type_enabled(v118, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15664();
          }
        }
      }

      else
      {
        v115 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v115, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v115, OS_LOG_TYPE_DEFAULT, "watch cbuuid is missing.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"watch cbuuid is missing.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"watch cbuuid is missing.");
            }
          }
        }
      }
    }

    if (dataCopy == 1)
    {
      memset(buf, 170, 16);
      linkUUID = [pairCopy linkUUID];
      [linkUUID getUUIDBytes:buf];

      v121 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
      if (v121)
      {
        CFDictionarySetValue(Mutable, @"gl-attr-linkuuid", v121);
      }

      else
      {
        v122 = MEMORY[0x1E69E9C10];
        v123 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v122, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E156E0();
        }
      }

      CFDictionarySetValue(Mutable, @"gl-attr-version", &unk_1F1B200D8);
    }

    goto LABEL_241;
  }

  v43 = [(NSData *)self->_skeData length];
  v44 = v43;
  if (!v43 || self->_skeToRemoteComplete)
  {
    if (!self->_isInitiator)
    {
      skeData = [pairCopy skeData];
      if (skeData)
      {
        v46 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
        {
          v47 = [(NSData *)skeData length];
          candidatePairToken = [pairCopy candidatePairToken];
          *buf = 134218498;
          *&buf[4] = skeData;
          *&buf[12] = 1024;
          *&buf[14] = v47;
          *&buf[18] = 2112;
          *&buf[20] = candidatePairToken;
          _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "piggyback SKE data %p (%uB) for realloc pair %@.", buf, 0x1Cu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v49 = [(NSData *)skeData length];
            [pairCopy candidatePairToken];
            v149 = v148 = v49;
            v147 = skeData;
            _IDSLogTransport(@"GL", @"IDS", @"piggyback SKE data %p (%uB) for realloc pair %@.");

            if (_IDSShouldLog())
            {
              v50 = [(NSData *)skeData length:skeData];
              [pairCopy candidatePairToken];
              v149 = v148 = v50;
              v147 = skeData;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"piggyback SKE data %p (%uB) for realloc pair %@.");
            }
          }
        }

        v51 = skeData;
        CFDictionarySetValue(Mutable, @"gl-attr-skedata", v51);
      }
    }

    goto LABEL_67;
  }

  if (v43 < 0x101u)
  {
    v129 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v129, OS_LOG_TYPE_DEFAULT))
    {
      skeData = self->_skeData;
      *buf = 134218240;
      *&buf[4] = skeData;
      *&buf[12] = 1024;
      *&buf[14] = v44;
      _os_log_impl(&dword_1A7AD9000, v129, OS_LOG_TYPE_DEFAULT, "piggyback SKE data %p (%uB), send session connected.", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v147 = self->_skeData;
        v148 = v44;
        _IDSLogTransport(@"GL", @"IDS", @"piggyback SKE data %p (%uB), send session connected.");
        if (_IDSShouldLog())
        {
          v147 = self->_skeData;
          v148 = v44;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"piggyback SKE data %p (%uB), send session connected.");
        }
      }
    }

    v131 = self->_skeData;
    if (v131)
    {
      CFDictionarySetValue(Mutable, @"gl-attr-skedata", v131);
    }

    else
    {
      v139 = MEMORY[0x1E69E9C10];
      v140 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v139, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E152AC();
      }
    }

    [pairCopy setSentSKEData:1];
    self->_delaySessionConnected = 0;
    if (!self->_isInitiator)
    {
      [pairCopy setSkeData:self->_skeData];
      v141 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_acceptDelayU32];
      if (v141)
      {
        CFDictionarySetValue(Mutable, @"gl-attr-acceptdelay", v141);
      }

      else
      {
        v142 = MEMORY[0x1E69E9C10];
        v143 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v142, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15004();
        }
      }

      v144 = dataCopy != 32769;
      if (self->_remoteGlobalLinkVersion)
      {
        v144 = 1;
      }

      if (!v144)
      {
        v145 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v145, OS_LOG_TYPE_DEFAULT))
        {
          v146 = self->_skeData;
          *buf = 134217984;
          *&buf[4] = v146;
          _os_log_impl(&dword_1A7AD9000, v145, OS_LOG_TYPE_DEFAULT, "SKE is complete for Receiver, remove SKE data %p.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v147 = self->_skeData;
            _IDSLogTransport(@"GL", @"IDS", @"SKE is complete for Receiver, remove SKE data %p.");
            if (_IDSShouldLog())
            {
              v147 = self->_skeData;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE is complete for Receiver, remove SKE data %p.");
            }
          }
        }

        self->_skeToRemoteComplete = 1;
      }
    }

    goto LABEL_67;
  }

  v116 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    *&buf[4] = v44;
    _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "SKE data is too long (%uB).", buf, 8u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"SKE data is too long (%uB).");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is too long (%uB).");
      }
    }
  }

  v117 = 0;
LABEL_250:

  return v117;
}

- (BOOL)_skipCommandMessage:(int64_t)message candidatePair:(id)pair timeNow:(double)now
{
  v19 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  state = [pairCopy state];
  if (state <= 2 && ![pairCopy isNominated])
  {
    goto LABEL_24;
  }

  LOBYTE(v9) = 0;
  if (message > 3)
  {
    switch(message)
    {
      case 4:
        v9 = +[IDSStunConnectionDataController sharedInstance];
        v14 = [v9 deliveryStatus:self->_cbuuid];

        LOBYTE(v9) = v14 > 1;
        goto LABEL_25;
      case 5:
        if ([pairCopy isActive] & 1) == 0 && (objc_msgSend(pairCopy, "isNominated"))
        {
          goto LABEL_23;
        }

        break;
      case 6:
        v10 = +[IDSStunRelayInterfaceInfoController sharedInstance];
        v11 = [v10 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

        if (v11 < 3)
        {
          goto LABEL_23;
        }

        v12 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          candidatePairToken = [pairCopy candidatePairToken];
          *buf = 138412290;
          v18 = candidatePairToken;
          _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip command 0006 for %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          candidatePairToken2 = [pairCopy candidatePairToken];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip command 0006 for %@");
        }

        break;
      default:
        goto LABEL_25;
    }

LABEL_24:
    LOBYTE(v9) = 1;
    goto LABEL_25;
  }

  switch(message)
  {
    case 1:
      LOBYTE(v9) = state != 3;
      break;
    case 2:
      LOBYTE(v9) = state == 6;
      break;
    case 3:
      if (([pairCopy pendingRealloc] & 1) == 0)
      {
        LODWORD(v9) = [pairCopy hbStarted] ^ 1;
        break;
      }

LABEL_23:
      LOBYTE(v9) = 0;
      break;
  }

LABEL_25:

  return v9;
}

- (BOOL)_shouldSkipCommand:(int64_t)command withCandidatePair:(id)pair connectionDataCounter:(int)counter relayInterfaceCounter:(int)interfaceCounter
{
  *&v26[5] = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  v11 = pairCopy;
  if (command == 6)
  {
    v17 = +[IDSStunRelayInterfaceInfoController sharedInstance];
    v18 = [v17 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

    if ((v18 - 3) <= 0xFFFFFFFFFFFFFFFDLL)
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v26 = v11;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "relay interface info is not in progress or waiting, no need to retransmit: %@, return YES", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"relay interface info is not in progress or waiting, no need to retransmit: %@, return YES");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"relay interface info is not in progress or waiting, no need to retransmit: %@, return YES");
          }
        }
      }

      goto LABEL_43;
    }

    if ((interfaceCounter & 0x80000000) == 0 && self->_localRelayInterfaceCounter > interfaceCounter)
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        localRelayInterfaceCounter = self->_localRelayInterfaceCounter;
        *buf = 67109376;
        v26[0] = interfaceCounter;
        LOWORD(v26[1]) = 1024;
        *(&v26[1] + 2) = localRelayInterfaceCounter;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "relayInterfaceCounter increased, skip sending old version old %d current %d", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"relayInterfaceCounter increased, skip sending old version old %d current %d");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"relayInterfaceCounter increased, skip sending old version old %d current %d");
          }
        }
      }

      goto LABEL_43;
    }

    goto LABEL_44;
  }

  if (command == 4)
  {
    v13 = +[IDSStunConnectionDataController sharedInstance];
    v14 = [v13 deliveryStatus:self->_cbuuid];

    if (v14 != 1)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v26 = v11;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "connection data is not in progress, no need to retransmit: %@, return YES", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"connection data is not in progress, no need to retransmit: %@, return YES");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data is not in progress, no need to retransmit: %@, return YES");
          }
        }
      }

      goto LABEL_43;
    }

    if ((counter & 0x80000000) == 0 && self->_localConnDataCounter > counter)
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        localConnDataCounter = self->_localConnDataCounter;
        *buf = 67109376;
        v26[0] = counter;
        LOWORD(v26[1]) = 1024;
        *(&v26[1] + 2) = localConnDataCounter;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "connection data counter increased, skip sending old version old %d current %d", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"connection data counter increased, skip sending old version old %d current %d");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"connection data counter increased, skip sending old version old %d current %d");
          }
        }
      }

      goto LABEL_43;
    }

LABEL_44:
    v23 = 0;
    goto LABEL_45;
  }

  if (command != 1 || !self->_enableSKE || !self->_skeToRemoteComplete || ![pairCopy recvConnectedAck])
  {
    goto LABEL_44;
  }

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "already received remote SKE, return YES", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"already received remote SKE, return YES");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"already received remote SKE, return YES");
      }
    }
  }

LABEL_43:
  v23 = 1;
LABEL_45:

  return v23;
}

- (void)sendTestPacketCommandMessage:(id)message candidatePair:(id)pair
{
  v12[1] = *MEMORY[0x1E69E9840];
  messageCopy = message;
  pairCopy = pair;
  if (!messageCopy)
  {
    messageCopy = [MEMORY[0x1E695DEF0] data];
  }

  v11 = @"gl-attr-generic-data";
  v12[0] = messageCopy;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v12 forKeys:&v11 count:1];
  v9 = [v8 mutableCopy];

  if ([pairCopy remoteRelayLinkID])
  {
    v10 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(pairCopy, "remoteRelayLinkID")}];
    [v9 setObject:v10 forKeyedSubscript:@"gl-attr-remote-relay-link-id"];
  }

  [(IDSGlobalLink *)self _sendCommandMessage:33008 stunMessage:0 options:v9 candidatePair:pairCopy];
}

- (void)sendTestPacketChannelDataMessage:(id)message candidatePair:(id)pair
{
  messageCopy = message;
  pairCopy = pair;
  if (!messageCopy)
  {
    messageCopy = [MEMORY[0x1E695DEF0] data];
  }

  v8 = _IDSLinkPacketBufferCreate();
  *(v8 + 1216) = [pairCopy linkID];
  v8[2] = [messageCopy length];
  [messageCopy getBytes:*v8 length:{objc_msgSend(messageCopy, "length")}];
  *(v8 + 134) |= 0x80000u;
  if ([(IDSGlobalLink *)self _sendChannelDataPacketBuffer:v8 candidatePair:pairCopy])
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *v10 = 0;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to send test packet to relay server", v10, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to send test packet to relay server");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send test packet to relay server");
        }
      }
    }
  }
}

- (void)_sendCommandMessage:(int64_t)message stunMessage:(id)stunMessage options:(id)options candidatePairToken:(id)token
{
  v22 = *MEMORY[0x1E69E9840];
  stunMessageCopy = stunMessage;
  optionsCopy = options;
  tokenCopy = token;
  if (tokenCopy && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v14 = CFDictionaryGetValue(tokenToCandidatePairs, tokenCopy)) != 0 || tokenCopy && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v14 = CFDictionaryGetValue(tokenToStunCheckPairs, tokenCopy)) != 0)
  {
    v16 = v14;
LABEL_9:
    [(IDSGlobalLink *)self _sendCommandMessage:message stunMessage:stunMessageCopy options:optionsCopy candidatePair:v16];

    goto LABEL_10;
  }

  v16 = [(IDSGlobalLink *)self _findVirtualCandidatePair:tokenCopy];
  if (v16)
  {
    goto LABEL_9;
  }

  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    messageCopy = message;
    v20 = 2112;
    v21 = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "send command %04lx failed due to invalid candidate pair %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"send command %04lx failed due to invalid candidate pair %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send command %04lx failed due to invalid candidate pair %@");
      }
    }
  }

LABEL_10:
}

- (void)_sendCommandMessage:(int64_t)message stunMessage:(id)stunMessage options:(id)options candidatePair:(id)pair
{
  v123 = *MEMORY[0x1E69E9840];
  stunMessageCopy = stunMessage;
  optionsCopy = options;
  pairCopy = pair;
  v13 = pairCopy;
  v108 = optionsCopy;
  v109 = stunMessageCopy;
  if (self->_state >= 6)
  {
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = _IDSLinkStateStrings[self->_state];
      *buf = 134218242;
      *v120 = message;
      *&v120[8] = 2080;
      *v121 = v15;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "skip session command %04lx, GL state (%s).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip session command %04lx, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip session command %04lx, GL state (%s).");
        }
      }
    }

    goto LABEL_10;
  }

  if ([pairCopy isRelayStunCandidatePair])
  {
    [(IDSGlobalLink *)self _sendChannelDataCommandMessage:message packetBuffer:0 options:optionsCopy candidatePair:v13];
    goto LABEL_10;
  }

  state = [v13 state];
  isP2P = [v13 isP2P];
  v106 = state;
  v18 = state - 5;
  if (isP2P && v18 <= 0xFFFFFFFFFFFFFFFDLL)
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      candidatePairToken = [v13 candidatePairToken];
      v21 = (&_IDSStunCandidatePairStateStrings)[v106];
      *buf = 138412802;
      *v120 = candidatePairToken;
      *&v120[8] = 2080;
      *v121 = v21;
      *&v121[8] = 1024;
      *&v121[10] = message;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], not sending command %04x.", buf, 0x1Cu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        candidatePairToken2 = [v13 candidatePairToken];
        v100 = (&_IDSStunCandidatePairStateStrings)[v106];
        _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], not sending command %04x.");

        if (_IDSShouldLog())
        {
          v23 = [v13 candidatePairToken:candidatePairToken2];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], not sending command %04x.");
        }
      }
    }

    goto LABEL_10;
  }

  messageCopy = message;
  selfCopy = self;
  v24 = v18 < 0xFFFFFFFFFFFFFFFELL;
  local = [v13 local];
  address = [local address];

  if (([v13 isRelayStunCandidatePair]& v24) != 1)
  {
LABEL_46:
    v48 = ids_monotonic_time();
    v49 = [v108 objectForKey:@"gl-attr-active-probing-link-id"];
    charValue = [v49 charValue];

    v51 = messageCopy;
    if (!charValue)
    {
      if ([(IDSGlobalLink *)selfCopy _skipCommandMessage:messageCopy candidatePair:v13 timeNow:v48])
      {
        v59 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v59, OS_LOG_TYPE_DEBUG))
        {
          candidatePairToken3 = [v13 candidatePairToken];
          v61 = (&_IDSStunCandidatePairStateStrings)[[v13 state]];
          *buf = 134218498;
          *v120 = messageCopy;
          *&v120[8] = 2112;
          *v121 = candidatePairToken3;
          *&v121[8] = 2080;
          *&v121[10] = v61;
          _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEBUG, "skip session command %04lx for %@, state [%s].", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          candidatePairToken4 = [v13 candidatePairToken];
          [v13 state];
          _IDSLogV(1, @"IDSFoundation", @"GL", @"skip session command %04lx for %@, state [%s].");
        }

        goto LABEL_10;
      }

      v51 = messageCopy;
      if (messageCopy == 3)
      {
        [v13 hbStartTime];
        if (v67 == 0.0)
        {
          v68 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v120 = v13;
            _os_log_impl(&dword_1A7AD9000, v68, OS_LOG_TYPE_DEFAULT, "session heartbeat request start now for %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v98 = v13;
              _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request start now for %@");
              if (_IDSShouldLog())
              {
                v98 = v13;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request start now for %@");
              }
            }
          }

          [v13 setHbStartTime:v48, v98, v99, v103, v104];
          v51 = 3;
        }

        else
        {
          v51 = 3;
          if (v48 - v67 > 60.0)
          {
            v96 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v96, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v120 = v13;
              _os_log_impl(&dword_1A7AD9000, v96, OS_LOG_TYPE_DEFAULT, "session heartbeat request message timed out, disconnect %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v98 = v13;
                _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request message timed out, disconnect %@");
                if (_IDSShouldLog())
                {
                  v98 = v13;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request message timed out, disconnect %@");
                }
              }
            }

            v97 = [v13 isQUIC:v98];
            candidatePairToken5 = [v13 candidatePairToken];
            if (v97)
            {
              goto LABEL_61;
            }

            goto LABEL_162;
          }
        }
      }
    }

    if (v109)
    {
      [(IDSStunMessage *)v109 startTime];
      if (v48 - v52 > 30.0)
      {
        if (messageCopy == 6)
        {
          v94 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v94, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v94, OS_LOG_TYPE_DEFAULT, "session relay interface information message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session relay interface information message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session relay interface information message timed out.");
              }
            }
          }

          [(IDSGlobalLink *)selfCopy _discardKeyMaterialMessage:12, v98];
          v95 = +[IDSStunRelayInterfaceInfoController sharedInstance];
          [v95 setRelayInterfaceInfoDeliveryStatus:selfCopy->_cbuuid status:4];

          goto LABEL_10;
        }

        if (messageCopy == 4)
        {
          v92 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v92, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v92, OS_LOG_TYPE_DEFAULT, "session connection data message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session connection data message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connection data message timed out.");
              }
            }
          }

          v93 = +[IDSStunConnectionDataController sharedInstance];
          [v93 setDeliveryStatus:selfCopy->_cbuuid status:3];

          goto LABEL_10;
        }

        if (messageCopy != 1)
        {
          goto LABEL_10;
        }

        v53 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v53, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *v120 = v13;
          _os_log_impl(&dword_1A7AD9000, v53, OS_LOG_TYPE_DEFAULT, "session connected message timed out, disconnect %@.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v98 = v13;
            _IDSLogTransport(@"GL", @"IDS", @"session connected message timed out, disconnect %@.");
            if (_IDSShouldLog())
            {
              v98 = v13;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message timed out, disconnect %@.");
            }
          }
        }

        linkEngine = [v13 linkEngine];

        if (linkEngine)
        {
          linkEngine2 = [v13 linkEngine];
          linkUniqueName = [v13 linkUniqueName];
          [linkEngine2 linkDidFail:linkUniqueName errorCode:9 isRecoverable:0 shouldReconnect:0];
        }

        isQUIC = [v13 isQUIC];
        candidatePairToken5 = [v13 candidatePairToken];
        if (isQUIC)
        {
LABEL_61:
          [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:candidatePairToken5 reason:9];

          goto LABEL_10;
        }

LABEL_162:
        [(IDSGlobalLink *)selfCopy _sendUnallocbindRequest:candidatePairToken5 stunMessage:0 reason:9];

        goto LABEL_10;
      }

      if ((messageCopy & 0xFFFFFFFFFFFF7FFFLL) == 4 && v108 || (messageCopy & 0xFFFFFFFFFFFF7FFFLL) == 6 && v108)
      {
        v69 = [v108 objectForKey:@"gl-attr-counter"];
        [v69 intValue];
      }

      if ([IDSGlobalLink _shouldSkipCommand:selfCopy withCandidatePair:"_shouldSkipCommand:withCandidatePair:connectionDataCounter:relayInterfaceCounter:" connectionDataCounter:v98 relayInterfaceCounter:?])
      {
        goto LABEL_10;
      }
    }

    else
    {
      v62 = [(IDSGlobalLink *)selfCopy _createCommandData:v51 options:v108 candidatePair:v13];
      if (!v62)
      {
        v70 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 134217984;
          *v120 = messageCopy;
          _os_log_impl(&dword_1A7AD9000, v70, OS_LOG_TYPE_DEFAULT, "failed to get indication data, skip session command (%04lx) message.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to get indication data, skip session command (%04lx) message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get indication data, skip session command (%04lx) message.");
            }
          }
        }

        v109 = 0;
        goto LABEL_10;
      }

      if ([v13 isRelayStunCandidatePair])
      {
        v63 = 22;
      }

      else
      {
        v63 = 23;
      }

      v109 = [[IDSStunMessage alloc] initWithType:v63];
      channelNumber = [v13 channelNumber];
      v65 = objc_alloc_init(MEMORY[0x1E695DF90]);
      v66 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:__rev16(channelNumber)];
      if (v66)
      {
        CFDictionarySetValue(v65, @"ids-stun-attribute-channelnumber", v66);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E157F0();
      }

      CFDictionarySetValue(v65, @"ids-stun-attribute-data", v62);
      v71 = [v108 objectForKey:@"gl-attr-remote-relay-link-id"];
      if (v71)
      {
        CFDictionarySetValue(v65, @"ids-stun-attribute-relay-link-id", v71);
      }

      [(IDSStunMessage *)v109 setTransactionID:0 attributes:v65];
      [(IDSStunMessage *)v109 setStartTime:v48];
    }

    v72 = +[IDSFoundationLog GlobalLink];
    v73 = os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT);
    if (charValue <= 0)
    {
      if (v73)
      {
        type = [(IDSStunMessage *)v109 type];
        candidatePairToken6 = [v13 candidatePairToken];
        idsSessionID = selfCopy->_idsSessionID;
        sessionID = [v13 sessionID];
        *buf = 67110146;
        *v120 = messageCopy;
        *&v120[4] = 1024;
        *&v120[6] = type;
        *v121 = 2112;
        *&v121[2] = candidatePairToken6;
        *&v121[10] = 2112;
        *&v121[12] = idsSessionID;
        *&v121[20] = 2112;
        *&v121[22] = sessionID;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "Send command %04x (stun:%04x) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x2Cu);
      }
    }

    else
    {
      if (v73)
      {
        type2 = [(IDSStunMessage *)v109 type];
        candidatePairToken7 = [v13 candidatePairToken];
        v76 = selfCopy->_idsSessionID;
        sessionID2 = [v13 sessionID];
        *buf = 67110402;
        *v120 = messageCopy;
        *&v120[4] = 1024;
        *&v120[6] = charValue;
        *v121 = 1024;
        *&v121[2] = type2;
        *&v121[6] = 2112;
        *&v121[8] = candidatePairToken7;
        *&v121[16] = 2112;
        *&v121[18] = v76;
        *&v121[26] = 2112;
        *&v121[28] = sessionID2;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "Send command %04x (active probing on link %d) (stun:%04x) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x32u);
      }

      if (selfCopy->_maxLinkID <= charValue)
      {
        v78 = 0;
      }

      else
      {
        v78 = selfCopy->_candidatePairs[charValue];
      }

      v72 = v13;
      v13 = v78;
    }

    [(IDSGlobalLink *)selfCopy _sendStunMessage:v109 candidatePair:v13];
    v83 = 0;
    v84 = messageCopy;
    if (messageCopy != 3 && (messageCopy & 0x8000) == 0)
    {
      v83 = v109;
    }

    v85 = charValue > 0 && messageCopy == 3;
    if (v85 || (messageCopy & 0x8000) != 0)
    {
LABEL_152:

      goto LABEL_10;
    }

    v86 = 1.0;
    if (messageCopy != 6 && messageCopy != 1)
    {
      v89 = v108;
      goto LABEL_151;
    }

    [(IDSStunMessage *)v109 startTime];
    if (v48 - v87 < 2.0)
    {
      v88 = selfCopy->_allocbindEndTime - selfCopy->_allocbindStartTime;
      v84 = messageCopy;
      v89 = v108;
      if (v88 <= 0.0)
      {
LABEL_151:
        v110[0] = MEMORY[0x1E69E9820];
        v110[1] = 3221225472;
        v110[2] = sub_1A7B9556C;
        v110[3] = &unk_1E77E0F78;
        v110[4] = selfCopy;
        v114 = v84;
        v111 = v83;
        v112 = v89;
        v113 = v13;
        IDSTransportThreadAddBlockAfter(v110, v86);

        goto LABEL_152;
      }

      v90 = v88 + v88;
      if (v88 + v88 > 0.2)
      {
        v90 = 0.2;
      }

      if (v90 >= 0.05)
      {
        v86 = v90;
      }

      else
      {
        v86 = 0.05;
      }

      v91 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v91, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134218240;
        *v120 = v86;
        *&v120[8] = 2048;
        *v121 = v88;
        _os_log_impl(&dword_1A7AD9000, v91, OS_LOG_TYPE_DEFAULT, "use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
          }
        }
      }
    }

    v84 = messageCopy;
    v89 = v108;
    goto LABEL_151;
  }

  v117 = 0u;
  v118 = 0u;
  v115 = 0u;
  v116 = 0u;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = [allValues countByEnumeratingWithState:&v115 objects:v122 count:16];
  if (v28)
  {
    v29 = *v116;
    while (2)
    {
      for (i = 0; i != v28; ++i)
      {
        if (*v116 != v29)
        {
          objc_enumerationMutation(allValues);
        }

        v31 = *(*(&v115 + 1) + 8 * i);
        local2 = [v31 local];
        address2 = [local2 address];

        sessionID3 = [v31 sessionID];
        sessionID4 = [v13 sessionID];
        if ([sessionID3 isEqualToString:sessionID4] && (objc_msgSend(v31, "state") == 3 || objc_msgSend(v31, "state") == 4))
        {
          v36 = IsSameSA(address, address2);

          if (v36)
          {
            candidatePairToken8 = [v13 candidatePairToken];
            candidatePairToken9 = [v31 candidatePairToken];
            v44 = v31;

            v45 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
            {
              v47 = (&_IDSStunCandidatePairStateStrings)[v106];
              *buf = 138413058;
              *v120 = candidatePairToken8;
              *&v120[8] = 2080;
              *v121 = v47;
              *&v121[8] = 1024;
              *&v121[10] = messageCopy;
              *&v121[14] = 2112;
              *&v121[16] = candidatePairToken9;
              _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], send command %04x using %@.", buf, 0x26u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v103 = messageCopy;
                v104 = candidatePairToken9;
                v98 = candidatePairToken8;
                v99 = (&_IDSStunCandidatePairStateStrings)[v106];
                _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], send command %04x using %@.");
                if (_IDSShouldLog())
                {
                  v103 = messageCopy;
                  v104 = candidatePairToken9;
                  v98 = candidatePairToken8;
                  v99 = (&_IDSStunCandidatePairStateStrings)[v106];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], send command %04x using %@.");
                }
              }
            }

            v13 = v44;
            goto LABEL_46;
          }
        }

        else
        {
        }
      }

      v28 = [allValues countByEnumeratingWithState:&v115 objects:v122 count:16];
      if (v28)
      {
        continue;
      }

      break;
    }
  }

  v37 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
  {
    candidatePairToken10 = [v13 candidatePairToken];
    v39 = (&_IDSStunCandidatePairStateStrings)[v106];
    *buf = 138412802;
    *v120 = candidatePairToken10;
    *&v120[8] = 2080;
    *v121 = v39;
    *&v121[8] = 1024;
    *&v121[10] = messageCopy;
    _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], Found no other connected candidate pair to send command %04x", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      candidatePairToken11 = [v13 candidatePairToken];
      v101 = (&_IDSStunCandidatePairStateStrings)[v106];
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");

      if (_IDSShouldLog())
      {
        v41 = [v13 candidatePairToken:candidatePairToken11];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");
      }
    }
  }

LABEL_10:
}

- (BOOL)_processIncomingIndicationData:(char *)data length:(int)length candidatePairToken:(id)token arrivalTime:(double)time remoteRelayLinkID:(unsigned __int16)d
{
  dCopy = d;
  v9 = *&length;
  v32 = *MEMORY[0x1E69E9840];
  tokenCopy = token;
  v13 = [IDSGlobalLinkMessage messageWithBuffer:data length:v9];
  command = [v13 command];
  if (!self->_useSecureControlMessage || ([v13 verifyHMacDigestWithKey:self->_controlMessageKey inputBuffer:data inputLength:v9] & 1) != 0)
  {
    Value = 0;
    if (tokenCopy && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
    }

    v16 = Value;
    v17 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      sessionID = [v16 sessionID];
      *buf = 67109890;
      v25 = command;
      v26 = 2112;
      v27 = tokenCopy;
      v28 = 2112;
      v29 = idsSessionID;
      v30 = 2112;
      v31 = sessionID;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Received command %04x on %@ for IDSSessionID: %@ QRSessionID: %@", buf, 0x26u);
    }

    if (command <= 0x8000)
    {
      if (command > 3)
      {
        if (command == 4)
        {
LABEL_35:
          [(IDSGlobalLink *)self _processCommandConnectionData:v13 candidatePairToken:tokenCopy];
          goto LABEL_40;
        }

        if (command == 5)
        {
LABEL_38:
          [(IDSGlobalLink *)self _processCommandNominate:v13 candidatePairToken:tokenCopy];
          goto LABEL_40;
        }

        if (command != 6)
        {
          goto LABEL_42;
        }

        goto LABEL_37;
      }

      if (command != 1)
      {
        if (command != 2)
        {
          if (command != 3)
          {
            goto LABEL_42;
          }

LABEL_27:
          [(IDSGlobalLink *)self _processCommandHeartbeat:v13 candidatePairToken:tokenCopy arrivalTime:dCopy remoteRelayLinkID:time];
LABEL_40:

          v21 = 1;
          goto LABEL_41;
        }

LABEL_39:
        [(IDSGlobalLink *)self _processCommandDisconnected:v13 candidatePairToken:tokenCopy];
        goto LABEL_40;
      }
    }

    else
    {
      if (command > 32771)
      {
        if (command <= 32773)
        {
          if (command != 32772)
          {
            goto LABEL_38;
          }

          goto LABEL_35;
        }

        if (command != 32774)
        {
          if (command == 33008)
          {
            [(IDSGlobalLink *)self _processCommandTestPacket:v13 candidatePairToken:tokenCopy remoteRelayLinkID:dCopy];
            goto LABEL_40;
          }

LABEL_42:
          v23 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 67109120;
            v25 = command;
            _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive invalid command %04x.", buf, 8u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"receive invalid command %04x.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid command %04x.");
              }
            }
          }

          goto LABEL_40;
        }

LABEL_37:
        [(IDSGlobalLink *)self _processCommandRelayInterfaceInfo:v13 candidatePairToken:tokenCopy];
        goto LABEL_40;
      }

      if (command != 32769)
      {
        if (command != 32770)
        {
          goto LABEL_27;
        }

        goto LABEL_39;
      }
    }

    [(IDSGlobalLink *)self _processCommandConnected:v13 candidatePairToken:tokenCopy];
    goto LABEL_40;
  }

  v20 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109378;
    v25 = command;
    v26 = 2112;
    v27 = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "failed to verify HMac, drop command %04x for %@.", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to verify HMac, drop command %04x for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to verify HMac, drop command %04x for %@.");
      }
    }
  }

  v21 = 0;
LABEL_41:

  return v21;
}

- (void)_notifyQRSessionConnected:(id)connected
{
  v74 = *MEMORY[0x1E69E9840];
  connectedCopy = connected;
  key = [(IDSGlobalLink *)connectedCopy candidatePairToken];
  state = [(IDSGlobalLink *)connectedCopy state];
  v4 = state;
  if (state <= 2)
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "receive session connected message before allocbind response.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive session connected message before allocbind response.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive session connected message before allocbind response.");
        }
      }
    }

LABEL_15:
    selfCopy4 = self;
    if (self->_state == 4)
    {
      if (!self->_allowOnlyOneQR)
      {
        v57 = 0;
LABEL_54:
        if (v4 <= 3)
        {
          [(IDSGlobalLink *)connectedCopy setState:4];
          [(IDSGlobalLink *)self _notifyLinkEngineCandidatePairDidConnect:connectedCopy];
          v30 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
          {
            v31 = (&_IDSStunCandidatePairStateStrings)[v4];
            *buf = 136315650;
            selfCopy5 = v31;
            v70 = 2080;
            v71 = off_1EB2B43C8;
            v72 = 2112;
            v73 = key;
            _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v55 = off_1EB2B43C8;
              v56 = key;
              selfCopy7 = (&_IDSStunCandidatePairStateStrings)[v4];
              _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
              if (_IDSShouldLog())
              {
                v55 = off_1EB2B43C8;
                v56 = key;
                selfCopy7 = (&_IDSStunCandidatePairStateStrings)[v4];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
              }
            }
          }

          [(IDSGlobalLink *)connectedCopy stopSessionConnectedTimer:selfCopy7];
          [(IDSGlobalLink *)self _notifyCandidatePairConnected:key];
          if ([(IDSGlobalLink *)connectedCopy isRelayStunCandidatePair]&& ([(IDSGlobalLink *)connectedCopy isSharedQRSession]& 1) == 0)
          {
            sessionID = [(IDSGlobalLink *)connectedCopy sessionID];
            v33 = [(IDSGlobalLink *)self _getCandidatePairsWithSessionID:sessionID inState:3];

            v63 = 0u;
            v64 = 0u;
            v61 = 0u;
            v62 = 0u;
            v34 = v33;
            v35 = [v34 countByEnumeratingWithState:&v61 objects:v67 count:16];
            if (v35)
            {
              v36 = *v62;
              do
              {
                for (i = 0; i != v35; ++i)
                {
                  if (*v62 != v36)
                  {
                    objc_enumerationMutation(v34);
                  }

                  v38 = *(*(&v61 + 1) + 8 * i);
                  isRealloc = [(IDSGlobalLink *)v38 isRealloc];
                  if (v38 == connectedCopy)
                  {
                    v40 = 1;
                  }

                  else
                  {
                    v40 = isRealloc;
                  }

                  if ((v40 & 1) == 0)
                  {
                    v41 = +[IDSFoundationLog GlobalLink];
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
                    {
                      sessionID2 = [(IDSGlobalLink *)v38 sessionID];
                      *buf = 138412546;
                      selfCopy5 = v38;
                      v70 = 2112;
                      v71 = sessionID2;
                      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "Found another succeeded candidate pair %@ with the same QRSessionID %@, disconnecting", buf, 0x16u);
                    }

                    isQUIC = [(IDSGlobalLink *)v38 isQUIC];
                    candidatePairToken = [(IDSGlobalLink *)v38 candidatePairToken];
                    if (isQUIC)
                    {
                      [(IDSGlobalLink *)self _sendQUICUnallocbindRequest:candidatePairToken reason:8];
                    }

                    else
                    {
                      [(IDSGlobalLink *)self _sendUnallocbindRequest:candidatePairToken stunMessage:0 reason:8];
                    }
                  }
                }

                v35 = [v34 countByEnumeratingWithState:&v61 objects:v67 count:16];
              }

              while (v35);
            }
          }

          Value = 0;
          if (self->_tokenToReallocBlocks && key)
          {
            Value = CFDictionaryGetValue(self->_tokenToReallocBlocks, key);
          }

          v46 = _Block_copy(Value);
          if (v46)
          {
            v47 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
            {
              v48 = _Block_copy(v46);
              *buf = 134218242;
              selfCopy5 = v48;
              v70 = 2112;
              v71 = key;
              _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "process delayed realloc block %p for %@.", buf, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                selfCopy7 = _Block_copy(v46);
                v55 = key;
                _IDSLogTransport(@"GL", @"IDS", @"process delayed realloc block %p for %@.");

                if (_IDSShouldLog())
                {
                  selfCopy7 = _Block_copy(v46);
                  v55 = key;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"process delayed realloc block %p for %@.");
                }
              }
            }

            v46[2](v46);
            if (key)
            {
              tokenToReallocBlocks = self->_tokenToReallocBlocks;
              if (tokenToReallocBlocks)
              {
                CFDictionaryRemoveValue(tokenToReallocBlocks, key);
              }
            }
          }

          selfCopy4 = self;
        }

        if (v57)
        {
          [(IDSGlobalLink *)selfCopy4 _notifyDefaultUnderlyingLinkChanged:key error:0];
          selfCopy4 = self;
        }

        [(IDSGlobalLink *)selfCopy4 _selectBetterDefaultCandidatePair:connectedCopy, selfCopy7, v55];
        v50 = [(IDSGlobalLink *)self _convergeSharedSessions:connectedCopy];
        v51 = [v50 count] == 0;

        if (!v51)
        {
          [(IDSGFTMetricsCollector *)self->_metricsCollector hasConvergence];
        }

        if ([(IDSGlobalLink *)connectedCopy isRelayStunCandidatePair])
        {
          v52 = +[IDSStunConnectionDataController sharedInstance];
          v53 = [v52 deliveryStatus:self->_cbuuid];

          if (v53 <= 1)
          {
            [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
          }
        }

        goto LABEL_102;
      }

      if (![(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v57 = 0;
        goto LABEL_53;
      }

      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        cbuuid = self->_cbuuid;
        *buf = 138412546;
        selfCopy5 = connectedCopy;
        v70 = 2112;
        v71 = cbuuid;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "candidate pair %@ is connected but GL is already connected, override for %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          selfCopy7 = connectedCopy;
          v55 = self->_cbuuid;
          _IDSLogTransport(@"GL", @"IDS", @"candidate pair %@ is connected but GL is already connected, override for %@");
          if (_IDSShouldLog())
          {
            selfCopy7 = connectedCopy;
            v55 = self->_cbuuid;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"candidate pair %@ is connected but GL is already connected, override for %@");
          }
        }
      }

      [(IDSGlobalLink *)self _updateDefaultCandidatePair:connectedCopy, selfCopy7, v55];
      v11 = 1;
LABEL_52:
      v57 = v11;
LABEL_53:
      selfCopy4 = self;
      goto LABEL_54;
    }

    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      selfCopy5 = self;
      v70 = 2080;
      v71 = v13;
      v72 = 2080;
      v73 = off_1EB2B3E70[0];
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "update GL: %@ state (%s->%s).", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v55 = _IDSLinkStateStrings[self->_state];
        v56 = off_1EB2B3E70[0];
        selfCopy7 = self;
        _IDSLogTransport(@"GL", @"IDS", @"update GL: %@ state (%s->%s).");
        if (_IDSShouldLog())
        {
          v55 = _IDSLinkStateStrings[self->_state];
          v56 = off_1EB2B3E70[0];
          selfCopy7 = self;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL: %@ state (%s->%s).");
        }
      }
    }

    selfCopy9 = self;
    self->_state = 4;
    if (!self->_isUPlusOneSession)
    {
      v15 = ids_monotonic_time();
      selfCopy9 = self;
      self->_linkConnectTime = v15;
    }

    [(IDSGlobalLink *)selfCopy9 _stopAllocbindFailoverTimer:0, selfCopy7, v55, v56];
    mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
    isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

    if (isInternalInstall)
    {
      [(IDSGlobalLink *)connectedCopy setTestOptionsFromUserDefaults];
    }

    v18 = _Block_copy(self->_connectReadyHandler);
    if (v18)
    {
      v19 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7B96780;
      block[3] = &unk_1E77E0B48;
      v66 = v18;
      v20 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS|DISPATCH_BLOCK_ASSIGN_CURRENT, QOS_CLASS_USER_INTERACTIVE, 0, block);
      dispatch_async(v19, v20);

      v21 = v66;
    }

    else
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v23 = objc_opt_respondsToSelector();

      if ((v23 & 1) == 0)
      {
LABEL_41:
        v24 = objc_loadWeakRetained(&self->_delegate);
        [v24 link:self didConnectForDeviceUniqueID:self->_deviceUniqueID cbuuid:self->_cbuuid];

        isActive = [(IDSGlobalLink *)connectedCopy isActive];
        if ((isActive & 1) == 0)
        {
          v26 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken2 = [(IDSGlobalLink *)connectedCopy candidatePairToken];
            *buf = 138412290;
            selfCopy5 = candidatePairToken2;
            _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "default candidate pair is not connected, switch to %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              selfCopy7 = [(IDSGlobalLink *)connectedCopy candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"default candidate pair is not connected, switch to %@.");

              if (_IDSShouldLog())
              {
                selfCopy7 = [(IDSGlobalLink *)connectedCopy candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"default candidate pair is not connected, switch to %@.");
              }
            }
          }

          [(IDSGlobalLink *)self _updateDefaultCandidatePair:connectedCopy, selfCopy7];
        }

        selfCopy11 = self;
        if (self->_skeToRemoteComplete)
        {
          skeData = self->_skeData;
          self->_skeData = 0;

          selfCopy11 = self;
        }

        [(IDSGlobalLink *)selfCopy11 _discardNonAcceptedCandidatePairs];
        [(IDSGlobalLink *)self _startActivityTimer];
        [(IDSGlobalLink *)self _startExtIPDiscovery];

        v11 = isActive ^ 1;
        goto LABEL_52;
      }

      v21 = objc_loadWeakRetained(&self->_delegate);
      [v21 link:self didConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_41;
  }

  if (state - 5 > 1)
  {
    goto LABEL_15;
  }

  v6 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = (&_IDSStunCandidatePairStateStrings)[v4];
    *buf = 138412546;
    selfCopy5 = key;
    v70 = 2080;
    v71 = v7;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], ignore session connected.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], ignore session connected.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], ignore session connected.");
      }
    }
  }

LABEL_102:
}

- (void)_setRemoteGlobalLinkVersionWithCommand:(int64_t)command receivedRemoteVersion:(BOOL)version versionValue:(unsigned __int16)value receivedSKE:(BOOL)e
{
  if (version)
  {
    goto LABEL_9;
  }

  if (!self->_isInitiator)
  {
    if (command != 1)
    {
      return;
    }

    goto LABEL_8;
  }

  if (command == 32769 && self->_enableSKE && e)
  {
LABEL_8:
    value = 0;
LABEL_9:
    self->_remoteGlobalLinkVersion = value;
  }
}

- (void)_processCommandConnected:(id)connected candidatePairToken:(id)token
{
  v154 = *MEMORY[0x1E69E9840];
  connectedCopy = connected;
  tokenCopy = token;
  command = [connectedCopy command];
  if (tokenCopy)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (tokenToCandidatePairs)
    {
      v9 = CFDictionaryGetValue(tokenToCandidatePairs, tokenCopy);
      if (v9)
      {
        v10 = v9;
        if ([v9 pendingRealloc])
        {
          v11 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
          {
            buf[0] = 67109378;
            buf[1] = command;
            LOWORD(v153[0]) = 2112;
            *(v153 + 2) = tokenCopy;
            _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receive session connected command %04x on realloc pair %@, ignore.", buf, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"receive session connected command %04x on realloc pair %@, ignore.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive session connected command %04x on realloc pair %@, ignore.");
              }
            }
          }

          goto LABEL_18;
        }

        bzero(buf, 0x410uLL);
        if ([connectedCopy getAttribute:4 attribute:buf])
        {
          v13 = [MEMORY[0x1E695DEF0] dataWithBytes:&v153[1] length:v153[0]];
          v14 = [v13 length];
          v15 = v14;
          if (v14)
          {
            enableSKE = self->_enableSKE;
          }

          else
          {
            enableSKE = 0;
          }

          if (enableSKE)
          {
            if (self->_recvRemoteSKEData)
            {
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                LOWORD(v147) = 0;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "already received remote SKE data, ignore.", &v147, 2u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"already received remote SKE data, ignore.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"already received remote SKE data, ignore.");
                  }
                }
              }
            }

            else
            {
              self->_recvRemoteSKEData = 1;
              [v10 setRecvSKEData:1];
              v26 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
              {
                v147 = 67109120;
                *v148 = v15;
                _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "receive new remote SKE data %u bytes.", &v147, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v124 = v15;
                  _IDSLogTransport(@"GL", @"IDS", @"receive new remote SKE data %u bytes.");
                  if (_IDSShouldLog())
                  {
                    v124 = v15;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new remote SKE data %u bytes.");
                  }
                }
              }

              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              [WeakRetained link:self didReceiveSKEData:v13];

              if (!self->_isInitiator)
              {
                self->_skeStartTime = ids_monotonic_time();
                if (self->_skeData)
                {
                  self->_delaySessionConnected = 0;
                  v28 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
                  {
                    LOWORD(v147) = 0;
                    _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "SKE data is ready, need to send SKE", &v147, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"SKE data is ready, need to send SKE");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is ready, need to send SKE");
                      }
                    }
                  }
                }

                else
                {
                  self->_delaySessionConnected = 1;
                  v29 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
                  {
                    LOWORD(v147) = 0;
                    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "SKE data is not ready, delay session connected.", &v147, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"SKE data is not ready, delay session connected.");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE data is not ready, delay session connected.");
                      }
                    }
                  }
                }
              }
            }
          }

          else
          {
            v18 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
            {
              v19 = @"NO";
              skeToRemoteComplete = self->_skeToRemoteComplete;
              if (self->_enableSKE)
              {
                v21 = @"YES";
              }

              else
              {
                v21 = @"NO";
              }

              v147 = 67109634;
              if (skeToRemoteComplete)
              {
                v19 = @"YES";
              }

              *v148 = v15;
              *&v148[4] = 2112;
              *&v148[6] = v21;
              v149 = 2112;
              v150 = v19;
              _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "ignore SKE data %uB (EnableSKE %@, SKEComplete %@).", &v147, 0x1Cu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v22 = self->_enableSKE ? @"YES" : @"NO";
              v23 = self->_skeToRemoteComplete ? @"YES" : @"NO";
              v127 = v22;
              v130 = v23;
              v124 = v15;
              _IDSLogTransport(@"GL", @"IDS", @"ignore SKE data %uB (EnableSKE %@, SKEComplete %@).");
              if (_IDSShouldLog())
              {
                if (self->_enableSKE)
                {
                  v24 = @"YES";
                }

                else
                {
                  v24 = @"NO";
                }

                if (self->_skeToRemoteComplete)
                {
                  v25 = @"YES";
                }

                else
                {
                  v25 = @"NO";
                }

                v127 = v24;
                v130 = v25;
                v124 = v15;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"ignore SKE data %uB (EnableSKE %@, SKEComplete %@).");
              }
            }
          }
        }

        else
        {
          enableSKE = 0;
        }

        v136 = 0;
        v135 = 0;
        v151 = 0uLL;
        if (command == 1)
        {
          HasValidUInt16Attr = GLUtilHasValidUInt16Attr(connectedCopy, 18, &v135);
          v31 = v135;
        }

        else
        {
          v31 = 0;
          HasValidUInt16Attr = 0;
        }

        [(IDSGlobalLink *)self _setRemoteGlobalLinkVersionWithCommand:command receivedRemoteVersion:HasValidUInt16Attr versionValue:v31 receivedSKE:enableSKE, v124, v127, v130];
        if (GLUtilHasValidUInt32Attr(connectedCopy, 7, &v136))
        {
          v32 = v136;
          self->_acceptDelayU32 = v136;
          v33 = vcvtd_n_f64_u32(v32, 0x10uLL) + HIWORD(v32);
          v34 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
          {
            acceptDelayU32 = self->_acceptDelayU32;
            v147 = 67109376;
            *v148 = acceptDelayU32;
            *&v148[4] = 2048;
            *&v148[6] = v33;
            _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "receive accept delay: %08x/%.6f", &v147, 0x12u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v128 = v33;
              v125 = self->_acceptDelayU32;
              _IDSLogTransport(@"GL", @"IDS", @"receive accept delay: %08x/%.6f");
              if (_IDSShouldLog())
              {
                v128 = v33;
                v125 = self->_acceptDelayU32;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive accept delay: %08x/%.6f");
              }
            }
          }
        }

        if (GLUtilHasValidUInt16Attr(connectedCopy, 2, &v135))
        {
          remote = [v10 remote];
          v37 = remote;
          if (v135 <= 4u)
          {
            v38 = v135;
          }

          else
          {
            v38 = 0;
          }

          [remote updateTransport:{v38, v125, *&v128}];
        }

        if (GLUtilHasValidUInt16Attr(connectedCopy, 5, &v135))
        {
          remote2 = [v10 remote];
          v40 = remote2;
          v41 = v135 >= 0xAu ? 10 : v135;
          [remote2 setRadioAccessTechnology:{v41, v125}];

          linkEngine = [v10 linkEngine];
          if (linkEngine)
          {
            linkUniqueName = [v10 linkUniqueName];
            v44 = linkUniqueName == 0;

            if (!v44)
            {
              linkEngine2 = [v10 linkEngine];
              linkUniqueName2 = [v10 linkUniqueName];
              if (v135 >= 0xAu)
              {
                v47 = 10;
              }

              else
              {
                v47 = v135;
              }

              [linkEngine2 setRemoteRATForLink:linkUniqueName2 rat:v47];

              linkEngine3 = [v10 linkEngine];
              [linkEngine3 scheduleUpdate];
            }
          }
        }

        if (GLUtilHasValidUInt16Attr(connectedCopy, 6, &v135))
        {
          remote3 = [v10 remote];
          [remote3 setMtu:v135];
        }

        if (GLUtilHasValidUInt16Attr(connectedCopy, 12, &v135))
        {
          if (self->_remoteCapabilityFlag != v135)
          {
            self->_remoteCapabilityFlag = v135;
            v50 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
            {
              remoteCapabilityFlag_low = LOWORD(self->_remoteCapabilityFlag);
              v147 = 67109120;
              *v148 = remoteCapabilityFlag_low;
              _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "update remote capability: %04X.", &v147, 8u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v125 = LOWORD(self->_remoteCapabilityFlag);
                _IDSLogTransport(@"GL", @"IDS", @"update remote capability: %04X.");
                if (_IDSShouldLog())
                {
                  v125 = LOWORD(self->_remoteCapabilityFlag);
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"update remote capability: %04X.");
                }
              }
            }
          }

          if ((v135 & 2) != 0)
          {
            _localIsQualityMetadataSupported = [(IDSGlobalLink *)self _localIsQualityMetadataSupported];
            v54 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
            {
              v55 = @"NO";
              if (_localIsQualityMetadataSupported)
              {
                v55 = @"YES";
              }

              v147 = 138412290;
              *v148 = v55;
              _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "remote has quality metadata capability; local: %@", &v147, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
            {
              v56 = _localIsQualityMetadataSupported ? @"YES" : @"NO";
              v125 = v56;
              _IDSLogTransport(@"GL", @"IDS", @"remote has quality metadata capability; local: %@");
              if (_IDSShouldLog())
              {
                v125 = v56;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"remote has quality metadata capability; local: %@");
              }
            }
          }

          else
          {
            v52 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
            {
              LOWORD(v147) = 0;
              _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "remote does not have quality metadata capability", &v147, 2u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"remote does not have quality metadata capability");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remote does not have quality metadata capability");
                }
              }
            }

            _localIsQualityMetadataSupported = 0;
          }

          [v10 setUseQualityMetadata:{_localIsQualityMetadataSupported, v125}];
        }

        v57 = GLUtilHasValidUInt16Attr(connectedCopy, 19, &v135);
        if (v135)
        {
          v58 = v57;
        }

        else
        {
          v58 = 0;
        }

        if (v58 == 1)
        {
          remote4 = [v10 remote];
          [remote4 setLinkFlags:v135];
        }

        HasValidUInt32Attr = GLUtilHasValidUInt32Attr(connectedCopy, 20, &v136);
        if (v136)
        {
          v61 = HasValidUInt32Attr;
        }

        else
        {
          v61 = 0;
        }

        if (v61 == 1)
        {
          remote5 = [v10 remote];
          [remote5 setDataSoMask:v136];
        }

        bzero(&v147, 0x410uLL);
        if ([connectedCopy getAttribute:8 attribute:&v147])
        {
          relayRemote = [v10 relayRemote];
          address = [relayRemote address];

          *&v65 = 0xAAAAAAAAAAAAAAAALL;
          *(&v65 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v145 = v65;
          v146 = v65;
          v143 = v65;
          v144 = v65;
          *&v141[32] = v65;
          v142 = v65;
          *v141 = v65;
          *&v141[16] = v65;
          if (IsValidSA(&v148[4]) && (!address || !IsSameSA(&v148[4], address)))
          {
            remote6 = [v10 remote];
            transport = [remote6 transport];
            remote7 = [v10 remote];
            radioAccessTechnology = [remote7 radioAccessTechnology];
            remote8 = [v10 remote];
            v71 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 3, transport, radioAccessTechnology, [remote8 mtu], 0xFFFFFFFFLL, &v148[4], &v148[4]);

            [v10 setRelayRemote:v71];
            v72 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
            {
              v73 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
              *v137 = 136315394;
              v138 = v73;
              v139 = 2112;
              v140 = tokenCopy;
              _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "receive relay-remote-address %s for %@.", v137, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v125 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
                v128 = *&tokenCopy;
                _IDSLogTransport(@"GL", @"IDS", @"receive relay-remote-address %s for %@.");
                if (_IDSShouldLog())
                {
                  v125 = SAToIPPortString(v141, 0x80uLL, &v148[4]);
                  v128 = *&tokenCopy;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"receive relay-remote-address %s for %@.");
                }
              }
            }
          }
        }

        v74 = GLUtilHasValidUUIDAttr(connectedCopy, 11, &v151);
        if (!v75)
        {
LABEL_164:
          if (![(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA", v74, v125, *&v128])
          {
            goto LABEL_176;
          }

          defaultRemoteDeviceCBUUID = [v10 defaultRemoteDeviceCBUUID];
          GLUtilHasValidUUIDAttr(connectedCopy, 13, &v151);
          if (v82)
          {
            v83 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&v151];
            if (v83)
            {
              v84 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v84, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 138412546;
                *&v141[4] = v83;
                *&v141[12] = 1024;
                *&v141[14] = 13;
                _os_log_impl(&dword_1A7AD9000, v84, OS_LOG_TYPE_DEFAULT, "receive watch cbuuid: %@, attr(%04x).", v141, 0x12u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v126 = v83;
                  v129 = 13;
                  _IDSLogTransport(@"GL", @"IDS", @"receive watch cbuuid: %@, attr(%04x).");
                  if (_IDSShouldLog())
                  {
                    v126 = v83;
                    v129 = 13;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"receive watch cbuuid: %@, attr(%04x).");
                  }
                }
              }

              if ([defaultRemoteDeviceCBUUID isEqual:{v83, v126, v129}])
              {

                goto LABEL_175;
              }

              v123 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v123, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 138412802;
                *&v141[4] = v83;
                *&v141[12] = 2112;
                *&v141[14] = defaultRemoteDeviceCBUUID;
                *&v141[22] = 1024;
                *&v141[24] = command;
                _os_log_impl(&dword_1A7AD9000, v123, OS_LOG_TYPE_DEFAULT, "watch cbuuid mismatch (%@, %@), reject session command %04x.", v141, 0x1Cu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"watch cbuuid mismatch (%@, %@), reject session command %04x.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"watch cbuuid mismatch (%@, %@), reject session command %04x.");
                  }
                }
              }
            }

            else
            {
              v122 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v122, OS_LOG_TYPE_DEFAULT))
              {
                *v141 = 67109120;
                *&v141[4] = command;
                _os_log_impl(&dword_1A7AD9000, v122, OS_LOG_TYPE_DEFAULT, "recieve invalid watch cbuuid, reject session command %04x.", v141, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"recieve invalid watch cbuuid, reject session command %04x.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"recieve invalid watch cbuuid, reject session command %04x.");
                  }
                }
              }
            }

            goto LABEL_18;
          }

LABEL_175:

LABEL_176:
          v85 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
          {
            remote9 = [v10 remote];
            v87 = (&_IDSStunTransportStrings)[[remote9 transport]];
            remote10 = [v10 remote];
            v89 = IDSRadioAccessTechnologyToString([remote10 radioAccessTechnology]);
            remote11 = [v10 remote];
            v91 = [remote11 mtu];
            v92 = LOWORD(self->_remoteCapabilityFlag);
            remoteGlobalLinkVersion = self->_remoteGlobalLinkVersion;
            *v141 = 136316162;
            *&v141[4] = v87;
            *&v141[12] = 2080;
            *&v141[14] = v89;
            *&v141[22] = 1024;
            *&v141[24] = v91;
            *&v141[28] = 1024;
            *&v141[30] = v92;
            *&v141[34] = 1024;
            *&v141[36] = remoteGlobalLinkVersion;
            _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "session connected message payload (%s/%s/%d/%04X/%d).", v141, 0x28u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              remote12 = [v10 remote];
              v95 = (&_IDSStunTransportStrings)[[remote12 transport]];
              remote13 = [v10 remote];
              v97 = IDSRadioAccessTechnologyToString([remote13 radioAccessTechnology]);
              remote14 = [v10 remote];
              v99 = [remote14 mtu];
              v132 = LOWORD(self->_remoteCapabilityFlag);
              v133 = self->_remoteGlobalLinkVersion;
              v129 = v97;
              v131 = v99;
              v126 = v95;
              _IDSLogTransport(@"GL", @"IDS", @"session connected message payload (%s/%s/%d/%04X/%d).");

              if (_IDSShouldLog())
              {
                remote15 = [v10 remote];
                v101 = (&_IDSStunTransportStrings)[[remote15 transport]];
                remote16 = [v10 remote];
                v103 = IDSRadioAccessTechnologyToString([remote16 radioAccessTechnology]);
                remote17 = [v10 remote];
                v105 = [remote17 mtu];
                v132 = LOWORD(self->_remoteCapabilityFlag);
                v133 = self->_remoteGlobalLinkVersion;
                v129 = v103;
                v131 = v105;
                v126 = v101;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message payload (%s/%s/%d/%04X/%d).");
              }
            }
          }

          if (command != 1)
          {
            if (command == 32769)
            {
              v109 = self->_enableSKE;
              if (v109)
              {
                self->_skeToRemoteComplete = 1;
              }

              [v10 setRecvConnectedAck:{1, v126, v129, v131, v132, v133}];
              v107 = !v109;
            }

            else
            {
              v107 = 0;
            }

LABEL_201:
            if (self->_enableSKE)
            {
              v107 = self->_recvRemoteSKEData && self->_skeToRemoteComplete;
            }

            if (self->_remoteGlobalLinkVersion >= 2)
            {
              recvConnected = [v10 recvConnected];
            }

            else
            {
              recvConnected = 1;
            }

            recvConnectedAck = [v10 recvConnectedAck];
            if (v107)
            {
              v112 = recvConnectedAck;
              if (recvConnected & recvConnectedAck)
              {
                v113 = 1;
LABEL_221:
                v116 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
                {
                  v117 = @"NO";
                  if (self->_enableSKE)
                  {
                    v118 = @"YES";
                  }

                  else
                  {
                    v118 = @"NO";
                  }

                  recvRemoteSKEData = self->_recvRemoteSKEData;
                  if (self->_skeToRemoteComplete)
                  {
                    v120 = @"YES";
                  }

                  else
                  {
                    v120 = @"NO";
                  }

                  *v141 = 138413058;
                  if (recvRemoteSKEData)
                  {
                    v121 = @"YES";
                  }

                  else
                  {
                    v121 = @"NO";
                  }

                  *&v141[4] = v118;
                  *&v141[12] = 2112;
                  if (v113)
                  {
                    v117 = @"YES";
                  }

                  *&v141[14] = v120;
                  *&v141[22] = 2112;
                  *&v141[24] = v121;
                  *&v141[32] = 2112;
                  *&v141[34] = v117;
                  _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@", v141, 0x2Au);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"SKE state enableSKE: %@ local complete: %@ remote complete: %@ isConnected: %@");
                    }
                  }
                }

                if (v113)
                {
                  [(IDSGlobalLink *)self _notifyQRSessionConnected:v10];
                  [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:0];
                }

                goto LABEL_18;
              }

              v114 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
              {
                v115 = @"NO";
                if (v112)
                {
                  v115 = @"YES";
                }

                *v141 = 138412290;
                *&v141[4] = v115;
                _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "still not finished Connected command exchange. recvConnectedAck = %@", v141, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"still not finished Connected command exchange. recvConnectedAck = %@");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"still not finished Connected command exchange. recvConnectedAck = %@");
                  }
                }
              }
            }

            v113 = 0;
            goto LABEL_221;
          }

          v106 = self->_remoteGlobalLinkVersion;
          v107 = v106 == 0;
          if (!v106)
          {
            if (self->_isInitiator || self->_delaySessionConnected)
            {
              v107 = 0;
LABEL_200:
              [v10 setRecvConnected:{1, v126}];
              goto LABEL_201;
            }

            [(IDSGlobalLink *)self _sendCommandMessage:32769 stunMessage:0 options:0 candidatePairToken:tokenCopy];
            [v10 setRecvConnectedAck:1];
            v106 = self->_remoteGlobalLinkVersion;
          }

          if (v106 >= 1)
          {
            if (self->_isInitiator || self->_delaySessionConnected || !self->_enableSKE || self->_skeToRemoteComplete || [v10 sentSKEData])
            {
              v108 = 32769;
            }

            else
            {
              v108 = 1;
            }

            [(IDSGlobalLink *)self _sendCommandMessage:v108 stunMessage:0 options:0 candidatePairToken:tokenCopy, v126, v129, v131, v132, v133];
          }

          goto LABEL_200;
        }

        v76 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&v151];
        if (v76)
        {
          linkUUID = [v10 linkUUID];
          if (([v76 isEqual:linkUUID] & 1) == 0)
          {
            isInitiator = self->_isInitiator;

            if (isInitiator)
            {
              goto LABEL_163;
            }

            [v10 setLinkUUID:v76];
            v79 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
            {
              candidatePairToken = [v10 candidatePairToken];
              *v141 = 138412546;
              *&v141[4] = v76;
              *&v141[12] = 2112;
              *&v141[14] = candidatePairToken;
              _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "update linkUUID %@ for %@.", v141, 0x16u);
            }

            if (!os_log_shim_legacy_logging_enabled())
            {
              goto LABEL_163;
            }

            if (!_IDSShouldLogTransport())
            {
              goto LABEL_163;
            }

            [v10 candidatePairToken];
            v125 = v76;
            v128 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
            _IDSLogTransport(@"GL", @"IDS", @"update linkUUID %@ for %@.");

            if (!_IDSShouldLog())
            {
              goto LABEL_163;
            }

            linkUUID = [v10 candidatePairToken];
            v125 = v76;
            v128 = *&linkUUID;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update linkUUID %@ for %@.");
          }
        }

LABEL_163:

        goto LABEL_164;
      }
    }
  }

  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    LOWORD(buf[0]) = 0;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair.");
      }
    }
  }

  v10 = 0;
LABEL_18:
}

- (void)_processCommandDisconnected:(id)disconnected candidatePairToken:(id)token
{
  v24 = *MEMORY[0x1E69E9840];
  disconnectedCopy = disconnected;
  tokenCopy = token;
  command = [disconnectedCopy command];
  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v10 = Value;
  v11 = v10;
  if (command == 2)
  {
    [v10 setRecvDisconnected:1];
    [(IDSGlobalLink *)self _sendCommandMessage:32770 stunMessage:0 options:0 candidatePairToken:tokenCopy];
    if (self->_allowOnlyOneQR && self->_state <= 4)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        selfCopy4 = self;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "Disconnecting IDSGlobalLink %@, remote side is disconnecting.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          selfCopy6 = self;
          _IDSLogTransport(@"GL", @"IDS", @"Disconnecting IDSGlobalLink %@, remote side is disconnecting.");
          if (_IDSShouldLog())
          {
            selfCopy6 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Disconnecting IDSGlobalLink %@, remote side is disconnecting.");
          }
        }
      }

      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        v14 = _IDSLinkStateStrings[self->_state];
        *buf = 138412802;
        selfCopy4 = self;
        v20 = 2080;
        v21 = v14;
        v22 = 2080;
        v23 = off_1EB2B3E78[0];
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "update GL %@ state (%s->%s).", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v16 = _IDSLinkStateStrings[self->_state];
          v17 = off_1EB2B3E78[0];
          selfCopy6 = self;
          _IDSLogTransport(@"GL", @"IDS", @"update GL %@ state (%s->%s).");
          if (_IDSShouldLog())
          {
            v16 = _IDSLinkStateStrings[self->_state];
            v17 = off_1EB2B3E78[0];
            selfCopy6 = self;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update GL %@ state (%s->%s).");
          }
        }
      }

      self->_state = 5;
      [(IDSGlobalLink *)self _sendCommandMessage:2 stunMessage:0 options:0 candidatePairToken:tokenCopy, selfCopy6, v16, v17];
      [(IDSGlobalLink *)self _startDisconnectTimer];
    }
  }

  else
  {
    [v10 setRecvDisconnectedAck:1];
  }

  if ([v11 recvDisconnected] && objc_msgSend(v11, "recvDisconnectedAck"))
  {
    [(IDSGlobalLink *)self _stopDisconnectTimer];
    [(IDSGlobalLink *)self _discardAllCandidatePairs:0];
  }
}

- (void)_processCommandHeartbeat:(id)heartbeat candidatePairToken:(id)token arrivalTime:(double)time remoteRelayLinkID:(unsigned __int16)d
{
  dCopy = d;
  v97 = *MEMORY[0x1E69E9840];
  heartbeatCopy = heartbeat;
  tokenCopy = token;
  command = [heartbeatCopy command];
  Value = 0;
  selfCopy = self;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v72 = tokenCopy;
  v14 = Value;
  bzero(v95, 0x410uLL);
  if ([heartbeatCopy getAttribute:1 attribute:v95])
  {
    v15 = v96;
  }

  else
  {
    v15 = 0;
  }

  bzero(v91, 0x410uLL);
  v16 = 0;
  v17 = 0;
  v18 = 0;
  v19 = 0;
  if ([heartbeatCopy getAttribute:10 attribute:v91])
  {
    v17 = ntpTime32(time);
    v18 = bswap32(v93);
    v19 = bswap32(v92);
    v16 = bswap32(v94);
  }

  v71 = heartbeatCopy;
  if (dCopy)
  {
    v20 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v14 relayLinkID], dCopy);
    v21 = 0;
    if (selfCopy->_localRemoteRelayLinkIDToVirtualCandidatePairs && v20)
    {
      v21 = CFDictionaryGetValue(selfCopy->_localRemoteRelayLinkIDToVirtualCandidatePairs, v20);
    }

    linkID = [v21 linkID];
  }

  else
  {
    linkID = [v14 linkID];
  }

  if (command == 32771)
  {
    linkEngine = [v14 linkEngine];

    if (linkEngine)
    {
      if (([v14 hasReceivedData] & 1) == 0)
      {
        [(IDSGlobalLink *)selfCopy didReceiveFirstDataOnCandidatePair:v14];
      }
    }

    else if ([v14 pendingRealloc])
    {
      local = [v14 local];
      address = [local address];

      remote = [v14 remote];
      external = [remote external];

      -[IDSGlobalLink _processDataOnReallocChannel:localAddress:remoteAddress:](selfCopy, "_processDataOnReallocChannel:localAddress:remoteAddress:", [v14 channelNumber], address, external);
    }

    if (v18)
    {
      v31 = vcvtd_n_f64_u32((v17 - (v16 + v18)), 0x10uLL) + ((v17 - (v16 + v18)) >> 16);
      v32 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        isActive = [v14 isActive];
        *buf = 67110658;
        v34 = @"NO";
        *v81 = linkID;
        *&v81[4] = 1024;
        if (isActive)
        {
          v34 = @"YES";
        }

        *&v81[6] = v15;
        v82 = 2112;
        *v83 = v34;
        *&v83[8] = 1024;
        *v84 = v17;
        *&v84[4] = 1024;
        v85 = v18;
        v86 = 1024;
        v87 = v16;
        v88 = 2048;
        v89 = v31;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "receive rtt response on link %d (counter:%04x active:%@ a:%08x e:%08x, d:%08x), rtt:%.6f sec).", buf, 0x34u);
      }
    }

    else
    {
      v31 = 0.0;
    }

    if (linkID < 1)
    {
      goto LABEL_68;
    }

    v35 = [MEMORY[0x1E696AD98] numberWithChar:linkID];
    v36 = 0;
    if (selfCopy->_linkIDToHBCounter && v35)
    {
      v36 = CFDictionaryGetValue(selfCopy->_linkIDToHBCounter, v35);
    }

    unsignedShortValue = [v36 unsignedShortValue];
    if (v15 - unsignedShortValue >= 0x8000)
    {
      if (unsignedShortValue == v15)
      {
LABEL_50:
        v43 = 0;
        if (selfCopy->_linkIDToRequestTimeStampAndRTT && v35)
        {
          v43 = CFDictionaryGetValue(selfCopy->_linkIDToRequestTimeStampAndRTT, v35);
        }

        key = v35;
        v74 = 0u;
        v75 = 0u;
        v76 = 0u;
        v77 = 0u;
        v44 = v43;
        v45 = [v44 countByEnumeratingWithState:&v74 objects:v79 count:16];
        if (v45)
        {
          v46 = v45;
          v47 = *v75;
          while (2)
          {
            for (i = 0; i != v46; ++i)
            {
              if (*v75 != v47)
              {
                objc_enumerationMutation(v44);
              }

              v49 = *(*(&v74 + 1) + 8 * i);
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v50 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v18];
                v51 = [v49 isEqualToNumber:v50];

                if (v51)
                {
                  v52 = [v44 indexOfObject:v49];
                  v53 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v18];
                  v78[0] = v53;
                  v54 = [MEMORY[0x1E696AD98] numberWithDouble:v31];
                  v78[1] = v54;
                  v55 = [MEMORY[0x1E695DEC8] arrayWithObjects:v78 count:2];
                  [v44 replaceObjectAtIndex:v52 withObject:v55];

                  if (!selfCopy->_linkIDToRequestTimeStampAndRTT)
                  {
                    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                    linkIDToRequestTimeStampAndRTT = selfCopy->_linkIDToRequestTimeStampAndRTT;
                    selfCopy->_linkIDToRequestTimeStampAndRTT = Mutable;
                  }

                  if (v44)
                  {
                    CFDictionarySetValue(selfCopy->_linkIDToRequestTimeStampAndRTT, key, v44);
                  }

                  goto LABEL_67;
                }
              }
            }

            v46 = [v44 countByEnumeratingWithState:&v74 objects:v79 count:{16, key, v71}];
            if (v46)
            {
              continue;
            }

            break;
          }
        }

LABEL_67:

LABEL_68:
        if (v14 && [v14 hbStarted])
        {
          [v14 setHbStarted:0];
          [v14 setHbStartTime:0.0];
          v58 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v58, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v81 = v72;
            _os_log_impl(&dword_1A7AD9000, v58, OS_LOG_TYPE_DEFAULT, "stop HB request for %@.", buf, 0xCu);
          }

          if ([v14 isActive])
          {
            if (v31 > 0.0)
            {
              v59 = v31 * 1000.0;
              GLUtilReportAWDActiveLinkRTT(v14, selfCopy->_enableSKE, selfCopy->_isInitiator, v59);
              v24 = GLUCreateQRActiveLinkRTTEvent(v14, v59);
              WeakRetained = objc_loadWeakRetained(&selfCopy->_delegate);
              v61 = objc_opt_respondsToSelector();

              if (v61)
              {
                v62 = objc_loadWeakRetained(&selfCopy->_delegate);
                [v62 link:selfCopy didAddQREvent:v24];
              }

              goto LABEL_99;
            }
          }
        }

        goto LABEL_100;
      }

      v39 = 0;
      p_linkIDToReorderedPackets = &selfCopy->_linkIDToReorderedPackets;
      if (selfCopy->_linkIDToReorderedPackets && v35)
      {
        v39 = CFDictionaryGetValue(selfCopy->_linkIDToReorderedPackets, v35);
      }

      v15 = [v39 unsignedShortValue] + 1;
    }

    else
    {
      p_linkIDToReorderedPackets = &selfCopy->_linkIDToHBCounter;
    }

    if (!*p_linkIDToReorderedPackets)
    {
      v40 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v41 = *p_linkIDToReorderedPackets;
      *p_linkIDToReorderedPackets = v40;
    }

    v42 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v15];
    if (v42)
    {
      CFDictionarySetValue(*p_linkIDToReorderedPackets, v35, v42);
    }

    goto LABEL_50;
  }

  if (command == 3)
  {
    v23 = v15;
    if (v15)
    {
      v24 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v25 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v15];
      if (v25)
      {
        CFDictionarySetValue(v24, @"gl-attr-counter", v25);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15878();
      }

      if (!v19)
      {
        goto LABEL_88;
      }
    }

    else
    {
      v24 = 0;
      if (!v19)
      {
LABEL_88:
        if (dCopy)
        {
          v68 = [MEMORY[0x1E696AD98] numberWithChar:linkID];
          if (v68)
          {
            CFDictionarySetValue(v24, @"gl-attr-active-probing-link-id", v68);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15988();
          }

          v69 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:dCopy];
          if (v69)
          {
            CFDictionarySetValue(v24, @"gl-attr-remote-relay-link-id", v69);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E15A10();
          }
        }

        [(IDSGlobalLink *)selfCopy _sendCommandMessage:32771 stunMessage:0 options:v24 candidatePairToken:v72];
LABEL_99:

        goto LABEL_100;
      }
    }

    v90[0] = 0;
    v90[1] = bswap32(v19);
    v63 = ids_monotonic_time();
    v64 = ntpTime32(v63);
    v65 = v64 - ntpTime32(time);
    v90[2] = bswap32(v65);
    if (!v24)
    {
      v24 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    }

    v66 = [MEMORY[0x1E695DEF0] dataWithBytes:v90 length:12];
    if (v66)
    {
      CFDictionarySetValue(v24, @"gl-attr-rttreport", v66);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15900();
    }

    v67 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67110144;
      *v81 = linkID;
      *&v81[4] = 1024;
      *&v81[6] = v23;
      v82 = 1024;
      *v83 = v19;
      *&v83[4] = 1024;
      *&v83[6] = v19;
      *v84 = 1024;
      *&v84[2] = v65;
      _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "receive rtt request on link %d (counter:%04x m:%08x), send resp (e:%08x d:%08x).", buf, 0x20u);
    }

    goto LABEL_88;
  }

LABEL_100:
}

- (void)_processCommandConnectionData:(id)data candidatePairToken:(id)token
{
  __b[129] = *MEMORY[0x1E69E9840];
  dataCopy = data;
  tokenCopy = token;
  v34 = 0;
  if (GLUtilHasValidUInt16Attr(dataCopy, 1, &v34))
  {
    if (self->_isUPlusOneSession && !self->_receivedRemoteDeviceVersion)
    {
      v19 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        LOWORD(__b[0]) = 0;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "[U+1] no remote device version received yet. Saving incoming ConnectionData[Ack] for later", __b, 2u);
      }

      objc_initWeak(__b, self);
      aBlock[0] = MEMORY[0x1E69E9820];
      aBlock[1] = 3221225472;
      aBlock[2] = sub_1A7B995F8;
      aBlock[3] = &unk_1E77E0FA0;
      objc_copyWeak(&v33, __b);
      v31 = dataCopy;
      v32 = tokenCopy;
      v20 = _Block_copy(aBlock);
      pendingCommandConnectionDataBlock = self->_pendingCommandConnectionDataBlock;
      self->_pendingCommandConnectionDataBlock = v20;

      objc_destroyWeak(&v33);
      objc_destroyWeak(__b);
    }

    else if ([dataCopy command] == 4)
    {
      memset(__b, 170, 0x400uLL);
      v29 = 0;
      if (GLUtilHasValidBinaryDataAttr(dataCopy, 3, __b, &v29))
      {
        v8 = MEMORY[0x1E695DF20];
        v9 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v34];
        v10 = [v8 dictionaryWithObject:v9 forKey:@"gl-attr-counter"];

        [(IDSGlobalLink *)self _sendCommandMessage:32772 stunMessage:0 options:v10 candidatePairToken:tokenCopy];
        if (self->_allowP2P || self->_useLinkEngine)
        {
          if (self->_remoteConnDataCounter < v34)
          {
            self->_remoteConnDataCounter = v34;
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109376;
              v36 = v34;
              v37 = 2048;
              v38 = v29;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receive connection data(count:%u, length:%zdB).", buf, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v27 = v34;
                v28 = v29;
                _IDSLogTransport(@"GL", @"IDS", @"receive connection data(count:%u, length:%zdB).");
                if (_IDSShouldLog())
                {
                  v27 = v34;
                  v28 = v29;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"receive connection data(count:%u, length:%zdB).");
                }
              }
            }

            v12 = [IDSStunConnectionDataController sharedInstance:v27];
            v13 = [MEMORY[0x1E695DEF0] dataWithBytes:__b length:v29];
            v14 = [v12 candidatesFromData:v13 token:self->_cbuuid];

            [(IDSGlobalLink *)self _processRemoteCandidates:v14];
            [(IDSGlobalLink *)self _setupRelayConnectionForNetworkAddressChanges];
            goto LABEL_38;
          }

          v14 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 67109120;
            v36 = v34;
            v24 = "receive old conn data(count:%u), ignore.";
            v25 = v14;
            v26 = 8;
LABEL_37:
            _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, v24, buf, v26);
          }
        }

        else
        {
          v14 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            v24 = "P2P is not allowed, skip processing remote connection data.";
            v25 = v14;
            v26 = 2;
            goto LABEL_37;
          }
        }

LABEL_38:

        goto LABEL_19;
      }

      v22 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid data.", buf, 2u);
      }
    }

    else
    {
      v16 = self->_localConnDataCounter > v34;
      v17 = +[IDSFoundationLog GlobalLink];
      v18 = os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT);
      if (v16)
      {
        if (v18)
        {
          LODWORD(__b[0]) = 67109120;
          HIDWORD(__b[0]) = v34;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive connection data ack(count:%u), ignore.", __b, 8u);
        }
      }

      else
      {
        if (v18)
        {
          LODWORD(__b[0]) = 67109120;
          HIDWORD(__b[0]) = v34;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive connection data ack(count:%u).", __b, 8u);
        }

        v23 = +[IDSStunConnectionDataController sharedInstance];
        [v23 setDeliveryStatus:self->_cbuuid status:2];
      }
    }
  }

  else
  {
    v15 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      LOWORD(__b[0]) = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid counter.", __b, 2u);
    }
  }

LABEL_19:
}

- (void)_processCommandNominate:(id)nominate candidatePairToken:(id)token
{
  v33 = *MEMORY[0x1E69E9840];
  nominateCopy = nominate;
  tokenCopy = token;
  command = [nominateCopy command];
  bzero(v31, 0x410uLL);
  if ([nominateCopy getAttribute:1 attribute:v31])
  {
    v9 = v32;
    if (tokenCopy && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v11 = CFDictionaryGetValue(tokenToCandidatePairs, tokenCopy)) != 0)
    {
      v12 = v11;
      v13 = 1;
    }

    else
    {
      if (!tokenCopy || (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) == 0 || (v16 = CFDictionaryGetValue(tokenToStunCheckPairs, tokenCopy)) == 0)
      {
        v18 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109378;
          v28 = command;
          v29 = 2112;
          v30 = tokenCopy;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "failed to process session command %04x due to invalid candidate pair for %@.", buf, 0x12u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to process session command %04x due to invalid candidate pair for %@.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process session command %04x due to invalid candidate pair for %@.");
            }
          }
        }

        v12 = 0;
        goto LABEL_31;
      }

      v12 = v16;
      v13 = 0;
    }

    if (command == 5)
    {
      if (self->_isInitiator)
      {
        v17 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive nomination while being Initiator, this shouldn't happen.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive nomination while being Initiator, this shouldn't happen.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination while being Initiator, this shouldn't happen.");
            }
          }
        }
      }

      else if (self->_nominateCount <= v9)
      {
        v23 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "receive new nomination #%d.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v26 = v9;
            _IDSLogTransport(@"GL", @"IDS", @"receive new nomination #%d.");
            if (_IDSShouldLog())
            {
              v26 = v9;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new nomination #%d.");
            }
          }
        }

        self->_nominateCount = v9;
        [(IDSGlobalLink *)self _updateNominatedCandidatePair:tokenCopy, v26];
        v24 = objc_alloc_init(MEMORY[0x1E695DF90]);
        v25 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v9];
        if (v25)
        {
          CFDictionarySetValue(v24, @"gl-attr-counter", v25);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15878();
        }

        [(IDSGlobalLink *)self _sendCommandMessage:32773 stunMessage:0 options:v24 candidatePairToken:tokenCopy];
        if (v13 && ([v12 isActive] & 1) == 0)
        {
          [(IDSGlobalLink *)self _updateDefaultCandidatePair:v12];
          [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:tokenCopy error:0];
        }
      }

      else
      {
        v20 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "receive old nomination #%d.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive old nomination #%d.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive old nomination #%d.");
            }
          }
        }
      }
    }

    else if (self->_isInitiator)
    {
      if (self->_nominateCount == v9)
      {
        v19 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "nomination #%d is accepted.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"nomination #%d is accepted.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"nomination #%d is accepted.");
            }
          }
        }

        if (v13 && ([v12 isActive] & 1) == 0)
        {
          [(IDSGlobalLink *)self _updateDefaultCandidatePair:v12];
          [(IDSGlobalLink *)self _notifyDefaultUnderlyingLinkChanged:tokenCopy error:0];
        }
      }

      else
      {
        v22 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          v28 = v9;
          _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive nomination #%d ack, ignore.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"receive nomination #%d ack, ignore.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination #%d ack, ignore.");
            }
          }
        }
      }
    }

    else
    {
      v21 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "receive nomination ack while being Receiver, this shouldn't happen.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"receive nomination ack while being Receiver, this shouldn't happen.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive nomination ack while being Receiver, this shouldn't happen.");
          }
        }
      }
    }

LABEL_31:

    goto LABEL_32;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    v28 = command;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "missing nominate count in command %04x.", buf, 8u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"missing nominate count in command %04x.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"missing nominate count in command %04x.");
      }
    }
  }

LABEL_32:
}

- (void)_processCommandTestPacket:(id)packet candidatePairToken:(id)token remoteRelayLinkID:(unsigned __int16)d
{
  dCopy = d;
  v32 = *MEMORY[0x1E69E9840];
  packetCopy = packet;
  tokenCopy = token;
  v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:tokenCopy];
  if (v10 || tokenCopy && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v10 = CFDictionaryGetValue(tokenToStunCheckPairs, tokenCopy)) != 0)
  {
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = dCopy;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "test packet remote relay link id: %u", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v24 = dCopy;
        _IDSLogTransport(@"GL", @"IDS", @"test packet remote relay link id: %u");
        if (_IDSShouldLog())
        {
          v24 = dCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"test packet remote relay link id: %u");
        }
      }
    }

    if (dCopy && (localRemoteRelayLinkIDForVirtualStunCandidatePair([v10 relayLinkID], dCopy), v12 = objc_claimAutoreleasedReturnValue(), -[NSMutableDictionary objectForKeyedSubscript:](self->_localRemoteRelayLinkIDToVirtualCandidatePairs, "objectForKeyedSubscript:", v12), v13 = objc_claimAutoreleasedReturnValue(), v10, v12, (v10 = v13) == 0))
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *&buf[4] = tokenCopy;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to process command test packet due to invalid VR candidate pair for %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to process command test packet due to invalid VR candidate pair for %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process command test packet due to invalid VR candidate pair for %@.");
          }
        }
      }
    }

    else
    {
      memset(buf, 170, 0x400uLL);
      v26 = 0;
      if (GLUtilHasValidBinaryDataAttr(packetCopy, 15, buf, &v26))
      {
        v14 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:v26];
        v15 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          v16 = [v14 length];
          *v27 = 134218242;
          v28 = v16;
          v29 = 2112;
          v30 = tokenCopy;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Received %lu byte test packet for candidate pair for %@.", v27, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v24 = [v14 length];
            v25 = tokenCopy;
            _IDSLogTransport(@"GL", @"IDS", @"Received %lu byte test packet for candidate pair for %@.");
            if (_IDSShouldLog())
            {
              v24 = [v14 length:v24];
              v25 = tokenCopy;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Received %lu byte test packet for candidate pair for %@.");
            }
          }
        }

        [v10 receiveLinkTestStatsPacket:{v14, v24, v25}];
        if (self->_useLinkSelection)
        {
          linkEngine = [v10 linkEngine];
          v18 = linkEngine == 0;

          if (!v18)
          {
            linkEngine2 = [v10 linkEngine];
            linkUniqueName = [v10 linkUniqueName];
            [linkEngine2 didReceiveStatsTestPacketWithPayload:v14 linkName:linkUniqueName completionHandler:&unk_1F1AAA460];
          }
        }
      }

      else
      {
        v14 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
        {
          *v27 = 0;
          _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "_processCommandConnectionData failed due to invalid data.", v27, 2u);
        }
      }
    }
  }

  else
  {
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = tokenCopy;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "failed to process command test packet due to invalid candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to process command test packet due to invalid candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process command test packet due to invalid candidate pair for %@.");
        }
      }
    }
  }
}

- (void)_sendConnectionDataWithRemovedAddressList:(id)list
{
  v12 = *MEMORY[0x1E69E9840];
  listCopy = list;
  delayFirstConnectionData = self->_delayFirstConnectionData;
  if (delayFirstConnectionData < 1)
  {
    if (!delayFirstConnectionData)
    {
      [(IDSGlobalLink *)self _sendNowConnectionDataWithRemovedAddressList:listCopy];
    }
  }

  else
  {
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = self->_delayFirstConnectionData;
      *buf = 134217984;
      v11 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "delaying first connection data transmission by %lu ms", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"delaying first connection data transmission by %lu ms");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"delaying first connection data transmission by %lu ms");
        }
      }
    }

    v8[0] = MEMORY[0x1E69E9820];
    v8[1] = 3221225472;
    v8[2] = sub_1A7B9A700;
    v8[3] = &unk_1E77E0250;
    v8[4] = self;
    v9 = listCopy;
    IDSTransportThreadAddBlockAfter(v8, self->_delayFirstConnectionData / 1000.0);
    self->_delayFirstConnectionData = -self->_delayFirstConnectionData;
  }
}

- (void)_sendNowConnectionDataWithRemovedAddressList:(id)list
{
  v57 = *MEMORY[0x1E69E9840];
  listCopy = list;
  v41 = listCopy;
  if (self->_allowP2P || self->_useLinkEngine)
  {
    selfCopy = self;
    self->_delayedConnData = 1;
    v49 = 0u;
    v50 = 0u;
    v51 = 0u;
    v52 = 0u;
    v5 = listCopy;
    v6 = [v5 countByEnumeratingWithState:&v49 objects:v56 count:16];
    v7 = 0;
    if (v6)
    {
      v8 = *v50;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v50 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v49 + 1) + 8 * i);
          v11 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index", name2, index2)}];
          v12 = [v7 containsObject:v11];

          if ((v12 & 1) == 0)
          {
            if (v7 || (v7 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              v13 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index")}];
              v14 = v13 == 0;

              if (!v14)
              {
                v15 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v10, "index")}];
                CFArrayAppendValue(v7, v15);
              }
            }

            v16 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
            {
              name = [v10 name];
              index = [v10 index];
              *buf = 138412546;
              *v55 = name;
              *&v55[8] = 1024;
              *&v55[10] = index;
              _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "removed if_index [%@:%d].", buf, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                name2 = [v10 name];
                index2 = [v10 index];
                _IDSLogTransport(@"GL", @"IDS", @"removed if_index [%@:%d].");

                if (_IDSShouldLog())
                {
                  name2 = [v10 name];
                  index2 = [v10 index];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"removed if_index [%@:%d].");
                }
              }
            }
          }
        }

        v6 = [v5 countByEnumeratingWithState:&v49 objects:v56 count:16];
      }

      while (v6);
    }

    [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs allValues];
    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    obj = v46 = 0u;
    v19 = [obj countByEnumeratingWithState:&v45 objects:v53 count:16];
    if (!v19)
    {
      v42 = 0;
      goto LABEL_46;
    }

    v20 = 0;
    v42 = 0;
    v21 = *v46;
    while (1)
    {
      for (j = 0; j != v19; ++j)
      {
        if (*v46 != v21)
        {
          objc_enumerationMutation(obj);
        }

        v23 = *(*(&v45 + 1) + 8 * j);
        local = [v23 local];
        index3 = [local index];

        state = [v23 state];
        v27 = [MEMORY[0x1E696AD98] numberWithInt:index3];
        v28 = [v7 containsObject:v27];

        if ((v28 & 1) == 0)
        {
          if ([v23 isRelayStunCandidatePair])
          {
            if (state != 4)
            {
              continue;
            }
          }

          else if (state != 3)
          {
            continue;
          }

          candidatePairToken = [v23 candidatePairToken];

          if ((v20 & 1) == 0)
          {
            v30 = +[IDSStunConnectionDataController sharedInstance];
            [v30 removeData:selfCopy->_cbuuid];

            ++selfCopy->_localConnDataCounter;
          }

          if (candidatePairToken)
          {
            selfCopy->_delayedConnData = 0;
            v31 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
            {
              localConnDataCounter = selfCopy->_localConnDataCounter;
              *buf = 67109378;
              *v55 = localConnDataCounter;
              *&v55[4] = 2112;
              *&v55[6] = candidatePairToken;
              _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "send connection data (count:%d) using %@.", buf, 0x12u);
            }

            v33 = selfCopy;
            if (os_log_shim_legacy_logging_enabled())
            {
              v33 = selfCopy;
              if (_IDSShouldLogTransport())
              {
                name2 = selfCopy->_localConnDataCounter;
                index2 = candidatePairToken;
                _IDSLogTransport(@"GL", @"IDS", @"send connection data (count:%d) using %@.");
                v33 = selfCopy;
                if (_IDSShouldLog())
                {
                  name2 = selfCopy->_localConnDataCounter;
                  index2 = candidatePairToken;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"send connection data (count:%d) using %@.");
                  v33 = selfCopy;
                }
              }
            }

            v34 = MEMORY[0x1E695DF20];
            v35 = [MEMORY[0x1E696AD98] numberWithInt:{v33->_localConnDataCounter, name2, index2}];
            name2 = @"gl-attr-counter";
            index2 = 0;
            v36 = [v34 dictionaryWithObjectsAndKeys:v35];

            [(IDSGlobalLink *)selfCopy _sendCommandMessage:4 stunMessage:0 options:v36 candidatePairToken:candidatePairToken];
            v20 = 1;
            v42 = candidatePairToken;
          }

          else
          {
            v42 = 0;
            v20 = 1;
          }
        }
      }

      v19 = [obj countByEnumeratingWithState:&v45 objects:v53 count:16];
      if (!v19)
      {
LABEL_46:

        if (selfCopy->_delayedConnData)
        {
          v37 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "delay sending connection data, no link is available.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"delay sending connection data, no link is available.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"delay sending connection data, no link is available.");
              }
            }
          }
        }

        goto LABEL_54;
      }
    }
  }

  v38 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "P2P is not allowed, skip sending connection data.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"P2P is not allowed, skip sending connection data.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"P2P is not allowed, skip sending connection data.");
      }
    }
  }

LABEL_54:
}

- (void)_handleDisconnectTimer
{
  v8 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    disconnectTimer = self->_disconnectTimer;
    *buf = 134217984;
    v7 = disconnectTimer;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "disconnect timer %p fired.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v5 = self->_disconnectTimer;
      _IDSLogTransport(@"GL", @"IDS", @"disconnect timer %p fired.");
      if (_IDSShouldLog())
      {
        v5 = self->_disconnectTimer;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"disconnect timer %p fired.");
      }
    }
  }

  [(IDSGlobalLink *)self _discardAllCandidatePairs:0, v5];
  [(IDSGlobalLink *)self _stopDisconnectTimer];
}

- (void)_handleDisconnect:(BOOL)disconnect
{
  [(IDSGlobalLink *)self _discardAllCandidatePairs:disconnect];

  [(IDSGlobalLink *)self _stopDisconnectTimer];
}

- (void)_startDisconnectTimer
{
  v15 = *MEMORY[0x1E69E9840];
  disconnectTimer = self->_disconnectTimer;
  if (disconnectTimer)
  {
    dispatch_source_cancel(disconnectTimer);
  }

  v4 = im_primary_queue();
  v5 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v4);
  v6 = self->_disconnectTimer;
  self->_disconnectTimer = v5;

  v7 = self->_disconnectTimer;
  v8 = dispatch_time(0, 3000000000);
  dispatch_source_set_timer(v7, v8, 0xB2D05E00uLL, 0x5F5E100uLL);
  v9 = self->_disconnectTimer;
  handler[0] = MEMORY[0x1E69E9820];
  handler[1] = 3221225472;
  handler[2] = sub_1A7B9B294;
  handler[3] = &unk_1E77E0818;
  handler[4] = self;
  dispatch_source_set_event_handler(v9, handler);
  dispatch_resume(self->_disconnectTimer);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = self->_disconnectTimer;
    *buf = 134217984;
    v14 = v11;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "start disconnect timer %p.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    _IDSLogTransport(@"GL", @"IDS", @"start disconnect timer %p.");
    if (_IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"start disconnect timer %p.");
    }
  }
}

- (void)_stopDisconnectTimer
{
  v9 = *MEMORY[0x1E69E9840];
  disconnectTimer = self->_disconnectTimer;
  if (disconnectTimer)
  {
    dispatch_source_cancel(disconnectTimer);
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = self->_disconnectTimer;
      *buf = 134217984;
      v8 = v5;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop disconnect timer %p.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop disconnect timer %p.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop disconnect timer %p.");
      }
    }

    v6 = self->_disconnectTimer;
    self->_disconnectTimer = 0;
  }
}

- (void)_schedulePacketLogFlush
{
  if (self->_packetLog)
  {
    objc_initWeak(&location, self);
    v2[0] = MEMORY[0x1E69E9820];
    v2[1] = 3221225472;
    v2[2] = sub_1A7B9B520;
    v2[3] = &unk_1E77E0FC8;
    objc_copyWeak(&v3, &location);
    IDSTransportThreadAddBlockAfter(v2, 3.0);
    objc_destroyWeak(&v3);
    objc_destroyWeak(&location);
  }
}

- (void)_flushPacketLogTick
{
  packetLog = self->_packetLog;
  if (packetLog && self->_state <= 4)
  {
    [(IDSObjCPacketLog *)packetLog flush];

    [(IDSGlobalLink *)self _schedulePacketLogFlush];
  }
}

- (void)_handleActivityTimer
{
  v69 = *MEMORY[0x1E69E9840];
  v3 = ids_monotonic_time();
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    activityTimer = self->_activityTimer;
    *buf = 134218240;
    v63 = activityTimer;
    v64 = 2048;
    v65 = v3;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "activity timer %p fired (%.6f).", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v52 = v3;
      v50 = self->_activityTimer;
      _IDSLogTransport(@"GL", @"IDS", @"activity timer %p fired (%.6f).");
      if (_IDSShouldLog())
      {
        v52 = v3;
        v50 = self->_activityTimer;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"activity timer %p fired (%.6f).");
      }
    }
  }

  if (self->_state != 4)
  {
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v63 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "GL state is [%s], stop activity timer.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v50 = _IDSLinkStateStrings[self->_state];
        _IDSLogTransport(@"GL", @"IDS", @"GL state is [%s], stop activity timer.");
        if (_IDSShouldLog())
        {
          v50 = _IDSLinkStateStrings[self->_state];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"GL state is [%s], stop activity timer.");
        }
      }
    }

    [(IDSGlobalLink *)self _stopActivityTimer:v50];
  }

  v60 = 0u;
  v61 = 0u;
  v58 = 0u;
  v59 = 0u;
  obj = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = [obj countByEnumeratingWithState:&v58 objects:v68 count:16];
  if (!v8)
  {

    return;
  }

  v9 = *v59;
  v10 = 0.0;
  do
  {
    for (i = 0; i != v8; ++i)
    {
      if (*v59 != v9)
      {
        objc_enumerationMutation(obj);
      }

      v12 = *(*(&v58 + 1) + 8 * i);
      state = [v12 state];
      isActive = [v12 isActive];
      isRelayStunCandidatePair = [v12 isRelayStunCandidatePair];
      isSelfQRSession = [v12 isSelfQRSession];
      isSharedQRSession = [v12 isSharedQRSession];
      if (((state - 5) < 0xFFFFFFFFFFFFFFFELL) | isSelfQRSession & 1)
      {
        continue;
      }

      v18 = isSharedQRSession;
      mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
      isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

      if (isInternalInstall)
      {
        [v12 testStartTime];
        if (v21 != 0.0)
        {
          [v12 testStartTime];
          if (v3 >= v22)
          {
            if ([v12 isQUIC])
            {
              [v12 sendQUICTestRequest];
            }

            else
            {
              [v12 sendTestRequest:0];
            }
          }
        }
      }

      [v12 lastOutgoingPacketTime];
      v56 = v23;
      [v12 lastIncomingPacketTime];
      v54 = v24;
      [v12 lastStatsReport];
      v26 = v25;
      linkID = [v12 linkID];
      v28.f64[0] = v56;
      v28.f64[1] = v54;
      v57 = v28;
      if (linkID)
      {
        v29 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, linkID);
        v30 = v29;
        if (v29)
        {
          v55 = v29[19];
          if (v26 < v29[20].f64[0])
          {
            v26 = v29[20].f64[0];
          }

          [v12 setTotalPacketsSentOnLink:LODWORD(v29[20].f64[1])];
          [v12 setTotalPacketsReceivedOnLink:HIDWORD(v30[20].f64[1])];
          v57 = vbslq_s8(vcgtq_f64(v55, v57), v55, v57);
        }

        if (isActive)
        {
LABEL_33:
          v31 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          v32 = v31;
          if (v31)
          {
            v57 = vbslq_s8(vcgtq_f64(v31[19], v57), v31[19], v57);
            if (v26 < v31[20].f64[0])
            {
              v26 = v31[20].f64[0];
            }
          }

          goto LABEL_39;
        }
      }

      else
      {
        v30 = 0;
        if (isActive)
        {
          goto LABEL_33;
        }
      }

      v32 = 0;
LABEL_39:
      [v12 setLastOutgoingPacketTime:v57.f64[0]];
      [v12 setLastIncomingPacketTime:v57.f64[1]];
      if (v10 < v57.f64[1])
      {
        v10 = v57.f64[1];
      }

      if (!isRelayStunCandidatePair)
      {
        v40 = v57.f64[0];
        if (v57.f64[0] > 0.0)
        {
          natMappingTimeout = self->_natMappingTimeout;
          goto LABEL_57;
        }

LABEL_64:
        if (v57.f64[1] > 0.0 && v3 - v57.f64[1] >= 30.0 && ([v12 hbStarted] & 1) == 0)
        {
          v47 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken = [v12 candidatePairToken];
            *buf = 138412546;
            v63 = candidatePairToken;
            v64 = 2048;
            v65 = v3 - v57.f64[1];
            _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "%@ has no remote packet for %.6f sec, send HBR.", buf, 0x16u);
          }

          [(IDSGlobalLink *)self _startHB:v12];
        }

        continue;
      }

      if (v3 - v26 >= [v12 statsIntervalInSeconds])
      {
        if (v30)
        {
          v30[20].f64[0] = v3;
        }

        if (v32)
        {
          v32[20].f64[0] = v3;
        }

        [v12 setLastStatsReport:v3];
        if ([v12 isQUIC])
        {
          linkIDToStatsData = self->_linkIDToStatsData;
          v34 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-send", linkID];
          v35 = [(NSMutableDictionary *)linkIDToStatsData objectForKeyedSubscript:v34];

          v36 = self->_linkIDToStatsData;
          v37 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-recv", linkID];
          v38 = [(NSMutableDictionary *)v36 objectForKeyedSubscript:v37];

          if (v35 && v38)
          {
            [v35 unsignedIntValue];
            [v38 unsignedIntValue];
          }

          Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          [v12 sendQUICStatsRequestWithOptions:Mutable];
        }

        else
        {
          [v12 sendStatsRequest:0 options:0];
        }
      }

      if ((v18 & 1) == 0)
      {
        natMappingTimeout = 20.0;
        v40 = v57.f64[0];
        if (v57.f64[0] > 0.0)
        {
LABEL_57:
          v42 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken2 = [v12 candidatePairToken];
            hbStarted = [v12 hbStarted];
            *buf = 138412802;
            v45 = @"NO";
            if (hbStarted)
            {
              v45 = @"YES";
            }

            v63 = candidatePairToken2;
            v64 = 2048;
            v65 = v3 - v57.f64[0];
            v66 = 2112;
            v67 = v45;
            _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "%@ is idle for %.6f sec (hbStarted:%@).", buf, 0x20u);
          }

          if (v3 - v57.f64[0] >= natMappingTimeout && ([v12 hbStarted] & 1) == 0)
          {
            [v12 setHbStarted:1];
            candidatePairToken3 = [v12 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:candidatePairToken3];
          }
        }

        goto LABEL_64;
      }
    }

    v8 = [obj countByEnumeratingWithState:&v58 objects:v68 count:16];
  }

  while (v8);

  if (v10 != 0.0 && v3 - v10 >= 60.0)
  {
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v63) = 60;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "No remote packets for %d seconds.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v51 = 60;
      _IDSLogTransport(@"GL", @"IDS", @"No remote packets for %d seconds.");
      if (_IDSShouldLog())
      {
        v51 = 60;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"No remote packets for %d seconds.");
      }
    }

    [(IDSGlobalLink *)self _handleNoRemotePacket];
  }
}

- (void)_startActivityTimer
{
  v15 = *MEMORY[0x1E69E9840];
  activityTimer = self->_activityTimer;
  if (activityTimer)
  {
    dispatch_source_cancel(activityTimer);
  }

  v4 = im_primary_queue();
  v5 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v4);
  v6 = self->_activityTimer;
  self->_activityTimer = v5;

  v7 = self->_activityTimer;
  v8 = dispatch_time(0, 5000000000);
  dispatch_source_set_timer(v7, v8, 0x12A05F200uLL, 0x5F5E100uLL);
  v9 = self->_activityTimer;
  handler[0] = MEMORY[0x1E69E9820];
  handler[1] = 3221225472;
  handler[2] = sub_1A7B9C0CC;
  handler[3] = &unk_1E77E0818;
  handler[4] = self;
  dispatch_source_set_event_handler(v9, handler);
  dispatch_resume(self->_activityTimer);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = self->_activityTimer;
    *buf = 134217984;
    v14 = v11;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "start activity timer %p.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    _IDSLogTransport(@"GL", @"IDS", @"start activity timer %p.");
    if (_IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"start activity timer %p.");
    }
  }
}

- (void)_stopActivityTimer
{
  v9 = *MEMORY[0x1E69E9840];
  activityTimer = self->_activityTimer;
  if (activityTimer)
  {
    dispatch_source_cancel(activityTimer);
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = self->_activityTimer;
      *buf = 134217984;
      v8 = v5;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop activity timer %p.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop activity timer %p.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop activity timer %p.");
      }
    }

    v6 = self->_activityTimer;
    self->_activityTimer = 0;
  }
}

- (void)_addStunCheckPair:(id)pair isRemoteCandidate:(BOOL)candidate excludeLocalAddress:(sockaddr *)address
{
  candidateCopy = candidate;
  v77 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  if (!self->_allowP2P)
  {
    goto LABEL_92;
  }

  v8 = 1464;
  if (candidateCopy)
  {
    v8 = 1456;
  }

  v9 = *(&self->super.isa + v8);
  v52 = pairCopy;
  v55 = candidateCopy;
  selfCopy = self;
  v47 = v9;
  if (!candidateCopy)
  {
    goto LABEL_18;
  }

  external = [(NSMutableArray *)pairCopy external];
  hasNATIPv4External = [(NSMutableArray *)pairCopy hasNATIPv4External];
  v64 = 0u;
  v65 = 0u;
  v66 = 0u;
  v67 = 0u;
  obj = self->_localCandidateList;
  v12 = [(NSMutableArray *)obj countByEnumeratingWithState:&v64 objects:v76 count:16];
  if (!v12)
  {
LABEL_17:

    v9 = v47;
LABEL_18:
    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    obj = v9;
    v53 = [(NSMutableArray *)obj countByEnumeratingWithState:&v60 objects:v75 count:16];
    if (!v53)
    {
      goto LABEL_91;
    }

    v17 = v55;
    if (!address)
    {
      v17 = 0;
    }

    v49 = v17;
    v51 = *v61;
    while (1)
    {
      for (i = 0; i != v53; ++i)
      {
        if (*v61 != v51)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v60 + 1) + 8 * i);
        if (v55)
        {
          v20 = *(*(&v60 + 1) + 8 * i);
        }

        else
        {
          v20 = v52;
        }

        if (v55)
        {
          v21 = v52;
        }

        else
        {
          v21 = *(*(&v60 + 1) + 8 * i);
        }

        v22 = v20;
        v23 = v21;
        if ([(NSMutableArray *)v22 isCompatibleWithStunCandidate:v23]&& (!v49 || !IsSameSA([(NSMutableArray *)v22 address], address)))
        {
          if (!v55)
          {
            external2 = [v19 external];
            hasNATIPv4External2 = [v19 hasNATIPv4External];
            v58 = 0u;
            v59 = 0u;
            v56 = 0u;
            v57 = 0u;
            v26 = selfCopy->_localCandidateList;
            v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v56 objects:v74 count:16];
            if (v27)
            {
              v28 = *v57;
              while (2)
              {
                for (j = 0; j != v27; ++j)
                {
                  if (*v57 != v28)
                  {
                    objc_enumerationMutation(v26);
                  }

                  v30 = *(*(&v56 + 1) + 8 * j);
                  address = [v30 address];
                  if (hasNATIPv4External2)
                  {
                    if (IsSameIP(address, external2))
                    {
                      goto LABEL_65;
                    }
                  }

                  else if (IsSameSA(address, external2))
                  {
LABEL_65:
                    v41 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
                    {
                      *buf = 138412802;
                      v69 = v22;
                      v70 = 2112;
                      v71 = v23;
                      v72 = 2112;
                      v73 = v30;
                      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)", buf, 0x20u);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v45 = v23;
                        v46 = v30;
                        candidatePairToken2 = v22;
                        _IDSLogTransport(@"GL", @"IDS", @"skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)");
                        if (_IDSShouldLog())
                        {
                          v45 = v23;
                          v46 = v30;
                          candidatePairToken2 = v22;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip invalid local-remote candidate pair %@-%@ (due to local candidate %@)");
                        }
                      }
                    }

                    goto LABEL_81;
                  }
                }

                v27 = [(NSMutableArray *)v26 countByEnumeratingWithState:&v56 objects:v74 count:16];
                if (v27)
                {
                  continue;
                }

                break;
              }
            }
          }

          v26 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v22 remoteCandidate:v23 sessionID:selfCopy->_cbuuid delegate:candidatePairToken2];
          if (selfCopy->_isInitiator)
          {
            uUID = [MEMORY[0x1E696AFB0] UUID];
            [(NSMutableArray *)v26 setLinkUUID:uUID];
          }

          if ((-[NSMutableArray hasNATIPv4Address](v22, "hasNATIPv4Address") & 1) == 0 && [v23 hasNATIPv4External])
          {
            v33 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
            {
              candidatePairToken = [(NSMutableArray *)v26 candidatePairToken];
              *buf = 138412290;
              v69 = candidatePairToken;
              _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "skip stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                candidatePairToken2 = [(NSMutableArray *)v26 candidatePairToken];
                _IDSLogTransport(@"GL", @"IDS", @"skip stun check pair %@.");

                if (_IDSShouldLog())
                {
                  candidatePairToken2 = [(NSMutableArray *)v26 candidatePairToken];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"skip stun check pair %@.");
                }
              }
            }

            goto LABEL_81;
          }

          candidatePairToken3 = [(NSMutableArray *)v26 candidatePairToken];
          v36 = selfCopy;
          tokenToStunCheckPairs = selfCopy->_tokenToStunCheckPairs;
          if (tokenToStunCheckPairs && candidatePairToken3)
          {
            if (!CFDictionaryGetValue(tokenToStunCheckPairs, candidatePairToken3))
            {
              v36 = selfCopy;
              tokenToStunCheckPairs = selfCopy->_tokenToStunCheckPairs;
              goto LABEL_61;
            }
          }

          else
          {
LABEL_61:
            if (!tokenToStunCheckPairs)
            {
              Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              v39 = selfCopy->_tokenToStunCheckPairs;
              selfCopy->_tokenToStunCheckPairs = Mutable;

              v36 = selfCopy;
            }

            v40 = v26;
            if (v40)
            {
              CFDictionarySetValue(v36->_tokenToStunCheckPairs, candidatePairToken3, v40);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              *buf = 138412546;
              v69 = candidatePairToken3;
              v70 = 2080;
              v71 = "_tokenToStunCheckPairs";
              _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
            }

            v42 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v69 = v40;
              _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "add stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                candidatePairToken2 = v40;
                _IDSLogTransport(@"GL", @"IDS", @"add stun check pair %@.");
                if (_IDSShouldLog())
                {
                  candidatePairToken2 = v40;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"add stun check pair %@.");
                }
              }
            }

            [(IDSGlobalLink *)selfCopy registerP2PCandidatePairWithLinkEngine:v40, candidatePairToken2];
            [(IDSGlobalLink *)selfCopy _startStunCheck:candidatePairToken3];
          }

LABEL_81:
        }
      }

      v53 = [(NSMutableArray *)obj countByEnumeratingWithState:&v60 objects:v75 count:16];
      if (!v53)
      {
        goto LABEL_91;
      }
    }
  }

  v13 = *v65;
LABEL_7:
  v14 = 0;
  while (1)
  {
    if (*v65 != v13)
    {
      objc_enumerationMutation(obj);
    }

    v15 = *(*(&v64 + 1) + 8 * v14);
    address2 = [v15 address];
    if (hasNATIPv4External)
    {
      if (IsSameIP(address2, external))
      {
        break;
      }

      goto LABEL_15;
    }

    if (IsSameSA(address2, external) || IsSameIP([v15 external], external))
    {
      break;
    }

LABEL_15:
    if (v12 == ++v14)
    {
      v12 = [(NSMutableArray *)obj countByEnumeratingWithState:&v64 objects:v76 count:16];
      if (!v12)
      {
        goto LABEL_17;
      }

      goto LABEL_7;
    }
  }

  v43 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412546;
    v69 = pairCopy;
    v70 = 2112;
    v71 = v15;
    _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "skip invalid remote candidate %@ (due to local candidate %@)", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip invalid remote candidate %@ (due to local candidate %@)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip invalid remote candidate %@ (due to local candidate %@)");
      }
    }
  }

LABEL_91:

  pairCopy = v52;
LABEL_92:
}

- (void)registerP2PCandidatePairWithLinkEngine:(id)engine
{
  engineCopy = engine;
  if (self->_useLinkEngine)
  {
    v7 = engineCopy;
    p2pLinkEngine = [(IDSGlobalLink *)self p2pLinkEngine];
    v6 = [p2pLinkEngine addLinkForCandidatePair:v7];
    if (v6)
    {
      [v7 setLinkEngine:p2pLinkEngine];
      [v7 setLinkUniqueName:v6];
    }

    engineCopy = v7;
  }
}

- (BOOL)_addCandidate:(id)candidate isRemoteCandidate:(BOOL)remoteCandidate
{
  remoteCandidateCopy = remoteCandidate;
  v26 = *MEMORY[0x1E69E9840];
  candidateCopy = candidate;
  v7 = candidateCopy;
  if (!candidateCopy || ([candidateCopy isLinkLocalStunCandidate] & 1) != 0)
  {
    goto LABEL_3;
  }

  if (remoteCandidateCopy)
  {
    if (([(NSMutableArray *)self->_remoteCandidateList containsObject:v7]& 1) != 0)
    {
LABEL_3:
      v8 = 0;
      goto LABEL_4;
    }

    remoteCandidateList = self->_remoteCandidateList;
    if (remoteCandidateList || (v11 = objc_alloc_init(MEMORY[0x1E695DF70]), v12 = self->_remoteCandidateList, self->_remoteCandidateList = v11, v12, (remoteCandidateList = self->_remoteCandidateList) != 0))
    {
      CFArrayAppendValue(remoteCandidateList, v7);
    }

    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v23 = v7;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "add remote candidate %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"add remote candidate %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"add remote candidate %@.");
        }
      }
    }

    v8 = 1;
  }

  else
  {
    v14 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [v7 index]);
    if (self->_cellInterfaceName && [v7 isCellularStunCandidate] && (-[NSString isEqualToIgnoringCase:](self->_cellInterfaceName, "isEqualToIgnoringCase:", v14) & 1) == 0)
    {
      v20 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        cellInterfaceName = self->_cellInterfaceName;
        *buf = 138412546;
        v23 = v14;
        v24 = 2112;
        v25 = cellInterfaceName;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip adding currentInterfaceName to _localCandidateList", buf, 0x16u);
      }

      goto LABEL_3;
    }

    v15 = [(NSMutableArray *)self->_localCandidateList containsObject:v7];
    if ((v15 & 1) == 0)
    {
      if (-[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [v7 index]))
      {
        [v7 setLinkFlags:{objc_msgSend(v7, "linkFlags") | 4}];
      }

      localCandidateList = self->_localCandidateList;
      if (localCandidateList || (v17 = objc_alloc_init(MEMORY[0x1E695DF70]), v18 = self->_localCandidateList, self->_localCandidateList = v17, v18, (localCandidateList = self->_localCandidateList) != 0))
      {
        CFArrayAppendValue(localCandidateList, v7);
      }

      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v23 = v7;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "add local candidate %@.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"add local candidate %@.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"add local candidate %@.");
          }
        }
      }
    }

    v8 = v15 ^ 1;
  }

LABEL_4:

  return v8;
}

- (BOOL)_hasActiveAllocbindFailoverTimerForSessionID:(id)d
{
  v29 = *MEMORY[0x1E69E9840];
  dCopy = d;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = allValues;
  if (dCopy)
  {
    v24 = 0u;
    v25 = 0u;
    v22 = 0u;
    v23 = 0u;
    v7 = allValues;
    v8 = [v7 countByEnumeratingWithState:&v22 objects:v28 count:16];
    if (v8)
    {
      v9 = *v23;
      while (2)
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v23 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = *(*(&v22 + 1) + 8 * i);
          sessionID = [v11 sessionID];
          v13 = [sessionID isEqualToString:dCopy];

          if (v13)
          {
            allocbindFailoverTimer = [v11 allocbindFailoverTimer];

            if (allocbindFailoverTimer)
            {
              v17 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                allocbindFailoverTimer2 = [v11 allocbindFailoverTimer];
                *buf = 134217984;
                v27 = allocbindFailoverTimer2;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "found active allocbind failover timer: %p", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  allocbindFailoverTimer3 = [v11 allocbindFailoverTimer];
                  _IDSLogTransport(@"GL", @"IDS", @"found active allocbind failover timer: %p");

                  if (_IDSShouldLog())
                  {
                    allocbindFailoverTimer4 = [v11 allocbindFailoverTimer];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"found active allocbind failover timer: %p");
                  }
                }
              }

              v16 = 1;
              goto LABEL_26;
            }
          }
        }

        v8 = [v7 countByEnumeratingWithState:&v22 objects:v28 count:16];
        if (v8)
        {
          continue;
        }

        break;
      }
    }
  }

  else
  {
    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "Couldn't find active allocbind failover timer due to invalid relaySessionID", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Couldn't find active allocbind failover timer due to invalid relaySessionID");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Couldn't find active allocbind failover timer due to invalid relaySessionID");
        }
      }
    }
  }

  v16 = 0;
LABEL_26:

  return v16;
}

- (void)_startAllocbindFailoverTimerOnCandidatePair:(id)pair delay:(int)delay
{
  v37 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  v7 = pairCopy;
  if (!self->_useLinkEngine)
  {
    local = [pairCopy local];
    isCellularStunCandidate = [local isCellularStunCandidate];
    if (isCellularStunCandidate)
    {
      v10 = 2;
    }

    else
    {
      v10 = 1;
    }

    allocbindFailoverTimer = [v7 allocbindFailoverTimer];
    if (allocbindFailoverTimer)
    {
    }

    else if (isCellularStunCandidate & 1 | !self->_reduceCellularUsage)
    {
      v12 = [MEMORY[0x1E6995700] weakRefWithObject:self];
      v13 = v12;
      if (delay < 1)
      {
        v24[0] = MEMORY[0x1E69E9820];
        v24[1] = 3221225472;
        v24[2] = sub_1A7B9D890;
        v24[3] = &unk_1E77E1040;
        v25 = v12;
        v26 = v7;
        v27 = v10;
        IDSTransportThreadAddBlock(v24);
        v20 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          v21 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          *buf = 134217984;
          v34 = v21;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "start allocbind failover now, _tokenToCandidatePairs: %lu", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v22 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
            _IDSLogTransport(@"GL", @"IDS", @"start allocbind failover now, _tokenToCandidatePairs: %lu");
            if (_IDSShouldLog())
            {
              [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind failover now, _tokenToCandidatePairs: %lu");
            }
          }
        }

        v17 = v25;
      }

      else
      {
        v14 = im_primary_queue();
        v15 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v14);

        [v7 setAllocbindFailoverTimer:v15];
        v16 = dispatch_time(0, 1000000000 * delay);
        dispatch_source_set_timer(v15, v16, 0xFFFFFFFFFFFFFFFFLL, 0x3B9ACA00uLL);
        handler[0] = MEMORY[0x1E69E9820];
        handler[1] = 3221225472;
        handler[2] = sub_1A7B9D780;
        handler[3] = &unk_1E77E1018;
        v29 = v13;
        v30 = v7;
        v17 = v15;
        v31 = v17;
        v32 = v10;
        dispatch_source_set_event_handler(v17, handler);
        dispatch_resume(v17);
        v18 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          v19 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          *buf = 134218240;
          v34 = v17;
          v35 = 2048;
          v36 = v19;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "start allocbind failover timer %p, _tokenToCandidatePairs: %lu", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v23 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
            _IDSLogTransport(@"GL", @"IDS", @"start allocbind failover timer %p, _tokenToCandidatePairs: %lu");
            if (_IDSShouldLog())
            {
              [(NSMutableDictionary *)self->_tokenToCandidatePairs count:v17];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"start allocbind failover timer %p, _tokenToCandidatePairs: %lu");
            }
          }
        }
      }
    }
  }
}

- (void)_handleAllocbindFailoverTimerWithTransportScoreCards:(id)cards failoverTimerOnCandidatePair:(id)pair onInterface:(int)interface
{
  v5 = *&interface;
  v63 = *MEMORY[0x1E69E9840];
  cardsCopy = cards;
  pairCopy = pair;
  if (cardsCopy)
  {
    isConnectToQRIPv6Enabled = [cardsCopy isConnectToQRIPv6Enabled];
    isSharedQRSession = [cardsCopy isSharedQRSession];
    v12 = +[IDSServerBag sharedInstance];
    v13 = [v12 objectForKey:@"disable-transport-score-cards"];
    bOOLValue = [v13 BOOLValue];

    v15 = isConnectToQRIPv6Enabled ^ 1u;
    if (bOOLValue & v15 & 1) != 0 || ((isSharedQRSession ^ 1))
    {
      sessionInfoDict = [cardsCopy sessionInfoDict];
      [(IDSGlobalLink *)self _handleAllocbindFailoverTimer:sessionInfoDict failoverTimerOnCandidatePair:pairCopy onInterface:v5];
    }

    else if (self->_state < 4)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
        v25 = [(NSMutableArray *)self->_interfaceAddressArray count];
        *buf = 134218752;
        *&buf[4] = pairCopy;
        *&buf[12] = 2048;
        *&buf[14] = v24;
        *&buf[22] = 1024;
        *&buf[24] = v5;
        *&buf[28] = 2048;
        *&buf[30] = v25;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu", buf, 0x26u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v26 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          v49 = v5;
          v50 = [(NSMutableArray *)self->_interfaceAddressArray count];
          v44 = pairCopy;
          v47 = v26;
          _IDSLogTransport(@"GL", @"IDS", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
          if (_IDSShouldLog())
          {
            v27 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:pairCopy];
            v49 = v5;
            v50 = [(NSMutableArray *)self->_interfaceAddressArray count];
            v44 = pairCopy;
            v47 = v27;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
          }
        }
      }

      if (v5 == 1)
      {
        v29 = 0;
        v28 = 1;
      }

      else if (v5 == 2)
      {
        v28 = 0;
        v29 = 1;
      }

      else
      {
        v29 = 0;
        v28 = 0;
      }

      sessionID = [cardsCopy sessionID];
      v31 = [(IDSGlobalLink *)self _findTriedCandidatePairForSession:sessionID wantOnlyCell:v28 wantOnlyNonCell:v29];

      if (v31)
      {
        v32 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no need to try!");
            }
          }
        }
      }

      else
      {
        v33 = objc_alloc_init(IDSQuickRelaySessionInfo);
        sessionInfoDict2 = [cardsCopy sessionInfoDict];
        v35 = [(IDSQuickRelaySessionInfo *)v33 parseSessionInfo:sessionInfoDict2];

        if (v35)
        {
          v36 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
          {
            sessionInfoDict3 = [cardsCopy sessionInfoDict];
            *buf = 134218242;
            *&buf[4] = v35;
            *&buf[12] = 2112;
            *&buf[14] = sessionInfoDict3;
            _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "error code = %ld - parsing sessionInfo: %@", buf, 0x16u);
          }
        }

        else
        {
          [(IDSQuickRelaySessionInfo *)v33 serverAddressIPv6];
          v61 = 0u;
          v62 = 0u;
          v59 = 0u;
          v60 = 0u;
          v58 = 0u;
          memset(buf, 0, sizeof(buf));
          __memcpy_chk();
          valid = IsValidSA(buf);
          v51 = 0;
          v52 = 0;
          sessionID2 = [cardsCopy sessionID];
          LOBYTE(v45) = valid;
          [(IDSGlobalLink *)self _selectStunTransport:&v52 andInterfaceAddress:&v51 forRelaySessionID:sessionID2 preferIPv4:v15 wantOnlyCell:v28 wantOnlyNonCell:v29 isValidSA:v45];
          v40 = v51;

          if (v40)
          {
            v41 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
            {
              *v53 = 67109378;
              v54 = v5;
              v55 = 2112;
              v56 = v40;
              _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@", v53, 0x12u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v46 = v5;
                v48 = v40;
                _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@");
                if (_IDSShouldLog())
                {
                  v46 = v5;
                  v48 = v40;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards interface: %u, newLocalAddress: %@");
                }
              }
            }

            sessionInfoDict4 = [cardsCopy sessionInfoDict];
            [(IDSGlobalLink *)self _connectWithSessionInfo:sessionInfoDict4 interfaceAddress:v40 joinSession:1 allocbindFailover:1 completionHandler:self->_connectReadyHandler withLocalInterfacePreference:0];
          }

          else
          {
            v43 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
            {
              *v53 = 0;
              _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!", v53, 2u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: no interface available to connect!");
                }
              }
            }
          }

          [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:pairCopy];
        }
      }
    }

    else
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = _IDSLinkStateStrings[self->_state];
        sessionInfoDict5 = [cardsCopy sessionInfoDict];
        *buf = 134218498;
        *&buf[4] = pairCopy;
        *&buf[12] = 2080;
        *&buf[14] = v17;
        *&buf[22] = 2048;
        *&buf[24] = sessionInfoDict5;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v19 = _IDSLinkStateStrings[self->_state];
          [cardsCopy sessionInfoDict];
          v49 = v47 = v19;
          v44 = pairCopy;
          _IDSLogTransport(@"GL", @"IDS", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");

          if (_IDSShouldLog())
          {
            v20 = _IDSLinkStateStrings[self->_state];
            [cardsCopy sessionInfoDict];
            v49 = v47 = v20;
            v44 = pairCopy;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
          }
        }
      }

      [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0, v44, v47, v49];
    }
  }

  else
  {
    v21 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimerWithTransportScoreCards: invalid candidatePair!");
        }
      }
    }
  }
}

- (BOOL)_findTriedCandidatePairForSession:(id)session wantOnlyCell:(BOOL)cell wantOnlyNonCell:(BOOL)nonCell
{
  nonCellCopy = nonCell;
  cellCopy = cell;
  v28 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  if (cellCopy == nonCellCopy)
  {
    v21 = 0;
  }

  else
  {
    v25 = 0u;
    v26 = 0u;
    v23 = 0u;
    v24 = 0u;
    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v10 = [allValues countByEnumeratingWithState:&v23 objects:v27 count:16];
    if (v10)
    {
      v11 = v10;
      v12 = *v24;
      while (2)
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v24 != v12)
          {
            objc_enumerationMutation(allValues);
          }

          v14 = *(*(&v23 + 1) + 8 * i);
          if ([v14 isRelayStunCandidatePair])
          {
            sessionID = [v14 sessionID];
            v16 = [sessionID isEqual:sessionCopy];

            if (v16)
            {
              if ([v14 state] && objc_msgSend(v14, "state") <= 4)
              {
                if (cellCopy && ([v14 local], v17 = objc_claimAutoreleasedReturnValue(), v18 = objc_msgSend(v17, "isCellularStunCandidate"), v17, (v18 & 1) != 0) || nonCellCopy && (objc_msgSend(v14, "local"), v19 = objc_claimAutoreleasedReturnValue(), v20 = objc_msgSend(v19, "isCellularStunCandidate"), v19, !v20))
                {
                  v21 = 1;
                  goto LABEL_20;
                }
              }
            }
          }
        }

        v11 = [allValues countByEnumeratingWithState:&v23 objects:v27 count:16];
        if (v11)
        {
          continue;
        }

        break;
      }
    }

    v21 = 0;
LABEL_20:
  }

  return v21;
}

- (void)_stopAllocbindFailoverTimer:(id)timer
{
  v51 = *MEMORY[0x1E69E9840];
  timerCopy = timer;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  if (timerCopy)
  {
    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v4 = allValues;
    v5 = [v4 countByEnumeratingWithState:&v37 objects:v49 count:16];
    if (v5)
    {
      v6 = *v38;
      while (2)
      {
        for (i = 0; i != v5; ++i)
        {
          if (*v38 != v6)
          {
            objc_enumerationMutation(v4);
          }

          v8 = *(*(&v37 + 1) + 8 * i);
          allocbindFailoverTimer = [v8 allocbindFailoverTimer];
          v10 = allocbindFailoverTimer == timerCopy;

          if (v10)
          {
            allocbindFailoverTimer2 = [v8 allocbindFailoverTimer];
            dispatch_source_cancel(allocbindFailoverTimer2);

            v12 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
            {
              v13 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
              *buf = 134218240;
              v46 = timerCopy;
              v47 = 2048;
              v48 = v13;
              _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu", buf, 0x16u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                allocbindFailoverTimer5 = timerCopy;
                v34 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
                _IDSLogTransport(@"GL", @"IDS", @"stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu");
                if (_IDSShouldLog())
                {
                  v14 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:timerCopy];
                  allocbindFailoverTimer5 = timerCopy;
                  v34 = v14;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"stop specified allocbind failover timer %p, _tokenToCandidatePairs: %lu");
                }
              }
            }

            [v8 setAllocbindFailoverTimer:{0, allocbindFailoverTimer5, v34}];
            sessionID = [v8 sessionID];
            if (sessionID)
            {
              v16 = self->_connectingCandidatePairSessionInfo == 0;

              if (!v16)
              {
                connectingCandidatePairSessionInfo = self->_connectingCandidatePairSessionInfo;
                sessionID2 = [v8 sessionID];
                CFDictionaryRemoveValue(connectingCandidatePairSessionInfo, sessionID2);
              }
            }

            goto LABEL_43;
          }
        }

        v5 = [v4 countByEnumeratingWithState:&v37 objects:v49 count:16];
        if (v5)
        {
          continue;
        }

        break;
      }
    }
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v46 = [allValues count];
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "stop all active allocbind failover timer. # candidatePairs = %lu", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        allocbindFailoverTimer5 = [allValues count];
        _IDSLogTransport(@"GL", @"IDS", @"stop all active allocbind failover timer. # candidatePairs = %lu");
        if (_IDSShouldLog())
        {
          allocbindFailoverTimer5 = [allValues count];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"stop all active allocbind failover timer. # candidatePairs = %lu");
        }
      }
    }

    v43 = 0u;
    v44 = 0u;
    v41 = 0u;
    v42 = 0u;
    v20 = allValues;
    v21 = [v20 countByEnumeratingWithState:&v41 objects:v50 count:16];
    if (v21)
    {
      v22 = *v42;
      do
      {
        for (j = 0; j != v21; ++j)
        {
          if (*v42 != v22)
          {
            objc_enumerationMutation(v20);
          }

          v24 = *(*(&v41 + 1) + 8 * j);
          allocbindFailoverTimer3 = [v24 allocbindFailoverTimer];

          if (allocbindFailoverTimer3)
          {
            v26 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
            {
              allocbindFailoverTimer4 = [v24 allocbindFailoverTimer];
              *buf = 134217984;
              v46 = allocbindFailoverTimer4;
              _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "stop allocbind failover timer: %p", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                allocbindFailoverTimer5 = [v24 allocbindFailoverTimer];
                _IDSLogTransport(@"GL", @"IDS", @"stop allocbind failover timer: %p");

                if (_IDSShouldLog())
                {
                  allocbindFailoverTimer5 = [v24 allocbindFailoverTimer];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"stop allocbind failover timer: %p");
                }
              }
            }

            allocbindFailoverTimer6 = [v24 allocbindFailoverTimer];
            dispatch_source_cancel(allocbindFailoverTimer6);

            [v24 setAllocbindFailoverTimer:0];
            sessionID3 = [v24 sessionID];
            if (sessionID3)
            {
              v30 = self->_connectingCandidatePairSessionInfo == 0;

              if (!v30)
              {
                v31 = self->_connectingCandidatePairSessionInfo;
                sessionID4 = [v24 sessionID];
                CFDictionaryRemoveValue(v31, sessionID4);
              }
            }
          }
        }

        v21 = [v20 countByEnumeratingWithState:&v41 objects:v50 count:16];
      }

      while (v21);
    }
  }

LABEL_43:
}

- (void)_handleAllocbindFailoverTimer:(id)timer failoverTimerOnCandidatePair:(id)pair onInterface:(int)interface
{
  v5 = *&interface;
  v60 = *MEMORY[0x1E69E9840];
  timerCopy = timer;
  pairCopy = pair;
  v9 = objc_alloc_init(IDSQuickRelaySessionInfo);
  v44 = v9;
  if ([(IDSQuickRelaySessionInfo *)v9 parseSessionInfo:timerCopy])
  {
    p_state = &self->_state;
LABEL_3:
    v11 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = _IDSLinkStateStrings[*p_state];
      *buf = 134218498;
      v57 = pairCopy;
      v58 = 2080;
      *v59 = v12;
      *&v59[8] = 2048;
      *&v59[10] = timerCopy;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v40 = _IDSLinkStateStrings[*p_state];
        v41 = timerCopy;
        v39 = pairCopy;
        _IDSLogTransport(@"GL", @"IDS", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
        if (_IDSShouldLog())
        {
          v40 = _IDSLinkStateStrings[*p_state];
          v41 = timerCopy;
          v39 = pairCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Return: handling allocbind failover timer %p, _state = %s, relaySessionInfo = %p");
        }
      }
    }

    [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:0, v39, v40, v41];
    goto LABEL_10;
  }

  relaySessionID = [(IDSQuickRelaySessionInfo *)v9 relaySessionID];
  v14 = [(IDSGlobalLink *)self _findTriedCandidatePairForSession:relaySessionID wantOnlyCell:v5 == 1 wantOnlyNonCell:v5 == 2];

  p_state = &self->_state;
  if (self->_state > 3 || v14)
  {
    goto LABEL_3;
  }

  v15 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
    v17 = [(NSMutableArray *)self->_interfaceAddressArray count];
    *buf = 134218752;
    v57 = pairCopy;
    v58 = 2048;
    *v59 = v16;
    *&v59[8] = 1024;
    *&v59[10] = v5;
    *&v59[14] = 2048;
    *&v59[16] = v17;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v18 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v41 = v5;
      v42 = [(NSMutableArray *)self->_interfaceAddressArray count];
      v39 = pairCopy;
      v40 = v18;
      _IDSLogTransport(@"GL", @"IDS", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
      if (_IDSShouldLog())
      {
        v19 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:pairCopy];
        v41 = v5;
        v42 = [(NSMutableArray *)self->_interfaceAddressArray count];
        v39 = pairCopy;
        v40 = v19;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"handling allocbind failover timer: %p, _tokenToCandidatePairs: %lu, on interface: %d, [_interfaceAddressArray count] : %lu");
      }
    }
  }

  v20 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
  v43 = v20;
  if (!v20)
  {
    goto LABEL_71;
  }

  if (![v20 count])
  {
    v36 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "Device does not have a second interface to retry", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Device does not have a second interface to retry");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Device does not have a second interface to retry");
        }
      }
    }

    goto LABEL_70;
  }

  v52 = 0u;
  v53 = 0u;
  v50 = 0u;
  v51 = 0u;
  v21 = v43;
  v22 = [v21 countByEnumeratingWithState:&v50 objects:v55 count:16];
  if (v22)
  {
    v23 = *v51;
    while (2)
    {
      for (i = 0; i != v22; ++i)
      {
        if (*v51 != v23)
        {
          objc_enumerationMutation(v21);
        }

        v25 = *(*(&v50 + 1) + 8 * i);
        address = [v25 address];
        v27 = *([address sa] + 1);

        if (v27 == 2)
        {
          if (v5 == 1)
          {
            if ([v25 isCellular])
            {
              goto LABEL_35;
            }
          }

          else if (v5 != 2 || ![v25 isCellular])
          {
LABEL_35:
            v28 = v25;

            if (v28)
            {
              goto LABEL_57;
            }

            goto LABEL_36;
          }
        }
      }

      v22 = [v21 countByEnumeratingWithState:&v50 objects:v55 count:16];
      if (v22)
      {
        continue;
      }

      break;
    }
  }

LABEL_36:
  v48 = 0u;
  v49 = 0u;
  v46 = 0u;
  v47 = 0u;
  v29 = v21;
  v30 = [v29 countByEnumeratingWithState:&v46 objects:v54 count:16];
  if (!v30)
  {
LABEL_49:

LABEL_64:
    v38 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v57) = v5;
      _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "Device does not have interface type: %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v39 = v5;
        _IDSLogTransport(@"GL", @"IDS", @"Device does not have interface type: %d");
        if (_IDSShouldLog())
        {
          v39 = v5;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Device does not have interface type: %d");
        }
      }
    }

    goto LABEL_70;
  }

  v31 = *v47;
LABEL_38:
  v32 = 0;
  while (1)
  {
    if (*v47 != v31)
    {
      objc_enumerationMutation(v29);
    }

    v33 = *(*(&v46 + 1) + 8 * v32);
    address2 = [v33 address];
    v35 = *([address2 sa] + 1);

    if (v35 != 30)
    {
      goto LABEL_47;
    }

    if (v5 != 1)
    {
      break;
    }

    if ([v33 isCellular])
    {
      goto LABEL_56;
    }

LABEL_47:
    if (v30 == ++v32)
    {
      v30 = [v29 countByEnumeratingWithState:&v46 objects:v54 count:16];
      if (v30)
      {
        goto LABEL_38;
      }

      goto LABEL_49;
    }
  }

  if (v5 == 2 && [v33 isCellular])
  {
    goto LABEL_47;
  }

LABEL_56:
  v28 = v33;

  if (!v28)
  {
    goto LABEL_64;
  }

LABEL_57:
  v37 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v57 = pairCopy;
    v58 = 1024;
    *v59 = v5;
    *&v59[4] = 2112;
    *&v59[6] = v28;
    _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v40 = v5;
      v41 = v28;
      v39 = pairCopy;
      _IDSLogTransport(@"GL", @"IDS", @"_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@");
      if (_IDSShouldLog())
      {
        v40 = v5;
        v41 = v28;
        v39 = pairCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_handleAllocbindFailoverTimer: %p, interface: %u, newLocalAddress: %@");
      }
    }
  }

  [(IDSGlobalLink *)self _connectWithSessionInfo:timerCopy interfaceAddress:v28 joinSession:1 allocbindFailover:1 completionHandler:self->_connectReadyHandler withLocalInterfacePreference:0, v39, v40, v41];

LABEL_70:
  [(IDSGlobalLink *)self _stopAllocbindFailoverTimer:pairCopy, v39];
  v20 = v43;
LABEL_71:

LABEL_10:
}

- (BOOL)_isExtIPDiscoveryDone
{
  v23 = *MEMORY[0x1E69E9840];
  if (self->_hasPendingSelfAllocation)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      v4 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
      *buf = 67109120;
      LODWORD(v21) = v4;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v14 = [(NSMutableArray *)self->_selfAllocateRequestIDs count];
        _IDSLogTransport(@"GL", @"IDS", @"_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u");
        if (_IDSShouldLog())
        {
          [(NSMutableArray *)self->_selfAllocateRequestIDs count];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_isExtIPDiscoveryDone: _hasPendingSelfAllocation, count = %u");
        }
      }
    }

    return 0;
  }

  else
  {
    [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v18 = 0u;
    v19 = 0u;
    v16 = 0u;
    v6 = v17 = 0u;
    v7 = [v6 countByEnumeratingWithState:&v16 objects:v22 count:16];
    if (v7)
    {
      v8 = *v17;
      while (2)
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v17 != v8)
          {
            objc_enumerationMutation(v6);
          }

          v10 = *(*(&v16 + 1) + 8 * i);
          if ([v10 allocateType] == 2 && objc_msgSend(v10, "state") <= 1)
          {
            v11 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
            {
              state = [v10 state];
              *buf = 134217984;
              v21 = state;
              _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "[candidatePair state] = %lu", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                state2 = [v10 state];
                _IDSLogTransport(@"GL", @"IDS", @"[candidatePair state] = %lu");
                if (_IDSShouldLog())
                {
                  [v10 state];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"[candidatePair state] = %lu");
                }
              }
            }

            v5 = 0;
            goto LABEL_26;
          }
        }

        v7 = [v6 countByEnumeratingWithState:&v16 objects:v22 count:16];
        if (v7)
        {
          continue;
        }

        break;
      }
    }

    v5 = 1;
LABEL_26:
  }

  return v5;
}

- (void)_handleSelfAllocationTimeout:(id)timeout
{
  v9 = *MEMORY[0x1E69E9840];
  timeoutCopy = timeout;
  if ([(NSMutableArray *)self->_selfAllocateRequestIDs containsObject:timeoutCopy])
  {
    v5 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v8 = timeoutCopy;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "self allocation request %@ timed out.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v6 = timeoutCopy;
        _IDSLogTransport(@"GL", @"IDS", @"self allocation request %@ timed out.");
        if (_IDSShouldLog())
        {
          v6 = timeoutCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"self allocation request %@ timed out.");
        }
      }
    }

    [(NSMutableArray *)self->_selfAllocateRequestIDs removeObject:timeoutCopy, v6];
    if (![(NSMutableArray *)self->_selfAllocateRequestIDs count])
    {
      self->_hasPendingSelfAllocation = 0;
      [(IDSGlobalLink *)self _discardSelfAllocateCandidatePairs];
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
  }
}

- (void)_processXORMappedAddress:(id)address arrivalTime:(double)time
{
  v56 = *MEMORY[0x1E69E9840];
  addressCopy = address;
  *&v6 = 0xAAAAAAAAAAAAAAAALL;
  *(&v6 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v54 = v6;
  v55 = v6;
  v52 = v6;
  v53 = v6;
  v50 = v6;
  v51 = v6;
  *__str = v6;
  v49 = v6;
  v46 = v6;
  v47 = v6;
  v44 = v6;
  v45 = v6;
  v42 = v6;
  v43 = v6;
  *v40 = v6;
  v41 = v6;
  local = [addressCopy local];
  address = [local address];

  local2 = [addressCopy local];
  external = [local2 external];

  SAToIPPortString(__str, 0x80uLL, address);
  SAToIPPortString(v40, 0x80uLL, external);
  v10 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 136315394;
    *v39 = v40;
    *&v39[8] = 2080;
    *&v39[10] = __str;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "discover external address on [%s] on [%s].", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v32 = v40;
      v34 = __str;
      _IDSLogTransport(@"GL", @"IDS", @"discover external address on [%s] on [%s].");
      if (_IDSShouldLog())
      {
        v32 = v40;
        v34 = __str;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"discover external address on [%s] on [%s].");
      }
    }
  }

  local3 = [addressCopy local];
  radioAccessTechnology = [local3 radioAccessTechnology];
  local4 = [addressCopy local];
  v14 = [local4 mtu];
  local5 = [addressCopy local];
  index = [local5 index];
  local6 = [addressCopy local];
  v18 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 1, 1, radioAccessTechnology, v14, index, [local6 address], external);

  local7 = [addressCopy local];
  [v18 setLinkFlags:{objc_msgSend(local7, "linkFlags")}];

  allocateType = [addressCopy allocateType];
  v21 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    allocateType2 = [addressCopy allocateType];
    *buf = 67109376;
    *v39 = allocateType == 2;
    *&v39[4] = 2048;
    *&v39[6] = allocateType2;
    _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "isSelfAllocate: %d, [candidatePair allocateType]: %ld", buf, 0x12u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v33 = (allocateType == 2);
      allocateType3 = [addressCopy allocateType];
      _IDSLogTransport(@"GL", @"IDS", @"isSelfAllocate: %d, [candidatePair allocateType]: %ld");
      if (_IDSShouldLog())
      {
        allocateType4 = [addressCopy allocateType];
        v33 = (allocateType == 2);
        allocateType3 = allocateType4;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"isSelfAllocate: %d, [candidatePair allocateType]: %ld");
      }
    }
  }

  if (allocateType == 2)
  {
    [addressCopy selfAllocateStartTime];
    v25 = ((time - v24) * 1000.0);
    GLUtilReportAWDClientTimerEvent(308, 0, addressCopy, self->_enableSKE, self->_isInitiator, v25);
    [(IDSGlobalLink *)self _reportAWDAllocateTime];
    v26 = GLUCreateQRClientTimeEvent(308, 0, addressCopy, self->_timeBase, v25);
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v28 = objc_opt_respondsToSelector();

    if (v28)
    {
      v29 = objc_loadWeakRetained(&self->_delegate);
      [v29 link:self didAddQREvent:v26];
    }
  }

  if (*(address + 1) == *(external + 1))
  {
    if ([(IDSGlobalLink *)self _addCandidate:v18 isRemoteCandidate:0])
    {
      [(IDSGlobalLink *)self _addStunCheckPair:v18 isRemoteCandidate:0];
    }

    else
    {
      v31 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315138;
        *v39 = v40;
        _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "external address [%s] already exists, do not add stun check pairs", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v33 = v40;
          _IDSLogTransport(@"GL", @"IDS", @"external address [%s] already exists, do not add stun check pairs");
          if (_IDSShouldLog())
          {
            v33 = v40;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"external address [%s] already exists, do not add stun check pairs");
          }
        }
      }
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0, v33, allocateType3];
  }

  else
  {
    v30 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "local and external addresses have mismatched family, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"local and external addresses have mismatched family, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"local and external addresses have mismatched family, ignore.");
        }
      }
    }
  }
}

- (BOOL)_IsExtIPDiscoveryNeeded:(sockaddr *)needed candidatePairList:(id)list
{
  v20 = *MEMORY[0x1E69E9840];
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  listCopy = list;
  v6 = [listCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v16;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v16 != v8)
        {
          objc_enumerationMutation(listCopy);
        }

        v10 = *(*(&v15 + 1) + 8 * i);
        if ([v10 isRelayStunCandidatePair])
        {
          local = [v10 local];
          address = [local address];

          if (IsSameSA(address, needed))
          {
            v13 = 0;
            goto LABEL_12;
          }
        }
      }

      v7 = [listCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v13 = 1;
LABEL_12:

  return v13;
}

- (void)_sendAllocbindRequestForExtIP:(id)p startTime:(double)time
{
  v44 = *MEMORY[0x1E69E9840];
  pCopy = p;
  v33 = +[IDSStunCandidate candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:](IDSStunCandidate, "candidateWithType:transport:radioAccessTechnology:mtu:index:address:external:", 3, 1, 10, 1400, 0xFFFFFFFFLL, 0, [pCopy serverAddress]);
  v39 = 0u;
  v40 = 0u;
  v37 = 0u;
  v38 = 0u;
  obj = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v37 objects:v43 count:16];
  if (v5)
  {
    v6 = *v38;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v38 != v6)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v37 + 1) + 8 * i);
        index = [v8 index];
        address = [v8 address];
        v11 = [address sa];

        v12 = IsLinkLocalSA(v11);
        iPVersion = [v8 IPVersion];
        if ([v8 isCellular])
        {
          v14 = +[IDSCellularLinkMonitor sharedInstance];
          radioAccessTechnology = [v14 radioAccessTechnology];
        }

        else if ([v8 isWired])
        {
          radioAccessTechnology = 9;
        }

        else
        {
          radioAccessTechnology = 0;
        }

        if (v11)
        {
          v16 = index < 1;
        }

        else
        {
          v16 = 1;
        }

        v17 = v16;
        if (((v17 | v12) & 1) == 0 && iPVersion != 1 && ([v8 isCompanionLink] & 1) == 0)
        {
          allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          v19 = [(IDSGlobalLink *)self _IsExtIPDiscoveryNeeded:v11 candidatePairList:allValues];

          if (v19)
          {
            v20 = [IDSStunCandidate candidateWithType:3 transport:1 radioAccessTechnology:radioAccessTechnology mtu:1450 index:index address:v11 external:v11];
            serverAddress = [pCopy serverAddress];
            relaySessionID = [pCopy relaySessionID];
            v23 = tokenForStunCandidatePair(v11, serverAddress, relaySessionID);

            relaySessionID2 = [pCopy relaySessionID];
            v25 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v20 remoteCandidate:v33 sessionID:relaySessionID2 delegate:self];

            v26 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v42 = pCopy;
              _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v31 = pCopy;
                _IDSLogTransport(@"GL", @"IDS", @"_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@");
                if (_IDSShouldLog())
                {
                  v31 = pCopy;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendAllocbindRequestForExtIP: setPropertiesWithRelaySessionInfo: qrSessionInfo: %@");
                }
              }
            }

            [v25 setPropertiesWithRelaySessionInfo:pCopy sessionInfoDict:0 enableSKE:{self->_enableSKE, v31}];
            [v25 setSelfAllocateStartTime:time];
            if (!self->_tokenToCandidatePairs)
            {
              Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              self->_tokenToCandidatePairs = Mutable;
            }

            v29 = v25;
            if (v29)
            {
              CFDictionarySetValue(self->_tokenToCandidatePairs, v23, v29);
            }

            else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
            {
              sub_1A7E1498C();
            }

            v30 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v42 = v23;
              _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "start extIP discovery for %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v32 = v23;
                _IDSLogTransport(@"GL", @"IDS", @"start extIP discovery for %@.");
                if (_IDSShouldLog())
                {
                  v32 = v23;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"start extIP discovery for %@.");
                }
              }
            }

            [(IDSGlobalLink *)self sendAllocbindRequest:v29 isRealloc:0 inResponseToNoSessionState:0 reconnectQUIC:0, v32];

            goto LABEL_43;
          }
        }
      }

      v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v37 objects:v43 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

LABEL_43:
}

- (BOOL)_requestSelfAllocationForInterfaceAddress:(id)address
{
  v19 = *MEMORY[0x1E69E9840];
  addressCopy = address;
  address = [addressCopy address];
  v6 = [address sa];

  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = [(IDSGlobalLink *)self _IsExtIPDiscoveryNeeded:v6 candidatePairList:allValues];

  if (v8)
  {
    if (!self->_hasPendingSelfAllocation)
    {
      self->_hasPendingSelfAllocation = 1;
    }

    v9 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BA0650;
    block[3] = &unk_1E77E0C88;
    block[4] = self;
    v16 = addressCopy;
    dispatch_async(v9, block);
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      address2 = [addressCopy address];
      *buf = 138412290;
      v18 = address2;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "no need to request self allocation for [%@].", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        address3 = [addressCopy address];
        _IDSLogTransport(@"GL", @"IDS", @"no need to request self allocation for [%@].");

        if (_IDSShouldLog())
        {
          address4 = [addressCopy address];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no need to request self allocation for [%@].");
        }
      }
    }
  }

  return v8;
}

- (void)_startExtIPDiscovery
{
  v47 = *MEMORY[0x1E69E9840];
  v2 = self->_useLinkEngine && self->_useLinkSelection && self->_linkSelectionStrategy != 0;
  if (self->_allowP2P || v2)
  {
    v4 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "== start external IP discovery for all interfaces ==", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"== start external IP discovery for all interfaces ==");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"== start external IP discovery for all interfaces ==");
        }
      }
    }

    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    obj = self->_interfaceAddressArray;
    v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v39 objects:v46 count:16];
    if (v5)
    {
      v31 = 0;
      v33 = *v40;
      do
      {
        for (i = 0; i != v5; ++i)
        {
          if (*v40 != v33)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v39 + 1) + 8 * i);
          index = [v7 index];
          address = [v7 address];
          v10 = [address sa];

          v11 = IsLinkLocalSA(v10);
          iPVersion = [v7 IPVersion];
          isCompanionLink = [v7 isCompanionLink];
          if ([v7 isCellular])
          {
            v14 = +[IDSCellularLinkMonitor sharedInstance];
            radioAccessTechnology = [v14 radioAccessTechnology];
          }

          else if ([v7 isWired])
          {
            radioAccessTechnology = 9;
          }

          else
          {
            radioAccessTechnology = 0;
          }

          if (*(v10 + 1) == 30)
          {
            v16 = 6;
          }

          else
          {
            v16 = 5;
          }

          LocalMTU = GLUtilGetLocalMTU(v16, [v7 isCellular]);
          if (v10)
          {
            v18 = index < 1;
          }

          else
          {
            v18 = 1;
          }

          v19 = v18;
          if (((v19 | v11 | isCompanionLink) & 1) == 0)
          {
            v20 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:radioAccessTechnology mtu:LocalMTU index:index address:v10 external:v10];
            if ([(IDSGlobalLink *)self _addCandidate:v20 isRemoteCandidate:0])
            {
              [(IDSGlobalLink *)self _addStunCheckPair:v20 isRemoteCandidate:0];
            }

            if (iPVersion != 1)
            {
              v21 = v31;
              if (!v31)
              {
                v21 = objc_alloc_init(MEMORY[0x1E695DF70]);
              }

              v31 = v21;
              if (v7 && v21)
              {
                CFArrayAppendValue(v21, v7);
              }
            }
          }
        }

        v5 = [(NSMutableArray *)obj countByEnumeratingWithState:&v39 objects:v46 count:16];
      }

      while (v5);
    }

    else
    {
      v31 = 0;
    }

    if ([(__CFArray *)v31 count])
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v45 = v31;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "need external IP discovery for interfaces:%@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v30 = v31;
          _IDSLogTransport(@"GL", @"IDS", @"need external IP discovery for interfaces:%@");
          if (_IDSShouldLog())
          {
            v30 = v31;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"need external IP discovery for interfaces:%@");
          }
        }
      }

      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v23 = v31;
      v24 = [(__CFArray *)v23 countByEnumeratingWithState:&v35 objects:v43 count:16];
      if (v24)
      {
        v25 = *v36;
        do
        {
          for (j = 0; j != v24; ++j)
          {
            if (*v36 != v25)
            {
              objc_enumerationMutation(v23);
            }

            [(IDSGlobalLink *)self _requestSelfAllocationForInterfaceAddress:*(*(&v35 + 1) + 8 * j), v30];
          }

          v24 = [(__CFArray *)v23 countByEnumeratingWithState:&v35 objects:v43 count:16];
        }

        while (v24);
      }
    }

    if (!self->_hasPendingSelfAllocation || (v27 = [(__CFArray *)v31 count], v28 = v31, !v27))
    {
      v29 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "external IP discovery is not needed, send connection data.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"external IP discovery is not needed, send connection data.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"external IP discovery is not needed, send connection data.");
          }
        }
      }

      [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0, v30];
      v28 = v31;
    }
  }

  else
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "skip external IP discovery because P2P is not allowed.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip external IP discovery because P2P is not allowed.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip external IP discovery because P2P is not allowed.");
      }
    }
  }
}

- (void)_processRemoteCandidates:(id)candidates
{
  v80 = *MEMORY[0x1E69E9840];
  candidatesCopy = candidates;
  v40 = candidatesCopy;
  if ([candidatesCopy count])
  {
    v70 = 0u;
    v71 = 0u;
    v68 = 0u;
    v69 = 0u;
    obj = candidatesCopy;
    v4 = [obj countByEnumeratingWithState:&v68 objects:v77 count:16];
    if (v4)
    {
      v44 = 0;
      v5 = *v69;
      do
      {
        for (i = 0; i != v4; ++i)
        {
          if (*v69 != v5)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v68 + 1) + 8 * i);
          if (([(NSMutableArray *)self->_remoteCandidateList containsObject:v7]& 1) == 0)
          {
            v8 = v44;
            if (!v44)
            {
              v8 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v7)
            {
              v9 = v8 == 0;
            }

            else
            {
              v9 = 1;
            }

            v44 = v8;
            if (!v9)
            {
              CFArrayAppendValue(v8, v7);
            }
          }
        }

        v4 = [obj countByEnumeratingWithState:&v68 objects:v77 count:16];
      }

      while (v4);
    }

    else
    {
      v44 = 0;
    }

    if ([(__CFArray *)v44 count])
    {
      [(IDSGlobalLink *)self _processNewRemoteCandidates:v44];
    }

    v66 = 0u;
    v67 = 0u;
    v64 = 0u;
    v65 = 0u;
    v41 = self->_remoteCandidateList;
    v11 = [(NSMutableArray *)v41 countByEnumeratingWithState:&v64 objects:v76 count:16];
    v12 = 0;
    if (v11)
    {
      v42 = *v65;
      do
      {
        for (j = 0; j != v11; ++j)
        {
          if (*v65 != v42)
          {
            objc_enumerationMutation(v41);
          }

          v14 = *(*(&v64 + 1) + 8 * j);
          v60 = 0u;
          v61 = 0u;
          v62 = 0u;
          v63 = 0u;
          v15 = obj;
          v16 = [v15 countByEnumeratingWithState:&v60 objects:v75 count:16];
          if (v16)
          {
            v17 = *v61;
            while (2)
            {
              for (k = 0; k != v16; ++k)
              {
                if (*v61 != v17)
                {
                  objc_enumerationMutation(v15);
                }

                if (IsSameIP([v14 address], objc_msgSend(*(*(&v60 + 1) + 8 * k), "address")))
                {

                  goto LABEL_52;
                }
              }

              v16 = [v15 countByEnumeratingWithState:&v60 objects:v75 count:16];
              if (v16)
              {
                continue;
              }

              break;
            }
          }

          if (v12 || (v12 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
          {
            if (v14)
            {
              CFArrayAppendValue(v12, v14);
            }
          }

          v19 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v79 = v14;
            _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "Try to remove remote candidate %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v39 = v14;
              _IDSLogTransport(@"GL", @"IDS", @"Try to remove remote candidate %@.");
              if (_IDSShouldLog())
              {
                v39 = v14;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Try to remove remote candidate %@.");
              }
            }
          }

LABEL_52:
          ;
        }

        v11 = [(NSMutableArray *)v41 countByEnumeratingWithState:&v64 objects:v76 count:16];
      }

      while (v11);
    }

    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    obja = v12;
    v20 = 0;
    v21 = [(__CFArray *)obja countByEnumeratingWithState:&v56 objects:v74 count:16];
    if (v21)
    {
      v22 = *v57;
      do
      {
        for (m = 0; m != v21; ++m)
        {
          if (*v57 != v22)
          {
            objc_enumerationMutation(obja);
          }

          v24 = *(*(&v56 + 1) + 8 * m);
          if ([v24 type] == 2)
          {
            if (!v20)
            {
              v20 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v24)
            {
              v25 = v20 == 0;
            }

            else
            {
              v25 = 1;
            }

            if (!v25)
            {
              CFArrayAppendValue(v20, v24);
            }
          }
        }

        v21 = [(__CFArray *)obja countByEnumeratingWithState:&v56 objects:v74 count:16];
      }

      while (v21);
    }

    v54 = 0u;
    v55 = 0u;
    v52 = 0u;
    v53 = 0u;
    v43 = v20;
    v26 = [(__CFArray *)v43 countByEnumeratingWithState:&v52 objects:v73 count:16];
    if (v26)
    {
      v27 = *v53;
      do
      {
        for (n = 0; n != v26; ++n)
        {
          if (*v53 != v27)
          {
            objc_enumerationMutation(v43);
          }

          v29 = *(*(&v52 + 1) + 8 * n);
          allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          v50 = 0u;
          v51 = 0u;
          v48 = 0u;
          v49 = 0u;
          v31 = allValues;
          v32 = [v31 countByEnumeratingWithState:&v48 objects:v72 count:16];
          if (v32)
          {
            v33 = *v49;
            while (2)
            {
              for (ii = 0; ii != v32; ++ii)
              {
                if (*v49 != v33)
                {
                  objc_enumerationMutation(v31);
                }

                v35 = *(*(&v48 + 1) + 8 * ii);
                if ([v35 state] == 3)
                {
                  remote = [v35 remote];
                  v37 = IsSameSA([remote external], objc_msgSend(v29, "external"));

                  if (v37)
                  {

                    goto LABEL_90;
                  }
                }
              }

              v32 = [v31 countByEnumeratingWithState:&v48 objects:v72 count:16];
              if (v32)
              {
                continue;
              }

              break;
            }
          }

          [(__CFArray *)obja removeObject:v29];
          v38 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v79 = v29;
            _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "Add back removed PRLX remote candidate %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v39 = v29;
              _IDSLogTransport(@"GL", @"IDS", @"Add back removed PRLX remote candidate %@");
              if (_IDSShouldLog())
              {
                v39 = v29;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Add back removed PRLX remote candidate %@");
              }
            }
          }

LABEL_90:
        }

        v26 = [(__CFArray *)v43 countByEnumeratingWithState:&v52 objects:v73 count:16];
      }

      while (v26);
    }

    [(IDSGlobalLink *)self _processRemovedRemoteCandidates:obja];
  }

  else
  {
    v10 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v79 = v40;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "invalid remote candidate list %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"invalid remote candidate list %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"invalid remote candidate list %@.");
        }
      }
    }
  }
}

- (void)_updateNominatedCandidatePair:(id)pair
{
  v30 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v23 = 0u;
  v6 = [allValues countByEnumeratingWithState:&v22 objects:v29 count:16];
  if (v6)
  {
    v7 = *v23;
    do
    {
      v8 = 0;
      do
      {
        if (*v23 != v7)
        {
          objc_enumerationMutation(allValues);
        }

        [*(*(&v22 + 1) + 8 * v8++) setIsNominated:0];
      }

      while (v6 != v8);
      v6 = [allValues countByEnumeratingWithState:&v22 objects:v29 count:16];
    }

    while (v6);
  }

  allValues2 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];

  v20 = 0u;
  v21 = 0u;
  v18 = 0u;
  v19 = 0u;
  v10 = allValues2;
  v11 = [v10 countByEnumeratingWithState:&v18 objects:v28 count:16];
  if (v11)
  {
    v12 = *v19;
    do
    {
      v13 = 0;
      do
      {
        if (*v19 != v12)
        {
          objc_enumerationMutation(v10);
        }

        [*(*(&v18 + 1) + 8 * v13++) setIsNominated:0];
      }

      while (v11 != v13);
      v11 = [v10 countByEnumeratingWithState:&v18 objects:v28 count:16];
    }

    while (v11);
  }

  if (!pairCopy || (tokenToCandidatePairs = self->_tokenToCandidatePairs) == 0 || (v15 = CFDictionaryGetValue(tokenToCandidatePairs, pairCopy)) == 0)
  {
    Value = 0;
    if (pairCopy && self->_tokenToStunCheckPairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, pairCopy);
    }

    v15 = Value;
  }

  [v15 setIsNominated:1];
  v17 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v27 = v15;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "set nominated flag for %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"set nominated flag for %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"set nominated flag for %@.");
      }
    }
  }
}

- (void)_nominateCandidatePair:(id)pair
{
  v15 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  if (self->_isInitiator)
  {
    Value = 0;
    if (pairCopy && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, pairCopy);
    }

    v6 = Value;
    if (([v6 isSharedQRSession] & 1) == 0)
    {
      ++self->_nominateCount;
      [(IDSGlobalLink *)self _updateNominatedCandidatePair:pairCopy];
      v7 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
      {
        nominateCount = self->_nominateCount;
        *buf = 67109378;
        v12 = nominateCount;
        v13 = 2112;
        v14 = pairCopy;
        _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "start nomination #%d: %@.", buf, 0x12u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v9 = self->_nominateCount;
          v10 = pairCopy;
          _IDSLogTransport(@"GL", @"IDS", @"start nomination #%d: %@.");
          if (_IDSShouldLog())
          {
            v9 = self->_nominateCount;
            v10 = pairCopy;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"start nomination #%d: %@.");
          }
        }
      }

      [(IDSGlobalLink *)self _sendCommandMessage:5 stunMessage:0 options:0 candidatePairToken:pairCopy, v9, v10];
    }
  }
}

- (void)_sendBindingRequest:(id)request stunMessage:(id)message
{
  v69 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  messageCopy = message;
  if (self->_state < 5)
  {
    if (!requestCopy || (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) == 0 || (v12 = CFDictionaryGetValue(tokenToStunCheckPairs, requestCopy)) == 0)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send bind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send bind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send bind request failed due to invalid candidate pair.");
          }
        }
      }

      if (messageCopy)
      {
        requestID = [(IDSStunMessage *)messageCopy requestID];
        [(IDSGlobalLink *)self _removeStunRequest:requestID];
        requestID4 = 0;
      }

      else
      {
        requestID4 = 0;
      }

      goto LABEL_98;
    }

    requestID4 = v12;
    state = [v12 state];
    if (state >= 3)
    {
      v14 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v15 = (&_IDSStunCandidatePairStateStrings)[state];
        *buf = 138412546;
        *&buf[4] = requestID4;
        *&buf[12] = 2080;
        *&buf[14] = v15;
        _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "skip binding request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip binding request for %@, state [%s].");
      }

      if (messageCopy)
      {
        requestID2 = [(IDSStunMessage *)messageCopy requestID];
        [(IDSGlobalLink *)self _removeStunRequest:requestID2];
      }

      goto LABEL_98;
    }

    local = [requestID4 local];
    v50 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [local index]);

    if (self->_cellInterfaceName)
    {
      local2 = [requestID4 local];
      if ([local2 isCellularStunCandidate])
      {
        v19 = [(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v50];

        if ((v19 & 1) == 0)
        {
          v20 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
          {
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            *&buf[4] = v50;
            *&buf[12] = 2112;
            *&buf[14] = cellInterfaceName;
            _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip binding request on currentInterfaceName", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ skip binding request on currentInterfaceName");
          }

          goto LABEL_97;
        }
      }

      else
      {
      }
    }

    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BA2A48;
    aBlock[3] = &unk_1E77E1090;
    requestID4 = requestID4;
    v62 = requestID4;
    selfCopy = self;
    v65 = state;
    v22 = requestCopy;
    v64 = v22;
    v23 = _Block_copy(aBlock);
    if (messageCopy)
    {
      [(IDSStunMessage *)messageCopy startTime];
      v25 = v24;
      if (ids_monotonic_time() - v24 <= 60.0)
      {
        [requestID4 triggeredCheckTime];
        if (v39 <= v25)
        {
          v23[2](v23, messageCopy);
        }

        else
        {
          v40 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = messageCopy;
            _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "cancel binding request %@ with triggered check", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"cancel binding request %@ with triggered check");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"cancel binding request %@ with triggered check");
              }
            }
          }

          v58[0] = MEMORY[0x1E69E9820];
          v58[1] = 3221225472;
          v58[2] = sub_1A7BA2FC8;
          v58[3] = &unk_1E77E1068;
          v58[4] = self;
          v59 = v22;
          messageCopy = messageCopy;
          v60 = messageCopy;
          v41 = ids_monotonic_time();
          IDSTransportThreadAddBlockAfter(v58, v25 + 60.0 - v41 + 0.1);
        }
      }

      else
      {
        [requestID4 setState:2];
        if (self->_useLinkEngine)
        {
          linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
          linkUniqueName = [requestID4 linkUniqueName];
          v28 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:linkUniqueName];
          LODWORD(linkEngineIDToCandidatePair) = requestID4 == v28;

          if (linkEngineIDToCandidatePair)
          {
            linkEngine = [requestID4 linkEngine];
            linkUniqueName2 = [requestID4 linkUniqueName];
            [linkEngine linkDidFail:linkUniqueName2 errorCode:44 isRecoverable:0 shouldReconnect:0];
          }
        }

        requestID3 = [(IDSStunMessage *)messageCopy requestID];
        [(IDSGlobalLink *)self _removeStunRequest:requestID3];

        v32 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          v33 = (&_IDSStunCandidatePairStateStrings)[state];
          *buf = 138412802;
          *&buf[4] = requestID4;
          *&buf[12] = 2080;
          *&buf[14] = v33;
          v67 = 2080;
          v68 = off_1EB2B43B8;
          _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "binding request %@ timed out, update state (%s->%s).", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"binding request %@ timed out, update state (%s->%s).");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"binding request %@ timed out, update state (%s->%s).");
            }
          }
        }
      }

      goto LABEL_96;
    }

    messageCopy = [[IDSStunMessage alloc] initWithType:1];
    v34 = objc_alloc_init(MEMORY[0x1E695DF90]);
    local3 = [requestID4 local];
    radioAccessTechnology = [local3 radioAccessTechnology];

    if (self->_remoteDeviceVersion <= 2 && radioAccessTechnology == 9)
    {
      v37 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v37, OS_LOG_TYPE_DEFAULT, "RATType Wired -> NonCell due to remote version", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"RATType Wired -> NonCell due to remote version");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"RATType Wired -> NonCell due to remote version");
          }
        }
      }

      radioAccessTechnology = 0;
    }

    v38 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:radioAccessTechnology];
    if (v38)
    {
      CFDictionarySetValue(v34, @"ids-stun-attribute-cellrat", v38);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15A98();
    }

    v42 = self->_controlMessageKey;
    if (v42)
    {
      CFDictionarySetValue(v34, @"ids-stun-attribute-messageintegrity", v42);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E15B20();
    }

    if (self->_isInitiator && (self->_remoteCapabilityFlag & 1) != 0)
    {
      memset(buf, 170, 16);
      linkUUID = [requestID4 linkUUID];
      [linkUUID getUUIDBytes:buf];

      v44 = [MEMORY[0x1E695DEF0] dataWithBytes:buf length:16];
      if (v44)
      {
        CFDictionarySetValue(v34, @"ids-stun-attribute-linkuuid", v44);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15BA8();
      }
    }

    if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
    {
      goto LABEL_86;
    }

    local4 = [requestID4 local];
    if ([local4 isCellularStunCandidate])
    {
      allowTLEOverCellular = self->_allowTLEOverCellular;

      if (!allowTLEOverCellular)
      {
LABEL_86:
        [(IDSStunMessage *)messageCopy setTransactionID:0 attributes:v34];
        [(IDSStunMessage *)messageCopy setStartTime:ids_monotonic_time()];
        v23[2](v23, messageCopy);
LABEL_95:

LABEL_96:
LABEL_97:

        goto LABEL_98;
      }
    }

    else
    {
    }

    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v22;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "getting p2p negotiation for: %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"getting p2p negotiation for: %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"getting p2p negotiation for: %@");
        }
      }
    }

    v51[0] = MEMORY[0x1E69E9820];
    v51[1] = 3221225472;
    v51[2] = sub_1A7BA2FD8;
    v51[3] = &unk_1E77E10B8;
    v52 = v22;
    v53 = requestID4;
    selfCopy2 = self;
    v55 = v34;
    v56 = messageCopy;
    v57 = v23;
    [(IDSGlobalLink *)self _getP2PNegotiationForCandidatePair:v53 completionBlock:v51];

    goto LABEL_95;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    v9 = _IDSLinkStateStrings[self->_state];
    *buf = 136315138;
    *&buf[4] = v9;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "skip bind request, GL state [%s].", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"skip bind request, GL state [%s].");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"skip bind request, GL state [%s].");
      }
    }
  }

  if (messageCopy)
  {
    requestID4 = [(IDSStunMessage *)messageCopy requestID];
    [(IDSGlobalLink *)self _removeStunRequest:requestID4];
LABEL_98:
  }
}

- (BOOL)_shouldUseP2PTLE
{
  v8 = *MEMORY[0x1E69E9840];
  forceP2PTLE = self->_forceP2PTLE;
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = @"NO";
    if (forceP2PTLE)
    {
      v4 = @"YES";
    }

    *buf = 138412290;
    v7 = v4;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_shouldUseP2PTLE: %@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_shouldUseP2PTLE: %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldUseP2PTLE: %@");
      }
    }
  }

  return forceP2PTLE;
}

- (BOOL)_shouldUseQRTLE
{
  v16 = *MEMORY[0x1E69E9840];
  v3 = self->_isTLEEnabled || self->_forceTLE;
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = @"NO";
    if (v3)
    {
      v6 = @"YES";
    }

    else
    {
      v6 = @"NO";
    }

    forceTLE = self->_forceTLE;
    if (self->_isTLEEnabled)
    {
      v8 = @"YES";
    }

    else
    {
      v8 = @"NO";
    }

    *buf = 138412802;
    v11 = v6;
    v12 = 2112;
    if (forceTLE)
    {
      v5 = @"YES";
    }

    v13 = v8;
    v14 = 2112;
    v15 = v5;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_shouldUseQRTLE: %@ (TLE enabled: %@, force: %@)");
      }
    }
  }

  return v3;
}

- (void)_getP2PNegotiationForCandidatePair:(id)pair completionBlock:(id)block
{
  v19 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  blockCopy = block;
  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    p2pNegotiatorProvider = self->_p2pNegotiatorProvider;
    *buf = 138412290;
    v18 = p2pNegotiatorProvider;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "getting p2p negotiator from %@...", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"getting p2p negotiator from %@...");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"getting p2p negotiator from %@...");
      }
    }
  }

  v10 = self->_p2pNegotiatorProvider;
  groupID = self->_groupID;
  v14[0] = MEMORY[0x1E69E9820];
  v14[1] = 3221225472;
  v14[2] = sub_1A7BA38B4;
  v14[3] = &unk_1E77E1108;
  v15 = pairCopy;
  v16 = blockCopy;
  v12 = blockCopy;
  v13 = pairCopy;
  [(IDSGlobalLinkP2PKeyNegotiatorProvider *)v10 negotiatorForGroup:groupID completionHandler:v14];
}

- (void)_processRemoteLinkUUID:(id)d candidatePair:(id)pair
{
  v21 = *MEMORY[0x1E69E9840];
  dCopy = d;
  pairCopy = pair;
  v8 = pairCopy;
  if (self->_isInitiator)
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "receive linkUUID from Receiver, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive linkUUID from Receiver, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive linkUUID from Receiver, ignore.");
        }
      }
    }
  }

  else if (dCopy)
  {
    linkUUID = [pairCopy linkUUID];
    v11 = [dCopy isEqual:linkUUID];

    if ((v11 & 1) == 0)
    {
      [v8 setLinkUUID:dCopy];
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken = [v8 candidatePairToken];
        *buf = 138412546;
        v18 = dCopy;
        v19 = 2112;
        v20 = candidatePairToken;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_processRemoteLinkUUID: update linkUUID %@ for %@.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          candidatePairToken2 = [v8 candidatePairToken];
          _IDSLogTransport(@"GL", @"IDS", @"_processRemoteLinkUUID: update linkUUID %@ for %@.");

          if (_IDSShouldLog())
          {
            candidatePairToken3 = [v8 candidatePairToken];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_processRemoteLinkUUID: update linkUUID %@ for %@.");
          }
        }
      }
    }
  }

  else
  {
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "receive invalid linkUUID, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"receive invalid linkUUID, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive invalid linkUUID, ignore.");
        }
      }
    }
  }
}

- (BOOL)_isCellularInterfaceForCandidatePair:(id)pair localAddress:(sockaddr *)address
{
  v28 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  v7 = pairCopy;
  if (pairCopy)
  {
    local = [pairCopy local];
    if ([local radioAccessTechnology])
    {
      local2 = [v7 local];
      v10 = [local2 radioAccessTechnology] != 9;
    }

    else
    {
      v10 = 0;
    }
  }

  else
  {
    v25 = 0u;
    v26 = 0u;
    v23 = 0u;
    v24 = 0u;
    v11 = self->_interfaceAddressArray;
    v12 = [(NSMutableArray *)v11 countByEnumeratingWithState:&v23 objects:v27 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v24;
      while (2)
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v24 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v23 + 1) + 8 * i);
          address = [v16 address];
          v18 = IsSameSA([address sa], address);

          if (v18 && [v16 isCellular])
          {
            v20 = +[IDSCellularLinkMonitor sharedInstance];
            radioAccessTechnology = [v20 radioAccessTechnology];

            goto LABEL_17;
          }
        }

        v13 = [(NSMutableArray *)v11 countByEnumeratingWithState:&v23 objects:v27 count:16];
        if (v13)
        {
          continue;
        }

        break;
      }
    }

    radioAccessTechnology = 0;
LABEL_17:

    if (radioAccessTechnology)
    {
      v21 = radioAccessTechnology == 9;
    }

    else
    {
      v21 = 1;
    }

    v10 = !v21;
  }

  return v10;
}

- (BOOL)_processBindingRequest:(id)request fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v10 = *&index;
  v171 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  deviceCopy = device;
  key = token;
  *&v13 = 0xAAAAAAAAAAAAAAAALL;
  *(&v13 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v169 = v13;
  v170 = v13;
  v167 = v13;
  v168 = v13;
  v165 = v13;
  v166 = v13;
  *__str = v13;
  v164 = v13;
  v162 = v13;
  v161 = v13;
  v160 = v13;
  v159 = v13;
  v158 = v13;
  v157 = v13;
  v156 = v13;
  *v155 = v13;
  memset(__b, 170, sizeof(__b));
  *&v14 = 0xAAAAAAAAAAAAAAAALL;
  *(&v14 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v153[7] = v14;
  v153[6] = v14;
  v153[5] = v14;
  v153[4] = v14;
  v153[3] = v14;
  v153[2] = v14;
  v153[1] = v14;
  v153[0] = v14;
  v152 = v14;
  v151 = v14;
  v150 = v14;
  v148 = v14;
  v149 = v14;
  v146 = v14;
  v147 = v14;
  v144 = v14;
  v145 = v14;
  v142 = v14;
  v143 = v14;
  v140 = v14;
  v141 = v14;
  v138 = v14;
  v139 = v14;
  v137 = v14;
  __memcpy_chk();
  __memcpy_chk();
  SAToIPPortString(__str, 0x80uLL, &v145);
  SAToIPPortString(v155, 0x80uLL, &v137);
  requestID = [requestCopy requestID];
  v94 = [(IDSGlobalLink *)self _hasStunRequest:requestID];

  if (!v94)
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138413058;
      *&buf[4] = requestCopy;
      *&buf[12] = 2080;
      *&buf[14] = v155;
      *&buf[22] = 2080;
      v134 = __str;
      LOWORD(v135) = 1024;
      *(&v135 + 2) = v10;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "receive binding request %@ from %s on %s(%u)", buf, 0x26u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v85 = __str;
        v86 = v10;
        v84 = v155;
        v80 = requestCopy;
        _IDSLogTransport(@"GL", @"IDS", @"receive binding request %@ from %s on %s(%u)");
        if (_IDSShouldLog())
        {
          v85 = __str;
          v86 = v10;
          v84 = v155;
          v80 = requestCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive binding request %@ from %s on %s(%u)");
        }
      }
    }

    __memcpy_chk();
    Value = 0;
    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x3032000000;
    v134 = sub_1A7BA55D8;
    v135 = sub_1A7BA55E8;
    if (key && self->_tokenToStunCheckPairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, key);
    }

    v136 = Value;
    linkUUID = [*(*&buf[8] + 40) linkUUID];
    v104[0] = 0;
    v104[1] = v104;
    v104[2] = 0x3032000000;
    v104[3] = sub_1A7BA55D8;
    v104[4] = sub_1A7BA55E8;
    v105 = [[IDSStunMessage alloc] initWithType:257];
    v19 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v20 = [IDSSockAddrWrapper wrapperWithSockAddr:v153];
    if (v20)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-xormappedaddress", v20);
    }

    else
    {
      v21 = MEMORY[0x1E69E9C10];
      v22 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15DC8();
      }

      v20 = 0;
    }

    v89 = v20;

    v23 = self->_controlMessageKey;
    if (v23)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-messageintegrity", v23);
    }

    else
    {
      v24 = MEMORY[0x1E69E9C10];
      v25 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15B20();
      }
    }

    v26 = !self->_islocalCellAttributeInexpensive && [(IDSGlobalLink *)self _isInterfaceExpensiveWithInterfaceIndex:v10];
    if ([(IDSGlobalLink *)self _isInterfaceConstrainedWithInterfaceIndex:v10, v80, v84, v85, v86])
    {
      v26 |= 2u;
    }

    if (self->_remoteDeviceVersion >= 2 && [(IDSGlobalLink *)self _isInterfaceDelegatedWithInterfaceIndex:v10])
    {
      v26 |= 4u;
    }

    if ([(IDSGlobalLink *)self _isCLAT46Interface:&v145])
    {
      v27 = v26 | 8;
    }

    else
    {
      v27 = v26;
    }

    if ([(IDSGlobalLink *)self _isCellularInterfaceForCandidatePair:*(*&buf[8] + 40) localAddress:&v145]&& (v27 = v27 | self->_cellularSlicingFlags, [(IDSGlobalLink *)self _isSlicedCellularInterfaceActive:v10]))
    {
      v27 = v27 | 0x80;
    }

    else if (!v27)
    {
      goto LABEL_48;
    }

    v28 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v27];
    if (v28)
    {
      CFDictionarySetValue(v19, @"ids-stun-attribute-link-attributes", v28);
    }

    else
    {
      v29 = MEMORY[0x1E69E9C10];
      v30 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E15E50();
      }
    }

LABEL_48:
    if ([(IDSGlobalLink *)self _isCellularInterfaceForCandidatePair:*(*&buf[8] + 40) localAddress:&v145])
    {
      v31 = +[IDSCellularLinkMonitor sharedInstance];
      dataSoMaskBits = [v31 dataSoMaskBits];

      v33 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:dataSoMaskBits];
      if (v33)
      {
        CFDictionarySetValue(v19, @"ids-stun-attribute-data-so-masks-attributes", v33);
      }

      else
      {
        v34 = MEMORY[0x1E69E9C10];
        v35 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15ED8();
        }
      }
    }

    if (self->_isInitiator && (self->_remoteCapabilityFlag & 1) != 0)
    {
      uUID = linkUUID;
      if (!linkUUID)
      {
        uUID = [MEMORY[0x1E696AFB0] UUID];
      }

      memset(v132, 170, sizeof(v132));
      linkUUID = uUID;
      [uUID getUUIDBytes:v132];
      v37 = [MEMORY[0x1E695DEF0] dataWithBytes:v132 length:16];
      if (v37)
      {
        CFDictionarySetValue(v19, @"ids-stun-attribute-linkuuid", v37);
      }

      else
      {
        v38 = MEMORY[0x1E69E9C10];
        v39 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15BA8();
        }
      }
    }

    v40 = [MEMORY[0x1E696AEC0] stringWithCString:__str encoding:4];
    v41 = [MEMORY[0x1E696AEC0] stringWithCString:v155 encoding:4];
    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BA55F0;
    aBlock[3] = &unk_1E77E1130;
    v113 = buf;
    aBlock[4] = self;
    v119 = v149;
    v120 = v150;
    v121 = v151;
    v122 = v152;
    v115 = v145;
    v116 = v146;
    v117 = v147;
    v118 = v148;
    v125 = v139;
    v126 = v140;
    v123 = v137;
    v124 = v138;
    v129 = v143;
    v130 = v144;
    v127 = v141;
    v128 = v142;
    v114 = v104;
    v42 = requestCopy;
    v108 = v42;
    v90 = v19;
    v109 = v90;
    v88 = v40;
    v110 = v88;
    v43 = v41;
    v111 = v43;
    v131 = v10;
    v87 = key;
    v112 = v87;
    v92 = _Block_copy(aBlock);
    if ([v42 getAttribute:32775 attribute:__b])
    {
      if (__b[2] >= 0xAu)
      {
        v44 = 10;
      }

      else
      {
        v44 = __b[2];
      }

      v45 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
      {
        v46 = IDSRadioAccessTechnologyToString(v44);
        *v132 = 136315138;
        *&v132[4] = v46;
        _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "receive remote cellular RAT [%s].", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v81 = IDSRadioAccessTechnologyToString(v44);
          _IDSLogTransport(@"GL", @"IDS", @"receive remote cellular RAT [%s].");
          if (_IDSShouldLog())
          {
            v81 = IDSRadioAccessTechnologyToString(v44);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive remote cellular RAT [%s].");
          }
        }
      }
    }

    else
    {
      v44 = 0;
    }

    v47 = *(*&buf[8] + 40);
    if (!v47)
    {
      if (BYTE1(v137) == 30)
      {
        v48 = 6;
      }

      else
      {
        v48 = 5;
      }

      if (v44)
      {
        v49 = v44 == 9;
      }

      else
      {
        v49 = 1;
      }

      v50 = !v49;
      v51 = [IDSStunCandidate candidateWithType:2 transport:1 radioAccessTechnology:v44 mtu:GLUtilGetLocalMTU(v48 index:v50) address:0xFFFFFFFFLL external:&v137, &v137];
      v52 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
      {
        *v132 = 138412290;
        *&v132[4] = v51;
        _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "discover remote prlx candidate %@.", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v82 = v51;
          _IDSLogTransport(@"GL", @"IDS", @"discover remote prlx candidate %@.");
          if (_IDSShouldLog())
          {
            v82 = v51;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"discover remote prlx candidate %@.");
          }
        }
      }

      if ([(IDSGlobalLink *)self _addCandidate:v51 isRemoteCandidate:1, v82])
      {
        [(IDSGlobalLink *)self _addStunCheckPair:v51 isRemoteCandidate:1 excludeLocalAddress:&v145];
      }

      v102 = 0u;
      v103 = 0u;
      v100 = 0u;
      v101 = 0u;
      v53 = self->_interfaceAddressArray;
      radioAccessTechnology = [(NSMutableArray *)v53 countByEnumeratingWithState:&v100 objects:v106 count:16];
      if (radioAccessTechnology)
      {
        v55 = v43;
        v56 = *v101;
        while (2)
        {
          for (i = 0; i != radioAccessTechnology; ++i)
          {
            if (*v101 != v56)
            {
              objc_enumerationMutation(v53);
            }

            v58 = *(*(&v100 + 1) + 8 * i);
            if ([v58 index] == v10)
            {
              v43 = v55;
              if ([v58 isCellular])
              {
                v59 = +[IDSCellularLinkMonitor sharedInstance];
                radioAccessTechnology = [v59 radioAccessTechnology];
              }

              else if ([v58 isWired])
              {
                radioAccessTechnology = 9;
              }

              else
              {
                radioAccessTechnology = 0;
              }

              goto LABEL_108;
            }
          }

          radioAccessTechnology = [(NSMutableArray *)v53 countByEnumeratingWithState:&v100 objects:v106 count:16];
          if (radioAccessTechnology)
          {
            continue;
          }

          break;
        }

        v43 = v55;
      }

LABEL_108:

      if (radioAccessTechnology)
      {
        v60 = radioAccessTechnology == 9;
      }

      else
      {
        v60 = 1;
      }

      v61 = !v60;
      if (BYTE1(v145) == 30)
      {
        v62 = 6;
      }

      else
      {
        v62 = 5;
      }

      v63 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:radioAccessTechnology mtu:GLUtilGetLocalMTU(v62 index:v61) address:v10 external:&v145, &v145];
      [(IDSGlobalLink *)self _addCandidate:v63 isRemoteCandidate:0];
      v64 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v63 remoteCandidate:v51 sessionID:self->_cbuuid delegate:self];
      v65 = *(*&buf[8] + 40);
      *(*&buf[8] + 40) = v64;

      if (self->_isInitiator)
      {
        v66 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
        {
          *v132 = 138412290;
          *&v132[4] = linkUUID;
          _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, "use linkUUID %@ for triggered check.", v132, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v83 = linkUUID;
            _IDSLogTransport(@"GL", @"IDS", @"use linkUUID %@ for triggered check.");
            if (_IDSShouldLog())
            {
              v83 = linkUUID;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"use linkUUID %@ for triggered check.");
            }
          }
        }

        [*(*&buf[8] + 40) setLinkUUID:{linkUUID, v83}];
      }

      if (!self->_tokenToStunCheckPairs)
      {
        Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
        tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
        self->_tokenToStunCheckPairs = Mutable;
      }

      v69 = *(*&buf[8] + 40);
      if (v69)
      {
        CFDictionarySetValue(self->_tokenToStunCheckPairs, v87, v69);
      }

      else
      {
        v70 = MEMORY[0x1E69E9C10];
        v71 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v70, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E15F60();
        }
      }

      v72 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
      {
        v73 = *(*&buf[8] + 40);
        *v132 = 138412290;
        *&v132[4] = v73;
        _os_log_impl(&dword_1A7AD9000, v72, OS_LOG_TYPE_DEFAULT, "add stun check pair %@.", v132, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v83 = *(*&buf[8] + 40);
          _IDSLogTransport(@"GL", @"IDS", @"add stun check pair %@.");
          if (_IDSShouldLog())
          {
            v83 = *(*&buf[8] + 40);
            _IDSLogV(0, @"IDSFoundation", @"GL", @"add stun check pair %@.");
          }
        }
      }

      [(IDSGlobalLink *)self registerP2PCandidatePairWithLinkEngine:*(*&buf[8] + 40), v83];

      v47 = *(*&buf[8] + 40);
    }

    linkMetrics = [v47 linkMetrics];
    [linkMetrics receiveBindingRequest];

    [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:*(*&buf[8] + 40)];
    if ([v42 getAttribute:32776 attribute:__b])
    {
      v75 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&__b[3]];
      [(IDSGlobalLink *)self _processRemoteLinkUUID:v75 candidatePair:*(*&buf[8] + 40)];
    }

    if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
    {
      goto LABEL_144;
    }

    local = [*(*&buf[8] + 40) local];
    if ([local isCellularStunCandidate])
    {
      allowTLEOverCellular = self->_allowTLEOverCellular;

      if (!allowTLEOverCellular)
      {
LABEL_144:
        v92[2]();
LABEL_147:

        _Block_object_dispose(v104, 8);
        _Block_object_dispose(buf, 8);

        goto LABEL_148;
      }
    }

    else
    {
    }

    v78 = *(*&buf[8] + 40);
    v97[0] = MEMORY[0x1E69E9820];
    v97[1] = 3221225472;
    v97[2] = sub_1A7BA5890;
    v97[3] = &unk_1E77E1158;
    v98 = v90;
    v99 = v92;
    [(IDSGlobalLink *)self _attemptP2PNegotiationForSTUNMessage:v42 candidatePair:v78 completionHandler:v97];

    goto LABEL_147;
  }

  v16 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138413058;
    *&buf[4] = requestCopy;
    *&buf[12] = 2080;
    *&buf[14] = v155;
    *&buf[22] = 2080;
    v134 = __str;
    LOWORD(v135) = 1024;
    *(&v135 + 2) = v10;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "ignoring self binding request %@ from %s on %s(%u)", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"ignoring self binding request %@ from %s on %s(%u)");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"ignoring self binding request %@ from %s on %s(%u)");
      }
    }
  }

LABEL_148:

  return !v94;
}

- (void)_attemptP2PNegotiationForSTUNMessage:(id)message candidatePair:(id)pair completionHandler:(id)handler
{
  v31 = *MEMORY[0x1E69E9840];
  messageCopy = message;
  pairCopy = pair;
  handlerCopy = handler;
  nextP2PNegotiationAttempt = self->_nextP2PNegotiationAttempt;
  self->_nextP2PNegotiationAttempt = nextP2PNegotiationAttempt + 1;
  v12 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    *&buf[4] = nextP2PNegotiationAttempt;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v20 = nextP2PNegotiationAttempt;
      _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]");
      if (_IDSShouldLog())
      {
        v20 = nextP2PNegotiationAttempt;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]");
      }
    }
  }

  if (![(IDSGlobalLink *)self _shouldSetUpP2PTLE])
  {
    goto LABEL_10;
  }

  local = [pairCopy local];
  if ([local isCellularStunCandidate])
  {
    allowTLEOverCellular = self->_allowTLEOverCellular;

    if (!allowTLEOverCellular)
    {
LABEL_10:
      (*(handlerCopy + 2))(handlerCopy, 0, 0);
      goto LABEL_35;
    }
  }

  else
  {
  }

  memset(buf, 170, 0x5D0uLL);
  if ([messageCopy getAttribute:36866 attribute:buf])
  {
    v15 = *&buf[8];
  }

  else
  {
    v15 = 0;
  }

  if ([messageCopy getAttribute:36867 attribute:buf])
  {
    v16 = *&buf[8];
  }

  else
  {
    v16 = 0;
  }

  if (v15 && v16 && [messageCopy getAttribute:36865 attribute:buf])
  {
    v17 = [MEMORY[0x1E695DEF0] dataWithBytes:&buf[12] length:*&buf[8]];
    v18 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      *v24 = 134218498;
      v25 = nextP2PNegotiationAttempt;
      v26 = 2112;
      v27 = v17;
      v28 = 2112;
      v29 = pairCopy;
      _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@", v24, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = v17;
        v23 = pairCopy;
        v21 = nextP2PNegotiationAttempt;
        _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@");
        if (_IDSShouldLog())
        {
          v22 = v17;
          v23 = pairCopy;
          v21 = nextP2PNegotiationAttempt;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]: received p2p negotiation blob: %@ from:%@");
        }
      }
    }

    [(IDSGlobalLink *)self _receiveP2PNegotiationBlob:v17 attemptID:nextP2PNegotiationAttempt remoteIDSConnectionID:v16 remoteAVCConnectionID:v15 candidatePair:pairCopy completionHandler:handlerCopy, v21, v22, v23];
  }

  else
  {
    v19 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *v24 = 134217984;
      v25 = nextP2PNegotiationAttempt;
      _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message", v24, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_attemptP2PNegotiationForSTUNMessage[%llu]: no p2p negotiation info in stun message");
        }
      }
    }

    (*(handlerCopy + 2))(handlerCopy, 0, 0);
  }

LABEL_35:
}

- (void)_receiveP2PNegotiationBlob:(id)blob attemptID:(unint64_t)d remoteIDSConnectionID:(unsigned int)iD remoteAVCConnectionID:(unsigned int)connectionID candidatePair:(id)pair completionHandler:(id)handler
{
  blobCopy = blob;
  pairCopy = pair;
  handlerCopy = handler;
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = sub_1A7BA6044;
  v20[3] = &unk_1E77E11F8;
  v21 = pairCopy;
  v22 = blobCopy;
  v24 = handlerCopy;
  dCopy = d;
  connectionIDCopy = connectionID;
  iDCopy = iD;
  selfCopy = self;
  v17 = handlerCopy;
  v18 = blobCopy;
  v19 = pairCopy;
  [(IDSGlobalLink *)self _getP2PNegotiationForCandidatePair:v19 completionBlock:v20];
}

- (void)setUpP2PQUICPodConnectionsForCandidatePair:(id)pair attemptID:(unint64_t)d completionHandler:(id)handler
{
  v21 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  handlerCopy = handler;
  nwLink = self->_nwLink;
  cbuuid = self->_cbuuid;
  local = [pairCopy local];
  address = [local address];
  remote = [pairCopy remote];
  address2 = [remote address];
  qUICConnectionIDs = [pairCopy QUICConnectionIDs];
  p2pNegotiatedKeys = [pairCopy p2pNegotiatedKeys];
  LOBYTE(nwLink) = -[IDSNWLink createQUICPodP2PConnectionsForSession:localAddress:remoteAddress:quicConnectionIDs:negotiatedKeys:channelNumber:completionHandler:](nwLink, "createQUICPodP2PConnectionsForSession:localAddress:remoteAddress:quicConnectionIDs:negotiatedKeys:channelNumber:completionHandler:", cbuuid, address, address2, qUICConnectionIDs, p2pNegotiatedKeys, [pairCopy channelNumber], handlerCopy);

  if ((nwLink & 1) == 0)
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      dCopy = d;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setUpP2PQUICPodConnectionsForCandidatePair[%llu]: failed to set up p2p connections");
        }
      }
    }
  }
}

- (BOOL)_processBindingResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v11 = *&index;
  v137 = *MEMORY[0x1E69E9840];
  responseCopy = response;
  deviceCopy = device;
  tokenCopy = token;
  *&v16 = 0xAAAAAAAAAAAAAAAALL;
  *(&v16 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v135 = v16;
  v136 = v16;
  v133 = v16;
  v134 = v16;
  v131 = v16;
  v132 = v16;
  v129 = v16;
  v130 = v16;
  v128 = v16;
  v127 = v16;
  v126 = v16;
  v125 = v16;
  v124 = v16;
  v123 = v16;
  v122 = v16;
  v121 = v16;
  __memcpy_chk();
  __memcpy_chk();
  v64 = 0;
  v65 = &v64;
  v66 = 0x2020000000;
  v67 = &v129;
  v60 = 0;
  v61 = &v60;
  v62 = 0x2020000000;
  v63 = &v121;
  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v120 = v17;
  v119 = v17;
  v118 = v17;
  v117 = v17;
  v116 = v17;
  v115 = v17;
  v114 = v17;
  *__str = v17;
  v112 = v17;
  v111 = v17;
  v110 = v17;
  v109 = v17;
  v108 = v17;
  v107 = v17;
  v106 = v17;
  *v105 = v17;
  memset(__b, 170, sizeof(__b));
  *&v18 = 0xAAAAAAAAAAAAAAAALL;
  *(&v18 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v103[6] = v18;
  v103[7] = v18;
  v103[4] = v18;
  v103[5] = v18;
  v103[2] = v18;
  v103[3] = v18;
  v103[0] = v18;
  v103[1] = v18;
  SAToIPPortString(__str, 0x80uLL, &v129);
  SAToIPPortString(v105, 0x80uLL, v61[3]);
  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138413058;
    v96 = responseCopy;
    v97 = 2080;
    v98 = v105;
    v99 = 2080;
    v100 = __str;
    v101 = 1024;
    v102 = v11;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive binding response %@ from %s on %s(%u)", buf, 0x26u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v56 = __str;
      v57 = v11;
      v52 = responseCopy;
      v55 = v105;
      _IDSLogTransport(@"GL", @"IDS", @"receive binding response %@ from %s on %s(%u)");
      if (_IDSShouldLog())
      {
        v56 = __str;
        v57 = v11;
        v52 = responseCopy;
        v55 = v105;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive binding response %@ from %s on %s(%u)");
      }
    }
  }

  Value = 0;
  if (tokenCopy && self->_tokenToStunCheckPairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToStunCheckPairs, tokenCopy);
  }

  v21 = Value;
  linkMetrics = [v21 linkMetrics];
  [linkMetrics receiveBindingResponse];

  [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v21];
  if (!v21)
  {
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v96 = tokenCopy;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for %@.");
        }
      }
    }

    goto LABEL_47;
  }

  if ([responseCopy getAttribute:32776 attribute:__b])
  {
    v23 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDBytes:&__b[3]];
    [(IDSGlobalLink *)self _processRemoteLinkUUID:v23 candidatePair:v21];
  }

  if (([responseCopy getAttribute:32 attribute:{__b, v52, v55, v56, v57}] & 1) == 0)
  {
    v29 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "failed to receive xor-mapped-address.", buf, 2u);
    }

    if (!os_log_shim_legacy_logging_enabled())
    {
      goto LABEL_47;
    }

    if (!_IDSShouldLogTransport())
    {
      goto LABEL_47;
    }

    _IDSLogTransport(@"GL", @"IDS", @"failed to receive xor-mapped-address.");
    if ((_IDSShouldLog() & 1) == 0)
    {
      goto LABEL_47;
    }

    v30 = @"failed to receive xor-mapped-address.";
    goto LABEL_46;
  }

  __memcpy_chk();
  if (!IsValidSA(v103))
  {
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "receive invalid xor-mapped-address.", buf, 2u);
    }

    if (!os_log_shim_legacy_logging_enabled())
    {
      goto LABEL_47;
    }

    if (!_IDSShouldLogTransport())
    {
      goto LABEL_47;
    }

    _IDSLogTransport(@"GL", @"IDS", @"receive invalid xor-mapped-address.");
    if (!_IDSShouldLog())
    {
      goto LABEL_47;
    }

    v30 = @"receive invalid xor-mapped-address.";
LABEL_46:
    _IDSLogV(0, @"IDSFoundation", @"GL", v30);
LABEL_47:
    v32 = 0;
    goto LABEL_48;
  }

  v24 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    v25 = SAToIPPortString(v105, 0x80uLL, v103);
    *buf = 136315138;
    v96 = v25;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "receive xor-mapped-address [%s].", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v53 = SAToIPPortString(v105, 0x80uLL, v103);
      _IDSLogTransport(@"GL", @"IDS", @"receive xor-mapped-address [%s].");
      if (_IDSShouldLog())
      {
        v53 = SAToIPPortString(v105, 0x80uLL, v103);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive xor-mapped-address [%s].");
      }
    }
  }

  v26 = [responseCopy getAttribute:32803 attribute:{__b, v53}];
  if (__b[2])
  {
    v27 = v26;
  }

  else
  {
    v27 = 0;
  }

  if (v27 != 1)
  {
    goto LABEL_27;
  }

  if ((__b[2] & 0x80) != 0)
  {
    v58 = __b[2] & 0x7F | 0x80;
    goto LABEL_50;
  }

  v58 = __b[2] & 0x7F;
  if ((__b[2] & 0x7F) != 0)
  {
LABEL_50:
    remote = [v21 remote];
    [remote setLinkFlags:v58];

    goto LABEL_51;
  }

LABEL_27:
  LOWORD(v58) = 0;
LABEL_51:
  v35 = [responseCopy getAttribute:32804 attribute:__b];
  v36 = __b[2];
  if (__b[2])
  {
    v37 = v35;
  }

  else
  {
    v37 = 0;
  }

  if (v37 == 1)
  {
    remote2 = [v21 remote];
    [remote2 setDataSoMask:v36];
  }

  else
  {
    LODWORD(v36) = 0;
  }

  local = [v21 local];
  external = [local external];

  if (IsSameSA(external, v103))
  {
    v41 = 0;
    v42 = 0;
  }

  else
  {
    local2 = [v21 local];
    radioAccessTechnology = [local2 radioAccessTechnology];

    local3 = [v21 local];
    v46 = [local3 mtu];

    v41 = [IDSStunCandidate candidateWithType:2 transport:1 radioAccessTechnology:radioAccessTechnology mtu:v46 index:v11 address:v65[3] external:v103];
    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v96 = v41;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "discover local prlx candidate %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v54 = v41;
        _IDSLogTransport(@"GL", @"IDS", @"discover local prlx candidate %@.");
        if (_IDSShouldLog())
        {
          v54 = v41;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"discover local prlx candidate %@.");
        }
      }
    }

    v42 = [(IDSGlobalLink *)self _addCandidate:v41 isRemoteCandidate:0, v54];
    local4 = [v21 local];
    [v41 setIsCLAT46:{objc_msgSend(local4, "isCLAT46")}];

    local5 = [v21 local];
    [v41 setCellularSlicingFlags:{objc_msgSend(local5, "cellularSlicingFlags")}];
  }

  v68[0] = MEMORY[0x1E69E9820];
  v68[1] = 3221225472;
  v68[2] = sub_1A7BA7680;
  v68[3] = &unk_1E77E1220;
  v79 = v133;
  v80 = v134;
  v81 = v135;
  v82 = v136;
  v75 = v129;
  v76 = v130;
  v77 = v131;
  v78 = v132;
  v73 = &v64;
  v74 = &v60;
  v89 = v127;
  v90 = v128;
  v87 = v125;
  v88 = v126;
  v85 = v123;
  v86 = v124;
  v83 = v121;
  v84 = v122;
  v50 = v21;
  v69 = v50;
  selfCopy = self;
  v71 = tokenCopy;
  v94 = v42;
  v51 = v41;
  v72 = v51;
  v93 = v58;
  v92 = v36;
  timeCopy = time;
  [(IDSGlobalLink *)self _attemptP2PNegotiationForSTUNMessage:responseCopy candidatePair:v50 completionHandler:v68];

  v32 = 1;
LABEL_48:

  _Block_object_dispose(&v60, 8);
  _Block_object_dispose(&v64, 8);

  return v32;
}

- (void)_discardNonSlicedP2PCandidatePairs
{
  v45 = *MEMORY[0x1E69E9840];
  if (self->_cellInterfaceName)
  {
    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v32 = 0u;
    v33 = 0u;
    v34 = 0u;
    v35 = 0u;
    v4 = [allValues countByEnumeratingWithState:&v32 objects:v44 count:16];
    if (!v4)
    {
      goto LABEL_21;
    }

    v6 = v4;
    v7 = *v33;
    v26 = v29;
    v8 = 0x1E77DB000uLL;
    *&v5 = 138413058;
    v25 = v5;
    v27 = allValues;
    while (1)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v33 != v7)
        {
          objc_enumerationMutation(allValues);
        }

        v10 = *(*(&v32 + 1) + 8 * i);
        local = [v10 local];
        v12 = -[IDSGlobalLink _interfaceNameForInterfaceIndexIncludingVPN:](self, "_interfaceNameForInterfaceIndexIncludingVPN:", [local index]);

        if (([v10 isRelayStunCandidatePair] & 1) == 0)
        {
          local2 = [v10 local];
          if ([local2 isCellularStunCandidate])
          {
            v14 = [(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v12];

            if (v14)
            {
              goto LABEL_19;
            }

            v15 = [*(v8 + 3824) sharedInstanceForBagType:0];
            local2 = [v15 objectForKey:@"ids-delay-for-cellular-default-and-slicing"];

            if (local2 && (objc_opt_class(), (objc_opt_isKindOfClass() & 1) != 0))
            {
              unsignedIntegerValue = [local2 unsignedIntegerValue];
              v17 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
              {
                cellInterfaceName = self->_cellInterfaceName;
                *buf = v25;
                v37 = v12;
                v38 = 2112;
                v39 = cellInterfaceName;
                v40 = 2112;
                v41 = v10;
                v42 = 1024;
                v43 = unsignedIntegerValue;
                _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ will discard existing pair: %@ in %u seconds.", buf, 0x26u);
              }

              v19 = [MEMORY[0x1E6995700] weakRefWithObject:self];
              v20 = dispatch_time(0, 1000000000 * unsignedIntegerValue);
              v21 = im_primary_queue();
              block[0] = MEMORY[0x1E69E9820];
              block[1] = 3221225472;
              v29[0] = sub_1A7BA8744;
              v29[1] = &unk_1E77E0C88;
              v30 = v19;
              v31 = v10;
              v22 = v19;
              dispatch_after(v20, v21, block);

              allValues = v27;
              v8 = 0x1E77DB000;
            }

            else
            {
              v23 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
              {
                v24 = self->_cellInterfaceName;
                *buf = 138412802;
                v37 = v12;
                v38 = 2112;
                v39 = v24;
                v40 = 2112;
                v41 = v10;
                _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@ _cellInterfaceName %@ discard existing pair: %@.", buf, 0x20u);
              }

              [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
              [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v10 withReason:13];
            }
          }
        }

LABEL_19:
      }

      v6 = [allValues countByEnumeratingWithState:&v32 objects:v44 count:16];
      if (!v6)
      {
LABEL_21:

        return;
      }
    }
  }
}

- (id)_filterNonSlicedLocalCandidates:(id)candidates
{
  v28 = *MEMORY[0x1E69E9840];
  candidatesCopy = candidates;
  v5 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v6 = candidatesCopy;
  v7 = [v6 countByEnumeratingWithState:&v19 objects:v27 count:16];
  if (v7)
  {
    v8 = *v20;
    do
    {
      v9 = 0;
      do
      {
        if (*v20 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v19 + 1) + 8 * v9);
        v11 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v24 = v10;
          _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "_filterNonSlicedLocalCandidates: checking %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v17 = v10;
            _IDSLogTransport(@"GL", @"IDS", @"_filterNonSlicedLocalCandidates: checking %@");
            if (_IDSShouldLog())
            {
              v17 = v10;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_filterNonSlicedLocalCandidates: checking %@");
            }
          }
        }

        v12 = [(IDSGlobalLink *)self _interfaceNameForInterfaceIndexIncludingVPN:[(NSString *)v10 index:v17]];
        if (self->_cellInterfaceName && [(NSString *)v10 isCellularStunCandidate]&& ([(NSString *)self->_cellInterfaceName isEqualToIgnoringCase:v12]& 1) == 0)
        {
          v13 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
          {
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            v24 = cellInterfaceName;
            v25 = 2112;
            v26 = v12;
            _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "_filterNonSlicedLocalCandidates: skipping because %@ does not match %@", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v17 = self->_cellInterfaceName;
              v18 = v12;
              _IDSLogTransport(@"GL", @"IDS", @"_filterNonSlicedLocalCandidates: skipping because %@ does not match %@");
              if (_IDSShouldLog())
              {
                v17 = self->_cellInterfaceName;
                v18 = v12;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_filterNonSlicedLocalCandidates: skipping because %@ does not match %@");
              }
            }
          }
        }

        else if (v5 && v10)
        {
          CFArrayAppendValue(v5, v10);
        }

        ++v9;
      }

      while (v7 != v9);
      v15 = [v6 countByEnumeratingWithState:&v19 objects:v27 count:16];
      v7 = v15;
    }

    while (v15);
  }

  return v5;
}

- (void)_updateInterfaceAddressesWithAddList:(id)list removeList:(id)removeList
{
  v25 = *MEMORY[0x1E69E9840];
  listCopy = list;
  removeListCopy = removeList;
  if (!self->_interfaceAddressArray)
  {
    v8 = objc_alloc_init(MEMORY[0x1E695DF70]);
    interfaceAddressArray = self->_interfaceAddressArray;
    self->_interfaceAddressArray = v8;
  }

  if ([listCopy count])
  {
    [(NSMutableArray *)self->_interfaceAddressArray addObjectsFromArray:listCopy];
  }

  if ([removeListCopy count])
  {
    [(NSMutableArray *)self->_interfaceAddressArray removeObjectsInArray:removeListCopy];
  }

  v20 = 0u;
  v21 = 0u;
  v18 = 0u;
  v19 = 0u;
  v10 = self->_interfaceAddressArray;
  v11 = [(NSMutableArray *)v10 countByEnumeratingWithState:&v18 objects:v24 count:16];
  if (v11)
  {
    v12 = 0;
    v13 = *v19;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v19 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v18 + 1) + 8 * i);
        if ([v15 isCellular])
        {
          if (!v12)
          {
            v12 = objc_alloc_init(MEMORY[0x1E696AD50]);
          }

          [v12 addIndex:{objc_msgSend(v15, "index")}];
        }
      }

      v11 = [(NSMutableArray *)v10 countByEnumeratingWithState:&v18 objects:v24 count:16];
    }

    while (v11);

    if (v12)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v23 = v12;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "current cellular interface indices: %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v17 = v12;
          _IDSLogTransport(@"GL", @"IDS", @"current cellular interface indices: %@");
          if (_IDSShouldLog())
          {
            v17 = v12;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"current cellular interface indices: %@");
          }
        }
      }

      [(IDSUDPLink *)self->_udpLink setCellularInterfaceIndices:v12, v17];
      [(IDSUDPLink *)self->_udpLinkv6 setCellularInterfaceIndices:v12];
      [(IDSTCPLink *)self->_tcpLink setCellularInterfaceIndices:v12];
      [(IDSTCPLink *)self->_tcpSSLLink setCellularInterfaceIndices:v12];
      [(IDSNWLink *)self->_nwLink setCellularInterfaceIndices:v12];
    }
  }

  else
  {

    v12 = 0;
  }

  [(IDSGlobalLink *)self _generateTransportScoreCard];
  [(IDSGlobalLink *)self _updateAllLinks];
}

- (void)_generateTransportScoreCard
{
  v57 = *MEMORY[0x1E69E9840];
  transportScoreCards = self->_transportScoreCards;
  if (!transportScoreCards)
  {
    v4 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v5 = self->_transportScoreCards;
    self->_transportScoreCards = v4;

    transportScoreCards = self->_transportScoreCards;
  }

  [(NSMutableArray *)transportScoreCards removeAllObjects];
  v49 = 0u;
  v50 = 0u;
  v47 = 0u;
  v48 = 0u;
  obj = self->_interfaceAddressArray;
  v41 = [(NSMutableArray *)obj countByEnumeratingWithState:&v47 objects:v56 count:16];
  if (v41)
  {
    v40 = *v48;
    do
    {
      v6 = 0;
      do
      {
        if (*v48 != v40)
        {
          v7 = v6;
          objc_enumerationMutation(obj);
          v6 = v7;
        }

        v42 = v6;
        v8 = *(*(&v47 + 1) + 8 * v6);
        if ([v8 IPVersion] || !objc_msgSend(v8, "clat46") || self->_disablePureLinkFeature)
        {
          if (!self->_cellInterfaceName || ![v8 isCellular] || (objc_msgSend(v8, "name"), v9 = objc_claimAutoreleasedReturnValue(), v10 = objc_msgSend(v9, "isEqualToIgnoringCase:", self->_cellInterfaceName), v9, (v10 & 1) != 0))
          {
            index = [v8 index];
            delegatedName = [v8 delegatedName];

            isWired = [v8 isWired];
            if (delegatedName)
            {
              if (isWired)
              {
                v14 = 31;
                v15 = 4;
                goto LABEL_30;
              }

              isCellular = [v8 isCellular];
              v17 = isCellular == 0;
              if (isCellular)
              {
                v14 = 1;
              }

              else
              {
                v14 = 25;
              }

              v18 = 5;
LABEL_27:
              if (v17)
              {
                v15 = v18;
              }

              else
              {
                v15 = v18 + 1;
              }

              goto LABEL_30;
            }

            if ((isWired & 1) == 0)
            {
              isCellular2 = [v8 isCellular];
              v17 = isCellular2 == 0;
              if (isCellular2)
              {
                v14 = 3;
              }

              else
              {
                v14 = 27;
              }

              v18 = 2;
              goto LABEL_27;
            }

            v14 = 33;
            v15 = 1;
LABEL_30:
            iPVersion = [v8 IPVersion];
            if (iPVersion == 1)
            {
              v14 *= 4;
            }

            else
            {
              [v8 IPVersion];
            }

            v21 = iPVersion == 1;
            v22 = 2;
            while (2)
            {
              if (v22 == 4)
              {
                shouldFallbackToTCPFirst = !self->_shouldFallbackToTCPFirst;
              }

              else
              {
                if (v22 != 3)
                {
                  if (v22 == 2)
                  {
                    v23 = 100 * v14;
                  }

                  else
                  {
                    v23 = v14;
                  }

LABEL_42:
                  v25 = objc_alloc_init(IDSTransportScoreCard);
                  v25->score = v23;
                  v25->stunTransport = v22;
                  v25->transportInterface = v15;
                  v25->interfaceIndex = index;
                  v25->alreadySelected = 0;
                  v25->isIPv6 = v21;
                  [(NSMutableArray *)self->_transportScoreCards addObject:v25];

                  if (++v22 == 5)
                  {
                    allKeys = [(NSDictionary *)self->_allocationsToTransportScoreCards allKeys];
                    v45 = 0u;
                    v46 = 0u;
                    v43 = 0u;
                    v44 = 0u;
                    v27 = [allKeys countByEnumeratingWithState:&v43 objects:v51 count:16];
                    if (v27)
                    {
                      v28 = *v44;
                      do
                      {
                        for (i = 0; i != v27; ++i)
                        {
                          if (*v44 != v28)
                          {
                            objc_enumerationMutation(allKeys);
                          }

                          v30 = *(*(&v43 + 1) + 8 * i);
                          v31 = [objc_alloc(MEMORY[0x1E695DF70]) initWithArray:self->_transportScoreCards copyItems:1];
                          if (v31)
                          {
                            CFDictionarySetValue(self->_allocationsToTransportScoreCards, v30, v31);
                          }

                          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                          {
                            *buf = 138412546;
                            v53 = v30;
                            v54 = 2080;
                            v55 = "_allocationsToTransportScoreCards";
                            _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
                          }
                        }

                        v27 = [allKeys countByEnumeratingWithState:&v43 objects:v51 count:16];
                      }

                      while (v27);
                    }

                    goto LABEL_55;
                  }

                  continue;
                }

                shouldFallbackToTCPFirst = self->_shouldFallbackToTCPFirst;
              }

              break;
            }

            v23 = v14 << shouldFallbackToTCPFirst;
            goto LABEL_42;
          }

          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            name = [v8 name];
            cellInterfaceName = self->_cellInterfaceName;
            *buf = 138412546;
            v53 = name;
            v54 = 2112;
            v55 = cellInterfaceName;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              name2 = [v8 name];
              v38 = self->_cellInterfaceName;
              _IDSLogTransport(@"GL", @"IDS", @"Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!");

              if (_IDSShouldLog())
              {
                name2 = [v8 name];
                v38 = self->_cellInterfaceName;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"Sliced Cellular Interface - currentInterfaceName %@, _cellInterfaceName %@ skipping currentInterfaceAddress for transport score card!");
              }
            }
          }
        }

        else
        {
          v35 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v53 = v8;
            _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              name2 = v8;
              _IDSLogTransport(@"GL", @"IDS", @"_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!");
              if (_IDSShouldLog())
              {
                name2 = v8;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_generateTransportScoreCard: skipping %@ which is a simualted IPv4 interface!");
              }
            }
          }
        }

LABEL_55:
        v6 = v42 + 1;
      }

      while (v42 + 1 != v41);
      v36 = [(NSMutableArray *)obj countByEnumeratingWithState:&v47 objects:v56 count:16];
      v41 = v36;
    }

    while (v36);
  }
}

- (BOOL)_isUsingSameRATCandidatePair:(id)pair transportScoreCard:(id)card
{
  pairCopy = pair;
  cardCopy = card;
  local = [pairCopy local];
  if ([local radioAccessTechnology] == 9)
  {
    v8 = cardCopy[3];
    if (v8 == 1)
    {
      goto LABEL_21;
    }

    if (v8 == 4)
    {
      goto LABEL_24;
    }
  }

  else
  {
  }

  local = [pairCopy local];
  if ([local radioAccessTechnology])
  {

LABEL_8:
    local = [pairCopy local];
    if ([local radioAccessTechnology])
    {
      local2 = [pairCopy local];
      if ([local2 radioAccessTechnology] > 8)
      {
        LOBYTE(v8) = 0;
      }

      else
      {
        v10 = cardCopy[3];
        LOBYTE(v8) = v10 == 3 || v10 == 6;
      }
    }

    else
    {
      LOBYTE(v8) = 0;
    }

    goto LABEL_21;
  }

  v12 = cardCopy[3];
  if (v12 != 2)
  {

    if (v12 == 5)
    {
LABEL_24:
      LOBYTE(v8) = 1;
      goto LABEL_22;
    }

    goto LABEL_8;
  }

  LOBYTE(v8) = 1;
LABEL_21:

LABEL_22:
  return v8;
}

- (id)_transportInterfaceToString:(int64_t)string
{
  if (string > 6)
  {
    return 0;
  }

  else
  {
    return off_1E77E13D0[string];
  }
}

- (BOOL)_processRemovedLocalAddressList:(id)list
{
  v88 = *MEMORY[0x1E69E9840];
  v76 = 0u;
  v77 = 0u;
  v78 = 0u;
  v79 = 0u;
  obj = list;
  v58 = [obj countByEnumeratingWithState:&v76 objects:v87 count:16];
  if (v58)
  {
    v62 = 0;
    theArray = 0;
    v61 = 0;
    v3 = 0;
    v4 = 0;
    v57 = *v77;
    do
    {
      v5 = 0;
      do
      {
        if (*v77 != v57)
        {
          v6 = v5;
          objc_enumerationMutation(obj);
          v5 = v6;
        }

        v59 = v5;
        address = [*(*(&v76 + 1) + 8 * v5) address];
        v8 = [address sa];

        allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];

        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v10 = allValues;
        v11 = [v10 countByEnumeratingWithState:&v72 objects:v86 count:16];
        if (v11)
        {
          v12 = *v73;
          do
          {
            for (i = 0; i != v11; ++i)
            {
              if (*v73 != v12)
              {
                objc_enumerationMutation(v10);
              }

              v14 = *(*(&v72 + 1) + 8 * i);
              local = [v14 local];
              v16 = IsSameIP(v8, [local address]);

              if (v16)
              {
                if (v4 || (v4 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
                {
                  candidatePairToken = [v14 candidatePairToken];
                  v18 = candidatePairToken == 0;

                  if (!v18)
                  {
                    candidatePairToken2 = [v14 candidatePairToken];
                    CFArrayAppendValue(v4, candidatePairToken2);
                  }
                }

                v20 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
                {
                  candidatePairToken3 = [v14 candidatePairToken];
                  *buf = 138412290;
                  v81 = candidatePairToken3;
                  _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "remove candidate pair %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    candidatePairToken4 = [v14 candidatePairToken];
                    _IDSLogTransport(@"GL", @"IDS", @"remove candidate pair %@.");

                    if (_IDSShouldLog())
                    {
                      candidatePairToken4 = [v14 candidatePairToken];
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove candidate pair %@.");
                    }
                  }
                }

                [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v14 withReason:1, candidatePairToken4];
                LOBYTE(v62) = [v14 isActive] | v62;
                HIDWORD(v62) |= [v14 isNominated];
              }
            }

            v11 = [v10 countByEnumeratingWithState:&v72 objects:v86 count:16];
          }

          while (v11);
        }

        allValues2 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];

        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v61 = allValues2;
        v23 = [v61 countByEnumeratingWithState:&v68 objects:v85 count:16];
        if (v23)
        {
          v24 = *v69;
          do
          {
            for (j = 0; j != v23; ++j)
            {
              if (*v69 != v24)
              {
                objc_enumerationMutation(v61);
              }

              v26 = *(*(&v68 + 1) + 8 * j);
              local2 = [v26 local];
              v28 = IsSameIP(v8, [local2 address]);

              if (v28)
              {
                if (theArray || (theArray = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
                {
                  candidatePairToken5 = [v26 candidatePairToken];
                  v30 = candidatePairToken5 == 0;

                  if (!v30)
                  {
                    candidatePairToken6 = [v26 candidatePairToken];
                    CFArrayAppendValue(theArray, candidatePairToken6);
                  }
                }

                else
                {
                  theArray = 0;
                }

                v32 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
                {
                  candidatePairToken7 = [v26 candidatePairToken];
                  *buf = 138412290;
                  v81 = candidatePairToken7;
                  _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "remove stun check pair %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    candidatePairToken4 = [v26 candidatePairToken];
                    _IDSLogTransport(@"GL", @"IDS", @"remove stun check pair %@.");

                    if (_IDSShouldLog())
                    {
                      candidatePairToken4 = [v26 candidatePairToken];
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove stun check pair %@.");
                    }
                  }
                }
              }
            }

            v23 = [v61 countByEnumeratingWithState:&v68 objects:v85 count:16];
          }

          while (v23);
        }

        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v34 = self->_localCandidateList;
        v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v64 objects:v84 count:16];
        if (v35)
        {
          v36 = *v65;
          do
          {
            for (k = 0; k != v35; ++k)
            {
              if (*v65 != v36)
              {
                objc_enumerationMutation(v34);
              }

              v38 = *(*(&v64 + 1) + 8 * k);
              if (IsSameIP(v8, [v38 address]))
              {
                if (!v3)
                {
                  v3 = objc_alloc_init(MEMORY[0x1E695DF70]);
                }

                if (v38)
                {
                  v39 = v3 == 0;
                }

                else
                {
                  v39 = 1;
                }

                if (!v39)
                {
                  CFArrayAppendValue(v3, v38);
                }

                v40 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
                {
                  *buf = 138412290;
                  v81 = v38;
                  _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "remove local candidate %@.", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    candidatePairToken4 = v38;
                    _IDSLogTransport(@"GL", @"IDS", @"remove local candidate %@.");
                    if (_IDSShouldLog())
                    {
                      candidatePairToken4 = v38;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"remove local candidate %@.");
                    }
                  }
                }
              }
            }

            v35 = [(NSMutableArray *)v34 countByEnumeratingWithState:&v64 objects:v84 count:16];
          }

          while (v35);
        }

        v5 = v59 + 1;
      }

      while (v59 + 1 != v58);
      v58 = [obj countByEnumeratingWithState:&v76 objects:v87 count:16];
    }

    while (v58);
  }

  else
  {
    v62 = 0;
    theArray = 0;
    v61 = 0;
    v3 = 0;
    v4 = 0;
  }

  if ([(__CFArray *)v4 count])
  {
    [(NSMutableDictionary *)self->_tokenToCandidatePairs removeObjectsForKeys:v4];
    v41 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
    {
      allValues3 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
      *buf = 138412290;
      v81 = allValues3;
      _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "remaining candidate pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        candidatePairToken4 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining candidate pairs: %@.");

        if (_IDSShouldLog())
        {
          candidatePairToken4 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining candidate pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)theArray count])
  {
    [(NSMutableDictionary *)self->_tokenToStunCheckPairs removeObjectsForKeys:theArray];
    v43 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
    {
      allValues4 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
      *buf = 138412290;
      v81 = allValues4;
      _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "remaining stun check pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        allValues5 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining stun check pairs: %@.");

        if (_IDSShouldLog())
        {
          allValues5 = [(NSMutableDictionary *)self->_tokenToStunCheckPairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining stun check pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)v3 count])
  {
    [(NSMutableArray *)self->_localCandidateList removeObjectsInArray:v3];
    v45 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
    {
      localCandidateList = self->_localCandidateList;
      *buf = 138412290;
      v81 = localCandidateList;
      _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "remaining local candidates: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v55 = self->_localCandidateList;
        _IDSLogTransport(@"GL", @"IDS", @"remaining local candidates: %@.");
        if (_IDSShouldLog())
        {
          v55 = self->_localCandidateList;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining local candidates: %@.");
        }
      }
    }

    [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:obj, v55];
  }

  [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:0 removeList:obj];
  v47 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
  {
    interfaceAddressArray = self->_interfaceAddressArray;
    *buf = 138412290;
    v81 = interfaceAddressArray;
    _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "remaining local address list: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"remaining local address list: %@.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining local address list: %@.");
      }
    }
  }

  if ((v62 | BYTE4(v62)))
  {
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      v50 = @"NO";
      if (v62)
      {
        v51 = @"YES";
      }

      else
      {
        v51 = @"NO";
      }

      if ((v62 & 0x100000000) != 0)
      {
        v50 = @"YES";
      }

      *buf = 138412546;
      v81 = v51;
      v82 = 2112;
      v83 = v50;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "default/nominated link is removed(default:%@, nominated:%@).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"default/nominated link is removed(default:%@, nominated:%@).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"default/nominated link is removed(default:%@, nominated:%@).");
        }
      }
    }
  }

  return (v62 | BYTE4(v62)) & 1;
}

- (void)_processNewLocalAddressList:(id)list
{
  v43 = *MEMORY[0x1E69E9840];
  listCopy = list;
  selfCopy = self;
  [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:listCopy removeList:0];
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    interfaceAddressArray = self->_interfaceAddressArray;
    *buf = 138412290;
    v42 = interfaceAddressArray;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "current local address list: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v29 = self->_interfaceAddressArray;
      _IDSLogTransport(@"GL", @"IDS", @"current local address list: %@.");
      if (_IDSShouldLog())
      {
        v29 = self->_interfaceAddressArray;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"current local address list: %@.");
      }
    }
  }

  v38 = 0u;
  v39 = 0u;
  v36 = 0u;
  v37 = 0u;
  obj = listCopy;
  v35 = [obj countByEnumeratingWithState:&v36 objects:v40 count:16];
  if (!v35)
  {

    v32 = 0;
LABEL_43:
    v27 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "no new valid local address is found, ignore.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"no new valid local address is found, ignore.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"no new valid local address is found, ignore.");
        }
      }
    }

    goto LABEL_57;
  }

  v32 = 0;
  v7 = 0;
  v30 = 1;
  v34 = *v37;
  do
  {
    for (i = 0; i != v35; ++i)
    {
      if (*v37 != v34)
      {
        objc_enumerationMutation(obj);
      }

      v9 = *(*(&v36 + 1) + 8 * i);
      address = [v9 address];
      v11 = address == 0;

      if (!v11)
      {
        address2 = [v9 address];
        v13 = IsLinkLocalSA([address2 sa]);

        if (!v13)
        {
          address3 = [v9 address];
          v15 = *([address3 sa] + 1);

          isCellular = [v9 isCellular];
          if (isCellular)
          {
            v17 = +[IDSCellularLinkMonitor sharedInstance];
            LODWORD(v18) = [v17 radioAccessTechnology];

            if (v18 >= 0xA)
            {
              v18 = 10;
            }

            else
            {
              v18 = v18;
            }
          }

          else if ([v9 isWired])
          {
            v18 = 9;
          }

          else
          {
            v18 = 0;
          }

          if (v15 == 30)
          {
            v19 = 6;
          }

          else
          {
            v19 = 5;
          }

          LocalMTU = GLUtilGetLocalMTU(v19, isCellular);
          index = [v9 index];
          address4 = [v9 address];
          v23 = [address4 sa];
          address5 = [v9 address];
          v29 = [address5 sa];
          v25 = [IDSStunCandidate candidateWithType:0 transport:1 radioAccessTechnology:v18 mtu:LocalMTU index:index address:v23 external:?];

          if ([(IDSGlobalLink *)selfCopy _addCandidate:v25 isRemoteCandidate:0])
          {
            [(IDSGlobalLink *)selfCopy _addStunCheckPair:v25 isRemoteCandidate:0];
          }

          if (v15 != 30)
          {
            if (selfCopy->_allowP2P)
            {
              [(IDSGlobalLink *)selfCopy _requestSelfAllocationForInterfaceAddress:v9];
            }

            v30 = 0;
          }

          v7 = 1;
          v32 = v25;
        }
      }
    }

    v35 = [obj countByEnumeratingWithState:&v36 objects:v40 count:16];
  }

  while (v35);

  if ((v7 & 1) == 0)
  {
    goto LABEL_43;
  }

  if (v30)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "new address list is IPv6 only, send connection data.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"new address list is IPv6 only, send connection data.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"new address list is IPv6 only, send connection data.");
        }
      }
    }

LABEL_56:
    [(IDSGlobalLink *)selfCopy _sendConnectionDataWithRemovedAddressList:0];
    goto LABEL_57;
  }

  if (!selfCopy->_allowP2P)
  {
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "p2p is disabled, so send connection data immediately.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"p2p is disabled, so send connection data immediately.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"p2p is disabled, so send connection data immediately.");
        }
      }
    }

    goto LABEL_56;
  }

LABEL_57:
}

- (BOOL)_isSlicedCellularInterfaceActive:(unsigned int)active
{
  v19 = *MEMORY[0x1E69E9840];
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v15;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v15 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v14 + 1) + 8 * i);
        if ([v9 index] == active)
        {
          v11 = +[IDSCellularLinkMonitor sharedInstance];
          name = [v9 name];
          v10 = [v11 isSlicedCellularInterfaceActive:name];

          goto LABEL_11;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v10 = 0;
LABEL_11:

  return v10;
}

- (BOOL)_isCLAT46Interface:(sockaddr *)interface
{
  v19 = *MEMORY[0x1E69E9840];
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v15;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v15 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v14 + 1) + 8 * i);
        address = [v9 address];
        v11 = [address sa];

        if (IsSameSA(v11, interface) && [v9 clat46] && interface->sa_family == 2)
        {
          v12 = 1;
          goto LABEL_13;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v12 = 0;
LABEL_13:

  return v12;
}

- (BOOL)_isInterfaceExpensiveWithInterfaceIndex:(unsigned int)index
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v12 + 1) + 8 * i);
        if ([v9 index] == index)
        {
          expensive = [v9 expensive];
          goto LABEL_11;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  expensive = 0;
LABEL_11:

  return expensive;
}

- (BOOL)_isInterfaceConstrainedWithInterfaceIndex:(unsigned int)index
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v12 + 1) + 8 * i);
        if ([v9 index] == index && (objc_msgSend(v9, "constrained") & 1) != 0)
        {
          v10 = 1;
          goto LABEL_12;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v10 = 0;
LABEL_12:

  return v10;
}

- (BOOL)_isInterfaceDelegatedWithInterfaceIndex:(unsigned int)index
{
  v18 = *MEMORY[0x1E69E9840];
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v14;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        if ([v9 index] == index)
        {
          delegatedName = [v9 delegatedName];

          if (delegatedName)
          {
            v11 = 1;
            goto LABEL_12;
          }
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v13 objects:v17 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_12:

  return v11;
}

- (id)_interfaceNameForInterfaceIndex:(unsigned int)index
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = self->_interfaceAddressArray;
  v5 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    name = &stru_1F1AC8480;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v10 = *(*(&v12 + 1) + 8 * i);
        if ([v10 index] == index)
        {
          name = [v10 name];
          goto LABEL_12;
        }
      }

      v6 = [(NSMutableArray *)v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    name = &stru_1F1AC8480;
  }

LABEL_12:

  return name;
}

- (id)_interfaceNameForInterfaceIndexIncludingVPN:(unsigned int)n
{
  v30 = *MEMORY[0x1E69E9840];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v5 = self->_interfaceAddressArray;
  v6 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v24 objects:v29 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v25;
LABEL_3:
    v9 = 0;
    while (1)
    {
      if (*v25 != v8)
      {
        objc_enumerationMutation(v5);
      }

      v10 = *(*(&v24 + 1) + 8 * v9);
      if ([v10 index] == n)
      {
        break;
      }

      if (v7 == ++v9)
      {
        v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v24 objects:v29 count:16];
        if (v7)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    name = [v10 name];
    delegatedIndex = [v10 delegatedIndex];

    if (!delegatedIndex)
    {
      name2 = name;
      goto LABEL_23;
    }

    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v5 = self->_interfaceAddressArray;
    v14 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v20 objects:v28 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v21;
      while (2)
      {
        for (i = 0; i != v15; ++i)
        {
          if (*v21 != v16)
          {
            objc_enumerationMutation(v5);
          }

          v18 = *(*(&v20 + 1) + 8 * i);
          if ([v18 index] == delegatedIndex)
          {
            name2 = [v18 name];

            goto LABEL_21;
          }
        }

        v15 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v20 objects:v28 count:16];
        if (v15)
        {
          continue;
        }

        break;
      }
    }

    name2 = name;
  }

  else
  {
LABEL_9:
    name = 0;
    name2 = 0;
  }

LABEL_21:

LABEL_23:

  return name2;
}

- (void)_processRemovedRemoteCandidates:(id)candidates
{
  v61 = *MEMORY[0x1E69E9840];
  candidatesCopy = candidates;
  selfCopy = self;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v54 = 0u;
  v55 = 0u;
  v52 = 0u;
  obj = v53 = 0u;
  v4 = [obj countByEnumeratingWithState:&v52 objects:v60 count:16];
  if (v4)
  {
    theArray = 0;
    v42 = *v53;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v53 != v42)
        {
          objc_enumerationMutation(obj);
        }

        v6 = *(*(&v52 + 1) + 8 * i);
        candidatePairToken = [v6 candidatePairToken];
        if ([v6 isRelayStunCandidatePair])
        {
          relayRemote = [v6 relayRemote];
          address = [relayRemote address];

          v50 = 0u;
          v51 = 0u;
          v48 = 0u;
          v49 = 0u;
          remote = candidatesCopy;
          v11 = [remote countByEnumeratingWithState:&v48 objects:v59 count:16];
          if (v11)
          {
            v12 = *v49;
            while (2)
            {
              for (j = 0; j != v11; ++j)
              {
                if (*v49 != v12)
                {
                  objc_enumerationMutation(remote);
                }

                address2 = [*(*(&v48 + 1) + 8 * j) address];
                if (address2 != 0 && address != 0 && IsSameIP(address2, address))
                {
                  v16 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412290;
                    v58 = candidatePairToken;
                    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "remote interface is removed, disconnect relay candidate pair %@.", buf, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v35 = candidatePairToken;
                      _IDSLogTransport(@"GL", @"IDS", @"remote interface is removed, disconnect relay candidate pair %@.");
                      if (_IDSShouldLog())
                      {
                        v35 = candidatePairToken;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"remote interface is removed, disconnect relay candidate pair %@.");
                      }
                    }
                  }

                  if ([v6 isQUIC])
                  {
                    [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:candidatePairToken reason:2];
                  }

                  else
                  {
                    [(IDSGlobalLink *)selfCopy _sendUnallocbindRequest:candidatePairToken stunMessage:0 reason:2];
                  }

                  goto LABEL_38;
                }
              }

              v11 = [remote countByEnumeratingWithState:&v48 objects:v59 count:16];
              if (v11)
              {
                continue;
              }

              break;
            }
          }
        }

        else
        {
          remote = [v6 remote];
          if ([candidatesCopy containsObject:remote])
          {
            [(IDSGlobalLink *)selfCopy _notifyCandidatePairDisconnected:v6 withReason:2];
            v15 = theArray;
            if (theArray || (v15 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              if (candidatePairToken)
              {
                CFArrayAppendValue(v15, candidatePairToken);
              }
            }

            theArray = v15;
            v17 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v58 = candidatePairToken;
              _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "remove candidate pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v35 = candidatePairToken;
                _IDSLogTransport(@"GL", @"IDS", @"remove candidate pair %@.");
                if (_IDSShouldLog())
                {
                  v35 = candidatePairToken;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remove candidate pair %@.");
                }
              }
            }
          }
        }

LABEL_38:
      }

      v4 = [obj countByEnumeratingWithState:&v52 objects:v60 count:16];
    }

    while (v4);
  }

  else
  {
    theArray = 0;
  }

  allValues = [(NSMutableDictionary *)selfCopy->_tokenToStunCheckPairs allValues];

  v46 = 0u;
  v47 = 0u;
  v44 = 0u;
  v45 = 0u;
  v19 = allValues;
  v20 = 0;
  v21 = [v19 countByEnumeratingWithState:&v44 objects:v56 count:16];
  if (v21)
  {
    v22 = *v45;
    do
    {
      for (k = 0; k != v21; ++k)
      {
        if (*v45 != v22)
        {
          objc_enumerationMutation(v19);
        }

        v24 = *(*(&v44 + 1) + 8 * k);
        if (([v24 isRelayStunCandidatePair] & 1) == 0)
        {
          remote2 = [v24 remote];
          v26 = [candidatesCopy containsObject:remote2];

          if (v26)
          {
            candidatePairToken2 = [v24 candidatePairToken];
            if (v20 || (v20 = objc_alloc_init(MEMORY[0x1E695DF70])) != 0)
            {
              if (candidatePairToken2)
              {
                CFArrayAppendValue(v20, candidatePairToken2);
              }
            }

            v28 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v58 = candidatePairToken2;
              _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "remove stun check pair %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v35 = candidatePairToken2;
                _IDSLogTransport(@"GL", @"IDS", @"remove stun check pair %@.");
                if (_IDSShouldLog())
                {
                  v35 = candidatePairToken2;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"remove stun check pair %@.");
                }
              }
            }
          }
        }
      }

      v21 = [v19 countByEnumeratingWithState:&v44 objects:v56 count:16];
    }

    while (v21);
  }

  if ([candidatesCopy count])
  {
    [(NSMutableArray *)selfCopy->_remoteCandidateList removeObjectsInArray:candidatesCopy];
  }

  v29 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
  {
    remoteCandidateList = selfCopy->_remoteCandidateList;
    *buf = 138412290;
    v58 = remoteCandidateList;
    _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "remaining remote candidates: %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = selfCopy->_remoteCandidateList;
      _IDSLogTransport(@"GL", @"IDS", @"remaining remote candidates: %@.");
      if (_IDSShouldLog())
      {
        v35 = selfCopy->_remoteCandidateList;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining remote candidates: %@.");
      }
    }
  }

  if ([(__CFArray *)theArray count])
  {
    [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs removeObjectsForKeys:theArray];
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      allValues2 = [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs allValues];
      *buf = 138412290;
      v58 = allValues2;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "remaining candidate pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        allValues3 = [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining candidate pairs: %@.");

        if (_IDSShouldLog())
        {
          allValues3 = [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining candidate pairs: %@.");
        }
      }
    }
  }

  if ([(__CFArray *)v20 count])
  {
    [(NSMutableDictionary *)selfCopy->_tokenToStunCheckPairs removeObjectsForKeys:v20];
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      allValues4 = [(NSMutableDictionary *)selfCopy->_tokenToStunCheckPairs allValues];
      *buf = 138412290;
      v58 = allValues4;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "remaining stun check pairs: %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        allValues5 = [(NSMutableDictionary *)selfCopy->_tokenToStunCheckPairs allValues];
        _IDSLogTransport(@"GL", @"IDS", @"remaining stun check pairs: %@.");

        if (_IDSShouldLog())
        {
          allValues6 = [(NSMutableDictionary *)selfCopy->_tokenToStunCheckPairs allValues];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"remaining stun check pairs: %@.");
        }
      }
    }
  }
}

- (void)_processNewRemoteCandidates:(id)candidates
{
  v19 = *MEMORY[0x1E69E9840];
  candidatesCopy = candidates;
  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v18 = candidatesCopy;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "new remote candidates %@.", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v11 = candidatesCopy;
      _IDSLogTransport(@"GL", @"IDS", @"new remote candidates %@.");
      if (_IDSShouldLog())
      {
        v11 = candidatesCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"new remote candidates %@.");
      }
    }
  }

  v14 = 0u;
  v15 = 0u;
  v12 = 0u;
  v13 = 0u;
  v6 = candidatesCopy;
  v7 = [v6 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v7)
  {
    v8 = *v13;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v13 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v12 + 1) + 8 * i);
        if ([(IDSGlobalLink *)self _addCandidate:v10 isRemoteCandidate:1, v11])
        {
          [(IDSGlobalLink *)self _addStunCheckPair:v10 isRemoteCandidate:1];
        }
      }

      v7 = [v6 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v7);
  }
}

- (void)_setupRelayConnectionForNetworkAddressChangesHelper
{
  objc_initWeak(&location, self);
  v2[0] = MEMORY[0x1E69E9820];
  v2[1] = 3221225472;
  v2[2] = sub_1A7BAC058;
  v2[3] = &unk_1E77E0FC8;
  objc_copyWeak(&v3, &location);
  IDSTransportThreadAddBlock(v2);
  objc_destroyWeak(&v3);
  objc_destroyWeak(&location);
}

- (void)_setupRelayConnectionForNetworkAddressChanges
{
  v67 = *MEMORY[0x1E69E9840];
  [(IDSGlobalLink *)self _updateAllLinks];
  selfCopy = self;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v49 = GLUtilGetSharedSessionIDs(allValues);

  if ([v49 count])
  {
    v4 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(selfCopy2) = [v49 count];
      _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "set up new QR link for %d shared session(s).", buf, 8u);
    }

    v57 = 0u;
    v58 = 0u;
    v55 = 0u;
    v56 = 0u;
    v5 = v49;
    v6 = [v5 countByEnumeratingWithState:&v55 objects:v66 count:16];
    if (v6)
    {
      v7 = *v56;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v56 != v7)
          {
            objc_enumerationMutation(v5);
          }

          v9 = *(*(&v55 + 1) + 8 * i);
          v10 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            selfCopy2 = v9;
            _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "set up new QR link for shared session %@.", buf, 0xCu);
          }

          allValues2 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
          HasSharedRelayCandidatePairSucceededOrConnected = GLUtilHasSharedRelayCandidatePairSucceededOrConnected(v9, allValues2);

          if (HasSharedRelayCandidatePairSucceededOrConnected)
          {
            [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:v9];
          }
        }

        v6 = [v5 countByEnumeratingWithState:&v55 objects:v66 count:16];
      }

      while (v6);
    }
  }

  else if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:1])
  {
    if (self->_allowOnlyOneQR)
    {
      v13 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "skip set up new relay link because only one QR link is allowed.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip set up new relay link because only one QR link is allowed.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip set up new relay link because only one QR link is allowed.");
          }
        }
      }
    }

    else
    {
      v18 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "set up new QR link additionally with existing connected pair", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"set up new QR link additionally with existing connected pair");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"set up new QR link additionally with existing connected pair");
          }
        }
      }

      [(IDSGlobalLink *)self _setupNewQRLinkIfNecessary:0];
    }
  }

  else if (self->_allowOnlyOneQR)
  {
    if (!self->_connectReadyHandler)
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v15 = objc_opt_respondsToSelector();

      if (v15)
      {
        v16 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          selfCopy2 = self;
          _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "all links are removed due to interface change, disconnect %@ immediately.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"all links are removed due to interface change, disconnect %@ immediately.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"all links are removed due to interface change, disconnect %@ immediately.");
            }
          }
        }

        v17 = objc_loadWeakRetained(&self->_delegate);
        [v17 link:self didDisconnectOverCloud:0 cbuuid:self->_cbuuid];
      }
    }
  }

  else if (GLUtilHasDefaultInterface(self->_interfaceAddressArray))
  {
    v19 = [(IDSGlobalLink *)self _hasActiveAllocbindFailoverTimerForSessionID:self->_acceptedRelaySessionID];
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v21 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v22 = @"NO";
      v23 = _IDSLinkStateStrings[self->_state];
      if (v19)
      {
        v22 = @"YES";
      }

      *buf = 134218498;
      selfCopy2 = v21;
      v62 = 2112;
      v63 = v22;
      v64 = 2080;
      v65 = v23;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
      v25 = v19 ? @"YES" : @"NO";
      v47 = v25;
      v48 = _IDSLinkStateStrings[selfCopy->_state];
      v46 = v24;
      _IDSLogTransport(@"GL", @"IDS", @"all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s");
      if (_IDSShouldLog())
      {
        v26 = [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs count:v46];
        v47 = v25;
        v48 = _IDSLinkStateStrings[selfCopy->_state];
        v46 = v26;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"all links are removed due to interface change, set up QR link now. %lu, hasActiveAllocbindFailoverTimer: %@, GL state = %s");
      }
    }

    if (v19 || selfCopy->_state == 2)
    {
      v27 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        acceptedRelaySessionID = selfCopy->_acceptedRelaySessionID;
        *buf = 138412290;
        selfCopy2 = acceptedRelaySessionID;
        _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "try to reconnect to the QR server, accepted relay sessionID: %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v46 = selfCopy->_acceptedRelaySessionID;
          _IDSLogTransport(@"GL", @"IDS", @"try to reconnect to the QR server, accepted relay sessionID: %@");
          if (_IDSShouldLog())
          {
            v46 = selfCopy->_acceptedRelaySessionID;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"try to reconnect to the QR server, accepted relay sessionID: %@");
          }
        }
      }

      connectingCandidatePairSessionInfo = selfCopy->_connectingCandidatePairSessionInfo;
      if (connectingCandidatePairSessionInfo && (v30 = selfCopy->_acceptedRelaySessionID) != 0 && (v31 = CFDictionaryGetValue(connectingCandidatePairSessionInfo, v30)) != 0)
      {
        v32 = v31;
        [(NSMutableDictionary *)selfCopy->_tokenToCandidatePairs allValues];
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v33 = v52 = 0u;
        v34 = [v33 countByEnumeratingWithState:&v51 objects:v59 count:16];
        if (v34)
        {
          v35 = *v52;
LABEL_67:
          v36 = 0;
          while (1)
          {
            if (*v52 != v35)
            {
              objc_enumerationMutation(v33);
            }

            v37 = *(*(&v51 + 1) + 8 * v36);
            sessionID = [v37 sessionID];
            v39 = [sessionID isEqualToString:selfCopy->_acceptedRelaySessionID];

            if (v39)
            {
              break;
            }

            if (v34 == ++v36)
            {
              v34 = [v33 countByEnumeratingWithState:&v51 objects:v59 count:16];
              if (v34)
              {
                goto LABEL_67;
              }

              goto LABEL_73;
            }
          }

          v44 = v37;

          if (!v44)
          {
            goto LABEL_94;
          }

          if (selfCopy->_useLinkEngine)
          {
            [(IDSGlobalLink *)selfCopy _updateAllLinks];
          }

          else
          {
            [(IDSGlobalLink *)selfCopy _handleAllocbindFailoverTimerWithTransportScoreCards:v44 failoverTimerOnCandidatePair:0 onInterface:0];
          }
        }

        else
        {
LABEL_73:

LABEL_94:
          v45 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "couldn't find candidatePair for accepted session, return", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"couldn't find candidatePair for accepted session, return");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"couldn't find candidatePair for accepted session, return");
              }
            }
          }
        }
      }

      else
      {
        v41 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "couldn't find accepted session, return", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"couldn't find accepted session, return");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"couldn't find accepted session, return");
            }
          }
        }
      }
    }

    else
    {
      v42 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
      {
        v43 = _IDSLinkStateStrings[selfCopy->_state];
        *buf = 136315138;
        selfCopy2 = v43;
        _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "state = %s, try to setup New QR Link ", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v46 = _IDSLinkStateStrings[selfCopy->_state];
          _IDSLogTransport(@"GL", @"IDS", @"state = %s, try to setup New QR Link ");
          if (_IDSShouldLog())
          {
            v46 = _IDSLinkStateStrings[selfCopy->_state];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"state = %s, try to setup New QR Link ");
          }
        }
      }

      [(IDSGlobalLink *)selfCopy _setupNewQRLinkIfNecessary:0, v46, v47, v48];
    }
  }

  else
  {
    v40 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "default interface is not ready, skip setting up QR link.", buf, 2u);
    }
  }
}

- (void)handleNetworkAddressChanges:(BOOL)changes hasIPv6AddressChange:(BOOL)change
{
  changeCopy = change;
  v79 = *MEMORY[0x1E69E9840];
  changesCopy = changes;
  if (changes || change)
  {
    if (self->_hasStarted)
    {
      changeCopy2 = change;
      v5 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
      {
        v6 = @"NO";
        if (changesCopy)
        {
          v7 = @"YES";
        }

        else
        {
          v7 = @"NO";
        }

        if (changeCopy)
        {
          v6 = @"YES";
        }

        *buf = 138412546;
        v76 = v7;
        v77 = 2112;
        v78 = v6;
        _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "handleNetworkAddressChange (IPv4:%@, IPv6:%@).", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
      {
        v8 = changesCopy ? @"YES" : @"NO";
        v9 = changeCopy2 ? @"YES" : @"NO";
        v54 = v8;
        v56 = v9;
        _IDSLogTransport(@"GL", @"IDS", @"handleNetworkAddressChange (IPv4:%@, IPv6:%@).");
        if (_IDSShouldLog())
        {
          v54 = v8;
          v56 = v9;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"handleNetworkAddressChange (IPv4:%@, IPv6:%@).");
        }
      }

      selfCopy5 = self;
      v11 = !self->_disallowWiFi;
      v12 = !self->_disallowCellular;
      if (self->_QUICForQREnabled)
      {
        if (![(IDSNWLink *)self->_nwLink hasListener])
        {
          v16 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddressWithNWLink:self->_QRIPv6Enabled wantsWiFi:v11 wantsCellular:v12];
          v14 = [v16 mutableCopy];

          selfCopy5 = self;
          v13 = self->_interfaceAddressArray;
          copyCurrentNetworkInterfaces = 0;
          goto LABEL_44;
        }

        v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
        copyCurrentNetworkInterfaces = [(IDSNWLink *)self->_nwLink copyCurrentNetworkInterfaces];
        [(NSMutableArray *)v13 addObjectsFromArray:copyCurrentNetworkInterfaces];
        v14 = 0;
        goto LABEL_43;
      }

      if (changesCopy)
      {
        if ([(IDSUDPLink *)self->_udpLink socket]!= -1)
        {
          copyCurrentNetworkInterfaces = [(IDSUDPLink *)self->_udpLink copyCurrentNetworkInterfaces];
          v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
          [(NSMutableArray *)v13 addObjectsFromArray:copyCurrentNetworkInterfaces];
          v14 = 0;
          selfCopy5 = self;
LABEL_37:
          if (!changeCopy2)
          {
            goto LABEL_44;
          }

          if ([(IDSUDPLink *)selfCopy5->_udpLinkv6 socket]== -1)
          {
            v19 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:1 wantsWiFi:v11 wantsCellular:v12];
            v20 = [v19 mutableCopy];

            v21 = self->_interfaceAddressArray;
            v14 = v20;
            v13 = v21;
          }

          else
          {
            copyCurrentNetworkInterfaces2 = [(IDSUDPLink *)self->_udpLinkv6 copyCurrentNetworkInterfaces];

            if (!v13)
            {
              v13 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            [(NSMutableArray *)v13 addObjectsFromArray:copyCurrentNetworkInterfaces2, v54, v56];
            copyCurrentNetworkInterfaces = copyCurrentNetworkInterfaces2;
          }

LABEL_43:
          selfCopy5 = self;
LABEL_44:
          [(IDSGlobalLink *)selfCopy5 _delayProcessingCellularInterfaces:v13, v54];
          v63 = [IDSInterfaceAddress addressesFromInterfaceAddresses:v13];
          v22 = [IDSInterfaceAddress addressesFromInterfaceAddresses:self->_interfaceAddressArray];
          v71 = 0u;
          v72 = 0u;
          v69 = 0u;
          v70 = 0u;
          obj = v13;
          v23 = [(NSMutableArray *)obj countByEnumeratingWithState:&v69 objects:v74 count:16];
          if (v23)
          {
            v24 = *v70;
            do
            {
              for (i = 0; i != v23; ++i)
              {
                if (*v70 != v24)
                {
                  objc_enumerationMutation(obj);
                }

                v26 = *(*(&v69 + 1) + 8 * i);
                address = [v26 address];
                v28 = [v22 containsObject:address];

                if ((v28 & 1) == 0)
                {
                  if (!v14)
                  {
                    v14 = objc_alloc_init(MEMORY[0x1E695DF70]);
                  }

                  if (v26)
                  {
                    v29 = v14 == 0;
                  }

                  else
                  {
                    v29 = 1;
                  }

                  if (!v29)
                  {
                    CFArrayAppendValue(v14, v26);
                  }
                }
              }

              v23 = [(NSMutableArray *)obj countByEnumeratingWithState:&v69 objects:v74 count:16];
            }

            while (v23);
          }

          v57 = [v14 count];
          if (v57)
          {
            v30 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v76 = v14;
              _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "new local address list: %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v55 = v14;
                _IDSLogTransport(@"GL", @"IDS", @"new local address list: %@");
                if (_IDSShouldLog())
                {
                  v55 = v14;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"new local address list: %@");
                }
              }
            }

            [(IDSGlobalLink *)self _processNewLocalAddressList:v14, v55];
          }

          v67 = 0u;
          v68 = 0u;
          v65 = 0u;
          v66 = 0u;
          v31 = self->_interfaceAddressArray;
          v32 = 0;
          v33 = [(NSMutableArray *)v31 countByEnumeratingWithState:&v65 objects:v73 count:16];
          if (v33)
          {
            v34 = *v66;
            do
            {
              for (j = 0; j != v33; ++j)
              {
                if (*v66 != v34)
                {
                  objc_enumerationMutation(v31);
                }

                v36 = *(*(&v65 + 1) + 8 * j);
                address2 = [v36 address];
                v38 = [v63 containsObject:address2];

                if ((v38 & 1) == 0)
                {
                  address3 = [v36 address];
                  v40 = *([address3 sa] + 1);

                  v41 = v40 == 2 && changesCopy;
                  v42 = v40 == 30 && changeCopy2;
                  if (v41 || v42)
                  {
                    if (v32)
                    {
                      if (!v36)
                      {
                        continue;
                      }
                    }

                    else
                    {
                      v32 = objc_alloc_init(MEMORY[0x1E695DF70]);
                      if (!v36)
                      {
                        continue;
                      }
                    }

                    if (v32)
                    {
                      CFArrayAppendValue(v32, v36);
                    }
                  }
                }
              }

              v33 = [(NSMutableArray *)v31 countByEnumeratingWithState:&v65 objects:v73 count:16];
            }

            while (v33);
          }

          if ([(__CFArray *)v32 count])
          {
            v43 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v76 = v32;
              _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "removed local address list: %@.", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v55 = v32;
                _IDSLogTransport(@"GL", @"IDS", @"removed local address list: %@.");
                if (_IDSShouldLog())
                {
                  v55 = v32;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"removed local address list: %@.");
                }
              }
            }

            [(IDSGlobalLink *)self _processRemovedLocalAddressList:v32, v55];
          }

          else if (!v57)
          {
LABEL_105:

            return;
          }

          if (self->_networkAddressChangeTimer)
          {
            v44 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
            {
              networkAddressChangeTimer = self->_networkAddressChangeTimer;
              *buf = 134217984;
              v76 = networkAddressChangeTimer;
              _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "delay set up new QR link already scheduled on timer: %p", buf, 0xCu);
            }
          }

          else
          {
            v46 = im_primary_queue();
            v47 = dispatch_source_create(MEMORY[0x1E69E9710], 0, 0, v46);
            v48 = self->_networkAddressChangeTimer;
            self->_networkAddressChangeTimer = v47;

            v49 = self->_networkAddressChangeTimer;
            v50 = dispatch_time(0, 2000000000);
            dispatch_source_set_timer(v49, v50, 0x77359400uLL, 0x5F5E100uLL);
            v51 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
            {
              v52 = self->_networkAddressChangeTimer;
              *buf = 134218240;
              v76 = 0x4000000000000000;
              v77 = 2048;
              v78 = v52;
              _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "delay set up new QR link for %.3f sec timer: %p", buf, 0x16u);
            }

            v53 = self->_networkAddressChangeTimer;
            handler[0] = MEMORY[0x1E69E9820];
            handler[1] = 3221225472;
            handler[2] = sub_1A7BAD790;
            handler[3] = &unk_1E77E0818;
            handler[4] = self;
            dispatch_source_set_event_handler(v53, handler);
            dispatch_resume(self->_networkAddressChangeTimer);
          }

          goto LABEL_105;
        }

        v17 = [(IDSGlobalLink *)self _addSocketAndInterfaceAddress:0 wantsWiFi:v11 wantsCellular:v12];
        v14 = [v17 mutableCopy];

        selfCopy5 = self;
        v13 = self->_interfaceAddressArray;
      }

      else
      {
        v14 = 0;
        v13 = 0;
      }

      copyCurrentNetworkInterfaces = 0;
      goto LABEL_37;
    }

    v15 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "handleNetworkAddressChange: _hasStarted is no; return.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"handleNetworkAddressChange: _hasStarted is no; return.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"handleNetworkAddressChange: _hasStarted is no; return.");
        }
      }
    }
  }
}

- (BOOL)_interfaceName:(id)name missingFrom:(id)from
{
  v20 = *MEMORY[0x1E69E9840];
  nameCopy = name;
  fromCopy = from;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v7 = [fromCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v16;
    v10 = 1;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v16 != v9)
        {
          objc_enumerationMutation(fromCopy);
        }

        name = [*(*(&v15 + 1) + 8 * i) name];
        v13 = [name isEqualToIgnoringCase:nameCopy];

        v10 &= v13 ^ 1;
      }

      v8 = [fromCopy countByEnumeratingWithState:&v15 objects:v19 count:16];
    }

    while (v8);
  }

  else
  {
    v10 = 1;
  }

  return v10;
}

- (void)_processDelayedCellularInterfaces
{
  v9 = *MEMORY[0x1E69E9840];
  if (self->_delayedCellInterfaces)
  {
    v3 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      delayedCellInterfaces = self->_delayedCellInterfaces;
      *buf = 138412290;
      v8 = delayedCellInterfaces;
      _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "process delayed cell interfaces:%@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v6 = self->_delayedCellInterfaces;
      _IDSLogTransport(@"GL", @"IDS", @"process delayed cell interfaces:%@");
      if (_IDSShouldLog())
      {
        v6 = self->_delayedCellInterfaces;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"process delayed cell interfaces:%@");
      }
    }

    [(IDSGlobalLink *)self _processNewLocalAddressList:self->_delayedCellInterfaces, v6];
    [(IDSGlobalLink *)self _setupRelayConnectionForNetworkAddressChanges];
    v5 = self->_delayedCellInterfaces;
    self->_delayedCellInterfaces = 0;
  }
}

- (void)_handleNewRATChange
{
  v13 = *MEMORY[0x1E69E9840];
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  radioAccessTechnology = [v3 radioAccessTechnology];

  v5 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 136315138;
    v12 = IDSRadioAccessTechnologyToString(radioAccessTechnology);
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "handle cellular RAT change (newRAT:%s).", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(radioAccessTechnology);
      _IDSLogTransport(@"GL", @"IDS", @"handle cellular RAT change (newRAT:%s).");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(radioAccessTechnology);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"handle cellular RAT change (newRAT:%s).");
      }
    }
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v7 = objc_opt_respondsToSelector();

  if (v7)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = IDSRadioAccessTechnologyToString(radioAccessTechnology);
      *buf = 136315138;
      v12 = v9;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "send didRATChange, newRAT:%s.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(radioAccessTechnology);
      _IDSLogTransport(@"GL", @"IDS", @"send didRATChange, newRAT:%s.");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(radioAccessTechnology);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send didRATChange, newRAT:%s.");
      }
    }

    v10 = objc_loadWeakRetained(&self->_delegate);
    [v10 link:self didRATChange:radioAccessTechnology];
  }
}

- (void)handleCellularRATChange
{
  v33 = *MEMORY[0x1E69E9840];
  [(IDSGlobalLink *)self _handleNewRATChange];
  v3 = +[IDSCellularLinkMonitor sharedInstance];
  cellularMTU = [v3 cellularMTU];

  if (cellularMTU)
  {
    v27 = 0u;
    v28 = 0u;
    v25 = 0u;
    v26 = 0u;
    v5 = self->_localCandidateList;
    v6 = 0;
    v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v25 objects:v32 count:16];
    if (v7)
    {
      v8 = *v26;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v26 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v25 + 1) + 8 * i);
          if ([v10 isCellularStunCandidate] && objc_msgSend(v10, "mtu") != cellularMTU)
          {
            [v10 setMtu:cellularMTU];
            v6 = 1;
          }
        }

        v7 = [(NSMutableArray *)v5 countByEnumeratingWithState:&v25 objects:v32 count:16];
      }

      while (v7);
    }

    [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v23 = 0u;
    v24 = 0u;
    v21 = 0u;
    v11 = v22 = 0u;
    v12 = [v11 countByEnumeratingWithState:&v21 objects:v31 count:16];
    if (v12)
    {
      v13 = *v22;
      do
      {
        for (j = 0; j != v12; ++j)
        {
          if (*v22 != v13)
          {
            objc_enumerationMutation(v11);
          }

          local = [*(*(&v21 + 1) + 8 * j) local];
          if ([local isCellularStunCandidate] && objc_msgSend(local, "mtu") != cellularMTU)
          {
            [local setMtu:cellularMTU];
          }
        }

        v12 = [v11 countByEnumeratingWithState:&v21 objects:v31 count:16];
      }

      while (v12);
    }

    if (v6)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        v30 = cellularMTU;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send cellular MTU change event with new MTU %uB.", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v20 = cellularMTU;
          _IDSLogTransport(@"GL", @"IDS", @"send cellular MTU change event with new MTU %uB.");
          if (_IDSShouldLog())
          {
            v20 = cellularMTU;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send cellular MTU change event with new MTU %uB.");
          }
        }
      }

      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v18 = objc_opt_respondsToSelector();

      if (v18)
      {
        v19 = objc_loadWeakRetained(&self->_delegate);
        [v19 link:self didCellularMTUChange:cellularMTU];
      }
    }
  }

  [(IDSGlobalLink *)self _processDelayedCellularInterfaces];
}

- (unint64_t)headerOverhead
{
  v2 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
  if (!v2)
  {
    return 255;
  }

  v3 = 4 * (*(v2 + 132) != 0);
  v4 = *(v2 + 9);
  if (v4 == 30)
  {
    return (v3 | 0x30);
  }

  else if (v4 == 2)
  {
    return (v3 + 28);
  }

  else
  {
    return 255;
  }
}

- (NSString)linkTypeString
{
  defaultLinkType = [(IDSGlobalLink *)self defaultLinkType];
  v3 = @"GlobalLink";
  if (defaultLinkType == 4)
  {
    v3 = @"GlobalLink-WWAN";
  }

  if (defaultLinkType == 3)
  {
    return @"GlobalLink-WiFi";
  }

  else
  {
    return &v3->isa;
  }
}

- (id)copyLinkStatsDict
{
  v3 = objc_alloc(MEMORY[0x1E695DF20]);
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalBytesReceived];
  v5 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalBytesSent];
  v6 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalPacketsReceived];
  v7 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:self->_totalPacketsSent];
  v8 = [v3 initWithObjectsAndKeys:{v4, @"bytesReceived", v5, @"bytesSent", v6, @"packetsReceived", v7, @"packetsSent", 0}];

  return v8;
}

- (void)_reportSessionSetupTime
{
  v90 = *MEMORY[0x1E69E9840];
  v3 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isUPlusOneSession)
    {
      v4 = @"YES";
    }

    else
    {
      v4 = @"NO";
    }

    *buf = 138412290;
    *v80 = v4;
    _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "_reportSessionSetupTime (U+1:%@)", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
  {
    v6 = self->_isUPlusOneSession ? @"YES" : @"NO";
    v69 = v6;
    _IDSLogTransport(@"GL", @"IDS", @"_reportSessionSetupTime (U+1:%@)");
    if (_IDSShouldLog())
    {
      if (self->_isUPlusOneSession)
      {
        v7 = @"YES";
      }

      else
      {
        v7 = @"NO";
      }

      v69 = v7;
      _IDSLogV(0, @"IDSFoundation", @"GL", @"_reportSessionSetupTime (U+1:%@)");
    }
  }

  v5.i64[0] = *&self->_allocbindEndTime;
  if (self->_isInitiator && ((skeStartTime = self->_skeStartTime, skeStartTime > 0.0) || self->_isUPlusOneSession && (skeStartTime = self->_remoteJoinedUPlusOneTime, skeStartTime > 0.0)))
  {
    p_firstClientPacketTime = &self->_firstClientPacketTime;
    v10 = *&self->_linkConnectTime;
    v11 = vdupq_lane_s64(*&v10.f64[0], 0);
    v11.f64[0] = skeStartTime;
    v74 = vmovn_s64(vcvtq_s64_f64(vmulq_f64(vsubq_f64(v10, v11), vdupq_n_s64(0x408F400000000000uLL))));
  }

  else
  {
    p_firstClientPacketTime = &self->_firstClientPacketTime;
    v74 = vmovn_s64(vcvtq_s64_f64(vmulq_f64(vsubq_f64(*&self->_linkConnectTime, vzip1q_s64(v5, *&self->_linkConnectTime)), vdupq_n_s64(0x408F400000000000uLL))));
    if (!self->_isInitiator)
    {
LABEL_23:
      v12 = ((self->_firstDataReceivedTime - *v5.i64) * 1000.0);
      goto LABEL_25;
    }
  }

  if (self->_isSecondOrLaterParticipant)
  {
    goto LABEL_23;
  }

  v12 = 0;
LABEL_25:
  allocbindEndTime = self->_allocbindEndTime;
  if (self->_maxLinkID >= 2)
  {
    v13 = self->_candidatePairs[1];
  }

  else
  {
    v13 = 0;
  }

  allocbindStartTime = self->_allocbindStartTime;
  v15 = v13;
  local = [(IDSStunCandidatePair *)v15 local];
  radioAccessTechnology = [local radioAccessTechnology];

  if (radioAccessTechnology >= 0xA)
  {
    v18 = 10;
  }

  else
  {
    v18 = radioAccessTechnology;
  }

  v73 = v18;
  remote = [(IDSStunCandidatePair *)v15 remote];
  radioAccessTechnology2 = [remote radioAccessTechnology];

  if (radioAccessTechnology2 >= 0xA)
  {
    v21 = 10;
  }

  else
  {
    v21 = radioAccessTechnology2;
  }

  v72 = v21;
  v77 = 0u;
  v78 = 0u;
  v75 = 0u;
  v76 = 0u;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = [allValues countByEnumeratingWithState:&v75 objects:v89 count:16];
  if (v23)
  {
    v24 = *v76;
    while (2)
    {
      for (i = 0; i != v23; ++i)
      {
        if (*v76 != v24)
        {
          objc_enumerationMutation(allValues);
        }

        if ([*(*(&v75 + 1) + 8 * i) pendingRealloc])
        {
          v71 = 1;
          goto LABEL_44;
        }
      }

      v23 = [allValues countByEnumeratingWithState:&v75 objects:v89 count:16];
      if (v23)
      {
        continue;
      }

      break;
    }
  }

  v71 = 0;
LABEL_44:

  if (v12 >= 1)
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *v80 = v12;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "received data duration: %d ms", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"received data duration: %d ms");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"received data duration: %d ms");
        }
      }
    }

    v27 = GLUCreateQRClientTimeEvent(310, 0, v15, self->_timeBase, v12);
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v29 = objc_opt_respondsToSelector();

    if (v29)
    {
      v30 = objc_loadWeakRetained(&self->_delegate);
      [v30 link:self didAddQREvent:v27];
    }
  }

  if (self->_isInitiator)
  {
    remoteJoinedUPlusOneTime = self->_skeStartTime;
    if (remoteJoinedUPlusOneTime != 0.0 && remoteJoinedUPlusOneTime < self->_allocbindEndTime)
    {
      v33 = ((*p_firstClientPacketTime - remoteJoinedUPlusOneTime) * 1000.0);
    }

    else
    {
      v33 = vadd_s32(vdup_lane_s32(v74, 1), v74).u32[0];
    }

    v46 = vcvtd_n_f64_u32(self->_acceptDelayU32, 0x10uLL) + HIWORD(self->_acceptDelayU32);
    if (remoteJoinedUPlusOneTime == 0.0)
    {
      if (!self->_isUPlusOneSession || (remoteJoinedUPlusOneTime = self->_remoteJoinedUPlusOneTime, remoteJoinedUPlusOneTime <= 0.0))
      {
        remoteJoinedUPlusOneTime = self->_allocbindEndTime;
      }
    }

    v45 = ((remoteJoinedUPlusOneTime - self->_inviteSentTime - v46) * 1000.0);
    v47 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_isInitiator)
      {
        v48 = @"YES";
      }

      else
      {
        v48 = @"NO";
      }

      v49 = IDSRadioAccessTechnologyToString(v73);
      v50 = IDSRadioAccessTechnologyToString(v72);
      if (v71)
      {
        v51 = @"YES";
      }

      else
      {
        v51 = @"NO";
      }

      *buf = 67110914;
      *v80 = v33;
      *&v80[4] = 2112;
      *&v80[6] = v48;
      *&v80[14] = 2080;
      *&v80[16] = v49;
      *&v80[24] = 2080;
      *&v80[26] = v50;
      *&v80[34] = 1024;
      *&v80[36] = v45;
      v81 = 1024;
      v82 = v74.i32[0];
      v83 = 1024;
      v84 = v74.i32[1];
      v85 = 2112;
      v86[0] = v51;
      _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).", buf, 0x42u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        IDSRadioAccessTechnologyToString(v73);
        IDSRadioAccessTechnologyToString(v72);
        _IDSLogTransport(@"GL", @"IDS", @"got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
        if (_IDSShouldLog())
        {
          IDSRadioAccessTechnologyToString(v73);
          IDSRadioAccessTechnologyToString(v72);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"got first client packet %d ms after Accept. (Initiator:%@, localRAT:%s, remoteRAT:%s, invite_time:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
        }
      }
    }

    v41 = objc_loadWeakRetained(&self->_delegate);
    v87 = @"gl-attr-acceptdelay";
    v44 = [MEMORY[0x1E696AD98] numberWithDouble:v46 * 1000.0];
    v88 = v44;
    v52 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v88 forKeys:&v87 count:1];
    [v41 link:self didReceiveReportEvent:v52];

    goto LABEL_93;
  }

  v34 = ((allocbindEndTime - allocbindStartTime) * 1000.0);
  v33 = v74.i32[1] + v74.i32[0] + v34;
  v35 = ((self->_firstDataReceivedTime - self->_calleeAcceptTime) * 1000.0);
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v37 = @"YES";
    }

    else
    {
      v37 = @"NO";
    }

    v38 = IDSRadioAccessTechnologyToString(v73);
    v39 = IDSRadioAccessTechnologyToString(v72);
    if (v71)
    {
      v40 = @"YES";
    }

    else
    {
      v40 = @"NO";
    }

    *buf = 67111170;
    *v80 = v74.i32[1] + v74.i32[0] + v34;
    *&v80[4] = 1024;
    *&v80[6] = v35;
    *&v80[10] = 2112;
    *&v80[12] = v37;
    *&v80[20] = 2080;
    *&v80[22] = v38;
    *&v80[30] = 2080;
    *&v80[32] = v39;
    v81 = 1024;
    v82 = ((allocbindEndTime - allocbindStartTime) * 1000.0);
    v83 = 1024;
    v84 = v74.i32[0];
    v85 = 1024;
    LODWORD(v86[0]) = v74.i32[1];
    WORD2(v86[0]) = 2112;
    *(v86 + 6) = v40;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).", buf, 0x48u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      IDSRadioAccessTechnologyToString(v73);
      IDSRadioAccessTechnologyToString(v72);
      _IDSLogTransport(@"GL", @"IDS", @"got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
      if (_IDSShouldLog())
      {
        IDSRadioAccessTechnologyToString(v73);
        IDSRadioAccessTechnologyToString(v72);
        _IDSLogV(0, @"IDSFoundation", @"GL", @"got first client packet %d ms after Accept, calleeAcceptToFirstIncomingData: %d ms(Initiator:%@, localRAT:%s, remoteRAT:%s, allocbind:%d ms, session_connected:%d ms, wait_after:%d ms, realloc:%@).");
      }
    }
  }

  if (v35 >= 1)
  {
    v41 = GLUCreateQRClientTimeEvent(302, 0, v15, self->_timeBase, v35);
    v42 = objc_loadWeakRetained(&self->_delegate);
    v43 = objc_opt_respondsToSelector();

    if ((v43 & 1) == 0)
    {
      v45 = 0;
      goto LABEL_94;
    }

    v44 = objc_loadWeakRetained(&self->_delegate);
    [v44 link:self didAddQREvent:v41];
    v45 = 0;
LABEL_93:

LABEL_94:
    goto LABEL_95;
  }

  v45 = 0;
LABEL_95:
  if (v33 >= 1)
  {
    GLUtilReportAWDClientTimerEvent(301, 0, v15, self->_enableSKE, self->_isInitiator, v33);
    v53 = GLUCreateQRClientTimeEvent(301, 0, v15, self->_timeBase, v33);
    v54 = objc_loadWeakRetained(&self->_delegate);
    v55 = objc_opt_respondsToSelector();

    if (v55)
    {
      v56 = objc_loadWeakRetained(&self->_delegate);
      [v56 link:self didAddQREvent:v53];
    }
  }

  if (v74.i32[0] >= 1)
  {
    GLUtilReportAWDClientTimerEvent(305, 0, v15, self->_enableSKE, self->_isInitiator, v74.u32[0]);
    v57 = GLUCreateQRClientTimeEvent(305, 0, v15, self->_timeBase, v74.u32[0]);
    v58 = objc_loadWeakRetained(&self->_delegate);
    v59 = objc_opt_respondsToSelector();

    if (v59)
    {
      v60 = objc_loadWeakRetained(&self->_delegate);
      [v60 link:self didAddQREvent:v57];
    }
  }

  if (v74.i32[1] >= 1)
  {
    GLUtilReportAWDClientTimerEvent(303, 0, v15, self->_enableSKE, self->_isInitiator, v74.u32[1]);
    v61 = GLUCreateQRClientTimeEvent(303, 0, v15, self->_timeBase, v74.u32[1]);
    v62 = objc_loadWeakRetained(&self->_delegate);
    v63 = objc_opt_respondsToSelector();

    if (v63)
    {
      v64 = objc_loadWeakRetained(&self->_delegate);
      [v64 link:self didAddQREvent:v61];
    }
  }

  if (self->_isInitiator && v45 >= 1)
  {
    GLUtilReportAWDClientTimerEvent(306, 0, v15, self->_enableSKE, 1u, v45);
    v65 = GLUCreateQRClientTimeEvent(306, 0, v15, self->_timeBase, v45);
    v66 = objc_loadWeakRetained(&self->_delegate);
    v67 = objc_opt_respondsToSelector();

    if (v67)
    {
      v68 = objc_loadWeakRetained(&self->_delegate);
      [v68 link:self didAddQREvent:v65];
    }
  }
}

- (BOOL)_getPacketBufferSendInfo:(id *)info channelNumber:(unsigned __int16 *)number transport:(int64_t *)transport glLinkProtocol:(int64_t *)protocol
{
  v17 = *MEMORY[0x1E69E9840];
  v10 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, info->var25);
  v11 = v10;
  if (v10)
  {
    info->var16 = *(v10 + 266);
    info->var17 = *(v10 + 1);
    memcpy(&info->var18, v10 + 1, *(v10 + 8));
    memcpy(&info->var19, v11 + 17, *(v11 + 136));
    if (number)
    {
      *number = *(v11 + 132);
    }

    if (transport)
    {
      *transport = v11[34];
    }

    if (protocol)
    {
      *protocol = v11[35];
    }
  }

  else
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      var25 = info->var25;
      *buf = 67109120;
      v16 = var25;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "_getPacketBufferSendInfo failed due to invalid linkID: %d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_getPacketBufferSendInfo failed due to invalid linkID: %d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_getPacketBufferSendInfo failed due to invalid linkID: %d.");
        }
      }
    }
  }

  return v11 != 0;
}

- (void)_updateSendStatsWithResult:(unint64_t)result bytesSent:(int64_t)sent packetsSent:(int)packetsSent linkID:(char)d delegatedLinkID:(char)iD token:(id)token isClientData:(BOOL)data sendTime:(double)self0 stunTransport:(int64_t)self1 packetBuffer:(id *)self2
{
  iDCopy = iD;
  dCopy = d;
  v63 = *MEMORY[0x1E69E9840];
  tokenCopy = token;
  if (result)
  {
    v20 = +[IDSFoundationLog GlobalLink];
    v21 = os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT);
    if (iDCopy == -1)
    {
      if (v21)
      {
        v34 = GLUtilStunTransportChar(transport);
        v35 = _IDSLinkSendResultStrings[result];
        var37 = buffer->var37;
        if (buffer->var38)
        {
          v37 = "qpod";
        }

        else
        {
          v37 = "udp";
        }

        v55 = 134219522;
        sentCopy4 = sent;
        v57 = 1024;
        packetsSentCopy2 = packetsSent;
        v59 = 1024;
        v60 = v34;
        v61 = 1024;
        *v62 = dCopy;
        *&v62[4] = 2080;
        *&v62[6] = v37;
        *&v62[14] = 2048;
        *&v62[16] = var37;
        *&v62[24] = 2080;
        *&v62[26] = v35;
        v26 = "GLW failed %zdB/%1d (%c %d  %s [C%llu]) (%s)";
        v27 = v20;
        v28 = 60;
        goto LABEL_27;
      }
    }

    else if (v21)
    {
      v22 = GLUtilStunTransportChar(transport);
      v23 = _IDSLinkSendResultStrings[result];
      v24 = buffer->var37;
      if (buffer->var38)
      {
        v25 = "qpod";
      }

      else
      {
        v25 = "udp";
      }

      v55 = 134219778;
      sentCopy4 = sent;
      v57 = 1024;
      packetsSentCopy2 = packetsSent;
      v59 = 1024;
      v60 = v22;
      v61 = 1024;
      *v62 = dCopy;
      *&v62[4] = 1024;
      *&v62[6] = iDCopy;
      *&v62[10] = 2080;
      *&v62[12] = v25;
      *&v62[20] = 2048;
      *&v62[22] = v24;
      *&v62[30] = 2080;
      *&v62[32] = v23;
      v26 = "GLW failed %zdB/%1d (%c %d/%d  %s [C%llu]) (%s)";
      v27 = v20;
      v28 = 66;
LABEL_27:
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, v26, &v55, v28);
    }

    goto LABEL_51;
  }

  self->_totalPacketsSent += packetsSent;
  self->_totalBytesSent += sent;
  v29 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, dCopy);
  if (iDCopy == -1)
  {
    v30 = dCopy;
  }

  else
  {
    v30 = iDCopy;
  }

  v31 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v30);
  if (v31)
  {
    v31[38] = time;
    *(v31 + 82) += packetsSent;
    *(v31 + 42) += sent;
  }

  if (v29 && v29 != v31)
  {
    v29[38] = time;
    *(v29 + 82) += packetsSent;
    *(v29 + 42) += sent;
  }

  if (!data)
  {
    Value = 0;
    if (tokenCopy && self->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
    }

    [Value setLastOutgoingPacketTime:time];
    v39 = +[IDSFoundationLog GlobalLink];
    v40 = os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT);
    if (iDCopy == -1)
    {
      if (v40)
      {
        v48 = GLUtilStunTransportChar(transport);
        var38 = buffer->var38;
        v50 = buffer->var37;
        v55 = 134219010;
        if (var38)
        {
          v51 = "qpod";
        }

        else
        {
          v51 = "udp";
        }

        sentCopy4 = sent;
        v57 = 1024;
        packetsSentCopy2 = v48;
        v59 = 1024;
        v60 = dCopy;
        v61 = 2080;
        *v62 = v51;
        *&v62[8] = 2048;
        *&v62[10] = v50;
        v45 = "NCD %zdB (%c %d  %s [C%llu])";
        v46 = v39;
        v47 = 44;
        goto LABEL_43;
      }
    }

    else if (v40)
    {
      v41 = GLUtilStunTransportChar(transport);
      v42 = buffer->var38;
      v43 = buffer->var37;
      v55 = 134219266;
      if (v42)
      {
        v44 = "qpod";
      }

      else
      {
        v44 = "udp";
      }

      sentCopy4 = sent;
      v57 = 1024;
      packetsSentCopy2 = v41;
      v59 = 1024;
      v60 = dCopy;
      v61 = 1024;
      *v62 = iDCopy;
      *&v62[4] = 2080;
      *&v62[6] = v44;
      *&v62[14] = 2048;
      *&v62[16] = v43;
      v45 = "NCD %zdB (%c %d/%d  %s [C%llu])";
      v46 = v39;
      v47 = 50;
LABEL_43:
      _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, v45, &v55, v47);
    }

    goto LABEL_51;
  }

  if (v29 && !*(v29 + 82))
  {
    v32 = *v29;
    if ((v32 & 0x80000000) != 0 || v32 >= self->_maxLinkID)
    {
      v33 = 0;
    }

    else
    {
      v33 = self->_candidatePairs[v32];
    }

    linkMetrics = [(IDSStunCandidatePair *)v33 linkMetrics];
    [linkMetrics event:@"glr"];
  }

  kdebug_trace();
  [(IDSGlobalLink *)self reportLinkMetricsForLinkID:dCopy lastPacketReceivedTime:0.0 lastPacketSentTime:ids_monotonic_time()];
  if (v29)
  {
    packetLog = self->_packetLog;
    if (packetLog)
    {
      v54 = sub_1A7BAF110(buffer, dCopy, iDCopy, packetLog, v29);
      if (v54)
      {
        [(IDSObjCPacketLog *)self->_packetLog recordPacketsWithPacketLogID:v54 kind:0 bytes:sent packetCount:packetsSent];
      }
    }
  }

LABEL_51:
}

- (unint64_t)_prepareOutgoingChannelData:(id *)data arraySize:(int)size channelNumber:(unsigned __int16)number candidatePair:(id)pair linkID:(char)d delegatedLinkID:(char *)iD stunTransport:(int64_t)transport
{
  dCopy = d;
  numberCopy = number;
  pairCopy = pair;
  sizeCopy = size;
  if (size >= 1)
  {
    sizeCopy2 = size;
    dataCopy = data;
    do
    {
      if ((*(*dataCopy + 517) & 1) != 0 || (*(*dataCopy + 537) & 4) != 0)
      {
        if (self->_isPartialTLEUPlusOneEnabled && (-[IDSStunCandidatePair connections](pairCopy, "connections"), v16 = pairCopy, v17 = objc_claimAutoreleasedReturnValue(), [v17 objectForKeyedSubscript:@"qpod"], v18 = objc_claimAutoreleasedReturnValue(), v18, v17, pairCopy = v16, v18))
        {
          v19 = *dataCopy;
          *(v19 + 1305) = 1;
          *(v19 + 517) = 0;
          *(v19 + 134) &= ~0x400u;
        }

        else if (!numberCopy)
        {
          v22 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(&v22->super, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E161B0();
          }

          v47 = 12;
          goto LABEL_73;
        }
      }

      ++dataCopy;
      --sizeCopy2;
    }

    while (sizeCopy2);
  }

  if (!numberCopy)
  {
    v47 = 0;
    goto LABEL_74;
  }

  if (!pairCopy || (dCopy & 0x80000000) == 0)
  {
    v20 = GLUtilGetCandidatePairByLinkID(dCopy, self->_sendInfoList, self->_candidatePairs, self->_maxLinkID, self->_channelToCandidatePairs);

    pairCopy = v20;
  }

  v21 = sizeCopy;
  pairCopy = pairCopy;
  v22 = pairCopy;
  if (![(IDSStunCandidatePair *)pairCopy isVirtualRelayStunCandidatePair])
  {
    goto LABEL_22;
  }

  delegatedLinkID = [(IDSStunCandidatePair *)pairCopy delegatedLinkID];
  *iD = delegatedLinkID;
  if (delegatedLinkID < 0 || self->_maxLinkID <= delegatedLinkID)
  {

    goto LABEL_51;
  }

  v22 = self->_candidatePairs[delegatedLinkID];

  if (!v22)
  {
LABEL_51:
    v48 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16140();
    }

    if (sizeCopy >= 1)
    {
      v49 = sizeCopy;
      v47 = 9;
      do
      {
        v50 = *data++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10180, v50);
        --v49;
      }

      while (v49);
      v22 = 0;
      goto LABEL_73;
    }

    v22 = 0;
LABEL_58:
    v47 = 9;
    goto LABEL_73;
  }

  if ((numberCopy & 0xF0) != 0x60)
  {
    v56 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v56, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16058();
    }

    if (sizeCopy >= 1)
    {
      v57 = sizeCopy;
      v47 = 9;
      do
      {
        v58 = *data++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10194, v58);
        --v57;
      }

      while (v57);
      goto LABEL_73;
    }

    goto LABEL_58;
  }

  remoteRelayLinkID = [(IDSStunCandidatePair *)pairCopy remoteRelayLinkID];
  if (sizeCopy < 1)
  {
    goto LABEL_66;
  }

  v25 = sizeCopy;
  dataCopy2 = data;
  do
  {
    v27 = *dataCopy2++;
    *(v27 + 524) = remoteRelayLinkID;
    *(v27 + 520) = 1;
    --v25;
  }

  while (v25);
LABEL_22:
  if (sizeCopy < 1)
  {
    goto LABEL_66;
  }

  v64 = pairCopy;
  v28 = 0;
  v29 = sizeCopy;
  do
  {
    v30 = data[v28];
    if (*(v30 + 536))
    {
      StunUtilGetMappedParticipantID(v30, 0, v22, 0);
    }

    ++v28;
  }

  while (sizeCopy != v28);
  for (i = 0; i != sizeCopy; ++i)
  {
    v32 = data[i];
    if ((*(v32 + 537) & 4) == 0)
    {
      continue;
    }

    v33 = *v32;
    v34 = *(v32 + 2);
    hbhEncKey = [(IDSStunCandidatePair *)v22 hbhEncKey];
    v36 = IDSHBHEncryptDataWithKey(v33, v34, hbhEncKey);

    if (!v36)
    {
      v51 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16104();
      }

      v47 = 11;
      do
      {
        v52 = *data++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10213, v52);
        --v29;
      }

      while (v29);
      goto LABEL_72;
    }

    v37 = *(data[i] + 1);
    if (v37 < [v36 length])
    {
      v53 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v53, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E160C8();
      }

      do
      {
        v54 = *data++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10220, v54);
        --v29;
      }

      while (v29);

      v47 = 4;
LABEL_72:
      pairCopy = v64;
      goto LABEL_73;
    }

    v38 = [v36 length];
    v39 = data[i];
    *(v39 + 2) = v38;
    memcpy(*v39, [v36 bytes], *(data[i] + 2));
  }

  if ((numberCopy & 0xF0) != 0x60)
  {
    pairCopy = v64;
LABEL_65:
    v21 = sizeCopy;
    goto LABEL_66;
  }

  v40 = *(*data + 535);
  v41 = *(*data + 134);
  pairCopy = v64;
  if (![(IDSStunCandidatePair *)v22 useQualityMetadata]|| (v40 & 1) != 0 || (v41 & 0x80000) != 0)
  {
    goto LABEL_65;
  }

  v21 = sizeCopy;
  v42 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "QualityMonitor: packet is neither command nor echo", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"QualityMonitor: packet is neither command nor echo");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"QualityMonitor: packet is neither command nor echo");
      }
    }
  }

  qualityHandler = [(IDSStunCandidatePair *)v22 qualityHandler];
  v44 = qualityHandler;
  if (qualityHandler)
  {
    v45 = *data;
    if (*(*data + 1306) == 1)
    {
      v46 = *(v45 + 1308);
    }

    else
    {
      v46 = -1;
    }

    v60 = [qualityHandler prependQualityBytesToPacketIfNeeded:**data packetHeadroomStart:v45 + 1310 deduplicationID:v46];
    v61 = **data;
    if (v60 != v61)
    {
      IDSLinkPacketBufferAddBufferStart(*data, v60 - v61);
    }
  }

  else
  {
    v59 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v59, OS_LOG_TYPE_DEFAULT))
    {
      *v66 = 0;
      _os_log_impl(&dword_1A7AD9000, v59, OS_LOG_TYPE_DEFAULT, "QualityMonitor: no quality handler", v66, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"QualityMonitor: no quality handler");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"QualityMonitor: no quality handler");
        }
      }
    }
  }

LABEL_66:
  StunUtilPrepareOutgoingChannelData(numberCopy, data, v21, transport);
  v47 = 0;
LABEL_73:

LABEL_74:
  return v47;
}

- (unint64_t)_sendChannelDataPacketBuffer:(id *)buffer candidatePair:(id)pair
{
  v28 = *MEMORY[0x1E69E9840];
  bufferCopy = buffer;
  pairCopy = pair;
  channelNumber = [pairCopy channelNumber];
  local = [pairCopy local];
  transport = [local transport];

  v10 = ids_monotonic_time();
  local2 = [pairCopy local];
  index = [local2 index];

  local3 = [pairCopy local];
  address = [local3 address];

  remote = [pairCopy remote];
  external = [remote external];

  if (address && external)
  {
    buffer->var17 = index;
    memcpy(&buffer->var18, address, *address);
    memcpy(&buffer->var19, external, *external);
    buffer->var16 = [pairCopy isVirtualRelayStunCandidatePair];
    v17 = -[IDSGlobalLink _getLink:stunTransport:glLinkProtocol:](self, "_getLink:stunTransport:glLinkProtocol:", buffer->var18.ss_family, transport, [pairCopy glLinkProtocol]);
    linkID = [pairCopy linkID];
    if (linkID)
    {
      v19 = linkID;
    }

    else
    {
      v19 = 0xFFFFFFFFLL;
    }

    buf[0] = -1;
    v20 = [(IDSGlobalLink *)self _prepareOutgoingChannelData:&bufferCopy arraySize:1 channelNumber:channelNumber candidatePair:pairCopy linkID:v19 delegatedLinkID:buf stunTransport:transport];
    if (!v20)
    {
      _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10284, bufferCopy);
      var2 = bufferCopy->var2;
      v20 = [v17 sendPacketBuffer:? toDeviceUniqueID:? cbuuid:?];
      LOBYTE(v24) = 1;
      [(IDSGlobalLink *)self _updateSendStatsWithResult:v20 bytesSent:var2 packetsSent:1 linkID:v19 delegatedLinkID:buf[0] token:0 isClientData:v10 sendTime:v24 stunTransport:transport packetBuffer:bufferCopy];
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10288, bufferCopy);
    }
  }

  else
  {
    v22 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v27 = pairCopy;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "_sendChannelDataPacketBuffer no local or remote IP %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_sendChannelDataPacketBuffer no local or remote IP %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendChannelDataPacketBuffer no local or remote IP %@");
        }
      }
    }

    v20 = 9;
  }

  return v20;
}

- (void)_sendSyntheticPacket:(id)packet candidatePair:(id)pair
{
  v15 = *MEMORY[0x1E69E9840];
  packetCopy = packet;
  pairCopy = pair;
  if ([pairCopy useQualityMetadata])
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v12 = packetCopy;
      v13 = 2112;
      v14 = pairCopy;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "Sending synthetic packet with data %@ on candidate pair %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"Sending synthetic packet with data %@ on candidate pair %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending synthetic packet with data %@ on candidate pair %@");
        }
      }
    }

    v9 = _IDSLinkPacketBufferCreate();
    *(v9 + 1216) = [pairCopy linkID];
    v10 = [packetCopy length];
    v9[2] = v10;
    [packetCopy getBytes:*v9 length:v10];
    *(v9 + 111) = 1;
    if ([pairCopy remoteRelayLinkID])
    {
      *(v9 + 130) = 1;
      *(v9 + 262) = [pairCopy remoteRelayLinkID];
    }

    *(v9 + 153) = ids_monotonic_time();
    [(IDSGlobalLink *)self _sendChannelDataPacketBuffer:v9 candidatePair:pairCopy];
  }
}

- (unint64_t)sendPacketBuffer:(id *)buffer toDeviceUniqueID:(id)d cbuuid:(id)cbuuid
{
  v33 = *MEMORY[0x1E69E9840];
  dCopy = d;
  cbuuidCopy = cbuuid;
  v10 = ids_monotonic_time();
  if (self->_firstClientPacketTime == 0.0 && (!self->_isUPlusOneSession || buffer->var2 >= 11))
  {
    self->_firstClientPacketTime = v10;
    self->_reportClientPacketTime = 1;
    v11 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_reportDataReceivedTime)
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v28 = 138412290;
      *v29 = v12;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "sendPacketBuffer: _firstDataReceivedTime _reportDataReceivedTime: %@", &v28, 0xCu);
    }

    if (self->_reportDataReceivedTime)
    {
      [(IDSGlobalLink *)self _reportSessionSetupTime];
      self->_reportClientPacketTime = 0;
    }
  }

  v13 = buffer->var25 <= 0 && (buffer->var23 < 1 || !buffer->var24[0].var19 && (buffer->var24[0].var20 & 0x80000) == 0);
  v14 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEBUG))
  {
    defaultLinkSelector = self->_defaultLinkSelector;
    v16 = @"NO";
    var25 = buffer->var25;
    if (v13)
    {
      v16 = @"YES";
    }

    v28 = 134218498;
    *v29 = defaultLinkSelector;
    *&v29[8] = 2112;
    v30 = v16;
    v31 = 1024;
    v32 = var25;
    _os_log_debug_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEBUG, "sendPacketBuffer: _defaultLinkSelector: %p; should use link selection: %@; linkID: %d", &v28, 0x1Cu);
  }

  v18 = !v13;
  if (!self->_defaultLinkSelector)
  {
    v18 = 1;
  }

  if (v18)
  {
    if (!buffer->var25 && (buffer->var24[0].var20 & 0x4000) != 0)
    {
      buffer->var25 = self->_linkIDForPlugin;
    }

    v24 = sub_1A7E14668(self, buffer, dCopy, cbuuidCopy, v10);
  }

  else
  {
    buffer->var40 = 1;
    nextPacketDeduplicationID = self->_nextPacketDeduplicationID;
    buffer->var41 = nextPacketDeduplicationID;
    if (((nextPacketDeduplicationID + 1) & 0xF800) != 0)
    {
      v20 = 0;
    }

    else
    {
      v20 = nextPacketDeduplicationID + 1;
    }

    self->_nextPacketDeduplicationID = v20;
    primaryLinkID = [(IDSLinkSelectorPrimarySecondary *)self->_defaultLinkSelector primaryLinkID];
    duplicationLinkID = [(IDSLinkSelectorPrimarySecondary *)self->_defaultLinkSelector duplicationLinkID];
    if (duplicationLinkID < 1)
    {
      v23 = 0;
    }

    else
    {
      v23 = _IDSLinkPacketBufferClone("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10379, buffer);
      *(v23 + 1216) = duplicationLinkID;
    }

    v25 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEBUG))
    {
      var41 = buffer->var41;
      v28 = 67109632;
      *v29 = var41;
      *&v29[4] = 1024;
      *&v29[6] = primaryLinkID;
      LOWORD(v30) = 1024;
      *(&v30 + 2) = duplicationLinkID;
      _os_log_debug_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEBUG, "sendPacketBuffer: using link selection; adding deduplication ID %d; primary link ID: %d; duplication link ID: %d", &v28, 0x14u);
    }

    buffer->var25 = primaryLinkID;
    v24 = sub_1A7E14668(self, buffer, dCopy, cbuuidCopy, v10);
    if (v23)
    {
      sub_1A7E14668(self, v23, dCopy, cbuuidCopy, v10);
    }
  }

  return v24;
}

- (unint64_t)sendPacketBufferArray:(id *)array arraySize:(int)size toDeviceUniqueID:(id)d cbuuid:(id)cbuuid
{
  v7 = *&size;
  dCopy = d;
  cbuuidCopy = cbuuid;
  if (v7 == 1)
  {
    v12 = [(IDSGlobalLink *)self sendPacketBuffer:*array toDeviceUniqueID:dCopy cbuuid:cbuuidCopy];
  }

  else if ((v7 - 9) > 0xFFFFFFF7)
  {
    v15 = *array;
    _IDSLinkPacketBufferRetain("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10448, *array);
    v30 = 0;
    v28 = 0xAAAAAAAAAAAAAAAALL;
    v29 = 0;
    v16 = ids_monotonic_time();
    if ([(IDSGlobalLink *)self _getPacketBufferSendInfo:v15 channelNumber:&v30 transport:&v29 glLinkProtocol:&v28])
    {
      v17 = [(IDSGlobalLink *)self _getLink:*(v15 + 57) stunTransport:v29 glLinkProtocol:v28];
      v27 = -1;
      v18 = *(v15 + 1216);
      if ((v18 & 0x80000000) != 0 || self->_maxLinkID <= v18)
      {
        v19 = 0;
      }

      else
      {
        v19 = self->_candidatePairs[*(v15 + 1216)];
      }

      v21 = [(IDSGlobalLink *)self _prepareOutgoingChannelData:array arraySize:v7 channelNumber:v30 candidatePair:v19 linkID:v18 delegatedLinkID:&v27 stunTransport:v29];
      if (v21)
      {
        v12 = v21;
        v22 = 10472;
      }

      else
      {
        v23 = 0;
        v24 = 0;
        do
        {
          v24 += *(array[v23++] + 2);
        }

        while (v7 != v23);
        v12 = [v17 sendPacketBufferArray:array arraySize:v7 toDeviceUniqueID:dCopy cbuuid:cbuuidCopy];
        LOBYTE(v26) = 1;
        [(IDSGlobalLink *)self _updateSendStatsWithResult:v12 bytesSent:v24 packetsSent:v7 linkID:v18 delegatedLinkID:v27 token:0 isClientData:v16 sendTime:v26 stunTransport:v29 packetBuffer:v15];
        v22 = 10483;
      }

      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", v22, v15);
    }

    else
    {
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10457, v15);
      v7 = v7;
      v12 = 9;
      do
      {
        v20 = *array++;
        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10460, v20);
        --v7;
      }

      while (v7);
    }
  }

  else if (v7 < 1)
  {
    v12 = 9;
  }

  else
  {
    v13 = v7;
    v12 = 9;
    do
    {
      v14 = *array++;
      _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 10442, v14);
      --v13;
    }

    while (v13);
  }

  return v12;
}

- (id)generateLinkReport:(double)report isCurrentLink:(BOOL)link
{
  previousReportTime = self->_previousReportTime;
  if (previousReportTime == 0.0)
  {
    v13 = 0;
  }

  else
  {
    v7 = report - previousReportTime;
    v8 = self->_totalBytesSent - self->_previousBytesSent;
    v9 = self->_totalBytesReceived - self->_previousBytesReceived;
    if (link)
    {
      v10 = 42;
    }

    else
    {
      v10 = 32;
    }

    v26 = v10;
    v27 = MEMORY[0x1E696AEC0];
    state = self->_state;
    if (state > 6)
    {
      v12 = "UnexpectedState";
    }

    else
    {
      v12 = _IDSLinkStateStrings[state];
    }

    v25 = v12;
    v24 = self->_totalPacketsSent - self->_previousPacketsSent;
    v14 = formattedBytes(v8);
    v15 = formattedSpeed(((8 * v8) / v7 + 0.5));
    totalPacketsSent = self->_totalPacketsSent;
    v17 = formattedBytes(self->_totalBytesSent);
    v18 = self->_totalPacketsReceived - self->_previousPacketsReceived;
    v19 = formattedBytes(v9);
    v20 = formattedSpeed(((8 * v9) / v7 + 0.5));
    totalPacketsReceived = self->_totalPacketsReceived;
    v22 = formattedBytes(self->_totalBytesReceived);
    v13 = [v27 stringWithFormat:@"%c GlobalLink(%s) Tx %6llu pkts %@B %@bps     %6llu pkts %@B\n                        Rx %6llu pkts %@B %@bps     %6llu pkts %@B\n", v26, v25, v24, v14, v15, totalPacketsSent, v17, v18, v19, v20, totalPacketsReceived, v22];
  }

  self->_previousReportTime = report;
  *&self->_previousBytesSent = *&self->_totalBytesSent;
  *&self->_previousBytesReceived = *&self->_totalBytesReceived;

  return v13;
}

- (void)_sendSKEDataWithSelectedCandidatePair
{
  v71 = *MEMORY[0x1E69E9840];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  if (!self->_isInitiator)
  {
    v53 = 0uLL;
    v54 = 0uLL;
    v51 = 0uLL;
    v52 = 0uLL;
    v23 = allValues;
    v24 = [v23 countByEnumeratingWithState:&v51 objects:v59 count:16];
    if (v24)
    {
      v25 = *v52;
LABEL_53:
      v26 = 0;
      while (1)
      {
        if (*v52 != v25)
        {
          objc_enumerationMutation(v23);
        }

        v27 = *(*(&v51 + 1) + 8 * v26);
        if ([v27 recvSKEData])
        {
          break;
        }

        if (v24 == ++v26)
        {
          v24 = [v23 countByEnumeratingWithState:&v51 objects:v59 count:16];
          if (v24)
          {
            goto LABEL_53;
          }

          goto LABEL_59;
        }
      }

      v20 = v27;

      if (!v20)
      {
        goto LABEL_83;
      }

      goto LABEL_61;
    }

    goto LABEL_59;
  }

  v57 = 0uLL;
  v58 = 0uLL;
  v55 = 0uLL;
  v56 = 0uLL;
  obj = allValues;
  v2 = [obj countByEnumeratingWithState:&v55 objects:v70 count:16];
  if (!v2)
  {
LABEL_59:

    goto LABEL_83;
  }

  v48 = 0;
  v50 = *v56;
LABEL_4:
  v3 = 0;
  while (1)
  {
    if (*v56 != v50)
    {
      objc_enumerationMutation(obj);
    }

    v4 = *(*(&v55 + 1) + 8 * v3);
    state = [(__CFString *)v4 state];
    v6 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)v4 isAcceptedRelaySession])
      {
        v7 = @"YES";
      }

      else
      {
        v7 = @"NO";
      }

      pendingRealloc = [(__CFString *)v4 pendingRealloc];
      sentSKEData = [(__CFString *)v4 sentSKEData];
      *buf = 136316162;
      if (pendingRealloc)
      {
        v10 = @"YES";
      }

      else
      {
        v10 = @"NO";
      }

      v61 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
      if (sentSKEData)
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      v62 = 2112;
      v63 = v4;
      v64 = 2112;
      v65 = v7;
      v66 = 2112;
      v67 = v10;
      v68 = 2112;
      v69 = v11;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v12 = [(__CFString *)v4 isAcceptedRelaySession]? @"YES" : @"NO";
      v13 = [(__CFString *)v4 pendingRealloc]? @"YES" : @"NO";
      v14 = [(__CFString *)v4 sentSKEData]? @"YES" : @"NO";
      v44 = v13;
      v45 = v14;
      v42 = v4;
      v43 = v12;
      candidatePairToken2 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
      _IDSLogTransport(@"GL", @"IDS", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      if (_IDSShouldLog())
      {
        if ([(__CFString *)v4 isAcceptedRelaySession:"[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]"])
        {
          v15 = @"YES";
        }

        else
        {
          v15 = @"NO";
        }

        if ([(__CFString *)v4 pendingRealloc])
        {
          v16 = @"YES";
        }

        else
        {
          v16 = @"NO";
        }

        if ([(__CFString *)v4 sentSKEData])
        {
          v17 = @"YES";
        }

        else
        {
          v17 = @"NO";
        }

        v44 = v16;
        v45 = v17;
        v42 = v4;
        v43 = v15;
        candidatePairToken2 = "[IDSGlobalLink _sendSKEDataWithSelectedCandidatePair]";
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      }
    }

    if ([(__CFString *)v4 isAcceptedRelaySession:candidatePairToken2]&& ([(__CFString *)v4 pendingRealloc]& 1) == 0)
    {
      sentSKEData2 = [(__CFString *)v4 sentSKEData];
      v19 = (state - 5) < 0xFFFFFFFFFFFFFFFELL ? 1 : sentSKEData2;
      if ((v19 & 1) == 0)
      {
        v20 = v4;

        local = [(__CFString *)v20 local];
        isCellularStunCandidate = [local isCellularStunCandidate];

        v48 = v20;
        if (!isCellularStunCandidate)
        {
          break;
        }
      }
    }

    if (v2 == ++v3)
    {
      v2 = [obj countByEnumeratingWithState:&v55 objects:v70 count:16];
      v20 = v48;
      if (v2)
      {
        goto LABEL_4;
      }

      break;
    }
  }

  if (v20)
  {
    [(__CFString *)v20 setSentSKEData:1];
LABEL_61:
    v28 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      candidatePairToken = [(__CFString *)v20 candidatePairToken];
      *buf = 138412290;
      v61 = candidatePairToken;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "send SKE data using %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        candidatePairToken2 = [(__CFString *)v20 candidatePairToken];
        _IDSLogTransport(@"GL", @"IDS", @"send SKE data using %@.");

        if (_IDSShouldLog())
        {
          candidatePairToken2 = [(__CFString *)v20 candidatePairToken];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"send SKE data using %@.");
        }
      }
    }

    v30 = ids_monotonic_time() - self->_skeStartTime;
    v31 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = @"NO";
      if (self->_isInitiator)
      {
        v32 = @"YES";
      }

      *buf = 134218242;
      v61 = *&v30;
      v62 = 2112;
      v63 = v32;
      _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v33 = self->_isInitiator ? @"YES" : @"NO";
      v42 = v33;
      candidatePairToken2 = *&v30;
      _IDSLogTransport(@"GL", @"IDS", @"send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
      if (_IDSShouldLog())
      {
        if (self->_isInitiator)
        {
          v34 = @"YES";
        }

        else
        {
          v34 = @"NO";
        }

        v42 = v34;
        candidatePairToken2 = *&v30;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
      }
    }

    if (self->_remoteGlobalLinkVersion)
    {
      candidatePairToken3 = [(__CFString *)v20 candidatePairToken];
      [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:candidatePairToken3];
    }

    else
    {
      isInitiator = self->_isInitiator;
      if (isInitiator)
      {
        v39 = 1;
      }

      else
      {
        v39 = 32769;
      }

      v40 = [(__CFString *)v20 candidatePairToken:candidatePairToken2];
      [(IDSGlobalLink *)self _sendCommandMessage:v39 stunMessage:0 options:0 candidatePairToken:v40];

      if (!isInitiator)
      {
        [(IDSGlobalLink *)self _notifyQRSessionConnected:v20];
      }
    }

    goto LABEL_93;
  }

LABEL_83:
  v36 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
  {
    if (self->_isInitiator)
    {
      v37 = @"YES";
    }

    else
    {
      v37 = @"NO";
    }

    *buf = 138412290;
    v61 = v37;
    _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "failed to select candidate pair to send SKE data (isInitiator:%@).", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to select candidate pair to send SKE data (isInitiator:%@).");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to select candidate pair to send SKE data (isInitiator:%@).");
      }
    }
  }

  v20 = 0;
LABEL_93:
}

- (void)_sendSKEDataToSucceededCandidatePairs
{
  v81 = *MEMORY[0x1E69E9840];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  array = [MEMORY[0x1E695DF70] array];
  if (!self->_isInitiator)
  {
    v62 = 0uLL;
    v63 = 0uLL;
    v60 = 0uLL;
    v61 = 0uLL;
    v21 = allValues;
    v24 = [(__CFString *)v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
    if (v24)
    {
      v25 = *v61;
      do
      {
        for (i = 0; i != v24; ++i)
        {
          if (*v61 != v25)
          {
            objc_enumerationMutation(v21);
          }

          v27 = *(*(&v60 + 1) + 8 * i);
          if ([v27 recvSKEData] && objc_msgSend(v27, "state") == 3)
          {
            [array addObject:v27];
          }
        }

        v24 = [(__CFString *)v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
      }

      while (v24);
    }

    goto LABEL_63;
  }

  v66 = 0uLL;
  v67 = 0uLL;
  v64 = 0uLL;
  v65 = 0uLL;
  obj = allValues;
  v3 = [(__CFString *)obj countByEnumeratingWithState:&v64 objects:v80 count:16];
  if (!v3)
  {
    v21 = obj;
    goto LABEL_63;
  }

  v51 = 0;
  v54 = *v65;
LABEL_4:
  v4 = 0;
  while (1)
  {
    if (*v65 != v54)
    {
      objc_enumerationMutation(obj);
    }

    v5 = *(*(&v64 + 1) + 8 * v4);
    state = [(__CFString *)v5 state];
    v7 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)v5 isAcceptedRelaySession])
      {
        v8 = @"YES";
      }

      else
      {
        v8 = @"NO";
      }

      pendingRealloc = [(__CFString *)v5 pendingRealloc];
      sentSKEData = [(__CFString *)v5 sentSKEData];
      *buf = 136316162;
      if (pendingRealloc)
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      v71 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
      if (sentSKEData)
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v72 = 2112;
      v73 = v5;
      v74 = 2112;
      v75 = v8;
      v76 = 2112;
      v77 = v11;
      v78 = 2112;
      v79 = v12;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      v13 = [(__CFString *)v5 isAcceptedRelaySession]? @"YES" : @"NO";
      v14 = [(__CFString *)v5 pendingRealloc]? @"YES" : @"NO";
      v15 = [(__CFString *)v5 sentSKEData]? @"YES" : @"NO";
      v48 = v14;
      v49 = v15;
      v46 = v5;
      v47 = v13;
      candidatePairToken2 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
      _IDSLogTransport(@"GL", @"IDS", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      if (_IDSShouldLog())
      {
        if ([(__CFString *)v5 isAcceptedRelaySession:"[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]"])
        {
          v16 = @"YES";
        }

        else
        {
          v16 = @"NO";
        }

        if ([(__CFString *)v5 pendingRealloc])
        {
          v17 = @"YES";
        }

        else
        {
          v17 = @"NO";
        }

        if ([(__CFString *)v5 sentSKEData])
        {
          v18 = @"YES";
        }

        else
        {
          v18 = @"NO";
        }

        v48 = v17;
        v49 = v18;
        v46 = v5;
        v47 = v16;
        candidatePairToken2 = "[IDSGlobalLink _sendSKEDataToSucceededCandidatePairs]";
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: candidatePair %@ isAcceptedRelaySession %@ pendingRealloc %@ sentSKEData %@");
      }
    }

    if ([(__CFString *)v5 isAcceptedRelaySession:candidatePairToken2]&& ([(__CFString *)v5 pendingRealloc]& 1) == 0)
    {
      sentSKEData2 = [(__CFString *)v5 sentSKEData];
      v20 = (state - 5) < 0xFFFFFFFFFFFFFFFELL ? 1 : sentSKEData2;
      if ((v20 & 1) == 0)
      {
        v21 = v5;

        local = [(__CFString *)v21 local];
        isCellularStunCandidate = [local isCellularStunCandidate];

        v51 = v21;
        if (!isCellularStunCandidate)
        {
          break;
        }
      }
    }

    if (v3 == ++v4)
    {
      v3 = [(__CFString *)obj countByEnumeratingWithState:&v64 objects:v80 count:16];
      v21 = v51;
      if (v3)
      {
        goto LABEL_4;
      }

      break;
    }
  }

  if (v21)
  {
    [(__CFString *)v21 setSentSKEData:1];
    [array addObject:v21];
LABEL_63:
  }

  if ([array count])
  {
    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    v55 = array;
    v28 = [v55 countByEnumeratingWithState:&v56 objects:v68 count:16];
    if (v28)
    {
      v29 = *v57;
      do
      {
        for (j = 0; j != v28; ++j)
        {
          if (*v57 != v29)
          {
            objc_enumerationMutation(v55);
          }

          v31 = *(*(&v56 + 1) + 8 * j);
          v32 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken = [v31 candidatePairToken];
            *buf = 138412290;
            v71 = candidatePairToken;
            _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              candidatePairToken2 = [v31 candidatePairToken];
              _IDSLogTransport(@"GL", @"IDS", @"_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.");

              if (_IDSShouldLog())
              {
                candidatePairToken2 = [v31 candidatePairToken];
                _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendSKEDataToSucceededCandidatePairs: send SKE data using %@.");
              }
            }
          }

          v34 = ids_monotonic_time() - self->_skeStartTime;
          v35 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
          {
            v36 = @"NO";
            if (self->_isInitiator)
            {
              v36 = @"YES";
            }

            *buf = 134218242;
            v71 = *&v34;
            v72 = 2112;
            v73 = v36;
            _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).", buf, 0x16u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
          {
            v37 = @"NO";
            if (self->_isInitiator)
            {
              v37 = @"YES";
            }

            v46 = v37;
            candidatePairToken2 = *&v34;
            _IDSLogTransport(@"GL", @"IDS", @"_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
            if (_IDSShouldLog())
            {
              v38 = @"NO";
              if (self->_isInitiator)
              {
                v38 = @"YES";
              }

              v46 = v38;
              candidatePairToken2 = *&v34;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"_sendSKEDataToSucceededCandidatePairs: send delayed session connected with SKE data (waitTime:%.6f sec, initiator:%@).");
            }
          }

          if (self->_remoteGlobalLinkVersion)
          {
            candidatePairToken3 = [v31 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:candidatePairToken3];
          }

          else
          {
            isInitiator = self->_isInitiator;
            if (isInitiator)
            {
              v41 = 1;
            }

            else
            {
              v41 = 32769;
            }

            candidatePairToken4 = [v31 candidatePairToken];
            [(IDSGlobalLink *)self _sendCommandMessage:v41 stunMessage:0 options:0 candidatePairToken:candidatePairToken4];

            if (!isInitiator)
            {
              [(IDSGlobalLink *)self _notifyQRSessionConnected:v31];
            }
          }
        }

        v28 = [v55 countByEnumeratingWithState:&v56 objects:v68 count:16];
      }

      while (v28);
    }
  }

  else
  {
    v43 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
    {
      if (self->_isInitiator)
      {
        v44 = @"YES";
      }

      else
      {
        v44 = @"NO";
      }

      *buf = 138412290;
      v71 = v44;
      _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "failed to get candidate pair to send SKE data (isInitiator:%@).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to get candidate pair to send SKE data (isInitiator:%@).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get candidate pair to send SKE data (isInitiator:%@).");
        }
      }
    }
  }
}

- (void)_requestNonUDPRelayAllocation:(int64_t)allocation relaySessionID:(id)d
{
  dCopy = d;
  v7 = dCopy;
  if ((allocation - 5) >= 0xFFFFFFFFFFFFFFFELL)
  {
    shouldFallbackToTCPFirst = self->_shouldFallbackToTCPFirst;
    if (allocation == 3)
    {
      v9 = 3;
    }

    else
    {
      v9 = 5;
    }

    if (allocation == 4)
    {
      v10 = 3;
    }

    else
    {
      v10 = 5;
    }

    v12[0] = MEMORY[0x1E69E9820];
    v12[1] = 3221225472;
    v12[2] = sub_1A7BB1CB8;
    v12[3] = &unk_1E77E0750;
    if (shouldFallbackToTCPFirst)
    {
      v11 = v9;
    }

    else
    {
      v11 = v10;
    }

    v12[4] = self;
    allocationCopy = allocation;
    v13 = dCopy;
    IDSTransportThreadAddBlockAfter(v12, v11);
  }
}

- (void)setAcceptedRelaySession:(id)session options:(id)options
{
  v78 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  theDict = options;
  if (self->_isInitiator)
  {
    if (sessionCopy)
    {
      acceptedRelaySessionID = self->_acceptedRelaySessionID;
      selfCopy = self;
      objc_storeStrong(&self->_acceptedRelaySessionID, session);
      v9 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        v10 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
        *buf = 138412546;
        v75 = sessionCopy;
        v76 = 2048;
        v77 = v10;
        _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v56 = sessionCopy;
          v58 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count];
          _IDSLogTransport(@"GL", @"IDS", @"receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu");
          if (_IDSShouldLog())
          {
            v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs count:sessionCopy];
            v56 = sessionCopy;
            v58 = v11;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive accepted relay-session-id %@, _tokenToCandidatePairs count = %lu");
          }
        }
      }

      v61 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:sessionCopy, v56, v58];
      if (v61)
      {
        remotePushTokens = [v61 remotePushTokens];
        v13 = [remotePushTokens copy];
        remoteAcceptedDevicePushTokens = self->_remoteAcceptedDevicePushTokens;
        self->_remoteAcceptedDevicePushTokens = v13;

        v15 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          v16 = self->_remoteAcceptedDevicePushTokens;
          *buf = 138412290;
          v75 = v16;
          _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "remote accepted device push tokens: %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            candidatePairToken2 = self->_remoteAcceptedDevicePushTokens;
            _IDSLogTransport(@"GL", @"IDS", @"remote accepted device push tokens: %@");
            if (_IDSShouldLog())
            {
              candidatePairToken2 = self->_remoteAcceptedDevicePushTokens;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"remote accepted device push tokens: %@");
            }
          }
        }

        [(IDSGlobalLink *)self _updateAllLinks];
      }

      Value = 0;
      if (theDict && @"gl-option-use-secure-control-message")
      {
        Value = CFDictionaryGetValue(theDict, @"gl-option-use-secure-control-message");
      }

      bOOLValue = [Value BOOLValue];
      if (!self->_useSecureControlMessage && ((bOOLValue ^ 1) & 1) == 0)
      {
        self->_useSecureControlMessage = bOOLValue;
        v19 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "enable secure control message for Initiator.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"enable secure control message for Initiator.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"enable secure control message for Initiator.");
            }
          }
        }
      }

      v20 = ids_monotonic_time();
      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      self->_skeStartTime = v20;
      allValues = [(NSMutableDictionary *)tokenToCandidatePairs allValues];
      if (![(NSMutableDictionary *)self->_tokenToCandidatePairs count])
      {
        v36 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v36, OS_LOG_TYPE_DEFAULT, "No valid candiate pair, _isSessionAccepted yes", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"No valid candiate pair, _isSessionAccepted yes");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"No valid candiate pair, _isSessionAccepted yes");
            }
          }
        }

        transport = 0;
        self->_isSessionAcceptedWithNoCandidatePair = 1;
LABEL_95:
        if (self->_skeData)
        {
          v54 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
          {
            skeData = self->_skeData;
            *buf = 134217984;
            v75 = skeData;
            _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "found saved SKE data %p, send it immediately.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              candidatePairToken2 = selfCopy->_skeData;
              _IDSLogTransport(@"GL", @"IDS", @"found saved SKE data %p, send it immediately.");
              if (_IDSShouldLog())
              {
                candidatePairToken2 = selfCopy->_skeData;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"found saved SKE data %p, send it immediately.");
              }
            }
          }

          [(IDSGlobalLink *)selfCopy _sendSKEDataWithSelectedCandidatePair];
          self = selfCopy;
        }

        if (transport == 2)
        {
          [(IDSGlobalLink *)self _requestNonUDPRelayAllocation:3 relaySessionID:sessionCopy];
          [(IDSGlobalLink *)selfCopy _requestNonUDPRelayAllocation:4 relaySessionID:sessionCopy];
        }

        goto LABEL_106;
      }

      if (acceptedRelaySessionID)
      {
        v66 = 0uLL;
        v67 = 0uLL;
        v64 = 0uLL;
        v65 = 0uLL;
        v22 = allValues;
        transport = 0;
        v24 = [v22 countByEnumeratingWithState:&v64 objects:v72 count:16];
        if (v24)
        {
          v25 = *v65;
          do
          {
            for (i = 0; i != v24; ++i)
            {
              if (*v65 != v25)
              {
                objc_enumerationMutation(v22);
              }

              v27 = *(*(&v64 + 1) + 8 * i);
              if ([v27 isRelayStunCandidatePair])
              {
                sessionID = [v27 sessionID];
                v29 = [sessionID isEqualToString:sessionCopy];

                if (v29)
                {
                  [v27 setIsAcceptedRelaySession:1];
                  local = [v27 local];
                  transport = [local transport];

                  v31 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
                  {
                    candidatePairToken = [v27 candidatePairToken];
                    v33 = (&_IDSStunTransportStrings)[transport];
                    *buf = 138412546;
                    v75 = candidatePairToken;
                    v76 = 2080;
                    v77 = v33;
                    _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "new relay candidate pair %@ is accepted, transport: %s.", buf, 0x16u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      candidatePairToken2 = [v27 candidatePairToken];
                      v59 = (&_IDSStunTransportStrings)[transport];
                      _IDSLogTransport(@"GL", @"IDS", @"new relay candidate pair %@ is accepted, transport: %s.");

                      if (_IDSShouldLog())
                      {
                        candidatePairToken2 = [v27 candidatePairToken];
                        v59 = (&_IDSStunTransportStrings)[transport];
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"new relay candidate pair %@ is accepted, transport: %s.");
                      }
                    }
                  }
                }
              }
            }

            v24 = [v22 countByEnumeratingWithState:&v64 objects:v72 count:16];
          }

          while (v24);
        }

LABEL_94:
        self = selfCopy;
        goto LABEL_95;
      }

      v70 = 0uLL;
      v71 = 0uLL;
      v68 = 0uLL;
      v69 = 0uLL;
      v37 = allValues;
      transport = 0;
      v38 = [v37 countByEnumeratingWithState:&v68 objects:v73 count:16];
      if (!v38)
      {
        goto LABEL_93;
      }

      v39 = *v69;
LABEL_67:
      v40 = 0;
      while (1)
      {
        if (*v69 != v39)
        {
          objc_enumerationMutation(v37);
        }

        v41 = *(*(&v68 + 1) + 8 * v40);
        if (![v41 isRelayStunCandidatePair])
        {
          goto LABEL_91;
        }

        sessionID2 = [v41 sessionID];
        v43 = [sessionID2 isEqualToString:sessionCopy];

        if (!v43)
        {
          break;
        }

        [v41 setIsAcceptedRelaySession:1];
        local2 = [v41 local];
        transport = [local2 transport];

        v45 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
        {
          candidatePairToken3 = [v41 candidatePairToken];
          v47 = (&_IDSStunTransportStrings)[transport];
          *buf = 138412546;
          v75 = candidatePairToken3;
          v76 = 2080;
          v77 = v47;
          _os_log_impl(&dword_1A7AD9000, v45, OS_LOG_TYPE_DEFAULT, "relay candidate pair %@ is accepted, transport: %s.", buf, 0x16u);
        }

        if (!os_log_shim_legacy_logging_enabled())
        {
          goto LABEL_91;
        }

        if (!_IDSShouldLogTransport())
        {
          goto LABEL_91;
        }

        candidatePairToken2 = [v41 candidatePairToken];
        v59 = (&_IDSStunTransportStrings)[transport];
        _IDSLogTransport(@"GL", @"IDS", @"relay candidate pair %@ is accepted, transport: %s.");

        if (!_IDSShouldLog())
        {
          goto LABEL_91;
        }

        candidatePairToken4 = [v41 candidatePairToken];
        candidatePairToken2 = candidatePairToken4;
        v59 = (&_IDSStunTransportStrings)[transport];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"relay candidate pair %@ is accepted, transport: %s.");
LABEL_90:

LABEL_91:
        if (v38 == ++v40)
        {
          v38 = [v37 countByEnumeratingWithState:&v68 objects:v73 count:16];
          if (!v38)
          {
LABEL_93:

            goto LABEL_94;
          }

          goto LABEL_67;
        }
      }

      nonAcceptedQRSessions = selfCopy->_nonAcceptedQRSessions;
      if (nonAcceptedQRSessions)
      {
        if (!v41)
        {
          goto LABEL_84;
        }
      }

      else
      {
        v50 = objc_alloc_init(MEMORY[0x1E695DF70]);
        v51 = selfCopy->_nonAcceptedQRSessions;
        selfCopy->_nonAcceptedQRSessions = v50;

        nonAcceptedQRSessions = selfCopy->_nonAcceptedQRSessions;
        if (!v41)
        {
LABEL_84:
          v52 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v52, OS_LOG_TYPE_DEFAULT))
          {
            candidatePairToken5 = [v41 candidatePairToken];
            *buf = 138412290;
            v75 = candidatePairToken5;
            _os_log_impl(&dword_1A7AD9000, v52, OS_LOG_TYPE_DEFAULT, "relay candidate pair %@ is not accepted, added to remove list.", buf, 0xCu);
          }

          if (!os_log_shim_legacy_logging_enabled())
          {
            goto LABEL_91;
          }

          if (!_IDSShouldLogTransport())
          {
            goto LABEL_91;
          }

          candidatePairToken2 = [v41 candidatePairToken];
          _IDSLogTransport(@"GL", @"IDS", @"relay candidate pair %@ is not accepted, added to remove list.");

          if (!_IDSShouldLog())
          {
            goto LABEL_91;
          }

          candidatePairToken4 = [v41 candidatePairToken];
          candidatePairToken2 = candidatePairToken4;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"relay candidate pair %@ is not accepted, added to remove list.");
          goto LABEL_90;
        }
      }

      if (nonAcceptedQRSessions)
      {
        CFArrayAppendValue(nonAcceptedQRSessions, v41);
      }

      goto LABEL_84;
    }

    v35 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "setAcceptedRelaySession failed due to invalid relay-session-id.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setAcceptedRelaySession failed due to invalid relay-session-id.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setAcceptedRelaySession failed due to invalid relay-session-id.");
        }
      }
    }
  }

  else
  {
    v34 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "setAcceptedRelaySession failed, not Initiator.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"setAcceptedRelaySession failed, not Initiator.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"setAcceptedRelaySession failed, not Initiator.");
        }
      }
    }
  }

LABEL_106:
}

- (void)requestMaterialsForSession:(id)session participantIDs:(id)ds materialType:(int)type
{
  v21 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  dsCopy = ds;
  v10 = IMGetDomainBoolForKey();
  v11 = +[IDSFoundationLog GlobalLink];
  v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);
  if (v10)
  {
    if (v12)
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: ignoring because DisableQUICMaterialRecovery is set", buf, 2u);
    }
  }

  else
  {
    if (v12)
    {
      *buf = 67109378;
      typeCopy = type;
      v19 = 2112;
      v20 = sessionCopy;
      _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: Trying to request material of type %d over active QUIC link for IDSSessionID: %@", buf, 0x12u);
    }

    if (self->_quicMaterialExchangeProvider)
    {
      v14[0] = MEMORY[0x1E69E9820];
      v14[1] = 3221225472;
      v14[2] = sub_1A7BB3484;
      v14[3] = &unk_1E77E1040;
      v14[4] = self;
      v15 = dsCopy;
      typeCopy2 = type;
      IDSTransportThreadAddBlock(v14);
    }

    else
    {
      v13 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "requestMaterialsForSession: SME disabled", buf, 2u);
      }
    }
  }
}

- (BOOL)_qrMaterialExchangePutMaterial:(id)material completionHandler:(id)handler
{
  v78 = *MEMORY[0x1E69E9840];
  materialCopy = material;
  handlerCopy = handler;
  v7 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    idsSessionID = self->_idsSessionID;
    *buf = 138412546;
    v75 = materialCopy;
    v76 = 2112;
    v77 = idsSessionID;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: Trying to send material %@ over active QUIC link for IDSSessionID: %@", buf, 0x16u);
  }

  if (self->_linkIDForPlugin)
  {
    v66 = 0u;
    v67 = 0u;
    v64 = 0u;
    v65 = 0u;
    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v10 = [allValues countByEnumeratingWithState:&v64 objects:v73 count:16];
    aBlock = handlerCopy;
    if (v10)
    {
      v11 = v10;
      obj = self;
      v12 = 0;
      v13 = *v65;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v65 != v13)
          {
            objc_enumerationMutation(allValues);
          }

          v15 = *(*(&v64 + 1) + 8 * i);
          state = [v15 state];
          if ([v15 isActualRelayStunCandidatePair])
          {
            if ([v15 isQUIC] && state == 4)
            {
              v18 = [IDSQRProtoMessage alloc];
              v71 = @"gl-option-materials-key";
              v72 = materialCopy;
              v19 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v72 forKeys:&v71 count:1];
              v20 = [(IDSQRProtoMessage *)v18 initWithType:24 candidatePair:v15 options:v19];

              v21 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                v75 = v15;
                _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: send quic message on %@", buf, 0xCu);
              }

              v22 = [v15 sendQUICPutMaterialRequest:v20];
              v12 |= v22;
              handlerCopy = aBlock;
              if (aBlock && v22)
              {
                putMaterialReqTxIdToCompletionBlock = obj->_putMaterialReqTxIdToCompletionBlock;
                v24 = _Block_copy(aBlock);
                v25 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{-[IDSQRProtoMessage transactionID](v20, "transactionID")}];
                [(NSMutableDictionary *)putMaterialReqTxIdToCompletionBlock setObject:v24 forKey:v25];

                handlerCopy = aBlock;
                v12 = 1;
              }
            }
          }
        }

        v11 = [allValues countByEnumeratingWithState:&v64 objects:v73 count:16];
      }

      while (v11);

      self = obj;
      if (v12)
      {
        v26 = 1;
        goto LABEL_54;
      }
    }

    else
    {
    }

    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    allValues2 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v30 = [allValues2 countByEnumeratingWithState:&v60 objects:v70 count:16];
    if (v30)
    {
      v31 = v30;
      v28 = 0;
      v32 = *v61;
      v48 = *v61;
      v49 = allValues2;
      do
      {
        v33 = 0;
        v50 = v31;
        do
        {
          if (*v61 != v32)
          {
            objc_enumerationMutation(allValues2);
          }

          v34 = *(*(&v60 + 1) + 8 * v33);
          state2 = [v34 state];
          if ([v34 isActualRelayStunCandidatePair] && (objc_msgSend(v34, "isQUIC") & 1) == 0 && state2 == 4)
          {
            v51 = v33;
            v58 = 0u;
            v59 = 0u;
            v56 = 0u;
            v57 = 0u;
            obja = materialCopy;
            v36 = [obja countByEnumeratingWithState:&v56 objects:v69 count:16];
            if (v36)
            {
              v37 = v36;
              v38 = *v57;
              do
              {
                for (j = 0; j != v37; ++j)
                {
                  if (*v57 != v38)
                  {
                    objc_enumerationMutation(obja);
                  }

                  v40 = *(*(&v56 + 1) + 8 * j);
                  v41 = objc_alloc_init(MEMORY[0x1E695DF90]);
                  v42 = objc_alloc_init(IDSQRProtoPutMaterialMaterials);
                  v68 = v40;
                  v43 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v68 count:1];
                  v44 = [v43 mutableCopy];
                  [(IDSQRProtoPutMaterialMaterials *)v42 setMaterials:v44];

                  data = [(IDSQRProtoPutMaterialMaterials *)v42 data];
                  [v41 setObject:data forKeyedSubscript:@"gl-option-materials-key"];

                  v46 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412546;
                    v75 = v34;
                    v76 = 2112;
                    v77 = v40;
                    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: send stun message on %@ for key material %@", buf, 0x16u);
                  }

                  [v34 sendPutMaterialRequest:0 options:v41];
                }

                v37 = [obja countByEnumeratingWithState:&v56 objects:v69 count:16];
              }

              while (v37);
            }

            v28 = 1;
            v32 = v48;
            allValues2 = v49;
            v31 = v50;
            v33 = v51;
          }

          ++v33;
        }

        while (v33 != v31);
        v31 = [allValues2 countByEnumeratingWithState:&v60 objects:v70 count:16];
      }

      while (v31);
    }

    else
    {
      v28 = 0;
    }

    v26 = v28;
    handlerCopy = aBlock;
    if (aBlock)
    {
LABEL_53:
      (*(handlerCopy + 2))(handlerCopy, v28 & 1);
      v26 = v28;
    }
  }

  else
  {
    v27 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "qrMaterialExchangePutMaterial: no active QUIC link", buf, 2u);
    }

    v28 = 0;
    v26 = 0;
    if (handlerCopy)
    {
      goto LABEL_53;
    }
  }

LABEL_54:

  return v26 & 1;
}

- (void)qrMaterialExchangePutMaterial:(id)material completionHandler:(id)handler
{
  materialCopy = material;
  handlerCopy = handler;
  v10[0] = MEMORY[0x1E69E9820];
  v10[1] = 3221225472;
  v10[2] = sub_1A7BB3E10;
  v10[3] = &unk_1E77E1270;
  v10[4] = self;
  v11 = materialCopy;
  v12 = handlerCopy;
  v8 = handlerCopy;
  v9 = materialCopy;
  IDSTransportThreadAddBlock(v10);
}

- (id)_getLocalAttribute:(id)attribute
{
  v214 = *MEMORY[0x1E69E9840];
  attributeCopy = attribute;
  v5 = objc_alloc_init(MEMORY[0x1E695DF90]);
  uniqueID = [attributeCopy uniqueID];
  [v5 setObject:uniqueID forKeyedSubscript:@"gl-attr-uniqueid"];

  isVirtualRelayStunCandidatePair = [attributeCopy isVirtualRelayStunCandidatePair];
  local = [attributeCopy local];
  transport = [local transport];

  v193 = isVirtualRelayStunCandidatePair;
  if (transport == 2)
  {
    v10 = 4;
  }

  else
  {
    local2 = [attributeCopy local];
    transport2 = [local2 transport];

    if (transport2 == 3)
    {
      v10 = 896;
    }

    else
    {
      v10 = 0;
    }
  }

  local3 = [attributeCopy local];
  address = [local3 address];

  *&v15 = 0xAAAAAAAAAAAAAAAALL;
  *(&v15 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v212 = v15;
  v213 = v15;
  v210 = v15;
  v211 = v15;
  v208 = v15;
  v209 = v15;
  *__str = v15;
  v207 = v15;
  SAToIPPortString(__str, 0x80uLL, address);
  __str = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", __str];
  if (__str)
  {
    CFDictionarySetValue(v5, @"gl-attr-local-address-key", __str);
  }

  else
  {
    v17 = MEMORY[0x1E69E9C10];
    v18 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E161EC();
    }
  }

  v19 = *(address + 1);
  v20 = v10 | 1;
  v21 = 1;
  if (v19 != 2)
  {
    v20 = v10;
    v21 = 0;
  }

  v22 = v19 == 30;
  if (v19 == 30)
  {
    v23 = v10 | 2;
  }

  else
  {
    v23 = v20;
  }

  v199 = v23;
  if (v22)
  {
    v24 = 2;
  }

  else
  {
    v24 = v21;
  }

  theDict = v5;
  if ([attributeCopy isRelayStunCandidatePair])
  {
    local4 = [attributeCopy local];
    transport3 = [local4 transport];
  }

  else
  {
    transport3 = 1;
  }

  local5 = [attributeCopy local];
  v198 = [local5 mtu];

  v28 = [(IDSGlobalLink *)self _getExpensiveLinkFlagsForCandidatePair:attributeCopy];
  local6 = [attributeCopy local];
  v30 = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](self, "_isInterfaceConstrainedWithInterfaceIndex:", [local6 index]);

  if (v30)
  {
    v31 = v28 | 2;
  }

  else
  {
    v31 = v28;
  }

  if (self->_remoteDeviceVersion >= 2)
  {
    local7 = [attributeCopy local];
    v33 = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [local7 index]);

    if (v33)
    {
      v31 |= 4u;
    }
  }

  remote = [attributeCopy remote];
  [remote linkFlags];

  v35 = *(address + 1);
  if (v35 == 2)
  {
    local8 = [attributeCopy local];
    isCLAT46 = [local8 isCLAT46];

    v35 = *(address + 1);
  }

  else
  {
    isCLAT46 = 0;
  }

  v197 = __str;
  v38 = v31;
  if (v35 == 30)
  {
    if ([attributeCopy isNAT64])
    {
      v38 = v31 | 0x10;
    }

    else
    {
      v38 = v31;
    }
  }

  if (isCLAT46)
  {
    v39 = v31 | 8;
  }

  else
  {
    v39 = v38;
  }

  v40 = +[IDSCellularLinkMonitor sharedInstance];
  dataSoMaskBits = [v40 dataSoMaskBits];

  local9 = [attributeCopy local];
  radioAccessTechnology = [local9 radioAccessTechnology];

  if (radioAccessTechnology)
  {
    v43 = radioAccessTechnology == 9;
  }

  else
  {
    v43 = 1;
  }

  v44 = !v43;
  v188 = v44;
  relayProviderType = [attributeCopy relayProviderType];
  relaySessionToken = [attributeCopy relaySessionToken];
  relaySessionKey = [attributeCopy relaySessionKey];
  local10 = [attributeCopy local];
  selfCopy = self;
  v47 = -[IDSGlobalLink _interfaceNameForInterfaceIndex:](self, "_interfaceNameForInterfaceIndex:", [local10 index]);

  local11 = [attributeCopy local];
  v49 = v39 | [local11 cellularSlicingFlags];

  v50 = +[IDSCellularLinkMonitor sharedInstance];
  v51 = [v50 isSlicedCellularInterfaceActive:v47];

  if (v51)
  {
    LOWORD(v49) = v49 | 0x80;
    local12 = [attributeCopy local];
    [local12 setCellularSlicingFlags:v49];
  }

  v53 = [MEMORY[0x1E696AD98] numberWithInteger:v24];
  v54 = theDict;
  if (v53)
  {
    CFDictionarySetValue(theDict, @"gl-attr-ipfamily", v53);
  }

  else
  {
    v55 = MEMORY[0x1E69E9C10];
    v56 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v55, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16274();
    }
  }

  v57 = [MEMORY[0x1E696AD98] numberWithInteger:transport3];
  if (v57)
  {
    CFDictionarySetValue(theDict, @"gl-attr-transport", v57);
  }

  else
  {
    v58 = MEMORY[0x1E69E9C10];
    v59 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E162FC();
    }
  }

  v60 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:radioAccessTechnology];
  if (v60)
  {
    CFDictionarySetValue(theDict, @"gl-attr-rat", v60);
  }

  else
  {
    v61 = MEMORY[0x1E69E9C10];
    v62 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v61, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16384();
    }
  }

  v63 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v49];
  if (v63)
  {
    CFDictionarySetValue(theDict, @"gl-attr-link-flags", v63);
  }

  else
  {
    v64 = MEMORY[0x1E69E9C10];
    v65 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v64, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1640C();
    }
  }

  v66 = [MEMORY[0x1E696AD98] numberWithChar:{objc_msgSend(attributeCopy, "delegatedLinkID")}];
  if (v66)
  {
    CFDictionarySetValue(theDict, @"gl-attr-delegated-link-id", v66);
  }

  else
  {
    v67 = MEMORY[0x1E69E9C10];
    v68 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v67, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16494();
    }
  }

  v69 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(attributeCopy, "relayLinkID")}];
  if (v69)
  {
    CFDictionarySetValue(theDict, @"gl-attr-local-relay-link-id", v69);
  }

  else
  {
    v70 = MEMORY[0x1E69E9C10];
    v71 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v70, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1651C();
    }
  }

  v72 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(attributeCopy, "remoteRelayLinkID")}];
  if (v72)
  {
    CFDictionarySetValue(theDict, @"gl-attr-remote-relay-link-id", v72);
  }

  else
  {
    v73 = MEMORY[0x1E69E9C10];
    v74 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E165A4();
    }
  }

  if (radioAccessTechnology && radioAccessTechnology != 9)
  {
    v75 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:dataSoMaskBits];
    if (v75)
    {
      CFDictionarySetValue(theDict, @"gl-attr-data-so-mask", v75);
    }

    else
    {
      v76 = MEMORY[0x1E69E9C10];
      v77 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v76, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E1662C();
      }
    }
  }

  v78 = [MEMORY[0x1E696AD98] numberWithInteger:relayProviderType];
  if (v78)
  {
    CFDictionarySetValue(theDict, @"qr-server-provider", v78);
  }

  else
  {
    v79 = MEMORY[0x1E69E9C10];
    v80 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v79, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E166B4();
    }
  }

  v81 = relaySessionToken;
  if (v81)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessiontoken", v81);
  }

  else
  {
    v82 = MEMORY[0x1E69E9C10];
    v83 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v82, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1673C();
    }
  }

  v84 = relaySessionKey;
  if (v84)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessionkey", v84);
  }

  else
  {
    v85 = MEMORY[0x1E69E9C10];
    v86 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v85, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E167C4();
    }
  }

  sessionID = [attributeCopy sessionID];
  if (sessionID)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-sessionid", sessionID);
  }

  else
  {
    v88 = MEMORY[0x1E69E9C10];
    v89 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v88, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1684C();
    }
  }

  v90 = [MEMORY[0x1E696AD98] numberWithBool:{objc_msgSend(attributeCopy, "serverIsDegraded")}];
  if (v90)
  {
    CFDictionarySetValue(theDict, @"gl-attr-relay-serverdegraded", v90);
  }

  else
  {
    v91 = MEMORY[0x1E69E9C10];
    v92 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E168D4();
    }
  }

  v93 = [MEMORY[0x1E696AD98] numberWithBool:v193];
  if (v93)
  {
    CFDictionarySetValue(theDict, @"gl-attr-is-virtual-link", v93);
  }

  else
  {
    v94 = MEMORY[0x1E69E9C10];
    v95 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v94, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1695C();
    }
  }

  v196 = v84;

  v96 = v47;
  if (v96)
  {
    CFDictionarySetValue(theDict, @"gl-attr-interface-name", v96);
    v97 = selfCopy;
  }

  else
  {
    v98 = MEMORY[0x1E69E9C10];
    v99 = MEMORY[0x1E69E9C10];
    v97 = selfCopy;
    if (os_log_type_enabled(v98, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E169E4();
    }
  }

  v100 = v199;

  if (v97->_QUICForQREnabled)
  {
    v101 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
    {
      if (v193)
      {
        v102 = @"YES";
      }

      else
      {
        v102 = @"NO";
      }

      *buf = 138412802;
      *v203 = attributeCopy;
      *&v203[8] = 2112;
      *&v203[10] = v102;
      v204 = 1024;
      delegatedLinkID = [attributeCopy delegatedLinkID];
      _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "Setting up child connection for candidatepair %@ isVirtualRelayLink %@ delegatedLinkID %d", buf, 0x1Cu);
    }

    if ((v193 & 1) != 0 || v97->_disableDirectDatapath)
    {
      clientUniquePID = 0;
    }

    else
    {
      clientUniquePID = v97->_clientUniquePID;
    }

    v186 = v96;
    v187 = v81;
    if ([attributeCopy isVirtualRelayStunCandidatePair])
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)v97 _shouldUseVRTLE];
    }

    else if ([attributeCopy isRelayStunCandidatePair])
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)v97 _shouldUseQRTLE];
    }

    else
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)v97 _shouldUseP2PTLE];
    }

    v190 = _shouldUseVRTLE;
    nwLink = v97->_nwLink;
    local13 = [attributeCopy local];
    address2 = [local13 address];
    remote2 = [attributeCopy remote];
    external = [remote2 external];
    sessionID2 = [attributeCopy sessionID];
    isRelayStunCandidatePair = [attributeCopy isRelayStunCandidatePair];
    kindSuffix = [attributeCopy kindSuffix];
    local14 = [attributeCopy local];
    LOBYTE(v183) = [local14 isCellularStunCandidate];
    v194 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:address2 remoteAddress:external clientUniquePID:clientUniquePID sessionID:sessionID2 type:0 isRelay:isRelayStunCandidatePair protocolStackSuffix:kindSuffix isCellular:v183];

    if (([attributeCopy isRelayStunCandidatePair] & 1) != 0 || objc_msgSend(attributeCopy, "isVirtualRelayStunCandidatePair"))
    {
      v114 = selfCopy->_nwLink;
      local15 = [attributeCopy local];
      address3 = [local15 address];
      remote3 = [attributeCopy remote];
      external2 = [remote3 external];
      sessionID3 = [attributeCopy sessionID];
      kindSuffix2 = [attributeCopy kindSuffix];
      local16 = [attributeCopy local];
      LOBYTE(v184) = [local16 isCellularStunCandidate];
      [(IDSNWLink *)v114 connectionInfoForLocalAddress:address3 remoteAddress:external2 clientUniquePID:clientUniquePID sessionID:sessionID3 type:7 isRelay:1 protocolStackSuffix:kindSuffix2 isCellular:v184];
    }

    else
    {
      v122 = selfCopy->_nwLink;
      local15 = [attributeCopy local];
      address4 = [local15 address];
      remote3 = [attributeCopy remote];
      external3 = [remote3 external];
      sessionID3 = [attributeCopy sessionID];
      kindSuffix2 = [attributeCopy kindSuffix];
      local16 = [attributeCopy local];
      LOBYTE(v184) = [local16 isCellularStunCandidate];
      [(IDSNWLink *)v122 connectionInfoForLocalAddress:address4 remoteAddress:external3 clientUniquePID:clientUniquePID sessionID:sessionID3 type:9 isRelay:0 protocolStackSuffix:kindSuffix2 isCellular:v184];
    }
    v125 = ;

    v97 = selfCopy;
    v81 = v187;
    if ([attributeCopy isRelayStunCandidatePair])
    {
      v126 = selfCopy->_nwLink;
      local17 = [attributeCopy local];
      address5 = [local17 address];
      remote4 = [attributeCopy remote];
      external4 = [remote4 external];
      sessionID4 = [attributeCopy sessionID];
      kindSuffix3 = [attributeCopy kindSuffix];
      LOBYTE(v185) = v188;
      v133 = [(IDSNWLink *)v126 connectionInfoForLocalAddress:address5 remoteAddress:external4 clientUniquePID:0 sessionID:sessionID4 type:5 isRelay:1 protocolStackSuffix:kindSuffix3 isCellular:v185];

      v134 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v134, OS_LOG_TYPE_DEFAULT))
      {
        protocolStackDescription = [v133 protocolStackDescription];
        *buf = 138412290;
        *v203 = protocolStackDescription;
        _os_log_impl(&dword_1A7AD9000, v134, OS_LOG_TYPE_DEFAULT, "relay control connection has protocol stack: %@", buf, 0xCu);
      }

      protocolStackDescription2 = [v133 protocolStackDescription];
      v97 = selfCopy;
      if (protocolStackDescription2)
      {
        CFDictionarySetValue(theDict, @"gl-relay-protocol-stack", protocolStackDescription2);
      }

      else
      {
        v137 = MEMORY[0x1E69E9C10];
        v138 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v137, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E16A6C();
        }
      }
    }

    isP2P = [attributeCopy isP2P];
    v54 = theDict;
    v96 = v186;
    if (v125 != 0 && v190)
    {
      v140 = v194;
      if ((isP2P & 1) != 0 || [attributeCopy isVirtualRelayStunCandidatePair])
      {
        v198 -= GLUtilGetLinkOverhead(8u);
      }
    }

    else
    {
      v140 = v194;
    }

    dictionary = [MEMORY[0x1E695DF90] dictionary];
    if (v140)
    {
      v142 = GLUtilConnectionDictionaryForNWConnectionInfo(v140, 1);
      [dictionary setObject:v142 forKeyedSubscript:@"udp"];
    }

    if (v125)
    {
      v143 = [MEMORY[0x1E696AD98] numberWithBool:v97->_isPartialTLEUPlusOneEnabled];
      if (v143)
      {
        CFDictionarySetValue(theDict, @"gl-attr-partial-tle-uplusone-enabled", v143);
      }

      else
      {
        v144 = MEMORY[0x1E69E9C10];
        v145 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v144, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E16AF4();
        }
      }

      v146 = GLUtilConnectionDictionaryForNWConnectionInfo(v125, v190);
      [dictionary setObject:v146 forKeyedSubscript:@"qpod"];
    }

    v147 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v147, OS_LOG_TYPE_DEFAULT))
    {
      linkID = [attributeCopy linkID];
      *buf = 67109378;
      *v203 = linkID;
      *&v203[4] = 2112;
      *&v203[6] = dictionary;
      _os_log_impl(&dword_1A7AD9000, v147, OS_LOG_TYPE_DEFAULT, "connections for link %d: %@", buf, 0x12u);
    }

    v149 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:{objc_msgSend(attributeCopy, "channelNumber")}];
    if (v149)
    {
      CFDictionarySetValue(theDict, @"gl-attr-linkchannelnumber", v149);
    }

    else
    {
      v150 = MEMORY[0x1E69E9C10];
      v151 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v150, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16B7C();
      }
    }

    hbhEncKey = [attributeCopy hbhEncKey];
    if (hbhEncKey)
    {
      CFDictionarySetValue(theDict, @"gl-attr-hbhenckey", hbhEncKey);
    }

    else
    {
      v153 = MEMORY[0x1E69E9C10];
      v154 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v153, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16C04();
      }
    }

    hbhDecKey = [attributeCopy hbhDecKey];
    if (hbhDecKey)
    {
      CFDictionarySetValue(theDict, @"gl-attr-hbhdeckey", hbhDecKey);
    }

    else
    {
      v156 = MEMORY[0x1E69E9C10];
      v157 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v156, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E16C8C();
      }
    }

    v158 = dictionary;
    if (v158)
    {
      CFDictionarySetValue(theDict, @"gl-attr-connections", v158);
      v159 = v194;
    }

    else
    {
      v160 = MEMORY[0x1E69E9C10];
      v161 = MEMORY[0x1E69E9C10];
      v162 = os_log_type_enabled(v160, OS_LOG_TYPE_ERROR);
      v159 = v194;
      if (v162)
      {
        sub_1A7E16D14();
      }
    }

    v100 = v199;
    if (v125 != 0 && v190)
    {
      v100 = v199 | 8;
      v103 = 16;
    }

    else
    {
      v103 = 32;
    }
  }

  else
  {
    v103 = 32;
  }

  if (([attributeCopy isVirtualRelayStunCandidatePair] & 1) != 0 || objc_msgSend(attributeCopy, "isRelayStunCandidatePair"))
  {
    v100 |= v103;
  }

  if ([attributeCopy isVirtualRelayStunCandidatePair])
  {
    v100 |= 0x40u;
  }

  array = [MEMORY[0x1E695DF70] array];
  v164 = array;
  if (v97->_useLinkEngine)
  {
    [array addObject:@"le"];
  }

  v165 = v97->_qrExperiments;
  if (v165)
  {
    CFDictionarySetValue(v54, @"gl-attr-qr-experiments", v165);
    v166 = v196;
  }

  else
  {
    v167 = MEMORY[0x1E69E9C10];
    v168 = MEMORY[0x1E69E9C10];
    v166 = v196;
    if (os_log_type_enabled(v167, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16D9C();
    }
  }

  v169 = v164;
  if (v169)
  {
    CFDictionarySetValue(v54, @"ff", v169);
  }

  else
  {
    v170 = MEMORY[0x1E69E9C10];
    v171 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v170, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16E24();
    }
  }

  linkUniqueName = [attributeCopy linkUniqueName];
  if (linkUniqueName)
  {
    CFDictionarySetValue(v54, @"leid", linkUniqueName);
  }

  else
  {
    v173 = MEMORY[0x1E69E9C10];
    v174 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v173, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16EAC();
    }
  }

  v175 = [MEMORY[0x1E696AD98] numberWithInt:v198];
  if (v175)
  {
    CFDictionarySetValue(v54, @"gl-attr-mtu", v175);
  }

  else
  {
    v176 = MEMORY[0x1E69E9C10];
    v177 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v176, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16F34();
    }
  }

  v178 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:GLUtilGetLinkOverhead(v100)];
  if (v178)
  {
    CFDictionarySetValue(v54, @"gl-attr-constant-overhead", v178);
  }

  else
  {
    v179 = MEMORY[0x1E69E9C10];
    v180 = MEMORY[0x1E69E9C10];
    if (os_log_type_enabled(v179, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E16FBC();
    }
  }

  v181 = [(__CFDictionary *)v54 copy];

  return v181;
}

- (id)_getRemoteAttribute:(id)attribute
{
  v74 = *MEMORY[0x1E69E9840];
  attributeCopy = attribute;
  v5 = objc_alloc_init(MEMORY[0x1E695DF90]);
  isVirtualRelayStunCandidatePair = [attributeCopy isVirtualRelayStunCandidatePair];
  remote = [attributeCopy remote];
  transport = [remote transport];

  if (transport == 2)
  {
    v9 = 4;
  }

  else
  {
    remote2 = [attributeCopy remote];
    transport2 = [remote2 transport];

    if (transport2 == 3)
    {
      v9 = 896;
    }

    else
    {
      v9 = 0;
    }
  }

  remote3 = [attributeCopy remote];
  external = [remote3 external];

  *&v14 = 0xAAAAAAAAAAAAAAAALL;
  *(&v14 + 1) = 0xAAAAAAAAAAAAAAAALL;
  v72 = v14;
  v73 = v14;
  v70 = v14;
  v71 = v14;
  v68 = v14;
  v69 = v14;
  *__str = v14;
  v67 = v14;
  SAToIPPortString(__str, 0x80uLL, external);
  __str = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", __str];
  if (__str)
  {
    CFDictionarySetValue(v5, @"gl-attr-remote-address-key", __str);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17044();
  }

  v16 = *(external + 1);
  v17 = v9 | 1;
  v18 = 1;
  if (v16 != 2)
  {
    v17 = v9;
    v18 = 0;
  }

  v19 = v16 == 30;
  if (v16 == 30)
  {
    v20 = v9 | 2;
  }

  else
  {
    v20 = v17;
  }

  v62 = v20;
  if (v19)
  {
    v21 = 2;
  }

  else
  {
    v21 = v18;
  }

  v63 = v21;
  if ([attributeCopy isRelayStunCandidatePair])
  {
    local = [attributeCopy local];
    transport3 = [local transport];
  }

  else
  {
    transport3 = 1;
  }

  remote4 = [attributeCopy remote];
  v65 = [remote4 mtu];

  if (self->_QUICForQREnabled)
  {
    if ([attributeCopy isVirtualRelayStunCandidatePair])
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)self _shouldUseVRTLE];
    }

    else if ([attributeCopy isRelayStunCandidatePair])
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)self _shouldUseQRTLE];
    }

    else
    {
      _shouldUseVRTLE = [(IDSGlobalLink *)self _shouldUseP2PTLE];
    }

    v58 = _shouldUseVRTLE;
    v59 = isVirtualRelayStunCandidatePair;
    v61 = __str;
    selfCopy = self;
    if (([attributeCopy isRelayStunCandidatePair] & 1) != 0 || objc_msgSend(attributeCopy, "isVirtualRelayStunCandidatePair"))
    {
      nwLink = self->_nwLink;
      local2 = [attributeCopy local];
      address = [local2 address];
      remote5 = [attributeCopy remote];
      external2 = [remote5 external];
      sessionID = [attributeCopy sessionID];
      kindSuffix = [attributeCopy kindSuffix];
      local3 = [attributeCopy local];
      LOBYTE(v57) = [local3 isCellularStunCandidate];
      [(IDSNWLink *)nwLink connectionInfoForLocalAddress:address remoteAddress:external2 clientUniquePID:0 sessionID:sessionID type:7 isRelay:1 protocolStackSuffix:kindSuffix isCellular:v57];
    }

    else
    {
      v34 = self->_nwLink;
      local2 = [attributeCopy local];
      address2 = [local2 address];
      remote5 = [attributeCopy remote];
      external3 = [remote5 external];
      sessionID = [attributeCopy sessionID];
      kindSuffix = [attributeCopy kindSuffix];
      local3 = [attributeCopy local];
      LOBYTE(v57) = [local3 isCellularStunCandidate];
      [(IDSNWLink *)v34 connectionInfoForLocalAddress:address2 remoteAddress:external3 clientUniquePID:0 sessionID:sessionID type:9 isRelay:0 protocolStackSuffix:kindSuffix isCellular:v57];
    }
    v37 = ;

    isP2P = [attributeCopy isP2P];
    v25 = v37 != 0 && v58;
    if (v25 == 1)
    {
      self = selfCopy;
      isVirtualRelayStunCandidatePair = v59;
      if ((isP2P & 1) != 0 || [attributeCopy isVirtualRelayStunCandidatePair])
      {
        v65 -= GLUtilGetLinkOverhead(8u);
      }
    }

    else
    {
      self = selfCopy;
      isVirtualRelayStunCandidatePair = v59;
    }

    __str = v61;
  }

  else
  {
    v25 = 0;
  }

  remote6 = [attributeCopy remote];
  linkFlags = [remote6 linkFlags];

  if ((isVirtualRelayStunCandidatePair & 1) == 0 && self->_remoteDeviceVersion < 2)
  {
    linkFlags &= ~4u;
  }

  remote7 = [attributeCopy remote];
  dataSoMask = [remote7 dataSoMask];

  remote8 = [attributeCopy remote];
  radioAccessTechnology = [remote8 radioAccessTechnology];

  if (v25)
  {
    v45 = v62 | 8;
  }

  else
  {
    v45 = v62;
  }

  if (([attributeCopy isVirtualRelayStunCandidatePair] & 1) != 0 || objc_msgSend(attributeCopy, "isRelayStunCandidatePair"))
  {
    if (v25)
    {
      v46 = 16;
    }

    else
    {
      v46 = 32;
    }

    v45 |= v46;
  }

  if ([attributeCopy isVirtualRelayStunCandidatePair])
  {
    v47 = v45 | 0x40;
  }

  else
  {
    v47 = v45;
  }

  v48 = [MEMORY[0x1E696AD98] numberWithInteger:v63];
  if (v48)
  {
    CFDictionarySetValue(v5, @"gl-attr-ipfamily", v48);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E170CC();
  }

  v49 = [MEMORY[0x1E696AD98] numberWithInteger:transport3];
  if (v49)
  {
    CFDictionarySetValue(v5, @"gl-attr-transport", v49);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17154();
  }

  v50 = [MEMORY[0x1E696AD98] numberWithInt:v65];
  if (v50)
  {
    CFDictionarySetValue(v5, @"gl-attr-mtu", v50);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E171DC();
  }

  v51 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:GLUtilGetLinkOverhead(v47)];
  if (v51)
  {
    CFDictionarySetValue(v5, @"gl-attr-constant-overhead", v51);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17264();
  }

  v52 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:radioAccessTechnology];
  if (v52)
  {
    CFDictionarySetValue(v5, @"gl-attr-rat", v52);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E172EC();
  }

  v53 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:linkFlags];
  if (v53)
  {
    CFDictionarySetValue(v5, @"gl-attr-link-flags", v53);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17374();
  }

  if (radioAccessTechnology && radioAccessTechnology != 9)
  {
    v54 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:dataSoMask];
    if (v54)
    {
      CFDictionarySetValue(v5, @"gl-attr-data-so-mask", v54);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E173FC();
    }
  }

  v55 = [(__CFDictionary *)v5 copy];

  return v55;
}

- (void)sendConnectedLinkInfoToAVC
{
  v53 = *MEMORY[0x1E69E9840];
  v3 = [(NSMutableArray *)self->_connectedLinkIDs copy];
  v4 = 0x1E77DB000uLL;
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *v45 = v3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "sendConnectedLinkInfoToAVC: current connected links: %@", buf, 0xCu);
  }

  v42 = 0u;
  v43 = 0u;
  v40 = 0u;
  v41 = 0u;
  v6 = v3;
  v36 = [v6 countByEnumeratingWithState:&v40 objects:v52 count:16];
  if (v36)
  {
    v8 = *v41;
    *&v7 = 67109378;
    v35 = v7;
    do
    {
      for (i = 0; i != v36; ++i)
      {
        if (*v41 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = *(*(&v40 + 1) + 8 * i);
        if (([v10 intValue] & 0x80000000) != 0 || objc_msgSend(v10, "intValue") >= self->_maxLinkID)
        {
          v11 = 0;
        }

        else
        {
          v11 = self->_candidatePairs[[v10 intValue]];
        }

        v12 = v11;
        isVirtualRelayStunCandidatePair = [(IDSStunCandidatePair *)v12 isVirtualRelayStunCandidatePair];
        v14 = [(IDSGlobalLink *)self _getLocalAttribute:v12];
        v38 = [(IDSGlobalLink *)self _getRemoteAttribute:v12];
        charValue = [v10 charValue];
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v16 = objc_opt_respondsToSelector();

        if (v16)
        {
          v17 = @"VR";
          if (!isVirtualRelayStunCandidatePair)
          {
            isRelayStunCandidatePair = [(IDSStunCandidatePair *)v12 isRelayStunCandidatePair];
            v17 = @"P2P";
            if (isRelayStunCandidatePair)
            {
              v17 = @"RLY";
            }
          }

          v37 = v17;
          globalLink = [*(v4 + 2592) GlobalLink];
          if (os_log_type_enabled(globalLink, OS_LOG_TYPE_DEFAULT))
          {
            v20 = v8;
            v21 = v6;
            v22 = v4;
            idsSessionID = self->_idsSessionID;
            sessionID = [(IDSStunCandidatePair *)v12 sessionID];
            *buf = 67110146;
            *v45 = charValue;
            *&v45[4] = 2112;
            *&v45[6] = v37;
            v46 = 2112;
            v47 = idsSessionID;
            v4 = v22;
            v6 = v21;
            v8 = v20;
            v48 = 2112;
            v49 = sessionID;
            v50 = 2112;
            v51 = v12;
            _os_log_impl(&dword_1A7AD9000, globalLink, OS_LOG_TYPE_DEFAULT, "Send link cached connected (%d) %@ for IDSSessionID: %@ QRSessionID: %@ and %@.", buf, 0x30u);
          }

          v25 = [(IDSGlobalLink *)self _translateLinkTransportTypeWhenH2Enabled:v14];

          v26 = objc_loadWeakRetained(&self->_delegate);
          linkUUID = [(IDSStunCandidatePair *)v12 linkUUID];
          v28 = v38;
          [v26 link:self didConnectUnderlyingLink:charValue linkUUID:linkUUID localAttributes:v25 remoteAttributes:v38];

          v14 = v25;
        }

        else
        {
          v28 = v38;
        }

        v29 = objc_loadWeakRetained(&self->_delegate);
        v30 = objc_opt_respondsToSelector();

        if (v30)
        {
          globalLink2 = [*(v4 + 2592) GlobalLink];
          if (os_log_type_enabled(globalLink2, OS_LOG_TYPE_DEFAULT))
          {
            participantIDMap = [(IDSStunCandidatePair *)v12 participantIDMap];
            *buf = v35;
            *v45 = charValue;
            *&v45[4] = 2112;
            *&v45[6] = participantIDMap;
            _os_log_impl(&dword_1A7AD9000, globalLink2, OS_LOG_TYPE_DEFAULT, "Send updated participantID cached map for link: %d, map: %@", buf, 0x12u);
          }

          v33 = objc_loadWeakRetained(&self->_delegate);
          participantIDMap2 = [(IDSStunCandidatePair *)v12 participantIDMap];
          [v33 link:self didReceiveMappedParticipantsDict:participantIDMap2 forLinkID:charValue];
        }
      }

      v36 = [v6 countByEnumeratingWithState:&v40 objects:v52 count:16];
    }

    while (v36);
  }
}

- (void)reportLinkEvent:(id)event linkID:(unsigned __int8)d
{
  dCopy = d;
  v15 = *MEMORY[0x1E69E9840];
  eventCopy = event;
  if (self->_maxLinkID > dCopy && (v7 = self->_candidatePairs[dCopy]) != 0)
  {
    p_super = &v7->super;
    v9 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v11 = 138412546;
      v12 = eventCopy;
      v13 = 2112;
      v14 = p_super;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "reportLinkEvent: eventName: %@, candidate pair: %@", &v11, 0x16u);
    }

    linkMetrics = [p_super linkMetrics];
    [linkMetrics event:eventCopy];
  }

  else
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_DEFAULT))
    {
      v11 = 67109120;
      LODWORD(v12) = dCopy;
      _os_log_impl(&dword_1A7AD9000, p_super, OS_LOG_TYPE_DEFAULT, "reportLinkEvent: no candidate pair found for linkID %d", &v11, 8u);
    }
  }
}

- (void)setPacketNotificationFilter:(char)filter uniqueTag:(unsigned int)tag isEnabled:(BOOL)enabled
{
  filterCopy = filter;
  v67 = *MEMORY[0x1E69E9840];
  if (self->_state < 5 || !enabled)
  {
    if (filter < 0 || self->_maxLinkID <= filter || (v8 = enabled, v9 = *&tag, (v10 = self->_candidatePairs[filter]) == 0))
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        *&buf[4] = filterCopy;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
          }
        }
      }

      v11 = 0;
    }

    else
    {
      v11 = v10;
      if ([(IDSStunCandidatePair *)v10 state]< 5)
      {
        local = [(IDSStunCandidatePair *)v11 local];
        address = [local address];

        remote = [(IDSStunCandidatePair *)v11 remote];
        external = [remote external];

        if (v8)
        {
          v48 = external;
          self->_basebandPacketChannelNumber = [(IDSStunCandidatePair *)v11 channelNumber];
          self->_basebandPacketLinkID = filterCopy;
          if (self->_clientType == 5)
          {
            v20 = 1;
          }

          else
          {
            v20 = 2;
          }

          v46 = v20;
          local2 = [(IDSStunCandidatePair *)v11 local];
          index = [local2 index];

          v55 = 0u;
          v56 = 0u;
          v53 = 0u;
          v54 = 0u;
          v23 = self->_interfaceAddressArray;
          v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v53 objects:v66 count:16];
          if (v24)
          {
            v25 = *v54;
LABEL_37:
            v26 = 0;
            while (1)
            {
              if (*v54 != v25)
              {
                objc_enumerationMutation(v23);
              }

              v27 = *(*(&v53 + 1) + 8 * v26);
              if ([v27 index] == index)
              {
                break;
              }

              if (v24 == ++v26)
              {
                v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v53 objects:v66 count:16];
                if (v24)
                {
                  goto LABEL_37;
                }

                goto LABEL_43;
              }
            }

            name = [v27 name];
            delegatedIndex = [v27 delegatedIndex];

            if (!delegatedIndex)
            {
              name3 = name;
              goto LABEL_66;
            }

            v51 = 0u;
            v52 = 0u;
            v49 = 0u;
            v50 = 0u;
            v23 = self->_interfaceAddressArray;
            v31 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v49 objects:v65 count:16];
            if (v31)
            {
              v32 = *v50;
LABEL_48:
              v33 = 0;
              while (1)
              {
                if (*v50 != v32)
                {
                  objc_enumerationMutation(v23);
                }

                v34 = *(*(&v49 + 1) + 8 * v33);
                if ([v34 index] == delegatedIndex)
                {
                  break;
                }

                if (v31 == ++v33)
                {
                  v31 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v49 objects:v65 count:16];
                  if (v31)
                  {
                    goto LABEL_48;
                  }

                  goto LABEL_63;
                }
              }

              if (![v34 isCellular])
              {
                goto LABEL_63;
              }

              v35 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
              {
                name2 = [v34 name];
                *buf = 138412546;
                *&buf[4] = name;
                *&buf[12] = 2112;
                *&buf[14] = name2;
                _os_log_impl(&dword_1A7AD9000, v35, OS_LOG_TYPE_DEFAULT, "setPacketNotificationFilter: overriding source interface [%@] with [%@]", buf, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  [v34 name];
                  v45 = v44 = name;
                  _IDSLogTransport(@"GL", @"IDS", @"setPacketNotificationFilter: overriding source interface [%@] with [%@]");

                  if (_IDSShouldLog())
                  {
                    [v34 name];
                    v45 = v44 = name;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"setPacketNotificationFilter: overriding source interface [%@] with [%@]");
                  }
                }
              }

              name3 = [v34 name];

              address2 = [v34 address];
              address = [address2 sa];
            }

            else
            {
LABEL_63:
              name3 = name;
            }
          }

          else
          {
LABEL_43:
            name = 0;
            name3 = 0;
          }

LABEL_66:
          *&v38 = 0xAAAAAAAAAAAAAAAALL;
          *(&v38 + 1) = 0xAAAAAAAAAAAAAAAALL;
          v63 = v38;
          v64 = v38;
          v61 = v38;
          v62 = v38;
          v59 = v38;
          v60 = v38;
          *buf = v38;
          *&buf[16] = v38;
          v57[6] = v38;
          v57[7] = v38;
          v57[4] = v38;
          v57[5] = v38;
          v57[2] = v38;
          v57[3] = v38;
          v57[0] = v38;
          v57[1] = v38;
          if (self->_QUICForQREnabled)
          {
            nwLink = self->_nwLink;
            sessionID = [(IDSStunCandidatePair *)v11 sessionID];
            v41 = [(IDSNWLink *)nwLink getEffectiveSourceAddress:buf fromSourceAddress:address effectiveDestinationAddress:v57 fromDestinationAddress:v48 sessionID:sessionID isQRConnection:[(IDSStunCandidatePair *)v11 isRelayStunCandidatePair]];

            v42 = v48;
            if (v41)
            {
              v42 = v57;
            }

            v48 = v42;
            if (v41)
            {
              address = buf;
            }
          }

          v43 = +[IDSCellularLinkMonitor sharedInstance];
          [v43 setPacketNotificationFilter:address remote:v48 uniqueTag:v9 callType:v46 ifname:name3];
        }

        else
        {
          v29 = +[IDSCellularLinkMonitor sharedInstance];
          [v29 removePacketNotificationFilter];

          self->_basebandPacketChannelNumber = 0;
          self->_basebandPacketLinkID = 0;
        }
      }

      else
      {
        v12 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109120;
          *&buf[4] = filterCopy;
          _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "candidate pair for linkID:%d has been already disconnected.", buf, 8u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"candidate pair for linkID:%d has been already disconnected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"candidate pair for linkID:%d has been already disconnected.");
            }
          }
        }
      }
    }
  }

  else
  {
    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = filterCopy;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "GL link already disconnected - not setting packet notification filter for link %d", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"GL link already disconnected - not setting packet notification filter for link %d");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"GL link already disconnected - not setting packet notification filter for link %d");
      }
    }
  }
}

- (void)dropIPPackets:(char)packets payloadArray:(id)array
{
  packetsCopy = packets;
  v59 = *MEMORY[0x1E69E9840];
  arrayCopy = array;
  if (packetsCopy < 0 || self->_maxLinkID <= packetsCopy || (v7 = self->_candidatePairs[packetsCopy]) == 0)
  {
    v9 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      *&buf[4] = packetsCopy;
      _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
        }
      }
    }
  }

  else
  {
    v8 = v7;
    if ([(IDSStunCandidatePair *)v7 isSharedQRSession])
    {
      channelNumber = [(IDSStunCandidatePair *)v8 channelNumber];
    }

    else
    {
      channelNumber = 0;
    }

    local = [(IDSStunCandidatePair *)v8 local];
    address = [local address];

    remote = [(IDSStunCandidatePair *)v8 remote];
    external = [remote external];

    local2 = [(IDSStunCandidatePair *)v8 local];
    index = [local2 index];

    v47 = 0u;
    v48 = 0u;
    v45 = 0u;
    v46 = 0u;
    v15 = self->_interfaceAddressArray;
    v16 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v45 objects:v58 count:16];
    if (v16)
    {
      v17 = *v46;
LABEL_15:
      v18 = 0;
      while (1)
      {
        if (*v46 != v17)
        {
          objc_enumerationMutation(v15);
        }

        v19 = *(*(&v45 + 1) + 8 * v18);
        if ([v19 index] == index)
        {
          break;
        }

        if (v16 == ++v18)
        {
          v16 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v45 objects:v58 count:16];
          if (v16)
          {
            goto LABEL_15;
          }

          goto LABEL_21;
        }
      }

      name = [v19 name];
      delegatedIndex = [v19 delegatedIndex];

      if (!delegatedIndex)
      {
        name3 = name;
        goto LABEL_43;
      }

      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v15 = self->_interfaceAddressArray;
      v22 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v41 objects:v57 count:16];
      if (v22)
      {
        v23 = *v42;
LABEL_25:
        v24 = 0;
        while (1)
        {
          if (*v42 != v23)
          {
            objc_enumerationMutation(v15);
          }

          v25 = *(*(&v41 + 1) + 8 * v24);
          if ([v25 index] == delegatedIndex)
          {
            break;
          }

          if (v22 == ++v24)
          {
            v22 = [(NSMutableArray *)v15 countByEnumeratingWithState:&v41 objects:v57 count:16];
            if (v22)
            {
              goto LABEL_25;
            }

            goto LABEL_40;
          }
        }

        if (![v25 isCellular])
        {
          goto LABEL_40;
        }

        v26 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
        {
          name2 = [v25 name];
          *buf = 138412546;
          *&buf[4] = name;
          *&buf[12] = 2112;
          *&buf[14] = name2;
          _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "dropIPPackets: overriding source interface [%@] with [%@]", buf, 0x16u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            [v25 name];
            v37 = v36 = name;
            _IDSLogTransport(@"GL", @"IDS", @"dropIPPackets: overriding source interface [%@] with [%@]");

            if (_IDSShouldLog())
            {
              [v25 name];
              v37 = v36 = name;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"dropIPPackets: overriding source interface [%@] with [%@]");
            }
          }
        }

        name3 = [v25 name];

        address2 = [v25 address];
        address = [address2 sa];
      }

      else
      {
LABEL_40:
        name3 = name;
      }
    }

    else
    {
LABEL_21:
      name = 0;
      name3 = 0;
    }

LABEL_43:
    *&v29 = 0xAAAAAAAAAAAAAAAALL;
    *(&v29 + 1) = 0xAAAAAAAAAAAAAAAALL;
    v55 = v29;
    v56 = v29;
    v53 = v29;
    v54 = v29;
    v51 = v29;
    v52 = v29;
    *buf = v29;
    *&buf[16] = v29;
    v49[6] = v29;
    v49[7] = v29;
    v49[4] = v29;
    v49[5] = v29;
    v49[2] = v29;
    v49[3] = v29;
    v49[0] = v29;
    v49[1] = v29;
    if (self->_QUICForQREnabled)
    {
      nwLink = self->_nwLink;
      sessionID = [(IDSStunCandidatePair *)v8 sessionID];
      v32 = [(IDSNWLink *)nwLink getEffectiveSourceAddress:buf fromSourceAddress:address effectiveDestinationAddress:v49 fromDestinationAddress:external sessionID:sessionID isQRConnection:[(IDSStunCandidatePair *)v8 isRelayStunCandidatePair]];

      v33 = external;
      if (v32)
      {
        v33 = v49;
      }

      external = v33;
      if (v32)
      {
        address = buf;
      }
    }

    v34 = +[IDSCellularLinkMonitor sharedInstance];
    local3 = [(IDSStunCandidatePair *)v8 local];
    [v34 dropIPPackets:arrayCopy localAddress:address remoteAddress:external isRelay:objc_msgSend(local3 channelNumberMSB:"isRelayStunCandidate") ifname:{channelNumber, name3}];
  }
}

- (void)updateProtocolQualityOfService:(char)service isGood:(BOOL)good
{
  serviceCopy = service;
  v12 = *MEMORY[0x1E69E9840];
  if (service < 0 || self->_maxLinkID <= service || (v5 = good, (v9 = self->_candidatePairs[service]) == 0))
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v11 = serviceCopy;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for linkID:%d.", buf, 8u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for linkID:%d.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for linkID:%d.");
        }
      }
    }
  }

  else
  {
    v6 = +[IDSCellularLinkMonitor sharedInstance];
    local = [(IDSStunCandidatePair *)v9 local];
    [v6 updateProtocolQualityOfService:v5 localAddress:{objc_msgSend(local, "address")}];
  }
}

- (void)stopKeepAlive:(id)alive
{
  v7 = *MEMORY[0x1E69E9840];
  aliveCopy = alive;
  v4 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v6 = aliveCopy;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "stop heart beat for linkIDs:%@", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"stop heart beat for linkIDs:%@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"stop heart beat for linkIDs:%@");
      }
    }
  }
}

- (void)currentCellularSignalStrength:(int *)strength signalStrength:(int *)signalStrength signalGrade:(int *)grade
{
  if (strength && signalStrength && grade)
  {
    v9 = +[IDSCellularLinkMonitor sharedInstance];
    [v9 currentCellularSignalStrength:strength signalStrength:signalStrength signalGrade:grade];
  }

  else
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "currentCellularSignalStrength failed due to invalid parameter.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"currentCellularSignalStrength failed due to invalid parameter.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"currentCellularSignalStrength failed due to invalid parameter.");
        }
      }
    }
  }
}

- (void)setWiFiAssistState:(BOOL)state
{
  stateCopy = state;
  [(IDSUDPLink *)self->_udpLink setWiFiAssistState:?];
  [(IDSUDPLink *)self->_udpLinkv6 setWiFiAssistState:stateCopy];
  [(IDSTCPLink *)self->_tcpLink setWiFiAssistState:stateCopy];
  [(IDSTCPLink *)self->_tcpSSLLink setWiFiAssistState:stateCopy];
  nwLink = self->_nwLink;

  [(IDSNWLink *)nwLink setWiFiAssistState:stateCopy];
}

- (void)startLinkProbing:(id)probing
{
  v53 = *MEMORY[0x1E69E9840];
  probingCopy = probing;
  v5 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v6 = [probingCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = [probingCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v8 = [v7 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v8)
    {
      connectedLinkIDs = self->_connectedLinkIDs;
      goto LABEL_8;
    }
  }

  else
  {
  }

  connectedLinkIDs = 0;
  if (probingCopy && @"ids-extchannel-probing-link-ids-key")
  {
    connectedLinkIDs = CFDictionaryGetValue(probingCopy, @"ids-extchannel-probing-link-ids-key");
  }

LABEL_8:
  v43 = 0u;
  v44 = 0u;
  v45 = 0u;
  v46 = 0u;
  v10 = [connectedLinkIDs copy];
  v11 = [v10 countByEnumeratingWithState:&v43 objects:v52 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v44;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v44 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v43 + 1) + 8 * i);
        if (([(NSMutableArray *)self->_activeProbingLinkIDs containsObject:v15]& 1) == 0)
        {
          [(NSMutableArray *)v5 addObject:v15];
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v43 objects:v52 count:16];
    }

    while (v12);
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v48 = v5;
    v49 = 2112;
    *v50 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "startLinkProbing: add new probing linkIDs: %@, to activeProbingLinkIDs: %@", buf, 0x16u);
  }

  [(NSMutableArray *)self->_activeProbingLinkIDs addObjectsFromArray:v5];
  Value = 0;
  if (probingCopy && @"ids-extchannel-probing-timeout-key")
  {
    Value = CFDictionaryGetValue(probingCopy, @"ids-extchannel-probing-timeout-key");
  }

  unsignedIntValue = [Value unsignedIntValue];
  v20 = 0;
  self->_probingTimeout = unsignedIntValue;
  v38 = v10;
  if (probingCopy && @"ids-extchannel-probing-interval-key")
  {
    v20 = CFDictionaryGetValue(probingCopy, @"ids-extchannel-probing-interval-key");
  }

  unsignedIntValue2 = [v20 unsignedIntValue];
  if (unsignedIntValue2)
  {
    v22 = unsignedIntValue2;
    v36 = v5;
    v37 = probingCopy;
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v23 = v5;
    v24 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v39 objects:v51 count:16];
    if (v24)
    {
      v25 = v24;
      v26 = 0;
      v27 = *v40;
      do
      {
        for (j = 0; j != v25; ++j)
        {
          if (*v40 != v27)
          {
            objc_enumerationMutation(v23);
          }

          v29 = *(*(&v39 + 1) + 8 * j);
          if (([v29 intValue] & 0x80000000) != 0 || objc_msgSend(v29, "intValue") >= self->_maxLinkID)
          {
            v30 = 0;
          }

          else
          {
            v30 = self->_candidatePairs[[v29 intValue]];
          }

          v31 = v30;
          if ([(IDSStunCandidatePair *)v31 isSharedQRSession])
          {
            v32 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v48 = v31;
              _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "startLinkProbing: skipped shared QR session %@", buf, 0xCu);
            }

            if (!v26)
            {
              v26 = objc_alloc_init(MEMORY[0x1E695DF70]);
            }

            if (v29 && v26)
            {
              CFArrayAppendValue(v26, v29);
            }
          }

          else
          {
            [(IDSStunCandidatePair *)v31 startLinkProbingTimer:v22];
          }
        }

        v25 = [(NSMutableArray *)v23 countByEnumeratingWithState:&v39 objects:v51 count:16];
      }

      while (v25);
    }

    else
    {
      v26 = 0;
    }

    [(NSMutableArray *)self->_activeProbingLinkIDs removeObjectsInArray:v26];
    v33 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = self->_activeProbingLinkIDs;
      probingTimeout = self->_probingTimeout;
      *buf = 138412802;
      v48 = v34;
      v49 = 1024;
      *v50 = v22;
      *&v50[4] = 1024;
      *&v50[6] = probingTimeout;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "startLinkProbing: activeProbingLinkIDs: %@, probingInterval: %u, _probingTimeout: %u", buf, 0x18u);
    }

    v5 = v36;
    probingCopy = v37;
  }

  else
  {
    v26 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17484();
    }
  }
}

- (void)stopLinkProbing:(id)probing
{
  v28 = *MEMORY[0x1E69E9840];
  probingCopy = probing;
  v5 = [probingCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [probingCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v7)
    {
      v8 = [(NSMutableArray *)self->_activeProbingLinkIDs copy];
      goto LABEL_9;
    }
  }

  else
  {
  }

  Value = 0;
  if (probingCopy && @"ids-extchannel-probing-link-ids-key")
  {
    Value = CFDictionaryGetValue(probingCopy, @"ids-extchannel-probing-link-ids-key");
  }

  v8 = Value;
LABEL_9:
  v21 = 0u;
  v22 = 0u;
  v19 = 0u;
  v20 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v19 objects:v27 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v20;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v20 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v19 + 1) + 8 * i);
        if (([v15 intValue] & 0x80000000) != 0 || objc_msgSend(v15, "intValue") >= self->_maxLinkID)
        {
          v16 = 0;
        }

        else
        {
          v16 = self->_candidatePairs[[v15 intValue]];
        }

        [(IDSStunCandidatePair *)v16 stopLinkProbingTimer];
      }

      v12 = [v10 countByEnumeratingWithState:&v19 objects:v27 count:16];
    }

    while (v12);
  }

  [(NSMutableArray *)self->_activeProbingLinkIDs removeObjectsInArray:v10];
  v17 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v24 = v10;
    v25 = 2112;
    v26 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "stopLinkProbing: linkIDs: %@, activeProbingLinkIDs: %@", buf, 0x16u);
  }
}

- (void)_stopProbingOnLinkID:(char)d
{
  dCopy = d;
  v14 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    v13 = dCopy;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_stopProbingOnLinkID: %d", buf, 8u);
  }

  v10 = @"ids-extchannel-probing-link-ids-key";
  v6 = [MEMORY[0x1E696AD98] numberWithChar:dCopy];
  v9 = v6;
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v9 count:1];
  v11 = v7;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v11 forKeys:&v10 count:1];
  [(IDSGlobalLink *)self stopLinkProbing:v8];
}

- (void)queryLinkProbingStatus:(id)status
{
  v118 = *MEMORY[0x1E69E9840];
  statusCopy = status;
  theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
  v5 = [statusCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  v81 = statusCopy;
  if ((objc_opt_isKindOfClass() & 1) == 0)
  {

LABEL_5:
    Value = 0;
    if (statusCopy && @"ids-extchannel-probing-link-ids-key")
    {
      Value = CFDictionaryGetValue(statusCopy, @"ids-extchannel-probing-link-ids-key");
    }

    v8 = Value;
    goto LABEL_9;
  }

  v6 = [statusCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

  if (!v7)
  {
    goto LABEL_5;
  }

  v8 = [(NSMutableArray *)self->_connectedLinkIDs copy];
LABEL_9:
  v10 = v8;
  v11 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v108 = v10;
    _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: linkIDs: %@", buf, 0xCu);
  }

  v103 = 0u;
  v104 = 0u;
  v101 = 0u;
  v102 = 0u;
  v12 = v10;
  v13 = [(__CFString *)v12 countByEnumeratingWithState:&v101 objects:v117 count:16];
  if (!v13)
  {
    v15 = 0;
    goto LABEL_107;
  }

  v14 = v13;
  v15 = 0;
  candidatePairs = self->_candidatePairs;
  v16 = *v102;
  v83 = *v102;
  v84 = v12;
  selfCopy = self;
  do
  {
    v17 = 0;
    v86 = v14;
    do
    {
      if (*v102 != v16)
      {
        objc_enumerationMutation(v12);
      }

      v18 = *(*(&v101 + 1) + 8 * v17);
      if (([v18 intValue] & 0x80000000) != 0 || objc_msgSend(v18, "intValue") >= self->_maxLinkID)
      {
        v19 = 0;
      }

      else
      {
        v19 = candidatePairs[[v18 intValue]];
      }

      v20 = v19;
      candidatePairToken = [(__CFString *)v20 candidatePairToken];
      if ([(__CFString *)v20 isSharedQRSession])
      {
        v21 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v108 = v20;
          _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: skipped shared QR session %@", buf, 0xCu);
        }

        if (!v15)
        {
          v15 = objc_alloc_init(MEMORY[0x1E695DF70]);
        }

        if (v18 && v15)
        {
          CFArrayAppendValue(v15, v18);
        }

        goto LABEL_100;
      }

      linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
      if (v18)
      {
        v23 = linkIDToRequestTimeStampAndRTT == 0;
      }

      else
      {
        v23 = 1;
      }

      if (v23)
      {
        v24 = 0;
      }

      else
      {
        v24 = CFDictionaryGetValue(linkIDToRequestTimeStampAndRTT, v18);
      }

      v25 = v24;
      v26 = [v25 objectAtIndexedSubscript:0];
      objc_opt_class();
      isKindOfClass = objc_opt_isKindOfClass();

      v28 = [v25 objectAtIndexedSubscript:0];
      v29 = v28;
      v89 = v15;
      if (isKindOfClass)
      {
        unsignedIntValue = [v28 unsignedIntValue];
      }

      else
      {
        v31 = [v28 objectAtIndexedSubscript:0];
        unsignedIntValue = [v31 unsignedIntValue];
      }

      v87 = v20;

      v32 = ((vcvtd_n_f64_u32(unsignedIntValue, 0x10uLL) + HIWORD(unsignedIntValue)) * 1000.0);
      v33 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        v34 = [v25 count];
        v35 = [v25 objectAtIndexedSubscript:0];
        *buf = 138413314;
        v108 = candidatePairToken;
        v109 = 2112;
        v110 = v18;
        v111 = 1024;
        v112 = v32;
        v113 = 2048;
        v114 = v34;
        v115 = 2112;
        v116 = v35;
        _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: candidatePairToken %@, linkID: %@, baseRequestTimeStampInMS: %u, requestTimeStampAndRTTs count: %lu, requestTimeStampAndRTTs: %@ ...", buf, 0x30u);
      }

      key = v18;
      v88 = v17;

      v96 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v92 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v36 = ids_monotonic_time();
      v37 = ntpTime32(v36);
      v97 = 0u;
      v98 = 0u;
      v99 = 0u;
      v100 = 0u;
      obj = v25;
      v38 = [obj countByEnumeratingWithState:&v97 objects:v106 count:16];
      if (!v38)
      {
        v40 = 0;
        v41 = 0;
        goto LABEL_64;
      }

      v39 = v38;
      v40 = 0;
      v41 = 0;
      v93 = ((vcvtd_n_f64_u32(v37, 0x10uLL) + HIWORD(v37)) * 1000.0);
      v42 = *v98;
      do
      {
        v43 = 0;
        do
        {
          if (*v98 != v42)
          {
            objc_enumerationMutation(obj);
          }

          v44 = *(*(&v97 + 1) + 8 * v43);
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            unsignedIntValue2 = [v44 unsignedIntValue];
            v46 = ((vcvtd_n_f64_u32(unsignedIntValue2, 0x10uLL) + HIWORD(unsignedIntValue2)) * 1000.0);
            if (v93 - v46 < selfCopy->_probingTimeout)
            {
              [v92 addObject:v44];
              goto LABEL_54;
            }

            v49 = v46 - v32;
            if (v46 - v32 >= 0x10000)
            {
              v44 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                LODWORD(v108) = v49;
                _os_log_impl(&dword_1A7AD9000, v44, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: ProbingTimeout: differenceInMS: %u is out of scope", buf, 8u);
              }

              LOWORD(v44) = -1;
              LOWORD(v49) = -1;
            }

            else
            {
              LOWORD(v44) = -1;
            }
          }

          else
          {
            v47 = [v44 objectAtIndexedSubscript:0];
            unsignedIntValue3 = [v47 unsignedIntValue];

            v49 = ((vcvtd_n_f64_u32(unsignedIntValue3, 0x10uLL) + HIWORD(unsignedIntValue3)) * 1000.0) - v32;
            if (v49 >= 0x10000)
            {
              v50 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                LODWORD(v108) = v49;
                _os_log_impl(&dword_1A7AD9000, v50, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: differenceInMS: %u is out of scope", buf, 8u);
              }

              LOWORD(v49) = -1;
            }

            ++v40;
            v51 = [v44 objectAtIndexedSubscript:1];
            [v51 doubleValue];
            LODWORD(v44) = (v52 * 1000.0);

            if (v44 >= 0x10000)
            {
              LOWORD(v44) = -2;
            }
          }

          ++v41;
          v53 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v49];
          v105[0] = v53;
          v54 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v44];
          v105[1] = v54;
          v55 = [MEMORY[0x1E695DEC8] arrayWithObjects:v105 count:2];
          [v96 addObject:v55];

LABEL_54:
          ++v43;
        }

        while (v39 != v43);
        v56 = [obj countByEnumeratingWithState:&v97 objects:v106 count:16];
        v39 = v56;
      }

      while (v56);
LABEL_64:

      v57 = 0;
      if (key)
      {
        self = selfCopy;
        if (selfCopy->_linkIDToReorderedPackets)
        {
          v57 = CFDictionaryGetValue(selfCopy->_linkIDToReorderedPackets, key);
        }
      }

      else
      {
        self = selfCopy;
      }

      v58 = v57;
      Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
      v60 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v32];
      if (v60)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-time-stamp-key", v60);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-time-stamp-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v61 = v58;
      if (v61)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-reordered-packets-key", v61);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-number-reordered-packets-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v62 = v96;
      if (v62)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-probing-request-offset-rtt-key", v62);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v108 = @"ids-extchannel-probing-request-offset-rtt-key";
        v109 = 2080;
        v110 = "linkStatus";
        _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
      }

      v63 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v41];
      if (v63)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-requests-key", v63);
        v17 = v88;
      }

      else
      {
        v17 = v88;
        if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v108 = @"ids-extchannel-number-requests-key";
          v109 = 2080;
          v110 = "linkStatus";
          _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
        }
      }

      v64 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:v40];
      if (v64)
      {
        CFDictionarySetValue(Mutable, @"ids-extchannel-number-response-key", v64);
        v65 = key;
        v66 = v92;
      }

      else
      {
        v65 = key;
        v66 = v92;
        if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v108 = @"ids-extchannel-number-response-key";
          v109 = 2080;
          v110 = "linkStatus";
          _os_log_error_impl(&dword_1A7AD9000, MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR, "REQUIRED_ATTRIBUTE - Warning, missing %@ to add to %s", buf, 0x16u);
        }
      }

      [(__CFDictionary *)theDict setObject:Mutable forKeyedSubscript:v65];
      if (v65)
      {
        linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
        if (linkIDToReorderedPackets)
        {
          CFDictionaryRemoveValue(linkIDToReorderedPackets, v65);
        }

        v68 = self->_linkIDToRequestTimeStampAndRTT;
        if (v68)
        {
          CFDictionaryRemoveValue(v68, v65);
        }
      }

      if ([v66 count])
      {
        v69 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v69, OS_LOG_TYPE_DEFAULT))
        {
          v70 = [v66 count];
          *buf = 134217984;
          v108 = v70;
          _os_log_impl(&dword_1A7AD9000, v69, OS_LOG_TYPE_DEFAULT, "queryLinkProbingStatus: remainingTimeStamp count: %lu", buf, 0xCu);
        }

        if (self->_linkIDToRequestTimeStampAndRTT)
        {
          if (v66)
          {
            goto LABEL_98;
          }
        }

        else
        {
          v71 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          v72 = self->_linkIDToRequestTimeStampAndRTT;
          self->_linkIDToRequestTimeStampAndRTT = v71;

          if (v66)
          {
LABEL_98:
            CFDictionarySetValue(self->_linkIDToRequestTimeStampAndRTT, v65, v66);
          }
        }
      }

      v15 = v89;
      v16 = v83;
      v12 = v84;
      v14 = v86;
      v20 = v87;
LABEL_100:

      ++v17;
    }

    while (v17 != v14);
    v73 = [(__CFString *)v12 countByEnumeratingWithState:&v101 objects:v117 count:16];
    v14 = v73;
  }

  while (v73);
LABEL_107:

  if ([(__CFArray *)v15 count])
  {
    v74 = [(__CFString *)v12 mutableCopy];
    [v74 removeObjectsInArray:v15];
    v75 = [MEMORY[0x1E695DEC8] arrayWithArray:v74];

    v12 = v75;
  }

  if (!theDict)
  {
    theDict = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  }

  v76 = v12;
  if (v76)
  {
    CFDictionarySetValue(theDict, v80, v76);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E174C0();
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v78 = objc_opt_respondsToSelector();

  if (v78)
  {
    v79 = objc_loadWeakRetained(&self->_delegate);
    [v79 link:self didGetLinkProbingStatus:theDict];
  }
}

- (void)flushLinkProbingStatus:(id)status
{
  v30 = *MEMORY[0x1E69E9840];
  statusCopy = status;
  v5 = [statusCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [statusCopy objectForKeyedSubscript:@"ids-extchannel-probing-link-ids-key"];
    v7 = [v6 isEqualToString:@"ids-extchannel-probing-all-links-value"];

    if (v7)
    {
      v8 = [(NSMutableArray *)self->_connectedLinkIDs copy];
      goto LABEL_9;
    }
  }

  else
  {
  }

  Value = 0;
  if (statusCopy && @"ids-extchannel-probing-link-ids-key")
  {
    Value = CFDictionaryGetValue(statusCopy, @"ids-extchannel-probing-link-ids-key");
  }

  v8 = Value;
LABEL_9:
  v23 = 0u;
  v24 = 0u;
  v21 = 0u;
  v22 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v21 objects:v29 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v22;
    do
    {
      v14 = 0;
      do
      {
        if (*v22 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v21 + 1) + 8 * v14);
        if (v15)
        {
          linkIDToReorderedPackets = self->_linkIDToReorderedPackets;
          if (linkIDToReorderedPackets)
          {
            CFDictionaryRemoveValue(linkIDToReorderedPackets, *(*(&v21 + 1) + 8 * v14));
          }

          linkIDToRequestTimeStampAndRTT = self->_linkIDToRequestTimeStampAndRTT;
          if (linkIDToRequestTimeStampAndRTT)
          {
            CFDictionaryRemoveValue(linkIDToRequestTimeStampAndRTT, v15);
          }

          linkIDToHBCounter = self->_linkIDToHBCounter;
          if (linkIDToHBCounter)
          {
            CFDictionaryRemoveValue(linkIDToHBCounter, v15);
          }
        }

        ++v14;
      }

      while (v12 != v14);
      v12 = [v10 countByEnumeratingWithState:&v21 objects:v29 count:16];
    }

    while (v12);
  }

  v19 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    activeProbingLinkIDs = self->_activeProbingLinkIDs;
    *buf = 138412546;
    v26 = v10;
    v27 = 2112;
    v28 = activeProbingLinkIDs;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "flushLinkProbingStatus: linkIDs: %@, activeProbingLinkIDs: %@", buf, 0x16u);
  }
}

- (void)sendStatsRequestForClient:(id)client
{
  v20 = *MEMORY[0x1E69E9840];
  clientCopy = client;
  v5 = [clientCopy objectForKeyedSubscript:@"linkid-key"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = [clientCopy objectForKeyedSubscript:@"ids-extchannel-stat-identifier-key"];
    objc_opt_class();
    isKindOfClass = objc_opt_isKindOfClass();

    if (isKindOfClass)
    {
      Value = 0;
      if (clientCopy && @"linkid-key")
      {
        Value = CFDictionaryGetValue(clientCopy, @"linkid-key");
      }

      v9 = Value;
      v10 = 0;
      if (clientCopy && @"ids-extchannel-stat-identifier-key")
      {
        v10 = CFDictionaryGetValue(clientCopy, @"ids-extchannel-stat-identifier-key");
      }

      v11 = v10;
      v12 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = 138412546;
        v17 = v9;
        v18 = 2112;
        v19 = v11;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "sendStatsRequestForClient: linkID: %@, statIdentifier: %@", &v16, 0x16u);
      }

      if (([v9 intValue]& 0x80000000) != 0 || [v9 intValue]>= self->_maxLinkID || (v13 = self->_candidatePairs[[v9 intValue]]) == 0)
      {
        p_super = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E175E8();
        }
      }

      else
      {
        p_super = &v13->super;
        if ([(IDSStunCandidatePair *)v13 isRelayStunCandidatePair])
        {
          [p_super setLastStatsReport:ids_monotonic_time()];
          if ([p_super isQUIC])
          {
            [p_super sendQUICStatsRequestWithOptions:clientCopy];
          }

          else
          {
            [p_super sendStatsRequest:0 options:clientCopy];
          }
        }

        else
        {
          v15 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E17578();
          }
        }
      }

      goto LABEL_23;
    }
  }

  else
  {
  }

  v9 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    sub_1A7E1753C();
  }

LABEL_23:
}

- (void)sendStatsRequest:(id)request
{
  v37 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  v5 = ids_monotonic_time();
  if (!self->_linkIDToStatsData)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    linkIDToStatsData = self->_linkIDToStatsData;
    self->_linkIDToStatsData = Mutable;
  }

  v8 = [requestCopy mutableCopy];
  v9 = self->_linkIDToStatsData;
  self->_linkIDToStatsData = v8;

  v34 = 0u;
  v35 = 0u;
  v32 = 0u;
  v33 = 0u;
  obj = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = [obj countByEnumeratingWithState:&v32 objects:v36 count:16];
  if (v10)
  {
    v11 = v10;
    v31 = *v33;
    v29 = requestCopy;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v33 != v31)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v32 + 1) + 8 * i);
        state = [v13 state];
        isRelayStunCandidatePair = [v13 isRelayStunCandidatePair];
        isSelfQRSession = [v13 isSelfQRSession];
        v17 = [requestCopy objectForKeyedSubscript:@"report-p2p-session-key"];
        bOOLValue = [v17 BOOLValue];

        if ((state - 5) >= 0xFFFFFFFFFFFFFFFELL && (isSelfQRSession & 1) == 0)
        {
          [v13 lastStatsReport];
          if (v5 - v19 >= [v13 statsIntervalInSeconds])
          {
            linkID = [v13 linkID];
            v21 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-send", linkID];
            v22 = [requestCopy objectForKeyedSubscript:v21];

            v23 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%d-recv", linkID];
            v24 = [requestCopy objectForKeyedSubscript:v23];

            if (v22 && v24)
            {
              [v22 unsignedIntValue];
              [v24 unsignedIntValue];
              if ((isRelayStunCandidatePair & 1) == 0)
              {
                requestCopy = v29;
                goto LABEL_21;
              }

LABEL_16:
              if ([v13 isQUIC])
              {
                v25 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                requestCopy = v29;
                v26 = [v29 objectForKeyedSubscript:@"report-p2p-session-key"];
                [(__CFDictionary *)v25 setObject:v26 forKeyedSubscript:@"report-p2p-session-key"];

                [v13 setLastStatsReport:v5];
                [v13 sendQUICStatsRequestWithOptions:v25];

                bOOLValue = 0;
              }

              else
              {
                [v13 setLastStatsReport:v5];
                [v13 sendStatsRequest:0 options:0];
                requestCopy = v29;
              }

LABEL_21:
            }

            else
            {
              if ((bOOLValue & isRelayStunCandidatePair) == 1)
              {
                goto LABEL_16;
              }

              requestCopy = v29;
              if (!bOOLValue)
              {
                continue;
              }

              bOOLValue = 1;
            }
          }

          if ((bOOLValue & isRelayStunCandidatePair) == 1 && [v13 isQUIC])
          {
            v27 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
            v28 = [MEMORY[0x1E696AD98] numberWithBool:1];
            [(__CFDictionary *)v27 setObject:v28 forKeyedSubscript:@"report-p2p-session-key"];

            [v13 setLastStatsReport:v5];
            [v13 sendQUICStatsRequestWithOptions:v27];
          }

          continue;
        }
      }

      v11 = [obj countByEnumeratingWithState:&v32 objects:v36 count:16];
    }

    while (v11);
  }
}

- (void)setReceivedRemoteDeviceVersion:(BOOL)version
{
  versionCopy = version;
  v22 = *MEMORY[0x1E69E9840];
  receivedRemoteDeviceVersion = self->_receivedRemoteDeviceVersion;
  v6 = +[IDSFoundationLog GlobalLink];
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);
  if (receivedRemoteDeviceVersion == versionCopy)
  {
    if (v7)
    {
      v8 = @"NO";
      if (self->_receivedRemoteDeviceVersion)
      {
        v9 = @"YES";
      }

      else
      {
        v9 = @"NO";
      }

      if (versionCopy)
      {
        v8 = @"YES";
      }

      v18 = 138412546;
      v19 = v9;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: _receivedRemoteDeviceVersion: %@ is the same as receivedRemoteDeviceVersion: %@", &v18, 0x16u);
    }

    goto LABEL_22;
  }

  if (v7)
  {
    v10 = @"NO";
    if (versionCopy)
    {
      v10 = @"YES";
    }

    v18 = 138412290;
    v19 = v10;
    _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "setReceivedRemoteDeviceVersion: %@", &v18, 0xCu);
  }

  self->_receivedRemoteDeviceVersion = versionCopy;
  if (versionCopy)
  {
    v11 = +[IDSStunRelayInterfaceInfoController sharedInstance];
    v12 = [v11 relayInterfaceInfoDeliveryStatus:self->_cbuuid];

    if (v12 == 1)
    {
      [(IDSGlobalLink *)self _sendRelayInterfaceInfo:0];
    }

    v13 = +[IDSStunConnectionDataController sharedInstance];
    v14 = [v13 deliveryStatus:self->_cbuuid];

    if (!v14)
    {
      [(IDSGlobalLink *)self _sendConnectionDataWithRemovedAddressList:0];
    }

    pendingCommandConnectionDataBlock = self->_pendingCommandConnectionDataBlock;
    if (pendingCommandConnectionDataBlock)
    {
      pendingCommandConnectionDataBlock[2]();
      v16 = self->_pendingCommandConnectionDataBlock;
      self->_pendingCommandConnectionDataBlock = 0;
    }

    pendingCommandRelayInterfaceInfoBlock = self->_pendingCommandRelayInterfaceInfoBlock;
    if (pendingCommandRelayInterfaceInfoBlock)
    {
      pendingCommandRelayInterfaceInfoBlock[2]();
      v6 = self->_pendingCommandRelayInterfaceInfoBlock;
      self->_pendingCommandRelayInterfaceInfoBlock = 0;
LABEL_22:
    }
  }
}

- (void)setRemoteDeviceVersion:(unsigned int)version
{
  v3 = *&version;
  v40 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    LODWORD(v38) = v3;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: version: %u", buf, 8u);
  }

  self->_remoteDeviceVersion = v3;
  v6 = +[IDSCellularLinkMonitor sharedInstance];
  [v6 setRemoteDeviceVersion:v3];

  [(IDSGlobalLink *)self setReceivedRemoteDeviceVersion:1];
  if (self->_remoteDeviceVersion == 1)
  {
    v34 = 0u;
    v35 = 0u;
    v32 = 0u;
    v33 = 0u;
    v7 = self->_localCandidateList;
    v8 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v32 objects:v39 count:16];
    if (v8)
    {
      v10 = v8;
      v11 = *v33;
      *&v9 = 138412290;
      v26 = v9;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v33 != v11)
          {
            objc_enumerationMutation(v7);
          }

          v13 = *(*(&v32 + 1) + 8 * i);
          if ([v13 radioAccessTechnology] == 8)
          {
            [v13 setRadioAccessTechnology:5];
            v14 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v26;
              v38 = v13;
              _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: update local %@ local RAT from NR to LTE", buf, 0xCu);
            }
          }
        }

        v10 = [(NSMutableArray *)v7 countByEnumeratingWithState:&v32 objects:v39 count:16];
      }

      while (v10);
    }

    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    v28 = 0u;
    v29 = 0u;
    v30 = 0u;
    v31 = 0u;
    v16 = [allValues countByEnumeratingWithState:&v28 objects:v36 count:16];
    if (v16)
    {
      v18 = v16;
      v19 = *v29;
      *&v17 = 138412290;
      v27 = v17;
      do
      {
        for (j = 0; j != v18; ++j)
        {
          if (*v29 != v19)
          {
            objc_enumerationMutation(allValues);
          }

          v21 = *(*(&v28 + 1) + 8 * j);
          local = [v21 local];
          radioAccessTechnology = [local radioAccessTechnology];

          if (radioAccessTechnology == 8)
          {
            local2 = [v21 local];
            [local2 setRadioAccessTechnology:5];

            v25 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v27;
              v38 = v21;
              _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "setRemoteDeviceVersion: update candidate pair %@ local RAT from NR to LTE", buf, 0xCu);
            }
          }
        }

        v18 = [allValues countByEnumeratingWithState:&v28 objects:v36 count:16];
      }

      while (v18);
    }
  }
}

- (void)requestPathMTUEvaluationForLinkID:(char)d
{
  if (self->_nwLink)
  {
    if (d < 0 || self->_maxLinkID <= d || (v4 = self->_candidatePairs[d]) == 0)
    {
      v5 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: no candidate pair", buf, 2u);
      }

      v4 = 0;
    }

    if (![(IDSStunCandidatePair *)v4 isRelayStunCandidatePair]&& ![(IDSStunCandidatePair *)v4 isVirtualRelayStunCandidatePair])
    {
      v6 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
      {
        *v13 = 0;
        _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: is not a relay link", v13, 2u);
      }
    }

    nwLink = self->_nwLink;
    local = [(IDSStunCandidatePair *)v4 local];
    address = [local address];
    remote = [(IDSStunCandidatePair *)v4 remote];
    external = [remote external];
    sessionID = [(IDSStunCandidatePair *)v4 sessionID];
    [(IDSNWLink *)nwLink requestPathMTUEvaluationForLocalAddress:address remoteAddress:external sessionID:sessionID type:5];
  }

  else
  {
    v4 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(&v4->super, OS_LOG_TYPE_DEFAULT))
    {
      *v15 = 0;
      _os_log_impl(&dword_1A7AD9000, &v4->super, OS_LOG_TYPE_DEFAULT, "requestPathMTUEvaluationForLinkID: could not request path MTU evaluation: no NWLink.", v15, 2u);
    }
  }
}

- (BOOL)_sendInfoRequest:(id)request relaySessionID:(id)d
{
  v34 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  dCopy = d;
  selfCopy = self;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v8 = v28 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v25 objects:v33 count:16];
  if (!v9)
  {
    goto LABEL_14;
  }

  v10 = v9;
  v11 = *v26;
  while (2)
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v26 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v25 + 1) + 8 * i);
      groupID = [v13 groupID];
      if (![groupID isEqualToString:requestCopy])
      {
        goto LABEL_11;
      }

      sessionID = [v13 sessionID];
      if (([sessionID isEqualToString:dCopy] & 1) == 0)
      {

LABEL_11:
        continue;
      }

      state = [v13 state];

      if (state == 4)
      {
        v20 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          linkID = [v13 linkID];
          *buf = 67109634;
          *v30 = linkID;
          *&v30[4] = 2112;
          *&v30[6] = requestCopy;
          *&v30[14] = 2112;
          *&v30[16] = dCopy;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "send info request using link %d for group %@, session %@.", buf, 0x1Cu);
        }

        if ([v13 isQUIC])
        {
          [v13 sendQUICInfoRequest];
        }

        else
        {
          [v13 sendInfoRequest:0];
        }

        v19 = 1;
        v17 = v8;
        goto LABEL_24;
      }
    }

    v10 = [v8 countByEnumeratingWithState:&v25 objects:v33 count:16];
    if (v10)
    {
      continue;
    }

    break;
  }

LABEL_14:

  if (selfCopy->_state < 2)
  {
    v19 = 0;
  }

  else
  {
    v17 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = _IDSLinkStateStrings[selfCopy->_state];
      *buf = 138413058;
      *v30 = selfCopy;
      *&v30[8] = 2080;
      *&v30[10] = v18;
      *&v30[18] = 2112;
      *&v30[20] = requestCopy;
      v31 = 2112;
      v32 = dCopy;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "%@ is in [%s] state, skip sending info request for group %@, session %@.", buf, 0x2Au);
    }

    v19 = 0;
LABEL_24:
  }

  return v19;
}

- (BOOL)_getSessionParticipants:(id)participants relaySessionID:(id)d options:(id)options
{
  v44 = *MEMORY[0x1E69E9840];
  participantsCopy = participants;
  dCopy = d;
  selfCopy = self;
  optionsCopy = options;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v37 = 0u;
  v38 = 0u;
  v35 = 0u;
  v10 = v36 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v35 objects:v43 count:16];
  if (!v11)
  {
    goto LABEL_14;
  }

  v12 = *v36;
  while (2)
  {
    for (i = 0; i != v11; ++i)
    {
      if (*v36 != v12)
      {
        objc_enumerationMutation(v10);
      }

      v14 = *(*(&v35 + 1) + 8 * i);
      groupID = [v14 groupID];
      if (![groupID isEqualToString:participantsCopy])
      {
        goto LABEL_11;
      }

      sessionID = [v14 sessionID];
      if (([sessionID isEqualToString:dCopy] & 1) == 0)
      {

LABEL_11:
        continue;
      }

      v17 = [v14 state] == 4;

      if (v17)
      {
        v21 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          linkID = [v14 linkID];
          *buf = 67109634;
          *v40 = linkID;
          *&v40[4] = 2112;
          *&v40[6] = participantsCopy;
          *&v40[14] = 2112;
          *&v40[16] = dCopy;
          _os_log_impl(&dword_1A7AD9000, v21, OS_LOG_TYPE_DEFAULT, "request participants session-info using link %d for group %@, session %@.", buf, 0x1Cu);
        }

        v24 = objc_alloc_init(MEMORY[0x1E695DF90]);
        CFDictionarySetValue(v24, @"gl-option-sessioninfo-request-type", &unk_1F1B20060);
        v25 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:{objc_msgSend(v14, "nextSessionInfoReqID")}];
        if (v25)
        {
          CFDictionarySetValue(v24, @"gl-option-sessioninfo-request-id", v25);
        }

        else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17658();
        }

        v26 = [optionsCopy objectForKey:@"gl-option-sessioninfo-command-flag"];
        unsignedIntValue = [v26 unsignedIntValue];

        if (unsignedIntValue)
        {
          v28 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:unsignedIntValue];
          if (v28)
          {
            CFDictionarySetValue(v24, @"gl-option-sessioninfo-command-flag", v28);
          }

          else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
          {
            sub_1A7E176E0();
          }
        }

        if ([v14 isQUIC])
        {
          [v14 sendQUICSessionInfoRequestWithOptions:v24];
        }

        else
        {
          [v14 sendSessionInfoRequest:0 options:v24];
        }

        goto LABEL_43;
      }
    }

    v11 = [v10 countByEnumeratingWithState:&v35 objects:v43 count:16];
    if (v11)
    {
      continue;
    }

    break;
  }

LABEL_14:

  if (optionsCopy)
  {
    if (selfCopy->_state >= 2)
    {
      v18 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v19 = _IDSLinkStateStrings[selfCopy->_state];
        *buf = 138413058;
        *v40 = selfCopy;
        *&v40[8] = 2080;
        *&v40[10] = v19;
        *&v40[18] = 2112;
        *&v40[20] = participantsCopy;
        v41 = 2112;
        v42 = dCopy;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "%@ is in [%s] state, skip sending session-info request for group %@, session %@.", buf, 0x2Au);
      }

      goto LABEL_19;
    }

    v29 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      *v40 = participantsCopy;
      *&v40[8] = 2112;
      *&v40[10] = dCopy;
      _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "trying cached response for group %@, session %@.", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v31 = participantsCopy;
        v32 = dCopy;
        _IDSLogTransport(@"GL", @"IDS", @"trying cached response for group %@, session %@.");
        if (_IDSShouldLog())
        {
          v31 = participantsCopy;
          v32 = dCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"trying cached response for group %@, session %@.");
        }
      }
    }

    [(IDSGlobalLink *)selfCopy connectWithSessionInfo:optionsCopy interfaceAddress:0 joinSession:0 completionHandler:0 withLocalInterfacePreference:0, v31, v32];
LABEL_43:
    v20 = 1;
  }

  else
  {
LABEL_19:
    v20 = 0;
  }

  return v20;
}

- (BOOL)_getSessionStreamInfo:(id)info relaySessionID:(id)d options:(id)options
{
  v68 = *MEMORY[0x1E69E9840];
  infoCopy = info;
  dCopy = d;
  optionsCopy = options;
  Value = 0;
  if (optionsCopy && @"gl-option-linkid")
  {
    Value = CFDictionaryGetValue(optionsCopy, @"gl-option-linkid");
  }

  intValue = [Value intValue];
  v11 = 0;
  if (optionsCopy && @"gl-option-sessioninfo-link-id-to-query")
  {
    v11 = CFDictionaryGetValue(optionsCopy, @"gl-option-sessioninfo-link-id-to-query");
  }

  intValue2 = [v11 intValue];
  v13 = intValue2;
  v14 = intValue2;
  if ((intValue2 & 0x80) != 0 || v14 >= self->_maxLinkID)
  {
    v15 = 0;
  }

  else
  {
    v15 = self->_candidatePairs[intValue2];
  }

  relayLinkID = [(IDSStunCandidatePair *)v15 relayLinkID];
  v16 = 0;
  if (optionsCopy && @"stream-info-generation-counter")
  {
    v16 = CFDictionaryGetValue(optionsCopy, @"stream-info-generation-counter");
  }

  unsignedIntValue = [v16 unsignedIntValue];
  if (v13 << 24)
  {
    if ((v14 & 0x80000000) == 0 && v14 < self->_maxLinkID)
    {
      v17 = v13;
LABEL_21:
      v18 = self->_candidatePairs[v17];
      goto LABEL_23;
    }
  }

  else if ((intValue & 0x80) == 0 && intValue < self->_maxLinkID)
  {
    v17 = intValue;
    goto LABEL_21;
  }

  v18 = 0;
LABEL_23:
  nextSessionInfoReqID = [(IDSStunCandidatePair *)v18 nextSessionInfoReqID];
  v20 = +[IDSFoundationLog GlobalLink];
  v53 = nextSessionInfoReqID;
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67110658;
    *v59 = unsignedIntValue;
    *&v59[4] = 1024;
    *&v59[6] = intValue;
    LOWORD(v60) = 1024;
    *(&v60 + 2) = v14;
    HIWORD(v60) = 1024;
    v61 = relayLinkID;
    v62 = 1024;
    v63 = nextSessionInfoReqID;
    v64 = 2112;
    v65 = infoCopy;
    v66 = 2112;
    v67 = dCopy;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "request session info (gc:%u, linkID:%1d, linkIDToQuery:%1d, relayLinkID:%04x, reqID:%08x) for group %@, session %@.", buf, 0x34u);
  }

  if (intValue < 0 || intValue >= self->_maxLinkID)
  {
    v21 = 0;
  }

  else
  {
    v21 = self->_candidatePairs[intValue];
  }

  v22 = v21;
  if ((v14 & 0x80000000) != 0 || v14 >= self->_maxLinkID)
  {
    v23 = 0;
  }

  else
  {
    v23 = self->_candidatePairs[v13];
  }

  v24 = v23;
  if (![(IDSStunCandidatePair *)v22 isSharedQRSession]|| ![(IDSStunCandidatePair *)v24 isSharedQRSession])
  {
    v30 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      *v59 = v22;
      *&v59[8] = 2112;
      v60 = v24;
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, "try to query with invalid candidate pairs: %@, %@ return", buf, 0x16u);
    }

    goto LABEL_43;
  }

  remote = [(IDSStunCandidatePair *)v22 remote];
  if (![remote external])
  {
    goto LABEL_48;
  }

  remote2 = [(IDSStunCandidatePair *)v24 remote];
  if (![remote2 external])
  {
LABEL_47:

LABEL_48:
    goto LABEL_49;
  }

  remote3 = [(IDSStunCandidatePair *)v22 remote];
  v27 = *([remote3 external] + 1);
  remote4 = [(IDSStunCandidatePair *)v24 remote];
  if (v27 != *([remote4 external] + 1))
  {

    goto LABEL_47;
  }

  remote5 = [(IDSStunCandidatePair *)v22 remote];
  external = [remote5 external];
  remote6 = [(IDSStunCandidatePair *)v24 remote];
  LOBYTE(external) = IsSameSA(external, [remote6 external]);

  if ((external & 1) == 0)
  {
    v30 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
    {
      remote7 = [(IDSStunCandidatePair *)v22 remote];
      remote8 = [(IDSStunCandidatePair *)v24 remote];
      *buf = 138412546;
      *v59 = remote7;
      *&v59[8] = 2112;
      v60 = remote8;
      v33 = "linkID's server: %@ is different from linkIDToQuery's server: %@, return";
LABEL_55:
      _os_log_impl(&dword_1A7AD9000, v30, OS_LOG_TYPE_DEFAULT, v33, buf, 0x16u);

      goto LABEL_43;
    }

    goto LABEL_43;
  }

LABEL_49:
  sessionID = [(IDSStunCandidatePair *)v22 sessionID];
  sessionID2 = [(IDSStunCandidatePair *)v24 sessionID];
  v38 = [sessionID isEqualToString:sessionID2];

  if (v38)
  {
    if (!v22)
    {
      v34 = 0;
      goto LABEL_45;
    }

    v30 = objc_alloc_init(MEMORY[0x1E695DF90]);
    CFDictionarySetValue(v30, @"gl-option-sessioninfo-request-type", &unk_1F1B20078);
    v39 = [MEMORY[0x1E696AD98] numberWithChar:v14];
    if (v39)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-link-id-to-query", v39);
      v40 = v53;
    }

    else
    {
      v40 = v53;
      if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E176E0();
      }
    }

    v41 = [MEMORY[0x1E696AD98] numberWithUnsignedShort:relayLinkID];
    if (v41)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-relay-link-id", v41);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1775C();
    }

    v42 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v40];
    if (v42)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-request-id", v42);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17658();
    }

    v43 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:unsignedIntValue];
    if (v43)
    {
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-generation-counter", v43);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E177E4();
    }

    if (optionsCopy && @"stream-info-published-streams" && (v44 = CFDictionaryGetValue(optionsCopy, @"stream-info-published-streams")) != 0)
    {
      v45 = v44;
      CFDictionarySetValue(v30, @"gl-option-sessioninfo-published-streams", v44);
    }

    else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E1786C();
      if (!optionsCopy)
      {
        goto LABEL_81;
      }
    }

    else if (!optionsCopy)
    {
      goto LABEL_81;
    }

    if (@"stream-info-subscribed-streams")
    {
      v46 = CFDictionaryGetValue(optionsCopy, @"stream-info-subscribed-streams");
      if (v46)
      {
        v47 = v46;
        CFDictionarySetValue(v30, @"gl-option-sessioninfo-subscribed-streams", v46);

LABEL_83:
        if (@"stream-info-max-concurrent-streams")
        {
          v48 = CFDictionaryGetValue(optionsCopy, @"stream-info-max-concurrent-streams");
          if (v48)
          {
            v49 = v48;
            CFDictionarySetValue(v30, @"gl-option-sessioninfo-max-concurrent-streams", v48);
          }
        }

        goto LABEL_86;
      }
    }

LABEL_81:
    if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
    {
      sub_1A7E178F4();
      if (optionsCopy)
      {
        goto LABEL_83;
      }
    }

    else if (optionsCopy)
    {
      goto LABEL_83;
    }

LABEL_86:
    if ([(IDSStunCandidatePair *)v22 isQUIC])
    {
      [(IDSStunCandidatePair *)v22 sendQUICSessionInfoRequestWithOptions:v30];
    }

    else
    {
      [(IDSStunCandidatePair *)v22 sendSessionInfoRequest:0 options:v30];
    }

    v34 = 1;
    goto LABEL_44;
  }

  v30 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
  {
    remote7 = [(IDSStunCandidatePair *)v22 sessionID];
    remote8 = [(IDSStunCandidatePair *)v24 sessionID];
    *buf = 138412546;
    *v59 = remote7;
    *&v59[8] = 2112;
    v60 = remote8;
    v33 = "linkID's session %@, linkIDToQuery's session: %@ are different, return";
    goto LABEL_55;
  }

LABEL_43:
  v34 = 0;
LABEL_44:

LABEL_45:
  return v34;
}

- (void)getSessionInfo:(id)info relaySessionID:(id)d requestType:(int64_t)type options:(id)options
{
  v23 = *MEMORY[0x1E69E9840];
  infoCopy = info;
  dCopy = d;
  optionsCopy = options;
  v13 = optionsCopy;
  if (type == 2)
  {
    if ([(IDSGlobalLink *)self _getSessionStreamInfo:infoCopy relaySessionID:dCopy options:optionsCopy])
    {
      goto LABEL_12;
    }
  }

  else if (type == 1)
  {
    v14 = [optionsCopy objectForKey:@"gl-option-info-request-type"];
    unsignedIntegerValue = [v14 unsignedIntegerValue];

    if (unsignedIntegerValue == 1)
    {
      if ([(IDSGlobalLink *)self _sendInfoRequest:infoCopy relaySessionID:dCopy])
      {
        goto LABEL_12;
      }
    }

    else if ([(IDSGlobalLink *)self _getSessionParticipants:infoCopy relaySessionID:dCopy options:v13])
    {
      goto LABEL_12;
    }
  }

  v16 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = 138412802;
    v18 = infoCopy;
    v19 = 2112;
    v20 = dCopy;
    v21 = 1024;
    typeCopy = type;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "get session info failed for group %@, session %@, request-type %d.", &v17, 0x1Cu);
  }

  [(IDSGlobalLink *)self _notifySessionInfoReceived:0 relayGroupID:infoCopy relaySessionID:dCopy status:5];
LABEL_12:
}

- (void)updateSessionParticipants:(id)participants relaySessionID:(id)d participants:(id)a5
{
  v32 = *MEMORY[0x1E69E9840];
  participantsCopy = participants;
  dCopy = d;
  v22 = a5;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v11 = [allValues countByEnumeratingWithState:&v23 objects:v31 count:16];
  if (v11)
  {
    v13 = v11;
    v14 = *v24;
    *&v12 = 138412546;
    v21 = v12;
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v24 != v14)
        {
          objc_enumerationMutation(allValues);
        }

        v16 = *(*(&v23 + 1) + 8 * i);
        sessionID = [v16 sessionID];
        if ([sessionID isEqualToString:dCopy])
        {
          groupID = [v16 groupID];
          v19 = [groupID isEqualToString:participantsCopy];

          if (v19)
          {
            v20 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
            {
              *buf = v21;
              v28 = participantsCopy;
              v29 = 2112;
              v30 = dCopy;
              _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "updateSessionParticipants for group %@, session %@.", buf, 0x16u);
            }

            [v16 updateParticipantIDMap:v22];
          }
        }

        else
        {
        }
      }

      v13 = [allValues countByEnumeratingWithState:&v23 objects:v31 count:16];
    }

    while (v13);
  }
}

- (void)registerPluginWithOptions:(id)options relayGroupID:(id)d
{
  v24 = *MEMORY[0x1E69E9840];
  optionsCopy = options;
  dCopy = d;
  linkIDForPlugin = self->_linkIDForPlugin;
  if (linkIDForPlugin < 0 || self->_maxLinkID <= linkIDForPlugin)
  {
    v9 = 0;
  }

  else
  {
    v9 = self->_candidatePairs[self->_linkIDForPlugin];
  }

  v10 = v9;
  Value = 0;
  if (optionsCopy && @"gl-option-plugin-name")
  {
    Value = CFDictionaryGetValue(optionsCopy, @"gl-option-plugin-name");
  }

  [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict setObject:optionsCopy forKey:Value];
  groupID = [(IDSStunCandidatePair *)v10 groupID];
  if ([groupID isEqualToString:dCopy] && -[IDSStunCandidatePair state](v10, "state") == 4)
  {
    isSharedQRSession = [(IDSStunCandidatePair *)v10 isSharedQRSession];

    if (isSharedQRSession)
    {
      v14 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v18 = 138412546;
        v19 = dCopy;
        v20 = 2112;
        v21 = optionsCopy;
        _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "Register plugin for group %@ and options %@", &v18, 0x16u);
      }

      if ([(IDSStunCandidatePair *)v10 isQUIC])
      {
        [(IDSStunCandidatePair *)v10 sendQUICPluginRegistrationRequestWithOptions:optionsCopy];
      }

      else
      {
        [(IDSStunCandidatePair *)v10 sendQRPluginRegistrationRequest:0 options:optionsCopy];
      }

      goto LABEL_19;
    }
  }

  else
  {
  }

  v15 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [(__CFDictionary *)optionsCopy objectForKeyedSubscript:@"gl-option-plugin-name"];
    v17 = self->_linkIDForPlugin;
    v18 = 138412802;
    v19 = v16;
    v20 = 2112;
    v21 = dCopy;
    v22 = 1024;
    v23 = v17;
    _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "FAILED: Register plugin %@ for group %@. linkID %d is not for a valid link", &v18, 0x1Cu);
  }

LABEL_19:
}

- (void)setForceTCPFallbackOnWiFi:(BOOL)fi
{
  fiCopy = fi;
  v9 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (fiCopy)
    {
      v6 = @"YES";
    }

    v7 = 138412290;
    v8 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Setting ForceTCPFallbackOnWiFi %@", &v7, 0xCu);
  }

  self->_forceTCPFallbackOnWiFi = fiCopy;
}

- (void)setForceTCPFallbackOnCell:(BOOL)cell
{
  cellCopy = cell;
  v9 = *MEMORY[0x1E69E9840];
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = @"NO";
    if (cellCopy)
    {
      v6 = @"YES";
    }

    v7 = 138412290;
    v8 = v6;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Setting ForceTCPFallbackOnCell %@", &v7, 0xCu);
  }

  self->_forceTCPFallbackOnCell = cellCopy;
}

- (unint64_t)createAliasForParticipantID:(unint64_t)d salt:(id)salt relayGroupID:(id)iD
{
  v31 = *MEMORY[0x1E69E9840];
  saltCopy = salt;
  iDCopy = iD;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v10 = v25 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v22 objects:v30 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v23;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v23 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v22 + 1) + 8 * i);
        groupID = [v15 groupID];
        if ([groupID isEqualToString:iDCopy] && objc_msgSend(v15, "state") == 4)
        {
          isSharedQRSession = [v15 isSharedQRSession];

          if (isSharedQRSession)
          {
            v18 = [v15 createAliasForParticipantID:d salt:saltCopy];
            if (v18)
            {
              v19 = v18;
              v20 = v10;
              goto LABEL_17;
            }
          }
        }

        else
        {
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v22 objects:v30 count:16];
    }

    while (v12);
  }

  v20 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    dCopy = d;
    v28 = 2112;
    v29 = saltCopy;
    _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "createAliasForParticipantID could not find participantID %llu salt %@", buf, 0x16u);
  }

  v19 = 0;
LABEL_17:

  return v19;
}

- (unint64_t)participantIDForAlias:(unint64_t)alias salt:(id)salt relayGroupID:(id)d
{
  aliasCopy = alias;
  v39 = *MEMORY[0x1E69E9840];
  saltCopy = salt;
  dCopy = d;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v8 = v31 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v28 objects:v38 count:16];
  if (!v9)
  {
    goto LABEL_20;
  }

  v10 = v9;
  v11 = *v29;
  do
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v29 != v11)
      {
        objc_enumerationMutation(v8);
      }

      v13 = *(*(&v28 + 1) + 8 * i);
      groupID = [v13 groupID];
      if (![groupID isEqualToString:dCopy] || objc_msgSend(v13, "state") != 4)
      {

LABEL_12:
        groupID2 = [v13 groupID];
        v18 = [groupID2 isEqualToString:dCopy];

        if (v18)
        {
          v19 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            state = [v13 state];
            isSharedQRSession = [v13 isSharedQRSession];
            *buf = 134218242;
            v22 = @"NO";
            if (isSharedQRSession)
            {
              v22 = @"YES";
            }

            v33 = state;
            v34 = 2112;
            v35 = v22;
            _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "participantIDForAlias: found candidate pair with state: %lu, isSharedSession: %@", buf, 0x16u);
          }
        }

        continue;
      }

      isSharedQRSession2 = [v13 isSharedQRSession];

      if (!isSharedQRSession2)
      {
        goto LABEL_12;
      }

      v16 = [v13 participantIDForAlias:aliasCopy salt:saltCopy];
      if (v16)
      {
        v23 = v16;
        v24 = v8;
        goto LABEL_23;
      }
    }

    v10 = [v8 countByEnumeratingWithState:&v28 objects:v38 count:16];
  }

  while (v10);
LABEL_20:

  v24 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v33 = aliasCopy;
    v34 = 2112;
    v35 = saltCopy;
    v36 = 2112;
    v37 = dCopy;
    _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "participantIDForAlias could not find candidate pair that matches the alias %llu salt %@, for %@", buf, 0x20u);
  }

  v23 = 0;
LABEL_23:

  return v23;
}

- (void)linksQualityDeltaSince:(id)since completionHandler:(id)handler
{
  handlerCopy = handler;
  qualityMeasurer = self->_qualityMeasurer;
  v9[0] = MEMORY[0x1E69E9820];
  v9[1] = 3221225472;
  v9[2] = sub_1A7BBB638;
  v9[3] = &unk_1E77E1298;
  v10 = handlerCopy;
  v8 = handlerCopy;
  [(IDSLinksQualityMeasurer *)qualityMeasurer deltaSince:since completionHandler:v9];
}

- (void)importQualityMeasurementDelta:(id)delta sourceName:(id)name completionHandler:(id)handler
{
  handlerCopy = handler;
  qualityMeasurer = self->_qualityMeasurer;
  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = sub_1A7BBB6F8;
  v11[3] = &unk_1E77E0B48;
  v12 = handlerCopy;
  v10 = handlerCopy;
  [(IDSLinksQualityMeasurer *)qualityMeasurer importDelta:delta sourceName:name completionHandler:v11];
}

- (void)importLinkEngineQualityMeasurementDelta:(id)delta sourceName:(id)name completionHandler:(id)handler
{
  v29 = *MEMORY[0x1E69E9840];
  deltaCopy = delta;
  nameCopy = name;
  handlerCopy = handler;
  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "importLinkEngineQualityMeasurementDelta: collecting LinkEngines...", buf, 2u);
  }

  allLinkEngines = [(IDSGlobalLink *)self allLinkEngines];
  v12 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = [allLinkEngines count];
    *buf = 134217984;
    v28 = v13;
    _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "importLinkEngineQualityMeasurementDelta: collected %lu LinkEngines...", buf, 0xCu);
  }

  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v23 = 0u;
  v14 = allLinkEngines;
  v15 = [v14 countByEnumeratingWithState:&v22 objects:v26 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v23;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v23 != v17)
        {
          objc_enumerationMutation(v14);
        }

        v19 = *(*(&v22 + 1) + 8 * i);
        v20 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v28 = v19;
          _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "... importing into %@", buf, 0xCu);
        }

        [v19 importQualityDelta:deltaCopy source:nameCopy];
      }

      v16 = [v14 countByEnumeratingWithState:&v22 objects:v26 count:16];
    }

    while (v16);
  }

  handlerCopy[2](handlerCopy);
}

- (BOOL)link:(id)link didReceivePacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid
{
  v147 = *MEMORY[0x1E69E9840];
  linkCopy = link;
  dCopy = d;
  cbuuidCopy = cbuuid;
  if (packet)
  {
    var2 = packet->var2;
    if (!var2 && packet->var35 == 200)
    {
      LOBYTE(packet) = 0;
      goto LABEL_199;
    }

    v14 = vdupq_n_s64(1uLL);
    v14.i64[0] = packet->var2;
    *&self->_totalBytesReceived = vaddq_s64(*&self->_totalBytesReceived, v14);
    v15 = ids_monotonic_time();
    if (packet->var13)
    {
      LOBYTE(packet) = -[IDSGlobalLink _processProtoPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:](self, "_processProtoPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:", packet, dCopy, cbuuidCopy, [linkCopy headerOverhead], v15);
      goto LABEL_199;
    }

    var36 = packet->var36;
    if (packet->var2 > 3 || packet->var36)
    {
      if (packet->var36)
      {
        if (IDSSimpleUInt16List_HasItem(&self->_channelNumberList, packet->var36))
        {
          v121 = (var36 & 0xF0) == 96;
          v17 = StunUtilProcessIncomingChannelDataWithoutChannelHeader(packet, (var36 & 0xF0) == 96, LOWORD(packet->var2));
LABEL_14:
          v18 = v17;
          key = channelForStunCandidatePair(&packet->var18, &packet->var19, var36);
          channelToCandidatePairs = self->_channelToCandidatePairs;
          if (channelToCandidatePairs && key)
          {
            v20 = CFDictionaryGetValue(channelToCandidatePairs, key);
            p_var14 = &packet->var24[0].var14;
            if (packet->var24[0].var14 >= 1 && v20)
            {
              v111 = v20;
              v22 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v20 relayLinkID], packet->var24[0].var15[0]);
              localRemoteRelayLinkIDToVirtualCandidatePairs = self->_localRemoteRelayLinkIDToVirtualCandidatePairs;
              if (localRemoteRelayLinkIDToVirtualCandidatePairs && v22 && (v24 = CFDictionaryGetValue(localRemoteRelayLinkIDToVirtualCandidatePairs, v22)) != 0)
              {
                __src = v24;
                linkID = [v24 linkID];
                if (linkID < 1)
                {
                  v26 = 0;
                }

                else
                {
                  v26 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, linkID);
                }

                if (v26)
                {
                  ++*(v26 + 83);
                  v26[43] += var2;
                }
              }

              else
              {

                __src = 0;
              }

              p_var14 = &packet->var24[0].var14;
              v29 = v111;
              if ((v18 & 1) == 0)
              {
                goto LABEL_207;
              }

LABEL_35:
              if (packet->var23 >= 1)
              {
                if (packet->var24[0].var19)
                {
                  if (*p_var14 < 1)
                  {
                    v30 = 0;
                  }

                  else
                  {
                    v30 = packet->var24[0].var15[0];
                  }

                  v73 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v73, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 67109120;
                    *&buf[4] = v30;
                    _os_log_impl(&dword_1A7AD9000, v73, OS_LOG_TYPE_DEFAULT, "received command message with remote relay linkID %u", buf, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v110 = v30;
                      _IDSLogTransport(@"GL", @"IDS", @"received command message with remote relay linkID %u");
                      if (_IDSShouldLog())
                      {
                        v110 = v30;
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"received command message with remote relay linkID %u");
                      }
                    }
                  }

                  LOBYTE(packet) = [(IDSGlobalLink *)self _processChannelDataCommandMessage:packet remoteRelayLinkID:v30 channelNumber:var36 fromDeviceUniqueID:dCopy cbuuid:cbuuidCopy arrivalTime:v15, v110];
                  goto LABEL_214;
                }

                if ((packet->var24[0].var20 & 0x80000) != 0)
                {
                  v62 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 0;
                    _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "received echo packet", buf, 2u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"received echo packet");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"received echo packet");
                      }
                    }
                  }

                  v63 = [MEMORY[0x1E695DEF0] dataWithBytes:packet->var0 length:packet->var2];
                  [v29 receiveLinkTestStatsPacket:v63];
                  if (self->_useLinkSelection)
                  {
                    linkEngine = [v29 linkEngine];
                    v65 = linkEngine == 0;

                    if (!v65)
                    {
                      linkEngine2 = [v29 linkEngine];
                      linkUniqueName = [v29 linkUniqueName];
                      [linkEngine2 didReceiveStatsTestPacketWithPayload:v63 linkName:linkUniqueName completionHandler:&unk_1F1AAA480];
                    }
                  }

                  goto LABEL_213;
                }
              }

              linkEngine3 = [__src linkEngine];

              if (linkEngine3)
              {
                v54 = __src;
                v55 = v29;
                if (([__src hasReceivedData] & 1) == 0)
                {
                  [(IDSGlobalLink *)self didReceiveFirstDataOnCandidatePair:__src];
                }
              }

              else
              {
                v55 = v29;
                v54 = __src;
                if (IDSSimpleUInt16List_HasItem(&self->_reallocChannelList, var36))
                {
                  [(IDSGlobalLink *)self _processReallocChannelData:packet channelNumber:var36 fromDeviceUniqueID:dCopy cbuuid:cbuuidCopy arrivalTime:v15];
                }
              }

              if ([v54 useQualityMetadata])
              {
                qualityHandler = [v54 qualityHandler];
                v57 = [qualityHandler readQualityBytesFromPacketReturingDeduplicationID:packet->var0 packetEnd:&packet->var0[packet->var2]];

                if ((v57 & 0x80) == 0)
                {
                  packet->var41 = v57 & 0x7F;
                  packet->var40 = 1;
                  packetDeduplicator = self->_packetDeduplicator;
                  if (packetDeduplicator)
                  {
                    if (![(IDSPacketDeduplicator *)packetDeduplicator markPacketAsReceivedWithSequenceNumber:?])
                    {
LABEL_213:
                      LOBYTE(packet) = 1;
LABEL_214:

                      goto LABEL_199;
                    }
                  }
                }

                StunUtilSkipQualityMetadata(packet);
                v55 = v29;
                v54 = __src;
              }

              goto LABEL_44;
            }
          }

          else
          {
            v20 = 0;
            p_var14 = &packet->var24[0].var14;
          }

          v29 = v20;
          __src = v29;
          if ((v18 & 1) == 0)
          {
LABEL_207:
            v108 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v108, OS_LOG_TYPE_DEFAULT))
            {
              v109 = packet->var2;
              *buf = 134217984;
              *&buf[4] = v109;
              _os_log_impl(&dword_1A7AD9000, v108, OS_LOG_TYPE_DEFAULT, "drop channel data (%zdB).", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"drop channel data (%zdB).");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"drop channel data (%zdB).");
                }
              }
            }

            goto LABEL_213;
          }

          goto LABEL_35;
        }
      }

      else
      {
        var36 = *packet->var0;
        if (IDSSimpleUInt16List_HasItem(&self->_channelNumberList, *packet->var0))
        {
          v121 = (var36 & 0xF0) == 96;
          v17 = StunUtilProcessIncomingChannelData(packet, (var36 & 0xF0) == 96);
          goto LABEL_14;
        }
      }

      if ((var36 & 0xC0) != 0)
      {
        if (self->_shouldProcessBasebandNotification && packet->var2 >= 4 && *packet->var0 == -272716322)
        {
          LODWORD(var36) = self->_basebandPacketChannelNumber;
          v27 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEBUG, "receive baseband notification packet.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
          {
            _IDSLogV(1, @"IDSFoundation", @"GL", @"receive baseband notification packet.");
          }

          v121 = 0;
          v28 = 1;
          goto LABEL_45;
        }
      }

      else if (packet->var2 >= 20 && *(packet->var0 + 1) == 1118048801)
      {
        -[IDSGlobalLink _processStunPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:](self, "_processStunPacket:fromDeviceUniqueID:cbuuid:arrivalTime:headerOverhead:", packet, dCopy, cbuuidCopy, [linkCopy headerOverhead], v15);
        LODWORD(var36) = 0;
        v121 = 0;
        v28 = 0;
        v31 = 0;
        goto LABEL_46;
      }

      LODWORD(var36) = 0;
    }

    v121 = 0;
LABEL_44:
    v28 = 0;
LABEL_45:
    v31 = 1;
LABEL_46:
    v32 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
    v33 = v32;
    if (v32)
    {
      v34 = IsSameSA((v32 + 1), &packet->var18);
      if (v34)
      {
        v34 = IsSameSA((v33 + 17), &packet->var19);
      }

      if (!v31)
      {
        goto LABEL_198;
      }
    }

    else
    {
      v34 = 0;
      if (!v31)
      {
LABEL_198:
        LOBYTE(packet) = 1;
        goto LABEL_199;
      }
    }

    var14 = packet->var24[0].var14;
    if (v34 && *(v33 + 132) == var36 && var14 <= 0)
    {
      if (v33)
      {
        v36 = v28;
      }

      else
      {
        v36 = 1;
      }

      if ((v36 & 1) == 0)
      {
        v33[39] = v15;
      }

      if (self->_supportChannelData)
      {
        v37 = *v33;
        packet->var25 = *v33;
        if (v121)
        {
          if ((v37 & 0x80) != 0 || v37 >= self->_maxLinkID)
          {
            v38 = 0;
          }

          else
          {
            v38 = self->_candidatePairs[v37];
          }

          keya = v38;
          capabilityFlags = [(IDSStunCandidatePair *)keya capabilityFlags];
          var23 = packet->var23;
          if (var23 >= 1)
          {
            v70 = capabilityFlags;
            v71 = 0;
            v72 = 536;
            do
            {
              if (v70 & 8) != 0 && (*(&packet->var0 + v72))
              {
                StunUtilGetMappedParticipantID(packet, v71, keya, 1);
                var23 = packet->var23;
              }

              ++v71;
              v72 += 96;
            }

            while (v71 < var23);
          }

          __srcb = -1;
LABEL_153:

          v39 = __srcb;
          if ((v28 & 1) == 0)
          {
            goto LABEL_154;
          }

          goto LABEL_195;
        }
      }

LABEL_66:
      v39 = -1;
      if ((v28 & 1) == 0)
      {
LABEL_154:
        var25 = packet->var25;
        __srcc = v39;
        if (var25 < 1)
        {
          v83 = 0;
        }

        else
        {
          v83 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, var25);
          v39 = __srcc;
        }

        keyb = v39;
        if (v39 < 1)
        {
          v84 = 0;
        }

        else
        {
          v84 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, v39);
        }

        if (v84)
        {
          v85 = v84;
        }

        else
        {
          v85 = v83;
        }

        if (v85)
        {
          if ((v85[88] & 1) == 0)
          {
            *(v85 + 352) = 1;
            v86 = *v85;
            if ((v86 & 0x80000000) == 0 && v86 < self->_maxLinkID)
            {
              v87 = self->_candidatePairs[v86];
              if (v87)
              {
                v88 = v87;
                linkMetrics = [(IDSStunCandidatePair *)v87 linkMetrics];
                [linkMetrics event:@"glr"];
              }
            }
          }
        }

        kdebug_trace();
        if (self->_firstDataReceivedTime == 0.0 && packet->var2 >= 1)
        {
          self->_reportDataReceivedTime = 1;
          self->_firstDataReceivedTime = v15;
          v90 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v90, OS_LOG_TYPE_DEFAULT))
          {
            if (self->_reportClientPacketTime)
            {
              v91 = @"YES";
            }

            else
            {
              v91 = @"NO";
            }

            *buf = 138412290;
            *&buf[4] = v91;
            _os_log_impl(&dword_1A7AD9000, v90, OS_LOG_TYPE_DEFAULT, "didReceivePacket: _firstDataReceivedTime, _reportClientPacketTime: %@", buf, 0xCu);
          }

          if (self->_reportClientPacketTime)
          {
            [(IDSGlobalLink *)self _reportSessionSetupTime];
            self->_reportDataReceivedTime = 0;
          }
        }

        if (v121)
        {
          v92 = packet->var25;
          if (v92 < 0 || self->_maxLinkID <= v92)
          {
            v93 = 0;
          }

          else
          {
            v93 = self->_candidatePairs[packet->var25];
          }

          v94 = v93;
          if ((packet->var24[0].var20 & 0x400) != 0)
          {
            var0 = packet->var0;
            v96 = packet->var2;
            v122 = v94;
            hbhDecKey = [(IDSStunCandidatePair *)v94 hbhDecKey];
            v98 = IDSHBHDecryptDataWithKey(var0, v96, hbhDecKey);

            if (!v98)
            {
              v107 = +[IDSFoundationLog GlobalLink];
              if (os_log_type_enabled(v107, OS_LOG_TYPE_ERROR))
              {
                sub_1A7E1797C();
              }

              goto LABEL_198;
            }

            packet->var2 = [v98 length];
            v99 = packet->var0;
            v100 = v98;
            memcpy(v99, [v98 bytes], packet->var2);

            v94 = v122;
          }
        }

        [(IDSGlobalLink *)self reportLinkMetricsForLinkID:packet->var25 lastPacketReceivedTime:ids_monotonic_time() lastPacketSentTime:0.0];
        packetLog = self->_packetLog;
        v102 = v85 == 0;
        if (!packetLog)
        {
          v102 = 1;
        }

        v39 = __srcc;
        if (!v102)
        {
          v103 = keyb < 1 ? 0 : packet->var25;
          v104 = sub_1A7BAF110(packet, *v85, v103, packetLog, v85);
          v39 = __srcc;
          if (v104)
          {
            [(IDSObjCPacketLog *)self->_packetLog recordPacketsWithPacketLogID:v104 kind:1 bytes:var2 packetCount:1];
            v39 = __srcc;
          }
        }
      }

LABEL_195:
      if (v39 != -1)
      {
        packet->var25 = v39;
      }

      packet->var6 = 1;
      packet->var28 = v15;
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      [WeakRetained link:self didReceivePacket:packet fromDeviceUniqueID:dCopy cbuuid:cbuuidCopy];

      goto LABEL_198;
    }

    if (packet->var15)
    {
      goto LABEL_66;
    }

    keya = channelForStunCandidatePair(&packet->var18, &packet->var19, var36);
    v40 = self->_channelToCandidatePairs;
    if (v40)
    {
      if (keya)
      {
        v41 = CFDictionaryGetValue(v40, keya);
        if (v41)
        {
          if ((v28 & 1) == 0)
          {
            v42 = v41;
            [v41 setLastIncomingPacketTime:v15];
            v41 = v42;
          }

          goto LABEL_73;
        }
      }
    }

    if (v28)
    {
      basebandPacketLinkID = self->_basebandPacketLinkID;
      if (self->_basebandPacketLinkID)
      {
        if (basebandPacketLinkID < 0 || self->_maxLinkID <= basebandPacketLinkID)
        {
          v50 = 0;
        }

        else
        {
          v49 = self->_candidatePairs[self->_basebandPacketLinkID];
          v50 = v49;
          if (v49)
          {
            __srca = [(IDSStunCandidatePair *)v49 remote];
            if (IsSameSA([__srca external], &packet->var19))
            {
              v51 = [(IDSStunCandidatePair *)v50 channelNumber]== var36;

              if (v51)
              {
                local = [(IDSStunCandidatePair *)v50 local];
                __srcd = [local address];

                memcpy(&packet->var18, __srcd, *__srcd);
                packet->var25 = self->_basebandPacketLinkID;

                v41 = 0;
LABEL_73:
                if (!self->_supportChannelData)
                {
                  __srcb = -1;
LABEL_152:

                  goto LABEL_153;
                }

                v112 = v41;
                packet->var25 = [v41 linkID];
                if (var14 < 1)
                {
                  linkID2 = -1;
LABEL_144:
                  v41 = v112;
                  __srcb = linkID2;
                  if (v121)
                  {
                    capabilityFlags2 = [v112 capabilityFlags];
                    v78 = packet->var23;
                    if (v78 >= 1)
                    {
                      v79 = capabilityFlags2;
                      v80 = 0;
                      v81 = 536;
                      do
                      {
                        if (v79 & 8) != 0 && (*(&packet->var0 + v81))
                        {
                          StunUtilGetMappedParticipantID(packet, v80, v112, 1);
                          v78 = packet->var23;
                        }

                        ++v80;
                        v81 += 96;
                      }

                      while (v80 < v78);
                    }

                    v41 = v112;
                  }

                  goto LABEL_152;
                }

                v43 = localRemoteRelayLinkIDForVirtualStunCandidatePair([v112 relayLinkID], packet->var24[0].var15[0]);
                v44 = self->_localRemoteRelayLinkIDToVirtualCandidatePairs;
                if (v44)
                {
                  if (v43)
                  {
                    v45 = CFDictionaryGetValue(v44, v43);
                    if (v45)
                    {
                      v46 = v45;
                      linkID2 = [v45 linkID];

                      goto LABEL_144;
                    }
                  }
                }

                *&v74 = 0xAAAAAAAAAAAAAAAALL;
                *(&v74 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v145 = v74;
                v146 = v74;
                v143 = v74;
                v144 = v74;
                v141 = v74;
                v142 = v74;
                *buf = v74;
                v140 = v74;
                v137 = v74;
                v138 = v74;
                v135 = v74;
                v136 = v74;
                v133 = v74;
                v134 = v74;
                *__str = v74;
                v132 = v74;
                v75 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
                {
                  v76 = packet->var2;
                  *v123 = 134218754;
                  v124 = v76;
                  v125 = 2112;
                  v126 = keya;
                  v127 = 2080;
                  v128 = SAToIPPortString(__str, 0x80uLL, &packet->var18);
                  v129 = 2080;
                  v130 = SAToIPPortString(buf, 0x80uLL, &packet->var19);
                  _os_log_impl(&dword_1A7AD9000, v75, OS_LOG_TYPE_DEFAULT, "No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]", v123, 0x2Au);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    SAToIPPortString(__str, 0x80uLL, &packet->var18);
                    SAToIPPortString(buf, 0x80uLL, &packet->var19);
                    _IDSLogTransport(@"GL", @"IDS", @"No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
                    if (_IDSShouldLog())
                    {
                      SAToIPPortString(__str, 0x80uLL, &packet->var18);
                      SAToIPPortString(buf, 0x80uLL, &packet->var19);
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"No valid virtual candidate pair. Drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
                    }
                  }
                }

                goto LABEL_142;
              }
            }

            else
            {
            }
          }
        }
      }
    }

    *&v59 = 0xAAAAAAAAAAAAAAAALL;
    *(&v59 + 1) = 0xAAAAAAAAAAAAAAAALL;
    v145 = v59;
    v146 = v59;
    v143 = v59;
    v144 = v59;
    v141 = v59;
    v142 = v59;
    *buf = v59;
    v140 = v59;
    v137 = v59;
    v138 = v59;
    v135 = v59;
    v136 = v59;
    v133 = v59;
    v134 = v59;
    *__str = v59;
    v132 = v59;
    v60 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
    {
      v61 = packet->var2;
      *v123 = 134218754;
      v124 = v61;
      v125 = 2112;
      v126 = keya;
      v127 = 2080;
      v128 = SAToIPPortString(__str, 0x80uLL, &packet->var18);
      v129 = 2080;
      v130 = SAToIPPortString(buf, 0x80uLL, &packet->var19);
      _os_log_impl(&dword_1A7AD9000, v60, OS_LOG_TYPE_DEFAULT, "drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]", v123, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        SAToIPPortString(__str, 0x80uLL, &packet->var18);
        SAToIPPortString(buf, 0x80uLL, &packet->var19);
        _IDSLogTransport(@"GL", @"IDS", @"drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
        if (_IDSShouldLog())
        {
          SAToIPPortString(__str, 0x80uLL, &packet->var18);
          SAToIPPortString(buf, 0x80uLL, &packet->var19);
          _IDSLogV(0, @"IDSFoundation", @"GL", @"drop incoming packet %zuB on channel %@, local address [%s], remote address [%s]");
        }
      }
    }

LABEL_142:

    goto LABEL_198;
  }

LABEL_199:

  return packet;
}

- (void)linkTransactionIDMismatchDetected:(id)detected
{
  [(IDSGFTMetricsCollector *)self->_metricsCollector transactionIDMismatchDetected];

  [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:&stru_1F1AC8480 subType:@"NWLinkError" subTypeContext:@"transactionIDMismatch" duration:15];
}

- (void)link:(id)link pathMTUDidChange:(unsigned __int16)change connectionInfo:(id)info
{
  changeCopy = change;
  v40 = *MEMORY[0x1E69E9840];
  linkCopy = link;
  infoCopy = info;
  localAddress = [infoCopy localAddress];
  remoteAddress = [infoCopy remoteAddress];
  if (localAddress)
  {
    v12 = remoteAddress;
    if (remoteAddress)
    {
      sessionID = [infoCopy sessionID];
      v14 = tokenForStunCandidatePair(localAddress, v12, sessionID);

      v15 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:v14];
      if (v14)
      {
        v16 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109634;
          *v37 = changeCopy;
          *&v37[4] = 1024;
          *&v37[6] = [v15 linkID];
          v38 = 2112;
          v39 = v15;
          _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@", buf, 0x18u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            linkID = [v15 linkID];
            v34 = v15;
            v30 = changeCopy;
            _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@");
            if (_IDSShouldLog())
            {
              linkID = [v15 linkID];
              v34 = v15;
              v30 = changeCopy;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: path MTU changed to %d for candidate pair with linkID=%d: %@");
            }
          }
        }

        if ([v15 pathMTU] != changeCopy)
        {
          v17 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
          {
            pathMTU = [v15 pathMTU];
            linkID2 = [v15 linkID];
            *buf = 67109632;
            *v37 = pathMTU;
            *&v37[4] = 1024;
            *&v37[6] = changeCopy;
            v38 = 1024;
            LODWORD(v39) = linkID2;
            _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d", buf, 0x14u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              pathMTU2 = [v15 pathMTU];
              v33 = changeCopy;
              linkID3 = [v15 linkID];
              v31 = pathMTU2;
              _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d");
              if (_IDSShouldLog())
              {
                pathMTU3 = [v15 pathMTU];
                v33 = changeCopy;
                linkID3 = [v15 linkID];
                v31 = pathMTU3;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: path MTU changed from %d to %d for candidatePair with linkID=%d");
              }
            }
          }

          v22 = -[IDSGFTMetricsCollector mtuChange:previous:](self->_metricsCollector, "mtuChange:previous:", changeCopy, [v15 pathMTU]);
          [v15 setPathMTU:changeCopy];
          [(IDSGlobalLink *)self _setLinkMetricsAttributesForCandidatePair:v15 linkAttributes:v22];
        }

        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v24 = objc_opt_respondsToSelector();

        if (v24)
        {
          v25 = objc_loadWeakRetained(&self->_delegate);
          [v25 link:self pathMTUDidChange:changeCopy forLinkID:{objc_msgSend(v15, "linkID")}];
        }

        else
        {
          v29 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "pathMTUDidChange: delegate does not implement pathMTUDidChange", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"pathMTUDidChange: delegate does not implement pathMTUDidChange");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"pathMTUDidChange: delegate does not implement pathMTUDidChange");
              }
            }
          }
        }
      }

      else
      {
        v28 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *v37 = 0;
          _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no candidate pair found for token %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no candidate pair found for token %@");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no candidate pair found for token %@");
            }
          }
        }
      }
    }

    else
    {
      v27 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v27, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no remote address on connectionInfo", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no remote address on connectionInfo");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no remote address on connectionInfo");
          }
        }
      }
    }
  }

  else
  {
    v26 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "WARNING: pathMTUDidChange: no local address on connectionInfo", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"WARNING: pathMTUDidChange: no local address on connectionInfo");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"WARNING: pathMTUDidChange: no local address on connectionInfo");
        }
      }
    }
  }
}

- (BOOL)_qrLinkLimitExceededWithNewLinkType:(unsigned __int8)type cellularRelayLinkCount:(unsigned __int16)count wifiRelayLinkCount:(unsigned __int16)linkCount
{
  if (self->_reduceRelayLinkCreation || self->_reduceCellularUsage)
  {
    v5 = 2;
  }

  else
  {
    v5 = 8;
  }

  if (linkCount + count >= v5)
  {
    return 1;
  }

  v6 = type == 4 || type == 8;
  if (v6 && count < 2u)
  {
    return 0;
  }

  return (type - 3) < 0xFFFFFFFE || linkCount > 1u;
}

- (unsigned)_getNewLinkType:(id)type remoteInterface:(int *)interface
{
  v91 = *MEMORY[0x1E69E9840];
  typeCopy = type;
  interfaceCopy = interface;
  *interface = 0;
  v6 = GLUtilGetRemainingInterfaces(self->_interfaceAddressArray);
  v7 = v6;
  if (!v6)
  {
    LOBYTE(v15) = 0;
    goto LABEL_82;
  }

  v81 = 0u;
  v82 = 0u;
  v79 = 0u;
  v80 = 0u;
  v8 = [v6 countByEnumeratingWithState:&v79 objects:v90 count:16];
  if (v8)
  {
    v9 = v8;
    v69 = 0;
    v10 = *v80;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v80 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v79 + 1) + 8 * i);
        delegatedName = [v12 delegatedName];

        if (!delegatedName)
        {
          if ([v12 isCellular])
          {
            v14 = 1;
          }

          else
          {
            v14 = 2;
          }

          v69 |= v14;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v79 objects:v90 count:16];
    }

    while (v9);
  }

  else
  {
    v69 = 0;
  }

  v77 = 0u;
  v78 = 0u;
  v75 = 0u;
  v76 = 0u;
  v16 = self->_remoteCandidateList;
  v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v75 objects:v89 count:16];
  if (v17)
  {
    v18 = v17;
    v19 = *v76;
    do
    {
      for (j = 0; j != v18; ++j)
      {
        if (*v76 != v19)
        {
          objc_enumerationMutation(v16);
        }

        v21 = *(*(&v75 + 1) + 8 * j);
        if (([v21 linkFlags] & 4) == 0)
        {
          if ([v21 isCellularStunCandidate])
          {
            v22 = 1;
          }

          else
          {
            v22 = 2;
          }

          *interfaceCopy |= v22;
        }
      }

      v18 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v75 objects:v89 count:16];
    }

    while (v18);
  }

  v65 = v7;

  v73 = 0u;
  v74 = 0u;
  v71 = 0u;
  v72 = 0u;
  selfCopy = self;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = [allValues countByEnumeratingWithState:&v71 objects:v88 count:16];
  if (!v24)
  {
    v68 = 0;
    v26 = 0;
    v27 = 0;
    goto LABEL_65;
  }

  v25 = v24;
  v68 = 0;
  v26 = 0;
  v27 = 0;
  v28 = *v72;
  do
  {
    v29 = 0;
    do
    {
      if (*v72 != v28)
      {
        objc_enumerationMutation(allValues);
      }

      v30 = *(*(&v71 + 1) + 8 * v29);
      state = [v30 state];
      isRelayStunCandidatePair = [v30 isRelayStunCandidatePair];
      v33 = isRelayStunCandidatePair;
      if (typeCopy)
      {
        if (state == 4)
        {
          v34 = isRelayStunCandidatePair;
        }

        else
        {
          v34 = 0;
        }

        if (v34 != 1)
        {
          goto LABEL_55;
        }

        sessionID = [v30 sessionID];
        v36 = [typeCopy isEqualToString:sessionID];

        if ((v36 & 1) == 0)
        {
          goto LABEL_55;
        }
      }

      else if (isRelayStunCandidatePair)
      {
        if (state != 4)
        {
          goto LABEL_55;
        }
      }

      else if (state != 3)
      {
        goto LABEL_55;
      }

      local = [v30 local];
      isCellularStunCandidate = [local isCellularStunCandidate];

      remote = [v30 remote];
      isCellularStunCandidate2 = [remote isCellularStunCandidate];

      if (isCellularStunCandidate2)
      {
        v41 = 8;
      }

      else
      {
        v41 = 4;
      }

      if (isCellularStunCandidate2)
      {
        v42 = 2;
      }

      else
      {
        v42 = 1;
      }

      if (isCellularStunCandidate)
      {
        v43 = 0;
      }

      else
      {
        v43 = v33;
      }

      v68 += v43;
      if (isCellularStunCandidate)
      {
        v44 = v33;
      }

      else
      {
        v44 = 0;
      }

      v26 += v44;
      if (!isCellularStunCandidate)
      {
        v41 = v42;
      }

      v27 |= v41;
LABEL_55:
      ++v29;
    }

    while (v25 != v29);
    v45 = [allValues countByEnumeratingWithState:&v71 objects:v88 count:16];
    v25 = v45;
  }

  while (v45);
LABEL_65:

  v46 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
  {
    v47 = GLUtilInterfaceTypeListToString(v69);
    v48 = GLUtilInterfaceTypeListToString(*interfaceCopy);
    v49 = GLUtilLinkTypeListToString(v27);
    *buf = 138412802;
    *v84 = v47;
    *&v84[8] = 2112;
    v85 = v48;
    v86 = 2112;
    v87 = v49;
    _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "current interface types L:%@, R:%@, link types: %@.", buf, 0x20u);
  }

  retryCountPerLinkType = selfCopy->_retryCountPerLinkType;
  if (!retryCountPerLinkType)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v52 = selfCopy->_retryCountPerLinkType;
    selfCopy->_retryCountPerLinkType = Mutable;

    retryCountPerLinkType = selfCopy->_retryCountPerLinkType;
  }

  v53 = GLUtilNewQRLinkType(v27, v69, *interfaceCopy, retryCountPerLinkType);
  if (v53)
  {
    v15 = v53;
    if ([(IDSGlobalLink *)selfCopy _qrLinkLimitExceededWithNewLinkType:v53 cellularRelayLinkCount:v26 wifiRelayLinkCount:v68])
    {
      v54 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109376;
        *v84 = v26;
        *&v84[4] = 1024;
        *&v84[6] = v68;
        v55 = "skip set up new QR link, exceeded limit cellularLinkcount: %d wifiLinkCount: %d";
        v56 = v54;
        v57 = 14;
        goto LABEL_75;
      }

      goto LABEL_76;
    }

    v58 = selfCopy->_retryCountPerLinkType;
    v59 = [MEMORY[0x1E696AD98] numberWithInt:v15];
    v54 = [(NSMutableDictionary *)v58 objectForKey:v59];

    v7 = v65;
    if (v54)
    {
      v60 = [v54 intValue]+ 1;
    }

    else
    {
      v60 = 1;
    }

    v61 = selfCopy->_retryCountPerLinkType;
    v62 = [MEMORY[0x1E696AD98] numberWithInt:v60];
    v63 = [MEMORY[0x1E696AD98] numberWithInt:v15];
    [(NSMutableDictionary *)v61 setObject:v62 forKey:v63];
  }

  else
  {
    v54 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v55 = "set up new QR link is not needed.";
      v56 = v54;
      v57 = 2;
LABEL_75:
      _os_log_impl(&dword_1A7AD9000, v56, OS_LOG_TYPE_DEFAULT, v55, buf, v57);
    }

LABEL_76:
    LOBYTE(v15) = 0;
    v7 = v65;
  }

LABEL_82:
  return v15;
}

- (id)_findCandidatePairWithRelaySessionID:(id)d
{
  v18 = *MEMORY[0x1E69E9840];
  dCopy = d;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = [allValues countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v6)
  {
    v7 = *v14;
    while (2)
    {
      for (i = 0; i != v6; i = i + 1)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(allValues);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        if (([v9 isVirtualRelayStunCandidatePair] & 1) == 0)
        {
          if ([v9 isRelayStunCandidatePair])
          {
            sessionID = [v9 sessionID];
            v11 = [dCopy isEqualToString:sessionID];

            if (v11)
            {
              v6 = v9;
              goto LABEL_13;
            }
          }
        }
      }

      v6 = [allValues countByEnumeratingWithState:&v13 objects:v17 count:16];
      if (v6)
      {
        continue;
      }

      break;
    }
  }

LABEL_13:

  return v6;
}

- (BOOL)_isSharedQRSession:(id)session
{
  v18 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v6 = [allValues countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v6)
  {
    v7 = *v14;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v14 != v7)
        {
          objc_enumerationMutation(allValues);
        }

        v9 = *(*(&v13 + 1) + 8 * i);
        sessionID = [v9 sessionID];
        if ([sessionCopy isEqualToString:sessionID])
        {
          isSharedQRSession = [v9 isSharedQRSession];

          if (isSharedQRSession)
          {
            LOBYTE(v6) = 1;
            goto LABEL_12;
          }
        }

        else
        {
        }
      }

      v6 = [allValues countByEnumeratingWithState:&v13 objects:v17 count:16];
    }

    while (v6);
  }

LABEL_12:

  return v6;
}

- (void)_requestNewTwoWayQRAllocation:(id)allocation
{
  v12 = -1431655766;
  v4 = [(IDSGlobalLink *)self _getNewLinkType:allocation remoteInterface:&v12];
  if (v4)
  {
    v5 = v4;
    self->_hasPendingAllocation = 1;
    v6 = im_primary_queue();
    v8[0] = MEMORY[0x1E69E9820];
    v8[1] = 3221225472;
    v8[2] = sub_1A7BBDDBC;
    v8[3] = &unk_1E77E0CB0;
    v9 = v12;
    v8[4] = self;
    v10 = v5;
    dispatch_async(v6, v8);
  }

  else
  {
    v7 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, no more QR link is required or not possible", buf, 2u);
    }
  }
}

- (BOOL)_setupNewQRLinkIfNecessary:(id)necessary
{
  v24 = *MEMORY[0x1E69E9840];
  necessaryCopy = necessary;
  if (self->_useLinkEngine)
  {
    [(IDSGlobalLink *)self _updateAllLinks];
LABEL_15:
    v8 = 0;
    goto LABEL_16;
  }

  if (![(IDSGlobalLink *)self _isSharedQRSession:necessaryCopy]|| !self->_sharedSessionJoined)
  {
    if (self->_state == 4)
    {
      goto LABEL_6;
    }

LABEL_12:
    v6 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v19 = v7;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, GL state [%s].", buf, 0xCu);
    }

    goto LABEL_15;
  }

  if (self->_state > 4)
  {
    goto LABEL_12;
  }

LABEL_6:
  if (!self->_allowConcurrentQRSetup && [(IDSGlobalLink *)self _hasCandidatePairInState:1 anotherState:3 relayCandidatePairsOnly:1 excludeSelfAlloc:1])
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "skip set up new QR link, concurrent QR setup not allowed with a connecting candidate pair.", buf, 2u);
    }

    goto LABEL_15;
  }

  if (necessaryCopy)
  {
    v10 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      v12 = _IDSLinkStateStrings[self->_state];
      *buf = 138412802;
      v19 = necessaryCopy;
      v20 = 2112;
      v21 = idsSessionID;
      v22 = 2080;
      v23 = v12;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "set up new QR link for %@, ids-sesion-id %@, GL state [%s].", buf, 0x20u);
    }

    v13 = [(IDSGlobalLink *)self _findCandidatePairWithRelaySessionID:necessaryCopy];
    v14 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v19 = necessaryCopy;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "found candidate pair for QR session %@.", buf, 0xCu);
    }

    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = sub_1A7BBE380;
    v16[3] = &unk_1E77E0250;
    v16[4] = self;
    v17 = v13;
    v15 = v13;
    IDSTransportThreadAddBlock(v16);
  }

  v8 = 1;
LABEL_16:

  return v8;
}

- (id)_convergeSharedSessions:(id)sessions
{
  sessionsCopy = sessions;
  if ([sessionsCopy isSharedQRSession])
  {
    if (self->_useLinkEngine)
    {
      [(IDSGlobalLink *)self _convergeSharedSessionsWithLinkEngine:sessionsCopy];
      v5 = MEMORY[0x1E695E0F0];
    }

    else
    {
      v5 = [(IDSGlobalLink *)self _convergeSharedSessionsWithoutLinkEngine:sessionsCopy];
    }
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (id)_linkIDsForSession:(id)session
{
  v21 = *MEMORY[0x1E69E9840];
  sessionCopy = session;
  array = [MEMORY[0x1E695DF70] array];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v6 = self->_tokenToCandidatePairs;
  v7 = [(NSMutableDictionary *)v6 countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v17;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v17 != v9)
        {
          objc_enumerationMutation(v6);
        }

        v11 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:*(*(&v16 + 1) + 8 * i), v16];
        sessionID = [v11 sessionID];
        qrSessionID = [sessionCopy qrSessionID];

        if (sessionID == qrSessionID)
        {
          v14 = [MEMORY[0x1E696AD98] numberWithChar:{objc_msgSend(v11, "linkID")}];
          [array addObject:v14];
        }
      }

      v8 = [(NSMutableDictionary *)v6 countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v8);
  }

  return array;
}

- (void)_convergeSharedSessionsWithLinkEngine:(id)engine
{
  v70 = *MEMORY[0x1E69E9840];
  engineCopy = engine;
  sessionID = [engineCopy sessionID];
  v6 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:sessionID];
  v7 = v6;
  if (v6)
  {
    v52 = sessionID;
    v53 = engineCopy;
    v51 = v6;
    v8 = v6;
    v64 = 0u;
    v65 = 0u;
    v66 = 0u;
    v67 = 0u;
    v9 = self->_sessionsByID;
    v10 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v64 objects:v69 count:16];
    v50 = v8;
    if (!v10)
    {
      goto LABEL_21;
    }

    v11 = v10;
    v12 = *v65;
    v54 = v9;
    while (1)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v65 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v64 + 1) + 8 * i);
        v15 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:v14];
        sessionInfo = [v15 sessionInfo];
        allocateType = [sessionInfo allocateType];

        v18 = allocateType != 3 || v15 == v8;
        if (!v18 && [v15 wantsToBeConnected])
        {
          sessionInfo2 = [v8 sessionInfo];
          [sessionInfo2 allocateTime];
          v21 = v20;
          sessionInfo3 = [v15 sessionInfo];
          [sessionInfo3 allocateTime];
          v24 = v23;

          if (v21 >= v24)
          {
            sessionInfo4 = [v8 sessionInfo];
            [sessionInfo4 allocateTime];
            v28 = v27;
            sessionInfo5 = [v15 sessionInfo];
            [sessionInfo5 allocateTime];
            v31 = v30;

            if (v28 != v31)
            {
              goto LABEL_19;
            }

            v32 = objc_alloc(MEMORY[0x1E696AFB0]);
            qrSessionID = [v8 qrSessionID];
            v34 = [v32 initWithUUIDString:qrSessionID];

            v35 = [objc_alloc(MEMORY[0x1E696AFB0]) initWithUUIDString:v14];
            if ([v34 compare:v35]!= 1)
            {
              v36 = v15;

              v8 = v36;
            }

            v25 = v8;

            v8 = v34;
            v9 = v54;
          }

          else
          {
            v25 = v15;
          }

          v8 = v25;
        }

LABEL_19:
      }

      v11 = [(NSMutableDictionary *)v9 countByEnumeratingWithState:&v64 objects:v69 count:16];
      if (!v11)
      {
LABEL_21:

        v37 = [MEMORY[0x1E695DFA8] set];
        v60 = 0u;
        v61 = 0u;
        v62 = 0u;
        v63 = 0u;
        v38 = self->_sessionsByID;
        v39 = [(NSMutableDictionary *)v38 countByEnumeratingWithState:&v60 objects:v68 count:16];
        if (v39)
        {
          v40 = v39;
          v41 = 0;
          v42 = *v61;
          do
          {
            for (j = 0; j != v40; ++j)
            {
              if (*v61 != v42)
              {
                objc_enumerationMutation(v38);
              }

              v44 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:*(*(&v60 + 1) + 8 * j)];
              v45 = v44;
              if (v44 != v8)
              {
                [v44 willDisconnect];
                [(IDSGlobalLink *)self _updateLinksForSession:v45];
                v57[0] = MEMORY[0x1E69E9820];
                v57[1] = 3221225472;
                v57[2] = sub_1A7BBEB20;
                v57[3] = &unk_1E77E0C88;
                v46 = v45;
                v58 = v46;
                selfCopy = self;
                [v46 startSessionConvergenceTimer:5 block:v57];
                v47 = [(IDSGlobalLink *)self _linkIDsForSession:v46];
                [v37 addObjectsFromArray:v47];

                v41 = 1;
              }
            }

            v40 = [(NSMutableDictionary *)v38 countByEnumeratingWithState:&v60 objects:v68 count:16];
          }

          while (v40);

          engineCopy = v53;
          if (v41)
          {
            v55[0] = MEMORY[0x1E69E9820];
            v55[1] = 3221225472;
            v55[2] = sub_1A7BBEB5C;
            v55[3] = &unk_1E77E0250;
            v55[4] = self;
            v56 = v53;
            IDSTransportThreadAddBlockAfter(v55, 8.0);
          }
        }

        else
        {

          engineCopy = v53;
        }

        sessionID = v52;
        if (v8 == v50)
        {
          if (self->_linkIDForPlugin)
          {
            v48 = [MEMORY[0x1E696AD98] numberWithChar:?];
            v49 = [v37 containsObject:v48];

            if (v49)
            {
              self->_linkIDForPlugin = [engineCopy linkID];
              [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
            }
          }
        }

        v7 = v51;
        goto LABEL_37;
      }
    }
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
  {
    sub_1A7E179B8();
  }

LABEL_37:
}

- (id)_convergeSharedSessionsWithoutLinkEngine:(id)engine
{
  v66 = *MEMORY[0x1E69E9840];
  engineCopy = engine;
  if (![engineCopy isSharedQRSession])
  {
    v45 = 0;
    goto LABEL_54;
  }

  sessionID = [engineCopy sessionID];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  HasDifferentSharedRelayCandidatePair = GLUtilHasDifferentSharedRelayCandidatePair(sessionID, allValues);

  if (!HasDifferentSharedRelayCandidatePair)
  {
    v45 = 0;
    goto LABEL_53;
  }

  v45 = objc_alloc_init(MEMORY[0x1E695DF70]);
  if (!v45)
  {
    v45 = objc_alloc_init(MEMORY[0x1E695DF70]);
  }

  v8 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *v64 = sessionID;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: start session convergence for session %@.", buf, 0xCu);
  }

  v60 = 0u;
  v61 = 0u;
  v58 = 0u;
  v59 = 0u;
  allValues2 = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = [allValues2 countByEnumeratingWithState:&v58 objects:v65 count:16];
  selfCopy = self;
  if (!v10)
  {
    v44 = 0;
    goto LABEL_39;
  }

  v11 = v10;
  v46 = 0;
  v44 = 0;
  v12 = *v59;
  do
  {
    for (i = 0; i != v11; ++i)
    {
      if (*v59 != v12)
      {
        objc_enumerationMutation(allValues2);
      }

      v14 = *(*(&v58 + 1) + 8 * i);
      if ([v14 isSharedQRSession])
      {
        sessionID2 = [v14 sessionID];
        if (([sessionID2 isEqualToString:sessionID]& 1) != 0)
        {
          goto LABEL_14;
        }

        state = [v14 state];

        if (state == 4)
        {
          [engineCopy allocateTime];
          v18 = v17;
          [v14 allocateTime];
          if (v18 >= v19 && (([engineCopy allocateTime], v21 = v20, objc_msgSend(v14, "allocateTime"), v21 != v22) || (v23 = objc_msgSend(objc_alloc(MEMORY[0x1E696AFB0]), "initWithUUIDString:", sessionID), v24 = objc_alloc(MEMORY[0x1E696AFB0]), objc_msgSend(v14, "sessionID"), v25 = objc_claimAutoreleasedReturnValue(), v26 = objc_msgSend(v24, "initWithUUIDString:", v25), v25, v27 = objc_msgSend(v23, "compare:", v26), v26, v23, v28 = v27 == 1, self = selfCopy, v28)))
          {
            v29 = sessionID;
            if (([v14 isDisconnecting] & 1) == 0)
            {
              [v45 addObject:v14];
            }

            if (self->_linkIDForPlugin)
            {
              linkIDForPlugin = self->_linkIDForPlugin;
              if (linkIDForPlugin == [v14 linkID])
              {
                self->_linkIDForPlugin = [engineCopy linkID];
                sessionID2 = +[IDSFoundationLog GlobalLink];
                sessionID = v29;
                if (os_log_type_enabled(sessionID2, OS_LOG_TYPE_DEFAULT))
                {
                  linkID = [v14 linkID];
                  v32 = self->_linkIDForPlugin;
                  *buf = 67109376;
                  *v64 = linkID;
                  *&v64[4] = 1024;
                  *&v64[6] = v32;
                  _os_log_impl(&dword_1A7AD9000, sessionID2, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: linkID for Plugin is now changed from %d to %d", buf, 0xEu);
                }

                v44 = 1;
LABEL_14:

                continue;
              }
            }

            sessionID = v29;
          }

          else
          {
            v46 = 1;
          }
        }
      }
    }

    v11 = [allValues2 countByEnumeratingWithState:&v58 objects:v65 count:16];
  }

  while (v11);

  if (v46)
  {
    allValues2 = [engineCopy candidatePairToken];
    v33 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v64 = allValues2;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: Should remove the current candidatePair %@.", buf, 0xCu);
    }

    if (([engineCopy isDisconnecting] & 1) == 0)
    {
      [v45 addObject:engineCopy];
    }

LABEL_39:
  }

  if ([v45 count])
  {
    v56 = 0u;
    v57 = 0u;
    v54 = 0u;
    v55 = 0u;
    v34 = v45;
    v35 = [v34 countByEnumeratingWithState:&v54 objects:v62 count:16];
    if (v35)
    {
      v36 = v35;
      v37 = *v55;
      do
      {
        for (j = 0; j != v36; ++j)
        {
          if (*v55 != v37)
          {
            objc_enumerationMutation(v34);
          }

          v39 = *(*(&v54 + 1) + 8 * j);
          candidatePairToken = [v39 candidatePairToken];
          v41 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v64 = candidatePairToken;
            _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_convergeSharedSessions: Setting timer to disconnect candidatePairToken %@ for convergence.", buf, 0xCu);
          }

          v50[0] = MEMORY[0x1E69E9820];
          v50[1] = 3221225472;
          v50[2] = sub_1A7BBF2A8;
          v50[3] = &unk_1E77E0E18;
          v51 = candidatePairToken;
          v52 = v39;
          v53 = selfCopy;
          v42 = candidatePairToken;
          [v39 startSessionConvergenceTimer:5 block:v50];
        }

        v36 = [v34 countByEnumeratingWithState:&v54 objects:v62 count:16];
      }

      while (v36);
    }

    v48[0] = MEMORY[0x1E69E9820];
    v48[1] = 3221225472;
    v48[2] = sub_1A7BBF394;
    v48[3] = &unk_1E77E0250;
    self = selfCopy;
    v48[4] = selfCopy;
    v49 = engineCopy;
    IDSTransportThreadAddBlockAfter(v48, 8.0);
  }

  if (v44)
  {
    [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
  }

LABEL_53:

LABEL_54:

  return v45;
}

- (void)_notifySessionInfoReceived:(id)received relayGroupID:(id)d relaySessionID:(id)iD status:(unsigned int)status
{
  v6 = *&status;
  v27 = *MEMORY[0x1E69E9840];
  receivedCopy = received;
  dCopy = d;
  iDCopy = iD;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v14 = objc_opt_respondsToSelector();

  if (v14)
  {
    v15 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v19 = 138413058;
      v20 = dCopy;
      v21 = 2112;
      v22 = iDCopy;
      v23 = 1024;
      v24 = v6;
      v25 = 2112;
      v26 = receivedCopy;
      _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "notify session-info received for group %@, session %@, status: %u: %@.", &v19, 0x26u);
    }

    v16 = objc_loadWeakRetained(&self->_delegate);
    [v16 link:self didReceiveSessionInfo:receivedCopy relayGroupID:dCopy relaySessionID:iDCopy status:v6];
  }

  if (receivedCopy)
  {
    if (self->_isUPlusOneSession)
    {
      v17 = [receivedCopy objectForKeyedSubscript:@"gl-option-sessioninfo-response-participants-key"];
      v18 = [v17 count];

      if (v18 == 2)
      {
        if (self->_remoteJoinedUPlusOneTime == 0.0)
        {
          self->_remoteJoinedUPlusOneTime = ids_monotonic_time();
        }

        [(IDSGlobalLink *)self _enableE2E];
      }
    }
  }
}

- (void)candidatePair:(id)pair didReceiveSessionInfo:(id)info status:(unsigned int)status
{
  v5 = *&status;
  sessionsByID = self->_sessionsByID;
  infoCopy = info;
  pairCopy = pair;
  sessionID = [pairCopy sessionID];
  v14 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:sessionID];

  if (v14)
  {
    [v14 setWantsInfo:0];
    [(IDSGlobalLink *)self _updateLinksForSession:v14];
  }

  groupID = [pairCopy groupID];
  sessionID2 = [pairCopy sessionID];

  [(IDSGlobalLink *)self _notifySessionInfoReceived:infoCopy relayGroupID:groupID relaySessionID:sessionID2 status:v5];
}

- (void)candidatePair:(id)pair didReceiveSessionStats:(id)stats success:(BOOL)success
{
  successCopy = success;
  v33 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  statsCopy = stats;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v11 = objc_opt_respondsToSelector();

  if (v11)
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      groupID = [pairCopy groupID];
      sessionID = [pairCopy sessionID];
      v15 = sessionID;
      v16 = @"NO";
      *buf = 138413058;
      v26 = groupID;
      if (successCopy)
      {
        v16 = @"YES";
      }

      v27 = 2112;
      v28 = sessionID;
      v29 = 2112;
      v30 = v16;
      v31 = 2112;
      v32 = statsCopy;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "notify session stats received for group %@, session %@, success:%@: %@.", buf, 0x2Au);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
    {
      groupID2 = [pairCopy groupID];
      sessionID2 = [pairCopy sessionID];
      if (successCopy)
      {
        v19 = @"YES";
      }

      else
      {
        v19 = @"NO";
      }

      _IDSLogTransport(@"GL", @"IDS", @"notify session stats received for group %@, session %@, success:%@: %@.");

      if (_IDSShouldLog())
      {
        groupID3 = [pairCopy groupID];
        sessionID3 = [pairCopy sessionID];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"notify session stats received for group %@, session %@, success:%@: %@.");
      }
    }

    v21 = objc_loadWeakRetained(&self->_delegate);
    groupID4 = [pairCopy groupID];
    sessionID4 = [pairCopy sessionID];
    [v21 link:self didReceiveSessionStats:statsCopy relayGroupID:groupID4 relaySessionID:sessionID4 success:successCopy];
  }
}

- (void)_removeChannelFromChannelToCandidatePair:(id)pair
{
  v18 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  local = [pairCopy local];
  address = [local address];

  remote = [pairCopy remote];
  external = [remote external];

  v9 = channelForStunCandidatePair(address, external, [pairCopy channelNumber]);
  v10 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v14 = 138412546;
    v15 = v9;
    v16 = 2112;
    v17 = pairCopy;
    _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "remove channel %@ from _channelToCandidatePairs for candidatePair: %@", &v14, 0x16u);
  }

  if (!self->_channelToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    channelToCandidatePairs = self->_channelToCandidatePairs;
    self->_channelToCandidatePairs = Mutable;
  }

  if (v9)
  {
    v13 = self->_channelToCandidatePairs;
    if (v13)
    {
      CFDictionaryRemoveValue(v13, v9);
    }
  }
}

- (void)_markLinkAsUsed:(id)used
{
  v13 = *MEMORY[0x1E69E9840];
  usedCopy = used;
  v5 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v11 = 138412290;
    v12 = usedCopy;
    _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "_markLinkAsUsed: marking link as used: %@", &v11, 0xCu);
  }

  v6 = objc_alloc_init(IDSGLUsedLink);
  local = [usedCopy local];
  externalAddressString = [local externalAddressString];
  [(IDSGLUsedLink *)v6 setLocalIP:externalAddressString];

  remote = [usedCopy remote];
  externalAddressString2 = [remote externalAddressString];
  [(IDSGLUsedLink *)v6 setServerIP:externalAddressString2];

  -[IDSGLUsedLink setLinkID:](v6, "setLinkID:", [usedCopy relayLinkID]);
  [(NSMutableSet *)self->_usedLinks addObject:v6];
}

- (BOOL)_handleRemapping:(id)remapping errorCode:(unsigned __int16)code reconnectQUIC:(BOOL)c
{
  cCopy = c;
  codeCopy = code;
  v41 = *MEMORY[0x1E69E9840];
  remappingCopy = remapping;
  [(IDSGlobalLink *)self _markLinkAsUsed:remappingCopy];
  state = [(__CFString *)remappingCopy state];
  if (cCopy || ((v26 = state, v27 = [(__CFString *)remappingCopy hasNoSessionStateTestOptions], v26 > 4) ? (v28 = v27) : (v28 = 0), (v28 & 1) != 0 || v26 - 2 <= 2))
  {
    v10 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      if ([(__CFString *)remappingCopy pendingNoSessionStateAllocbind])
      {
        v11 = @"YES";
      }

      else
      {
        v11 = @"NO";
      }

      *buf = 134218754;
      if ([(__CFString *)remappingCopy hasNoSessionStateTestOptions])
      {
        v12 = @"YES";
      }

      else
      {
        v12 = @"NO";
      }

      v34 = codeCopy;
      if (cCopy)
      {
        v13 = @"YES";
      }

      else
      {
        v13 = @"NO";
      }

      v35 = 2112;
      v36 = v11;
      v37 = 2112;
      v38 = v12;
      v39 = 2112;
      v40 = v13;
      _os_log_impl(&dword_1A7AD9000, v10, OS_LOG_TYPE_DEFAULT, "_handleRemapping: error code: %ld, pendingNoSessionStateAllocbind = %@, hasNoSessionStateTestOptions = %@, reconnectQUIC = %@", buf, 0x2Au);
    }

    if (([(__CFString *)remappingCopy pendingNoSessionStateAllocbind]& 1) == 0)
    {
      v14 = GLUCreateQRNoSessionStateEvent(remappingCopy, 237, codeCopy);
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v16 = objc_opt_respondsToSelector();

      if (v16)
      {
        v17 = objc_loadWeakRetained(&self->_delegate);
        [v17 link:self didAddQREvent:v14];
      }

      if (codeCopy == 699)
      {
        v18 = objc_loadWeakRetained(&self->_delegate);
        v19 = objc_opt_respondsToSelector();

        if (v19)
        {
          v20 = objc_loadWeakRetained(&self->_delegate);
          sessionInfoDict = [(__CFString *)remappingCopy sessionInfoDict];
          [v20 link:self reportNoSessionState:sessionInfoDict];
        }
      }

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:remappingCopy withReason:5];
      [(IDSGlobalLink *)self _removeChannelFromChannelToCandidatePair:remappingCopy];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:remappingCopy withReason:5];
      }

      state2 = [(__CFString *)remappingCopy state];
      [(__CFString *)remappingCopy setState:1];
      [(__CFString *)remappingCopy setChannelNumber:0];
      [(__CFString *)remappingCopy setLinkID:0];
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = (&_IDSStunCandidatePairStateStrings)[state2];
        *buf = 136315650;
        v34 = v24;
        v35 = 2080;
        v36 = off_1EB2B43B0;
        v37 = 2112;
        v38 = remappingCopy;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v31 = off_1EB2B43B0;
          v32 = remappingCopy;
          v30 = (&_IDSStunCandidatePairStateStrings)[state2];
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v31 = off_1EB2B43B0;
            v32 = remappingCopy;
            v30 = (&_IDSStunCandidatePairStateStrings)[state2];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      [(IDSGlobalLink *)self sendAllocbindRequest:remappingCopy isRealloc:0 inResponseToNoSessionState:1 reconnectQUIC:cCopy, v30, v31, v32];
      [(__CFString *)remappingCopy setPendingNoSessionState:1];
    }

    v25 = 1;
  }

  else
  {
    v25 = 0;
  }

  return v25;
}

- (BOOL)_hasConnectedP2pLink
{
  v15 = *MEMORY[0x1E69E9840];
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v8 = 0u;
  v9 = 0u;
  v10 = 0u;
  v2 = v11 = 0u;
  v3 = [v2 countByEnumeratingWithState:&v8 objects:v14 count:16];
  if (v3)
  {
    v4 = *v9;
    while (2)
    {
      for (i = 0; i != v3; i = (i + 1))
      {
        if (*v9 != v4)
        {
          objc_enumerationMutation(v2);
        }

        v6 = *(*(&v8 + 1) + 8 * i);
        if (([v6 state] == 3 || objc_msgSend(v6, "state") == 4) && (objc_msgSend(v6, "isRelayStunCandidatePair") & 1) == 0)
        {
          v3 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v13 = v6;
            _os_log_impl(&dword_1A7AD9000, v3, OS_LOG_TYPE_DEFAULT, "has connected P2P link: %@", buf, 0xCu);
          }

          LOBYTE(v3) = 1;
          goto LABEL_15;
        }
      }

      v3 = [v2 countByEnumeratingWithState:&v8 objects:v14 count:16];
      if (v3)
      {
        continue;
      }

      break;
    }
  }

LABEL_15:

  return v3;
}

- (void)candidatePair:(id)pair didReceiveStunErrorResponse:(int64_t)response errorCode:(unsigned __int16)code didLocalExternalAddressChange:(BOOL)change
{
  changeCopy = change;
  codeCopy = code;
  pairCopy = pair;
  v11 = pairCopy;
  if (response != 4080)
  {
    if (codeCopy == 602)
    {
      if (!self->_isUPlusOneSession || ![(IDSGlobalLink *)self _hasConnectedP2pLink])
      {
        WeakRetained = objc_loadWeakRetained(&self->_delegate);
        v22 = objc_opt_respondsToSelector();

        if ((v22 & 1) == 0)
        {
          goto LABEL_36;
        }

        candidatePairToken = objc_loadWeakRetained(&self->_delegate);
        [candidatePairToken terminateCallDueToIdleClientForLink:self];
LABEL_33:

        goto LABEL_36;
      }

      if (self->_useLinkEngine)
      {
        linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
        linkUniqueName = [v11 linkUniqueName];
        v19 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:linkUniqueName];

        if (v19 != v11)
        {
          goto LABEL_36;
        }

        [(IDSGlobalLink *)self _markLinkAsUsed:v11];
        [(IDSGlobalLink *)self _reportNoSessionState:v11 errorCode:602];
        linkEngine = [v11 linkEngine];
        linkUniqueName2 = [v11 linkUniqueName];
        [linkEngine linkDidFail:linkUniqueName2 errorCode:602 isRecoverable:1 shouldReconnect:1];

        goto LABEL_13;
      }

      selfCopy2 = self;
      v28 = v11;
      v29 = 602;
      v26 = 1;
    }

    else
    {
      if (codeCopy != 601)
      {
        goto LABEL_36;
      }

      if (self->_useLinkEngine)
      {
        v12 = self->_linkEngineIDToCandidatePair;
        linkUniqueName3 = [pairCopy linkUniqueName];
        v14 = [(NSMutableDictionary *)v12 objectForKeyedSubscript:linkUniqueName3];

        if (v14 != v11)
        {
          goto LABEL_36;
        }

        [(IDSGlobalLink *)self _markLinkAsUsed:v11];
        [(IDSGlobalLink *)self _reportNoSessionState:v11 errorCode:601];
        linkEngine = [v11 linkEngine];
        linkUniqueName4 = [v11 linkUniqueName];
        [linkEngine linkDidFail:linkUniqueName4 errorCode:601 isRecoverable:1 shouldReconnect:!changeCopy];

LABEL_13:
        goto LABEL_36;
      }

      v26 = !changeCopy;
      selfCopy2 = self;
      v28 = v11;
      v29 = 601;
    }

    [(IDSGlobalLink *)selfCopy2 _handleRemapping:v28 errorCode:v29 reconnectQUIC:v26];
    goto LABEL_36;
  }

  if (![pairCopy isSharedQRSession])
  {
    goto LABEL_36;
  }

  if (codeCopy <= 607)
  {
    if (codeCopy != 441)
    {
      if (codeCopy != 486)
      {
        if (codeCopy != 603)
        {
          goto LABEL_36;
        }

        goto LABEL_27;
      }

      selfCopy6 = self;
      v25 = 52;
LABEL_35:
      [(IDSGlobalLink *)selfCopy6 receiveBlockedIndicationWithReason:v25];
      goto LABEL_36;
    }

    [(IDSGlobalLink *)self _didReceiveRequestToPurgeRegistration];
    v30 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BC0584;
    block[3] = &unk_1E77E12C0;
    v32 = v11;
    selfCopy4 = self;
    v34 = 441;
    dispatch_async(v30, block);

    goto LABEL_36;
  }

  switch(codeCopy)
  {
    case 608:
      [(IDSGlobalLink *)self receiveBlockedIndicationWithReason:49];
      candidatePairToken = [v11 candidatePairToken];
      [(IDSGlobalLink *)self _triggerSymptomsWithCandidatePairToken:candidatePairToken subType:@"DiagnosticRemoveParticipant" subTypeContext:@"NotUploadKeys" duration:15];
      goto LABEL_33;
    case 611:
LABEL_27:
      if (codeCopy == 603)
      {
        v25 = 44;
      }

      else
      {
        v25 = 46;
      }

      selfCopy6 = self;
      goto LABEL_35;
    case 613:
      selfCopy6 = self;
      v25 = 50;
      goto LABEL_35;
  }

LABEL_36:
}

- (void)candidatePair:(id)pair didAddQREvent:(id)event
{
  eventCopy = event;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didAddQREvent:eventCopy];
  }
}

- (void)candidatePair:(id)pair didReceiveParticipantUpdate:(id)update status:(unsigned __int16)status
{
  statusCopy = status;
  updateCopy = update;
  v7 = [updateCopy objectForKey:@"ids-stun-attribute-session-state-type"];
  unsignedShortValue = [v7 unsignedShortValue];

  if (statusCopy && (unsignedShortValue - 7) <= 1)
  {
    self->_isLightweightParticipant = unsignedShortValue != 7;
  }

  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v10 = objc_opt_respondsToSelector();

  if (v10)
  {
    v11 = objc_loadWeakRetained(&self->_delegate);
    [v11 link:self didReceiveParticipantUpdate:updateCopy status:statusCopy];
  }
}

- (void)candidatePair:(id)pair didReceivePluginRegistration:(unint64_t)registration pluginName:(id)name
{
  v34 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  nameCopy = name;
  groupID = [pairCopy groupID];
  v26 = pairCopy;
  sessionID = [pairCopy sessionID];
  selfCopy = self;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v11 = [allValues countByEnumeratingWithState:&v28 objects:v33 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v29;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v29 != v13)
        {
          objc_enumerationMutation(allValues);
        }

        v15 = *(*(&v28 + 1) + 8 * i);
        sessionID2 = [v15 sessionID];
        if ([sessionID2 isEqualToString:sessionID])
        {
          groupID2 = [v15 groupID];
          if ([groupID2 isEqualToString:groupID] && objc_msgSend(v15, "state") == 4)
          {
            isSharedQRSession = [v15 isSharedQRSession];

            if (!isSharedQRSession)
            {
              continue;
            }

            sessionID2 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:registration];
            v32 = sessionID2;
            groupID2 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v32 count:1];
            [v15 updateParticipantIDMap:groupID2];
          }
        }
      }

      v12 = [allValues countByEnumeratingWithState:&v28 objects:v33 count:16];
    }

    while (v12);
  }

  if (nameCopy)
  {
    pluginParticipantIDs = selfCopy->_pluginParticipantIDs;
    v20 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:registration];
    [(NSMutableDictionary *)pluginParticipantIDs setObject:nameCopy forKey:v20];
  }

  WeakRetained = objc_loadWeakRetained(&selfCopy->_delegate);
  v22 = objc_opt_respondsToSelector();

  if (v22)
  {
    v23 = objc_loadWeakRetained(&selfCopy->_delegate);
    [v23 link:selfCopy didReceivePluginRegistration:registration pluginName:nameCopy];
  }

  if (selfCopy->_linkIDForPlugin != [v26 linkID])
  {
    [(IDSGlobalLink *)selfCopy _didReceiveRequestToPurgeRegistration];
  }
}

- (void)candidatePair:(id)pair didReceivePluginUnregistration:(unint64_t)unregistration pluginName:(id)name
{
  v34 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  nameCopy = name;
  groupID = [pairCopy groupID];
  v26 = pairCopy;
  sessionID = [pairCopy sessionID];
  selfCopy = self;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v11 = [allValues countByEnumeratingWithState:&v28 objects:v33 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v29;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v29 != v13)
        {
          objc_enumerationMutation(allValues);
        }

        v15 = *(*(&v28 + 1) + 8 * i);
        sessionID2 = [v15 sessionID];
        if ([sessionID2 isEqualToString:sessionID])
        {
          groupID2 = [v15 groupID];
          if ([groupID2 isEqualToString:groupID] && objc_msgSend(v15, "state") == 4)
          {
            isSharedQRSession = [v15 isSharedQRSession];

            if (!isSharedQRSession)
            {
              continue;
            }

            sessionID2 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:unregistration];
            v32 = sessionID2;
            groupID2 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v32 count:1];
            [v15 removeFromParticipantIDMap:groupID2];
          }
        }
      }

      v12 = [allValues countByEnumeratingWithState:&v28 objects:v33 count:16];
    }

    while (v12);
  }

  if (nameCopy)
  {
    pluginParticipantIDs = selfCopy->_pluginParticipantIDs;
    v20 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:unregistration];
    [(NSMutableDictionary *)pluginParticipantIDs removeObjectForKey:v20];

    [(NSMutableDictionary *)selfCopy->_pluginNameToPluginOptionsDict removeObjectForKey:nameCopy];
  }

  WeakRetained = objc_loadWeakRetained(&selfCopy->_delegate);
  v22 = objc_opt_respondsToSelector();

  if (v22)
  {
    v23 = objc_loadWeakRetained(&selfCopy->_delegate);
    [v23 link:selfCopy didReceivePluginUnregistration:unregistration pluginName:nameCopy];
  }
}

- (void)candidatePair:(id)pair didReceivePluginControlEvent:(unint64_t)event operation:(unsigned __int8)operation transactionID:(id)d
{
  operationCopy = operation;
  v19 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  dCopy = d;
  v12 = dCopy;
  if (operationCopy != 2)
  {
    goto LABEL_13;
  }

  if (!dCopy)
  {
LABEL_12:
    [(IDSGlobalLink *)self _disconnectPluginConnectionsForParticipantID:event andPurgeRegistration:0];
    goto LABEL_13;
  }

  if (([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs containsObject:dCopy]& 1) == 0)
  {
    if ([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs count]>= 0x14)
    {
      do
      {
        [(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs removeObjectAtIndex:0];
      }

      while ([(NSMutableArray *)self->_pluginControlDisconnectRecentTransactionIDs count]> 0x13);
    }

    pluginControlDisconnectRecentTransactionIDs = self->_pluginControlDisconnectRecentTransactionIDs;
    if (!pluginControlDisconnectRecentTransactionIDs)
    {
      v15 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v16 = self->_pluginControlDisconnectRecentTransactionIDs;
      self->_pluginControlDisconnectRecentTransactionIDs = v15;

      pluginControlDisconnectRecentTransactionIDs = self->_pluginControlDisconnectRecentTransactionIDs;
    }

    [(NSMutableArray *)pluginControlDisconnectRecentTransactionIDs addObject:v12];
    goto LABEL_12;
  }

  v13 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v17 = 138412290;
    v18 = v12;
    _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "PluginControl indication event has duplicate transactionID %@ - dropped", &v17, 0xCu);
  }

LABEL_13:
}

- (void)candidatePair:(id)pair didReceiveMappedParticipantsDict:(id)dict forLinkID:(char)d
{
  dCopy = d;
  dictCopy = dict;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v8 = objc_opt_respondsToSelector();

  if (v8)
  {
    v9 = objc_loadWeakRetained(&self->_delegate);
    [v9 link:self didReceiveMappedParticipantsDict:dictCopy forLinkID:dCopy];
  }
}

- (void)candidatePair:(id)pair didReceivePutMaterialIndication:(id)indication
{
  indicationCopy = indication;
  if (IMGetDomainBoolForKey())
  {
    v6 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      *v9 = 0;
      _os_log_impl(&dword_1A7AD9000, v6, OS_LOG_TYPE_DEFAULT, "didReceivePutMaterialIndication: ignoring because DisableQUICMaterialIndication is set", v9, 2u);
    }
  }

  else
  {
    materials = [indicationCopy materials];
    [(IDSGlobalLink *)self _getAndProcessDatablobsFromReceivedMaterials:materials];
    materials2 = [indicationCopy materials];
    [(IDSGlobalLink *)self receiveKeyMaterials:materials2];
  }
}

- (void)candidatePair:(id)pair didReceiveGetMaterialResponse:(id)response
{
  responseCopy = response;
  materials = [responseCopy materials];
  [(IDSGlobalLink *)self _getAndProcessDatablobsFromReceivedMaterials:materials];

  materials2 = [responseCopy materials];

  [(IDSGlobalLink *)self receiveKeyMaterials:materials2];
}

- (void)receiveKeyMaterials:(id)materials
{
  v34 = *MEMORY[0x1E69E9840];
  materialsCopy = materials;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    v19 = materialsCopy;
    obj = materialsCopy;
    v7 = [obj countByEnumeratingWithState:&v26 objects:v33 count:16];
    if (v7)
    {
      v8 = v7;
      v21 = *v27;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v27 != v21)
          {
            objc_enumerationMutation(obj);
          }

          v10 = *(*(&v26 + 1) + 8 * i);
          v11 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v32 = v10;
            _os_log_impl(&dword_1A7AD9000, v11, OS_LOG_TYPE_DEFAULT, "receiveKeyMaterials received material: %@", buf, 0xCu);
          }

          v24 = 0u;
          v25 = 0u;
          v22 = 0u;
          v23 = 0u;
          materialInfos = [v10 materialInfos];
          v13 = [materialInfos countByEnumeratingWithState:&v22 objects:v30 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v23;
            do
            {
              for (j = 0; j != v14; ++j)
              {
                if (*v23 != v15)
                {
                  objc_enumerationMutation(materialInfos);
                }

                v17 = *(*(&v22 + 1) + 8 * j);
                v18 = objc_loadWeakRetained(&self->_delegate);
                [v18 link:self didReceiveMaterialInfo:v17 material:v10];
              }

              v14 = [materialInfos countByEnumeratingWithState:&v22 objects:v30 count:16];
            }

            while (v14);
          }
        }

        v8 = [obj countByEnumeratingWithState:&v26 objects:v33 count:16];
      }

      while (v8);
    }

    materialsCopy = v19;
  }
}

- (void)candidatePair:(id)pair didReceivePutMaterialResponse:(id)response forTxId:(unint64_t)id
{
  putMaterialReqTxIdToCompletionBlock = self->_putMaterialReqTxIdToCompletionBlock;
  v9 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:id];
  v13 = [(NSMutableDictionary *)putMaterialReqTxIdToCompletionBlock objectForKeyedSubscript:v9];

  v10 = v13;
  if (v13)
  {
    (*(v13 + 16))(v13, response != 0);
    v11 = self->_putMaterialReqTxIdToCompletionBlock;
    v12 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:id];
    [(NSMutableDictionary *)v11 removeObjectForKey:v12];

    v10 = v13;
  }
}

- (void)_didReceiveRequestToPurgeRegistration
{
  v15 = *MEMORY[0x1E69E9840];
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v4 = [allValues countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v11;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v11 != v6)
        {
          objc_enumerationMutation(allValues);
        }

        v8 = *(*(&v10 + 1) + 8 * i);
        if ([v8 state] == 4 && objc_msgSend(v8, "isSharedQRSession"))
        {
          allKeys = [(NSMutableDictionary *)self->_pluginParticipantIDs allKeys];
          [v8 removeFromParticipantIDMap:allKeys];
        }
      }

      v5 = [allValues countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v5);
  }

  [(IDSGlobalLink *)self _disconnectPluginConnectionsForParticipantID:0 andPurgeRegistration:1];
}

- (void)_disconnectPluginConnectionsForParticipantID:(unint64_t)d andPurgeRegistration:(BOOL)registration
{
  registrationCopy = registration;
  v42 = *MEMORY[0x1E69E9840];
  v7 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v8 = v7;
  pluginParticipantIDs = self->_pluginParticipantIDs;
  if (d)
  {
    v10 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:d];
    v11 = [(NSMutableDictionary *)pluginParticipantIDs objectForKeyedSubscript:v10];

    if (v11)
    {
      v12 = self->_pluginParticipantIDs;
      v13 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:d];
      v14 = [(NSMutableDictionary *)v12 objectForKeyedSubscript:v13];
      v15 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:d];
      [v8 setObject:v14 forKey:v15];

      if (registrationCopy)
      {
        v16 = self->_pluginParticipantIDs;
        v17 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:d];
        [(NSMutableDictionary *)v16 removeObjectForKey:v17];

        [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict removeObjectForKey:v11];
      }
    }

    else
    {
      v23 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        dCopy = d;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "_disconnectPluginConnectionsForParticipantID cannot find pluginName for participantID %llu", buf, 0xCu);
      }
    }

    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v25 = objc_opt_respondsToSelector();

    if (v25)
    {
      v26 = objc_loadWeakRetained(&self->_delegate);
      v27 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:d];
      v39 = v27;
      v28 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v39 count:1];
      [v26 link:self didReceivePluginDisconnect:v28];
    }
  }

  else
  {
    v34 = MEMORY[0x1E69E9820];
    v35 = 3221225472;
    v36 = sub_1A7BC1900;
    v37 = &unk_1E77E12E8;
    v18 = v7;
    v38 = v18;
    [(NSMutableDictionary *)pluginParticipantIDs enumerateKeysAndObjectsUsingBlock:&v34];
    if (registrationCopy)
    {
      [(NSMutableDictionary *)self->_pluginParticipantIDs removeAllObjects:v34];
      [(NSMutableDictionary *)self->_pluginNameToPluginOptionsDict removeAllObjects];
    }

    v19 = objc_loadWeakRetained(&self->_delegate);
    v20 = objc_opt_respondsToSelector();

    if (v20)
    {
      v21 = objc_loadWeakRetained(&self->_delegate);
      allKeys = [v18 allKeys];
      [v21 link:self didReceivePluginDisconnect:allKeys];
    }

    v11 = v38;
  }

  if (registrationCopy)
  {
    if ([v8 count])
    {
      v29 = objc_loadWeakRetained(&self->_delegate);
      v30 = objc_opt_respondsToSelector();

      if (v30)
      {
        v31 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = [v8 count];
          *buf = 134217984;
          dCopy = v32;
          _os_log_impl(&dword_1A7AD9000, v31, OS_LOG_TYPE_DEFAULT, "didReceiveRequestToPurgeRegistration for %lu plugins.", buf, 0xCu);
        }

        v33 = objc_loadWeakRetained(&self->_delegate);
        [v33 link:self didReceiveRequestToPurgeRegistration:v8];
      }
    }
  }
}

- (void)disconnectIdleQUICConnectionForCandidatePair:(id)pair
{
  v14 = *MEMORY[0x1E69E9840];
  pairCopy = pair;
  if ([pairCopy isQUIC] && objc_msgSend(pairCopy, "state") <= 2)
  {
    v5 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      candidatePairToken = [pairCopy candidatePairToken];
      v12 = 138412290;
      v13 = candidatePairToken;
      _os_log_impl(&dword_1A7AD9000, v5, OS_LOG_TYPE_DEFAULT, "Disconnecting QUIC connection %@ after Info request", &v12, 0xCu);
    }

    nwLink = self->_nwLink;
    sessionID = [pairCopy sessionID];
    local = [pairCopy local];
    address = [local address];
    remote = [pairCopy remote];
    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", sessionID, address, [remote external], 0, self->_delayQUICDisconnectionAfterInfo);
  }
}

- (void)candidatePairDidReceiveInfoResponse:(id)response
{
  responseCopy = response;
  sessionsByID = self->_sessionsByID;
  v10 = responseCopy;
  sessionID = [responseCopy sessionID];
  v7 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:sessionID];

  if (v7)
  {
    [v7 setWantsInfo:0];
  }

  linkEngine = [v10 linkEngine];
  if (linkEngine)
  {
    linkUniqueName = [v10 linkUniqueName];
    [linkEngine linkDidDisconnect:linkUniqueName];
  }
}

- (void)sendAllocbindRequest:(id)request isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state reconnectQUIC:(BOOL)c
{
  cCopy = c;
  stateCopy = state;
  reallocCopy = realloc;
  v32 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  candidatePairToken = [requestCopy candidatePairToken];
  if ([requestCopy isQUIC])
  {
    pendingNoSessionStateAllocbind = [requestCopy pendingNoSessionStateAllocbind];
    if (cCopy)
    {
      v20 = pendingNoSessionStateAllocbind;
      v21 = cCopy;
      v13 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        candidatePairToken2 = [requestCopy candidatePairToken];
        *buf = 138412290;
        v31 = candidatePairToken2;
        _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "Disconnecting NWLink for candidate pair reconnect: %@", buf, 0xCu);
      }

      nwLink = self->_nwLink;
      sessionID = [requestCopy sessionID];
      local = [requestCopy local];
      address = [local address];
      remote = [requestCopy remote];
      -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", sessionID, address, [remote external], 1, 0.0);

      v22[0] = MEMORY[0x1E69E9820];
      v22[1] = 3221225472;
      v22[2] = sub_1A7BC1E04;
      v22[3] = &unk_1E77E0FF0;
      v23 = requestCopy;
      selfCopy = self;
      v25 = candidatePairToken;
      v26 = reallocCopy;
      v27 = stateCopy;
      v28 = v21;
      v29 = v20;
      IDSTransportThreadAddBlockAfter(v22, 0.5);
    }

    else
    {
      [(IDSGlobalLink *)self _sendQUICAllocbindRequest:candidatePairToken isRealloc:reallocCopy inResponseToNoSessionState:stateCopy shouldConnectLinkFirst:0 isPendingInResponseToNoSessionState:pendingNoSessionStateAllocbind];
    }
  }

  else
  {
    [(IDSGlobalLink *)self _sendAllocbindRequest:candidatePairToken stunMessage:0 isRealloc:reallocCopy inResponseToNoSessionState:stateCopy];
  }
}

- (BOOL)receiveNoSessionStateForCandidatePair:(id)pair didLocalExternalAddressChange:(BOOL)change
{
  changeCopy = change;
  pairCopy = pair;
  v7 = pairCopy;
  if (self->_useLinkEngine)
  {
    linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
    linkUniqueName = [pairCopy linkUniqueName];
    v10 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:linkUniqueName];

    if (v10 == v7)
    {
      [(IDSGlobalLink *)self _markLinkAsUsed:v7];
      [(IDSGlobalLink *)self _reportNoSessionState:v7 errorCode:601];
      linkEngine = [v7 linkEngine];
      linkUniqueName2 = [v7 linkUniqueName];
      v11 = 1;
      [linkEngine linkDidFail:linkUniqueName2 errorCode:601 isRecoverable:1 shouldReconnect:!changeCopy];
    }

    else
    {
      v11 = 1;
    }
  }

  else
  {
    v11 = [(IDSGlobalLink *)self _handleRemapping:pairCopy errorCode:601 reconnectQUIC:!changeCopy];
  }

  return v11;
}

- (void)receiveIdleClientErrorForCandidatePair:(id)pair
{
  pairCopy = pair;
  if (self->_isUPlusOneSession && [(IDSGlobalLink *)self _hasConnectedP2pLink])
  {
    if (self->_useLinkEngine)
    {
      linkEngineIDToCandidatePair = self->_linkEngineIDToCandidatePair;
      linkUniqueName = [pairCopy linkUniqueName];
      v6 = [(NSMutableDictionary *)linkEngineIDToCandidatePair objectForKeyedSubscript:linkUniqueName];

      if (v6 == pairCopy)
      {
        [(IDSGlobalLink *)self _markLinkAsUsed:pairCopy];
        [(IDSGlobalLink *)self _reportNoSessionState:pairCopy errorCode:602];
        linkEngine = [pairCopy linkEngine];
        linkUniqueName2 = [pairCopy linkUniqueName];
        [linkEngine linkDidFail:linkUniqueName2 errorCode:602 isRecoverable:1 shouldReconnect:1];
      }
    }

    else
    {
      [(IDSGlobalLink *)self _handleRemapping:pairCopy errorCode:602 reconnectQUIC:1];
    }
  }

  else
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v10 = objc_opt_respondsToSelector();

    if (v10)
    {
      v11 = objc_loadWeakRetained(&self->_delegate);
      [v11 terminateCallDueToIdleClientForLink:self];
    }
  }
}

- (void)receiveBlockedIndicationWithReason:(unsigned int)reason
{
  v3 = *&reason;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 didReceiveBlockedIndicationForLink:self reason:v3];
  }
}

- (void)receiveErrorIndicationWithCode:(unsigned int)code
{
  v3 = *&code;
  WeakRetained = objc_loadWeakRetained(&self->_delegate);
  v6 = objc_opt_respondsToSelector();

  if (v6)
  {
    v7 = objc_loadWeakRetained(&self->_delegate);
    [v7 link:self didReceiveErrorIndicationWithCode:v3];
  }
}

- (id)createLinkCycleForCandidatePair:(id)pair
{
  pairCopy = pair;
  if (([pairCopy isRelayStunCandidatePair] & 1) == 0 && (objc_msgSend(pairCopy, "isVirtualRelayStunCandidatePair") & 1) == 0)
  {
    if (self->_tokenToStunCheckPairs)
    {
      local = [pairCopy local];
      address = [local address];
      remote = [pairCopy remote];
      v8 = tokenForStunCandidatePair(address, [remote address], self->_cbuuid);
      if (v8)
      {
        tokenToStunCheckPairs = self->_tokenToStunCheckPairs;
        local2 = [pairCopy local];
        address2 = [local2 address];
        remote2 = [pairCopy remote];
        v13 = tokenForStunCandidatePair(address2, [remote2 address], self->_cbuuid);
        v14 = CFDictionaryGetValue(tokenToStunCheckPairs, v13);
      }

      else
      {
        v14 = 0;
      }

      if (v14)
      {
        linkMetrics = [v14 linkMetrics];

        if (linkMetrics)
        {
          linkMetrics2 = [v14 linkMetrics];

          goto LABEL_13;
        }
      }
    }

    else
    {
      v14 = 0;
    }
  }

  linkMetrics2 = [(IDSGFTMetricsCollector *)self->_metricsCollector createLinkCycle];
LABEL_13:

  return linkMetrics2;
}

- (id)interfaceNameForCandidatePair:(id)pair
{
  local = [pair local];
  v5 = -[IDSGlobalLink _interfaceNameForInterfaceIndex:](self, "_interfaceNameForInterfaceIndex:", [local index]);

  return v5;
}

- (tagIDSQRSendInfo)sendInfoForCandidatePair:(id)pair
{
  sendInfoList = self->_sendInfoList;
  linkID = [pair linkID];

  return IDSQRSendInfoList_ItemAtIndex(sendInfoList, linkID);
}

- (BOOL)isCandidatePairConstrained:(id)constrained
{
  local = [constrained local];
  LOBYTE(self) = -[IDSGlobalLink _isInterfaceConstrainedWithInterfaceIndex:](self, "_isInterfaceConstrainedWithInterfaceIndex:", [local index]);

  return self;
}

- (BOOL)isCandidatePairDelegated:(id)delegated
{
  local = [delegated local];
  LOBYTE(self) = -[IDSGlobalLink _isInterfaceDelegatedWithInterfaceIndex:](self, "_isInterfaceDelegatedWithInterfaceIndex:", [local index]);

  return self;
}

- (id)_createInterfaceAddressArrayWithNWLink:(BOOL)link wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular
{
  cellularCopy = cellular;
  fiCopy = fi;
  *&v27[5] = *MEMORY[0x1E69E9840];
  if (!self->_startPort)
  {
LABEL_22:
    v12 = [(IDSNWLink *)self->_nwLink newListenerWithClientUUID:self->_clientUUID wantsWiFi:fiCopy wantsCellular:cellularCopy, v22, v24];
    if (v12)
    {
      v16 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        port = [(IDSNWLink *)self->_nwLink port];
        cellularPort = [(IDSNWLink *)self->_nwLink cellularPort];
        *buf = 67109376;
        v27[0] = port;
        LOWORD(v27[1]) = 1024;
        *(&v27[1] + 2) = cellularPort;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "bind to random ports(%u,%u) succeeded", buf, 0xEu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          port2 = [(IDSNWLink *)self->_nwLink port];
          cellularPort2 = [(IDSNWLink *)self->_nwLink cellularPort];
          _IDSLogTransport(@"GL", @"IDS", @"bind to random ports(%u,%u) succeeded");
          if (_IDSShouldLog())
          {
            [(IDSNWLink *)self->_nwLink port:port2];
            [(IDSNWLink *)self->_nwLink cellularPort];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"bind to random ports(%u,%u) succeeded");
          }
        }
      }
    }

    else
    {
      v19 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed binding to random port, remove listeners.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed binding to random port, remove listeners.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed binding to random port, remove listeners.");
          }
        }
      }

      [(IDSNWLink *)self->_nwLink cleanup];
    }

    goto LABEL_36;
  }

  v8 = self->_startPort + LOWORD(self->_portRange) - 1;
  v9 = OSLogHandleForIDSCategory();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    startPort = self->_startPort;
    *buf = 67109376;
    v27[0] = startPort;
    LOWORD(v27[1]) = 1024;
    *(&v27[1] + 2) = v8;
    _os_log_impl(&dword_1A7AD9000, v9, OS_LOG_TYPE_DEFAULT, "use port range [%u, %u]", buf, 0xEu);
  }

  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
  {
    v22 = self->_startPort;
    v24 = v8;
    _IDSLogV(0, @"IDSFoundation", @"GL", @"use port range [%u, %u]");
  }

  v11 = self->_startPort;
  if (v11 >= v8)
  {
LABEL_16:
    [(IDSNWLink *)self->_nwLink setPort:0, v22];
    [(IDSNWLink *)self->_nwLink setCellularPort:0];
    v14 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = self->_startPort;
      *buf = 67109376;
      v27[0] = v15;
      LOWORD(v27[1]) = 1024;
      *(&v27[1] + 2) = v8;
      _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "all tries failed to bind port range [%u,%u], trying random port.", buf, 0xEu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = self->_startPort;
        v24 = v8;
        _IDSLogTransport(@"GL", @"IDS", @"all tries failed to bind port range [%u,%u], trying random port.");
        if (_IDSShouldLog())
        {
          v22 = self->_startPort;
          v24 = v8;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"all tries failed to bind port range [%u,%u], trying random port.");
        }
      }
    }

    goto LABEL_22;
  }

  while (1)
  {
    [(IDSNWLink *)self->_nwLink setPort:v11, v22, v24];
    [(IDSNWLink *)self->_nwLink setCellularPort:(v11 + 1)];
    v12 = [(IDSNWLink *)self->_nwLink newListenerWithClientUUID:self->_clientUUID wantsWiFi:fiCopy wantsCellular:cellularCopy];
    v13 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *v27 = v12;
      _os_log_impl(&dword_1A7AD9000, v13, OS_LOG_TYPE_DEFAULT, "Interface address array = %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v22 = v12;
        _IDSLogTransport(@"GL", @"IDS", @"Interface address array = %@");
        if (_IDSShouldLog())
        {
          v22 = v12;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"Interface address array = %@");
        }
      }
    }

    if (v12)
    {
      break;
    }

    LOWORD(v11) = v11 + 2;
    if (v8 <= v11)
    {
      goto LABEL_16;
    }
  }

LABEL_36:
  v20 = v12;

  return v20;
}

- (id)_addSocketAndInterfaceAddressWithNWLink:(BOOL)link wantsWiFi:(BOOL)fi wantsCellular:(BOOL)cellular
{
  linkCopy = link;
  v27 = *MEMORY[0x1E69E9840];
  v7 = [(IDSGlobalLink *)self _createInterfaceAddressArrayWithNWLink:link wantsWiFi:fi wantsCellular:cellular];
  v8 = [v7 mutableCopy];

  if (v8)
  {
    [(IDSGlobalLink *)self _delayProcessingCellularInterfaces:v8];
    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v9 = v8;
    v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
    if (v10)
    {
      v11 = *v21;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v21 != v11)
          {
            objc_enumerationMutation(v9);
          }

          v13 = *(*(&v20 + 1) + 8 * i);
          if ([v13 IPVersion] == 1)
          {
            index = [v13 index];
            name = [v13 name];
            [(IDSGlobalLink *)self _getNAT64PrefixForInterface:index interfaceName:name completionBlock:0];
          }
        }

        v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
      }

      while (v10);
    }

    if ([v9 count])
    {
      [(IDSGlobalLink *)self _updateInterfaceAddressesWithAddList:v9 removeList:0];
    }

    v16 = v9;
  }

  else
  {
    v17 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = @"NO";
      if (linkCopy)
      {
        v18 = @"YES";
      }

      *buf = 138412290;
      v26 = v18;
      _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "failed to create interface address array enableIPv6 %@.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to create interface address array enableIPv6 %@.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create interface address array enableIPv6 %@.");
        }
      }
    }
  }

  return v8;
}

- (void)_getAndProcessDatablobsFromReceivedMaterials:(id)materials
{
  v40 = *MEMORY[0x1E69E9840];
  materialsCopy = materials;
  v4 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v39 = materialsCopy;
    _os_log_impl(&dword_1A7AD9000, v4, OS_LOG_TYPE_DEFAULT, "_getAndProcessDatablobsFromReceivedMaterials: materials: %@", buf, 0xCu);
  }

  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v35 = 0u;
  obj = materialsCopy;
  v26 = [(__CFDictionary *)obj countByEnumeratingWithState:&v32 objects:v37 count:16];
  if (v26)
  {
    v25 = *v33;
    do
    {
      v6 = 0;
      do
      {
        if (*v33 != v25)
        {
          objc_enumerationMutation(obj);
        }

        v27 = v6;
        materialInfos = [*(*(&v32 + 1) + 8 * v6) materialInfos];
        v28 = 0u;
        v29 = 0u;
        v30 = 0u;
        v31 = 0u;
        v8 = [materialInfos countByEnumeratingWithState:&v28 objects:v36 count:16];
        if (v8)
        {
          v9 = v8;
          v10 = *v29;
          do
          {
            for (i = 0; i != v9; ++i)
            {
              if (*v29 != v10)
              {
                objc_enumerationMutation(materialInfos);
              }

              v12 = *(*(&v28 + 1) + 8 * i);
              materialType = [v12 materialType];
              materialContent = [v12 materialContent];
              if (materialType == 12 || materialType == 6)
              {
                v16 = [MEMORY[0x1E696AD98] numberWithInt:materialType];
                v17 = [(__CFDictionary *)Mutable objectForKey:v16];

                if (!v17)
                {
                  v17 = objc_alloc_init(MEMORY[0x1E695DF70]);
                }

                [v17 addObject:materialContent];
                v18 = [MEMORY[0x1E696AD98] numberWithInt:materialType];
                [(__CFDictionary *)Mutable setObject:v17 forKey:v18];
              }
            }

            v9 = [materialInfos countByEnumeratingWithState:&v28 objects:v36 count:16];
          }

          while (v9);
        }

        v6 = v27 + 1;
      }

      while (v27 + 1 != v26);
      v26 = [(__CFDictionary *)obj countByEnumeratingWithState:&v32 objects:v37 count:16];
    }

    while (v26);
  }

  v19 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    v39 = Mutable;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "_getAndProcessDatablobsFromReceivedMaterials: typeToEncryptedDataBlobs: %@", buf, 0xCu);
  }

  if ([(__CFDictionary *)Mutable count])
  {
    WeakRetained = objc_loadWeakRetained(&self->_delegate);
    v21 = objc_opt_respondsToSelector();

    if (v21)
    {
      v22 = objc_loadWeakRetained(&self->_delegate);
      [v22 link:self didReceiveEncryptedDataBlobs:Mutable];
    }
  }
}

- (void)_parseActiveExperiments:(id)experiments
{
  v29 = *MEMORY[0x1E69E9840];
  experimentsCopy = experiments;
  v4 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v5 = experimentsCopy;
  v6 = [v5 countByEnumeratingWithState:&v22 objects:v28 count:16];
  if (!v6)
  {
    goto LABEL_23;
  }

  v7 = v6;
  v8 = *v23;
  while (2)
  {
    v9 = 0;
    do
    {
      if (*v23 != v8)
      {
        objc_enumerationMutation(v5);
      }

      v10 = *(*(&v22 + 1) + 8 * v9);
      experimentName = [v10 experimentName];

      if (!experimentName)
      {
        v18 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          v27[0] = v10;
          _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "Experiment name is not set in IDSQRProtoChannelExperiment: %@. Skipping...", buf, 0xCu);
        }

        goto LABEL_23;
      }

      experimentName2 = [v10 experimentName];
      testValue = [v10 testValue];
      if (testValue == 3)
      {
        stringValue = [MEMORY[0x1E696AD98] numberWithInt:{objc_msgSend(v10, "int32Value")}];
        goto LABEL_13;
      }

      v14 = testValue;
      if (testValue == 2)
      {
        stringValue = [v10 stringValue];
        goto LABEL_13;
      }

      if (testValue == 1)
      {
        stringValue = [MEMORY[0x1E696AD98] numberWithBool:{objc_msgSend(v10, "BOOLValue")}];
LABEL_13:
        v16 = stringValue;
        [v4 setObject:stringValue forKey:experimentName2];
        goto LABEL_14;
      }

      v16 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109378;
        LODWORD(v27[0]) = v14;
        WORD2(v27[0]) = 2112;
        *(v27 + 6) = v10;
        _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "Received unknown IDSQRProtoChannelExperiment_TestValue: %d in IDSQRProtoChannelExperiment: %@", buf, 0x12u);
      }

LABEL_14:

      ++v9;
    }

    while (v7 != v9);
    v17 = [v5 countByEnumeratingWithState:&v22 objects:v28 count:16];
    v7 = v17;
    if (v17)
    {
      continue;
    }

    break;
  }

LABEL_23:

  v19 = [v4 copy];
  qrChannelExperiments = self->_qrChannelExperiments;
  self->_qrChannelExperiments = v19;
}

- (void)_buildQrExperiments
{
  v46 = *MEMORY[0x1E69E9840];
  v3 = objc_alloc_init(MEMORY[0x1E695DF90]);
  if ([(NSDictionary *)self->_qrSessionExperiments count])
  {
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v4 = self->_qrSessionExperiments;
    v5 = [(NSDictionary *)v4 countByEnumeratingWithState:&v39 objects:v45 count:16];
    if (v5)
    {
      v6 = v5;
      v7 = *v40;
      do
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v40 != v7)
          {
            objc_enumerationMutation(v4);
          }

          v9 = *(*(&v39 + 1) + 8 * i);
          v10 = [(NSDictionary *)self->_qrSessionExperiments objectForKey:v9];
          v11 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrse_%@", v9];
          [v3 setObject:v10 forKey:v11];
        }

        v6 = [(NSDictionary *)v4 countByEnumeratingWithState:&v39 objects:v45 count:16];
      }

      while (v6);
    }
  }

  if ([(NSDictionary *)self->_qrChannelExperiments count])
  {
    v37 = 0u;
    v38 = 0u;
    v35 = 0u;
    v36 = 0u;
    v12 = self->_qrChannelExperiments;
    v13 = [(NSDictionary *)v12 countByEnumeratingWithState:&v35 objects:v44 count:16];
    if (v13)
    {
      v14 = v13;
      v15 = *v36;
      do
      {
        for (j = 0; j != v14; ++j)
        {
          if (*v36 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v17 = *(*(&v35 + 1) + 8 * j);
          v18 = [(NSDictionary *)self->_qrChannelExperiments objectForKey:v17];
          v19 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrce_%@", v17];
          [v3 setObject:v18 forKey:v19];
        }

        v14 = [(NSDictionary *)v12 countByEnumeratingWithState:&v35 objects:v44 count:16];
      }

      while (v14);
    }
  }

  glComputedSessionExperiments = self->_glComputedSessionExperiments;
  if (glComputedSessionExperiments)
  {
    v33 = 0u;
    v34 = 0u;
    v31 = 0u;
    v32 = 0u;
    v21 = glComputedSessionExperiments;
    v22 = [(NSDictionary *)v21 countByEnumeratingWithState:&v31 objects:v43 count:16];
    if (v22)
    {
      v23 = v22;
      v24 = *v32;
      do
      {
        for (k = 0; k != v23; ++k)
        {
          if (*v32 != v24)
          {
            objc_enumerationMutation(v21);
          }

          v26 = *(*(&v31 + 1) + 8 * k);
          v27 = [(NSDictionary *)self->_glComputedSessionExperiments objectForKeyedSubscript:v26];
          v28 = [MEMORY[0x1E696AEC0] stringWithFormat:@"qrse_%@", v26];
          [v3 setObject:v27 forKeyedSubscript:v28];
        }

        v23 = [(NSDictionary *)v21 countByEnumeratingWithState:&v31 objects:v43 count:16];
      }

      while (v23);
    }
  }

  v29 = [v3 copy];
  qrExperiments = self->_qrExperiments;
  self->_qrExperiments = v29;
}

- (BOOL)_processNWLinkAllocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v223 = *MEMORY[0x1E69E9840];
  responseCopy = response;
  deviceCopy = device;
  key = token;
  if (self->_allocbindEndTime == 0.0)
  {
    self->_allocbindEndTime = time;
  }

  [(IDSGFTMetricsCollector *)self->_metricsCollector quicAllocbindResponse];
  v200 = 0u;
  v201 = 0u;
  v198 = 0u;
  v199 = 0u;
  selfCopy = self;
  v16 = self->_interfaceAddressArray;
  v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v198 objects:v222 count:16];
  if (v17)
  {
    v18 = *v199;
    while (2)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v199 != v18)
        {
          objc_enumerationMutation(v16);
        }

        v20 = *(*(&v198 + 1) + 8 * i);
        if ([v20 index] == index)
        {
          metricsCollector = selfCopy->_metricsCollector;
          name = [v20 name];
          [(IDSGFTMetricsCollector *)metricsCollector allocbindResponseFromInterface:name];

          goto LABEL_13;
        }
      }

      v17 = [(NSMutableArray *)v16 countByEnumeratingWithState:&v198 objects:v222 count:16];
      if (v17)
      {
        continue;
      }

      break;
    }
  }

LABEL_13:

  messageType = [responseCopy messageType];
  v24 = messageType;
  if (messageType >= 0x29)
  {
    v174 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", messageType];
  }

  else
  {
    v174 = off_1E77E1408[messageType];
  }

  allocbindResponse = [responseCopy allocbindResponse];
  if (allocbindResponse)
  {
    Value = 0;
    if (key && selfCopy->_tokenToCandidatePairs)
    {
      Value = CFDictionaryGetValue(selfCopy->_tokenToCandidatePairs, key);
    }

    v181 = Value;
    state = [v181 state];
    nwLink = selfCopy->_nwLink;
    sessionID = [v181 sessionID];
    kindSuffix = [v181 kindSuffix];
    local = [v181 local];
    LOBYTE(v162) = [local isCellularStunCandidate];
    v175 = [(IDSNWLink *)nwLink connectionInfoForLocalAddress:address remoteAddress:remmoteAddress clientUniquePID:0 sessionID:sessionID type:5 isRelay:1 protocolStackSuffix:kindSuffix isCellular:v162];

    v30 = selfCopy->_metricsCollector;
    protocolStackDescription = [v175 protocolStackDescription];
    [(IDSGFTMetricsCollector *)v30 allocbindResponseForProtocolStack:protocolStackDescription];

    v32 = GLUtilConnectionDictionaryForNWConnectionInfo(v175, 1);
    connections = [v181 connections];
    [connections setObject:v32 forKeyedSubscript:@"qr"];

    linkMetrics = [v181 linkMetrics];
    [linkMetrics receiveAllocbindResponse];

    [(IDSGlobalLink *)selfCopy _setLinkMetricsAttributesForCandidatePair:v181];
    local2 = [v181 local];
    address = [local2 address];

    v37 = *(address + 1);
    if (v37 == 2)
    {
      if (IMGetDomainBoolForKey())
      {
LABEL_23:
        v38 = +[IDSFoundationLog GlobalLink];
        v39 = v38;
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          if (*(address + 1) == 30)
          {
            v40 = "IPv6";
          }

          else
          {
            v40 = "IPv4";
          }

          transactionID = [responseCopy transactionID];
          *buf = 136315394;
          *&buf[4] = v40;
          *&buf[12] = 2048;
          *&buf[14] = transactionID;
          v39 = v38;
          _os_log_impl(&dword_1A7AD9000, v38, OS_LOG_TYPE_DEFAULT, "_processNWLinkAllocbindResponse: force dropping [%s] quic allocbind response %llu.", buf, 0x16u);
        }

        v42 = 0;
        goto LABEL_225;
      }
    }

    else if (v37 == 30 && (IMGetDomainBoolForKey() & 1) != 0)
    {
      goto LABEL_23;
    }

    if (-[NSObject removeProtoRequest:](v181, "removeProtoRequest:", [responseCopy transactionID]))
    {
      isRealloc = [v181 isRealloc];
      if (selfCopy->_state < 5 || ([v181 pendingNoSessionStateAllocbind]& 1) != 0)
      {
        materials = [allocbindResponse materials];
        [(IDSGlobalLink *)selfCopy _getAndProcessDatablobsFromReceivedMaterials:materials];
        if (state > 2)
        {
          if (([v181 pendingNoSessionStateAllocbind]& 1) == 0)
          {
            v80 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v80, OS_LOG_TYPE_DEFAULT))
            {
              v81 = (&_IDSStunCandidatePairStateStrings)[state];
              *buf = 136315394;
              *&buf[4] = v81;
              *&buf[12] = 2112;
              *&buf[14] = v174;
              _os_log_impl(&dword_1A7AD9000, v80, OS_LOG_TYPE_DEFAULT, "candidate pair state is [%s], ignore %@", buf, 0x16u);
            }

            v42 = 1;
            goto LABEL_224;
          }
        }

        else
        {
          allocbindStartTime = selfCopy->_allocbindStartTime;
          allocbindEndTime = selfCopy->_allocbindEndTime;
          v46 = +[IDSFoundationLog GlobalLink];
          v47 = (allocbindEndTime - allocbindStartTime) * 1000.0;
          if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
          {
            local3 = [v181 local];
            transport = [local3 transport];
            v50 = *(address + 1);
            idsSessionID = selfCopy->_idsSessionID;
            sessionID2 = [v181 sessionID];
            *buf = 138413826;
            *&buf[4] = v174;
            *&buf[12] = 2112;
            *&buf[14] = key;
            *&buf[22] = 2048;
            *&buf[24] = v47;
            LOWORD(v216) = 2048;
            *(&v216 + 2) = transport;
            WORD5(v216) = 1024;
            HIDWORD(v216) = v50;
            *v217 = 2112;
            *&v217[2] = idsSessionID;
            *&v217[10] = 2112;
            *&v217[12] = sessionID2;
            _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_DEFAULT, "Received %@ on %@ after %0.6lf ms over protocol: %ld family: %d IDSSessionID: %@ QRSessionID: %@", buf, 0x44u);
          }

          v53 = stunMessageTypeFromProtoMessageType(v24, isRealloc);
          GLUtilReportAWDStunMessageEventWithType(v53, 0, v181, v47);
          reportingDataBlob = [allocbindResponse reportingDataBlob];
          local4 = [v181 local];
          v56 = [reportingDataBlob base64EncodedStringWithOptions:0];
          [local4 setAllocbindDataBlob:v56];

          local5 = [v181 local];
          software = [allocbindResponse software];
          [local5 setServerSoftwareVersion:software];

          v59 = GLUCreateQRStunMessageEventWithType(v53, 0, v181, selfCopy->_timeBase, v47);
          if (v59)
          {
            WeakRetained = objc_loadWeakRetained(&selfCopy->_delegate);
            v61 = objc_opt_respondsToSelector();

            if (v61)
            {
              v62 = objc_loadWeakRetained(&selfCopy->_delegate);
              [v62 link:selfCopy didAddQREvent:v59];
            }
          }
        }

        clientAddress = [allocbindResponse clientAddress];
        if ([clientAddress length])
        {
          local6 = [v181 local];
          [local6 setExternalAddress:clientAddress];

          channelId = [allocbindResponse channelId];
          v70 = channelId;
          if (channelId)
          {
            channelNumber = [v181 channelNumber];
            v72 = bswap32(channelId) >> 16;
            if (!channelNumber)
            {
              v82 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109634;
                *&buf[4] = 0;
                *&buf[8] = 1024;
                *&buf[10] = v70;
                *&buf[14] = 2112;
                *&buf[16] = key;
                _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "update channelNumber (%04x->%04x) for %@", buf, 0x18u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v163 = v70;
                  v165 = key;
                  software3 = 0;
                  _IDSLogTransport(@"GL", @"IDS", @"update channelNumber (%04x->%04x) for %@");
                  if (_IDSShouldLog())
                  {
                    v163 = v70;
                    v165 = key;
                    software3 = 0;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update channelNumber (%04x->%04x) for %@");
                  }
                }
              }

              [v181 setChannelNumber:v72, software3, v163, v165];
LABEL_78:
              IDSSimpleUInt16List_AddItem(&selfCopy->_channelNumberList, v72);
              [(IDSGlobalLink *)selfCopy _setChannelToCandidatePair:v181 localAddress:address remoteAddress:remmoteAddress channelNumber:v72];
              v83 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
              {
                participantType = [allocbindResponse participantType];
                v85 = @"lightweight";
                if ((participantType & 1) == 0)
                {
                  v85 = @"normal";
                }

                *buf = 138412290;
                *&buf[4] = v85;
                _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "server reports this client is a %@ participant", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
              {
                v86 = ([allocbindResponse participantType] & 1) != 0 ? @"lightweight" : @"normal";
                software3 = v86;
                _IDSLogTransport(@"GL", @"IDS", @"server reports this client is a %@ participant");
                if (_IDSShouldLog())
                {
                  if ([allocbindResponse participantType])
                  {
                    v87 = @"lightweight";
                  }

                  else
                  {
                    v87 = @"normal";
                  }

                  software3 = v87;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"server reports this client is a %@ participant");
                }
              }

              v88 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
              {
                software2 = [allocbindResponse software];
                *buf = 138412290;
                *&buf[4] = software2;
                _os_log_impl(&dword_1A7AD9000, v88, OS_LOG_TYPE_DEFAULT, "received QR server build version %@", buf, 0xCu);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  software3 = [allocbindResponse software];
                  _IDSLogTransport(@"GL", @"IDS", @"received QR server build version %@");

                  if (_IDSShouldLog())
                  {
                    software3 = [allocbindResponse software];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"received QR server build version %@");
                  }
                }
              }

              -[NSObject setRelayLinkID:](v181, "setRelayLinkID:", [allocbindResponse linkId]);
              [allocbindResponse quicConnectionInfos];
              v196 = 0u;
              v197 = 0u;
              v194 = 0u;
              obj = v195 = 0u;
              v90 = [obj countByEnumeratingWithState:&v194 objects:v221 count:16];
              if (v90)
              {
                v91 = *v195;
                do
                {
                  for (j = 0; j != v90; ++j)
                  {
                    if (*v195 != v91)
                    {
                      objc_enumerationMutation(obj);
                    }

                    v93 = *(*(&v194 + 1) + 8 * j);
                    quicConnectionId = [v93 quicConnectionId];
                    quicConnectionType = [v93 quicConnectionType];
                    qUICConnectionIDs = [v181 QUICConnectionIDs];
                    v97 = qUICConnectionIDs;
                    if (quicConnectionType == 1)
                    {
                      [qUICConnectionIDs setRemoteIDSConnectionIDData:quicConnectionId];
                    }

                    else if (quicConnectionType)
                    {
                      v98 = +[IDSFoundationLog GlobalLink];
                      if (os_log_type_enabled(v98, OS_LOG_TYPE_DEFAULT))
                      {
                        *buf = 67109378;
                        *&buf[4] = quicConnectionType;
                        *&buf[8] = 2112;
                        *&buf[10] = v93;
                        _os_log_impl(&dword_1A7AD9000, v98, OS_LOG_TYPE_DEFAULT, "Received unknown QuicConnectionType: %d in QuicConnectionInfo: %@", buf, 0x12u);
                      }
                    }

                    else
                    {
                      [qUICConnectionIDs setRemoteAVCConnectionIDData:quicConnectionId];
                    }
                  }

                  v90 = [obj countByEnumeratingWithState:&v194 objects:v221 count:16];
                }

                while (v90);
              }

              if ([(IDSGlobalLink *)selfCopy _shouldUseQRTLE])
              {
                local7 = [v181 local];
                if ([local7 isCellularStunCandidate])
                {
                  allowTLEOverCellular = selfCopy->_allowTLEOverCellular;

                  if (!allowTLEOverCellular)
                  {
                    goto LABEL_154;
                  }
                }

                else
                {
                }

                qUICConnectionIDs2 = [v181 QUICConnectionIDs];
                isComplete = [qUICConnectionIDs2 isComplete];

                if (isComplete)
                {
                  sessionID3 = [v181 sessionID];
                  local8 = [v181 local];
                  address2 = [local8 address];

                  remote = [v181 remote];
                  external = [remote external];

                  qUICConnectionIDs3 = [v181 QUICConnectionIDs];
                  channelNumber2 = [v181 channelNumber];
                  if ([(IDSNWLink *)selfCopy->_nwLink createQUICPodQRConnectionsForSession:sessionID3 localAddress:address2 remoteAddress:external quicConnectionIDs:qUICConnectionIDs3 channelNumber:channelNumber2])
                  {
                    *&v111 = 0xAAAAAAAAAAAAAAAALL;
                    *(&v111 + 1) = 0xAAAAAAAAAAAAAAAALL;
                    v219 = v111;
                    v220 = v111;
                    *&v217[16] = v111;
                    v218 = v111;
                    v216 = v111;
                    *v217 = v111;
                    *buf = v111;
                    *&buf[16] = v111;
                    __str[6] = v111;
                    __str[7] = v111;
                    __str[4] = v111;
                    __str[5] = v111;
                    __str[2] = v111;
                    __str[3] = v111;
                    __str[0] = v111;
                    __str[1] = v111;
                    SAToIPPortString(buf, 0x80uLL, address2);
                    SAToIPPortString(__str, 0x80uLL, external);
                    v112 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v112, OS_LOG_TYPE_DEFAULT))
                    {
                      *v204 = 138413314;
                      v205 = sessionID3;
                      v206 = 2080;
                      v207 = buf;
                      v208 = 2080;
                      v209 = __str;
                      v210 = 2112;
                      v211 = qUICConnectionIDs3;
                      v212 = 1024;
                      v213 = __rev16(channelNumber2);
                      _os_log_impl(&dword_1A7AD9000, v112, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded", v204, 0x30u);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        v113 = __rev16(channelNumber2);
                        v167 = qUICConnectionIDs3;
                        v168 = v113;
                        v165 = __str;
                        sessionID5 = sessionID3;
                        v163 = buf;
                        _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded");
                        if (_IDSShouldLog())
                        {
                          v167 = qUICConnectionIDs3;
                          v168 = v113;
                          v165 = __str;
                          sessionID5 = sessionID3;
                          v163 = buf;
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@, %s, %s, %@, 0x%04x) succeeded");
                        }
                      }
                    }
                  }

                  else
                  {
                    v116 = OSLogHandleForTransportCategory();
                    if (os_log_type_enabled(v116, OS_LOG_TYPE_DEFAULT))
                    {
                      sessionID4 = [v181 sessionID];
                      *buf = 138412290;
                      *&buf[4] = sessionID4;
                      _os_log_impl(&dword_1A7AD9000, v116, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@) failed", buf, 0xCu);
                    }

                    if (os_log_shim_legacy_logging_enabled())
                    {
                      if (_IDSShouldLogTransport())
                      {
                        sessionID5 = [v181 sessionID];
                        _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@) failed");

                        if (_IDSShouldLog())
                        {
                          sessionID5 = [v181 sessionID];
                          _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@) failed");
                        }
                      }
                    }

                    if (selfCopy->_clientType == 6)
                    {
                      v118 = OSLogHandleForTransportCategory();
                      if (os_log_type_enabled(v118, OS_LOG_TYPE_DEFAULT))
                      {
                        sessionID6 = [v181 sessionID];
                        *buf = 138412290;
                        *&buf[4] = sessionID6;
                        _os_log_impl(&dword_1A7AD9000, v118, OS_LOG_TYPE_DEFAULT, "createQUICPodQRConnectionsForSession(%@) failed, triggering ABC", buf, 0xCu);
                      }

                      if (os_log_shim_legacy_logging_enabled())
                      {
                        if (_IDSShouldLogTransport())
                        {
                          sessionID5 = [v181 sessionID];
                          _IDSLogTransport(@"GL", @"IDS", @"createQUICPodQRConnectionsForSession(%@) failed, triggering ABC");

                          if (_IDSShouldLog())
                          {
                            sessionID5 = [v181 sessionID];
                            _IDSLogV(0, @"IDSFoundation", @"GL", @"createQUICPodQRConnectionsForSession(%@) failed, triggering ABC");
                          }
                        }
                      }

                      [(IDSGlobalLink *)selfCopy _triggerSymptomsWithType:@"IDSQuickRelayShared" subType:@"TLE" subTypeContext:@"SetupFailed" duration:0, sessionID5];
                    }
                  }

                  goto LABEL_153;
                }

                v114 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
                {
                  qUICConnectionIDs4 = [v181 QUICConnectionIDs];
                  *buf = 138412290;
                  *&buf[4] = qUICConnectionIDs4;
                  _os_log_impl(&dword_1A7AD9000, v114, OS_LOG_TYPE_DEFAULT, "QUIC connectionIDs not available for TLE (%@)", buf, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    sessionID5 = [v181 QUICConnectionIDs];
                    _IDSLogTransport(@"GL", @"IDS", @"QUIC connectionIDs not available for TLE (%@)");

                    if (_IDSShouldLog())
                    {
                      sessionID3 = [v181 QUICConnectionIDs];
                      sessionID5 = sessionID3;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"QUIC connectionIDs not available for TLE (%@)");
LABEL_153:
                    }
                  }
                }
              }

LABEL_154:
              activeExperiments = [allocbindResponse activeExperiments];
              [(IDSGlobalLink *)selfCopy _parseActiveExperiments:activeExperiments];

              [(IDSGlobalLink *)selfCopy _buildQrExperiments];
              v121 = [MEMORY[0x1E695DFA8] set];
              if ([allocbindResponse ackedStaleLinkIdsCount])
              {
                v122 = 0;
                do
                {
                  v123 = *([allocbindResponse ackedStaleLinkIds] + 4 * v122);
                  v124 = objc_alloc_init(IDSGLUsedLink);
                  [(IDSGLUsedLink *)v124 setLinkID:v123];
                  clientAddress2 = [allocbindResponse clientAddress];
                  [(IDSGLUsedLink *)v124 setLocalIP:clientAddress2];

                  remote2 = [v181 remote];
                  externalAddressString = [remote2 externalAddressString];
                  [(IDSGLUsedLink *)v124 setServerIP:externalAddressString];

                  [v121 addObject:v124];
                  ++v122;
                }

                while ([allocbindResponse ackedStaleLinkIdsCount] > v122);
              }

              v192 = 0u;
              v193 = 0u;
              v191 = 0u;
              v190 = 0u;
              v128 = v121;
              v129 = [v128 countByEnumeratingWithState:&v190 objects:v203 count:16];
              if (v129)
              {
                v130 = *v191;
                do
                {
                  for (k = 0; k != v129; ++k)
                  {
                    if (*v191 != v130)
                    {
                      objc_enumerationMutation(v128);
                    }

                    [(NSMutableSet *)selfCopy->_usedLinks removeObject:*(*(&v190 + 1) + 8 * k)];
                  }

                  v129 = [v128 countByEnumeratingWithState:&v190 objects:v203 count:16];
                }

                while (v129);
              }

              materials2 = [allocbindResponse materials];
              [(IDSGlobalLink *)selfCopy receiveKeyMaterials:materials2];

              quicMaterialExchangeProvider = selfCopy->_quicMaterialExchangeProvider;
              if (quicMaterialExchangeProvider)
              {
                [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider sendDesiredMaterialsIfNeeded];
              }

              if (state > 2)
              {
                goto LABEL_220;
              }

              [v181 setState:3];
              [(IDSGlobalLink *)selfCopy _notifyLinkEngineCandidatePairDidConnect:v181];
              v134 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v134, OS_LOG_TYPE_DEFAULT))
              {
                v135 = (&_IDSStunCandidatePairStateStrings)[state];
                *buf = 136315650;
                *&buf[4] = v135;
                *&buf[12] = 2080;
                *&buf[14] = off_1EB2B43C0;
                *&buf[22] = 2112;
                *&buf[24] = key;
                _os_log_impl(&dword_1A7AD9000, v134, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v164 = off_1EB2B43C0;
                  v166 = key;
                  v160 = (&_IDSStunCandidatePairStateStrings)[state];
                  _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
                  if (_IDSShouldLog())
                  {
                    v164 = off_1EB2B43C0;
                    v166 = key;
                    v160 = (&_IDSStunCandidatePairStateStrings)[state];
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
                  }
                }
              }

              v136 = [v181 linkEngine:v160];

              if (v136)
              {
                linkEngine = [v181 linkEngine];
                linkUniqueName = [v181 linkUniqueName];
                v139 = [linkEngine isLinkConnecting:linkUniqueName];

                if ((v139 & 1) == 0)
                {
                  v140 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v140, OS_LOG_TYPE_DEFAULT))
                  {
                    linkUniqueName2 = [v181 linkUniqueName];
                    *buf = 138412546;
                    *&buf[4] = linkUniqueName2;
                    *&buf[12] = 2112;
                    *&buf[14] = v181;
                    _os_log_impl(&dword_1A7AD9000, v140, OS_LOG_TYPE_DEFAULT, "Link Engine link no longer connecting: %@, disconnect candidate pair %@", buf, 0x16u);
                  }

LABEL_191:

                  v151 = +[IDSFoundationLog GlobalLink];
                  if (os_log_type_enabled(v151, OS_LOG_TYPE_DEFAULT))
                  {
                    *buf = 138412290;
                    *&buf[4] = v181;
                    _os_log_impl(&dword_1A7AD9000, v151, OS_LOG_TYPE_DEFAULT, "Disconnecting %@", buf, 0xCu);
                  }

                  [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:key reason:8];
                }
              }

              else if ([v181 isRelayStunCandidatePair]&& (([v181 isSharedQRSession]| isRealloc) & 1) == 0)
              {
                sessionID7 = [v181 sessionID];
                v143 = [(IDSGlobalLink *)selfCopy _getCandidatePairsWithSessionID:sessionID7 inState:4];

                v188 = 0u;
                v189 = 0u;
                v186 = 0u;
                v187 = 0u;
                v140 = v143;
                v144 = [v140 countByEnumeratingWithState:&v186 objects:v202 count:16];
                if (v144)
                {
                  v145 = *v187;
                  while (2)
                  {
                    v146 = 0;
                    v147 = v181;
                    do
                    {
                      if (*v187 != v145)
                      {
                        objc_enumerationMutation(v140);
                        v147 = v181;
                      }

                      v148 = *(*(&v186 + 1) + 8 * v146);
                      if (v148 != v147)
                      {
                        v149 = +[IDSFoundationLog GlobalLink];
                        if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
                        {
                          sessionID8 = [v181 sessionID];
                          *buf = 138412802;
                          *&buf[4] = v148;
                          *&buf[12] = 2112;
                          *&buf[14] = sessionID8;
                          *&buf[22] = 2112;
                          *&buf[24] = v181;
                          _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "Found another connected candidate pair %@ with the same QRSessionID %@ disconnecting %@", buf, 0x20u);
                        }

                        goto LABEL_191;
                      }

                      ++v146;
                    }

                    while (v144 != v146);
                    v144 = [v140 countByEnumeratingWithState:&v186 objects:v202 count:16];
                    if (v144)
                    {
                      continue;
                    }

                    break;
                  }
                }
              }

              [(IDSGlobalLink *)selfCopy _setFirstDefaultCandidatePair:v181];
              if (isRealloc)
              {
                if (([v181 hbStarted]& 1) == 0)
                {
                  v152 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v152, OS_LOG_TYPE_DEFAULT))
                  {
                    pendingRealloc = [v181 pendingRealloc];
                    v154 = @"NO";
                    if (pendingRealloc)
                    {
                      v154 = @"YES";
                    }

                    *buf = 138412290;
                    *&buf[4] = v154;
                    _os_log_impl(&dword_1A7AD9000, v152, OS_LOG_TYPE_DEFAULT, "receive reallocate response, send HBR (%@).", buf, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled() && _IDSShouldLogTransport())
                  {
                    v155 = [v181 pendingRealloc]? @"YES" : @"NO";
                    v161 = v155;
                    _IDSLogTransport(@"GL", @"IDS", @"receive reallocate response, send HBR (%@).");
                    if (_IDSShouldLog())
                    {
                      if ([v181 pendingRealloc])
                      {
                        v156 = @"YES";
                      }

                      else
                      {
                        v156 = @"NO";
                      }

                      v161 = v156;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"receive reallocate response, send HBR (%@).");
                    }
                  }

                  [(IDSGlobalLink *)selfCopy _sendCommandMessage:3 stunMessage:0 options:0 candidatePairToken:key, v161];
                  [v181 setHbStarted:1];
                }

                if (([v181 isSharedQRSession]& 1) == 0)
                {
                  goto LABEL_222;
                }
              }

              else
              {
                [(IDSGlobalLink *)selfCopy _processXORMappedAddress:v181 arrivalTime:time];
                if ([v181 allocateType]== 2)
                {
                  [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:key reason:0];
                  goto LABEL_222;
                }
              }

              if (![(IDSGlobalLink *)selfCopy _postProcessQUICAllocbindResponse:allocbindResponse candidatePair:v181])
              {
                if (selfCopy->_delaySessionConnected)
                {
                  if (!selfCopy->_isInitiator)
                  {
                    v182[0] = MEMORY[0x1E69E9820];
                    v182[1] = 3221225472;
                    v182[2] = sub_1A7BC56F8;
                    v182[3] = &unk_1E77E0E18;
                    v183 = v181;
                    v184 = selfCopy;
                    v185 = key;
                    [v183 startSessionConnectedTimer:30 block:v182];
                  }
                }

                else
                {
                  [(IDSGlobalLink *)selfCopy _sendCommandMessage:1 stunMessage:0 options:0 candidatePairToken:key];
                }

LABEL_220:
                if ([v181 pendingNoSessionStateAllocbind])
                {
                  [v181 setPendingNoSessionState:0];
                }
              }

LABEL_222:

              v42 = 1;
              goto LABEL_223;
            }

            v73 = __rev16(channelNumber);
            if (channelId == v73)
            {
              v74 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 67109120;
                *&buf[4] = v70;
                _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "channelNumber unchanged (%04x)", buf, 8u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  software3 = v70;
                  _IDSLogTransport(@"GL", @"IDS", @"channelNumber unchanged (%04x)");
                  if (_IDSShouldLog())
                  {
                    software3 = v70;
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"channelNumber unchanged (%04x)");
                  }
                }
              }

              goto LABEL_78;
            }

            v101 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v101, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 67109376;
              *&buf[4] = v73;
              *&buf[8] = 1024;
              *&buf[10] = v70;
              _os_log_impl(&dword_1A7AD9000, v101, OS_LOG_TYPE_DEFAULT, "channelNumber mismatch (%04x->%04x)", buf, 0xEu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                _IDSLogTransport(@"GL", @"IDS", @"channelNumber mismatch (%04x->%04x)");
                if (_IDSShouldLog())
                {
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"channelNumber mismatch (%04x->%04x)");
                }
              }
            }

LABEL_122:
            v42 = 0;
LABEL_223:
            v80 = clientAddress;
LABEL_224:

            v39 = materials;
            goto LABEL_225;
          }

          v79 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = v174;
            _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "receive %@ without channel-number", buf, 0xCu);
          }
        }

        else
        {
          v79 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v79, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *&buf[4] = v174;
            _os_log_impl(&dword_1A7AD9000, v79, OS_LOG_TYPE_DEFAULT, "receive %@ with invalid client address", buf, 0xCu);
          }
        }

        goto LABEL_122;
      }

      v75 = +[IDSFoundationLog GlobalLink];
      v39 = v75;
      if (os_log_type_enabled(v75, OS_LOG_TYPE_DEFAULT))
      {
        v76 = (&_IDSStunCandidatePairStateStrings)[state];
        pendingNoSessionStateAllocbind = [v181 pendingNoSessionStateAllocbind];
        v78 = @"NO";
        *buf = 136315650;
        *&buf[4] = v76;
        *&buf[12] = 2112;
        if (pendingNoSessionStateAllocbind)
        {
          v78 = @"YES";
        }

        *&buf[14] = v78;
        *&buf[22] = 2112;
        *&buf[24] = v174;
        v65 = "_processNWLinkAllocbindResponse: candidate pair state is [%s], pendingNoSessionStateAllocbind: %@, ignore %@";
        v39 = v75;
        v66 = v75;
        v67 = 32;
        goto LABEL_45;
      }
    }

    else
    {
      v63 = +[IDSFoundationLog GlobalLink];
      v39 = v63;
      if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
      {
        transactionID2 = [responseCopy transactionID];
        *buf = 134217984;
        *&buf[4] = transactionID2;
        v65 = "_processNWLinkAllocbindResponse: %llu not pending proto request";
        v39 = v63;
        v66 = v63;
        v67 = 12;
LABEL_45:
        _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, v65, buf, v67);
      }
    }

    v42 = 1;
LABEL_225:

    v43 = v181;
    goto LABEL_226;
  }

  v43 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *&buf[4] = v174;
    _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_DEFAULT, "invalid %@ received", buf, 0xCu);
  }

  v42 = 0;
LABEL_226:

  return v42;
}

- (BOOL)_processQUICUnallocbindResponse:(id)response fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remmoteAddress:(sockaddr *)remmoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v103 = *MEMORY[0x1E69E9840];
  responseCopy = response;
  deviceCopy = device;
  tokenCopy = token;
  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v87 = tokenCopy;
  v16 = Value;
  state = [v16 state];
  if ([v16 removeProtoRequest:{objc_msgSend(responseCopy, "transactionID")}])
  {
    if (state == 6)
    {
      reportingDataBlob = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(reportingDataBlob, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315138;
        prots = OBJC_PROTOCOL___IDSServerBagContentProvider.prots;
        v19 = "receive unallocbind response with state [%s], ignore.";
LABEL_10:
        _os_log_impl(&dword_1A7AD9000, reportingDataBlob, OS_LOG_TYPE_DEFAULT, v19, buf, 0xCu);
        goto LABEL_78;
      }

      goto LABEL_78;
    }

    v84 = state;
    [responseCopy startTime];
    v21 = v20;
    v22 = +[IDSFoundationLog GlobalLink];
    v23 = (time - v21) * 1000.0;
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      sessionID = [v16 sessionID];
      local = [v16 local];
      transport = [local transport];
      local2 = [v16 local];
      v29 = *([local2 address] + 1);
      *buf = 138413570;
      prots = idsSessionID;
      v93 = 2112;
      v94 = sessionID;
      v95 = 2112;
      v96 = v87;
      v97 = 2048;
      v98 = v23;
      v99 = 2048;
      v100 = transport;
      v101 = 1024;
      v102 = v29;
      _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "Received unallocbind response for IDSSessionID: %@ QRSessionID: %@ on %@ after %0.6lf ms over protocol: %ld family: %d", buf, 0x3Au);
    }

    v30 = stunMessageTypeFromProtoMessageType([responseCopy messageType], 0);
    v31 = v23;
    GLUtilReportAWDStunMessageEventWithType(v30, 0, v16, v31);
    unallocbindResponse = [responseCopy unallocbindResponse];
    reportingDataBlob = [unallocbindResponse reportingDataBlob];

    local3 = [v16 local];
    v34 = [reportingDataBlob base64EncodedStringWithOptions:0];
    [local3 setAllocbindDataBlob:v34];

    v85 = GLUCreateQRStunMessageEventWithType(v30, 0, v16, self->_timeBase, v31);
    if (v85)
    {
      WeakRetained = objc_loadWeakRetained(&self->_delegate);
      v36 = objc_opt_respondsToSelector();

      if (v36)
      {
        v37 = objc_loadWeakRetained(&self->_delegate);
        [v37 link:self didAddQREvent:v85];
      }
    }

    if (self->_state > 3)
    {
      transactionID = [responseCopy transactionID];
      if (self->_unallocbindRequestToReason)
      {
        v58 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:transactionID];
        if (v58)
        {
          unallocbindRequestToReason = self->_unallocbindRequestToReason;
          v60 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:transactionID];
          unsignedIntValue = [CFDictionaryGetValue(unallocbindRequestToReason v60)];
        }

        else
        {
          unsignedIntValue = [0 unsignedIntValue];
        }
      }

      else
      {
        unsignedIntValue = [0 unsignedIntValue];
      }

      v67 = self->_unallocbindRequestToReason;
      v68 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:transactionID];
      [(NSMutableDictionary *)v67 removeObjectForKey:v68];

      [(IDSGlobalLink *)self _notifyCandidatePairDisconnected:v16 withReason:unsignedIntValue];
      if (self->_isUPlusOneSession)
      {
        [(IDSGlobalLink *)self _destroyVirtualRelayLinksForCandidatePair:v16 withReason:unsignedIntValue];
      }

      v69 = [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0];
      v70 = v69;
      if (self->_state == 5)
      {
        [(IDSGlobalLink *)self _discardCandidatePairsWithOption:0 isReinitiating:0];
        if (!v70)
        {
          [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:0 reason:unsignedIntValue];
        }
      }

      else if (!v69 && [(NSString *)self->_cbuuid isEqualToString:@"12345678-7654-DADA-DADA-DADADADADADA"])
      {
        v71 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_1A7AD9000, v71, OS_LOG_TYPE_DEFAULT, "no more underlying link is connected.", buf, 2u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"no more underlying link is connected.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"no more underlying link is connected.");
            }
          }
        }

        [(IDSGlobalLink *)self disconnectWithCompletionHandler:0 isReinitiating:0];
      }

      goto LABEL_70;
    }

    [v16 setState:6];
    if (self->_useLinkEngine)
    {
      linkEngine = [v16 linkEngine];
      linkUniqueName = [v16 linkUniqueName];
      [linkEngine linkDidDisconnect:linkUniqueName];
    }

    v40 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      v41 = (&_IDSStunCandidatePairStateStrings)[v84];
      *buf = 136315650;
      prots = v41;
      v93 = 2080;
      v94 = off_1EB2B43D8;
      v95 = 2112;
      v96 = v87;
      _os_log_impl(&dword_1A7AD9000, v40, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v80 = off_1EB2B43D8;
        v82 = v87;
        v77 = (&_IDSStunCandidatePairStateStrings)[v84];
        _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
        if (_IDSShouldLog())
        {
          v80 = off_1EB2B43D8;
          v82 = v87;
          v77 = (&_IDSStunCandidatePairStateStrings)[v84];
          _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
        }
      }
    }

    v42 = [IDSFoundationLog GlobalLink:v77];
    if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
    {
      candidatePairToken = [v16 candidatePairToken];
      *buf = 138412290;
      prots = candidatePairToken;
      _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "Disconnecting unconnected QUIC connection %@ after successful unallocbind response", buf, 0xCu);
    }

    nwLink = self->_nwLink;
    sessionID2 = [v16 sessionID];
    local4 = [v16 local];
    address = [local4 address];
    remote = [v16 remote];
    -[IDSNWLink disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:](nwLink, "disconnectWithSessionID:localAddress:remoteAddress:waitTime:final:", sessionID2, address, [remote external], 1, 5.0);

    if ([(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0])
    {
LABEL_70:
      if ([v16 pendingNoSessionStateAllocbind])
      {
        [v16 setState:1];
        v74 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v74, OS_LOG_TYPE_DEFAULT))
        {
          v75 = (&_IDSStunCandidatePairStateStrings)[v84];
          *buf = 136315650;
          prots = v75;
          v93 = 2080;
          v94 = off_1EB2B43B0;
          v95 = 2112;
          v96 = v87;
          _os_log_impl(&dword_1A7AD9000, v74, OS_LOG_TYPE_DEFAULT, "unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"unallocbind response: pendingNoSessionStateAllocbind: update state (%s->%s) for %@.");
            }
          }
        }
      }

      goto LABEL_77;
    }

    v83 = _Block_copy(self->_connectReadyHandler);
    v49 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      prots = self;
      _os_log_impl(&dword_1A7AD9000, v49, OS_LOG_TYPE_DEFAULT, "failed to connect GlobalLink %@ due to session connected message timed out.", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        selfCopy2 = self;
        _IDSLogTransport(@"GL", @"IDS", @"failed to connect GlobalLink %@ due to session connected message timed out.");
        if (_IDSShouldLog())
        {
          selfCopy2 = self;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to connect GlobalLink %@ due to session connected message timed out.");
        }
      }
    }

    local5 = [v16 local];
    v51 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
    {
      v52 = (&_IDSStunTransportStrings)[[local5 transport]];
      *buf = 136315394;
      prots = v52;
      v93 = 1024;
      LODWORD(v94) = 22;
      _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_DEFAULT, "report session setup failure (%s, %d).", buf, 0x12u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v79 = (&_IDSStunTransportStrings)[[local5 transport]];
        v81 = 22;
        _IDSLogTransport(@"GL", @"IDS", @"report session setup failure (%s, %d).");
        if (_IDSShouldLog())
        {
          v79 = (&_IDSStunTransportStrings)[[local5 transport]];
          v81 = 22;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"report session setup failure (%s, %d).");
        }
      }
    }

    GLUtilReportAWDClientTimerEvent(305, 22, v16, self->_enableSKE, self->_isInitiator, 0.0);
    v53 = GLUCreateQRClientTimeEvent(305, 22, v16, self->_timeBase, 0.0);
    v54 = objc_loadWeakRetained(&self->_delegate);
    v55 = objc_opt_respondsToSelector();

    if (v55)
    {
      v56 = objc_loadWeakRetained(&self->_delegate);
      [v56 link:self didAddQREvent:v53];
    }

    if ([v16 isSelfQRSession])
    {

LABEL_77:
      goto LABEL_78;
    }

    if (v83)
    {
      v62 = MEMORY[0x1E696ABC0];
      v63 = [MEMORY[0x1E695DF20] dictionaryWithObject:@"SessionConnected message timed out." forKey:*MEMORY[0x1E696A578]];
      v64 = [v62 errorWithDomain:@"GlobalLink" code:9 userInfo:v63];

      v65 = im_primary_queue();
      block[0] = MEMORY[0x1E69E9820];
      block[1] = 3221225472;
      block[2] = sub_1A7BC65C4;
      block[3] = &unk_1E77DD0F0;
      v89 = v64;
      v90 = v83;
      v66 = v64;
      dispatch_async(v65, block);
    }

    else
    {
      v72 = objc_loadWeakRetained(&self->_delegate);
      v73 = objc_opt_respondsToSelector();

      if ((v73 & 1) == 0)
      {
LABEL_69:

        goto LABEL_70;
      }

      v66 = objc_loadWeakRetained(&self->_delegate);
      [v66 link:self didFailToConnectOverCloud:0 cbuuid:self->_cbuuid];
    }

    goto LABEL_69;
  }

  reportingDataBlob = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(reportingDataBlob, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    prots = [responseCopy transactionID];
    v19 = "_processQUICUnallocbindResponse: %llu not pending proto request";
    goto LABEL_10;
  }

LABEL_78:

  return 1;
}

- (BOOL)_processQUICReallocIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v11 = *&index;
  v151 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  deviceCopy = device;
  tokenCopy = token;
  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v17 = Value;
  reallocateIndication = [indicationCopy reallocateIndication];
  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    txnId = [reallocateIndication txnId];
    *buf = 134218242;
    *&buf[4] = txnId;
    *&buf[12] = 2112;
    *&buf[14] = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "receive realloc indication(%llu) on %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      txnId2 = [reallocateIndication txnId];
      v92 = tokenCopy;
      _IDSLogTransport(@"GL", @"IDS", @"receive realloc indication(%llu) on %@");
      if (_IDSShouldLog())
      {
        txnId2 = [reallocateIndication txnId];
        v92 = tokenCopy;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc indication(%llu) on %@");
      }
    }
  }

  if (reallocateIndication)
  {
    v21 = stunMessageTypeFromProtoMessageType([indicationCopy messageType], 0);
    reallocateToken = [reallocateIndication reallocateToken];
    if ([reallocateToken length])
    {
      v22 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *&buf[4] = reallocateToken;
        _os_log_impl(&dword_1A7AD9000, v22, OS_LOG_TYPE_DEFAULT, "receive realloc token %@", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          txnId2 = reallocateToken;
          _IDSLogTransport(@"GL", @"IDS", @"receive realloc token %@");
          if (_IDSShouldLog())
          {
            txnId2 = reallocateToken;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive realloc token %@");
          }
        }
      }

      clientAddress = [reallocateIndication clientAddress];
      serverAddress = [reallocateIndication serverAddress];
      *&v23 = 0xAAAAAAAAAAAAAAAALL;
      *(&v23 + 1) = 0xAAAAAAAAAAAAAAAALL;
      v149 = v23;
      v150 = v23;
      v147 = v23;
      v148 = v23;
      v145 = v23;
      v146 = v23;
      *buf = v23;
      *&buf[16] = v23;
      v24 = IPPortStringToSA(serverAddress, buf);
      if (IsValidSA(v24))
      {
        v25 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
        {
          *v136 = 138412290;
          *&v136[4] = serverAddress;
          _os_log_impl(&dword_1A7AD9000, v25, OS_LOG_TYPE_DEFAULT, "receive new relay server address [%@].", v136, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v89 = serverAddress;
            _IDSLogTransport(@"GL", @"IDS", @"receive new relay server address [%@].");
            if (_IDSShouldLog())
            {
              v89 = serverAddress;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"receive new relay server address [%@].");
            }
          }
        }

        *&v26 = 0xAAAAAAAAAAAAAAAALL;
        *(&v26 + 1) = 0xAAAAAAAAAAAAAAAALL;
        v142 = v26;
        v143 = v26;
        v140 = v26;
        v141 = v26;
        v138 = v26;
        v139 = v26;
        *v136 = v26;
        v137 = v26;
        v27 = IPPortStringToSA(clientAddress, v136);
        if (IsValidSA(v27))
        {
          v28 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
          {
            *v129 = 138412290;
            *&v129[4] = clientAddress;
            _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "receive client address [%@].", v129, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v89 = clientAddress;
              _IDSLogTransport(@"GL", @"IDS", @"receive client address [%@].");
              if (_IDSShouldLog())
              {
                v89 = clientAddress;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"receive client address [%@].");
              }
            }
          }

          sessionID = [v17 sessionID];
          if (sessionID)
          {
            linkEngine = [v17 linkEngine];
            v110 = [(NSMutableDictionary *)self->_sessionsByID objectForKeyedSubscript:sessionID];
            if (linkEngine)
            {
              if (v110)
              {
                v134 = 0u;
                v135 = 0u;
                v132 = 0u;
                v133 = 0u;
                v130 = 0u;
                v131 = 0u;
                memset(v129, 0, sizeof(v129));
                if (buf[1] == 30)
                {
                  v29 = v129;
                }

                else
                {
                  v29 = buf;
                }

                if (buf[1] == 30)
                {
                  v30 = buf;
                }

                else
                {
                  v30 = v129;
                }

                [v110 setServerAddress:v29];
                [v110 setServerAddressV6:v30];
                *&v31 = 0xAAAAAAAAAAAAAAAALL;
                *(&v31 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v128[6] = v31;
                v128[7] = v31;
                v128[4] = v31;
                v128[5] = v31;
                v128[2] = v31;
                v128[3] = v31;
                v128[0] = v31;
                v128[1] = v31;
                serverIpAddressV4 = [reallocateIndication serverIpAddressV4];
                v33 = IPPortStringToSA(serverIpAddressV4, v128);

                if (IsValidSA(v33))
                {
                  v34 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
                  {
                    v35 = SAToIPString(v33);
                    *v120 = 138412290;
                    *&v120[4] = v35;
                    _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "realloc provided explicit ipv4 address: %@", v120, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v90 = SAToIPString(v33);
                      _IDSLogTransport(@"GL", @"IDS", @"realloc provided explicit ipv4 address: %@");

                      if (_IDSShouldLog())
                      {
                        v90 = SAToIPString(v33);
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc provided explicit ipv4 address: %@");
                      }
                    }
                  }

                  [v110 setServerAddress:{v128, v90}];
                }

                *&v36 = 0xAAAAAAAAAAAAAAAALL;
                *(&v36 + 1) = 0xAAAAAAAAAAAAAAAALL;
                v126 = v36;
                v127 = v36;
                v124 = v36;
                v125 = v36;
                v122 = v36;
                v123 = v36;
                *v120 = v36;
                v121 = v36;
                serverIpAddressV6 = [reallocateIndication serverIpAddressV6];
                v38 = IPPortStringToSA(serverIpAddressV6, v120);

                if (IsValidSA(v38))
                {
                  v39 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
                  {
                    v40 = SAToIPString(v38);
                    *v118 = 138412290;
                    v119 = v40;
                    _os_log_impl(&dword_1A7AD9000, v39, OS_LOG_TYPE_DEFAULT, "realloc provided explicit ipv6 address: %@", v118, 0xCu);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      v90 = SAToIPString(v38);
                      _IDSLogTransport(@"GL", @"IDS", @"realloc provided explicit ipv6 address: %@");

                      if (_IDSShouldLog())
                      {
                        v90 = SAToIPString(v38);
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"realloc provided explicit ipv6 address: %@");
                      }
                    }
                  }

                  [v110 setServerAddressV6:{v120, v90}];
                }

                [v110 setHasReceivedReallocIndication:1];
                [v110 setSessionToken:reallocateToken];
                [(IDSGlobalLink *)self _updateLinksForSession:v110];
              }

              else
              {
                v67 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v67, OS_LOG_TYPE_DEFAULT))
                {
                  *v129 = 0;
                  _os_log_impl(&dword_1A7AD9000, v67, OS_LOG_TYPE_DEFAULT, "failed to process QUIC Realloc indication: no session", v129, 2u);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    _IDSLogTransport(@"GL", @"IDS", @"failed to process QUIC Realloc indication: no session");
                    if (_IDSShouldLog())
                    {
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to process QUIC Realloc indication: no session");
                    }
                  }
                }
              }
            }

            else
            {
              local = [v17 local];
              radioAccessTechnology = [local radioAccessTechnology];

              remote = [v17 remote];
              keya = [remote radioAccessTechnology];

              local2 = [v17 local];
              v104 = [local2 mtu];

              remote2 = [v17 remote];
              v102 = [remote2 mtu];

              v109 = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:radioAccessTechnology mtu:v104 index:v11 address:address external:0];
              v103 = [IDSStunCandidate candidateWithType:3 transport:2 radioAccessTechnology:keya mtu:v102 index:0xFFFFFFFFLL address:0 external:buf];
              v105 = [IDSStunCandidatePair candidatePairWithLocalCandidate:v109 remoteCandidate:v103 sessionID:sessionID delegate:self];
              if (address->sa_family == 30 && buf[1] == 2)
              {
                FirstPrefix = IDSNAT64PrefixCacheGetFirstPrefix(self->_nat64PrefixCache, v11);
                if (!FirstPrefix)
                {
                  v87 = OSLogHandleForTransportCategory();
                  if (os_log_type_enabled(v87, OS_LOG_TYPE_DEFAULT))
                  {
                    *v129 = 67109120;
                    *&v129[4] = v11;
                    _os_log_impl(&dword_1A7AD9000, v87, OS_LOG_TYPE_DEFAULT, "failed to get nat64 prefix for realloc (if:%d).", v129, 8u);
                  }

                  if (os_log_shim_legacy_logging_enabled())
                  {
                    if (_IDSShouldLogTransport())
                    {
                      _IDSLogTransport(@"GL", @"IDS", @"failed to get nat64 prefix for realloc (if:%d).");
                      if (_IDSShouldLog())
                      {
                        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get nat64 prefix for realloc (if:%d).");
                      }
                    }
                  }

                  v42 = 0;
                  goto LABEL_143;
                }

                local3 = [v105 local];
                [local3 setPrefix:FirstPrefix];

                [v105 synthesizeNat64WithPrefix];
              }

              key = [v105 candidatePairToken];
              tokenToCandidatePairs = self->_tokenToCandidatePairs;
              if (tokenToCandidatePairs && key && (v64 = CFDictionaryGetValue(tokenToCandidatePairs, key)) != 0)
              {
                v65 = v64;
                v66 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
                {
                  *v129 = 138412290;
                  *&v129[4] = key;
                  _os_log_impl(&dword_1A7AD9000, v66, OS_LOG_TYPE_DEFAULT, "found existing candidate pair for %@.", v129, 0xCu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v91 = key;
                    _IDSLogTransport(@"GL", @"IDS", @"found existing candidate pair for %@.");
                    if (_IDSShouldLog())
                    {
                      v91 = key;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"found existing candidate pair for %@.");
                    }
                  }
                }
              }

              else
              {
                channelNumber = [v17 channelNumber];
                IDSSimpleUInt16List_AddItem(&self->_reallocChannelList, channelNumber);
                v69 = OSLogHandleForTransportCategory();
                if (os_log_type_enabled(v69, OS_LOG_TYPE_DEFAULT))
                {
                  v97 = [reallocateToken length];
                  relaySessionKey = [v17 relaySessionKey];
                  v70 = [relaySessionKey length];
                  channelNumber2 = [v17 channelNumber];
                  *v129 = 138413314;
                  *&v129[4] = v17;
                  *&v129[12] = 2048;
                  *&v129[14] = v97;
                  *&v129[22] = 2048;
                  *&v129[24] = v70;
                  LOWORD(v130) = 1024;
                  *(&v130 + 2) = __rev16(channelNumber);
                  WORD3(v130) = 1024;
                  DWORD2(v130) = channelNumber2;
                  _os_log_impl(&dword_1A7AD9000, v69, OS_LOG_TYPE_DEFAULT, "start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).", v129, 0x2Cu);
                }

                if (os_log_shim_legacy_logging_enabled())
                {
                  if (_IDSShouldLogTransport())
                  {
                    v100 = [reallocateToken length];
                    relaySessionKey2 = [v17 relaySessionKey];
                    v73 = [relaySessionKey2 length];
                    channelNumber3 = [v17 channelNumber];
                    v98 = __rev16(channelNumber);
                    v94 = v73;
                    v95 = v98;
                    v91 = v17;
                    v93 = v100;
                    _IDSLogTransport(@"GL", @"IDS", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");

                    if (_IDSShouldLog())
                    {
                      v101 = [reallocateToken length];
                      relaySessionKey3 = [v17 relaySessionKey];
                      v75 = [relaySessionKey3 length];
                      v95 = v98;
                      channelNumber3 = [v17 channelNumber];
                      v93 = v101;
                      v94 = v75;
                      v91 = v17;
                      _IDSLogV(0, @"IDSFoundation", @"GL", @"start QR realloc for %@ (token %lu bytes, key %lu bytes, channelNumber %04x, candidate pair channel number: %d).");
                    }
                  }
                }

                v76 = v105;
                [v76 setPropertiesWithReallocCandidatePair:v17 reallocToken:reallocateToken];
                remote3 = [v76 remote];
                -[IDSGlobalLink _setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:](self, "_setChannelToCandidatePair:localAddress:remoteAddress:channelNumber:", v76, address, [remote3 external], channelNumber);

                if (!self->_tokenToCandidatePairs)
                {
                  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                  v79 = self->_tokenToCandidatePairs;
                  self->_tokenToCandidatePairs = Mutable;
                }

                v65 = v76;
                if (v65)
                {
                  CFDictionarySetValue(self->_tokenToCandidatePairs, key, v65);
                }

                else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
                {
                  sub_1A7E1498C();
                }
              }

              [v65 setIsRealloc:{1, v91, v93, v94, v95, channelNumber3}];
              -[IDSGlobalLink _sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:](self, "_sendQUICAllocbindRequest:isRealloc:inResponseToNoSessionState:shouldConnectLinkFirst:isPendingInResponseToNoSessionState:", key, 1, 0, 1, [v65 pendingNoSessionStateAllocbind]);
              if (!self->_reallocNewCandidatePairToOldCandidatePair)
              {
                v80 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                reallocNewCandidatePairToOldCandidatePair = self->_reallocNewCandidatePairToOldCandidatePair;
                self->_reallocNewCandidatePairToOldCandidatePair = v80;
              }

              v82 = v17;
              if (v82)
              {
                CFDictionarySetValue(self->_reallocNewCandidatePairToOldCandidatePair, key, v82);
              }

              else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
              {
                sub_1A7E14BA4();
              }
            }

            GLUtilReportAWDStunMessageEventWithType(v21, 0, v17, 0.0);
            v109 = GLUCreateQRStunMessageEventWithType(v21, 0, v17, 0, 0.0);
            if (v109)
            {
              WeakRetained = objc_loadWeakRetained(&self->_delegate);
              v84 = objc_opt_respondsToSelector();

              if (v84)
              {
                v85 = objc_loadWeakRetained(&self->_delegate);
                [v85 link:self didAddQREvent:v109];
              }
            }

            [(IDSGFTMetricsCollector *)self->_metricsCollector hasRealloc];
            v42 = 1;
LABEL_143:

            goto LABEL_145;
          }

          v54 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
          {
            *v129 = 138412290;
            *&v129[4] = tokenCopy;
            _os_log_impl(&dword_1A7AD9000, v54, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@.", v129, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@.");
              }
            }
          }

          GLUtilReportAWDStunMessageEventWithType(v21, 6, v17, 0.0);
          linkEngine = GLUCreateQRStunMessageEventWithType(v21, 6u, v17, 0, 0.0);
          if (linkEngine)
          {
            v55 = objc_loadWeakRetained(&self->_delegate);
            v56 = objc_opt_respondsToSelector();

            if (v56)
            {
              v111 = objc_loadWeakRetained(&self->_delegate);
              [v111 link:self didAddQREvent:linkEngine];
              v42 = 0;

LABEL_145:
              goto LABEL_146;
            }
          }
        }

        else
        {
          v51 = OSLogHandleForIDSCategory();
          if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
          {
            *v129 = 0;
            _os_log_impl(&dword_1A7AD9000, v51, OS_LOG_TYPE_ERROR, "invalid client address.", v129, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            _IDSWarnV();
            _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid client address.");
            _IDSLogTransport(@"Warning", @"IDS", @"invalid client address.");
          }

          GLUtilReportAWDStunMessageEventWithType(v21, 4, v17, 0.0);
          sessionID = GLUCreateQRStunMessageEventWithType(v21, 4u, v17, 0, 0.0);
          if (!sessionID || (v52 = objc_loadWeakRetained(&self->_delegate), v53 = objc_opt_respondsToSelector(), v52, (v53 & 1) == 0))
          {
            v42 = 0;
LABEL_146:

            goto LABEL_147;
          }

          linkEngine = objc_loadWeakRetained(&self->_delegate);
          [linkEngine link:self didAddQREvent:sessionID];
        }

        v42 = 0;
        goto LABEL_145;
      }

      v46 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
      {
        *v136 = 0;
        _os_log_impl(&dword_1A7AD9000, v46, OS_LOG_TYPE_ERROR, "invalid realloc server address.", v136, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        _IDSWarnV();
        _IDSLogV(0, @"IDSFoundation", @"Warning", @"invalid realloc server address.");
        _IDSLogTransport(@"Warning", @"IDS", @"invalid realloc server address.");
      }

      GLUtilReportAWDStunMessageEventWithType(v21, 3, v17, 0.0);
      v47 = GLUCreateQRStunMessageEventWithType(v21, 3u, v17, 0, 0.0);
      if (v47)
      {
        v48 = objc_loadWeakRetained(&self->_delegate);
        v49 = objc_opt_respondsToSelector();

        if (v49)
        {
          v50 = objc_loadWeakRetained(&self->_delegate);
          [v50 link:self didAddQREvent:v47];
        }
      }
    }

    else
    {
      v43 = OSLogHandleForIDSCategory();
      if (os_log_type_enabled(v43, OS_LOG_TYPE_ERROR))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v43, OS_LOG_TYPE_ERROR, "failed to receive realloc token.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        _IDSWarnV();
        _IDSLogV(0, @"IDSFoundation", @"Warning", @"failed to receive realloc token.");
        _IDSLogTransport(@"Warning", @"IDS", @"failed to receive realloc token.");
      }

      GLUtilReportAWDStunMessageEventWithType(v21, 2, v17, 0.0);
      clientAddress = GLUCreateQRStunMessageEventWithType(v21, 2u, v17, 0, 0.0);
      if (!clientAddress || (v44 = objc_loadWeakRetained(&self->_delegate), v45 = objc_opt_respondsToSelector(), v44, (v45 & 1) == 0))
      {
        v42 = 0;
LABEL_148:

        goto LABEL_149;
      }

      serverAddress = objc_loadWeakRetained(&self->_delegate);
      [serverAddress link:self didAddQREvent:clientAddress];
    }

    v42 = 0;
LABEL_147:

    goto LABEL_148;
  }

  v41 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v41, OS_LOG_TYPE_DEFAULT, "_processReallocIndication failed due to invalid reallocateIndication.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"_processReallocIndication failed due to invalid reallocateIndication.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_processReallocIndication failed due to invalid reallocateIndication.");
      }
    }
  }

  v42 = 0;
LABEL_149:

  return v42;
}

- (BOOL)_processQUICDiagnosticIndication:(id)indication candidatePairToken:(id)token arrivalTime:(double)time
{
  v29 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  tokenCopy = token;
  mEMORY[0x1E69A60F0] = [MEMORY[0x1E69A60F0] sharedInstance];
  isInternalInstall = [mEMORY[0x1E69A60F0] isInternalInstall];

  if (isInternalInstall)
  {
    diagnosticIndication = [indicationCopy diagnosticIndication];
    v12 = diagnosticIndication;
    if (diagnosticIndication)
    {
      failureSubtype = [diagnosticIndication failureSubtype];
      failureSubtypeContext = [v12 failureSubtypeContext];
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134218498;
        txnId = [v12 txnId];
        v25 = 2112;
        v26 = failureSubtype;
        v27 = 2112;
        v28 = failureSubtypeContext;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "receive diagnostic indication(%llu) subtype [%@] context [%@}", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v21 = failureSubtype;
          v22 = failureSubtypeContext;
          txnId2 = [v12 txnId];
          _IDSLogTransport(@"GL", @"IDS", @"receive diagnostic indication(%llu) subtype [%@] context [%@}");
          if (_IDSShouldLog())
          {
            txnId3 = [v12 txnId];
            v21 = failureSubtype;
            v22 = failureSubtypeContext;
            txnId2 = txnId3;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"receive diagnostic indication(%llu) subtype [%@] context [%@}");
          }
        }
      }

      v17 = -[IDSGlobalLink _triggerSymptomsWithCandidatePairToken:subType:subTypeContext:duration:](self, "_triggerSymptomsWithCandidatePairToken:subType:subTypeContext:duration:", tokenCopy, failureSubtype, failureSubtypeContext, [v12 packetsRecordDuration]);
    }

    else
    {
      v18 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "_processDiagnosticIndication failed due to invalid diagnosticIndication.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"_processDiagnosticIndication failed due to invalid diagnosticIndication.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"_processDiagnosticIndication failed due to invalid diagnosticIndication.");
          }
        }
      }

      v17 = 0;
    }
  }

  else
  {
    v17 = 1;
  }

  return v17;
}

- (BOOL)_processQUICGoAwayIndication:(id)indication fromDevice:(id)device localIfIndex:(unsigned int)index localAddress:(sockaddr *)address remoteAddress:(sockaddr *)remoteAddress candidatePairToken:(id)token arrivalTime:(double)time
{
  v67 = *MEMORY[0x1E69E9840];
  indicationCopy = indication;
  deviceCopy = device;
  tokenCopy = token;
  Value = 0;
  if (tokenCopy && self->_tokenToCandidatePairs)
  {
    Value = CFDictionaryGetValue(self->_tokenToCandidatePairs, tokenCopy);
  }

  v17 = Value;
  v45 = indicationCopy;
  goAwayIndication = [indicationCopy goAwayIndication];
  v19 = goAwayIndication;
  if (goAwayIndication)
  {
    reasonCode = [goAwayIndication reasonCode];
    reasonString = [v19 reasonString];
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134218754;
      txnId = [v19 txnId];
      v61 = 2112;
      v62 = tokenCopy;
      v63 = 1024;
      v64 = reasonCode;
      v65 = 2112;
      v66 = reasonString;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "receive goaway indication(%llu) for %@, error_code(%u) reason(%@).", buf, 0x26u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        v41 = reasonCode;
        v42 = reasonString;
        txnId2 = [v19 txnId];
        v40 = tokenCopy;
        _IDSLogTransport(@"GL", @"IDS", @"receive goaway indication(%llu) for %@, error_code(%u) reason(%@).");
        if (_IDSShouldLog())
        {
          txnId3 = [v19 txnId];
          v41 = reasonCode;
          v42 = reasonString;
          txnId2 = txnId3;
          v40 = tokenCopy;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"receive goaway indication(%llu) for %@, error_code(%u) reason(%@).");
        }
      }
    }

    serverBlob = [v19 serverBlob];
    if ([serverBlob length])
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = [serverBlob length];
        *buf = 134217984;
        txnId = v24;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "This goaway has QR Server data blob(%luB)", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v39 = [serverBlob length];
          _IDSLogTransport(@"GL", @"IDS", @"This goaway has QR Server data blob(%luB)");
          if (_IDSShouldLog())
          {
            v39 = [serverBlob length];
            _IDSLogV(0, @"IDSFoundation", @"GL", @"This goaway has QR Server data blob(%luB)");
          }
        }
      }

      v25 = MEMORY[0x1E695DF20];
      sessionID = [v17 sessionID];
      v27 = [v25 dictionaryWithObject:serverBlob forKey:sessionID];
      QRServerDataBlob = self->_QRServerDataBlob;
      self->_QRServerDataBlob = v27;
    }

    [(IDSGroupQUICMaterialExchangeProvider *)self->_quicMaterialExchangeProvider invalidate];
    if (self->_useLinkEngine)
    {
      sessionsByID = self->_sessionsByID;
      sessionID2 = [v17 sessionID];
      v31 = [(NSMutableDictionary *)sessionsByID objectForKeyedSubscript:sessionID2];

      if ([v31 wantsToBeConnected])
      {
        [v31 willDisconnect];
        linkEngine = [v31 linkEngine];
        [linkEngine scheduleUpdate];

        v57[0] = MEMORY[0x1E69E9820];
        v57[1] = 3221225472;
        v57[2] = sub_1A7BC85DC;
        v57[3] = &unk_1E77E0818;
        v31 = v31;
        v58 = v31;
        [v31 startSessionGoAwayTimer:5 block:v57];
      }
    }

    else
    {
      [v17 setIsDisconnecting:1];
      v53[0] = MEMORY[0x1E69E9820];
      v53[1] = 3221225472;
      v53[2] = sub_1A7BC86C4;
      v53[3] = &unk_1E77E0E18;
      v54 = tokenCopy;
      v55 = v17;
      selfCopy = self;
      [v55 startSessionGoAwayTimer:5 block:v53];

      v31 = v54;
    }

    _getQRAllocateType = [(IDSGlobalLink *)self _getQRAllocateType];
    v35 = *&remoteAddress->sa_data[2];
    v36 = im_primary_queue();
    block[0] = MEMORY[0x1E69E9820];
    block[1] = 3221225472;
    block[2] = sub_1A7BC88C0;
    block[3] = &unk_1E77E0E88;
    block[4] = self;
    v49 = _getQRAllocateType;
    v48 = v17;
    timeCopy = time;
    v52 = reasonCode;
    v51 = v35;
    dispatch_async(v36, block);

    [(IDSGFTMetricsCollector *)self->_metricsCollector hasGoaway];
  }

  else
  {
    v33 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "_processGoAwayIndication failed due to invalid goAwayIndication.", buf, 2u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"_processGoAwayIndication failed due to invalid goAwayIndication.");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"_processGoAwayIndication failed due to invalid goAwayIndication.");
        }
      }
    }
  }

  return v19 != 0;
}

- (BOOL)_processProtoPacket:(id *)packet fromDeviceUniqueID:(id)d cbuuid:(id)cbuuid arrivalTime:(double)time headerOverhead:(unint64_t)overhead
{
  v103 = *MEMORY[0x1E69E9840];
  dCopy = d;
  cbuuidCopy = cbuuid;
  var31 = packet->var31;
  if (packet->var35 && packet->var34 != 7)
  {
    p_super = 0;
LABEL_9:
    var34 = packet->var34;
    v13 = @"error_response";
    goto LABEL_10;
  }

  v13 = [MEMORY[0x1E695DEF0] dataWithBytesNoCopy:packet->var0 length:packet->var2 freeWhenDone:0];
  if (!v13)
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17B00();
    }

    goto LABEL_43;
  }

  v14 = [[IDSQRProtoMessage alloc] initWithData:v13];
  if (!v14)
  {
    p_super = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(p_super, OS_LOG_TYPE_ERROR))
    {
      sub_1A7E17A64(v13, p_super);
    }

    goto LABEL_43;
  }

  p_super = &v14->super;

  if (packet->var35)
  {
    goto LABEL_9;
  }

  messageType = [p_super messageType];
  var34 = messageType;
  if (messageType >= 0x29)
  {
    v13 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", messageType];
  }

  else
  {
    v13 = off_1E77E1408[messageType];
  }

  [p_super setTransactionID:var31];
LABEL_10:
  v18 = +[IDSFoundationLog GlobalLink];
  if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
  {
    var35 = packet->var35;
    *buf = 138413314;
    *&buf[4] = v13;
    *&buf[12] = 1024;
    *&buf[14] = var34;
    *&buf[18] = 2048;
    *&buf[20] = var31;
    *&buf[28] = 1024;
    *&buf[30] = var35;
    *&buf[34] = 2112;
    *&buf[36] = p_super;
    _os_log_impl(&dword_1A7AD9000, v18, OS_LOG_TYPE_DEFAULT, "received %@[%d](%llu) error %u proto message %@", buf, 0x2Cu);
  }

  [(IDSGlobalLink *)self _startTimeForProtoRequest:var31];
  v21 = v20;
  [p_super setStartTime:?];
  v22 = [(IDSGlobalLink *)self _tokenForProtoRequest:var31];
  if (v22)
  {
    goto LABEL_17;
  }

  if (var34 <= 0x24 && ((1 << var34) & 0x1084027218) != 0)
  {
    v23 = packet->var32;
    if (v23)
    {
      v24 = v23;
      v22 = tokenForStunCandidatePair(&packet->var18, &packet->var19, v23);

LABEL_17:
      tokenToCandidatePairs = self->_tokenToCandidatePairs;
      if (tokenToCandidatePairs && v22 && (v26 = CFDictionaryGetValue(tokenToCandidatePairs, v22)) != 0)
      {
        v27 = v26;
        if ([v26 isActive])
        {
          v28 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
          if (v28)
          {
            v28[39] = time;
          }
        }

        else
        {
          [v27 setLastIncomingPacketTime:time];
        }

        -[IDSGlobalLink didReceiveProtobufPacketForLinkID:](self, "didReceiveProtobufPacketForLinkID:", [v27 linkID]);
        switch(var34)
        {
          case 1u:
          case 5u:
          case 7u:
          case 0xAu:
          case 0xFu:
          case 0x12u:
          case 0x14u:
          case 0x16u:
            overhead = [v27 processQUICErrorResponse:p_super packetBuffer:packet startTime:overhead headerOverhead:v21];
            goto LABEL_87;
          case 2u:
            overhead = [(IDSGlobalLink *)self _processNWLinkAllocbindResponse:p_super fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:v22 arrivalTime:time];
            goto LABEL_87;
          case 3u:
            v30 = [(IDSGlobalLink *)self _processQUICDiagnosticIndication:p_super candidatePairToken:v22 arrivalTime:time];

            goto LABEL_92;
          case 4u:
            v30 = [(IDSGlobalLink *)self _processQUICGoAwayIndication:p_super fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remoteAddress:&packet->var19 candidatePairToken:v22 arrivalTime:time];

            goto LABEL_92;
          case 6u:
            overhead = [v27 processQUICInfoResponse:p_super receivedBytes:packet->var2 + overhead];
            goto LABEL_87;
          case 8u:
            overhead = [v27 processQUICParticipantUpdateResponse:p_super];
            goto LABEL_87;
          case 9u:
            v30 = [v27 processQUICParticipantUpdateIndication:p_super];

            goto LABEL_92;
          case 0xBu:
            overhead = [v27 processQUICPluginRegistrationResponse:p_super];
            goto LABEL_87;
          case 0xCu:
            v30 = [v27 processQUICPluginControlIndication:p_super];

            goto LABEL_92;
          case 0xDu:
            v30 = [v27 processQUICErrorIndication:p_super];

            goto LABEL_92;
          case 0xEu:
            v34 = *&packet->var18.__ss_pad2[64];
            v99 = *&packet->var18.__ss_pad2[48];
            v100 = v34;
            v35 = *&packet->var18.__ss_pad2[96];
            v101 = *&packet->var18.__ss_pad2[80];
            v102 = v35;
            v36 = *packet->var18.__ss_pad2;
            *buf = *&packet->var18.ss_len;
            *&buf[16] = v36;
            v37 = *&packet->var18.__ss_pad2[32];
            *&buf[32] = *&packet->var18.__ss_pad2[16];
            v98 = v37;
            v38 = *&packet->var19.__ss_pad2[64];
            v39 = *&packet->var19.__ss_pad2[80];
            v93 = *&packet->var19.__ss_pad2[48];
            v94 = v38;
            v40 = *&packet->var19.__ss_pad2[96];
            v95 = v39;
            v96 = v40;
            v41 = *packet->var19.__ss_pad2;
            v89 = *&packet->var19.ss_len;
            v90 = v41;
            v42 = *&packet->var19.__ss_pad2[32];
            v91 = *&packet->var19.__ss_pad2[16];
            v92 = v42;
            var17 = packet->var17;
            aBlock[0] = MEMORY[0x1E69E9820];
            aBlock[1] = 3221225472;
            aBlock[2] = sub_1A7BC96D4;
            aBlock[3] = &unk_1E77E0EB0;
            aBlock[4] = self;
            v68 = p_super;
            v69 = dCopy;
            v88 = var17;
            v75 = v99;
            v76 = v100;
            v77 = v101;
            v78 = v102;
            v71 = *buf;
            v72 = *&buf[16];
            v73 = *&buf[32];
            v74 = v98;
            v85 = v95;
            v86 = v96;
            v83 = v93;
            v84 = v94;
            v81 = v91;
            v82 = v92;
            v79 = v89;
            v80 = v90;
            v44 = v22;
            v70 = v44;
            timeCopy = time;
            v45 = _Block_copy(aBlock);
            state = [v27 state];
            if (state > 3)
            {
              v45[2](v45);
            }

            else
            {
              v47 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
              {
                v48 = _Block_copy(v45);
                v49 = (&_IDSStunCandidatePairStateStrings)[state];
                *v61 = 134218498;
                v62 = v48;
                v63 = 2112;
                v64 = v44;
                v65 = 2080;
                v66 = v49;
                _os_log_impl(&dword_1A7AD9000, v47, OS_LOG_TYPE_DEFAULT, "delay processing realloc block %p for %@, state [%s].", v61, 0x20u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  v50 = _Block_copy(v45);
                  _IDSLogTransport(@"GL", @"IDS", @"delay processing realloc block %p for %@, state [%s].");

                  if (_IDSShouldLog())
                  {
                    v51 = _Block_copy(v45);
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"delay processing realloc block %p for %@, state [%s].");
                  }
                }
              }

              if (!self->_tokenToReallocBlocks)
              {
                Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
                tokenToReallocBlocks = self->_tokenToReallocBlocks;
                self->_tokenToReallocBlocks = Mutable;
              }

              v54 = _Block_copy(v45);
              if (v54)
              {
                CFDictionarySetValue(self->_tokenToReallocBlocks, v44, v54);
              }

              else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
              {
                sub_1A7E14C48();
              }
            }

            v30 = 1;
            goto LABEL_92;
          case 0x10u:
            overhead = [v27 processQUICSessionInfoResponse:p_super receivedBytes:packet->var2 + overhead isLightweightParticipant:self->_isLightweightParticipant];
            goto LABEL_87;
          case 0x11u:
            v30 = [v27 processQUICSessionInfoIndication:p_super arrivalTime:self->_isLightweightParticipant isLightweightParticipant:time];

            goto LABEL_92;
          case 0x13u:
            overhead = [v27 processQUICStatsResponse:p_super arrivalTime:time];
            goto LABEL_87;
          case 0x15u:
            overhead = [v27 processQUICTestResponse:p_super arrivalTime:time];
            goto LABEL_87;
          case 0x17u:
            overhead = [(IDSGlobalLink *)self _processQUICUnallocbindResponse:p_super fromDevice:dCopy localIfIndex:packet->var17 localAddress:&packet->var18 remmoteAddress:&packet->var19 candidatePairToken:v22 arrivalTime:time];
            goto LABEL_87;
          case 0x19u:
            overhead = [v27 processQUICPutMaterialResponse:p_super];
            goto LABEL_87;
          case 0x1Au:
            v30 = [v27 processQUICPutMaterialIndication:p_super];

            goto LABEL_92;
          case 0x1Cu:
            overhead = [v27 processQUICGetMaterialResponse:p_super];
            goto LABEL_87;
          case 0x1Du:
          case 0x20u:
            overhead = [(IDSGlobalLink *)self _processReliableUnicastRegistrationErrorResponse:p_super packetBuffer:packet startTime:v27 candidatePair:v21];
            goto LABEL_87;
          case 0x1Eu:
            overhead = [(IDSGlobalLink *)self _processRegisterResponse:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x1Fu:
            overhead = [(IDSGlobalLink *)self _processRegisterIndication:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x21u:
            overhead = [(IDSGlobalLink *)self _processRegisterAckResponse:p_super candidatePairToken:v22];
            goto LABEL_87;
          case 0x26u:
            overhead = [v27 processQUICCallModeUpdateResponse:p_super];
            goto LABEL_87;
          case 0x28u:
            overhead = [v27 processQUICChannelConfigResponse:p_super];
LABEL_87:
            v30 = overhead;
            break;
          default:
            v58 = +[IDSFoundationLog GlobalLink];
            if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
            {
              sub_1A7E179F4();
            }

            v30 = 0;
            break;
        }

        v55 = packet->var35;
        if (v55)
        {
          v56 = v55;
        }

        else
        {
          v56 = 200;
        }

        [(IDSGlobalLink *)self _removeProtoRequest:var31 status:v56];
      }

      else
      {
        v29 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 138412290;
          *&buf[4] = v22;
          _os_log_impl(&dword_1A7AD9000, v29, OS_LOG_TYPE_DEFAULT, "failed to find candidate pair for incoming proto message, candidagePairToken = %@", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to find candidate pair for incoming proto message, candidagePairToken = %@");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find candidate pair for incoming proto message, candidagePairToken = %@");
            }
          }
        }

        v30 = 0;
      }

LABEL_92:

      goto LABEL_93;
    }

    v32 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      *&buf[4] = v13;
      _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for %@", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for %@");
        }
      }
    }

LABEL_43:
    v30 = 0;
    goto LABEL_93;
  }

  v33 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    *&buf[4] = var31;
    *&buf[12] = 2112;
    *&buf[14] = v13;
    _os_log_impl(&dword_1A7AD9000, v33, OS_LOG_TYPE_DEFAULT, "no matching request with QUIC transactionID %llu for %@ proto message, ignore.", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"no matching request with QUIC transactionID %llu for %@ proto message, ignore.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"no matching request with QUIC transactionID %llu for %@ proto message, ignore.");
      }
    }
  }

  v30 = 1;
LABEL_93:

  return v30;
}

- (void)_updateCandidatePair:(id)pair newLocalPort:(unsigned __int16)port
{
  portCopy = port;
  pairCopy = pair;
  tokenToCandidatePairs = self->_tokenToCandidatePairs;
  candidatePairToken = [pairCopy candidatePairToken];
  [(NSMutableDictionary *)tokenToCandidatePairs removeObjectForKey:candidatePairToken];

  local = [pairCopy local];
  [local setLocalPort:portCopy];

  if (!self->_tokenToCandidatePairs)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v11 = self->_tokenToCandidatePairs;
    self->_tokenToCandidatePairs = Mutable;
  }

  v12 = pairCopy;
  v13 = v12;
  if (v12)
  {
    v14 = self->_tokenToCandidatePairs;
    candidatePairToken2 = [v12 candidatePairToken];
    CFDictionarySetValue(v14, candidatePairToken2, v13);
  }

  else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
  {
    sub_1A7E17B3C();
  }
}

- (void)_saveProtoRequest:(id)request token:(id)token path:(id)path
{
  v42 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  tokenCopy = token;
  pathCopy = path;
  transactionID = [requestCopy transactionID];
  [requestCopy startTime];
  v13 = v12;
  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218498;
    v37 = transactionID;
    v38 = 2048;
    v39 = v13;
    v40 = 2112;
    v41 = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "_saveProtoRequest %llu %.3f for %@", buf, 0x20u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      v35 = tokenCopy;
      v34 = v13;
      v33 = transactionID;
      _IDSLogTransport(@"GL", @"IDS", @"_saveProtoRequest %llu %.3f for %@");
      if (_IDSShouldLog())
      {
        v35 = tokenCopy;
        v34 = v13;
        v33 = transactionID;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_saveProtoRequest %llu %.3f for %@");
      }
    }
  }

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  if (!transactionIDToRequestMetadata)
  {
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    v17 = self->_transactionIDToRequestMetadata;
    self->_transactionIDToRequestMetadata = Mutable;

    transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  }

  v18 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{transactionID, v33, *&v34, v35}];
  v19 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v18];

  if (!v19)
  {
    metricsCollector = self->_metricsCollector;
    messageType = [requestCopy messageType];
    if (messageType >= 0x29)
    {
      v22 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(unknown: %i)", messageType];
    }

    else
    {
      v22 = off_1E77E1408[messageType];
    }

    v23 = [(IDSGFTMetricsCollector *)metricsCollector request:v22];

    v24 = [(NSMutableDictionary *)self->_tokenToCandidatePairs objectForKeyedSubscript:tokenCopy];
    v25 = v24;
    if (v24)
    {
      local = [v24 local];
      radioAccessTechnology = [local radioAccessTechnology];

      linkID = [v25 linkID];
    }

    else
    {
      linkID = 0;
      radioAccessTechnology = 10;
    }

    v29 = [[IDSGlobalLinkRequestMetadata alloc] initWithStartTime:pathCopy path:tokenCopy token:linkID linkID:radioAccessTechnology localRAT:v23 metricsRequest:v13];
    v19 = v29;
    if (v29)
    {
      v30 = self->_transactionIDToRequestMetadata;
      v31 = MEMORY[0x1E696AD98];
      v32 = v29;
      CFDictionarySetValue(v30, [v31 numberWithUnsignedLongLong:transactionID], v32);
    }
  }
}

- (void)_removeProtoRequest:(unint64_t)request status:(unsigned int)status
{
  v4 = *&status;
  v48 = *MEMORY[0x1E69E9840];
  v7 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    requestCopy = request;
    _os_log_impl(&dword_1A7AD9000, v7, OS_LOG_TYPE_DEFAULT, "_removeProtoRequest %llu", buf, 0xCu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      requestCopy3 = request;
      _IDSLogTransport(@"GL", @"IDS", @"_removeProtoRequest %llu");
      if (_IDSShouldLog())
      {
        requestCopy3 = request;
        _IDSLogV(0, @"IDSFoundation", @"GL", @"_removeProtoRequest %llu");
      }
    }
  }

  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v9 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{request, requestCopy3}];
  v10 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v9];

  if (v10)
  {
    metricsRequest = [v10 metricsRequest];
    [metricsRequest receivedResponse:v4];

    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      path = [v10 path];
      v14 = ids_monotonic_time();
      [v10 startTime];
      v16 = v15;
      linkID = [v10 linkID];
      v18 = IDSRadioAccessTechnologyToString([v10 localRAT]);
      *buf = 138413570;
      requestCopy = path;
      v38 = 2048;
      requestCopy4 = request;
      v40 = 1024;
      v41 = v4;
      v42 = 2048;
      v43 = v14 - v16;
      v44 = 1024;
      v45 = linkID;
      v46 = 2080;
      v47 = v18;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)", buf, 0x36u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        path2 = [v10 path];
        v20 = ids_monotonic_time();
        [v10 startTime];
        v22 = v21;
        linkID2 = [v10 linkID];
        v35 = IDSRadioAccessTechnologyToString([v10 localRAT]);
        v33 = v20 - v22;
        requestCopy6 = request;
        v32 = v4;
        v30 = path2;
        _IDSLogTransport(@"GL", @"IDS", @"%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)");

        if (_IDSShouldLog())
        {
          path3 = [v10 path];
          v24 = ids_monotonic_time();
          [v10 startTime];
          v26 = v25;
          linkID2 = [v10 linkID];
          v35 = IDSRadioAccessTechnologyToString([v10 localRAT]);
          v33 = v24 - v26;
          requestCopy6 = request;
          v32 = v4;
          v30 = path3;
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%@(%llu) status=%d took %.6fs (linkID: %d, RAT: %s)");
        }
      }
    }

    v27 = self->_transactionIDToRequestMetadata;
    v28 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{request, v30, requestCopy6, v32, *&v33, linkID2, v35}];
    [(NSMutableDictionary *)v27 removeObjectForKey:v28];
  }
}

- (double)_startTimeForProtoRequest:(unint64_t)request
{
  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:request];
  v5 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v4];

  [v5 startTime];
  v7 = v6;

  return v7;
}

- (id)_tokenForProtoRequest:(unint64_t)request
{
  transactionIDToRequestMetadata = self->_transactionIDToRequestMetadata;
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:request];
  v5 = [(NSMutableDictionary *)transactionIDToRequestMetadata objectForKeyedSubscript:v4];

  token = [v5 token];

  return token;
}

- (int64_t)_sendProtoMessage:(id)message candidatePair:(id)pair
{
  v55 = *MEMORY[0x1E69E9840];
  messageCopy = message;
  pairCopy = pair;
  local = [pairCopy local];
  index = [local index];

  local2 = [pairCopy local];
  address = [local2 address];

  remote = [pairCopy remote];
  external = [remote external];

  local3 = [pairCopy local];
  transport = [local3 transport];

  glLinkProtocol = [pairCopy glLinkProtocol];
  candidatePairToken = [pairCopy candidatePairToken];
  __buf = 0xAAAAAAAAAAAAAAAALL;
  arc4random_buf(&__buf, 8uLL);
  [messageCopy setTransactionID:__buf];
  linkID = [pairCopy linkID];
  if (linkID)
  {
    v15 = linkID;
  }

  else
  {
    v15 = -1;
  }

  if ([pairCopy isVirtualRelayStunCandidatePair])
  {
    delegatedLinkID = [pairCopy delegatedLinkID];
  }

  else
  {
    delegatedLinkID = -1;
  }

  *&v17 = 0xAAAAAAAAAAAAAAAALL;
  *(&v17 + 1) = 0xAAAAAAAAAAAAAAAALL;
  __str[6] = v17;
  __str[7] = v17;
  __str[4] = v17;
  __str[5] = v17;
  __str[2] = v17;
  __str[3] = v17;
  __str[0] = v17;
  __str[1] = v17;
  v52 = v17;
  v53 = v17;
  v50 = v17;
  v51 = v17;
  v48 = v17;
  v49 = v17;
  *v46 = v17;
  v47 = v17;
  SAToIPPortString(__str, 0x80uLL, address);
  SAToIPPortString(v46, 0x80uLL, external);
  data = [messageCopy data];
  v19 = [data length];
  v20 = _IDSLinkPacketBufferCreateWithSize("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 14537, [data length]);
  [data getBytes:*v20 length:v19];
  v20[2] = v19;
  *(v20 + 44) = 1;
  v20[157] = __buf;
  if ([messageCopy messageType] == 1 && (objc_msgSend(pairCopy, "isRealloc") & 1) != 0)
  {
    messageType = 14;
  }

  else
  {
    messageType = [messageCopy messageType];
  }

  *(v20 + 320) = messageType;
  sessionID = [pairCopy sessionID];
  v23 = v20[158];
  v20[158] = sessionID;

  *(v20 + 12) = index;
  memcpy(v20 + 7, address, *address);
  memcpy(v20 + 23, external, *external);
  v24 = [(IDSGlobalLink *)self _sendPacketBuffer:v20 stunTransport:transport glLinkProtocol:glLinkProtocol token:candidatePairToken linkID:v15 delegatedLinkID:delegatedLinkID];
  if (v24 < 1)
  {
    v28 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = self->_idsSessionID;
      *buf = 138413058;
      v37 = messageCopy;
      v38 = 2112;
      v39 = idsSessionID;
      v40 = 2080;
      v41 = __str;
      v42 = 2080;
      v43 = v46;
      _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "Failed to send proto message %@ for IDSSessionID: %@ and %s-%s", buf, 0x2Au);
    }
  }

  else
  {
    v25 = +[IDSNWLink descriptionForMessageType:](IDSNWLink, "descriptionForMessageType:", [messageCopy messageType]);
    [(IDSGlobalLink *)self _saveProtoRequest:messageCopy token:candidatePairToken path:v25];

    v26 = OSLogHandleForIDSCategory();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      v27 = self->_idsSessionID;
      *buf = 138413314;
      v37 = messageCopy;
      v38 = 2048;
      v39 = __buf;
      v40 = 2112;
      v41 = v27;
      v42 = 2080;
      v43 = __str;
      v44 = 2080;
      v45 = v46;
      _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "send proto message %@ (%llu) for IDSSessionID: %@ and %s-%s.", buf, 0x34u);
    }

    if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
    {
      _IDSLogV(0, @"IDSFoundation", @"GL", @"send proto message %@ (%llu) for IDSSessionID: %@ and %s-%s.");
    }
  }

  return v24;
}

- (void)_sendQUICAllocbindRequest:(id)request isRealloc:(BOOL)realloc inResponseToNoSessionState:(BOOL)state shouldConnectLinkFirst:(BOOL)first isPendingInResponseToNoSessionState:(BOOL)sessionState
{
  sessionStateCopy = sessionState;
  firstCopy = first;
  stateCopy = state;
  reallocCopy = realloc;
  v212 = *MEMORY[0x1E69E9840];
  key = request;
  if (key)
  {
    if (self->_state >= 5 && !stateCopy)
    {
      v12 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = _IDSLinkStateStrings[self->_state];
        *buf = 138412546;
        *v203 = key;
        *&v203[8] = 2080;
        *&v203[10] = v13;
        _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip allocbind request for %@, GL state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request for %@, GL state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request for %@, GL state [%s].");
          }
        }
      }

      goto LABEL_35;
    }

    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v171 = reallocCopy, v172 = self, v16 = CFDictionaryGetValue(tokenToCandidatePairs, key), v17 = reallocCopy, !v16))
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "send allocbind request failed due to invalid candidate pair.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send allocbind request failed due to invalid candidate pair.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send allocbind request failed due to invalid candidate pair.");
          }
        }
      }

      v18 = 0;
      goto LABEL_34;
    }

    v18 = v16;
    if ([v16 isSharedQRSession] && !self->_sharedSessionHasJoined)
    {
      v24 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v24, OS_LOG_TYPE_DEFAULT, "skip allocbind request, session is not yet joined!", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip allocbind request, session is not yet joined!");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip allocbind request, session is not yet joined!");
          }
        }
      }

      goto LABEL_34;
    }

    if (firstCopy)
    {
      v196[1] = MEMORY[0x1E69E9820];
      v196[2] = 3221225472;
      v196[3] = sub_1A7BCC1A4;
      v196[4] = &unk_1E77E1310;
      v196[5] = self;
      v197 = v18;
      v198 = reallocCopy;
      v199 = stateCopy;
      v200 = sessionStateCopy;
      v18 = v197;
      [IDSGlobalLink _connectNWLink:"_connectNWLink:disconnectAfterUse:connectedHandler:" disconnectAfterUse:? connectedHandler:?];
      if (([v197 isSelfQRSession] & 1) == 0)
      {
        if ([v197 isSharedQRSession])
        {
          v19 = 0;
        }

        else
        {
          v19 = 2;
        }

        [(IDSGlobalLink *)self _startAllocbindFailoverTimerOnCandidatePair:v197 delay:v19];
      }

      goto LABEL_34;
    }

    state = [v18 state];
    pendingRealloc = [v18 pendingRealloc];
    if (state == 2)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "in failed state, send allocbind request ignored", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"in failed state, send allocbind request ignored");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"in failed state, send allocbind request ignored");
          }
        }
      }

      goto LABEL_34;
    }

    v25 = pendingRealloc;
    if (state < 3)
    {
      reallocCopy = 1;
    }

    if ((sessionStateCopy & ~v17 & stateCopy & 1) != 0 || (v17 & (pendingRealloc ^ 1) & 1) != 0 || !reallocCopy)
    {
      v32 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
      {
        v33 = @"allocbind";
        v34 = (&_IDSStunCandidatePairStateStrings)[state];
        if (v17)
        {
          v33 = @"realloc";
        }

        *buf = 138413826;
        *v203 = v33;
        v35 = @"YES";
        *&v203[8] = 2112;
        *&v203[10] = key;
        if (v25)
        {
          v36 = @"YES";
        }

        else
        {
          v36 = @"NO";
        }

        *&v203[18] = 2080;
        *&v203[20] = v34;
        if (reallocCopy)
        {
          v37 = @"NO";
        }

        else
        {
          v37 = @"YES";
        }

        v204 = 2112;
        if (stateCopy)
        {
          v38 = @"YES";
        }

        else
        {
          v38 = @"NO";
        }

        v205 = v36;
        if (!sessionStateCopy)
        {
          v35 = @"NO";
        }

        v206 = 2112;
        v207 = v37;
        v208 = 2112;
        v209 = v38;
        v210 = 2112;
        v211 = v35;
        _os_log_impl(&dword_1A7AD9000, v32, OS_LOG_TYPE_DEFAULT, "skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@", buf, 0x48u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip %@ request for %@, state [%s], pendingRealloc %@, isAllocbindInProcess: %@, inResponseToNoSessionState: %@, isPendingInResponseToNoSessionState: %@");
          }
        }
      }

      goto LABEL_34;
    }

    v168 = state;
    v167 = stunMessageTypeFromProtoMessageType(1, v17);
    v169 = v18;
    theDict = objc_alloc_init(MEMORY[0x1E695DF90]);
    sessionID = [v18 sessionID];
    allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
    HasCandidatePairForSameSharedSession = GLUtilHasCandidatePairForSameSharedSession(sessionID, allValues);

    if (HasCandidatePairForSameSharedSession)
    {
      v29 = 16;
    }

    else
    {
      v29 = 0;
    }

    if (stateCopy)
    {
      v30 = v29 | 0x20;
    }

    else
    {
      v30 = v29;
    }

    v31 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:v30];
    if (v31)
    {
      CFDictionarySetValue(theDict, @"gl-option-additional-binding", v31);
    }

    else
    {
      v39 = MEMORY[0x1E69E9C10];
      v40 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v39, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E14CC4();
      }
    }

    if ([(IDSGlobalLink *)v172 _shouldUseQRTLE])
    {
      local = [v18 local];
      if ([local isCellularStunCandidate])
      {
        allowTLEOverCellular = v172->_allowTLEOverCellular;

        if (!allowTLEOverCellular)
        {
          goto LABEL_101;
        }
      }

      else
      {
      }

      v43 = objc_alloc_init(IDSQUICConnectionIDs);
      v44 = [(NSMutableSet *)v172->_usedLocalConnectionIDs copy];
      v196[0] = v44;
      v45 = [(IDSQUICConnectionIDs *)v43 generateLocalIDs:v196];
      v46 = v196[0];

      [(NSMutableSet *)v172->_usedLocalConnectionIDs addObjectsFromArray:v45];
      [v18 setQUICConnectionIDs:v43];
      localAVCConnectionIDData = [(IDSQUICConnectionIDs *)v43 localAVCConnectionIDData];
      if (localAVCConnectionIDData)
      {
        CFDictionarySetValue(theDict, @"gl-option-qr-connection-id-avc-key", localAVCConnectionIDData);
      }

      else
      {
        v48 = MEMORY[0x1E69E9C10];
        v49 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17BD4();
        }
      }

      localIDSConnectionIDData = [(IDSQUICConnectionIDs *)v43 localIDSConnectionIDData];
      if (localIDSConnectionIDData)
      {
        CFDictionarySetValue(theDict, @"gl-option-qr-connection-id-ids-key", localIDSConnectionIDData);
      }

      else
      {
        v51 = MEMORY[0x1E69E9C10];
        v52 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17C5C();
        }
      }
    }

LABEL_101:
    v53 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isShortMKIEnabled];
    if (v53)
    {
      CFDictionarySetValue(theDict, @"gs-shortmki-enabled-key", v53);
    }

    else
    {
      v54 = MEMORY[0x1E69E9C10];
      v55 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v54, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17CE4();
      }
    }

    v56 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isTLEEnabled];
    if (v56)
    {
      CFDictionarySetValue(theDict, @"gs-tle-enabled-key", v56);
    }

    else
    {
      v57 = MEMORY[0x1E69E9C10];
      v58 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17D6C();
      }
    }

    v59 = [MEMORY[0x1E696AD98] numberWithBool:v172->_isPartialTLEUPlusOneEnabled];
    if (v59)
    {
      CFDictionarySetValue(theDict, @"gs-enable-qpod-vr", v59);
    }

    else
    {
      v60 = MEMORY[0x1E69E9C10];
      v61 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17DF4();
      }
    }

    v62 = v172;
    if (v172->_clientType == 6)
    {
      v63 = objc_alloc_init(IDSQRProtoCallModeUpdateInfo);
      [(IDSQRProtoCallModeUpdateInfo *)v63 setModeGenCounter:v172->_callModeUpdateGenerationCounter];
      if (v172->_isUPlusOneSession)
      {
        v64 = 1;
      }

      else
      {
        v64 = 2;
      }

      [(IDSQRProtoCallModeUpdateInfo *)v63 setFacetimeMode:v64];
      v65 = v63;
      if (v65)
      {
        CFDictionarySetValue(theDict, @"gs-started-as-u-plus-one-key", v65);
      }

      else
      {
        v66 = MEMORY[0x1E69E9C10];
        v67 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v66, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17E7C();
        }
      }

      if (_os_feature_enabled_impl())
      {
        CFDictionarySetValue(theDict, @"gs-dl-participantid-removal-supported-key", MEMORY[0x1E695E118]);
      }

      v62 = v172;
    }

    pluginNameToPluginOptionsDict = v62->_pluginNameToPluginOptionsDict;
    if (pluginNameToPluginOptionsDict && [(NSMutableDictionary *)pluginNameToPluginOptionsDict count])
    {
      v69 = objc_alloc_init(MEMORY[0x1E695DF70]);
      v70 = v172->_pluginNameToPluginOptionsDict;
      v194[0] = MEMORY[0x1E69E9820];
      v194[1] = 3221225472;
      v194[2] = sub_1A7BCC20C;
      v194[3] = &unk_1E77E1338;
      v71 = v69;
      v195 = v71;
      [(NSMutableDictionary *)v70 enumerateKeysAndObjectsUsingBlock:v194];
      v72 = v71;
      if (v72)
      {
        CFDictionarySetValue(theDict, @"gl-option-fast-plugin-request-key", v72);
      }

      else
      {
        v73 = MEMORY[0x1E69E9C10];
        v74 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E17F04();
        }
      }
    }

    v75 = [MEMORY[0x1E696AD98] numberWithBool:v172->_shouldOverrideServerTestOptionTLEDisabled];
    if (v75)
    {
      CFDictionarySetValue(theDict, @"gl-option-should-override-server-test-option-tle-disabled", v75);
    }

    else
    {
      v76 = MEMORY[0x1E69E9C10];
      v77 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v76, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E17F8C();
      }
    }

    v78 = [MEMORY[0x1E696AD98] numberWithBool:v172->_serverTestOptionTLEDisabled];
    if (v78)
    {
      CFDictionarySetValue(theDict, @"gl-option-server-test-option-tle-disabled", v78);
    }

    else
    {
      v79 = MEMORY[0x1E69E9C10];
      v80 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v79, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18014();
      }
    }

    sessionID2 = [v169 sessionID];
    if ([(NSDictionary *)v172->_QRServerDataBlob count])
    {
      v82 = [(NSDictionary *)v172->_QRServerDataBlob objectForKeyedSubscript:sessionID2];
      v83 = v82 == 0;

      if (v83)
      {
        allKeys = [(NSDictionary *)v172->_QRServerDataBlob allKeys];
        firstObject = [allKeys firstObject];

        allValues2 = [(NSDictionary *)v172->_QRServerDataBlob allValues];
        firstObject2 = [allValues2 firstObject];

        QRServerDataBlob = v172->_QRServerDataBlob;
        v172->_QRServerDataBlob = 0;

        v89 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v89, OS_LOG_TYPE_DEFAULT))
        {
          v90 = [firstObject2 length];
          *buf = 67109634;
          *v203 = v90;
          *&v203[4] = 2112;
          *&v203[6] = firstObject;
          *&v203[14] = 2112;
          *&v203[16] = sessionID2;
          _os_log_impl(&dword_1A7AD9000, v89, OS_LOG_TYPE_DEFAULT, "Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@", buf, 0x1Cu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v165 = firstObject;
            v166 = sessionID2;
            v162 = [firstObject2 length];
            _IDSLogTransport(@"GL", @"IDS", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
            if (_IDSShouldLog())
            {
              v91 = [firstObject2 length];
              v165 = firstObject;
              v166 = sessionID2;
              v162 = v91;
              _IDSLogV(0, @"IDSFoundation", @"GL", @"Sending QR Server data blob(%dB) from previous goaway for %@ in allocbind for %@");
            }
          }
        }

        v92 = firstObject2;
        if (v92)
        {
          CFDictionarySetValue(theDict, @"gl-option-qr-server-data-blob", v92);
        }

        else
        {
          v93 = MEMORY[0x1E69E9C10];
          v94 = MEMORY[0x1E69E9C10];
          if (os_log_type_enabled(v93, OS_LOG_TYPE_ERROR))
          {
            sub_1A7E1809C();
          }
        }
      }
    }

    v95 = v172;
    if (v172->_idsContextBlob)
    {
      v96 = [(IDSGlobalLink *)v172 _createIDSContextBlobMaterialProto:?];
      if (v96)
      {
        CFDictionarySetValue(theDict, @"gl-option-ids-context-blob-key", v96);
      }

      else
      {
        v97 = MEMORY[0x1E69E9C10];
        v98 = MEMORY[0x1E69E9C10];
        if (os_log_type_enabled(v97, OS_LOG_TYPE_ERROR))
        {
          sub_1A7E18124();
        }
      }

      v95 = v172;
    }

    if (v95->_state != 4)
    {
      CFDictionarySetValue(theDict, @"gl-option-ids-context-reason-key", &unk_1F1B200F0);
      v95 = v172;
    }

    v99 = v95->_qrSessionExperiments;
    if (v99)
    {
      CFDictionarySetValue(theDict, @"gl-option-qr-session-experiments", v99);
    }

    else
    {
      v100 = MEMORY[0x1E69E9C10];
      v101 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v100, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E181AC();
      }
    }

    v102 = v172;
    quicMaterialExchangeProvider = v172->_quicMaterialExchangeProvider;
    if (quicMaterialExchangeProvider)
    {
      takeAllCurrentMaterials = [(IDSGroupQUICMaterialExchangeProvider *)quicMaterialExchangeProvider takeAllCurrentMaterials];
      v105 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v105, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v203 = takeAllCurrentMaterials;
        _os_log_impl(&dword_1A7AD9000, v105, OS_LOG_TYPE_DEFAULT, "IDSGlobalLinkOptionMaterialsKey: %@", buf, 0xCu);
      }

      [(__CFDictionary *)theDict setObject:takeAllCurrentMaterials forKeyedSubscript:@"gl-option-materials-key"];
      if (v172->_isAutoDisconnectSupportedForGFTService)
      {
        if (v172->_isLightweightParticipant)
        {
          goto LABEL_187;
        }

        v106 = +[IDSFoundationLog GlobalLink];
        if (os_log_type_enabled(v106, OS_LOG_TYPE_DEFAULT))
        {
          v107 = @"NO";
          if (v172->_isAutoDisconnectSupportedForGFTService)
          {
            v108 = @"YES";
          }

          else
          {
            v108 = @"NO";
          }

          if (v172->_isLightweightParticipant)
          {
            v107 = @"YES";
          }

          *buf = 138412546;
          *v203 = v108;
          *&v203[8] = 2112;
          *&v203[10] = v107;
          _os_log_impl(&dword_1A7AD9000, v106, OS_LOG_TYPE_DEFAULT, "_isAutoDisconnectSupportedForGFTService: %@, _isLightweightParticipant: %@", buf, 0x16u);
        }

        [(__CFDictionary *)theDict setObject:MEMORY[0x1E695E118] forKeyedSubscript:@"gl-option-should-auto-disconnect-for-standard-participant"];
        if (v172->_isAutoDisconnectSupportedForGFTService)
        {
LABEL_187:
          [(__CFDictionary *)theDict setObject:MEMORY[0x1E695E118] forKeyedSubscript:@"gl-option-is-facetime-session", v162, v165, v166];
        }
      }

      v102 = v172;
    }

    v109 = [MEMORY[0x1E696AD98] numberWithBool:{v102->_isLightweightParticipant, v162}];
    if (v109)
    {
      CFDictionarySetValue(theDict, @"gl-option-is-lightweight-participant-key", v109);
    }

    else
    {
      v110 = MEMORY[0x1E69E9C10];
      v111 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v110, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18234();
      }
    }

    v112 = [MEMORY[0x1E696AD98] numberWithBool:v172->_uplinkNackDisabled];
    if (v112)
    {
      CFDictionarySetValue(theDict, @"gl-option-uplink-nack-disabled", v112);
    }

    else
    {
      v113 = MEMORY[0x1E69E9C10];
      v114 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v113, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E182BC();
      }
    }

    v192 = 0u;
    v193 = 0u;
    v190 = 0u;
    v191 = 0u;
    v115 = v172->_usedLinks;
    v116 = [(NSMutableSet *)v115 countByEnumeratingWithState:&v190 objects:v201 count:16];
    if (v116)
    {
      v117 = *v191;
      do
      {
        for (i = 0; i != v116; ++i)
        {
          if (*v191 != v117)
          {
            objc_enumerationMutation(v115);
          }

          v119 = *(*(&v190 + 1) + 8 * i);
          v120 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v120, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v203 = v119;
            _os_log_impl(&dword_1A7AD9000, v120, OS_LOG_TYPE_DEFAULT, "adding stale link to allocbind request: %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v163 = v119;
              _IDSLogTransport(@"GL", @"IDS", @"adding stale link to allocbind request: %@");
              if (_IDSShouldLog())
              {
                v163 = v119;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"adding stale link to allocbind request: %@");
              }
            }
          }
        }

        v116 = [(NSMutableSet *)v115 countByEnumeratingWithState:&v190 objects:v201 count:16];
      }

      while (v116);
    }

    v121 = v172->_usedLinks;
    if (v121)
    {
      CFDictionarySetValue(theDict, @"gl-option-used-links", v121);
    }

    else
    {
      v122 = MEMORY[0x1E69E9C10];
      v123 = MEMORY[0x1E69E9C10];
      if (os_log_type_enabled(v122, OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18344();
      }
    }

    v124 = [[IDSQRProtoMessage alloc] initWithType:1 candidatePair:v169 options:theDict];
    if (!v124)
    {
      v136 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v136, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        *v203 = @"allocbind_request";
        _os_log_impl(&dword_1A7AD9000, v136, OS_LOG_TYPE_DEFAULT, "failed to create proto message (%@).", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to create proto message (%@).");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create proto message (%@).");
          }
        }
      }

      goto LABEL_265;
    }

    v125 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v125, OS_LOG_TYPE_DEFAULT))
    {
      idsSessionID = v172->_idsSessionID;
      sessionID3 = [v169 sessionID];
      *buf = 138413314;
      *v203 = @"allocbind_request";
      *&v203[8] = 2112;
      *&v203[10] = v124;
      *&v203[18] = 2112;
      *&v203[20] = idsSessionID;
      v204 = 2112;
      v205 = sessionID3;
      v206 = 2112;
      v207 = key;
      _os_log_impl(&dword_1A7AD9000, v125, OS_LOG_TYPE_DEFAULT, "Send %@ %@ for IDSSessionID: %@ QRSessionID: %@ token: %@", buf, 0x34u);
    }

    [(IDSGFTMetricsCollector *)v172->_metricsCollector quicAllocbindRequest];
    linkMetrics = [v169 linkMetrics];
    [linkMetrics sendAllocbindRequest];

    [(IDSGlobalLink *)v172 _setLinkMetricsAttributesForCandidatePair:v169];
    local2 = [v169 local];
    transport = [local2 transport];

    v131 = IMGetDomainBoolForKey();
    v132 = IMGetDomainBoolForKey();
    v133 = v132;
    if (v131)
    {
      v134 = 0;
      v135 = v172;
    }

    else
    {
      v135 = v172;
      v134 = !v172->_forceTCPFallbackOnWiFi;
    }

    v137 = (v132 & 1) == 0 && !v135->_forceTCPFallbackOnCell;
    v138 = +[IDSFoundationLog GlobalLink];
    if (os_log_type_enabled(v138, OS_LOG_TYPE_DEFAULT))
    {
      v139 = @"NO";
      if (v131)
      {
        v140 = @"YES";
      }

      else
      {
        v140 = @"NO";
      }

      forceTCPFallbackOnCell = v172->_forceTCPFallbackOnCell;
      if (v172->_forceTCPFallbackOnWiFi)
      {
        v142 = @"YES";
      }

      else
      {
        v142 = @"NO";
      }

      *buf = 138413058;
      *v203 = v140;
      if (v133)
      {
        v143 = @"YES";
      }

      else
      {
        v143 = @"NO";
      }

      *&v203[8] = 2112;
      *&v203[10] = v142;
      if (forceTCPFallbackOnCell)
      {
        v139 = @"YES";
      }

      *&v203[18] = 2112;
      *&v203[20] = v143;
      v204 = 2112;
      v205 = v139;
      _os_log_impl(&dword_1A7AD9000, v138, OS_LOG_TYPE_DEFAULT, "sendQUICAllocbindRequest forceTCPFallbackOnWiFI default: %@ manual: %@; forceTCPFallbackOnCell default: %@ manual: %@", buf, 0x2Au);
    }

    local3 = [v169 local];
    isCellularStunCandidate = [local3 isCellularStunCandidate];

    aBlock[0] = MEMORY[0x1E69E9820];
    aBlock[1] = 3221225472;
    aBlock[2] = sub_1A7BCC2FC;
    aBlock[3] = &unk_1E77E0E18;
    aBlock[4] = v172;
    v146 = v124;
    v188 = v146;
    v147 = v169;
    v189 = v147;
    v148 = _Block_copy(aBlock);
    if ((v134 | isCellularStunCandidate) & 1 | ((transport - 3) < 0xFFFFFFFFFFFFFFFELL))
    {
      if (v137 || (transport - 3) < 0xFFFFFFFFFFFFFFFELL || ((isCellularStunCandidate ^ 1) & 1) != 0)
      {
        [v147 debugDelay];
        if (v157 == 0.0)
        {
          v148[2](v148);
        }

        else
        {
          v158 = +[IDSFoundationLog GlobalLink];
          if (os_log_type_enabled(v158, OS_LOG_TYPE_DEFAULT))
          {
            [v147 debugDelay];
            *buf = 134217984;
            *v203 = v159;
            _os_log_impl(&dword_1A7AD9000, v158, OS_LOG_TYPE_DEFAULT, "debugDelay is present. Delaying by %f seconds", buf, 0xCu);
          }

          [v147 debugDelay];
          if (v160 > 0.0)
          {
            v185[0] = MEMORY[0x1E69E9820];
            v185[1] = 3221225472;
            v185[2] = sub_1A7BCC348;
            v185[3] = &unk_1E77E0188;
            v186 = v148;
            [v147 debugDelay];
            IDSTransportThreadAddBlockAfter(v185, v161);
          }
        }

        goto LABEL_254;
      }

      v149 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
      {
        v150 = (&_IDSStunTransportStrings)[transport];
        *buf = 136315138;
        *v203 = v150;
        _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnCell is set, skip message %s", buf, 0xCu);
      }
    }

    else
    {
      v149 = +[IDSFoundationLog GlobalLink];
      if (os_log_type_enabled(v149, OS_LOG_TYPE_DEFAULT))
      {
        v151 = (&_IDSStunTransportStrings)[transport];
        *buf = 136315138;
        *v203 = v151;
        _os_log_impl(&dword_1A7AD9000, v149, OS_LOG_TYPE_DEFAULT, "forceTCPFallbackOnWiFi is set, skip message %s", buf, 0xCu);
      }
    }

LABEL_254:
    if (!v168)
    {
      [v147 setState:1];
      v152 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v152, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136315650;
        *v203 = _IDSStunCandidatePairStateStrings;
        *&v203[8] = 2080;
        *&v203[10] = off_1EB2B43B0;
        *&v203[18] = 2112;
        *&v203[20] = key;
        _os_log_impl(&dword_1A7AD9000, v152, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v165 = off_1EB2B43B0;
          v166 = key;
          v164 = _IDSStunCandidatePairStateStrings;
          _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
          if (_IDSShouldLog())
          {
            v165 = off_1EB2B43B0;
            v166 = key;
            v164 = _IDSStunCandidatePairStateStrings;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
          }
        }
      }

      allocateType = [v147 allocateType];
      v154 = 10.0;
      v155 = allocateType == 2;
      if (allocateType == 2)
      {
        v154 = GLUtilNATCheckTimeout();
      }

      transactionID = [(IDSQRProtoMessage *)v146 transactionID];
      v174[0] = MEMORY[0x1E69E9820];
      v174[1] = 3221225472;
      v174[2] = sub_1A7BCC358;
      v174[3] = &unk_1E77E1360;
      v175 = v147;
      v176 = v172;
      v179 = transactionID;
      v180 = 0;
      v177 = key;
      v183 = v171;
      v181 = v154;
      v184 = v155;
      v178 = v146;
      v182 = v167;
      IDSTransportThreadAddBlockAfter(v174, v154);
    }

LABEL_265:
    v18 = v169;
LABEL_34:

    goto LABEL_35;
  }

  v14 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v14, OS_LOG_TYPE_DEFAULT, "failed to send allocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send allocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send allocbind request due to invalid token.");
      }
    }
  }

LABEL_35:
}

- (void)_sendQUICUnallocbindRequest:(id)request reason:(unsigned __int8)reason
{
  reasonCopy = reason;
  v53 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  v7 = requestCopy;
  if (self->_state >= 6)
  {
    v8 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = _IDSLinkStateStrings[self->_state];
      *buf = 136315138;
      v48 = v9;
      _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "skip unallocbind request, GL state (%s).", buf, 0xCu);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request, GL state (%s).");
        }
      }
    }

    goto LABEL_34;
  }

  if (requestCopy)
  {
    tokenToCandidatePairs = self->_tokenToCandidatePairs;
    if (!tokenToCandidatePairs || (v11 = CFDictionaryGetValue(tokenToCandidatePairs, v7)) == 0)
    {
      v17 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v18 = self->_tokenToCandidatePairs;
        *buf = 138412546;
        v48 = v7;
        v49 = 2112;
        v50 = v18;
        _os_log_impl(&dword_1A7AD9000, v17, OS_LOG_TYPE_DEFAULT, "send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request failed due to invalid candidate pair; token: %@; tokenToCandidatePairs: %@");
          }
        }
      }

      v12 = 0;
      goto LABEL_27;
    }

    v12 = v11;
    if (([v11 isRelayStunCandidatePair] & 1) == 0)
    {
      v20 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v48 = v7;
        _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, not over relay.", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, not over relay.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, not over relay.");
          }
        }
      }

      goto LABEL_27;
    }

    state = [v12 state];
    v14 = state;
    if (state <= 6 && ((1 << state) & 0x47) != 0)
    {
      v15 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        v16 = (&_IDSStunCandidatePairStateStrings)[v14];
        *buf = 138412546;
        v48 = v7;
        v49 = 2080;
        v50 = v16;
        _os_log_impl(&dword_1A7AD9000, v15, OS_LOG_TYPE_DEFAULT, "skip unallocbind request for %@, state [%s].", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"skip unallocbind request for %@, state [%s].");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"skip unallocbind request for %@, state [%s].");
          }
        }
      }

      goto LABEL_27;
    }

    sessionID = [v12 sessionID];
    if (!sessionID)
    {
      v23 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid relay-session-id.", buf, 2u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid relay-session-id.");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid relay-session-id.");
          }
        }
      }

      goto LABEL_91;
    }

    [v12 stopSessionConnectedTimer];
    [v12 stopSessionConvergenceTimer];
    [v12 stopSessionGoAwayTimer];
    Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
    if (self->_idsContextBlob)
    {
      v22 = [(IDSGlobalLink *)self _createIDSContextBlobMaterialProto:?];
      if (v22)
      {
        CFDictionarySetValue(Mutable, @"gl-option-ids-context-blob-key", v22);
      }

      else if (os_log_type_enabled(MEMORY[0x1E69E9C10], OS_LOG_TYPE_ERROR))
      {
        sub_1A7E18124();
      }
    }

    if (reasonCopy == 12)
    {
      v24 = &unk_1F1B20108;
    }

    else if (reasonCopy == 4)
    {
      v24 = &unk_1F1B20120;
    }

    else
    {
      if (![v12 isSharedQRSession] || self->_sharedSessionHasJoined)
      {
        goto LABEL_59;
      }

      v24 = &unk_1F1B200F0;
    }

    CFDictionarySetValue(Mutable, @"gl-option-ids-context-reason-key", v24);
LABEL_59:
    v25 = [[IDSQRProtoMessage alloc] initWithType:22 candidatePair:v12 options:Mutable];
    if (v25)
    {
      v26 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        v48 = v25;
        v49 = 2112;
        v50 = v7;
        _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "send unallocbind request %@ for %@.", buf, 0x16u);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          v35 = v25;
          v37 = v7;
          _IDSLogTransport(@"GL", @"IDS", @"send unallocbind request %@ for %@.");
          if (_IDSShouldLog())
          {
            v35 = v25;
            v37 = v7;
            _IDSLogV(0, @"IDSFoundation", @"GL", @"send unallocbind request %@ for %@.");
          }
        }
      }

      v27 = [(IDSGlobalLink *)self _sendProtoMessage:v25 candidatePair:v12, v35, v37];
      [v12 addProtoRequest:{-[IDSQRProtoMessage transactionID](v25, "transactionID")}];
      if (v14 != 5)
      {
        [v12 setState:5];
        v28 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          v29 = (&_IDSStunCandidatePairStateStrings)[v14];
          *buf = 136315650;
          v48 = v29;
          v49 = 2080;
          v50 = off_1EB2B43D0;
          v51 = 2112;
          v52 = v7;
          _os_log_impl(&dword_1A7AD9000, v28, OS_LOG_TYPE_DEFAULT, "update state (%s->%s) for %@.", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            v38 = off_1EB2B43D0;
            v39 = v7;
            v36 = (&_IDSStunCandidatePairStateStrings)[v14];
            _IDSLogTransport(@"GL", @"IDS", @"update state (%s->%s) for %@.");
            if (_IDSShouldLog())
            {
              v38 = off_1EB2B43D0;
              v39 = v7;
              v36 = (&_IDSStunCandidatePairStateStrings)[v14];
              _IDSLogV(0, @"IDSFoundation", @"GL", @"update state (%s->%s) for %@.");
            }
          }
        }
      }

      if (v27 == -1 && !((self->_state != 5) | [(IDSGlobalLink *)self _hasCandidatePairInState:3 anotherState:4 relayCandidatePairsOnly:0 excludeSelfAlloc:0]))
      {
        [(IDSGlobalLink *)self _notifyLinkDisconnectedWithError:24 reason:reasonCopy];
      }

      else
      {
        v30 = [(IDSQRProtoMessage *)v25 transactionID:v36];
        if (!self->_unallocbindRequestToReason)
        {
          v31 = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
          unallocbindRequestToReason = self->_unallocbindRequestToReason;
          self->_unallocbindRequestToReason = v31;
        }

        v33 = [MEMORY[0x1E696AD98] numberWithUnsignedChar:reasonCopy];
        if (v33)
        {
          CFDictionarySetValue(self->_unallocbindRequestToReason, [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:v30], v33);
        }

        v41[0] = MEMORY[0x1E69E9820];
        v41[1] = 3221225472;
        v41[2] = sub_1A7BCDA2C;
        v41[3] = &unk_1E77E1388;
        v42 = v12;
        selfCopy = self;
        v44 = v30;
        v46 = reasonCopy;
        v45 = 22;
        IDSTransportThreadAddBlockAfter(v41, 3.0);
      }
    }

    else
    {
      v34 = OSLogHandleForTransportCategory();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v48 = @"unallocbind_request";
        _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "failed to create proto message (%@)", buf, 0xCu);
      }

      if (os_log_shim_legacy_logging_enabled())
      {
        if (_IDSShouldLogTransport())
        {
          _IDSLogTransport(@"GL", @"IDS", @"failed to create proto message (%@)");
          if (_IDSShouldLog())
          {
            _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to create proto message (%@)");
          }
        }
      }
    }

LABEL_91:
LABEL_27:

    goto LABEL_34;
  }

  v19 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_1A7AD9000, v19, OS_LOG_TYPE_DEFAULT, "failed to send unallocbind request due to invalid token.", buf, 2u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"failed to send unallocbind request due to invalid token.");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to send unallocbind request due to invalid token.");
      }
    }
  }

LABEL_34:
}

- (void)_sendChannelDataCommandMessage:(int64_t)message packetBuffer:(id *)buffer options:(id)options candidatePairToken:(id)token
{
  v21 = *MEMORY[0x1E69E9840];
  optionsCopy = options;
  tokenCopy = token;
  if (tokenCopy && (tokenToCandidatePairs = self->_tokenToCandidatePairs) != 0 && (v13 = CFDictionaryGetValue(tokenToCandidatePairs, tokenCopy)) != 0 || tokenCopy && (tokenToStunCheckPairs = self->_tokenToStunCheckPairs) != 0 && (v13 = CFDictionaryGetValue(tokenToStunCheckPairs, tokenCopy)) != 0)
  {
    v15 = v13;
LABEL_9:
    [(IDSGlobalLink *)self _sendChannelDataCommandMessage:message packetBuffer:buffer options:optionsCopy candidatePair:v15];

    goto LABEL_10;
  }

  v15 = [(IDSGlobalLink *)self _findVirtualCandidatePair:tokenCopy];
  if (v15)
  {
    goto LABEL_9;
  }

  v16 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218242;
    messageCopy = message;
    v19 = 2112;
    v20 = tokenCopy;
    _os_log_impl(&dword_1A7AD9000, v16, OS_LOG_TYPE_DEFAULT, "send command %04lx failed due to invalid candidate pair %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      _IDSLogTransport(@"GL", @"IDS", @"send command %04lx failed due to invalid candidate pair %@");
      if (_IDSShouldLog())
      {
        _IDSLogV(0, @"IDSFoundation", @"GL", @"send command %04lx failed due to invalid candidate pair %@");
      }
    }
  }

  _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15015, buffer);
LABEL_10:
}

- (void)_sendChannelDataCommandMessage:(int64_t)message packetBuffer:(id *)buffer options:(id)options candidatePair:(id)pair
{
  v111 = *MEMORY[0x1E69E9840];
  optionsCopy = options;
  pairCopy = pair;
  v11 = pairCopy;
  selfCopy = self;
  messageCopy = message;
  if (self->_state >= 6)
  {
    v12 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = _IDSLinkStateStrings[self->_state];
      *buf = 134218242;
      *v109 = message;
      *&v109[8] = 2080;
      *&v109[10] = v13;
      _os_log_impl(&dword_1A7AD9000, v12, OS_LOG_TYPE_DEFAULT, "skip session command %04lx, GL state (%s).", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"skip session command %04lx, GL state (%s).");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"skip session command %04lx, GL state (%s).");
        }
      }
    }

    _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15027, buffer);
    goto LABEL_9;
  }

  bufferCopy = buffer;
  state = [pairCopy state];
  local = [v11 local];
  address = [local address];

  if (![v11 isRelayStunCandidatePair]|| (state - 5) > 0xFFFFFFFFFFFFFFFDLL)
  {
LABEL_39:
    v37 = ids_monotonic_time();
    v38 = [optionsCopy objectForKey:@"gl-attr-active-probing-link-id"];
    charValue = [v38 charValue];

    v40 = messageCopy;
    if (!charValue)
    {
      if ([(IDSGlobalLink *)selfCopy _skipCommandMessage:messageCopy candidatePair:v11 timeNow:v37])
      {
        v48 = OSLogHandleForIDSCategory();
        if (os_log_type_enabled(v48, OS_LOG_TYPE_DEBUG))
        {
          candidatePairToken = [v11 candidatePairToken];
          v50 = (&_IDSStunCandidatePairStateStrings)[[v11 state]];
          *buf = 134218498;
          *v109 = messageCopy;
          *&v109[8] = 2112;
          *&v109[10] = candidatePairToken;
          *&v109[18] = 2080;
          *&v109[20] = v50;
          _os_log_impl(&dword_1A7AD9000, v48, OS_LOG_TYPE_DEBUG, "skip session command %04lx for %@, state [%s].", buf, 0x20u);
        }

        if (os_log_shim_legacy_logging_enabled() && _IDSShouldLog())
        {
          candidatePairToken2 = [v11 candidatePairToken];
          [v11 state];
          _IDSLogV(1, @"IDSFoundation", @"GL", @"skip session command %04lx for %@, state [%s].");
        }

        _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15065, bufferCopy);
        goto LABEL_9;
      }

      v40 = messageCopy;
      if (messageCopy == 3)
      {
        [v11 hbStartTime];
        if (v60 == 0.0)
        {
          v61 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v61, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v109 = v11;
            _os_log_impl(&dword_1A7AD9000, v61, OS_LOG_TYPE_DEFAULT, "session heartbeat request start now for %@", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v88 = v11;
              _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request start now for %@");
              if (_IDSShouldLog())
              {
                v88 = v11;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request start now for %@");
              }
            }
          }

          [v11 setHbStartTime:v37, v88, v89, v92, v93];
          v40 = 3;
        }

        else
        {
          v40 = 3;
          if (v37 - v60 > 60.0)
          {
            v85 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              *v109 = v11;
              _os_log_impl(&dword_1A7AD9000, v85, OS_LOG_TYPE_DEFAULT, "session heartbeat request message timed out, disconnect %@", buf, 0xCu);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v88 = v11;
                _IDSLogTransport(@"GL", @"IDS", @"session heartbeat request message timed out, disconnect %@");
                if (_IDSShouldLog())
                {
                  v88 = v11;
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"session heartbeat request message timed out, disconnect %@");
                }
              }
            }

            v86 = [v11 isQUIC:v88];
            candidatePairToken3 = [v11 candidatePairToken];
            if (v86)
            {
              [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:candidatePairToken3 reason:9];
            }

            else
            {
              [(IDSGlobalLink *)selfCopy _sendUnallocbindRequest:candidatePairToken3 stunMessage:0 reason:9];
            }

            _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15083, bufferCopy);
            goto LABEL_9;
          }
        }
      }
    }

    v41 = bufferCopy;
    if (!bufferCopy)
    {
      v51 = [(IDSGlobalLink *)selfCopy _createCommandData:v40 options:optionsCopy candidatePair:v11];
      if (!v51)
      {
        v71 = OSLogHandleForTransportCategory();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 134217984;
          *v109 = messageCopy;
          _os_log_impl(&dword_1A7AD9000, v71, OS_LOG_TYPE_DEFAULT, "failed to get indication data, skip session command (%04lx) message.", buf, 0xCu);
        }

        if (os_log_shim_legacy_logging_enabled())
        {
          if (_IDSShouldLogTransport())
          {
            _IDSLogTransport(@"GL", @"IDS", @"failed to get indication data, skip session command (%04lx) message.");
            if (_IDSShouldLog())
            {
              _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to get indication data, skip session command (%04lx) message.");
            }
          }
        }

        goto LABEL_9;
      }

      bufferCopy = _IDSLinkPacketBufferCreate();
      bufferCopy->var25 = [v11 linkID];
      v52 = [v51 length];
      bufferCopy->var2 = v52;
      [v51 getBytes:bufferCopy->var0 length:v52];
      bufferCopy->var23 = 1;
      bufferCopy->var24[0].var19 = 1;
      v53 = [optionsCopy objectForKey:@"gl-attr-remote-relay-link-id"];
      v54 = v53;
      v55 = bufferCopy;
      if (v53)
      {
        bufferCopy->var24[0].var14 = 1;
        unsignedShortValue = [v53 unsignedShortValue];
        v55 = bufferCopy;
        bufferCopy->var24[0].var15[0] = unsignedShortValue;
      }

      v55->var28 = v37;

LABEL_84:
      v62 = +[IDSFoundationLog GlobalLink];
      v63 = os_log_type_enabled(v62, OS_LOG_TYPE_DEFAULT);
      if (charValue <= 0)
      {
        if (v63)
        {
          candidatePairToken4 = [v11 candidatePairToken];
          idsSessionID = selfCopy->_idsSessionID;
          sessionID = [v11 sessionID];
          *buf = 67110146;
          *v109 = messageCopy;
          *&v109[4] = 2112;
          *&v109[6] = candidatePairToken4;
          *&v109[14] = 2112;
          *&v109[16] = idsSessionID;
          *&v109[24] = 2112;
          *&v109[26] = sessionID;
          *&v109[34] = 2112;
          *&v109[36] = v11;
          _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "Send command %04x (relay) for %@ IDSSessionID: %@ QRSessionID: %@ candidatePair: %@", buf, 0x30u);
        }
      }

      else
      {
        if (v63)
        {
          candidatePairToken5 = [v11 candidatePairToken];
          v65 = selfCopy->_idsSessionID;
          sessionID2 = [v11 sessionID];
          *buf = 67110146;
          *v109 = messageCopy;
          *&v109[4] = 1024;
          *&v109[6] = charValue;
          *&v109[10] = 2112;
          *&v109[12] = candidatePairToken5;
          *&v109[20] = 2112;
          *&v109[22] = v65;
          *&v109[30] = 2112;
          *&v109[32] = sessionID2;
          _os_log_impl(&dword_1A7AD9000, v62, OS_LOG_TYPE_DEFAULT, "Send command %04x (active probing on link %d) (relay) for %@ IDSSessionID: %@ QRSessionID: %@", buf, 0x2Cu);
        }

        if (selfCopy->_maxLinkID <= charValue)
        {
          v67 = 0;
        }

        else
        {
          v67 = selfCopy->_candidatePairs[charValue];
        }

        v62 = v11;
        v11 = v67;
      }

      v72 = 0;
      v73 = messageCopy;
      if (messageCopy != 3 && (messageCopy & 0x8000) == 0)
      {
        v72 = _IDSLinkPacketBufferClone("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15158, bufferCopy);
        v73 = messageCopy;
      }

      v74 = (v73 & 0x8000) == 0;
      var28 = bufferCopy->var28;
      [IDSGlobalLink _sendChannelDataPacketBuffer:selfCopy candidatePair:"_sendChannelDataPacketBuffer:candidatePair:"];
      v76 = messageCopy;
      v77 = messageCopy == 3 && charValue > 0;
      if (!v77 && v74)
      {
        v78 = 1.0;
        if (messageCopy == 6 || messageCopy == 1)
        {
          v79 = selfCopy;
          if (v37 - var28 < 2.0)
          {
            v80 = selfCopy->_allocbindEndTime - selfCopy->_allocbindStartTime;
            if (v80 > 0.0)
            {
              v81 = v80 + v80;
              if (v80 + v80 > 0.2)
              {
                v81 = 0.2;
              }

              if (v81 >= 0.05)
              {
                v78 = v81;
              }

              else
              {
                v78 = 0.05;
              }

              v82 = OSLogHandleForTransportCategory();
              if (os_log_type_enabled(v82, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 134218240;
                *v109 = v78;
                *&v109[8] = 2048;
                *&v109[10] = v80;
                _os_log_impl(&dword_1A7AD9000, v82, OS_LOG_TYPE_DEFAULT, "use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.", buf, 0x16u);
              }

              if (os_log_shim_legacy_logging_enabled())
              {
                if (_IDSShouldLogTransport())
                {
                  _IDSLogTransport(@"GL", @"IDS", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
                  if (_IDSShouldLog())
                  {
                    _IDSLogV(0, @"IDSFoundation", @"GL", @"use aggressive rexmit interval %.3f sec, allocbind rtt %.3f sec.");
                  }
                }
              }

              v79 = selfCopy;
              v76 = messageCopy;
            }
          }
        }

        else
        {
          v79 = selfCopy;
        }

        v99[0] = MEMORY[0x1E69E9820];
        v99[1] = 3221225472;
        v99[2] = sub_1A7BCF388;
        v99[3] = &unk_1E77E13B0;
        v99[4] = v79;
        v102 = v76;
        v103 = v72;
        v100 = optionsCopy;
        v11 = v11;
        v101 = v11;
        IDSTransportThreadAddBlockAfter(v99, v78);
      }

      goto LABEL_9;
    }

    if (v37 - bufferCopy->var28 > 30.0)
    {
      switch(v40)
      {
        case 6:
          v84 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v84, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v84, OS_LOG_TYPE_DEFAULT, "session relay interface information message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session relay interface information message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session relay interface information message timed out.");
              }
            }
          }

          [(IDSGlobalLink *)selfCopy _discardKeyMaterialMessage:12, v88];
          candidatePairToken6 = +[IDSStunRelayInterfaceInfoController sharedInstance];
          [candidatePairToken6 setRelayInterfaceInfoDeliveryStatus:selfCopy->_cbuuid status:4];
          break;
        case 4:
          v83 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v83, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_1A7AD9000, v83, OS_LOG_TYPE_DEFAULT, "session connection data message timed out.", buf, 2u);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              _IDSLogTransport(@"GL", @"IDS", @"session connection data message timed out.");
              if (_IDSShouldLog())
              {
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connection data message timed out.");
              }
            }
          }

          candidatePairToken6 = +[IDSStunConnectionDataController sharedInstance];
          [candidatePairToken6 setDeliveryStatus:selfCopy->_cbuuid status:3];
          break;
        case 1:
          v42 = OSLogHandleForTransportCategory();
          if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            *v109 = v11;
            _os_log_impl(&dword_1A7AD9000, v42, OS_LOG_TYPE_DEFAULT, "session connected message timed out, disconnect %@.", buf, 0xCu);
          }

          if (os_log_shim_legacy_logging_enabled())
          {
            if (_IDSShouldLogTransport())
            {
              v88 = v11;
              _IDSLogTransport(@"GL", @"IDS", @"session connected message timed out, disconnect %@.");
              if (_IDSShouldLog())
              {
                v88 = v11;
                _IDSLogV(0, @"IDSFoundation", @"GL", @"session connected message timed out, disconnect %@.");
              }
            }
          }

          linkEngine = [v11 linkEngine];

          if (linkEngine)
          {
            linkEngine2 = [v11 linkEngine];
            linkUniqueName = [v11 linkUniqueName];
            [linkEngine2 linkDidFail:linkUniqueName errorCode:9 isRecoverable:0 shouldReconnect:0];
          }

          isQUIC = [v11 isQUIC];
          candidatePairToken6 = [v11 candidatePairToken];
          if (isQUIC)
          {
            [(IDSGlobalLink *)selfCopy _sendQUICUnallocbindRequest:candidatePairToken6 reason:9];
          }

          else
          {
            [(IDSGlobalLink *)selfCopy _sendUnallocbindRequest:candidatePairToken6 stunMessage:0 reason:9];
          }

          break;
        default:
LABEL_150:
          _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15109, v41);
          goto LABEL_9;
      }

      v41 = bufferCopy;
      goto LABEL_150;
    }

    if ((v40 & 0xFFFFFFFFFFFF7FFFLL) == 4 && optionsCopy)
    {
      v57 = [optionsCopy objectForKey:@"gl-attr-counter"];
      intValue = [v57 intValue];
      intValue2 = 0xFFFFFFFFLL;
    }

    else
    {
      intValue = 0xFFFFFFFFLL;
      intValue2 = 0xFFFFFFFFLL;
      if ((v40 & 0xFFFFFFFFFFFF7FFFLL) != 6 || !optionsCopy)
      {
LABEL_82:
        if ([(IDSGlobalLink *)selfCopy _shouldSkipCommand:v40 withCandidatePair:v11 connectionDataCounter:intValue relayInterfaceCounter:intValue2, v88])
        {
          _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15122, bufferCopy);
          goto LABEL_9;
        }

        goto LABEL_84;
      }

      v57 = [optionsCopy objectForKey:@"gl-attr-counter"];
      intValue2 = [v57 intValue];
    }

    v40 = messageCopy;
    goto LABEL_82;
  }

  v106 = 0u;
  v107 = 0u;
  v104 = 0u;
  v105 = 0u;
  allValues = [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v17 = [allValues countByEnumeratingWithState:&v104 objects:v110 count:16];
  if (v17)
  {
    v18 = *v105;
    while (2)
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v105 != v18)
        {
          objc_enumerationMutation(allValues);
        }

        v20 = *(*(&v104 + 1) + 8 * i);
        local2 = [v20 local];
        address2 = [local2 address];

        sessionID3 = [v20 sessionID];
        sessionID4 = [v11 sessionID];
        if ([sessionID3 isEqualToString:sessionID4] && (objc_msgSend(v20, "state") == 3 || objc_msgSend(v20, "state") == 4))
        {
          v25 = IsSameSA(address, address2);

          if (v25)
          {
            candidatePairToken7 = [v11 candidatePairToken];
            candidatePairToken8 = [v20 candidatePairToken];
            v33 = v20;

            v34 = OSLogHandleForTransportCategory();
            if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
            {
              v36 = (&_IDSStunCandidatePairStateStrings)[state];
              *buf = 138413058;
              *v109 = candidatePairToken7;
              *&v109[8] = 2080;
              *&v109[10] = v36;
              *&v109[18] = 1024;
              *&v109[20] = messageCopy;
              *&v109[24] = 2112;
              *&v109[26] = candidatePairToken8;
              _os_log_impl(&dword_1A7AD9000, v34, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], send command %04x using %@.", buf, 0x26u);
            }

            if (os_log_shim_legacy_logging_enabled())
            {
              if (_IDSShouldLogTransport())
              {
                v92 = messageCopy;
                v93 = candidatePairToken8;
                v88 = candidatePairToken7;
                v89 = (&_IDSStunCandidatePairStateStrings)[state];
                _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], send command %04x using %@.");
                if (_IDSShouldLog())
                {
                  v92 = messageCopy;
                  v93 = candidatePairToken8;
                  v88 = candidatePairToken7;
                  v89 = (&_IDSStunCandidatePairStateStrings)[state];
                  _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], send command %04x using %@.");
                }
              }
            }

            v11 = v33;
            goto LABEL_39;
          }
        }

        else
        {
        }
      }

      v17 = [allValues countByEnumeratingWithState:&v104 objects:v110 count:16];
      if (v17)
      {
        continue;
      }

      break;
    }
  }

  v26 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    candidatePairToken9 = [v11 candidatePairToken];
    v28 = (&_IDSStunCandidatePairStateStrings)[state];
    *buf = 138412802;
    *v109 = candidatePairToken9;
    *&v109[8] = 2080;
    *&v109[10] = v28;
    *&v109[18] = 1024;
    *&v109[20] = messageCopy;
    _os_log_impl(&dword_1A7AD9000, v26, OS_LOG_TYPE_DEFAULT, "%@ has state [%s], Found no other connected candidate pair to send command %04x", buf, 0x1Cu);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      candidatePairToken10 = [v11 candidatePairToken];
      v90 = (&_IDSStunCandidatePairStateStrings)[state];
      _IDSLogTransport(@"GL", @"IDS", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");

      if (_IDSShouldLog())
      {
        v30 = [v11 candidatePairToken:candidatePairToken10];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%@ has state [%s], Found no other connected candidate pair to send command %04x");
      }
    }
  }

  _IDSLinkPacketBufferRelease("/Library/Caches/com.apple.xbs/Sources/IdentityServices/IDSFoundation/IDSGlobalLink.m", 15054, bufferCopy);
LABEL_9:
}

- (BOOL)_processChannelDataCommandMessage:(id *)message remoteRelayLinkID:(unsigned __int16)d channelNumber:(unsigned __int16)number fromDeviceUniqueID:(id)iD cbuuid:(id)cbuuid arrivalTime:(double)time
{
  numberCopy = number;
  dCopy = d;
  v31 = *MEMORY[0x1E69E9840];
  iDCopy = iD;
  cbuuidCopy = cbuuid;
  v16 = channelForStunCandidatePair(&message->var18, &message->var19, numberCopy);
  channelToCandidatePairs = self->_channelToCandidatePairs;
  if (channelToCandidatePairs)
  {
    v18 = v16 == 0;
  }

  else
  {
    v18 = 1;
  }

  if (v18 || (v19 = CFDictionaryGetValue(channelToCandidatePairs, v16)) == 0)
  {
    v23 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = self->_channelToCandidatePairs;
      *buf = 138412546;
      v28 = v16;
      v29 = 2112;
      v30 = v24;
      _os_log_impl(&dword_1A7AD9000, v23, OS_LOG_TYPE_DEFAULT, "failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"failed to find relay-session-id for command message, channel %@, _channelToCandidatePairs = %@");
        }
      }
    }

    v25 = 0;
  }

  else
  {
    v20 = v19;
    candidatePairToken = [v19 candidatePairToken];
    if ([v20 isActive])
    {
      v22 = IDSQRSendInfoList_ItemAtIndex(self->_sendInfoList, 0);
      if (v22)
      {
        v22[39] = time;
      }
    }

    else
    {
      [v20 setLastIncomingPacketTime:time];
    }

    v25 = [(IDSGlobalLink *)self _processIncomingIndicationData:message->var0 length:LODWORD(message->var2) candidatePairToken:candidatePairToken arrivalTime:dCopy remoteRelayLinkID:time];
  }

  return v25;
}

- (int64_t)getAllocBindErrorCodeForSessionID:(id)d
{
  v31 = *MEMORY[0x1E69E9840];
  dCopy = d;
  [(NSMutableDictionary *)self->_tokenToCandidatePairs allValues];
  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v5 = v23 = 0u;
  v6 = [v5 countByEnumeratingWithState:&v22 objects:v30 count:16];
  if (!v6)
  {

LABEL_20:
    v20 = OSLogHandleForTransportCategory();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 136315394;
      v27 = "[IDSGlobalLink getAllocBindErrorCodeForSessionID:]";
      v28 = 2112;
      v29 = dCopy;
      _os_log_impl(&dword_1A7AD9000, v20, OS_LOG_TYPE_DEFAULT, "%s: did not find candidate pairs for session %@", buf, 0x16u);
    }

    if (os_log_shim_legacy_logging_enabled())
    {
      if (_IDSShouldLogTransport())
      {
        _IDSLogTransport(@"GL", @"IDS", @"%s: did not find candidate pairs for session %@");
        if (_IDSShouldLog())
        {
          _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: did not find candidate pairs for session %@");
        }
      }
    }

    v19 = 7;
    goto LABEL_27;
  }

  v7 = 0;
  v8 = 0;
  v9 = *v23;
  do
  {
    for (i = 0; i != v6; ++i)
    {
      if (*v23 != v9)
      {
        objc_enumerationMutation(v5);
      }

      v11 = *(*(&v22 + 1) + 8 * i);
      sessionID = [v11 sessionID];
      v13 = [sessionID isEqualToString:dCopy];

      if (v13)
      {
        local = [v11 local];
        v15 = *([local address] + 1) == 30;

        if (v15)
        {
          v7 = 1;
        }

        else
        {
          local2 = [v11 local];
          v17 = *([local2 address] + 1) == 2;

          v8 |= v17;
        }
      }
    }

    v6 = [v5 countByEnumeratingWithState:&v22 objects:v30 count:16];
  }

  while (v6);

  v18 = 37;
  if ((v8 & 1 & v7) != 0)
  {
    v18 = 7;
  }

  if (v8)
  {
    v19 = v18;
  }

  else
  {
    v19 = 38;
  }

  if (((v8 | v7) & 1) == 0)
  {
    goto LABEL_20;
  }

LABEL_27:

  return v19;
}

- (BOOL)_sendChannelConfigRequestToQR:(id)r
{
  v24 = *MEMORY[0x1E69E9840];
  rCopy = r;
  state = [rCopy state];
  if (![rCopy isRelayStunCandidatePair])
  {
    goto LABEL_14;
  }

  local = [rCopy local];
  if (![local isCellularStunCandidate] || state != 4)
  {

    goto LABEL_14;
  }

  isQUIC = [rCopy isQUIC];

  if (!isQUIC)
  {
LABEL_14:
    v14 = 0;
    goto LABEL_15;
  }

  v8 = OSLogHandleForTransportCategory();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    candidatePairToken = [rCopy candidatePairToken];
    *buf = 136315394;
    v21 = "[IDSGlobalLink _sendChannelConfigRequestToQR:]";
    v22 = 2112;
    v23 = candidatePairToken;
    _os_log_impl(&dword_1A7AD9000, v8, OS_LOG_TYPE_DEFAULT, "%s: %@", buf, 0x16u);
  }

  if (os_log_shim_legacy_logging_enabled())
  {
    if (_IDSShouldLogTransport())
    {
      candidatePairToken2 = [rCopy candidatePairToken];
      _IDSLogTransport(@"GL", @"IDS", @"%s: %@");

      if (_IDSShouldLog())
      {
        candidatePairToken3 = [rCopy candidatePairToken];
        _IDSLogV(0, @"IDSFoundation", @"GL", @"%s: %@");
      }
    }
  }

  ++self->_channelConfigGenerationCounter;
  v10 = [IDSQRProtoMessage alloc];
  v19[0] = &unk_1F1B20138;
  v18[0] = @"gl-option-channel-config-override-idle-timeout-key";
  v18[1] = @"gl-option-channel-config-counter-key";
  v11 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:self->_channelConfigGenerationCounter];
  v19[1] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v19 forKeys:v18 count:2];
  v13 = [(IDSQRProtoMessage *)v10 initWithType:39 candidatePair:rCopy options:v12];

  if (v13)
  {
    v14 = [rCopy sendQUICChannelConfigRequest:v13];
  }

  else
  {
    v14 = 0;
  }

LABEL_15:
  return v14;
}

- (IDSLinkDelegate)delegate
{
  WeakRetained = objc_loadWeakRetained(&self->_delegate);

  return WeakRetained;
}

- (IDSLinkDelegate)alternateDelegate
{
  WeakRetained = objc_loadWeakRetained(&self->_alternateDelegate);

  return WeakRetained;
}

@end