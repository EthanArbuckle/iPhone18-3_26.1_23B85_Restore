@interface PLModelMigrator
+ (BOOL)_readBooleanFlagWithKey:(id)a3 fromMetadataWithMOC:(id)a4 pathManager:(id)a5;
+ (BOOL)_writeNumber:(id)a3 forKey:(id)a4 pathManager:(id)a5 error:(id *)a6;
+ (BOOL)enumerateObjectsWithIncrementalSaveDefaultBatchSizeFetchRequest:(id)a3 managedObjectContext:(id)a4 count:(unint64_t *)a5 error:(id *)a6 block:(id)a7;
+ (BOOL)executeBatchDeleteWithEntityName:(id)a3 predicate:(id)a4 managedObjectContext:(id)a5 error:(id *)a6;
+ (BOOL)executeBatchUpdateWithEntityName:(id)a3 predicate:(id)a4 propertiesToUpdate:(id)a5 managedObjectContext:(id)a6 error:(id *)a7;
+ (BOOL)markAssetsWithThumbsForTableRebuildInContext:(id)a3;
+ (BOOL)performFaceAnalysisResetWithResetLevel:(int64_t)a3 pathManager:(id)a4 context:(id)a5;
+ (BOOL)rebuildMomentsInContext:(id)a3 pathManager:(id)a4 deleteExistingMoments:(BOOL)a5 targetedAssetOIDs:(id)a6;
+ (BOOL)resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager:(id)a3 deferHintChanges:(BOOL)a4 inContext:(id)a5;
+ (BOOL)shouldImportAssetsFromDCIMSubDirectoryAtURL:(id)a3 assetsKind:(int *)a4;
+ (BOOL)shouldPromptUserForRebuildWithLibraryPathManager:(id)a3;
+ (BOOL)waitForDataMigratorToExit;
+ (id)_readNumberWithKey:(id)a3 fromMetadataWithMOC:(id)a4 pathManager:(id)a5 error:(id *)a6;
+ (id)extractPathToAssetUUIDRecoveryMappingFromDatabasePath:(id)a3;
+ (id)schemaIncompatibilityDetailsForStoreMetadata:(id)a3 model:(id)a4;
- (BOOL)_addCameraCaptureDeviceForAssetsInStore:(id)a3;
- (BOOL)_addCloudKindSubtypeAndBurstFlagsInStore:(id)a3;
- (BOOL)_addLocalVideoKeyFrameResourceInStore:(id)a3 deferHintChanges:(BOOL)a4;
- (BOOL)_addLocationHashesToAssets:(id)a3;
- (BOOL)_addRAWPackedBadgeAttributeForAllRAWAssetsInStore:(id)a3;
- (BOOL)_addUUIDsToCollectionLists:(id)a3 skipMomentLists:(BOOL)a4;
- (BOOL)_addUUIDsToExistingKeywordsInStore:(id)a3;
- (BOOL)_applyDataProtectionToDCIMFromClassBToClassC;
- (BOOL)_batchOfflineDeleteFromDatabaseOnlyAssets:(id)a3 inManagedObjectContext:(id)a4 error:(id *)a5;
- (BOOL)_cleanupInvalidAlbumsAndFoldersInStore:(id)a3;
- (BOOL)_convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore:(id)a3;
- (BOOL)_copyAssetDescriptionToAccessibilityDescription:(id)a3;
- (BOOL)_createImportSessionAlbums:(id)a3;
- (BOOL)_createPhotoDataDirectoryIfNecessary:(BOOL *)a3 error:(id *)a4;
- (BOOL)_deleteAllMemoriesInStore:(id)a3;
- (BOOL)_deleteCloudSharedAndSynced:(BOOL)a3 assetReferencesInStore:(id)a4;
- (BOOL)_deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore:(id)a3;
- (BOOL)_deleteExtraneousAdjustedFullSizeResourcesForSloMoAssetsWithStore:(id)a3;
- (BOOL)_deleteLocalVideoKeyFrameResourcesForNonVideosInStore:(id)a3 deferHintChanges:(BOOL)a4;
- (BOOL)_deleteOrphanedUnverifiedPeople:(id)a3;
- (BOOL)_deletePersistentHistoryInStore:(id)a3;
- (BOOL)_deletePersonsMissingUUIDInStore:(id)a3;
- (BOOL)_deletePhotoCloudSharingMetadataInManagedObjectContext:(id)a3 error:(id *)a4;
- (BOOL)_deletePhotoStreamAssetReferencesInStore:(id)a3;
- (BOOL)_deleteVideoThumbsMadeFromPreferredFrameInStore:(id)a3;
- (BOOL)_disableICloudPhoto;
- (BOOL)_emptyResourceTablesInStagedStore:(id)a3;
- (BOOL)_ensureAllUserVerifiedPersonsHaveFaceCropsInStore:(id)a3;
- (BOOL)_filterSceneClassificationsInStore:(id)a3;
- (BOOL)_fixAdjustedAssets:(id)a3;
- (BOOL)_fixAlbumAndFolderSortAscending:(id)a3;
- (BOOL)_fixAssetMasterResources:(id)a3;
- (BOOL)_fixCloudMasterCloudLocalState:(id)a3;
- (BOOL)_fixCloudSharedGIFsInStore:(id)a3;
- (BOOL)_fixCloudSharedVideosInStore:(id)a3;
- (BOOL)_fixCorruptedOrientationsInStore:(id)a3;
- (BOOL)_fixCustomRenderedValues:(id)a3;
- (BOOL)_fixDuplicatedAssets:(id)a3;
- (BOOL)_fixDuplicatedRootFolderAndOrphanedAlbumsInStore:(id)a3;
- (BOOL)_fixEmptyVideoResourcePathsInStore:(id)a3;
- (BOOL)_fixFaceAlgorithmVersion:(id)a3;
- (BOOL)_fixImportedAssetsFromCMMSavedInDCIMWithWrongSavedAssetType:(id)a3;
- (BOOL)_fixIncorrectAddedDateForAssetsInStore:(id)a3;
- (BOOL)_fixIncorrectHeifMetadataInStore:(id)a3;
- (BOOL)_fixIncorrectThumbnailTablesInStore:(id)a3 deferHintChanges:(BOOL)a4;
- (BOOL)_fixInitialSyncMarker;
- (BOOL)_fixItemIdentifierForVideoCmplInStore:(id)a3;
- (BOOL)_fixKeywordsInStagedStore:(id)a3;
- (BOOL)_fixLastPrefetchDateInStore:(id)a3;
- (BOOL)_fixLocalPathForVideoCmplDerivativesInStore:(id)a3;
- (BOOL)_fixLocallyAvailableFlagForThumbnailsInStore:(id)a3;
- (BOOL)_fixMasterCloudLocalStateEnum:(id)a3;
- (BOOL)_fixMemoriesWithAssetLists:(id)a3;
- (BOOL)_fixMergedPeopleThatShouldBeVerified:(id)a3;
- (BOOL)_fixMovieAttributesInStore:(id)a3;
- (BOOL)_fixNilCloudMasterGUID:(id)a3;
- (BOOL)_fixNonDuplicatedAssets:(id)a3 adjusted:(BOOL)a4;
- (BOOL)_fixOriginalPropertiesForCloudSharedAssetsInStore:(id)a3;
- (BOOL)_fixRawWithZeroDimensions:(id)a3;
- (BOOL)_fixRejectedKeyFace:(id)a3;
- (BOOL)_fixSharedStreamVideoResourcesInStore:(id)a3;
- (BOOL)_fixSidecarUTIsAndDataStoreSubtype:(id)a3;
- (BOOL)_fixTrashedDate:(id)a3;
- (BOOL)_fixUTIforSlowMoInStore:(id)a3;
- (BOOL)_fixUnpushedVideoComplementResourcesInStore:(id)a3;
- (BOOL)_fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore:(id)a3;
- (BOOL)_fixVideoDimensionsForAsset:(id)a3;
- (BOOL)_fixVideoDimensionsInStore:(id)a3;
- (BOOL)_fixVideoJPGPath:(id)a3;
- (BOOL)_fixVisibleBurstAsset:(id)a3;
- (BOOL)_fixWhitelistOwnerForPendingInvitationsInStore:(id)a3;
- (BOOL)_fixZeroDurationPhotoIrisWithLocalResourcesInStore:(id)a3 assumeAdjustedIrisIsVisible:(BOOL)a4;
- (BOOL)_fixZeroTrashedDateForEntityName:(id)a3 inManagedObjectContext:(id)a4;
- (BOOL)_fixupAlbumOrderInAlbumListInStore:(id)a3;
- (BOOL)_fixupAssetPersistence:(id)a3;
- (BOOL)_fixupBrokenBurstPicksInStore:(id)a3;
- (BOOL)_fixupCroppedUnadjustedAssets:(id)a3;
- (BOOL)_fixupImportedAssetsInStore:(id)a3;
- (BOOL)_fixupImportedEventsInStore:(id)a3;
- (BOOL)_fixupSharedStreamOrientationsInStore:(id)a3;
- (BOOL)_fixupSyncedAssetAttributesInStore:(id)a3;
- (BOOL)_flattenUnknownCustomRenderedValues:(id)a3;
- (BOOL)_forceAlbumMetadataToDiskInStore:(id)a3;
- (BOOL)_forceSoftResetSync;
- (BOOL)_generateAddedDateForAssetsInStore:(id)a3;
- (BOOL)_identifyVariationsAndDepthAdjustmentsForAsset:(id)a3;
- (BOOL)_identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure:(BOOL)a3 inStore:(id)a4;
- (BOOL)_initiateLightweightReimportOfAllPhotoCloudSharingMetadataInStore:(id)a3;
- (BOOL)_invalidateReverseGeocodingDataInStore:(id)a3;
- (BOOL)_invalidateZeroHDRGainInStore:(id)a3;
- (BOOL)_isFileSystemImportRequiredForLibrary:(id)a3;
- (BOOL)_isFilesystemImportConfigurationDisabled;
- (BOOL)_isReasonableCreationDate:(id)a3;
- (BOOL)_markAllProcessedAnalysisStatesDirtyForWorkerType:(signed __int16)a3 withStartingWorkerFlags:(int)a4 inStore:(id)a5;
- (BOOL)_markMigrationVerifiedTypePersonsInStore:(id)a3;
- (BOOL)_markOldPhotoIrisEditsEvaluatedInStore:(id)a3;
- (BOOL)_markPhotoIrisVideoOrphansInStore:(id)a3;
- (BOOL)_migrateAssetLocationData:(id)a3;
- (BOOL)_migrateCandidateBitsToDeferredProcessingCandidateOptions:(id)a3;
- (BOOL)_migrateCloudResourcesRelationshipsInStagedStore:(id)a3;
- (BOOL)_migrateDetectedFacesGroupInStagedStore:(id)a3;
- (BOOL)_migrateLegacySlomoAdjustmentsInStore:(id)a3 fromLegacySLMFormat:(BOOL)a4;
- (BOOL)_migrateMetadataAndMigrationHistoryWithStore:(id)a3;
- (BOOL)_migrateOriginalColorSpaceInStagedStore:(id)a3;
- (BOOL)_migrateRejectedFacesGroupInStagedStore:(id)a3;
- (BOOL)_migrateResourceUTIAndCodecInStagedStore:(id)a3;
- (BOOL)_migrateTransformableUUIDsToStringsInStore:(id)a3;
- (BOOL)_migrateVideoKeyFrameTimeValuesInStagedStore:(id)a3;
- (BOOL)_moveCloudSharedDerivativesInStore:(id)a3;
- (BOOL)_moveGpsHorizontalAccuracyToNewAttribute:(id)a3;
- (BOOL)_moveMyPhotoStreamToAlbumsListInStore:(id)a3;
- (BOOL)_nukeWallpaperRemnantsInStore:(id)a3;
- (BOOL)_performChangesOnBatchFetchedObjects:(id)a3 inMOC:(id)a4 batchSize:(unint64_t)a5 objectHandler:(id)a6 error:(id *)a7;
- (BOOL)_performMigrationCacheDateCreatedOnResources:(BOOL)a3 cacheItemIdentifierOnResources:(BOOL)a4 store:(id)a5;
- (BOOL)_persistImportSessionAlbumType:(id)a3;
- (BOOL)_persistMemoriesInStore:(id)a3;
- (BOOL)_persistMetadataToFileSystemForAlbum:(id)a3;
- (BOOL)_persistPersonsInStore:(id)a3;
- (BOOL)_persistPhotoIrisVisibilityStateToDiskInStore:(id)a3;
- (BOOL)_persistPlaceAnnotationData:(id)a3;
- (BOOL)_persistResourceTypeAttributeOnAlternateImageResourcesInStore:(id)a3;
- (BOOL)_persistStoreUUIDToMobileCPLPlist:(id)a3;
- (BOOL)_persistVideoComplPropertiesInStore:(id)a3;
- (BOOL)_populateAdjustmentTimestampsOnAssets:(id)a3;
- (BOOL)_populateAdjustmentsStateForAssetsInStore:(id)a3;
- (BOOL)_populateAlbumAndFolderOrderKeysInStagedStore:(id)a3;
- (BOOL)_populateCloudNameSourceOnFacesInStore:(id)a3;
- (BOOL)_populateCloudResourceLocalStateInStor:(id)a3;
- (BOOL)_populateCloudVerifiedTypeOnPersonsInStore:(id)a3;
- (BOOL)_populateDurationAndHDRTypeFromAdditionalAssetAttributesInStagedStore:(id)a3;
- (BOOL)_populateFaceRegionsInStore:(id)a3;
- (BOOL)_populateLatLongInAsset:(id)a3;
- (BOOL)_populateLightweightReimportDirectoryWithPhotoCloudSharingAssetsInManagedObjectContext:(id)a3 error:(id *)a4;
- (BOOL)_populateNilOriginalFilename:(id)a3;
- (BOOL)_populateNilOriginalFilenameOnMaster:(id)a3;
- (BOOL)_populateRepresentativeAssets:(id)a3;
- (BOOL)_populateUserKeyFacePickSourceForPersonInStore:(id)a3;
- (BOOL)_populateVideoCpFieldsInStagedStore:(id)a3;
- (BOOL)_postProcessFromVersion6006Store:(id)a3;
- (BOOL)_processDeletesForUUIDs:(id)a3;
- (BOOL)_purgeCloudSharedResourcesInStore:(id)a3;
- (BOOL)_rebuildMomentsInStore:(id)a3 deleteExistingMoments:(BOOL)a4 targetedAssetOIDs:(id)a5;
- (BOOL)_rebuildWideCaptureThumbsInStore:(id)a3;
- (BOOL)_reconstructImageExtendedAttributes:(id)a3;
- (BOOL)_recordCurrentVersionMetadataInPersistentStore:(id)a3 migrationType:(int64_t)a4 forceRebuildReason:(id)a5 sourceModelVersion:(id)a6 updateLegacyMigrationState:(BOOL)a7 journalRebuildRequred:(BOOL)a8;
- (BOOL)_recoverSingleBurstPhotos:(id)a3;
- (BOOL)_refactorLargeVideoRecipeResourcesInStore:(id)a3;
- (BOOL)_refreshTriggerValues:(id)a3;
- (BOOL)_regenerateMonthHighlightTitlesWithStore:(id)a3;
- (BOOL)_regenerateReferenceKeyDataInStore:(id)a3;
- (BOOL)_regenerateSharedStreamsDataStoreKeysDataInStore:(id)a3 deferHintChanges:(BOOL)a4;
- (BOOL)_removeAllLocalVideoKeyFrameResourcesRevert14037InStore:(id)a3;
- (BOOL)_removeAutoloopCacheIfExists;
- (BOOL)_removeAutoloopWorkerStatesInStore:(id)a3;
- (BOOL)_removeCameraRollInStore:(id)a3;
- (BOOL)_removeCloudSharedFileAtPath:(id)a3 withFileManager:(id)a4 error:(id *)a5;
- (BOOL)_removeEvents:(id)a3;
- (BOOL)_removeInvalidAdjustmentResourceDataInStore:(id)a3;
- (BOOL)_removeInvalidImportSessionAlbums:(id)a3;
- (BOOL)_removeOldPersonMetadataInStore:(id)a3;
- (BOOL)_removeResourceModelManualIdentityConstraintInStore:(id)a3;
- (BOOL)_removeUnneededAnalysisStateTableEntries:(id)a3;
- (BOOL)_removeUntrackedCloudResourceImageDerivativesInStore:(id)a3;
- (BOOL)_removeUntrackedPersonMetadataInStore:(id)a3;
- (BOOL)_removingDuplicatedCloudAssetGuid:(id)a3;
- (BOOL)_repairCTMOriginalVideosWithSOCAvailableBitInStore:(id)a3;
- (BOOL)_repairCTMOriginalVideosWithoutAdjustmentsInStore:(id)a3;
- (BOOL)_repairReframedAssetsWithoutSOCAvailableBitWithStore:(id)a3;
- (BOOL)_repairWallpaperAlbumsInStore:(id)a3 containerUUID:(id)a4 title:(id)a5;
- (BOOL)_repersistDuplicatedAssets:(id)a3;
- (BOOL)_repushAssetsMatchingPredicate:(id)a3 inStore:(id)a4 withMaster:(BOOL)a5;
- (BOOL)_repushAssetsWithAnyUserConfirmedFaceInStore:(id)a3;
- (BOOL)_repushMemoriesWithNewFeaturesInStore:(id)a3;
- (BOOL)_repushPersonsWithMergeTargetInStore:(id)a3;
- (BOOL)_requestAvailabilityChangeForAssetsMissing1kResourcesInStore:(id)a3;
- (BOOL)_resetAlbumToFolderOrderKeyForAlbums:(id)a3;
- (BOOL)_resetAnalysisStateForVideosInStore:(id)a3;
- (BOOL)_resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore:(id)a3;
- (BOOL)_resetFailedAssets:(id)a3;
- (BOOL)_resetFailedCloudMasters:(id)a3;
- (BOOL)_resetUploadAttempts:(id)a3;
- (BOOL)_retryQuarantinedAssetsAndFixResourceRelation:(id)a3;
- (BOOL)_revalidateImportSessionDates:(id)a3;
- (BOOL)_runMigrationStepWithName:(id)a3 fetchRequest:(id)a4 store:(id)a5 migrationHandler:(id)a6;
- (BOOL)_runMigrationStepWithPrettyFunction:(const char *)a3 store:(id)a4 migrationHandler:(id)a5;
- (BOOL)_runPairingForAssetsInStore:(id)a3;
- (BOOL)_saveChangesToPhotoIrisInStore:(id)a3 matchingPredicate:(id)a4 countChanged:(unint64_t *)a5 error:(id *)a6 changeBlock:(id)a7;
- (BOOL)_scavengeCameraProcessingAdjustmentMetadataForAssetsInStore:(id)a3;
- (BOOL)_setImportedByInPLCloudMaster:(id)a3;
- (BOOL)_setPlaybackStyleForAnimatedGIFsInStore:(id)a3;
- (BOOL)_setUserTypeOnKeyFace:(id)a3;
- (BOOL)_setupRootFolderInStore:(id)a3;
- (BOOL)_shouldTriggerLightweightMigrationFailureForInternalTesting;
- (BOOL)_storeContainsFaceCrops:(id)a3 success:(BOOL *)a4;
- (BOOL)_tagScreenshotsForAssetsInStore:(id)a3;
- (BOOL)_trimInvalidAlbumAssetsMappingRecords;
- (BOOL)_tryToPromoteUnknownAssetsInStore:(id)a3;
- (BOOL)_unquarantineClass:(Class)a3 inManagedObject:(id)a4;
- (BOOL)_unquarantinedQuarantinedItems:(id)a3;
- (BOOL)_updateAlbumDatesInStore:(id)a3;
- (BOOL)_updateCPLMarkerFiles;
- (BOOL)_updateKeyAssetInMemory:(id)a3;
- (BOOL)_updateKindSubtypeForPanoramaPhotosNeedsReset:(BOOL)a3 inStore:(id)a4;
- (BOOL)_updateMissingFileSystemVolumeUuidInStore:(id)a3;
- (BOOL)_updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:(id)a3;
- (BOOL)_updatePlaybackStylesAndVariationsInStore:(id)a3;
- (BOOL)_updatePlaybackWithBatchUpdateRequest:(id)a3 targetDescription:(id)a4 inContext:(id)a5;
- (BOOL)_updateSuggestionStartAndEndDatesInStore:(id)a3;
- (BOOL)_validateOrDeleteFileAtPath:(id)a3 forCloudResource:(id)a4;
- (BOOL)_verifyAndFixBrokenLocalAvailabilityForResourceWithFileIDsInStore:(id)a3;
- (BOOL)_verifyCloudAssetsLocalAvailability:(id)a3;
- (BOOL)clearVisionWorkerCache;
- (BOOL)debug_resetThumbnailsAndInitiateRebuildRequestInStore:(id)a3;
- (BOOL)deleteAllAssetAnalysisStatesInStore:(id)a3;
- (BOOL)deleteAnalysisStatesInStore:(id)a3 forWorkerType:(signed __int16)a4;
- (BOOL)fixPossiblyIncorrectAddedDateForAsset:(id)a3;
- (BOOL)fixupStatesWithUnreachableAssetUUIDsInStore:(id)a3;
- (BOOL)fixupUnknownAnalysisStatesInStore:(id)a3;
- (BOOL)isCloudPhotoLibraryEnabled;
- (BOOL)isLoadingFacesFromFileSystem;
- (BOOL)isPhotoLibraryDatabaseReadyForOpen:(id *)a3;
- (BOOL)markAllDirtyFaceAnalysisStatesWithFaceDetectionWorkerFlagsInStore:(id)a3;
- (BOOL)markAllSceneAnalysisStatesDirtyAndClearDistanceIdentitiesInStoreAndClearSceneprints:(id)a3;
- (BOOL)markUserConfirmedFacesAndCorrespondingFaceAnalysisStatesDirtyInStore:(id)a3;
- (BOOL)migratePurgeableResources;
- (BOOL)postProcessMigratedStore:(id)a3 migrationUUID:(id)a4 fromVersion:(int)a5 progress:(id)a6 progressUnitCount:(unint64_t)a7;
- (BOOL)postProcessThumbnailsOnlyIfVersionMismatchOrMissing:(BOOL *)a3 coordinator:(id)a4;
- (BOOL)processWelterweightMigrationStageOnStore:(id)a3 migrationUUID:(id)a4 fromVersion:(int)a5 toVersion:(int)a6 migrationContext:(id)a7 progress:(id)a8 progressUnitCount:(unint64_t)a9;
- (BOOL)reconsiderAllowedForAnalysisOnAssetsMarkedNotAllowedInStore:(id)a3;
- (BOOL)resetAnalysisStateForVideosWithMoc:(id)a3;
- (BOOL)resetFaceQualityInStore:(id)a3;
- (BOOL)resetManualOrderForNonFavoritePeopleInManagedObjectContext:(id)a3;
- (BOOL)resetManualOrderForNonFavoritePeopleInStore:(id)a3;
- (BOOL)resetRejectedFacesOnAllPersonsInStore:(id)a3;
- (BOOL)shouldCreateDatabase;
- (BOOL)skipDataProtectionForFilePath:(id)a3;
- (BOOL)touchAnalysisStateSortTokensInStoreInStore:(id)a3;
- (BOOL)updateCompletedMigrationStateWithError:(id *)a3;
- (BOOL)validateModelEntityNames:(id *)a3;
- (PLModelMigrator)initWithPathManager:(id)a3;
- (id)_dateForFirstCRVSPhoto;
- (id)_dateForVariations;
- (id)_dateForWideGamutCapture;
- (id)_eventNameFromDate:(id)a3;
- (id)_fetchRequestToIdentifyAdjustedDepthAndVariationsCandidates;
- (id)_fetchRequestToIdentifyBakedInVariationsCandidatesIncludingLongExposure:(BOOL)a3;
- (id)_iTunesPhotosLastSyncMetadata;
- (id)_importFileSystemImportAssets:(id)a3 intoLibrary:(id)a4 type:(unsigned __int8)a5 progress:(id)a6;
- (id)_loadOriginalVideoMetadataFromAsset:(id)a3 timeZoneLookup:(id)a4 error:(id *)a5;
- (id)_migrationThumbnailManagerWithStore:(id)a3;
- (id)_newSyncedPropertiesByAssetUUIDs:(BOOL)a3;
- (id)_orderedAssetsToImportInLibrary:(id)a3;
- (id)_orderedAssetsToImportInLibrary:(id)a3 cameraRollOnly:(BOOL)a4;
- (id)_predicateForInconsistentHeifAssets;
- (id)_syncedPropertiesForAssetUUID:(id)a3;
- (id)archivedAssetUUIDForURL:(id)a3;
- (id)generatePathToAssetUUIDRecoveryMapping;
- (id)managedObjectContextForMigrationInStore:(id)a3 name:(const char *)a4 concurrencyType:(unint64_t)a5;
- (id)managedObjectContextForMigrationWithName:(const char *)a3 persistentStoreCoordinator:(id)a4 concurrencyType:(unint64_t)a5;
- (id)newDeviceRestoreMigrationSupport;
- (id)newShortLivedLibraryForRebuildWithName:(const char *)a3;
- (id)newShortLivedLibraryWithName:(const char *)a3;
- (int)_migrateLegacySlomoAdjustmentsForAsset:(id)a3;
- (int64_t)attemptLightweightMigrationFromVersion:(id)a3 onStore:(id)a4 withMetadata:(id)a5 orStoreURL:(id)a6 options:(id)a7 coordinator:(id)a8 migrationPolicy:(unsigned int)a9 error:(id *)a10;
- (int64_t)checkForceRebuildIndicatorFile;
- (int64_t)createNewDatabaseWithMigrationType:(int64_t)a3 forceRebuildReason:(id)a4 coordinator:(id)a5 error:(id *)a6;
- (int64_t)legacyMigrationState;
- (int64_t)loadFileSystemDataInProgressCount;
- (int64_t)migrateOrCreateDatabaseIfNecessaryWithPersistentContainer:(id)a3 migrationPolicy:(unsigned int)a4 error:(id *)a5;
- (int64_t)promptUserIfNeededForRebuildReason:(id)a3 migrationError:(id)a4;
- (signed)_migrationHistoryOriginFromLatestDataMigration;
- (unint64_t)_assetCountForContext:(id)a3;
- (unint64_t)_assetCountForLibrary:(id)a3;
- (unint64_t)assetCountForStore:(id)a3;
- (void)_addUBFBundleScopedOrderedAssetsToImport:(id)a3 onDiskURLsToSkip:(id)a4;
- (void)_applySyncedProperties:(id)a3 toAsset:(id)a4;
- (void)_convertImplicitDownloadAndKeepOriginalsEnabledToExplicit;
- (void)_failed_recordCurrentVersionMetadata;
- (void)_failed_repairSingletonObjectsInNewDatabaseWithNilContextError:(id)a3;
- (void)_failed_repairSingletonObjectsInNewDatabaseWithNoPersistentStores;
- (void)_failed_repairSingletonObjectsInNewDatabaseWithRepairError:(id)a3;
- (void)_failed_repairSingletonObjectsWithError:(id)a3;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSCoreDataError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleSchemaError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleVersionHashError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreInvalidTypeError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreOpenError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTimeoutError;
- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTypeMismatchError;
- (void)_failed_repairSingletonObjectsWithErrorTypeOtherCoreDataError;
- (void)_failed_repairSingletonObjectsWithErrorTypeOtherPhotosError;
- (void)_failed_repairSingletonObjectsWithErrorTypeOtherSQLiteError;
- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidState;
- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidURL;
- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryRequiresMigration;
- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryTooNew;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_CANTOPEN;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_CORRUPT;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_ERROR;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_FULL;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_LOCKED;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_MISUSE;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_NOTADB;
- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_PERM;
- (void)_failed_repairSingletonObjectsWithInvalidDatabaseFile;
- (void)_failed_repairSingletonObjectsWithInvalidFileTypeLibraryDirectory;
- (void)_failed_repairSingletonObjectsWithMissingDatabaseFile;
- (void)_failed_repairSingletonObjectsWithMissingLibraryDirectory;
- (void)_failed_repairSingletonObjectsWithNilContextError:(id)a3;
- (void)_failed_repairSingletonObjectsWithNoPersistentStores;
- (void)_failed_repairSingletonObjectsWithRepairError:(id)a3;
- (void)_fixIncorrectHeifMetadataForAsset:(id)a3;
- (void)_fixPathForResource:(id)a3 withPath:(id)a4;
- (void)_generateAlbumMetadataFromLastiTunesSyncedPlist;
- (void)_handleCreateOptionsUsingContext:(id)a3;
- (void)_importAfterCrash:(id)a3 completionBlock:(id)a4;
- (void)_importAllDCIMAssetsInLibrary:(id)a3 progress:(id)a4 progressFraction:(id)a5 rebuildComplete:(BOOL)a6;
- (void)_loadFacesFileSystemDataIntoDatabase;
- (void)_loadFileSystemDataIntoDatabaseIfNeededWithReason:(id)a3 progress:(id)a4 requestBackgroundMigrationRegistration:(BOOL *)a5;
- (void)_migratePersonContactInfo;
- (void)_populateFaceRegionsForAsset:(id)a3;
- (void)_prepareForImportDeleteCorruptAssetsWithImporter:(id)a3 context:(id)a4;
- (void)_rebuildAssetsFromJournal:(id)a3 inLibrary:(id)a4 progress:(id)a5 progressFraction:(id)a6;
- (void)_recordCurrentVersionMetadataIfNeededForDataMigrationInPersistentStore:(id)a3;
- (void)_removeFileAt:(id)a3 forResource:(id)a4;
- (void)_repairMetadataAndSingletonsForMigrationType:(int64_t)a3 forceRebuildReason:(id)a4 journalRebuildRequired:(BOOL)a5;
- (void)_repairPotentialModelCorruptionInLibrary:(id)a3;
- (void)_updateImportedSavedAssetTypeForFileSystemImportedAsset:(id)a3 type:(unsigned __int8)a4 importAssetKind:(int)a5 isCPLAssetsDirectory:(BOOL)a6 destinationAlbum:(id)a7;
- (void)_validateCurrentModelVersionAttempt:(int64_t)a3;
- (void)_validateCurrentModelVersionFailedWithMismatchedVersion:(int64_t)a3;
- (void)_validateCurrentModelVersionFailedWithNoVersionFromServer;
- (void)applyDataProtectionToAllPhotosFilesOnce;
- (void)applyDataProtectionToPhotosPaths:(id)a3 fromKeyClass:(int)a4 toKeyClass:(int)a5;
- (void)archiveAssetUUIDForPathPlist:(id)a3;
- (void)cleanupModelForDataMigrationForRestoreType:(int64_t)a3;
- (void)dontImportFileSystemDataIntoDatabaseWithPhotoLibrary:(id)a3;
- (void)filesystemImportResultsUpdateKeywordWithImportedAssets:(id)a3;
- (void)handleGreenChanges:(id)a3;
- (void)importAfterCrash:(id)a3 completionBlock:(id)a4;
- (void)loadFacesFileSystemDataIntoDatabase;
- (void)loadFileSystemAssetsNotifyCompleted:(id)a3;
- (void)loadFileSystemDataIntoDatabaseIfNeededWithReason:(id)a3 completionHandler:(id)a4;
- (void)migratePersonContactInfo;
- (void)postProcessFixesAfterOTARestoreForCompleteAsset:(id)a3 fixAddedDate:(BOOL)a4 isMegaBackup:(BOOL)a5;
- (void)removeUnpairedTimelapsePreviewsInContext:(id)a3 fromDuplicatedUUIDs:(id)a4;
- (void)setLoadingFacesFromFileSystem:(BOOL)a3;
@end

@implementation PLModelMigrator

- (BOOL)reconsiderAllowedForAnalysisOnAssetsMarkedNotAllowedInStore:(id)a3
{
  v23[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) reconsiderAllowedForAnalysisOnAssetsMarkedNotAllowedInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setFetchBatchSize:100];
  v23[0] = @"additionalAttributes";
  v23[1] = @"mediaAnalysisAttributes";
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v23 count:2];
  [v9 setRelationshipKeyPathsForPrefetching:v10];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == NO", @"additionalAttributes.allowedForAnalysis"];
  [v9 setPredicate:v11];

  v12 = [v6 executeFetchRequest:v9 error:0];
  v13 = [v6 enumerateWithIncrementalSaveUsingObjects:v12 withBlock:&__block_literal_global_184];
  [v6 reset];
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v13)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v22 = v13;
      v16 = "Failed to reconsider allowed for analysis for assets marked as not allowed, error: %@";
      v17 = v15;
      v18 = OS_LOG_TYPE_ERROR;
      v19 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v17, v18, v16, buf, v19);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    v16 = "Reconsidered allowed for analysis for assets marked as not allowed.";
    v17 = v15;
    v18 = OS_LOG_TYPE_DEFAULT;
    v19 = 2;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v5);
  return v13 == 0;
}

void __94__PLModelMigrator_AssetAnalysis__reconsiderAllowedForAnalysisOnAssetsMarkedNotAllowedInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 calculateAllowedForAnalysis];
  v4 = [v2 additionalAttributes];

  [v4 setAllowedForAnalysis:v3];
}

- (BOOL)resetAnalysisStateForVideosWithMoc:(id)a3
{
  v18[1] = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v18[0] = @"mediaAnalysisAttributes";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v18 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v7];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K != 0", @"kind", 1, @"videoKeyFrameValue"];
  [v6 setPredicate:v8];

  [v6 setFetchBatchSize:100];
  [v6 setResultType:1];
  v17 = 0;
  v9 = [v3 executeFetchRequest:v6 error:&v17];
  if (v9 && ([MEMORY[0x1E696AE18] predicateWithFormat:@"asset IN %@ AND analysisState = %d", v9, 20], v10 = objc_claimAutoreleasedReturnValue(), v11 = objc_opt_class(), +[PLAssetAnalysisState entityName](PLAssetAnalysisState, "entityName"), v12 = objc_claimAutoreleasedReturnValue(), LODWORD(v11) = objc_msgSend(v11, "executeBatchUpdateWithEntityName:predicate:propertiesToUpdate:managedObjectContext:error:", v12, v10, &unk_1F0FC05C8, v3, 0), v12, v10, v11))
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Reset analysis state for video assets with non-zero bestKeyFrame values", buf, 2u);
    }

    v14 = 1;
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Failed to reset analysis state for video assets with non-zero bestKeyFrame values", buf, 2u);
    }

    v14 = 0;
  }

  return v14;
}

- (BOOL)markUserConfirmedFacesAndCorrespondingFaceAnalysisStatesDirtyInStore:(id)a3
{
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) markUserConfirmedFacesAndCorrespondingFaceAnalysisStatesDirtyInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"nameSource == %d", 1];
  v8 = objc_opt_class();
  v9 = +[PLDetectedFace entityName];
  LODWORD(v8) = [v8 executeBatchUpdateWithEntityName:v9 predicate:v7 propertiesToUpdate:&unk_1F0FC0550 managedObjectContext:v6 error:0];

  if (v8)
  {
    v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(SUBQUERY(asset.detectedFaces, $f, $f.nameSource == %d).@count != 0) AND workerType == %d", 1, 4];
    v11 = MEMORY[0x1E695D5E0];
    v12 = +[PLAssetAnalysisState entityName];
    v13 = [v11 fetchRequestWithEntityName:v12];

    [v13 setResultType:1];
    [v13 setPredicate:v10];
    v27 = 0;
    v14 = [v6 executeFetchRequest:v13 error:&v27];
    v15 = v27;
    v16 = v15;
    if (v14)
    {
      v25 = v15;
      v26 = v5;
      v17 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self IN %@ AND analysisState != %d", v14, 20];
      v18 = objc_opt_class();
      v19 = +[PLAssetAnalysisState entityName];
      LODWORD(v18) = [v18 executeBatchUpdateWithEntityName:v19 predicate:v17 propertiesToUpdate:&unk_1F0FC0578 managedObjectContext:v6 error:0];

      if (v18)
      {
        v20 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self IN %@ AND analysisState = %d", v14, 20];
        v21 = objc_opt_class();
        v22 = +[PLAssetAnalysisState entityName];
        v23 = [v21 executeBatchUpdateWithEntityName:v22 predicate:v20 propertiesToUpdate:&unk_1F0FC05A0 managedObjectContext:v6 error:0];
      }

      else
      {
        v23 = 0;
      }

      v16 = v25;
      v5 = v26;
    }

    else
    {
      v23 = 0;
    }
  }

  else
  {
    v23 = 0;
  }

  objc_autoreleasePoolPop(v5);
  return v23;
}

- (BOOL)markAllDirtyFaceAnalysisStatesWithFaceDetectionWorkerFlagsInStore:(id)a3
{
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) markAllDirtyFaceAnalysisStatesWithFaceDetectionWorkerFlagsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"workerType == %d AND analysisState != %d AND analysisState != %d", 4, 20, 10];
  v8 = +[PLAssetAnalysisState entityName];
  LOBYTE(self) = [objc_opt_class() executeBatchUpdateWithEntityName:v8 predicate:v7 propertiesToUpdate:&unk_1F0FC0528 managedObjectContext:v6 error:0];

  objc_autoreleasePoolPop(v5);
  return self;
}

- (BOOL)resetRejectedFacesOnAllPersonsInStore:(id)a3
{
  v21 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) resetRejectedFacesOnAllPersonsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"rejectedFaces.@count > 0"];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLPerson entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  [v10 setPredicate:v7];
  v18 = 0;
  v11 = [v6 executeFetchRequest:v10 error:&v18];
  v12 = v18;
  if (v11 && ([v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:&__block_literal_global_111_4006], v13 = objc_claimAutoreleasedReturnValue(), v12, (v12 = v13) == 0))
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v16 = [v11 count];
      *buf = 134217984;
      v20 = v16;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Reset rejected faces on %lu persons", buf, 0xCu);
    }

    v15 = 1;
  }

  else
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v20 = v12;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Failed to reset rejected faces with error %@", buf, 0xCu);
    }

    v15 = 0;
  }

  objc_autoreleasePoolPop(v5);
  return v15;
}

void __72__PLModelMigrator_AssetAnalysis__resetRejectedFacesOnAllPersonsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 mutableRejectedFaces];
  [v3 removeAllObjects];

  v4 = [MEMORY[0x1E695DFD8] set];
  [v2 setRejectedFacesNeedingFaceCrops:v4];
}

- (BOOL)clearVisionWorkerCache
{
  v19 = *MEMORY[0x1E69E9840];
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_DEFAULT, "Clearing vision worker cache files...", buf, 2u);
  }

  v4 = [MEMORY[0x1E696AC08] defaultManager];
  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 privateCacheDirectoryWithSubType:5];

  if ([v4 fileExistsAtPath:v6])
  {
    v16 = 0;
    v7 = [v4 removeItemAtPath:v6 error:&v16];
    v8 = v16;
    v9 = PLMigrationGetLog();
    v10 = v9;
    if (v7)
    {
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        v11 = "Cleared vision worker cache files.";
        v12 = v10;
        v13 = OS_LOG_TYPE_DEFAULT;
        v14 = 2;
LABEL_12:
        _os_log_impl(&dword_19BF1F000, v12, v13, v11, buf, v14);
      }
    }

    else if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v18 = v8;
      v11 = "Failed to remove vision worker cache files: %@";
      v12 = v10;
      v13 = OS_LOG_TYPE_ERROR;
      v14 = 12;
      goto LABEL_12;
    }

    goto LABEL_14;
  }

  v8 = PLMigrationGetLog();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "No vision worker cache files found to clear.", buf, 2u);
  }

  v7 = 1;
LABEL_14:

  return v7;
}

- (BOOL)touchAnalysisStateSortTokensInStoreInStore:(id)a3
{
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) touchAnalysisStateSortTokensInStoreInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLAssetAnalysisState entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setFetchBatchSize:100];
  v10 = [v6 executeFetchRequest:v9 error:0];
  v11 = [v6 enumerateWithIncrementalSaveUsingObjects:v10 shouldRefreshAfterSave:1 withBlock:&__block_literal_global_105];
  v12 = v11 == 0;

  objc_autoreleasePoolPop(v5);
  return v12;
}

void __77__PLModelMigrator_AssetAnalysis__touchAnalysisStateSortTokensInStoreInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 sortToken];
  [v2 setSortToken:?];
}

- (BOOL)fixupStatesWithUnreachableAssetUUIDsInStore:(id)a3
{
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) fixupStatesWithUnreachableAssetUUIDsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLAssetAnalysisState entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"asset != nil && assetUUID != asset.uuid"];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 shouldRefreshAfterSave:1 withBlock:&__block_literal_global_4019];
  v13 = v12 == 0;

  objc_autoreleasePoolPop(v5);
  return v13;
}

void __78__PLModelMigrator_AssetAnalysis__fixupStatesWithUnreachableAssetUUIDsInStore___block_invoke(uint64_t a1, void *a2)
{
  v4 = a2;
  v2 = [v4 asset];
  v3 = [v2 uuid];

  if (v3)
  {
    [v4 setAssetUUID:v3];
  }
}

- (BOOL)fixupUnknownAnalysisStatesInStore:(id)a3
{
  v23 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) fixupUnknownAnalysisStatesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = objc_alloc(MEMORY[0x1E695D5E0]);
  v8 = +[PLAssetAnalysisState entityName];
  v9 = [v7 initWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"analysisState = %d", 0];
  [v9 setPredicate:v10];

  v11 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
  v18 = 0;
  v12 = [v6 executeRequest:v11 error:&v18];
  v13 = v18;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v13)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v16 = [v13 userInfo];
      *buf = 138412546;
      v20 = v13;
      v21 = 2112;
      v22 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "fixupUnknownAnalysisStatesInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Deleted all unknown assets states.", buf, 2u);
  }

  objc_autoreleasePoolPop(v5);
  return v13 == 0;
}

- (BOOL)deleteAnalysisStatesInStore:(id)a3 forWorkerType:(signed __int16)a4
{
  v4 = a4;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v6 name:"[PLModelMigrator(AssetAnalysis) deleteAnalysisStatesInStore:forWorkerType:]" concurrencyType:*MEMORY[0x1E695D708]];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"workerType", v4];
  v10 = objc_opt_class();
  v11 = +[PLAssetAnalysisState entityName];
  LOBYTE(v10) = [v10 executeBatchDeleteWithEntityName:v11 predicate:v9 managedObjectContext:v8 error:0];

  objc_autoreleasePoolPop(v7);
  return v10;
}

- (BOOL)deleteAllAssetAnalysisStatesInStore:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) deleteAllAssetAnalysisStatesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = objc_alloc(MEMORY[0x1E695D5E0]);
  v8 = +[PLAssetAnalysisState entityName];
  v9 = [v7 initWithEntityName:v8];

  v10 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
  v17 = 0;
  v11 = [v6 executeRequest:v10 error:&v17];
  v12 = v17;
  v13 = PLMigrationGetLog();
  v14 = v13;
  if (v12)
  {
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v15 = [v12 userInfo];
      *buf = 138412546;
      v19 = v12;
      v20 = 2112;
      v21 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "deleteAllAssetAnalysisStatesInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Deleted all assets states.", buf, 2u);
  }

  objc_autoreleasePoolPop(v5);
  return v12 == 0;
}

- (BOOL)_markAllProcessedAnalysisStatesDirtyForWorkerType:(signed __int16)a3 withStartingWorkerFlags:(int)a4 inStore:(id)a5
{
  v5 = *&a4;
  v6 = a3;
  v17[2] = *MEMORY[0x1E69E9840];
  v8 = a5;
  v9 = objc_autoreleasePoolPush();
  v10 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v8 name:"[PLModelMigrator(AssetAnalysis) _markAllProcessedAnalysisStatesDirtyForWorkerType:withStartingWorkerFlags:inStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"workerType == %ld AND analysisState == %ld", v6, 20];
  v16[0] = @"analysisState";
  v16[1] = @"workerFlags";
  v17[0] = &unk_1F0FBAC60;
  v12 = [MEMORY[0x1E696AD98] numberWithInt:v5];
  v17[1] = v12;
  v13 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v17 forKeys:v16 count:2];

  v14 = +[PLAssetAnalysisState entityName];
  LOBYTE(self) = [objc_opt_class() executeBatchUpdateWithEntityName:v14 predicate:v11 propertiesToUpdate:v13 managedObjectContext:v10 error:0];

  objc_autoreleasePoolPop(v9);
  return self;
}

- (BOOL)resetFaceQualityInStore:(id)a3
{
  v13[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) resetFaceQualityInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"qualityMeasure", 0];
  v12 = @"qualityMeasure";
  v13[0] = &unk_1F0FBAC48;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v13 forKeys:&v12 count:1];
  v9 = objc_opt_class();
  v10 = +[PLDetectedFace entityName];
  LOBYTE(v9) = [v9 executeBatchUpdateWithEntityName:v10 predicate:v7 propertiesToUpdate:v8 managedObjectContext:v6 error:0];

  objc_autoreleasePoolPop(v5);
  return v9;
}

- (BOOL)resetManualOrderForNonFavoritePeopleInStore:(id)a3
{
  v3 = self;
  v4 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:a3 name:"[PLModelMigrator(AssetAnalysis) resetManualOrderForNonFavoritePeopleInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  LOBYTE(v3) = [(PLModelMigrator *)v3 resetManualOrderForNonFavoritePeopleInManagedObjectContext:v4];

  return v3;
}

- (BOOL)resetManualOrderForNonFavoritePeopleInManagedObjectContext:(id)a3
{
  v47[2] = *MEMORY[0x1E69E9840];
  v3 = a3;
  v38 = objc_autoreleasePoolPush();
  v4 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d AND (%K == nil OR %K == %@)", @"type", 1, @"fullName", @"fullName", &stru_1F0F06D80];
  v5 = +[PLPerson fetchRequest];
  v37 = v4;
  [v5 setPredicate:v4];
  v6 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"faceCount" ascending:0];
  v47[0] = v6;
  v7 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"personUUID" ascending:1];
  v47[1] = v7;
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v47 count:2];

  [v5 setSortDescriptors:v8];
  v41 = 0;
  v9 = [v3 executeFetchRequest:v5 error:&v41];
  v10 = v41;
  if (!v9)
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      *buf = 136315394;
      v44 = "[PLModelMigrator(AssetAnalysis) resetManualOrderForNonFavoritePeopleInManagedObjectContext:]";
      v45 = 2112;
      v46 = v10;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%s failed to fetch unnamed persons with error %@", buf, 0x16u);
    }

    v17 = 0;
    v27 = 0;
    v12 = v5;
    v16 = v8;
    v19 = v3;
    goto LABEL_25;
  }

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d AND %K != nil AND %K != %@", @"type", 1, @"fullName", @"fullName", &stru_1F0F06D80];
  v12 = +[PLPerson fetchRequest];

  [v12 setPredicate:v11];
  v13 = [objc_alloc(MEMORY[0x1E696AEB0]) initWithKey:@"fullName" ascending:1 selector:sel_localizedCaseInsensitiveCompare_];
  v42[0] = v13;
  v14 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"faceCount" ascending:0];
  v42[1] = v14;
  v15 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"personUUID" ascending:1];
  v42[2] = v15;
  v16 = [MEMORY[0x1E695DEC8] arrayWithObjects:v42 count:3];

  [v12 setSortDescriptors:v16];
  v40 = v10;
  v17 = [v3 executeFetchRequest:v12 error:&v40];
  v18 = v40;

  v19 = v3;
  if (!v17)
  {
    v34 = PLMigrationGetLog();
    v35 = v38;
    if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
    {
      *buf = 136315394;
      v44 = "[PLModelMigrator(AssetAnalysis) resetManualOrderForNonFavoritePeopleInManagedObjectContext:]";
      v45 = 2112;
      v46 = v18;
      _os_log_impl(&dword_19BF1F000, v34, OS_LOG_TYPE_ERROR, "%s failed to fetch named persons with error %@", buf, 0x16u);
    }

    v17 = 0;
    v27 = 0;
    v10 = v18;
    goto LABEL_26;
  }

  if (![v9 count] && !objc_msgSend(v17, "count"))
  {
    v27 = 1;
    v35 = v38;
    goto LABEL_27;
  }

  v20 = v3;
  v21 = 4294966271;
  v22 = [v9 count];
  v23 = [v17 count] + v22;
  if (v23)
  {
    v21 = 0xFFFFFBFF / v23;
  }

  if (v21 <= 1)
  {
    v24 = 1;
  }

  else
  {
    v24 = v21;
  }

  v25 = 1024;
  do
  {
    v26 = v25;
    v25 >>= 1;
  }

  while (v26 > v24);
  v11 = [v17 arrayByAddingObjectsFromArray:v9];
  v39[0] = MEMORY[0x1E69E9820];
  v39[1] = 3221225472;
  v39[2] = __93__PLModelMigrator_AssetAnalysis__resetManualOrderForNonFavoritePeopleInManagedObjectContext___block_invoke;
  v39[3] = &__block_descriptor_40_e25_v32__0__PLPerson_8Q16_B24l;
  v39[4] = v26;
  v19 = v20;
  v10 = [v20 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v39];

  v27 = v10 == 0;
  v28 = PLMigrationGetLog();
  v29 = v28;
  if (v10)
  {
    if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
    {
      *buf = 136315394;
      v44 = "[PLModelMigrator(AssetAnalysis) resetManualOrderForNonFavoritePeopleInManagedObjectContext:]";
      v45 = 2112;
      v46 = v10;
      v30 = "%s failed to save with error %@";
      v31 = v29;
      v32 = OS_LOG_TYPE_ERROR;
      v33 = 22;
LABEL_23:
      _os_log_impl(&dword_19BF1F000, v31, v32, v30, buf, v33);
    }
  }

  else if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v44 = v23;
    v30 = "Sorted %lu non-favorite persons";
    v31 = v29;
    v32 = OS_LOG_TYPE_DEFAULT;
    v33 = 12;
    goto LABEL_23;
  }

LABEL_25:
  v35 = v38;
LABEL_26:

  v18 = v10;
LABEL_27:

  objc_autoreleasePoolPop(v35);
  return v27;
}

uint64_t __93__PLModelMigrator_AssetAnalysis__resetManualOrderForNonFavoritePeopleInManagedObjectContext___block_invoke(uint64_t a1, void *a2, uint64_t a3)
{
  if ((*(a1 + 32) * a3) >= 0xFFFFFFFE)
  {
    v3 = 4294967294;
  }

  else
  {
    v3 = *(a1 + 32) * a3;
  }

  return [a2 setManualOrder:v3];
}

- (BOOL)markAllSceneAnalysisStatesDirtyAndClearDistanceIdentitiesInStoreAndClearSceneprints:(id)a3
{
  v43[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = *MEMORY[0x1E695D708];
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) markAllSceneAnalysisStatesDirtyAndClearDistanceIdentitiesInStoreAndClearSceneprints:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D560];
  v9 = +[PLAdditionalAssetAttributes entityName];
  v10 = [v8 batchUpdateRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"distanceIdentity != nil"];
  [v10 setPredicate:v11];

  v42 = @"distanceIdentity";
  v12 = [MEMORY[0x1E696ABC8] expressionForConstantValue:0];
  v43[0] = v12;
  v13 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v43 forKeys:&v42 count:1];
  [v10 setPropertiesToUpdate:v13];

  [v10 setResultType:0];
  v39 = 0;
  v14 = [v7 executeRequest:v10 error:&v39];
  v15 = v39;
  v16 = v14 != 0;
  if (!v14)
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v41 = v15;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "Batch update request failed, setting distance identities to nil, error: %@", buf, 0xCu);
    }
  }

  [v7 reset];

  objc_autoreleasePoolPop(v5);
  v18 = objc_autoreleasePoolPush();
  v19 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator(AssetAnalysis) markAllSceneAnalysisStatesDirtyAndClearDistanceIdentitiesInStoreAndClearSceneprints:]" concurrencyType:v6];
  v20 = MEMORY[0x1E695D5E0];
  v21 = +[PLSceneprint entityName];
  v22 = [v20 fetchRequestWithEntityName:v21];

  [v22 setFetchBatchSize:100];
  v38 = 0;
  v23 = [v19 executeFetchRequest:v22 error:&v38];
  v24 = v38;
  if (v23)
  {
    v25 = [v23 count];
    v36[0] = MEMORY[0x1E69E9820];
    v36[1] = 3221225472;
    v36[2] = __118__PLModelMigrator_AssetAnalysis__markAllSceneAnalysisStatesDirtyAndClearDistanceIdentitiesInStoreAndClearSceneprints___block_invoke;
    v36[3] = &unk_1E75657A0;
    v37 = v19;
    v26 = [v37 enumerateWithIncrementalSaveUsingObjects:v23 withBlock:v36];

    v27 = PLMigrationGetLog();
    v28 = v27;
    if (v26)
    {
      if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v41 = v26;
        v29 = "Failed to delete sceneprint with error: %@";
        v30 = v28;
        v31 = OS_LOG_TYPE_ERROR;
LABEL_14:
        _os_log_impl(&dword_19BF1F000, v30, v31, v29, buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v41 = v25;
      v29 = "Deleted %lu sceneprints";
      v30 = v28;
      v31 = OS_LOG_TYPE_DEFAULT;
      goto LABEL_14;
    }

    v32 = v37;
    goto LABEL_16;
  }

  v32 = PLMigrationGetLog();
  if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v41 = v24;
    _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_ERROR, "Failed to fetch Sceneprints with error: %@", buf, 0xCu);
  }

  v16 = 0;
  v26 = v24;
LABEL_16:

  objc_autoreleasePoolPop(v18);
  v33 = PLMigrationGetLog();
  if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
  {
    v34 = @"NO";
    if (v16)
    {
      v34 = @"YES";
    }

    *buf = 138412290;
    v41 = v34;
    _os_log_impl(&dword_19BF1F000, v33, OS_LOG_TYPE_DEFAULT, "Performed scene analysis reset, success: %@", buf, 0xCu);
  }

  return v16;
}

+ (BOOL)performFaceAnalysisResetWithResetLevel:(int64_t)a3 pathManager:(id)a4 context:(id)a5
{
  v37[1] = *MEMORY[0x1E69E9840];
  v7 = a4;
  v8 = a5;
  if (a3 < 1)
  {
    v14 = 1;
    goto LABEL_22;
  }

  v36 = @"faceAdjustmentVersion";
  v9 = [MEMORY[0x1E695DFB0] null];
  v37[0] = v9;
  v10 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v37 forKeys:&v36 count:1];

  v11 = +[PLManagedAsset entityName];
  v29 = 0;
  v12 = [PLModelMigrator executeBatchUpdateWithEntityName:v11 predicate:0 propertiesToUpdate:v10 managedObjectContext:v8 error:&v29];
  v13 = v29;

  if (!v12)
  {
    v15 = PLBackendGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v31 = v13;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Failed to batch reset faceAdjustmentVersion: %@", buf, 0xCu);
    }

    v14 = 0;
    goto LABEL_21;
  }

  if (a3 != 1)
  {
    context = objc_autoreleasePoolPush();
    v16 = +[PLDetectedFaceGroup entityName];
    v17 = [PLModelMigrator executeBatchDeleteWithEntityName:v16 predicate:0 managedObjectContext:v8 error:0];

    if (!v17)
    {
      v18 = PLBackendGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v31 = 0;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Failed to batch delete face groups %@", buf, 0xCu);
      }
    }

    v34 = @"state";
    v35 = &unk_1F0FBACD8;
    v19 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v35 forKeys:&v34 count:1];
    if (v17)
    {
      v20 = +[PLFaceCrop entityName];
      v28 = 0;
      v21 = [PLModelMigrator executeBatchUpdateWithEntityName:v20 predicate:0 propertiesToUpdate:v19 managedObjectContext:v8 error:&v28];
      v22 = v28;

      if (v21)
      {
        v14 = 1;
LABEL_20:

        objc_autoreleasePoolPop(context);
        goto LABEL_21;
      }
    }

    else
    {
      v22 = 0;
    }

    v23 = PLBackendGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v31 = v22;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "Failed to batch set face crops to dirty: %@", buf, 0xCu);
    }

    v14 = 0;
    goto LABEL_20;
  }

  v14 = 1;
LABEL_21:

LABEL_22:
  v24 = PLBackendGetLog();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
  {
    v25 = @"NO";
    if (v14)
    {
      v25 = @"YES";
    }

    *buf = 134218242;
    v31 = a3;
    v32 = 2112;
    v33 = v25;
    _os_log_impl(&dword_19BF1F000, v24, OS_LOG_TYPE_INFO, "Performed face analysis reset with level: %lu, success: %@", buf, 0x16u);
  }

  return v14;
}

- (BOOL)_migrateResourceUTIAndCodecInStagedStore:(id)a3
{
  v43 = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v28 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _migrateResourceUTIAndCodecInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [PLPersistentHistoryTransactionModifiers transactionAuthorFromChangeSource:2];
  [v5 setTransactionAuthor:v6];

  [PLCloudMaster deleteOrphanedMastersWithManagedObjectContext:v5];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLInternalResource entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF9E8];
  v37 = 0;
  v38 = &v37;
  v39 = 0x3020000000;
  v40 = 0;
  v10 = [MEMORY[0x1E696AEC0] stringWithUTF8String:"-[PLModelMigrator _migrateResourceUTIAndCodecInStagedStore:]"];
  v11 = [v5 pathManager];
  v12 = [v5 persistentStoreCoordinator];
  v13 = [v5 transactionAuthor];
  v14 = [PLEnumerateAndSaveController alloc];
  v32[0] = MEMORY[0x1E69E9820];
  v32[1] = 3221225472;
  v32[2] = __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke;
  v32[3] = &unk_1E756C520;
  v15 = v10;
  v33 = v15;
  v16 = v12;
  v34 = v16;
  v17 = v11;
  v35 = v17;
  v18 = v13;
  v36 = v18;
  v31[0] = MEMORY[0x1E69E9820];
  v31[1] = 3221225472;
  v31[2] = __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke_3;
  v31[3] = &unk_1E7569880;
  v31[4] = &v37;
  v19 = [(PLEnumerateAndSaveController *)v14 initWithName:@"migrateUTIAndCodec" fetchRequest:v9 context:v5 options:5 generateContextBlock:v32 didFetchObjectIDsBlock:0 processResultBlock:v31];
  v30 = 0;
  v20 = [(PLEnumerateAndSaveController *)v19 processObjectsWithError:&v30];
  v21 = v30;
  if (v20)
  {
    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      v23 = atomic_load(v38 + 10);
      *buf = 134217984;
      v42 = v23;
      v24 = "Reset %ld asset image request hints.";
      v25 = v22;
      v26 = OS_LOG_TYPE_DEFAULT;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v25, v26, v24, buf, 0xCu);
    }
  }

  else
  {
    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v42 = v21;
      v24 = "Error resetting image request hints, %@";
      v25 = v22;
      v26 = OS_LOG_TYPE_ERROR;
      goto LABEL_6;
    }
  }

  _Block_object_dispose(&v37, 8);
  objc_autoreleasePoolPop(context);

  return v20;
}

id __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke(uint64_t a1)
{
  v2 = [objc_alloc(MEMORY[0x1E695D628]) initWithConcurrencyType:1];
  [v2 setName:*(a1 + 32)];
  [v2 setPersistentStoreCoordinator:*(a1 + 40)];
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke_2;
  v7[3] = &unk_1E75761B8;
  v3 = v2;
  v8 = v3;
  v9 = *(a1 + 48);
  v10 = *(a1 + 56);
  [v3 performBlockAndWait:v7];
  v4 = v10;
  v5 = v3;

  return v3;
}

void __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke_3(uint64_t a1, uint64_t a2, void *a3)
{
  v9 = a3;
  v4 = [v9 valueForKeyPath:@"uniformTypeIdentifier.identifier"];
  if ([v4 length])
  {
    v5 = [PLUniformTypeIdentifier utiWithIdentifier:v4];
    [v9 willChangeValueForKey:@"compactUTI"];
    v6 = [v5 compactRepresentation];
    [v9 setPrimitiveValue:v6 forKey:@"compactUTI"];

    [v9 didChangeValueForKey:@"compactUTI"];
    [v9 willChangeValueForKey:@"utiConformanceHint"];
    v7 = [MEMORY[0x1E696AD98] numberWithShort:{objc_msgSend(v5, "conformanceHint")}];
    [v9 setPrimitiveValue:v7 forKey:@"utiConformanceHint"];

    [v9 didChangeValueForKey:@"utiConformanceHint"];
  }

  v8 = [v9 valueForKeyPath:@"codec.fourCharCodeName"];
  if ([v8 length])
  {
    [v9 willChangeValueForKey:@"codecFourCharCodeName"];
    [v9 setPrimitiveValue:v8 forKey:@"codecFourCharCodeName"];
    [v9 didChangeValueForKey:@"codecFourCharCodeName"];
  }

  atomic_fetch_add((*(*(a1 + 32) + 8) + 40), 1u);
}

uint64_t __60__PLModelMigrator__migrateResourceUTIAndCodecInStagedStore___block_invoke_2(uint64_t a1)
{
  v2 = *(a1 + 40);
  v3 = [*(a1 + 32) userInfo];
  [v3 setObject:v2 forKeyedSubscript:@"com.apple.photos.PLModelMigratorPathManagerKey"];

  v4 = *(a1 + 48);
  v5 = *(a1 + 32);

  return [v5 setTransactionAuthor:v4];
}

BOOL __61__PLModelMigrator__discardUnusedCustomRenderedValuesInStore___block_invoke(uint64_t a1, void *a2)
{
  v18[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = a2;
  v4 = +[PLManagedAsset entityName];
  v5 = [v2 batchUpdateRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(NOT %K IN %@) AND (%K == %d)", @"hdrType", &unk_1F0FBF9D0, @"kind", 0];
  [v5 setPredicate:v6];
  v17 = @"hdrType";
  v18[0] = &unk_1F0FBBE00;
  v7 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v18 forKeys:&v17 count:1];
  [v5 setPropertiesToUpdate:v7];

  [v5 setResultType:2];
  v14 = 0;
  v8 = [v3 executeRequest:v5 error:&v14];

  v9 = v14;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v16 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Discard unused customRenderedValue successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v16 = v9;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Batch update request failed, setting customRenderedValue: %@", buf, 0xCu);
  }

  return v8 != 0;
}

- (BOOL)_deleteLocalVideoKeyFrameResourcesForNonVideosInStore:(id)a3 deferHintChanges:(BOOL)a4
{
  v5[0] = MEMORY[0x1E69E9820];
  v5[1] = 3221225472;
  v5[2] = __90__PLModelMigrator__deleteLocalVideoKeyFrameResourcesForNonVideosInStore_deferHintChanges___block_invoke;
  v5[3] = &__block_descriptor_33_e32_B16__0__NSManagedObjectContext_8l;
  v6 = a4;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _deleteLocalVideoKeyFrameResourcesForNonVideosInStore:deferHintChanges:]" store:a3 migrationHandler:v5];
}

uint64_t __90__PLModelMigrator__deleteLocalVideoKeyFrameResourcesForNonVideosInStore_deferHintChanges___block_invoke(uint64_t a1, void *a2)
{
  v33[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v23 = 0;
  v24 = &v23;
  v25 = 0x2020000000;
  v26 = 0;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLInternalResource entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K != %d", @"recipeID", 65749, @"asset.kind", 1];
  [v6 setPredicate:v7];
  v33[0] = @"asset";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v33 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v22 = 0;
  v9 = [v3 executeFetchRequest:v6 error:&v22];
  v10 = v22;
  if (v9 && (v18[0] = MEMORY[0x1E69E9820], v18[1] = 3221225472, v18[2] = __90__PLModelMigrator__deleteLocalVideoKeyFrameResourcesForNonVideosInStore_deferHintChanges___block_invoke_2, v18[3] = &unk_1E7569838, v11 = v3, v21 = *(a1 + 32), v19 = v11, v20 = &v23, [v11 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:v18], v12 = objc_claimAutoreleasedReturnValue(), v10, v19, (v10 = v12) == 0))
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v16 = v24[3];
      *buf = 134217984;
      v28 = v16;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Deleted %lu video key frame resources on non-video assets", buf, 0xCu);
    }

    v10 = 0;
    v15 = 1;
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v10 userInfo];
      *buf = 136446722;
      v28 = "[PLModelMigrator _deleteLocalVideoKeyFrameResourcesForNonVideosInStore:deferHintChanges:]_block_invoke";
      v29 = 2112;
      v30 = v10;
      v31 = 2112;
      v32 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%{public}s: failed: %@ %@", buf, 0x20u);
    }

    v15 = 0;
  }

  _Block_object_dispose(&v23, 8);
  return v15;
}

void __90__PLModelMigrator__deleteLocalVideoKeyFrameResourcesForNonVideosInStore_deferHintChanges___block_invoke_2(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 asset];
  v5 = [MEMORY[0x1E696AC08] defaultManager];
  v6 = [v4 pathForLocalVideoKeyFrame];
  v12 = 0;
  v7 = [v5 removeItemAtPath:v6 error:&v12];
  v8 = v12;

  if ((v7 & 1) == 0 && (PLIsErrorFileNotFound() & 1) == 0)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = [v4 pathForLocalVideoKeyFrame];
      v11 = [v8 userInfo];
      *buf = 136446978;
      v14 = "[PLModelMigrator _deleteLocalVideoKeyFrameResourcesForNonVideosInStore:deferHintChanges:]_block_invoke_2";
      v15 = 2112;
      v16 = v10;
      v17 = 2112;
      v18 = v8;
      v19 = 2112;
      v20 = v11;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "%{public}s: failed to remove file at path: %@ error: %@ %@", buf, 0x2Au);
    }
  }

  if ([v3 isLocallyAvailable])
  {
    [v3 markAsNotLocallyAvailable];
    [*(a1 + 32) deleteObject:v3];
    if ((*(a1 + 48) & 1) == 0)
    {
      [v4 recalculateImageRequestHints];
    }
  }

  else
  {
    [*(a1 + 32) deleteObject:v3];
  }

  ++*(*(*(a1 + 40) + 8) + 24);
}

- (BOOL)_deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __80__PLModelMigrator__deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore___block_invoke;
  v4[3] = &unk_1E7569168;
  v4[4] = self;
  v4[5] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __80__PLModelMigrator__deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore___block_invoke(uint64_t a1, void *a2)
{
  v25 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedFolder entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K = %@", @"kind", 4000, @"cloudGUID", @"----Project-Root-Folder----"];
  [v6 setPredicate:v7];

  v17[0] = MEMORY[0x1E69E9820];
  v17[1] = 3221225472;
  v17[2] = __80__PLModelMigrator__deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore___block_invoke_2;
  v17[3] = &unk_1E7569810;
  v17[4] = *(a1 + 32);
  v18 = 0;
  v8 = [v3 enumerateObjectsFromFetchRequest:v6 count:&v18 usingDefaultBatchSizeWithBlock:v17];
  if ([v3 hasChanges])
  {
    v16 = 0;
    v9 = [v3 save:&v16];
    v10 = v16;
    v11 = PLMigrationGetLog();
    v12 = v11;
    if (v9)
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v20 = v18;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Deleted %lu empty project root folder with wrong folder kind", buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v13 = NSStringFromSelector(*(a1 + 40));
      v14 = [v10 userInfo];
      *buf = 138543874;
      v20 = v13;
      v21 = 2112;
      v22 = v10;
      v23 = 2112;
      v24 = v14;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v9 = 1;
  }

  return v9;
}

void __80__PLModelMigrator__deleteEmptyFolderWithProjectRootCloudGUIDOfWrongKindInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  [v3 delete];
  v4 = [*(a1 + 32) pathManager];
  [v3 removePersistedFileSystemDataWithPathManager:v4];
}

uint64_t __66__PLModelMigrator__repairDuplicateSingletonFetchingAlbumsInStore___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = MEMORY[0x1E695D5E0];
  v4 = +[PLFetchingAlbum entityName];
  v5 = [v3 fetchRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"kind", 1507];
  [v5 setPredicate:v6];

  v7 = objc_alloc_init(MEMORY[0x1E695DFA8]);
  v8 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __66__PLModelMigrator__repairDuplicateSingletonFetchingAlbumsInStore___block_invoke_2;
  v21[3] = &unk_1E75697E8;
  v9 = v7;
  v22 = v9;
  v10 = v8;
  v23 = v10;
  v11 = [v2 enumerateObjectsFromFetchRequest:v5 count:0 usingDefaultBatchSizeWithBlock:v21];
  if (v11)
  {
LABEL_2:
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446466;
      v25 = "[PLModelMigrator _repairDuplicateSingletonFetchingAlbumsInStore:]_block_invoke";
      v26 = 2112;
      v27 = v11;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}s: failed with error: %@", buf, 0x16u);
    }

    v13 = 0;
    goto LABEL_12;
  }

  if ([v10 count])
  {
    v14 = [objc_alloc(MEMORY[0x1E695D538]) initWithObjectIDs:v10];
    [v14 setResultType:2];
    v20 = 0;
    v15 = [v2 executeRequest:v14 error:&v20];
    v11 = v20;
    if (!v15)
    {
      v19 = PLMigrationGetLog();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v25 = v11;
        _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "Failed to delete duplicate singleton fetching albums: %@", buf, 0xCu);
      }

      goto LABEL_2;
    }

    v16 = [v15 result];
    v17 = [v16 unsignedIntegerValue];
  }

  else
  {
    v17 = 0;
    v11 = 0;
  }

  v12 = PLMigrationGetLog();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v25 = v17;
    _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Removed %lu duplicate singleton fetching albums", buf, 0xCu);
  }

  v13 = 1;
LABEL_12:

  return v13;
}

void __66__PLModelMigrator__repairDuplicateSingletonFetchingAlbumsInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = *(a1 + 32);
  v4 = a2;
  v5 = [v4 kind];
  LOBYTE(v3) = [v3 containsObject:v5];

  if (v3)
  {
    v6 = *(a1 + 40);
    [v4 objectID];
  }

  else
  {
    v6 = *(a1 + 32);
    [v4 kind];
  }
  v7 = ;

  [v6 addObject:v7];
}

BOOL __57__PLModelMigrator__resetLimitedLibraryFilterDataInStore___block_invoke(uint64_t a1, void *a2)
{
  v18[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = a2;
  v4 = +[PLLimitedLibraryFetchFilter entityName];
  v5 = [v2 batchUpdateRequestWithEntityName:v4];

  v17 = @"fetchFilterData";
  v6 = [MEMORY[0x1E695DEF0] data];
  v18[0] = v6;
  v7 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v18 forKeys:&v17 count:1];
  [v5 setPropertiesToUpdate:v7];

  [v5 setResultType:2];
  v14 = 0;
  v8 = [v3 executeRequest:v5 error:&v14];

  v9 = v14;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v16 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Reset limited-library fetchFilterData successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v16 = v9;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Batch update request failed, resetting limited-library fetchFilterData, error: %@", buf, 0xCu);
  }

  return v8 != 0;
}

BOOL __56__PLModelMigrator__unQuarantineAssetsIfPossibleInStore___block_invoke(uint64_t a1, void *a2)
{
  v24[3] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = MEMORY[0x1E695D5E0];
  v4 = +[PLManagedAsset entityName];
  v5 = [v3 fetchRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K == %d", @"cloudLocalState", 4, @"master.cloudLocalState", 4];
  [v5 setPredicate:v6];

  v24[0] = @"master";
  v24[1] = @"modernResources";
  v24[2] = @"master.assets";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v24 count:3];
  [v5 setRelationshipKeyPathsForPrefetching:v7];

  [v5 setFetchBatchSize:100];
  v16 = 0;
  v17 = &v16;
  v18 = 0x2020000000;
  v19 = 0;
  v15 = 0;
  v8 = [v2 executeFetchRequest:v5 error:&v15];
  v9 = v15;
  if (v8)
  {
    v14[0] = MEMORY[0x1E69E9820];
    v14[1] = 3221225472;
    v14[2] = __56__PLModelMigrator__unQuarantineAssetsIfPossibleInStore___block_invoke_2;
    v14[3] = &unk_1E7568EB0;
    v14[4] = &v16;
    v10 = [v2 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v14];

    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = v17[3];
      *buf = 134217984;
      v21 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Un-quarantined %lu assets", buf, 0xCu);
    }
  }

  else
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446466;
      v21 = "[PLModelMigrator _unQuarantineAssetsIfPossibleInStore:]_block_invoke";
      v22 = 2112;
      v23 = v9;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%{public}s: failed with error: %@", buf, 0x16u);
    }

    v10 = v9;
  }

  _Block_object_dispose(&v16, 8);
  return v8 != 0;
}

uint64_t __56__PLModelMigrator__unQuarantineAssetsIfPossibleInStore___block_invoke_2(uint64_t a1, void *a2)
{
  result = [a2 unQuarantineIfPossible];
  if (result)
  {
    ++*(*(*(a1 + 32) + 8) + 24);
  }

  return result;
}

- (void)_convertImplicitDownloadAndKeepOriginalsEnabledToExplicit
{
  v8 = *MEMORY[0x1E69E9840];
  v2 = PLReadCloudPhotoLibraryKeepOriginalsEnabled_Legacy();
  if (!v2)
  {
    v3 = PLIsEDUMode();
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = @"download and keep originals";
      if (v3)
      {
        v5 = @"optimize storage";
      }

      v6 = 138412290;
      v7 = v5;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_DEFAULT, "Converting implicit to explicit iCPL mode in defaults: %@", &v6, 0xCu);
    }

    PLWriteCloudPhotoLibraryKeepOriginalsEnabled_Legacy(v3 ^ 1u);
  }
}

BOOL __62__PLModelMigrator__convertAssetDepthStatesToDepthTypeInStore___block_invoke(uint64_t a1, void *a2)
{
  v18[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = a2;
  v4 = +[PLManagedAsset entityName];
  v5 = [v2 batchUpdateRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(%K = %d) OR (%K = %d) OR (%K = %d) OR (%K = %d)", @"depthType", 2, @"depthType", 3, @"hdrType", 7, @"hdrType", 8];
  [v5 setPredicate:v6];

  v17 = @"depthType";
  v18[0] = &unk_1F0FBBDE8;
  v7 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v18 forKeys:&v17 count:1];
  [v5 setPropertiesToUpdate:v7];

  [v5 setResultType:2];
  v14 = 0;
  v8 = [v3 executeRequest:v5 error:&v14];

  v9 = v14;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v16 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Convert asset depth states to depth type successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v16 = v9;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Batch update request failed, setting depthType: %@", buf, 0xCu);
  }

  return v8 != 0;
}

- (BOOL)_updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke;
  v4[3] = &unk_1E7569528;
  v4[4] = self;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v71[2] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v37 = objc_alloc_init(MEMORY[0x1E69C08E8]);
  v61[0] = 0;
  v61[1] = v61;
  v61[2] = 0x2020000000;
  v62 = 0;
  v57 = 0;
  v58 = &v57;
  v59 = 0x2020000000;
  v60 = 0;
  v53 = 0;
  v54 = &v53;
  v55 = 0x2020000000;
  v56 = 0;
  v49 = 0;
  v50 = &v49;
  v51 = 0x2020000000;
  v52 = 0;
  v3 = MEMORY[0x1E695D5E0];
  v4 = +[PLManagedAsset entityName];
  v5 = [v3 fetchRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K == %d", @"kindSubtype", 101, @"kind", 1];
  [v5 setPredicate:v6];

  [v5 setFetchBatchSize:100];
  v71[0] = @"additionalAttributes.unmanagedAdjustment";
  v71[1] = @"master.mediaMetadata";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v71 count:2];
  [v5 setRelationshipKeyPathsForPrefetching:v7];

  v48 = 0;
  v8 = [v2 executeFetchRequest:v5 error:&v48];
  v9 = v48;
  if (!v8)
  {
    goto LABEL_11;
  }

  v10 = PLMigrationGetLog();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = [v8 count];
    *buf = 134217984;
    v64 = v11;
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Adding hfr state for %lu existing Mogul assets", buf, 0xCu);
  }

  v43[0] = MEMORY[0x1E69E9820];
  v43[1] = 3221225472;
  v43[2] = __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke_2625;
  v43[3] = &unk_1E75726E8;
  v12 = *(a1 + 32);
  v45 = &v57;
  v43[4] = v12;
  v13 = v37;
  v44 = v13;
  v46 = v61;
  v47 = &v53;
  v14 = [v2 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v43];

  if (v14)
  {
    v9 = v14;
LABEL_12:
    v29 = PLMigrationGetLog();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v30 = [v9 userInfo];
      *buf = 136315650;
      v64 = "[PLModelMigrator _updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:]_block_invoke";
      v65 = 2112;
      v66 = v9;
      v67 = 2112;
      v68 = v30;
      _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
    }

    v31 = 0;
    goto LABEL_15;
  }

  v15 = MEMORY[0x1E695D5E0];
  v16 = +[PLManagedAsset entityName];
  v5 = [v15 fetchRequestWithEntityName:v16];

  v17 = MEMORY[0x1E696AB28];
  v18 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:0];
  v70[0] = v18;
  v19 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kind", 1];
  v70[1] = v19;
  v20 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"kindSubtype", 101];
  v70[2] = v20;
  v21 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForUpdateMogulSubtypeExclusions"), 1}];
  v70[3] = v21;
  v22 = [MEMORY[0x1E695DEC8] arrayWithObjects:v70 count:4];
  v23 = [v17 andPredicateWithSubpredicates:v22];
  [v5 setPredicate:v23];

  [v5 setFetchBatchSize:100];
  v69 = @"master.mediaMetadata";
  v24 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v69 count:1];
  [v5 setRelationshipKeyPathsForPrefetching:v24];

  v42 = 0;
  v25 = [v2 executeFetchRequest:v5 error:&v42];
  v9 = v42;
  if (!v25)
  {
LABEL_11:

    goto LABEL_12;
  }

  v26 = PLMigrationGetLog();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    v27 = [v25 count];
    *buf = 134217984;
    v64 = v27;
    _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "Checking %lu non-Mogul adjusted videos if original is slomo (and if so update kindSubtype and hfr state)", buf, 0xCu);
  }

  v38[0] = MEMORY[0x1E69E9820];
  v38[1] = 3221225472;
  v38[2] = __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke_2627;
  v38[3] = &unk_1E756DBE0;
  v38[4] = *(a1 + 32);
  v39 = v13;
  v40 = v61;
  v41 = &v49;
  v28 = [v2 enumerateWithIncrementalSaveUsingObjects:v25 withBlock:v38];

  if (v28)
  {
    v9 = v28;
    goto LABEL_12;
  }

  v29 = PLMigrationGetLog();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
  {
    v33 = v58[3];
    v34 = v54[3];
    v35 = v50[3];
    *buf = 134218496;
    v64 = v33;
    v65 = 2048;
    v66 = v34;
    v67 = 2048;
    v68 = v35;
    _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_DEFAULT, "updated %lu standard slomo assets, %lu nonstandard adjusted slomo assets, %lu original-only slomo assets", buf, 0x20u);
  }

  v9 = 0;
  v31 = 1;
LABEL_15:

  _Block_object_dispose(&v49, 8);
  _Block_object_dispose(&v53, 8);
  _Block_object_dispose(&v57, 8);
  _Block_object_dispose(v61, 8);

  return v31;
}

void __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke_2625(void *a1, void *a2)
{
  v30 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E69C0910];
  v5 = [v3 additionalAttributes];
  v6 = [v5 unmanagedAdjustment];
  v7 = [v6 adjustmentFormatIdentifier];
  v8 = [v3 additionalAttributes];
  v9 = [v8 unmanagedAdjustment];
  v10 = [v9 adjustmentFormatVersion];
  LODWORD(v4) = [v4 isRecognizedSlowMotionFormatWithIdentifier:v7 version:v10];

  if (v4)
  {
    [v3 setHighFrameRateState:3];
    ++*(*(a1[6] + 8) + 24);
  }

  else
  {
    v11 = a1[4];
    v12 = a1[5];
    v21 = 0;
    v13 = [v11 _loadOriginalVideoMetadataFromAsset:v3 timeZoneLookup:v12 error:&v21];
    v14 = v21;
    if (!v13)
    {
      v15 = *(a1[7] + 8);
      v16 = *(v15 + 24);
      if (v16 <= 2)
      {
        *(v15 + 24) = v16 + 1;
        v17 = PLMigrationGetLog();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
        {
          v18 = [v3 uuid];
          v19 = [v14 userInfo];
          *buf = 136315906;
          v23 = "[PLModelMigrator _updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:]_block_invoke";
          v24 = 2112;
          v25 = v18;
          v26 = 2112;
          v27 = v14;
          v28 = 2112;
          v29 = v19;
          _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "%s: failed to load metadata for asset with uuid %@, not fatal, will proceed with migration, error: %@ %@", buf, 0x2Au);
        }
      }
    }

    if ([v13 isSloMo])
    {
      v20 = 3;
    }

    else
    {
      v20 = 2;
    }

    [v3 setHighFrameRateState:v20];
    ++*(*(a1[8] + 8) + 24);
  }
}

void __78__PLModelMigrator__updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore___block_invoke_2627(void *a1, void *a2)
{
  v22 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = a1[4];
  v5 = a1[5];
  v13 = 0;
  v6 = [v4 _loadOriginalVideoMetadataFromAsset:v3 timeZoneLookup:v5 error:&v13];
  v7 = v13;
  if (!v6)
  {
    v8 = *(a1[6] + 8);
    v9 = *(v8 + 24);
    if (v9 <= 2)
    {
      *(v8 + 24) = v9 + 1;
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = [v3 uuid];
        v12 = [v7 userInfo];
        *buf = 136315906;
        v15 = "[PLModelMigrator _updateMogulSubtypeAndSetHighFrameRateStateOnAssetsInStore:]_block_invoke";
        v16 = 2112;
        v17 = v11;
        v18 = 2112;
        v19 = v7;
        v20 = 2112;
        v21 = v12;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%s: failed to load metadata for asset with uuid %@, not fatal, will proceed with migration, error: %@ %@", buf, 0x2Au);
      }
    }
  }

  if ([v6 isSloMo])
  {
    [v3 setHighFrameRateState:1];
    [v3 setKindSubtype:101];
    ++*(*(a1[7] + 8) + 24);
  }
}

- (id)_loadOriginalVideoMetadataFromAsset:(id)a3 timeZoneLookup:(id)a4 error:(id *)a5
{
  v28[1] = *MEMORY[0x1E69E9840];
  v7 = a3;
  v8 = a4;
  v9 = [v7 master];
  v10 = [v9 mediaMetadata];
  v11 = [v10 data];

  if (v11)
  {
    v12 = objc_alloc(MEMORY[0x1E69C0718]);
    v13 = [v7 master];
    v14 = [v13 mediaMetadata];
    v15 = [v14 data];
    v16 = [v12 initWithAVProxyData:v15 timeZoneLookup:v8];

    goto LABEL_7;
  }

  if (([v7 isReferencedAsset] & 1) == 0)
  {
    v21 = objc_alloc(MEMORY[0x1E69C0718]);
    v22 = MEMORY[0x1E695DFF8];
    v23 = [v7 pathForOriginalFile];
    v24 = [v22 fileURLWithPath:v23];
    v16 = [v21 initWithAVURL:v24 timeZoneLookup:v8];

LABEL_7:
    v20 = 0;
    if (!a5)
    {
      goto LABEL_9;
    }

    goto LABEL_8;
  }

  v17 = MEMORY[0x1E696ABC0];
  v18 = *MEMORY[0x1E69BFF48];
  v27 = *MEMORY[0x1E696A278];
  v28[0] = @"skipping reference asset";
  v19 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:&v27 count:1];
  v20 = [v17 errorWithDomain:v18 code:46502 userInfo:v19];

  v16 = 0;
  if (a5)
  {
LABEL_8:
    v25 = v20;
    *a5 = v20;
  }

LABEL_9:

  return v16;
}

BOOL __63__PLModelMigrator__resetAssetLocationShiftingAndRevGeoInStore___block_invoke(uint64_t a1, void *a2)
{
  v26[2] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = a2;
  v4 = +[PLAdditionalAssetAttributes entityName];
  v5 = [v2 batchUpdateRequestWithEntityName:v4];

  [v5 setResultType:2];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != nil", @"shiftedLocationData"];
  [v5 setPredicate:v6];

  v25[0] = @"reverseLocationDataIsValid";
  v25[1] = @"shiftedLocationIsValid";
  v26[0] = MEMORY[0x1E695E110];
  v26[1] = MEMORY[0x1E695E110];
  v7 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v26 forKeys:v25 count:2];
  [v5 setPropertiesToUpdate:v7];

  v18 = 0;
  v8 = [v3 executeRequest:v5 error:&v18];

  v9 = v18;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v20 = v12;
      v13 = "Invalidated reverse geocoding and shifted location data for %@ assets";
      v14 = v11;
      v15 = OS_LOG_TYPE_DEFAULT;
      v16 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v14, v15, v13, buf, v16);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    v12 = [v9 userInfo];
    *buf = 136315650;
    v20 = "[PLModelMigrator _resetAssetLocationShiftingAndRevGeoInStore:]_block_invoke";
    v21 = 2112;
    v22 = v9;
    v23 = 2112;
    v24 = v12;
    v13 = "%s: failed to update: %@ %@";
    v14 = v11;
    v15 = OS_LOG_TYPE_ERROR;
    v16 = 32;
    goto LABEL_6;
  }

  return v8 != 0;
}

- (BOOL)_resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __85__PLModelMigrator__resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __85__PLModelMigrator__resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore___block_invoke(uint64_t a1, void *a2)
{
  v26 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLAdditionalAssetAttributes entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"cloudRecoveryState", &unk_1F0FBBF98];
  [v6 setPredicate:v7];

  [v6 setFetchBatchSize:100];
  v18 = 0;
  v19 = &v18;
  v20 = 0x2020000000;
  v21 = 0;
  v17 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v17];
  v9 = v17;
  if (v8 && (v16[0] = MEMORY[0x1E69E9820], v16[1] = 3221225472, v16[2] = __85__PLModelMigrator__resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore___block_invoke_2609, v16[3] = &unk_1E75697C0, v16[4] = &v18, [v3 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v16], v10 = objc_claimAutoreleasedReturnValue(), v9, (v9 = v10) == 0))
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v14 = v19[3];
      *buf = 134217984;
      v23 = v14;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Reset cloud recovery state for %lu assets", buf, 0xCu);
    }

    v9 = 0;
    v13 = 1;
  }

  else
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v23 = v12;
      v24 = 2112;
      v25 = v9;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%@: failed with error: %@", buf, 0x16u);
    }

    v13 = 0;
  }

  _Block_object_dispose(&v18, 8);
  return v13;
}

void __85__PLModelMigrator__resetDeferredRepairAdjustmentFailureAndCloudRecoveryStateInStore___block_invoke_2609(uint64_t a1, void *a2)
{
  v3 = a2;
  if ([v3 cloudRecoveryState])
  {
    [v3 setCloudRecoveryState:0];
    [v3 setCloudStateRecoveryAttemptsCount:0];
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_invalidateZeroHDRGainInStore:(id)a3
{
  v4 = a3;
  pl_dispatch_once();
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _invalidateZeroHDRGainInStore:]" store:v4 migrationHandler:&__block_literal_global_2600];

  return self;
}

BOOL __49__PLModelMigrator__invalidateZeroHDRGainInStore___block_invoke(uint64_t a1, void *a2)
{
  v20[1] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_DEFAULT, "Invalidating zero hdrGain for assets", buf, 2u);
  }

  v4 = objc_alloc(MEMORY[0x1E695D560]);
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 initWithEntityName:v5];

  [v6 setResultType:2];
  v19 = @"hdrGain";
  v7 = [MEMORY[0x1E695DFB0] null];
  v20[0] = v7;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v20 forKeys:&v19 count:1];
  [v6 setPropertiesToUpdate:v8];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"hdrGain", 0];
  [v6 setPredicate:v9];

  v16 = 0;
  v10 = [v2 executeRequest:v6 error:&v16];
  v11 = v16;
  v12 = PLMigrationGetLog();
  v13 = v12;
  if (v11)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v18 = v11;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Failed to invalidate zero hdrGain assets: %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v14 = [v10 result];
    *buf = 138412290;
    v18 = v14;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Invalidated %@ assets with zero hdrGain", buf, 0xCu);
  }

  [v2 reset];
  return v11 == 0;
}

- (BOOL)_repairWallpaperAlbumsInStore:(id)a3 containerUUID:(id)a4 title:(id)a5
{
  v9 = a4;
  v10 = a5;
  v14[0] = MEMORY[0x1E69E9820];
  v14[1] = 3221225472;
  v14[2] = __69__PLModelMigrator__repairWallpaperAlbumsInStore_containerUUID_title___block_invoke;
  v14[3] = &unk_1E7569798;
  v15 = v9;
  v16 = self;
  v17 = v10;
  v18 = a2;
  v11 = v10;
  v12 = v9;
  LOBYTE(a3) = [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _repairWallpaperAlbumsInStore:containerUUID:title:]" store:a3 migrationHandler:v14];

  return a3;
}

uint64_t __69__PLModelMigrator__repairWallpaperAlbumsInStore_containerUUID_title___block_invoke(void *a1, void *a2)
{
  v62[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAlbum entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %@", @"uuid", a1[4]];
  v62[0] = @"assets";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v62 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  [v6 setPredicate:v7];
  v53 = 0;
  v9 = [v3 executeFetchRequest:v6 error:&v53];
  v10 = v53;
  v11 = objc_alloc_init(MEMORY[0x1E695DFA0]);
  if ([v9 count] >= 2)
  {
    v39 = [MEMORY[0x1E696AAA8] currentHandler];
    [v39 handleFailureInMethod:a1[7] object:a1[5] file:@"PLModelMigrator.m" lineNumber:14638 description:{@"found more than one locket album with UUID %@", a1[4]}];
  }

  if ([v9 count])
  {
    v43 = v10;
    v46 = [v9 firstObject];
    v12 = [v46 assets];
    v13 = [v12 array];
    [v11 addObjectsFromArray:v13];

    v40 = [v11 count];
    v41 = 0;
    goto LABEL_7;
  }

  v14 = [(PLGenericAlbum *)PLManagedAlbum insertAlbumWithKind:2 title:a1[6] uuid:a1[4] inManagedObjectContext:v3];
  if (v14)
  {
    v43 = v10;
    v46 = v14;
    v40 = 0;
    v41 = 1;
LABEL_7:
    v15 = MEMORY[0x1E695D5E0];
    v16 = +[PLGenericAlbum entityName];
    v17 = [v15 fetchRequestWithEntityName:v16];

    v42 = a1;
    v18 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %@ AND %K != %@", @"title", a1[6], @"uuid", a1[4]];

    v61 = @"assets";
    v19 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v61 count:1];
    [v17 setRelationshipKeyPathsForPrefetching:v19];

    v45 = v18;
    [v17 setPredicate:v18];
    v52 = v43;
    v20 = [v3 executeFetchRequest:v17 error:&v52];
    v44 = v52;

    v50 = 0u;
    v51 = 0u;
    v48 = 0u;
    v49 = 0u;
    v9 = v20;
    v21 = [v9 countByEnumeratingWithState:&v48 objects:v60 count:16];
    if (v21)
    {
      v22 = v21;
      v23 = *v49;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v49 != v23)
          {
            objc_enumerationMutation(v9);
          }

          v25 = *(*(&v48 + 1) + 8 * i);
          v26 = [v25 assets];
          v27 = [v26 array];
          [v11 addObjectsFromArray:v27];

          [v3 deleteObject:v25];
        }

        v22 = [v9 countByEnumeratingWithState:&v48 objects:v60 count:16];
      }

      while (v22);
    }

    v28 = v46;
    if ([v11 count])
    {
      [v46 setAssets:v11];
    }

    if ([v3 hasChanges])
    {
      v47 = 0;
      v29 = [v3 save:&v47];
      v30 = v47;
      v31 = v30;
      if (v29)
      {

        [v3 reset];
        v32 = PLMigrationGetLog();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          v33 = [v11 count] - v40;
          v34 = [v9 count];
          *buf = 134218496;
          v55 = v33;
          v56 = 2048;
          v57 = v34;
          v58 = 1024;
          v59 = v41;
          _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_DEFAULT, "wallpaper repair migrated %ld assets from %ld albums, created=%d", buf, 0x1Cu);
        }

        v35 = 1;
        goto LABEL_25;
      }

      v36 = PLMigrationGetLog();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
      {
        v37 = NSStringFromSelector(v42[7]);
        *buf = 138412546;
        v55 = v37;
        v56 = 2112;
        v57 = v31;
        _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_ERROR, "%@ failed: %@", buf, 0x16u);
      }
    }

    [v3 reset];
    v35 = 0;
LABEL_25:
    v10 = v44;
    v7 = v45;
    goto LABEL_26;
  }

  v28 = PLMigrationGetLog();
  if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v28, OS_LOG_TYPE_ERROR, "failed to insert locket album", buf, 2u);
  }

  v35 = 0;
  v17 = v6;
LABEL_26:

  return v35;
}

uint64_t __56__PLModelMigrator__removeDuplicatedCloudSharedComments___block_invoke(uint64_t a1, void *a2)
{
  v58[1] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = MEMORY[0x1E695D5E0];
  v4 = +[PLCloudSharedComment entityName];
  v5 = [v3 fetchRequestWithEntityName:v4];

  v58[0] = @"commentDate";
  v6 = [MEMORY[0x1E695DEC8] arrayWithObjects:v58 count:1];
  [v5 setPropertiesToFetch:v6];

  v57 = @"commentDate";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v57 count:1];
  [v5 setPropertiesToGroupBy:v7];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"count(SELF) > 1"];
  [v5 setHavingPredicate:v8];

  [v5 setResultType:2];
  v50 = 0;
  v38 = v2;
  v9 = [v2 executeFetchRequest:v5 error:&v50];
  v10 = v50;
  v11 = v10;
  if (v9)
  {
    v33 = v10;
    v35 = v5;
    v12 = [MEMORY[0x1E695DF70] arrayWithCapacity:{objc_msgSend(v9, "count")}];
    v46 = 0u;
    v47 = 0u;
    v48 = 0u;
    v49 = 0u;
    v34 = v9;
    obj = v9;
    v39 = [obj countByEnumeratingWithState:&v46 objects:v56 count:16];
    if (v39)
    {
      v37 = *v47;
      do
      {
        for (i = 0; i != v39; ++i)
        {
          if (*v47 != v37)
          {
            objc_enumerationMutation(obj);
          }

          v40 = [*(*(&v46 + 1) + 8 * i) objectForKey:@"commentDate"];
          v14 = [PLCloudSharedComment cloudSharedCommentsWithCommentDate:"cloudSharedCommentsWithCommentDate:inManagedObjectContext:" inManagedObjectContext:?];
          v42 = 0u;
          v43 = 0u;
          v44 = 0u;
          v45 = 0u;
          v15 = [v14 countByEnumeratingWithState:&v42 objects:v55 count:16];
          if (v15)
          {
            v16 = v15;
            v17 = 0;
            v18 = 0;
            v19 = 0;
            v20 = *v43;
            do
            {
              for (j = 0; j != v16; ++j)
              {
                if (*v43 != v20)
                {
                  objc_enumerationMutation(v14);
                }

                v22 = *(*(&v42 + 1) + 8 * j);
                if (v17)
                {
                  if ([*(*(&v42 + 1) + 8 * j) matchesCommentText:v19 isLike:v18 & 1])
                  {
                    v23 = [v22 objectID];
                    [v12 addObject:v23];
                  }
                }

                else
                {
                  v24 = [*(*(&v42 + 1) + 8 * j) commentText];

                  v18 = [v22 isLikeBoolValue];
                  v19 = v24;
                }

                v17 = 1;
              }

              v16 = [v14 countByEnumeratingWithState:&v42 objects:v55 count:16];
            }

            while (v16);
          }

          else
          {
            v19 = 0;
          }
        }

        v39 = [obj countByEnumeratingWithState:&v46 objects:v56 count:16];
      }

      while (v39);
    }

    if ([v12 count])
    {
      v25 = [objc_alloc(MEMORY[0x1E695D538]) initWithObjectIDs:v12];
      [v25 setResultType:2];
      v41 = 0;
      v26 = [v38 executeRequest:v25 error:&v41];
      v27 = v41;
      v28 = PLMigrationGetLog();
      v29 = v28;
      v11 = v33;
      if (v27)
      {
        v5 = v35;
        if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
        {
          v30 = [v12 count];
          *buf = 134218242;
          v52 = v30;
          v53 = 2112;
          v54 = v33;
          _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_ERROR, "Failed to delete %lu duplicated cloud shared comments: %@", buf, 0x16u);
        }
      }

      else
      {
        v5 = v35;
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          v31 = [v26 result];
          *buf = 138412290;
          v52 = v31;
          _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_DEFAULT, "Deleted %@ duplicated cloud shared comments", buf, 0xCu);
        }
      }
    }

    else
    {
      v25 = PLMigrationGetLog();
      v11 = v33;
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_DEFAULT, "No duplicated cloud shared comments found.", buf, 2u);
      }

      v5 = v35;
    }

    v9 = v34;
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v52 = v11;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_removeDuplicatedCloudSharedComments: Error executing fetch request, error:%@", buf, 0xCu);
    }
  }

  return 1;
}

- (BOOL)_refactorLargeVideoRecipeResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __61__PLModelMigrator__refactorLargeVideoRecipeResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _refactorLargeVideoRecipeResourcesInStore:]" store:a3 migrationHandler:v4];
}

BOOL __61__PLModelMigrator__refactorLargeVideoRecipeResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v37[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v26 = 0;
  v27 = &v26;
  v28 = 0x2020000000;
  v29 = 0;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v37[0] = @"modernResources";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v37 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v7];

  v8 = MEMORY[0x1E696AB28];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"kind", 1];
  v36[0] = v9;
  v10 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForAssetsEligibleForCloudKitTransport"), 1}];
  v36[1] = v10;
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"SUBQUERY(%K, $r, $r.%K = %d).@count > 0", @"modernResources", @"recipeID", 131473];
  v36[2] = v11;
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v36 count:3];
  v13 = [v8 andPredicateWithSubpredicates:v12];
  [v6 setPredicate:v13];

  v25 = 0;
  v14 = [v3 executeFetchRequest:v6 error:&v25];
  v15 = v25;
  if (v14)
  {
    v24[0] = MEMORY[0x1E69E9820];
    v24[1] = 3221225472;
    v24[2] = __61__PLModelMigrator__refactorLargeVideoRecipeResourcesInStore___block_invoke_2;
    v24[3] = &unk_1E7568EB0;
    v24[4] = &v26;
    v16 = [v3 enumerateWithIncrementalSaveUsingObjects:v14 withBlock:v24];
    v17 = v16 == 0;
    if (v16)
    {
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = NSStringFromSelector(*(a1 + 32));
        v20 = [v16 userInfo];
        *buf = 138543874;
        v31 = v19;
        v32 = 2112;
        v33 = v16;
        v34 = 2112;
        v35 = v20;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v22 = v27[3];
        *buf = 134217984;
        v31 = v22;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "updated %lu resources.", buf, 0xCu);
      }
    }
  }

  else
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v21 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v31 = v21;
      v32 = 2112;
      v33 = v15;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%@: failed to fetch with error: %@", buf, 0x16u);
    }

    v17 = 0;
  }

  _Block_object_dispose(&v26, 8);
  return v17;
}

void __61__PLModelMigrator__refactorLargeVideoRecipeResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x1E69E9840];
  v3 = a2;
  [v3 persistedResourcesMatching:&__block_literal_global_2585];
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  obj = v18 = 0u;
  v4 = [obj countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v16;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v16 != v6)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v15 + 1) + 8 * i);
        v9 = [v3 persistedResourcesWithRecipeID:131077 andVersion:{objc_msgSend(v8, "version")}];
        v10 = [v9 anyObject];

        if (v10)
        {
          [v10 deleteResource];
        }

        [v8 setRecipeID:131077];
        if ([v8 localAvailability] >= 1)
        {
          v11 = [v3 pathForCPLResourceType:objc_msgSend(v8 adjusted:{"cplType"), objc_msgSend(v8, "isAdjustedResource")}];
          v12 = [MEMORY[0x1E695DFF8] fileURLWithPath:v11 isDirectory:0];
          v13 = [v12 path];
          [v8 markAsLocallyAvailableWithFilePath:v13];
        }

        ++*(*(*(a1 + 32) + 8) + 24);
      }

      v5 = [obj countByEnumeratingWithState:&v15 objects:v19 count:16];
    }

    while (v5);
  }
}

- (BOOL)_repairCTMOriginalVideosWithoutAdjustmentsInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __69__PLModelMigrator__repairCTMOriginalVideosWithoutAdjustmentsInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _repairCTMOriginalVideosWithoutAdjustmentsInStore:]" store:a3 migrationHandler:v4];
}

BOOL __69__PLModelMigrator__repairCTMOriginalVideosWithoutAdjustmentsInStore___block_invoke(uint64_t a1, void *a2)
{
  v30 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(%K = %d) and (%K = %d) and SUBQUERY(modernResources, $r, $r.resourceType = %d and $r.version = %d).@count == 0", @"kind", 1, @"deferredProcessingNeeded", 2, 10, 0];
  [v6 setPredicate:v7];

  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v19 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v19];
  v9 = v19;
  if (v8)
  {
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __69__PLModelMigrator__repairCTMOriginalVideosWithoutAdjustmentsInStore___block_invoke_2;
    v18[3] = &unk_1E7568EB0;
    v18[4] = &v20;
    v10 = [v3 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v18];
    v11 = v10 == 0;
    if (v10)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = NSStringFromSelector(*(a1 + 32));
        v14 = [v10 userInfo];
        *buf = 138543874;
        v25 = v13;
        v26 = 2112;
        v27 = v10;
        v28 = 2112;
        v29 = v14;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = *(v21 + 6);
        *buf = 67109120;
        LODWORD(v25) = v16;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Repaired %d assets without adjustments but deferredProcessingNeeded set.", buf, 8u);
      }
    }
  }

  else
  {
    v10 = PLMigrationGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v15 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v25 = v15;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@: failed to fetch assets for fetch request with error: %@", buf, 0x16u);
    }

    v11 = 0;
  }

  _Block_object_dispose(&v20, 8);
  return v11;
}

void __69__PLModelMigrator__repairCTMOriginalVideosWithoutAdjustmentsInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  if (([v3 hasAdjustments] & 1) == 0)
  {
    [v3 setDeferredProcessingNeeded:0];
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_addLocalVideoKeyFrameResourceInStore:(id)a3 deferHintChanges:(BOOL)a4
{
  v5[0] = MEMORY[0x1E69E9820];
  v5[1] = 3221225472;
  v5[2] = __74__PLModelMigrator__addLocalVideoKeyFrameResourceInStore_deferHintChanges___block_invoke;
  v5[3] = &__block_descriptor_41_e32_B16__0__NSManagedObjectContext_8l;
  v6 = a4;
  v5[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _addLocalVideoKeyFrameResourceInStore:deferHintChanges:]" store:a3 migrationHandler:v5];
}

uint64_t __74__PLModelMigrator__addLocalVideoKeyFrameResourceInStore_deferHintChanges___block_invoke(uint64_t a1, void *a2)
{
  v31[2] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v23 = 0;
  v24 = &v23;
  v25 = 0x2020000000;
  v26 = 0;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = MEMORY[0x1E696AB28];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kind", 1];
  v31[0] = v8;
  v9 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForAddingLocalVideoKeyFrameResourceExclusions"), 1}];
  v31[1] = v9;
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v31 count:2];
  v11 = [v7 andPredicateWithSubpredicates:v10];
  [v6 setPredicate:v11];

  v22 = 0;
  v12 = [v3 executeFetchRequest:v6 error:&v22];
  v13 = v22;
  if (v12 && (v20[0] = MEMORY[0x1E69E9820], v20[1] = 3221225472, v20[2] = __74__PLModelMigrator__addLocalVideoKeyFrameResourceInStore_deferHintChanges___block_invoke_2, v20[3] = &unk_1E7569750, v20[4] = &v23, v21 = *(a1 + 40), [v3 enumerateWithIncrementalSaveUsingObjects:v12 shouldRefreshAfterSave:1 withBlock:v20], v14 = objc_claimAutoreleasedReturnValue(), v13, (v13 = v14) == 0))
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v18 = *(v24 + 6);
      *buf = 67109120;
      LODWORD(v28) = v18;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Added %d local video key frame resources", buf, 8u);
    }

    v13 = 0;
    v17 = 1;
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v28 = v16;
      v29 = 2112;
      v30 = v13;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "%@: failed with error: %@", buf, 0x16u);
    }

    v17 = 0;
  }

  _Block_object_dispose(&v23, 8);
  return v17;
}

void __74__PLModelMigrator__addLocalVideoKeyFrameResourceInStore_deferHintChanges___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = v3;
  if (v3)
  {
    [v3 videoKeyFrameTime];
    v5 = (v10 & 0x1D) == 1;
  }

  else
  {
    v5 = 0;
  }

  v6 = [v4 localVideoKeyFrameResource];
  v7 = v6;
  if (v5 && v6 == 0)
  {
    v9 = [PLResourceInstaller onDemand_installLocalVideoKeyFrameForAsset:v4];
    if (v9)
    {
      ++*(*(*(a1 + 32) + 8) + 24);
    }
  }

  else if (v6 != 0 && !v5)
  {
    [v4 pruneLocalVideoKeyFrameImage];
    [v7 deleteResource];
  }

  if (([v4 hasAdjustments] & 1) == 0 && ((v5 ^ (v7 == 0)) & 1) == 0 && (*(a1 + 40) & 1) == 0)
  {
    [v4 recalculateImageRequestHints];
  }
}

- (BOOL)_addRAWPackedBadgeAttributeForAllRAWAssetsInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __69__PLModelMigrator__addRAWPackedBadgeAttributeForAllRAWAssetsInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _addRAWPackedBadgeAttributeForAllRAWAssetsInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __69__PLModelMigrator__addRAWPackedBadgeAttributeForAllRAWAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v27[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLInternalResource entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K == %d AND %K == %d", @"utiConformanceHint", 2, @"dataStoreSubtype", 1, @"dataStoreClassID", 0];
  [v6 setPredicate:v7];

  v27[0] = @"asset";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v27 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v22 = 0;
  v9 = [v3 executeFetchRequest:v6 error:&v22];
  v10 = v22;
  v18 = 0;
  v19 = &v18;
  v20 = 0x2020000000;
  v21 = 0;
  if (v9 && (v17[0] = MEMORY[0x1E69E9820], v17[1] = 3221225472, v17[2] = __69__PLModelMigrator__addRAWPackedBadgeAttributeForAllRAWAssetsInStore___block_invoke_2, v17[3] = &unk_1E75741F0, v17[4] = &v18, [v3 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:v17], v11 = objc_claimAutoreleasedReturnValue(), v10, (v10 = v11) == 0))
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v15 = v19[3];
      *buf = 134217984;
      v24 = v15;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Added RAW packed badge attributes to %lu assets", buf, 0xCu);
    }

    v10 = 0;
    v14 = 1;
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v24 = v13;
      v25 = 2112;
      v26 = v10;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%@: failed with error: %@", buf, 0x16u);
    }

    v14 = 0;
  }

  _Block_object_dispose(&v18, 8);
  return v14;
}

void __69__PLModelMigrator__addRAWPackedBadgeAttributeForAllRAWAssetsInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = [a2 asset];
  [v3 setRAWBadgeAttribute:3];

  ++*(*(*(a1 + 32) + 8) + 24);
}

- (BOOL)_persistResourceTypeAttributeOnAlternateImageResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __81__PLModelMigrator__persistResourceTypeAttributeOnAlternateImageResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _persistResourceTypeAttributeOnAlternateImageResourcesInStore:]" store:a3 migrationHandler:v4];
}

BOOL __81__PLModelMigrator__persistResourceTypeAttributeOnAlternateImageResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v18 = *MEMORY[0x1E69E9840];
  v13 = 0;
  v3 = MEMORY[0x1E695D5E0];
  v4 = a2;
  v5 = +[PLInternalResource entityName];
  v6 = [v3 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K == %d AND %K == %d AND %K >= %d", @"dataStoreClassID", 0, @"resourceType", 4, @"version", 0, @"localAvailability", 1];
  [v6 setPredicate:v7];

  v8 = [v4 enumerateObjectsFromFetchRequest:v6 count:&v13 usingDefaultBatchSizeWithBlock:&__block_literal_global_2564];

  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v8)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v11 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v15 = v11;
      v16 = 2112;
      v17 = v8;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@: failed with error: %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v15 = v13;
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Persisted resourceType to %lu alternate image resources", buf, 0xCu);
  }

  return v8 == 0;
}

void __81__PLModelMigrator__persistResourceTypeAttributeOnAlternateImageResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v11 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = [v2 fileURL];
  if (v3)
  {
    v4 = v2;
    if ([v4 resourceType] == 4 && !objc_msgSend(v4, "version"))
    {
      v8 = [v4 recipeID];

      if ((v8 & 1) == 0)
      {
        v5 = objc_alloc_init(PLValidatedExternalResource);
        [(PLValidatedExternalResource *)v5 setResourceType:4];
        [(PLValidatedExternalResource *)v5 setFileURL:v3];
        [(PLValidatedExternalResource *)v5 persistResourceTypeToFileURL];
        goto LABEL_7;
      }
    }

    else
    {
    }
  }

  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(&v5->super, OS_LOG_TYPE_ERROR))
  {
    v6 = [v2 asset];
    v7 = [v6 uuid];
    v9 = 138543362;
    v10 = v7;
    _os_log_impl(&dword_19BF1F000, &v5->super, OS_LOG_TYPE_ERROR, "Resource UR unexpectedly nil or resource type/version/recipeID don't metch for alternate-imaage resource for asset: %{public}@", &v9, 0xCu);
  }

LABEL_7:
}

- (BOOL)_repairCTMOriginalVideosWithSOCAvailableBitInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __70__PLModelMigrator__repairCTMOriginalVideosWithSOCAvailableBitInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _repairCTMOriginalVideosWithSOCAvailableBitInStore:]" store:a3 migrationHandler:v4];
}

BOOL __70__PLModelMigrator__repairCTMOriginalVideosWithSOCAvailableBitInStore___block_invoke(uint64_t a1, void *a2)
{
  v30 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(%K = %d) and SUBQUERY(modernResources, $r, $r.resourceType = %d and $r.version = %d).@count == 0", @"kind", 1, 10, 0];
  [v6 setPredicate:v7];

  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v19 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v19];
  v9 = v19;
  if (v8)
  {
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __70__PLModelMigrator__repairCTMOriginalVideosWithSOCAvailableBitInStore___block_invoke_2;
    v18[3] = &unk_1E7568EB0;
    v18[4] = &v20;
    v10 = [v3 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v18];
    v11 = v10 == 0;
    if (v10)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = NSStringFromSelector(*(a1 + 32));
        v14 = [v10 userInfo];
        *buf = 138543874;
        v25 = v13;
        v26 = 2112;
        v27 = v10;
        v28 = 2112;
        v29 = v14;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = *(v21 + 6);
        *buf = 67109120;
        LODWORD(v25) = v16;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Repaired %d assets without soc available bit.", buf, 8u);
      }
    }
  }

  else
  {
    v10 = PLMigrationGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v15 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v25 = v15;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@: failed to fetch assets for fetch request with error: %@", buf, 0x16u);
    }

    v11 = 0;
  }

  _Block_object_dispose(&v20, 8);
  return v11;
}

void __70__PLModelMigrator__repairCTMOriginalVideosWithSOCAvailableBitInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = [v5 cameraProcessingAdjustmentState];
  v4 = v5;
  if (v3)
  {
    [v5 setCameraProcessingAdjustmentState:{objc_msgSend(v5, "cameraProcessingAdjustmentState") & 0xFFFE}];
    if ([v5 hasAdjustments])
    {
      [v5 setDeferredProcessingNeeded:2];
    }

    ++*(*(*(a1 + 32) + 8) + 24);
    v4 = v5;
  }
}

- (BOOL)_removeResourceModelManualIdentityConstraintInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __71__PLModelMigrator__removeResourceModelManualIdentityConstraintInStore___block_invoke;
  v4[3] = &unk_1E7569528;
  v4[4] = self;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _removeResourceModelManualIdentityConstraintInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __71__PLModelMigrator__removeResourceModelManualIdentityConstraintInStore___block_invoke(uint64_t a1)
{
  v16 = *MEMORY[0x1E69E9840];
  v1 = [*(a1 + 32) pathManager];
  v2 = [v1 photosDatabasePath];
  v3 = PLOpenSQLTransactionWithDBPath([v2 fileSystemRepresentation]);

  if (!v3)
  {
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_ERROR, "Unable to open db in order to remove manual index.", buf, 2u);
    }

    goto LABEL_17;
  }

  v4 = [MEMORY[0x1E696AEC0] stringWithFormat:@"DROP INDEX IF EXISTS RADAR_45737537_UNIQUE_INDEX"];
  errmsg = 0;
  v5 = sqlite3_exec(v3, [v4 UTF8String], 0, 0, &errmsg);
  if (v5)
  {
    v6 = v5;
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      *buf = 67109378;
      v13 = v6;
      v14 = 2080;
      v15 = errmsg;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "Error while removing manual index: %d %s", buf, 0x12u);
    }

    if (errmsg)
    {
      sqlite3_free(errmsg);
    }

    PLRollbackSQLTransactionAndCloseDB(v3);
LABEL_17:
    v8 = 0;
    goto LABEL_18;
  }

  if (!PLCommitSQLTransactionAndCloseDB(v3))
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "Unable to commit transaction for index removal.", buf, 2u);
    }

    goto LABEL_17;
  }

  v4 = PLMigrationGetLog();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_DEFAULT, "Removed manual index for resource model identity constraint.", buf, 2u);
  }

  v8 = 1;
LABEL_18:

  return v8;
}

- (BOOL)_removeAllLocalVideoKeyFrameResourcesRevert14037InStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __75__PLModelMigrator__removeAllLocalVideoKeyFrameResourcesRevert14037InStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _removeAllLocalVideoKeyFrameResourcesRevert14037InStore:]" store:a3 migrationHandler:v4];
}

uint64_t __75__PLModelMigrator__removeAllLocalVideoKeyFrameResourcesRevert14037InStore___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLInternalResource entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == 65749", @"recipeID"];
  [v6 setPredicate:v7];

  v23 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v23];
  v9 = v23;
  v19 = 0;
  v20 = &v19;
  v21 = 0x2020000000;
  v22 = 0;
  if (v8 && (v16[0] = MEMORY[0x1E69E9820], v16[1] = 3221225472, v16[2] = __75__PLModelMigrator__removeAllLocalVideoKeyFrameResourcesRevert14037InStore___block_invoke_2, v16[3] = &unk_1E7569708, v17 = v3, v18 = &v19, [v17 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v16], v10 = objc_claimAutoreleasedReturnValue(), v9, v17, (v9 = v10) == 0))
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v14 = v20[3];
      *buf = 134217984;
      v25 = v14;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Reverting 14037, removed %lu resources", buf, 0xCu);
    }

    v9 = 0;
    v13 = 1;
  }

  else
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v25 = v12;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%@: failed with error: %@", buf, 0x16u);
    }

    v13 = 0;
  }

  _Block_object_dispose(&v19, 8);
  return v13;
}

uint64_t __75__PLModelMigrator__removeAllLocalVideoKeyFrameResourcesRevert14037InStore___block_invoke_2(uint64_t a1, uint64_t a2)
{
  result = [*(a1 + 32) deleteObject:a2];
  ++*(*(*(a1 + 40) + 8) + 24);
  return result;
}

- (BOOL)_copyAssetDescriptionToAccessibilityDescription:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __67__PLModelMigrator__copyAssetDescriptionToAccessibilityDescription___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _copyAssetDescriptionToAccessibilityDescription:]" store:a3 migrationHandler:v4];
}

uint64_t __67__PLModelMigrator__copyAssetDescriptionToAccessibilityDescription___block_invoke(uint64_t a1, void *a2)
{
  v21[2] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != NULL", @"additionalAttributes.assetDescription.longDescription"];
  [v6 setPredicate:v7];

  v21[0] = @"additionalAttributes";
  v21[1] = @"additionalAttributes.assetDescription";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v21 count:2];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v9 = [v3 enumerateObjectsFromFetchRequest:v6 count:0 usingDefaultBatchSizeWithBlock:&__block_literal_global_2540];
  if ([v3 hasChanges])
  {
    v16 = 0;
    v10 = [v3 save:&v16];
    v11 = v16;
    v12 = PLMigrationGetLog();
    v13 = v12;
    if (v10)
    {
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        LODWORD(v18) = 0;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Copied %d asset descriptions fields to accessibility description fields.", buf, 8u);
      }
    }

    else if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v14 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v18 = v14;
      v19 = 2112;
      v20 = v11;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%@: failed to save with error: %@", buf, 0x16u);
    }
  }

  else
  {
    v10 = 1;
  }

  return v10;
}

void __67__PLModelMigrator__copyAssetDescriptionToAccessibilityDescription___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  v2 = [v3 longDescription];
  if ([v2 length])
  {
    [v3 setAccessibilityDescription:v2];
    [v3 persistMetadataToFilesystem];
  }
}

BOOL __67__PLModelMigrator__clearAvalancheUUIDOnCloudSharedAssetsWithStore___block_invoke(uint64_t a1, void *a2)
{
  v24[2] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = a2;
  v4 = +[PLManagedAsset entityName];
  v5 = [v2 batchUpdateRequestWithEntityName:v4];

  v6 = MEMORY[0x1E696AB28];
  v7 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v24[0] = v7;
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != nil", @"avalancheUUID"];
  v24[1] = v8;
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v24 count:2];
  v10 = [v6 andPredicateWithSubpredicates:v9];

  [v5 setPredicate:v10];
  v22 = @"avalancheUUID";
  v11 = [MEMORY[0x1E695DFB0] null];
  v23 = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v23 forKeys:&v22 count:1];
  [v5 setPropertiesToUpdate:v12];

  [v5 setResultType:2];
  v19 = 0;
  v13 = [v3 executeRequest:v5 error:&v19];

  v14 = v19;
  v15 = PLMigrationGetLog();
  v16 = v15;
  if (v13)
  {
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v13 result];
      *buf = 138412290;
      v21 = v17;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Batch update to clear avalancheUUID successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v21 = v14;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "Batch update to clear avalancheUUID failed, error: %@", buf, 0xCu);
  }

  return v13 != 0;
}

- (BOOL)_repairReframedAssetsWithoutSOCAvailableBitWithStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __72__PLModelMigrator__repairReframedAssetsWithoutSOCAvailableBitWithStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _repairReframedAssetsWithoutSOCAvailableBitWithStore:]" store:a3 migrationHandler:v4];
}

BOOL __72__PLModelMigrator__repairReframedAssetsWithoutSOCAvailableBitWithStore___block_invoke(uint64_t a1, void *a2)
{
  v30 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(%K = %d) and SUBQUERY(modernResources, $r, $r.resourceType = %d and $r.version = %d).@count > 0", @"kind", 1, 10, 0];
  [v6 setPredicate:v7];

  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v19 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v19];
  v9 = v19;
  if (v8)
  {
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __72__PLModelMigrator__repairReframedAssetsWithoutSOCAvailableBitWithStore___block_invoke_2;
    v18[3] = &unk_1E7568EB0;
    v18[4] = &v20;
    v10 = [v3 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v18];
    v11 = v10 == 0;
    if (v10)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = NSStringFromSelector(*(a1 + 32));
        v14 = [v10 userInfo];
        *buf = 138543874;
        v25 = v13;
        v26 = 2112;
        v27 = v10;
        v28 = 2112;
        v29 = v14;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = *(v21 + 6);
        *buf = 67109120;
        LODWORD(v25) = v16;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Repaired %d assets without soc available bit.", buf, 8u);
      }
    }
  }

  else
  {
    v10 = PLMigrationGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v15 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v25 = v15;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@: failed to fetch assets for fetch request with error: %@", buf, 0x16u);
    }

    v11 = 0;
  }

  _Block_object_dispose(&v20, 8);
  return v11;
}

void __72__PLModelMigrator__repairReframedAssetsWithoutSOCAvailableBitWithStore___block_invoke_2(uint64_t a1, void *a2)
{
  v8 = a2;
  v3 = [v8 cameraProcessingAdjustmentState];
  v4 = v8;
  if ((v3 & 1) == 0)
  {
    [v8 setCameraProcessingAdjustmentState:{objc_msgSend(v8, "cameraProcessingAdjustmentState") | 1}];
    if ([v8 cloudLocalState] == 2)
    {
      [v8 setCloudLocalState:0];
    }

    v5 = [v8 master];
    v6 = [v5 cloudLocalState];

    if (v6 == 2)
    {
      v7 = [v8 master];
      [v7 setCloudLocalState:0];
    }

    ++*(*(*(a1 + 32) + 8) + 24);
    v4 = v8;
  }
}

- (BOOL)_migrateMetadataAndMigrationHistoryWithStore:(id)a3
{
  v4 = a3;
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __64__PLModelMigrator__migrateMetadataAndMigrationHistoryWithStore___block_invoke;
  v7[3] = &unk_1E7569500;
  v8 = v4;
  v9 = self;
  v5 = v4;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _migrateMetadataAndMigrationHistoryWithStore:]" store:v5 migrationHandler:v7];

  return self;
}

uint64_t __64__PLModelMigrator__migrateMetadataAndMigrationHistoryWithStore___block_invoke(uint64_t a1, void *a2)
{
  v75 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v67 = 0;
  v68 = 0;
  v4 = [PLMigrationHistory currentMigrationHistoryIndex:&v68 withManagedObjectContext:v3 error:&v67];
  v5 = v67;
  if (v4)
  {
    if ((v68 & 0x8000000000000000) == 0)
    {
      v6 = PLMigrationGetLog();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v72 = v68;
        _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Migration history already migrated from metadata, curent index: %lld", buf, 0xCu);
      }

      v7 = 1;
      goto LABEL_52;
    }

    v8 = [*(a1 + 32) metadata];
    v6 = [v8 mutableCopy];

    if (!v6)
    {
      v27 = PLMigrationGetLog();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
      {
        *buf = 136446210;
        v72 = "[PLModelMigrator _migrateMetadataAndMigrationHistoryWithStore:]_block_invoke";
        _os_log_impl(&dword_19BF1F000, v27, OS_LOG_TYPE_ERROR, "%{public}s no metadata found in store", buf, 0xCu);
      }

      v7 = 0;
      goto LABEL_51;
    }

    v51 = a1;
    v52 = v5;
    v9 = v3;
    v68 = 0;
    v10 = [v6 allKeys];
    v11 = [v10 sortedArrayUsingSelector:sel_compare_];

    v54 = objc_alloc_init(MEMORY[0x1E695DF70]);
    v63 = 0u;
    v64 = 0u;
    v65 = 0u;
    v66 = 0u;
    v12 = v11;
    v13 = [v12 countByEnumeratingWithState:&v63 objects:v70 count:16];
    v53 = v12;
    if (v13)
    {
      v14 = v13;
      v15 = *v64;
      do
      {
        for (i = 0; i != v14; ++i)
        {
          if (*v64 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v17 = *(*(&v63 + 1) + 8 * i);
          if ([v17 hasPrefix:@"MetadataArchive_"])
          {
            v18 = [v6 objectForKeyedSubscript:v17];
            v19 = [v18 mutableCopy];

            ++v68;
            v20 = [PLMigrationHistory migrateLegacyMigrationHistoryWithMetadata:"migrateLegacyMigrationHistoryWithMetadata:index:outGlobalKeyValues:managedObjectContext:" index:v19 outGlobalKeyValues:? managedObjectContext:?];
            [v54 addObject:v20];
            [v6 removeObjectForKey:v17];

            v12 = v53;
          }
        }

        v14 = [v12 countByEnumeratingWithState:&v63 objects:v70 count:16];
      }

      while (v14);
    }

    v21 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v3 = v9;
    v22 = [PLMigrationHistory migrateLegacyMigrationHistoryWithMetadata:v6 index:v68 outGlobalKeyValues:v21 managedObjectContext:v9];
    [v54 addObject:v22];
    v23 = [*(v51 + 40) pathManager];
    [PLGlobalKeyValue migrateLocaleIdentifierToGlobalKeyValues:v21 withPathManager:v23];

    v24 = v21;
    [PLGlobalKeyValue populateWithDictionary:v21 managedObjectContext:v9 replaceExisting:0];
    v25 = [*(v51 + 32) metadata];
    LOBYTE(v23) = [v25 isEqualToDictionary:v6];

    if (v23)
    {
      v5 = v52;
      if (![v9 hasChanges])
      {
        v26 = PLMigrationGetLog();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "No migration history or global key values found to migrate.", buf, 2u);
        }

        goto LABEL_46;
      }
    }

    else
    {
      [*(v51 + 32) setMetadata:v6];
      [v9 hasChanges];
      v5 = v52;
    }

    v62 = v5;
    v28 = [v9 save:&v62];
    v29 = v62;

    if ((v28 & 1) == 0)
    {
      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        *buf = 136446466;
        v72 = "[PLModelMigrator _migrateMetadataAndMigrationHistoryWithStore:]_block_invoke";
        v73 = 2114;
        v74 = v29;
        _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, "%{public}s failed to save migrated migration history: %{public}@", buf, 0x16u);
      }

      v7 = 0;
      v5 = v29;
      goto LABEL_50;
    }

    v48 = v29;
    v49 = v22;
    v50 = v21;
    v60 = 0u;
    v61 = 0u;
    v58 = 0u;
    v59 = 0u;
    v30 = v54;
    v31 = [v30 countByEnumeratingWithState:&v58 objects:v69 count:16];
    if (v31)
    {
      v32 = v31;
      v33 = *v59;
      do
      {
        for (j = 0; j != v32; ++j)
        {
          if (*v59 != v33)
          {
            objc_enumerationMutation(v30);
          }

          v35 = *(*(&v58 + 1) + 8 * j);
          v36 = PLMigrationGetLog();
          if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138543362;
            v72 = v35;
            _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEFAULT, "Migrated migration history to: %{public}@ ", buf, 0xCu);
          }
        }

        v32 = [v30 countByEnumeratingWithState:&v58 objects:v69 count:16];
      }

      while (v32);
    }

    v37 = PLMigrationGetLog();
    v24 = v50;
    if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138543362;
      v72 = v50;
      _os_log_impl(&dword_19BF1F000, v37, OS_LOG_TYPE_DEFAULT, "Migrated global key values to: %{public}@ ", buf, 0xCu);
    }

    v38 = PLMigrationGetLog();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138543362;
      v72 = v6;
      _os_log_impl(&dword_19BF1F000, v38, OS_LOG_TYPE_DEFAULT, "Migrated library metadata to: %{public}@ ", buf, 0xCu);
    }

    v39 = MEMORY[0x1E695DFF8];
    v40 = [*(v51 + 40) pathManager];
    v41 = [v40 photoDirectoryWithType:8];
    v26 = [v39 fileURLWithPath:v41];

    v42 = [[PLJournal alloc] initWithBaseURL:v26 payloadClass:objc_opt_class()];
    v43 = [v30 objectEnumerator];
    v56[0] = MEMORY[0x1E69E9820];
    v56[1] = 3221225472;
    v56[2] = __64__PLModelMigrator__migrateMetadataAndMigrationHistoryWithStore___block_invoke_2524;
    v56[3] = &unk_1E75696E0;
    v44 = v43;
    v57 = v44;
    v55 = v48;
    LOBYTE(v39) = [(PLJournal *)v42 createSnapshotUsingNextPayloadBlock:v56 createOnlyIfNecessary:0 error:&v55];
    v5 = v55;

    v3 = v9;
    v22 = v49;
    if ((v39 & 1) == 0)
    {
      v45 = v5;
      v46 = PLMigrationGetLog();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
      {
        *buf = 136446466;
        v72 = "[PLModelMigrator _migrateMetadataAndMigrationHistoryWithStore:]_block_invoke_2";
        v73 = 2114;
        v74 = v45;
        _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_ERROR, "%{public}s failed to persist migration history to journal: %{public}@", buf, 0x16u);
      }

      v5 = v45;
      v24 = v50;
    }

LABEL_46:
    v7 = 1;
LABEL_50:

    v27 = v53;
LABEL_51:

    goto LABEL_52;
  }

  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    *buf = 136446466;
    v72 = "[PLModelMigrator _migrateMetadataAndMigrationHistoryWithStore:]_block_invoke";
    v73 = 2114;
    v74 = v5;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "%{public}s unable to query current history index, %{public}@", buf, 0x16u);
  }

  v7 = 0;
LABEL_52:

  return v7;
}

id __64__PLModelMigrator__migrateMetadataAndMigrationHistoryWithStore___block_invoke_2524(uint64_t a1)
{
  v1 = [*(a1 + 32) nextObject];
  v2 = v1;
  if (v1)
  {
    v3 = [v1 payloadForChangedKeys:0];
  }

  else
  {
    v3 = 0;
  }

  return v3;
}

- (BOOL)_moveGpsHorizontalAccuracyToNewAttribute:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __60__PLModelMigrator__moveGpsHorizontalAccuracyToNewAttribute___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _moveGpsHorizontalAccuracyToNewAttribute:]" store:a3 migrationHandler:v4];
}

uint64_t __60__PLModelMigrator__moveGpsHorizontalAccuracyToNewAttribute___block_invoke(uint64_t a1, void *a2)
{
  v26[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != nil", @"locationData"];
  [v6 setPredicate:v7];

  v26[0] = @"additionalAttributes";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v26 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v18 = 0;
  v19 = &v18;
  v20 = 0x2020000000;
  v21 = 0;
  v17[0] = MEMORY[0x1E69E9820];
  v17[1] = 3221225472;
  v17[2] = __60__PLModelMigrator__moveGpsHorizontalAccuracyToNewAttribute___block_invoke_2;
  v17[3] = &unk_1E7568EB0;
  v17[4] = &v18;
  v9 = [v3 enumerateObjectsFromFetchRequest:v6 count:0 usingDefaultBatchSizeWithBlock:v17];
  if ([v3 hasChanges])
  {
    v16 = 0;
    v10 = [v3 save:&v16];
    v11 = v16;
    if (v10)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = v19[3];
        *buf = 134217984;
        v23 = v13;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Moved %ld assets' GPS horizontal accuracy.", buf, 0xCu);
      }
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v14 = NSStringFromSelector(*(a1 + 32));
        *buf = 138412546;
        v23 = v14;
        v24 = 2112;
        v25 = v11;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%@: failed to save: %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v10 = 1;
  }

  _Block_object_dispose(&v18, 8);

  return v10;
}

void __60__PLModelMigrator__moveGpsHorizontalAccuracyToNewAttribute___block_invoke_2(uint64_t a1, void *a2)
{
  v10 = a2;
  v3 = [v10 locationData];
  v4 = [v10 dateCreated];
  v5 = [PLManagedAsset newLocationFromLocationData:v3 timestampIfMissing:v4];

  [v5 coordinate];
  v6 = -1.0;
  if (CLLocationCoordinate2DIsValid(v12))
  {
    [v5 horizontalAccuracy];
    if (v7 != 0.0)
    {
      [v5 horizontalAccuracy];
      v6 = v8;
    }
  }

  v9 = [v10 additionalAttributes];
  [v9 setGpsHorizontalAccuracy:v6];

  ++*(*(*(a1 + 32) + 8) + 24);
}

- (BOOL)_migrateCandidateBitsToDeferredProcessingCandidateOptions:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __77__PLModelMigrator__migrateCandidateBitsToDeferredProcessingCandidateOptions___block_invoke;
  v4[3] = &__block_descriptor_46_e32_B16__0__NSManagedObjectContext_8l;
  v5 = 2097154;
  v6 = 16;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _migrateCandidateBitsToDeferredProcessingCandidateOptions:]" store:a3 migrationHandler:v4];
}

uint64_t __77__PLModelMigrator__migrateCandidateBitsToDeferredProcessingCandidateOptions___block_invoke(uint64_t a1, void *a2)
{
  v37[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v37[0] = @"additionalAttributes";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v37 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v7];

  v8 = [MEMORY[0x1E695DF70] array];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 40) | 1u];
  [v8 addObject:v9];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 42) | 1u];
  [v8 addObject:v10];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 44) | 1u];
  [v8 addObject:v11];

  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 40) | *(a1 + 42) | 1u];
  [v8 addObject:v12];

  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 40) | *(a1 + 44) | 1u];
  [v8 addObject:v13];

  v14 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 42) | *(a1 + 44) | 1u];
  [v8 addObject:v14];

  v15 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"cameraProcessingAdjustmentState", *(a1 + 40) | *(a1 + 42) | *(a1 + 44) | 1u];
  [v8 addObject:v15];

  v16 = [MEMORY[0x1E696AB28] orPredicateWithSubpredicates:v8];
  [v6 setPredicate:v16];

  v29 = 0;
  v30 = &v29;
  v31 = 0x2020000000;
  v32 = 0;
  v25[0] = MEMORY[0x1E69E9820];
  v25[1] = 3221225472;
  v25[2] = __77__PLModelMigrator__migrateCandidateBitsToDeferredProcessingCandidateOptions___block_invoke_2;
  v25[3] = &unk_1E7569698;
  v26 = *(a1 + 40);
  v27 = *(a1 + 42);
  v28 = *(a1 + 44);
  v25[4] = &v29;
  v17 = [v3 enumerateObjectsFromFetchRequest:v6 count:0 usingDefaultBatchSizeWithBlock:v25];
  if ([v3 hasChanges])
  {
    v24 = 0;
    v18 = [v3 save:&v24];
    v19 = v24;
    if (v18)
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v21 = v30[3];
        *buf = 134217984;
        v34 = v21;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Migrated %ld soc assets' candidate bits.", buf, 0xCu);
      }
    }

    else
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v22 = NSStringFromSelector(*(a1 + 32));
        *buf = 138412546;
        v34 = v22;
        v35 = 2112;
        v36 = v19;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "%@: failed to save: %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v18 = 1;
  }

  _Block_object_dispose(&v29, 8);

  return v18;
}

void __77__PLModelMigrator__migrateCandidateBitsToDeferredProcessingCandidateOptions___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [v3 cameraProcessingAdjustmentState];
  v5 = *(a1 + 40);
  v6 = [v3 cameraProcessingAdjustmentState];
  if ((v5 & v4) != 0)
  {
    v7 = 5;
  }

  else
  {
    v7 = 4;
  }

  if ((*(a1 + 42) & v6) != 0)
  {
    LODWORD(v8) = v7;
  }

  else
  {
    LODWORD(v8) = (v5 & v4) != 0;
  }

  if ((*(a1 + 44) & [v3 cameraProcessingAdjustmentState]) != 0)
  {
    v8 = v8 | 2;
  }

  else
  {
    v8 = v8;
  }

  v9 = [v3 additionalAttributes];
  [v9 setDeferredProcessingCandidateOptions:v8];

  [v3 setCameraProcessingAdjustmentState:{objc_msgSend(v3, "cameraProcessingAdjustmentState") & ((*(a1 + 44) | *(a1 + 40) | *(a1 + 42)) ^ 0xFFFF)}];
  ++*(*(*(a1 + 32) + 8) + 24);
}

- (BOOL)_runPairingForAssetsInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __47__PLModelMigrator__runPairingForAssetsInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _runPairingForAssetsInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __47__PLModelMigrator__runPairingForAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v18 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = objc_alloc_init(PLPairing);
  v13 = 0;
  [(PLPairing *)v4 processPairingForEntireLibraryInContext:v3 error:&v13];
  v5 = v13;
  if (v5)
  {
    v6 = PLMigrationGetLog();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v15 = v5;
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "Error while attempting to pair CTM assets in the library: %@", buf, 0xCu);
    }

    v7 = 0;
LABEL_13:

    goto LABEL_14;
  }

  if ([v3 hasChanges])
  {
    v12 = 0;
    v7 = [v3 save:&v12];
    v6 = v12;
    v8 = PLMigrationGetLog();
    v9 = v8;
    if (v7)
    {
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Processed assets for CTM pairing.", buf, 2u);
      }
    }

    else if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v10 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412546;
      v15 = v10;
      v16 = 2112;
      v17 = v6;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "%@: failed to save: %@", buf, 0x16u);
    }

    goto LABEL_13;
  }

  v7 = 1;
LABEL_14:

  return v7;
}

- (BOOL)_scavengeCameraProcessingAdjustmentMetadataForAssetsInStore:(id)a3
{
  v5 = a3;
  v6 = [MEMORY[0x1E695DF00] dateWithTimeIntervalSinceReferenceDate:590400000.0];
  v18[0] = 0;
  v18[1] = v18;
  v18[2] = 0x2020000000;
  v18[3] = 0;
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke;
  aBlock[3] = &unk_1E75695F8;
  aBlock[4] = v18;
  v7 = _Block_copy(aBlock);
  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke_2;
  v11[3] = &unk_1E7569670;
  v8 = v6;
  v12 = v8;
  v13 = @"IMG_S";
  v9 = v7;
  v15 = v18;
  v16 = a2;
  v14 = v9;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _scavengeCameraProcessingAdjustmentMetadataForAssetsInStore:]" store:v5 migrationHandler:v11];

  _Block_object_dispose(v18, 8);
  return self;
}

void __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke(uint64_t a1, void *a2, int a3)
{
  v14 = a2;
  v5 = [v14 additionalAttributes];
  v6 = [v5 spatialOverCaptureGroupIdentifier];

  v7 = v14;
  if (!v6)
  {
    v8 = [v14 metadataFromMediaPropertiesOrOriginalResource];
    v9 = [v8 spatialOverCaptureIdentifier];
    if (v9)
    {
      v10 = [v14 additionalAttributes];
      [v10 setSpatialOverCaptureGroupIdentifier:v9];

      if (a3 && [v14 hasAdjustments])
      {
        v11 = [v14 additionalAttributes];
        v12 = [v11 unmanagedAdjustment];
        v13 = [v12 adjustmentRenderTypes];

        if ((v13 & 0x10) != 0)
        {
          [v14 setCameraProcessingAdjustmentState:{objc_msgSend(v14, "cameraProcessingAdjustmentState") | 4}];
        }

        if ((v13 & 0x20) != 0)
        {
          [v14 setCameraProcessingAdjustmentState:{objc_msgSend(v14, "cameraProcessingAdjustmentState") | 4}];
          [v14 setCameraProcessingAdjustmentState:{objc_msgSend(v14, "cameraProcessingAdjustmentState") | 8}];
        }
      }

      ++*(*(*(a1 + 32) + 8) + 24);
    }

    v7 = v14;
  }
}

uint64_t __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v34[2] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K > %@ AND %K BEGINSWITH[c] %@", @"dateCreated", *(a1 + 32), @"additionalAttributes.originalFilename", *(a1 + 40)];
  [v6 setPredicate:v7];

  v34[0] = @"master.mediaMetadata";
  v34[1] = @"additionalAttributes";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v34 count:2];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v9 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v25[0] = MEMORY[0x1E69E9820];
  v25[1] = 3221225472;
  v25[2] = __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke_3;
  v25[3] = &unk_1E7569620;
  v28 = *(a1 + 48);
  v26 = *(a1 + 40);
  v10 = v9;
  v27 = v10;
  v11 = [v3 enumerateObjectsFromFetchRequest:v6 count:0 usingDefaultBatchSizeWithBlock:v25];
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K > %@ AND %K IN %@", @"dateCreated", *(a1 + 32), @"additionalAttributes.originalFilename", v10];
  [v6 setPredicate:v12];

  v33[0] = @"master.mediaMetadata";
  v33[1] = @"additionalAttributes";
  v33[2] = @"additionalAttributes.unmanagedAdjustment";
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v33 count:3];
  [v6 setRelationshipKeyPathsForPrefetching:v13];

  v23[0] = MEMORY[0x1E69E9820];
  v23[1] = 3221225472;
  v23[2] = __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke_4;
  v23[3] = &unk_1E7569648;
  v24 = *(a1 + 48);
  v14 = [v3 enumerateObjectsFromFetchRequest:v6 count:0 usingDefaultBatchSizeWithBlock:v23];
  if ([v3 hasChanges])
  {
    v22 = 0;
    v15 = [v3 save:&v22];
    v16 = v22;
    v17 = PLMigrationGetLog();
    v18 = v17;
    if (v15)
    {
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v19 = *(*(*(a1 + 56) + 8) + 24);
        *buf = 134217984;
        v30 = v19;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Scavenged camera processing adjustment metadata for %ld assets.", buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v20 = NSStringFromSelector(*(a1 + 64));
      *buf = 138412546;
      v30 = v20;
      v31 = 2112;
      v32 = v16;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%@: failed to save: %@", buf, 0x16u);
    }
  }

  else
  {
    v15 = 1;
  }

  return v15;
}

void __79__PLModelMigrator__scavengeCameraProcessingAdjustmentMetadataForAssetsInStore___block_invoke_3(uint64_t a1, void *a2)
{
  v3 = *(a1 + 48);
  v4 = *(v3 + 16);
  v5 = a2;
  v4(v3, v5, 0);
  v7 = [v5 originalFilename];

  v6 = [v7 stringByReplacingCharactersInRange:objc_msgSend(*(a1 + 32) withString:{"length") - 1, 1, &stru_1F0F06D80}];
  if ([v6 length])
  {
    [*(a1 + 40) addObject:v6];
  }
}

- (BOOL)_fixUnpushedVideoComplementResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __63__PLModelMigrator__fixUnpushedVideoComplementResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _fixUnpushedVideoComplementResourcesInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __63__PLModelMigrator__fixUnpushedVideoComplementResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v43[2] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v43[0] = @"modernResources";
  v43[1] = @"master";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v43 count:2];
  [v6 setRelationshipKeyPathsForPrefetching:v7];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d && %K == %d && %K != NULL", @"kind", 0, @"kindSubtype", 2, @"master"];
  [v6 setPredicate:v8];
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 0;
  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v23 = 0;
  v24 = &v23;
  v25 = 0x2020000000;
  v26 = 0;
  v22 = 0;
  v9 = [v3 executeFetchRequest:v6 error:&v22];
  v10 = v22;
  if (v9)
  {
    v21[0] = MEMORY[0x1E69E9820];
    v21[1] = 3221225472;
    v21[2] = __63__PLModelMigrator__fixUnpushedVideoComplementResourcesInStore___block_invoke_2;
    v21[3] = &unk_1E7568FC8;
    v21[4] = &v27;
    v21[5] = &v31;
    v21[6] = &v23;
    v11 = [v3 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:v21];

    if (v11)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = NSStringFromSelector(*(a1 + 32));
        *buf = 138543618;
        v36 = v13;
        v37 = 2114;
        v38 = v11;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: save failed: %{public}@", buf, 0x16u);
      }

      v14 = 0;
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v16 = NSStringFromSelector(*(a1 + 32));
        v17 = v28[3];
        v18 = v32[3];
        v19 = v24[3];
        *buf = 138544130;
        v36 = v16;
        v37 = 2048;
        v38 = v17;
        v39 = 2048;
        v40 = v18;
        v41 = 2048;
        v42 = v19;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@: resources repushed: %lu, resources created: %lu, resource creation failed: %lu", buf, 0x2Au);
      }

      v11 = 0;
      v14 = 1;
    }
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v15 = NSStringFromSelector(*(a1 + 32));
      *buf = 138543618;
      v36 = v15;
      v37 = 2114;
      v38 = v10;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%{public}@: fetch failed: %{public}@", buf, 0x16u);
    }

    v14 = 0;
    v11 = v10;
  }

  _Block_object_dispose(&v23, 8);
  _Block_object_dispose(&v27, 8);
  _Block_object_dispose(&v31, 8);

  return v14;
}

void __63__PLModelMigrator__fixUnpushedVideoComplementResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 firstPersistedResourceMatching:&__block_literal_global_2494];
  if (v4)
  {
    v5 = v4;
    if (![v4 cloudLocalState])
    {
      v6 = [v5 fingerprint];

      if (!v6)
      {
        v7 = 32;
LABEL_7:
        ++*(*(*(a1 + v7) + 8) + 24);
        v9 = [v3 master];
        [v9 setCloudLocalState:0];

        [v3 setCloudLocalState:0];
      }
    }
  }

  else
  {
    v8 = [PLResourceInstaller onDemand_installOriginalVideoComplementResourceIfPresentForAsset:v3];
    if (v8)
    {
      v5 = v8;
      v7 = 40;
      goto LABEL_7;
    }

    ++*(*(*(a1 + 48) + 8) + 24);
    v10 = PLBackendGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = [v3 uuid];
      v12 = [v3 pathForVideoComplementFile];
      v13 = 138543618;
      v14 = v11;
      v15 = 2114;
      v16 = v12;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "Unable to create resource for original video complement for asset uuid: %{public}@, resource is missing from CPL and not locally available at path: %{public}@", &v13, 0x16u);
    }

    v5 = 0;
  }
}

- (BOOL)_fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __74__PLModelMigrator__fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore:]" store:a3 migrationHandler:v4];
}

BOOL __74__PLModelMigrator__fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = objc_alloc_init(MEMORY[0x1E695DF90]);
  v5 = +[PLInternalResource fetchRequest];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d && %K == %d", @"cloudLocalState", 3, @"remoteAvailability", 0];
  [v5 setPredicate:v6];
  v18 = 0;
  v7 = [v3 executeFetchRequest:v5 error:&v18];
  v8 = v18;
  if (v7)
  {
    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = __74__PLModelMigrator__fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore___block_invoke_2;
    v16[3] = &unk_1E7577F08;
    v17 = v4;
    v9 = [v3 enumerateWithIncrementalSaveUsingObjects:v7 withBlock:v16];

    v10 = v9 == 0;
    if (v9)
    {
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        v12 = NSStringFromSelector(*(a1 + 32));
        *buf = 138543362;
        v20 = v12;
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%{public}@: failed", buf, 0xCu);
      }
    }

    v13 = v17;
    v8 = v9;
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = NSStringFromSelector(*(a1 + 32));
      *buf = 138543362;
      v20 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%{public}@: fetch failed", buf, 0xCu);
    }

    v10 = 0;
  }

  [v4 enumerateKeysAndObjectsUsingBlock:&__block_literal_global_2489];
  return v10;
}

void __74__PLModelMigrator__fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v10 = a2;
  [v10 setRemoteAvailability:1];
  v3 = *(a1 + 32);
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v10, "cplType")}];
  v5 = [v3 objectForKeyedSubscript:v4];

  if (v5)
  {
    v6 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v5, "unsignedIntegerValue") + 1}];
    v7 = *(a1 + 32);
    v8 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v10, "cplType")}];
    [v7 setObject:v6 forKeyedSubscript:v8];
  }

  else
  {
    v9 = *(a1 + 32);
    v6 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v10, "cplType")}];
    [v9 setObject:&unk_1F0FBBF80 forKeyedSubscript:v6];
  }
}

void __74__PLModelMigrator__fixUploadedButNotRemotelyAvailalbeCPLResourcesInStore___block_invoke_2486(uint64_t a1, void *a2, void *a3)
{
  v11 = *MEMORY[0x1E69E9840];
  v4 = a2;
  v5 = a3;
  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = 134218240;
    v8 = [v5 unsignedIntegerValue];
    v9 = 2048;
    v10 = [v4 unsignedIntegerValue];
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "fixed remote availability for %lu resources with cpl type %lu", &v7, 0x16u);
  }
}

- (BOOL)_fixSharedStreamVideoResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __57__PLModelMigrator__fixSharedStreamVideoResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _fixSharedStreamVideoResourcesInStore:]" store:a3 migrationHandler:v4];
}

uint64_t __57__PLModelMigrator__fixSharedStreamVideoResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v34[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v34[0] = @"modernResources";
  v7 = [MEMORY[0x1E695DEC8] arrayWithObjects:v34 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v7];

  v8 = MEMORY[0x1E696AB28];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kind", 1];
  v33[0] = v9;
  v10 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v33[1] = v10;
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v33 count:2];
  v12 = [v8 andPredicateWithSubpredicates:v11];

  [v6 setPredicate:v12];
  v26 = 0;
  v13 = [v3 executeFetchRequest:v6 error:&v26];
  v14 = v26;
  if (v13)
  {
    v23[0] = MEMORY[0x1E69E9820];
    v23[1] = 3221225472;
    v23[2] = __57__PLModelMigrator__fixSharedStreamVideoResourcesInStore___block_invoke_2;
    v23[3] = &unk_1E75708F0;
    v25 = &v27;
    v24 = v3;
    v15 = [v24 enumerateWithIncrementalSaveUsingObjects:v13 withBlock:v23];

    if (v15)
    {
      v16 = PLMigrationGetLog();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = NSStringFromSelector(*(a1 + 32));
        *buf = 138543362;
        v32 = v17;
        _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%{public}@: failed", buf, 0xCu);
      }

      v18 = 0;
      v14 = v15;
    }

    else
    {

      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v21 = v28[3];
        *buf = 134217984;
        v32 = v21;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "added %lu shared stream video resources", buf, 0xCu);
      }

      v18 = 1;
    }
  }

  else
  {
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v20 = NSStringFromSelector(*(a1 + 32));
      *buf = 138543362;
      v32 = v20;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "%{public}@: fetch failed", buf, 0xCu);
    }

    v18 = 0;
  }

  _Block_object_dispose(&v27, 8);
  return v18;
}

void __57__PLModelMigrator__fixSharedStreamVideoResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v6 = a2;
  v3 = [v6 modernResources];
  v4 = [v3 objectsPassingTest:&__block_literal_global_2480];

  if (![v4 count])
  {
    v5 = [PLResourceDataStoreManager updateDerivativeResourcesForAsset:v6 forLifecycleEvent:2];
    *(*(*(a1 + 40) + 8) + 24) += [v5 count];
  }

  [*(a1 + 32) refreshObject:v6 mergeChanges:{objc_msgSend(v6, "hasChanges")}];
}

BOOL __57__PLModelMigrator__fixSharedStreamVideoResourcesInStore___block_invoke_3(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 dataStoreSubtype] == 7 || objc_msgSend(v2, "dataStoreSubtype") == 8;

  return v3;
}

- (BOOL)_removeCloudSharedFileAtPath:(id)a3 withFileManager:(id)a4 error:(id *)a5
{
  v25 = *MEMORY[0x1E69E9840];
  v8 = a4;
  v9 = MEMORY[0x1E69BF2A0];
  v10 = a3;
  v11 = [v9 systemLibraryPathManager];
  v12 = MEMORY[0x1E695DFF8];
  v13 = [v11 photoDirectoryWithType:23];
  v14 = [v12 fileURLWithPath:v13];

  v15 = [MEMORY[0x1E695DFF8] fileURLWithPath:v10];

  v20 = 2;
  if ([v8 getRelationship:&v20 ofDirectoryAtURL:v14 toItemAtURL:v15 error:a5])
  {
    if (!v20)
    {
      v18 = [v8 removeItemAtURL:v15 error:a5];
      goto LABEL_7;
    }

    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
    {
      v17 = NSStringFromSelector(a2);
      *buf = 138412546;
      v22 = v17;
      v23 = 2112;
      v24 = v15;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEBUG, "%@: not cloud shared url: %@", buf, 0x16u);
    }
  }

  v18 = 0;
LABEL_7:

  return v18;
}

- (BOOL)_verifyAndFixBrokenLocalAvailabilityForResourceWithFileIDsInStore:(id)a3
{
  v5 = a3;
  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 capabilities];
  v8 = [v7 isCentralizedCacheDeleteCapable];

  if (v8)
  {
    v10[0] = MEMORY[0x1E69E9820];
    v10[1] = 3221225472;
    v10[2] = __85__PLModelMigrator__verifyAndFixBrokenLocalAvailabilityForResourceWithFileIDsInStore___block_invoke;
    v10[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
    v10[4] = a2;
    [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _verifyAndFixBrokenLocalAvailabilityForResourceWithFileIDsInStore:]" store:v5 migrationHandler:v10];
  }

  return 1;
}

uint64_t __85__PLModelMigrator__verifyAndFixBrokenLocalAvailabilityForResourceWithFileIDsInStore___block_invoke(uint64_t a1, uint64_t a2)
{
  v22 = *MEMORY[0x1E69E9840];
  v12 = 0;
  v13 = 0;
  v10 = 0;
  v11 = 0;
  v3 = [PLCacheDeleteSupport verifyAndFixLocalAvailabilityForMissingResourcesUsingFileIDInManagedObjectContext:a2 countPresent:&v13 countMissing:&v12 countUnableToVerify:&v11 error:&v10];
  v4 = v10;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = NSStringFromSelector(*(a1 + 32));
    *buf = 138544130;
    v15 = v6;
    v16 = 2048;
    v17 = v13;
    v18 = 2048;
    v19 = v12;
    v20 = 2048;
    v21 = v11;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@: Count present: %ld, missing: %ld, unable to verify: %ld\n", buf, 0x2Au);
  }

  if (!v3)
  {
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v8 = NSStringFromSelector(*(a1 + 32));
      *buf = 138543618;
      v15 = v8;
      v16 = 2112;
      v17 = v4;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "%{public}@: encountered errors while verifying fileIDs: %@", buf, 0x16u);
    }
  }

  return 1;
}

- (BOOL)_requestAvailabilityChangeForAssetsMissing1kResourcesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __80__PLModelMigrator__requestAvailabilityChangeForAssetsMissing1kResourcesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _requestAvailabilityChangeForAssetsMissing1kResourcesInStore:]" store:a3 migrationHandler:v4];
}

BOOL __80__PLModelMigrator__requestAvailabilityChangeForAssetsMissing1kResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v36[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v26 = 0;
  v27 = &v26;
  v28 = 0x2020000000;
  v29 = 0;
  v4 = [PLResourceRecipe recipeFromID:65747];
  v5 = [v4 supportedVersionsForLocalResourceGeneration];
  v6 = [v5 firstObject];
  v7 = [v6 integerValue];

  v8 = objc_alloc_init(PLValidatedExternalResource);
  [(PLValidatedExternalResource *)v8 setResourceType:0];
  [(PLValidatedExternalResource *)v8 setVersion:v7];
  [(PLValidatedExternalResource *)v8 setRecipeID:65747];
  v9 = [v4 uti];
  [(PLValidatedExternalResource *)v8 setUniformTypeIdentifier:v9];

  v10 = MEMORY[0x1E695D5E0];
  v11 = +[PLManagedAsset entityName];
  v12 = [v10 fetchRequestWithEntityName:v11];

  v36[0] = @"modernResources";
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v36 count:1];
  [v12 setRelationshipKeyPathsForPrefetching:v13];

  v14 = [v3 executeFetchRequest:v12 error:0];
  v22[0] = MEMORY[0x1E69E9820];
  v22[1] = 3221225472;
  v22[2] = __80__PLModelMigrator__requestAvailabilityChangeForAssetsMissing1kResourcesInStore___block_invoke_2;
  v22[3] = &unk_1E7569590;
  v25 = v7;
  v15 = v4;
  v23 = v15;
  v24 = &v26;
  v16 = [v3 enumerateWithIncrementalSaveUsingObjects:v14 withBlock:v22];
  if (v16)
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = NSStringFromSelector(*(a1 + 32));
      v19 = [v16 userInfo];
      *buf = 138543874;
      v31 = v18;
      v32 = 2112;
      v33 = v16;
      v34 = 2112;
      v35 = v19;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v20 = v27[3];
      *buf = 134217984;
      v31 = v20;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "requested 1k for %lu assets.", buf, 0xCu);
    }
  }

  _Block_object_dispose(&v26, 8);
  return v16 == 0;
}

void __80__PLModelMigrator__requestAvailabilityChangeForAssetsMissing1kResourcesInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v23[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:*(a1 + 48)];
  v23[0] = v4;
  v5 = [MEMORY[0x1E695DEC8] arrayWithObjects:v23 count:1];
  v6 = [PLResourceGenerator expectedLocalResourceRecipesForAsset:v3 versions:v5];

  v7 = MEMORY[0x1E695DFD8];
  v8 = [MEMORY[0x1E696AD98] numberWithUnsignedInt:*(a1 + 48)];
  v9 = [v7 setWithObject:v8];
  v10 = [PLResourceGenerator locallyUnavailableRecipesFromRecipes:v6 versions:v9 asset:v3];

  if ([v10 containsObject:*(a1 + 32)])
  {
    v11 = [*(a1 + 32) chooseIngredientsFrom:v3 version:*(a1 + 48)];

    if (v11)
    {
      v12 = *(a1 + 48);
      v13 = [v3 width];
      v14 = [v3 height];
      v15 = *(a1 + 32);
      LOWORD(v21) = [v3 kind];
      v16 = [PLResourceInstaller generateValidatedExternalImageResourceOfType:0 forFilePath:0 requireFileToBePresent:0 version:v12 basedOnFullSizeWidth:v13 andHeight:v14 recipe:v15 assetKind:v21 error:0];
      v22 = v16;
      v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v22 count:1];
      v18 = [PLResourceDataStoreManager storeExternalResources:v17 forAsset:v3 forLifecycleEvent:2 error:0];

      v19 = [v18 anyObject];
      v20 = v19;
      if (v19)
      {
        [v19 setLocalAvailabilityTarget:1];
        ++*(*(*(a1 + 40) + 8) + 24);
      }
    }
  }
}

- (BOOL)_regenerateReferenceKeyDataInStore:(id)a3
{
  v14[1] = *MEMORY[0x1E69E9840];
  v4 = MEMORY[0x1E695D5E0];
  v5 = a3;
  v6 = +[PLManagedAsset entityName];
  v7 = [v4 fetchRequestWithEntityName:v6];

  v8 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForReferencedAsset"), 1}];
  [v7 setFetchBatchSize:100];
  [v7 setPredicate:v8];
  v14[0] = @"modernResources";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v14 count:1];
  [v7 setRelationshipKeyPathsForPrefetching:v9];

  v10 = objc_opt_class();
  v11 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _regenerateReferenceKeyDataInStore:]"];
  v13[0] = MEMORY[0x1E69E9820];
  v13[1] = 3221225472;
  v13[2] = __54__PLModelMigrator__regenerateReferenceKeyDataInStore___block_invoke;
  v13[3] = &__block_descriptor_40_e28_B24__0__NSManagedObject_8Q16lu32l8;
  v13[4] = v10;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v11 fetchRequest:v7 store:v5 migrationHandler:v13];

  return self;
}

uint64_t __54__PLModelMigrator__regenerateReferenceKeyDataInStore___block_invoke(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x1E69E9840];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v2 = [a2 modernResources];
  v3 = [v2 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v13;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v13 != v5)
        {
          objc_enumerationMutation(v2);
        }

        v7 = *(*(&v12 + 1) + 8 * i);
        if (([v7 isDerivative] & 1) == 0)
        {
          v8 = [v7 dataStoreKey];
          if (objc_opt_isKindOfClass())
          {
            v9 = -[PLPrimaryResourceDataStoreReferenceFileKey initWithResourceType:]([PLPrimaryResourceDataStoreReferenceFileKey alloc], "initWithResourceType:", [v7 resourceType]);
            v10 = [(PLPrimaryResourceDataStoreReferenceFileKey *)v9 keyData];
            [v7 setDataStoreKeyData:v10];
          }
        }
      }

      v4 = [v2 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v4);
  }

  return 1;
}

BOOL __52__PLModelMigrator__fixupResourceTypeUnknownInStore___block_invoke(uint64_t a1, void *a2)
{
  v19[1] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_DEFAULT, "Renumbering PLResourceTypeUnknown from 32 to 31...", buf, 2u);
  }

  v4 = MEMORY[0x1E695D560];
  v5 = +[PLInternalResource entityName];
  v6 = [v4 batchUpdateRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"resourceType", 32];
  [v6 setPredicate:v7];

  v18 = @"resourceType";
  v19[0] = &unk_1F0FBBF68;
  v8 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v19 forKeys:&v18 count:1];
  [v6 setPropertiesToUpdate:v8];

  [v6 setResultType:2];
  v15 = 0;
  v9 = [v2 executeRequest:v6 error:&v15];

  v10 = v15;
  v11 = PLMigrationGetLog();
  v12 = v11;
  if (v9)
  {
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v13 = [v9 result];
      *buf = 138412290;
      v17 = v13;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Batch update to remap PLResourceTypeUnknown from 32 to 31 successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v17 = v10;
    _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "Batch update to remap PLResourceTypeUnknown from 32 to 31 failed, error: %@", buf, 0xCu);
  }

  return v9 != 0;
}

BOOL __80__PLModelMigrator__renumberLocalAvailabilityAndLocalAvailabilityTargetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v28[1] = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = MEMORY[0x1E695D560];
  v4 = +[PLInternalResource entityName];
  v5 = [v3 batchUpdateRequestWithEntityName:v4];

  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"localAvailability", 0];
  [v5 setPredicate:v6];

  v27 = @"localAvailability";
  v28[0] = &unk_1F0FBBF50;
  v7 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:&v27 count:1];
  [v5 setPropertiesToUpdate:v7];

  [v5 setResultType:2];
  v22 = 0;
  v8 = [v2 executeRequest:v5 error:&v22];
  v9 = v22;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v26 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Batch update to remap localAvailability none/0 to none/-1 request successful with result %@", buf, 0xCu);
    }

    v13 = MEMORY[0x1E695D560];
    v14 = +[PLInternalResource entityName];
    v5 = [v13 batchUpdateRequestWithEntityName:v14];

    v23 = @"localAvailabilityTarget";
    v24 = &unk_1F0FBBE00;
    v15 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v24 forKeys:&v23 count:1];
    [v5 setPropertiesToUpdate:v15];

    [v5 setResultType:2];
    v21 = 0;
    v11 = [v2 executeRequest:v5 error:&v21];
    v9 = v21;
    v16 = v11 != 0;
    v17 = PLMigrationGetLog();
    v18 = v17;
    if (v11)
    {
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        v19 = [v11 result];
        *buf = 138412290;
        v26 = v19;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Batch update to remap localAvailabilityTarget to neutral/0 request successful with result %@", buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v26 = v9;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Batch update to remap localAvailabilityTarget to neutral/0 request failed, error: %@", buf, 0xCu);
    }
  }

  else
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v26 = v9;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Batch update to remap localAvailability none/0 to none/-1 request failed, error: %@", buf, 0xCu);
    }

    v16 = 0;
  }

  [v2 reset];
  return v16;
}

- (BOOL)migratePurgeableResources
{
  v14 = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 capabilities];
  v5 = [v4 isCentralizedCacheDeleteCapable];

  v6 = PLMigrationGetLog();
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);
  if (v5)
  {
    if (v7)
    {
      LOWORD(v12) = 0;
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Migrating purgeable resources", &v12, 2u);
    }

    v8 = [(PLModelMigrator *)self pathManager];
    v6 = [PLCPLSettings settingsWithPathManager:v8];

    [v6 setRunOnceFlag:4 error:0];
  }

  else if (v7)
  {
    v9 = [(PLModelMigrator *)self pathManager];
    v10 = [v9 libraryURL];
    v12 = 138412290;
    v13 = v10;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Skip migrating purgeable resources, not supported for library at %@", &v12, 0xCu);
  }

  return 1;
}

- (BOOL)_migrateVideoKeyFrameTimeValuesInStagedStore:(id)a3
{
  v28[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _migrateVideoKeyFrameTimeValuesInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v27[0] = @"videoKeyFrameValue";
  v10 = [MEMORY[0x1E696ABC8] expressionForKeyPath:@"mediaAnalysisAttributes.bestKeyFrameValue"];
  v27[1] = @"videoKeyFrameTimeScale";
  v28[0] = v10;
  v11 = [MEMORY[0x1E696ABC8] expressionForKeyPath:@"mediaAnalysisAttributes.bestKeyFrameTimeScale"];
  v28[1] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:v27 count:2];
  [v9 setPropertiesToUpdate:v12];

  [v9 setResultType:2];
  v20 = 0;
  v13 = [v6 executeRequest:v9 error:&v20];
  v14 = v20;
  v15 = PLMigrationGetLog();
  v16 = v15;
  if (v13)
  {
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v13 result];
      *buf = 138412290;
      v22 = v17;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Migrated %@ assets video key frame values from MediaAnalysisAttributes table to Asset table", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v18 = [v14 userInfo];
    *buf = 136315650;
    v22 = "[PLModelMigrator _migrateVideoKeyFrameTimeValuesInStagedStore:]";
    v23 = 2112;
    v24 = v14;
    v25 = 2112;
    v26 = v18;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  return v13 != 0;
}

- (BOOL)_emptyResourceTablesInStagedStore:(id)a3
{
  v3 = [PLResourceInstaller resetInternalResourcesInStore:a3 resetUTIs:1 resetCodecs:1 resetMasters:0 migrator:self];
  if (!v3)
  {
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      *v6 = 0;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_ERROR, "Failed to empty resource tables.", v6, 2u);
    }
  }

  return v3;
}

- (BOOL)_invalidateReverseGeocodingDataInStore:(id)a3
{
  v4 = a3;
  v12 = 0;
  v13 = &v12;
  v14 = 0x2020000000;
  v15 = 1;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _invalidateReverseGeocodingDataInStore:]" concurrencyType:1];
  v9[0] = MEMORY[0x1E69E9820];
  v9[1] = 3221225472;
  v9[2] = __58__PLModelMigrator__invalidateReverseGeocodingDataInStore___block_invoke;
  v9[3] = &unk_1E7578910;
  v7 = v6;
  v10 = v7;
  v11 = &v12;
  [v7 performBlockAndWait:v9];

  objc_autoreleasePoolPop(v5);
  LOBYTE(v5) = *(v13 + 24);
  _Block_object_dispose(&v12, 8);

  return v5;
}

void __58__PLModelMigrator__invalidateReverseGeocodingDataInStore___block_invoke(uint64_t a1)
{
  v21[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = +[PLAdditionalAssetAttributes entityName];
  v4 = [v2 batchUpdateRequestWithEntityName:v3];

  v20 = @"reverseLocationDataIsValid";
  v21[0] = MEMORY[0x1E695E110];
  v5 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v21 forKeys:&v20 count:1];
  [v4 setPropertiesToUpdate:v5];

  [v4 setResultType:2];
  v6 = *(a1 + 32);
  v13 = 0;
  v7 = [v6 executeRequest:v4 error:&v13];
  v8 = v13;
  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v7)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v11 = [v7 result];
      *buf = 138412290;
      v15 = v11;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Invalidated reverse geocoding data for %@ assets", buf, 0xCu);
    }
  }

  else
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v12 = [v8 userInfo];
      *buf = 136315650;
      v15 = "[PLModelMigrator _invalidateReverseGeocodingDataInStore:]_block_invoke";
      v16 = 2112;
      v17 = v8;
      v18 = 2112;
      v19 = v12;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
    }

    *(*(*(a1 + 40) + 8) + 24) = 0;
  }
}

- (BOOL)_regenerateSharedStreamsDataStoreKeysDataInStore:(id)a3 deferHintChanges:(BOOL)a4
{
  v16[2] = *MEMORY[0x1E69E9840];
  v6 = MEMORY[0x1E695D5E0];
  v7 = a3;
  v8 = +[PLManagedAsset entityName];
  v9 = [v6 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  [v9 setFetchBatchSize:100];
  [v9 setPredicate:v10];
  v16[0] = @"albums";
  v16[1] = @"modernResources";
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v16 count:2];
  [v9 setRelationshipKeyPathsForPrefetching:v11];

  v12 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _regenerateSharedStreamsDataStoreKeysDataInStore:deferHintChanges:]"];
  v14[0] = MEMORY[0x1E69E9820];
  v14[1] = 3221225472;
  v14[2] = __85__PLModelMigrator__regenerateSharedStreamsDataStoreKeysDataInStore_deferHintChanges___block_invoke;
  v14[3] = &__block_descriptor_33_e28_B24__0__NSManagedObject_8Q16l;
  v15 = a4;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v12 fetchRequest:v9 store:v7 migrationHandler:v14];

  return self;
}

uint64_t __85__PLModelMigrator__regenerateSharedStreamsDataStoreKeysDataInStore_deferHintChanges___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 albums];
  v5 = [v4 anyObject];

  if ([v5 kindValue] == 1505)
  {
    v25 = 0u;
    v26 = 0u;
    v23 = 0u;
    v24 = 0u;
    v6 = [v3 modernResources];
    v7 = [v6 countByEnumeratingWithState:&v23 objects:v27 count:16];
    if (v7)
    {
      v8 = v7;
      v21 = a1;
      v22 = 0;
      v9 = *v24;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v24 != v9)
          {
            objc_enumerationMutation(v6);
          }

          v11 = *(*(&v23 + 1) + 8 * i);
          v12 = [v11 dataStoreKeyData];
          if (v12)
          {
            v13 = v12;
            v14 = [v11 dataStoreClassID];
            v15 = +[PLSharedStreamsDataStore storeClassID];

            if (v14 == v15)
            {
              v16 = -[PLSharedStreamsDataStoreKey initWithAsset:album:type:]([PLSharedStreamsDataStoreKey alloc], "initWithAsset:album:type:", v3, v5, [v11 dataStoreSubtype]);
              v17 = v16;
              if (v16 && ([(PLSharedStreamsDataStoreKey *)v16 keyData], v18 = objc_claimAutoreleasedReturnValue(), v18, v18))
              {
                v19 = [(PLSharedStreamsDataStoreKey *)v17 keyData];
                [v11 setDataStoreKeyData:v19];

                v22 = 1;
              }

              else
              {
                [v11 markAsNotLocallyAvailable];
              }
            }
          }
        }

        v8 = [v6 countByEnumeratingWithState:&v23 objects:v27 count:16];
      }

      while (v8);

      if ((v22 & 1) != 0 && (*(v21 + 32) & 1) == 0)
      {
        [v3 recalculateImageRequestHints];
      }
    }

    else
    {
    }
  }

  return 1;
}

- (BOOL)_fixSidecarUTIsAndDataStoreSubtype:(id)a3
{
  v4 = MEMORY[0x1E695D5E0];
  v5 = a3;
  v6 = +[PLInternalResource entityName];
  v7 = [v4 fetchRequestWithEntityName:v6];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K >= %d AND %K = %d", @"localAvailability", 1, @"resourceType", 5];
  [v7 setPredicate:v8];

  v9 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _fixSidecarUTIsAndDataStoreSubtype:]"];
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v9 fetchRequest:v7 store:v5 migrationHandler:&__block_literal_global_2439];

  return self;
}

uint64_t __54__PLModelMigrator__fixSidecarUTIsAndDataStoreSubtype___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 dataStoreKey];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = [v3 extension];
    v5 = [v4 caseInsensitiveCompare:*MEMORY[0x1E69C0E20]];

    if (!v5)
    {
      v6 = [MEMORY[0x1E69C08F0] supplementalResourceXMPType];
      v7 = [v6 identifier];
      v8 = [PLUniformTypeIdentifier utiWithIdentifier:v7];
      [v2 setUniformTypeIdentifier:v8];
    }
  }

  v9 = [v2 uniformTypeIdentifier];
  v10 = [v9 identifier];
  v11 = [MEMORY[0x1E69C08F0] supplementalResourceAAEType];
  v12 = [v11 identifier];
  if ([v10 isEqualToString:v12])
  {
    v13 = [v2 dataStoreSubtype];

    if (v13 != 22)
    {
      [v2 setDataStoreSubtype:22];
    }
  }

  else
  {
  }

  return 1;
}

- (BOOL)_removeUnneededAnalysisStateTableEntries:(id)a3
{
  v23 = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:a3 name:"[PLModelMigrator _removeUnneededAnalysisStateTableEntries:]" concurrencyType:*MEMORY[0x1E695D708]];
  v4 = objc_alloc(MEMORY[0x1E695D5E0]);
  v5 = +[PLAssetAnalysisState entityName];
  v6 = [v4 initWithEntityName:v5];

  v7 = MEMORY[0x1E696AE18];
  v8 = +[PLAssetAnalysisState workerTypesPersistingAnalysisState];
  v9 = [v7 predicateWithFormat:@"NOT (workerType IN %@)", v8];

  [v6 setPredicate:v9];
  v10 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v6];
  v20 = 0;
  v11 = [v3 executeRequest:v10 error:&v20];
  v12 = v20;
  v13 = PLMigrationGetLog();
  v14 = v13;
  if (v11)
  {
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v15 = "deleted unused analysis state table entries";
      v16 = v14;
      v17 = OS_LOG_TYPE_DEFAULT;
      v18 = 2;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v16, v17, v15, buf, v18);
    }
  }

  else if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v22 = v12;
    v15 = "error deleting unused analysis state table entries: %@";
    v16 = v14;
    v17 = OS_LOG_TYPE_ERROR;
    v18 = 12;
    goto LABEL_6;
  }

  return v11 != 0;
}

- (BOOL)_reconstructImageExtendedAttributes:(id)a3
{
  v13[1] = *MEMORY[0x1E69E9840];
  v4 = MEMORY[0x1E695D5E0];
  v5 = a3;
  v6 = +[PLManagedAsset entityName];
  v7 = [v4 fetchRequestWithEntityName:v6];

  v13[0] = @"master";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v13 count:1];
  [v7 setRelationshipKeyPathsForPrefetching:v8];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind == %d AND extendedAttributes != nil AND extendedAttributes.iso == 0", 0];
  [v7 setPredicate:v9];

  v10 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _reconstructImageExtendedAttributes:]"];
  v12[0] = MEMORY[0x1E69E9820];
  v12[1] = 3221225472;
  v12[2] = __55__PLModelMigrator__reconstructImageExtendedAttributes___block_invoke;
  v12[3] = &unk_1E7569250;
  v12[4] = self;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v10 fetchRequest:v7 store:v5 migrationHandler:v12];

  return self;
}

uint64_t __55__PLModelMigrator__reconstructImageExtendedAttributes___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 newShortLivedLibraryWithName:"-[PLModelMigrator _reconstructImageExtendedAttributes:]_block_invoke"];
  v5 = objc_alloc(MEMORY[0x1E69C0718]);
  v6 = [v3 imageProperties];
  v7 = MEMORY[0x1E69C08F0];
  v8 = [v3 uniformTypeIdentifier];
  v9 = [v7 typeWithIdentifier:v8];
  v10 = [v4 libraryBundle];
  v11 = [v10 timeZoneLookup];
  v12 = [v5 initWithImageProperties:v6 contentType:v9 timeZoneLookup:v11];

  [v3 updateImageExtendedAttributesFromMetadata:v12];
  return 1;
}

- (BOOL)_updateAlbumDatesInStore:(id)a3
{
  v4 = a3;
  v12 = 0;
  v13 = &v12;
  v14 = 0x2020000000;
  v15 = 1;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _updateAlbumDatesInStore:]" concurrencyType:1];
  v9[0] = MEMORY[0x1E69E9820];
  v9[1] = 3221225472;
  v9[2] = __44__PLModelMigrator__updateAlbumDatesInStore___block_invoke;
  v9[3] = &unk_1E7578910;
  v7 = v6;
  v10 = v7;
  v11 = &v12;
  [v7 performBlockAndWait:v9];

  objc_autoreleasePoolPop(v5);
  LOBYTE(v5) = *(v13 + 24);
  _Block_object_dispose(&v12, 8);

  return v5;
}

void __44__PLModelMigrator__updateAlbumDatesInStore___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x1E69E9840];
  [PLPhotoLibrary refreshCachedCountsAndDates:1 onAssetsContainerClass:objc_opt_class() inContext:*(a1 + 32) withPredicate:0];
  if ([*(a1 + 32) hasChanges])
  {
    v2 = PLMigrationGetLog();
    if (os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT))
    {
      v3 = [*(a1 + 32) updatedObjects];
      *buf = 134217984;
      v10 = [v3 count];
      _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_DEFAULT, "Updating dates on %ld albums", buf, 0xCu);
    }

    v4 = *(a1 + 32);
    v8 = 0;
    v5 = [v4 save:&v8];
    v6 = v8;
    if ((v5 & 1) == 0)
    {
      v7 = PLBackendGetLog();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v10 = v6;
        _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "Failed to update dates on albums %@", buf, 0xCu);
      }

      *(*(*(a1 + 40) + 8) + 24) = 0;
    }
  }
}

- (BOOL)_updateCPLMarkerFiles
{
  v47 = *MEMORY[0x1E69E9840];
  v3 = [MEMORY[0x1E696AC08] defaultManager];
  v4 = [@"/var/mobile/Media/PhotoData" stringByAppendingPathComponent:@"pauseICloudPhotos"];
  if (![v3 fileExistsAtPath:v4])
  {
    v8 = 0;
    goto LABEL_10;
  }

  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 pauseICloudPhotosFilePath];

  v40 = 0;
  v7 = [v3 moveItemAtPath:v4 toPath:v6 error:&v40];
  v8 = v40;
  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v7)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v42 = v4;
      v43 = 2112;
      v44 = v6;
      v11 = "Migrated pause marker from %@ to %@";
      v12 = v10;
      v13 = OS_LOG_TYPE_DEFAULT;
      v14 = 22;
LABEL_8:
      _os_log_impl(&dword_19BF1F000, v12, v13, v11, buf, v14);
    }
  }

  else if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412802;
    v42 = v4;
    v43 = 2112;
    v44 = v6;
    v45 = 2112;
    v46 = v8;
    v11 = "Failed to migrate pause marker from %@ to %@: %@";
    v12 = v10;
    v13 = OS_LOG_TYPE_ERROR;
    v14 = 32;
    goto LABEL_8;
  }

LABEL_10:
  v15 = [@"/var/mobile/Media/PhotoData" stringByAppendingPathComponent:@"enableICloudPhotos"];
  if (![v3 fileExistsAtPath:v15])
  {
    v19 = v8;
    goto LABEL_19;
  }

  v16 = [(PLModelMigrator *)self pathManager];
  v17 = [v16 enableICloudPhotosFilePath];

  v39 = v8;
  v18 = [v3 moveItemAtPath:v15 toPath:v17 error:&v39];
  v19 = v39;

  v20 = PLMigrationGetLog();
  v21 = v20;
  if (v18)
  {
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412546;
      v42 = v15;
      v43 = 2112;
      v44 = v17;
      v22 = "Migrated enable marker from %@ to %@";
      v23 = v21;
      v24 = OS_LOG_TYPE_DEFAULT;
      v25 = 22;
LABEL_17:
      _os_log_impl(&dword_19BF1F000, v23, v24, v22, buf, v25);
    }
  }

  else if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412802;
    v42 = v15;
    v43 = 2112;
    v44 = v17;
    v45 = 2112;
    v46 = v19;
    v22 = "Failed to migrate enable marker from %@ to %@: %@";
    v23 = v21;
    v24 = OS_LOG_TYPE_ERROR;
    v25 = 32;
    goto LABEL_17;
  }

LABEL_19:
  v26 = [@"/var/mobile/Media/PhotoData" stringByAppendingPathComponent:@"disableICloudPhotos"];
  if ([v3 fileExistsAtPath:v26])
  {
    v27 = [(PLModelMigrator *)self pathManager];
    v28 = [v27 disableICloudPhotosFilePath];

    v38 = v19;
    v29 = [v3 moveItemAtPath:v26 toPath:v28 error:&v38];
    v30 = v38;

    v31 = PLMigrationGetLog();
    v32 = v31;
    if (v29)
    {
      if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        v42 = v15;
        v43 = 2112;
        v44 = v28;
        v33 = "Migrated disable marker from %@ to %@";
        v34 = v32;
        v35 = OS_LOG_TYPE_DEFAULT;
        v36 = 22;
LABEL_26:
        _os_log_impl(&dword_19BF1F000, v34, v35, v33, buf, v36);
      }
    }

    else if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412802;
      v42 = v26;
      v43 = 2112;
      v44 = v28;
      v45 = 2112;
      v46 = v30;
      v33 = "Failed to migrate disable marker from %@ to %@: %@";
      v34 = v32;
      v35 = OS_LOG_TYPE_ERROR;
      v36 = 32;
      goto LABEL_26;
    }

    goto LABEL_28;
  }

  v30 = v19;
LABEL_28:

  return 1;
}

- (BOOL)_updateMissingFileSystemVolumeUuidInStore:(id)a3
{
  v4 = MEMORY[0x1E695D5E0];
  v5 = a3;
  v6 = +[PLFileSystemVolume entityName];
  v7 = [v4 fetchRequestWithEntityName:v6];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"uuid == nil"];
  [v7 setPredicate:v8];

  v9 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _updateMissingFileSystemVolumeUuidInStore:]"];
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v9 fetchRequest:v7 store:v5 migrationHandler:&__block_literal_global_2413];

  return self;
}

uint64_t __61__PLModelMigrator__updateMissingFileSystemVolumeUuidInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = MEMORY[0x1E69BF320];
  v3 = a2;
  v4 = [v2 UUIDString];
  [v3 setUuid:v4];

  return 1;
}

- (BOOL)_deleteExtraneousAdjustedFullSizeResourcesForSloMoAssetsWithStore:(id)a3
{
  v29[4] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _deleteExtraneousAdjustedFullSizeResourcesForSloMoAssetsWithStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLInternalResource entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"asset.%K == %d", @"kindSubtype", 101];
  v29[0] = v11;
  v12 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:@"asset"];
  v29[1] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K <= %d", @"localAvailability", 0xFFFFFFFFLL];
  v29[2] = v13;
  v14 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"remoteAvailability", 0];
  v29[3] = v14;
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:v29 count:4];
  v16 = [v10 andPredicateWithSubpredicates:v15];
  [v9 setPredicate:v16];

  v17 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
  [v17 setResultType:2];
  v24 = 0;
  v18 = [v6 executeRequest:v17 error:&v24];
  v19 = v24;
  v20 = PLMigrationGetLog();
  v21 = v20;
  if (v18)
  {
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v22 = [v18 result];
      *buf = 136315394;
      v26 = "[PLModelMigrator _deleteExtraneousAdjustedFullSizeResourcesForSloMoAssetsWithStore:]";
      v27 = 2112;
      v28 = v22;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "%s deleted %@ resource rows.", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
  {
    *buf = 136315394;
    v26 = "[PLModelMigrator _deleteExtraneousAdjustedFullSizeResourcesForSloMoAssetsWithStore:]";
    v27 = 2112;
    v28 = v19;
    _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "%s failed: %@", buf, 0x16u);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v18 != 0;
}

- (BOOL)_fixImportedAssetsFromCMMSavedInDCIMWithWrongSavedAssetType:(id)a3
{
  v46[3] = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v5 = *MEMORY[0x1E695D708];
  v35 = v4;
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixImportedAssetsFromCMMSavedInDCIMWithWrongSavedAssetType:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"additionalAttributes.importedBy", 7];
  v46[0] = v11;
  v12 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudPhotoLibraryAsset"), 1}];
  v46[1] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K CONTAINS %@", @"directory", @"DCIM"];
  v46[2] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v46 count:3];
  v15 = [v10 andPredicateWithSubpredicates:v14];
  [v9 setPredicate:v15];

  [v9 setResultType:1];
  v37 = 0;
  v16 = [v6 executeFetchRequest:v9 error:&v37];
  v17 = v37;
  if (!v16)
  {
    v18 = PLMigrationGetLog();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v31 = [v17 userInfo];
      *buf = 136315650;
      v41 = "[PLModelMigrator _fixImportedAssetsFromCMMSavedInDCIMWithWrongSavedAssetType:]";
      v42 = 2112;
      v43 = v17;
      v44 = 2112;
      v45 = v31;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%s: failed to fetch object IDs: %@ %@", buf, 0x20u);
    }

    v27 = 0;
    goto LABEL_13;
  }

  if ([v16 count])
  {
    v33 = v6;
    v18 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixImportedAssetsFromCMMSavedInDCIMWithWrongSavedAssetType:]" concurrencyType:v5];
    v19 = MEMORY[0x1E695D560];
    v20 = +[PLManagedAsset entityName];
    v21 = [v19 batchUpdateRequestWithEntityName:v20];

    v22 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self in %@", v16];
    [v21 setPredicate:v22];

    v38 = @"savedAssetType";
    v23 = [MEMORY[0x1E696AD98] numberWithShort:{objc_msgSend(MEMORY[0x1E69BF328], "savedAssetTypeForCameraAsset")}];
    v39 = v23;
    v24 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v39 forKeys:&v38 count:1];
    [v21 setPropertiesToUpdate:v24];

    [v21 setResultType:2];
    v36 = 0;
    v25 = [v18 executeRequest:v21 error:&v36];
    v26 = v36;
    v27 = v25 != 0;
    v28 = PLMigrationGetLog();
    v29 = v28;
    if (v25)
    {
      if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
      {
        v30 = [v25 result];
        *buf = 138412290;
        v41 = v30;
        _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_DEFAULT, "Set savedAssetType to Camera for %@ imported CMM assets that are saved in DCIM folder with CloudPhotoLibrary savedAssetType", buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v41 = v26;
      _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_ERROR, "Failed to fix imported CMM assets that are saved in DCIM folder with CloudPhotoLibrary savedAssetType with error with error %@", buf, 0xCu);
    }

    v6 = v33;
LABEL_13:

    goto LABEL_14;
  }

  v27 = 1;
LABEL_14:

  objc_autoreleasePoolPop(context);
  return v27;
}

- (BOOL)_resetAnalysisStateForVideosInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __55__PLModelMigrator__resetAnalysisStateForVideosInStore___block_invoke;
  v4[3] = &unk_1E7569528;
  v4[4] = self;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _resetAnalysisStateForVideosInStore:]" store:a3 migrationHandler:v4];
}

- (BOOL)_deleteVideoThumbsMadeFromPreferredFrameInStore:(id)a3
{
  v4 = a3;
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __67__PLModelMigrator__deleteVideoThumbsMadeFromPreferredFrameInStore___block_invoke;
  v7[3] = &unk_1E7569500;
  v7[4] = self;
  v8 = v4;
  v5 = v4;
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _deleteVideoThumbsMadeFromPreferredFrameInStore:]" store:v5 migrationHandler:v7];

  return self;
}

uint64_t __67__PLModelMigrator__deleteVideoThumbsMadeFromPreferredFrameInStore___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND %K != 0", @"kind", 1, @"videoKeyFrameValue"];
  [v6 setPredicate:v7];

  [v6 setFetchBatchSize:100];
  v20 = 0;
  v8 = [v3 executeFetchRequest:v6 error:&v20];
  v9 = v20;
  v10 = [v8 count];
  if (v8)
  {
    v11 = v10;
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __67__PLModelMigrator__deleteVideoThumbsMadeFromPreferredFrameInStore___block_invoke_2;
    v18[3] = &unk_1E75781C0;
    v12 = *(a1 + 40);
    v18[4] = *(a1 + 32);
    v19 = v12;
    v13 = [v3 enumerateWithIncrementalSaveUsingObjects:v8 shouldRefreshAfterSave:1 withBlock:v18];

    if (!v13)
    {
      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v22 = v11;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Deleted thumbnails for %lu video assets with non-zero videoKeyFrame values and marked for rebuild", buf, 0xCu);
      }

      v14 = 1;
      goto LABEL_12;
    }
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v22 = v9;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Failed to fetch video assets with non-zero videoKeyFrame values with error %@", buf, 0xCu);
    }

    v13 = 0;
  }

  v16 = PLMigrationGetLog();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v22 = v13;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "Failed to enumerate thumbnails for video assets with non-zero videoKeyFrame values with error %@", buf, 0xCu);
  }

  v14 = 0;
LABEL_12:

  return v14;
}

void __67__PLModelMigrator__deleteVideoThumbsMadeFromPreferredFrameInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v8 = a2;
  v4 = [v2 _migrationThumbnailManagerWithStore:v3];
  v5 = [v8 thumbnailIdentifier];
  v6 = [v8 thumbnailIndex];
  v7 = [v8 uuid];
  [v4 deleteThumbnailsWithIdentifier:v5 orIndex:v6 uuid:v7];

  [v8 setEffectiveThumbnailIndex:0x7FFFFFFFFFFFFFFFLL];
}

- (BOOL)_filterSceneClassificationsInStore:(id)a3
{
  v36 = *MEMORY[0x1E69E9840];
  v26 = a3;
  context = objc_autoreleasePoolPush();
  v24 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _filterSceneClassificationsInStore:]"];
  v25 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%@-%@", @"scene-thresholds", &unk_1F0FBBF38];
  v4 = [MEMORY[0x1E696AAE8] bundleForClass:objc_opt_class()];
  v5 = [v4 URLForResource:v25 withExtension:@"plist"];

  v6 = [MEMORY[0x1E695DF20] dictionaryWithContentsOfURL:v5];
  v23 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v26 name:"[PLModelMigrator _filterSceneClassificationsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLSceneClassification entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setFetchBatchSize:100];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"sceneIdentifier >= 0"];
  [v9 setPredicate:v10];
  if (v6)
  {
    *&v33 = 0;
    *(&v33 + 1) = &v33;
    v34 = 0x2020000000;
    v35 = 0;
    v28[0] = MEMORY[0x1E69E9820];
    v28[1] = 3221225472;
    v28[2] = __54__PLModelMigrator__filterSceneClassificationsInStore___block_invoke;
    v28[3] = &unk_1E75694D8;
    v29 = v6;
    v30 = &v33;
    if ([(PLModelMigrator *)self _runMigrationStepWithName:v24 fetchRequest:v9 store:v26 migrationHandler:v28])
    {
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        v12 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:*(*(&v33 + 1) + 24)];
        *buf = 138412290;
        v32 = v12;
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Deleted %@ sceneclassifications", buf, 0xCu);
      }
    }

    else
    {
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Failed to delete sceneclassifications", buf, 2u);
      }
    }

    _Block_object_dispose(&v33, 8);
    v17 = 1;
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      LODWORD(v33) = 138412290;
      *(&v33 + 4) = v5;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Failed to located scene thresholds file: %@. Deleting everying", &v33, 0xCu);
    }

    v14 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
    [v14 setResultType:2];
    v27 = 0;
    v15 = [v23 executeRequest:v14 error:&v27];
    v16 = v27;
    v17 = v15 != 0;
    v18 = PLMigrationGetLog();
    v19 = v18;
    if (v15)
    {
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        v20 = [v15 result];
        LODWORD(v33) = 138412290;
        *(&v33 + 4) = v20;
        _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_DEFAULT, "Deleted %@ sceneclassifications", &v33, 0xCu);
      }
    }

    else if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      LODWORD(v33) = 138412290;
      *(&v33 + 4) = v16;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "Failed to delete sceneclassifications with error: %@", &v33, 0xCu);
    }
  }

  objc_autoreleasePoolPop(context);
  return v17;
}

uint64_t __54__PLModelMigrator__filterSceneClassificationsInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [v3 managedObjectContext];
  v5 = v3;
  v6 = MEMORY[0x1E696AEC0];
  v7 = [MEMORY[0x1E696AD98] numberWithUnsignedLongLong:{objc_msgSend(v5, "sceneIdentifier")}];
  v8 = [v6 stringWithFormat:@"%@", v7];

  v9 = [*(a1 + 32) objectForKeyedSubscript:v8];

  if (v9)
  {
    v10 = [*(a1 + 32) objectForKeyedSubscript:v8];
    [v10 doubleValue];
    v12 = v11;
  }

  else
  {
    v12 = 1.79769313e308;
  }

  [v5 confidence];
  if (v13 < v12)
  {
    [v4 deleteObject:v5];
    ++*(*(*(a1 + 40) + 8) + 24);
  }

  return 1;
}

- (BOOL)_ensureAllUserVerifiedPersonsHaveFaceCropsInStore:(id)a3
{
  v4 = a3;
  v5 = +[PLPerson fetchRequest];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K.@count > 0 AND SUBQUERY(%K, $f, $f.%K = %d).@count = 0", @"verifiedType", 1, @"detectedFaces", @"detectedFaces", @"nameSource", 1];
  [v5 setPredicate:v6];

  v7 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _ensureAllUserVerifiedPersonsHaveFaceCropsInStore:]"];
  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:v7 fetchRequest:v5 store:v4 migrationHandler:&__block_literal_global_2370];

  return self;
}

uint64_t __69__PLModelMigrator__ensureAllUserVerifiedPersonsHaveFaceCropsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 keyFace];

  if (v3)
  {
    v4 = [v2 keyFace];
    [v4 setEffectiveNameSource:1];
  }

  return 1;
}

- (BOOL)_removeUntrackedPersonMetadataInStore:(id)a3
{
  v79[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removeUntrackedPersonMetadataInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = +[PLPerson fetchRequest];
  v8 = +[PLPerson predicateForPersistence];
  [v7 setPredicate:v8];

  [v7 setFetchBatchSize:100];
  v79[0] = @"personUUID";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v79 count:1];
  [v7 setPropertiesToFetch:v9];

  v70 = 0;
  v10 = [v6 executeFetchRequest:v7 error:&v70];
  v11 = v70;
  if (v10)
  {
    v53 = v7;
    v54 = v6;
    v12 = [MEMORY[0x1E695DFA8] set];
    v66 = 0u;
    v67 = 0u;
    v68 = 0u;
    v69 = 0u;
    v52 = v10;
    v13 = v10;
    v14 = [v13 countByEnumeratingWithState:&v66 objects:v78 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v67;
      do
      {
        for (i = 0; i != v15; ++i)
        {
          if (*v67 != v16)
          {
            objc_enumerationMutation(v13);
          }

          v18 = [*(*(&v66 + 1) + 8 * i) personUUID];
          [v12 addObject:v18];
        }

        v15 = [v13 countByEnumeratingWithState:&v66 objects:v78 count:16];
      }

      while (v15);
    }

    v19 = [MEMORY[0x1E696AC08] defaultManager];
    v20 = MEMORY[0x1E695DFF8];
    v21 = [(PLModelMigrator *)self pathManager];
    v22 = [v21 privateDirectoryWithSubType:5 createIfNeeded:0 error:0];
    v23 = [v20 fileURLWithPath:v22 isDirectory:1];

    v65 = v11;
    v24 = [v19 contentsOfDirectoryAtURL:v23 includingPropertiesForKeys:0 options:1 error:&v65];
    v25 = v65;

    v50 = v24;
    v51 = v23;
    if (v24)
    {
      v48 = v5;
      v49 = v4;
      v63 = 0u;
      v64 = 0u;
      v61 = 0u;
      v62 = 0u;
      obj = v24;
      v26 = [obj countByEnumeratingWithState:&v61 objects:v77 count:16];
      if (v26)
      {
        v27 = v26;
        v55 = 0;
        v28 = *v62;
        v56 = 1;
        do
        {
          for (j = 0; j != v27; ++j)
          {
            if (*v62 != v28)
            {
              objc_enumerationMutation(obj);
            }

            v30 = *(*(&v61 + 1) + 8 * j);
            v31 = [v30 path];
            v60 = 0;
            v32 = [PLPersistedPersonMetadata isValidPath:v31 outPersonUUID:&v60];
            v33 = v60;

            if (v32 && ([v12 containsObject:v33]& 1) == 0)
            {
              v59 = v25;
              v34 = [v19 removeItemAtURL:v30 error:&v59];
              v35 = v59;

              if (v34)
              {
                ++v55;
                v56 = 1;
              }

              else
              {
                v36 = PLMigrationGetLog();
                if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
                {
                  v37 = [v35 userInfo];
                  buf = 136315650;
                  v72 = "[PLModelMigrator _removeUntrackedPersonMetadataInStore:]";
                  v73 = 2112;
                  v74 = v35;
                  v75 = 2112;
                  v76 = v37;
                  _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_ERROR, "%s: failed to remove item: %@ %@", &buf, 0x20u);
                }

                v56 = 0;
              }

              v25 = v35;
            }
          }

          v27 = [obj countByEnumeratingWithState:&v61 objects:v77 count:16];
        }

        while (v27);
      }

      else
      {
        v55 = 0;
        v56 = 1;
      }

      v46 = PLMigrationGetLog();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        buf = 134217984;
        v72 = v55;
        _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_DEFAULT, "Removed %lu untracked person metadata files", &buf, 0xCu);
      }

      v5 = v48;
      v4 = v49;
      v7 = v53;
      v6 = v54;
    }

    else
    {
      v58 = 0;
      v40 = [v23 path];
      v41 = [v19 fileExistsAtPath:v40 isDirectory:&v58];
      v42 = (v41 & v58);

      v43 = PLMigrationGetLog();
      v44 = v43;
      if (v42 == 1)
      {
        v7 = v53;
        v6 = v54;
        if (os_log_type_enabled(v43, OS_LOG_TYPE_ERROR))
        {
          v45 = [v25 userInfo];
          buf = 136315650;
          v72 = "[PLModelMigrator _removeUntrackedPersonMetadataInStore:]";
          v73 = 2112;
          v74 = v25;
          v75 = 2112;
          v76 = v45;
          _os_log_impl(&dword_19BF1F000, v44, OS_LOG_TYPE_ERROR, "%s: failed to return contents of directory: %@ %@", &buf, 0x20u);
        }
      }

      else
      {
        v7 = v53;
        v6 = v54;
        if (os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT))
        {
          buf = 136315138;
          v72 = "[PLModelMigrator _removeUntrackedPersonMetadataInStore:]";
          _os_log_impl(&dword_19BF1F000, v44, OS_LOG_TYPE_DEFAULT, "%s: no faces metadata directory exists", &buf, 0xCu);
        }
      }

      v56 = v42 ^ 1;
    }

    v10 = v52;

    v11 = v25;
    v39 = v56;
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v38 = [v11 userInfo];
      buf = 136315650;
      v72 = "[PLModelMigrator _removeUntrackedPersonMetadataInStore:]";
      v73 = 2112;
      v74 = v11;
      v75 = 2112;
      v76 = v38;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%s: failed to fetch persons: %@ %@", &buf, 0x20u);
    }

    v39 = 0;
  }

  objc_autoreleasePoolPop(v5);
  return v39 & 1;
}

- (BOOL)_populateCloudVerifiedTypeOnPersonsInStore:(id)a3
{
  v28[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateCloudVerifiedTypeOnPersonsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLPerson entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d AND %K != %d", @"verifiedType", 0, @"verifiedType", 0xFFFFFFFFLL];
  [v9 setPredicate:v10];

  v27 = @"cloudVerifiedType";
  v11 = [MEMORY[0x1E696ABC8] expressionForKeyPath:@"verifiedType"];
  v28[0] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:&v27 count:1];
  [v9 setPropertiesToUpdate:v12];

  [v9 setResultType:2];
  v20 = 0;
  v13 = [v6 executeRequest:v9 error:&v20];
  v14 = v20;
  v15 = PLMigrationGetLog();
  v16 = v15;
  if (v13)
  {
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v13 result];
      *buf = 138412290;
      v22 = v17;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Populated cloud verified type for %@ persons", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v18 = [v14 userInfo];
    *buf = 136315650;
    v22 = "[PLModelMigrator _populateCloudVerifiedTypeOnPersonsInStore:]";
    v23 = 2112;
    v24 = v14;
    v25 = 2112;
    v26 = v18;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  return v13 != 0;
}

- (BOOL)_populateCloudNameSourceOnFacesInStore:(id)a3
{
  v28[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateCloudNameSourceOnFacesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLDetectedFace entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d AND %K != %d", @"nameSource", 0, @"nameSource", 2];
  [v9 setPredicate:v10];

  v27 = @"cloudNameSource";
  v11 = [MEMORY[0x1E696ABC8] expressionForKeyPath:@"nameSource"];
  v28[0] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:&v27 count:1];
  [v9 setPropertiesToUpdate:v12];

  [v9 setResultType:2];
  v20 = 0;
  v13 = [v6 executeRequest:v9 error:&v20];
  v14 = v20;
  v15 = PLMigrationGetLog();
  v16 = v15;
  if (v13)
  {
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v13 result];
      *buf = 138412290;
      v22 = v17;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Populated cloud name source for %@ faces", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v18 = [v14 userInfo];
    *buf = 136315650;
    v22 = "[PLModelMigrator _populateCloudNameSourceOnFacesInStore:]";
    v23 = 2112;
    v24 = v14;
    v25 = 2112;
    v26 = v18;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  return v13 != 0;
}

- (BOOL)_markMigrationVerifiedTypePersonsInStore:(id)a3
{
  v58[5] = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _markMigrationVerifiedTypePersonsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"verifiedType", 1];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K.@count = 0", @"detectedFaces"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = nil OR %K = %@", @"fullName", @"fullName", &stru_1F0F06D80];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = nil", @"contactMatchingDictionary"];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"type", 0];
  v11 = MEMORY[0x1E696AB28];
  v58[0] = v6;
  v58[1] = v7;
  v45 = v9;
  v46 = v8;
  v58[2] = v8;
  v58[3] = v9;
  v44 = v10;
  v58[4] = v10;
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v58 count:5];
  v13 = [v11 andPredicateWithSubpredicates:v12];

  v14 = MEMORY[0x1E695D5E0];
  v15 = +[PLPerson entityName];
  v16 = [v14 fetchRequestWithEntityName:v15];

  v43 = v13;
  [v16 setPredicate:v13];
  [v16 setResultType:1];
  v49 = 0;
  v17 = [v5 executeFetchRequest:v16 error:&v49];
  v18 = v49;
  if (v17)
  {
    v40 = v4;
    v19 = MEMORY[0x1E695D560];
    v20 = +[PLPerson entityName];
    v21 = [v19 batchUpdateRequestWithEntityName:v20];

    v22 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self IN %@", v17];
    [v21 setPredicate:v22];

    v56 = @"verifiedType";
    v57 = &unk_1F0FBBF20;
    v23 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v57 forKeys:&v56 count:1];
    [v21 setPropertiesToUpdate:v23];

    [v21 setResultType:2];
    v48 = v18;
    v24 = [v5 executeRequest:v21 error:&v48];
    v25 = v48;

    v26 = v24 != 0;
    v27 = PLMigrationGetLog();
    v28 = v27;
    if (v24)
    {
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        [v24 result];
        v41 = v7;
        v29 = v6;
        v31 = v30 = v5;
        *buf = 138412290;
        v51 = v31;
        v32 = "Mark migration verified type on %@ persons";
        v33 = v28;
        v34 = OS_LOG_TYPE_DEFAULT;
        v35 = 12;
LABEL_10:
        _os_log_impl(&dword_19BF1F000, v33, v34, v32, buf, v35);

        v5 = v30;
        v6 = v29;
        v7 = v41;
      }
    }

    else if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      [v25 userInfo];
      v41 = v7;
      v29 = v6;
      v31 = v30 = v5;
      *buf = 136315650;
      v51 = "[PLModelMigrator _markMigrationVerifiedTypePersonsInStore:]";
      v52 = 2112;
      v53 = v25;
      v54 = 2112;
      v55 = v31;
      v32 = "%s: failed to update: %@ %@";
      v33 = v28;
      v34 = OS_LOG_TYPE_ERROR;
      v35 = 32;
      goto LABEL_10;
    }

    v4 = v40;
    goto LABEL_12;
  }

  v42 = v7;
  v36 = v6;
  v37 = v5;
  v21 = PLMigrationGetLog();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
  {
    v38 = [v18 userInfo];
    *buf = 136315650;
    v51 = "[PLModelMigrator _markMigrationVerifiedTypePersonsInStore:]";
    v52 = 2112;
    v53 = v18;
    v54 = 2112;
    v55 = v38;
    _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "%s: failed to fetch object IDs: %@ %@", buf, 0x20u);
  }

  v26 = 0;
  v25 = v18;
  v5 = v37;
  v6 = v36;
  v7 = v42;
LABEL_12:

  objc_autoreleasePoolPop(context);
  return v26;
}

- (BOOL)_storeContainsFaceCrops:(id)a3 success:(BOOL *)a4
{
  v24 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v6 name:"[PLModelMigrator _storeContainsFaceCrops:success:]" concurrencyType:*MEMORY[0x1E695D708]];
  v9 = MEMORY[0x1E695D5E0];
  v10 = +[PLFaceCrop entityName];
  v11 = [v9 fetchRequestWithEntityName:v10];

  v12 = 1;
  [v11 setFetchLimit:1];
  v17 = 0;
  v13 = [v8 countForFetchRequest:v11 error:&v17];
  v14 = v17;
  if (v13)
  {
    if (v13 == 0x7FFFFFFFFFFFFFFFLL)
    {
      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
      {
        v15 = [v14 userInfo];
        *buf = 136315650;
        v19 = "[PLModelMigrator _storeContainsFaceCrops:success:]";
        v20 = 2112;
        v21 = v14;
        v22 = 2112;
        v23 = v15;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%s failed to count face crops in store: %@ %@", buf, 0x20u);
      }

      v12 = 0;
    }

    else
    {
      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Library contains at least 1 faceCrop, skipping some steps to prepare local model for faces sync", buf, 2u);
      }

      v12 = 1;
    }

    LOBYTE(v13) = v12;
  }

  objc_autoreleasePoolPop(v7);
  if (a4)
  {
    *a4 = v12;
  }

  return v13;
}

- (BOOL)_removeAutoloopCacheIfExists
{
  v2 = MEMORY[0x1E695DFF8];
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 privateCacheDirectoryWithSubType:11];
  v5 = 1;
  v6 = [v2 fileURLWithPath:v4 isDirectory:1];

  if (v6)
  {
    v7 = [MEMORY[0x1E696AC08] defaultManager];
    v8 = [v6 path];
    v9 = [v7 directoryExistsAtPath:v8];

    if (v9)
    {
      v10 = [MEMORY[0x1E696AC08] defaultManager];
      v5 = [v10 removeItemAtURL:v6 error:0];
    }

    else
    {
      v5 = 1;
    }
  }

  return v5;
}

- (BOOL)_fixUTIforSlowMoInStore:(id)a3
{
  v30[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixUTIforSlowMoInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = objc_alloc(MEMORY[0x1E695D560]);
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 initWithEntityName:v8];

  [v9 setResultType:2];
  v10 = MEMORY[0x1E696AE18];
  v11 = [*MEMORY[0x1E6982E58] identifier];
  v12 = [v10 predicateWithFormat:@"%K = %d AND %K = %@", @"kindSubtype", 101, @"uniformTypeIdentifier", v11];

  [v9 setPredicate:v12];
  v29 = @"uniformTypeIdentifier";
  v13 = [*MEMORY[0x1E6982F80] identifier];
  v30[0] = v13;
  v14 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v30 forKeys:&v29 count:1];
  [v9 setPropertiesToUpdate:v14];

  v22 = 0;
  v15 = [v6 executeRequest:v9 error:&v22];
  v16 = v22;
  v17 = PLMigrationGetLog();
  v18 = v17;
  if (v15)
  {
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v19 = [v15 result];
      *buf = 138412290;
      v24 = v19;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Fixed UTI for %@ slow-mo videos", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
  {
    v20 = [v16 userInfo];
    *buf = 136315650;
    v24 = "[PLModelMigrator _fixUTIforSlowMoInStore:]";
    v25 = 2112;
    v26 = v16;
    v27 = 2112;
    v28 = v20;
    _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  return v15 != 0;
}

- (BOOL)_unquarantineClass:(Class)a3 inManagedObject:(id)a4
{
  v24 = *MEMORY[0x1E69E9840];
  v5 = MEMORY[0x1E695D5E0];
  v6 = a4;
  v7 = [(objc_class *)a3 entityName];
  v8 = [v5 fetchRequestWithEntityName:v7];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 4];
  [v8 setPredicate:v9];
  [v8 setFetchBatchSize:100];
  v10 = [v6 executeFetchRequest:v8 error:0];
  v11 = [v6 enumerateWithIncrementalSaveUsingObjects:v10 withBlock:&__block_literal_global_2324];

  v12 = PLMigrationGetLog();
  v13 = v12;
  if (v11)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v14 = [(objc_class *)a3 entityName];
      v15 = [v11 userInfo];
      *buf = 138412802;
      v19 = v14;
      v20 = 2112;
      v21 = v11;
      v22 = 2112;
      v23 = v15;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "unquarantined %@ failed: %@ %@", buf, 0x20u);

LABEL_6:
    }
  }

  else if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [v10 count];
    v14 = [(objc_class *)a3 entityName];
    *buf = 134218242;
    v19 = v16;
    v20 = 2112;
    v21 = v14;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "unquarantined %lu %@", buf, 0x16u);
    goto LABEL_6;
  }

  return v11 == 0;
}

void __54__PLModelMigrator__unquarantineClass_inManagedObject___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v2 = v3;
    [v2 setUploadAttempts:0];
    [v2 setLastUploadAttemptDate:0];
  }

  if (objc_opt_respondsToSelector())
  {
    [v3 setCloudLocalState:0];
  }
}

- (BOOL)_unquarantinedQuarantinedItems:(id)a3
{
  v19[8] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _unquarantinedQuarantinedItems:]" concurrencyType:*MEMORY[0x1E695D708]];
  v19[0] = objc_opt_class();
  v19[1] = objc_opt_class();
  v19[2] = objc_opt_class();
  v19[3] = objc_opt_class();
  v19[4] = objc_opt_class();
  v19[5] = objc_opt_class();
  v19[6] = objc_opt_class();
  v19[7] = objc_opt_class();
  [MEMORY[0x1E695DEC8] arrayWithObjects:v19 count:8];
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v7 = v17 = 0u;
  v8 = [v7 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v15;
    while (2)
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v15 != v10)
        {
          objc_enumerationMutation(v7);
        }

        if (![(PLModelMigrator *)self _unquarantineClass:*(*(&v14 + 1) + 8 * i) inManagedObject:v6, v14])
        {
          v12 = 0;
          goto LABEL_11;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v9)
      {
        continue;
      }

      break;
    }
  }

  v12 = 1;
LABEL_11:

  objc_autoreleasePoolPop(v5);
  return v12;
}

- (BOOL)_retryQuarantinedAssetsAndFixResourceRelation:(id)a3
{
  v22[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _retryQuarantinedAssetsAndFixResourceRelation:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLCloudResource entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v22[0] = @"cloudMaster";
  v22[1] = @"asset";
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v22 count:2];
  [v9 setRelationshipKeyPathsForPrefetching:v10];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudMaster != nil && asset != nil"];
  [v9 setPredicate:v11];
  [v9 setFetchBatchSize:100];
  v12 = [v6 executeFetchRequest:v9 error:0];
  v13 = [v6 enumerateWithIncrementalSaveUsingObjects:v12 withBlock:&__block_literal_global_2321];
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v13)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v16 = [v13 userInfo];
      v18 = 138412546;
      v19 = v13;
      v20 = 2112;
      v21 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_retryQuarantinedAssetsAndFixResourceRelation saveResource: failed: %@ %@", &v18, 0x16u);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v18 = 134217984;
    v19 = [v12 count];
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Fixed %lu resources", &v18, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  return v13 == 0;
}

void __65__PLModelMigrator__retryQuarantinedAssetsAndFixResourceRelation___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v4 = [v2 asset];
  [v4 setUploadAttempts:0];
  [v4 setLastUploadAttemptDate:0];
  [v4 setCloudLocalState:0];
  v3 = [v2 cloudMaster];
  [v3 setCloudLocalState:0];
  [v2 setAsset:0];
}

- (BOOL)_deletePersonsMissingUUIDInStore:(id)a3
{
  v4 = MEMORY[0x1E695D5E0];
  v5 = a3;
  v6 = +[PLPerson entityName];
  v7 = [v4 fetchRequestWithEntityName:v6];

  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"personUUID == nil OR personUUID == ''"];
  [v7 setPredicate:v8];

  LOBYTE(self) = [(PLModelMigrator *)self _runMigrationStepWithName:@"deletePersonsMissingUUID" fetchRequest:v7 store:v5 migrationHandler:&__block_literal_global_2316];
  return self;
}

uint64_t __52__PLModelMigrator__deletePersonsMissingUUIDInStore___block_invoke(uint64_t a1, void *a2)
{
  v7 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v5 = 138412290;
    v6 = v2;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_DEFAULT, "Deleting person missing UUID: %@", &v5, 0xCu);
  }

  [v2 deletePersonWithReason:1];
  return 1;
}

- (BOOL)_repushPersonsWithMergeTargetInStore:(id)a3
{
  v27 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _repushPersonsWithMergeTargetInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLPerson entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"mergeTargetPerson != nil"];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v21 = 0;
  v22 = &v21;
  v23 = 0x2020000000;
  v24 = 0;
  v11 = [v6 executeFetchRequest:v9 error:0];
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = __56__PLModelMigrator__repushPersonsWithMergeTargetInStore___block_invoke;
  v20[3] = &unk_1E7569368;
  v20[4] = &v21;
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v20];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v26 = v12;
      v14 = "Failed to fetch persons with merge target: %@";
      v15 = v13;
      v16 = OS_LOG_TYPE_ERROR;
      v17 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v15, v16, v14, buf, v17);
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v18 = *(v22 + 6);
      *buf = 67109120;
      LODWORD(v26) = v18;
      v14 = "Will repush %d persons with merge target";
      v15 = v13;
      v16 = OS_LOG_TYPE_DEFAULT;
      v17 = 8;
      goto LABEL_6;
    }
  }

  [v6 reset];
  _Block_object_dispose(&v21, 8);

  objc_autoreleasePoolPop(v5);
  return v12 == 0;
}

void __56__PLModelMigrator__repushPersonsWithMergeTargetInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  if ([v3 cloudLocalState])
  {
    [v3 setCloudLocalState:0];
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_persistStoreUUIDToMobileCPLPlist:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = MEMORY[0x1E69BF1C0];
  v7 = *MEMORY[0x1E69BF418];
  v8 = [(PLModelMigrator *)self pathManager];
  v9 = [v6 readCPLPlistObjectWithKey:v7 pathManager:v8];

  if (!v9)
  {
    v10 = [v4 metadata];
    v11 = [v10 objectForKey:*MEMORY[0x1E695D4B8]];

    v12 = MEMORY[0x1E69BF1C0];
    v13 = [(PLModelMigrator *)self pathManager];
    [v12 saveCPLPlistObject:v11 forKey:v7 pathManager:v13];

    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = 138412290;
      v17 = v11;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Persist the storeUUID %@", &v16, 0xCu);
    }
  }

  objc_autoreleasePoolPop(v5);
  return 1;
}

- (BOOL)_fixNilCloudMasterGUID:(id)a3
{
  v34 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v23 = 0;
  v24 = &v23;
  v25 = 0x2020000000;
  v26 = 0;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixNilCloudMasterGUID:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLCloudMaster entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudMasterGUID == nil OR cloudMasterGUID == ''"];
  [v9 setPredicate:v10];
  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __42__PLModelMigrator__fixNilCloudMasterGUID___block_invoke;
  v19[3] = &unk_1E7569450;
  v21 = &v27;
  v12 = v6;
  v20 = v12;
  v22 = &v23;
  v13 = [v12 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v19];
  if (v13)
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = [v13 userInfo];
      *buf = 138412546;
      *v32 = v13;
      *&v32[8] = 2112;
      v33 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "_fixNilCloudMasterGUID failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = *(v28 + 6);
      v17 = *(v24 + 6);
      *buf = 67109376;
      *v32 = v16;
      *&v32[4] = 1024;
      *&v32[6] = v17;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Fixed %d assets, deleted %d masters", buf, 0xEu);
    }
  }

  objc_autoreleasePoolPop(v5);
  _Block_object_dispose(&v23, 8);
  _Block_object_dispose(&v27, 8);

  return v13 == 0;
}

void __42__PLModelMigrator__fixNilCloudMasterGUID___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 assets];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v5 = [v4 countByEnumeratingWithState:&v16 objects:v22 count:16];
  if (v5)
  {
    v7 = v5;
    v8 = *v17;
    *&v6 = 138412290;
    v15 = v6;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v17 != v8)
        {
          objc_enumerationMutation(v4);
        }

        v10 = *(*(&v16 + 1) + 8 * i);
        [v10 setCloudLocalState:{0, v15}];
        [v10 setMaster:0];
        ++*(*(*(a1 + 40) + 8) + 24);
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          v12 = [v10 uuid];
          *buf = v15;
          v21 = v12;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Marking asset %@ unpushed, master doesn't have a valid cloudMasterGUID", buf, 0xCu);
        }
      }

      v7 = [v4 countByEnumeratingWithState:&v16 objects:v22 count:16];
    }

    while (v7);
  }

  v13 = PLMigrationGetLog();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v14 = [v3 scopedIdentifier];
    *buf = 138412290;
    v21 = v14;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Deleting master %@ to force master creation", buf, 0xCu);
  }

  [*(a1 + 32) deleteObject:v3];
  ++*(*(*(a1 + 48) + 8) + 24);
}

- (BOOL)_fixAssetMasterResources:(id)a3
{
  v41[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v32 = 0;
  v33 = &v32;
  v34 = 0x2020000000;
  v35 = 0;
  v28 = 0;
  v29 = &v28;
  v30 = 0x2020000000;
  v31 = 0;
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixAssetMasterResources:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v41[0] = @"master";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v41 count:1];
  [v8 setRelationshipKeyPathsForPrefetching:v9];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 2];
  [v8 setPredicate:v10];
  [v8 setFetchBatchSize:100];
  v27 = 0;
  v11 = [v5 executeFetchRequest:v8 error:&v27];
  v12 = v27;
  if (v11)
  {
    v23[0] = MEMORY[0x1E69E9820];
    v23[1] = 3221225472;
    v23[2] = __44__PLModelMigrator__fixAssetMasterResources___block_invoke;
    v23[3] = &unk_1E7569428;
    v25 = &v32;
    v26 = &v28;
    v24 = v5;
    v13 = [v24 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v23];
    v14 = v13 == 0;
    if (v13)
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        v16 = [v13 userInfo];
        *buf = 138412546;
        v37 = v13;
        v38 = 2112;
        *v39 = v16;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_fixAssetMasterResources failed: %@ %@", buf, 0x16u);
      }
    }

    else
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        v18 = [v11 count];
        v19 = *(v33 + 6);
        v20 = *(v29 + 6);
        *buf = 134218496;
        v37 = v18;
        v38 = 1024;
        *v39 = v19;
        *&v39[4] = 1024;
        *&v39[6] = v20;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Fixed %lu assets (noMaster: %d, noOriginal: %d)", buf, 0x18u);
      }
    }

    v17 = v24;
  }

  else
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      *buf = 136315650;
      v37 = "[PLModelMigrator _fixAssetMasterResources:]";
      v38 = 2112;
      *v39 = v10;
      *&v39[8] = 2112;
      v40 = v12;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "%s fetch failed with predicate %@, error: %@", buf, 0x20u);
    }

    v14 = 0;
  }

  objc_autoreleasePoolPop(context);
  _Block_object_dispose(&v28, 8);
  _Block_object_dispose(&v32, 8);

  return v14;
}

void __44__PLModelMigrator__fixAssetMasterResources___block_invoke(uint64_t a1, void *a2)
{
  v34 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 master];
  if (v4)
  {
    v5 = [v3 uuid];
    v6 = [PLCloudResource cloudResourceForResourceType:1 forAssetUuid:v5 forCloudMaster:v4];

    if (!v6)
    {
      v24 = v3;
      v7 = MEMORY[0x1E695DFD8];
      v8 = v4;
      v9 = [v4 assets];
      v10 = [v7 setWithSet:v9];

      v27 = 0u;
      v28 = 0u;
      v25 = 0u;
      v26 = 0u;
      v11 = v10;
      v12 = [v11 countByEnumeratingWithState:&v25 objects:v33 count:16];
      if (v12)
      {
        v13 = v12;
        v14 = *v26;
        do
        {
          for (i = 0; i != v13; ++i)
          {
            if (*v26 != v14)
            {
              objc_enumerationMutation(v11);
            }

            v16 = *(*(&v25 + 1) + 8 * i);
            [v16 setCloudLocalState:0];
            [v16 setMaster:0];
            ++*(*(*(a1 + 48) + 8) + 24);
            v17 = PLMigrationGetLog();
            if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
            {
              v18 = [v16 uuid];
              v19 = [v8 scopedIdentifier];
              *buf = 138412546;
              v30 = v18;
              v31 = 2112;
              v32 = v19;
              _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Marking asset %@ in master %@ unpushed, don't have original resource", buf, 0x16u);
            }
          }

          v13 = [v11 countByEnumeratingWithState:&v25 objects:v33 count:16];
        }

        while (v13);
      }

      v20 = PLMigrationGetLog();
      v4 = v8;
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v21 = [v8 scopedIdentifier];
        *buf = 138412290;
        v30 = v21;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Deleting master %@ to force master creation", buf, 0xCu);
      }

      [*(a1 + 32) deleteObject:v8];
      v6 = 0;
      v3 = v24;
    }
  }

  else
  {
    [v3 setCloudLocalState:0];
    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
    {
      v23 = [v3 uuid];
      *buf = 138412290;
      v30 = v23;
      _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "Marking asset %@ unpushed, don't have master", buf, 0xCu);
    }

    ++*(*(*(a1 + 40) + 8) + 24);
  }
}

- (BOOL)_repushAssetsWithAnyUserConfirmedFaceInStore:(id)a3
{
  v4 = MEMORY[0x1E696AE18];
  v5 = a3;
  v6 = [v4 predicateWithFormat:@"SUBQUERY(detectedFaces, $f, $f.nameSource == %d).@count != 0", 1];
  LOBYTE(self) = [(PLModelMigrator *)self _repushAssetsMatchingPredicate:v6 inStore:v5 withMaster:0];

  return self;
}

- (BOOL)_repushAssetsMatchingPredicate:(id)a3 inStore:(id)a4 withMaster:(BOOL)a5
{
  v5 = a5;
  v47 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v28 = v9;
  v10 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v9 name:"[PLModelMigrator _repushAssetsMatchingPredicate:inStore:withMaster:]" concurrencyType:*MEMORY[0x1E695D708]];
  v11 = MEMORY[0x1E695D5E0];
  v12 = +[PLManagedAsset entityName];
  v13 = [v11 fetchRequestWithEntityName:v12];

  v31 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d AND %K != %d", @"cloudLocalState", 0, @"cloudLocalState", 4];
  v14 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  v15 = [MEMORY[0x1E695DF70] array];
  [v15 addObject:v31];
  [v15 addObject:v14];
  if (v8)
  {
    [v15 addObject:v8];
  }

  v16 = [MEMORY[0x1E696AB28] andPredicateWithSubpredicates:v15];
  [v13 setPredicate:v16];

  [v13 setFetchBatchSize:100];
  v38 = 0;
  v17 = [v10 executeFetchRequest:v13 error:&v38];
  v30 = v38;
  if (v17)
  {
    *v45 = 0;
    *&v45[8] = v45;
    *&v45[16] = 0x2020000000;
    v46 = 0;
    v34 = 0;
    v35 = &v34;
    v36 = 0x2020000000;
    v37 = 0;
    v32[0] = MEMORY[0x1E69E9820];
    v32[1] = 3221225472;
    v32[2] = __69__PLModelMigrator__repushAssetsMatchingPredicate_inStore_withMaster___block_invoke;
    v32[3] = &unk_1E7569400;
    v18 = v5;
    v33 = v5;
    v32[4] = &v34;
    v32[5] = v45;
    v19 = [v10 enumerateWithIncrementalSaveUsingObjects:v17 withBlock:v32];
    v20 = v19 == 0;
    if (v19)
    {
      v21 = PLMigrationGetLog();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        *buf = 136315394;
        v40 = "[PLModelMigrator _repushAssetsMatchingPredicate:inStore:withMaster:]";
        v41 = 2112;
        v42 = v19;
        _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "%s save failed with error: %@", buf, 0x16u);
      }
    }

    else
    {
      v21 = PLMigrationGetLog();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
      {
        v23 = *(*&v45[8] + 24);
        if (v18)
        {
          v26 = *(*&v45[8] + 24);
          v24 = [MEMORY[0x1E696AEC0] stringWithFormat:@"and %lu masters ", v35[3]];
          v23 = v26;
        }

        else
        {
          v24 = &stru_1F0F06D80;
        }

        v27 = v24;
        *buf = 136315650;
        v40 = "[PLModelMigrator _repushAssetsMatchingPredicate:inStore:withMaster:]";
        v41 = 2048;
        v42 = v23;
        v43 = 2112;
        v44 = v24;
        _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "%s marked %lu assets %@to be repushed", buf, 0x20u);
        if (v18)
        {
        }
      }
    }

    _Block_object_dispose(&v34, 8);
    _Block_object_dispose(v45, 8);
  }

  else
  {
    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      *v45 = 136315650;
      *&v45[4] = "[PLModelMigrator _repushAssetsMatchingPredicate:inStore:withMaster:]";
      *&v45[12] = 2112;
      *&v45[14] = v8;
      *&v45[22] = 2112;
      v46 = v30;
      _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "%s fetch failed with predicate %@, error: %@", v45, 0x20u);
    }

    v20 = 0;
  }

  objc_autoreleasePoolPop(context);
  return v20;
}

void __69__PLModelMigrator__repushAssetsMatchingPredicate_inStore_withMaster___block_invoke(uint64_t a1, void *a2)
{
  v4 = a2;
  [v4 setCloudLocalState:0];
  if (*(a1 + 48) == 1)
  {
    v3 = [v4 master];
    [v3 setCloudLocalState:0];

    ++*(*(*(a1 + 32) + 8) + 24);
  }

  ++*(*(*(a1 + 40) + 8) + 24);
}

- (id)_predicateForInconsistentHeifAssets
{
  v9[3] = *MEMORY[0x1E69E9840];
  v2 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K ENDSWITH[c] '.jpg'", @"filename"];
  v3 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == 'public.data' OR %K == nil OR %K == ''", @"uniformTypeIdentifier", @"uniformTypeIdentifier", @"uniformTypeIdentifier"];
  v4 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K ENDSWITH[c] '.heic' OR %K ENDSWITH[c] '.heif'", @"additionalAttributes.originalFilename", @"additionalAttributes.originalFilename"];
  v5 = MEMORY[0x1E696AB28];
  v9[0] = v3;
  v9[1] = v4;
  v9[2] = v2;
  v6 = [MEMORY[0x1E695DEC8] arrayWithObjects:v9 count:3];
  v7 = [v5 andPredicateWithSubpredicates:v6];

  return v7;
}

- (void)_fixIncorrectHeifMetadataForAsset:(id)a3
{
  v69 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = [(PLModelMigrator *)self _predicateForInconsistentHeifAssets];
  if ([v6 evaluateWithObject:v5])
  {
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = NSStringFromSelector(a2);
      *buf = 138412546;
      v64 = v8;
      v65 = 2112;
      v66 = v5;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "%@: Attempting to fix incorrect HEIF metadata for asset: %@", buf, 0x16u);
    }

    if ([v5 width] && objc_msgSend(v5, "height"))
    {
LABEL_13:
      v59 = v6;
      v61 = [v5 additionalAttributes];
      v15 = [v61 originalFilename];
      v16 = [v15 pathExtension];
      v17 = [v16 uppercaseString];

      v18 = [v5 pathForOriginalFile];
      v19 = [v5 filename];
      v20 = [v19 stringByDeletingPathExtension];
      v21 = [v20 stringByAppendingPathExtension:v17];

      v22 = [v18 stringByDeletingPathExtension];
      v60 = v17;
      v23 = [v22 stringByAppendingPathExtension:v17];

      v24 = [MEMORY[0x1E696AC08] defaultManager];
      v25 = [v24 fileExistsAtPath:v18];

      if (!v25)
      {
        v58 = 0;
        goto LABEL_22;
      }

      v26 = [MEMORY[0x1E696AC08] defaultManager];
      v62 = 0;
      v27 = [v26 moveItemAtPath:v18 toPath:v23 error:&v62];
      v58 = v62;

      v28 = PLMigrationGetLog();
      v29 = v28;
      if (v27)
      {
        if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
        {
          v30 = NSStringFromSelector(a2);
          *buf = 138412802;
          v64 = v30;
          v65 = 2112;
          v66 = v18;
          v67 = 2112;
          v68 = v23;
          v31 = "%@: Moved original resource from %@ to %@";
          v32 = v29;
          v33 = OS_LOG_TYPE_DEFAULT;
LABEL_20:
          _os_log_impl(&dword_19BF1F000, v32, v33, v31, buf, 0x20u);
        }
      }

      else if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
      {
        v30 = NSStringFromSelector(a2);
        *buf = 138412802;
        v64 = v30;
        v65 = 2112;
        v66 = v18;
        v67 = 2112;
        v68 = v23;
        v31 = "%@: Failed to move the original resource from %@ to %@";
        v32 = v29;
        v33 = OS_LOG_TYPE_ERROR;
        goto LABEL_20;
      }

LABEL_22:
      [v5 setFilename:v21];
      v34 = PLMigrationGetLog();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        v35 = NSStringFromSelector(a2);
        *buf = 138412546;
        v64 = v35;
        v65 = 2112;
        v66 = v21;
        _os_log_impl(&dword_19BF1F000, v34, OS_LOG_TYPE_DEFAULT, "%@: Changed asset filename to %@", buf, 0x16u);
      }

      v36 = v21;
      v37 = a2;

      v38 = [v5 master];
      v39 = [v5 uuid];
      v40 = [PLCloudResource cloudResourceForResourceType:1 forAssetUuid:v39 forCloudMaster:v38];

      if (v40)
      {
        [v40 setFilePath:v23];
        v41 = PLMigrationGetLog();
        if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
        {
          v42 = NSStringFromSelector(v37);
          *buf = 138412546;
          v64 = v42;
          v65 = 2112;
          v66 = v23;
          _os_log_impl(&dword_19BF1F000, v41, OS_LOG_TYPE_DEFAULT, "%@: Changed filepath of original resource to %@", buf, 0x16u);
        }
      }

      [v5 setUniformTypeIdentifierFromOriginalFile];
      if (v38)
      {
        v43 = [v5 uniformTypeIdentifier];
        [v38 setUniformTypeIdentifier:v43];
      }

      v44 = v37;
      if (v40)
      {
        v45 = [v5 uniformTypeIdentifier];
        [v40 setUniformTypeIdentifier:v45];
      }

      v46 = PLMigrationGetLog();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
      {
        v47 = NSStringFromSelector(v37);
        v48 = [v5 uniformTypeIdentifier];
        *buf = 138412546;
        v64 = v47;
        v65 = 2112;
        v66 = v48;
        _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_DEFAULT, "%@: Changed UTI to %@", buf, 0x16u);

        v44 = v37;
      }

      if ([v5 kind] != 3)
      {
        goto LABEL_42;
      }

      v49 = [v5 promoteFromUnknownKind];
      v50 = PLMigrationGetLog();
      v51 = v50;
      if (v49)
      {
        if (os_log_type_enabled(v50, OS_LOG_TYPE_DEFAULT))
        {
          v52 = NSStringFromSelector(v44);
          v53 = [v5 kind];
          *buf = 138412546;
          v64 = v52;
          v65 = 1024;
          LODWORD(v66) = v53;
          v54 = "%@: Promoted asset kind from Unknown to %d";
          v55 = v51;
          v56 = OS_LOG_TYPE_DEFAULT;
          v57 = 18;
LABEL_40:
          _os_log_impl(&dword_19BF1F000, v55, v56, v54, buf, v57);
        }
      }

      else if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
      {
        v52 = NSStringFromSelector(v44);
        *buf = 138412290;
        v64 = v52;
        v54 = "%@: Failed to promote the asset kind from Unknown";
        v55 = v51;
        v56 = OS_LOG_TYPE_ERROR;
        v57 = 12;
        goto LABEL_40;
      }

LABEL_42:
      v6 = v59;
      goto LABEL_43;
    }

    v9 = [v5 imageProperties];
    if (v9)
    {
      [v5 setOriginalSizeAndOrientationFromImageProperties:v9];
      [v5 setSizeAndOrientationFromImageProperties:v9];
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        v11 = NSStringFromSelector(a2);
        *buf = 138412290;
        v64 = v11;
        v12 = "%@: Fixed asset dimensions";
        v13 = v10;
        v14 = OS_LOG_TYPE_DEFAULT;
LABEL_11:
        _os_log_impl(&dword_19BF1F000, v13, v14, v12, buf, 0xCu);
      }
    }

    else
    {
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = NSStringFromSelector(a2);
        *buf = 138412290;
        v64 = v11;
        v12 = "%@: Failed to read image properties to fix asset dimensions";
        v13 = v10;
        v14 = OS_LOG_TYPE_ERROR;
        goto LABEL_11;
      }
    }

    goto LABEL_13;
  }

LABEL_43:
}

- (BOOL)_fixIncorrectHeifMetadataInStore:(id)a3
{
  v26 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixIncorrectHeifMetadataInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [(PLModelMigrator *)self _predicateForInconsistentHeifAssets];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v23 = 0;
  v11 = [v6 executeFetchRequest:v9 error:&v23];
  v12 = v23;
  if (v11)
  {
    v22[0] = MEMORY[0x1E69E9820];
    v22[1] = 3221225472;
    v22[2] = __52__PLModelMigrator__fixIncorrectHeifMetadataInStore___block_invoke;
    v22[3] = &unk_1E7575368;
    v22[4] = self;
    v13 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v22];

    v14 = v13 == 0;
    v15 = PLMigrationGetLog();
    v16 = v15;
    if (v13)
    {
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v25 = v13;
        v17 = "Failed to fix incorrect metadata for HEIF assets: %@";
        v18 = v16;
        v19 = OS_LOG_TYPE_ERROR;
LABEL_10:
        _os_log_impl(&dword_19BF1F000, v18, v19, v17, buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v25 = 0;
      v17 = "Fixed incorrect metadata for %ld HEIF assets";
      v18 = v16;
      v19 = OS_LOG_TYPE_DEFAULT;
      goto LABEL_10;
    }

    goto LABEL_12;
  }

  v20 = PLMigrationGetLog();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v25 = v12;
    _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "Can't fetch HEIF assets with incorrect metadata: %@", buf, 0xCu);
  }

  v14 = 0;
  v13 = v12;
LABEL_12:
  [v6 reset];

  objc_autoreleasePoolPop(v5);
  return v14;
}

- (BOOL)_fixRawWithZeroDimensions:(id)a3
{
  v15[1] = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d AND (%K == 0 OR %K == 0 OR %K == 0 OR %K == 0)", @"kind", 0, @"width", @"height", @"additionalAttributes.originalWidth", @"additionalAttributes.originalHeight"];
  [v9 setPredicate:v10];

  v15[0] = @"additionalAttributes";
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v15 count:1];
  [v9 setRelationshipKeyPathsForPrefetching:v11];

  [v9 setFetchBatchSize:100];
  v12 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _fixRawWithZeroDimensions:]"];
  v14[0] = MEMORY[0x1E69E9820];
  v14[1] = 3221225472;
  v14[2] = __45__PLModelMigrator__fixRawWithZeroDimensions___block_invoke;
  v14[3] = &__block_descriptor_40_e28_B24__0__NSManagedObject_8Q16l;
  v14[4] = a2;
  [(PLModelMigrator *)self _runMigrationStepWithName:v12 fetchRequest:v9 store:v5 migrationHandler:v14];

  objc_autoreleasePoolPop(v6);
  return 1;
}

BOOL __45__PLModelMigrator__fixRawWithZeroDimensions___block_invoke(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x1E69E9840];
  v3 = a2;
  if ([v3 isRAW])
  {
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = NSStringFromSelector(*(a1 + 32));
      v16 = 138412546;
      v17 = v5;
      v18 = 2112;
      v19 = v3;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_DEFAULT, "%@: Attempting to fix zero dimensions of raw image: %@", &v16, 0x16u);
    }

    v6 = [v3 imageProperties];
    v7 = [v6 count];
    v8 = v7 != 0;
    if (v7)
    {
      if (![v3 originalWidth] || !objc_msgSend(v3, "originalHeight"))
      {
        v9 = PLMigrationGetLog();
        if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
        {
          v10 = NSStringFromSelector(*(a1 + 32));
          v16 = 138412290;
          v17 = v10;
          _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "%@: Fixed original width/height for raw image", &v16, 0xCu);
        }

        [v3 setOriginalSizeAndOrientationFromImageProperties:v6];
      }

      if (![v3 width] || !objc_msgSend(v3, "height"))
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          v12 = NSStringFromSelector(*(a1 + 32));
          v16 = 138412290;
          v17 = v12;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "%@: Fixed width/height for raw image", &v16, 0xCu);
        }

        [v3 setSizeAndOrientationFromImageProperties:v6];
      }
    }

    else
    {
      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
      {
        v14 = NSStringFromSelector(*(a1 + 32));
        v16 = 138412290;
        v17 = v14;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%@: Failed to fetch image properties to fix zero dimensions of raw image", &v16, 0xCu);
      }
    }
  }

  else
  {
    v8 = 1;
  }

  return v8;
}

- (BOOL)_populateCloudResourceLocalStateInStor:(id)a3
{
  v27 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateCloudResourceLocalStateInStor:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = PLMigrationGetLog();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "Populating cloudLocalState for cloudResources", buf, 2u);
  }

  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLCloudResource entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudMaster.cloudLocalState == %d OR asset.cloudLocalState == %d", 1, 1];
  [v10 setPredicate:v11];
  [v10 setFetchBatchSize:100];
  *buf = 0;
  v22 = buf;
  v23 = 0x2020000000;
  v24 = 0;
  v20 = 0;
  v12 = [v6 executeFetchRequest:v10 error:&v20];
  v13 = v20;
  if (v12)
  {
    v19[0] = MEMORY[0x1E69E9820];
    v19[1] = 3221225472;
    v19[2] = __58__PLModelMigrator__populateCloudResourceLocalStateInStor___block_invoke;
    v19[3] = &unk_1E75693B8;
    v19[4] = buf;
    v14 = [v6 enumerateWithIncrementalSaveUsingObjects:v12 withBlock:v19];

    if (v14)
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        *v25 = 138412290;
        v26 = v14;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Failed to populate cloudLocalState for cloudResources: %@", v25, 0xCu);
      }

      v16 = 0;
    }

    else
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        v17 = *(v22 + 3);
        *v25 = 134217984;
        v26 = v17;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Populated cloudLocalState for %ld cloudResources", v25, 0xCu);
      }

      v14 = 0;
      v16 = 1;
    }
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      *v25 = 138412290;
      v26 = v13;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Can't fetch cloudResources: %@", v25, 0xCu);
    }

    v16 = 0;
    v14 = v13;
  }

  [v6 reset];
  _Block_object_dispose(buf, 8);

  objc_autoreleasePoolPop(v5);
  return v16;
}

uint64_t __58__PLModelMigrator__populateCloudResourceLocalStateInStor___block_invoke(uint64_t a1, void *a2)
{
  result = [a2 setCloudLocalState:3];
  ++*(*(*(a1 + 32) + 8) + 24);
  return result;
}

- (BOOL)_fixZeroTrashedDateForEntityName:(id)a3 inManagedObjectContext:(id)a4
{
  v26 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:v5];
  v8 = MEMORY[0x1E696AE18];
  v9 = [MEMORY[0x1E695DF00] dateWithTimeIntervalSinceReferenceDate:0.0];
  v10 = [v8 predicateWithFormat:@"trashedDate == %@", v9];
  [v7 setPredicate:v10];

  [v7 setFetchBatchSize:100];
  v19 = 0;
  v11 = [v6 executeFetchRequest:v7 error:&v19];
  v12 = v19;
  if (v11)
  {
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __75__PLModelMigrator__fixZeroTrashedDateForEntityName_inManagedObjectContext___block_invoke;
    v18[3] = &unk_1E75691B8;
    v18[4] = &v20;
    v13 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v18];

    if (v13)
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        *v25 = v5;
        *&v25[8] = 2112;
        *&v25[10] = v13;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Failed to zero trashed date (%@): %@", buf, 0x16u);
      }

      v15 = 0;
    }

    else
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v16 = v21[3];
        *buf = 67109378;
        *v25 = v16;
        *&v25[4] = 2112;
        *&v25[6] = v5;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Fixed %d zero trashed date (%@), setting them to nil", buf, 0x12u);
      }

      v13 = 0;
      v15 = 1;
    }
  }

  else
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      *v25 = v5;
      *&v25[8] = 2112;
      *&v25[10] = v12;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Can't fetch request _fixZeroTrashedDate (%@): %@", buf, 0x16u);
    }

    v15 = 0;
    v13 = v12;
  }

  _Block_object_dispose(&v20, 8);
  return v15;
}

uint64_t __75__PLModelMigrator__fixZeroTrashedDateForEntityName_inManagedObjectContext___block_invoke(uint64_t a1, void *a2)
{
  result = [a2 setValue:0 forKey:@"trashedDate"];
  ++*(*(*(a1 + 32) + 8) + 24);
  return result;
}

- (BOOL)_fixTrashedDate:(id)a3
{
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixTrashedDate:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = +[PLManagedAsset entityName];
  v8 = [(PLModelMigrator *)self _fixZeroTrashedDateForEntityName:v7 inManagedObjectContext:v6];

  if (v8)
  {
    v9 = +[PLGenericAlbum entityName];
    v10 = [(PLModelMigrator *)self _fixZeroTrashedDateForEntityName:v9 inManagedObjectContext:v6];
  }

  else
  {
    v10 = 0;
  }

  [v6 reset];

  objc_autoreleasePoolPop(v5);
  return v10;
}

- (BOOL)_fixMasterCloudLocalStateEnum:(id)a3
{
  v21 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Fixing cloudLocalState enum for master", buf, 2u);
  }

  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixMasterCloudLocalStateEnum:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = objc_alloc(MEMORY[0x1E695D560]);
  v9 = +[PLCloudMaster entityName];
  v10 = [v8 initWithEntityName:v9];

  [v10 setResultType:2];
  [v10 setPropertiesToUpdate:&unk_1F0FC06B8];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 1];
  [v10 setPredicate:v11];

  v18 = 0;
  v12 = [v7 executeRequest:v10 error:&v18];
  v13 = v18;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v13)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v20 = v13;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Failed to fix pushed masters: %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [v12 result];
    *buf = 138412290;
    v20 = v16;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Fixed %@ pushed masters, setting them to CPLIsUploaded", buf, 0xCu);
  }

  [v7 reset];
  objc_autoreleasePoolPop(v5);

  return v13 == 0;
}

- (BOOL)_tryToPromoteUnknownAssetsInStore:(id)a3
{
  v23 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if ([(PLModelMigrator *)self isCloudPhotoLibraryEnabled])
  {
    v5 = objc_autoreleasePoolPush();
    v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _tryToPromoteUnknownAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
    v20 = 0;
    v7 = [PLManagedAsset assetsToConsiderForTypePromotionInContext:v6 withExtensions:&unk_1F0FBF9B8 error:&v20];
    v8 = v20;
    v16 = 0;
    v17 = &v16;
    v18 = 0x2020000000;
    v19 = 0;
    if (v7)
    {
      v15[0] = MEMORY[0x1E69E9820];
      v15[1] = 3221225472;
      v15[2] = __53__PLModelMigrator__tryToPromoteUnknownAssetsInStore___block_invoke;
      v15[3] = &unk_1E7568EB0;
      v15[4] = &v16;
      v9 = [v6 enumerateWithIncrementalSaveUsingObjects:v7 shouldRefreshAfterSave:1 withBlock:v15];

      if (v9)
      {
        v10 = PLMigrationGetLog();
        if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v22 = v9;
          _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "Failed to enumerate unknown assets for promotion with error %@", buf, 0xCu);
        }

        v11 = 0;
      }

      else
      {
        v12 = [(PLModelMigrator *)self _migrationThumbnailManagerWithStore:v4];
        [v12 addRebuildThumbnailsRequest];

        v10 = PLMigrationGetLog();
        if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
        {
          v13 = v17[3];
          *buf = 134217984;
          v22 = v13;
          _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Promoted %lu assets from asset type unknown.", buf, 0xCu);
        }

        v9 = 0;
        v11 = 1;
      }
    }

    else
    {
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v22 = v8;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "Failed to fetch for unknown assets for promotion with error %@", buf, 0xCu);
      }

      v11 = 0;
      v9 = v8;
    }

    _Block_object_dispose(&v16, 8);
    objc_autoreleasePoolPop(v5);
  }

  else
  {
    v11 = 1;
  }

  return v11;
}

uint64_t __53__PLModelMigrator__tryToPromoteUnknownAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  result = [a2 promoteFromUnknownKind];
  if (result)
  {
    ++*(*(*(a1 + 32) + 8) + 24);
  }

  return result;
}

- (BOOL)_rebuildWideCaptureThumbsInStore:(id)a3
{
  v44[2] = *MEMORY[0x1E69E9840];
  v34 = a3;
  context = objc_autoreleasePoolPush();
  v33 = self;
  v32 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v34 name:"[PLModelMigrator _rebuildWideCaptureThumbsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  v7 = [(PLModelMigrator *)self _dateForWideGamutCapture];
  v8 = MEMORY[0x1E696AB28];
  v31 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K >= %@", @"dateCreated", v7];
  v43[0] = v31;
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %@", @"originalColorSpace", @"Display P3"];
  v43[1] = v9;
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v43 count:2];
  v11 = [v8 andPredicateWithSubpredicates:v10];
  v44[0] = v11;
  v12 = MEMORY[0x1E696AB28];
  v13 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:0];
  v42[0] = v13;
  v35 = v7;
  v14 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K >= %@", @"adjustmentTimestamp", v7];
  v42[1] = v14;
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:v42 count:2];
  v16 = [v12 andPredicateWithSubpredicates:v15];
  v44[1] = v16;
  v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:v44 count:2];
  v18 = [v8 orPredicateWithSubpredicates:v17];
  [v6 setPredicate:v18];

  v19 = v6;
  [v6 setFetchBatchSize:100];
  v20 = [(PLModelMigrator *)v33 _migrationThumbnailManagerWithStore:v34];
  v39 = 0;
  v21 = [v32 executeFetchRequest:v6 error:&v39];
  v22 = v39;
  v23 = [v21 count];
  if (!v21 || v22)
  {
    v28 = PLMigrationGetLog();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v41 = v22;
      _os_log_impl(&dword_19BF1F000, v28, OS_LOG_TYPE_ERROR, "Failed to fetch wide gamut capture assets with error %@", buf, 0xCu);
    }

    v26 = 0;
  }

  else
  {
    v24 = v23;
    v37[0] = MEMORY[0x1E69E9820];
    v37[1] = 3221225472;
    v37[2] = __52__PLModelMigrator__rebuildWideCaptureThumbsInStore___block_invoke;
    v37[3] = &unk_1E7575368;
    v25 = v20;
    v38 = v25;
    v26 = [v32 enumerateWithIncrementalSaveUsingObjects:v21 shouldRefreshAfterSave:1 withBlock:v37];

    if (!v26)
    {
      [v25 addRebuildThumbnailsRequest];
      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v41 = v24;
        _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "Deleted thumbnails for %lu wide gamut captures and marked for rebuild", buf, 0xCu);
      }

      v27 = 1;
      goto LABEL_13;
    }
  }

  v29 = PLMigrationGetLog();
  if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v41 = v26;
    _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_ERROR, "Failed to enumerate thumbnails for wide gamut captures with error %@", buf, 0xCu);
  }

  v27 = 0;
LABEL_13:

  objc_autoreleasePoolPop(context);
  return v27;
}

void __52__PLModelMigrator__rebuildWideCaptureThumbsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v6 = a2;
  v3 = [v6 thumbnailIdentifier];
  v4 = [v6 thumbnailIndex];
  v5 = [v6 uuid];
  [v2 deleteThumbnailsWithIdentifier:v3 orIndex:v4 uuid:v5];

  [v6 setEffectiveThumbnailIndex:0x7FFFFFFFFFFFFFFFLL];
}

- (id)_dateForWideGamutCapture
{
  v2 = [MEMORY[0x1E695DEE8] calendarWithIdentifier:*MEMORY[0x1E695D850]];
  v3 = objc_alloc_init(MEMORY[0x1E695DF10]);
  [v3 setYear:2016];
  [v3 setMonth:6];
  [v3 setDay:1];
  v4 = [v2 dateFromComponents:v3];

  return v4;
}

- (BOOL)_removeUntrackedCloudResourceImageDerivativesInStore:(id)a3
{
  v27 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removeUntrackedCloudResourceImageDerivativesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLCloudResource entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"isLocallyAvailable == NO AND isAvailable == YES AND filePath != nil AND (type == %d OR type == %d)", 4, 5];
  [v9 setPredicate:v10];

  v24 = 0;
  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v19[0] = 0;
  v19[1] = v19;
  v19[2] = 0x2020000000;
  v19[3] = 0;
  v18[0] = MEMORY[0x1E69E9820];
  v18[1] = 3221225472;
  v18[2] = __72__PLModelMigrator__removeUntrackedCloudResourceImageDerivativesInStore___block_invoke;
  v18[3] = &unk_1E7569390;
  v18[4] = &v20;
  v18[5] = v19;
  v11 = [v6 enumerateObjectsFromFetchRequest:v9 count:&v24 usingDefaultBatchSizeWithBlock:v18];
  if (v11)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v26 = v11;
      v13 = "Failed to remove untracked images with error %@";
      v14 = v12;
      v15 = OS_LOG_TYPE_ERROR;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v14, v15, v13, buf, 0xCu);
    }
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v16 = v21[3];
      *buf = 134217984;
      v26 = v16;
      v13 = "Removed %lu untracked images.";
      v14 = v12;
      v15 = OS_LOG_TYPE_DEFAULT;
      goto LABEL_6;
    }
  }

  _Block_object_dispose(v19, 8);
  _Block_object_dispose(&v20, 8);

  objc_autoreleasePoolPop(v5);
  return v11 == 0;
}

void __72__PLModelMigrator__removeUntrackedCloudResourceImageDerivativesInStore___block_invoke(uint64_t a1, void *a2)
{
  v18 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [MEMORY[0x1E696AC08] defaultManager];
  v5 = [v3 filePath];
  v6 = [v4 fileExistsAtPath:v5];

  if (v6)
  {
    v7 = [MEMORY[0x1E696AC08] defaultManager];
    v8 = [v3 filePath];
    v13 = 0;
    v9 = [v7 removeItemAtPath:v8 error:&v13];
    v10 = v13;

    if (v9)
    {
      ++*(*(*(a1 + 32) + 8) + 24);
    }

    else
    {
      ++*(*(*(a1 + 40) + 8) + 24);
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        v12 = *(*(*(a1 + 40) + 8) + 24);
        *buf = 134218242;
        v15 = v12;
        v16 = 2112;
        v17 = v10;
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Failed to remove file (%lu total failures so far) with error: %@", buf, 0x16u);
      }
    }
  }
}

- (BOOL)_fixupCroppedUnadjustedAssets:(id)a3
{
  v31[3] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupCroppedUnadjustedAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setFetchBatchSize:100];
  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kind", 0];
  v31[0] = v11;
  v12 = [PLManagedAsset predicateForUnadjustedAssetsWithKeyPathToAsset:0];
  v31[1] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K IN %@", @"orientation", &unk_1F0FBF9A0];
  v31[2] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v31 count:3];
  v15 = [v10 andPredicateWithSubpredicates:v14];
  [v9 setPredicate:v15];

  v16 = [v6 executeFetchRequest:v9 error:0];
  v25 = 0;
  v26 = &v25;
  v27 = 0x2020000000;
  v28 = 0;
  v24[0] = MEMORY[0x1E69E9820];
  v24[1] = 3221225472;
  v24[2] = __49__PLModelMigrator__fixupCroppedUnadjustedAssets___block_invoke;
  v24[3] = &unk_1E7568EB0;
  v24[4] = &v25;
  v17 = [v6 enumerateWithIncrementalSaveUsingObjects:v16 withBlock:v24];
  if (v17)
  {
    v18 = PLMigrationGetLog();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v30 = v17;
      v19 = "_fixupCroppedUnadjustedAssets failed: %@";
      v20 = v18;
      v21 = OS_LOG_TYPE_ERROR;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v20, v21, v19, buf, 0xCu);
    }
  }

  else
  {
    v18 = PLMigrationGetLog();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v22 = v26[3];
      *buf = 134217984;
      v30 = v22;
      v19 = "Fixed %lu CroppedUnadjustedAssets";
      v20 = v18;
      v21 = OS_LOG_TYPE_DEFAULT;
      goto LABEL_6;
    }
  }

  _Block_object_dispose(&v25, 8);
  objc_autoreleasePoolPop(v5);

  return v17 == 0;
}

void __49__PLModelMigrator__fixupCroppedUnadjustedAssets___block_invoke(uint64_t a1, void *a2)
{
  v7 = a2;
  v3 = [v7 originalWidth];
  v4 = [v7 originalHeight];
  v5 = [v7 originalOrientation] - 5;
  if (v5 >= 4)
  {
    v6 = v3;
  }

  else
  {
    v6 = v4;
  }

  if (v5 >= 4)
  {
    v3 = v4;
  }

  if ([v7 width] != v6 || objc_msgSend(v7, "height") != v3)
  {
    ++*(*(*(a1 + 32) + 8) + 24);
    [v7 setWidth:v6];
    [v7 setHeight:v3];
  }
}

- (BOOL)_trimInvalidAlbumAssetsMappingRecords
{
  v20 = *MEMORY[0x1E69E9840];
  v2 = [(PLModelMigrator *)self pathManager];
  v3 = [v2 photosDatabasePath];
  v4 = [v3 fileSystemRepresentation];

  v5 = PLOpenSQLTransactionWithDBPath(v4);
  if (!v5)
  {
    return 1;
  }

  v6 = v5;
  errmsg = 0;
  v7 = [MEMORY[0x1E696AEC0] stringWithFormat:@"DELETE FROM %@ WHERE ROWID IN(                                SELECT                                     MAP.ROWID                                 FROM                                     %@ AS MAP                                     LEFT OUTER JOIN ZGENERICASSET AS ASSET ON MAP.%@ = ASSET.Z_PK                                     LEFT OUTER JOIN ZGENERICALBUM AS ALBUM ON MAP.%@ = ALBUM.Z_PK                                     LEFT OUTER JOIN Z_PRIMARYKEY AS PK ON ALBUM.Z_ENT = PK.Z_ENT                                 WHERE                                     ASSET.ZUUID IS NULL OR                                     ALBUM.ZUUID IS NULL OR                                     PK.Z_NAME IN ('FetchingAlbum'))", @"Z_15ASSETS", @"Z_15ASSETS", @"Z_22ASSETS", @"Z_15ALBUMS"];
  v8 = sqlite3_exec(v6, [v7 UTF8String], 0, 0, &errmsg);
  v9 = v8 == 0;
  if (v8)
  {
    v10 = v8;
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109378;
      v17 = v10;
      v18 = 2080;
      v19 = errmsg;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Failed to clear invalid asset to album mapping records, %d %s", buf, 0x12u);
    }

    PLRollbackSQLTransactionAndCloseDB(v6);
  }

  else
  {
    v12 = sqlite3_changes(v6);
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v17 = v12;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Cleared %d invalid asset to album mapping records.", buf, 8u);
    }

    PLCommitSQLTransactionAndCloseDB(v6);
  }

  return v9;
}

- (BOOL)_fixRejectedKeyFace:(id)a3
{
  v27 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixRejectedKeyFace:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLPerson entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"verifiedType = %d AND rejectedFaces.@count == 0", 1];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v21 = 0;
  v22 = &v21;
  v23 = 0x2020000000;
  v24 = 0;
  v11 = [v6 executeFetchRequest:v9 error:0];
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = __39__PLModelMigrator__fixRejectedKeyFace___block_invoke;
  v20[3] = &unk_1E7569368;
  v20[4] = &v21;
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v20];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v26 = v12;
      v14 = "Failed to fix faces: %@";
      v15 = v13;
      v16 = OS_LOG_TYPE_ERROR;
      v17 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v15, v16, v14, buf, v17);
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v18 = *(v22 + 6);
      *buf = 67109120;
      LODWORD(v26) = v18;
      v14 = "Fixed %d faces keyFace, setting them to nil";
      v15 = v13;
      v16 = OS_LOG_TYPE_DEFAULT;
      v17 = 8;
      goto LABEL_6;
    }
  }

  [v6 reset];
  _Block_object_dispose(&v21, 8);

  objc_autoreleasePoolPop(v5);
  return v12 == 0;
}

void __39__PLModelMigrator__fixRejectedKeyFace___block_invoke(uint64_t a1, void *a2)
{
  v6 = a2;
  v3 = [v6 keyFace];
  if (v3)
  {
    v4 = [v6 rejectedFaces];
    v5 = [v4 containsObject:v3];

    if (v5)
    {
      [v6 setKeyFace:0 pickSource:0];
      ++*(*(*(a1 + 32) + 8) + 24);
    }
  }
}

- (BOOL)_fixMergedPeopleThatShouldBeVerified:(id)a3
{
  v25 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixMergedPeopleThatShouldBeVerified:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLPerson entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"verifiedType = %d AND detectedFaces.@count > 1", 0];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __56__PLModelMigrator__fixMergedPeopleThatShouldBeVerified___block_invoke;
  v21[3] = &unk_1E7572300;
  v22 = v6;
  v12 = v6;
  v13 = [v12 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v21];
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v13)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v24 = v13;
      v16 = "Failed to verified unverified person: %@";
      v17 = v15;
      v18 = OS_LOG_TYPE_ERROR;
      v19 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v17, v18, v16, buf, v19);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    LODWORD(v24) = 0;
    v16 = "Verified %d unverified person";
    v17 = v15;
    v18 = OS_LOG_TYPE_DEFAULT;
    v19 = 8;
    goto LABEL_6;
  }

  [v12 reset];
  objc_autoreleasePoolPop(v5);

  return v13 == 0;
}

void __56__PLModelMigrator__fixMergedPeopleThatShouldBeVerified___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 associatedFaceGroup];
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v5 = [v3 detectedFaces];
  v6 = [v5 countByEnumeratingWithState:&v18 objects:v22 count:16];
  if (v6)
  {
    v7 = v6;
    v16 = a1;
    v17 = v4;
    v8 = *v19;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v19 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = [*(*(&v18 + 1) + 8 * i) faceGroup];
        if (v10)
        {
          v11 = v10;
          v12 = [v10 uuid];
          v13 = [v3 associatedFaceGroup];
          v14 = [v13 uuid];
          v15 = [v12 isEqualToString:v14];

          if ((v15 & 1) == 0)
          {

            [v3 setAssociatedFaceGroup:0];
            [v3 setEffectiveVerifiedType:1];
            v4 = v17;
            [PLPerson createAssociatedPersonForFaceGroup:v17 inManagedObjectContext:*(v16 + 32)];
            goto LABEL_13;
          }
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v18 objects:v22 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }

    v4 = v17;
  }

  else
  {
  }

LABEL_13:
}

- (BOOL)_refreshTriggerValues:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v3 = a3;
  pl_dispatch_once();
  v4 = objc_autoreleasePoolPush();
  v5 = [v3 persistentStoreCoordinator];
  v15 = 0;
  v6 = [v5 _refreshTriggerValuesInStore:v3 error:&v15];
  v7 = v15;
  v8 = PLMigrationGetLog();
  v9 = v8;
  if (v6)
  {
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v10 = "Refreshed trigger values";
      v11 = v9;
      v12 = OS_LOG_TYPE_DEFAULT;
      v13 = 2;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v11, v12, v10, buf, v13);
    }
  }

  else if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v17 = v7;
    v10 = "Failed to refresh trigger values: %@";
    v11 = v9;
    v12 = OS_LOG_TYPE_ERROR;
    v13 = 12;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v4);
  return 1;
}

- (BOOL)_setUserTypeOnKeyFace:(id)a3
{
  v50[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v36 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _setUserTypeOnKeyFace:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLDetectedFace entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"nameSource = 1"];
  [v8 setPredicate:v9];

  [v8 setFetchBatchSize:100];
  v40 = 0;
  v41 = &v40;
  v42 = 0x2020000000;
  v43 = 0;
  v10 = [v5 executeFetchRequest:v8 error:0];
  v39[5] = MEMORY[0x1E69E9820];
  v39[6] = 3221225472;
  v39[7] = __41__PLModelMigrator__setUserTypeOnKeyFace___block_invoke;
  v39[8] = &unk_1E7575218;
  v39[9] = &v40;
  v35 = v10;
  v38 = [v5 enumerateWithIncrementalSaveUsingObjects:? withBlock:?];
  if (!v38)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v14 = *(v41 + 6);
      LODWORD(buf) = 67109120;
      DWORD1(buf) = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Reset %d faces' nameSource to type auto", &buf, 8u);
    }

    v15 = MEMORY[0x1E695D5E0];
    v16 = +[PLDetectedFace entityName];
    v11 = [v15 fetchRequestWithEntityName:v16];

    v34 = MEMORY[0x1E696AB28];
    v17 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"personForFace.verifiedType", 1];
    v50[0] = v17;
    v18 = MEMORY[0x1E696AB28];
    v19 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != nil", @"faceGroupBeingKeyFace"];
    v49[0] = v19;
    v20 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != nil", @"personBeingKeyFace"];
    v49[1] = v20;
    v21 = [MEMORY[0x1E695DEC8] arrayWithObjects:v49 count:2];
    v22 = [v18 orPredicateWithSubpredicates:v21];
    v50[1] = v22;
    v23 = [MEMORY[0x1E695DEC8] arrayWithObjects:v50 count:2];
    v24 = [v34 andPredicateWithSubpredicates:v23];
    [v11 setPredicate:v24];

    [v11 setFetchBatchSize:100];
    *&buf = 0;
    *(&buf + 1) = &buf;
    v47 = 0x2020000000;
    v48 = 0;
    v25 = [v5 executeFetchRequest:v11 error:0];
    v39[0] = MEMORY[0x1E69E9820];
    v39[1] = 3221225472;
    v39[2] = __41__PLModelMigrator__setUserTypeOnKeyFace___block_invoke_2189;
    v39[3] = &unk_1E7575218;
    v39[4] = &buf;
    v26 = [v5 enumerateWithIncrementalSaveUsingObjects:v25 withBlock:v39];
    v12 = v26 == 0;
    if (v26)
    {
      v27 = PLMigrationGetLog();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
      {
        *v44 = 138412290;
        v45 = v26;
        v28 = "Failed to marked faces: %@";
        v29 = v27;
        v30 = OS_LOG_TYPE_ERROR;
        v31 = 12;
LABEL_12:
        _os_log_impl(&dword_19BF1F000, v29, v30, v28, v44, v31);
      }
    }

    else
    {
      v27 = PLMigrationGetLog();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT))
      {
        v32 = *(*(&buf + 1) + 24);
        *v44 = 67109120;
        LODWORD(v45) = v32;
        v28 = "Marked %d faces' nameSource to type user";
        v29 = v27;
        v30 = OS_LOG_TYPE_DEFAULT;
        v31 = 8;
        goto LABEL_12;
      }
    }

    _Block_object_dispose(&buf, 8);
    goto LABEL_14;
  }

  v11 = PLMigrationGetLog();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
  {
    LODWORD(buf) = 138412290;
    *(&buf + 4) = v38;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Failed to reset faces: %@", &buf, 0xCu);
  }

  v12 = 0;
LABEL_14:

  [v5 reset];
  _Block_object_dispose(&v40, 8);

  objc_autoreleasePoolPop(context);
  return v12;
}

void __41__PLModelMigrator__setUserTypeOnKeyFace___block_invoke(uint64_t a1, void *a2)
{
  v6 = a2;
  [v6 setEffectiveNameSource:0];
  v3 = [v6 associatedAssetForFaceOrTorso:0 orTemporal:0];
  v4 = [v3 cloudLocalState];

  if (v4)
  {
    v5 = [v6 associatedAssetForFaceOrTorso:0 orTemporal:0];
    [v5 setCloudLocalState:0];
  }

  ++*(*(*(a1 + 32) + 8) + 24);
}

void __41__PLModelMigrator__setUserTypeOnKeyFace___block_invoke_2189(uint64_t a1, void *a2)
{
  v8 = a2;
  v3 = [v8 nameSource] == 1;
  v4 = v8;
  if (!v3)
  {
    [v8 setEffectiveNameSource:1];
    v5 = [v8 associatedAssetForFaceOrTorso:0 orTemporal:0];
    v6 = [v5 cloudLocalState];

    if (v6)
    {
      v7 = [v8 associatedAssetForFaceOrTorso:0 orTemporal:0];
      [v7 setCloudLocalState:0];
    }

    ++*(*(*(a1 + 32) + 8) + 24);
    v4 = v8;
  }
}

- (BOOL)_recoverSingleBurstPhotos:(id)a3
{
  v55[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v40 = objc_autoreleasePoolPush();
  v41 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _recoverSingleBurstPhotos:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = objc_alloc_init(MEMORY[0x1E695D5C8]);
  [v6 setName:@"count"];
  v7 = [MEMORY[0x1E696ABC8] expressionWithFormat:@"count:(avalancheUUID)"];
  [v6 setExpression:v7];

  [v6 setExpressionResultType:300];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v55[0] = @"avalancheUUID";
  v55[1] = v6;
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v55 count:2];
  [v10 setPropertiesToFetch:v11];

  [v10 setPropertiesToGroupBy:&unk_1F0FBF988];
  [v10 setResultType:2];
  v12 = objc_alloc_init(MEMORY[0x1E695DFA8]);
  v48[0] = MEMORY[0x1E69E9820];
  v48[1] = 3221225472;
  v48[2] = __45__PLModelMigrator__recoverSingleBurstPhotos___block_invoke;
  v48[3] = &unk_1E7574658;
  v13 = v12;
  v49 = v13;
  v14 = [v5 enumerateObjectsFromFetchRequest:v10 count:0 usingDefaultBatchSizeWithBlock:v48];
  v15 = MEMORY[0x1E695D5E0];
  v16 = +[PLManagedAsset entityName];
  v17 = [v15 fetchRequestWithEntityName:v16];

  v18 = MEMORY[0x1E696AE18];
  v19 = [v13 allObjects];
  v20 = [v18 predicateWithFormat:@"avalancheUUID IN %@", v19];
  [v17 setPredicate:v20];

  v47 = v14;
  v21 = [v5 executeFetchRequest:v17 error:&v47];
  v22 = v47;

  v39 = v22;
  if (!v21)
  {
    v31 = PLMigrationGetLog();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
    {
      v33 = [v22 userInfo];
      *buf = 138412546;
      v52 = v22;
      v53 = 2112;
      v54 = v33;
      _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_ERROR, "_recoverSingleBurstPhotos: failed: %@ %@", buf, 0x16u);
    }

    v32 = 0;
    v29 = v40;
    v34 = v41;
    goto LABEL_22;
  }

  v38 = [v21 count];
  [PLAvalanche disolveBurstForAssets:v21 permanently:0];
  v45 = 0u;
  v46 = 0u;
  v43 = 0u;
  v44 = 0u;
  v23 = v21;
  v24 = [v23 countByEnumeratingWithState:&v43 objects:v50 count:16];
  if (v24)
  {
    v25 = v24;
    v26 = *v44;
    do
    {
      for (i = 0; i != v25; ++i)
      {
        if (*v44 != v26)
        {
          objc_enumerationMutation(v23);
        }

        [*(*(&v43 + 1) + 8 * i) persistMetadataToFilesystem];
      }

      v25 = [v23 countByEnumeratingWithState:&v43 objects:v50 count:16];
    }

    while (v25);
  }

  if ([v5 hasChanges])
  {
    v28 = PLMigrationGetLog();
    v29 = v40;
    if (os_log_type_enabled(v28, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v52 = v38;
      _os_log_impl(&dword_19BF1F000, v28, OS_LOG_TYPE_DEFAULT, "Recover %lu single burst photo", buf, 0xCu);
    }

    v42 = 0;
    v30 = [v5 save:&v42];
    v31 = v42;
    if (v30)
    {
      v32 = 1;
    }

    else
    {
      v35 = PLMigrationGetLog();
      if (os_log_type_enabled(v35, OS_LOG_TYPE_ERROR))
      {
        v36 = [v31 userInfo];
        *buf = 138412546;
        v52 = v31;
        v53 = 2112;
        v54 = v36;
        _os_log_impl(&dword_19BF1F000, v35, OS_LOG_TYPE_ERROR, "_recoverSingleBurstPhotos: failed: %@ %@", buf, 0x16u);
      }

      v32 = 0;
    }

    v34 = v41;
LABEL_22:

    goto LABEL_23;
  }

  v32 = 1;
  v29 = v40;
  v34 = v41;
LABEL_23:

  objc_autoreleasePoolPop(v29);
  return v32;
}

void __45__PLModelMigrator__recoverSingleBurstPhotos___block_invoke(uint64_t a1, void *a2)
{
  v7 = a2;
  v3 = [v7 objectForKeyedSubscript:@"count"];
  v4 = [v3 integerValue];

  if (v4 == 1)
  {
    v5 = *(a1 + 32);
    v6 = [v7 objectForKeyedSubscript:@"avalancheUUID"];
    [v5 addObject:v6];
  }
}

- (void)_repairMetadataAndSingletonsForMigrationType:(int64_t)a3 forceRebuildReason:(id)a4 journalRebuildRequired:(BOOL)a5
{
  v7 = a4;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v8 = [MEMORY[0x1E696AAA8] currentHandler];
    [v8 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:10602 description:@"-[PLModelMigrator addSingletonObjectsToDatabase] can only be called from assetsd"];
  }

  if (PLIsAssetsd())
  {
    pl_dispatch_once();
    v9 = v7;
    pl_dispatch_sync();
  }
}

void __106__PLModelMigrator__repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired___block_invoke_2(uint64_t a1)
{
  v2 = *(a1 + 48);
  if (v2)
  {
    v3 = PLStringFromMigrationType(v2, 1);
  }

  else
  {
    v3 = @"repairing singletons";
  }

  v4 = [*(a1 + 32) pathManager];
  v5 = [v4 libraryURL];
  v25 = 0;
  v6 = [PLManagedObjectContext contextForRepairingSingletonObjectsWithReason:v3 libraryURL:v5 error:&v25];
  v7 = v25;

  if (!v6)
  {
    v8 = *(a1 + 32);
    if (*(a1 + 64) == 1)
    {
      [v8 _failed_repairSingletonObjectsInNewDatabaseWithNilContextError:v7];
    }

    else
    {
      [v8 _failed_repairSingletonObjectsWithNilContextError:v7];
    }
  }

  v9 = [v6 persistentStoreCoordinator];
  v10 = [v9 persistentStores];
  v11 = [v10 firstObject];

  if (!v11)
  {
    v12 = *(a1 + 32);
    if (*(a1 + 64) == 1)
    {
      [v12 _failed_repairSingletonObjectsInNewDatabaseWithNoPersistentStores];
    }

    else
    {
      [v12 _failed_repairSingletonObjectsWithNoPersistentStores];
    }
  }

  v16 = MEMORY[0x1E69E9820];
  v17 = 3221225472;
  v18 = __106__PLModelMigrator__repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired___block_invoke_3;
  v19 = &unk_1E756B288;
  v13 = v6;
  v14 = *(a1 + 32);
  v20 = v13;
  v21 = v14;
  v24 = *(a1 + 64);
  v15 = *(a1 + 56);
  v22 = *(a1 + 48);
  v23 = v15;
  [v13 performBlockAndWait:&v16];
  if (*(a1 + 64) == 1 && ([*(a1 + 32) _recordCurrentVersionMetadataInPersistentStore:v11 migrationType:*(a1 + 48) forceRebuildReason:*(a1 + 40) sourceModelVersion:0 updateLegacyMigrationState:1 journalRebuildRequred:{*(a1 + 65), v16, v17, v18, v19}] & 1) == 0)
  {
    [*(a1 + 32) _failed_recordCurrentVersionMetadata];
  }
}

void __106__PLModelMigrator__repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired___block_invoke_3(uint64_t a1)
{
  v28 = *MEMORY[0x1E69E9840];
  [*(a1 + 32) setIsInitializingSingletons:1];
  v2 = *(a1 + 32);
  v3 = [*(a1 + 40) pathManager];
  v21 = 0;
  LOBYTE(v2) = [PLModelMigrationAction_RepairSingletons repairSingletonObjectsInDatabaseUsingContext:v2 pathManager:v3 error:&v21];
  v4 = v21;

  if ((v2 & 1) == 0)
  {
    v5 = *(a1 + 40);
    if (*(a1 + 64) == 1)
    {
      [v5 _failed_repairSingletonObjectsInNewDatabaseWithRepairError:v4];
    }

    else
    {
      [v5 _failed_repairSingletonObjectsWithRepairError:v4];
    }
  }

  if ((*(a1 + 48) | 2) == 3)
  {
    v6 = MEMORY[0x1E69BF188];
    v7 = [*(a1 + 40) pathManager];
    v8 = [v7 libraryURL];
    v9 = [v6 appPrivateDataForLibraryURL:v8];

    v10 = [v9 valueForKey:@"PLModelMigrator.CreateOptions"];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      [*(a1 + 40) setOptions:v10];
      v11 = [v10 objectForKeyedSubscript:@"LibraryCreateOptions"];
      v12 = v11;
      if (v11)
      {
        +[PLGlobalValues setLibraryCreateOptions:managedObjectContext:](PLGlobalValues, "setLibraryCreateOptions:managedObjectContext:", [v11 unsignedIntValue], *(a1 + 32));
      }

      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v23 = v10;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "restored appPrivateData library create options: %@", buf, 0xCu);
      }
    }
  }

  if (*(a1 + 64) == 1)
  {
    [*(a1 + 40) _handleCreateOptionsUsingContext:*(a1 + 32)];
  }

  if ([*(a1 + 32) hasChanges])
  {
    v14 = *(a1 + 32);
    v20 = 0;
    v15 = [v14 save:&v20];
    v16 = v20;
    if ((v15 & 1) == 0)
    {
      v17 = PLMigrationGetLog();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
      {
        v18 = NSStringFromSelector(*(a1 + 56));
        v19 = [v16 userInfo];
        *buf = 138412802;
        v23 = v18;
        v24 = 2112;
        v25 = v16;
        v26 = 2112;
        v27 = v19;
        _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }
  }

  [*(a1 + 32) setIsInitializingSingletons:0];
}

void __106__PLModelMigrator__repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired___block_invoke()
{
  v0 = dispatch_queue_create("com.apple.assetsd.migrator.singletonrepair", 0);
  v1 = _repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired__isolation;
  _repairMetadataAndSingletonsForMigrationType_forceRebuildReason_journalRebuildRequired__isolation = v0;
}

- (void)_failed_recordCurrentVersionMetadata
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Failed to save current metadata", v3, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithRepairError:(id)a3
{
  v8 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v6 = 138412290;
    v7 = v4;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsWithRepairError: %@", &v6, 0xCu);
  }

  [(PLModelMigrator *)self _failed_repairSingletonObjectsWithError:v4];
}

- (void)_failed_repairSingletonObjectsInNewDatabaseWithRepairError:(id)a3
{
  v8 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v6 = 138412290;
    v7 = v4;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsInNewDatabaseWithRepairError: %@", &v6, 0xCu);
  }

  [(PLModelMigrator *)self _failed_repairSingletonObjectsWithError:v4];
}

- (void)_failed_repairSingletonObjectsInNewDatabaseWithNilContextError:(id)a3
{
  v8 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v6 = 138412290;
    v7 = v4;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsInNewDatabaseWithNilContextError: %@", &v6, 0xCu);
  }

  [(PLModelMigrator *)self _failed_repairSingletonObjectsWithError:v4];
}

- (void)_failed_repairSingletonObjectsWithNilContextError:(id)a3
{
  v8 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v6 = 138412290;
    v7 = v4;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsWithNilContextError: %@", &v6, 0xCu);
  }

  [(PLModelMigrator *)self _failed_repairSingletonObjectsWithError:v4];
}

- (void)_failed_repairSingletonObjectsWithError:(id)a3
{
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v16 = 138412290;
    v17 = v4;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsWithError: %@", &v16, 0xCu);
  }

  v6 = [v4 domain];
  v7 = [v6 isEqualToString:*MEMORY[0x1E69BFF48]];

  if (!v7)
  {
    v9 = [v4 domain];
    v10 = [v9 isEqualToString:*MEMORY[0x1E696A250]];

    if (!v10)
    {
      goto LABEL_54;
    }

    v11 = [v4 userInfo];
    v12 = [v11 objectForKey:*MEMORY[0x1E695D488]];

    if (!v12)
    {
      v13 = [v4 code];
      if (v13 <= 134059)
      {
        switch(v13)
        {
          case 134000:
            [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreInvalidTypeError];
            goto LABEL_53;
          case 134010:
            [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTypeMismatchError];
            goto LABEL_53;
          case 134020:
            [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleSchemaError];
            goto LABEL_53;
        }
      }

      else if (v13 > 134089)
      {
        if (v13 == 134090)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTimeoutError];
          goto LABEL_53;
        }

        if (v13 == 134100)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleVersionHashError];
          goto LABEL_53;
        }
      }

      else
      {
        if (v13 == 134060)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSCoreDataError];
          goto LABEL_53;
        }

        if (v13 == 134080)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreOpenError];
LABEL_53:

          goto LABEL_54;
        }
      }

      [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeOtherCoreDataError];
      goto LABEL_53;
    }

    v14 = [v12 intValue];
    if (v14 > 0xC)
    {
      if (v14 > 20)
      {
        if (v14 == 21)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_MISUSE];
          goto LABEL_53;
        }

        if (v14 == 26)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_NOTADB];
          goto LABEL_53;
        }
      }

      else
      {
        if (v14 == 13)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_FULL];
          goto LABEL_53;
        }

        if (v14 == 14)
        {
          [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_CANTOPEN];
          goto LABEL_53;
        }
      }
    }

    else if (v14 > 5)
    {
      if (v14 == 6)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_LOCKED];
        goto LABEL_53;
      }

      if (v14 == 11)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_CORRUPT];
        goto LABEL_53;
      }
    }

    else
    {
      if (v14 == 1)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_ERROR];
        goto LABEL_53;
      }

      if (v14 == 3)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeSQLITE_PERM];
        goto LABEL_53;
      }
    }

    [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeOtherSQLiteError];
    goto LABEL_53;
  }

  v8 = [v4 code];
  if (v8 > 46101)
  {
    if (v8 != 46102)
    {
      if (v8 == 46502)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidState];
        goto LABEL_54;
      }

      goto LABEL_23;
    }

    [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidURL];
  }

  else
  {
    if (v8 != 46006)
    {
      if (v8 == 46007)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryRequiresMigration];
        goto LABEL_54;
      }

LABEL_23:
      [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypeOtherPhotosError];
      goto LABEL_54;
    }

    [(PLModelMigrator *)self _failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryTooNew];
  }

LABEL_54:
  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v16 = 138412290;
    v17 = v4;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsWithError: %@", &v16, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeOtherCoreDataError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSCoreDataError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreInvalidTypeError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTypeMismatchError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleSchemaError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreIncompatibleVersionHashError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreTimeoutError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeNSPersistentStoreOpenError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeOtherSQLiteError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_MISUSE
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_LOCKED
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_ERROR
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_CANTOPEN
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_PERM
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_FULL
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_NOTADB
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeSQLITE_CORRUPT
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypeOtherPhotosError
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidURL
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorInvalidState
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryTooNew
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithErrorTypePLPhotosErrorLibraryRequiresMigration
{
  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    v4 = NSStringFromSelector(a2);
    v5 = 138543362;
    v6 = v4;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "%{public}@", &v5, 0xCu);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsInNewDatabaseWithNoPersistentStores
{
  [(PLModelMigrator *)self _failed_repairSingletonObjectsWithNoPersistentStores];
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsInNewDatabaseWithNoPersistentStores", v3, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithNoPersistentStores
{
  v3 = [MEMORY[0x1E69BF238] fileManager];
  v13 = 0;
  v4 = [(PLModelMigrator *)self pathManager];
  v5 = [v4 libraryURL];
  v6 = [v5 path];
  v7 = [v3 fileExistsAtPath:v6 isDirectory:&v13];

  if (v7)
  {
    if (v13)
    {
      v8 = [(PLModelMigrator *)self pathManager];
      v9 = [v8 photosDatabasePath];
      v10 = [v3 fileExistsAtPath:v9 isDirectory:0];

      if (v10)
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithInvalidDatabaseFile];
      }

      else
      {
        [(PLModelMigrator *)self _failed_repairSingletonObjectsWithMissingDatabaseFile];
      }
    }

    else
    {
      [(PLModelMigrator *)self _failed_repairSingletonObjectsWithInvalidFileTypeLibraryDirectory];
    }
  }

  else
  {
    [(PLModelMigrator *)self _failed_repairSingletonObjectsWithMissingLibraryDirectory];
  }

  v11 = PLMigrationGetLog();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
  {
    *v12 = 0;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "_failed_repairSingletonObjectsInNewDatabaseWithNoPersistentStores", v12, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithInvalidDatabaseFile
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Repair singleton objects in new database failed, cannot open database. Exiting", v3, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithMissingDatabaseFile
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Repair singleton objects in new database failed, cannot create database. Exiting", v3, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithInvalidFileTypeLibraryDirectory
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Repair singleton objects in new database failed, invalid file type library directory. Exiting", v3, 2u);
  }

  __break(1u);
}

- (void)_failed_repairSingletonObjectsWithMissingLibraryDirectory
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    *v3 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Repair singleton objects in new database failed, missing library directory. Exiting", v3, 2u);
  }

  __break(1u);
}

- (BOOL)_deletePhotoCloudSharingMetadataInManagedObjectContext:(id)a3 error:(id *)a4
{
  v38 = *MEMORY[0x1E69E9840];
  v7 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v33 = [MEMORY[0x1E696AAA8] currentHandler];
    [v33 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:10351 description:@"_deleteAllLocalSharedAlbumsMetadataAndMoveTheAssetDataIntoACacheFolder only valid in assetsd!"];
  }

  v8 = PLMigrationGetLog();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Deleting all photo cloud sharing metadata from photo library database", buf, 2u);
  }

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"collectionShareKind", 2];
  v10 = [(PLShare *)PLCollectionShare sharesWithPredicate:v9 fetchLimit:0 inManagedObjectContext:v7];
  if ([v10 count])
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v10 count];
      *buf = 134217984;
      v37 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Deleting %tu shared albums", buf, 0xCu);
    }

    v13 = [v7 enumerateWithIncrementalSaveUsingObjects:v10 withBlock:&__block_literal_global_2140];
    v14 = v13 == 0;
  }

  else
  {
    v13 = 0;
    v14 = 1;
  }

  v15 = [PLGenericAlbum albumsWithKind:1505 inManagedObjectContext:v7];
  if (![v15 count])
  {
    if (!v14)
    {
      goto LABEL_14;
    }

LABEL_17:
    v19 = +[PLManagedAsset assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:](PLManagedAsset, "assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:", [MEMORY[0x1E69BF328] maskForCloudSharedAsset], v7);
    if (![v19 count])
    {
      goto LABEL_23;
    }

    goto LABEL_18;
  }

  v16 = PLMigrationGetLog();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = [v15 count];
    *buf = 134217984;
    v37 = v17;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Deleting %tu shared albums", buf, 0xCu);
  }

  v18 = [v7 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:&__block_literal_global_2144];

  v13 = v18;
  if (!v18)
  {
    goto LABEL_17;
  }

LABEL_14:
  v19 = 0;
  if (![0 count])
  {
    v20 = 0;
    v21 = 0;
    goto LABEL_24;
  }

LABEL_18:
  v22 = PLMigrationGetLog();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = [v19 count];
    *buf = 134217984;
    v37 = v23;
    _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "Deleting %tu shared assets", buf, 0xCu);
  }

  v24 = [v7 enumerateWithIncrementalSaveUsingObjects:v19 withBlock:&__block_literal_global_2147];

  v21 = 0;
  if (v24)
  {
    v20 = 0;
    v13 = v24;
    goto LABEL_24;
  }

  v13 = 0;
LABEL_23:
  v21 = [PLCloudFeedEntry allEntriesInManagedObjectContext:v7];
  v20 = 1;
LABEL_24:
  if ([v21 count])
  {
    v25 = PLMigrationGetLog();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
    {
      v26 = [v21 count];
      *buf = 134217984;
      v37 = v26;
      _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_DEFAULT, "Deleting %tu remaining cloud feed entries", buf, 0xCu);
    }

    v34[0] = MEMORY[0x1E69E9820];
    v34[1] = 3221225472;
    v34[2] = __80__PLModelMigrator__deletePhotoCloudSharingMetadataInManagedObjectContext_error___block_invoke_2149;
    v34[3] = &unk_1E7569318;
    v35 = v7;
    v27 = [v35 enumerateWithIncrementalSaveUsingObjects:v21 withBlock:v34];

    v28 = v27;
    if (v27)
    {
      v29 = v28;
      goto LABEL_30;
    }

    v29 = 0;
LABEL_33:
    v31 = 1;
    goto LABEL_35;
  }

  v29 = v13;
  if (v20)
  {
    goto LABEL_33;
  }

LABEL_30:
  if (a4)
  {
    v30 = v29;
    v31 = 0;
    *a4 = v29;
  }

  else
  {
    v31 = 0;
  }

LABEL_35:

  return v31;
}

- (BOOL)_deletePhotoStreamAssetReferencesInStore:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v20 = [MEMORY[0x1E696AAA8] currentHandler];
    v21 = NSStringFromSelector(a2);
    [v20 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:10324 description:{@"%@ can only be called from assetsd", v21}];
  }

  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _deletePhotoStreamAssetReferencesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = +[PLManagedAsset assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:](PLManagedAsset, "assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:", [MEMORY[0x1E69BF328] maskForPhotoStreamAsset], v7);
  if (![v8 count])
  {
    v16 = 0;
LABEL_18:
    v18 = 1;
    goto LABEL_19;
  }

  v9 = PLMigrationGetLog();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v29 = [v8 count];
    _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Deleting %lu my photo stream assets", buf, 0xCu);
  }

  v25 = 0u;
  v26 = 0u;
  v23 = 0u;
  v24 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v23 objects:v27 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v24;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v24 != v13)
        {
          objc_enumerationMutation(v10);
        }

        [*(*(&v23 + 1) + 8 * i) deleteFromDatabaseOnly];
      }

      v12 = [v10 countByEnumeratingWithState:&v23 objects:v27 count:16];
    }

    while (v12);
  }

  v22 = 0;
  v15 = [v7 save:&v22];
  v16 = v22;
  if (v15)
  {
    goto LABEL_18;
  }

  v17 = PLMigrationGetLog();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v29 = v16;
    _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "Failed to remove old my photo stream assets %@", buf, 0xCu);
  }

  v18 = 0;
LABEL_19:
  [v7 reset];

  objc_autoreleasePoolPop(v6);
  return v18;
}

- (BOOL)_deleteCloudSharedAndSynced:(BOOL)a3 assetReferencesInStore:(id)a4
{
  v4 = a3;
  v44 = *MEMORY[0x1E69E9840];
  v7 = a4;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v32 = [MEMORY[0x1E696AAA8] currentHandler];
    v33 = NSStringFromSelector(a2);
    [v32 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:10276 description:{@"%@ can only be called from assetsd", v33}];
  }

  v8 = objc_autoreleasePoolPush();
  v9 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v7 name:"[PLModelMigrator _deleteCloudSharedAndSynced:assetReferencesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v40 = 0;
  v10 = [(PLModelMigrator *)self _deletePhotoCloudSharingMetadataInManagedObjectContext:v9 error:&v40];
  v11 = v40;
  v12 = PLMigrationGetLog();
  v13 = v12;
  if (!v10)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v43 = v11;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Failed to delete photo cloud sharing data %@", buf, 0xCu);
    }

    v25 = 0;
    goto LABEL_23;
  }

  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Deleted all iCloud shared albums, assets, and feed entries", buf, 2u);
  }

  if (!v4)
  {
    v25 = 1;
    goto LABEL_25;
  }

  v14 = [(PLGenericAlbum *)PLManagedAlbum allSyncedAlbumsInManagedObjectContext:v9];
  v15 = [v14 count];
  v36 = 0u;
  v37 = 0u;
  v38 = 0u;
  v39 = 0u;
  v13 = v14;
  v16 = [v13 countByEnumeratingWithState:&v36 objects:v41 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v37;
    do
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v37 != v18)
        {
          objc_enumerationMutation(v13);
        }

        [*(*(&v36 + 1) + 8 * i) delete];
      }

      v17 = [v13 countByEnumeratingWithState:&v36 objects:v41 count:16];
    }

    while (v17);
  }

  v35 = v11;
  v20 = [v9 save:&v35];
  v21 = v35;

  v22 = PLMigrationGetLog();
  v23 = v22;
  if ((v20 & 1) == 0)
  {
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v43 = v21;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "Failed to delete synced albums %@", buf, 0xCu);
    }

    v25 = 0;
    v11 = v21;
    goto LABEL_23;
  }

  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v43 = v15;
    _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Deleted %ld iTunes synced albums", buf, 0xCu);
  }

  v13 = +[PLManagedAsset assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:](PLManagedAsset, "assetsWithValidatedSavedAssetTypeMask:inManagedObjectContext:", [MEMORY[0x1E69BF328] maskForFinderSyncedAsset], v9);
  v24 = [v13 count];
  v34 = v21;
  v25 = [(PLModelMigrator *)self _batchOfflineDeleteFromDatabaseOnlyAssets:v13 inManagedObjectContext:v9 error:&v34];
  v11 = v34;

  v26 = PLMigrationGetLog();
  v27 = v26;
  if (v25)
  {
    if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v43 = v24;
      v28 = "Deleted %ld iTunes synced assets";
      v29 = v27;
      v30 = OS_LOG_TYPE_DEFAULT;
LABEL_31:
      _os_log_impl(&dword_19BF1F000, v29, v30, v28, buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v43 = v11;
    v28 = "Failed to delete synced assets %@";
    v29 = v27;
    v30 = OS_LOG_TYPE_ERROR;
    goto LABEL_31;
  }

LABEL_23:
LABEL_25:

  objc_autoreleasePoolPop(v8);
  return v25;
}

- (BOOL)_batchOfflineDeleteFromDatabaseOnlyAssets:(id)a3 inManagedObjectContext:(id)a4 error:(id *)a5
{
  v32 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if ([v6 count])
  {
    v8 = objc_alloc_init(MEMORY[0x1E695D5E0]);
    v26 = [(PLManagedObject *)PLManagedAsset entityInManagedObjectContext:v7];
    [v8 setEntity:v26];
    [v8 setReturnsObjectsAsFaults:0];
    [v8 setFetchBatchSize:100];
    v9 = [v26 relationshipsByName];
    v10 = [v9 allKeys];
    [v8 setRelationshipKeyPathsForPrefetching:v10];

    v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self IN %@", v6];
    [v8 setPredicate:v11];

    v29[0] = 0;
    v12 = [v7 executeFetchRequest:v8 error:v29];
    v24 = v29[0];
    v27 = v12 != 0;
    if (v12)
    {
      v13 = [v12 count];
      v14 = 0;
      v15 = 0;
      do
      {
        if (v15 >= v13)
        {
          break;
        }

        v16 = objc_autoreleasePoolPush();
        v17 = 0;
        do
        {
          v18 = [v6 objectAtIndex:v15];
          [v18 deleteFromDatabaseOnly];

          ++v15;
          if (v17 > 0x62)
          {
            break;
          }

          ++v17;
        }

        while (v15 < v13);
        v28 = v14;
        v19 = [v7 save:&v28];
        v20 = v28;

        v14 = v20;
        if ((v19 & 1) == 0)
        {
          v21 = PLMigrationGetLog();
          if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412290;
            v31 = v14;
            _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "Save failed. Rolling back changes. (%@)", buf, 0xCu);
          }

          [v7 rollback];
        }

        objc_autoreleasePoolPop(v16);
      }

      while ((v19 & 1) != 0);
      if (a5)
      {
        v22 = v14;
        *a5 = v14;
      }
    }

    else
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v31 = v24;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "could not batch fault in to-be-deleted assets: %@", buf, 0xCu);
      }
    }
  }

  else
  {
    v27 = 1;
  }

  return v27;
}

BOOL __53__PLModelMigrator__deleteOrphanedExtendedAttributes___block_invoke(uint64_t a1, void *a2)
{
  v18 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = +[PLExtendedAttributes entityName];
  v4 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:v3];
  v5 = [MEMORY[0x1E696AE18] predicateWithFormat:@"asset == nil"];
  [v4 setPredicate:v5];

  v6 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v4];
  [v6 setResultType:2];
  v13 = 0;
  v7 = [v2 executeRequest:v6 error:&v13];

  v8 = v13;
  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v7)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v11 = [v7 result];
      *buf = 138412546;
      v15 = v11;
      v16 = 2112;
      v17 = v3;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Deleted all %@ orphaned %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412546;
    v15 = v3;
    v16 = 2112;
    v17 = v8;
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "Failed to delete orphaned %@, %@", buf, 0x16u);
  }

  return v7 != 0;
}

- (BOOL)_updateSuggestionStartAndEndDatesInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __60__PLModelMigrator__updateSuggestionStartAndEndDatesInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _updateSuggestionStartAndEndDatesInStore:]" store:a3 migrationHandler:v4];
}

BOOL __60__PLModelMigrator__updateSuggestionStartAndEndDatesInStore___block_invoke(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x1E69E9840];
  v3 = MEMORY[0x1E695D5E0];
  v4 = a2;
  v5 = [v3 fetchRequestWithEntityName:@"Suggestion"];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"startDate == nil OR endDate == nil"];
  [v5 setPredicate:v6];

  v7 = [v5 execute:0];
  v8 = [v4 enumerateWithIncrementalSaveUsingObjects:v7 withBlock:&__block_literal_global_2121];

  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v8)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v11 = NSStringFromSelector(*(a1 + 32));
      v12 = [v8 userInfo];
      v14 = 138543874;
      v15 = v11;
      v16 = 2112;
      v17 = v8;
      v18 = 2112;
      v19 = v12;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", &v14, 0x20u);
    }
  }

  else if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    v14 = 134217984;
    v15 = [v7 count];
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "updated %lu suggestions with nil startDates", &v14, 0xCu);
  }

  return v8 == 0;
}

- (BOOL)_addUUIDsToExistingKeywordsInStore:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:a3 name:"[PLModelMigrator _addUUIDsToExistingKeywordsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedKeyword entityName];
  v6 = [v4 fetchRequestWithEntityName:v5];

  [v6 setFetchBatchSize:100];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == nil", @"uuid"];
  [v6 setPredicate:v7];

  v8 = [v3 executeFetchRequest:v6 error:0];
  v9 = [v3 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:&__block_literal_global_2112];
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v9)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v18 = v9;
      v12 = "Failed to add uuids to keywords, error: %@";
      v13 = v11;
      v14 = OS_LOG_TYPE_ERROR;
      v15 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v13, v14, v12, buf, v15);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    v12 = "Added uuids to existing keywords";
    v13 = v11;
    v14 = OS_LOG_TYPE_DEFAULT;
    v15 = 2;
    goto LABEL_6;
  }

  [v3 reset];
  return v9 == 0;
}

void __54__PLModelMigrator__addUUIDsToExistingKeywordsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = MEMORY[0x1E69BF320];
  v3 = a2;
  v4 = [v2 UUIDString];
  [v3 setUuid:v4];
}

- (BOOL)_deletePersistentHistoryInStore:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __51__PLModelMigrator__deletePersistentHistoryInStore___block_invoke;
  v4[3] = &__block_descriptor_40_e32_B16__0__NSManagedObjectContext_8l;
  v4[4] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _deletePersistentHistoryInStore:]" store:a3 migrationHandler:v4];
}

BOOL __51__PLModelMigrator__deletePersistentHistoryInStore___block_invoke(uint64_t a1, uint64_t a2)
{
  v18 = *MEMORY[0x1E69E9840];
  v13 = 0;
  v3 = [PLPersistentHistoryUtilities deleteHistoryBeforeToken:0 withContext:a2 error:&v13];
  v4 = v13;
  v5 = PLMigrationGetLog();
  v6 = v5;
  if (v3)
  {
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v7 = NSStringFromSelector(*(a1 + 32));
      *buf = 138412290;
      v15 = v7;
      v8 = "%@: Deleted persistent history";
      v9 = v6;
      v10 = OS_LOG_TYPE_DEFAULT;
      v11 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v9, v10, v8, buf, v11);
    }
  }

  else if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
  {
    v7 = NSStringFromSelector(*(a1 + 32));
    *buf = 138412546;
    v15 = v7;
    v16 = 2112;
    v17 = v4;
    v8 = "%@: failed to deleted persistent history: %@";
    v9 = v6;
    v10 = OS_LOG_TYPE_ERROR;
    v11 = 22;
    goto LABEL_6;
  }

  return v3;
}

- (BOOL)_nukeWallpaperRemnantsInStore:(id)a3
{
  v45 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _nukeWallpaperRemnantsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [v5 metadata];
  v9 = [v8 mutableCopy];

  [v9 removeObjectForKey:@"PLWallpaperFileHash"];
  v10 = [v7 persistentStoreCoordinator];
  [v10 setMetadata:v9 forPersistentStore:v5];

  v11 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AlbumList"];
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"identifier = %d", 6];
  [v11 setPredicate:v12];
  [v11 setFetchBatchSize:100];
  v39 = 0;
  v13 = [v7 executeFetchRequest:v11 error:&v39];
  v14 = v39;
  v32 = v12;
  v33 = v13;
  if (!v14)
  {
    if ([v13 count])
    {
      v29 = v6;
      v30 = a2;
      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v17 = v13;
      v18 = [v17 countByEnumeratingWithState:&v35 objects:v40 count:16];
      if (v18)
      {
        v19 = v18;
        v20 = *v36;
        do
        {
          for (i = 0; i != v19; ++i)
          {
            if (*v36 != v20)
            {
              objc_enumerationMutation(v17);
            }

            v22 = *(*(&v35 + 1) + 8 * i);
            if ([v22 albumListType] == 6)
            {
              [v7 deleteObject:v22];
            }
          }

          v19 = [v17 countByEnumeratingWithState:&v35 objects:v40 count:16];
        }

        while (v19);
      }

      v6 = v29;
      a2 = v30;
    }

    v34 = 0;
    v23 = [v7 save:&v34];
    v15 = v34;
    if (v23)
    {
      v24 = 1;
      goto LABEL_21;
    }

    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      NSStringFromSelector(a2);
      v25 = v31 = a2;
      *buf = 138412546;
      v42 = v25;
      v43 = 2112;
      v44 = v15;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%@: failed to save: %@", buf, 0x16u);

      a2 = v31;
    }

    goto LABEL_19;
  }

  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v16 = NSStringFromSelector(a2);
    *buf = 138412546;
    v42 = v16;
    v43 = 2112;
    v44 = v14;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "%@: failed to fetch wallpaper album list: %@", buf, 0x16u);
LABEL_19:
  }

  v24 = 0;
LABEL_21:

  v26 = PLMigrationGetLog();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    v27 = NSStringFromSelector(a2);
    *buf = 138412546;
    v42 = v27;
    v43 = 1024;
    LODWORD(v44) = v24;
    _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "%@: finished %d", buf, 0x12u);
  }

  objc_autoreleasePoolPop(v6);
  return v24;
}

- (BOOL)_identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure:(BOOL)a3 inStore:(id)a4
{
  v4 = a3;
  v17[1] = *MEMORY[0x1E69E9840];
  v6 = a4;
  v7 = [(PLModelMigrator *)self _fetchRequestToIdentifyBakedInVariationsCandidatesIncludingLongExposure:v4];
  v8 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s (BakedInVariations)", "-[PLModelMigrator _identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure:inStore:]"];
  v16[0] = MEMORY[0x1E69E9820];
  v16[1] = 3221225472;
  v16[2] = __94__PLModelMigrator__identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure_inStore___block_invoke;
  v16[3] = &unk_1E7569250;
  v16[4] = self;
  v9 = [(PLModelMigrator *)self _runMigrationStepWithName:v8 fetchRequest:v7 store:v6 migrationHandler:v16];

  if (v9)
  {
    if ([(PLModelMigrator *)self isCloudPhotoLibraryEnabled])
    {
      v10 = 1;
    }

    else
    {
      v11 = [(PLModelMigrator *)self _fetchRequestToIdentifyAdjustedDepthAndVariationsCandidates];
      v17[0] = @"additionalAttributes.unmanagedAdjustment";
      v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v17 count:1];
      [v11 setRelationshipKeyPathsForPrefetching:v12];

      v13 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s (adjustments_iCPLOff)", "-[PLModelMigrator _identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure:inStore:]"];
      v15[0] = MEMORY[0x1E69E9820];
      v15[1] = 3221225472;
      v15[2] = __94__PLModelMigrator__identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure_inStore___block_invoke_2;
      v15[3] = &unk_1E7569250;
      v15[4] = self;
      v10 = [(PLModelMigrator *)self _runMigrationStepWithName:v13 fetchRequest:v11 store:v6 migrationHandler:v15];
    }
  }

  else
  {
    v10 = 0;
  }

  return v10;
}

- (id)_fetchRequestToIdentifyAdjustedDepthAndVariationsCandidates
{
  v16[4] = *MEMORY[0x1E69E9840];
  v3 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"playbackVariation", 0];
  v4 = MEMORY[0x1E696AE18];
  v5 = [(PLModelMigrator *)self _dateForVariations];
  v6 = [v4 predicateWithFormat:@"%K >= %@", @"adjustmentTimestamp", v5];

  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K in %@", @"playbackStyle", &unk_1F0FBF970];
  v8 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:0];
  v9 = MEMORY[0x1E696AB28];
  v16[0] = v6;
  v16[1] = v7;
  v16[2] = v3;
  v16[3] = v8;
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v16 count:4];
  v11 = [v9 andPredicateWithSubpredicates:v10];

  v12 = MEMORY[0x1E695D5E0];
  v13 = +[PLManagedAsset entityName];
  v14 = [v12 fetchRequestWithEntityName:v13];

  [v14 setPredicate:v11];

  return v14;
}

- (id)_fetchRequestToIdentifyBakedInVariationsCandidatesIncludingLongExposure:(BOOL)a3
{
  v18[4] = *MEMORY[0x1E69E9840];
  if (a3)
  {
    v4 = [&unk_1F0FBF958 arrayByAddingObject:&unk_1F0FBBE60];
  }

  else
  {
    v4 = &unk_1F0FBF958;
  }

  v5 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"playbackVariation", 0];
  v6 = MEMORY[0x1E696AE18];
  v7 = [(PLModelMigrator *)self _dateForVariations];
  v8 = [v6 predicateWithFormat:@"%K >= %@", @"dateCreated", v7];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K in %@", @"playbackStyle", v4];
  v10 = [PLManagedAsset predicateForUnadjustedAssetsWithKeyPathToAsset:0];
  v11 = MEMORY[0x1E696AB28];
  v18[0] = v8;
  v18[1] = v9;
  v18[2] = v5;
  v18[3] = v10;
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v18 count:4];
  v13 = [v11 andPredicateWithSubpredicates:v12];

  v14 = MEMORY[0x1E695D5E0];
  v15 = +[PLManagedAsset entityName];
  v16 = [v14 fetchRequestWithEntityName:v15];

  [v16 setPredicate:v13];

  return v16;
}

- (BOOL)_identifyVariationsAndDepthAdjustmentsForAsset:(id)a3
{
  v35 = *MEMORY[0x1E69E9840];
  v3 = a3;
  if (![v3 hasAdjustments])
  {
    if ([v3 isVideo])
    {
      v4 = [v3 avAssetProxyForOriginalAllowReadFromFile:1];
      if (v4)
      {
        v18 = [v3 updatePlaybackVariationAndLoopingStyleFromAVAsset:v4];
LABEL_15:
        v13 = v18;
LABEL_30:

        goto LABEL_31;
      }

      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        v27 = [v3 uuid];
        v28 = [v3 pathToOriginalVideoFile];
        v31 = 138412546;
        v32 = v27;
        v33 = 2112;
        v34 = v28;
        v29 = "Failed to create avAsset from video asset %@, %@";
LABEL_27:
        _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, v29, &v31, 0x16u);
      }
    }

    else
    {
      if (![v3 isPhotoIris])
      {
        goto LABEL_20;
      }

      v4 = [v3 metadataFromMediaPropertiesOrOriginalResource];
      if (v4)
      {
        v18 = [v3 updatePlaybackVariationAndStyleFromOriginalMetadata:v4];
        goto LABEL_15;
      }

      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        v27 = [v3 uuid];
        v28 = [v3 mainFileURL];
        v31 = 138412546;
        v32 = v27;
        v33 = 2112;
        v34 = v28;
        v29 = "Failed to get image properties from live photo asset %@, %@";
        goto LABEL_27;
      }
    }

    goto LABEL_29;
  }

  if (([v3 isPhotoIris] & 1) != 0 || objc_msgSend(v3, "isVideo"))
  {
    v4 = [v3 pathForFullsizeRenderVideoFile];
    v5 = [MEMORY[0x1E696AC08] defaultManager];
    v6 = [v5 fileExistsAtPath:v4];

    if (v6)
    {
      v7 = MEMORY[0x1E6987E28];
      v8 = [MEMORY[0x1E695DFF8] fileURLWithPath:v4];
      v9 = [v7 assetWithURL:v8];

      if (v9)
      {
        v10 = [v3 additionalAttributes];
        v11 = [v10 unmanagedAdjustment];
        v12 = [v11 adjustmentRenderTypes];

        v13 = [v3 updatePlaybackVariationAndLoopingStyleFromAVAsset:v9];
        v14 = [v3 updateAdjustmentRenderTypes:v12 withPlaybackVariation:{objc_msgSend(v3, "playbackVariation")}];
        goto LABEL_7;
      }

      goto LABEL_23;
    }

    goto LABEL_29;
  }

  if ([v3 isPhoto])
  {
    v4 = [v3 pathForFullsizeRenderImageFile];
    v19 = [MEMORY[0x1E696AC08] defaultManager];
    v20 = [v19 fileExistsAtPath:v4];

    if (v20)
    {
      v21 = objc_alloc(MEMORY[0x1E69C0718]);
      v22 = [MEMORY[0x1E695DFF8] fileURLWithPath:v4 isDirectory:0];
      v23 = objc_alloc_init(MEMORY[0x1E69C08E8]);
      v9 = [v21 initWithMediaURL:v22 options:12 timeZoneLookup:v23 shouldCache:0];

      if (v9)
      {
        v24 = [v3 additionalAttributes];
        v25 = [v24 unmanagedAdjustment];
        v12 = [v25 adjustmentRenderTypes];

        LODWORD(v24) = [v3 depthType];
        [v3 setDepthTypeFromMetadata:v9];
        v13 = [v3 depthType] != v24;
        v14 = [v3 updateAdjustmentRenderTypes:v12 withDepthType:{objc_msgSend(v3, "depthType")}];
LABEL_7:
        if (v14 != v12)
        {
          v15 = v14;
          v16 = [v3 additionalAttributes];
          v17 = [v16 unmanagedAdjustment];
          [v17 setAdjustmentRenderTypes:v15];

          v13 = 1;
        }

        goto LABEL_24;
      }

LABEL_23:
      v13 = 0;
LABEL_24:

      goto LABEL_30;
    }

LABEL_29:
    v13 = 0;
    goto LABEL_30;
  }

LABEL_20:
  v13 = 0;
LABEL_31:

  return v13;
}

- (id)_dateForVariations
{
  v2 = [MEMORY[0x1E695DEE8] calendarWithIdentifier:*MEMORY[0x1E695D850]];
  v3 = objc_alloc_init(MEMORY[0x1E695DF10]);
  [v3 setYear:2017];
  [v3 setMonth:6];
  [v3 setDay:5];
  v4 = [v2 dateFromComponents:v3];

  return v4;
}

- (BOOL)_runMigrationStepWithName:(id)a3 fetchRequest:(id)a4 store:(id)a5 migrationHandler:(id)a6
{
  v10 = a3;
  v11 = a4;
  v12 = a5;
  v13 = a6;
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 1;
  pl_dispatch_once();
  v14 = objc_autoreleasePoolPush();
  v15 = -[PLModelMigrator managedObjectContextForMigrationInStore:name:concurrencyType:](self, "managedObjectContextForMigrationInStore:name:concurrencyType:", v12, [v10 UTF8String], 1);
  v16 = [v11 fetchBatchSize];
  if (!v16)
  {
    v16 = 100;
    [v11 setFetchBatchSize:100];
  }

  v23[0] = MEMORY[0x1E69E9820];
  v23[1] = 3221225472;
  v23[2] = __81__PLModelMigrator__runMigrationStepWithName_fetchRequest_store_migrationHandler___block_invoke;
  v23[3] = &unk_1E756FCE8;
  v17 = v15;
  v24 = v17;
  v18 = v11;
  v25 = v18;
  v19 = v10;
  v26 = v19;
  v27 = self;
  v29 = &v31;
  v30 = v16;
  v20 = v13;
  v28 = v20;
  [v17 performBlockAndWait:v23];

  objc_autoreleasePoolPop(v14);
  v21 = *(v32 + 24);
  _Block_object_dispose(&v31, 8);

  return v21;
}

void __81__PLModelMigrator__runMigrationStepWithName_fetchRequest_store_migrationHandler___block_invoke(uint64_t a1)
{
  v29 = *MEMORY[0x1E69E9840];
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v22 = 0;
  v4 = [v2 executeFetchRequest:v3 error:&v22];
  v5 = v22;
  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEBUG))
  {
    v7 = [v4 count];
    v8 = *(a1 + 48);
    *buf = 134218242;
    *&buf[4] = v7;
    *&buf[12] = 2112;
    *&buf[14] = v8;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEBUG, "Processing %lu objects for %@.", buf, 0x16u);
  }

  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x2020000000;
  v28 = 0;
  v9 = *(a1 + 32);
  v10 = *(a1 + 80);
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __81__PLModelMigrator__runMigrationStepWithName_fetchRequest_store_migrationHandler___block_invoke_2078;
  v19[3] = &unk_1E7569228;
  v11 = *(a1 + 56);
  v20 = *(a1 + 64);
  v21 = buf;
  v18 = 0;
  LOBYTE(v9) = [v11 _performChangesOnBatchFetchedObjects:v4 inMOC:v9 batchSize:v10 objectHandler:v19 error:&v18];
  v12 = v18;
  *(*(*(a1 + 72) + 8) + 24) = v9;
  if (*(*(*(a1 + 72) + 8) + 24))
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v14 = *(a1 + 48);
      v15 = *(*&buf[8] + 24);
      *v23 = 138412546;
      v24 = v14;
      v25 = 1024;
      LODWORD(v26) = v15;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Migration step %@ successfully processed %d objects", v23, 0x12u);
    }
  }

  else
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = *(a1 + 48);
      *v23 = 138412546;
      v24 = v17;
      v25 = 2112;
      v26 = v12;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%@ save failed: %@", v23, 0x16u);
    }

    *(*(*(a1 + 72) + 8) + 24) = 0;
  }

  _Block_object_dispose(buf, 8);
}

uint64_t __81__PLModelMigrator__runMigrationStepWithName_fetchRequest_store_migrationHandler___block_invoke_2078(uint64_t a1)
{
  result = (*(*(a1 + 32) + 16))();
  if (result)
  {
    ++*(*(*(a1 + 40) + 8) + 24);
  }

  return result;
}

- (BOOL)_runMigrationStepWithPrettyFunction:(const char *)a3 store:(id)a4 migrationHandler:(id)a5
{
  v8 = a4;
  v9 = a5;
  v19 = 0;
  v20 = &v19;
  v21 = 0x2020000000;
  v22 = 1;
  v10 = objc_autoreleasePoolPush();
  pl_dispatch_once();
  v11 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v8 name:a3 concurrencyType:1];
  v15[0] = MEMORY[0x1E69E9820];
  v15[1] = 3221225472;
  v15[2] = __78__PLModelMigrator__runMigrationStepWithPrettyFunction_store_migrationHandler___block_invoke;
  v15[3] = &unk_1E7577918;
  v18 = &v19;
  v12 = v9;
  v17 = v12;
  v13 = v11;
  v16 = v13;
  [v13 performBlockAndWait:v15];

  objc_autoreleasePoolPop(v10);
  LOBYTE(v10) = *(v20 + 24);
  _Block_object_dispose(&v19, 8);

  return v10;
}

uint64_t __78__PLModelMigrator__runMigrationStepWithPrettyFunction_store_migrationHandler___block_invoke(void *a1)
{
  *(*(a1[6] + 8) + 24) = (*(a1[5] + 16))();
  v2 = a1[4];

  return [v2 reset];
}

- (BOOL)_updatePlaybackStylesAndVariationsInStore:(id)a3
{
  v67[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _updatePlaybackStylesAndVariationsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D560];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 batchUpdateRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"playbackStyle", 1];
  [v10 setPredicate:v11];

  v66[0] = @"playbackVariation";
  v66[1] = @"playbackStyle";
  v67[0] = &unk_1F0FBBE30;
  v67[1] = &unk_1F0FBBE48;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v67 forKeys:v66 count:2];
  [v10 setPropertiesToUpdate:v12];

  LODWORD(v12) = [(PLModelMigrator *)self _updatePlaybackWithBatchUpdateRequest:v10 targetDescription:@"autoloop" inContext:v7];
  if (v12 && (v13 = MEMORY[0x1E695D560], +[PLManagedAsset entityName](PLManagedAsset, "entityName"), v14 = objc_claimAutoreleasedReturnValue(), [v13 batchUpdateRequestWithEntityName:v14], v15 = objc_claimAutoreleasedReturnValue(), v14, objc_msgSend(MEMORY[0x1E696AE18], "predicateWithFormat:", @"%K == %d", @"playbackStyle", 3), v16 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v15, "setPredicate:", v16), v16, v64[0] = @"playbackVariation", v64[1] = @"playbackStyle", v65[0] = &unk_1F0FBBE60, v65[1] = &unk_1F0FBBE60, objc_msgSend(MEMORY[0x1E695DF20], "dictionaryWithObjects:forKeys:count:", v65, v64, 2), v17 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v15, "setPropertiesToUpdate:", v17), v17, LODWORD(v17) = -[PLModelMigrator _updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:](self, "_updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:", v15, @"longexposure", v7), v15, v17) && (v18 = MEMORY[0x1E695D560], +[PLManagedAsset entityName](PLManagedAsset, "entityName"), v19 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v18, "batchUpdateRequestWithEntityName:", v19), v20 = objc_claimAutoreleasedReturnValue(), v19, objc_msgSend(MEMORY[0x1E696AE18], "predicateWithFormat:", @"%K == %d", @"playbackStyle", 4), v21 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v20, "setPredicate:", v21), v21, v62[0] = @"playbackVariation", v62[1] = @"playbackStyle", v63[0] = &unk_1F0FBBE78, v63[1] = &unk_1F0FBBE48, objc_msgSend(MEMORY[0x1E695DF20], "dictionaryWithObjects:forKeys:count:", v63, v62, 2), v22 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v20, "setPropertiesToUpdate:", v22), v22, LODWORD(v22) = -[PLModelMigrator _updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:](self, "_updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:", v20, @"pingpong", v7), v20, v22))
  {
    v50 = v5;
    v51 = v6;
    v23 = MEMORY[0x1E695D560];
    v24 = +[PLManagedAsset entityName];
    v25 = [v23 batchUpdateRequestWithEntityName:v24];

    v26 = +[PLManagedAsset videoComplementVisibilityStatePlayablePredicate];
    v27 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K = 0", @"kindSubtype", 2, @"playbackStyle"];
    v28 = MEMORY[0x1E696AB28];
    v61[0] = v27;
    v61[1] = v26;
    v29 = [MEMORY[0x1E695DEC8] arrayWithObjects:v61 count:2];
    v30 = [v28 andPredicateWithSubpredicates:v29];

    [v25 setPredicate:v30];
    v59 = @"playbackStyle";
    v60 = &unk_1F0FBBE60;
    v31 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v60 forKeys:&v59 count:1];
    [v25 setPropertiesToUpdate:v31];

    LODWORD(v31) = [(PLModelMigrator *)self _updatePlaybackWithBatchUpdateRequest:v25 targetDescription:@"live photo" inContext:v7];
    if (v31 && (v32 = MEMORY[0x1E695D560], +[PLManagedAsset entityName](PLManagedAsset, "entityName"), v33 = objc_claimAutoreleasedReturnValue(), [v32 batchUpdateRequestWithEntityName:v33], v34 = objc_claimAutoreleasedReturnValue(), v33, objc_msgSend(MEMORY[0x1E696AE18], "predicateWithFormat:", @"%K == %d and %K = 0", @"kind", 0, @"playbackStyle"), v35 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v34, "setPredicate:", v35), v35, v57 = @"playbackStyle", v58 = &unk_1F0FBBE30, objc_msgSend(MEMORY[0x1E695DF20], "dictionaryWithObjects:forKeys:count:", &v58, &v57, 1), v36 = objc_claimAutoreleasedReturnValue(), objc_msgSend(v34, "setPropertiesToUpdate:", v36), v36, v37 = -[PLModelMigrator _updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:](self, "_updatePlaybackWithBatchUpdateRequest:targetDescription:inContext:", v34, @"image", v7), v34, v37))
    {
      v38 = MEMORY[0x1E695D560];
      v39 = +[PLManagedAsset entityName];
      v40 = [v38 batchUpdateRequestWithEntityName:v39];

      v41 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(%K == %d or %K == %d) and (%K = 0)", @"kind", 1, @"kind", 2, @"playbackVariation"];
      [v40 setPredicate:v41];

      v55 = @"playbackStyle";
      v56 = &unk_1F0FBBE90;
      v42 = [MEMORY[0x1E695DF20] dictionaryWithObjects:&v56 forKeys:&v55 count:1];
      [v40 setPropertiesToUpdate:v42];

      [v40 setResultType:2];
      v52 = 0;
      v43 = [v7 executeRequest:v40 error:&v52];
      v44 = v52;
      v45 = v43 != 0;
      v46 = PLMigrationGetLog();
      v47 = v46;
      v6 = v51;
      if (v43)
      {
        if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
        {
          v48 = [v43 result];
          *buf = 138412290;
          v54 = v48;
          _os_log_impl(&dword_19BF1F000, v47, OS_LOG_TYPE_DEFAULT, "updating autoloop playback successful with result %@", buf, 0xCu);

          v6 = v51;
        }
      }

      else if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v54 = v44;
        _os_log_impl(&dword_19BF1F000, v47, OS_LOG_TYPE_ERROR, "Batch update request failed, updating autoloop playback, error: %@", buf, 0xCu);
      }

      v5 = v50;
    }

    else
    {
      v45 = 0;
      v5 = v50;
      v6 = v51;
    }
  }

  else
  {
    v45 = 0;
  }

  [v7 reset];

  objc_autoreleasePoolPop(v6);
  objc_autoreleasePoolPop(v5);

  return v45;
}

- (BOOL)_updatePlaybackWithBatchUpdateRequest:(id)a3 targetDescription:(id)a4 inContext:(id)a5
{
  v21 = *MEMORY[0x1E69E9840];
  v7 = a4;
  v8 = a5;
  v9 = a3;
  [v9 setResultType:2];
  v16 = 0;
  v10 = [v8 executeRequest:v9 error:&v16];

  v11 = v16;
  v12 = PLMigrationGetLog();
  v13 = v12;
  if (v10)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v14 = [v10 result];
      *buf = 138412546;
      v18 = v7;
      v19 = 2112;
      v20 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Updating %@ playback successful with result %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412546;
    v18 = v7;
    v19 = 2112;
    v20 = v11;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Batch update request failed, updating %@ playback, error: %@", buf, 0x16u);
  }

  return v10 != 0;
}

- (BOOL)_fixMovieAttributesInStore:(id)a3
{
  v5 = a3;
  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 1;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _fixMovieAttributesInStore:]" concurrencyType:1];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K = %d", @"kind", 1, @"kindSubtype", 0];
  [v10 setPredicate:v11];
  [v10 setFetchBatchSize:100];
  v15[0] = MEMORY[0x1E69E9820];
  v15[1] = 3221225472;
  v15[2] = __46__PLModelMigrator__fixMovieAttributesInStore___block_invoke;
  v15[3] = &unk_1E7576680;
  v12 = v7;
  v16 = v12;
  v13 = v10;
  v17 = v13;
  v18 = &v20;
  v19 = a2;
  [v12 performBlockAndWait:v15];

  objc_autoreleasePoolPop(v6);
  LOBYTE(v6) = *(v21 + 24);
  _Block_object_dispose(&v20, 8);

  return v6;
}

void __46__PLModelMigrator__fixMovieAttributesInStore___block_invoke(uint64_t a1)
{
  v27 = *MEMORY[0x1E69E9840];
  v17 = 0;
  v18 = &v17;
  v19 = 0x2020000000;
  v20 = 0;
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v16 = 0;
  v4 = [v2 executeFetchRequest:v3 error:&v16];
  v5 = v16;
  if (v5)
  {
    *(*(*(a1 + 48) + 8) + 24) = 0;
    v6 = PLMigrationGetLog();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = NSStringFromSelector(*(a1 + 56));
      v8 = [v5 userInfo];
      *buf = 138412802;
      v22 = v7;
      v23 = 2112;
      v24 = v5;
      v25 = 2112;
      v26 = v8;
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "%@ failed to fetch movie assets: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v9 = *(a1 + 32);
    v15[0] = MEMORY[0x1E69E9820];
    v15[1] = 3221225472;
    v15[2] = __46__PLModelMigrator__fixMovieAttributesInStore___block_invoke_2036;
    v15[3] = &unk_1E7568EB0;
    v15[4] = &v17;
    v6 = [v9 enumerateWithIncrementalSaveUsingObjects:v4 withBlock:v15];
    if (v6)
    {
      *(*(*(a1 + 48) + 8) + 24) = 0;
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = NSStringFromSelector(*(a1 + 56));
        v12 = [v6 userInfo];
        *buf = 138412802;
        v22 = v11;
        v23 = 2112;
        v24 = v6;
        v25 = 2112;
        v26 = v12;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v10 = PLMomentsGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        v13 = v18[3];
        v14 = [v4 count];
        *buf = 134218240;
        v22 = v13;
        v23 = 2048;
        v24 = v14;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Update kind sub type for %lu of %lu movie assets.", buf, 0x16u);
      }
    }
  }

  _Block_object_dispose(&v17, 8);
}

void __46__PLModelMigrator__fixMovieAttributesInStore___block_invoke_2036(uint64_t a1, void *a2)
{
  v9 = a2;
  v3 = [v9 avAssetProxyForOriginalAllowReadFromFile:0];
  if (v3)
  {
    v4 = objc_alloc(MEMORY[0x1E69C0718]);
    v5 = [v9 photoLibrary];
    v6 = [v5 libraryBundle];
    v7 = [v6 timeZoneLookup];
    v8 = [v4 initWithAVAsset:v3 timeZoneLookup:v7];

    [v9 updateVideoAttributesFromMetadata:v8 overwriteOriginalProperties:1];
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_setPlaybackStyleForAnimatedGIFsInStore:(id)a3
{
  v5 = a3;
  v22 = 0;
  v23 = &v22;
  v24 = 0x2020000000;
  v25 = 1;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _setPlaybackStyleForAnimatedGIFsInStore:]" concurrencyType:1];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = MEMORY[0x1E696AE18];
  v12 = [*MEMORY[0x1E6982DE8] identifier];
  v13 = [v11 predicateWithFormat:@"kind == %d AND uniformTypeIdentifier == %@ AND playbackStyle != %d", 0, v12, 2];
  [v10 setPredicate:v13];

  [v10 setFetchBatchSize:100];
  v17[0] = MEMORY[0x1E69E9820];
  v17[1] = 3221225472;
  v17[2] = __59__PLModelMigrator__setPlaybackStyleForAnimatedGIFsInStore___block_invoke;
  v17[3] = &unk_1E7576680;
  v14 = v7;
  v18 = v14;
  v15 = v10;
  v19 = v15;
  v20 = &v22;
  v21 = a2;
  [v14 performBlockAndWait:v17];

  objc_autoreleasePoolPop(v6);
  LOBYTE(v6) = *(v23 + 24);
  _Block_object_dispose(&v22, 8);

  return v6;
}

void __59__PLModelMigrator__setPlaybackStyleForAnimatedGIFsInStore___block_invoke(uint64_t a1)
{
  v27 = *MEMORY[0x1E69E9840];
  v17 = 0;
  v18 = &v17;
  v19 = 0x2020000000;
  v20 = 0;
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v16 = 0;
  v4 = [v2 executeFetchRequest:v3 error:&v16];
  v5 = v16;
  if (v5)
  {
    *(*(*(a1 + 48) + 8) + 24) = 0;
    v6 = PLMigrationGetLog();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = NSStringFromSelector(*(a1 + 56));
      v8 = [v5 userInfo];
      *buf = 138412802;
      v22 = v7;
      v23 = 2112;
      v24 = v5;
      v25 = 2112;
      v26 = v8;
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "%@ failed to fetch GIF assets: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v9 = *(a1 + 32);
    v15[0] = MEMORY[0x1E69E9820];
    v15[1] = 3221225472;
    v15[2] = __59__PLModelMigrator__setPlaybackStyleForAnimatedGIFsInStore___block_invoke_2035;
    v15[3] = &unk_1E7568EB0;
    v15[4] = &v17;
    v6 = [v9 enumerateWithIncrementalSaveUsingObjects:v4 withBlock:v15];
    if (v6)
    {
      *(*(*(a1 + 48) + 8) + 24) = 0;
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = NSStringFromSelector(*(a1 + 56));
        v12 = [v6 userInfo];
        *buf = 138412802;
        v22 = v11;
        v23 = 2112;
        v24 = v6;
        v25 = 2112;
        v26 = v12;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v10 = PLMomentsGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        v13 = v18[3];
        v14 = [v4 count];
        *buf = 134218240;
        v22 = v13;
        v23 = 2048;
        v24 = v14;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Set playback style for %lu of %lu GIFs.", buf, 0x16u);
      }
    }
  }

  _Block_object_dispose(&v17, 8);
}

void __59__PLModelMigrator__setPlaybackStyleForAnimatedGIFsInStore___block_invoke_2035(uint64_t a1, void *a2)
{
  v3 = a2;
  v5 = [v3 metadataFromMediaPropertiesOrOriginalResource];
  [v3 updatePlaybackVariationAndStyleFromOriginalMetadata:?];
  v4 = [v3 playbackStyle];

  if (v4 == 2)
  {
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_removeAutoloopWorkerStatesInStore:(id)a3
{
  v21 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removeAutoloopWorkerStatesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLAssetAnalysisState entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"workerType = %d", 5];
  [v9 setPredicate:v10];

  v11 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
  [v11 setResultType:2];
  v18 = 0;
  v12 = [v6 executeRequest:v11 error:&v18];
  v13 = v18;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v12)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = [v12 result];
      *buf = 138412290;
      v20 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "_removeAutoloopWorkerStatesInStore deleted %@ autoloop analysis states.", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v20 = v13;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_removeAutoloopWorkerStatesInStore failed: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v12 != 0;
}

- (BOOL)_fixInitialSyncMarker
{
  v17 = *MEMORY[0x1E69E9840];
  v2 = [(PLModelMigrator *)self pathManager];
  v3 = CPLStatusFromPathManager(v2);
  v4 = [v3 initialSyncDate];

  if (v4)
  {
    v14 = 0;
    v5 = [v3 writeInitialSyncMarker:&v14];
    v6 = v14;
    v7 = PLMigrationGetLog();
    v8 = v7;
    if (v5)
    {
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        v9 = "Rewriting initial sync marker";
        v10 = v8;
        v11 = OS_LOG_TYPE_DEFAULT;
        v12 = 2;
LABEL_7:
        _os_log_impl(&dword_19BF1F000, v10, v11, v9, buf, v12);
      }
    }

    else if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v16 = v6;
      v9 = "Fail to write initial sync marker, error: %@";
      v10 = v8;
      v11 = OS_LOG_TYPE_ERROR;
      v12 = 12;
      goto LABEL_7;
    }
  }

  return 1;
}

- (BOOL)_removingDuplicatedCloudAssetGuid:(id)a3
{
  v28[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v24 = 0;
  v25 = &v24;
  v26 = 0x2020000000;
  v27 = 1;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removingDuplicatedCloudAssetGuid:]" concurrencyType:1];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setPropertiesToGroupBy:&unk_1F0FBF928];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"count(SELF) > 1"];
  [v9 setHavingPredicate:v10];

  [v9 setResultType:2];
  [v9 setPropertiesToFetch:&unk_1F0FBF940];
  v11 = MEMORY[0x1E696AB28];
  v12 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  v28[0] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudAssetGUID != nil && complete == 1"];
  v28[1] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v28 count:2];
  v15 = [v11 andPredicateWithSubpredicates:v14];

  [v9 setPredicate:v15];
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __53__PLModelMigrator__removingDuplicatedCloudAssetGuid___block_invoke;
  v19[3] = &unk_1E75778C0;
  v16 = v6;
  v20 = v16;
  v17 = v9;
  v21 = v17;
  v22 = self;
  v23 = &v24;
  [v16 performBlockAndWait:v19];

  objc_autoreleasePoolPop(v5);
  LOBYTE(v5) = *(v25 + 24);
  _Block_object_dispose(&v24, 8);

  return v5 & 1;
}

void __53__PLModelMigrator__removingDuplicatedCloudAssetGuid___block_invoke(void *a1)
{
  v27 = *MEMORY[0x1E69E9840];
  v21 = 0;
  v22 = &v21;
  v23 = 0x2020000000;
  v24 = 0;
  v2 = a1[4];
  v3 = a1[5];
  v20 = 0;
  v4 = [v2 executeFetchRequest:v3 error:&v20];
  v5 = v20;
  if (v4)
  {
    v6 = a1[4];
    v16[0] = MEMORY[0x1E69E9820];
    v16[1] = 3221225472;
    v16[2] = __53__PLModelMigrator__removingDuplicatedCloudAssetGuid___block_invoke_2021;
    v16[3] = &unk_1E7569200;
    v7 = v6;
    v8 = a1[6];
    v17 = v7;
    v18 = v8;
    v19 = &v21;
    v9 = [v7 enumerateWithIncrementalSaveUsingObjects:v4 withBlock:v16];

    *(*(a1[7] + 8) + 24) = v9 == 0;
    if (*(*(a1[7] + 8) + 24) == 1)
    {
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        v11 = v22[3];
        *buf = 134217984;
        v26 = v11;
        v12 = "Removed %lu duplicated assets";
        v13 = v10;
        v14 = OS_LOG_TYPE_DEFAULT;
LABEL_9:
        _os_log_impl(&dword_19BF1F000, v13, v14, v12, buf, 0xCu);
      }
    }

    else
    {
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v26 = v9;
        v12 = "RemoveDuplicateMigration: Error fetching, error:%@";
        v13 = v10;
        v14 = OS_LOG_TYPE_ERROR;
        goto LABEL_9;
      }
    }

    v15 = v17;
    v5 = v9;
    goto LABEL_11;
  }

  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v26 = v5;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "RemoveDuplicateMigration: Error executing fetch request, error:%@", buf, 0xCu);
  }

LABEL_11:

  _Block_object_dispose(&v21, 8);
}

void __53__PLModelMigrator__removingDuplicatedCloudAssetGuid___block_invoke_2021(uint64_t a1, void *a2)
{
  v73[1] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 objectForKey:@"cloudAssetGUID"];
  v5 = MEMORY[0x1E695D5E0];
  v6 = +[PLManagedAsset entityName];
  v7 = [v5 fetchRequestWithEntityName:v6];

  v73[0] = @"master.resources";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v73 count:1];
  [v7 setRelationshipKeyPathsForPrefetching:v8];

  [v7 setFetchBatchSize:100];
  v9 = MEMORY[0x1E696AB28];
  v10 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  v72[0] = v10;
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudAssetGUID == %@ && cloudAssetGUID != nil && complete == 1", v4];
  v72[1] = v11;
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v72 count:2];
  v13 = [v9 andPredicateWithSubpredicates:v12];

  [v7 setPredicate:v13];
  v56 = a1;
  v14 = *(a1 + 32);
  v65 = 0;
  v15 = [v14 executeFetchRequest:v7 error:&v65];
  v16 = v65;
  if (!v15)
  {
    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v68 = v16;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "RemoveDuplicateMigration: Error fetching, error:%@", buf, 0xCu);
    }

    goto LABEL_41;
  }

  if ([v15 count] >= 2)
  {
    v49 = v16;
    v50 = v13;
    v51 = v7;
    v52 = v4;
    v53 = v3;
    v17 = [MEMORY[0x1E695DF70] array];
    v55 = [MEMORY[0x1E696AC08] defaultManager];
    v61 = 0u;
    v62 = 0u;
    v63 = 0u;
    v64 = 0u;
    v48 = v15;
    v18 = v15;
    v19 = [v18 countByEnumeratingWithState:&v61 objects:v71 count:16];
    if (!v19)
    {

      goto LABEL_28;
    }

    v20 = v19;
    v21 = 0;
    v22 = *v62;
    v54 = v18;
    while (1)
    {
      for (i = 0; i != v20; ++i)
      {
        if (*v62 != v22)
        {
          objc_enumerationMutation(v18);
        }

        v24 = *(*(&v61 + 1) + 8 * i);
        if (v21)
        {
          goto LABEL_20;
        }

        if ([*(v56 + 40) isCloudPhotoLibraryEnabled])
        {
          v25 = v17;
          v26 = [v24 master];
          v27 = [v24 uuid];
          v28 = [PLCloudResource cloudResourceForResourceType:1 forAssetUuid:v27 forCloudMaster:v26];
          v29 = [v28 filePath];
          v30 = [v29 lastPathComponent];

          v31 = [v24 filename];
          LOBYTE(v29) = [v30 isEqualToString:v31];

          if ((v29 & 1) == 0)
          {

            v17 = v25;
            v21 = 0;
            v18 = v54;
LABEL_19:

LABEL_20:
            [v17 addObject:v24];
            continue;
          }

          v32 = v24;
          v33 = PLMigrationGetLog();
          v17 = v25;
          v21 = v32;
          if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
          {
            v34 = [v32 uuid];
            *buf = 138412546;
            v68 = v34;
            v69 = 2112;
            v70 = v30;
            _os_log_impl(&dword_19BF1F000, v33, OS_LOG_TYPE_DEFAULT, "RemoveDuplicateMigration: Found a match, keeping asset %@ (%@)", buf, 0x16u);
          }

          v18 = v54;
        }

        else
        {
          v26 = [v24 pathForOriginalFile];
          if (![v55 fileExistsAtPath:v26])
          {
            goto LABEL_19;
          }

          v21 = v24;
          v35 = PLMigrationGetLog();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
          {
            v36 = [v21 uuid];
            *buf = 138412546;
            v68 = v36;
            v69 = 2112;
            v70 = v26;
            _os_log_impl(&dword_19BF1F000, v35, OS_LOG_TYPE_DEFAULT, "RemoveDuplicateMigration: Found a match, keeping asset %@ (%@)", buf, 0x16u);
          }
        }
      }

      v20 = [v18 countByEnumeratingWithState:&v61 objects:v71 count:16];
      if (!v20)
      {

        if (!v21)
        {
LABEL_28:
          v37 = PLMigrationGetLog();
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            v38 = [v17 firstObject];
            v39 = [v38 uuid];
            *buf = 138412290;
            v68 = v39;
            _os_log_impl(&dword_19BF1F000, v37, OS_LOG_TYPE_DEFAULT, "RemoveDuplicateMigration: Keeping asset %@", buf, 0xCu);
          }

          [v17 removeObjectAtIndex:0];
          v21 = 0;
        }

        v59 = 0u;
        v60 = 0u;
        v57 = 0u;
        v58 = 0u;
        v40 = v17;
        v41 = [v40 countByEnumeratingWithState:&v57 objects:v66 count:16];
        if (v41)
        {
          v42 = v41;
          v43 = *v58;
          do
          {
            for (j = 0; j != v42; ++j)
            {
              if (*v58 != v43)
              {
                objc_enumerationMutation(v40);
              }

              v45 = *(*(&v57 + 1) + 8 * j);
              v46 = PLMigrationGetLog();
              if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
              {
                v47 = [v45 uuid];
                *buf = 138412290;
                v68 = v47;
                _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_DEFAULT, "RemoveDuplicateMigration: Will delete asset %@", buf, 0xCu);
              }

              [v45 deleteFromDatabaseOnly];
              ++*(*(*(v56 + 48) + 8) + 24);
            }

            v42 = [v40 countByEnumeratingWithState:&v57 objects:v66 count:16];
          }

          while (v42);
        }

        v4 = v52;
        v3 = v53;
        v13 = v50;
        v7 = v51;
        v15 = v48;
        v16 = v49;
LABEL_41:

        break;
      }
    }
  }
}

- (BOOL)_convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore:(id)a3
{
  v43 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v35 = 0;
  v36 = &v35;
  v37 = 0x2020000000;
  v38 = 1;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore:]" concurrencyType:1];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLDeferredRebuildFace entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  [v10 setFetchBatchSize:100];
  v29 = 0;
  v30 = &v29;
  v31 = 0x3032000000;
  v32 = __Block_byref_object_copy__21558;
  v33 = __Block_byref_object_dispose__21559;
  v34 = 0;
  v25 = 0;
  v26 = &v25;
  v27 = 0x2020000000;
  v28 = 0;
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __80__PLModelMigrator__convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore___block_invoke;
  v19[3] = &unk_1E756F910;
  v11 = v7;
  v20 = v11;
  v12 = v10;
  v21 = v12;
  v22 = &v29;
  v23 = &v35;
  v24 = &v25;
  [v11 performBlockAndWait:v19];
  if (v36[3])
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v14 = v26[3];
      *buf = 134217984;
      v40 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Fixed %lu deferred rebuild faces", buf, 0xCu);
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v15 = NSStringFromSelector(a2);
      v16 = v30[5];
      *buf = 138412546;
      v40 = v15;
      v41 = 2112;
      v42 = v16;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%@ failed with error: %@", buf, 0x16u);
    }
  }

  _Block_object_dispose(&v25, 8);
  _Block_object_dispose(&v29, 8);

  objc_autoreleasePoolPop(v6);
  v17 = *(v36 + 24);
  _Block_object_dispose(&v35, 8);

  return v17 & 1;
}

void __80__PLModelMigrator__convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore___block_invoke(uint64_t a1)
{
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v4 = *(*(a1 + 48) + 8);
  obj = *(v4 + 40);
  v5 = [v2 executeFetchRequest:v3 error:&obj];
  objc_storeStrong((v4 + 40), obj);
  *(*(*(a1 + 56) + 8) + 24) = v5 != 0;
  if (*(*(*(a1 + 56) + 8) + 24) == 1)
  {
    *(*(*(a1 + 64) + 8) + 24) = [v5 count];
    v6 = [*(a1 + 32) enumerateWithIncrementalSaveUsingObjects:v5 withBlock:&__block_literal_global_2005];
    v7 = *(*(a1 + 48) + 8);
    v8 = *(v7 + 40);
    *(v7 + 40) = v6;

    *(*(*(a1 + 56) + 8) + 24) = *(*(*(a1 + 48) + 8) + 40) == 0;
    if (*(*(*(a1 + 56) + 8) + 24))
    {
      if ([*(a1 + 32) hasChanges])
      {
        v9 = *(a1 + 32);
        v10 = *(*(a1 + 48) + 8);
        v12 = *(v10 + 40);
        v11 = [v9 save:&v12];
        objc_storeStrong((v10 + 40), v12);
        *(*(*(a1 + 56) + 8) + 24) = v11;
      }
    }
  }
}

void __80__PLModelMigrator__convertNameSourceFromBoolToIntForDeferredRebuildFaceInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 setNameSource:{objc_msgSend(v2, "nameSource") == 0}];
}

- (BOOL)_populateUserKeyFacePickSourceForPersonInStore:(id)a3
{
  v44 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v36 = 0;
  v37 = &v36;
  v38 = 0x2020000000;
  v39 = 1;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _populateUserKeyFacePickSourceForPersonInStore:]" concurrencyType:1];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLPerson entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"keyFace.nameSource == %d AND verifiedType == %d", 1, 1];
  [v10 setPredicate:v11];

  [v10 setFetchBatchSize:100];
  v30 = 0;
  v31 = &v30;
  v32 = 0x3032000000;
  v33 = __Block_byref_object_copy__21558;
  v34 = __Block_byref_object_dispose__21559;
  v35 = 0;
  v26 = 0;
  v27 = &v26;
  v28 = 0x2020000000;
  v29 = 0;
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = __66__PLModelMigrator__populateUserKeyFacePickSourceForPersonInStore___block_invoke;
  v20[3] = &unk_1E756F910;
  v12 = v7;
  v21 = v12;
  v13 = v10;
  v22 = v13;
  v23 = &v30;
  v24 = &v36;
  v25 = &v26;
  [v12 performBlockAndWait:v20];
  if (v37[3])
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = v27[3];
      *buf = 134217984;
      v41 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Populated user keyFacePickSource on %lu assets", buf, 0xCu);
    }
  }

  else
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v16 = NSStringFromSelector(a2);
      v17 = v31[5];
      *buf = 138412546;
      v41 = v16;
      v42 = 2112;
      v43 = v17;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "%@ failed with error: %@", buf, 0x16u);
    }
  }

  _Block_object_dispose(&v26, 8);
  _Block_object_dispose(&v30, 8);

  objc_autoreleasePoolPop(v6);
  v18 = *(v37 + 24);
  _Block_object_dispose(&v36, 8);

  return v18 & 1;
}

void __66__PLModelMigrator__populateUserKeyFacePickSourceForPersonInStore___block_invoke(uint64_t a1)
{
  v2 = *(a1 + 32);
  v3 = *(a1 + 40);
  v4 = *(*(a1 + 48) + 8);
  obj = *(v4 + 40);
  v5 = [v2 executeFetchRequest:v3 error:&obj];
  objc_storeStrong((v4 + 40), obj);
  *(*(*(a1 + 56) + 8) + 24) = v5 != 0;
  if (*(*(*(a1 + 56) + 8) + 24) == 1)
  {
    *(*(*(a1 + 64) + 8) + 24) = [v5 count];
    v6 = [*(a1 + 32) enumerateWithIncrementalSaveUsingObjects:v5 withBlock:&__block_literal_global_2001];
    v7 = *(*(a1 + 48) + 8);
    v8 = *(v7 + 40);
    *(v7 + 40) = v6;

    *(*(*(a1 + 56) + 8) + 24) = *(*(*(a1 + 48) + 8) + 40) == 0;
    if (*(*(*(a1 + 56) + 8) + 24))
    {
      if ([*(a1 + 32) hasChanges])
      {
        v9 = *(a1 + 32);
        v10 = *(*(a1 + 48) + 8);
        v12 = *(v10 + 40);
        v11 = [v9 save:&v12];
        objc_storeStrong((v10 + 40), v12);
        *(*(*(a1 + 56) + 8) + 24) = v11;
      }
    }
  }
}

- (BOOL)_populateAdjustmentTimestampsOnAssets:(id)a3
{
  v25[1] = *MEMORY[0x1E69E9840];
  v5 = a3;
  v21 = 0;
  v22 = &v21;
  v23 = 0x2020000000;
  v24 = 1;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _populateAdjustmentTimestampsOnAssets:]" concurrencyType:1];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.unmanagedAdjustment.adjustmentTimestamp != nil"];
  [v10 setPredicate:v11];

  v25[0] = @"additionalAttributes.unmanagedAdjustment.adjustmentTimestamp";
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v25 count:1];
  [v10 setRelationshipKeyPathsForPrefetching:v12];

  v16[0] = MEMORY[0x1E69E9820];
  v16[1] = 3221225472;
  v16[2] = __57__PLModelMigrator__populateAdjustmentTimestampsOnAssets___block_invoke;
  v16[3] = &unk_1E7576680;
  v13 = v7;
  v17 = v13;
  v14 = v10;
  v18 = v14;
  v19 = &v21;
  v20 = a2;
  [v13 performBlockAndWait:v16];

  objc_autoreleasePoolPop(v6);
  LOBYTE(v6) = *(v22 + 24);
  _Block_object_dispose(&v21, 8);

  return v6 & 1;
}

void __57__PLModelMigrator__populateAdjustmentTimestampsOnAssets___block_invoke(uint64_t a1)
{
  v18 = *MEMORY[0x1E69E9840];
  v11 = 0;
  v2 = [*(a1 + 32) enumerateObjectsFromFetchRequest:*(a1 + 40) count:&v11 usingDefaultBatchSizeWithBlock:&__block_literal_global_1996];
  if ([*(a1 + 32) hasChanges])
  {
    v3 = *(a1 + 32);
    v10 = 0;
    v4 = [v3 save:&v10];
    v5 = v10;
    *(*(*(a1 + 48) + 8) + 24) = v4;
    if ((*(*(*(a1 + 48) + 8) + 24) & 1) == 0)
    {
      v6 = PLMigrationGetLog();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
      {
        v7 = NSStringFromSelector(*(a1 + 56));
        v8 = [v5 userInfo];
        *buf = 138412802;
        v13 = v7;
        v14 = 2112;
        v15 = v5;
        v16 = 2112;
        v17 = v8;
        _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }
  }

  if (*(*(*(a1 + 48) + 8) + 24) == 1)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v13 = v11;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Populated adjustmentTimestamps on %lu assets", buf, 0xCu);
    }
  }
}

void __57__PLModelMigrator__populateAdjustmentTimestampsOnAssets___block_invoke_2(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 additionalAttributes];
  v4 = [v3 unmanagedAdjustment];
  v5 = [v4 adjustmentTimestamp];

  [v2 setAdjustmentTimestamp:v5];
}

- (BOOL)_migrateCloudResourcesRelationshipsInStagedStore:(id)a3
{
  v27[1] = *MEMORY[0x1E69E9840];
  v5 = a3;
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _migrateCloudResourcesRelationshipsInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AdditionalAssetAttributes"];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudMaster != nil OR cloudResources.@count > 0"];
  [v8 setPredicate:v9];

  v27[0] = @"asset";
  v10 = [MEMORY[0x1E695DEC8] arrayWithObjects:v27 count:1];
  [v8 setRelationshipKeyPathsForPrefetching:v10];

  v19 = 0;
  v20 = &v19;
  v21 = 0x2020000000;
  v22 = 0;
  v11 = [v7 executeFetchRequest:v8 error:0];
  v18[0] = MEMORY[0x1E69E9820];
  v18[1] = 3221225472;
  v18[2] = __68__PLModelMigrator__migrateCloudResourcesRelationshipsInStagedStore___block_invoke;
  v18[3] = &unk_1E75691B8;
  v18[4] = &v19;
  v12 = [v7 enumerateWithIncrementalSaveUsingObjects:v11 shouldRefreshAfterSave:1 withBlock:v18];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = NSStringFromSelector(a2);
      *buf = 138412546;
      v24 = v14;
      v25 = 2112;
      v26 = v12;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "%@ failed to migrate cloudResources fields: %@", buf, 0x16u);
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v15 = NSStringFromSelector(a2);
      v16 = v20[3];
      *buf = 138412546;
      v24 = v15;
      v25 = 1024;
      LODWORD(v26) = v16;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "%@ migrated cloudResources fields on %d assets", buf, 0x12u);
    }
  }

  _Block_object_dispose(&v19, 8);
  objc_autoreleasePoolPop(v6);

  return v12 == 0;
}

void __68__PLModelMigrator__migrateCloudResourcesRelationshipsInStagedStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v6 = [v3 valueForKey:@"cloudMaster"];
  v4 = [v3 valueForKey:@"cloudResources"];
  v5 = [v3 valueForKey:@"asset"];

  [v5 setValue:v6 forKey:@"master"];
  [v5 setValue:v4 forKey:@"resources"];
  ++*(*(*(a1 + 32) + 8) + 24);
}

- (BOOL)_revalidateImportSessionDates:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"ImportSession"];
  [v5 setFetchBatchSize:100];
  v16 = 0;
  v17 = &v16;
  v18 = 0x2020000000;
  v19 = 0;
  v6 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _revalidateImportSessionDates:]"];
  v15[0] = MEMORY[0x1E69E9820];
  v15[1] = 3221225472;
  v15[2] = __49__PLModelMigrator__revalidateImportSessionDates___block_invoke;
  v15[3] = &unk_1E7569190;
  v15[4] = &v16;
  v7 = [(PLModelMigrator *)self _runMigrationStepWithName:v6 fetchRequest:v5 store:v4 migrationHandler:v15];

  if (v7)
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = v17[3];
      *buf = 134217984;
      v21 = v9;
      v10 = "Revalidate %lu import session albums.";
      v11 = v8;
      v12 = OS_LOG_TYPE_DEFAULT;
      v13 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v11, v12, v10, buf, v13);
    }
  }

  else
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      v10 = "_revalidateImportSessionDates failed.";
      v11 = v8;
      v12 = OS_LOG_TYPE_ERROR;
      v13 = 2;
      goto LABEL_6;
    }
  }

  _Block_object_dispose(&v16, 8);
  return v7;
}

uint64_t __49__PLModelMigrator__revalidateImportSessionDates___block_invoke(uint64_t a1, void *a2)
{
  [a2 revalidateImportDates];
  ++*(*(*(a1 + 32) + 8) + 24);
  return 1;
}

- (BOOL)_setImportedByInPLCloudMaster:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  [v5 setFetchBatchSize:100];
  v16 = 0;
  v17 = &v16;
  v18 = 0x2020000000;
  v19 = 0;
  v6 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%s", "-[PLModelMigrator _setImportedByInPLCloudMaster:]"];
  v15[0] = MEMORY[0x1E69E9820];
  v15[1] = 3221225472;
  v15[2] = __49__PLModelMigrator__setImportedByInPLCloudMaster___block_invoke;
  v15[3] = &unk_1E7569190;
  v15[4] = &v16;
  v7 = [(PLModelMigrator *)self _runMigrationStepWithName:v6 fetchRequest:v5 store:v4 migrationHandler:v15];

  if (v7)
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = v17[3];
      *buf = 134217984;
      v21 = v9;
      v10 = "setImportedBy for %lu masters";
      v11 = v8;
      v12 = OS_LOG_TYPE_DEFAULT;
      v13 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v11, v12, v10, buf, v13);
    }
  }

  else
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      v10 = "_setImportedByInPLCloudMaster failed.";
      v11 = v8;
      v12 = OS_LOG_TYPE_ERROR;
      v13 = 2;
      goto LABEL_6;
    }
  }

  _Block_object_dispose(&v16, 8);
  return v7;
}

uint64_t __49__PLModelMigrator__setImportedByInPLCloudMaster___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [v3 assets];
  v5 = [v4 allObjects];

  if ([v5 count])
  {
    v6 = [v5 firstObject];
    v7 = [v6 additionalAttributes];
    [v3 setImportedBy:{objc_msgSend(v7, "importedBy")}];

    ++*(*(*(a1 + 32) + 8) + 24);
  }

  return 1;
}

- (BOOL)_persistImportSessionAlbumType:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _persistImportSessionAlbumType:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"ImportSession"];
  [v7 setFetchBatchSize:100];
  v13 = 0;
  v14 = &v13;
  v15 = 0x2020000000;
  v16 = 0;
  v12[0] = MEMORY[0x1E69E9820];
  v12[1] = 3221225472;
  v12[2] = __50__PLModelMigrator__persistImportSessionAlbumType___block_invoke;
  v12[3] = &unk_1E7569140;
  v12[4] = self;
  v12[5] = &v13;
  v8 = [v6 enumerateObjectsFromFetchRequest:v7 count:0 usingDefaultBatchSizeWithBlock:v12];
  v9 = PLMigrationGetLog();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    v10 = v14[3];
    *buf = 134217984;
    v18 = v10;
    _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Persisted %lu import session albums.", buf, 0xCu);
  }

  _Block_object_dispose(&v13, 8);
  objc_autoreleasePoolPop(v5);

  return 1;
}

uint64_t __50__PLModelMigrator__persistImportSessionAlbumType___block_invoke(uint64_t a1, uint64_t a2)
{
  result = [*(a1 + 32) _persistMetadataToFileSystemForAlbum:a2];
  if (result)
  {
    ++*(*(*(a1 + 40) + 8) + 24);
  }

  return result;
}

- (BOOL)_createImportSessionAlbums:(id)a3
{
  v40[1] = *MEMORY[0x1E69E9840];
  v5 = a3;
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _createImportSessionAlbums:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.importSessionID != NULL"];
  [v10 setPredicate:v11];

  v40[0] = @"additionalAttributes";
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v40 count:1];
  [v10 setRelationshipKeyPathsForPrefetching:v12];

  v13 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"additionalAttributes.importSessionID" ascending:1];
  v39 = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v39 count:1];
  [v10 setSortDescriptors:v14];

  [v10 setFetchBatchSize:100];
  v15 = [v7 executeFetchRequest:v10 error:0];
  v29 = 0;
  v30 = &v29;
  v31 = 0x2020000000;
  v32 = 0;
  v27[0] = 0;
  v27[1] = v27;
  v27[2] = 0x3032000000;
  v27[3] = __Block_byref_object_copy__21558;
  v27[4] = __Block_byref_object_dispose__21559;
  v28 = 0;
  v23[0] = MEMORY[0x1E69E9820];
  v23[1] = 3221225472;
  v23[2] = __46__PLModelMigrator__createImportSessionAlbums___block_invoke;
  v23[3] = &unk_1E7569428;
  v25 = v27;
  v16 = v7;
  v24 = v16;
  v26 = &v29;
  v17 = [v16 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:v23];
  if (v17)
  {
    v18 = PLMigrationGetLog();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v19 = NSStringFromSelector(a2);
      v20 = [v17 userInfo];
      *buf = 138543874;
      v34 = v19;
      v35 = 2112;
      v36 = v17;
      v37 = 2112;
      v38 = v20;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v18 = PLMigrationGetLog();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v21 = v30[3];
      *buf = 134217984;
      v34 = v21;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Added %lu assets to importSessionAlbums", buf, 0xCu);
    }
  }

  [v16 reset];
  _Block_object_dispose(v27, 8);

  _Block_object_dispose(&v29, 8);
  objc_autoreleasePoolPop(v6);

  return v17 == 0;
}

void __46__PLModelMigrator__createImportSessionAlbums___block_invoke(void *a1, void *a2)
{
  v12 = a2;
  v3 = [v12 additionalAttributes];
  v4 = v3;
  if (v3)
  {
    v5 = [v3 valueForKey:@"importSessionID"];
    v6 = [v12 importSession];
    v7 = v6;
    if (v6)
    {
      v8 = [v6 importSessionID];
      v9 = [v8 isEqualToString:v5];

      if (v9)
      {
        goto LABEL_12;
      }
    }

    v10 = [*(*(a1[5] + 8) + 40) importSessionID];
    if ([v10 isEqualToString:v5])
    {
      v11 = *(*(a1[5] + 8) + 40);

      if (v11)
      {
LABEL_11:
        [v12 setImportSession:v11];
        [v11 updateImportDatesFromAddedAsset:v12];

LABEL_12:
        [v4 setValue:0 forKey:@"importSessionID"];
        ++*(*(a1[6] + 8) + 24);

        goto LABEL_13;
      }
    }

    else
    {
    }

    v11 = [PLImportSession albumWithImportSessionID:v5 inManagedObjectContext:a1[4]];
    if (!v11)
    {
      v11 = [PLImportSession insertNewImportSessionAlbumWithImportSessionID:v5 inManagedObjectContext:a1[4]];
    }

    objc_storeStrong((*(a1[5] + 8) + 40), v11);
    goto LABEL_11;
  }

LABEL_13:
}

- (BOOL)_removeInvalidImportSessionAlbums:(id)a3
{
  v4[0] = MEMORY[0x1E69E9820];
  v4[1] = 3221225472;
  v4[2] = __53__PLModelMigrator__removeInvalidImportSessionAlbums___block_invoke;
  v4[3] = &unk_1E7569168;
  v4[4] = self;
  v4[5] = a2;
  return [(PLModelMigrator *)self _runMigrationStepWithPrettyFunction:"[PLModelMigrator _removeInvalidImportSessionAlbums:]" store:a3 migrationHandler:v4];
}

BOOL __53__PLModelMigrator__removeInvalidImportSessionAlbums___block_invoke(uint64_t a1, void *a2)
{
  v24 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"ImportSession"];
  v5 = [MEMORY[0x1E696AE18] predicateWithFormat:@"importSessionID == NULL"];
  [v4 setPredicate:v5];

  v6 = [v3 executeFetchRequest:v4 error:0];
  v14 = 0;
  v15 = &v14;
  v16 = 0x2020000000;
  v17 = 0;
  v13[0] = MEMORY[0x1E69E9820];
  v13[1] = 3221225472;
  v13[2] = __53__PLModelMigrator__removeInvalidImportSessionAlbums___block_invoke_2;
  v13[3] = &unk_1E7569140;
  v13[4] = *(a1 + 32);
  v13[5] = &v14;
  v7 = [v3 enumerateWithIncrementalSaveUsingObjects:v6 withBlock:v13];
  if (v7)
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = NSStringFromSelector(*(a1 + 40));
      v10 = [v7 userInfo];
      *buf = 138543874;
      v19 = v9;
      v20 = 2112;
      v21 = v7;
      v22 = 2112;
      v23 = v10;
      _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v11 = v15[3];
      *buf = 134217984;
      v19 = v11;
      _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "removed %lu invalid importSession ", buf, 0xCu);
    }
  }

  _Block_object_dispose(&v14, 8);
  return v7 == 0;
}

void __53__PLModelMigrator__removeInvalidImportSessionAlbums___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = *(a1 + 32);
  v4 = a2;
  v5 = [v3 pathManager];
  [v4 removePersistedFileSystemDataWithPathManager:v5];

  [v4 delete];
  ++*(*(*(a1 + 40) + 8) + 24);
}

- (BOOL)_migrateDetectedFacesGroupInStagedStore:(id)a3
{
  v42 = *MEMORY[0x1E69E9840];
  v5 = a3;
  context = objc_autoreleasePoolPush();
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _migrateDetectedFacesGroupInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLDetectedFace entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"faceGroups.@count > 0"];
  [v10 setPredicate:v11];

  v33 = 0;
  v34 = &v33;
  v35 = 0x2020000000;
  v36 = 0;
  v29 = 0;
  v30 = &v29;
  v31 = 0x2020000000;
  v32 = 0;
  v12 = [v7 executeFetchRequest:v10 error:0];
  v22 = MEMORY[0x1E69E9820];
  v23 = 3221225472;
  v24 = __59__PLModelMigrator__migrateDetectedFacesGroupInStagedStore___block_invoke;
  v25 = &unk_1E75690F0;
  v27 = &v33;
  v13 = v7;
  v26 = v13;
  v28 = &v29;
  v14 = [v13 enumerateWithIncrementalSaveUsingObjects:v12 shouldRefreshAfterSave:1 withBlock:&v22];
  if (v14)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = [v14 userInfo];
      *buf = 136315650;
      v38 = "[PLModelMigrator _migrateDetectedFacesGroupInStagedStore:]";
      v39 = 2112;
      *v40 = v14;
      *&v40[8] = 2112;
      v41 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "%s: failed to migrate detected faces group: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = NSStringFromSelector(a2);
      v18 = v34[3];
      v19 = v30[3];
      *buf = 138412802;
      v38 = v17;
      v39 = 1024;
      *v40 = v18;
      *&v40[4] = 1024;
      *&v40[6] = v19;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "%@ migrated %d persons with detectedFacesGroups, deleted %d rejectedFacesGroup", buf, 0x18u);
    }
  }

  [v13 reset];
  _Block_object_dispose(&v29, 8);
  _Block_object_dispose(&v33, 8);

  objc_autoreleasePoolPop(v6);
  objc_autoreleasePoolPop(context);

  return v14 == 0;
}

void __59__PLModelMigrator__migrateDetectedFacesGroupInStagedStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [v3 valueForKey:@"faceGroups"];
  v8[0] = MEMORY[0x1E69E9820];
  v8[1] = 3221225472;
  v8[2] = __59__PLModelMigrator__migrateDetectedFacesGroupInStagedStore___block_invoke_2;
  v8[3] = &unk_1E7569118;
  v9 = v3;
  v7 = *(a1 + 32);
  v5 = v7;
  v10 = v7;
  v11 = *(a1 + 48);
  v6 = v3;
  [v4 enumerateObjectsUsingBlock:v8];
}

void __59__PLModelMigrator__migrateDetectedFacesGroupInStagedStore___block_invoke_2(uint64_t a1, void *a2)
{
  *&v16[13] = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 valueForKey:@"faceGroupType"];
  v5 = [v4 intValue];

  if (v5 == 5)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = *(a1 + 32);
      v13 = 138412546;
      v14 = v3;
      v15 = 2112;
      *v16 = v10;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Found rejected faceGroup %@ in detectedFace %@", &v13, 0x16u);
    }

    [*(a1 + 40) deleteObject:v3];
    v11 = *(a1 + 56);
    goto LABEL_14;
  }

  if (v5 == 1)
  {
    v6 = [*(a1 + 32) valueForKey:@"faceGroup"];

    if (v6)
    {
      v7 = PLMigrationGetLog();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
      {
        v8 = *(a1 + 32);
        v13 = 138412546;
        v14 = v3;
        v15 = 2112;
        *v16 = v8;
        _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "Found more than 1 faceGroup %@ for detectedFace %@ during staged migration", &v13, 0x16u);
      }

      goto LABEL_15;
    }

    [*(a1 + 32) setValue:v3 forKey:@"faceGroup"];
    v11 = *(a1 + 48);
LABEL_14:
    ++*(*(v11 + 8) + 24);
    goto LABEL_15;
  }

  v12 = PLMigrationGetLog();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
  {
    v13 = 136315650;
    v14 = "[PLModelMigrator _migrateDetectedFacesGroupInStagedStore:]_block_invoke";
    v15 = 1024;
    *v16 = v5;
    v16[2] = 2112;
    *&v16[3] = v3;
    _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%s: Unknown faceGroupType %d for faceGroup %@", &v13, 0x1Cu);
  }

LABEL_15:
}

- (BOOL)_migrateRejectedFacesGroupInStagedStore:(id)a3
{
  v42 = *MEMORY[0x1E69E9840];
  v5 = a3;
  context = objc_autoreleasePoolPush();
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _migrateRejectedFacesGroupInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLPerson entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  [v10 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF910];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"rejectedFacesGroup != nil"];
  [v10 setPredicate:v11];

  v33 = 0;
  v34 = &v33;
  v35 = 0x2020000000;
  v36 = 0;
  v29 = 0;
  v30 = &v29;
  v31 = 0x2020000000;
  v32 = 0;
  v12 = [v7 executeFetchRequest:v10 error:0];
  v22 = MEMORY[0x1E69E9820];
  v23 = 3221225472;
  v24 = __59__PLModelMigrator__migrateRejectedFacesGroupInStagedStore___block_invoke;
  v25 = &unk_1E75690F0;
  v27 = &v33;
  v13 = v7;
  v26 = v13;
  v28 = &v29;
  v14 = [v13 enumerateWithIncrementalSaveUsingObjects:v12 shouldRefreshAfterSave:1 withBlock:&v22];
  if (v14)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = [v14 userInfo];
      *buf = 136315650;
      v38 = "[PLModelMigrator _migrateRejectedFacesGroupInStagedStore:]";
      v39 = 2112;
      *v40 = v14;
      *&v40[8] = 2112;
      v41 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "%s: failed to migrate rejected faces group: %@ %@", buf, 0x20u);
    }
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = NSStringFromSelector(a2);
      v18 = v34[3];
      v19 = v30[3];
      *buf = 138412802;
      v38 = v17;
      v39 = 1024;
      *v40 = v18;
      *&v40[4] = 1024;
      *&v40[6] = v19;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "%@ migrated %d persons with rejectedFacesGroup, deleted %d rejectedFacesGroup", buf, 0x18u);
    }
  }

  [v13 reset];
  _Block_object_dispose(&v29, 8);
  _Block_object_dispose(&v33, 8);

  objc_autoreleasePoolPop(v6);
  objc_autoreleasePoolPop(context);

  return v14 == 0;
}

void __59__PLModelMigrator__migrateRejectedFacesGroupInStagedStore___block_invoke(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 valueForKey:@"rejectedFacesGroup"];
  v5 = v4;
  if (v4)
  {
    v6 = [v4 valueForKey:@"faces"];
    if (v6)
    {
      [v3 setValue:v6 forKey:@"rejectedFaces"];
      ++*(*(*(a1 + 40) + 8) + 24);
    }

    [*(a1 + 32) deleteObject:v5];
    ++*(*(*(a1 + 48) + 8) + 24);
  }

  else
  {
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v8 = 136315394;
      v9 = "[PLModelMigrator _migrateRejectedFacesGroupInStagedStore:]_block_invoke";
      v10 = 2112;
      v11 = v3;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "%s: failed to find rejectedFacesGroup for person %@", &v8, 0x16u);
    }
  }
}

- (BOOL)_migrateOriginalColorSpaceInStagedStore:(id)a3
{
  v27[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _migrateOriginalColorSpaceInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v26 = @"originalColorSpace";
  v10 = [MEMORY[0x1E696ABC8] expressionForKeyPath:@"additionalAttributes.originalColorSpace"];
  v27[0] = v10;
  v11 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v27 forKeys:&v26 count:1];
  [v9 setPropertiesToUpdate:v11];

  [v9 setResultType:2];
  v19 = 0;
  v12 = [v6 executeRequest:v9 error:&v19];
  v13 = v19;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v12)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = [v12 result];
      *buf = 138412290;
      v21 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Updated %@ assets", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    v17 = [v13 userInfo];
    *buf = 136315650;
    v21 = "[PLModelMigrator _migrateOriginalColorSpaceInStagedStore:]";
    v22 = 2112;
    v23 = v13;
    v24 = 2112;
    v25 = v17;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  return v12 != 0;
}

- (BOOL)_performMigrationCacheDateCreatedOnResources:(BOOL)a3 cacheItemIdentifierOnResources:(BOOL)a4 store:(id)a5
{
  v5 = a4;
  v31[2] = *MEMORY[0x1E69E9840];
  v9 = a5;
  v10 = v9;
  if (a3 || v5)
  {
    if (!v9)
    {
      v23 = [MEMORY[0x1E696AAA8] currentHandler];
      [v23 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:9077 description:{@"Invalid parameter not satisfying: %@", @"store != nil"}];
    }

    v12 = objc_autoreleasePoolPush();
    v13 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v10 name:"[PLModelMigrator _performMigrationCacheDateCreatedOnResources:cacheItemIdentifierOnResources:store:]" concurrencyType:*MEMORY[0x1E695D708]];
    v14 = MEMORY[0x1E695D5E0];
    v15 = +[PLManagedAsset entityName];
    v16 = [v14 fetchRequestWithEntityName:v15];

    v31[0] = @"master";
    v31[1] = @"resources";
    v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:v31 count:2];
    [v16 setRelationshipKeyPathsForPrefetching:v17];

    [v16 setFetchBatchSize:100];
    v18 = [v13 executeFetchRequest:v16 error:0];
    v24[0] = MEMORY[0x1E69E9820];
    v24[1] = 3221225472;
    v24[2] = __101__PLModelMigrator__performMigrationCacheDateCreatedOnResources_cacheItemIdentifierOnResources_store___block_invoke;
    v24[3] = &__block_descriptor_34_e31_v32__0__PLManagedAsset_8Q16_B24l;
    v25 = a3;
    v26 = v5;
    v19 = [v13 enumerateWithIncrementalSaveUsingObjects:v18 withBlock:v24];
    v11 = v19 == 0;
    if (v19)
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v21 = [v19 userInfo];
        *buf = 138412546;
        v28 = v19;
        v29 = 2112;
        v30 = v21;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "_performMigrationWithMarkThumbnailsAsAltAvailable:cacheDateCreatedOnResources:cacheItemIdentifierOnResources:store: failed: %@ %@", buf, 0x16u);
      }
    }

    objc_autoreleasePoolPop(v12);
  }

  else
  {
    v11 = 1;
  }

  return v11;
}

void __101__PLModelMigrator__performMigrationCacheDateCreatedOnResources_cacheItemIdentifierOnResources_store___block_invoke(uint64_t a1, void *a2)
{
  v59 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = v3;
  if (*(a1 + 32) == 1)
  {
    v53 = 0u;
    v54 = 0u;
    v51 = 0u;
    v52 = 0u;
    v5 = [v3 master];
    v6 = [v5 resources];

    v7 = [v6 countByEnumeratingWithState:&v51 objects:v58 count:16];
    if (v7)
    {
      v8 = v7;
      v9 = *v52;
      do
      {
        v10 = 0;
        do
        {
          if (*v52 != v9)
          {
            objc_enumerationMutation(v6);
          }

          v11 = *(*(&v51 + 1) + 8 * v10);
          v12 = [v4 master];
          v13 = [v12 creationDate];
          [v11 setDateCreated:v13];

          ++v10;
        }

        while (v8 != v10);
        v8 = [v6 countByEnumeratingWithState:&v51 objects:v58 count:16];
      }

      while (v8);
    }

    v49 = 0u;
    v50 = 0u;
    v47 = 0u;
    v48 = 0u;
    v14 = [v4 resources];
    v15 = [v14 countByEnumeratingWithState:&v47 objects:v57 count:16];
    if (v15)
    {
      v16 = v15;
      v17 = *v48;
      do
      {
        v18 = 0;
        do
        {
          if (*v48 != v17)
          {
            objc_enumerationMutation(v14);
          }

          v19 = *(*(&v47 + 1) + 8 * v18);
          v20 = [v4 master];
          v21 = [v20 creationDate];
          [v19 setDateCreated:v21];

          ++v18;
        }

        while (v16 != v18);
        v16 = [v14 countByEnumeratingWithState:&v47 objects:v57 count:16];
      }

      while (v16);
    }
  }

  if (*(a1 + 33) == 1)
  {
    v45 = 0u;
    v46 = 0u;
    v43 = 0u;
    v44 = 0u;
    v22 = [v4 resources];
    v23 = [v22 countByEnumeratingWithState:&v43 objects:v56 count:16];
    if (v23)
    {
      v24 = v23;
      v25 = *v44;
      do
      {
        v26 = 0;
        do
        {
          if (*v44 != v25)
          {
            objc_enumerationMutation(v22);
          }

          v27 = *(*(&v43 + 1) + 8 * v26);
          v28 = [v4 cloudAssetGUID];
          [v27 setItemIdentifier:v28];

          ++v26;
        }

        while (v24 != v26);
        v24 = [v22 countByEnumeratingWithState:&v43 objects:v56 count:16];
      }

      while (v24);
    }

    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v29 = [v4 master];
    v30 = [v29 resources];

    v31 = [v30 countByEnumeratingWithState:&v39 objects:v55 count:16];
    if (v31)
    {
      v32 = v31;
      v33 = *v40;
      do
      {
        v34 = 0;
        do
        {
          if (*v40 != v33)
          {
            objc_enumerationMutation(v30);
          }

          v35 = *(*(&v39 + 1) + 8 * v34);
          v36 = [v4 master];
          v37 = [v36 scopedIdentifier];
          v38 = [v37 identifier];
          [v35 setItemIdentifier:v38];

          ++v34;
        }

        while (v32 != v34);
        v32 = [v30 countByEnumeratingWithState:&v39 objects:v55 count:16];
      }

      while (v32);
    }
  }
}

- (BOOL)_moveMyPhotoStreamToAlbumsListInStore:(id)a3
{
  v29 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v20 = [MEMORY[0x1E696AAA8] currentHandler];
    v21 = NSStringFromSelector(a2);
    [v20 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:9029 description:{@"%@ can only be called from assetsd", v21}];
  }

  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _moveMyPhotoStreamToAlbumsListInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [(PLGenericAlbum *)PLManagedAlbum albumWithKind:1500 inManagedObjectContext:v7];
  if (v8)
  {
    v9 = [PLManagedAlbumList allStreamedAlbumsListInManagedObjectContext:v7];
    v10 = [PLManagedAlbumList albumListInManagedObjectContext:v7];
    v11 = [v9 albums];
    v12 = [v11 indexOfObject:v8];
    if (v12 != 0x7FFFFFFFFFFFFFFFLL)
    {
      [v11 removeObjectAtIndex:v12];
      v13 = PLMigrationGetLog();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Removed My Photo Stream album from streams list", buf, 2u);
      }
    }

    v14 = [v10 albums];
    if ([v14 indexOfObject:v8] == 0x7FFFFFFFFFFFFFFFLL)
    {
      [v10 insertIntoOrderedAlbumsAtIndexByPriorityForAlbum:v8];
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Added My Photo Stream album to albums list", buf, 2u);
      }
    }

    if ([v7 hasChanges])
    {
      v23 = v6;
      v24 = 0;
      v16 = [v7 save:&v24];
      v17 = v24;
      if ((v16 & 1) == 0)
      {
        v18 = PLMigrationGetLog();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
        {
          v22 = [v17 userInfo];
          *buf = 138412546;
          v26 = v17;
          v27 = 2112;
          v28 = v22;
          _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Failed to move My Photo Stream to albums list %@ %@", buf, 0x16u);
        }
      }

      v6 = v23;
    }

    else
    {
      v16 = 1;
    }
  }

  else
  {
    v16 = 1;
  }

  objc_autoreleasePoolPop(v6);
  return v16;
}

- (BOOL)_fixupAssetPersistence:(id)a3
{
  v19[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupAssetPersistence:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForFixupAssetPersistenceExclusions"), 1}];
  v19[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"complete"];
  v19[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v19 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];
  [v9 setPredicate:v14];

  v18 = @"additionalAttributes";
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v18 count:1];
  [v9 setRelationshipKeyPathsForPrefetching:v15];

  v16 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:&__block_literal_global_1924];
  [v6 reset];

  objc_autoreleasePoolPop(v5);
  return 1;
}

- (BOOL)_persistVideoComplPropertiesInStore:(id)a3
{
  v36[4] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _persistVideoComplPropertiesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = MEMORY[0x1E696AB28];
  v10 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudPhotoLibraryAsset"), 1}];
  v36[0] = v10;
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kindSubtype", 2];
  v36[1] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"videoCpDurationValue"];
  v36[2] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"complete"];
  v36[3] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v36 count:4];
  v15 = [v9 andPredicateWithSubpredicates:v14];
  [v8 setPredicate:v15];

  v35 = @"additionalAttributes";
  v16 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v35 count:1];
  [v8 setRelationshipKeyPathsForPrefetching:v16];

  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v17 = [MEMORY[0x1E696AC08] defaultManager];
  v24[0] = MEMORY[0x1E69E9820];
  v24[1] = 3221225472;
  v24[2] = __55__PLModelMigrator__persistVideoComplPropertiesInStore___block_invoke;
  v24[3] = &unk_1E75721F8;
  v18 = v17;
  v25 = v18;
  v26 = &v27;
  v19 = [v5 enumerateObjectsFromFetchRequest:v8 count:0 usingDefaultBatchSizeWithBlock:v24];
  [v5 reset];
  v20 = PLMigrationGetLog();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    v21 = v28[3];
    *buf = 67109376;
    v32 = 1;
    v33 = 2048;
    v34 = v21;
    _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "_persistVideoComplPropertiesInStore: finished %d with %ld assets", buf, 0x12u);
  }

  _Block_object_dispose(&v27, 8);
  objc_autoreleasePoolPop(context);

  return 1;
}

void __55__PLModelMigrator__persistVideoComplPropertiesInStore___block_invoke(uint64_t a1, void *a2)
{
  v10 = a2;
  v3 = [v10 mainFileURL];
  v4 = v3;
  if (v3)
  {
    v5 = *(a1 + 32);
    v6 = [v3 path];
    LODWORD(v5) = [v5 fileExistsAtPath:v6];

    if (v5)
    {
      v7 = [MEMORY[0x1E69BF230] filesystemPersistenceBatchItemForFileAtURL:v4];
      v8 = [v10 videoComplementData];
      [v7 setData:v8 forKey:*MEMORY[0x1E69BFD78]];

      v9 = [v10 videoCpVisibilityState];
      [v7 setUInt16:v9 forKey:*MEMORY[0x1E69BFE70]];
      [v7 persist];
      ++*(*(*(a1 + 40) + 8) + 24);
    }
  }
}

- (BOOL)_persistPlaceAnnotationData:(id)a3
{
  v14[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _persistPlaceAnnotationData:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.placeAnnotationData != nil"];
  [v9 setPredicate:v10];

  v14[0] = @"additionalAttributes";
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v14 count:1];
  [v9 setRelationshipKeyPathsForPrefetching:v11];

  v12 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:&__block_literal_global_1921];
  [v6 reset];

  objc_autoreleasePoolPop(v5);
  return 1;
}

- (BOOL)_fixVideoDimensionsInStore:(id)a3
{
  v29[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixVideoDimensionsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind == %d AND complete != 0", 1];
  [v9 setPredicate:v10];

  v29[0] = @"additionalAttributes";
  v11 = [MEMORY[0x1E695DEC8] arrayWithObjects:v29 count:1];
  [v9 setRelationshipKeyPathsForPrefetching:v11];

  v22 = 0;
  v23 = &v22;
  v24 = 0x2020000000;
  v25 = 0;
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __46__PLModelMigrator__fixVideoDimensionsInStore___block_invoke;
  v21[3] = &unk_1E75721F8;
  v21[4] = self;
  v21[5] = &v22;
  v12 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:v21];
  if ([v6 hasChanges])
  {
    v20 = 0;
    v13 = [v6 save:&v20];
    v14 = v20;
    if ((v13 & 1) == 0)
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        v16 = [v14 userInfo];
        *buf = 138412546;
        *v27 = v14;
        *&v27[8] = 2112;
        v28 = v16;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_fixVideoDimensionsInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v13 = 1;
  }

  v17 = PLMigrationGetLog();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    v18 = *(v23 + 6);
    *buf = 67109376;
    *v27 = v13;
    *&v27[4] = 1024;
    *&v27[6] = v18;
    _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "_fixVideoDimensionsInStore: finished %d with %d assets", buf, 0xEu);
  }

  [v6 reset];
  _Block_object_dispose(&v22, 8);

  objc_autoreleasePoolPop(v5);
  return v13;
}

uint64_t __46__PLModelMigrator__fixVideoDimensionsInStore___block_invoke(uint64_t a1, uint64_t a2)
{
  result = [*(a1 + 32) _fixVideoDimensionsForAsset:a2];
  if (result)
  {
    ++*(*(*(a1 + 40) + 8) + 24);
  }

  return result;
}

- (BOOL)_fixVideoDimensionsForAsset:(id)a3
{
  v3 = a3;
  if (![v3 height] || !objc_msgSend(v3, "width"))
  {
    v6 = [v3 fileURLForFullsizeRenderVideo];
    v5 = [MEMORY[0x1E696AC08] defaultManager];
    if (v6 && ([v6 path], v7 = objc_claimAutoreleasedReturnValue(), v8 = objc_msgSend(v5, "fileExistsAtPath:", v7), v7, (v8 & 1) != 0))
    {
      v9 = v6;
    }

    else
    {
      v9 = [v3 mainFileURL];

      if (!v9)
      {
        v4 = 0;
        goto LABEL_14;
      }

      v10 = [v9 path];
      v11 = [v5 fileExistsAtPath:v10];

      if (!v11)
      {
        v4 = 0;
        goto LABEL_13;
      }

      v6 = v9;
    }

    [PLManagedAsset dimensionsForVideoAtURL:v6];
    v13 = v12;
    [v3 setHeight:v14];
    [v3 setWidth:v13];
    v4 = 1;
LABEL_13:

    goto LABEL_14;
  }

  v4 = 0;
  v5 = 0;
LABEL_14:
  if (![v3 originalHeight] || !objc_msgSend(v3, "originalWidth"))
  {
    if (!v5)
    {
      v5 = objc_opt_new();
    }

    v15 = [v3 mainFileURL];
    v16 = [v15 path];
    v17 = [v5 fileExistsAtPath:v16];

    if (v17)
    {
      v18 = [v3 mainFileURL];
      [PLManagedAsset dimensionsForVideoAtURL:v18];
      v20 = v19;
      v22 = v21;

      [v3 setOriginalHeight:v22];
      [v3 setOriginalWidth:v20];
      v4 = 1;
    }
  }

  return v4;
}

- (BOOL)_populateAdjustmentsStateForAssetsInStore:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateAdjustmentsStateForAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.editorBundleID != NULL"];
  [v9 setPredicate:v10];

  v19 = 0;
  v11 = [v6 enumerateObjectsFromFetchRequest:v9 count:&v19 usingDefaultBatchSizeWithBlock:&__block_literal_global_1913];
  if ([v6 hasChanges])
  {
    v18 = 0;
    v12 = [v6 save:&v18];
    v13 = v18;
    if ((v12 & 1) == 0)
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        v15 = [v13 userInfo];
        *buf = 138412546;
        *v21 = v13;
        *&v21[8] = 2112;
        *&v21[10] = v15;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "_populateHasAdjustmentsForAssetsInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v12 = 1;
  }

  v16 = PLMigrationGetLog();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109376;
    *v21 = v12;
    *&v21[4] = 2048;
    *&v21[6] = v19;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "_populateHasAdjustmentsForAssetsInStore: finished %d with %lu assets", buf, 0x12u);
  }

  objc_autoreleasePoolPop(v5);
  return v12;
}

- (BOOL)_fixEmptyVideoResourcePathsInStore:(id)a3
{
  v32 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixEmptyVideoResourcePathsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudResource"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(type = %d OR type = %d OR type = %d) AND cloudMaster != nil AND filePath = nil", 18, 6, 7];
  [v7 setPredicate:v8];
  [v7 setFetchBatchSize:100];
  v9 = [v6 executeFetchRequest:v7 error:0];
  v26 = 0;
  v27 = &v26;
  v28 = 0x2020000000;
  v29 = 0;
  v22 = 0;
  v23 = &v22;
  v24 = 0x2020000000;
  v25 = 0;
  v18[0] = MEMORY[0x1E69E9820];
  v18[1] = 3221225472;
  v18[2] = __54__PLModelMigrator__fixEmptyVideoResourcePathsInStore___block_invoke;
  v18[3] = &unk_1E75690A8;
  v10 = v6;
  v19 = v10;
  v20 = &v26;
  v21 = &v22;
  v11 = [v10 enumerateWithIncrementalSaveUsingObjects:v9 shouldRefreshAfterSave:1 withBlock:v18];
  if (v11)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = [v11 userInfo];
      *buf = 138412546;
      *v31 = v11;
      *&v31[8] = 2112;
      *&v31[10] = v13;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_fixEmptyVideoResourcePathsInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v14 = PLMigrationGetLog();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v15 = v27[3];
    v16 = v23[3];
    *buf = 67109632;
    *v31 = v11 == 0;
    *&v31[4] = 2048;
    *&v31[6] = v15;
    *&v31[14] = 2048;
    *&v31[16] = v16;
    _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "_fixEmptyVideoResourcePathsInStore: finished %d fixed %lu resources, skipped %lu resources", buf, 0x1Cu);
  }

  _Block_object_dispose(&v22, 8);
  _Block_object_dispose(&v26, 8);

  objc_autoreleasePoolPop(v5);
  return v11 == 0;
}

void __54__PLModelMigrator__fixEmptyVideoResourcePathsInStore___block_invoke(void *a1, void *a2)
{
  v13 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 assetUuid];
  if (v4)
  {
    v5 = [PLManagedAsset assetWithUUID:v4 inManagedObjectContext:a1[4]];
    if (v5)
    {
      v6 = -[NSObject pathForCPLResourceType:adjusted:](v5, "pathForCPLResourceType:adjusted:", [v3 type], 0);
      if (v6)
      {
        v7 = v6;
        [v3 setFilePath:v6];
        ++*(*(a1[5] + 8) + 24);
      }

      else
      {
        ++*(*(a1[6] + 8) + 24);
        v8 = PLMigrationGetLog();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
        {
          v9 = 138412546;
          v10 = v3;
          v11 = 2112;
          v12 = v5;
          _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_ERROR, "_fixEmptyVideoResourcePathsInStore: Unable to find a path for cloudResource %@ with asset %@", &v9, 0x16u);
        }

        v7 = 0;
      }
    }

    else
    {
      ++*(*(a1[6] + 8) + 24);
      v7 = PLMigrationGetLog();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
      {
        v9 = 138412290;
        v10 = v3;
        _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEBUG, "_fixEmptyVideoResourcePathsInStore: Unable to find asset for cloudResource: %@", &v9, 0xCu);
      }
    }
  }

  else
  {
    ++*(*(a1[6] + 8) + 24);
    v5 = PLMigrationGetLog();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
    {
      v9 = 138412290;
      v10 = v3;
      _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEBUG, "_fixEmptyVideoResourcePathsInStore: CloudResource %@ has no assetUUID", &v9, 0xCu);
    }
  }
}

- (BOOL)_fixLocalPathForVideoCmplDerivativesInStore:(id)a3
{
  v37 = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixLocalPathForVideoCmplDerivativesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudResource"];
  v7 = MEMORY[0x1E696AE18];
  v8 = [*MEMORY[0x1E6982F80] identifier];
  v9 = [v7 predicateWithFormat:@"(type = %d OR type = %d) AND cloudMaster != nil AND filePath LIKE %@ AND uniformTypeIdentifier == %@", 6, 7, @"*.MP4", v8];

  [v6 setPredicate:v9];
  [v6 setFetchBatchSize:100];
  v10 = [v5 executeFetchRequest:v6 error:0];
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 0;
  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v11 = [MEMORY[0x1E696AC08] defaultManager];
  v22[0] = MEMORY[0x1E69E9820];
  v22[1] = 3221225472;
  v22[2] = __63__PLModelMigrator__fixLocalPathForVideoCmplDerivativesInStore___block_invoke;
  v22[3] = &unk_1E7569080;
  v12 = v11;
  v23 = v12;
  v13 = v5;
  v24 = v13;
  v25 = &v27;
  v26 = &v31;
  v14 = [v13 enumerateWithIncrementalSaveUsingObjects:v10 shouldRefreshAfterSave:1 withBlock:v22];
  if (v14)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = [v14 userInfo];
      *buf = 138412546;
      *v36 = v14;
      *&v36[8] = 2112;
      *&v36[10] = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_fixLocalPathForVideoCmplDerivativesInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v17 = PLMigrationGetLog();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    v18 = v32[3];
    v19 = v28[3];
    *buf = 67109632;
    *v36 = v14 == 0;
    *&v36[4] = 2048;
    *&v36[6] = v18;
    *&v36[14] = 2048;
    *&v36[16] = v19;
    _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "_fixLocalPathForVideoCmplDerivativesInStore: finished %d with %lu resources, moved %lu files", buf, 0x1Cu);
  }

  _Block_object_dispose(&v27, 8);
  _Block_object_dispose(&v31, 8);

  objc_autoreleasePoolPop(context);
  return v14 == 0;
}

void __63__PLModelMigrator__fixLocalPathForVideoCmplDerivativesInStore___block_invoke(uint64_t a1, void *a2)
{
  v25 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 filePath];
  if (v4)
  {
    [v3 setIsLocallyAvailable:{objc_msgSend(*(a1 + 32), "fileExistsAtPath:", v4)}];
  }

  v5 = [v3 assetUuid];
  if (v5)
  {
    v6 = [PLManagedAsset assetWithUUID:v5 inManagedObjectContext:*(a1 + 40)];
    v7 = v6;
    if (v6)
    {
      if ([v6 kindSubtype]!= 2)
      {
        v8 = PLMigrationGetLog();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v18 = v3;
          _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_ERROR, "Found non-Iris video resource %@ with incorrect path.", buf, 0xCu);
        }
      }

      v9 = -[NSObject pathForCPLResourceType:adjusted:](v7, "pathForCPLResourceType:adjusted:", [v3 type], 0);
      if (v9)
      {
        v10 = v9;
        if (([v4 isEqualToString:v9] & 1) == 0)
        {
          [v3 setFilePath:v10];
          if ([v3 isLocallyAvailable])
          {
            v11 = *(a1 + 32);
            v16 = 0;
            v12 = [v11 moveItemAtPath:v4 toPath:v10 error:&v16];
            v13 = v16;
            if (v12)
            {
              ++*(*(*(a1 + 48) + 8) + 24);
            }

            else
            {
              v15 = PLMigrationGetLog();
              if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
              {
                *buf = 138413058;
                v18 = v4;
                v19 = 2112;
                v20 = v10;
                v21 = 2112;
                v22 = v3;
                v23 = 2112;
                v24 = v13;
                _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Unable to move %@ to %@ for cloudResource %@. Error: %@", buf, 0x2Au);
              }

              [v3 setIsLocallyAvailable:0];
            }
          }

          ++*(*(*(a1 + 56) + 8) + 24);
        }
      }

      else
      {
        v14 = PLMigrationGetLog();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v18 = v3;
          v19 = 2112;
          v20 = v7;
          _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Unable to find a path for cloudResource %@ with asset %@", buf, 0x16u);
        }

        v10 = 0;
      }
    }

    else
    {
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v18 = v3;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "_fixLocalPathForVideoCmplDerivativesInStore: Unable to find asset for cloudResource: %@", buf, 0xCu);
      }
    }
  }

  else
  {
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v18 = v3;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "_fixLocalPathForVideoCmplDerivativesInStore: CloudResource %@ has no assetUUID", buf, 0xCu);
    }
  }
}

- (BOOL)_fixItemIdentifierForVideoCmplInStore:(id)a3
{
  v28[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixItemIdentifierForVideoCmplInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudResource"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(type = %d OR type = %d) AND itemIdentifier != cloudMaster.cloudMasterGUID", 6, 7];
  [v7 setPredicate:v8];
  [v7 setFetchBatchSize:100];
  v28[0] = @"cloudMaster";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v28 count:1];
  [v7 setRelationshipKeyPathsForPrefetching:v9];

  v10 = [v6 executeFetchRequest:v7 error:0];
  v22 = 0;
  v23 = &v22;
  v24 = 0x2020000000;
  v25 = 0;
  v11 = [MEMORY[0x1E696AC08] defaultManager];
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __57__PLModelMigrator__fixItemIdentifierForVideoCmplInStore___block_invoke;
  v19[3] = &unk_1E7568F28;
  v12 = v11;
  v20 = v12;
  v21 = &v22;
  v13 = [v6 enumerateWithIncrementalSaveUsingObjects:v10 shouldRefreshAfterSave:1 withBlock:v19];
  if (v13)
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = [v13 userInfo];
      *buf = 138412546;
      *v27 = v13;
      *&v27[8] = 2112;
      *&v27[10] = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "_fixItemIdentifierForVideoCmplInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v16 = PLMigrationGetLog();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = v23[3];
    *buf = 67109376;
    *v27 = v13 == 0;
    *&v27[4] = 2048;
    *&v27[6] = v17;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "_fixItemIdentifierForVideoCmplInStore: finished %d with %lu assets", buf, 0x12u);
  }

  _Block_object_dispose(&v22, 8);
  objc_autoreleasePoolPop(v5);

  return v13 == 0;
}

void __57__PLModelMigrator__fixItemIdentifierForVideoCmplInStore___block_invoke(uint64_t a1, void *a2)
{
  v7 = a2;
  v3 = [v7 cloudMaster];
  v4 = [v3 scopedIdentifier];
  v5 = [v4 identifier];

  if (v5)
  {
    [v7 setItemIdentifier:v5];
  }

  v6 = [v7 filePath];
  if (v6)
  {
    [v7 setIsLocallyAvailable:{objc_msgSend(*(a1 + 32), "fileExistsAtPath:", v6)}];
  }

  ++*(*(*(a1 + 40) + 8) + 24);
}

- (BOOL)_markPhotoIrisVideoOrphansInStore:(id)a3
{
  v25 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _markPhotoIrisVideoOrphansInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind = %d and kindSubtype = %d AND complete != 0 AND duration != nil AND duration > 0 AND duration < %f", 1, 0, 0x4010000000000000];
  [v9 setPredicate:v10];
  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v19 = 0;
  v20 = &v19;
  v21 = 0x2020000000;
  v22 = 0;
  v18[0] = MEMORY[0x1E69E9820];
  v18[1] = 3221225472;
  v18[2] = __53__PLModelMigrator__markPhotoIrisVideoOrphansInStore___block_invoke;
  v18[3] = &unk_1E7568EB0;
  v18[4] = &v19;
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 shouldRefreshAfterSave:1 withBlock:v18];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v12 userInfo];
      *buf = 138412546;
      *v24 = v12;
      *&v24[8] = 2112;
      *&v24[10] = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_markPhotoIrisVideoOrphansInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = v20[3];
    *buf = 67109376;
    *v24 = v12 == 0;
    *&v24[4] = 2048;
    *&v24[6] = v16;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "_markPhotoIrisVideoOrphansInStore: finished %d with %lu assets", buf, 0x12u);
  }

  _Block_object_dispose(&v19, 8);
  objc_autoreleasePoolPop(v5);

  return v12 == 0;
}

void __53__PLModelMigrator__markPhotoIrisVideoOrphansInStore___block_invoke(uint64_t a1, void *a2)
{
  v6 = a2;
  v3 = [v6 pathForOriginalFile];
  if (v3)
  {
    v4 = PFVideoComplementMetadataForVideoAtPath();
    v5 = [v4 pairingIdentifier];
    if (v5)
    {
      [v6 setMediaGroupUUID:v5];
      [v6 persistMetadataToFilesystem];
      [v6 setCloudLocalState:0];
      ++*(*(*(a1 + 32) + 8) + 24);
    }
  }
}

- (BOOL)_fixZeroDurationPhotoIrisWithLocalResourcesInStore:(id)a3 assumeAdjustedIrisIsVisible:(BOOL)a4
{
  v21 = *MEMORY[0x1E69E9840];
  v18 = 0;
  v6 = MEMORY[0x1E696AE18];
  v7 = a3;
  v8 = [v6 predicateWithFormat:@"videoCpDurationValue == 0"];
  v17 = 0;
  v15[0] = MEMORY[0x1E69E9820];
  v15[1] = 3221225472;
  v15[2] = __98__PLModelMigrator__fixZeroDurationPhotoIrisWithLocalResourcesInStore_assumeAdjustedIrisIsVisible___block_invoke;
  v15[3] = &__block_descriptor_33_e51_v24__0__PLManagedAsset_8__NSManagedObjectContext_16l;
  v16 = a4;
  v9 = [(PLModelMigrator *)self _saveChangesToPhotoIrisInStore:v7 matchingPredicate:v8 countChanged:&v18 error:&v17 changeBlock:v15];

  v10 = v17;
  if (!v9)
  {
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = [v10 userInfo];
      *buf = 138412546;
      *v20 = v10;
      *&v20[8] = 2112;
      *&v20[10] = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "_fixZeroDurationPhotoIrisInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v13 = PLMigrationGetLog();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109376;
    *v20 = v9;
    *&v20[4] = 2048;
    *&v20[6] = v18;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "_fixZeroDurationPhotoIrisInStore: finished %d with %lu assets", buf, 0x12u);
  }

  return v9;
}

void __98__PLModelMigrator__fixZeroDurationPhotoIrisWithLocalResourcesInStore_assumeAdjustedIrisIsVisible___block_invoke(uint64_t a1, void *a2)
{
  v24 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 pathForVideoComplementFile];
  v5 = [MEMORY[0x1E696AC08] defaultManager];
  v6 = [v5 fileExistsAtPath:v4];

  if (v6)
  {
    v7 = [MEMORY[0x1E695DFF8] fileURLWithPath:v4 isDirectory:0];
    v21 = 0;
    v8 = *MEMORY[0x1E695DB50];
    v20 = 0;
    v9 = [v7 getResourceValue:&v21 forKey:v8 error:&v20];
    v10 = v21;
    v11 = v20;
    if (v9)
    {
      v12 = PFVideoComplementMetadataForVideoAtPath();
      v13 = [v12 pairingIdentifier];
      if (v12)
      {
        [v12 videoDuration];
        [v12 imageDisplayTime];
      }

      else
      {
        buf = 0uLL;
        v23 = 0;
        memset(v19, 0, sizeof(v19));
      }

      [v3 updatePhotoIrisMetadataWithMediaGroupUUID:v13 videoDuration:&buf stillDisplayTime:v19];

      if ([v3 hasAdjustments])
      {
        v14 = *(a1 + 32);
        v15 = 11;
        if ((v14 & 1) == 0)
        {
          v16 = [v3 pathForFullsizeRenderVideoFile];
          v17 = [MEMORY[0x1E696AC08] defaultManager];
          v18 = [v17 fileExistsAtPath:v16];

          if (v18)
          {
            v15 = 11;
          }

          else
          {
            v15 = 3;
          }
        }
      }

      else
      {
        v15 = 0;
      }

      [v3 setVideoCpVisibilityState:v15];
      [v3 persistMetadataToFilesystem];
    }

    else
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        LODWORD(buf) = 138412290;
        *(&buf + 4) = v11;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_fixZeroDurationPhotoIrisWithLocalResourcesInStore: failed to get size of video complement with error: %@", &buf, 0xCu);
      }
    }
  }
}

- (BOOL)_repushMemoriesWithNewFeaturesInStore:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _repushMemoriesWithNewFeaturesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLMemory entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState != %d AND (blacklistedFeature != nil OR extendedCuratedAssets.@count > 0)", 0];
  [v8 setPredicate:v9];
  [v8 setFetchBatchSize:100];
  v23 = 0;
  v10 = [v5 executeFetchRequest:v8 error:&v23];
  v11 = v23;
  if (v10)
  {
    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x2020000000;
    v29 = 0;
    v22[0] = MEMORY[0x1E69E9820];
    v22[1] = 3221225472;
    v22[2] = __57__PLModelMigrator__repushMemoriesWithNewFeaturesInStore___block_invoke;
    v22[3] = &unk_1E7569038;
    v22[4] = buf;
    v12 = [v5 enumerateWithIncrementalSaveUsingObjects:v10 withBlock:v22];
    v13 = v12 == 0;
    if (v12)
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        *v24 = 136315394;
        v25 = "[PLModelMigrator _repushMemoriesWithNewFeaturesInStore:]";
        v26 = 2112;
        v27 = v12;
        v15 = "%s save failed with error: %@";
        v16 = v14;
        v17 = OS_LOG_TYPE_ERROR;
LABEL_10:
        _os_log_impl(&dword_19BF1F000, v16, v17, v15, v24, 0x16u);
      }
    }

    else
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        v19 = *(*&buf[8] + 24);
        *v24 = 136315394;
        v25 = "[PLModelMigrator _repushMemoriesWithNewFeaturesInStore:]";
        v26 = 2048;
        v27 = v19;
        v15 = "%s for %lu memories.";
        v16 = v14;
        v17 = OS_LOG_TYPE_DEFAULT;
        goto LABEL_10;
      }
    }

    _Block_object_dispose(buf, 8);
    goto LABEL_12;
  }

  v18 = PLMigrationGetLog();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
  {
    *buf = 136315394;
    *&buf[4] = "[PLModelMigrator _repushMemoriesWithNewFeaturesInStore:]";
    *&buf[12] = 2112;
    *&buf[14] = v11;
    _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "%s fetch failed with error: %@", buf, 0x16u);
  }

  v13 = 0;
LABEL_12:

  objc_autoreleasePoolPop(context);
  return v13;
}

uint64_t __57__PLModelMigrator__repushMemoriesWithNewFeaturesInStore___block_invoke(uint64_t a1, void *a2)
{
  result = [a2 setCloudLocalState:0];
  ++*(*(*(a1 + 32) + 8) + 24);
  return result;
}

- (BOOL)_fixWhitelistOwnerForPendingInvitationsInStore:(id)a3
{
  v20 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixWhitelistOwnerForPendingInvitationsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = objc_alloc(MEMORY[0x1E695D560]);
  v8 = +[PLCloudSharedAlbum entityName];
  v9 = [v7 initWithEntityName:v8];

  [v9 setResultType:2];
  [v9 setPropertiesToUpdate:&unk_1F0FC0690];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudRelationshipState == %d AND cloudOwnerIsWhitelisted == YES", 1];
  [v9 setPredicate:v10];
  v17 = 0;
  v11 = [v6 executeRequest:v9 error:&v17];
  v12 = v17;
  v13 = PLMigrationGetLog();
  v14 = v13;
  if (v11)
  {
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v15 = [v11 result];
      *buf = 138412290;
      v19 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Reset cloudOwnerIsWhitelisted to NO for %@ pending shared album invitations.", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v19 = v12;
    _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Failed to reset cloudOwnerIsWhitelisted for pending shared album invitations: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v11 != 0;
}

- (BOOL)_persistPhotoIrisVisibilityStateToDiskInStore:(id)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v14 = 0;
  v4 = MEMORY[0x1E696AE18];
  v5 = a3;
  v6 = [v4 predicateWithFormat:@"videoCpVisibilityState != %d", 0];
  v13 = 0;
  v7 = [(PLModelMigrator *)self _saveChangesToPhotoIrisInStore:v5 matchingPredicate:v6 countChanged:&v14 error:&v13 changeBlock:&__block_literal_global_1873];

  v8 = v13;
  if (!v7)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = [v8 userInfo];
      *buf = 138412546;
      *v16 = v8;
      *&v16[8] = 2112;
      *&v16[10] = v10;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "_persistPhotoIrisVisibilityStateToDiskInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v11 = PLMigrationGetLog();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109376;
    *v16 = v7;
    *&v16[4] = 2048;
    *&v16[6] = v14;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "_persistPhotoIrisVisibilityStateToDiskInStore: finished %d with %lu assets", buf, 0x12u);
  }

  return v7;
}

- (BOOL)_markOldPhotoIrisEditsEvaluatedInStore:(id)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v14 = 0;
  v4 = MEMORY[0x1E696AE18];
  v5 = a3;
  v6 = [v4 predicateWithFormat:@"videoCpVisibilityState = %d AND additionalAttributes.unmanagedAdjustment != nil", 0];
  v13 = 0;
  v7 = [(PLModelMigrator *)self _saveChangesToPhotoIrisInStore:v5 matchingPredicate:v6 countChanged:&v14 error:&v13 changeBlock:&__block_literal_global_1868];

  v8 = v13;
  if (!v7)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = [v8 userInfo];
      *buf = 138412546;
      *v16 = v8;
      *&v16[8] = 2112;
      *&v16[10] = v10;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "_markOldPhotoIrisEditsEvaluatedInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v11 = PLMigrationGetLog();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109376;
    *v16 = v7;
    *&v16[4] = 2048;
    *&v16[6] = v14;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "_markOldPhotoIrisEditsEvaluatedInStore: finished %d with %lu assets", buf, 0x12u);
  }

  return v7;
}

- (BOOL)_saveChangesToPhotoIrisInStore:(id)a3 matchingPredicate:(id)a4 countChanged:(unint64_t *)a5 error:(id *)a6 changeBlock:(id)a7
{
  v44[2] = *MEMORY[0x1E69E9840];
  v12 = a3;
  v13 = a4;
  v14 = a7;
  if (!v14)
  {
    v24 = 1;
    goto LABEL_15;
  }

  v15 = objc_autoreleasePoolPush();
  v16 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v12 name:"[PLModelMigrator _saveChangesToPhotoIrisInStore:matchingPredicate:countChanged:error:changeBlock:]" concurrencyType:*MEMORY[0x1E695D708]];
  v17 = MEMORY[0x1E695D5E0];
  v18 = +[PLManagedAsset entityName];
  v19 = [v17 fetchRequestWithEntityName:v18];

  v20 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kindSubtype = %d", 2];
  v39 = v13;
  v37 = v20;
  if (v13)
  {
    v21 = MEMORY[0x1E696AB28];
    v44[0] = v20;
    v44[1] = v13;
    v22 = [MEMORY[0x1E695DEC8] arrayWithObjects:v44 count:2];
    v23 = [v21 andPredicateWithSubpredicates:v22];
  }

  else
  {
    v23 = v20;
  }

  v36 = v23;
  [v19 setPredicate:v23];
  [v19 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF8F8];
  [v19 setFetchBatchSize:100];
  v43 = 0;
  v25 = [v16 executeFetchRequest:v19 error:&v43];
  v26 = v43;
  v38 = v14;
  if (!v25)
  {
    v27 = v16;
    v24 = 0;
    if (!a5)
    {
      goto LABEL_9;
    }

    goto LABEL_8;
  }

  v40[0] = MEMORY[0x1E69E9820];
  v40[1] = 3221225472;
  v40[2] = __99__PLModelMigrator__saveChangesToPhotoIrisInStore_matchingPredicate_countChanged_error_changeBlock___block_invoke;
  v40[3] = &unk_1E7568FF0;
  v42 = v14;
  v27 = v16;
  v41 = v16;
  [v41 enumerateWithIncrementalSaveUsingObjects:v25 shouldRefreshAfterSave:1 withBlock:v40];
  v28 = v15;
  v29 = a5;
  v30 = a6;
  v32 = v31 = v12;

  v24 = v32 == 0;
  v26 = v32;
  v12 = v31;
  a6 = v30;
  a5 = v29;
  v15 = v28;
  if (a5)
  {
LABEL_8:
    *a5 = [v25 count];
  }

LABEL_9:

  objc_autoreleasePoolPop(v15);
  if (a6)
  {
    v33 = v24;
  }

  else
  {
    v33 = 1;
  }

  if ((v33 & 1) == 0)
  {
    v34 = v26;
    *a6 = v26;
  }

  v14 = v38;
  v13 = v39;
LABEL_15:

  return v24;
}

- (BOOL)_moveCloudSharedDerivativesInStore:(id)a3
{
  v40[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _moveCloudSharedDerivativesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v40[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K > %d", @"thumbnailIndex", 0xFFFFFFFFLL];
  v40[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v40 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];

  [v9 setPredicate:v14];
  [v9 setFetchBatchSize:100];
  v15 = [v6 executeFetchRequest:v9 error:0];
  v32 = 0;
  v33 = &v32;
  v34 = 0x2020000000;
  v35 = 0;
  v28 = 0;
  v29 = &v28;
  v30 = 0x2020000000;
  v31 = 0;
  v16 = [MEMORY[0x1E696AC08] defaultManager];
  v24[0] = MEMORY[0x1E69E9820];
  v24[1] = 3221225472;
  v24[2] = __54__PLModelMigrator__moveCloudSharedDerivativesInStore___block_invoke;
  v24[3] = &unk_1E7569428;
  v17 = v16;
  v25 = v17;
  v26 = &v32;
  v27 = &v28;
  v18 = [v6 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:v24];
  if (v18)
  {
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v37 = v18;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "_moveCloudSharedDerivativesInStore failed: %@", buf, 0xCu);
    }
  }

  v20 = PLMigrationGetLog();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    v21 = v33[3];
    v22 = v29[3];
    *buf = 134218240;
    v37 = v21;
    v38 = 2048;
    v39 = v22;
    _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "_moveCloudSharedDerivativesInStore: moved %lu failed %lu cloud shared asset derivatives", buf, 0x16u);
  }

  _Block_object_dispose(&v28, 8);
  _Block_object_dispose(&v32, 8);

  objc_autoreleasePoolPop(v5);
  return v18 == 0;
}

void __54__PLModelMigrator__moveCloudSharedDerivativesInStore___block_invoke(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x1E69E9840];
  v3 = [a2 pathForOriginalFile];
  v4 = v3;
  if (v3)
  {
    v5 = [v3 stringByDeletingPathExtension];
    v6 = [v5 stringByAppendingPathExtension:@"deriv.JPG"];

    v13 = 0;
    if ([*(a1 + 32) fileExistsAtPath:v6 isDirectory:&v13] && (v13 & 1) == 0)
    {
      v7 = PLMigrationGetLog();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412546;
        v15 = v6;
        v16 = 2112;
        v17 = v4;
        _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "found derivative file at %@, moving to %@", buf, 0x16u);
      }

      if ([*(a1 + 32) fileExistsAtPath:v4 isDirectory:&v13] && (v13 & 1) == 0)
      {
        v10 = PLMigrationGetLog();
        if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v15 = v4;
          _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "found unexpected original file at %@, skipping", buf, 0xCu);
        }
      }

      else
      {
        v8 = *(a1 + 32);
        v12 = 0;
        v9 = [v8 moveItemAtPath:v6 toPath:v4 error:&v12];
        v10 = v12;
        if (v9)
        {
          ++*(*(*(a1 + 40) + 8) + 24);
        }

        else
        {
          ++*(*(*(a1 + 48) + 8) + 24);
          v11 = PLMigrationGetLog();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412802;
            v15 = v6;
            v16 = 2112;
            v17 = v4;
            v18 = 2112;
            v19 = v10;
            _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "couldn't move cloud shared derivative from %@ to %@. Error: %@", buf, 0x20u);
          }
        }
      }
    }
  }
}

- (BOOL)_purgeCloudSharedResourcesInStore:(id)a3
{
  v25[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [MEMORY[0x1E696AC08] defaultManager];
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _purgeCloudSharedResourcesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = MEMORY[0x1E696AB28];
  v12 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v25[0] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K > %d", @"thumbnailIndex", 0xFFFFFFFFLL];
  v25[1] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v25 count:2];
  v15 = [v11 andPredicateWithSubpredicates:v14];

  [v10 setPredicate:v15];
  [v10 setFetchBatchSize:100];
  v16 = [v7 executeFetchRequest:v10 error:0];
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __53__PLModelMigrator__purgeCloudSharedResourcesInStore___block_invoke;
  v21[3] = &unk_1E7575368;
  v22 = v6;
  v17 = v6;
  v18 = [v7 enumerateWithIncrementalSaveUsingObjects:v16 withBlock:v21];
  if (v18)
  {
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v24 = v18;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "_purgeCloudSharedResourcesInStore failed: %@", buf, 0xCu);
    }
  }

  objc_autoreleasePoolPop(v5);
  return v18 == 0;
}

void __53__PLModelMigrator__purgeCloudSharedResourcesInStore___block_invoke(uint64_t a1, void *a2)
{
  v45 = *MEMORY[0x1E69E9840];
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  v38 = 0u;
  v28 = a2;
  v3 = [v28 allFileURLs];
  v4 = [v3 countByEnumeratingWithState:&v35 objects:v44 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v36;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v36 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v35 + 1) + 8 * i);
        v34 = 0;
        v9 = *(a1 + 32);
        v10 = [v8 path];
        LODWORD(v9) = [v9 fileExistsAtPath:v10 isDirectory:&v34];
        v11 = v34;

        if (v9 && (v11 & 1) == 0)
        {
          v12 = *(a1 + 32);
          v33 = 0;
          v13 = [v12 removeItemAtURL:v8 error:&v33];
          v14 = v33;
          v15 = PLMigrationGetLog();
          v16 = v15;
          if (v13)
          {
            if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v41 = v8;
              v17 = v16;
              v18 = OS_LOG_TYPE_DEFAULT;
              v19 = "deleted derivative file at %@";
              v20 = 12;
              goto LABEL_13;
            }
          }

          else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412546;
            v41 = v8;
            v42 = 2112;
            v43 = v14;
            v17 = v16;
            v18 = OS_LOG_TYPE_ERROR;
            v19 = "couldn't delete file at %@. Error: %@";
            v20 = 22;
LABEL_13:
            _os_log_impl(&dword_19BF1F000, v17, v18, v19, buf, v20);
          }

          continue;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v35 objects:v44 count:16];
    }

    while (v5);
  }

  v31 = 0u;
  v32 = 0u;
  v29 = 0u;
  v30 = 0u;
  v21 = [v28 modernResources];
  v22 = [v21 countByEnumeratingWithState:&v29 objects:v39 count:16];
  if (v22)
  {
    v23 = v22;
    v24 = *v30;
    do
    {
      for (j = 0; j != v23; ++j)
      {
        if (*v30 != v24)
        {
          objc_enumerationMutation(v21);
        }

        v26 = *(*(&v29 + 1) + 8 * j);
        if (([v26 localAvailability] & 0x80000000) == 0)
        {
          v27 = [v26 fileURL];

          if (v27)
          {
            [v26 markAsNotLocallyAvailable];
          }
        }
      }

      v23 = [v21 countByEnumeratingWithState:&v29 objects:v39 count:16];
    }

    while (v23);
  }
}

- (BOOL)_fixOriginalPropertiesForCloudSharedAssetsInStore:(id)a3
{
  v46[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixOriginalPropertiesForCloudSharedAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF8E0];
  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v46[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == 0 OR %K == 0 OR %K == nil", @"additionalAttributes.originalWidth", @"additionalAttributes.originalHeight", @"additionalAttributes.originalFilename"];
  v46[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v46 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];

  [v9 setPredicate:v14];
  v38 = 0;
  v39 = 0;
  v35 = 0;
  v36 = &v35;
  v37 = 0x2020000000;
  v31 = 0;
  v32 = &v31;
  v33 = 0x2020000000;
  v34 = 0;
  v27 = 0;
  v28 = &v27;
  v29 = 0x2020000000;
  v30 = 0;
  v26[0] = MEMORY[0x1E69E9820];
  v26[1] = 3221225472;
  v26[2] = __69__PLModelMigrator__fixOriginalPropertiesForCloudSharedAssetsInStore___block_invoke;
  v26[3] = &unk_1E7568FC8;
  v26[4] = &v35;
  v26[5] = &v31;
  v26[6] = &v27;
  v15 = [v6 enumerateObjectsFromFetchRequest:v9 count:&v39 usingDefaultBatchSizeWithBlock:v26];
  if ([v6 hasChanges])
  {
    v25 = 0;
    v16 = [v6 save:&v25];
    v17 = v25;
    if ((v16 & 1) == 0)
    {
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = [v17 userInfo];
        *buf = 138412546;
        *v41 = v17;
        *&v41[8] = 2112;
        *&v41[10] = v19;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "_fixOriginalPropertiesForCloudSharedAssetsInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v16 = 1;
  }

  v20 = PLMigrationGetLog();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
  {
    v21 = v36[3];
    v22 = v32[3];
    v23 = v28[3];
    *buf = 67110144;
    *v41 = v16;
    *&v41[4] = 2048;
    *&v41[6] = v39;
    *&v41[14] = 2048;
    *&v41[16] = v21;
    v42 = 2048;
    v43 = v22;
    v44 = 2048;
    v45 = v23;
    _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "_fixOriginalPropertiesForCloudSharedAssetsInStore: finished %d with %lu assets, fixed %lu original filename, %lu original width, %lu original height", buf, 0x30u);
  }

  _Block_object_dispose(&v27, 8);
  _Block_object_dispose(&v31, 8);
  _Block_object_dispose(&v35, 8);

  objc_autoreleasePoolPop(v5);
  return v16;
}

void __69__PLModelMigrator__fixOriginalPropertiesForCloudSharedAssetsInStore___block_invoke(void *a1, void *a2)
{
  v5 = a2;
  v3 = [v5 filename];
  if (v3)
  {
    v4 = [v5 originalFilename];

    if (!v4)
    {
      [v5 setOriginalFilename:v3];
      ++*(*(a1[4] + 8) + 24);
    }
  }

  if (![v5 originalWidth] && objc_msgSend(v5, "width"))
  {
    [v5 setOriginalWidth:{objc_msgSend(v5, "width")}];
    ++*(*(a1[5] + 8) + 24);
  }

  if (![v5 originalHeight] && objc_msgSend(v5, "height"))
  {
    [v5 setOriginalHeight:{objc_msgSend(v5, "height")}];
    ++*(*(a1[6] + 8) + 24);
  }
}

- (BOOL)_fixCloudSharedGIFsInStore:(id)a3
{
  v29[3] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixCloudSharedGIFsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = MEMORY[0x1E696AB28];
  v10 = 1;
  v11 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v29[0] = v11;
  v12 = MEMORY[0x1E696AE18];
  v13 = [*MEMORY[0x1E6982DE8] identifier];
  v14 = [v12 predicateWithFormat:@"%K == %@", @"uniformTypeIdentifier", v13];
  v29[1] = v14;
  v15 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K ENDSWITH[c] %@", @"filename", @"JPG"];
  v29[2] = v15;
  v16 = [MEMORY[0x1E695DEC8] arrayWithObjects:v29 count:3];
  v17 = [v9 andPredicateWithSubpredicates:v16];

  [v8 setPredicate:v17];
  v26 = 0;
  v18 = [v5 enumerateObjectsFromFetchRequest:v8 count:&v26 usingDefaultBatchSizeWithBlock:&__block_literal_global_1832];
  if ([v5 hasChanges])
  {
    v25 = 0;
    v10 = [v5 save:&v25];
    v19 = v25;
    if ((v10 & 1) == 0)
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v21 = [v19 userInfo];
        *buf = 138412546;
        *v28 = v19;
        *&v28[8] = 2112;
        *&v28[10] = v21;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "_fixCloudSharedGIFsInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  v22 = PLMigrationGetLog();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109376;
    *v28 = v10;
    *&v28[4] = 2048;
    *&v28[6] = v26;
    _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "_fixCloudSharedGIFsInStore: finished %d with %lu assets", buf, 0x12u);
  }

  objc_autoreleasePoolPop(context);
  return v10;
}

void __46__PLModelMigrator__fixCloudSharedGIFsInStore___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v2 = [v5 filename];
  v3 = [v2 stringByDeletingPathExtension];
  v4 = [v3 stringByAppendingPathExtension:@"GIF"];

  if (([v2 isEqualToString:v4] & 1) == 0)
  {
    [v5 setFilename:v4];
  }
}

- (BOOL)_fixCloudSharedVideosInStore:(id)a3
{
  v65[3] = *MEMORY[0x1E69E9840];
  v34 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v32 = [MEMORY[0x1E696AC08] defaultManager];
  v3 = [(PLModelMigrator *)self pathManager];
  v31 = [v3 photoDirectoryWithType:12];

  v33 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v34 name:"[PLModelMigrator _fixCloudSharedVideosInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v4 = MEMORY[0x1E695D5E0];
  v5 = +[PLManagedAsset entityName];
  v35 = [v4 fetchRequestWithEntityName:v5];

  v6 = MEMORY[0x1E696AB28];
  v7 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v65[0] = v7;
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"kind", 1];
  v65[1] = v8;
  v9 = MEMORY[0x1E696AB28];
  v10 = MEMORY[0x1E696AE18];
  v11 = [*MEMORY[0x1E6982E58] identifier];
  v12 = [v10 predicateWithFormat:@"%K == %@", @"uniformTypeIdentifier", v11];
  v64[0] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K BEGINSWITH %@", @"directory", @"/var/mobile/Media"];
  v64[1] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v64 count:2];
  v15 = [v9 orPredicateWithSubpredicates:v14];
  v65[2] = v15;
  v16 = [MEMORY[0x1E695DEC8] arrayWithObjects:v65 count:3];
  v17 = [v6 andPredicateWithSubpredicates:v16];

  [v35 setPredicate:v17];
  v57 = 0;
  v53 = 0;
  v54 = &v53;
  v55 = 0x2020000000;
  v56 = 0;
  v49 = 0;
  v50 = &v49;
  v51 = 0x2020000000;
  v52 = 0;
  v45 = 0;
  v46 = &v45;
  v47 = 0x2020000000;
  v48 = 0;
  v38[0] = MEMORY[0x1E69E9820];
  v38[1] = 3221225472;
  v38[2] = __48__PLModelMigrator__fixCloudSharedVideosInStore___block_invoke;
  v38[3] = &unk_1E7568FA0;
  v18 = v31;
  v39 = v18;
  v40 = self;
  v42 = &v53;
  v43 = &v49;
  v44 = &v45;
  v19 = v32;
  v41 = v19;
  v20 = [v33 enumerateObjectsFromFetchRequest:v35 count:&v57 usingDefaultBatchSizeWithBlock:v38];
  if ([v33 hasChanges])
  {
    v37 = 0;
    v21 = [v33 save:&v37];
    v22 = v37;
    if ((v21 & 1) == 0)
    {
      v23 = PLMigrationGetLog();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
      {
        v24 = [v22 userInfo];
        *buf = 138412546;
        *v59 = v22;
        *&v59[8] = 2112;
        *&v59[10] = v24;
        _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "_fixCloudSharedVideosInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v21 = 1;
  }

  v25 = PLMigrationGetLog();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
  {
    v26 = v54[3];
    v27 = v50[3];
    v28 = v46[3];
    *buf = 67110144;
    *v59 = v21;
    *&v59[4] = 2048;
    *&v59[6] = v57;
    *&v59[14] = 2048;
    *&v59[16] = v26;
    v60 = 2048;
    v61 = v27;
    v62 = 2048;
    v63 = v28;
    _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_DEFAULT, "_fixCloudSharedVideosInStore: finished %d with %lu assets, fixed %lu UTI, %lu directory, %lu filename", buf, 0x30u);
  }

  _Block_object_dispose(&v45, 8);
  _Block_object_dispose(&v49, 8);
  _Block_object_dispose(&v53, 8);

  objc_autoreleasePoolPop(context);
  return v21;
}

void __48__PLModelMigrator__fixCloudSharedVideosInStore___block_invoke(uint64_t a1, void *a2)
{
  v36 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = objc_alloc(MEMORY[0x1E696AF20]);
  v5 = [v3 thumbnailIdentifier];
  v6 = [v4 initWithString:v5];

  v7 = MEMORY[0x1E696AEC0];
  v8 = *(a1 + 32);
  v30 = v6;
  v9 = [v6 path];
  v10 = [v7 stringWithFormat:@"%@/%@", v8, v9];

  v11 = [v3 uniformTypeIdentifier];
  v12 = *MEMORY[0x1E6982EC8];
  v13 = [*MEMORY[0x1E6982EC8] identifier];

  if (v11 != v13)
  {
    v14 = [v12 identifier];
    [v3 setUniformTypeIdentifier:v14];

    ++*(*(*(a1 + 56) + 8) + 24);
  }

  v15 = [v3 directory];
  v16 = [*(a1 + 40) pathManager];
  v17 = [v16 assetAbbreviatedMetadataDirectoryForDirectory:v15 type:32 bundleScope:0];

  if (([v15 isEqualToString:v17] & 1) == 0)
  {
    [v3 setDirectory:v17];
    ++*(*(*(a1 + 64) + 8) + 24);
  }

  v18 = [v3 filename];
  v19 = [v18 stringByDeletingPathExtension];
  v20 = [v19 stringByAppendingPathExtension:@"MP4"];

  if (([v18 isEqualToString:v20] & 1) == 0)
  {
    [v3 setFilename:v20];
    ++*(*(*(a1 + 72) + 8) + 24);
  }

  v21 = MEMORY[0x1E696AEC0];
  v22 = *(a1 + 32);
  v23 = [v3 thumbnailIdentifier];
  v24 = [v21 stringWithFormat:@"%@/%@", v22, v23];

  if (([v10 isEqualToString:v24] & 1) == 0 && objc_msgSend(*(a1 + 48), "fileExistsAtPath:", v10))
  {
    v25 = *(a1 + 48);
    v31 = 0;
    v26 = [v25 moveItemAtPath:v10 toPath:v24 error:&v31];
    v27 = v31;
    if ((v26 & 1) == 0)
    {
      v28 = PLMigrationGetLog();
      if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
      {
        v29 = [v27 userInfo];
        *buf = 138412546;
        v33 = v27;
        v34 = 2112;
        v35 = v29;
        _os_log_impl(&dword_19BF1F000, v28, OS_LOG_TYPE_ERROR, "_fixCloudSharedVideosInStore: failed to move master thumb: %@ %@, abandoning thumbnail instead.", buf, 0x16u);
      }

      [v3 setEffectiveThumbnailIndex:0x7FFFFFFFFFFFFFFFLL];
    }
  }
}

- (BOOL)_addCloudKindSubtypeAndBurstFlagsInStore:(id)a3
{
  v28 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _addCloudKindSubtypeAndBurstFlagsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __60__PLModelMigrator__addCloudKindSubtypeAndBurstFlagsInStore___block_invoke;
  v19[3] = &unk_1E7568EB0;
  v19[4] = &v20;
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 shouldRefreshAfterSave:1 withBlock:v19];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v12 userInfo];
      *buf = 138412546;
      *v25 = v12;
      *&v25[8] = 2112;
      *&v25[10] = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_addCloudKindSubtypeAndBurstFlagsInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    v16 = [v11 count];
    v17 = v21[3];
    *buf = 67109888;
    *v25 = v12 == 0;
    *&v25[4] = 2048;
    *&v25[6] = v16;
    *&v25[14] = 2048;
    *&v25[16] = v17;
    v26 = 2048;
    v27 = v17;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "_addCloudKindSubtypeAndBurstFlagsInStore: finished %d with %lu assets (%lu cloudKindSubType %lu cloudBurstFlag)", buf, 0x26u);
  }

  _Block_object_dispose(&v20, 8);
  objc_autoreleasePoolPop(v5);

  return v12 == 0;
}

void __60__PLModelMigrator__addCloudKindSubtypeAndBurstFlagsInStore___block_invoke(uint64_t a1, void *a2)
{
  v6 = a2;
  v3 = [v6 additionalAttributes];
  v4 = [v6 cplAssetSubtypeFromPLAssetSubtype:{objc_msgSend(v6, "kindSubtype")}];
  if (v4 != [v3 cloudKindSubtype])
  {
    [v3 setCloudKindSubtype:v4];
    ++*(*(*(a1 + 32) + 8) + 24);
  }

  v5 = [v6 cplBurstFlagsFromPLAvalancheType:{objc_msgSend(v6, "avalanchePickType")}];
  if (v5 != [v3 cloudAvalanchePickType])
  {
    [v3 setCloudAvalanchePickType:v5];
  }
}

- (BOOL)_tagScreenshotsForAssetsInStore:(id)a3
{
  v36[5] = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v25 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _tagScreenshotsForAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v28 = 0;
  v29 = &v28;
  v30 = 0x2020000000;
  v31 = 0;
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = MEMORY[0x1E696AB28];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kind", 0];
  v36[0] = v10;
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kindSubtype", 0];
  v36[1] = v11;
  v12 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForTagScreenshotsExclusions"), 1}];
  v36[2] = v12;
  v13 = MEMORY[0x1E696AE18];
  v14 = [*MEMORY[0x1E6982F28] identifier];
  v15 = [v13 predicateWithFormat:@"%K == %@", @"uniformTypeIdentifier", v14];
  v36[3] = v15;
  v16 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"complete"];
  v36[4] = v16;
  v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:v36 count:5];
  v18 = [v9 andPredicateWithSubpredicates:v17];
  [v8 setPredicate:v18];

  [v8 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF8C8];
  [v8 setFetchBatchSize:100];
  v19 = [v5 executeFetchRequest:v8 error:0];
  v27[0] = MEMORY[0x1E69E9820];
  v27[1] = 3221225472;
  v27[2] = __51__PLModelMigrator__tagScreenshotsForAssetsInStore___block_invoke;
  v27[3] = &unk_1E7568EB0;
  v27[4] = &v28;
  v20 = [v5 enumerateWithIncrementalSaveUsingObjects:v19 withBlock:v27];
  if (v20)
  {
    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = [v20 userInfo];
      *buf = 138412546;
      v33 = v20;
      v34 = 2112;
      v35 = v22;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "_tagScreenshotsForAssetsInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v23 = *(v29 + 6);
      *buf = 67109120;
      LODWORD(v33) = v23;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "Tagged %d screenshots", buf, 8u);
    }
  }

  _Block_object_dispose(&v28, 8);
  objc_autoreleasePoolPop(context);

  return v20 == 0;
}

void __51__PLModelMigrator__tagScreenshotsForAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  if ([v3 updateKindSubtypeIfScreenshot])
  {
    ++*(*(*(a1 + 32) + 8) + 24);
    if ([v3 cloudLocalState])
    {
      [v3 setCloudLocalState:0];
    }
  }
}

- (BOOL)_addCameraCaptureDeviceForAssetsInStore:(id)a3
{
  v28 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _addCameraCaptureDeviceForAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v20 = 0;
  v21 = &v20;
  v22 = 0x2020000000;
  v23 = 0;
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AE18];
  v11 = [*MEMORY[0x1E6982E58] identifier];
  v12 = [v10 predicateWithFormat:@"uniformTypeIdentifier == %@ AND complete != 0 AND width <= 1280 AND height <= 1280", v11];
  [v9 setPredicate:v12];

  [v9 setFetchBatchSize:100];
  v13 = [v6 executeFetchRequest:v9 error:0];
  v19[0] = MEMORY[0x1E69E9820];
  v19[1] = 3221225472;
  v19[2] = __59__PLModelMigrator__addCameraCaptureDeviceForAssetsInStore___block_invoke;
  v19[3] = &unk_1E7568EB0;
  v19[4] = &v20;
  v14 = [v6 enumerateWithIncrementalSaveUsingObjects:v13 withBlock:v19];
  if (v14)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = [v14 userInfo];
      *buf = 138412546;
      v25 = v14;
      v26 = 2112;
      v27 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_addCameraCaptureDeviceForAssetsInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = *(v21 + 6);
      *buf = 67109120;
      LODWORD(v25) = v17;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Added camera capture device to %d assets", buf, 8u);
    }
  }

  _Block_object_dispose(&v20, 8);
  objc_autoreleasePoolPop(v5);

  return v14 == 0;
}

void __59__PLModelMigrator__addCameraCaptureDeviceForAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v5 = [v3 metadataFromMediaPropertiesOrOriginalResource];
  v4 = [v3 updatePlaybackVariationAndStyleFromOriginalMetadata:?];

  if (v4)
  {
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_fixIncorrectAddedDateForAssetsInStore:(id)a3
{
  v30[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixIncorrectAddedDateForAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v22 = 0;
  v23 = &v22;
  v24 = 0x2020000000;
  v25 = 0;
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForFixIncorrectAddedDateExclusions"), 0}];
  v30[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"complete"];
  v30[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v30 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];
  [v9 setPredicate:v14];

  [v9 setFetchBatchSize:100];
  v15 = [v6 executeFetchRequest:v9 error:0];
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __58__PLModelMigrator__fixIncorrectAddedDateForAssetsInStore___block_invoke;
  v21[3] = &unk_1E75721F8;
  v21[4] = self;
  v21[5] = &v22;
  v16 = [v6 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:v21];
  if (v16)
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = [v16 userInfo];
      *buf = 138412546;
      v27 = v16;
      v28 = 2112;
      v29 = v18;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "_fixIncorrectAddedDateForAssetsInStore: failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v19 = *(v23 + 6);
      *buf = 67109120;
      LODWORD(v27) = v19;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Fixed %d incorrect added date", buf, 8u);
    }
  }

  _Block_object_dispose(&v22, 8);
  objc_autoreleasePoolPop(v5);

  return v16 == 0;
}

uint64_t __58__PLModelMigrator__fixIncorrectAddedDateForAssetsInStore___block_invoke(uint64_t a1, uint64_t a2)
{
  result = [*(a1 + 32) fixPossiblyIncorrectAddedDateForAsset:a2];
  if (result)
  {
    ++*(*(*(a1 + 40) + 8) + 24);
  }

  return result;
}

- (BOOL)fixPossiblyIncorrectAddedDateForAsset:(id)a3
{
  v4 = a3;
  v5 = [v4 dateCreated];
  v6 = [v4 addedDate];
  v7 = v6;
  if (v6)
  {
    [v6 timeIntervalSinceDate:v5];
    if (v8 <= 60.0)
    {
      v11 = 0;
      v10 = 0;
      goto LABEL_28;
    }

    v9 = [v4 cameraMake];
    if ([v9 isEqualToString:@"Apple"] && -[PLModelMigrator _isReasonableCreationDate:](self, "_isReasonableCreationDate:", v5))
    {
      v10 = v5;
    }

    else
    {
      v12 = [v4 pathForOriginalFile];
      v13 = [MEMORY[0x1E696AC08] defaultManager];
      v10 = 0;
      if ([v13 fileExistsAtPath:v12 isDirectory:0])
      {
        v24 = 0;
        v14 = [v13 attributesOfItemAtPath:v12 error:&v24];
        v15 = v14;
        if (v14)
        {
          v16 = [v14 fileCreationDate];
          v17 = v16;
          if (!v16)
          {
            goto LABEL_22;
          }

          [v16 timeIntervalSinceDate:v5];
          if (v18 < 0.0)
          {
            v18 = -v18;
          }

          if (v18 < 60.0)
          {
            goto LABEL_20;
          }

          v19 = [v4 modificationDate];
          [v17 timeIntervalSinceDate:v19];
          v21 = v20;

          v22 = -v21;
          if (v21 >= 0.0)
          {
            v22 = v21;
          }

          if (v22 < 60.0)
          {
LABEL_20:
            v10 = v17;
          }

          else
          {
LABEL_22:
            v10 = 0;
          }
        }

        else
        {
          v10 = 0;
        }
      }
    }

    if (!v10)
    {
      goto LABEL_27;
    }
  }

  else
  {
    v10 = v5;
    if (!v10)
    {
LABEL_27:
      v11 = 0;
      goto LABEL_28;
    }
  }

  [v4 setAddedDate:v10];
  [v4 persistMetadataToFilesystem];
  if ([v4 cloudLocalState])
  {
    [v4 setCloudLocalState:0];
  }

  v11 = 1;
LABEL_28:

  return v11;
}

- (BOOL)_isReasonableCreationDate:(id)a3
{
  v3 = a3;
  v4 = [MEMORY[0x1E695DF00] date];
  v5 = [MEMORY[0x1E695DF00] dateWithTimeIntervalSinceReferenceDate:0.0];
  [v3 timeIntervalSinceDate:v4];
  if (v6 >= 0.0)
  {
    v8 = 0;
  }

  else
  {
    [v5 timeIntervalSinceDate:v3];
    v8 = v7 < 0.0;
  }

  return v8;
}

- (BOOL)_generateAddedDateForAssetsInStore:(id)a3
{
  v27[3] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _generateAddedDateForAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForGenerateAddedDateExclusions"), 0}];
  v27[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 0", @"complete"];
  v27[1] = v12;
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == nil", @"addedDate"];
  v27[2] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v27 count:3];
  v15 = [v10 andPredicateWithSubpredicates:v14];
  [v9 setPredicate:v15];

  v16 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:&__block_literal_global_1802];
  if ([v6 hasChanges])
  {
    v22 = 0;
    v17 = [v6 save:&v22];
    v18 = v22;
    if ((v17 & 1) == 0)
    {
      v19 = PLMigrationGetLog();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = [v18 userInfo];
        *buf = 138412546;
        v24 = v18;
        v25 = 2112;
        v26 = v20;
        _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "_generateAddedDateForAssetsInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v17 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v17;
}

void __54__PLModelMigrator__generateAddedDateForAssetsInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v2 = [v3 dateCreated];
  [v3 setAddedDate:v2];

  [v3 persistMetadataToFilesystem];
}

- (BOOL)_repersistDuplicatedAssets:(id)a3
{
  v140 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v81 = objc_autoreleasePoolPush();
  v88 = self;
  v82 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _repersistDuplicatedAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E696AC08] defaultManager];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"assets.@count > 1"];
  [v7 setPredicate:v8];

  v80 = v7;
  [v5 executeFetchRequest:v7 error:0];
  v128 = 0u;
  v129 = 0u;
  v130 = 0u;
  obj = v131 = 0u;
  v85 = [obj countByEnumeratingWithState:&v128 objects:v139 count:16];
  if (v85)
  {
    v84 = *v129;
    v9 = off_1E7560000;
    v89 = v5;
    do
    {
      v10 = 0;
      do
      {
        if (*v129 != v84)
        {
          objc_enumerationMutation(obj);
        }

        v87 = v10;
        v11 = *(*(&v128 + 1) + 8 * v10);
        v86 = objc_autoreleasePoolPush();
        v90 = v11;
        v12 = [PLCloudResource cloudResourcesForResourceType:1 forCloudMaster:v11];
        v13 = [MEMORY[0x1E695DFA8] set];
        v111 = [MEMORY[0x1E695DFA8] set];
        v124 = 0u;
        v125 = 0u;
        v126 = 0u;
        v127 = 0u;
        v92 = v12;
        v91 = v13;
        v94 = [v92 countByEnumeratingWithState:&v124 objects:v138 count:16];
        if (v94)
        {
          v14 = 0;
          v93 = *v125;
          do
          {
            v15 = 0;
            do
            {
              v109 = v14;
              if (*v125 != v93)
              {
                objc_enumerationMutation(v92);
              }

              v107 = v15;
              v16 = *(*(&v124 + 1) + 8 * v15);
              v17 = objc_autoreleasePoolPush();
              v18 = [v16 filePath];
              v19 = [v13 containsObject:v18];

              v20 = [v16 filePath];
              if (v19)
              {
                v21 = v111;
              }

              else
              {
                v21 = v13;
              }

              [v21 addObject:v20];

              v22 = v9[53];
              v23 = [v16 assetUuid];
              v24 = [(__objc2_class *)v22 assetWithUUID:v23 inManagedObjectContext:v5];

              v25 = MEMORY[0x1E695D5E0];
              v26 = [(__objc2_class *)v9[53] entityName];
              v27 = [v25 fetchRequestWithEntityName:v26];

              v28 = MEMORY[0x1E696AE18];
              v103 = v24;
              v29 = [v24 cloudAssetGUID];
              v30 = [v28 predicateWithFormat:@"cloudAssetGUID == %@", v29];

              v99 = v30;
              [v27 setPredicate:v30];
              v123 = 0;
              v31 = [v5 executeFetchRequest:v27 error:&v123];
              v32 = v123;
              v95 = [v31 count];
              context = v17;
              v101 = v27;
              v96 = v32;
              v97 = v31;
              if ([v31 count] < 2)
              {
                if (v109)
                {
                  goto LABEL_26;
                }
              }

              else
              {
                v122 = 0u;
                v120 = 0u;
                v121 = 0u;
                v119 = 0u;
                v33 = v31;
                v34 = [v33 countByEnumeratingWithState:&v119 objects:v137 count:16];
                if (v34)
                {
                  v35 = v34;
                  v36 = 0;
                  v37 = *v120;
                  do
                  {
                    for (i = 0; i != v35; ++i)
                    {
                      if (*v120 != v37)
                      {
                        objc_enumerationMutation(v33);
                      }

                      v39 = *(*(&v119 + 1) + 8 * i);
                      v40 = [v39 pathForOriginalFile];
                      [v39 setCloudAssetGUID:0];
                      [v39 setCloudLocalState:0];
                      if (([v6 fileExistsAtPath:v40 isDirectory:0] & 1) == 0)
                      {
                        v41 = [PLAssetTransactionReason transactionReason:@"[_repersistDuplicatedAssets]The original file is not on disk, deleting asset."];
                        [v39 deleteWithReason:v41];
                        ++v36;
                      }
                    }

                    v35 = [v33 countByEnumeratingWithState:&v119 objects:v137 count:16];
                  }

                  while (v35);
                }

                else
                {
                  v36 = 0;
                }

                v5 = v89;
                v9 = off_1E7560000;
                v13 = v91;
                if (v109 & 1 | (v36 != v95))
                {
LABEL_26:
                  [v90 setCloudLocalState:0];
                  v14 = 1;
                  goto LABEL_30;
                }
              }

              v14 = 0;
LABEL_30:
              v42 = [v103 pathForOriginalFile];
              v43 = [v6 fileExistsAtPath:v42 isDirectory:0];

              if (v43)
              {
                [v103 persistMetadataToFilesystem];
              }

              objc_autoreleasePoolPop(context);
              v15 = v107 + 1;
            }

            while (v107 + 1 != v94);
            v94 = [v92 countByEnumeratingWithState:&v124 objects:v138 count:16];
          }

          while (v94);
        }

        v117 = 0u;
        v118 = 0u;
        v115 = 0u;
        v116 = 0u;
        v108 = v92;
        v110 = [v108 countByEnumeratingWithState:&v115 objects:v136 count:16];
        if (v110)
        {
          v44 = *v116;
          contexta = *v116;
          do
          {
            for (j = 0; j != v110; ++j)
            {
              if (*v116 != v44)
              {
                objc_enumerationMutation(v108);
              }

              v46 = *(*(&v115 + 1) + 8 * j);
              v47 = objc_autoreleasePoolPush();
              v48 = [v46 filePath];
              v49 = [v111 containsObject:v48];

              if (v49)
              {
                v50 = v9[53];
                v51 = [v46 assetUuid];
                v52 = [(__objc2_class *)v50 assetWithUUID:v51 inManagedObjectContext:v5];

                if (v52)
                {
                  v53 = [v52 cloudAssetGUID];

                  if (!v53)
                  {
                    v104 = [v52 pathForOriginalFile];
                    v54 = [v52 uuid];
                    v55 = [v52 photoDataCPLResourceDestinationDirectoryCreateIfNeededWithIdentifier:v54];

                    v56 = [(PLModelMigrator *)v88 pathManager];
                    v57 = [v56 assetAbbreviatedMetadataDirectoryForDirectory:v55 type:32 bundleScope:0];
                    [v52 setDirectory:v57];

                    v58 = v9[53];
                    v59 = [v52 uniformTypeIdentifier];
                    v60 = [(__objc2_class *)v58 preferredFileExtensionForType:v59];

                    v61 = MEMORY[0x1E696AEC0];
                    v62 = [v52 uuid];
                    v102 = v60;
                    v63 = [v61 stringWithFormat:@"%@.%@", v62, v60];

                    v100 = v63;
                    [v52 setFilename:v63];
                    v64 = [v52 pathForOriginalFile];
                    v65 = [v64 stringByDeletingLastPathComponent];

                    v114 = 0;
                    v98 = v65;
                    LOBYTE(v65) = [v6 createDirectoryIfNeededAtPath:v65 error:&v114];
                    v66 = v114;
                    if ((v65 & 1) == 0)
                    {
                      v67 = PLMigrationGetLog();
                      if (os_log_type_enabled(v67, OS_LOG_TYPE_ERROR))
                      {
                        v68 = [v66 userInfo];
                        *buf = 138412546;
                        v133 = v66;
                        v134 = 2112;
                        v135 = v68;
                        _os_log_impl(&dword_19BF1F000, v67, OS_LOG_TYPE_ERROR, "_repersistDuplicatedAssets: failed to create directory: %@ %@", buf, 0x16u);
                      }
                    }

                    v113 = v66;
                    v69 = [v6 copyItemAtPath:v104 toPath:v64 error:&v113];
                    v70 = v113;

                    if ((v69 & 1) == 0)
                    {
                      v71 = PLMigrationGetLog();
                      if (os_log_type_enabled(v71, OS_LOG_TYPE_ERROR))
                      {
                        v72 = [v70 userInfo];
                        *buf = 138412546;
                        v133 = v70;
                        v134 = 2112;
                        v135 = v72;
                        _os_log_impl(&dword_19BF1F000, v71, OS_LOG_TYPE_ERROR, "_repersistDuplicatedAssets: failed to copy originalFile: %@ %@", buf, 0x16u);
                      }
                    }

                    v9 = off_1E7560000;
                  }
                }

                v44 = contexta;
              }

              objc_autoreleasePoolPop(v47);
            }

            v110 = [v108 countByEnumeratingWithState:&v115 objects:v136 count:16];
          }

          while (v110);
        }

        objc_autoreleasePoolPop(v86);
        v10 = v87 + 1;
      }

      while (v87 + 1 != v85);
      v85 = [obj countByEnumeratingWithState:&v128 objects:v139 count:16];
    }

    while (v85);
  }

  if ([v5 hasChanges])
  {
    v112 = 0;
    v73 = [v5 save:&v112];
    v74 = v112;
    v75 = v82;
    if ((v73 & 1) == 0)
    {
      v76 = PLMigrationGetLog();
      if (os_log_type_enabled(v76, OS_LOG_TYPE_ERROR))
      {
        [v74 userInfo];
        v78 = v77 = v5;
        *buf = 138412546;
        v133 = v74;
        v134 = 2112;
        v135 = v78;
        _os_log_impl(&dword_19BF1F000, v76, OS_LOG_TYPE_ERROR, "_repersistDuplicatedAssets: failed: %@ %@", buf, 0x16u);

        v5 = v77;
      }
    }
  }

  else
  {
    v73 = 1;
    v75 = v82;
  }

  objc_autoreleasePoolPop(v81);
  return v73;
}

- (BOOL)_fixKeywordsInStagedStore:(id)a3
{
  v80[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  context = objc_autoreleasePoolPush();
  v55 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixKeywordsInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [(PLManagedObject *)PLManagedKeyword entityInManagedObjectContext:v5];
  v7 = MEMORY[0x1E695D5E0];
  v8 = [v6 name];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696ABC8] expressionWithFormat:@"count:(title)"];
  v11 = objc_alloc_init(MEMORY[0x1E695D5C8]);
  [v11 setName:@"count"];
  v52 = v10;
  [v11 setExpression:v10];
  [v11 setExpressionResultType:300];
  v61 = v6;
  v12 = [v6 propertiesByName];
  v13 = [v12 objectForKey:@"title"];

  v80[0] = v13;
  v80[1] = v11;
  v51 = v11;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v80 count:2];
  [v9 setPropertiesToFetch:v14];

  v50 = v13;
  v79 = v13;
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v79 count:1];
  [v9 setPropertiesToGroupBy:v15];

  [v9 setResultType:2];
  v53 = v9;
  v16 = [v5 executeFetchRequest:v9 error:0];
  v17 = [MEMORY[0x1E695DF70] array];
  v71 = 0u;
  v72 = 0u;
  v73 = 0u;
  v74 = 0u;
  obj = v16;
  v18 = [obj countByEnumeratingWithState:&v71 objects:v78 count:16];
  if (v18)
  {
    v19 = v18;
    v20 = *v72;
    do
    {
      for (i = 0; i != v19; ++i)
      {
        if (*v72 != v20)
        {
          objc_enumerationMutation(obj);
        }

        v22 = *(*(&v71 + 1) + 8 * i);
        v23 = [v22 objectForKey:@"count"];
        v24 = [v23 integerValue];

        if (v24 >= 2)
        {
          v25 = [v22 objectForKey:@"title"];
          v26 = PLMigrationGetLog();
          if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v77 = v25;
            _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "Found dupeKeyword: %@", buf, 0xCu);
          }

          [v17 addObject:v25];
        }
      }

      v19 = [obj countByEnumeratingWithState:&v71 objects:v78 count:16];
    }

    while (v19);
  }

  v60 = [MEMORY[0x1E695DF70] array];
  v67 = 0u;
  v68 = 0u;
  v69 = 0u;
  v70 = 0u;
  v56 = v17;
  v27 = [v56 countByEnumeratingWithState:&v67 objects:v75 count:16];
  if (v27)
  {
    v28 = v27;
    v59 = *v68;
    v58 = 1;
    do
    {
      for (j = 0; j != v28; ++j)
      {
        if (*v68 != v59)
        {
          objc_enumerationMutation(v56);
        }

        v30 = *(*(&v67 + 1) + 8 * j);
        v31 = MEMORY[0x1E695D5E0];
        v32 = [v61 name];
        v33 = [v31 fetchRequestWithEntityName:v32];

        v34 = [MEMORY[0x1E696AE18] predicateWithFormat:@"title == %@", v30];
        [v33 setPredicate:v34];

        [v33 setFetchBatchSize:100];
        v66 = 0;
        v35 = [v5 executeFetchRequest:v33 error:&v66];
        v36 = v66;
        v37 = [objc_alloc(MEMORY[0x1E695D620]) initWithEntity:v61 insertIntoManagedObjectContext:v5];
        [v37 setValue:v30 forKey:@"title"];
        v63[0] = MEMORY[0x1E69E9820];
        v63[1] = 3221225472;
        v63[2] = __45__PLModelMigrator__fixKeywordsInStagedStore___block_invoke;
        v63[3] = &unk_1E7568F78;
        v38 = v37;
        v64 = v38;
        v65 = v60;
        v39 = [v5 enumerateWithIncrementalSaveUsingObjects:v35 withBlock:v63];
        if (v39)
        {
          v40 = PLMigrationGetLog();
          if (os_log_type_enabled(v40, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412290;
            v77 = v36;
            _os_log_impl(&dword_19BF1F000, v40, OS_LOG_TYPE_ERROR, "Uniquing Keywords failed - error: %@", buf, 0xCu);
          }

          v58 = 0;
        }

        else
        {
          [v5 reset];
        }
      }

      v28 = [v56 countByEnumeratingWithState:&v67 objects:v75 count:16];
    }

    while (v28);
  }

  else
  {
    v58 = 1;
  }

  if ([v60 count])
  {
    v41 = [objc_alloc(MEMORY[0x1E695D538]) initWithObjectIDs:v60];
    v62 = 0;
    v42 = [v5 executeRequest:v41 error:&v62];
    v43 = v62;
    v44 = PLMigrationGetLog();
    v45 = v44;
    if (v43)
    {
      if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v77 = v43;
        v46 = "Error deleting keywords: %@";
        v47 = v45;
        v48 = OS_LOG_TYPE_ERROR;
LABEL_32:
        _os_log_impl(&dword_19BF1F000, v47, v48, v46, buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v44, OS_LOG_TYPE_DEBUG))
    {
      *buf = 138412290;
      v77 = v42;
      v46 = "Deleted keywords: %@";
      v47 = v45;
      v48 = OS_LOG_TYPE_DEBUG;
      goto LABEL_32;
    }
  }

  objc_autoreleasePoolPop(context);
  return v58 & 1;
}

void __45__PLModelMigrator__fixKeywordsInStagedStore___block_invoke(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = [v3 valueForKey:{@"assetAttributes", 0}];
  v5 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    do
    {
      v8 = 0;
      do
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = [*(*(&v12 + 1) + 8 * v8) mutableSetValueForKey:@"keywords"];
        [v9 addObject:*(a1 + 32)];

        ++v8;
      }

      while (v6 != v8);
      v6 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v6);
  }

  v10 = *(a1 + 40);
  v11 = [v3 objectID];
  [v10 addObject:v11];
}

- (BOOL)_fixFaceAlgorithmVersion:(id)a3
{
  v20 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixFaceAlgorithmVersion:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLDetectedFace entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"faceAlgorithmVersion == 0"];
  [v9 setPredicate:v10];

  [v9 setPropertiesToUpdate:&unk_1F0FC0668];
  [v9 setResultType:2];
  v17 = 0;
  v11 = [v6 executeRequest:v9 error:&v17];
  v12 = v17;
  v13 = PLMigrationGetLog();
  v14 = v13;
  if (v11)
  {
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v15 = [v11 result];
      *buf = 138412290;
      v19 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Fixing faceAlgorithmVersion successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v19 = v12;
    _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "Batch update request failed, setting faceAlgorithmVersion from 0 to 2, error: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v11 != 0;
}

- (BOOL)_fixAlbumAndFolderSortAscending:(id)a3
{
  v33 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v22 = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixAlbumAndFolderSortAscending:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"customSortAscending == NO"];
  [v6 setPredicate:v7];
  [v6 setFetchBatchSize:100];
  v8 = [v5 executeFetchRequest:v6 error:0];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v24 objects:v32 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v25;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v25 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v24 + 1) + 8 * i);
        [v13 setCustomSortAscending:1];
        [v13 setCloudLocalState:0];
        [(PLModelMigrator *)self _persistMetadataToFileSystemForAlbum:v13];
      }

      v10 = [v8 countByEnumeratingWithState:&v24 objects:v32 count:16];
    }

    while (v10);
  }

  if ([v5 hasChanges])
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = [v8 count];
      *buf = 134217984;
      v29 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Fixed sort ascending on %lu album", buf, 0xCu);
    }

    v23 = 0;
    v16 = [v5 save:&v23];
    v17 = v23;
    v18 = v22;
    if ((v16 & 1) == 0)
    {
      v19 = PLMigrationGetLog();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = [v17 userInfo];
        *buf = 138412546;
        v29 = v17;
        v30 = 2112;
        v31 = v20;
        _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "_fixAlbumAndFolderSortAscending: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v16 = 1;
    v18 = v22;
  }

  objc_autoreleasePoolPop(v18);
  return v16;
}

- (void)_handleCreateOptionsUsingContext:(id)a3
{
  v14 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [(PLModelMigrator *)self options];
  v6 = v5;
  if (v5)
  {
    v7 = [v5 objectForKeyedSubscript:@"DefaultAlbumUUID"];
    v8 = [v6 objectForKeyedSubscript:@"DefaultAlbumTitle"];
    if (v7)
    {
      v9 = PLMigrationGetLog();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        if (v8)
        {
          v10 = v8;
        }

        else
        {
          v10 = v7;
        }

        v12 = 138412290;
        v13 = v10;
        _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "creating album %@ from migration options", &v12, 0xCu);
      }

      v11 = [(PLGenericAlbum *)PLManagedAlbum insertAlbumWithKind:2 title:v8 uuid:v7 inManagedObjectContext:v4];
    }
  }
}

- (BOOL)_deleteOrphanedUnverifiedPeople:(id)a3
{
  v21 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _deleteOrphanedUnverifiedPeople:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLPerson entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"verifiedType == %d AND faceCount == 0 AND associatedFaceGroup == nil", 0];
  [v9 setPredicate:v10];

  v11 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v9];
  [v11 setResultType:2];
  v18 = 0;
  v12 = [v6 executeRequest:v11 error:&v18];
  v13 = v18;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v12)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = [v12 result];
      *buf = 138412290;
      v20 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "_deleteOrphanedUnverifiedPeople deleted %@ orphaned people", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v20 = v13;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_deleteOrphanedUnverifiedPeople failed: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v12 != 0;
}

- (BOOL)_processDeletesForUUIDs:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 count];
  if (v5)
  {
    v6 = v5;
    v7 = [(PLPhotoLibraryPathManager *)self->_pathManager deletedMemoryUUIDsFilePath];
    v8 = [MEMORY[0x1E696AC08] defaultManager];
    v9 = [v8 fileExistsAtPath:v7];

    if (v9)
    {
      v10 = [MEMORY[0x1E695DEC8] arrayWithContentsOfFile:v7];
      if ([v10 count])
      {
        [v4 addObjectsFromArray:v10];
      }
    }

    v11 = [v4 writeToFile:v7 atomically:1];
    v12 = PLMigrationGetLog();
    v13 = v12;
    if (v11)
    {
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v18 = 134218242;
        v19 = v6;
        v20 = 2112;
        v21 = v7;
        v14 = "Persisted %lu deletedMemoryUUIDs to %@";
        v15 = v13;
        v16 = OS_LOG_TYPE_DEFAULT;
LABEL_12:
        _os_log_impl(&dword_19BF1F000, v15, v16, v14, &v18, 0x16u);
      }
    }

    else if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v18 = 134218242;
      v19 = v6;
      v20 = 2112;
      v21 = v7;
      v14 = "Failed to persist %lu deletedMemoryUUIDs to %@";
      v15 = v13;
      v16 = OS_LOG_TYPE_ERROR;
      goto LABEL_12;
    }

    goto LABEL_14;
  }

  LOBYTE(v11) = 1;
LABEL_14:

  return v11;
}

- (BOOL)_fixMemoriesWithAssetLists:(id)a3
{
  v122 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v69 = objc_autoreleasePoolPush();
  v70 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixMemoriesWithAssetLists:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Memory"];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"representativeAssets.@count > 500"];
  [v6 setPredicate:v7];

  [v6 setFetchBatchSize:100];
  v8 = [MEMORY[0x1E695DF70] array];
  v68 = v6;
  v9 = [v5 executeFetchRequest:v6 error:0];
  v10 = [MEMORY[0x1E695DF90] dictionary];
  v110 = 0u;
  v111 = 0u;
  v112 = 0u;
  v113 = 0u;
  obj = v9;
  v11 = [obj countByEnumeratingWithState:&v110 objects:v121 count:16];
  v96 = v8;
  v80 = v10;
  if (v11)
  {
    v12 = v11;
    v74 = *v111;
    do
    {
      v13 = 0;
      v71 = v12;
      do
      {
        if (*v111 != v74)
        {
          objc_enumerationMutation(obj);
        }

        v81 = v13;
        v14 = *(*(&v110 + 1) + 8 * v13);
        v15 = [v14 valueForKeyPath:@"curatedAssets.objectID"];
        v16 = [v14 valueForKeyPath:@"movieCuratedAssets.objectID"];
        [v14 valueForKeyPath:@"representativeAssets.objectID"];
        v91 = v15;
        v87 = v89 = v16;
        v17 = [MEMORY[0x1E696AEC0] stringWithFormat:@"curated%lu+movie%lu+rep%lu", objc_msgSend(v15, "count"), objc_msgSend(v16, "count"), objc_msgSend(v87, "count")];
        v10 = v80;
        v18 = [v80 objectForKey:v17];
        if (v18)
        {
          v19 = v18;
          v76 = v17;
          v20 = [v18 allKeys];
          v21 = [v20 count];

          v85 = v19;
          if (v21)
          {
            v22 = 0;
            v78 = 0;
            v83 = v14;
            do
            {
              v94 = [MEMORY[0x1E696AEC0] stringWithFormat:@"variant%d", v22];
              v23 = [v19 objectForKey:?];
              if (!v23)
              {
                v23 = [MEMORY[0x1E695DF70] arrayWithObject:v14];
              }

              v24 = [v23 firstObject];
              v25 = [v24 valueForKeyPath:@"curatedAssets.objectID"];
              v26 = [v24 valueForKeyPath:@"movieCuratedAssets.objectID"];
              v27 = [v24 valueForKeyPath:@"representativeAssets.objectID"];
              v93 = v25;
              v28 = [MEMORY[0x1E695DFA8] setWithSet:v25];
              [v28 minusSet:v91];
              v29 = v26;
              v30 = [MEMORY[0x1E695DFA8] setWithSet:v26];
              [v30 minusSet:v89];
              v31 = [MEMORY[0x1E695DFA8] setWithSet:v27];
              [v31 minusSet:v87];
              if (![v28 count] && !objc_msgSend(v30, "count") && !objc_msgSend(v31, "count"))
              {
                [v23 addObject:v83];
                v78 = 1;
              }

              ++v22;
              v19 = v85;
              v32 = [v85 allKeys];
              v33 = [v32 count];

              v14 = v83;
            }

            while (v33 > v22);
            v8 = v96;
            v12 = v71;
            if (v78)
            {
              v10 = v80;
              v34 = v81;
              v17 = v76;
              goto LABEL_21;
            }
          }

          v35 = MEMORY[0x1E696AEC0];
          v36 = [v19 allKeys];
          v37 = [v35 stringWithFormat:@"variant%lu", objc_msgSend(v36, "count")];

          v38 = [MEMORY[0x1E695DF70] arrayWithObject:v14];
          [v19 setObject:v38 forKey:v37];

          v10 = v80;
          v34 = v81;
          v17 = v76;
        }

        else
        {
          v39 = [MEMORY[0x1E695DF90] dictionary];
          [v80 setObject:v39 forKey:v17];
          v37 = [MEMORY[0x1E695DF70] arrayWithObject:v14];
          v85 = v39;
          [v39 setObject:v37 forKey:@"variant0"];
          v34 = v81;
        }

LABEL_21:
        v13 = v34 + 1;
      }

      while (v13 != v12);
      v12 = [obj countByEnumeratingWithState:&v110 objects:v121 count:16];
    }

    while (v12);
  }

  v40 = [(PLModelMigrator *)self isCloudPhotoLibraryEnabled];
  v41 = v10;
  v42 = v40;
  v106 = 0u;
  v107 = 0u;
  v108 = 0u;
  v109 = 0u;
  v72 = [v41 allKeys];
  v77 = [v72 countByEnumeratingWithState:&v106 objects:v120 count:16];
  v43 = 0;
  if (v77)
  {
    v75 = *v107;
    do
    {
      v44 = 0;
      do
      {
        if (*v107 != v75)
        {
          v45 = v44;
          objc_enumerationMutation(v72);
          v44 = v45;
        }

        v79 = v44;
        v46 = [v80 objectForKey:*(*(&v106 + 1) + 8 * v44)];
        v102 = 0u;
        v103 = 0u;
        v104 = 0u;
        v105 = 0u;
        v88 = [v46 allKeys];
        v47 = [v88 countByEnumeratingWithState:&v102 objects:v119 count:16];
        if (v47)
        {
          v48 = v47;
          v49 = *v103;
          v82 = *v103;
          v84 = v46;
          do
          {
            v50 = 0;
            v86 = v48;
            do
            {
              if (*v103 != v49)
              {
                objc_enumerationMutation(v88);
              }

              v51 = [v46 objectForKey:*(*(&v102 + 1) + 8 * v50)];
              if ([v51 count] >= 2)
              {
                v90 = v51;
                v92 = v50;
                v100 = 0u;
                v101 = 0u;
                v98 = 0u;
                v99 = 0u;
                v52 = v51;
                v53 = [v52 countByEnumeratingWithState:&v98 objects:v118 count:16];
                if (v53)
                {
                  v54 = v53;
                  v55 = *v99;
                  do
                  {
                    v95 = v43;
                    for (i = 0; i != v54; ++i)
                    {
                      if (*v99 != v55)
                      {
                        objc_enumerationMutation(v52);
                      }

                      v57 = *(*(&v98 + 1) + 8 * i);
                      if (v42 && [*(*(&v98 + 1) + 8 * i) cloudLocalState] == 1)
                      {
                        v58 = [v57 uuid];
                        if (v58)
                        {
                          [v8 addObject:v58];
                        }

                        else
                        {
                          v59 = PLMigrationGetLog();
                          if (os_log_type_enabled(v59, OS_LOG_TYPE_ERROR))
                          {
                            *buf = 138412290;
                            v115 = v57;
                            _os_log_impl(&dword_19BF1F000, v59, OS_LOG_TYPE_ERROR, "Memory %@ missing uuid", buf, 0xCu);
                          }

                          v8 = v96;
                        }
                      }

                      v60 = [(PLModelMigrator *)self pathManager];
                      [v57 removePersistedFileSystemDataWithPathManager:v60];

                      [v5 deleteObject:v57];
                    }

                    v43 = &v95[v54];
                    v54 = [v52 countByEnumeratingWithState:&v98 objects:v118 count:16];
                  }

                  while (v54);
                }

                v49 = v82;
                v46 = v84;
                v48 = v86;
                v51 = v90;
                v50 = v92;
              }

              ++v50;
            }

            while (v50 != v48);
            v48 = [v88 countByEnumeratingWithState:&v102 objects:v119 count:16];
          }

          while (v48);
        }

        v44 = v79 + 1;
      }

      while (v79 + 1 != v77);
      v77 = [v72 countByEnumeratingWithState:&v106 objects:v120 count:16];
    }

    while (v77);
  }

  v97 = 0;
  v61 = [v5 save:&v97];
  v62 = v97;
  v63 = PLMigrationGetLog();
  v64 = v63;
  if (v61)
  {
    if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v115 = v43;
      _os_log_impl(&dword_19BF1F000, v64, OS_LOG_TYPE_DEFAULT, "_fixMemoriesWithAssetLists deleted %ld", buf, 0xCu);
    }

    v65 = [(PLModelMigrator *)self _processDeletesForUUIDs:v8];
  }

  else
  {
    if (os_log_type_enabled(v63, OS_LOG_TYPE_ERROR))
    {
      v66 = [v62 userInfo];
      *buf = 138412546;
      v115 = v62;
      v116 = 2112;
      v117 = v66;
      _os_log_impl(&dword_19BF1F000, v64, OS_LOG_TYPE_ERROR, "_fixMemoriesWithAssetLists failed: %@ %@", buf, 0x16u);
    }

    v65 = 0;
  }

  [v5 reset];

  objc_autoreleasePoolPop(v69);
  return v65;
}

- (BOOL)_updateKeyAssetInMemory:(id)a3
{
  v42 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _updateKeyAssetInMemory:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Memory"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"keyAsset = nil"];
  [v7 setPredicate:v8];

  [v7 setFetchBatchSize:100];
  v34 = 0;
  v35 = &v34;
  v36 = 0x2020000000;
  v37 = 0;
  v30 = 0;
  v31 = &v30;
  v32 = 0x2020000000;
  v33 = 0;
  v9 = [MEMORY[0x1E695DF70] array];
  objc_initWeak(&location, v9);

  v10 = [v6 executeFetchRequest:v7 error:0];
  v20 = MEMORY[0x1E69E9820];
  v21 = 3221225472;
  v22 = __43__PLModelMigrator__updateKeyAssetInMemory___block_invoke;
  v23 = &unk_1E7568F50;
  v26 = &v34;
  v24 = self;
  objc_copyWeak(&v28, &location);
  v11 = v6;
  v25 = v11;
  v27 = &v30;
  v12 = [v11 enumerateWithIncrementalSaveUsingObjects:v10 withBlock:&v20];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v12 userInfo];
      *buf = 138412546;
      v39 = v12;
      v40 = 2112;
      v41 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_updateKeyAssetInMemory failed: %@ %@", buf, 0x16u);
    }

    v15 = 0;
  }

  else
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v17 = v35[3];
      v18 = v31[3];
      *buf = 134218240;
      v39 = v17;
      v40 = 2048;
      v41 = v18;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "_updateKeyAssetInMemory fixed %ld deleted %ld", buf, 0x16u);
    }

    v13 = objc_loadWeakRetained(&location);
    v15 = [(PLModelMigrator *)self _processDeletesForUUIDs:v13, v20, v21, v22, v23, v24];
  }

  [v11 reset];
  objc_destroyWeak(&v28);

  objc_destroyWeak(&location);
  _Block_object_dispose(&v30, 8);
  _Block_object_dispose(&v34, 8);

  objc_autoreleasePoolPop(v5);
  return v15;
}

void __43__PLModelMigrator__updateKeyAssetInMemory___block_invoke(id *a1, void *a2)
{
  v11 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 calculateKeyAsset];
  if (v4)
  {
    [v3 setKeyAsset:v4];
    v5 = 6;
  }

  else
  {
    if ([a1[4] isCloudPhotoLibraryEnabled] && objc_msgSend(v3, "cloudLocalState") == 1)
    {
      v6 = [v3 uuid];
      if (v6)
      {
        WeakRetained = objc_loadWeakRetained(a1 + 8);
        [WeakRetained addObject:v6];
      }

      else
      {
        WeakRetained = PLMigrationGetLog();
        if (os_log_type_enabled(WeakRetained, OS_LOG_TYPE_ERROR))
        {
          v9 = 138412290;
          v10 = v3;
          _os_log_impl(&dword_19BF1F000, WeakRetained, OS_LOG_TYPE_ERROR, "Memory %@ missing uuid", &v9, 0xCu);
        }
      }
    }

    v8 = [a1[4] pathManager];
    [v3 removePersistedFileSystemDataWithPathManager:v8];

    [a1[5] deleteObject:v3];
    v5 = 7;
  }

  ++*(*(a1[v5] + 1) + 24);
}

- (BOOL)_fixLocallyAvailableFlagForThumbnailsInStore:(id)a3
{
  v46[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v30 = v4;
  v33 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixLocallyAvailableFlagForThumbnailsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v5 = MEMORY[0x1E695D5E0];
  v6 = +[PLCloudResource entityName];
  v34 = [v5 fetchRequestWithEntityName:v6];

  v32 = [MEMORY[0x1E696AE18] predicateWithFormat:@"type == %d AND isLocallyAvailable == YES", 5];
  v7 = MEMORY[0x1E696AB28];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"SUBQUERY(cloudMaster.assets, $asset, $asset.adjustmentsState = %d AND $asset.thumbnailIndex = -1).@count != 0", 0];
  v46[0] = v8;
  v9 = MEMORY[0x1E696AB28];
  v10 = [PLManagedAsset predicateForUnadjustedAssetsWithKeyPathToAsset:@"asset"];
  v45[0] = v10;
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"asset.thumbnailIndex = -1"];
  v45[1] = v11;
  v12 = [MEMORY[0x1E695DEC8] arrayWithObjects:v45 count:2];
  v13 = [v9 andPredicateWithSubpredicates:v12];
  v46[1] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v46 count:2];
  v15 = [v7 orPredicateWithSubpredicates:v14];

  v16 = MEMORY[0x1E696AB28];
  v44[0] = v32;
  v44[1] = v15;
  v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:v44 count:2];
  v18 = [v16 andPredicateWithSubpredicates:v17];

  [v34 setFetchBatchSize:100];
  [v34 setPredicate:v18];
  v19 = [v33 executeFetchRequest:v34 error:0];
  v38 = 0;
  v39 = &v38;
  v40 = 0x2020000000;
  v41 = 0;
  v20 = [MEMORY[0x1E696AC08] defaultManager];
  v35[0] = MEMORY[0x1E69E9820];
  v35[1] = 3221225472;
  v35[2] = __64__PLModelMigrator__fixLocallyAvailableFlagForThumbnailsInStore___block_invoke;
  v35[3] = &unk_1E7568F28;
  v21 = v20;
  v36 = v21;
  v37 = &v38;
  v22 = [v33 enumerateWithIncrementalSaveUsingObjects:v19 withBlock:v35];
  if (v22)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v43 = v22;
      v24 = "Batch update request failed fixing locallyAvailableFlagForThumbnails, error: %@";
      v25 = v23;
      v26 = OS_LOG_TYPE_ERROR;
      v27 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v25, v26, v24, buf, v27);
    }
  }

  else
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v28 = *(v39 + 6);
      *buf = 67109120;
      LODWORD(v43) = v28;
      v24 = "Fixed %d locallyAvailableFlagForThumbnails";
      v25 = v23;
      v26 = OS_LOG_TYPE_DEFAULT;
      v27 = 8;
      goto LABEL_6;
    }
  }

  [v33 reset];
  _Block_object_dispose(&v38, 8);

  objc_autoreleasePoolPop(context);
  return v22 == 0;
}

void __64__PLModelMigrator__fixLocallyAvailableFlagForThumbnailsInStore___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 filePath];
  if ([*(a1 + 32) fileExistsAtPath:v4])
  {
    v5 = *(a1 + 32);
    v9 = 0;
    v6 = [v5 removeItemAtPath:v4 error:&v9];
    v7 = v9;
    if ((v6 & 1) == 0)
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v11 = v3;
        v12 = 2112;
        v13 = v7;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_ERROR, "Failed to remove thumbnail resource for %@: %@", buf, 0x16u);
      }
    }
  }

  [v3 setIsLocallyAvailable:0];
  ++*(*(*(a1 + 40) + 8) + 24);
}

- (BOOL)_fixLastPrefetchDateInStore:(id)a3
{
  v23[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixLastPrefetchDateInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLCloudResource entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"lastPrefetchDate == %@", @"<null>"];
  [v9 setPredicate:v10];

  v22 = @"lastPrefetchDate";
  v11 = [MEMORY[0x1E695DF00] dateWithTimeIntervalSinceReferenceDate:0.0];
  v23[0] = v11;
  v12 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v23 forKeys:&v22 count:1];
  [v9 setPropertiesToUpdate:v12];

  [v9 setResultType:2];
  v19 = 0;
  v13 = [v6 executeRequest:v9 error:&v19];
  v14 = v19;
  v15 = PLMigrationGetLog();
  v16 = v15;
  if (v13)
  {
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = [v13 result];
      *buf = 138412290;
      v21 = v17;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Fixing lastPrefetchDate successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v21 = v14;
    _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "Batch update request failed fixing lastPrefetchDate, error: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v13 != 0;
}

- (BOOL)_removeCameraRollInStore:(id)a3
{
  v25 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removeCameraRollInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind = %d", 1000];
  [v7 setPredicate:v8];

  v22 = 0;
  v9 = [v6 executeFetchRequest:v7 error:&v22];
  v10 = v22;
  v20[0] = MEMORY[0x1E69E9820];
  v20[1] = 3221225472;
  v20[2] = __44__PLModelMigrator__removeCameraRollInStore___block_invoke;
  v20[3] = &unk_1E7568F00;
  v21 = v6;
  v11 = v6;
  v12 = [v11 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:v20];
  v13 = PLMigrationGetLog();
  v14 = v13;
  if (v12)
  {
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v24 = v12;
      v15 = "Failed to delete camera roll: %@";
      v16 = v14;
      v17 = OS_LOG_TYPE_ERROR;
      v18 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v16, v17, v15, buf, v18);
    }
  }

  else if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    v15 = "Deleted camera roll";
    v16 = v14;
    v17 = OS_LOG_TYPE_DEFAULT;
    v18 = 2;
    goto LABEL_6;
  }

  [v11 reset];
  objc_autoreleasePoolPop(v5);

  return v12 == 0;
}

- (BOOL)_applyDataProtectionToDCIMFromClassBToClassC
{
  v7[1] = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 photoDirectoryWithType:4];

  v7[0] = v4;
  v5 = [MEMORY[0x1E695DEC8] arrayWithObjects:v7 count:1];
  [(PLModelMigrator *)self applyDataProtectionToPhotosPaths:v5 fromKeyClass:2 toKeyClass:3];

  return 1;
}

- (BOOL)_deleteAllMemoriesInStore:(id)a3
{
  v39 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _deleteAllMemoriesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Memory"];
  [v6 setFetchBatchSize:100];
  v7 = [MEMORY[0x1E695DF70] arrayWithCapacity:100];
  objc_initWeak(&location, v7);

  v30 = 0;
  v31 = &v30;
  v32 = 0x2020000000;
  v33 = 0;
  v8 = [v5 executeFetchRequest:v6 error:0];
  v9 = [(PLModelMigrator *)self isCloudPhotoLibraryEnabled];
  v25[0] = MEMORY[0x1E69E9820];
  v25[1] = 3221225472;
  v25[2] = __45__PLModelMigrator__deleteAllMemoriesInStore___block_invoke;
  v25[3] = &unk_1E7568ED8;
  v29 = v9;
  objc_copyWeak(&v28, &location);
  v10 = v5;
  v26 = v10;
  v27 = &v30;
  v11 = [v10 enumerateWithIncrementalSaveUsingObjects:v8 withBlock:v25];
  if (v11)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v36 = v11;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "Failed to delete memories: %@", buf, 0xCu);
    }

    goto LABEL_14;
  }

  v13 = PLMigrationGetLog();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v14 = *(v31 + 6);
    *buf = 67109120;
    LODWORD(v36) = v14;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Deleted %d memories", buf, 8u);
  }

  v15 = objc_loadWeakRetained(&location);
  v16 = [v15 count];

  if (v16)
  {
    v12 = [(PLPhotoLibraryPathManager *)self->_pathManager deletedMemoryUUIDsFilePath];
    v17 = objc_loadWeakRetained(&location);
    v18 = [v17 writeToFile:v12 atomically:1];

    if (v18)
    {
      v19 = PLMigrationGetLog();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134218242;
        v36 = v16;
        v37 = 2112;
        v38 = v12;
        v20 = "Persisted %lu deletedMemoryUUIDs to %@";
        v21 = v19;
        v22 = OS_LOG_TYPE_DEFAULT;
LABEL_12:
        _os_log_impl(&dword_19BF1F000, v21, v22, v20, buf, 0x16u);
      }
    }

    else
    {
      v19 = PLMigrationGetLog();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        *buf = 134218242;
        v36 = v16;
        v37 = 2112;
        v38 = v12;
        v20 = "Failed to persist %lu deletedMemoryUUIDs to %@";
        v21 = v19;
        v22 = OS_LOG_TYPE_ERROR;
        goto LABEL_12;
      }
    }

LABEL_14:
  }

  [v10 reset];

  objc_destroyWeak(&v28);
  _Block_object_dispose(&v30, 8);
  objc_destroyWeak(&location);

  objc_autoreleasePoolPop(context);
  return v11 == 0;
}

void __45__PLModelMigrator__deleteAllMemoriesInStore___block_invoke(uint64_t a1, void *a2)
{
  v9 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = v3;
  if (*(a1 + 56) == 1 && [v3 cloudLocalState] == 1)
  {
    v5 = [v4 uuid];
    if (v5)
    {
      WeakRetained = objc_loadWeakRetained((a1 + 48));
      [WeakRetained addObject:v5];
    }

    else
    {
      WeakRetained = PLMigrationGetLog();
      if (os_log_type_enabled(WeakRetained, OS_LOG_TYPE_ERROR))
      {
        v7 = 138412290;
        v8 = v4;
        _os_log_impl(&dword_19BF1F000, WeakRetained, OS_LOG_TYPE_ERROR, "Memory %@ missing uuid", &v7, 0xCu);
      }
    }
  }

  [*(a1 + 32) deleteObject:v4];
  ++*(*(*(a1 + 40) + 8) + 24);
}

- (BOOL)_fixCustomRenderedValues:(id)a3
{
  v30 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixCustomRenderedValues:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AE18];
  v11 = [(PLModelMigrator *)self _dateForFirstCRVSPhoto];
  v12 = [*MEMORY[0x1E6982E58] identifier];
  v13 = [v10 predicateWithFormat:@"dateCreated >= %@ AND %K == %@ AND uniformTypeIdentifier == %@", v11, @"hdrType", &unk_1F0FBBE00, v12];
  [v9 setPredicate:v13];

  [v9 setFetchBatchSize:100];
  v24 = 0;
  v25 = &v24;
  v26 = 0x2020000000;
  v27 = 0;
  v14 = [v6 executeFetchRequest:v9 error:0];
  v23[0] = MEMORY[0x1E69E9820];
  v23[1] = 3221225472;
  v23[2] = __44__PLModelMigrator__fixCustomRenderedValues___block_invoke;
  v23[3] = &unk_1E7568EB0;
  v23[4] = &v24;
  v15 = [v6 enumerateWithIncrementalSaveUsingObjects:v14 withBlock:v23];
  if (v15)
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v29 = v15;
      v17 = "Failed to fix custom rendered value: %@";
      v18 = v16;
      v19 = OS_LOG_TYPE_ERROR;
      v20 = 12;
LABEL_6:
      _os_log_impl(&dword_19BF1F000, v18, v19, v17, buf, v20);
    }
  }

  else
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v21 = *(v25 + 6);
      *buf = 67109120;
      LODWORD(v29) = v21;
      v17 = "Fixed %d custom rendered value";
      v18 = v16;
      v19 = OS_LOG_TYPE_DEFAULT;
      v20 = 8;
      goto LABEL_6;
    }
  }

  [v6 reset];
  _Block_object_dispose(&v24, 8);

  objc_autoreleasePoolPop(v5);
  return v15 == 0;
}

void __44__PLModelMigrator__fixCustomRenderedValues___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [v3 metadataFromMediaPropertiesOrOriginalResource];
  [v3 setDepthTypeFromMetadata:v4];

  ++*(*(*(a1 + 32) + 8) + 24);
}

- (id)_dateForFirstCRVSPhoto
{
  v2 = [MEMORY[0x1E695DEE8] currentCalendar];
  v3 = objc_alloc_init(MEMORY[0x1E695DF10]);
  [v3 setYear:2016];
  [v3 setMonth:5];
  [v3 setDay:1];
  v4 = [v2 dateFromComponents:v3];

  return v4;
}

- (BOOL)_flattenUnknownCustomRenderedValues:(id)a3
{
  v22[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _flattenUnknownCustomRenderedValues:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D560];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 batchUpdateRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %@", @"hdrType", &unk_1F0FBBDE8];
  [v9 setPredicate:v10];

  v21 = @"hdrType";
  v22[0] = &unk_1F0FBBE00;
  v11 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v22 forKeys:&v21 count:1];
  [v9 setPropertiesToUpdate:v11];

  [v9 setResultType:2];
  v18 = 0;
  v12 = [v6 executeRequest:v9 error:&v18];
  v13 = v18;
  v14 = PLMigrationGetLog();
  v15 = v14;
  if (v12)
  {
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v16 = [v12 result];
      *buf = 138412290;
      v20 = v16;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Flattened assets successful with result %@", buf, 0xCu);
    }
  }

  else if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    *buf = 138412290;
    v20 = v13;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Batch update request failed, flattening custom rendered values from 1 to 0, error: %@", buf, 0xCu);
  }

  [v6 reset];
  objc_autoreleasePoolPop(v5);

  return v12 != 0;
}

- (BOOL)_populateNilOriginalFilename:(id)a3
{
  v26 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateNilOriginalFilename:]" concurrencyType:*MEMORY[0x1E695D708]];
  v18 = 0;
  v19 = &v18;
  v20 = 0x2020000000;
  v21 = 0;
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF8B0];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.originalFilename == nil"];
  [v9 setPredicate:v10];

  v11 = [v6 executeFetchRequest:v9 error:0];
  v17[0] = MEMORY[0x1E69E9820];
  v17[1] = 3221225472;
  v17[2] = __48__PLModelMigrator__populateNilOriginalFilename___block_invoke;
  v17[3] = &unk_1E7568EB0;
  v17[4] = &v18;
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:v17];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v12 userInfo];
      *buf = 138412546;
      v23 = v12;
      v24 = 2112;
      v25 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_populateNilOriginalFilename: failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v15 = *(v19 + 6);
      *buf = 67109120;
      LODWORD(v23) = v15;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Fixed %d originalFilenames", buf, 8u);
    }
  }

  _Block_object_dispose(&v18, 8);
  objc_autoreleasePoolPop(v5);

  return v12 == 0;
}

void __48__PLModelMigrator__populateNilOriginalFilename___block_invoke(uint64_t a1, void *a2)
{
  v7 = a2;
  v3 = [v7 cloudAssetGUID];
  if (v3)
  {
    v4 = MEMORY[0x1E696AEC0];
    v5 = [v7 fileExtension];
    v6 = [v4 stringWithFormat:@"%@.%@", v3, v5];

    [v7 setOriginalFilename:v6];
    [v7 persistMetadataToFilesystem];
    ++*(*(*(a1 + 32) + 8) + 24);
  }
}

- (BOOL)_populateNilOriginalFilenameOnMaster:(id)a3
{
  v20 = *MEMORY[0x1E69E9840];
  v4 = a3;
  if ([(PLModelMigrator *)self isCloudPhotoLibraryEnabled])
  {
    pl_dispatch_once();
    v5 = objc_autoreleasePoolPush();
    v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateNilOriginalFilenameOnMaster:]" concurrencyType:*MEMORY[0x1E695D708]];
    v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
    v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"originalFilename == nil"];
    [v7 setPredicate:v8];
    [v7 setFetchBatchSize:100];
    v9 = [v6 executeFetchRequest:v7 error:0];
    v10 = [v6 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:&__block_literal_global_1674];
    v11 = v10 == 0;
    v12 = PLMigrationGetLog();
    v13 = v12;
    if (v10)
    {
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v14 = [v10 userInfo];
        v16 = 138412546;
        v17 = v10;
        v18 = 2112;
        v19 = v14;
        _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_populateNilOriginalFilenameOnMaster: failed: %@ %@", &v16, 0x16u);
      }
    }

    else if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v16 = 134217984;
      v17 = [v9 count];
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Fix %lu cloudMaster nil original filename", &v16, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
  }

  else
  {
    v11 = 1;
  }

  return v11;
}

void __56__PLModelMigrator__populateNilOriginalFilenameOnMaster___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 assets];
  v4 = [v3 allObjects];
  v6 = [v4 firstObject];

  v5 = [v6 originalFilename];
  [v2 setOriginalFilename:v5];

  [v2 setCloudLocalState:0];
}

- (BOOL)_removeOldPersonMetadataInStore:(id)a3
{
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = MEMORY[0x1E695DFF8];
  v7 = [(PLModelMigrator *)self pathManager];
  v8 = [v7 privateDirectoryWithSubType:4 createIfNeeded:1 error:0];
  v9 = [v6 fileURLWithPath:v8 isDirectory:1];

  LOBYTE(v7) = [PLPhotoLibrary removeFaceMetadataAtURL:v9 includingPeople:1];
  objc_autoreleasePoolPop(v5);

  return v7;
}

- (BOOL)_persistPersonsInStore:(id)a3
{
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _persistPersonsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = +[PLPerson fetchRequest];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"verifiedType", 0];
  [v7 setPredicate:v8];

  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = __42__PLModelMigrator__persistPersonsInStore___block_invoke;
  v11[3] = &unk_1E7572300;
  v11[4] = self;
  v9 = [v6 enumerateObjectsFromFetchRequest:v7 count:0 usingDefaultBatchSizeWithBlock:v11];

  objc_autoreleasePoolPop(v5);
  return 1;
}

void __42__PLModelMigrator__persistPersonsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 pathManager];
  [v3 persistMetadataToFileSystemWithPathManager:v4];
}

- (BOOL)_persistMemoriesInStore:(id)a3
{
  v13[3] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _persistMemoriesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Memory"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != %d", @"pendingState", 1];
  [v7 setPredicate:v8];

  v13[0] = @"curatedAssets";
  v13[1] = @"representativeAssets";
  v13[2] = @"movieCuratedAssets";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v13 count:3];
  [v7 setRelationshipKeyPathsForPrefetching:v9];

  v12[0] = MEMORY[0x1E69E9820];
  v12[1] = 3221225472;
  v12[2] = __43__PLModelMigrator__persistMemoriesInStore___block_invoke;
  v12[3] = &unk_1E7568E88;
  v12[4] = self;
  v10 = [v6 enumerateObjectsFromFetchRequest:v7 count:0 usingDefaultBatchSizeWithBlock:v12];
  [v6 reset];

  objc_autoreleasePoolPop(v5);
  return 1;
}

void __43__PLModelMigrator__persistMemoriesInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 pathManager];
  [v3 persistMetadataToFileSystemWithPathManager:v4];
}

- (BOOL)_populateLatLongInAsset:(id)a3
{
  v20 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateLatLongInAsset:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"locationData != NULL"];
  [v9 setPredicate:v10];

  [v9 setFetchBatchSize:100];
  v11 = [v6 executeFetchRequest:v9 error:0];
  v12 = [v6 enumerateWithIncrementalSaveUsingObjects:v11 withBlock:&__block_literal_global_1649];
  if (v12)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = [v12 userInfo];
      v16 = 138412546;
      v17 = v12;
      v18 = 2112;
      v19 = v14;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "_populateLatLongInAsset failed: %@ %@", &v16, 0x16u);
    }
  }

  objc_autoreleasePoolPop(v5);
  return v12 == 0;
}

void __43__PLModelMigrator__populateLatLongInAsset___block_invoke(uint64_t a1, void *a2)
{
  v11 = a2;
  v2 = [v11 locationData];

  if (v2)
  {
    v3 = [v11 locationData];
    v4 = [v11 dateCreated];
    v5 = [PLManagedAsset newLocationFromLocationData:v3 timestampIfMissing:v4];

    v6 = MEMORY[0x1E696AD98];
    [v5 coordinate];
    v7 = [v6 numberWithDouble:?];
    [v11 setValue:v7 forKey:@"latitude"];

    v8 = MEMORY[0x1E696AD98];
    [v5 coordinate];
    v10 = [v8 numberWithDouble:v9];
    [v11 setValue:v10 forKey:@"longitude"];
  }
}

- (BOOL)_populateRepresentativeAssets:(id)a3
{
  v19[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateRepresentativeAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Memory"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"representativeAssets.@count = 0 && curatedAssets.@count > 0"];
  [v7 setPredicate:v8];

  v19[0] = @"curatedAssets";
  v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:v19 count:1];
  [v7 setRelationshipKeyPathsForPrefetching:v9];

  [v7 setFetchBatchSize:100];
  v10 = [v6 executeFetchRequest:v7 error:0];
  v11 = [v6 enumerateWithIncrementalSaveUsingObjects:v10 withBlock:&__block_literal_global_1641];
  if (v11)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = [v11 userInfo];
      v15 = 138412546;
      v16 = v11;
      v17 = 2112;
      v18 = v13;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_fixupCloudResourcesInStore failed: %@ %@", &v15, 0x16u);
    }
  }

  objc_autoreleasePoolPop(v5);
  return v11 == 0;
}

void __49__PLModelMigrator__populateRepresentativeAssets___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [v2 curatedAssets];
  [v2 setValue:v3 forKey:@"representativeAssets"];
}

- (BOOL)_fixCloudMasterCloudLocalState:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixCloudMasterCloudLocalState:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 0];
  [v7 setPredicate:v8];
  [v7 setFetchBatchSize:100];
  v9 = [v6 executeFetchRequest:v7 error:0];
  v10 = [v6 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:&__block_literal_global_1629];
  v11 = PLMigrationGetLog();
  v12 = v11;
  if (v10)
  {
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v13 = [v10 userInfo];
      *buf = 138412546;
      v16 = v10;
      v17 = 2112;
      v18 = v13;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_fixCloudMasterCloudLocalState: failed: %@ %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v16 = [v9 count];
    _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Fix %lu cloudMaster cloudLocalState", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  return v10 == 0;
}

void __50__PLModelMigrator__fixCloudMasterCloudLocalState___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v2 = [v5 assets];
  v3 = [v2 allObjects];
  v4 = [v3 firstObject];

  if (v4 && [v4 cloudLocalState])
  {
    [v5 setCloudLocalState:{objc_msgSend(v4, "cloudLocalState")}];
  }
}

- (BOOL)_resetUploadAttempts:(id)a3
{
  v25[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _resetUploadAttempts:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"additionalAttributes.uploadAttempts > 0"];
  v11 = MEMORY[0x1E696AB28];
  v25[0] = v10;
  v12 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  v25[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v25 count:2];
  v14 = [v11 andPredicateWithSubpredicates:v13];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF898];
  [v9 setPredicate:v14];
  [v9 setFetchBatchSize:100];
  v15 = [v6 executeFetchRequest:v9 error:0];
  v16 = [v6 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:&__block_literal_global_1627];
  v17 = PLMigrationGetLog();
  v18 = v17;
  if (v16)
  {
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v19 = [v16 userInfo];
      v21 = 138412546;
      v22 = v16;
      v23 = 2112;
      v24 = v19;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "_resetUploadAttempts: failed: %@ %@", &v21, 0x16u);
    }
  }

  else if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    v21 = 134217984;
    v22 = [v15 count];
    _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Reset %lu upload attempts", &v21, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  return v16 == 0;
}

void __40__PLModelMigrator__resetUploadAttempts___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 setUploadAttempts:0];
  [v2 setLastUploadAttemptDate:0];
  [v2 setCloudLocalState:0];
}

- (BOOL)_resetFailedCloudMasters:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _resetFailedCloudMasters:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 2];
  [v7 setPredicate:v8];
  [v7 setFetchBatchSize:100];
  v9 = [v6 executeFetchRequest:v7 error:0];
  v10 = [v6 enumerateWithIncrementalSaveUsingObjects:v9 withBlock:&__block_literal_global_1619];
  v11 = PLMigrationGetLog();
  v12 = v11;
  if (v10)
  {
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v13 = [v10 userInfo];
      *buf = 138412546;
      v16 = v10;
      v17 = 2112;
      v18 = v13;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_resetFailedCloudMasters failed: %@ %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v16 = [v9 count];
    _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "Reset %lu failed masters", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  return v10 == 0;
}

- (BOOL)_resetFailedAssets:(id)a3
{
  v25[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _resetFailedAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"cloudLocalState == %d", 2];
  v11 = MEMORY[0x1E696AB28];
  v25[0] = v10;
  v12 = +[PLManagedAsset predicateForSupportedAssetTypesForUpload];
  v25[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v25 count:2];
  v14 = [v11 andPredicateWithSubpredicates:v13];

  [v9 setPredicate:v14];
  [v9 setFetchBatchSize:100];
  v15 = [v6 executeFetchRequest:v9 error:0];
  v16 = [v6 enumerateWithIncrementalSaveUsingObjects:v15 withBlock:&__block_literal_global_1616];
  v17 = PLMigrationGetLog();
  v18 = v17;
  if (v16)
  {
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v19 = [v16 userInfo];
      *buf = 138412546;
      v22 = v16;
      v23 = 2112;
      v24 = v19;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "_resetFailedAssets: failed: %@ %@", buf, 0x16u);
    }
  }

  else if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v22 = [v15 count];
    _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Reset %lu failed assets", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  return v16 == 0;
}

void __38__PLModelMigrator__resetFailedAssets___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 setUploadAttempts:0];
  [v2 setLastUploadAttemptDate:0];
  [v2 setCloudLocalState:0];
}

- (BOOL)_fixVideoJPGPath:(id)a3
{
  v78 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v41 = objc_autoreleasePoolPush();
  v42 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixVideoJPGPath:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  [v6 setFetchBatchSize:100];
  v39 = v6;
  v40 = v5;
  [v5 executeFetchRequest:v6 error:0];
  v66 = 0u;
  v67 = 0u;
  v68 = 0u;
  obj = v69 = 0u;
  v46 = [obj countByEnumeratingWithState:&v66 objects:v77 count:16];
  if (v46)
  {
    v45 = *v67;
    v44 = *MEMORY[0x1E6982EE8];
    do
    {
      v7 = 0;
      do
      {
        if (*v67 != v45)
        {
          objc_enumerationMutation(obj);
        }

        v48 = v7;
        v8 = *(*(&v66 + 1) + 8 * v7);
        context = objc_autoreleasePoolPush();
        v9 = MEMORY[0x1E69C08F0];
        v10 = [v8 uniformTypeIdentifier];
        v11 = [v9 typeWithIdentifier:v10];
        v12 = [v11 conformsToType:v44];

        if (v12)
        {
          v64 = 0u;
          v65 = 0u;
          v62 = 0u;
          v63 = 0u;
          v49 = [v8 assets];
          v51 = [v49 countByEnumeratingWithState:&v62 objects:v76 count:16];
          if (v51)
          {
            v50 = *v63;
            while (2)
            {
              v13 = 0;
              do
              {
                if (*v63 != v50)
                {
                  objc_enumerationMutation(v49);
                }

                v14 = *(*(&v62 + 1) + 8 * v13);
                if ([v14 kind] != 1)
                {
                  v31 = PLMigrationGetLog();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
                  {
                    v32 = [v14 uuid];
                    v33 = [v8 scopedIdentifier];
                    *buf = 138412546;
                    v73 = v32;
                    v74 = 2112;
                    v75 = v33;
                    _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: asset %@ kind is showing that this is not a video while the master %@ uti thinks it is.", buf, 0x16u);
                  }

                  goto LABEL_38;
                }

                v52 = v13;
                v60 = 0u;
                v61 = 0u;
                v58 = 0u;
                v59 = 0u;
                v15 = [&unk_1F0FBF880 countByEnumeratingWithState:&v58 objects:v71 count:16];
                if (v15)
                {
                  v16 = v15;
                  v17 = *v59;
                  do
                  {
                    for (i = 0; i != v16; ++i)
                    {
                      if (*v59 != v17)
                      {
                        objc_enumerationMutation(&unk_1F0FBF880);
                      }

                      v19 = *(*(&v58 + 1) + 8 * i);
                      v20 = [v19 unsignedIntegerValue];
                      v21 = [v14 uuid];
                      v22 = [PLCloudResource cloudResourceForResourceType:v20 forAssetUuid:v21 forCloudMaster:v8];

                      if (v22)
                      {
                        v23 = [v14 pathForCPLResourceType:objc_msgSend(v19 adjusted:{"unsignedIntegerValue"), 0}];
                        [(PLModelMigrator *)self _fixPathForResource:v22 withPath:v23];
                      }
                    }

                    v16 = [&unk_1F0FBF880 countByEnumeratingWithState:&v58 objects:v71 count:16];
                  }

                  while (v16);
                }

                if ([v14 hasAdjustments])
                {
                  v56 = 0u;
                  v57 = 0u;
                  v54 = 0u;
                  v55 = 0u;
                  v24 = [&unk_1F0FBF880 countByEnumeratingWithState:&v54 objects:v70 count:16];
                  if (v24)
                  {
                    v25 = v24;
                    v26 = *v55;
                    do
                    {
                      for (j = 0; j != v25; ++j)
                      {
                        if (*v55 != v26)
                        {
                          objc_enumerationMutation(&unk_1F0FBF880);
                        }

                        v28 = *(*(&v54 + 1) + 8 * j);
                        v29 = +[PLCloudResource legacyCloudResourceForResourceType:forAsset:](PLCloudResource, "legacyCloudResourceForResourceType:forAsset:", [v28 unsignedIntegerValue], v14);
                        if (v29)
                        {
                          v30 = [v14 pathForCPLResourceType:objc_msgSend(v28 adjusted:{"unsignedIntegerValue"), 1}];
                          [(PLModelMigrator *)self _fixPathForResource:v29 withPath:v30];
                        }
                      }

                      v25 = [&unk_1F0FBF880 countByEnumeratingWithState:&v54 objects:v70 count:16];
                    }

                    while (v25);
                  }
                }

                v13 = v52 + 1;
              }

              while (v52 + 1 != v51);
              v51 = [v49 countByEnumeratingWithState:&v62 objects:v76 count:16];
              if (v51)
              {
                continue;
              }

              break;
            }
          }

LABEL_38:
        }

        objc_autoreleasePoolPop(context);
        v7 = v48 + 1;
      }

      while (v48 + 1 != v46);
      v46 = [obj countByEnumeratingWithState:&v66 objects:v77 count:16];
    }

    while (v46);
  }

  if ([v40 hasChanges])
  {
    v53 = 0;
    v34 = [v40 save:&v53];
    v35 = v53;
    if ((v34 & 1) == 0)
    {
      v36 = PLMigrationGetLog();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
      {
        v37 = [v35 userInfo];
        *buf = 138412546;
        v73 = v35;
        v74 = 2112;
        v75 = v37;
        _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v34 = 1;
  }

  objc_autoreleasePoolPop(v41);
  return v34;
}

- (void)_fixPathForResource:(id)a3 withPath:(id)a4
{
  v15 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if (v7)
  {
    v8 = [v6 filePath];
    v9 = v8;
    if (v8)
    {
      if (([v8 isEqualToString:v7]& 1) != 0)
      {
LABEL_13:
        [v6 setIsLocallyAvailable:{-[PLModelMigrator _validateOrDeleteFileAtPath:forCloudResource:](self, "_validateOrDeleteFileAtPath:forCloudResource:", v7, v6)}];
        goto LABEL_14;
      }

      [v6 setFilePath:v7];
      v10 = [MEMORY[0x1E696AC08] defaultManager];
      if ([v10 fileExistsAtPath:v9])
      {
        if (![(PLModelMigrator *)self _validateOrDeleteFileAtPath:v7 forCloudResource:v6])
        {
          [v10 moveItemAtPath:v9 toPath:v7 error:0];
        }

        [v10 removeItemAtPath:v9 error:0];
      }
    }

    else
    {
      [v6 setFilePath:v7];
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = 138412546;
        v12 = v6;
        v13 = 2112;
        v14 = v7;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: resource %@, found nil resourcePath, setting to corrected path %@", &v11, 0x16u);
      }
    }

    goto LABEL_13;
  }

  v9 = PLMigrationGetLog();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    v11 = 138412290;
    v12 = v6;
    _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: can't correct cloudResource %@ path to nil", &v11, 0xCu);
  }

LABEL_14:
}

- (BOOL)_validateOrDeleteFileAtPath:(id)a3 forCloudResource:(id)a4
{
  v22 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = [MEMORY[0x1E696AC08] defaultManager];
  if ([v8 fileExistsAtPath:v6])
  {
    v9 = [MEMORY[0x1E695DFF8] fileURLWithPath:v6 isDirectory:0];
    v17 = 0;
    v10 = [v9 getResourceValue:&v17 forKey:*MEMORY[0x1E695DB50] error:0];
    v11 = v17;
    v12 = v11;
    if (v10)
    {
      v13 = [v11 integerValue];
      if (v13 == [v7 fileSize])
      {
        v14 = 1;
LABEL_10:

        goto LABEL_11;
      }
    }

    else
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v19 = v7;
        v20 = 2112;
        v21 = v6;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: resource %@ can't get the fileSize for file at path %@", buf, 0x16u);
      }
    }

    [(PLModelMigrator *)self _removeFileAt:v6 forResource:v7];
    v14 = 0;
    goto LABEL_10;
  }

  v14 = 0;
LABEL_11:

  return v14;
}

- (void)_removeFileAt:(id)a3 forResource:(id)a4
{
  v18 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  if (v5)
  {
    v7 = [MEMORY[0x1E696AC08] defaultManager];
    v8 = [v7 removeItemAtPath:v5 error:0];
    v9 = PLMigrationGetLog();
    v10 = v9;
    if (v8)
    {
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        v14 = 138412546;
        v15 = v6;
        v16 = 2112;
        v17 = v5;
        v11 = "_fixVideoJPGPath: resource %@ removing file at: %@";
        v12 = v10;
        v13 = OS_LOG_TYPE_DEFAULT;
LABEL_9:
        _os_log_impl(&dword_19BF1F000, v12, v13, v11, &v14, 0x16u);
      }
    }

    else if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v14 = 138412546;
      v15 = v6;
      v16 = 2112;
      v17 = v5;
      v11 = "_fixVideoJPGPath: resource %@, can't delete resource from %@";
      v12 = v10;
      v13 = OS_LOG_TYPE_ERROR;
      goto LABEL_9;
    }

    goto LABEL_11;
  }

  v7 = PLMigrationGetLog();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
  {
    v14 = 138412290;
    v15 = v6;
    _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_ERROR, "_fixVideoJPGPath: resource %@, can't delete resource from nil path", &v14, 0xCu);
  }

LABEL_11:
}

- (BOOL)_fixNonDuplicatedAssets:(id)a3 adjusted:(BOOL)a4
{
  v4 = a4;
  v77[2] = *MEMORY[0x1E69E9840];
  v6 = a3;
  v64 = objc_autoreleasePoolPush();
  v65 = v6;
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v6 name:"[PLModelMigrator _fixNonDuplicatedAssets:adjusted:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(SUBQUERY(assets, $att, $att.adjustmentsState != %d).@count != 0)", 0];
  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(SUBQUERY(assets, $att, $att.adjustmentsState == %d).@count == 0)", 0];
  v11 = MEMORY[0x1E696AB28];
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"assets.@count == 1"];
  v13 = v12;
  v60 = v10;
  v61 = v9;
  if (v4)
  {
    v14 = v9;
  }

  else
  {
    v14 = v10;
  }

  v77[0] = v12;
  v77[1] = v14;
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:v77 count:2];
  v16 = [v11 andPredicateWithSubpredicates:v15];

  v59 = v16;
  [v8 setPredicate:v16];
  v62 = v8;
  v63 = v7;
  [v7 executeFetchRequest:v8 error:0];
  v68 = 0u;
  v69 = 0u;
  v70 = 0u;
  obj = v71 = 0u;
  v17 = [obj countByEnumeratingWithState:&v68 objects:v76 count:16];
  if (v17)
  {
    v18 = v17;
    v19 = *v69;
    do
    {
      for (i = 0; i != v18; ++i)
      {
        if (*v69 != v19)
        {
          objc_enumerationMutation(obj);
        }

        v21 = *(*(&v68 + 1) + 8 * i);
        v22 = objc_autoreleasePoolPush();
        v23 = [v21 assets];
        v24 = [v23 anyObject];

        v25 = [PLCloudResource cloudResourcesForResourceType:5 forCloudMaster:v21];
        v26 = [v25 firstObject];

        if (v26)
        {
          v27 = [v24 uuid];
          [v26 setAssetUuid:v27];
        }

        v28 = [PLCloudResource cloudResourcesForResourceType:4 forCloudMaster:v21];
        v29 = [v28 firstObject];

        if (v29)
        {
          v30 = [v24 uuid];
          [v29 setAssetUuid:v30];
        }

        v31 = [PLCloudResource cloudResourcesForResourceType:3 forCloudMaster:v21];
        v32 = [v31 firstObject];

        if (v32)
        {
          v33 = [v24 uuid];
          [v32 setAssetUuid:v33];
        }

        v34 = [PLCloudResource cloudResourcesForResourceType:2 forCloudMaster:v21];
        v35 = [v34 firstObject];

        if (v35)
        {
          v36 = [v24 uuid];
          [v35 setAssetUuid:v36];
        }

        v37 = [PLCloudResource cloudResourcesForResourceType:7 forCloudMaster:v21];
        v38 = [v37 firstObject];

        if (v38)
        {
          v39 = [v24 uuid];
          [v38 setAssetUuid:v39];
        }

        v40 = [PLCloudResource cloudResourcesForResourceType:6 forCloudMaster:v21];
        v41 = [v40 firstObject];

        if (v41)
        {
          v42 = [v24 uuid];
          [v41 setAssetUuid:v42];
        }

        v43 = [PLCloudResource cloudResourcesForResourceType:1 forCloudMaster:v21];
        v44 = [v43 firstObject];

        if (v44)
        {
          v45 = [v24 uuid];
          [v44 setAssetUuid:v45];
        }

        v46 = [PLCloudResource cloudResourcesForResourceType:17 forCloudMaster:v21];
        v47 = [v46 firstObject];

        if (v47)
        {
          v48 = [v24 uuid];
          [v47 setAssetUuid:v48];
        }

        objc_autoreleasePoolPop(v22);
      }

      v18 = [obj countByEnumeratingWithState:&v68 objects:v76 count:16];
    }

    while (v18);
  }

  if ([v63 hasChanges])
  {
    v67 = 0;
    v49 = [v63 save:&v67];
    v50 = v67;
    v51 = v64;
    v53 = v61;
    v52 = v62;
    v54 = v60;
    if ((v49 & 1) == 0)
    {
      v55 = PLMigrationGetLog();
      if (os_log_type_enabled(v55, OS_LOG_TYPE_ERROR))
      {
        v56 = [v50 userInfo];
        *buf = 138412546;
        v73 = v50;
        v74 = 2112;
        v75 = v56;
        _os_log_impl(&dword_19BF1F000, v55, OS_LOG_TYPE_ERROR, "_fixNonAdjustedNonDuplicatedAssets: failed: %@ %@", buf, 0x16u);
      }
    }

    v57 = v65;
  }

  else
  {
    v49 = 1;
    v51 = v64;
    v57 = v65;
    v53 = v61;
    v52 = v62;
    v54 = v60;
  }

  objc_autoreleasePoolPop(v51);
  return v49;
}

- (BOOL)_fixDuplicatedAssets:(id)a3
{
  v62 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v42 = objc_autoreleasePoolPush();
  v46 = self;
  v43 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixDuplicatedAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudMaster"];
  [v6 setFetchBatchSize:100];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"assets.@count > 1"];
  [v6 setPredicate:v7];

  v41 = v6;
  [v5 executeFetchRequest:v6 error:0];
  v52 = 0u;
  v53 = 0u;
  v54 = 0u;
  v8 = v55 = 0u;
  v38 = [v8 countByEnumeratingWithState:&v52 objects:v61 count:16];
  if (v38)
  {
    v9 = *v53;
    v40 = v8;
    v37 = *v53;
    v45 = v5;
    do
    {
      v10 = 0;
      do
      {
        if (*v53 != v9)
        {
          objc_enumerationMutation(v8);
        }

        v39 = v10;
        v11 = *(*(&v52 + 1) + 8 * v10);
        context = objc_autoreleasePoolPush();
        v48 = 0u;
        v49 = 0u;
        v50 = 0u;
        v51 = 0u;
        v12 = [v11 assets];
        v13 = [v12 countByEnumeratingWithState:&v48 objects:v60 count:16];
        if (v13)
        {
          v14 = v13;
          v15 = *v49;
          while (2)
          {
            for (i = 0; i != v14; ++i)
            {
              if (*v49 != v15)
              {
                objc_enumerationMutation(v12);
              }

              v17 = *(*(&v48 + 1) + 8 * i);
              v18 = [v17 uuid];
              v19 = [PLCloudResource cloudResourceForResourceType:1 forAssetUuid:v18 forCloudMaster:v11];

              if (v19 || ([v17 cloudAssetGUID], v20 = objc_claimAutoreleasedReturnValue(), v20, !v20))
              {
              }

              else
              {
                if ([v17 isCloudPhotoLibraryAsset])
                {
                  v21 = [v17 cloudAssetGUID];
                  v22 = [v17 photoDataCPLResourceDestinationDirectoryCreateIfNeededWithIdentifier:v21];

                  v23 = [(PLModelMigrator *)v46 pathManager];
                  v24 = [v23 assetAbbreviatedMetadataDirectoryForDirectory:v22 type:32 bundleScope:0];
                  [v17 setDirectory:v24];

                  v25 = [v17 uniformTypeIdentifier];
                  v26 = [PLManagedAsset preferredFileExtensionForType:v25];

                  v27 = MEMORY[0x1E696AEC0];
                  [v17 cloudAssetGUID];
                  v29 = v28 = v12;
                  v30 = [v27 stringWithFormat:@"%@.%@", v29, v26];

                  v12 = v28;
                  [v17 setFilename:v30];

                  v5 = v45;
                }

                if (![PLCloudResource legacyCreateNewResourcesIn:v11 inManagedObjectContext:v5 forAsset:v17])
                {

                  objc_autoreleasePoolPop(context);
                  v33 = 0;
                  v8 = v40;
                  v32 = v40;
                  goto LABEL_25;
                }
              }
            }

            v14 = [v12 countByEnumeratingWithState:&v48 objects:v60 count:16];
            if (v14)
            {
              continue;
            }

            break;
          }
        }

        objc_autoreleasePoolPop(context);
        v10 = v39 + 1;
        v8 = v40;
        v9 = v37;
      }

      while (v39 + 1 != v38);
      v38 = [v40 countByEnumeratingWithState:&v52 objects:v61 count:16];
    }

    while (v38);
  }

  if ([v5 hasChanges])
  {
    v47 = 0;
    v31 = [v5 save:&v47];
    v32 = v47;
    if (v31)
    {
      v33 = 1;
    }

    else
    {
      v35 = PLMigrationGetLog();
      if (os_log_type_enabled(v35, OS_LOG_TYPE_ERROR))
      {
        v36 = [v32 userInfo];
        *buf = 138412546;
        v57 = v32;
        v58 = 2112;
        v59 = v36;
        _os_log_impl(&dword_19BF1F000, v35, OS_LOG_TYPE_ERROR, "_fixDuplicatedAssets: failed: %@ %@", buf, 0x16u);
      }

      v33 = 0;
    }

LABEL_25:
  }

  else
  {
    v33 = 1;
  }

  objc_autoreleasePoolPop(v42);
  return v33;
}

- (BOOL)_fixVisibleBurstAsset:(id)a3
{
  v49 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v35 = objc_autoreleasePoolPush();
  v36 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixVisibleBurstAsset:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  [v8 setFetchBatchSize:100];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"avalancheUUID != NULL AND visibilityState = %d AND trashedState = %d", 0, 0];
  [v8 setPredicate:v9];

  v10 = v5;
  v34 = v8;
  [v5 executeFetchRequest:v8 error:0];
  v40 = 0u;
  v41 = 0u;
  v42 = 0u;
  obj = v43 = 0u;
  v11 = [obj countByEnumeratingWithState:&v40 objects:v48 count:16];
  if (v11)
  {
    v12 = v11;
    v38 = 0;
    v13 = *v41;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v41 != v13)
        {
          objc_enumerationMutation(obj);
        }

        v15 = *(*(&v40 + 1) + 8 * i);
        v16 = objc_autoreleasePoolPush();
        v17 = [v15 avalancheUUID];
        v18 = [v15 avalanchePickType];
        if ((v18 & 8) == 0)
        {
          v19 = v18;
          v20 = MEMORY[0x1E695D5E0];
          v21 = +[PLManagedAsset entityName];
          v22 = [v20 fetchRequestWithEntityName:v21];

          [v22 setFetchBatchSize:100];
          v23 = [MEMORY[0x1E696AE18] predicateWithFormat:@"avalancheUUID == %@ AND trashedState != %d", v17, 0];
          [v22 setPredicate:v23];

          v24 = [v10 executeFetchRequest:v22 error:0];
          if ([v24 count])
          {
            [v15 setAvalanchePickType:v19 & 4 | 8u];
            [v15 setCloudLocalState:0];
            ++v38;
            if ([v15 complete])
            {
              [v15 persistMetadataToFilesystem];
            }
          }
        }

        objc_autoreleasePoolPop(v16);
      }

      v12 = [obj countByEnumeratingWithState:&v40 objects:v48 count:16];
    }

    while (v12);
  }

  else
  {
    v38 = 0;
  }

  if ([v10 hasChanges])
  {
    v39 = 0;
    v25 = [v10 save:&v39];
    v26 = v39;
    v28 = v35;
    v27 = v36;
    v29 = v34;
    if ((v25 & 1) == 0)
    {
      v30 = PLMigrationGetLog();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
      {
        v31 = [v26 userInfo];
        *buf = 138412546;
        v45 = v26;
        v46 = 2112;
        v47 = v31;
        _os_log_impl(&dword_19BF1F000, v30, OS_LOG_TYPE_ERROR, "_fixVisibleBurstAsset: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v25 = 1;
    v28 = v35;
    v27 = v36;
    v29 = v34;
  }

  v32 = PLMigrationGetLog();
  if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 67109120;
    LODWORD(v45) = v38;
    _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_DEFAULT, "_fixVisibleBurstAsset: fixed %d burst assets", buf, 8u);
  }

  objc_autoreleasePoolPop(v28);
  return v25;
}

- (BOOL)_fixAdjustedAssets:(id)a3
{
  v32 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v24 = 0;
  v25 = &v24;
  v26 = 0x2020000000;
  v27 = 1;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixAdjustedAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:0];
  [v9 setPredicate:v10];

  v11 = [MEMORY[0x1E696AC08] defaultManager];
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __38__PLModelMigrator__fixAdjustedAssets___block_invoke;
  v21[3] = &unk_1E75721F8;
  v12 = v11;
  v22 = v12;
  v23 = &v24;
  v13 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:v21];
  if (*(v25 + 24) == 1 && [v6 hasChanges])
  {
    v20 = 0;
    v14 = [v6 save:&v20];
    v15 = v20;
    *(v25 + 24) = v14;
    if ((v14 & 1) == 0)
    {
      v16 = PLMigrationGetLog();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = [v15 userInfo];
        *buf = 138412546;
        v29 = v15;
        v30 = 2112;
        v31 = v17;
        _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "_fixAdjustedAssets: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  objc_autoreleasePoolPop(v5);
  v18 = *(v25 + 24);
  _Block_object_dispose(&v24, 8);

  return v18 & 1;
}

void __38__PLModelMigrator__fixAdjustedAssets___block_invoke(uint64_t a1, void *a2, uint64_t a3, _BYTE *a4)
{
  v43 = *MEMORY[0x1E69E9840];
  v5 = a2;
  [v5 resources];
  v34 = 0u;
  v35 = 0u;
  v36 = 0u;
  v6 = v37 = 0u;
  v31 = [v6 countByEnumeratingWithState:&v34 objects:v42 count:16];
  if (v31)
  {
    v7 = *v35;
    v28 = *v35;
    v29 = v6;
    do
    {
      for (i = 0; i != v31; ++i)
      {
        if (*v35 != v7)
        {
          objc_enumerationMutation(v6);
        }

        v9 = *(*(&v34 + 1) + 8 * i);
        v10 = objc_autoreleasePoolPush();
        v11 = [v5 uuid];
        [v9 setAssetUuid:v11];

        v12 = [v9 filePath];
        v13 = [v5 pathForCPLResourceType:objc_msgSend(v9 adjusted:{"type"), 1}];
        LOBYTE(v11) = [v12 isEqualToString:v13];
        v14 = [*(a1 + 32) fileExistsAtPath:v12 isDirectory:0];
        if (v11)
        {
          [v9 setIsLocallyAvailable:v14];
          goto LABEL_21;
        }

        if (v14)
        {
          v15 = [v13 stringByDeletingLastPathComponent];
          v16 = *(a1 + 32);
          v33 = 0;
          v30 = v15;
          v17 = [v16 createDirectoryIfNeededAtPath:? error:?];
          v18 = v33;
          if (v17)
          {
            v19 = *(a1 + 32);
            v32 = v18;
            v20 = [v19 moveItemAtPath:v12 toPath:v13 error:&v32];
            v21 = v32;

            if (v20)
            {
              v22 = 1;
LABEL_19:
              v7 = v28;

              v6 = v29;
              goto LABEL_20;
            }

            v23 = PLMigrationGetLog();
            if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
            {
              v25 = [v21 userInfo];
              *buf = 138412546;
              v39 = v21;
              v40 = 2112;
              v41 = v25;
              _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "_fixAdjustedAssets: failed: %@ %@", buf, 0x16u);
            }

            v18 = v21;
          }

          else
          {
            v23 = PLMigrationGetLog();
            if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
            {
              v24 = [v18 userInfo];
              *buf = 138412546;
              v39 = v18;
              v40 = 2112;
              v41 = v24;
              _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "_fixAdjustedAssets: failed: %@ %@", buf, 0x16u);
            }
          }

          v22 = 0;
          *(*(*(a1 + 40) + 8) + 24) = 0;
          v21 = v18;
          goto LABEL_19;
        }

        v22 = 0;
LABEL_20:
        [v9 setIsLocallyAvailable:v22];
        [v9 setFilePath:v13];
LABEL_21:
        v26 = *(*(*(a1 + 40) + 8) + 24);

        objc_autoreleasePoolPop(v10);
        if (v26 != 1)
        {
          goto LABEL_24;
        }
      }

      v31 = [v6 countByEnumeratingWithState:&v34 objects:v42 count:16];
    }

    while (v31);
  }

LABEL_24:

  if ((*(*(*(a1 + 40) + 8) + 24) & 1) == 0)
  {
    *a4 = 1;
  }
}

- (BOOL)_migrateLegacySlomoAdjustmentsInStore:(id)a3 fromLegacySLMFormat:(BOOL)a4
{
  v56 = a4;
  v74[2] = *MEMORY[0x1E69E9840];
  v5 = a3;
  pl_dispatch_once();
  v54 = objc_autoreleasePoolPush();
  v6 = self;
  v55 = v5;
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _migrateLegacySlomoAdjustmentsInStore:fromLegacySLMFormat:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"complete != 0"];
  v12 = MEMORY[0x1E696AB28];
  v13 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %d", @"kindSubtype"];
  v74[0] = v13;
  v14 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForMigrateLegacyVideoAdjustmentsExclusions"), 0}];
  v74[1] = v14;
  v15 = [MEMORY[0x1E695DEC8] arrayWithObjects:v74 count:2];
  v16 = [v12 andPredicateWithSubpredicates:v15];

  v17 = MEMORY[0x1E696AB28];
  v50 = v16;
  v51 = v11;
  v73[0] = v16;
  v73[1] = v11;
  v18 = [MEMORY[0x1E695DEC8] arrayWithObjects:v73 count:2];
  v19 = [v17 andPredicateWithSubpredicates:v18];

  v49 = v19;
  [v10 setPredicate:v19];
  [v10 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF868];
  v52 = v10;
  v53 = v7;
  [v7 executeFetchRequest:v10 error:0];
  v62 = 0u;
  v63 = 0u;
  v64 = 0u;
  obj = v65 = 0u;
  v20 = [obj countByEnumeratingWithState:&v62 objects:v72 count:16];
  if (!v20)
  {
    v60 = 0;
    v57 = 0;
    v58 = 0;
    goto LABEL_28;
  }

  v21 = v20;
  v60 = 0;
  v57 = 0;
  v58 = 0;
  v22 = *v63;
  do
  {
    for (i = 0; i != v21; ++i)
    {
      if (*v63 != v22)
      {
        objc_enumerationMutation(obj);
      }

      v24 = *(*(&v62 + 1) + 8 * i);
      v25 = objc_autoreleasePoolPush();
      v26 = [(PLModelMigrator *)v6 _migrateLegacySlomoAdjustmentsForAsset:v24];
      if (!v26)
      {
        ++v60;
        goto LABEL_24;
      }

      v27 = v26;
      v28 = [v24 pathForAdjustmentFile];
      v29 = [MEMORY[0x1E696AC08] defaultManager];
      v30 = [v29 fileExistsAtPath:v28];

      if (v30)
      {
        if (v27 == 2)
        {
          ++v58;
        }

        else if (v27 == 1)
        {
          ++v57;
        }

        goto LABEL_23;
      }

      v31 = PLMigrationGetLog();
      v32 = os_log_type_enabled(v31, OS_LOG_TYPE_ERROR);
      if (v27 == 1)
      {
        if (v56)
        {
          if (v32)
          {
            v33 = [v24 pathForLegacySlalomRegionsArchive];
            *buf = 138412546;
            v67 = v33;
            v68 = 2112;
            v69 = v28;
            _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_ERROR, "_migrateLegacySlomoAdjustmentsInStore failed to migrate %@ to %@", buf, 0x16u);
          }

          goto LABEL_22;
        }

        if (v32)
        {
          *buf = 138412290;
          v67 = v28;
          v34 = v31;
          v35 = "_migrateLegacySlomoAdjustmentsInStore failed to migrate %@ to updated format";
          goto LABEL_21;
        }
      }

      else if (v32)
      {
        *buf = 138412290;
        v67 = v28;
        v34 = v31;
        v35 = "_migrateLegacySlomoAdjustmentsInStore failed to create default adjustments at %@";
LABEL_21:
        _os_log_impl(&dword_19BF1F000, v34, OS_LOG_TYPE_ERROR, v35, buf, 0xCu);
      }

LABEL_22:

LABEL_23:
LABEL_24:
      objc_autoreleasePoolPop(v25);
    }

    v21 = [obj countByEnumeratingWithState:&v62 objects:v72 count:16];
  }

  while (v21);
LABEL_28:

  v36 = PLMigrationGetLog();
  v37 = os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT);
  if (v56)
  {
    v39 = v54;
    v38 = v55;
    v41 = v52;
    v40 = v53;
    if (v37)
    {
      *buf = 134218496;
      v67 = v57;
      v68 = 2048;
      v69 = v58;
      v70 = 2048;
      v71 = v60;
      v42 = "Slo-mo assets: migrated %ld SLM files, created defaults for %ld files, and did nothing for %ld";
      goto LABEL_33;
    }
  }

  else
  {
    v39 = v54;
    v38 = v55;
    v41 = v52;
    v40 = v53;
    if (v37)
    {
      *buf = 134218496;
      v67 = v57;
      v68 = 2048;
      v69 = v58;
      v70 = 2048;
      v71 = v60;
      v42 = "Slo-mo assets: migrated %ld adjustments files, created defaults for %ld files, and did nothing for %ld";
LABEL_33:
      _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEFAULT, v42, buf, 0x20u);
    }
  }

  if ([v40 hasChanges])
  {
    v61 = 0;
    v43 = [v40 save:&v61];
    v44 = v61;
    v45 = v51;
    if ((v43 & 1) == 0)
    {
      v46 = PLMigrationGetLog();
      if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
      {
        v47 = [v44 userInfo];
        *buf = 138412546;
        v67 = v44;
        v68 = 2112;
        v69 = v47;
        _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_ERROR, "_migrateLegacySlomoAdjustmentsInStore failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v43 = 1;
    v45 = v51;
  }

  objc_autoreleasePoolPop(v39);
  return v43;
}

- (int)_migrateLegacySlomoAdjustmentsForAsset:(id)a3
{
  v3 = a3;
  if ([v3 migrateLegacyVideoAdjustments])
  {
    v4 = 1;
  }

  else if ([v3 setDefaultAdjustmentsIfNecessaryWithMainFileMetadata:0])
  {
    v4 = 2;
  }

  else
  {
    v4 = 0;
  }

  return v4;
}

- (BOOL)_performChangesOnBatchFetchedObjects:(id)a3 inMOC:(id)a4 batchSize:(unint64_t)a5 objectHandler:(id)a6 error:(id *)a7
{
  v11 = a3;
  v12 = a4;
  v13 = a6;
  v29 = 0;
  v30 = &v29;
  v31 = 0x2020000000;
  v32 = 1;
  aBlock = MEMORY[0x1E69E9820];
  v23 = 3221225472;
  v24 = __92__PLModelMigrator__performChangesOnBatchFetchedObjects_inMOC_batchSize_objectHandler_error___block_invoke;
  v25 = &unk_1E7576208;
  v21 = v12;
  v26 = v21;
  v27 = &v29;
  v28 = a7;
  v14 = _Block_copy(&aBlock);
  v15 = 0;
  do
  {
    if (v15 >= [v11 count])
    {
      break;
    }

    v16 = objc_autoreleasePoolPush();
    v17 = [v11 objectAtIndexedSubscript:v15];
    v13[2](v13, v17, v15);
    if (a5 && !((v15 + 1) % a5))
    {
      v14[2](v14);
      [v21 reset];
    }

    v18 = *(v30 + 24);

    objc_autoreleasePoolPop(v16);
    ++v15;
  }

  while ((v18 & 1) != 0);
  if (*(v30 + 24) == 1)
  {
    v14[2](v14);
    v19 = *(v30 + 24);
  }

  else
  {
    v19 = 0;
  }

  _Block_object_dispose(&v29, 8);
  return v19 & 1;
}

uint64_t __92__PLModelMigrator__performChangesOnBatchFetchedObjects_inMOC_batchSize_objectHandler_error___block_invoke(uint64_t a1)
{
  result = [*(a1 + 32) hasChanges];
  if (result)
  {
    result = [*(a1 + 32) save:*(a1 + 48)];
    *(*(*(a1 + 40) + 8) + 24) &= result;
  }

  return result;
}

- (BOOL)_fixCorruptedOrientationsInStore:(id)a3
{
  v28 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _fixCorruptedOrientationsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E696AE18] predicateWithFormat:@"(additionalAttributes.unmanagedAdjustment != nil) AND (complete != 0)"];
  v9 = MEMORY[0x1E695D5E0];
  v10 = +[PLManagedAsset entityName];
  v11 = [v9 fetchRequestWithEntityName:v10];

  [v11 setFetchBatchSize:100];
  [v11 setPredicate:v8];
  [v11 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF850];
  v12 = [v7 executeFetchRequest:v11 error:0];
  v13 = PLMigrationGetLog();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v23 = [v12 count];
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Found %lu assets with managed adjustments to check orientation.", buf, 0xCu);
  }

  v21 = 0;
  v14 = [(PLModelMigrator *)self _performChangesOnBatchFetchedObjects:v12 inMOC:v7 batchSize:100 objectHandler:&__block_literal_global_1566 error:&v21];
  v15 = v21;
  if (!v14)
  {
    v16 = PLMigrationGetLog();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = NSStringFromSelector(a2);
      [v15 userInfo];
      v18 = v20 = v6;
      *buf = 138412802;
      v23 = v17;
      v24 = 2112;
      v25 = v15;
      v26 = 2112;
      v27 = v18;
      _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);

      v6 = v20;
    }
  }

  objc_autoreleasePoolPop(v6);
  return v14;
}

void __52__PLModelMigrator__fixCorruptedOrientationsInStore___block_invoke(uint64_t a1, void *a2)
{
  v10 = a2;
  v2 = [v10 mainFileURL];
  v3 = [objc_alloc(MEMORY[0x1E695DEF0]) initWithContentsOfURL:v2 options:1 error:0];
  if ([(__CFData *)v3 length])
  {
    v4 = CGImageSourceCreateWithData(v3, 0);
    v5 = CGImageSourceCopyPropertiesAtIndex(v4, 0, 0);
    v6 = [(__CFDictionary *)v5 objectForKeyedSubscript:*MEMORY[0x1E696DE78]];
    v7 = [v6 shortValue];
    v8 = [v10 originalOrientation];
    if (v7)
    {
      v9 = v8 == v7;
    }

    else
    {
      v9 = 1;
    }

    if (!v9)
    {
      [v10 setOriginalOrientation:v7];
    }

    CFRelease(v4);
  }
}

- (BOOL)_persistMetadataToFileSystemForAlbum:(id)a3
{
  v4 = a3;
  objc_opt_class();
  if ((objc_opt_isKindOfClass() & 1) == 0)
  {
    objc_opt_class();
    if ((objc_opt_isKindOfClass() & 1) == 0)
    {
      objc_opt_class();
      if ((objc_opt_isKindOfClass() & 1) != 0 && [v4 isValidForPersistence])
      {
        goto LABEL_4;
      }

LABEL_7:
      v6 = 0;
      goto LABEL_8;
    }
  }

  if (([v4 isValidForPersistence] & 1) == 0)
  {
    goto LABEL_7;
  }

LABEL_4:
  v5 = [(PLModelMigrator *)self pathManager];
  [v4 persistMetadataToFileSystemWithPathManager:v5];

  v6 = 1;
LABEL_8:

  return v6;
}

- (BOOL)_forceAlbumMetadataToDiskInStore:(id)a3
{
  v38 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v24 = [MEMORY[0x1E696AAA8] currentHandler];
    v25 = NSStringFromSelector(a2);
    [v24 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:6308 description:{@"%@ can only be called from assetsd", v25}];
  }

  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _forceAlbumMetadataToDiskInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v34 = 0;
  v9 = [v7 executeFetchRequest:v8 error:&v34];
  v10 = v34;
  if (v9)
  {
    if ([v9 count])
    {
      v26 = v10;
      v27 = v7;
      v28 = v6;
      v29 = v5;
      v32 = 0u;
      v33 = 0u;
      v30 = 0u;
      v31 = 0u;
      v11 = v9;
      v12 = [v11 countByEnumeratingWithState:&v30 objects:v37 count:16];
      if (v12)
      {
        v13 = v12;
        v14 = 0;
        v15 = *v31;
        do
        {
          for (i = 0; i != v13; ++i)
          {
            if (*v31 != v15)
            {
              objc_enumerationMutation(v11);
            }

            v17 = *(*(&v30 + 1) + 8 * i);
            v18 = objc_autoreleasePoolPush();
            v14 += [(PLModelMigrator *)self _persistMetadataToFileSystemForAlbum:v17];
            objc_autoreleasePoolPop(v18);
          }

          v13 = [v11 countByEnumeratingWithState:&v30 objects:v37 count:16];
        }

        while (v13);
      }

      else
      {
        v14 = 0;
      }

      v6 = v28;
      v5 = v29;
      v10 = v26;
      v7 = v27;
    }

    else
    {
      v14 = 0;
    }

    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v36 = v14;
      v20 = "Persisted %lu albums and folders.";
      v21 = v19;
      v22 = OS_LOG_TYPE_DEFAULT;
      goto LABEL_20;
    }
  }

  else
  {
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v36 = v10;
      v20 = "Ignoring _forceAlbumMetadataToDiskInStore: fetch failure: %@";
      v21 = v19;
      v22 = OS_LOG_TYPE_ERROR;
LABEL_20:
      _os_log_impl(&dword_19BF1F000, v21, v22, v20, buf, 0xCu);
    }
  }

  objc_autoreleasePoolPop(v6);
  return 1;
}

- (BOOL)_setupRootFolderInStore:(id)a3
{
  v22 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v15 = [MEMORY[0x1E696AAA8] currentHandler];
    v16 = NSStringFromSelector(a2);
    [v15 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:6278 description:{@"%@ can only be called from assetsd", v16}];
  }

  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _setupRootFolderInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [PLManagedAlbumList albumListInManagedObjectContext:v7];
  v9 = [(PLGenericAlbum *)PLManagedFolder albumWithKind:3999 inManagedObjectContext:v7];
  [PLManagedAlbumList pushChangesFromAlbumContainer:v8 toAlbumContainer:v9];
  if ([v7 hasChanges])
  {
    v17 = 0;
    v10 = [v7 save:&v17];
    v11 = v17;
    if ((v10 & 1) == 0)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = [v11 userInfo];
        *buf = 138412546;
        v19 = v11;
        v20 = 2112;
        v21 = v13;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "_setupRootFolderInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v10 = 1;
  }

  objc_autoreleasePoolPop(v6);
  return v10;
}

- (BOOL)_fixDuplicatedRootFolderAndOrphanedAlbumsInStore:(id)a3
{
  v95 = *MEMORY[0x1E69E9840];
  v5 = a3;
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v71 = self;
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _fixDuplicatedRootFolderAndOrphanedAlbumsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedFolder entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind = %d", 3999];
  [v10 setPredicate:v11];

  v86 = 0;
  v12 = [v7 executeFetchRequest:v10 error:&v86];
  v13 = v86;
  if ([v12 count] >= 2)
  {
    v73 = v13;
    v74 = v7;
    v70 = v10;
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = [v12 count];
      *buf = 134217984;
      v88 = v15;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Found %lu root folders, attempting repair", buf, 0xCu);
    }

    aSelector = a2;

    v16 = [MEMORY[0x1E695DF70] array];
    v82 = 0u;
    v83 = 0u;
    v84 = 0u;
    v85 = 0u;
    v69 = v12;
    v17 = v12;
    v18 = [v17 countByEnumeratingWithState:&v82 objects:v94 count:16];
    if (v18)
    {
      v19 = v18;
      v67 = v6;
      v68 = v5;
      v20 = 0;
      v21 = 0;
      v22 = *v83;
      do
      {
        for (i = 0; i != v19; ++i)
        {
          if (*v83 != v22)
          {
            objc_enumerationMutation(v17);
          }

          v24 = *(*(&v82 + 1) + 8 * i);
          v25 = [v24 albums];
          v26 = [v25 count];

          if (v26 > v20)
          {
            v27 = v24;

            v20 = v26;
            v21 = v27;
          }
        }

        v19 = [v17 countByEnumeratingWithState:&v82 objects:v94 count:16];
      }

      while (v19);

      if (!v20)
      {
        v6 = v67;
        v5 = v68;
        goto LABEL_34;
      }

      v28 = [v21 albums];
      v78 = 0u;
      v79 = 0u;
      v80 = 0u;
      v81 = 0u;
      v29 = v17;
      v30 = [v29 countByEnumeratingWithState:&v78 objects:v93 count:16];
      if (v30)
      {
        v31 = v30;
        v32 = *v79;
        do
        {
          for (j = 0; j != v31; ++j)
          {
            if (*v79 != v32)
            {
              objc_enumerationMutation(v29);
            }

            v34 = *(*(&v78 + 1) + 8 * j);
            if (v34 != v21)
            {
              v35 = [*(*(&v78 + 1) + 8 * j) albums];
              v36 = [v35 count];

              if (v36)
              {
                v37 = [v34 albums];
                v38 = [v37 array];
                [v28 addObjectsFromArray:v38];
              }

              [v34 delete];
              [v16 addObject:v34];
            }
          }

          v31 = [v29 countByEnumeratingWithState:&v78 objects:v93 count:16];
        }

        while (v31);
      }

      v6 = v67;
      v5 = v68;
    }

    else
    {
      v21 = 0;
      v28 = v17;
    }

LABEL_34:
    v42 = MEMORY[0x1E695DFA8];
    v43 = +[PLManagedAlbum validKindsForPersistence];
    v44 = [v42 setWithArray:v43];

    v45 = +[PLManagedFolder validKindsForPersistence];
    [v44 addObjectsFromArray:v45];

    [v44 removeObject:&unk_1F0FBBD70];
    [v44 addObject:&unk_1F0FBBD88];
    if ([v44 count])
    {
      v46 = MEMORY[0x1E695D5E0];
      v47 = +[PLGenericAlbum entityName];
      v48 = [v46 fetchRequestWithEntityName:v47];

      v49 = MEMORY[0x1E696AE18];
      v50 = [v44 allObjects];
      v51 = [v49 predicateWithFormat:@"%K IN %@ AND %K = NULL", @"kind", v50, @"parentFolder", aSelector];
      [v48 setPredicate:v51];

      v77 = v73;
      v52 = [v74 executeFetchRequest:v48 error:&v77];
      v53 = v77;

      if ([v52 count])
      {
        v54 = PLMigrationGetLog();
        if (os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT))
        {
          v55 = [v52 count];
          *buf = 134217984;
          v88 = v55;
          _os_log_impl(&dword_19BF1F000, v54, OS_LOG_TYPE_DEFAULT, "Found %lu orpaned albums/folders, adding to root folder", buf, 0xCu);
        }

        v56 = [v21 albums];
        [v56 addObjectsFromArray:v52];
      }

      v73 = v53;
    }

    if ([v74 hasChanges])
    {
      v57 = [PLManagedAlbumList albumListInManagedObjectContext:v74];
      [PLManagedAlbumList pushChangesFromAlbumContainer:v21 toAlbumContainer:v57];
      v58 = [(PLModelMigrator *)v71 pathManager];
      [v21 persistMetadataToFileSystemWithPathManager:v58];

      v76[0] = MEMORY[0x1E69E9820];
      v76[1] = 3221225472;
      v76[2] = __68__PLModelMigrator__fixDuplicatedRootFolderAndOrphanedAlbumsInStore___block_invoke;
      v76[3] = &unk_1E7577F08;
      v76[4] = v71;
      [v16 enumerateObjectsUsingBlock:v76];
      v75 = 0;
      v39 = [v74 save:&v75];
      v59 = v75;
      v60 = PLMigrationGetLog();
      v61 = v60;
      if (v39)
      {
        if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
        {
          v62 = [v16 count];
          *buf = 134217984;
          v88 = v62;
          _os_log_impl(&dword_19BF1F000, v61, OS_LOG_TYPE_DEFAULT, "Deleted %lu duplicated root folders, attempting repair", buf, 0xCu);
        }
      }

      else if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
      {
        v72 = NSStringFromSelector(aSelector);
        v63 = [v59 userInfo];
        *buf = 138543874;
        v88 = v72;
        v89 = 2112;
        v90 = v59;
        v91 = 2112;
        v92 = v63;
        v64 = v63;
        _os_log_impl(&dword_19BF1F000, v61, OS_LOG_TYPE_ERROR, "%{public}@: failed: %@ %@", buf, 0x20u);
      }
    }

    else
    {
      v39 = 1;
    }

    v13 = v73;
    v7 = v74;
    v12 = v69;
    v10 = v70;
LABEL_49:

    goto LABEL_50;
  }

  if (!v12)
  {
    v40 = a2;
    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v41 = NSStringFromSelector(v40);
      *buf = 138543618;
      v88 = v41;
      v89 = 2114;
      v90 = v13;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "%{public}@: failed: %{public}@", buf, 0x16u);
    }

    v39 = 1;
    goto LABEL_49;
  }

  v39 = 1;
LABEL_50:

  objc_autoreleasePoolPop(v6);
  return v39;
}

void __68__PLModelMigrator__fixDuplicatedRootFolderAndOrphanedAlbumsInStore___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 pathManager];
  [v3 removePersistedFileSystemDataWithPathManager:v4];
}

- (BOOL)_removeInvalidAdjustmentResourceDataInStore:(id)a3
{
  v26[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _removeInvalidAdjustmentResourceDataInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [PLManagedAsset predicateForAdjustedAssetsWithKeyPathToAsset:0];
  v26[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"SUBQUERY(resources, $r, $r.type == %d).@count > 1", 13];
  v26[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v26 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];
  [v9 setPredicate:v14];

  v15 = [v6 enumerateObjectsFromFetchRequest:v9 count:0 usingDefaultBatchSizeWithBlock:&__block_literal_global_1546];
  if ([v6 hasChanges])
  {
    v21 = 0;
    v16 = [v6 save:&v21];
    v17 = v21;
    if ((v16 & 1) == 0)
    {
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = [v17 userInfo];
        *buf = 138412546;
        v23 = v17;
        v24 = 2112;
        v25 = v19;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "_removeInvalidAdjustmentResourceDataInStore: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v16 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v16;
}

void __63__PLModelMigrator__removeInvalidAdjustmentResourceDataInStore___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = [v2 resources];
  v4 = [v2 syncedAdjustmentFingerprint];
  v5 = [MEMORY[0x1E695DFA8] set];
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v6 = v3;
  v7 = [v6 countByEnumeratingWithState:&v18 objects:v22 count:16];
  if (!v7)
  {

    goto LABEL_19;
  }

  v8 = v7;
  v17 = v2;
  v9 = 0;
  v10 = *v19;
  do
  {
    v11 = 0;
    do
    {
      if (*v19 != v10)
      {
        objc_enumerationMutation(v6);
      }

      v12 = *(*(&v18 + 1) + 8 * v11);
      v13 = objc_autoreleasePoolPush();
      if ([v12 type] != 13)
      {
        goto LABEL_11;
      }

      if (v9)
      {
        v9 = 1;
        goto LABEL_12;
      }

      v14 = [v12 fingerprint];
      v15 = [v14 isEqualToString:v4];

      if (v15)
      {
        v9 = 1;
LABEL_11:
        [v5 addObject:v12];
        goto LABEL_12;
      }

      v9 = 0;
LABEL_12:
      objc_autoreleasePoolPop(v13);
      ++v11;
    }

    while (v8 != v11);
    v16 = [v6 countByEnumeratingWithState:&v18 objects:v22 count:16];
    v8 = v16;
  }

  while (v16);

  v2 = v17;
  if (v9)
  {
    [v17 setResources:v5];
  }

LABEL_19:
}

- (BOOL)_migrateAssetLocationData:(id)a3
{
  v34 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _migrateAssetLocationData:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"locationData != nil"];
  [v9 setPredicate:v10];

  [v6 executeFetchRequest:v9 error:0];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v11 = v28 = 0u;
  v12 = [v11 countByEnumeratingWithState:&v25 objects:v33 count:16];
  if (v12)
  {
    v13 = v12;
    v14 = *v26;
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v26 != v14)
        {
          objc_enumerationMutation(v11);
        }

        v16 = *(*(&v25 + 1) + 8 * i);
        v17 = objc_autoreleasePoolPush();
        [v16 migrateLocationDataIfNeededAfterOTARestore:0];
        objc_autoreleasePoolPop(v17);
      }

      v13 = [v11 countByEnumeratingWithState:&v25 objects:v33 count:16];
    }

    while (v13);
  }

  if ([v6 hasChanges])
  {
    v24 = 0;
    v18 = [v6 save:&v24];
    v19 = v24;
    if (v18)
    {
      v20 = PLMomentsGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v21 = [v11 count];
        *buf = 134217984;
        v30 = v21;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Successfully migrated location data for %lu assets.", buf, 0xCu);
      }
    }

    else
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v22 = [v19 userInfo];
        *buf = 138412546;
        v30 = v19;
        v31 = 2112;
        v32 = v22;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "_migrateAssetLocationData failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v18 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v18;
}

- (BOOL)_addLocationHashesToAssets:(id)a3
{
  v23 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _addLocationHashesToAssets:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"locationData != nil"];
  [v9 setPredicate:v10];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF838];
  v18 = 0;
  v11 = [v6 enumerateObjectsFromFetchRequest:v9 count:&v18 usingDefaultBatchSizeWithBlock:&__block_literal_global_1541];
  if ([v6 hasChanges])
  {
    v17 = 0;
    v12 = [v6 save:&v17];
    v13 = v17;
    if (v12)
    {
      v14 = PLMomentsGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 134217984;
        v20 = v18;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_DEFAULT, "Successfully generated location hashes for %lu assets.", buf, 0xCu);
      }
    }

    else
    {
      v14 = PLMigrationGetLog();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        v15 = [v13 userInfo];
        *buf = 138412546;
        v20 = v13;
        v21 = 2112;
        v22 = v15;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "_addLocationHashesToAssets failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v12 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v12;
}

void __46__PLModelMigrator__addLocationHashesToAssets___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x1E69E9840];
  v2 = a2;
  v3 = [v2 location];
  v4 = [v3 pl_locationHash];
  v5 = PLMomentsGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    [v3 coordinate];
    v7 = v6;
    [v3 coordinate];
    v9[0] = 67109633;
    v9[1] = v4;
    v10 = 2049;
    v11 = v7;
    v12 = 2049;
    v13 = v8;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEBUG, "Generating hash (%d) for asset location (%{private}f, %{private}f)", v9, 0x1Cu);
  }

  [v2 setLocationHash:v4];
}

- (BOOL)_addUUIDsToCollectionLists:(id)a3 skipMomentLists:(BOOL)a4
{
  v55 = *MEMORY[0x1E69E9840];
  v6 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v34 = [MEMORY[0x1E696AAA8] currentHandler];
    v35 = NSStringFromSelector(a2);
    [v34 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:6029 description:{@"%@ can only be called from assetsd", v35}];
  }

  pl_dispatch_once();
  v37 = objc_autoreleasePoolPush();
  v38 = v6;
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v6 name:"[PLModelMigrator _addUUIDsToCollectionLists:skipMomentLists:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AlbumList"];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"uuid == nil"];
  [v8 setPredicate:v9];

  v39 = v7;
  [v7 executeFetchRequest:v8 error:0];
  v45 = 0u;
  v46 = 0u;
  v47 = 0u;
  v10 = v48 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v45 objects:v54 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v46;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v46 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v45 + 1) + 8 * i);
        v16 = objc_autoreleasePoolPush();
        v17 = [MEMORY[0x1E69BF320] UUIDString];
        [v15 setValue:v17 forKey:@"uuid"];

        objc_autoreleasePoolPop(v16);
      }

      v12 = [v10 countByEnumeratingWithState:&v45 objects:v54 count:16];
    }

    while (v12);
  }

  if (!a4)
  {
    v18 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"MomentList"];
    v19 = [MEMORY[0x1E696AE18] predicateWithFormat:@"uuid == nil"];
    [v18 setPredicate:v19];

    [v39 executeFetchRequest:v18 error:0];
    v41 = 0u;
    v42 = 0u;
    v43 = 0u;
    v20 = v44 = 0u;
    v21 = [v20 countByEnumeratingWithState:&v41 objects:v53 count:16];
    if (v21)
    {
      v22 = v21;
      v23 = *v42;
      do
      {
        for (j = 0; j != v22; ++j)
        {
          if (*v42 != v23)
          {
            objc_enumerationMutation(v20);
          }

          v25 = *(*(&v41 + 1) + 8 * j);
          v26 = objc_autoreleasePoolPush();
          v27 = [MEMORY[0x1E69BF320] UUIDString];
          [v25 setValue:v27 forKey:@"uuid"];

          objc_autoreleasePoolPop(v26);
        }

        v22 = [v20 countByEnumeratingWithState:&v41 objects:v53 count:16];
      }

      while (v22);
    }
  }

  if ([v39 hasChanges])
  {
    v40 = 0;
    v28 = [v39 save:&v40];
    v29 = v40;
    v30 = v38;
    if ((v28 & 1) == 0)
    {
      v31 = PLMigrationGetLog();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
      {
        v32 = [v29 userInfo];
        *buf = 138412546;
        v50 = v29;
        v51 = 2112;
        v52 = v32;
        _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_ERROR, "_addUUIDsToCollectionLists:skipMomentLists: failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v28 = 1;
    v30 = v38;
  }

  objc_autoreleasePoolPop(v37);
  return v28;
}

- (BOOL)_regenerateMonthHighlightTitlesWithStore:(id)a3
{
  v18 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _regenerateMonthHighlightTitlesWithStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [PLMomentGenerationDataManager alloc];
  v8 = [(PLModelMigrator *)self pathManager];
  v9 = [(PLMomentGenerationDataManager *)v7 initWithManagedObjectContext:v6 pathManagerForLightweightMigration:v8];

  objc_autoreleasePoolPop(v5);
  v10 = [(PLMomentGenerationDataManager *)v9 generator];
  v15 = 0;
  v11 = [v10 regenerateMonthHighlightTitlesWithManager:v9 error:&v15];
  v12 = v15;

  if ((v11 & 1) == 0)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v17 = v12;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Unable to regenerate month highlight titles, %@", buf, 0xCu);
    }
  }

  return v11;
}

- (BOOL)_rebuildMomentsInStore:(id)a3 deleteExistingMoments:(BOOL)a4 targetedAssetOIDs:(id)a5
{
  v6 = a4;
  v8 = a3;
  v9 = a5;
  if (PLPlatformMomentsSupported())
  {
    v10 = objc_autoreleasePoolPush();
    v11 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v8 name:"[PLModelMigrator _rebuildMomentsInStore:deleteExistingMoments:targetedAssetOIDs:]" concurrencyType:*MEMORY[0x1E695D708]];
    v12 = objc_opt_class();
    v13 = [(PLModelMigrator *)self pathManager];
    v14 = [v12 rebuildMomentsInContext:v11 pathManager:v13 deleteExistingMoments:v6 targetedAssetOIDs:v9];

    objc_autoreleasePoolPop(v10);
  }

  else
  {
    v14 = 1;
  }

  return v14;
}

- (BOOL)_fixupSyncedAssetAttributesInStore:(id)a3
{
  v26 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = 1;
  v6 = [(PLModelMigrator *)self _newSyncedPropertiesByAssetUUIDs:1];
  if ([v6 count])
  {
    pl_dispatch_once();
    v7 = objc_autoreleasePoolPush();
    v8 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupSyncedAssetAttributesInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
    v9 = MEMORY[0x1E695D5E0];
    v10 = +[PLManagedAsset entityName];
    v11 = [v9 fetchRequestWithEntityName:v10];

    v5 = 1;
    v12 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForFinderSyncedAsset"), 1}];
    [v11 setPredicate:v12];

    [v11 setPropertiesToFetch:&unk_1F0FBF808];
    [v11 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF820];
    v19[0] = MEMORY[0x1E69E9820];
    v19[1] = 3221225472;
    v19[2] = __54__PLModelMigrator__fixupSyncedAssetAttributesInStore___block_invoke;
    v19[3] = &unk_1E75781C0;
    v20 = v6;
    v21 = self;
    v13 = [v8 enumerateObjectsFromFetchRequest:v11 count:0 usingDefaultBatchSizeWithBlock:v19];
    if ([v8 hasChanges])
    {
      v18 = 0;
      v5 = [v8 save:&v18];
      v14 = v18;
      if ((v5 & 1) == 0)
      {
        v15 = PLMigrationGetLog();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
        {
          v16 = [v14 userInfo];
          *buf = 138412546;
          v23 = v14;
          v24 = 2112;
          v25 = v16;
          _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_fixupSyncedAssetAttributesInStore failed: %@ %@", buf, 0x16u);
        }
      }
    }

    objc_autoreleasePoolPop(v7);
  }

  return v5;
}

void __54__PLModelMigrator__fixupSyncedAssetAttributesInStore___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v5 = [v3 uuid];
  v4 = [*(a1 + 32) objectForKey:v5];
  [*(a1 + 40) _applySyncedProperties:v4 toAsset:v3];
}

- (BOOL)_cleanupInvalidAlbumsAndFoldersInStore:(id)a3
{
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _cleanupInvalidAlbumsAndFoldersInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  [PLGenericAlbum removeInvalidAlbumsAndFoldersInManagedObjectContext:v6];

  objc_autoreleasePoolPop(v5);
  return 1;
}

- (BOOL)_fixupSharedStreamOrientationsInStore:(id)a3
{
  v35[2] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupSharedStreamOrientationsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = MEMORY[0x1E696AB28];
  v11 = [MEMORY[0x1E69BF328] predicateForIncludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForCloudSharedAsset"), 1}];
  v35[0] = v11;
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != 1", @"additionalAttributes.originalOrientation"];
  v35[1] = v12;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v35 count:2];
  v14 = [v10 andPredicateWithSubpredicates:v13];
  [v9 setPredicate:v14];

  [v9 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF7F0];
  v15 = [v6 executeFetchRequest:v9 error:0];
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  v16 = [v15 countByEnumeratingWithState:&v26 objects:v34 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v27;
    do
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v27 != v18)
        {
          objc_enumerationMutation(v15);
        }

        [*(*(&v26 + 1) + 8 * i) setOriginalOrientation:1];
      }

      v17 = [v15 countByEnumeratingWithState:&v26 objects:v34 count:16];
    }

    while (v17);
  }

  if ([v6 hasChanges])
  {
    v25 = 0;
    v20 = [v6 save:&v25];
    v21 = v25;
    if ((v20 & 1) == 0)
    {
      v22 = PLMigrationGetLog();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
      {
        v23 = [v21 userInfo];
        *buf = 138412546;
        v31 = v21;
        v32 = 2112;
        v33 = v23;
        _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "_fixupSharedStreamOrientationsInStore failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v20 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v20;
}

- (BOOL)_populateFaceRegionsInStore:(id)a3
{
  v32[2] = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _populateFaceRegionsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = MEMORY[0x1E695D5E0];
  v9 = +[PLManagedAsset entityName];
  v10 = [v8 fetchRequestWithEntityName:v9];

  [v10 setFetchBatchSize:100];
  v11 = MEMORY[0x1E696AB28];
  v12 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d", @"kind", 0];
  v32[0] = v12;
  v13 = [MEMORY[0x1E69BF328] predicateForExcludeMask:objc_msgSend(MEMORY[0x1E69BF328] useIndex:{"maskForPopulateFaceRegionsExclusions"), 1}];
  v32[1] = v13;
  v14 = [MEMORY[0x1E695DEC8] arrayWithObjects:v32 count:2];
  v15 = [v11 andPredicateWithSubpredicates:v14];
  [v10 setPredicate:v15];

  [v10 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF7D8];
  v16 = [v7 executeFetchRequest:v10 error:0];
  v17 = PLMigrationGetLog();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134217984;
    v27 = [v16 count];
    _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Found %lu assets to populate face regions.", buf, 0xCu);
  }

  v24 = 0;
  v25[0] = MEMORY[0x1E69E9820];
  v25[1] = 3221225472;
  v25[2] = __47__PLModelMigrator__populateFaceRegionsInStore___block_invoke;
  v25[3] = &unk_1E7568E20;
  v25[4] = self;
  v18 = [(PLModelMigrator *)self _performChangesOnBatchFetchedObjects:v16 inMOC:v7 batchSize:100 objectHandler:v25 error:&v24];
  v19 = v24;
  if (!v18)
  {
    v20 = PLMigrationGetLog();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = NSStringFromSelector(a2);
      v22 = [v19 userInfo];
      *buf = 138412802;
      v27 = v21;
      v28 = 2112;
      v29 = v19;
      v30 = 2112;
      v31 = v22;
      _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
    }
  }

  objc_autoreleasePoolPop(v6);
  return v18;
}

- (void)_populateFaceRegionsForAsset:(id)a3
{
  v15 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = [v3 mainFileURL];
  if (v4)
  {
    v5 = [objc_alloc(MEMORY[0x1E695DEF0]) initWithContentsOfURL:v4 options:1 error:0];
  }

  else
  {
    v6 = PLMigrationGetLog();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
    {
      v7 = [v3 uuid];
      v11 = 138412546;
      v12 = v7;
      v13 = 1024;
      v14 = [v3 savedAssetType];
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Found asset %@ of type %hd with nil mainFileURL, skipping", &v11, 0x12u);
    }

    v5 = 0;
  }

  if ([(__CFData *)v5 length])
  {
    v8 = CGImageSourceCreateWithData(v5, 0);
    v9 = CGImageSourceCopyMetadataAtIndex(v8, 0, 0);
    if (v9)
    {
      v10 = v9;
      [v3 setFaceRegionsFromImageMetadata:v9];
      CFRelease(v10);
    }

    CFRelease(v8);
  }
}

- (BOOL)_populateVideoCpFieldsInStagedStore:(id)a3
{
  v29 = *MEMORY[0x1E69E9840];
  v5 = a3;
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _populateVideoCpFieldsInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AdditionalAssetAttributes"];
  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"videoCpVisibilityState != 0 OR videoCpDurationValue != 0"];
  [v8 setPredicate:v9];

  [v8 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF7C0];
  v21 = 0;
  v22 = &v21;
  v23 = 0x2020000000;
  v24 = 0;
  v10 = [v7 executeFetchRequest:v8 error:0];
  v17[0] = MEMORY[0x1E69E9820];
  v17[1] = 3221225472;
  v17[2] = __55__PLModelMigrator__populateVideoCpFieldsInStagedStore___block_invoke;
  v17[3] = &unk_1E7568DF8;
  v18 = @"videoCpDurationValue";
  v19 = @"videoCpVisibilityState";
  v20 = &v21;
  v11 = [v7 enumerateWithIncrementalSaveUsingObjects:v10 shouldRefreshAfterSave:1 withBlock:v17];
  if (v11)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = NSStringFromSelector(a2);
      *buf = 138412546;
      v26 = v13;
      v27 = 2112;
      v28 = v11;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "%@ failed to update videoCp fields assets: %@", buf, 0x16u);
    }
  }

  else
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v14 = NSStringFromSelector(a2);
      v15 = v22[3];
      *buf = 138412546;
      v26 = v14;
      v27 = 1024;
      LODWORD(v28) = v15;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "%@ updated videpCp fields on %d assets", buf, 0x12u);
    }
  }

  _Block_object_dispose(&v21, 8);
  objc_autoreleasePoolPop(v6);

  return v11 == 0;
}

void __55__PLModelMigrator__populateVideoCpFieldsInStagedStore___block_invoke(void *a1, void *a2)
{
  v3 = a1[4];
  v4 = a2;
  v7 = [v4 valueForKey:v3];
  v5 = [v4 valueForKey:a1[5]];
  v6 = [v4 valueForKey:@"asset"];

  [v6 setValue:v7 forKey:a1[4]];
  [v6 setValue:v5 forKey:a1[5]];
  ++*(*(a1[6] + 8) + 24);
}

- (BOOL)_populateAlbumAndFolderOrderKeysInStagedStore:(id)a3
{
  v171 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v107 = v4;
  v117 = *MEMORY[0x1E695D708];
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateAlbumAndFolderOrderKeysInStagedStore:]" concurrencyType:?];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"Album"];
  v8 = +[PLManagedAlbum albumSupportsAssetOrderKeysPredicate];
  [v7 setPredicate:v8];

  [v7 setRelationshipKeyPathsForPrefetching:&unk_1F0FBF790];
  v9 = [v6 executeFetchRequest:v7 error:0];
  if (![v9 count])
  {
    goto LABEL_10;
  }

  objc_initWeak(&location, self);
  v10 = [PLRelationshipOrderKeyManager alloc];
  v154[0] = MEMORY[0x1E69E9820];
  v154[1] = 3221225472;
  v154[2] = __65__PLModelMigrator__populateAlbumAndFolderOrderKeysInStagedStore___block_invoke;
  v154[3] = &unk_1E7568DD0;
  objc_copyWeak(&v156, &location);
  v155 = v107;
  v11 = [(PLRelationshipOrderKeyManager *)v10 initWithGenerateContextBlock:v154];
  [(PLRelationshipOrderKeyManager *)v11 migration_updateLegacyOrderValuesForAssetsInAlbums:v9 managedObjectContext:v6];
  if (![v6 hasChanges])
  {

    objc_destroyWeak(&v156);
    objc_destroyWeak(&location);
LABEL_10:

    objc_autoreleasePoolPop(v5);
    goto LABEL_11;
  }

  v153 = 0;
  v12 = [v6 save:&v153];
  v13 = v153;
  if ((v12 & 1) == 0)
  {
    v14 = PLMigrationGetLog();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v115 = v12;
      v15 = NSStringFromSelector(a2);
      v16 = [v13 userInfo];
      *buf = 138412802;
      v166 = v15;
      v167 = 2112;
      v168 = v13;
      v169 = 2112;
      v113 = v16;
      v170 = v16;
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "%@ failed to update order values for album assets: %@ %@", buf, 0x20u);
      v110 = v15;

      v12 = v115;
    }
  }

  objc_destroyWeak(&v156);
  objc_destroyWeak(&location);

  objc_autoreleasePoolPop(v5);
  if ((v12 & 1) == 0)
  {
    v17 = 0;
    goto LABEL_76;
  }

LABEL_11:
  v100 = objc_autoreleasePoolPush();
  v116 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v107 name:"[PLModelMigrator _populateAlbumAndFolderOrderKeysInStagedStore:]" concurrencyType:v117];
  context = objc_autoreleasePoolPush();
  v114 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v18 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind == %d OR kind == %d", 4000, 3999];
  [v114 setPredicate:v18];

  v152 = 0;
  v19 = [v116 executeFetchRequest:v114 error:&v152];
  v106 = v152;
  if (!v19)
  {
    v72 = PLMigrationGetLog();
    if (os_log_type_enabled(v72, OS_LOG_TYPE_ERROR))
    {
      v73 = NSStringFromSelector(a2);
      v74 = [v106 userInfo];
      *buf = 138412802;
      v166 = v73;
      v167 = 2112;
      v168 = v106;
      v169 = 2112;
      v170 = v74;
      _os_log_impl(&dword_19BF1F000, v72, OS_LOG_TYPE_ERROR, "%@ failed to fetch folder: %@ %@", buf, 0x20u);
    }

    goto LABEL_74;
  }

  objc_initWeak(buf, self);
  v20 = [PLRelationshipOrderKeyManager alloc];
  v149[0] = MEMORY[0x1E69E9820];
  v149[1] = 3221225472;
  v149[2] = __65__PLModelMigrator__populateAlbumAndFolderOrderKeysInStagedStore___block_invoke_1454;
  v149[3] = &unk_1E7568DD0;
  objc_copyWeak(&v151, buf);
  v21 = v107;
  v150 = v21;
  v22 = [(PLRelationshipOrderKeyManager *)v20 initWithGenerateContextBlock:v149];
  v147 = 0u;
  v148 = 0u;
  v145 = 0u;
  v146 = 0u;
  v23 = v19;
  v24 = [v23 countByEnumeratingWithState:&v145 objects:v164 count:16];
  if (v24)
  {
    v25 = *v146;
    do
    {
      for (i = 0; i != v24; ++i)
      {
        if (*v146 != v25)
        {
          objc_enumerationMutation(v23);
        }

        v27 = *(*(&v145 + 1) + 8 * i);
        v28 = objc_autoreleasePoolPush();
        [(PLRelationshipOrderKeyManager *)v22 migration_updateLegacyChildCollectionOrderKeysInFolder:v27];
        objc_autoreleasePoolPop(v28);
      }

      v24 = [v23 countByEnumeratingWithState:&v145 objects:v164 count:16];
    }

    while (v24);
  }

  objc_destroyWeak(&v151);
  objc_destroyWeak(buf);
  if ([v116 hasChanges])
  {
    v144 = 0;
    v29 = [v116 save:&v144];
    v30 = v144;
    v31 = v30;
    if ((v29 & 1) == 0)
    {
      v78 = PLMigrationGetLog();
      if (os_log_type_enabled(v78, OS_LOG_TYPE_ERROR))
      {
        v79 = NSStringFromSelector(a2);
        v80 = [v31 userInfo];
        *buf = 138412802;
        v166 = v79;
        v167 = 2112;
        v168 = v31;
        v169 = 2112;
        v170 = v80;
        _os_log_impl(&dword_19BF1F000, v78, OS_LOG_TYPE_ERROR, "%@ failed to fixup child order keys: %@ %@", buf, 0x20u);
      }

      goto LABEL_74;
    }
  }

  objc_autoreleasePoolPop(context);
  objc_autoreleasePoolPop(v100);
  v100 = objc_autoreleasePoolPush();
  v116 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v21 name:"[PLModelMigrator _populateAlbumAndFolderOrderKeysInStagedStore:]" concurrencyType:v117];
  context = objc_autoreleasePoolPush();
  v114 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  [v114 setIncludesPropertyValues:0];
  [v114 setResultType:1];
  v32 = [MEMORY[0x1E696AE18] predicateWithFormat:@"kind == %@ OR kind == %@", &unk_1F0FBBD58, &unk_1F0FBBD70];
  [v114 setPredicate:v32];

  v143 = 0;
  v33 = [v116 executeFetchRequest:v114 error:&v143];
  v106 = v143;
  if (!v33)
  {
    v75 = PLMigrationGetLog();
    if (os_log_type_enabled(v75, OS_LOG_TYPE_ERROR))
    {
      v76 = NSStringFromSelector(a2);
      v77 = [v106 userInfo];
      *buf = 138412802;
      v166 = v76;
      v167 = 2112;
      v168 = v106;
      v169 = 2112;
      v170 = v77;
      _os_log_impl(&dword_19BF1F000, v75, OS_LOG_TYPE_ERROR, "%@ failed to fetch folders: %@ %@", buf, 0x20u);
    }

    [v116 reset];
LABEL_74:
    v17 = 0;
    goto LABEL_75;
  }

  v141 = 0u;
  v142 = 0u;
  v139 = 0u;
  v140 = 0u;
  obj = v33;
  v104 = [obj countByEnumeratingWithState:&v139 objects:v163 count:16];
  if (!v104)
  {
    goto LABEL_39;
  }

  v101 = *v140;
  while (2)
  {
    for (j = 0; j != v104; j = j + 1)
    {
      if (*v140 != v101)
      {
        objc_enumerationMutation(obj);
      }

      v35 = *(*(&v139 + 1) + 8 * j);
      v111 = objc_autoreleasePoolPush();
      v118 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
      [v118 setPropertiesToFetch:&unk_1F0FBF7A8];
      v36 = [MEMORY[0x1E696AE18] predicateWithFormat:@"parentFolder = %@", v35];
      [v118 setPredicate:v36];

      v37 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"albumToFolderOrderKey" ascending:1];
      v162 = v37;
      v38 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v162 count:1];
      [v118 setSortDescriptors:v38];

      v138 = 0;
      v39 = [v116 executeFetchRequest:v118 error:&v138];
      v108 = v138;
      v40 = [MEMORY[0x1E695DF70] arrayWithCapacity:{2 * objc_msgSend(v39, "count")}];
      v136 = 0u;
      v137 = 0u;
      v134 = 0u;
      v135 = 0u;
      v41 = v39;
      v42 = [v41 countByEnumeratingWithState:&v134 objects:v161 count:16];
      if (v42)
      {
        v43 = *v135;
        do
        {
          for (k = 0; k != v42; ++k)
          {
            if (*v135 != v43)
            {
              objc_enumerationMutation(v41);
            }

            v45 = *(*(&v134 + 1) + 8 * k);
            v46 = [v45 objectID];
            [v40 addObject:v46];

            v47 = [v45 valueForKey:@"albumToFolderOrderKey"];
            [v40 addObject:v47];
          }

          v42 = [v41 countByEnumeratingWithState:&v134 objects:v161 count:16];
        }

        while (v42);
      }

      v133 = 0;
      v48 = [v116 _updateLocationsOfObjectsToLocationByOrderKey:v40 inRelationshipWithName:@"childCollections" onObjectWithID:v35 error:&v133];
      v49 = v133;
      if (!v48)
      {
        v52 = PLMigrationGetLog();
        if (os_log_type_enabled(v52, OS_LOG_TYPE_ERROR))
        {
          v81 = NSStringFromSelector(a2);
          v82 = [v49 userInfo];
          *buf = 138412802;
          v166 = v81;
          v167 = 2112;
          v168 = v49;
          v169 = 2112;
          v170 = v82;
          _os_log_impl(&dword_19BF1F000, v52, OS_LOG_TYPE_ERROR, "%@ failed to update location values in childCollections: %@ %@", buf, 0x20u);
        }

        goto LABEL_73;
      }

      v132 = 0;
      v50 = [v116 save:&v132];
      v51 = v132;
      v52 = v51;
      if ((v50 & 1) == 0)
      {
        v83 = PLMigrationGetLog();
        if (os_log_type_enabled(v83, OS_LOG_TYPE_ERROR))
        {
          v84 = NSStringFromSelector(a2);
          v85 = [v52 userInfo];
          *buf = 138412802;
          v166 = v84;
          v167 = 2112;
          v168 = v52;
          v169 = 2112;
          v170 = v85;
          _os_log_impl(&dword_19BF1F000, v83, OS_LOG_TYPE_ERROR, "%@ failed to save updated location values in childCollections: %@ %@", buf, 0x20u);
        }

LABEL_73:
        objc_autoreleasePoolPop(v111);

        [v116 reset];
        goto LABEL_74;
      }

      objc_autoreleasePoolPop(v111);
    }

    v104 = [obj countByEnumeratingWithState:&v139 objects:v163 count:16];
    if (v104)
    {
      continue;
    }

    break;
  }

LABEL_39:

  [v116 reset];
  objc_autoreleasePoolPop(context);
  context = objc_autoreleasePoolPush();
  v114 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  [v114 setIncludesPropertyValues:0];
  [v114 setResultType:1];
  v53 = +[PLManagedAlbum albumSupportsAssetOrderKeysPredicate];
  [v114 setPredicate:v53];

  v131 = 0;
  v94 = [v116 executeFetchRequest:v114 error:&v131];
  v106 = v131;
  if (v94)
  {
    v129 = 0u;
    v130 = 0u;
    v127 = 0u;
    v128 = 0u;
    v95 = v94;
    obja = [v95 countByEnumeratingWithState:&v127 objects:v160 count:16];
    if (!obja)
    {
      v17 = 1;
      goto LABEL_87;
    }

    v96 = *v128;
LABEL_42:
    v109 = 0;
    while (1)
    {
      if (*v128 != v96)
      {
        objc_enumerationMutation(v95);
      }

      v112 = *(*(&v127 + 1) + 8 * v109);
      v105 = objc_autoreleasePoolPush();
      v119 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AssetToAlbumOrder"];
      v54 = [MEMORY[0x1E696AE18] predicateWithFormat:@"album = %@", v112];
      [v119 setPredicate:v54];

      v55 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"orderValue" ascending:1];
      v159 = v55;
      v56 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v159 count:1];
      [v119 setSortDescriptors:v56];

      v126 = 0;
      v57 = [v116 executeFetchRequest:v119 error:&v126];
      v102 = v126;
      v58 = [MEMORY[0x1E695DF70] arrayWithCapacity:{2 * objc_msgSend(v57, "count")}];
      v124 = 0u;
      v125 = 0u;
      v122 = 0u;
      v123 = 0u;
      v59 = v57;
      v60 = [v59 countByEnumeratingWithState:&v122 objects:v158 count:16];
      if (v60)
      {
        v61 = *v123;
        do
        {
          for (m = 0; m != v60; ++m)
          {
            if (*v123 != v61)
            {
              objc_enumerationMutation(v59);
            }

            v63 = *(*(&v122 + 1) + 8 * m);
            v64 = [v63 objectIDsForRelationshipNamed:@"asset"];
            v65 = [v64 firstObject];

            if (v65)
            {
              [v58 addObject:v65];
              v66 = [v63 valueForKey:@"orderValue"];
              [v58 addObject:v66];
            }
          }

          v60 = [v59 countByEnumeratingWithState:&v122 objects:v158 count:16];
        }

        while (v60);
      }

      v121 = 0;
      v67 = [v116 _updateLocationsOfObjectsToLocationByOrderKey:v58 inRelationshipWithName:@"assets" onObjectWithID:v112 error:&v121];
      v68 = v121;
      if (!v67)
      {
        break;
      }

      v120 = 0;
      v69 = [v116 save:&v120];
      v70 = v120;
      v71 = v70;
      if ((v69 & 1) == 0)
      {
        v91 = PLMigrationGetLog();
        if (os_log_type_enabled(v91, OS_LOG_TYPE_ERROR))
        {
          v92 = NSStringFromSelector(a2);
          v93 = [v71 userInfo];
          *buf = 138412802;
          v166 = v92;
          v167 = 2112;
          v168 = v71;
          v169 = 2112;
          v170 = v93;
          _os_log_impl(&dword_19BF1F000, v91, OS_LOG_TYPE_ERROR, "%@ failed to save updated location values in assets: %@ %@", buf, 0x20u);
        }

LABEL_85:
        objc_autoreleasePoolPop(v105);
        goto LABEL_86;
      }

      objc_autoreleasePoolPop(v105);
      if (++v109 == obja)
      {
        obja = [v95 countByEnumeratingWithState:&v127 objects:v160 count:16];
        v17 = 1;
        if (obja)
        {
          goto LABEL_42;
        }

        goto LABEL_87;
      }
    }

    v71 = PLMigrationGetLog();
    if (os_log_type_enabled(v71, OS_LOG_TYPE_ERROR))
    {
      v89 = NSStringFromSelector(a2);
      v90 = [v68 userInfo];
      *buf = 138412802;
      v166 = v89;
      v167 = 2112;
      v168 = v68;
      v169 = 2112;
      v170 = v90;
      _os_log_impl(&dword_19BF1F000, v71, OS_LOG_TYPE_ERROR, "%@ failed to update location values in assets: %@ %@", buf, 0x20u);
    }

    goto LABEL_85;
  }

  v95 = PLMigrationGetLog();
  if (os_log_type_enabled(v95, OS_LOG_TYPE_ERROR))
  {
    v87 = NSStringFromSelector(a2);
    v88 = [v106 userInfo];
    *buf = 138412802;
    v166 = v87;
    v167 = 2112;
    v168 = v106;
    v169 = 2112;
    v170 = v88;
    _os_log_impl(&dword_19BF1F000, v95, OS_LOG_TYPE_ERROR, "%@ failed to fetch albums: %@ %@", buf, 0x20u);
  }

LABEL_86:
  v17 = 0;
LABEL_87:

LABEL_75:
  objc_autoreleasePoolPop(context);

  objc_autoreleasePoolPop(v100);
LABEL_76:

  return v17;
}

id __65__PLModelMigrator__populateAlbumAndFolderOrderKeysInStagedStore___block_invoke(uint64_t a1, uint64_t a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v5 = [WeakRetained managedObjectContextForMigrationInStore:*(a1 + 32) name:a2 concurrencyType:1];

  return v5;
}

id __65__PLModelMigrator__populateAlbumAndFolderOrderKeysInStagedStore___block_invoke_1454(uint64_t a1, uint64_t a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v5 = [WeakRetained managedObjectContextForMigrationInStore:*(a1 + 32) name:a2 concurrencyType:1];

  return v5;
}

- (BOOL)_resetAlbumToFolderOrderKeyForAlbums:(id)a3
{
  v34 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _resetAlbumToFolderOrderKeyForAlbums:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v8 = MEMORY[0x1E696AE18];
  v9 = [MEMORY[0x1E696AD98] numberWithInt:2];
  v10 = [MEMORY[0x1E696AD98] numberWithInt:4000];
  v11 = [v8 predicateWithFormat:@"kind == %@ OR kind == %@", v9, v10];
  [v7 setPredicate:v11];

  [v6 executeFetchRequest:v7 error:0];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v12 = v28 = 0u;
  v13 = [v12 countByEnumeratingWithState:&v25 objects:v33 count:16];
  if (v13)
  {
    v14 = v13;
    v15 = *v26;
    do
    {
      for (i = 0; i != v14; ++i)
      {
        if (*v26 != v15)
        {
          objc_enumerationMutation(v12);
        }

        v17 = *(*(&v25 + 1) + 8 * i);
        v18 = objc_autoreleasePoolPush();
        [v17 setCloudLocalState:0];
        objc_autoreleasePoolPop(v18);
      }

      v14 = [v12 countByEnumeratingWithState:&v25 objects:v33 count:16];
    }

    while (v14);
  }

  if ([v6 hasChanges])
  {
    v24 = 0;
    v19 = [v6 save:&v24];
    v20 = v24;
    if ((v19 & 1) == 0)
    {
      v21 = PLMigrationGetLog();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        v22 = [v20 userInfo];
        *buf = 138412546;
        v30 = v20;
        v31 = 2112;
        v32 = v22;
        _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "_resetAlbumToFolderOrderKeyForAlbums failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v19 = 1;
  }

  objc_autoreleasePoolPop(v5);
  return v19;
}

- (BOOL)_fixupAlbumOrderInAlbumListInStore:(id)a3
{
  v36 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v25 = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupAlbumOrderInAlbumListInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [PLManagedAlbumList albumListInManagedObjectContext:v5];
  v7 = [v6 albums];
  v8 = [v7 copy];

  v9 = [MEMORY[0x1E695DF70] array];
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v10 = v8;
  v11 = [v10 countByEnumeratingWithState:&v27 objects:v35 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v28;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v28 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v27 + 1) + 8 * i);
        v16 = objc_autoreleasePoolPush();
        if ([v15 kindValue] == 2)
        {
          [v9 addObject:v15];
        }

        else
        {
          [v6 insertIntoOrderedAlbumsAtIndexByPriorityForAlbum:v15];
        }

        objc_autoreleasePoolPop(v16);
      }

      v12 = [v10 countByEnumeratingWithState:&v27 objects:v35 count:16];
    }

    while (v12);
  }

  v17 = [v6 albums];
  [v17 removeObjectsInArray:v9];

  v18 = [v6 albums];
  [v18 addObjectsFromArray:v9];

  v19 = [(PLGenericAlbum *)PLManagedFolder albumWithKind:3999 inManagedObjectContext:v5];
  [PLManagedAlbumList pushChangesFromAlbumContainer:v6 toAlbumContainer:v19];
  if ([v5 hasChanges])
  {
    v26 = 0;
    v20 = [v5 save:&v26];
    v21 = v26;
    if ((v20 & 1) == 0)
    {
      v22 = PLMigrationGetLog();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
      {
        v23 = [v21 userInfo];
        *buf = 138412546;
        v32 = v21;
        v33 = 2112;
        v34 = v23;
        _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "_fixupAlbumOrderInAlbumListInStore failed: %@ %@", buf, 0x16u);
      }
    }
  }

  else
  {
    v20 = 1;
  }

  objc_autoreleasePoolPop(v25);
  return v20;
}

- (BOOL)_fixupImportedAssetsInStore:(id)a3
{
  v61 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v36 = objc_autoreleasePoolPush();
  v37 = v4;
  v40 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupImportedAssetsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v5 = [PLGenericAlbum albumWithKind:1604 inManagedObjectContext:?];
  v6 = [MEMORY[0x1E695DF70] array];
  v50 = 0u;
  v51 = 0u;
  v52 = 0u;
  v53 = 0u;
  v35 = v5;
  v7 = [v5 assets];
  v8 = [v7 countByEnumeratingWithState:&v50 objects:v60 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = 0;
    v11 = *v51;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v51 != v11)
        {
          objc_enumerationMutation(v7);
        }

        v13 = *(*(&v50 + 1) + 8 * i);
        if (![v13 savedAssetType])
        {
          if (!v10)
          {
            v10 = [MEMORY[0x1E695DF70] array];
            [v6 addObject:v10];
          }

          [v10 addObject:v13];
          if ([v10 count]>= 0x64)
          {

            v10 = 0;
          }
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v50 objects:v60 count:16];
    }

    while (v9);
  }

  else
  {
    v10 = 0;
  }

  v48 = 0u;
  v49 = 0u;
  v46 = 0u;
  v47 = 0u;
  v14 = v6;
  v15 = [v14 countByEnumeratingWithState:&v46 objects:v59 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = 0;
    obj = v14;
    v39 = *v47;
    while (2)
    {
      for (j = 0; j != v16; ++j)
      {
        if (*v47 != v39)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v46 + 1) + 8 * j);

        v20 = objc_autoreleasePoolPush();
        v42 = 0u;
        v43 = 0u;
        v44 = 0u;
        v45 = 0u;
        v10 = v19;
        v21 = [v10 countByEnumeratingWithState:&v42 objects:v58 count:16];
        if (v21)
        {
          v22 = v21;
          v23 = *v43;
          do
          {
            for (k = 0; k != v22; ++k)
            {
              if (*v43 != v23)
              {
                objc_enumerationMutation(v10);
              }

              [*(*(&v42 + 1) + 8 * k) setSavedAssetType:{objc_msgSend(MEMORY[0x1E69BF328], "savedAssetTypeForImportedByCameraConnectionKit")}];
            }

            v17 += v22;
            v22 = [v10 countByEnumeratingWithState:&v42 objects:v58 count:16];
          }

          while (v22);
        }

        v41 = 0;
        v25 = [v40 save:&v41];
        v26 = v41;
        v27 = v26;
        if ((v25 & 1) == 0)
        {
          v32 = PLMigrationGetLog();
          if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
          {
            v33 = [v27 userInfo];
            *buf = 138412546;
            v55 = v27;
            v56 = 2112;
            v57 = v33;
            _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_ERROR, "_fixupImportedAssetsInStore failed: %@ %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v20);
          v14 = obj;

          v30 = 0;
          goto LABEL_38;
        }

        objc_autoreleasePoolPop(v20);
      }

      v14 = obj;
      v16 = [obj countByEnumeratingWithState:&v46 objects:v59 count:16];
      if (v16)
      {
        continue;
      }

      break;
    }

    if (!v17)
    {
      v30 = 1;
      v28 = v36;
      v31 = v37;
      v29 = v35;
      goto LABEL_40;
    }

    v10 = PLMigrationGetLog();
    v29 = v35;
    v28 = v36;
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v55) = v17;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Fixed asset save type on %d CCK assets", buf, 8u);
    }

    v30 = 1;
    v31 = v37;
  }

  else
  {

    v30 = 1;
    v10 = v14;
LABEL_38:
    v28 = v36;
    v31 = v37;
    v29 = v35;
  }

LABEL_40:
  objc_autoreleasePoolPop(v28);

  return v30;
}

- (BOOL)_fixupImportedEventsInStore:(id)a3
{
  v32 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v25 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupImportedEventsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v26 = [PLManagedAlbumList importListInManagedObjectContext:v5];
  v6 = [PLManagedAlbumList eventListInManagedObjectContext:v5];
  v7 = [v6 albums];
  v8 = [MEMORY[0x1E695DFB8] orderedSetWithOrderedSet:v7];
  v9 = [v8 count];
  v10 = [MEMORY[0x1E695DF70] array];
  v11 = [MEMORY[0x1E696AD50] indexSet];
  if (v9)
  {
    for (i = 0; i != v9; ++i)
    {
      v13 = objc_autoreleasePoolPush();
      v14 = [v8 objectAtIndex:i];
      if ([v14 kindValue] == 12)
      {
        [v10 addObject:v14];
        [v11 addIndex:i];
      }

      objc_autoreleasePoolPop(v13);
    }
  }

  v15 = [v10 count];
  if (v15)
  {
    v16 = [v26 albums];
    v17 = [MEMORY[0x1E696AC90] indexSetWithIndexesInRange:{0, v15}];
    [v16 insertObjects:v10 atIndexes:v17];
    [v7 removeObjectsAtIndexes:v11];
  }

  if ([v5 hasChanges])
  {
    v27 = 0;
    v18 = [v5 save:&v27];
    v19 = v27;
    v20 = PLMigrationGetLog();
    v21 = v20;
    if (v18)
    {
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109120;
        LODWORD(v29) = v15;
        _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "Moved %d import events into import list", buf, 8u);
      }
    }

    else if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v22 = [v19 userInfo];
      *buf = 138412546;
      v29 = v19;
      v30 = 2112;
      v31 = v22;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "_fixupImportedEventsInStore failed: %@ %@", buf, 0x16u);
    }
  }

  else
  {
    v18 = 1;
  }

  objc_autoreleasePoolPop(context);
  return v18;
}

- (BOOL)_updateKindSubtypeForPanoramaPhotosNeedsReset:(BOOL)a3 inStore:(id)a4
{
  v4 = a3;
  v34 = *MEMORY[0x1E69E9840];
  v7 = a4;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v27 = [MEMORY[0x1E696AAA8] currentHandler];
    v28 = NSStringFromSelector(a2);
    [v27 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:5397 description:{@"%@ can only be called from assetsd", v28}];
  }

  v8 = [v7 URL];
  v9 = [v8 path];
  v10 = [v9 fileSystemRepresentation];

  v11 = PLOpenSQLTransactionWithDBPath(v10);
  if (!v11)
  {
    goto LABEL_17;
  }

  v12 = v11;
  errmsg = 0;
  if (!v4)
  {
LABEL_10:
    v18 = [MEMORY[0x1E696AEC0] stringWithFormat:@"SET ZKINDSUBTYPE=%d, ZCLOUDLOCALSTATE=%d", 1, 0];
    v19 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(((cast(ZWIDTH as real) / cast(ZHEIGHT as real)) > %f) OR (cast(ZHEIGHT as real) / cast(ZWIDTH as real)) > %f) ", 0x4000000000000000, 0x4000000000000000];
    v20 = [MEMORY[0x1E696AEC0] stringWithFormat:@"(ZHEIGHT > %d AND ZHEIGHT < %d AND ZWIDTH > %d and ZWIDTH < %d)", 800, 30000, 800, 30000];
    v21 = [MEMORY[0x1E696AEC0] stringWithFormat:@"UPDATE ZASSET %@ WHERE %@ AND %@", v18, v19, v20];
    v15 = sqlite3_exec(v12, [v21 UTF8String], 0, 0, &errmsg);

    if (v15)
    {
      goto LABEL_11;
    }

    v24 = sqlite3_changes(v12);
    v25 = PLMigrationGetLog();
    if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v31 = v24;
      _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_DEFAULT, "Updated %d panorama photos with subtypes", buf, 8u);
    }

    PLCommitSQLTransactionAndCloseDB(v12);
LABEL_17:
    v23 = 1;
    goto LABEL_18;
  }

  v13 = [MEMORY[0x1E696AEC0] stringWithFormat:@"UPDATE ZASSET SET ZKINDSUBTYPE=%d WHERE ZKINDSUBTYPE=%d", 0, 1];
  v14 = sqlite3_exec(v12, [v13 UTF8String], 0, 0, &errmsg);
  if (!v14)
  {
    v16 = sqlite3_changes(v12);
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      v31 = v16;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Reset %d panorama photo subtypes", buf, 8u);
    }

    goto LABEL_10;
  }

  v15 = v14;

LABEL_11:
  v22 = PLMigrationGetLog();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
  {
    *buf = 67109378;
    v31 = v15;
    v32 = 2080;
    v33 = errmsg;
    _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "Failed to update panorama subtypes, %d %s", buf, 0x12u);
  }

  PLRollbackSQLTransactionAndCloseDB(v12);
  v23 = 0;
LABEL_18:

  return v23;
}

- (BOOL)_initiateLightweightReimportOfAllPhotoCloudSharingMetadataInStore:(id)a3
{
  v34 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = MEMORY[0x1E69BF2A0];
  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 libraryURL];
  LODWORD(v5) = [v5 isSystemPhotoLibraryURL:v7];

  if (v5)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _initiateLightweightReimportOfAllPhotoCloudSharingMetadataInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
    v29 = 0;
    v10 = [(PLModelMigrator *)self _populateLightweightReimportDirectoryWithPhotoCloudSharingAssetsInManagedObjectContext:v9 error:&v29];
    v11 = v29;
    if (!v10)
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = [v11 userInfo];
        *buf = 138412546;
        v31 = v11;
        v32 = 2112;
        v33 = v13;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "Unable to populate the photo cloud sharing lightweight reimport cache %@ %@", buf, 0x16u);
      }
    }

    v28 = 0;
    v14 = [(PLModelMigrator *)self _deletePhotoCloudSharingMetadataInManagedObjectContext:v9 error:&v28];
    v15 = v28;
    v16 = v15;
    if (v14)
    {
      v27 = 0;
      v17 = [PLPhotoSharingHelper removeCloudSharingDirectories:&v27];
      v18 = v27;
      v19 = v18;
      if (v17)
      {

        v20 = PLMigrationGetLog();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Telling mstreamd to forget everything to initiate lightweight reimport of photo cloud sharing metadata ", buf, 2u);
        }

        [PLPhotoSharingHelper forgetSharingPersonID:0];
        v21 = +[PLNotificationManager sharedManager];
        [v21 discardAllNotifications];
        v22 = 1;
LABEL_17:

        objc_autoreleasePoolPop(v8);
        goto LABEL_18;
      }
    }

    else
    {
      v19 = v15;
    }

    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v23 = [v19 localizedDescription];
      v24 = [v19 userInfo];
      v25 = [v24 description];
      *buf = 138412546;
      v31 = v23;
      v32 = 2112;
      v33 = v25;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "Failed to initiate lightweight reimport of photo cloud sharing metadata %@ %@", buf, 0x16u);
    }

    v22 = 0;
    v16 = v19;
    goto LABEL_17;
  }

  v22 = 1;
LABEL_18:

  return v22;
}

- (BOOL)_populateLightweightReimportDirectoryWithPhotoCloudSharingAssetsInManagedObjectContext:(id)a3 error:(id *)a4
{
  v136 = *MEMORY[0x1E69E9840];
  v82 = a3;
  v102 = [MEMORY[0x1E696AC08] defaultManager];
  v6 = [(PLModelMigrator *)self pathManager];
  v83 = [v6 photoDirectoryWithType:23];

  v7 = [(PLModelMigrator *)self pathManager];
  v88 = [v7 privateCacheDirectoryWithSubType:3];

  v8 = PLMigrationGetLog();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 138412290;
    *v126 = v88;
    _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Moving all photo cloud sharing asset data into lightweight reimport cache directory %@", buf, 0xCu);
  }

  v9 = v102;
  if ([v102 fileExistsAtPath:v83])
  {
    v10 = [PLGenericAlbum albumsWithKind:1505 inManagedObjectContext:v82];
    if (![v10 count])
    {
      v12 = PLMigrationGetLog();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "No photo cloud sharing albums found, nothing to move", buf, 2u);
      }

      goto LABEL_106;
    }

    v124 = 0;
    if ([v102 fileExistsAtPath:v88 isDirectory:&v124] && (v124 & 1) != 0)
    {
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Found existing lightweight reimport cloud sharing data cache directory, merging asset data", buf, 2u);
      }

      v12 = 0;
    }

    else
    {
      v123 = 0;
      v14 = [v102 createDirectoryAtPath:v88 withIntermediateDirectories:1 attributes:0 error:&v123];
      v12 = v123;
      if ((v14 & 1) == 0)
      {
        v75 = PLMigrationGetLog();
        if (os_log_type_enabled(v75, OS_LOG_TYPE_ERROR))
        {
          v76 = [v12 localizedDescription];
          v77 = [v12 userInfo];
          v78 = [v77 description];
          *buf = 138412802;
          *v126 = v88;
          *&v126[8] = 2112;
          v127 = v76;
          v128 = 2112;
          v129 = v78;
          _os_log_impl(&dword_19BF1F000, v75, OS_LOG_TYPE_ERROR, "Unable to create photo cloud sharing lightweight reimport cache directory %@: %@ %@", buf, 0x20u);

          v9 = v102;
        }

        if (a4)
        {
          v79 = v12;
          v13 = 0;
          *a4 = v12;
LABEL_107:

          goto LABEL_108;
        }

LABEL_113:
        v13 = 0;
        goto LABEL_107;
      }
    }

    v121 = 0u;
    v122 = 0u;
    v119 = 0u;
    v120 = 0u;
    v15 = v10;
    v93 = [v15 countByEnumeratingWithState:&v119 objects:v135 count:16];
    if (v93)
    {
      v103 = 0;
      v92 = *v120;
      v84 = *MEMORY[0x1E69BFEE8];
      v85 = v15;
      v86 = v10;
      do
      {
        for (i = 0; i != v93; ++i)
        {
          if (*v120 != v92)
          {
            objc_enumerationMutation(v15);
          }

          v17 = *(*(&v119 + 1) + 8 * i);
          v18 = [v17 assets];
          v19 = [v18 copy];

          v20 = v19;
          if ([v19 count])
          {
            v21 = [v17 cloudPersonID];
            v94 = [v17 cloudGUID];
            v95 = v21;
            v96 = [PLCloudSharedAlbum lightweightReimportDirectoryNameWithGUID:"lightweightReimportDirectoryNameWithGUID:cloudPersonID:" cloudPersonID:?];
            v107 = [v88 stringByAppendingPathComponent:?];
            v97 = i;
            if ([v9 fileExistsAtPath:? isDirectory:?] && (v124 & 1) != 0)
            {
              v22 = PLMigrationGetLog();
              if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
              {
                *buf = 138412290;
                *v126 = v96;
                _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "Found existing lightweight reimport cloud sharing data cache directory for album '%@', merging asset data", buf, 0xCu);
              }

              v87 = 1;
LABEL_27:
              v91 = v12;
              context = objc_autoreleasePoolPush();
              v105 = [MEMORY[0x1E695DF90] dictionary];
              v24 = [MEMORY[0x1E695DF90] dictionary];
              v114 = 0u;
              v115 = 0u;
              v116 = 0u;
              v117 = 0u;
              v90 = v20;
              obj = v20;
              v25 = [obj countByEnumeratingWithState:&v114 objects:v134 count:16];
              v104 = v24;
              if (!v25)
              {
                goto LABEL_67;
              }

              v26 = v25;
              v27 = *v115;
              v106 = *v115;
              while (2)
              {
                v28 = 0;
                v108 = v26;
LABEL_30:
                if (*v115 != v27)
                {
                  objc_enumerationMutation(obj);
                }

                v29 = *(*(&v114 + 1) + 8 * v28);
                v30 = [v29 cloudAssetGUID];
                if ([v29 hasAllThumbs])
                {
                  v31 = [v29 filename];
                  if (v31)
                  {
                    v32 = [v24 objectForKey:v31];
                    if (v32)
                    {
                      v33 = v32;
                      [v105 removeObjectForKey:v32];
                      v34 = [PLManagedAsset lightweightReimportFileNameWithGUID:v33 type:0];
                      v35 = [v107 stringByAppendingPathComponent:v34];
                      v36 = PLMigrationGetLog();
                      if (os_log_type_enabled(v36, OS_LOG_TYPE_DEBUG))
                      {
                        *buf = 138412802;
                        *v126 = v34;
                        *&v126[8] = 2112;
                        v127 = v30;
                        v128 = 2112;
                        v129 = v33;
                        _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEBUG, "Found two assets pointing to the same file %@ on disk, ommiting %@ and %@ from the reimport cache", buf, 0x20u);
                      }

                      v113 = 0;
                      v37 = [v9 removeItemAtPath:v35 error:&v113];
                      v38 = v113;
                      if ((v37 & 1) == 0)
                      {
                        v39 = PLMigrationGetLog();
                        if (os_log_type_enabled(v39, OS_LOG_TYPE_ERROR))
                        {
                          v98 = [v38 localizedDescription];
                          v100 = [v38 userInfo];
                          v40 = [v100 description];
                          *buf = 138413314;
                          *v126 = v30;
                          *&v126[8] = 2112;
                          v127 = v33;
                          v128 = 2112;
                          v129 = v35;
                          v130 = 2112;
                          v131 = v98;
                          v132 = 2112;
                          v133 = v40;
                          _os_log_impl(&dword_19BF1F000, v39, OS_LOG_TYPE_ERROR, "Unable to remove shared asset data with references from %@ and %@ at path %@, %@ %@", buf, 0x34u);

                          v24 = v104;
                          v9 = v102;
                        }
                      }

                      goto LABEL_63;
                    }
                  }

                  v41 = [v29 pathForOriginalFile];
                  v33 = v41;
                  if (v31)
                  {
                    v42 = v41 == 0;
                  }

                  else
                  {
                    v42 = 1;
                  }

                  if (v42)
                  {
                    v34 = PLMigrationGetLog();
                    if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
                    {
                      *buf = 138412802;
                      *v126 = v30;
                      *&v126[8] = 2112;
                      v127 = v31;
                      v128 = 2112;
                      v129 = v33;
                      _os_log_impl(&dword_19BF1F000, v34, OS_LOG_TYPE_DEFAULT, "Skipping asset %@ with missing filename or path (%@, %@)", buf, 0x20u);
                    }

                    v38 = 0;
                  }

                  else
                  {
                    [v24 setObject:v30 forKey:v31];
                    v34 = [PLManagedAsset lightweightReimportFileNameWithGUID:v30 type:0];
                    v43 = [v107 stringByAppendingPathComponent:v34];
                    v112 = 0;
                    v44 = [v9 linkItemAtPath:v33 toPath:v43 error:&v112];
                    v45 = v112;
                    v38 = v45;
                    if (v44)
                    {
                      goto LABEL_54;
                    }

                    if ([v45 code] != 516)
                    {
                      goto LABEL_60;
                    }

                    v47 = PLMigrationGetLog();
                    if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
                    {
                      *buf = 138412290;
                      *v126 = v30;
                      _os_log_impl(&dword_19BF1F000, v47, OS_LOG_TYPE_DEFAULT, "Attempting to replace existing cached image for %@", buf, 0xCu);
                    }

                    if ([v9 removeItemAtPath:v33 error:0] && (v111 = v38, v48 = objc_msgSend(v9, "linkItemAtPath:toPath:error:", v33, v43, &v111), v49 = v111, v38, v38 = v49, v9 = v102, (v48 & 1) != 0))
                    {
LABEL_54:
                      ++HIDWORD(v103);
                      v46 = [MEMORY[0x1E695DF90] dictionary];
                      [v105 setObject:v46 forKey:v30];
                    }

                    else
                    {
LABEL_60:
                      LODWORD(v103) = v103 + 1;
                      v46 = PLMigrationGetLog();
                      if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
                      {
                        v99 = [v38 localizedDescription];
                        v101 = [v38 userInfo];
                        v50 = [v101 description];
                        *buf = 138413314;
                        *v126 = v30;
                        *&v126[8] = 2112;
                        v127 = v33;
                        v128 = 2112;
                        v129 = v43;
                        v130 = 2112;
                        v131 = v99;
                        v132 = 2112;
                        v133 = v50;
                        _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_ERROR, "Unable to link shared asset data for %@ from %@ to %@, %@ %@", buf, 0x34u);

                        v9 = v102;
                      }
                    }

                    v24 = v104;
LABEL_63:
                    v27 = v106;
                    v26 = v108;
                  }
                }

                else
                {
                  v31 = PLMigrationGetLog();
                  if (os_log_type_enabled(v31, OS_LOG_TYPE_DEBUG))
                  {
                    *buf = 138412290;
                    *v126 = v30;
                    _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_DEBUG, "Skipping cloud shared asset %@ with missing thumbs", buf, 0xCu);
                  }

                  v38 = 0;
                }

                if (v26 == ++v28)
                {
                  v26 = [obj countByEnumeratingWithState:&v114 objects:v134 count:16];
                  if (!v26)
                  {
LABEL_67:

                    v51 = v105;
                    if ([v105 count])
                    {
                      v52 = [v107 stringByAppendingPathComponent:v84];
                      v15 = v85;
                      v10 = v86;
                      v12 = v91;
                      i = v97;
                      if (v87)
                      {
                        v53 = [MEMORY[0x1E695DF90] dictionaryWithContentsOfFile:v52];
                        v54 = v53;
                        if (v53 && [v53 count])
                        {
                          [v54 addEntriesFromDictionary:v105];
                          v55 = v54;

                          v110 = v91;
                          v56 = [v102 removeItemAtPath:v52 error:&v110];
                          v57 = v110;

                          if ((v56 & 1) == 0)
                          {
                            v58 = PLMigrationGetLog();
                            if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
                            {
                              v59 = [v57 localizedDescription];
                              v60 = [v57 userInfo];
                              v61 = [v60 description];
                              *buf = 138412802;
                              *v126 = v52;
                              *&v126[8] = 2112;
                              v127 = v59;
                              v128 = 2112;
                              v129 = v61;
                              _os_log_impl(&dword_19BF1F000, v58, OS_LOG_TYPE_ERROR, "Unable to remove previous cached album info dictionary from %@, %@ %@", buf, 0x20u);
                            }
                          }

                          v24 = v104;
                        }

                        else
                        {
                          v55 = v105;
                          v57 = v91;
                        }

                        v67 = v55;
                        v12 = v57;
                        i = v97;
                      }

                      else
                      {
                        v67 = v105;
                      }

                      v68 = v67;
                      v69 = [MEMORY[0x1E696AE40] dataWithPropertyList:? format:? options:? error:?];
                      if (([v69 writeToFile:v52 options:1073741825 error:0] & 1) == 0)
                      {
                        v70 = PLMigrationGetLog();
                        if (os_log_type_enabled(v70, OS_LOG_TYPE_ERROR))
                        {
                          *buf = 138412290;
                          *v126 = v52;
                          _os_log_impl(&dword_19BF1F000, v70, OS_LOG_TYPE_ERROR, "Failed to write cached album info dictionary %@", buf, 0xCu);
                        }

                        i = v97;
                      }

                      v9 = v102;
                      v51 = v68;
                    }

                    else
                    {
                      v15 = v85;
                      v10 = v86;
                      v12 = v91;
                      i = v97;
                    }

                    objc_autoreleasePoolPop(context);
                    v20 = v90;
                    goto LABEL_89;
                  }

                  continue;
                }

                goto LABEL_30;
              }
            }

            v118 = 0;
            v23 = [v9 createDirectoryAtPath:v107 withIntermediateDirectories:1 attributes:0 error:&v118];
            v12 = v118;
            if (v23)
            {
              v87 = 0;
              goto LABEL_27;
            }

            v62 = PLMigrationGetLog();
            if (os_log_type_enabled(v62, OS_LOG_TYPE_ERROR))
            {
              [v12 localizedDescription];
              v64 = v63 = v20;
              v65 = [v12 userInfo];
              v66 = [v65 description];
              *buf = 138412802;
              *v126 = v107;
              *&v126[8] = 2112;
              v127 = v64;
              v128 = 2112;
              v129 = v66;
              _os_log_impl(&dword_19BF1F000, v62, OS_LOG_TYPE_ERROR, "Unable to create photo cloud sharing lightweight reimport cache directory '%@' for album: %@ %@", buf, 0x20u);

              v9 = v102;
              i = v97;

              v20 = v63;
            }

LABEL_89:
          }
        }

        v93 = [v15 countByEnumeratingWithState:&v119 objects:v135 count:16];
      }

      while (v93);

      if (SHIDWORD(v103) >= 1)
      {
        v71 = PLMigrationGetLog();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 67109376;
          *v126 = HIDWORD(v103);
          *&v126[4] = 1024;
          *&v126[6] = v103;
          v72 = "Successfully cached %d shared asset image files to lightweight reimport cloud sharing data cache (%d failed)";
          v73 = v71;
          v74 = 14;
LABEL_104:
          _os_log_impl(&dword_19BF1F000, v73, OS_LOG_TYPE_DEFAULT, v72, buf, v74);
          goto LABEL_105;
        }

        goto LABEL_105;
      }

      if (v103 >= 1)
      {
        v81 = PLMigrationGetLog();
        if (os_log_type_enabled(v81, OS_LOG_TYPE_ERROR))
        {
          *buf = 67109120;
          *v126 = v103;
          _os_log_impl(&dword_19BF1F000, v81, OS_LOG_TYPE_ERROR, "Failed to cache any shared asset image files to lightweight reimport cloud sharing data cache (%d failed)", buf, 8u);
        }

        goto LABEL_113;
      }
    }

    else
    {
    }

    v71 = PLMigrationGetLog();
    if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v72 = "No shared asset image files found, none cached to lightweight reimport cloud sharing data cache";
      v73 = v71;
      v74 = 2;
      goto LABEL_104;
    }

LABEL_105:

LABEL_106:
    v13 = 1;
    goto LABEL_107;
  }

  v10 = PLMigrationGetLog();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "No cloud sharing data directory found, no photo shared asset data to migrate", buf, 2u);
  }

  v13 = 1;
LABEL_108:

  return v13;
}

- (BOOL)_postProcessFromVersion6006Store:(id)a3
{
  v4 = a3;
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEFAULT, "Rebuild photo cloud sharing metadata", buf, 2u);
  }

  if (![(PLModelMigrator *)self _initiateLightweightReimportOfAllPhotoCloudSharingMetadataInStore:v4])
  {
    goto LABEL_17;
  }

  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    *v17 = 0;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Fixing imported CCK events list.", v17, 2u);
  }

  if (![(PLModelMigrator *)self _fixupImportedEventsInStore:v4])
  {
    goto LABEL_17;
  }

  v7 = PLMigrationGetLog();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    *v16 = 0;
    _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "Fixing CCK asset types", v16, 2u);
  }

  if (![(PLModelMigrator *)self _fixupImportedAssetsInStore:v4])
  {
    goto LABEL_17;
  }

  v8 = [(PLModelMigrator *)self pathManager];
  v9 = [v8 isDCIM];

  if (!v9)
  {
    goto LABEL_14;
  }

  v10 = PLMigrationGetLog();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    *v15 = 0;
    _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Fixing sync'd asset attributes", v15, 2u);
  }

  if ([(PLModelMigrator *)self _fixupSyncedAssetAttributesInStore:v4])
  {
LABEL_14:
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *v14 = 0;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Moving My Photo Stream to Albums list.", v14, 2u);
    }

    v12 = [(PLModelMigrator *)self _moveMyPhotoStreamToAlbumsListInStore:v4];
  }

  else
  {
LABEL_17:
    v12 = 0;
  }

  return v12;
}

- (void)applyDataProtectionToAllPhotosFilesOnce
{
  v2 = self;
  v76[3] = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 isDataProtectionComplete];

  if (v4)
  {
    return;
  }

  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEFAULT, "Applying Photos data protection", buf, 2u);
  }

  v6 = 0x1E695D000uLL;
  [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
  v8 = v7;
  v9 = [(PLModelMigrator *)v2 pathManager];
  if ([v9 isDCIM])
  {
    v10 = [v9 photoDirectoryWithType:4];
    v76[0] = v10;
    v11 = [v9 iTunesPhotosDirectory];
    v76[1] = v11;
    v12 = [v9 photoDirectoryWithType:15];
    v76[2] = v12;
    v55 = [MEMORY[0x1E695DEC8] arrayWithObjects:v76 count:3];

    v56 = [MEMORY[0x1E695DF70] array];
    context = objc_autoreleasePoolPush();
    v13 = [v9 photoDirectoryWithType:34];
    v14 = [MEMORY[0x1E696AC08] defaultManager];
    v15 = [v14 contentsOfDirectoryAtPath:v13 error:0];

    v69 = 0u;
    v70 = 0u;
    v67 = 0u;
    v68 = 0u;
    v16 = v15;
    v17 = [v16 countByEnumeratingWithState:&v67 objects:v75 count:16];
    if (v17)
    {
      v18 = v17;
      obj = v16;
      v53 = v9;
      v19 = 0;
      v20 = *v68;
      v21 = v56;
      do
      {
        for (i = 0; i != v18; ++i)
        {
          if (*v68 != v20)
          {
            objc_enumerationMutation(obj);
          }

          v23 = *(*(&v67 + 1) + 8 * i);
          v24 = [v23 isEqualToString:{@"Caches", v53}];
          v25 = [v13 stringByAppendingPathComponent:v23];
          v26 = v25;
          if (v24)
          {
            v27 = v19;
            v19 = v25;
          }

          else
          {
            if (![(PLModelMigrator *)v2 skipDataProtectionForFilePath:v25])
            {
              [v56 addObject:v26];
            }

            v27 = v26;
          }
        }

        v18 = [obj countByEnumeratingWithState:&v67 objects:v75 count:16];
      }

      while (v18);
      v16 = obj;

      if (!v19)
      {
        v9 = v53;
        v6 = 0x1E695D000;
LABEL_46:

        objc_autoreleasePoolPop(context);
        [v55 arrayByAddingObjectsFromArray:v21];
        v49 = v48 = v21;
        [(PLModelMigrator *)v2 applyDataProtectionToPhotosPaths:v49 fromKeyClass:4 toKeyClass:3];

        goto LABEL_47;
      }

      v57 = v2;
      v28 = [MEMORY[0x1E696AC08] defaultManager];
      v29 = [v28 contentsOfDirectoryAtPath:v19 error:0];

      v65 = 0u;
      v66 = 0u;
      v63 = 0u;
      v64 = 0u;
      v30 = v29;
      v31 = [v30 countByEnumeratingWithState:&v63 objects:v74 count:16];
      if (v31)
      {
        v32 = v31;
        v33 = 0;
        v34 = *v64;
        do
        {
          for (j = 0; j != v32; ++j)
          {
            if (*v64 != v34)
            {
              objc_enumerationMutation(v30);
            }

            v36 = *(*(&v63 + 1) + 8 * j);
            v37 = [v36 isEqualToString:@"search"];
            v38 = [v19 stringByAppendingPathComponent:v36];
            v39 = v38;
            if (v37)
            {
              v40 = v33;
              v33 = v38;
            }

            else
            {
              if (![(PLModelMigrator *)v57 skipDataProtectionForFilePath:v38])
              {
                [v56 addObject:v39];
              }

              v40 = v39;
            }
          }

          v32 = [v30 countByEnumeratingWithState:&v63 objects:v74 count:16];
        }

        while (v32);

        if (!v33)
        {
          v9 = v53;
          v6 = 0x1E695D000;
          v21 = v56;
          v2 = v57;
          v16 = obj;
          goto LABEL_46;
        }

        v41 = [MEMORY[0x1E696AC08] defaultManager];
        v42 = [v41 contentsOfDirectoryAtPath:v33 error:0];

        v61 = 0u;
        v62 = 0u;
        v59 = 0u;
        v60 = 0u;
        v30 = v42;
        v43 = [v30 countByEnumeratingWithState:&v59 objects:v73 count:16];
        v9 = v53;
        v6 = 0x1E695D000;
        if (v43)
        {
          v44 = v43;
          v45 = *v60;
          do
          {
            for (k = 0; k != v44; ++k)
            {
              if (*v60 != v45)
              {
                objc_enumerationMutation(v30);
              }

              v47 = [v33 stringByAppendingPathComponent:*(*(&v59 + 1) + 8 * k)];
              if (![(PLModelMigrator *)v57 skipDataProtectionForFilePath:v47])
              {
                [v56 addObject:v47];
              }
            }

            v44 = [v30 countByEnumeratingWithState:&v59 objects:v73 count:16];
          }

          while (v44);
        }

        v21 = v56;
      }

      else
      {
        v33 = v30;
        v9 = v53;
        v6 = 0x1E695D000uLL;
      }

      v2 = v57;
      v16 = obj;
    }

    else
    {
      v19 = 0;
      v33 = v16;
      v21 = v56;
    }

    goto LABEL_46;
  }

LABEL_47:
  v50 = [(PLModelMigrator *)v2 pathManager];
  [v50 setDataProtectionComplete:1];

  v51 = PLMigrationGetLog();
  if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
  {
    [*(v6 + 3840) timeIntervalSinceReferenceDate];
    *buf = 134217984;
    v72 = v52 - v8;
    _os_log_impl(&dword_19BF1F000, v51, OS_LOG_TYPE_DEFAULT, "Data protection completed in %1.1fs", buf, 0xCu);
  }
}

- (void)applyDataProtectionToPhotosPaths:(id)a3 fromKeyClass:(int)a4 toKeyClass:(int)a5
{
  v38 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = [MEMORY[0x1E696AC08] defaultManager];
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v8 = v6;
  v9 = [v8 countByEnumeratingWithState:&v25 objects:v37 count:16];
  if (v9)
  {
    v11 = v9;
    v12 = *v26;
    *&v10 = 138413058;
    v22 = v10;
    v24 = v8;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v26 != v12)
        {
          objc_enumerationMutation(v8);
        }

        v14 = *(*(&v25 + 1) + 8 * i);
        if (![(PLModelMigrator *)self skipDataProtectionForFilePath:v14, v22])
        {
          if ([v7 fileExistsAtPath:v14 isDirectory:0])
          {
            [v14 fileSystemRepresentation];
            inited = aks_migrate_path_delayInitStub(v15);
            if (inited)
            {
              v17 = inited;
              v18 = *__error();
              v19 = PLMigrationGetLog();
              if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
              {
                v20 = NSStringFromSelector(a2);
                v21 = strerror(v18);
                *buf = v22;
                v30 = v20;
                v31 = 2112;
                v32 = v14;
                v33 = 1024;
                v34 = v17;
                v35 = 2080;
                v36 = v21;
                _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "%@ failed to migrate data protection for path: %@ %d %s", buf, 0x26u);
              }

              v8 = v24;
            }
          }
        }
      }

      v11 = [v8 countByEnumeratingWithState:&v25 objects:v37 count:16];
    }

    while (v11);
  }
}

- (BOOL)skipDataProtectionForFilePath:(id)a3
{
  v4 = a3;
  if ([v4 hasSuffix:@".sqlite"] & 1) != 0 || (objc_msgSend(v4, "hasSuffix:", @"-wal") & 1) != 0 || (objc_msgSend(v4, "hasSuffix:", @"-shm") & 1) != 0 || (objc_msgSend(v4, "hasSuffix:", @"-journal"))
  {
    goto LABEL_5;
  }

  v7 = [(PLModelMigrator *)self pathManager];
  if (![v7 isDCIM])
  {

LABEL_11:
    v5 = 0;
    goto LABEL_6;
  }

  v8 = [v4 hasSuffix:*MEMORY[0x1E69BF448]];

  if ((v8 & 1) == 0)
  {
    goto LABEL_11;
  }

LABEL_5:
  v5 = 1;
LABEL_6:

  return v5;
}

- (BOOL)_fixupBrokenBurstPicksInStore:(id)a3
{
  v39 = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  v26 = objc_autoreleasePoolPush();
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _fixupBrokenBurstPicksInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = MEMORY[0x1E695D5E0];
  v7 = +[PLManagedAsset entityName];
  v8 = [v6 fetchRequestWithEntityName:v7];

  v9 = [MEMORY[0x1E696AE18] predicateWithFormat:@"avalanchePickType != %d && avalancheUUID = NULL", 0];
  [v8 setPredicate:v9];

  [v5 executeFetchRequest:v8 error:0];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v10 = v31 = 0u;
  v11 = [v10 countByEnumeratingWithState:&v28 objects:v38 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = 0;
    v14 = *v29;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v29 != v14)
        {
          objc_enumerationMutation(v10);
        }

        v16 = *(*(&v28 + 1) + 8 * i);
        v17 = objc_autoreleasePoolPush();
        [v16 setAvalanchePickType:0];
        [v16 setVisibilityState:0];
        objc_autoreleasePoolPop(v17);
      }

      v13 += v12;
      v12 = [v10 countByEnumeratingWithState:&v28 objects:v38 count:16];
    }

    while (v12);
  }

  else
  {
    v13 = 0;
  }

  if ([v5 hasChanges])
  {
    v27 = 0;
    v18 = [v5 save:&v27];
    v19 = v27;
    if ((v18 & 1) == 0)
    {
      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v21 = NSStringFromSelector(a2);
        v22 = [v19 userInfo];
        *buf = 138412802;
        v33 = v21;
        v34 = 2112;
        v35 = v19;
        v36 = 2112;
        v37 = v22;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }
  }

  else
  {
    v18 = 1;
  }

  if (v18 && v13 >= 1)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109120;
      LODWORD(v33) = v13;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Fixed up %d broken burst assets", buf, 8u);
    }
  }

  objc_autoreleasePoolPop(v26);
  return v18;
}

- (BOOL)_populateDurationAndHDRTypeFromAdditionalAssetAttributesInStagedStore:(id)a3
{
  aSelector = a2;
  v47[1] = *MEMORY[0x1E69E9840];
  v4 = a3;
  pl_dispatch_once();
  context = objc_autoreleasePoolPush();
  v33 = v4;
  v5 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v4 name:"[PLModelMigrator _populateDurationAndHDRTypeFromAdditionalAssetAttributesInStagedStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v6 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"AdditionalAssetAttributes"];
  v7 = [MEMORY[0x1E696AE18] predicateWithFormat:@"((duration != NULL) AND (duration > 0.0)) OR ((highDynamicRangeType != NULL) && (highDynamicRangeType != 0))"];
  [v6 setPredicate:v7];

  [v6 setPropertiesToFetch:&unk_1F0FBF778];
  v47[0] = @"asset";
  v8 = [MEMORY[0x1E695DEC8] arrayWithObjects:v47 count:1];
  [v6 setRelationshipKeyPathsForPrefetching:v8];

  v30 = v6;
  v31 = v5;
  [v5 executeFetchRequest:v6 error:0];
  v37 = 0u;
  v38 = 0u;
  v39 = 0u;
  obj = v40 = 0u;
  v9 = [obj countByEnumeratingWithState:&v37 objects:v46 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = 0;
    v35 = 0;
    v12 = *v38;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v38 != v12)
        {
          objc_enumerationMutation(obj);
        }

        v14 = *(*(&v37 + 1) + 8 * i);
        v15 = objc_autoreleasePoolPush();
        v16 = [v14 valueForKey:{@"duration", aSelector}];
        v17 = [v14 valueForKey:@"highDynamicRangeType"];
        v18 = [v14 valueForKey:@"asset"];
        [v16 floatValue];
        if (v19 > 0.0)
        {
          [v18 setValue:v16 forKey:@"duration"];
          ++v35;
        }

        if ([v17 integerValue])
        {
          [v18 setValue:v17 forKey:@"highDynamicRangeType"];
          ++v11;
        }

        objc_autoreleasePoolPop(v15);
      }

      v10 = [obj countByEnumeratingWithState:&v37 objects:v46 count:16];
    }

    while (v10);
  }

  else
  {
    v11 = 0;
    v35 = 0;
  }

  if (![v31 hasChanges])
  {
    goto LABEL_17;
  }

  v36 = 0;
  v20 = [v31 save:&v36];
  v21 = v36;
  v22 = v21;
  if (v20)
  {

LABEL_17:
    [v31 reset];
    if (v35 > 0 || v11 >= 1)
    {
      v23 = PLMigrationGetLog();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 67109376;
        *v42 = v35;
        *&v42[4] = 1024;
        *&v42[6] = v11;
        _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Populated duration on %d and HDR type on %d assets", buf, 0xEu);
      }
    }

    v24 = 1;
    goto LABEL_26;
  }

  v25 = PLMigrationGetLog();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
  {
    v26 = NSStringFromSelector(aSelector);
    v27 = [v22 userInfo];
    *buf = 138412802;
    *v42 = v26;
    *&v42[8] = 2112;
    v43 = v22;
    v44 = 2112;
    v45 = v27;
    _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
  }

  [v31 reset];
  v24 = 0;
LABEL_26:

  objc_autoreleasePoolPop(context);
  return v24;
}

- (BOOL)_migrateTransformableUUIDsToStringsInStore:(id)a3
{
  v5 = a3;
  v14 = 0;
  v15 = &v14;
  v16 = 0x2020000000;
  v17 = 1;
  pl_dispatch_once();
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _migrateTransformableUUIDsToStringsInStore:]" concurrencyType:*MEMORY[0x1E695D708]];
  v10[0] = MEMORY[0x1E69E9820];
  v10[1] = 3221225472;
  v10[2] = __62__PLModelMigrator__migrateTransformableUUIDsToStringsInStore___block_invoke;
  v10[3] = &unk_1E7568DA8;
  v8 = v7;
  v11 = v8;
  v12 = &v14;
  v13 = a2;
  [&unk_1F0FC0640 enumerateKeysAndObjectsUsingBlock:v10];
  [v8 reset];

  objc_autoreleasePoolPop(v6);
  LOBYTE(v6) = *(v15 + 24);
  _Block_object_dispose(&v14, 8);

  return v6;
}

void __62__PLModelMigrator__migrateTransformableUUIDsToStringsInStore___block_invoke(uint64_t a1, void *a2, void *a3, _BYTE *a4)
{
  v47 = *MEMORY[0x1E69E9840];
  v7 = a2;
  v8 = a3;
  v9 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:v7];
  if ([v8 count] == 1)
  {
    v10 = MEMORY[0x1E696AE18];
    v11 = [v8 firstObject];
    v12 = [v10 predicateWithFormat:@"%K != NULL", v11];
  }

  else
  {
    v33 = a4;
    v34 = v9;
    v13 = [MEMORY[0x1E695DF70] array];
    v40 = 0u;
    v41 = 0u;
    v42 = 0u;
    v43 = 0u;
    v14 = v8;
    v15 = [v14 countByEnumeratingWithState:&v40 objects:v46 count:16];
    if (v15)
    {
      v16 = v15;
      v17 = *v41;
      do
      {
        for (i = 0; i != v16; ++i)
        {
          if (*v41 != v17)
          {
            objc_enumerationMutation(v14);
          }

          v19 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K != NULL", *(*(&v40 + 1) + 8 * i)];
          [v13 addObject:v19];
        }

        v16 = [v14 countByEnumeratingWithState:&v40 objects:v46 count:16];
      }

      while (v16);
    }

    v12 = [MEMORY[0x1E696AB28] orPredicateWithSubpredicates:v13];

    v9 = v34;
    a4 = v33;
  }

  [v9 setPredicate:v12];
  v39 = 0;
  v20 = *(a1 + 32);
  v37[0] = MEMORY[0x1E69E9820];
  v37[1] = 3221225472;
  v37[2] = __62__PLModelMigrator__migrateTransformableUUIDsToStringsInStore___block_invoke_2;
  v37[3] = &unk_1E7577F08;
  v21 = v8;
  v38 = v21;
  v22 = [v20 enumerateObjectsFromFetchRequest:v9 count:&v39 usingDefaultBatchSizeWithBlock:v37];
  if (v22)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = NSStringFromSelector(*(a1 + 48));
      v25 = [v22 userInfo];
      *buf = 138412802;
      *v45 = v24;
      *&v45[8] = 2112;
      *&v45[10] = v22;
      *&v45[18] = 2112;
      *&v45[20] = v25;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
    }

    *(*(*(a1 + 40) + 8) + 24) = 0;
  }

  else if ([*(a1 + 32) hasChanges])
  {
    v26 = *(a1 + 32);
    v36 = 0;
    v27 = [v26 save:&v36];
    v28 = v36;
    *(*(*(a1 + 40) + 8) + 24) = v27;
    if ((*(*(*(a1 + 40) + 8) + 24) & 1) == 0)
    {
      v29 = PLMigrationGetLog();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        v35 = NSStringFromSelector(*(a1 + 48));
        v30 = [v28 userInfo];
        *buf = 138412802;
        *v45 = v35;
        *&v45[8] = 2112;
        *&v45[10] = v28;
        *&v45[18] = 2112;
        *&v45[20] = v30;
        v31 = v30;
        _os_log_impl(&dword_19BF1F000, v29, OS_LOG_TYPE_ERROR, "%@ failed: %@ %@", buf, 0x20u);
      }
    }
  }

  if (*(*(*(a1 + 40) + 8) + 24))
  {
    v32 = PLMigrationGetLog();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109634;
      *v45 = v39;
      *&v45[4] = 2112;
      *&v45[6] = v7;
      *&v45[14] = 2112;
      *&v45[16] = v21;
      _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_DEFAULT, "Migrated %d %@ %@ to strings", buf, 0x1Cu);
    }
  }

  else
  {
    *a4 = 1;
  }
}

void __62__PLModelMigrator__migrateTransformableUUIDsToStringsInStore___block_invoke_2(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = *(a1 + 32);
  v5 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v12 + 1) + 8 * i);
        v10 = [v9 stringByAppendingString:{@"String", v12}];
        v11 = [v3 valueForKey:v9];
        [v3 setValue:v11 forKey:v10];
      }

      v6 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v6);
  }
}

- (BOOL)processWelterweightMigrationStageOnStore:(id)a3 migrationUUID:(id)a4 fromVersion:(int)a5 toVersion:(int)a6 migrationContext:(id)a7 progress:(id)a8 progressUnitCount:(unint64_t)a9
{
  v11 = *&a6;
  v12 = *&a5;
  v142 = *MEMORY[0x1E69E9840];
  v77 = a3;
  v81 = a4;
  v79 = a7;
  v80 = a8;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v70 = [MEMORY[0x1E696AAA8] currentHandler];
    v71 = NSStringFromSelector(a2);
    [v70 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:4765 description:{@"%@ only valid in assetsd!", v71}];
  }

  v16 = +[PLModelMigrator currentModelVersion];
  if (v16 <= v12)
  {
    v72 = [MEMORY[0x1E696AAA8] currentHandler];
    [v72 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:4769 description:{@"Previous store version %d must be less than current version %d", v12, v16}];
  }

  if (v16 <= v11)
  {
    v73 = [MEMORY[0x1E696AAA8] currentHandler];
    [v73 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:4770 description:{@"target version %d must be less than the current version %d", v11, v16}];
  }

  if (v12 <= 6005)
  {
    v74 = [MEMORY[0x1E696AAA8] currentHandler];
    [v74 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:4771 description:@"Previous store version is unsupported"];
  }

  v17 = v11 == 8012 || v11 == 8000;
  v18 = v17;
  v19 = 1;
  if (v17)
  {
    v19 = 2;
  }

  v20 = v12 < 8318 || (v12 & 0x7FFFFFFE) == 9000;
  v21 = v20 && v11 == 9021;
  if (v20)
  {
    v18 = v19;
  }

  v23 = v12 > 14999 && v11 == 15054 || v11 == 14206;
  v24 = v23;
  v78 = v24;
  v25 = v23 || v11 == 12329;
  v76 = v12;
  v26 = v11 == 9049 || v11 == 9300;
  if (v11 == 10113)
  {
    ++v26;
  }

  if (v11 == 10123)
  {
    ++v26;
  }

  if (v11 == 10405)
  {
    ++v26;
  }

  if (v11 == 10407)
  {
    ++v26;
  }

  if (v11 == 15062)
  {
    v27 = v26 + 1;
  }

  else
  {
    v27 = v26;
  }

  v28 = v21 + v18 + v25;
  v29 = [PLModelMigrationActionProcessor alloc];
  v30 = [(PLModelMigrator *)self pathManager];
  v31 = [(PLModelMigrator *)self analyticsEventManager];
  v32 = [(PLModelMigrator *)self migrationLogger];
  v33 = [(PLModelMigrationActionProcessor *)v29 initWithUUID:v81 pathManager:v30 migrationActionType:5 analyticsEventManager:v31 logger:v32 progressUnitCount:v27 + v28];

  v34 = [(PLModelMigrationActionProcessor *)v33 progress];

  if (v34)
  {
    v35 = [(PLModelMigrationActionProcessor *)v33 progress];
    [v80 addChild:v35 withPendingUnitCount:a9];
  }

  v36 = objc_autoreleasePoolPush();
  v104[0] = MEMORY[0x1E69E9820];
  v104[1] = 3221225472;
  v104[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke;
  v104[3] = &unk_1E7570878;
  v104[4] = self;
  v37 = v77;
  v105 = v37;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Populating duration and HDR type on assets" ifRequired:v11 == 8000 block:v104];
  v102[0] = MEMORY[0x1E69E9820];
  v102[1] = 3221225472;
  v102[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_2;
  v102[3] = &unk_1E7570878;
  v102[4] = self;
  v38 = v37;
  v103 = v38;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating transformable UUIDs to strings" ifRequired:v11 == 8012 block:v102];
  v100[0] = MEMORY[0x1E69E9820];
  v100[1] = 3221225472;
  v100[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_3;
  v100[3] = &unk_1E7570878;
  v100[4] = self;
  v39 = v38;
  v101 = v39;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Populate synced orderKeys for albums and folders" ifRequired:v21 block:v100];
  v98[0] = MEMORY[0x1E69E9820];
  v98[1] = 3221225472;
  v98[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_4;
  v98[3] = &unk_1E7570878;
  v98[4] = self;
  v40 = v39;
  v99 = v40;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Populating videoCpVisibilityState and videoCpDurationValue on assets" ifRequired:v11 == 9049 block:v98];
  v96[0] = MEMORY[0x1E69E9820];
  v96[1] = 3221225472;
  v96[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_5;
  v96[3] = &unk_1E7570878;
  v96[4] = self;
  v41 = v40;
  v97 = v41;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating PLCloudResource relationships" ifRequired:v11 == 9300 block:v96];
  v94[0] = MEMORY[0x1E69E9820];
  v94[1] = 3221225472;
  v94[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_6;
  v94[3] = &unk_1E7570878;
  v94[4] = self;
  v42 = v41;
  v95 = v42;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating originalColorSpace" ifRequired:v11 == 10113 block:v94];
  v92[0] = MEMORY[0x1E69E9820];
  v92[1] = 3221225472;
  v92[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_7;
  v92[3] = &unk_1E7570878;
  v92[4] = self;
  v43 = v42;
  v93 = v43;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating keywords" ifRequired:v11 == 10123 block:v92];
  v90[0] = MEMORY[0x1E69E9820];
  v90[1] = 3221225472;
  v90[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_8;
  v90[3] = &unk_1E7570878;
  v90[4] = self;
  v44 = v43;
  v91 = v44;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating rejectedFacesGroup" ifRequired:v11 == 10405 block:v90];
  v88[0] = MEMORY[0x1E69E9820];
  v88[1] = 3221225472;
  v88[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_9;
  v88[3] = &unk_1E7570878;
  v88[4] = self;
  v45 = v44;
  v89 = v45;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating detecedFacesGroup" ifRequired:v11 == 10407 block:v88];
  v86[0] = MEMORY[0x1E69E9820];
  v86[1] = 3221225472;
  v86[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_10;
  v86[3] = &unk_1E7570878;
  v86[4] = self;
  v46 = v45;
  v87 = v46;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Emptying resources tables" ifRequired:v11 == 12329 block:v86];
  v84[0] = MEMORY[0x1E69E9820];
  v84[1] = 3221225472;
  v84[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_11;
  v84[3] = &unk_1E7570878;
  v84[4] = self;
  v47 = v46;
  v85 = v47;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating video key frame values from MediaAnalysisTable to Asset table" ifRequired:v78 block:v84];
  v82[0] = MEMORY[0x1E69E9820];
  v82[1] = 3221225472;
  v82[2] = __140__PLModelMigrator_processWelterweightMigrationStageOnStore_migrationUUID_fromVersion_toVersion_migrationContext_progress_progressUnitCount___block_invoke_12;
  v82[3] = &unk_1E7570878;
  v82[4] = self;
  v48 = v47;
  v83 = v48;
  [(PLModelMigrationActionProcessor *)v33 performActionWithName:@"Migrating UTI and Codec from relationship to table integrated values" ifRequired:v11 == 15062 block:v82];
  if (![(PLModelMigrationActionProcessor *)v33 isSuccess])
  {
    [(PLModelMigrationActionProcessor *)v33 setSuccess:0];
    v60 = PLMigrationGetLog();
    v61 = os_log_type_enabled(v60, OS_LOG_TYPE_ERROR);

    if (!v61)
    {
      goto LABEL_69;
    }

    v62 = [(PLModelMigrator *)self migrationLogger];

    if (v62)
    {
      v52 = v36;
      v141 = 0u;
      v140 = 0u;
      v139 = 0u;
      v138 = 0u;
      v137 = 0u;
      v136 = 0u;
      v135 = 0u;
      v134 = 0u;
      v133 = 0u;
      v132 = 0u;
      v131 = 0u;
      v130 = 0u;
      v128 = 0u;
      v129 = 0u;
      v126 = 0u;
      v127 = 0u;
      v124 = 0u;
      v125 = 0u;
      v122 = 0u;
      v123 = 0u;
      v120 = 0u;
      v121 = 0u;
      v118 = 0u;
      v119 = 0u;
      v116 = 0u;
      v117 = 0u;
      v114 = 0u;
      v115 = 0u;
      v112 = 0u;
      v113 = 0u;
      *buf = 0u;
      v111 = 0u;
      v63 = PLMigrationGetLog();
      os_log_type_enabled(v63, OS_LOG_TYPE_ERROR);
      v106 = 67109376;
      v107 = v76;
      v108 = 1024;
      v109 = v11;
      LODWORD(v75) = 14;
      v54 = _os_log_send_and_compose_impl();

      v55 = [(PLModelMigrator *)self migrationLogger:&v106];
      v56 = v55;
      v57 = v54;
      v58 = 4883;
      v59 = 16;
      goto LABEL_60;
    }

    v64 = PLMigrationGetLog();
    if (os_log_type_enabled(v64, OS_LOG_TYPE_ERROR))
    {
      *buf = 67109376;
      *&buf[4] = v76;
      *&buf[8] = 1024;
      *&buf[10] = v11;
      v65 = "Failed to process lightweight migration stage of photo database from version %d to %d.  Requires full database rebuild.";
      v66 = v64;
      v67 = OS_LOG_TYPE_ERROR;
      goto LABEL_67;
    }

LABEL_68:

    goto LABEL_69;
  }

  v49 = PLMigrationGetLog();
  v50 = os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT);

  if (!v50)
  {
    goto LABEL_69;
  }

  v51 = [(PLModelMigrator *)self migrationLogger];

  if (!v51)
  {
    v64 = PLMigrationGetLog();
    if (os_log_type_enabled(v64, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109376;
      *&buf[4] = v76;
      *&buf[8] = 1024;
      *&buf[10] = v11;
      v65 = "Successfully processed lightweight migration stage of photo database from version %d to %d.";
      v66 = v64;
      v67 = OS_LOG_TYPE_DEFAULT;
LABEL_67:
      _os_log_impl(&dword_19BF1F000, v66, v67, v65, buf, 0xEu);
      goto LABEL_68;
    }

    goto LABEL_68;
  }

  v52 = v36;
  v141 = 0u;
  v140 = 0u;
  v139 = 0u;
  v138 = 0u;
  v137 = 0u;
  v136 = 0u;
  v135 = 0u;
  v134 = 0u;
  v133 = 0u;
  v132 = 0u;
  v131 = 0u;
  v130 = 0u;
  v128 = 0u;
  v129 = 0u;
  v126 = 0u;
  v127 = 0u;
  v124 = 0u;
  v125 = 0u;
  v122 = 0u;
  v123 = 0u;
  v120 = 0u;
  v121 = 0u;
  v118 = 0u;
  v119 = 0u;
  v116 = 0u;
  v117 = 0u;
  v114 = 0u;
  v115 = 0u;
  v112 = 0u;
  v113 = 0u;
  *buf = 0u;
  v111 = 0u;
  v53 = PLMigrationGetLog();
  os_log_type_enabled(v53, OS_LOG_TYPE_DEFAULT);
  v106 = 67109376;
  v107 = v76;
  v108 = 1024;
  v109 = v11;
  LODWORD(v75) = 14;
  v54 = _os_log_send_and_compose_impl();

  v55 = [(PLModelMigrator *)self migrationLogger:&v106];
  v56 = v55;
  v57 = v54;
  v58 = 4880;
  v59 = 0;
LABEL_60:
  [v55 logWithMessage:v57 fromCodeLocation:"PLModelMigrator.m" type:{v58, v59}];

  if (v54 != buf)
  {
    free(v54);
  }

  v36 = v52;
LABEL_69:

  objc_autoreleasePoolPop(v36);
  v68 = [(PLModelMigrationActionProcessor *)v33 isSuccess];

  return v68;
}

- (void)postProcessFixesAfterOTARestoreForCompleteAsset:(id)a3 fixAddedDate:(BOOL)a4 isMegaBackup:(BOOL)a5
{
  v6 = a4;
  v60 = *MEMORY[0x1E69E9840];
  v9 = a3;
  if (PLIsAssetsd())
  {
    if (a5)
    {
LABEL_3:
      v10 = 1;
      goto LABEL_6;
    }
  }

  else
  {
    v11 = [MEMORY[0x1E696AAA8] currentHandler];
    v12 = NSStringFromSelector(a2);
    [v11 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:4679 description:{@"%@ only valid in assetsd!", v12}];

    if (a5)
    {
      goto LABEL_3;
    }
  }

  v10 = [v9 hasAllThumbs];
LABEL_6:
  v13 = PLMigrationGetLog();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v14 = NSStringFromSelector(a2);
    v15 = [v9 filename];
    v16 = [v9 uuid];
    v17 = [v9 objectID];
    *buf = 138413314;
    v51 = v14;
    v52 = 2112;
    v53 = v15;
    v54 = 2112;
    v55 = v16;
    v56 = 2112;
    v57 = v17;
    v58 = 1024;
    v59 = v10 ^ 1;
    _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "%@ for %@ %@ (%@), shouldGenerateThumbnails: %d", buf, 0x30u);
  }

  v18 = objc_autoreleasePoolPush();
  v19 = [v9 addedDate];

  if (v19)
  {
    if (v6)
    {
      [(PLModelMigrator *)self fixPossiblyIncorrectAddedDateForAsset:v9];
    }
  }

  else
  {
    v20 = [v9 dateCreated];
    [v9 setAddedDate:v20];
  }

  if ([v9 hasAdjustments])
  {
    [v9 adjustmentTimestamp];
  }

  else
  {
    [v9 dateCreated];
  }
  v21 = ;
  v22 = [(PLModelMigrator *)self _dateForVariations];
  v23 = [v22 compare:v21];

  if ([v9 isVideo])
  {
    [(PLModelMigrator *)self _fixVideoDimensionsForAsset:v9];
    if ([v9 kindSubtype] == 101)
    {
      [MEMORY[0x1E69BF328] maskForMigrateLegacyVideoAdjustmentsExclusions];
      [v9 savedAssetType];
      if ((PLValidatedSavedAssetTypeApplies() & 1) == 0)
      {
        v24 = [(PLModelMigrator *)self _migrateLegacySlomoAdjustmentsForAsset:v9];
        if (v24)
        {
          v25 = v24;
          v26 = PLMigrationGetLog();
          if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
          {
            v27 = @"to default";
            if (v25 == 1)
            {
              v27 = @"from SLM";
            }

            *buf = 138412290;
            v51 = v27;
            _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_DEFAULT, "Migrated slomo adjustment %@", buf, 0xCu);
          }
        }
      }
    }

    if (v23 == -1)
    {
      [(PLModelMigrator *)self _identifyVariationsAndDepthAdjustmentsForAsset:v9];
    }

    goto LABEL_40;
  }

  if (![v9 isPhoto])
  {
    if (![v9 isUnknown])
    {
      goto LABEL_40;
    }

    v29 = [v9 promoteFromUnknownKind];
    v30 = PLMigrationGetLog();
    v31 = os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT);
    if (v29)
    {
      if (v31)
      {
        v32 = [v9 filename];
        v33 = [v9 uuid];
        v34 = [v9 kind];
        *buf = 138412802;
        v51 = v32;
        v52 = 2112;
        v53 = v33;
        v54 = 1024;
        LODWORD(v55) = v34;
        v35 = "Promoted unkown asset %@ %@ to type %d";
        v36 = v30;
        v37 = 28;
LABEL_38:
        _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEFAULT, v35, buf, v37);
      }
    }

    else if (v31)
    {
      v32 = [v9 filename];
      v33 = [v9 uuid];
      *buf = 138412546;
      v51 = v32;
      v52 = 2112;
      v53 = v33;
      v35 = "Failed to promote unknown asset %@ %@";
      v36 = v30;
      v37 = 22;
      goto LABEL_38;
    }

    goto LABEL_40;
  }

  [v9 updateKindSubtypeIfScreenshot];
  v28 = [v9 metadataFromMediaPropertiesOrOriginalResource];
  [v9 setCameraCaptureDeviceFromMetadata:v28];
  [(PLModelMigrator *)self _populateFaceRegionsForAsset:v9];
  [v9 updatePlaybackVariationAndStyleFromOriginalMetadata:v28];
  [(PLModelMigrator *)self _fixIncorrectHeifMetadataForAsset:v9];
  if (v23 == -1 && (([v9 hasAdjustments] & 1) != 0 || objc_msgSend(v9, "isPhotoIris")))
  {
    [(PLModelMigrator *)self _identifyVariationsAndDepthAdjustmentsForAsset:v9];
  }

LABEL_40:
  [v9 migrateLocationDataIfNeededAfterOTARestore:1];
  [v9 persistMetadataToFilesystem];
  if ((v10 & 1) == 0)
  {
    v38 = [v9 persistedResourcesMatching:&__block_literal_global_1294];
    v48[0] = MEMORY[0x1E69E9820];
    v48[1] = 3221225472;
    v48[2] = __93__PLModelMigrator_postProcessFixesAfterOTARestoreForCompleteAsset_fixAddedDate_isMegaBackup___block_invoke_2;
    v48[3] = &unk_1E756B120;
    v39 = v9;
    v49 = v39;
    [v38 enumerateObjectsUsingBlock:v48];
    [(__CFString *)v39 generateAndUpdateThumbnailsWithPreviewImage:0 thumbnailImage:0 fromImageSource:0 imageData:0 forceSRGBConversion:0];
    v47 = 0;
    v40 = [PLResourceInstaller installInternalResourcesForExistingAsset:v39 assumeNoExistingResources:0 referencedResourceURLs:0 error:&v47];
    v41 = v47;
    if (!v40)
    {
      v42 = PLMigrationGetLog();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v51 = v39;
        v52 = 2112;
        v53 = v41;
        _os_log_impl(&dword_19BF1F000, v42, OS_LOG_TYPE_ERROR, "Failed to install resources after OTA restore of asset: %@, reason: %@", buf, 0x16u);
      }
    }

    [(__CFString *)v39 setDeferredProcessingNeeded:[(__CFString *)v39 expectedDeferredProcessingNeededOnAssetCreation]];
    if ([(__CFString *)v39 deferredProcessingNeeded])
    {
      v43 = [(__CFString *)v39 photoLibrary];
      v44 = [v43 libraryServicesManager];
      v45 = [v44 backgroundJobService];
      v46 = [(__CFString *)v39 photoLibrary];
      [v45 signalBackgroundProcessingNeededOnLibrary:v46];
    }
  }

  objc_autoreleasePoolPop(v18);
}

void __93__PLModelMigrator_postProcessFixesAfterOTARestoreForCompleteAsset_fixAddedDate_isMegaBackup___block_invoke_2(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = a2;
  v4 = [v2 managedObjectContext];
  [v4 deleteObject:v3];
}

- (BOOL)_shouldTriggerLightweightMigrationFailureForInternalTesting
{
  v27 = *MEMORY[0x1E69E9840];
  if (!MEMORY[0x19EAEE230](self, a2))
  {
    return 0;
  }

  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 photoDirectoryWithType:34];
  v5 = [v4 stringByAppendingPathComponent:@"lightweightfail"];

  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 photoDirectoryWithType:34];
  v8 = [v7 stringByAppendingPathComponent:@"lightweightcrash"];

  v9 = [MEMORY[0x1E696AC08] defaultManager];
  LODWORD(v7) = [v9 fileExistsAtPath:v5];

  v10 = [MEMORY[0x1E696AC08] defaultManager];
  v11 = v10;
  if (v7)
  {
    v24 = 0;
    v12 = [v10 removeItemAtPath:v5 error:&v24];
    v13 = v24;

    v14 = PLMigrationGetLog();
    v15 = os_log_type_enabled(v14, OS_LOG_TYPE_ERROR);
    if (v12)
    {
      if (v15)
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "[INTERNAL ONLY] Found lightweightfail indicator file, forcing lightweight migration to fail (assetsd will rebuild w/o crashing)", buf, 2u);
      }

      v16 = 1;
      goto LABEL_16;
    }

    if (v15)
    {
      *buf = 138412290;
      v26 = v13;
      v21 = "[INTERNAL ONLY] Unable to remove lightweightfail indicator file - ignoring! %@";
      goto LABEL_14;
    }

    goto LABEL_15;
  }

  v17 = [v10 fileExistsAtPath:v8];

  if (!v17)
  {
    v16 = 0;
    goto LABEL_18;
  }

  v18 = [MEMORY[0x1E696AC08] defaultManager];
  v23 = 0;
  v19 = [v18 removeItemAtPath:v8 error:&v23];
  v13 = v23;

  v14 = PLMigrationGetLog();
  v20 = os_log_type_enabled(v14, OS_LOG_TYPE_ERROR);
  if (!v19)
  {
    if (v20)
    {
      *buf = 138412290;
      v26 = v13;
      v21 = "[INTERNAL ONLY] Unable to remove lightweightcrash indicator file - ignoring! %@";
LABEL_14:
      _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, v21, buf, 0xCu);
    }

LABEL_15:
    v16 = 0;
LABEL_16:

LABEL_18:
    return v16;
  }

  if (v20)
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v14, OS_LOG_TYPE_ERROR, "[INTERNAL ONLY] Found lightweightcrash indicator file, forcing lightweight migration to crash (assetsd will rebuild after restarting)", buf, 2u);
  }

  qword_1EAFF9EC8 = "[INTERNAL ONLY] Found lightweightcrash indicator file, forcing lightweight migration to crash (assetsd will rebuild after restarting)";
  __break(1u);
  return result;
}

- (BOOL)postProcessMigratedStore:(id)a3 migrationUUID:(id)a4 fromVersion:(int)a5 progress:(id)a6 progressUnitCount:(unint64_t)a7
{
  v972 = *MEMORY[0x1E69E9840];
  v428 = a3;
  v503 = a4;
  v480 = a6;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v415 = [MEMORY[0x1E696AAA8] currentHandler];
    v416 = NSStringFromSelector(a2);
    [v415 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3197 description:{@"%@ only valid in assetsd!", v416}];
  }

  v12 = postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard;
  if (postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard >= 1)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard;
      v15 = [MEMORY[0x1E696AF00] callStackSymbols];
      v941[0] = 67109634;
      v941[1] = v14;
      LOWORD(v941[2]) = 2112;
      *(&v941[2] + 2) = 0;
      HIWORD(v941[4]) = 2112;
      *&v941[5] = v15;
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Violating post processing guard (%d), postProcessMigratedStore:fromVersion: should never run simultaneously:\n\n----------------------PREVIOUS STACK %@\n\n-------------------CURRENT STACK %@", v941, 0x1Cu);
    }

    v12 = postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard;
  }

  postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard = v12 + 1;
  [(PLModelMigrator *)self _setIsPostProcessingLightWeightMigration:1];
  v16 = +[PLModelMigrator currentModelVersion];
  if (v16 <= a5)
  {
    v417 = [MEMORY[0x1E696AAA8] currentHandler];
    [v417 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3211 description:@"Previous store version must be less than current version"];
  }

  if (a5 <= 6005)
  {
    v418 = [MEMORY[0x1E696AAA8] currentHandler];
    [v418 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3212 description:@"Previous store version is unsupported"];
  }

  context = objc_autoreleasePoolPush();
  v17 = PLMigrationGetLog();
  v18 = os_log_type_enabled(v17, OS_LOG_TYPE_INFO);

  if (v18)
  {
    v19 = [(PLModelMigrator *)self migrationLogger];

    if (v19)
    {
      v970 = 0u;
      v971 = 0u;
      v968 = 0u;
      v969 = 0u;
      v966 = 0u;
      v967 = 0u;
      v964 = 0u;
      v965 = 0u;
      v962 = 0u;
      v963 = 0u;
      v960 = 0u;
      v961 = 0u;
      v958 = 0u;
      v959 = 0u;
      v956 = 0u;
      v957 = 0u;
      v954 = 0u;
      v955 = 0u;
      v952 = 0u;
      v953 = 0u;
      v950 = 0u;
      v951 = 0u;
      v948 = 0u;
      v949 = 0u;
      v946 = 0u;
      v947 = 0u;
      v944 = 0u;
      v945 = 0u;
      v942 = 0u;
      v943 = 0u;
      memset(v941, 0, sizeof(v941));
      v20 = PLMigrationGetLog();
      os_log_type_enabled(v20, OS_LOG_TYPE_INFO);
      v937 = 67109376;
      v938 = a5;
      v939 = 1024;
      v940 = v16;
      LODWORD(v419) = 14;
      v21 = _os_log_send_and_compose_impl();

      v22 = [(PLModelMigrator *)self migrationLogger:&v937];
      [v22 logWithMessage:v21 fromCodeLocation:"PLModelMigrator.m" type:{3225, 1}];

      if (v21 != v941)
      {
        free(v21);
      }
    }

    else
    {
      v23 = PLMigrationGetLog();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
      {
        v941[0] = 67109376;
        v941[1] = a5;
        LOWORD(v941[2]) = 1024;
        *(&v941[2] + 2) = v16;
        _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_INFO, "Beginning post-processing lightweight migration from %d to %d", v941, 0xEu);
      }
    }
  }

  v24 = _os_feature_enabled_impl();
  v501 = PLPlatformMomentsSupported();
  v25 = (a5 < 0x428E) & v24;
  v26 = (a5 - 16040) < 0x8D || a5 < 13340;
  v477 = v26 | v25;
  v27 = PLPlatformMomentsSupported() & (v26 | v25);
  if (v27)
  {
    v28 = 2;
  }

  else
  {
    v28 = 1;
  }

  if (a5 == 6006)
  {
    v29 = v28;
  }

  else
  {
    v29 = v27;
  }

  v30 = [(PLModelMigrator *)self isCloudPhotoLibraryEnabled];
  v31 = [(PLModelMigrator *)self pathManager];
  v425 = [v31 isDeviceRestoreSupported];

  v32 = [(PLModelMigrator *)self pathManager];
  v33 = [v32 isDeviceRestoreSupported];

  v34 = v29 + v33;
  v420 = v16;
  if (a5 < 12136 || (a5 - 13001) <= 0x103)
  {
    v438 = PLPlatformSearchSupported();
    v34 += PLPlatformSearchSupported();
  }

  else
  {
    v438 = 0;
  }

  v483 = a5 - 9000;
  v35 = (a5 - 9000) < 0x2C || a5 < 8062;
  v486 = v35;
  LODWORD(v36) = (a5 - 9306) < 0x460 || (a5 - 9000) < 0x2C;
  if (a5 < 8023)
  {
    LODWORD(v36) = 1;
  }

  v499 = a5 - 11000;
  if ((a5 - 11000) < 0x13)
  {
    v36 = 1;
  }

  else
  {
    v36 = v36;
  }

  v485 = v36;
  v37 = a5 < 8027;
  v487 = a5 < 8044 && !v30;
  v488 = v37 ^ (a5 < 8049);
  v38 = [(PLModelMigrator *)self pathManager];
  v39 = [v38 isDeviceRestoreSupported];

  if (v39)
  {
    v40 = [(PLModelMigrator *)self deviceRestoreMigrationSupport];
    if ([v40 isRestoreFromBackupSourceCloud])
    {
      v41 = [(PLModelMigrator *)self postProcessingToken];
      v489 = v34;
      v34 = [v41 isModelMigrationRestorePostProcessingComplete] ^ 1;

      v39 = v34;
      LOWORD(v34) = v489;
    }

    else
    {
      v39 = 0;
    }
  }

  v42 = (a5 < 8008) + (a5 < 8006) + (a5 < 8011) + v37 + (a5 < 8029) + (a5 < 8030) + (a5 < 8061) + (a5 < 8033) + (a5 < 8045) + (a5 < 8046) + (a5 < 8052);
  if (a5 < 8058)
  {
    ++v42;
  }

  if (a5 < 8064)
  {
    ++v42;
  }

  if (a5 < 8065)
  {
    ++v42;
  }

  v43 = a5 >= 8200 && (a5 - 8300) >= 3;
  v44 = !v43;
  v429 = v44;
  v45 = v42 + (v37 ^ (a5 < 8049)) + ((a5 - 8047) < 4) + v486;
  if (v43)
  {
    v46 = v45;
  }

  else
  {
    v46 = v45 + 1;
  }

  v47 = a5 & 0x7FFFFFFE;
  v48 = a5 < 8101 || v47 == 8200;
  v49 = v48;
  v484 = v49;
  if (v48)
  {
    v50 = v30 + 1;
  }

  else
  {
    v50 = v30;
  }

  if (!v48)
  {
    v50 = 0;
  }

  v51 = v46 + v485 + (a5 < 8044 && !v30) + v34 + v50;
  v423 = v39;
  v52 = a5 < 8304;
  v53 = a5 < 9015 && v30;
  v54 = a5 < 9009 && v30;
  v431 = v54;
  v55 = a5 < 9051 && v30;
  if (a5 < 8312)
  {
    ++v52;
  }

  if (a5 < 9001)
  {
    ++v52;
  }

  if (a5 < 9004)
  {
    ++v52;
  }

  if (a5 < 9010)
  {
    ++v52;
  }

  if (a5 < 9011)
  {
    ++v52;
  }

  if (a5 < 9023)
  {
    ++v52;
  }

  if (a5 < 9037)
  {
    ++v52;
  }

  if (a5 < 9041)
  {
    ++v52;
  }

  if (a5 < 9042)
  {
    ++v52;
  }

  if (a5 < 9046)
  {
    ++v52;
  }

  if (a5 < 9047)
  {
    ++v52;
  }

  if (a5 < 9048)
  {
    ++v52;
  }

  if (a5 < 9201)
  {
    ++v52;
  }

  if (a5 < 9204)
  {
    ++v52;
  }

  if (v483 < 0x22)
  {
    ++v52;
  }

  if (v483 < 0x28)
  {
    ++v52;
  }

  v56 = a5 < 8318 || v47 == 9000;
  v57 = v56;
  v430 = v57;
  v58 = v52 + ((a5 < 8029) ^ (a5 < 9038));
  if (v56)
  {
    ++v58;
  }

  v433 = v55;
  v432 = v53;
  v424 = (a5 < 8302) & (v39 ^ 1u);
  v59 = v53 + v55 + v51 + ((a5 < 8302) & (v39 ^ 1));
  if (a5 >= 9205)
  {
    v60 = 0;
  }

  else
  {
    v60 = 3;
  }

  v61 = v58 + v59 + v60;
  v437 = [(PLModelMigrator *)self sceneStepRequiredForPreviousStoreVersion:a5];
  v62 = [(PLModelMigrator *)self sceneStepRequiredForPreviousStoreVersion:a5];
  v63 = 0;
  v64 = a5 < 10067 && v30;
  if (a5 >= 10027)
  {
    v65 = a5 < 9302;
  }

  else
  {
    v65 = (a5 < 9302) + 1;
  }

  v66 = a5 - 10000;
  if (a5 < 10036)
  {
    ++v65;
  }

  if (a5 < 10041)
  {
    ++v65;
  }

  if (a5 < 10065)
  {
    ++v65;
  }

  if (a5 < 10070)
  {
    ++v65;
  }

  if (a5 < 10079)
  {
    ++v65;
  }

  if (a5 < 10088)
  {
    ++v65;
  }

  if (a5 < 10102)
  {
    ++v65;
  }

  if (a5 < 10106)
  {
    ++v65;
  }

  if (a5 < 10109)
  {
    ++v65;
  }

  if (a5 < 10112)
  {
    ++v65;
  }

  if (v66 < 0x25)
  {
    ++v65;
  }

  if ((a5 & 0xFFFFFFFC) == 0x2754)
  {
    ++v65;
  }

  if (v66 < 0x67)
  {
    ++v65;
  }

  v426 = a5 - 10000;
  if (v66 < 0x75)
  {
    ++v65;
  }

  v434 = v64;
  v67 = v65 + v64 + v62;
  v435 = a5 < 10118 && v30;
  if (v435)
  {
    v68 = 2;
  }

  else
  {
    v68 = 0;
  }

  v475 = v67 + v68 + v61;
  v482 = a5 & 0xFFFFFFFE;
  v481 = a5 - 11001;
  v69 = (a5 - 11001) < 0x30 || a5 < 10203;
  v490 = v69;
  v71 = a5 < 10300 || (a5 - 10400) < 3;
  v494 = v71;
  v73 = a5 < 10427 || v499 < 0x17;
  v493 = v73;
  v74 = a5 < 11007 && v30;
  v496 = v74;
  v75 = a5 < 11011 && v30;
  v495 = v75;
  v76 = (a5 - 11014) < 7 && v30;
  v497 = v76;
  v78 = a5 < 10428 || v499 < 0x1B;
  v492 = v78;
  v79 = (a5 - 11004) < 0x1B && v30;
  v498 = v79;
  v80 = a5 == 11038 && v30;
  v500 = v80;
  v491 = (a5 < 10151) & v30;
  v81 = a5 < 11043;
  if (v81 && v30)
  {
    v63 = [MEMORY[0x1E6994A80] serverSupportsVision];
  }

  v440 = v63;
  v421 = v501 & v477;
  v427 = v484 & v30;
  v439 = [(PLModelMigrator *)self faceQualityResetRequiredForPreviousStoreVersion:a5];
  v82 = [(PLModelMigrator *)self faceQualityResetRequiredForPreviousStoreVersion:a5];
  v83 = (a5 - 11048) < 0x10 && v30;
  v84 = a5 < 11074 && v30;
  v85 = a5 < 11075 && v30;
  v86 = a5 < 11076 && v30;
  v87 = a5 < 11077 && v30;
  v88 = a5 < 11081 && v30;
  v89 = a5 < 11089 && v30;
  v90 = a5 < 13016 && v30;
  v91 = (a5 < 10150) + (a5 < 10123) + (a5 < 10203) + (a5 < 10204) + (a5 < 10206) + (a5 < 10207) + (a5 < 11000) + (a5 < 11001) + (a5 < 11022) + (a5 < 11024) + (a5 < 11025) + v81;
  if (a5 < 11047)
  {
    ++v91;
  }

  if (a5 < 11048)
  {
    ++v91;
  }

  if (a5 < 11049)
  {
    ++v91;
  }

  if (a5 < 11052)
  {
    ++v91;
  }

  if (a5 < 11060)
  {
    ++v91;
  }

  if (a5 < 11061)
  {
    ++v91;
  }

  v92 = !v30;
  if (a5 < 11063)
  {
    ++v91;
  }

  if (a5 < 11068)
  {
    ++v91;
  }

  if (a5 < 11069)
  {
    ++v91;
  }

  if (a5 < 11070)
  {
    ++v91;
  }

  if (a5 < 11079)
  {
    ++v91;
  }

  if (a5 < 11080)
  {
    ++v91;
  }

  if (a5 < 11200)
  {
    ++v91;
  }

  if (a5 < 11203)
  {
    ++v91;
  }

  if (a5 < 12000)
  {
    ++v91;
    v92 = 1;
  }

  if (a5 < 12035)
  {
    ++v91;
  }

  if (a5 < 13027)
  {
    ++v91;
  }

  if (a5 < 13036)
  {
    ++v91;
  }

  if (a5 < 13050)
  {
    ++v91;
  }

  if (a5 < 12036)
  {
    ++v91;
  }

  v93 = v91 + ((a5 & 0xFFFFFFFE) == 10124) + ((a5 - 11022) < 4) + ((a5 - 10425) < 0x25B);
  if (v481 < 0x40)
  {
    ++v93;
  }

  if ((a5 - 10075) >= 0x3F1)
  {
    v94 = v93;
  }

  else
  {
    v94 = v93 + 1;
  }

  v95 = a5 - 12000;
  if ((a5 - 11079) < 0xC)
  {
    ++v94;
  }

  v96 = a5 - 13000;
  v97 = v95 >= 0x42 && v96 >= 0x1A;
  v98 = !v97;
  v447 = v98;
  v99 = v94 + v490 + v494 + v493 + v492;
  if (!v97)
  {
    ++v99;
  }

  v100 = v95 >= 0x40 && v96 >= 0x15;
  v101 = !v100;
  v448 = v101;
  if (!v100)
  {
    ++v99;
  }

  v102 = v95 >= 0x58 && v96 >= 0x38;
  v103 = !v102;
  v452 = v103;
  if (!v102)
  {
    ++v99;
  }

  v441 = v84;
  v442 = v85;
  v443 = v86;
  v444 = v87;
  v445 = v88;
  v446 = v89;
  v449 = v90;
  v436 = v83;
  v104 = v99 + (a5 < 10151 && v30) + v496 + v495 + v500 + v84 + v85 + v86 + v87 + v88 + v89 + v90 + v497 + v498 + v83 + v475 + v82;
  v106 = a5 < 0x2F3E || v96 < 0x3E || a5 == 12097;
  v107 = v106;
  if (v106)
  {
    v108 = v104 + 1;
  }

  else
  {
    v108 = v104;
  }

  v109 = (v92 & 1) == 0;
  if (v92)
  {
    v110 = 0;
  }

  else
  {
    v110 = v107;
  }

  v451 = v110;
  if (v109)
  {
    v111 = v108;
  }

  else
  {
    v111 = v104;
  }

  v112 = a5 < 13089;
  v113 = a5 < 13180 && v30;
  if (a5 < 13099)
  {
    ++v112;
  }

  if (a5 < 13103)
  {
    ++v112;
  }

  if (a5 < 13106)
  {
    ++v112;
  }

  if (a5 < 13117)
  {
    ++v112;
  }

  if (a5 < 13119)
  {
    ++v112;
  }

  if (a5 < 13137)
  {
    ++v112;
  }

  if (a5 < 13152)
  {
    ++v112;
  }

  if (a5 < 13187)
  {
    ++v112;
  }

  v114 = v95 >= 0x77 && v96 >= 0x46;
  v115 = !v114;
  v450 = v115;
  if (!v114)
  {
    ++v112;
  }

  v116 = v95 >= 0x7D && v96 >= 0x52;
  v117 = !v116;
  v453 = v117;
  if (!v116)
  {
    ++v112;
  }

  v454 = v113;
  v118 = v112 + v113 + v111;
  v119 = v95 >= 0x12C && v96 >= 0xBC;
  v120 = !v119;
  if (v119)
  {
    v121 = v118;
  }

  else
  {
    v121 = v118 + 1;
  }

  if (!v30)
  {
    v120 = 0;
  }

  v455 = v120;
  if (v30)
  {
    v122 = v121;
  }

  else
  {
    v122 = v118;
  }

  v123 = PLPlatformExtendedAttributesSupported();
  v124 = PLPlatformExtendedAttributesSupported();
  if (v96 < 0xFA)
  {
    v125 = v123;
  }

  else
  {
    v125 = 0;
  }

  v456 = v125;
  if (v96 < 0xFA)
  {
    v126 = v124;
  }

  else
  {
    v126 = 0;
  }

  v127 = (a5 - 13355) < 0x9D && v30;
  if (a5 >= 13193)
  {
    v128 = a5 < 13191;
  }

  else
  {
    v128 = (a5 < 13191) + 1;
  }

  if (a5 < 13195)
  {
    ++v128;
  }

  if (a5 < 13196)
  {
    ++v128;
  }

  if (a5 < 13200)
  {
    ++v128;
  }

  if (a5 < 13307)
  {
    ++v128;
  }

  if (a5 < 13222)
  {
    ++v128;
  }

  if (a5 < 13242)
  {
    ++v128;
  }

  if (a5 < 13301)
  {
    ++v128;
  }

  if (a5 < 13304)
  {
    ++v128;
  }

  if (a5 < 13309)
  {
    ++v128;
  }

  if (a5 < 13323)
  {
    ++v128;
  }

  if (a5 < 13260)
  {
    ++v128;
  }

  if (a5 < 13351)
  {
    ++v128;
  }

  if (a5 < 13533)
  {
    ++v128;
  }

  if (a5 < 14005)
  {
    ++v128;
  }

  if (a5 < 14009)
  {
    ++v128;
  }

  if (a5 < 18083)
  {
    ++v128;
  }

  if (a5 < 14016)
  {
    ++v128;
  }

  if (a5 < 14021)
  {
    ++v128;
  }

  if (a5 < 14025)
  {
    ++v128;
  }

  if (a5 < 14027)
  {
    ++v128;
  }

  if (a5 < 14032)
  {
    ++v128;
  }

  if (a5 == 14037)
  {
    ++v128;
  }

  if (a5 < 14039)
  {
    ++v128;
  }

  if (v96 < 0xE3)
  {
    ++v128;
  }

  if (v96 < 0x12F)
  {
    ++v128;
  }

  if (v96 < 0x1F8)
  {
    ++v128;
  }

  if (v96 < 0x213)
  {
    ++v128;
  }

  if (v96 < 0x1FB)
  {
    ++v128;
  }

  if ((a5 - 13513) < 3)
  {
    ++v128;
  }

  v129 = a5 - 15000;
  v130 = (a5 - 14021) >= 0x13 && v129 >= 3;
  v131 = !v130;
  v459 = v131;
  if (!v130)
  {
    ++v128;
  }

  v132 = a5 < 14043 || (a5 & 0x7FFFFFF8) == 15000;
  v133 = v132;
  v460 = v133;
  if (v132)
  {
    ++v128;
  }

  v134 = a5 >= 14044 && v129 >= 9;
  v135 = !v134;
  v461 = v135;
  if (!v134)
  {
    ++v128;
  }

  v136 = a5 >= 14045 && v129 >= 0xA;
  v137 = !v136;
  v464 = v137;
  if (!v136)
  {
    ++v128;
  }

  v138 = (a5 - 14040) >= 6 && (a5 - 15003) >= 8;
  v139 = !v138;
  v466 = v139;
  if (!v138)
  {
    ++v128;
  }

  v140 = a5 >= 14047 && v129 >= 0xD;
  v141 = !v140;
  v468 = v141;
  if (!v140)
  {
    ++v128;
  }

  v142 = a5 >= 14051 && v129 >= 0x10;
  v143 = !v142;
  v471 = v143;
  if (!v142)
  {
    ++v128;
  }

  v458 = v127;
  v144 = v128 + v127 + v122 + v126;
  if ((a5 - 14001) < 0x3A || v129 <= 0x15)
  {
    v145 = [(PLModelMigrator *)self options];
    if (v145)
    {
      v146 = MEMORY[0x1E69BF2A0];
      v147 = [(PLModelMigrator *)self pathManager];
      v148 = [v147 libraryURL];
      v469 = [v146 isSystemPhotoLibraryURL:v148] ^ 1;
    }

    else
    {
      v469 = 0;
    }

    v149 = [(PLModelMigrator *)self options];
    if (v149)
    {
      v150 = v149;
      v151 = MEMORY[0x1E69BF2A0];
      v152 = [(PLModelMigrator *)self pathManager];
      v153 = [v152 libraryURL];
      LOBYTE(v151) = [v151 isSystemPhotoLibraryURL:v153];

      v144 += (v151 & 1) == 0;
    }
  }

  else
  {
    v469 = 0;
  }

  v154 = [(PLModelMigrator *)self pathManager];
  v155 = [(PLThumbnailManagerCore *)PLThumbnailManager requiredThumbnailResetTypeWithPathManager:v154 comparedToConfigPhase:1];

  v156 = v155 - 1;
  if (a5 >= 15059)
  {
    v157 = 1;
  }

  else
  {
    v157 = 2;
  }

  v158 = a5 >= 14060 && v129 >= 0x17;
  v159 = vdupq_n_s32(a5);
  v160 = !v158;
  v462 = v160;
  v161 = vorrq_s8(vcgtq_s32(xmmword_19C60AF70, v159), vcgtq_u32(xmmword_19C60AF80, vdupq_n_s32(v129)));
  v162 = vandq_s8(v161, xmmword_19C60AF90);
  v162.i32[0] = vaddvq_s32(v162) & 0xF;
  v163 = vaddlv_u8(vcnt_s8(*v162.i8));
  v164 = v163;
  if (!v158)
  {
    v164 = v163 + 1;
  }

  v165 = a5 >= 14087 && v129 >= 0x1E;
  v166 = !v165;
  v167 = a5 - 14000;
  if (v165)
  {
    v168 = 1;
  }

  else
  {
    v168 = 2;
  }

  v169 = v167 >= 0x59 && v129 >= 0x20;
  v170 = !v169;
  v465 = v170;
  v171 = vmovn_s32(v161);
  v467 = v171.i8[0];
  v470 = v171.i8[2];
  v472 = v171.i8[4];
  v473 = v171.i8[6];
  v463 = v166;
  if (v169)
  {
    v168 = v166;
  }

  v172 = a5 >= 14204 && v129 >= 0x32;
  v173 = !v172;
  if (v172)
  {
    v174 = 1;
  }

  else
  {
    v174 = 2;
  }

  v175 = v167 >= 0x6A && v129 >= 0x29;
  v176 = !v175;
  v474 = v176;
  v476 = v173;
  if (v175)
  {
    v177 = v173;
  }

  else
  {
    v177 = v174;
  }

  v178 = a5 >= 14205 && v129 >= 0x34;
  v179 = !v178;
  if (v178)
  {
    v180 = 1;
  }

  else
  {
    v180 = 2;
  }

  v182 = a5 < 14201 || v129 < 0x2D || v482 == 10124;
  v422 = v155;
  v183 = v182 || v155 == 2;
  v184 = v183;
  v502 = v184;
  v478 = v179;
  if (!v183)
  {
    v180 = v179;
  }

  if (v156 >= 2)
  {
    v185 = v144;
  }

  else
  {
    v185 = v144 + 1;
  }

  v186 = v164 + v168 + v177 + v180 + v185 + v157;
  v187 = [PLModelMigrationActionProcessor alloc];
  v188 = [(PLModelMigrator *)self pathManager];
  v189 = [(PLModelMigrator *)self analyticsEventManager];
  v190 = [(PLModelMigrator *)self migrationLogger];
  v191 = [(PLModelMigrationActionProcessor *)v187 initWithUUID:v503 pathManager:v188 migrationActionType:2 analyticsEventManager:v189 logger:v190 progressUnitCount:v186];

  v192 = [(PLModelMigrationActionProcessor *)v191 progress];

  if (v192)
  {
    v193 = [(PLModelMigrationActionProcessor *)v191 progress];
    [v480 addChild:v193 withPendingUnitCount:a7];
  }

  if ([(PLModelMigrator *)self _shouldTriggerLightweightMigrationFailureForInternalTesting])
  {
    [(PLModelMigrationActionProcessor *)v191 setSuccess:0];
  }

  v934[0] = MEMORY[0x1E69E9820];
  v934[1] = 3221225472;
  v934[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke;
  v934[3] = &unk_1E7568D08;
  v934[4] = self;
  v194 = v428;
  v935 = v194;
  v936 = v423 & 1;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Delete iCloud restore synced/shared content" ifRequired:v425 block:v934];
  v932[0] = MEMORY[0x1E69E9820];
  v932[1] = 3221225472;
  v932[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_461;
  v932[3] = &unk_1E7570878;
  v932[4] = self;
  v195 = v194;
  v933 = v195;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Post processing from 6006" ifRequired:a5 == 6006 block:v932];
  v930[0] = MEMORY[0x1E69E9820];
  v930[1] = 3221225472;
  v930[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2;
  v930[3] = &unk_1E7570878;
  v930[4] = self;
  v196 = v195;
  v931 = v196;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating panorama subtypes" ifRequired:v484 block:v930];
  v927[0] = MEMORY[0x1E69E9820];
  v927[1] = 3221225472;
  v927[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3;
  v927[3] = &unk_1E7568D08;
  v927[4] = self;
  v197 = v196;
  v928 = v197;
  v929 = (a5 - 16040) < 0x8D;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Rebuilding all moments after lightweight migration." ifRequired:v421 block:v927];
  v924[0] = MEMORY[0x1E69E9820];
  v924[1] = 3221225472;
  v924[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_476;
  v924[3] = &unk_1E7568D08;
  v924[4] = self;
  v198 = v197;
  v925 = v198;
  v926 = a5 < 13340;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Adding UUIDs to AlbumLists and MomentLists" ifRequired:a5 < 8006 block:v924];
  v922[0] = MEMORY[0x1E69E9820];
  v922[1] = 3221225472;
  v922[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_480;
  v922[3] = &unk_1E7570878;
  v922[4] = self;
  v199 = v198;
  v923 = v199;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Generating location hashes for assets" ifRequired:a5 < 8008 block:v922];
  v920[0] = MEMORY[0x1E69E9820];
  v920[1] = 3221225472;
  v920[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_484;
  v920[3] = &unk_1E7570878;
  v920[4] = self;
  v200 = v199;
  v921 = v200;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating location data for assets" ifRequired:v424 block:v920];
  v918[0] = MEMORY[0x1E69E9820];
  v918[1] = 3221225472;
  v918[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4;
  v918[3] = &unk_1E7570878;
  v918[4] = self;
  v201 = v200;
  v919 = v201;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Setting up root folder" ifRequired:a5 < 8011 block:v918];
  v916[0] = MEMORY[0x1E69E9820];
  v916[1] = 3221225472;
  v916[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5;
  v916[3] = &unk_1E7570878;
  v916[4] = self;
  v202 = v201;
  v917 = v202;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Forcing album metadata to disk" ifRequired:v485 block:v916];
  v913[0] = MEMORY[0x1E69E9820];
  v913[1] = 3221225472;
  v913[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6;
  v913[3] = &unk_1E7568D08;
  v915 = v423 & 1;
  v913[4] = self;
  v203 = v202;
  v914 = v203;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating SLM files" ifRequired:a5 < 8027 block:v913];
  v910[0] = MEMORY[0x1E69E9820];
  v910[1] = 3221225472;
  v910[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_499;
  v910[3] = &unk_1E7568D08;
  v912 = v423 & 1;
  v910[4] = self;
  v204 = v203;
  v911 = v204;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Persisting place annotation data" ifRequired:a5 < 9201 block:v910];
  v907[0] = MEMORY[0x1E69E9820];
  v907[1] = 3221225472;
  v907[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_504;
  v907[3] = &unk_1E7568D08;
  v909 = v423 & 1;
  v907[4] = self;
  v205 = v204;
  v908 = v205;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing up asset persistence" ifRequired:v486 block:v907];
  v904[0] = MEMORY[0x1E69E9820];
  v904[1] = 3221225472;
  v904[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_509;
  v904[3] = &unk_1E7568D08;
  v906 = v423 & 1;
  v904[4] = self;
  v206 = v205;
  v905 = v206;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Generating addedDate for assets" ifRequired:a5 < 8029 block:v904];
  v902[0] = MEMORY[0x1E69E9820];
  v902[1] = 3221225472;
  v902[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_514;
  v902[3] = &unk_1E7570878;
  v902[4] = self;
  v207 = v206;
  v903 = v207;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating adjustmentsState" ifRequired:a5 < 8030 block:v902];
  v899[0] = MEMORY[0x1E69E9820];
  v899[1] = 3221225472;
  v899[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_518;
  v899[3] = &unk_1E7568D08;
  v901 = v423 & 1;
  v899[4] = self;
  v208 = v207;
  v900 = v208;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing video dimensions" ifRequired:a5 < 8033 block:v899];
  v896[0] = MEMORY[0x1E69E9820];
  v896[1] = 3221225472;
  v896[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_523;
  v896[3] = &unk_1E7568D08;
  v898 = v423 & 1;
  v896[4] = self;
  v209 = v208;
  v897 = v209;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing orientations previously corrupted by adjustment migration" ifRequired:(a5 - 8047) < 4 block:v896];
  v894[0] = MEMORY[0x1E69E9820];
  v894[1] = 3221225472;
  v894[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_528;
  v894[3] = &unk_1E7570878;
  v894[4] = self;
  v210 = v209;
  v895 = v210;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing album order in Albums list." ifRequired:a5 < 8052 block:v894];
  v892[0] = MEMORY[0x1E69E9820];
  v892[1] = 3221225472;
  v892[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_532;
  v892[3] = &unk_1E7570878;
  v892[4] = self;
  v211 = v210;
  v893 = v211;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing orientation of images in Shared Photo Streams" ifRequired:a5 < 8058 block:v892];
  v890[0] = MEMORY[0x1E69E9820];
  v890[1] = 3221225472;
  v890[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_536;
  v890[3] = &unk_1E7570878;
  v890[4] = self;
  v212 = v211;
  v891 = v212;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing broken burst picks" ifRequired:a5 < 8045 block:v890];
  v887[0] = MEMORY[0x1E69E9820];
  v887[1] = 3221225472;
  v887[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_540;
  v887[3] = &unk_1E7568D08;
  v887[4] = self;
  v213 = v212;
  v888 = v213;
  v889 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing incorrect thumbnail tables" ifRequired:v482 == 10124 block:v887];
  v884[0] = MEMORY[0x1E69E9820];
  v884[1] = 3221225472;
  v884[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_544;
  v884[3] = &unk_1E7568D08;
  v886 = v423 & 1;
  v884[4] = self;
  v214 = v213;
  v885 = v214;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing HEIF assets with incorrect metadata" ifRequired:a5 < 11068 block:v884];
  v880[0] = MEMORY[0x1E69E9820];
  v880[1] = 3221225472;
  v880[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_549;
  v880[3] = &unk_1E7568D30;
  v880[4] = self;
  v215 = v214;
  v881 = v215;
  v882 = v422;
  v883 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting all thumbs and thumb index data ifRequired:and request a thumbnail rebuild" block:v156 < 2, v880];
  v878[0] = MEMORY[0x1E69E9820];
  v878[1] = 3221225472;
  v878[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_553;
  v878[3] = &unk_1E7570878;
  v878[4] = self;
  v216 = v215;
  v879 = v216;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Verifying cloud assets local availability" ifRequired:a5 < 8061 block:v878];
  v877[0] = MEMORY[0x1E69E9820];
  v877[1] = 3221225472;
  v877[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_557;
  v877[3] = &unk_1E7573368;
  v877[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Disabling iCloudPhoto ifRequired:writing a disable file marker" block:v487, v877];
  v875[0] = MEMORY[0x1E69E9820];
  v875[1] = 3221225472;
  v875[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_561;
  v875[3] = &unk_1E7570878;
  v875[4] = self;
  v217 = v216;
  v876 = v217;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing events from database" ifRequired:a5 < 8046 block:v875];
  v873[0] = MEMORY[0x1E69E9820];
  v873[1] = 3221225472;
  v873[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_565;
  v873[3] = &unk_1E7570878;
  v873[4] = self;
  v218 = v217;
  v874 = v218;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating slo-mo adjustments files that used NSKeyedArchiver to use NSPropertyListSerialization format" ifRequired:v488 block:v873];
  v871[0] = MEMORY[0x1E69E9820];
  v871[1] = 3221225472;
  v871[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_569;
  v871[3] = &unk_1E7570878;
  v871[4] = self;
  v219 = v218;
  v872 = v219;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixinf multiple master relationships" ifRequired:a5 < 8064 block:v871];
  v869[0] = MEMORY[0x1E69E9820];
  v869[1] = 3221225472;
  v869[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_577;
  v869[3] = &unk_1E7570878;
  v869[4] = self;
  v220 = v219;
  v870 = v220;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repersist duplicated originals" ifRequired:a5 < 8065 block:v869];
  v866[0] = MEMORY[0x1E69E9820];
  v866[1] = 3221225472;
  v866[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_581;
  v866[3] = &unk_1E7568D08;
  v868 = v423 & 1;
  v866[4] = self;
  v221 = v220;
  v867 = v221;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populate face regions" ifRequired:v429 block:v866];
  v865[0] = MEMORY[0x1E69E9820];
  v865[1] = 3221225472;
  v865[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_586;
  v865[3] = &unk_1E7573368;
  v865[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Force a reset sync after lightweight migration post processing completes" ifRequired:v427 block:v865];
  v863[0] = MEMORY[0x1E69E9820];
  v863[1] = 3221225472;
  v863[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_590;
  v863[3] = &unk_1E7570878;
  v863[4] = self;
  v222 = v221;
  v864 = v222;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting orderKey for albums" ifRequired:a5 < 8304 block:v863];
  v861[0] = MEMORY[0x1E69E9820];
  v861[1] = 3221225472;
  v861[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_594;
  v861[3] = &unk_1E7570878;
  v861[4] = self;
  v223 = v222;
  v862 = v223;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing duplicate assets" ifRequired:a5 < 8312 block:v861];
  v859[0] = MEMORY[0x1E69E9820];
  v859[1] = 3221225472;
  v859[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_598;
  v859[3] = &unk_1E7570878;
  v859[4] = self;
  v224 = v223;
  v860 = v224;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing visible single burst assets" ifRequired:a5 < 9001 block:v859];
  v857[0] = MEMORY[0x1E69E9820];
  v857[1] = 3221225472;
  v857[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_602;
  v857[3] = &unk_1E7570878;
  v857[4] = self;
  v225 = v224;
  v858 = v225;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing video JPG Path" ifRequired:v430 block:v857];
  v855[0] = MEMORY[0x1E69E9820];
  v855[1] = 3221225472;
  v855[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_606;
  v855[3] = &unk_1E7570878;
  v855[4] = self;
  v226 = v225;
  v856 = v226;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing sort ascending for album and folder" ifRequired:a5 < 9004 block:v855];
  v851[0] = MEMORY[0x1E69E9820];
  v851[1] = 3221225472;
  v851[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7;
  v851[3] = &unk_1E7568D58;
  v853 = v432;
  v851[4] = self;
  v854 = v431;
  v227 = v226;
  v852 = v227;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Caching date created and itemIdentifier on resources" ifRequired:v432 block:v851];
  v849[0] = MEMORY[0x1E69E9820];
  v849[1] = 3221225472;
  v849[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_615;
  v849[3] = &unk_1E7570878;
  v849[4] = self;
  v228 = v227;
  v850 = v228;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Recovering single burst photos." ifRequired:a5 < 9010 block:v849];
  v847[0] = MEMORY[0x1E69E9820];
  v847[1] = 3221225472;
  v847[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_619;
  v847[3] = &unk_1E7570878;
  v847[4] = self;
  v229 = v228;
  v848 = v229;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating adjustmentTimestamp on assets." ifRequired:a5 < 9011 block:v847];
  v844[0] = MEMORY[0x1E69E9820];
  v844[1] = 3221225472;
  v844[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_623;
  v844[3] = &unk_1E7568D08;
  v846 = v423 & 1;
  v844[4] = self;
  v230 = v229;
  v845 = v230;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing incorrect added date." ifRequired:(a5 < 8029) ^ (a5 < 9038) block:v844];
  v842[0] = MEMORY[0x1E69E9820];
  v842[1] = 3221225472;
  v842[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_628;
  v842[3] = &unk_1E7570878;
  v842[4] = self;
  v231 = v230;
  v843 = v231;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Adding Camera capture device." ifRequired:a5 < 9037 block:v842];
  v840[0] = MEMORY[0x1E69E9820];
  v840[1] = 3221225472;
  v840[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_632;
  v840[3] = &unk_1E7570878;
  v840[4] = self;
  v232 = v231;
  v841 = v232;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Tagging screenshots." ifRequired:a5 < 9023 block:v840];
  v838[0] = MEMORY[0x1E69E9820];
  v838[1] = 3221225472;
  v838[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_636;
  v838[3] = &unk_1E7570878;
  v838[4] = self;
  v233 = v232;
  v839 = v233;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Mark previously edited Irises as evaluated." ifRequired:v483 < 0x22 block:v838];
  v836[0] = MEMORY[0x1E69E9820];
  v836[1] = 3221225472;
  v836[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_640;
  v836[3] = &unk_1E7570878;
  v836[4] = self;
  v234 = v233;
  v837 = v234;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixup video orphans." ifRequired:v483 < 0x28 block:v836];
  v834[0] = MEMORY[0x1E69E9820];
  v834[1] = 3221225472;
  v834[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_644;
  v834[3] = &unk_1E7570878;
  v834[4] = self;
  v235 = v234;
  v835 = v235;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Adding cloud kindSubtype and Burst flags." ifRequired:a5 < 9041 block:v834];
  v832[0] = MEMORY[0x1E69E9820];
  v832[1] = 3221225472;
  v832[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_648;
  v832[3] = &unk_1E7570878;
  v832[4] = self;
  v236 = v235;
  v833 = v236;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixup itemIdentifier on videocmpl resources" ifRequired:a5 < 9042 block:v832];
  v830[0] = MEMORY[0x1E69E9820];
  v830[1] = 3221225472;
  v830[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_652;
  v830[3] = &unk_1E7570878;
  v830[4] = self;
  v237 = v236;
  v831 = v237;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixup local path for videocmpl derivatives" ifRequired:v433 block:v830];
  v828[0] = MEMORY[0x1E69E9820];
  v828[1] = 3221225472;
  v828[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8;
  v828[3] = &unk_1E7570878;
  v828[4] = self;
  v238 = v237;
  v829 = v238;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixup empty local path for video resources" ifRequired:a5 < 9048 block:v828];
  v826[0] = MEMORY[0x1E69E9820];
  v826[1] = 3221225472;
  v826[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9;
  v826[3] = &unk_1E7570878;
  v826[4] = self;
  v239 = v238;
  v827 = v239;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Persist videoCompl properties" ifRequired:a5 < 9046 block:v826];
  v825[0] = MEMORY[0x1E69E9820];
  v825[1] = 3221225472;
  v825[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10;
  v825[3] = &unk_1E7573368;
  v825[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Clean out invalid asset <--> album mapping records." ifRequired:a5 < 9047 block:v825];
  v824[0] = MEMORY[0x1E69E9820];
  v824[1] = 3221225472;
  v824[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11;
  v824[3] = &unk_1E7573368;
  v824[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Applying data protection to DCIM (B->C)" ifRequired:a5 < 9204 block:v824];
  v822[0] = MEMORY[0x1E69E9820];
  v822[1] = 3221225472;
  v822[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12;
  v822[3] = &unk_1E7570878;
  v822[4] = self;
  v240 = v239;
  v823 = v240;
  v241 = a5 < 9205;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting failed assets" ifRequired:v241 block:v822];
  v820[0] = MEMORY[0x1E69E9820];
  v820[1] = 3221225472;
  v820[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_13;
  v820[3] = &unk_1E7570878;
  v820[4] = self;
  v242 = v240;
  v821 = v242;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting failed cloud masters" ifRequired:v241 block:v820];
  v818[0] = MEMORY[0x1E69E9820];
  v818[1] = 3221225472;
  v818[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_14;
  v818[3] = &unk_1E7570878;
  v818[4] = self;
  v243 = v242;
  v819 = v243;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting upload attempts" ifRequired:v241 block:v818];
  v816[0] = MEMORY[0x1E69E9820];
  v816[1] = 3221225472;
  v816[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_15;
  v816[3] = &unk_1E7570878;
  v816[4] = self;
  v244 = v243;
  v817 = v244;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix cloudMaster cloudLocalState" ifRequired:a5 < 9302 block:v816];
  v814[0] = MEMORY[0x1E69E9820];
  v814[1] = 3221225472;
  v814[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_16;
  v814[3] = &unk_1E7570878;
  v814[4] = self;
  v245 = v244;
  v815 = v245;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating representative assets" ifRequired:a5 < 10027 block:v814];
  v812[0] = MEMORY[0x1E69E9820];
  v812[1] = 3221225472;
  v812[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_17;
  v812[3] = &unk_1E7570878;
  v812[4] = self;
  v246 = v245;
  v813 = v246;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Clearing all analysis states" ifRequired:v426 < 0x25 block:v812];
  v810[0] = MEMORY[0x1E69E9820];
  v810[1] = 3221225472;
  v810[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_18;
  v810[3] = &unk_1E7570878;
  v810[4] = self;
  v247 = v246;
  v811 = v247;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing up unknown analysis states" ifRequired:a5 < 10070 block:v810];
  v808[0] = MEMORY[0x1E69E9820];
  v808[1] = 3221225472;
  v808[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_19;
  v808[3] = &unk_1E7570878;
  v808[4] = self;
  v248 = v247;
  v809 = v248;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing up mismatched analysis state uuids" ifRequired:(a5 & 0xFFFFFFFC) == 10068 block:v808];
  v806[0] = MEMORY[0x1E69E9820];
  v806[1] = 3221225472;
  v806[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_20;
  v806[3] = &unk_1E7570878;
  v806[4] = self;
  v249 = v248;
  v807 = v249;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Touching analysis state sort tokens" ifRequired:a5 < 10079 block:v806];
  v804[0] = MEMORY[0x1E69E9820];
  v804[1] = 3221225472;
  v804[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_21;
  v804[3] = &unk_1E7570878;
  v804[4] = self;
  v250 = v249;
  v805 = v250;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating latitude and longitude in assets" ifRequired:a5 < 10036 block:v804];
  v802[0] = MEMORY[0x1E69E9820];
  v802[1] = 3221225472;
  v802[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_22;
  v802[3] = &unk_1E7570878;
  v802[4] = self;
  v251 = v250;
  v803 = v251;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Forcing file system persistence for memories" ifRequired:a5 < 10041 block:v802];
  v800[0] = MEMORY[0x1E69E9820];
  v800[1] = 3221225472;
  v800[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_23;
  v800[3] = &unk_1E7570878;
  v800[4] = self;
  v252 = v251;
  v801 = v252;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Forcing file system persistence for persons" ifRequired:v490 block:v800];
  v798[0] = MEMORY[0x1E69E9820];
  v798[1] = 3221225472;
  v798[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_24;
  v798[3] = &unk_1E7570878;
  v798[4] = self;
  v253 = v252;
  v799 = v253;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing old file system persistence for persons" ifRequired:a5 < 10203 block:v798];
  v796[0] = MEMORY[0x1E69E9820];
  v796[1] = 3221225472;
  v796[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_25;
  v796[3] = &unk_1E7570878;
  v796[4] = self;
  v254 = v253;
  v797 = v254;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating asset's filename with nil originalFilename" ifRequired:a5 < 11052 block:v796];
  v794[0] = MEMORY[0x1E69E9820];
  v794[1] = 3221225472;
  v794[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_712;
  v794[3] = &unk_1E7570878;
  v794[4] = self;
  v255 = v254;
  v795 = v255;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Flattening unknown custom rendered values (0 or 1) to 0" ifRequired:a5 < 10065 block:v794];
  v792[0] = MEMORY[0x1E69E9820];
  v792[1] = 3221225472;
  v792[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_716;
  v792[3] = &unk_1E7570878;
  v792[4] = self;
  v256 = v255;
  v793 = v256;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing custom rendered values" ifRequired:v434 block:v792];
  v790[0] = MEMORY[0x1E69E9820];
  v790[1] = 3221225472;
  v790[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_720;
  v790[3] = &unk_1E7570878;
  v790[4] = self;
  v257 = v256;
  v791 = v257;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting all memories" ifRequired:a5 < 10088 block:v790];
  v789[0] = MEMORY[0x1E69E9820];
  v789[1] = 3221225472;
  v789[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_724;
  v789[3] = &unk_1E7573368;
  v789[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Applying data protection to DCIM (D->C)" ifRequired:v426 < 0x67 block:v789];
  v787[0] = MEMORY[0x1E69E9820];
  v787[1] = 3221225472;
  v787[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_728;
  v787[3] = &unk_1E7570878;
  v787[4] = self;
  v258 = v257;
  v788 = v258;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing faceAlgorithmVersion" ifRequired:a5 < 10106 block:v787];
  v785[0] = MEMORY[0x1E69E9820];
  v785[1] = 3221225472;
  v785[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_732;
  v785[3] = &unk_1E7570878;
  v785[4] = self;
  v259 = v258;
  v786 = v259;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing zero duration photo iris" ifRequired:v426 < 0x75 block:v785];
  v783[0] = MEMORY[0x1E69E9820];
  v783[1] = 3221225472;
  v783[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_736;
  v783[3] = &unk_1E7570878;
  v783[4] = self;
  v260 = v259;
  v784 = v260;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing CameraRoll" ifRequired:a5 < 10112 block:v783];
  v781[0] = MEMORY[0x1E69E9820];
  v781[1] = 3221225472;
  v781[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_740;
  v781[3] = &unk_1E7570878;
  v781[4] = self;
  v261 = v260;
  v782 = v261;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing lastPrefetchDate" ifRequired:v435 block:v781];
  v779[0] = MEMORY[0x1E69E9820];
  v779[1] = 3221225472;
  v779[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9_744;
  v779[3] = &unk_1E7570878;
  v779[4] = self;
  v262 = v261;
  v780 = v262;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing locallyAvailableFlag for thumbnails" ifRequired:v435 block:v779];
  v777[0] = MEMORY[0x1E69E9820];
  v777[1] = 3221225472;
  v777[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_748;
  v777[3] = &unk_1E7570878;
  v777[4] = self;
  v263 = v262;
  v778 = v263;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating key asset in memory" ifRequired:a5 < 11000 block:v777];
  v775[0] = MEMORY[0x1E69E9820];
  v775[1] = 3221225472;
  v775[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_752;
  v775[3] = &unk_1E7570878;
  v775[4] = self;
  v264 = v263;
  v776 = v264;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Delete orphaned unverified people" ifRequired:a5 < 10123 block:v775];
  v773[0] = MEMORY[0x1E69E9820];
  v773[1] = 3221225472;
  v773[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12_756;
  v773[3] = &unk_1E7570878;
  v773[4] = self;
  v265 = v264;
  v774 = v265;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing memories with duplicate assetLists" ifRequired:a5 < 10150 block:v773];
  v771[0] = MEMORY[0x1E69E9820];
  v771[1] = 3221225472;
  v771[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_13_760;
  v771[3] = &unk_1E7570878;
  v771[4] = self;
  v266 = v265;
  v772 = v266;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing untracked cloud resource image derivatives" ifRequired:v491 block:v771];
  v769[0] = MEMORY[0x1E69E9820];
  v769[1] = 3221225472;
  v769[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_14_764;
  v769[3] = &unk_1E7570878;
  v769[4] = self;
  v267 = v266;
  v770 = v267;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Rebuilding thumbnails for wide gamut captures" ifRequired:a5 < 10206 block:v769];
  v766[0] = MEMORY[0x1E69E9820];
  v766[1] = 3221225472;
  v766[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_15_768;
  v766[3] = &unk_1E7568D08;
  v768 = v423 & 1;
  v766[4] = self;
  v268 = v267;
  v767 = v268;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Persist iris visibility state to disk." ifRequired:v493 block:v766];
  v764[0] = MEMORY[0x1E69E9820];
  v764[1] = 3221225472;
  v764[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_773;
  v764[3] = &unk_1E7570878;
  v764[4] = self;
  v269 = v268;
  v765 = v269;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Remove invalid albums and folders." ifRequired:v492 block:v764];
  v761[0] = MEMORY[0x1E69E9820];
  v761[1] = 3221225472;
  v761[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_777;
  v761[3] = &unk_1E7568D08;
  v763 = v423 & 1;
  v761[4] = self;
  v270 = v269;
  v762 = v270;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Set playback style for all animated GIFs." ifRequired:a5 < 11061 block:v761];
  v759[0] = MEMORY[0x1E69E9820];
  v759[1] = 3221225472;
  v759[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_782;
  v759[3] = &unk_1E7570878;
  v759[4] = self;
  v271 = v270;
  v760 = v271;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing movie asset attributes" ifRequired:v436 block:v759];
  v758[0] = MEMORY[0x1E69E9820];
  v758[1] = 3221225472;
  v758[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_786;
  v758[3] = &unk_1E7573368;
  v758[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Dropping search index after lightweight migration" ifRequired:v438 block:v758];
  v756[0] = MEMORY[0x1E69E9820];
  v756[1] = 3221225472;
  v756[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_790;
  v756[3] = &unk_1E7570878;
  v756[4] = self;
  v272 = v271;
  v757 = v272;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Reset scene analysis for algorithm bump" ifRequired:v437 block:v756];
  v754[0] = MEMORY[0x1E69E9820];
  v754[1] = 3221225472;
  v754[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_794;
  v754[3] = &unk_1E7570878;
  v754[4] = self;
  v273 = v272;
  v755 = v273;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix name source const" ifRequired:a5 < 10102 block:v754];
  v752[0] = MEMORY[0x1E69E9820];
  v752[1] = 3221225472;
  v752[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_798;
  v752[3] = &unk_1E7570878;
  v752[4] = self;
  v274 = v273;
  v753 = v274;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Refresh trigger values" ifRequired:a5 < 10109 block:v752];
  v751[0] = MEMORY[0x1E69E9820];
  v751[1] = 3221225472;
  v751[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_802;
  v751[3] = &unk_1E7573368;
  v751[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Clear vision worker" ifRequired:a5 < 10204 block:v751];
  v749[0] = MEMORY[0x1E69E9820];
  v749[1] = 3221225472;
  v749[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_806;
  v749[3] = &unk_1E7570878;
  v749[4] = self;
  v275 = v274;
  v750 = v275;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix rejected key face" ifRequired:a5 < 10207 block:v749];
  v747[0] = MEMORY[0x1E69E9820];
  v747[1] = 3221225472;
  v747[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_810;
  v747[3] = &unk_1E7570878;
  v747[4] = self;
  v276 = v275;
  v748 = v276;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix merged people that should be verified" ifRequired:v494 block:v747];
  v745[0] = MEMORY[0x1E69E9820];
  v745[1] = 3221225472;
  v745[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9_814;
  v745[3] = &unk_1E7570878;
  v745[4] = self;
  v277 = v276;
  v746 = v277;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Prompt unknown assets" ifRequired:a5 < 13027 block:v745];
  v743[0] = MEMORY[0x1E69E9820];
  v743[1] = 3221225472;
  v743[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_818;
  v743[3] = &unk_1E7570878;
  v743[4] = self;
  v278 = v277;
  v744 = v278;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix zero trash date" ifRequired:a5 < 11001 block:v743];
  v741[0] = MEMORY[0x1E69E9820];
  v741[1] = 3221225472;
  v741[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_822;
  v741[3] = &unk_1E7570878;
  v741[4] = self;
  v279 = v278;
  v742 = v279;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix master cloudLocalState enum" ifRequired:v495 block:v741];
  v739[0] = MEMORY[0x1E69E9820];
  v739[1] = 3221225472;
  v739[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12_826;
  v739[3] = &unk_1E7570878;
  v739[4] = self;
  v280 = v279;
  v740 = v280;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populate cloud resource local state" ifRequired:v496 block:v739];
  v737[0] = MEMORY[0x1E69E9820];
  v737[1] = 3221225472;
  v737[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_13_830;
  v737[3] = &unk_1E7570878;
  v737[4] = self;
  v281 = v280;
  v738 = v281;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix cropped unadjusted assets issue" ifRequired:v497 block:v737];
  v735[0] = MEMORY[0x1E69E9820];
  v735[1] = 3221225472;
  v735[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_14_834;
  v735[3] = &unk_1E7570878;
  v735[4] = self;
  v282 = v281;
  v736 = v282;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populating user keyFacePickSource on Person" ifRequired:a5 < 11022 block:v735];
  v733[0] = MEMORY[0x1E69E9820];
  v733[1] = 3221225472;
  v733[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_15_838;
  v733[3] = &unk_1E7570878;
  v733[4] = self;
  v283 = v282;
  v734 = v283;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Converting nameSource from BOOL to int on DeferredRebuildFace" ifRequired:a5 < 11024 block:v733];
  v731[0] = MEMORY[0x1E69E9820];
  v731[1] = 3221225472;
  v731[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_16_842;
  v731[3] = &unk_1E7570878;
  v731[4] = self;
  v284 = v283;
  v732 = v284;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing duplicated cloud asset guid from the database" ifRequired:a5 < 11025 block:v731];
  v729[0] = MEMORY[0x1E69E9820];
  v729[1] = 3221225472;
  v729[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_17_843;
  v729[3] = &unk_1E7570878;
  v729[4] = self;
  v285 = v284;
  v730 = v285;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing duplicated cloud asset guid from the database" ifRequired:(a5 - 11022) < 4 block:v729];
  v727[0] = MEMORY[0x1E69E9820];
  v727[1] = 3221225472;
  v727[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_18_847;
  v727[3] = &unk_1E7570878;
  v727[4] = self;
  v286 = v285;
  v728 = v286;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing whitelist owner for pending invitations" ifRequired:(a5 - 10425) < 0x25B block:v727];
  v725[0] = MEMORY[0x1E69E9820];
  v725[1] = 3221225472;
  v725[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_19_851;
  v725[3] = &unk_1E7570878;
  v725[4] = self;
  v287 = v286;
  v726 = v287;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repush memories with new features" ifRequired:v498 block:v725];
  v723[0] = MEMORY[0x1E69E9820];
  v723[1] = 3221225472;
  v723[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_20_855;
  v723[3] = &unk_1E7570878;
  v723[4] = self;
  v288 = v287;
  v724 = v288;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Retry quarantined assets and fix resource relation" ifRequired:v500 block:v723];
  v719[0] = MEMORY[0x1E69E9820];
  v719[1] = 3221225472;
  v719[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_21_859;
  v719[3] = &unk_1E7568D80;
  v721 = a5;
  v719[4] = self;
  v289 = v288;
  v720 = v289;
  v722 = v440;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Preparing library for faces sync" ifRequired:a5 < 11043 block:v719];
  v717[0] = MEMORY[0x1E69E9820];
  v717[1] = 3221225472;
  v717[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_869;
  v717[3] = &unk_1E7570878;
  v717[4] = self;
  v290 = v289;
  v718 = v290;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populate faces with cloudNameSource" ifRequired:a5 < 11047 block:v717];
  v715[0] = MEMORY[0x1E69E9820];
  v715[1] = 3221225472;
  v715[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_873;
  v715[3] = &unk_1E7570878;
  v715[4] = self;
  v291 = v290;
  v716 = v291;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Update playback styles and variations" ifRequired:a5 < 11048 block:v715];
  v712[0] = MEMORY[0x1E69E9820];
  v712[1] = 3221225472;
  v712[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_877;
  v712[3] = &unk_1E7568D08;
  v714 = v423 & 1;
  v712[4] = self;
  v292 = v291;
  v713 = v292;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Identifying variations and new depth adjustments" ifRequired:a5 < 11070 block:v712];
  v710[0] = MEMORY[0x1E69E9820];
  v710[1] = 3221225472;
  v710[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_882;
  v710[3] = &unk_1E7570878;
  v710[4] = self;
  v293 = v292;
  v711 = v293;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Populate persons with cloudVerifiedType" ifRequired:a5 < 11049 block:v710];
  v708[0] = MEMORY[0x1E69E9820];
  v708[1] = 3221225472;
  v708[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_886;
  v708[3] = &unk_1E7570878;
  v708[4] = self;
  v294 = v293;
  v709 = v294;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting face quality" ifRequired:v439 block:v708];
  v706[0] = MEMORY[0x1E69E9820];
  v706[1] = 3221225472;
  v706[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_890;
  v706[3] = &unk_1E7570878;
  v706[4] = self;
  v295 = v294;
  v707 = v295;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing untracked person metadata" ifRequired:a5 < 11060 block:v706];
  v704[0] = MEMORY[0x1E69E9820];
  v704[1] = 3221225472;
  v704[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_894;
  v704[3] = &unk_1E7570878;
  v704[4] = self;
  v296 = v295;
  v705 = v296;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting manual order on non-favorite persons" ifRequired:a5 < 11063 block:v704];
  v703[0] = MEMORY[0x1E69E9820];
  v703[1] = 3221225472;
  v703[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_898;
  v703[3] = &unk_1E7573368;
  v703[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing 'AutoloopCache' folder if it still exists" ifRequired:v481 < 0x40 block:v703];
  v701[0] = MEMORY[0x1E69E9820];
  v701[1] = 3221225472;
  v701[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_902;
  v701[3] = &unk_1E7570878;
  v701[4] = self;
  v297 = v296;
  v702 = v297;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing asset master relationship" ifRequired:a5 < 11069 block:v701];
  v700[0] = MEMORY[0x1E69E9820];
  v700[1] = 3221225472;
  v700[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_906;
  v700[3] = &unk_1E7573368;
  v700[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Going to send optimize setting feedback" ifRequired:v441 block:v700];
  v698[0] = MEMORY[0x1E69E9820];
  v698[1] = 3221225472;
  v698[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_911;
  v698[3] = &unk_1E7570878;
  v698[4] = self;
  v298 = v297;
  v699 = v298;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing nil cloudMasterGUID" ifRequired:v442 block:v698];
  v696[0] = MEMORY[0x1E69E9820];
  v696[1] = 3221225472;
  v696[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9_915;
  v696[3] = &unk_1E7570878;
  v696[4] = self;
  v299 = v298;
  v697 = v299;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repush persons with merge target" ifRequired:v443 block:v696];
  v694[0] = MEMORY[0x1E69E9820];
  v694[1] = 3221225472;
  v694[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_919;
  v694[3] = &unk_1E7570878;
  v694[4] = self;
  v300 = v299;
  v695 = v300;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Persist storeUUID to mobileCPL.plist" ifRequired:v444 block:v694];
  v692[0] = MEMORY[0x1E69E9820];
  v692[1] = 3221225472;
  v692[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_923;
  v692[3] = &unk_1E7570878;
  v692[4] = self;
  v301 = v300;
  v693 = v301;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Puring cloud shared resources" ifRequired:a5 < 11079 block:v692];
  v690[0] = MEMORY[0x1E69E9820];
  v690[1] = 3221225472;
  v690[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_931;
  v690[3] = &unk_1E7570878;
  v690[4] = self;
  v302 = v301;
  v691 = v302;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting persons without UUID" ifRequired:a5 < 11080 block:v690];
  v688[0] = MEMORY[0x1E69E9820];
  v688[1] = 3221225472;
  v688[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_935;
  v688[3] = &unk_1E7570878;
  v688[4] = self;
  v303 = v302;
  v689 = v303;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Unquarantined quarantined items" ifRequired:v445 block:v688];
  v686[0] = MEMORY[0x1E69E9820];
  v686[1] = 3221225472;
  v686[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_939;
  v686[3] = &unk_1E7570878;
  v686[4] = self;
  v304 = v303;
  v687 = v304;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix UTI for slow-mo videos" ifRequired:(a5 - 10075) < 0x3F1 block:v686];
  v685[0] = MEMORY[0x1E69E9820];
  v685[1] = 3221225472;
  v685[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_943;
  v685[3] = &unk_1E7573368;
  v685[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix initialsync_marker" ifRequired:v446 block:v685];
  v683[0] = MEMORY[0x1E69E9820];
  v683[1] = 3221225472;
  v683[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_947;
  v683[3] = &unk_1E7570878;
  v683[4] = self;
  v305 = v304;
  v684 = v305;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Moving cloud shared derivatives" ifRequired:(a5 - 11079) < 0xC block:v683];
  v681[0] = MEMORY[0x1E69E9820];
  v681[1] = 3221225472;
  v681[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_951;
  v681[3] = &unk_1E7570878;
  v681[4] = self;
  v306 = v305;
  v682 = v306;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing duplicated root folder/orphaned albums" ifRequired:a5 < 11203 block:v681];
  v678[0] = MEMORY[0x1E69E9820];
  v678[1] = 3221225472;
  v678[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_955;
  v678[3] = &unk_1E7570878;
  v307 = v306;
  v679 = v307;
  v680 = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Reconsidering saved asset type" ifRequired:a5 < 12035 block:v678];
  v308 = *MEMORY[0x1E69BF6D0];
  v309 = *MEMORY[0x1E69BF710];
  v676[0] = MEMORY[0x1E69E9820];
  v676[1] = 3221225472;
  v676[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_959;
  v676[3] = &unk_1E7570878;
  v676[4] = self;
  v310 = v307;
  v677 = v310;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting and populating internal resources" ifRequired:a5 < 13106 recordTimedCoreAnalyticsEvent:v308 coreAnalyticsEventKey:v309 block:v676];
  v673[0] = MEMORY[0x1E69E9820];
  v673[1] = 3221225472;
  v673[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_965;
  v673[3] = &unk_1E7570878;
  v311 = v310;
  v674 = v311;
  v675 = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting legacy cloud resources" ifRequired:a5 < 13119 block:v673];
  v671[0] = MEMORY[0x1E69E9820];
  v671[1] = 3221225472;
  v671[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_969;
  v671[3] = &unk_1E7570878;
  v671[4] = self;
  v312 = v311;
  v672 = v312;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting dummy worker analysis states" ifRequired:a5 < 11200 block:v671];
  v669[0] = MEMORY[0x1E69E9820];
  v669[1] = 3221225472;
  v669[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_973;
  v669[3] = &unk_1E7570878;
  v669[4] = self;
  v313 = v312;
  v670 = v313;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Cleaning up wallpaper remnants" ifRequired:a5 < 12000 block:v669];
  v667[0] = MEMORY[0x1E69E9820];
  v667[1] = 3221225472;
  v667[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_977;
  v667[3] = &unk_1E7570878;
  v667[4] = self;
  v314 = v313;
  v668 = v314;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting persistent history" ifRequired:v447 block:v667];
  v665[0] = MEMORY[0x1E69E9820];
  v665[1] = 3221225472;
  v665[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_981;
  v665[3] = &unk_1E7570878;
  v665[4] = self;
  v315 = v314;
  v666 = v315;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Remove invalidAdjustmentResourceData" ifRequired:v449 block:v665];
  v663[0] = MEMORY[0x1E69E9820];
  v663[1] = 3221225472;
  v663[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_985;
  v663[3] = &unk_1E7570878;
  v663[4] = self;
  v316 = v315;
  v664 = v316;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Creating importSession albums" ifRequired:v448 block:v663];
  v661[0] = MEMORY[0x1E69E9820];
  v661[1] = 3221225472;
  v661[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_990;
  v661[3] = &unk_1E7570878;
  v661[4] = self;
  v317 = v316;
  v662 = v317;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Remove invalid importSession albums" ifRequired:a5 < 13036 block:v661];
  v659[0] = MEMORY[0x1E69E9820];
  v659[1] = 3221225472;
  v659[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_994;
  v659[3] = &unk_1E7570878;
  v659[4] = self;
  v318 = v317;
  v660 = v318;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix zero dimensions for local raw images" ifRequired:a5 < 13050 block:v659];
  v657[0] = MEMORY[0x1E69E9820];
  v657[1] = 3221225472;
  v657[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_998;
  v657[3] = &unk_1E7570878;
  v657[4] = self;
  v319 = v318;
  v658 = v319;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Remove scenes that are below the previous threshold" ifRequired:a5 < 12036 block:v657];
  v655[0] = MEMORY[0x1E69E9820];
  v655[1] = 3221225472;
  v655[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_1002;
  v655[3] = &unk_1E7570878;
  v655[4] = self;
  v320 = v319;
  v656 = v320;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Revalidating import session dates" ifRequired:v452 block:v655];
  v653[0] = MEMORY[0x1E69E9820];
  v653[1] = 3221225472;
  v653[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_1006;
  v653[3] = &unk_1E7570878;
  v653[4] = self;
  v321 = v320;
  v654 = v321;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Set importedBy in PLCloudMaster" ifRequired:v451 block:v653];
  v650[0] = MEMORY[0x1E69E9820];
  v650[1] = 3221225472;
  v650[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_1010;
  v650[3] = &unk_1E7568D08;
  v652 = v423 & 1;
  v650[4] = self;
  v322 = v321;
  v651 = v322;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Delete video thumbs with preferred keyframe" ifRequired:v450 block:v650];
  v648[0] = MEMORY[0x1E69E9820];
  v648[1] = 3221225472;
  v648[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_1015;
  v648[3] = &unk_1E7570878;
  v648[4] = self;
  v323 = v322;
  v649 = v323;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Reset Analysis state for videos" ifRequired:v453 block:v648];
  v646[0] = MEMORY[0x1E69E9820];
  v646[1] = 3221225472;
  v646[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_1019;
  v646[3] = &unk_1E7570878;
  v646[4] = self;
  v324 = v323;
  v647 = v324;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix CMM assets in DCIM folder with wrong saved asset type" ifRequired:a5 < 13089 block:v646];
  v644[0] = MEMORY[0x1E69E9820];
  v644[1] = 3221225472;
  v644[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_1023;
  v644[3] = &unk_1E7570878;
  v644[4] = self;
  v325 = v324;
  v645 = v325;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Add UUIDs to existing keywords" ifRequired:a5 < 13099 block:v644];
  v642[0] = MEMORY[0x1E69E9820];
  v642[1] = 3221225472;
  v642[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_1027;
  v642[3] = &unk_1E7570878;
  v642[4] = self;
  v326 = v325;
  v643 = v326;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Update start and end dates for suggestions missing them" ifRequired:a5 < 13103 block:v642];
  v640[0] = MEMORY[0x1E69E9820];
  v640[1] = 3221225472;
  v640[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_1031;
  v640[3] = &unk_1E7570878;
  v640[4] = self;
  v327 = v326;
  v641 = v327;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting all orphaned ExtendedAttributes" ifRequired:a5 < 13117 block:v640];
  v638[0] = MEMORY[0x1E69E9820];
  v638[1] = 3221225472;
  v638[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_1035;
  v638[3] = &unk_1E7570878;
  v638[4] = self;
  v328 = v327;
  v639 = v328;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Deleting extraneous adjusted full size resource rows" ifRequired:a5 < 13137 block:v638];
  v636[0] = MEMORY[0x1E69E9820];
  v636[1] = 3221225472;
  v636[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_1039;
  v636[3] = &unk_1E7570878;
  v636[4] = self;
  v329 = v328;
  v637 = v329;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating missing FileSystemVolume.uuid values" ifRequired:a5 < 13152 block:v636];
  v635[0] = MEMORY[0x1E69E9820];
  v635[1] = 3221225472;
  v635[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_1043;
  v635[3] = &unk_1E7573368;
  v635[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating CPL marker files" ifRequired:v454 block:v635];
  v633[0] = MEMORY[0x1E69E9820];
  v633[1] = 3221225472;
  v633[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9_1047;
  v633[3] = &unk_1E7570878;
  v633[4] = self;
  v330 = v329;
  v634 = v330;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating album start/end dates" ifRequired:a5 < 13187 block:v633];
  v632[0] = MEMORY[0x1E69E9820];
  v632[1] = 3221225472;
  v632[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_1051;
  v632[3] = &unk_1E7573368;
  v632[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Going to repush videos" ifRequired:v455 block:v632];
  v630[0] = MEMORY[0x1E69E9820];
  v630[1] = 3221225472;
  v630[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_1055;
  v630[3] = &unk_1E7570878;
  v630[4] = self;
  v331 = v330;
  v631 = v331;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing kindSubtype for live photos with LoopingVideo playbackStyle" ifRequired:a5 < 13191 block:v630];
  v628[0] = MEMORY[0x1E69E9820];
  v628[1] = 3221225472;
  v628[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12_1059;
  v628[3] = &unk_1E7570878;
  v628[4] = self;
  v332 = v331;
  v629 = v332;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing white balance values" ifRequired:a5 < 13193 block:v628];
  v626[0] = MEMORY[0x1E69E9820];
  v626[1] = 3221225472;
  v626[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_13_1063;
  v626[3] = &unk_1E7570878;
  v626[4] = self;
  v333 = v332;
  v627 = v333;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing unneeded analysis state table entries" ifRequired:a5 < 13195 block:v626];
  v624[0] = MEMORY[0x1E69E9820];
  v624[1] = 3221225472;
  v624[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_14_1067;
  v624[3] = &unk_1E7570878;
  v624[4] = self;
  v334 = v333;
  v625 = v334;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing UTI for RD Migration" ifRequired:a5 < 13196 block:v624];
  v621[0] = MEMORY[0x1E69E9820];
  v621[1] = 3221225472;
  v621[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_15_1071;
  v621[3] = &unk_1E7568D08;
  v621[4] = self;
  v335 = v334;
  v622 = v335;
  v623 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Regenerating all Shared Streams resources data store key data" ifRequired:v96 < 0xE3 block:v621];
  v619[0] = MEMORY[0x1E69E9820];
  v619[1] = 3221225472;
  v619[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_16_1075;
  v619[3] = &unk_1E7570878;
  v619[4] = self;
  v336 = v335;
  v620 = v336;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing location values" ifRequired:a5 < 13200 block:v619];
  v617[0] = MEMORY[0x1E69E9820];
  v617[1] = 3221225472;
  v617[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_17_1079;
  v617[3] = &unk_1E7570878;
  v617[4] = self;
  v337 = v336;
  v618 = v337;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Invalidating reverse geocoding data" ifRequired:a5 < 13307 block:v617];
  v615[0] = MEMORY[0x1E69E9820];
  v615[1] = 3221225472;
  v615[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_18_1083;
  v615[3] = &unk_1E7570878;
  v615[4] = self;
  v338 = v337;
  v616 = v338;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing has location query on Smart Album" ifRequired:a5 < 13222 block:v615];
  v613[0] = MEMORY[0x1E69E9820];
  v613[1] = 3221225472;
  v613[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_19_1087;
  v613[3] = &unk_1E7570878;
  v613[4] = self;
  v339 = v338;
  v614 = v339;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing XMP resource UTIs" ifRequired:0 block:v613];
  v612[0] = MEMORY[0x1E69E9820];
  v612[1] = 3221225472;
  v612[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_20_1091;
  v612[3] = &unk_1E7573368;
  v612[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrate purgeable resources" ifRequired:a5 < 13260 block:v612];
  v610[0] = MEMORY[0x1E69E9820];
  v610[1] = 3221225472;
  v610[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_21_1095;
  v610[3] = &unk_1E7570878;
  v610[4] = self;
  v340 = v339;
  v611 = v340;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Renumbering localAvailability/localAvailabilityTargets" ifRequired:a5 < 13242 block:v610];
  v607[0] = MEMORY[0x1E69E9820];
  v607[1] = 3221225472;
  v607[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_22_1099;
  v607[3] = &unk_1E7568D08;
  v607[4] = self;
  v341 = v340;
  v608 = v341;
  v609 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating existing 1k resources from version specific to current" ifRequired:0 block:v607];
  v605[0] = MEMORY[0x1E69E9820];
  v605[1] = 3221225472;
  v605[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_23_1103;
  v605[3] = &unk_1E7570878;
  v605[4] = self;
  v342 = v341;
  v606 = v342;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Requesting availability of 1k for relevant assets" ifRequired:0 block:v605];
  v603[0] = MEMORY[0x1E69E9820];
  v603[1] = 3221225472;
  v603[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_24_1107;
  v603[3] = &unk_1E7570878;
  v603[4] = self;
  v343 = v342;
  v604 = v343;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Reconstructing PLExtendedAttributes for images" ifRequired:v456 block:v603];
  v601[0] = MEMORY[0x1E69E9820];
  v601[1] = 3221225472;
  v601[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_25_1111;
  v601[3] = &unk_1E7570878;
  v601[4] = self;
  v344 = v343;
  v602 = v344;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Moving 1k resources out of masters dir" ifRequired:a5 < 13301 block:v601];
  v599[0] = MEMORY[0x1E69E9820];
  v599[1] = 3221225472;
  v599[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_26;
  v599[3] = &unk_1E7570878;
  v599[4] = self;
  v345 = v344;
  v600 = v345;
  v346 = v96 < 0x12F;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Remap PLResourceTypeUnknown..." ifRequired:v346 block:v599];
  v597[0] = MEMORY[0x1E69E9820];
  v597[1] = 3221225472;
  v597[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_27;
  v597[3] = &unk_1E7570878;
  v597[4] = self;
  v347 = v345;
  v598 = v347;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Rebuild ReferenceKeys..." ifRequired:v346 block:v597];
  v596[0] = MEMORY[0x1E69E9820];
  v596[1] = 3221225472;
  v596[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_28;
  v596[3] = &unk_1E7573368;
  v596[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Relocate CPL marker files" ifRequired:a5 < 13304 block:v596];
  v595[0] = MEMORY[0x1E69E9820];
  v595[1] = 3221225472;
  v595[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_29;
  v595[3] = &unk_1E7573368;
  v595[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Cleanup legacy files" ifRequired:a5 < 13309 block:v595];
  v593[0] = MEMORY[0x1E69E9820];
  v593[1] = 3221225472;
  v593[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_30;
  v593[3] = &unk_1E7570878;
  v593[4] = self;
  v348 = v347;
  v594 = v348;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Relocate original UBF files" ifRequired:a5 < 13323 block:v593];
  v591[0] = MEMORY[0x1E69E9820];
  v591[1] = 3221225472;
  v591[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_31;
  v591[3] = &unk_1E7570878;
  v591[4] = self;
  v349 = v348;
  v592 = v349;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"verifying and fixing local availability for resources with broken fileIDs..." ifRequired:a5 < 13351 block:v591];
  v589[0] = MEMORY[0x1E69E9820];
  v589[1] = 3221225472;
  v589[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_32;
  v589[3] = &unk_1E7570878;
  v589[4] = self;
  v350 = v349;
  v590 = v350;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Recalculating shared stream paths..." ifRequired:0 block:v589];
  v587[0] = MEMORY[0x1E69E9820];
  v587[1] = 3221225472;
  v587[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_33;
  v587[3] = &unk_1E7570878;
  v587[4] = self;
  v351 = v350;
  v588 = v351;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing shared stream video resources..." ifRequired:v96 < 0x1F8 block:v587];
  v585[0] = MEMORY[0x1E69E9820];
  v585[1] = 3221225472;
  v585[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_34;
  v585[3] = &unk_1E7570878;
  v585[4] = self;
  v352 = v351;
  v586 = v352;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing CPL resources that are uploaded not remotely available..." ifRequired:v96 < 0x213 block:v585];
  v583[0] = MEMORY[0x1E69E9820];
  v583[1] = 3221225472;
  v583[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_35;
  v583[3] = &unk_1E7570878;
  v583[4] = self;
  v353 = v352;
  v584 = v353;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing CPL resources that are uploaded not remotely available..." ifRequired:v96 < 0x1FB block:v583];
  v581[0] = MEMORY[0x1E69E9820];
  v581[1] = 3221225472;
  v581[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_36;
  v581[3] = &unk_1E7570878;
  v581[4] = self;
  v354 = v353;
  v582 = v354;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing adjustedFingerPrint values..." ifRequired:0 block:v581];
  v580[0] = MEMORY[0x1E69E9820];
  v580[1] = 3221225472;
  v580[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_37;
  v580[3] = &unk_1E7573368;
  v580[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Going to repush master with missing media metadata" ifRequired:v458 block:v580];
  v578[0] = MEMORY[0x1E69E9820];
  v578[1] = 3221225472;
  v578[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_38;
  v578[3] = &unk_1E7570878;
  v578[4] = self;
  v355 = v354;
  v579 = v355;
  v356 = a5 < 13533;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Scavenging for snowplowGroupUUIDs..." ifRequired:v356 block:v578];
  v576[0] = MEMORY[0x1E69E9820];
  v576[1] = 3221225472;
  v576[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_39;
  v576[3] = &unk_1E7570878;
  v576[4] = self;
  v357 = v355;
  v577 = v357;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix invalid post migration filesystem imported assets" ifRequired:(a5 - 13513) < 3 block:v576];
  v574[0] = MEMORY[0x1E69E9820];
  v574[1] = 3221225472;
  v574[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_40;
  v574[3] = &unk_1E7570878;
  v574[4] = self;
  v358 = v357;
  v575 = v358;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Running CTM pairing..." ifRequired:v356 block:v574];
  v572[0] = MEMORY[0x1E69E9820];
  v572[1] = 3221225472;
  v572[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_41;
  v572[3] = &unk_1E7570878;
  v572[4] = self;
  v359 = v358;
  v573 = v359;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing orphaned project extensions..." ifRequired:0 block:v572];
  v571[0] = MEMORY[0x1E69E9820];
  v571[1] = 3221225472;
  v571[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_42;
  v571[3] = &unk_1E7573368;
  v571[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing table thumb fragmentation..." ifRequired:0 block:v571];
  v569[0] = MEMORY[0x1E69E9820];
  v569[1] = 3221225472;
  v569[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_43;
  v569[3] = &unk_1E7570878;
  v569[4] = self;
  v360 = v359;
  v570 = v360;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Marking all user smart albums not pushed..." ifRequired:0 block:v569];
  v567[0] = MEMORY[0x1E69E9820];
  v567[1] = 3221225472;
  v567[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_44;
  v567[3] = &unk_1E7570878;
  v567[4] = self;
  v361 = v360;
  v568 = v361;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing Legacy Migration with Duplicate Versions and missing Cloud Resources..." ifRequired:0 block:v567];
  v565[0] = MEMORY[0x1E69E9820];
  v565[1] = 3221225472;
  v565[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_45;
  v565[3] = &unk_1E7570878;
  v565[4] = self;
  v362 = v361;
  v566 = v362;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating candidate bits to deferred processing candidate bits..." ifRequired:a5 < 14005 block:v565];
  v563[0] = MEMORY[0x1E69E9820];
  v563[1] = 3221225472;
  v563[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_46;
  v563[3] = &unk_1E7570878;
  v563[4] = self;
  v363 = v362;
  v564 = v363;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Moving GPS horizontal accuracy to new attribute..." ifRequired:a5 < 14009 block:v563];
  v561[0] = MEMORY[0x1E69E9820];
  v561[1] = 3221225472;
  v561[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_47;
  v561[3] = &unk_1E7570878;
  v561[4] = self;
  v364 = v363;
  v562 = v364;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Reconsidering allowed for analysis on assets marked as not allowed..." ifRequired:a5 < 18083 block:v561];
  v559[0] = MEMORY[0x1E69E9820];
  v559[1] = 3221225472;
  v559[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_48;
  v559[3] = &unk_1E7570878;
  v559[4] = self;
  v365 = v364;
  v560 = v365;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Migrating metadata and migration history..." ifRequired:a5 < 14016 block:v559];
  v557[0] = MEMORY[0x1E69E9820];
  v557[1] = 3221225472;
  v557[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_49;
  v557[3] = &unk_1E7570878;
  v557[4] = self;
  v366 = v365;
  v558 = v366;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing reframe videos without SOC available bit..." ifRequired:a5 < 14021 block:v557];
  v555[0] = MEMORY[0x1E69E9820];
  v555[1] = 3221225472;
  v555[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_50;
  v555[3] = &unk_1E7570878;
  v555[4] = self;
  v367 = v366;
  v556 = v367;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fixing avalancheUUID for cloud shared assets..." ifRequired:a5 < 14025 block:v555];
  v553[0] = MEMORY[0x1E69E9820];
  v553[1] = 3221225472;
  v553[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_51;
  v553[3] = &unk_1E7570878;
  v553[4] = self;
  v368 = v367;
  v554 = v368;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Regenerating month highlight titles..." ifRequired:a5 < 14027 block:v553];
  v551[0] = MEMORY[0x1E69E9820];
  v551[1] = 3221225472;
  v551[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_52;
  v551[3] = &unk_1E7570878;
  v551[4] = self;
  v369 = v368;
  v552 = v369;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Copying asset description to accessibility description..." ifRequired:a5 < 14032 block:v551];
  v549[0] = MEMORY[0x1E69E9820];
  v549[1] = 3221225472;
  v549[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_53;
  v549[3] = &unk_1E7570878;
  v549[4] = self;
  v370 = v369;
  v550 = v370;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing all local video key frame resources to revert 14037..." ifRequired:a5 == 14037 block:v549];
  v547[0] = MEMORY[0x1E69E9820];
  v547[1] = 3221225472;
  v547[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_54;
  v547[3] = &unk_1E7570878;
  v547[4] = self;
  v371 = v370;
  v548 = v371;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing resource model manual constraint..." ifRequired:a5 < 14039 block:v547];
  v545[0] = MEMORY[0x1E69E9820];
  v545[1] = 3221225472;
  v545[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_55;
  v545[3] = &unk_1E7570878;
  v545[4] = self;
  v372 = v371;
  v546 = v372;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing CTM original videos with SOC available bit set..." ifRequired:v459 block:v545];
  v543[0] = MEMORY[0x1E69E9820];
  v543[1] = 3221225472;
  v543[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_56;
  v543[3] = &unk_1E7570878;
  v543[4] = self;
  v373 = v372;
  v544 = v373;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Persisting resource type on alternate image resources..." ifRequired:v460 block:v543];
  v541[0] = MEMORY[0x1E69E9820];
  v541[1] = 3221225472;
  v541[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_57;
  v541[3] = &unk_1E7570878;
  v541[4] = self;
  v374 = v373;
  v542 = v374;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Adding RAW packed badge attributes..." ifRequired:v461 block:v541];
  v538[0] = MEMORY[0x1E69E9820];
  v538[1] = 3221225472;
  v538[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_58;
  v538[3] = &unk_1E7568D08;
  v538[4] = self;
  v375 = v374;
  v539 = v375;
  v540 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Adding local video key frame resource..." ifRequired:v464 block:v538];
  v536[0] = MEMORY[0x1E69E9820];
  v536[1] = 3221225472;
  v536[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_59;
  v536[3] = &unk_1E7570878;
  v536[4] = self;
  v376 = v375;
  v537 = v376;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing CTM original videos without adjustments..." ifRequired:v466 block:v536];
  v534[0] = MEMORY[0x1E69E9820];
  v534[1] = 3221225472;
  v534[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_60;
  v534[3] = &unk_1E7570878;
  v534[4] = self;
  v377 = v376;
  v535 = v377;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Refactoring video large recipes..." ifRequired:v468 block:v534];
  v532[0] = MEMORY[0x1E69E9820];
  v532[1] = 3221225472;
  v532[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_61;
  v532[3] = &unk_1E7570878;
  v532[4] = self;
  v378 = v377;
  v533 = v378;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Removing duplicated cloud shared comments" ifRequired:v471 block:v532];
  v530[0] = MEMORY[0x1E69E9820];
  v530[1] = 3221225472;
  v530[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_62;
  v530[3] = &unk_1E7570878;
  v530[4] = self;
  v379 = v378;
  v531 = v379;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Fix wallpaper albums" ifRequired:v469 block:v530];
  v528[0] = MEMORY[0x1E69E9820];
  v528[1] = 3221225472;
  v528[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_1228;
  v528[3] = &unk_1E7570878;
  v528[4] = self;
  v380 = v379;
  v529 = v380;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Invalidating assets with hdrGain==0" ifRequired:v462 block:v528];
  v526[0] = MEMORY[0x1E69E9820];
  v526[1] = 3221225472;
  v526[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_1232;
  v526[3] = &unk_1E7570878;
  v526[4] = self;
  v381 = v380;
  v527 = v381;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting RepairAdjustmentFailure to Adjustment and clearing cloudRecoveryState" ifRequired:v463 block:v526];
  v524[0] = MEMORY[0x1E69E9820];
  v524[1] = 3221225472;
  v524[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_1236;
  v524[3] = &unk_1E7570878;
  v524[4] = self;
  v382 = v381;
  v525 = v382;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting asset location shifting and rev geo" ifRequired:v465 block:v524];
  v522[0] = MEMORY[0x1E69E9820];
  v522[1] = 3221225472;
  v522[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_1240;
  v522[3] = &unk_1E7570878;
  v522[4] = self;
  v383 = v382;
  v523 = v383;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Updating mogul subytpe on original slomos" ifRequired:v467 & 1 block:v522];
  v520[0] = MEMORY[0x1E69E9820];
  v520[1] = 3221225472;
  v520[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_1244;
  v520[3] = &unk_1E7570878;
  v520[4] = self;
  v384 = v383;
  v521 = v384;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Converting asset depth states to depth type" ifRequired:v470 & 1 block:v520];
  v519[0] = MEMORY[0x1E69E9820];
  v519[1] = 3221225472;
  v519[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_1248;
  v519[3] = &unk_1E7573368;
  v519[4] = self;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Converting implicit keepOriginalsEnabled setting to explicit" ifRequired:v472 & 1 block:v519];
  v517[0] = MEMORY[0x1E69E9820];
  v517[1] = 3221225472;
  v517[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_1252;
  v517[3] = &unk_1E7570878;
  v517[4] = self;
  v385 = v384;
  v518 = v385;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Un-quarantining previously quarantined assets" ifRequired:v473 & 1 block:v517];
  v515[0] = MEMORY[0x1E69E9820];
  v515[1] = 3221225472;
  v515[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_1256;
  v515[3] = &unk_1E7570878;
  v515[4] = self;
  v386 = v385;
  v516 = v386;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting limited-library filter data" ifRequired:v474 block:v515];
  v513[0] = MEMORY[0x1E69E9820];
  v513[1] = 3221225472;
  v513[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_9_1260;
  v513[3] = &unk_1E7570878;
  v513[4] = self;
  v387 = v386;
  v514 = v387;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Delete empty folder with the project root cloudGUID that has the wrong folder kind" ifRequired:v476 block:v513];
  v510[0] = MEMORY[0x1E69E9820];
  v510[1] = 3221225472;
  v510[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_1264;
  v510[3] = &unk_1E7568D08;
  v510[4] = self;
  v388 = v387;
  v511 = v388;
  v512 = v502;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Delete key frame video resources for non-video assets" ifRequired:v478 block:v510];
  v508[0] = MEMORY[0x1E69E9820];
  v508[1] = 3221225472;
  v508[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_1268;
  v508[3] = &unk_1E7570878;
  v508[4] = self;
  v389 = v388;
  v509 = v389;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Discard unused custom rendered values" ifRequired:a5 < 15059 block:v508];
  v506[0] = MEMORY[0x1E69E9820];
  v506[1] = 3221225472;
  v506[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12_1272;
  v506[3] = &unk_1E7570878;
  v506[4] = self;
  v390 = v389;
  v507 = v390;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Resetting image request hints" ifRequired:v502 block:v506];
  v504[0] = MEMORY[0x1E69E9820];
  v504[1] = 3221225472;
  v504[2] = __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_13_1276;
  v504[3] = &unk_1E7570878;
  v504[4] = self;
  v391 = v390;
  v505 = v391;
  [(PLModelMigrationActionProcessor *)v191 performActionWithName:@"Repairing duplicate singleton fetching albums" ifRequired:1 block:v504];
  v392 = [MEMORY[0x1E696AC08] defaultManager];
  v393 = [(PLModelMigrator *)self pathManager];
  v394 = [v393 privateCacheDirectoryWithSubType:10];
  [v392 removeItemAtPath:v394 error:0];

  [(PLModelMigrator *)self applyDataProtectionToAllPhotosFilesOnce];
  if ([(PLModelMigrationActionProcessor *)v191 isSuccess])
  {
    v395 = PLMigrationGetLog();
    v396 = os_log_type_enabled(v395, OS_LOG_TYPE_DEFAULT);

    if (!v396)
    {
      goto LABEL_587;
    }

    v397 = [(PLModelMigrator *)self migrationLogger];

    if (v397)
    {
      v970 = 0u;
      v971 = 0u;
      v968 = 0u;
      v969 = 0u;
      v966 = 0u;
      v967 = 0u;
      v964 = 0u;
      v965 = 0u;
      v962 = 0u;
      v963 = 0u;
      v960 = 0u;
      v961 = 0u;
      v958 = 0u;
      v959 = 0u;
      v956 = 0u;
      v957 = 0u;
      v954 = 0u;
      v955 = 0u;
      v952 = 0u;
      v953 = 0u;
      v950 = 0u;
      v951 = 0u;
      v948 = 0u;
      v949 = 0u;
      v946 = 0u;
      v947 = 0u;
      v944 = 0u;
      v945 = 0u;
      v942 = 0u;
      v943 = 0u;
      memset(v941, 0, sizeof(v941));
      v398 = PLMigrationGetLog();
      os_log_type_enabled(v398, OS_LOG_TYPE_DEFAULT);
      v937 = 67109376;
      v938 = a5;
      v939 = 1024;
      v940 = v420;
      LODWORD(v419) = 14;
      v399 = _os_log_send_and_compose_impl();

      v400 = [(PLModelMigrator *)self migrationLogger:&v937];
      v401 = v400;
      v402 = v399;
      v403 = 4637;
      v404 = 0;
      goto LABEL_579;
    }

    v409 = PLMigrationGetLog();
    if (os_log_type_enabled(v409, OS_LOG_TYPE_DEFAULT))
    {
      v941[0] = 67109376;
      v941[1] = a5;
      LOWORD(v941[2]) = 1024;
      *(&v941[2] + 2) = v420;
      v410 = "Successfully finished post-processing lightweight migration of photo database from version %d to %d.";
      v411 = v409;
      v412 = OS_LOG_TYPE_DEFAULT;
LABEL_585:
      _os_log_impl(&dword_19BF1F000, v411, v412, v410, v941, 0xEu);
      goto LABEL_586;
    }

    goto LABEL_586;
  }

  [(PLModelMigrationActionProcessor *)v191 setSuccess:0];
  v405 = PLMigrationGetLog();
  v406 = os_log_type_enabled(v405, OS_LOG_TYPE_ERROR);

  if (!v406)
  {
    goto LABEL_587;
  }

  v407 = [(PLModelMigrator *)self migrationLogger];

  if (!v407)
  {
    v409 = PLMigrationGetLog();
    if (os_log_type_enabled(v409, OS_LOG_TYPE_ERROR))
    {
      v941[0] = 67109376;
      v941[1] = a5;
      LOWORD(v941[2]) = 1024;
      *(&v941[2] + 2) = v420;
      v410 = "Failed to post-process lightweight migration of photo database from version %d to %d.  Requires full database rebuild.";
      v411 = v409;
      v412 = OS_LOG_TYPE_ERROR;
      goto LABEL_585;
    }

LABEL_586:

    goto LABEL_587;
  }

  v970 = 0u;
  v971 = 0u;
  v968 = 0u;
  v969 = 0u;
  v966 = 0u;
  v967 = 0u;
  v964 = 0u;
  v965 = 0u;
  v962 = 0u;
  v963 = 0u;
  v960 = 0u;
  v961 = 0u;
  v958 = 0u;
  v959 = 0u;
  v956 = 0u;
  v957 = 0u;
  v954 = 0u;
  v955 = 0u;
  v952 = 0u;
  v953 = 0u;
  v950 = 0u;
  v951 = 0u;
  v948 = 0u;
  v949 = 0u;
  v946 = 0u;
  v947 = 0u;
  v944 = 0u;
  v945 = 0u;
  v942 = 0u;
  v943 = 0u;
  memset(v941, 0, sizeof(v941));
  v408 = PLMigrationGetLog();
  os_log_type_enabled(v408, OS_LOG_TYPE_ERROR);
  v937 = 67109376;
  v938 = a5;
  v939 = 1024;
  v940 = v420;
  LODWORD(v419) = 14;
  v399 = _os_log_send_and_compose_impl();

  v400 = [(PLModelMigrator *)self migrationLogger:&v937];
  v401 = v400;
  v402 = v399;
  v403 = 4640;
  v404 = 16;
LABEL_579:
  [v400 logWithMessage:v402 fromCodeLocation:"PLModelMigrator.m" type:{v403, v404}];

  if (v399 != v941)
  {
    free(v399);
  }

LABEL_587:

  objc_autoreleasePoolPop(context);
  --postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount__postProcessMigratedStoreGuard;
  [(PLModelMigrator *)self _setIsPostProcessingLightWeightMigration:0];
  v413 = [(PLModelMigrationActionProcessor *)v191 isSuccess];

  return v413;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke(uint64_t a1)
{
  v59 = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) deviceRestoreMigrationSupport];
  if (![v2 isRestoreFromBackup])
  {
    goto LABEL_3;
  }

  v3 = [*(a1 + 32) postProcessingToken];
  v4 = [v3 isModelMigrationRestorePostProcessingComplete];

  if (v4)
  {
    goto LABEL_3;
  }

  v7 = [v2 isRestoreFromBackupSourceDeviceToDevice];
  v8 = PLMigrationGetLog();
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_INFO);

  if (v9)
  {
    v10 = [*(a1 + 32) migrationLogger];

    if (v10)
    {
      v57 = 0u;
      v58 = 0u;
      v55 = 0u;
      v56 = 0u;
      v53 = 0u;
      v54 = 0u;
      v51 = 0u;
      v52 = 0u;
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v45 = 0u;
      v46 = 0u;
      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v39 = 0u;
      v40 = 0u;
      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v33 = 0u;
      v34 = 0u;
      v31 = 0u;
      v32 = 0u;
      v29 = 0u;
      v30 = 0u;
      *buf = 0u;
      v28 = 0u;
      v11 = PLMigrationGetLog();
      os_log_type_enabled(v11, OS_LOG_TYPE_INFO);
      v12 = @"cloud shared and iTunes synced";
      if (v7)
      {
        v12 = @"cloud shared";
      }

      v25 = 138543362;
      v26 = v12;
      LODWORD(v24) = 12;
      v13 = _os_log_send_and_compose_impl();

      v14 = [*(a1 + 32) migrationLogger];
      [v14 logWithMessage:v13 fromCodeLocation:"PLModelMigrator.m" type:{3515, 1}];

      if (v13 != buf)
      {
        free(v13);
      }
    }

    else
    {
      v15 = PLMigrationGetLog();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = @"cloud shared and iTunes synced";
        if (v7)
        {
          v16 = @"cloud shared";
        }

        *buf = 138543362;
        *&buf[4] = v16;
        _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_INFO, "Removing orphaned %{public}@ asset references", buf, 0xCu);
      }
    }
  }

  if (![*(a1 + 32) _deleteCloudSharedAndSynced:v7 ^ 1u assetReferencesInStore:*(a1 + 40)])
  {
    v5 = 0;
    goto LABEL_4;
  }

  if (*(a1 + 48) == 1)
  {
    v17 = PLMigrationGetLog();
    v18 = os_log_type_enabled(v17, OS_LOG_TYPE_INFO);

    if (v18)
    {
      v19 = [*(a1 + 32) migrationLogger];

      if (v19)
      {
        v57 = 0u;
        v58 = 0u;
        v55 = 0u;
        v56 = 0u;
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v52 = 0u;
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        *buf = 0u;
        v28 = 0u;
        v20 = PLMigrationGetLog();
        os_log_type_enabled(v20, OS_LOG_TYPE_INFO);
        LOWORD(v25) = 0;
        LODWORD(v24) = 2;
        v21 = _os_log_send_and_compose_impl();

        v22 = [*(a1 + 32) migrationLogger];
        [v22 logWithMessage:v21 fromCodeLocation:"PLModelMigrator.m" type:{3518, 1}];

        if (v21 != buf)
        {
          free(v21);
        }
      }

      else
      {
        v23 = PLMigrationGetLog();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_INFO, "Removing orphaned my photo stream references", buf, 2u);
        }
      }
    }

    v5 = [*(a1 + 32) _deletePhotoStreamAssetReferencesInStore:*(a1 + 40)];
  }

  else
  {
LABEL_3:
    v5 = 1;
  }

LABEL_4:

  return v5;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3(uint64_t a1)
{
  v49 = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) managedObjectContextForMigrationInStore:*(a1 + 40) name:"-[PLModelMigrator postProcessMigratedStore:migrationUUID:fromVersion:progress:progressUnitCount:]_block_invoke_3" concurrencyType:*MEMORY[0x1E695D708]];
  v3 = [MEMORY[0x1E696AE18] predicateWithFormat:@"TRUEPREDICATE"];
  v4 = [(PLShare *)PLLibraryScope sharesWithPredicate:v3 fetchLimit:1 inManagedObjectContext:v2];
  v5 = [v4 count];

  if (*(a1 + 48) != 1 || v5)
  {
    v12 = [*(a1 + 32) rebuildAllMomentsInStore:*(a1 + 40) deleteExistingMoments:1];
  }

  else
  {
    v6 = PLMigrationGetLog();
    v7 = os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);

    if (v7)
    {
      v8 = [*(a1 + 32) migrationLogger];

      if (v8)
      {
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        v27 = 0u;
        v28 = 0u;
        v25 = 0u;
        v26 = 0u;
        v23 = 0u;
        v24 = 0u;
        v21 = 0u;
        v22 = 0u;
        v19 = 0u;
        v20 = 0u;
        *buf = 0u;
        v18 = 0u;
        v9 = PLMigrationGetLog();
        os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT);
        v16[0] = 0;
        LODWORD(v15) = 2;
        v10 = _os_log_send_and_compose_impl();

        v11 = [*(a1 + 32) migrationLogger];
        [v11 logWithMessage:v10 fromCodeLocation:"PLModelMigrator.m" type:{3544, 0}];

        if (v10 != buf)
        {
          free(v10);
        }
      }

      else
      {
        v13 = PLMigrationGetLog();
        if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Skipping moment rebuild because it's only needed if shared content exists and none was found.", buf, 2u);
        }
      }
    }

    v12 = 1;
  }

  return v12;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6(uint64_t a1)
{
  v50 = *MEMORY[0x1E69E9840];
  v2 = *(a1 + 48);
  v3 = PLMigrationGetLog();
  v4 = os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT);

  if (v2 == 1)
  {
    if (v4)
    {
      v5 = [*(a1 + 32) migrationLogger];

      if (v5)
      {
        v48 = 0u;
        v49 = 0u;
        v46 = 0u;
        v47 = 0u;
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        *buf = 0u;
        v19 = 0u;
        v6 = PLMigrationGetLog();
        os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);
        v17[0] = 0;
        LODWORD(v16) = 2;
        v7 = _os_log_send_and_compose_impl();

        v8 = [*(a1 + 32) migrationLogger];
        [v8 logWithMessage:v7 fromCodeLocation:"PLModelMigrator.m" type:{3576, 0}];

        if (v7 != buf)
        {
          free(v7);
        }
      }

      else
      {
        v13 = PLMigrationGetLog();
        if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_DEFAULT, "Migrating SLM files will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    if (v4)
    {
      v9 = [*(a1 + 32) migrationLogger];

      if (v9)
      {
        v48 = 0u;
        v49 = 0u;
        v46 = 0u;
        v47 = 0u;
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        *buf = 0u;
        v19 = 0u;
        v10 = PLMigrationGetLog();
        os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT);
        v17[0] = 0;
        LODWORD(v16) = 2;
        v11 = _os_log_send_and_compose_impl();

        v12 = [*(a1 + 32) migrationLogger];
        [v12 logWithMessage:v11 fromCodeLocation:"PLModelMigrator.m" type:{3578, 0}];

        if (v11 != buf)
        {
          free(v11);
        }
      }

      else
      {
        v15 = PLMigrationGetLog();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Migrating SLM files to new adjustments format", buf, 2u);
        }
      }
    }

    return [*(a1 + 32) _migrateLegacySlomoAdjustmentsInStore:*(a1 + 40) fromLegacySLMFormat:1];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_499(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3587, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing asset persisence will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _persistPlaceAnnotationData:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_504(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3597, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing asset persisence will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _fixupAssetPersistence:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_509(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3607, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Generating addedDate will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _generateAddedDateForAssetsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_518(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3621, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing video dimensions will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _fixVideoDimensionsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_523(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3631, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing orientations will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _fixCorruptedOrientationsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_5_544(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3660, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing HEIF assets with incorrect metadata will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _fixIncorrectHeifMetadataInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_549(uint64_t a1)
{
  v2 = [*(a1 + 32) managedObjectContextForMigrationInStore:*(a1 + 40) name:"-[PLModelMigrator postProcessMigratedStore:migrationUUID:fromVersion:progress:progressUnitCount:]_block_invoke" concurrencyType:*MEMORY[0x1E695D708]];
  v3 = [*(a1 + 32) _migrationThumbnailManagerWithStore:*(a1 + 40)];
  v4 = [v3 resetThumbnailsWithResetType:*(a1 + 48) deferHintChanges:*(a1 + 56) inContext:v2];

  return v4;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_569(uint64_t a1)
{
  v65 = *MEMORY[0x1E69E9840];
  v2 = PLMigrationGetLog();
  v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

  if (v3)
  {
    v4 = [*(a1 + 32) migrationLogger];

    if (v4)
    {
      v63 = 0u;
      v64 = 0u;
      v61 = 0u;
      v62 = 0u;
      v59 = 0u;
      v60 = 0u;
      v57 = 0u;
      v58 = 0u;
      v55 = 0u;
      v56 = 0u;
      v53 = 0u;
      v54 = 0u;
      v51 = 0u;
      v52 = 0u;
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v45 = 0u;
      v46 = 0u;
      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v39 = 0u;
      v40 = 0u;
      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      *buf = 0u;
      v34 = 0u;
      v5 = PLMigrationGetLog();
      os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
      v32[0] = 0;
      LODWORD(v31) = 2;
      v6 = _os_log_send_and_compose_impl();

      v7 = [*(a1 + 32) migrationLogger];
      [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3690, 0}];

      if (v6 != buf)
      {
        free(v6);
      }
    }

    else
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Moving adjusted resources for adjusted assets", buf, 2u);
      }
    }
  }

  result = [*(a1 + 32) _fixAdjustedAssets:*(a1 + 40)];
  if (result)
  {
    v10 = PLMigrationGetLog();
    v11 = os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT);

    if (v11)
    {
      v12 = [*(a1 + 32) migrationLogger];

      if (v12)
      {
        v63 = 0u;
        v64 = 0u;
        v61 = 0u;
        v62 = 0u;
        v59 = 0u;
        v60 = 0u;
        v57 = 0u;
        v58 = 0u;
        v55 = 0u;
        v56 = 0u;
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v52 = 0u;
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        *buf = 0u;
        v34 = 0u;
        v13 = PLMigrationGetLog();
        os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
        v32[0] = 0;
        LODWORD(v31) = 2;
        v14 = _os_log_send_and_compose_impl();

        v15 = [*(a1 + 32) migrationLogger];
        [v15 logWithMessage:v14 fromCodeLocation:"PLModelMigrator.m" type:{3693, 0}];

        if (v14 != buf)
        {
          free(v14);
        }
      }

      else
      {
        v16 = PLMigrationGetLog();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Duplicating original files for duplicated assets", buf, 2u);
        }
      }
    }

    result = [*(a1 + 32) _fixDuplicatedAssets:*(a1 + 40)];
    if (result)
    {
      v17 = PLMigrationGetLog();
      v18 = os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT);

      if (v18)
      {
        v19 = [*(a1 + 32) migrationLogger];

        if (v19)
        {
          v63 = 0u;
          v64 = 0u;
          v61 = 0u;
          v62 = 0u;
          v59 = 0u;
          v60 = 0u;
          v57 = 0u;
          v58 = 0u;
          v55 = 0u;
          v56 = 0u;
          v53 = 0u;
          v54 = 0u;
          v51 = 0u;
          v52 = 0u;
          v49 = 0u;
          v50 = 0u;
          v47 = 0u;
          v48 = 0u;
          v45 = 0u;
          v46 = 0u;
          v43 = 0u;
          v44 = 0u;
          v41 = 0u;
          v42 = 0u;
          v39 = 0u;
          v40 = 0u;
          v37 = 0u;
          v38 = 0u;
          v35 = 0u;
          v36 = 0u;
          *buf = 0u;
          v34 = 0u;
          v20 = PLMigrationGetLog();
          os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT);
          v32[0] = 0;
          LODWORD(v31) = 2;
          v21 = _os_log_send_and_compose_impl();

          v22 = [*(a1 + 32) migrationLogger];
          [v22 logWithMessage:v21 fromCodeLocation:"PLModelMigrator.m" type:{3697, 0}];

          if (v21 != buf)
          {
            free(v21);
          }
        }

        else
        {
          v23 = PLMigrationGetLog();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Assign assetUuid for non adjusted assets", buf, 2u);
          }
        }
      }

      result = [*(a1 + 32) _fixNonDuplicatedAssets:*(a1 + 40) adjusted:0];
      if (result)
      {
        v24 = PLMigrationGetLog();
        v25 = os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT);

        if (v25)
        {
          v26 = [*(a1 + 32) migrationLogger];

          if (v26)
          {
            v63 = 0u;
            v64 = 0u;
            v61 = 0u;
            v62 = 0u;
            v59 = 0u;
            v60 = 0u;
            v57 = 0u;
            v58 = 0u;
            v55 = 0u;
            v56 = 0u;
            v53 = 0u;
            v54 = 0u;
            v51 = 0u;
            v52 = 0u;
            v49 = 0u;
            v50 = 0u;
            v47 = 0u;
            v48 = 0u;
            v45 = 0u;
            v46 = 0u;
            v43 = 0u;
            v44 = 0u;
            v41 = 0u;
            v42 = 0u;
            v39 = 0u;
            v40 = 0u;
            v37 = 0u;
            v38 = 0u;
            v35 = 0u;
            v36 = 0u;
            *buf = 0u;
            v34 = 0u;
            v27 = PLMigrationGetLog();
            os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT);
            v32[0] = 0;
            LODWORD(v31) = 2;
            v28 = _os_log_send_and_compose_impl();

            v29 = [*(a1 + 32) migrationLogger];
            [v29 logWithMessage:v28 fromCodeLocation:"PLModelMigrator.m" type:{3701, 0}];

            if (v28 != buf)
            {
              free(v28);
            }
          }

          else
          {
            v30 = PLMigrationGetLog();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 0;
              _os_log_impl(&dword_19BF1F000, v30, OS_LOG_TYPE_DEFAULT, "Assign assetUuid for non-duplicated adjusted assets", buf, 2u);
            }
          }
        }

        return [*(a1 + 32) _fixNonDuplicatedAssets:*(a1 + 40) adjusted:1];
      }
    }
  }

  return result;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_581(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3714, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Populate face regions will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _populateFaceRegionsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7(uint64_t a1)
{
  v51 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        v27 = 0u;
        v28 = 0u;
        v25 = 0u;
        v26 = 0u;
        v23 = 0u;
        v24 = 0u;
        v21 = 0u;
        v22 = 0u;
        *buf = 0u;
        v20 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v18[0] = 0;
        LODWORD(v17) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3751, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v8 = PLMigrationGetLog();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Caching date created on resources.", buf, 2u);
        }
      }
    }
  }

  if (*(a1 + 49) == 1)
  {
    v9 = PLMigrationGetLog();
    v10 = os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT);

    if (v10)
    {
      v11 = [*(a1 + 32) migrationLogger];

      if (v11)
      {
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        v27 = 0u;
        v28 = 0u;
        v25 = 0u;
        v26 = 0u;
        v23 = 0u;
        v24 = 0u;
        v21 = 0u;
        v22 = 0u;
        *buf = 0u;
        v20 = 0u;
        v12 = PLMigrationGetLog();
        os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT);
        v18[0] = 0;
        LODWORD(v17) = 2;
        v13 = _os_log_send_and_compose_impl();

        v14 = [*(a1 + 32) migrationLogger];
        [v14 logWithMessage:v13 fromCodeLocation:"PLModelMigrator.m" type:{3754, 0}];

        if (v13 != buf)
        {
          free(v13);
        }
      }

      else
      {
        v15 = PLMigrationGetLog();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Caching itemIdentifier on resources.", buf, 2u);
        }
      }
    }
  }

  return [*(a1 + 32) _performMigrationCacheDateCreatedOnResources:*(a1 + 48) cacheItemIdentifierOnResources:*(a1 + 49) store:*(a1 + 40)];
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_623(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3770, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Fixing incorrectly addedDate will be handled during background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _fixIncorrectAddedDateForAssetsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11(uint64_t a1)
{
  v7[1] = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) pathManager];
  v3 = [v2 photoDirectoryWithType:4];

  v4 = *(a1 + 32);
  v7[0] = v3;
  v5 = [MEMORY[0x1E695DEC8] arrayWithObjects:v7 count:1];
  [v4 applyDataProtectionToPhotosPaths:v5 fromKeyClass:2 toKeyClass:3];

  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_25(uint64_t a1)
{
  v51 = *MEMORY[0x1E69E9840];
  v2 = PLMigrationGetLog();
  v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

  if (v3)
  {
    v4 = [*(a1 + 32) migrationLogger];

    if (v4)
    {
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v45 = 0u;
      v46 = 0u;
      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v39 = 0u;
      v40 = 0u;
      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v33 = 0u;
      v34 = 0u;
      v31 = 0u;
      v32 = 0u;
      v29 = 0u;
      v30 = 0u;
      v27 = 0u;
      v28 = 0u;
      v25 = 0u;
      v26 = 0u;
      v23 = 0u;
      v24 = 0u;
      v21 = 0u;
      v22 = 0u;
      *buf = 0u;
      v20 = 0u;
      v5 = PLMigrationGetLog();
      os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
      v18[0] = 0;
      LODWORD(v17) = 2;
      v6 = _os_log_send_and_compose_impl();

      v7 = [*(a1 + 32) migrationLogger];
      [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3885, 0}];

      if (v6 != buf)
      {
        free(v6);
      }
    }

    else
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Populating asset's filename with nil originalFilename", buf, 2u);
      }
    }
  }

  result = [*(a1 + 32) _populateNilOriginalFilename:*(a1 + 40)];
  if (result)
  {
    v10 = PLMigrationGetLog();
    v11 = os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT);

    if (v11)
    {
      v12 = [*(a1 + 32) migrationLogger];

      if (v12)
      {
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        v27 = 0u;
        v28 = 0u;
        v25 = 0u;
        v26 = 0u;
        v23 = 0u;
        v24 = 0u;
        v21 = 0u;
        v22 = 0u;
        *buf = 0u;
        v20 = 0u;
        v13 = PLMigrationGetLog();
        os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
        v18[0] = 0;
        LODWORD(v17) = 2;
        v14 = _os_log_send_and_compose_impl();

        v15 = [*(a1 + 32) migrationLogger];
        [v15 logWithMessage:v14 fromCodeLocation:"PLModelMigrator.m" type:{3888, 0}];

        if (v14 != buf)
        {
          free(v14);
        }
      }

      else
      {
        v16 = PLMigrationGetLog();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Populating master's original filename with nil originalFilename", buf, 2u);
        }
      }
    }

    return [*(a1 + 32) _populateNilOriginalFilenameOnMaster:*(a1 + 40)];
  }

  return result;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_4_724(uint64_t a1)
{
  v7[1] = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) pathManager];
  v3 = [v2 photoDirectoryWithType:4];

  v4 = *(a1 + 32);
  v7[0] = v3;
  v5 = [MEMORY[0x1E695DEC8] arrayWithObjects:v7 count:1];
  [v4 applyDataProtectionToPhotosPaths:v5 fromKeyClass:4 toKeyClass:3];

  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_15_768(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3963, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Persist iris visibility will be handled in background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _persistPhotoIrisVisibilityStateToDiskInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_777(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{3977, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Setting correct playback style will be handled in background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _setPlaybackStyleForAnimatedGIFsInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_2_786(uint64_t a1)
{
  v1 = [*(a1 + 32) pathManager];
  v2 = [v1 libraryURL];
  v3 = [PLLibraryServicesManager libraryServicesManagerForLibraryURL:v2];

  v4 = [v3 searchIndexingEngine];
  [v4 dropSearchIndexWithSourceName:@"Dropping search index after lightweight migration" completion:0];

  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_21_859(uint64_t a1)
{
  v82 = *MEMORY[0x1E69E9840];
  v2 = 1;
  v49 = 1;
  if (*(a1 + 48) < 11000)
  {
    v3 = 0;
  }

  else
  {
    v3 = [*(a1 + 32) _storeContainsFaceCrops:*(a1 + 40) success:&v49];
    v2 = v49;
    if ((v49 & 1) == 0)
    {
      goto LABEL_14;
    }
  }

  if ((v3 & 1) == 0)
  {
    v4 = PLMigrationGetLog();
    v5 = os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT);

    if (v5)
    {
      v6 = [*(a1 + 32) migrationLogger];

      if (v6)
      {
        v80 = 0u;
        v81 = 0u;
        v78 = 0u;
        v79 = 0u;
        v76 = 0u;
        v77 = 0u;
        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v60 = 0u;
        v61 = 0u;
        v58 = 0u;
        v59 = 0u;
        v56 = 0u;
        v57 = 0u;
        v54 = 0u;
        v55 = 0u;
        v52 = 0u;
        v53 = 0u;
        *buf = 0u;
        v51 = 0u;
        v7 = PLMigrationGetLog();
        os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT);
        v48[0] = 0;
        LODWORD(v47) = 2;
        v8 = _os_log_send_and_compose_impl();

        v9 = [*(a1 + 32) migrationLogger];
        [v9 logWithMessage:v8 fromCodeLocation:"PLModelMigrator.m" type:{4082, 0}];

        if (v8 != buf)
        {
          free(v8);
        }
      }

      else
      {
        v10 = PLMigrationGetLog();
        if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Ensuring every user-verified person with faces has a user-confirmed face", buf, 2u);
        }
      }
    }

    v2 = [*(a1 + 32) _ensureAllUserVerifiedPersonsHaveFaceCropsInStore:*(a1 + 40)];
    v49 = v2;
  }

LABEL_14:
  if (!(v3 & 1 | ((v2 & 1) == 0)))
  {
    v11 = PLMigrationGetLog();
    v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);

    if (v12)
    {
      v13 = [*(a1 + 32) migrationLogger];

      if (v13)
      {
        v80 = 0u;
        v81 = 0u;
        v78 = 0u;
        v79 = 0u;
        v76 = 0u;
        v77 = 0u;
        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v60 = 0u;
        v61 = 0u;
        v58 = 0u;
        v59 = 0u;
        v56 = 0u;
        v57 = 0u;
        v54 = 0u;
        v55 = 0u;
        v52 = 0u;
        v53 = 0u;
        *buf = 0u;
        v51 = 0u;
        v14 = PLMigrationGetLog();
        os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT);
        v48[0] = 0;
        LODWORD(v47) = 2;
        v15 = _os_log_send_and_compose_impl();

        v16 = [*(a1 + 32) migrationLogger];
        [v16 logWithMessage:v15 fromCodeLocation:"PLModelMigrator.m" type:{4086, 0}];

        if (v15 != buf)
        {
          free(v15);
        }
      }

      else
      {
        v17 = PLMigrationGetLog();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Resetting rejected faces on all persons", buf, 2u);
        }
      }
    }

    v2 = [*(a1 + 32) resetRejectedFacesOnAllPersonsInStore:*(a1 + 40)];
    v49 = v2;
  }

  if (!(v3 & 1 | ((v2 & 1) == 0)))
  {
    v18 = PLMigrationGetLog();
    v19 = os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT);

    if (v19)
    {
      v20 = [*(a1 + 32) migrationLogger];

      if (v20)
      {
        v80 = 0u;
        v81 = 0u;
        v78 = 0u;
        v79 = 0u;
        v76 = 0u;
        v77 = 0u;
        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v60 = 0u;
        v61 = 0u;
        v58 = 0u;
        v59 = 0u;
        v56 = 0u;
        v57 = 0u;
        v54 = 0u;
        v55 = 0u;
        v52 = 0u;
        v53 = 0u;
        *buf = 0u;
        v51 = 0u;
        v21 = PLMigrationGetLog();
        os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT);
        v48[0] = 0;
        LODWORD(v47) = 2;
        v22 = _os_log_send_and_compose_impl();

        v23 = [*(a1 + 32) migrationLogger];
        [v23 logWithMessage:v22 fromCodeLocation:"PLModelMigrator.m" type:{4090, 0}];

        if (v22 != buf)
        {
          free(v22);
        }
      }

      else
      {
        v24 = PLMigrationGetLog();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v24, OS_LOG_TYPE_DEFAULT, "Resetting face analysis state worker flags", buf, 2u);
        }
      }
    }

    v2 = [*(a1 + 32) markAllDirtyFaceAnalysisStatesWithFaceDetectionWorkerFlagsInStore:*(a1 + 40)];
    v49 = v2;
  }

  if (v3 & 1 | ((v2 & 1) == 0))
  {
    if ((v2 & 1) == 0)
    {
      return 0;
    }
  }

  else
  {
    v26 = PLMigrationGetLog();
    v27 = os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT);

    if (v27)
    {
      v28 = [*(a1 + 32) migrationLogger];

      if (v28)
      {
        v80 = 0u;
        v81 = 0u;
        v78 = 0u;
        v79 = 0u;
        v76 = 0u;
        v77 = 0u;
        v74 = 0u;
        v75 = 0u;
        v72 = 0u;
        v73 = 0u;
        v70 = 0u;
        v71 = 0u;
        v68 = 0u;
        v69 = 0u;
        v66 = 0u;
        v67 = 0u;
        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v60 = 0u;
        v61 = 0u;
        v58 = 0u;
        v59 = 0u;
        v56 = 0u;
        v57 = 0u;
        v54 = 0u;
        v55 = 0u;
        v52 = 0u;
        v53 = 0u;
        *buf = 0u;
        v51 = 0u;
        v29 = PLMigrationGetLog();
        os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT);
        v48[0] = 0;
        LODWORD(v47) = 2;
        v30 = _os_log_send_and_compose_impl();

        v31 = [*(a1 + 32) migrationLogger];
        [v31 logWithMessage:v30 fromCodeLocation:"PLModelMigrator.m" type:{4094, 0}];

        if (v30 != buf)
        {
          free(v30);
        }
      }

      else
      {
        v32 = PLMigrationGetLog();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_DEFAULT, "Marking face analysis state dirty for user confirmed faces", buf, 2u);
        }
      }
    }

    v49 = [*(a1 + 32) markUserConfirmedFacesAndCorrespondingFaceAnalysisStatesDirtyInStore:*(a1 + 40)];
    if ((v49 & 1) == 0)
    {
      return 0;
    }
  }

  if (*(a1 + 52) != 1)
  {
    return 1;
  }

  v33 = PLMigrationGetLog();
  v34 = os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT);

  if (v34)
  {
    v35 = [*(a1 + 32) migrationLogger];

    if (v35)
    {
      v80 = 0u;
      v81 = 0u;
      v78 = 0u;
      v79 = 0u;
      v76 = 0u;
      v77 = 0u;
      v74 = 0u;
      v75 = 0u;
      v72 = 0u;
      v73 = 0u;
      v70 = 0u;
      v71 = 0u;
      v68 = 0u;
      v69 = 0u;
      v66 = 0u;
      v67 = 0u;
      v64 = 0u;
      v65 = 0u;
      v62 = 0u;
      v63 = 0u;
      v60 = 0u;
      v61 = 0u;
      v58 = 0u;
      v59 = 0u;
      v56 = 0u;
      v57 = 0u;
      v54 = 0u;
      v55 = 0u;
      v52 = 0u;
      v53 = 0u;
      *buf = 0u;
      v51 = 0u;
      v36 = PLMigrationGetLog();
      os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT);
      v48[0] = 0;
      LODWORD(v47) = 2;
      v37 = _os_log_send_and_compose_impl();

      v38 = [*(a1 + 32) migrationLogger];
      [v38 logWithMessage:v37 fromCodeLocation:"PLModelMigrator.m" type:{4100, 0}];

      if (v37 != buf)
      {
        free(v37);
      }
    }

    else
    {
      v39 = PLMigrationGetLog();
      if (os_log_type_enabled(v39, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v39, OS_LOG_TYPE_DEFAULT, "Repush assets with user modified faces", buf, 2u);
      }
    }
  }

  result = [*(a1 + 32) _repushAssetsWithAnyUserConfirmedFaceInStore:*(a1 + 40)];
  v49 = result;
  if (result)
  {
    if (*(a1 + 52))
    {
      v40 = PLMigrationGetLog();
      v41 = os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT);

      if (v41)
      {
        v42 = [*(a1 + 32) migrationLogger];

        if (v42)
        {
          v80 = 0u;
          v81 = 0u;
          v78 = 0u;
          v79 = 0u;
          v76 = 0u;
          v77 = 0u;
          v74 = 0u;
          v75 = 0u;
          v72 = 0u;
          v73 = 0u;
          v70 = 0u;
          v71 = 0u;
          v68 = 0u;
          v69 = 0u;
          v66 = 0u;
          v67 = 0u;
          v64 = 0u;
          v65 = 0u;
          v62 = 0u;
          v63 = 0u;
          v60 = 0u;
          v61 = 0u;
          v58 = 0u;
          v59 = 0u;
          v56 = 0u;
          v57 = 0u;
          v54 = 0u;
          v55 = 0u;
          v52 = 0u;
          v53 = 0u;
          *buf = 0u;
          v51 = 0u;
          v43 = PLMigrationGetLog();
          os_log_type_enabled(v43, OS_LOG_TYPE_DEFAULT);
          v48[0] = 0;
          LODWORD(v47) = 2;
          v44 = _os_log_send_and_compose_impl();

          v45 = [*(a1 + 32) migrationLogger];
          [v45 logWithMessage:v44 fromCodeLocation:"PLModelMigrator.m" type:{4104, 0}];

          if (v44 != buf)
          {
            free(v44);
          }
        }

        else
        {
          v46 = PLMigrationGetLog();
          if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_DEFAULT, "Flagging persons that may have synced ", buf, 2u);
          }
        }
      }

      return [*(a1 + 32) _markMigrationVerifiedTypePersonsInStore:*(a1 + 40)];
    }

    return 1;
  }

  return result;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_3_877(uint64_t a1)
{
  v47 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        v33 = 0u;
        v34 = 0u;
        v31 = 0u;
        v32 = 0u;
        v29 = 0u;
        v30 = 0u;
        v27 = 0u;
        v28 = 0u;
        v25 = 0u;
        v26 = 0u;
        v23 = 0u;
        v24 = 0u;
        v21 = 0u;
        v22 = 0u;
        v19 = 0u;
        v20 = 0u;
        v17 = 0u;
        v18 = 0u;
        *buf = 0u;
        v16 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v14[0] = 0;
        LODWORD(v13) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{4122, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v12 = PLMigrationGetLog();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_DEFAULT, "identifyVariationsAndDepthAdjustments will be handled in background OTA restore phase", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = [*(a1 + 32) isCloudPhotoLibraryEnabled];
    v9 = *(a1 + 32);
    v10 = *(a1 + 40);

    return [v9 _identifyVariationsAndDepthAdjustmentsIncludingBakedInLongExposure:v8 inStore:v10];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_7_906(uint64_t a1)
{
  v1 = [*(a1 + 32) pathManager];
  v2 = [PLCPLSettings settingsWithPathManager:v1];

  [v2 setRunOnceFlag:2 error:0];
  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_11_923(uint64_t a1)
{
  v65 = *MEMORY[0x1E69E9840];
  v2 = PLMigrationGetLog();
  v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

  if (v3)
  {
    v4 = [*(a1 + 32) migrationLogger];

    if (v4)
    {
      v63 = 0u;
      v64 = 0u;
      v61 = 0u;
      v62 = 0u;
      v59 = 0u;
      v60 = 0u;
      v57 = 0u;
      v58 = 0u;
      v55 = 0u;
      v56 = 0u;
      v53 = 0u;
      v54 = 0u;
      v51 = 0u;
      v52 = 0u;
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v45 = 0u;
      v46 = 0u;
      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v39 = 0u;
      v40 = 0u;
      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      *buf = 0u;
      v34 = 0u;
      v5 = PLMigrationGetLog();
      os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
      v32[0] = 0;
      LODWORD(v31) = 2;
      v6 = _os_log_send_and_compose_impl();

      v7 = [*(a1 + 32) migrationLogger];
      [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{4173, 0}];

      if (v6 != buf)
      {
        free(v6);
      }
    }

    else
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Puring cloud shared resources", buf, 2u);
      }
    }
  }

  result = [*(a1 + 32) _purgeCloudSharedResourcesInStore:*(a1 + 40)];
  if (result)
  {
    v10 = PLMigrationGetLog();
    v11 = os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT);

    if (v11)
    {
      v12 = [*(a1 + 32) migrationLogger];

      if (v12)
      {
        v63 = 0u;
        v64 = 0u;
        v61 = 0u;
        v62 = 0u;
        v59 = 0u;
        v60 = 0u;
        v57 = 0u;
        v58 = 0u;
        v55 = 0u;
        v56 = 0u;
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v52 = 0u;
        v49 = 0u;
        v50 = 0u;
        v47 = 0u;
        v48 = 0u;
        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v41 = 0u;
        v42 = 0u;
        v39 = 0u;
        v40 = 0u;
        v37 = 0u;
        v38 = 0u;
        v35 = 0u;
        v36 = 0u;
        *buf = 0u;
        v34 = 0u;
        v13 = PLMigrationGetLog();
        os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT);
        v32[0] = 0;
        LODWORD(v31) = 2;
        v14 = _os_log_send_and_compose_impl();

        v15 = [*(a1 + 32) migrationLogger];
        [v15 logWithMessage:v14 fromCodeLocation:"PLModelMigrator.m" type:{4176, 0}];

        if (v14 != buf)
        {
          free(v14);
        }
      }

      else
      {
        v16 = PLMigrationGetLog();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Fixing UTI and directory for cloud shared videos", buf, 2u);
        }
      }
    }

    result = [*(a1 + 32) _fixCloudSharedVideosInStore:*(a1 + 40)];
    if (result)
    {
      v17 = PLMigrationGetLog();
      v18 = os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT);

      if (v18)
      {
        v19 = [*(a1 + 32) migrationLogger];

        if (v19)
        {
          v63 = 0u;
          v64 = 0u;
          v61 = 0u;
          v62 = 0u;
          v59 = 0u;
          v60 = 0u;
          v57 = 0u;
          v58 = 0u;
          v55 = 0u;
          v56 = 0u;
          v53 = 0u;
          v54 = 0u;
          v51 = 0u;
          v52 = 0u;
          v49 = 0u;
          v50 = 0u;
          v47 = 0u;
          v48 = 0u;
          v45 = 0u;
          v46 = 0u;
          v43 = 0u;
          v44 = 0u;
          v41 = 0u;
          v42 = 0u;
          v39 = 0u;
          v40 = 0u;
          v37 = 0u;
          v38 = 0u;
          v35 = 0u;
          v36 = 0u;
          *buf = 0u;
          v34 = 0u;
          v20 = PLMigrationGetLog();
          os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT);
          v32[0] = 0;
          LODWORD(v31) = 2;
          v21 = _os_log_send_and_compose_impl();

          v22 = [*(a1 + 32) migrationLogger];
          [v22 logWithMessage:v21 fromCodeLocation:"PLModelMigrator.m" type:{4180, 0}];

          if (v21 != buf)
          {
            free(v21);
          }
        }

        else
        {
          v23 = PLMigrationGetLog();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 0;
            _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Fixing filename for cloud shared GIFs", buf, 2u);
          }
        }
      }

      result = [*(a1 + 32) _fixCloudSharedGIFsInStore:*(a1 + 40)];
      if (result)
      {
        v24 = PLMigrationGetLog();
        v25 = os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT);

        if (v25)
        {
          v26 = [*(a1 + 32) migrationLogger];

          if (v26)
          {
            v63 = 0u;
            v64 = 0u;
            v61 = 0u;
            v62 = 0u;
            v59 = 0u;
            v60 = 0u;
            v57 = 0u;
            v58 = 0u;
            v55 = 0u;
            v56 = 0u;
            v53 = 0u;
            v54 = 0u;
            v51 = 0u;
            v52 = 0u;
            v49 = 0u;
            v50 = 0u;
            v47 = 0u;
            v48 = 0u;
            v45 = 0u;
            v46 = 0u;
            v43 = 0u;
            v44 = 0u;
            v41 = 0u;
            v42 = 0u;
            v39 = 0u;
            v40 = 0u;
            v37 = 0u;
            v38 = 0u;
            v35 = 0u;
            v36 = 0u;
            *buf = 0u;
            v34 = 0u;
            v27 = PLMigrationGetLog();
            os_log_type_enabled(v27, OS_LOG_TYPE_DEFAULT);
            v32[0] = 0;
            LODWORD(v31) = 2;
            v28 = _os_log_send_and_compose_impl();

            v29 = [*(a1 + 32) migrationLogger];
            [v29 logWithMessage:v28 fromCodeLocation:"PLModelMigrator.m" type:{4184, 0}];

            if (v28 != buf)
            {
              free(v28);
            }
          }

          else
          {
            v30 = PLMigrationGetLog();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 0;
              _os_log_impl(&dword_19BF1F000, v30, OS_LOG_TYPE_DEFAULT, "Fixing originalWidth/height/filename for cloud shared assets", buf, 2u);
            }
          }
        }

        return [*(a1 + 32) _fixOriginalPropertiesForCloudSharedAssetsInStore:*(a1 + 40)];
      }
    }
  }

  return result;
}

BOOL __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_8_959(uint64_t a1)
{
  v52 = *MEMORY[0x1E69E9840];
  v2 = PLMigrationGetLog();
  v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

  if (v3)
  {
    v4 = [*(a1 + 32) migrationLogger];

    if (v4)
    {
      v50 = 0u;
      v51 = 0u;
      v48 = 0u;
      v49 = 0u;
      v46 = 0u;
      v47 = 0u;
      v44 = 0u;
      v45 = 0u;
      v42 = 0u;
      v43 = 0u;
      v40 = 0u;
      v41 = 0u;
      v38 = 0u;
      v39 = 0u;
      v36 = 0u;
      v37 = 0u;
      v34 = 0u;
      v35 = 0u;
      v32 = 0u;
      v33 = 0u;
      v30 = 0u;
      v31 = 0u;
      v28 = 0u;
      v29 = 0u;
      v26 = 0u;
      v27 = 0u;
      v24 = 0u;
      v25 = 0u;
      v22 = 0u;
      v23 = 0u;
      *buf = 0u;
      v21 = 0u;
      v5 = PLMigrationGetLog();
      os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
      v19[0] = 0;
      LODWORD(v18) = 2;
      v6 = _os_log_send_and_compose_impl();

      v7 = [*(a1 + 32) migrationLogger];
      [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{4220, 0}];

      if (v6 != buf)
      {
        free(v6);
      }
    }

    else
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Resetting internal resources", buf, 2u);
      }
    }
  }

  v9 = [PLResourceInstaller resetInternalResourcesInStore:*(a1 + 40) resetUTIs:1 resetCodecs:1 resetMasters:0 migrator:*(a1 + 32)];
  result = 0;
  if (v9)
  {
    v11 = PLMigrationGetLog();
    v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);

    if (v12)
    {
      v13 = [*(a1 + 32) migrationLogger];

      if (v13)
      {
        v50 = 0u;
        v51 = 0u;
        v48 = 0u;
        v49 = 0u;
        v46 = 0u;
        v47 = 0u;
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        *buf = 0u;
        v21 = 0u;
        v14 = PLMigrationGetLog();
        os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT);
        v19[0] = 0;
        LODWORD(v18) = 2;
        v15 = _os_log_send_and_compose_impl();

        v16 = [*(a1 + 32) migrationLogger];
        [v16 logWithMessage:v15 fromCodeLocation:"PLModelMigrator.m" type:{4223, 0}];

        if (v15 != buf)
        {
          free(v15);
        }
      }

      else
      {
        v17 = PLMigrationGetLog();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "Populating internal resources", buf, 2u);
        }
      }
    }

    return [PLResourceInstaller createInternalResourcesForExistingAssetsWithNoExistingResourcesInStore:*(a1 + 40) migrator:*(a1 + 32)];
  }

  return result;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_985(uint64_t a1)
{
  v44 = *MEMORY[0x1E69E9840];
  result = [*(a1 + 32) _createImportSessionAlbums:*(a1 + 40)];
  if (result)
  {
    v3 = PLMigrationGetLog();
    v4 = os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT);

    if (v4)
    {
      v5 = [*(a1 + 32) migrationLogger];

      if (v5)
      {
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        v14 = 0u;
        v15 = 0u;
        *buf = 0u;
        v13 = 0u;
        v6 = PLMigrationGetLog();
        os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT);
        v11[0] = 0;
        LODWORD(v10) = 2;
        v7 = _os_log_send_and_compose_impl();

        v8 = [*(a1 + 32) migrationLogger];
        [v8 logWithMessage:v7 fromCodeLocation:"PLModelMigrator.m" type:{4253, 0}];

        if (v7 != buf)
        {
          free(v7);
        }
      }

      else
      {
        v9 = PLMigrationGetLog();
        if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Persisting import session albums", buf, 2u);
        }
      }
    }

    return [*(a1 + 32) _persistImportSessionAlbumType:*(a1 + 40)];
  }

  return result;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_6_1010(uint64_t a1)
{
  v46 = *MEMORY[0x1E69E9840];
  if (*(a1 + 48) == 1)
  {
    v2 = PLMigrationGetLog();
    v3 = os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT);

    if (v3)
    {
      v4 = [*(a1 + 32) migrationLogger];

      if (v4)
      {
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        v24 = 0u;
        v25 = 0u;
        v22 = 0u;
        v23 = 0u;
        v20 = 0u;
        v21 = 0u;
        v18 = 0u;
        v19 = 0u;
        v16 = 0u;
        v17 = 0u;
        *buf = 0u;
        v15 = 0u;
        v5 = PLMigrationGetLog();
        os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT);
        v13[0] = 0;
        LODWORD(v12) = 2;
        v6 = _os_log_send_and_compose_impl();

        v7 = [*(a1 + 32) migrationLogger];
        [v7 logWithMessage:v6 fromCodeLocation:"PLModelMigrator.m" type:{4282, 0}];

        if (v6 != buf)
        {
          free(v6);
        }
      }

      else
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Local thumbs will be recreated during OTA Migration", buf, 2u);
        }
      }
    }

    return 1;
  }

  else
  {
    v8 = *(a1 + 32);
    v9 = *(a1 + 40);

    return [v8 _deleteVideoThumbsMadeFromPreferredFrameInStore:v9];
  }
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_10_1051(uint64_t a1)
{
  v1 = [*(a1 + 32) pathManager];
  v2 = [PLCPLSettings settingsWithPathManager:v1];

  [v2 setRunOnceFlag:16 error:0];
  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_37(uint64_t a1)
{
  v1 = [*(a1 + 32) pathManager];
  v2 = [PLCPLSettings settingsWithPathManager:v1];

  [v2 setRunOnceFlag:32 error:0];
  return 1;
}

uint64_t __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_62(uint64_t a1)
{
  v56 = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) options];
  v3 = [v2 objectForKeyedSubscript:@"DefaultAlbumUUID"];

  v4 = [*(a1 + 32) options];
  v5 = [v4 objectForKeyedSubscript:@"DefaultAlbumTitle"];

  if (!v3)
  {
LABEL_18:
    v19 = 1;
    goto LABEL_19;
  }

  v6 = [MEMORY[0x1E695E000] standardUserDefaults];
  v7 = [v6 BOOLForKey:@"com.apple.Photos.FixWallpaper"];

  v8 = PLMigrationGetLog();
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT);

  if (!v7)
  {
    if (v9)
    {
      v14 = [*(a1 + 32) migrationLogger];

      if (v14)
      {
        v54 = 0u;
        v55 = 0u;
        v52 = 0u;
        v53 = 0u;
        v50 = 0u;
        v51 = 0u;
        v48 = 0u;
        v49 = 0u;
        v46 = 0u;
        v47 = 0u;
        v44 = 0u;
        v45 = 0u;
        v42 = 0u;
        v43 = 0u;
        v40 = 0u;
        v41 = 0u;
        v38 = 0u;
        v39 = 0u;
        v36 = 0u;
        v37 = 0u;
        v34 = 0u;
        v35 = 0u;
        v32 = 0u;
        v33 = 0u;
        v30 = 0u;
        v31 = 0u;
        v28 = 0u;
        v29 = 0u;
        v26 = 0u;
        v27 = 0u;
        *buf = 0u;
        v25 = 0u;
        v15 = PLMigrationGetLog();
        os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT);
        v23[0] = 0;
        LODWORD(v22) = 2;
        v16 = _os_log_send_and_compose_impl();

        v17 = [*(a1 + 32) migrationLogger];
        [v17 logWithMessage:v16 fromCodeLocation:"PLModelMigrator.m" type:{4552, 0}];

        if (v16 != buf)
        {
          free(v16);
        }
      }

      else
      {
        v20 = PLMigrationGetLog();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "skip fix wallpaper albums", buf, 2u);
        }
      }
    }

    goto LABEL_18;
  }

  if (v9)
  {
    v10 = [*(a1 + 32) migrationLogger];

    if (v10)
    {
      v54 = 0u;
      v55 = 0u;
      v52 = 0u;
      v53 = 0u;
      v50 = 0u;
      v51 = 0u;
      v48 = 0u;
      v49 = 0u;
      v46 = 0u;
      v47 = 0u;
      v44 = 0u;
      v45 = 0u;
      v42 = 0u;
      v43 = 0u;
      v40 = 0u;
      v41 = 0u;
      v38 = 0u;
      v39 = 0u;
      v36 = 0u;
      v37 = 0u;
      v34 = 0u;
      v35 = 0u;
      v32 = 0u;
      v33 = 0u;
      v30 = 0u;
      v31 = 0u;
      v28 = 0u;
      v29 = 0u;
      v26 = 0u;
      v27 = 0u;
      *buf = 0u;
      v25 = 0u;
      v11 = PLMigrationGetLog();
      os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);
      v23[0] = 0;
      LODWORD(v22) = 2;
      v12 = _os_log_send_and_compose_impl();

      v13 = [*(a1 + 32) migrationLogger];
      [v13 logWithMessage:v12 fromCodeLocation:"PLModelMigrator.m" type:{4549, 0}];

      if (v12 != buf)
      {
        free(v12);
      }
    }

    else
    {
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "fix wallpaper albums", buf, 2u);
      }
    }
  }

  v19 = [*(a1 + 32) _repairWallpaperAlbumsInStore:*(a1 + 40) containerUUID:v3 title:v5];
LABEL_19:

  return v19;
}

BOOL __97__PLModelMigrator_postProcessMigratedStore_migrationUUID_fromVersion_progress_progressUnitCount___block_invoke_12_1272(uint64_t a1)
{
  v1 = [*(a1 + 32) managedObjectContextForMigrationInStore:*(a1 + 40) name:"-[PLModelMigrator postProcessMigratedStore:migrationUUID:fromVersion:progress:progressUnitCount:]_block_invoke_12" concurrencyType:*MEMORY[0x1E695D708]];
  v2 = [PLResourceInstaller resetImageRequestHintsInContext:v1];

  return v2;
}

- (BOOL)validateModelEntityNames:(id *)a3
{
  v25 = *MEMORY[0x1E69E9840];
  v4 = +[PLManagedObjectContext managedObjectModel];
  v5 = [v4 entitiesByName];
  v6 = [v5 allKeys];

  v7 = PLXPCStoreAllowedEntityNames();
  v8 = PLXPCStoreDeniedEntityNames();
  v9 = [MEMORY[0x1E695DFA8] set];
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v10 = v6;
  v11 = [v10 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v11)
  {
    v12 = v11;
    v13 = *v21;
    do
    {
      for (i = 0; i != v12; ++i)
      {
        if (*v21 != v13)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v20 + 1) + 8 * i);
        if (([v7 containsObject:{v15, v20}] & 1) == 0 && (objc_msgSend(v8, "containsObject:", v15) & 1) == 0)
        {
          [v9 addObject:v15];
        }
      }

      v12 = [v10 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v12);
  }

  v16 = [v9 count];
  v17 = v16;
  if (a3 && v16)
  {
    v18 = v9;
    *a3 = v9;
  }

  return v17 == 0;
}

- (int64_t)attemptLightweightMigrationFromVersion:(id)a3 onStore:(id)a4 withMetadata:(id)a5 orStoreURL:(id)a6 options:(id)a7 coordinator:(id)a8 migrationPolicy:(unsigned int)a9 error:(id *)a10
{
  v17 = a3;
  v18 = a4;
  v19 = a5;
  v20 = a6;
  v34 = a7;
  v21 = a8;
  if (v17)
  {
    if (v19)
    {
      goto LABEL_3;
    }
  }

  else
  {
    v31 = [MEMORY[0x1E696AAA8] currentHandler];
    [v31 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3037 description:{@"Invalid parameter not satisfying: %@", @"previousStoreVersion", v34}];

    if (v19)
    {
      goto LABEL_3;
    }
  }

  v32 = [MEMORY[0x1E696AAA8] currentHandler];
  [v32 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3038 description:{@"Invalid parameter not satisfying: %@", @"storeMetadata"}];

LABEL_3:
  if (!v21)
  {
    v33 = [MEMORY[0x1E696AAA8] currentHandler];
    [v33 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:3039 description:{@"Invalid parameter not satisfying: %@", @"coordinator"}];
  }

  v37 = 0;
  v38 = &v37;
  v39 = 0x2020000000;
  v40 = 0;
  v35[0] = 0;
  v35[1] = v35;
  v35[2] = 0x3032000000;
  v35[3] = __Block_byref_object_copy__21558;
  v35[4] = __Block_byref_object_dispose__21559;
  v22 = v18;
  v36 = v22;
  v23 = v17;
  v24 = v22;
  v25 = v19;
  v26 = v20;
  v27 = v21;
  v28 = v34;
  PLRunWithUnfairLock();
  if (*(v38 + 24))
  {
    v29 = 2;
  }

  else
  {
    v29 = 4;
  }

  _Block_object_dispose(v35, 8);
  _Block_object_dispose(&v37, 8);

  return v29;
}

void __132__PLModelMigrator_attemptLightweightMigrationFromVersion_onStore_withMetadata_orStoreURL_options_coordinator_migrationPolicy_error___block_invoke(uint64_t a1)
{
  v123 = *MEMORY[0x1E69E9840];
  if (([*(a1 + 32) _allowSchemaUpgradeWithUserPromptFromVersion:*(a1 + 40) onStore:*(a1 + 48) withMetadata:*(a1 + 56) orStoreURL:*(a1 + 64)] & 1) == 0)
  {
    *(*(*(a1 + 88) + 8) + 24) = 0;
    return;
  }

  [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
  v3 = v2;
  v4 = [PLMigrationContext alloc];
  v5 = *(*(a1 + 32) + 32);
  v6 = *(*(*(a1 + 96) + 8) + 40);
  v8 = *(a1 + 64);
  v7 = *(a1 + 72);
  v9 = [*(a1 + 40) unsignedShortValue];
  v86 = a1;
  v10 = *(a1 + 80);
  v11 = *(a1 + 112);
  v12 = [*(v86 + 32) analyticsEventManager];
  v13 = [*(v86 + 32) graphCache];
  LODWORD(v84) = v11;
  v14 = v10;
  v15 = v86;
  v16 = [(PLMigrationContext *)v4 initWithPathManager:v5 coordinator:v7 onStore:v6 orStoreURL:v8 version:v9 options:v14 migrationPolicy:v84 analyticsEventManager:v12 graphCache:v13];

  v17 = [PLModelMigration alloc];
  v18 = [*(v86 + 32) migrationLogger];
  v19 = [(PLModelMigration *)v17 initWithMigrationContext:v16 logger:v18];

  v20 = [*(v86 + 32) progress];
  v21 = [(PLModelMigration *)v19 progress];
  [v20 addChild:v21 withPendingUnitCount:1];

  [(PLModelMigration *)v19 setLegacyMigrationDelegate:*(v86 + 32)];
  v87 = 0;
  v22 = [(PLModelMigration *)v19 migrateWithError:&v87];
  v23 = v87;
  if (v22 == 1)
  {
    v24 = *(*(*(v86 + 96) + 8) + 40);
    if (!v24)
    {
      v25 = [(PLMigrationContext *)v16 store];
      v26 = *(*(v86 + 96) + 8);
      v27 = *(v26 + 40);
      *(v26 + 40) = v25;

      v24 = *(*(*(v86 + 96) + 8) + 40);
    }

    if ([*(v86 + 32) _recordCurrentVersionMetadataInPersistentStore:v24 migrationType:2 forceRebuildReason:0 sourceModelVersion:*(v86 + 40) updateLegacyMigrationState:0 journalRebuildRequred:0])
    {
      [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
      v29 = v28;
      v30 = PLMigrationGetLog();
      v31 = os_log_type_enabled(v30, OS_LOG_TYPE_DEFAULT);

      if (v31)
      {
        v32 = v29 - v3;
        v33 = [*(v86 + 32) migrationLogger];

        if (v33)
        {
          v121 = 0u;
          v122 = 0u;
          v119 = 0u;
          v120 = 0u;
          v117 = 0u;
          v118 = 0u;
          v115 = 0u;
          v116 = 0u;
          v113 = 0u;
          v114 = 0u;
          v111 = 0u;
          v112 = 0u;
          v109 = 0u;
          v110 = 0u;
          v107 = 0u;
          v108 = 0u;
          v105 = 0u;
          v106 = 0u;
          v103 = 0u;
          v104 = 0u;
          v101 = 0u;
          v102 = 0u;
          v99 = 0u;
          v100 = 0u;
          v97 = 0u;
          v98 = 0u;
          v95 = 0u;
          v96 = 0u;
          v94 = 0u;
          v93 = 0u;
          memset(buf, 0, sizeof(buf));
          v34 = PLMigrationGetLog();
          os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT);
          v35 = +[PLModelMigrator currentModelVersion];
          v90 = 67109376;
          LODWORD(v91[0]) = v35;
          WORD2(v91[0]) = 2048;
          *(v91 + 6) = v32;
          LODWORD(v85) = 18;
          v36 = _os_log_send_and_compose_impl();

          v37 = [*(v86 + 32) migrationLogger];
          [v37 logWithMessage:v36 fromCodeLocation:"PLModelMigrator.m" type:{3078, 0}];

          if (v36 != buf)
          {
            free(v36);
          }
        }

        else
        {
          v63 = PLMigrationGetLog();
          if (os_log_type_enabled(v63, OS_LOG_TYPE_DEFAULT))
          {
            v64 = +[PLModelMigrator currentModelVersion];
            *buf = 67109376;
            *&buf[4] = v64;
            *&buf[8] = 2048;
            *&buf[10] = v32;
            _os_log_impl(&dword_19BF1F000, v63, OS_LOG_TYPE_DEFAULT, "Successfully migrated store to version %d in %1.1fs", buf, 0x12u);
          }
        }
      }

      if ([(PLModelMigration *)v19 allowRebuild]|| [(PLModelMigration *)v19 didCreateSqliteErrorIndicator])
      {
        v65 = PLMigrationGetLog();
        v66 = os_log_type_enabled(v65, OS_LOG_TYPE_DEFAULT);

        if (v66)
        {
          v67 = [*(v86 + 32) migrationLogger];

          if (v67)
          {
            v121 = 0u;
            v122 = 0u;
            v119 = 0u;
            v120 = 0u;
            v117 = 0u;
            v118 = 0u;
            v115 = 0u;
            v116 = 0u;
            v113 = 0u;
            v114 = 0u;
            v111 = 0u;
            v112 = 0u;
            v109 = 0u;
            v110 = 0u;
            v107 = 0u;
            v108 = 0u;
            v105 = 0u;
            v106 = 0u;
            v103 = 0u;
            v104 = 0u;
            v101 = 0u;
            v102 = 0u;
            v99 = 0u;
            v100 = 0u;
            v97 = 0u;
            v98 = 0u;
            v95 = 0u;
            v96 = 0u;
            v94 = 0u;
            v93 = 0u;
            memset(buf, 0, sizeof(buf));
            v68 = PLMigrationGetLog();
            os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT);
            LOWORD(v90) = 0;
            LODWORD(v85) = 2;
            v69 = _os_log_send_and_compose_impl();

            v70 = [*(v86 + 32) migrationLogger];
            [v70 logWithMessage:v69 fromCodeLocation:"PLModelMigrator.m" type:{3083, 0}];

            if (v69 != buf)
            {
              free(v69);
            }
          }

          else
          {
            v72 = PLMigrationGetLog();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 0;
              _os_log_impl(&dword_19BF1F000, v72, OS_LOG_TYPE_DEFAULT, "Removing migration indicator file", buf, 2u);
            }
          }
        }

        v73 = [*(v86 + 32) pathManager];
        [v73 removeSqliteErrorIndicatorFile];
      }

      v71 = 1;
      goto LABEL_49;
    }

    v44 = PLMigrationGetLog();
    v45 = os_log_type_enabled(v44, OS_LOG_TYPE_ERROR);

    if (!v45)
    {
      goto LABEL_43;
    }

    v46 = [*(v86 + 32) migrationLogger];

    if (v46)
    {
      v121 = 0u;
      v122 = 0u;
      v119 = 0u;
      v120 = 0u;
      v117 = 0u;
      v118 = 0u;
      v115 = 0u;
      v116 = 0u;
      v113 = 0u;
      v114 = 0u;
      v111 = 0u;
      v112 = 0u;
      v109 = 0u;
      v110 = 0u;
      v107 = 0u;
      v108 = 0u;
      v105 = 0u;
      v106 = 0u;
      v103 = 0u;
      v104 = 0u;
      v101 = 0u;
      v102 = 0u;
      v99 = 0u;
      v100 = 0u;
      v97 = 0u;
      v98 = 0u;
      v95 = 0u;
      v96 = 0u;
      v94 = 0u;
      v93 = 0u;
      memset(buf, 0, sizeof(buf));
      v47 = PLMigrationGetLog();
      os_log_type_enabled(v47, OS_LOG_TYPE_ERROR);
      LOWORD(v90) = 0;
      LODWORD(v85) = 2;
      v48 = _os_log_send_and_compose_impl();

      v49 = [*(v86 + 32) migrationLogger];
      [v49 logWithMessage:v48 fromCodeLocation:"PLModelMigrator.m" type:{3087, 16}];

      if (v48 != buf)
      {
        v50 = v48;
LABEL_28:
        free(v50);
        goto LABEL_43;
      }

      goto LABEL_43;
    }

    v61 = PLMigrationGetLog();
    if (os_log_type_enabled(v61, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v61, OS_LOG_TYPE_ERROR, "Failed to save current metadata, requires rebuild", buf, 2u);
    }

LABEL_42:

    goto LABEL_43;
  }

  v38 = PLMigrationGetLog();
  v39 = os_log_type_enabled(v38, OS_LOG_TYPE_ERROR);

  if (v39)
  {
    v40 = [*(v86 + 32) migrationLogger];

    if (v40)
    {
      v121 = 0u;
      v122 = 0u;
      v119 = 0u;
      v120 = 0u;
      v117 = 0u;
      v118 = 0u;
      v115 = 0u;
      v116 = 0u;
      v113 = 0u;
      v114 = 0u;
      v111 = 0u;
      v112 = 0u;
      v109 = 0u;
      v110 = 0u;
      v107 = 0u;
      v108 = 0u;
      v105 = 0u;
      v106 = 0u;
      v103 = 0u;
      v104 = 0u;
      v101 = 0u;
      v102 = 0u;
      v99 = 0u;
      v100 = 0u;
      v97 = 0u;
      v98 = 0u;
      v95 = 0u;
      v96 = 0u;
      v94 = 0u;
      v93 = 0u;
      memset(buf, 0, sizeof(buf));
      v41 = PLMigrationGetLog();
      os_log_type_enabled(v41, OS_LOG_TYPE_ERROR);
      v90 = 138412290;
      v91[0] = v23;
      LODWORD(v85) = 12;
      v42 = _os_log_send_and_compose_impl();

      v43 = [*(v86 + 32) migrationLogger];
      [v43 logWithMessage:v42 fromCodeLocation:"PLModelMigrator.m" type:{3063, 16}];

      if (v42 != buf)
      {
        free(v42);
      }
    }

    else
    {
      v51 = PLMigrationGetLog();
      if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        *&buf[4] = v23;
        _os_log_impl(&dword_19BF1F000, v51, OS_LOG_TYPE_ERROR, "Failed migration with error: %@", buf, 0xCu);
      }
    }
  }

  v52 = *(v86 + 104);
  if (v52)
  {
    v53 = v23;
    *v52 = v23;
  }

  v54 = PLMigrationGetLog();
  v55 = os_log_type_enabled(v54, OS_LOG_TYPE_DEFAULT);

  if (!v55)
  {
    goto LABEL_43;
  }

  v56 = [*(v86 + 32) migrationLogger];

  if (!v56)
  {
    v61 = PLMigrationGetLog();
    if (os_log_type_enabled(v61, OS_LOG_TYPE_DEFAULT))
    {
      v62 = PLFilteredStoreMetadataWithPolicy(*(v86 + 56), 1);
      *buf = 138543362;
      *&buf[4] = v62;
      _os_log_impl(&dword_19BF1F000, v61, OS_LOG_TYPE_DEFAULT, "Requires rebuild, migration post processing failed with metadata %{public}@", buf, 0xCu);
    }

    goto LABEL_42;
  }

  v121 = 0u;
  v122 = 0u;
  v119 = 0u;
  v120 = 0u;
  v117 = 0u;
  v118 = 0u;
  v115 = 0u;
  v116 = 0u;
  v113 = 0u;
  v114 = 0u;
  v111 = 0u;
  v112 = 0u;
  v109 = 0u;
  v110 = 0u;
  v107 = 0u;
  v108 = 0u;
  v105 = 0u;
  v106 = 0u;
  v103 = 0u;
  v104 = 0u;
  v101 = 0u;
  v102 = 0u;
  v99 = 0u;
  v100 = 0u;
  v97 = 0u;
  v98 = 0u;
  v95 = 0u;
  v96 = 0u;
  v94 = 0u;
  v93 = 0u;
  memset(buf, 0, sizeof(buf));
  v57 = PLMigrationGetLog();
  os_log_type_enabled(v57, OS_LOG_TYPE_DEFAULT);
  v58 = PLFilteredStoreMetadataWithPolicy(*(v86 + 56), 1);
  v90 = 138543362;
  v91[0] = v58;
  LODWORD(v85) = 12;
  v59 = _os_log_send_and_compose_impl();

  v60 = [*(v86 + 32) migrationLogger];
  [v60 logWithMessage:v59 fromCodeLocation:"PLModelMigrator.m" type:{3070, 0}];

  if (v59 != buf)
  {
    v50 = v59;
    goto LABEL_28;
  }

LABEL_43:
  v71 = 0;
LABEL_49:
  *(*(*(v86 + 88) + 8) + 24) = v71;
  if ((*(*(*(v86 + 88) + 8) + 24) & 1) == 0)
  {
    v74 = *(v86 + 104);
    if (v74)
    {
      if (!*v74)
      {
        v75 = MEMORY[0x1E696ABC0];
        v76 = *MEMORY[0x1E69BFF48];
        v88[0] = *MEMORY[0x1E696A368];
        v77 = [*(v86 + 64) path];
        v89[0] = v77;
        v88[1] = *MEMORY[0x1E696A998];
        v78 = [*(v86 + 64) URLByDeletingLastPathComponent];
        [v78 URLByDeletingLastPathComponent];
        v80 = v79 = v23;
        v89[1] = v80;
        v88[2] = *MEMORY[0x1E696A578];
        v81 = [MEMORY[0x1E696AEC0] stringWithFormat:@"Lightweight migration failed from model version %d to version %d.", objc_msgSend(*(v86 + 40), "intValue"), +[PLModelMigrator currentModelVersion](PLModelMigrator, "currentModelVersion")];
        v89[2] = v81;
        v82 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v89 forKeys:v88 count:3];
        v83 = v76;
        v15 = v86;
        **(v86 + 104) = [v75 errorWithDomain:v83 code:46008 userInfo:v82];

        v23 = v79;
      }
    }
  }

  [*(v15 + 32) migrationLoggerClose];
}

- (void)_updateImportedSavedAssetTypeForFileSystemImportedAsset:(id)a3 type:(unsigned __int8)a4 importAssetKind:(int)a5 isCPLAssetsDirectory:(BOOL)a6 destinationAlbum:(id)a7
{
  v8 = a6;
  v10 = a4;
  v18 = a3;
  v11 = a7;
  if (v11)
  {
    [MEMORY[0x1E69BF328] maskForPhotoStreamAsset];
    [v18 savedAssetType];
    if (PLValidatedSavedAssetTypeApplies())
    {
      goto LABEL_22;
    }
  }

  [MEMORY[0x1E69BF328] maskForAssetsEligibleForFileSystemImportSavedAssetTypeUpdate];
  [v18 savedAssetType];
  if (!PLValidatedSavedAssetTypeApplies())
  {
    goto LABEL_22;
  }

  if (v10 == 1)
  {
    v12 = [v18 isInTrash] ^ 1;
  }

  else
  {
    v12 = 0;
  }

  v13 = 0;
  if (a5 > 7)
  {
    goto LABEL_20;
  }

  if (((1 << a5) & 0x8D) != 0)
  {
    v14 = MEMORY[0x1E69BF328];
    if (!v12)
    {
      if (v8)
      {
        v15 = [MEMORY[0x1E69BF328] savedAssetTypeForAssetsInCPLAssetsDirectory];
      }

      else
      {
        v15 = [MEMORY[0x1E69BF328] defaultSavedAssetTypeForUnknownFilesystemImportAssets];
      }

      goto LABEL_19;
    }
  }

  else
  {
    v16 = v18;
    if (a5 != 1)
    {
      if (a5 == 4)
      {
        v17 = [MEMORY[0x1E69BF328] savedAssetTypeForFinderSyncedAsset];
        v16 = v18;
        v13 = v17;
      }

      goto LABEL_21;
    }

    v14 = MEMORY[0x1E69BF328];
    if (!v12)
    {
      v15 = [MEMORY[0x1E69BF328] savedAssetTypeForImportedByCameraConnectionKit];
      goto LABEL_19;
    }
  }

  v15 = [v14 savedAssetTypeForRecoveredAsset];
LABEL_19:
  v13 = v15;
LABEL_20:
  v16 = v18;
LABEL_21:
  [v16 setSavedAssetType:v13];
LABEL_22:
}

- (id)_importFileSystemImportAssets:(id)a3 intoLibrary:(id)a4 type:(unsigned __int8)a5 progress:(id)a6
{
  v10 = a3;
  v11 = a4;
  v12 = a6;
  v13 = [v11 libraryServicesManager];
  v14 = [v13 wellKnownPhotoLibraryIdentifier];

  if (v14 == 3)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_importFileSystemImportAssets is unsupported for the syndication photo library", buf, 2u);
    }

    [v12 setCompletedUnitCount:{objc_msgSend(v12, "totalUnitCount")}];
    v16 = MEMORY[0x1E695E0F0];
  }

  else
  {
    v17 = [MEMORY[0x1E695DF70] array];
    v18 = objc_autoreleasePoolPush();
    v19 = [v11 libraryServicesManager];
    v21[0] = MEMORY[0x1E69E9820];
    v21[1] = 3221225472;
    v21[2] = __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke;
    v21[3] = &unk_1E7568CB8;
    v22 = v11;
    v23 = self;
    v24 = v10;
    v25 = v12;
    v27 = a5;
    v16 = v17;
    v26 = v16;
    [v19 performFileSystemAssetImporterWorkWithLibrary:v22 block:v21];

    objc_autoreleasePoolPop(v18);
  }

  return v16;
}

void __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke(uint64_t a1, void *a2)
{
  v140 = *MEMORY[0x1E69E9840];
  v97 = a2;
  v104 = a1;
  v3 = [*(a1 + 32) managedObjectContext];
  [*(v104 + 40) _prepareForImportDeleteCorruptAssetsWithImporter:v97 context:v3];
  v131 = 0;
  v132 = &v131;
  v133 = 0x2020000000;
  v134 = 0;
  v127 = 0;
  v128 = &v127;
  v129 = 0x2020000000;
  v130 = arc4random_uniform(0xAu) + 20;
  Mutable = CFDictionaryCreateMutable(0, 0, MEMORY[0x1E695E9D8], MEMORY[0x1E695E9E8]);
  aBlock[0] = MEMORY[0x1E69E9820];
  aBlock[1] = 3221225472;
  aBlock[2] = __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke_2;
  aBlock[3] = &unk_1E7578898;
  theDict = Mutable;
  v123 = theDict;
  v86 = v3;
  v124 = v86;
  v125 = &v131;
  v126 = &v127;
  v92 = _Block_copy(aBlock);
  v96 = [*(v104 + 32) filesystemImportProgressAlbum];
  v99 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:objc_msgSend(*(v104 + 48) parent:"count") pendingUnitCount:{*(v104 + 56), objc_msgSend(*(v104 + 56), "totalUnitCount")}];
  v93 = [MEMORY[0x1E695DFA8] set];
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = [*(v104 + 48) count];
    LODWORD(buf.origin.x) = 134217984;
    *(&buf.origin.x + 4) = v6;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEFAULT, "Starting file system import of %ld assets", &buf, 0xCu);
  }

  v120 = 0u;
  v121 = 0u;
  v118 = 0u;
  v119 = 0u;
  obj = *(v104 + 48);
  v7 = [obj countByEnumeratingWithState:&v118 objects:v139 count:16];
  if (v7)
  {
    v94 = v7;
    v91 = 0;
    v95 = *v119;
    v87 = *MEMORY[0x1E695DAA8];
    while (2)
    {
      v102 = 0;
      do
      {
        if (*v119 != v95)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v118 + 1) + 8 * v102);
        if ([*(v104 + 56) isCancelled])
        {
          v75 = PLBackendGetLog();
          if (os_log_type_enabled(v75, OS_LOG_TYPE_ERROR))
          {
            LOWORD(buf.origin.x) = 0;
            _os_log_impl(&dword_19BF1F000, v75, OS_LOG_TYPE_ERROR, "Will abort looping over file system import assets due to progress cancel", &buf, 2u);
          }

          goto LABEL_82;
        }

        context = objc_autoreleasePoolPush();
        v103 = [v8 urls];
        v9 = [v8 destinationAlbum];
        if (v9)
        {
          [v93 addObject:v9];
        }

        v105 = v9;
        v10 = *(v104 + 72);
        v11 = [v8 assetPayload];
        v106 = [v97 addAssetWithURLs:v103 assetPayload:v11 forceInsert:0 forceUpdate:v10 == 2 fixAddedDate:0];

        if (v106)
        {
          [*(v104 + 64) addObject:?];
          if (+[PLAvalanche shouldOnlyShowAvalanchePicks])
          {
            v12 = [v106 avalancheUUID];
            if (v12)
            {
              v13 = [v106 avalanchePickTypeIsVisible] ^ 1;
            }

            else
            {
              v13 = 0;
            }
          }

          else
          {
            v13 = 0;
          }

          v14 = v105;
          if (archivedAssetUUIDForPathDictionary_block_invoke_s_onceToken != -1)
          {
            dispatch_once(&archivedAssetUUIDForPathDictionary_block_invoke_s_onceToken, &__block_literal_global_403);
          }

          v100 = [v106 pathManager];
          if ([v100 isDCIM])
          {
            v15 = [v106 directory];
            v16 = [v15 hasPrefix:archivedAssetUUIDForPathDictionary_block_invoke_s_cplAssetDirectoryPrefix];

            v14 = v105;
          }

          else
          {
            v16 = 0;
          }

          [*(v104 + 40) _updateImportedSavedAssetTypeForFileSystemImportedAsset:v106 type:*(v104 + 72) importAssetKind:objc_msgSend(v8 isCPLAssetsDirectory:"assetKind") destinationAlbum:{v16, v14}];
          if (v16)
          {
            v17 = [v106 cloudAssetGUID];
            v18 = v17 == 0;

            if (v18)
            {
              v19 = objc_alloc(MEMORY[0x1E696AFB0]);
              v20 = [v106 filename];
              v21 = [v20 stringByDeletingPathExtension];
              v22 = [v19 initWithUUIDString:v21];

              if (v22)
              {
                v23 = [v22 UUIDString];
                [v106 setCloudAssetGUID:v23];
              }
            }
          }

          v98 = [v103 anyObject];
          v24 = v105;
          if ([v106 isPhotoStreamPhoto])
          {
            v117 = 0;
            v25 = [v98 getResourceValue:&v117 forKey:v87 error:0];
            v26 = v117;
            v27 = v26;
            if (v25)
            {
              if (v26)
              {
                [v106 setDateCreated:v26];
              }

              v28 = [v106 dateCreated];
              [v28 timeIntervalSinceReferenceDate];
              [v106 setSortToken:?];
            }

            [v106 setVisibilityState:1];

            v24 = v105;
          }

          if ([v8 isCameraKit])
          {
            if (!v91)
            {
              v91 = [*(v104 + 32) allImportedPhotosAlbum];
            }

            if ((v13 & 1) == 0)
            {
              v29 = [v91 mutableAssets];
              [v29 addObject:v106];

              v24 = v105;
            }

            if (v24)
            {
              if ([v24 kindValue] == 12)
              {
                v30 = [v24 mutableAssets];
                v31 = [v30 count] == 0;

                if (v31)
                {
                  v32 = objc_alloc(MEMORY[0x1E69C0718]);
                  v33 = [*(v104 + 32) libraryBundle];
                  v34 = [v33 timeZoneLookup];
                  v35 = [v32 initWithMediaURL:v98 timeZoneLookup:v34];

                  v36 = *(v104 + 40);
                  v37 = [v35 creationDate];
                  v38 = [v36 _eventNameFromDate:v37];
                  [v105 setTitle:v38];
                }
              }
            }
          }

          if ([v100 isDCIM] && objc_msgSend(v106, "isFinderSyncedAsset"))
          {
            v39 = [v106 photoLibrary];
            v40 = [v39 pathManager];
            v41 = [v40 iTunesSyncedFaceDataDirectory];
            v42 = [v106 uuid];
            v43 = [v41 stringByAppendingPathComponent:v42];
            v88 = [v43 stringByAppendingPathExtension:@"plist"];

            v44 = [MEMORY[0x1E695DEC8] arrayWithContentsOfFile:v88];
            v116 = 0u;
            v114 = 0u;
            v115 = 0u;
            v113 = 0u;
            v45 = v44;
            v46 = [v45 countByEnumeratingWithState:&v113 objects:v138 count:16];
            if (v46)
            {
              v47 = *v114;
              do
              {
                for (i = 0; i != v46; ++i)
                {
                  if (*v114 != v47)
                  {
                    objc_enumerationMutation(v45);
                  }

                  v49 = *(*(&v113 + 1) + 8 * i);
                  v50 = [v49 objectForKey:@"faceAlbumUUID"];
                  v51 = [v49 objectForKey:@"faceIndex"];
                  v52 = [v49 objectForKey:@"faceRectangle"];
                  v53 = v52;
                  if (v51)
                  {
                    v54 = v52 == 0;
                  }

                  else
                  {
                    v54 = 1;
                  }

                  if (!v54)
                  {
                    memset(&buf, 0, sizeof(buf));
                    if (CGRectMakeWithDictionaryRepresentation(v52, &buf))
                    {
                      v55 = [v51 intValue];
                      v56 = [v106 addLegacyFaceWithRelativeRect:v55 identifier:v50 albumUUID:{buf.origin.x, buf.origin.y, buf.size.width, buf.size.height}];
                    }
                  }
                }

                v46 = [v45 countByEnumeratingWithState:&v113 objects:v138 count:16];
              }

              while (v46);
            }

            v57 = *(v104 + 40);
            v58 = [v106 uuid];
            v59 = [v57 _syncedPropertiesForAssetUUID:v58];

            [*(v104 + 40) _applySyncedProperties:v59 toAsset:v106];
          }

          v112 = 0;
          v60 = [PLResourceInstaller installInternalResourcesForExistingAsset:v106 assumeNoExistingResources:0 referencedResourceURLs:0 error:&v112];
          v61 = v112;
          if (!v60)
          {
            v62 = PLMigrationGetLog();
            if (os_log_type_enabled(v62, OS_LOG_TYPE_ERROR))
            {
              v63 = [v106 uuid];
              LODWORD(buf.origin.x) = 138412546;
              *(&buf.origin.x + 4) = v63;
              WORD2(buf.origin.y) = 2112;
              *(&buf.origin.y + 6) = v61;
              _os_log_impl(&dword_19BF1F000, v62, OS_LOG_TYPE_ERROR, "Failed to build modern resources for asset uuid: %@, reason: %@", &buf, 0x16u);
            }
          }

          [v106 setDeferredProcessingNeeded:{objc_msgSend(v106, "expectedDeferredProcessingNeededOnAssetCreation")}];
          if ([v106 deferredProcessingNeeded])
          {
            v64 = [v106 photoLibrary];
            v65 = [v64 libraryServicesManager];
            v66 = [v65 backgroundJobService];
            v67 = [v106 photoLibrary];
            [v66 signalBackgroundProcessingNeededOnLibrary:v67];
          }

          v136 = v106;
          v68 = [MEMORY[0x1E695DEC8] arrayWithObjects:&v136 count:1];
          [PLManagedAsset markMomentShareAndCollectionShareAssetsAsCopied:v68];

          v69 = PLMigrationGetLog();
          v70 = os_log_type_enabled(v69, OS_LOG_TYPE_DEBUG);
          v71 = v105;
          if (v70)
          {
            v72 = [v106 uuid];
            LODWORD(buf.origin.x) = 138412546;
            *(&buf.origin.x + 4) = v103;
            WORD2(buf.origin.y) = 2112;
            *(&buf.origin.y + 6) = v72;
            _os_log_impl(&dword_19BF1F000, v69, OS_LOG_TYPE_DEBUG, "Added '%@'\nto the database. UUID = %@", &buf, 0x16u);

            v71 = v105;
          }

          v73 = v71 == 0;

          if (!v73)
          {
            v74 = [(__CFDictionary *)theDict objectForKey:v105];
            if (!v74)
            {
              v74 = [MEMORY[0x1E695DF70] array];
              CFDictionarySetValue(theDict, v105, v74);
            }

            [v74 addObject:v106];
          }

          ++v132[3];
        }

        else
        {
          [v105 reducePendingItemsCountBy:1];
          [v96 reducePendingItemsCountBy:1];
          [v99 setCompletedUnitCount:{objc_msgSend(v99, "completedUnitCount") + 1}];
        }

        if (v128[3] <= v132[3])
        {
          [v96 reducePendingItemsCountBy:?];
          [v99 setCompletedUnitCount:{v132[3] + objc_msgSend(v99, "completedUnitCount")}];
          v92[2]();
        }

        objc_autoreleasePoolPop(context);
        ++v102;
      }

      while (v102 != v94);
      v94 = [obj countByEnumeratingWithState:&v118 objects:v139 count:16];
      if (v94)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v91 = 0;
  }

LABEL_82:

  v92[2]();
  v76 = [v96 pendingItemsCount];
  if (v76)
  {
    [v96 reducePendingItemsCountBy:v76];
  }

  v110 = 0u;
  v111 = 0u;
  v108 = 0u;
  v109 = 0u;
  v77 = v93;
  v78 = [v77 countByEnumeratingWithState:&v108 objects:v135 count:16];
  if (v78)
  {
    v79 = *v109;
    do
    {
      for (j = 0; j != v78; ++j)
      {
        if (*v109 != v79)
        {
          objc_enumerationMutation(v77);
        }

        v81 = *(*(&v108 + 1) + 8 * j);
        v82 = [v81 pendingItemsCount];
        if (v82)
        {
          [v81 reducePendingItemsCountBy:v82];
        }
      }

      v78 = [v77 countByEnumeratingWithState:&v108 objects:v135 count:16];
    }

    while (v78);
  }

  if ([v86 hasChanges])
  {
    v107 = 0;
    v83 = [v86 save:&v107];
    v84 = v107;
    if ((v83 & 1) == 0)
    {
      v85 = PLMigrationGetLog();
      if (os_log_type_enabled(v85, OS_LOG_TYPE_ERROR))
      {
        LODWORD(buf.origin.x) = 138412290;
        *(&buf.origin.x + 4) = v84;
        _os_log_impl(&dword_19BF1F000, v85, OS_LOG_TYPE_ERROR, "Unable to save moc during migration. Data loss may occur. (%@)", &buf, 0xCu);
      }
    }
  }

  else
  {
    v84 = 0;
  }

  _Block_object_dispose(&v127, 8);
  _Block_object_dispose(&v131, 8);
}

void __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke_2(uint64_t a1)
{
  v9 = *MEMORY[0x1E69E9840];
  [*(a1 + 32) enumerateKeysAndObjectsUsingBlock:&__block_literal_global_399];
  [*(a1 + 32) removeAllObjects];
  if ([*(a1 + 40) hasChanges])
  {
    v2 = *(a1 + 40);
    v6 = 0;
    v3 = [v2 save:&v6];
    v4 = v6;
    if ((v3 & 1) == 0)
    {
      v5 = PLMigrationGetLog();
      if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v8 = v4;
        _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "Unable to save moc during migration. Data loss may occur. (%@)", buf, 0xCu);
      }
    }
  }

  else
  {
    v4 = 0;
  }

  *(*(*(a1 + 48) + 8) + 24) = 0;
  *(*(*(a1 + 56) + 8) + 24) = arc4random_uniform(0xAu) + 20;
}

void __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke_401()
{
  v0 = [MEMORY[0x1E696AEC0] stringWithFormat:@"%@/%@", @"PhotoData", @"CPLAssets"];
  v1 = archivedAssetUUIDForPathDictionary_block_invoke_s_cplAssetDirectoryPrefix;
  archivedAssetUUIDForPathDictionary_block_invoke_s_cplAssetDirectoryPrefix = v0;
}

void __75__PLModelMigrator__importFileSystemImportAssets_intoLibrary_type_progress___block_invoke_3(uint64_t a1, void *a2, void *a3)
{
  v4 = a3;
  v7 = a2;
  v5 = [v7 mutableAssets];
  [v5 addObjectsFromArray:v4];

  v6 = [v4 count];
  [v7 reducePendingItemsCountBy:v6];
}

- (void)_prepareForImportDeleteCorruptAssetsWithImporter:(id)a3 context:(id)a4
{
  v100 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  v7 = [v6 photoLibrary];
  v8 = [v7 libraryServicesManager];
  v9 = [v8 wellKnownPhotoLibraryIdentifier];

  if (v9 == 3)
  {
    v10 = PLMigrationGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "_prepareForImportDeleteCorruptAssetsWithImporter is unsupported for the syndication photo library", buf, 2u);
    }

    goto LABEL_76;
  }

  v11 = objc_autoreleasePoolPush();
  v12 = MEMORY[0x1E695D5E0];
  v13 = +[PLManagedAsset entityName];
  v14 = [v12 fetchRequestWithEntityName:v13];

  [v14 setResultType:2];
  v15 = objc_alloc_init(MEMORY[0x1E695D5C8]);
  [v15 setName:@"objectID"];
  v16 = [MEMORY[0x1E696ABC8] expressionForEvaluatedObject];
  [v15 setExpression:v16];

  [v15 setExpressionResultType:2000];
  v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:{v15, @"uuid", @"directory", @"filename", @"savedAssetType", 0}];
  [v14 setPropertiesToFetch:v17];

  v95 = 0;
  v71 = v14;
  v18 = [v6 executeFetchRequest:v14 error:&v95];
  v78 = v95;
  if (!v18)
  {
    v45 = PLMigrationGetLog();
    if (os_log_type_enabled(v45, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      *v98 = v78;
      _os_log_impl(&dword_19BF1F000, v45, OS_LOG_TYPE_ERROR, "Unable to fetch asset UUIDs and paths during migration. (%@)", buf, 0xCu);
    }

    goto LABEL_75;
  }

  v67 = v15;
  v68 = v11;
  v69 = v5;
  v74 = [MEMORY[0x1E695DFA8] setWithCapacity:{objc_msgSend(v18, "count")}];
  v76 = [MEMORY[0x1E695DF90] dictionaryWithCapacity:{objc_msgSend(v18, "count")}];
  v73 = [MEMORY[0x1E695DF90] dictionaryWithCapacity:{objc_msgSend(v18, "count")}];
  v75 = [MEMORY[0x1E695DFA8] set];
  v91 = 0u;
  v92 = 0u;
  v93 = 0u;
  v94 = 0u;
  v70 = v18;
  obj = v18;
  v19 = [obj countByEnumeratingWithState:&v91 objects:v99 count:16];
  v79 = v6;
  if (!v19)
  {
    goto LABEL_41;
  }

  v20 = 1;
  v80 = *v92;
  while (2)
  {
    v81 = v19;
    v21 = 0;
    v72 = v20 + v19;
    v22 = -v20;
    do
    {
      if (*v92 != v80)
      {
        objc_enumerationMutation(obj);
      }

      v23 = *(*(&v91 + 1) + 8 * v21);
      v24 = objc_autoreleasePoolPush();
      v25 = v20 / 0x64;
      context = v24;
      if (v22 == -100 * (v20 / 0x64))
      {
        v26 = v24;
        if ([v6 hasChanges])
        {
          v90 = v78;
          v27 = [v6 save:&v90];
          v28 = v90;

          if ((v27 & 1) == 0)
          {
            v46 = PLMigrationGetLog();
            if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
            {
              *buf = 67109378;
              *v98 = v25;
              *&v98[4] = 2112;
              *&v98[6] = v28;
              _os_log_impl(&dword_19BF1F000, v46, OS_LOG_TYPE_ERROR, "Unable to save moc while cleaning database [batch %d]. (%@)", buf, 0x12u);
            }

            objc_autoreleasePoolPop(v26);
            v78 = v28;
            goto LABEL_41;
          }

          v78 = v28;
        }
      }

      v29 = [v23 objectForKey:@"objectID"];
      v30 = [v23 objectForKey:@"uuid"];
      v31 = [v23 objectForKey:@"directory"];
      v32 = [v23 objectForKey:@"filename"];
      v33 = [v31 stringByAppendingPathComponent:v32];
      v34 = [v33 uppercaseString];

      if ([v34 length])
      {
        v35 = v81;
        if (!v30)
        {
          v6 = v79;
          v39 = [v79 existingObjectWithID:v29 error:0];
          v40 = v39;
          if (v39 && ([v39 isDeleted] & 1) == 0)
          {
            v41 = [MEMORY[0x1E69BF320] UUIDString];
            [v40 setUuid:v41];

            [v40 persistMetadataToFilesystem];
          }

          goto LABEL_26;
        }

        v36 = [v76 objectForKey:v34];

        v6 = v79;
        if (v36)
        {
          [v75 addObject:v29];
          goto LABEL_33;
        }

        if (![v74 containsObject:v30])
        {
          goto LABEL_32;
        }

        v42 = [v79 existingObjectWithID:v29 error:0];
        v43 = v42;
        if (!v42 || [v42 isDeleted])
        {

LABEL_26:
          v30 = 0;
          goto LABEL_33;
        }

        v44 = [MEMORY[0x1E69BF320] UUIDString];

        [v43 setUuid:v44];
        [v43 persistMetadataToFilesystem];

        v30 = v44;
        if (v44)
        {
LABEL_32:
          [v76 setObject:v30 forKey:v34];
          [v74 addObject:v30];
          [v73 setObject:v29 forKey:v30];
        }
      }

      else
      {
        [MEMORY[0x1E69BF328] maskForCanDeleteEmptyPathForCorruptAssetsDuringFilesystemImport];
        v37 = [v23 objectForKey:@"savedAssetType"];
        [v37 intValue];
        v38 = PLValidatedSavedAssetTypeApplies();

        v35 = v81;
        if (v38)
        {
          [v75 addObject:v29];
        }

        v6 = v79;
      }

LABEL_33:

      objc_autoreleasePoolPop(context);
      ++v21;
      --v22;
      ++v20;
    }

    while (v35 != v21);
    v19 = [obj countByEnumeratingWithState:&v91 objects:v99 count:16];
    v20 = v72;
    if (v19)
    {
      continue;
    }

    break;
  }

LABEL_41:

  if ([v6 hasChanges])
  {
    v89 = v78;
    v47 = [v6 save:&v89];
    v48 = v89;

    v5 = v69;
    v49 = v75;
    if ((v47 & 1) == 0)
    {
      v50 = PLMigrationGetLog();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        *v98 = v48;
        _os_log_impl(&dword_19BF1F000, v50, OS_LOG_TYPE_ERROR, "Unable to save moc while cleaning database [pre-delete]. (%@)", buf, 0xCu);
      }
    }

    v18 = v70;
  }

  else
  {
    v48 = v78;
    v5 = v69;
    v18 = v70;
    v49 = v75;
  }

  v45 = v74;
  [v5 setExistingUUIDs:v74];
  [v5 setExistingUUIDsByUppercasePath:v76];
  [v5 setExistingOIDsByUUID:v73];
  if ([v49 count])
  {
    v51 = objc_autoreleasePoolPush();
    v52 = MEMORY[0x1E695D5E0];
    v53 = +[PLManagedAsset entityName];
    v54 = [v52 fetchRequestWithEntityName:v53];

    v55 = [MEMORY[0x1E696AE18] predicateWithFormat:@"self IN %@", v49];
    [v54 setPredicate:v55];

    v88 = v48;
    v56 = [v6 executeFetchRequest:v54 error:&v88];
    v57 = v88;

    v11 = v68;
    if (v56)
    {
      if ([v56 count])
      {
        v58 = PLMigrationGetLog();
        if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
        {
          v59 = [v56 count];
          *buf = 134217984;
          *v98 = v59;
          _os_log_impl(&dword_19BF1F000, v58, OS_LOG_TYPE_ERROR, "Removing %lu corrupt assets from the database", buf, 0xCu);
        }

        v86 = 0u;
        v87 = 0u;
        v84 = 0u;
        v85 = 0u;
        v60 = v56;
        v61 = [v60 countByEnumeratingWithState:&v84 objects:v96 count:16];
        if (v61)
        {
          v62 = v61;
          v63 = *v85;
          do
          {
            for (i = 0; i != v62; ++i)
            {
              if (*v85 != v63)
              {
                objc_enumerationMutation(v60);
              }

              [*(*(&v84 + 1) + 8 * i) deleteFromDatabaseOnly];
            }

            v62 = [v60 countByEnumeratingWithState:&v84 objects:v96 count:16];
          }

          while (v62);
          v6 = v79;
        }

        goto LABEL_64;
      }
    }

    else
    {
      v60 = PLMigrationGetLog();
      if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        *v98 = v57;
        _os_log_impl(&dword_19BF1F000, v60, OS_LOG_TYPE_ERROR, "Unable to fetch assets to delete. (%@)", buf, 0xCu);
      }

LABEL_64:
    }

    objc_autoreleasePoolPop(v51);
    v18 = v70;
    v45 = v74;
  }

  else
  {
    v57 = v48;
    v11 = v68;
  }

  if ([v6 hasChanges])
  {
    v83 = v57;
    v65 = [v6 save:&v83];
    v78 = v83;

    if (v65)
    {
      v15 = v67;
    }

    else
    {
      v66 = PLMigrationGetLog();
      v15 = v67;
      if (os_log_type_enabled(v66, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        *v98 = v78;
        _os_log_impl(&dword_19BF1F000, v66, OS_LOG_TYPE_ERROR, "Unable to save moc while cleaning database [delete]. (%@)", buf, 0xCu);
      }
    }

    v45 = v74;
  }

  else
  {
    v78 = v57;
    v15 = v67;
  }

LABEL_75:
  objc_autoreleasePoolPop(v11);
LABEL_76:
}

- (id)_syncedPropertiesForAssetUUID:(id)a3
{
  v4 = a3;
  syncedPropertiesByUUID = self->_syncedPropertiesByUUID;
  if (!syncedPropertiesByUUID)
  {
    v6 = [(PLModelMigrator *)self _newSyncedPropertiesByAssetUUIDs:0];
    v7 = self->_syncedPropertiesByUUID;
    self->_syncedPropertiesByUUID = v6;

    syncedPropertiesByUUID = self->_syncedPropertiesByUUID;
  }

  v8 = [(NSDictionary *)syncedPropertiesByUUID objectForKey:v4];

  return v8;
}

- (void)_applySyncedProperties:(id)a3 toAsset:(id)a4
{
  v24 = a3;
  v6 = a4;
  if ([v24 count])
  {
    v7 = [v24 objectForKey:@"exposureDate"];
    if (v7 || ([v24 objectForKey:@"modificationDate"], (v7 = objc_claimAutoreleasedReturnValue()) != 0))
    {
      v8 = v7;
      [v7 doubleValue];
      v9 = [(PLModelMigrator *)self _dateWithiTunesTimeInterval:?];
      [v6 setDateCreated:v9];
      v10 = [v6 dateCreated];
      [v10 timeIntervalSinceReferenceDate];
      [v6 setSortToken:?];
    }

    v11 = [v24 objectForKey:@"modificationDate"];
    v12 = v11;
    if (v11)
    {
      [v11 doubleValue];
      v13 = [(PLModelMigrator *)self _dateWithiTunesTimeInterval:?];
      [v6 setModificationDate:v13];
    }

    v14 = [v24 objectForKey:@"originalFileName"];
    if (v14)
    {
      [v6 setOriginalFilename:v14];
    }

    latitude = *MEMORY[0x1E6985CC0];
    longitude = *(MEMORY[0x1E6985CC0] + 8);
    v17 = [v24 objectForKey:@"latitude"];
    v18 = [v24 objectForKey:@"longitude"];
    if (v18 && v17)
    {
      [v17 doubleValue];
      v20 = v19;
      [v18 doubleValue];
      v22 = CLLocationCoordinate2DMake(v20, v21);
      latitude = v22.latitude;
      longitude = v22.longitude;
    }

    if ([PLLocationUtils canUseCoordinate:latitude, longitude])
    {
      v23 = [objc_alloc(MEMORY[0x1E6985C40]) initWithLatitude:latitude longitude:longitude];
      [v6 setLocation:v23];
    }

    else
    {
      [v6 setLocation:0];
    }
  }
}

- (id)_newSyncedPropertiesByAssetUUIDs:(BOOL)a3
{
  v3 = a3;
  v37 = *MEMORY[0x1E69E9840];
  v5 = objc_autoreleasePoolPush();
  v6 = [(PLModelMigrator *)self _iTunesPhotosLastSyncMetadata];
  v7 = [v6 objectForKey:@"updates"];
  v29 = v7;
  if (![v7 count])
  {
    goto LABEL_14;
  }

  v26 = v3;
  v27 = self;
  v28 = v5;
  v30 = [objc_alloc(MEMORY[0x1E695DF90]) initWithCapacity:{objc_msgSend(v7, "count")}];
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v35 = 0u;
  v8 = v7;
  v9 = [v8 countByEnumeratingWithState:&v32 objects:v36 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v33;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v33 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v32 + 1) + 8 * i);
        v14 = [v13 objectForKey:@"itemType"];
        if ([v14 isEqual:@"Asset"])
        {
          v15 = [v13 objectForKey:@"uuid"];
          if (v15)
          {
            [v30 setObject:v13 forKey:v15];
          }
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v32 objects:v36 count:16];
    }

    while (v10);
  }

  v16 = v30;
  v17 = v16;
  v5 = v28;
  v7 = v29;
  self = v27;
  v3 = v26;
  if (!v16)
  {
LABEL_14:
    v17 = objc_opt_new();
    v16 = 0;
  }

  if (v6 && [v6 count] && v3)
  {
    v18 = [(PLModelMigrator *)self pathManager];
    v19 = [v18 syncInfoPath];

    v20 = [MEMORY[0x1E696AC08] defaultManager];
    if ([v20 fileExistsAtPath:v19])
    {
      v31 = 0;
      [v20 removeItemAtPath:v19 error:&v31];
    }

    v21 = [MEMORY[0x1E695DF90] dictionary];
    v22 = [v6 objectForKey:@"iTunesUserAgent"];
    if (v22)
    {
      [v21 setObject:v22 forKey:@"userAgent"];
    }

    v23 = [v6 objectForKey:@"libraryKind"];
    if (v23)
    {
      [v21 setObject:v23 forKey:@"libraryKind"];
    }

    v24 = [MEMORY[0x1E696AE40] dataWithPropertyList:v21 format:100 options:0 error:0];
    [v24 writeToFile:v19 options:1073741825 error:0];

    v7 = v29;
  }

  objc_autoreleasePoolPop(v5);
  return v17;
}

- (void)_importAfterCrash:(id)a3 completionBlock:(id)a4
{
  v34 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  v8 = [MEMORY[0x1E69BF360] transaction:"-[PLModelMigrator _importAfterCrash:completionBlock:]"];
  v9 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator _importAfterCrash:completionBlock:]"];
  v10 = [MEMORY[0x1E695DF70] array];
  v11 = PLMigrationGetLog();
  v12 = os_signpost_id_generate(v11);
  v13 = v11;
  v14 = v13;
  if (v12 - 1 <= 0xFFFFFFFFFFFFFFFDLL && os_signpost_enabled(v13))
  {
    *buf = 134217984;
    v33 = [v6 count];
    _os_signpost_emit_with_name_impl(&dword_19BF1F000, v14, OS_SIGNPOST_INTERVAL_BEGIN, v12, "ImportAfterCrash", "fileURLs count: %lu", buf, 0xCu);
  }

  v27[0] = MEMORY[0x1E69E9820];
  v27[1] = 3221225472;
  v27[2] = __53__PLModelMigrator__importAfterCrash_completionBlock___block_invoke;
  v27[3] = &unk_1E7578100;
  v28 = v6;
  v29 = self;
  v30 = v9;
  v31 = v10;
  v21[0] = MEMORY[0x1E69E9820];
  v21[1] = 3221225472;
  v21[2] = __53__PLModelMigrator__importAfterCrash_completionBlock___block_invoke_3;
  v21[3] = &unk_1E7576190;
  v22 = v31;
  v23 = v8;
  v24 = v14;
  v25 = v7;
  v26 = v12;
  v15 = v14;
  v16 = v8;
  v17 = v31;
  v18 = v7;
  v19 = v9;
  v20 = v6;
  [v19 performTransaction:v27 completionHandler:v21];
}

void __53__PLModelMigrator__importAfterCrash_completionBlock___block_invoke(uint64_t a1)
{
  if ([*(a1 + 32) count])
  {
    v7 = [MEMORY[0x1E695DF70] arrayWithCapacity:{objc_msgSend(*(a1 + 32), "count")}];
    v3 = *(a1 + 32);
    v2 = *(a1 + 40);
    v4 = v2[1];
    v5 = [v2 pathManager];
    [PLRebuildableDirectory collectFileURLs:v3 urlsToSkip:0 forAddingToAlbum:0 intoAssetsArray:v7 assetsKind:0 testCreationDates:0 startTime:v4 pathManager:v5];

    [v7 sortUsingComparator:&__block_literal_global_382];
    v6 = [*(a1 + 40) _importFileSystemImportAssets:v7 intoLibrary:*(a1 + 48) type:2 progress:0];
    [*(a1 + 56) addObjectsFromArray:v6];
  }
}

void __53__PLModelMigrator__importAfterCrash_completionBlock___block_invoke_3(uint64_t a1)
{
  v2 = *(a1 + 56);
  if (v2)
  {
    (*(v2 + 16))(v2, *(a1 + 32));
  }

  [*(a1 + 40) stillAlive];
  v3 = *(a1 + 48);
  v4 = v3;
  v5 = *(a1 + 64);
  if (v5 - 1 <= 0xFFFFFFFFFFFFFFFDLL && os_signpost_enabled(v3))
  {
    *v6 = 0;
    _os_signpost_emit_with_name_impl(&dword_19BF1F000, v4, OS_SIGNPOST_INTERVAL_END, v5, "ImportAfterCrash", "", v6, 2u);
  }
}

- (void)_importAllDCIMAssetsInLibrary:(id)a3 progress:(id)a4 progressFraction:(id)a5 rebuildComplete:(BOOL)a6
{
  v6 = a6;
  v53 = *MEMORY[0x1E69E9840];
  v10 = a3;
  v11 = a4;
  v12 = a5;
  v13 = [v10 libraryServicesManager];
  v14 = [v13 wellKnownPhotoLibraryIdentifier];

  if (v14 == 3)
  {
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "_importAllDCIMAssetsInLibrary is unsupported for the syndication photo library", buf, 2u);
    }

    [v12 progressFractionForType:2];
    [v11 setCompletedUnitCount:{(v16 * objc_msgSend(v11, "totalUnitCount"))}];
  }

  else
  {
    context = objc_autoreleasePoolPush();
    [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
    v18 = v17;
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      [MEMORY[0x1E696AF00] callStackSymbols];
      v20 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
      *buf = 138412290;
      v52 = v20;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_DEFAULT, "Beginning file system import %@", buf, 0xCu);
    }

    v21 = [(PLModelMigrator *)self pathManager];
    if ([v21 isUBF])
    {
      [(PLModelMigrator *)self _orderedAssetsToImportInLibrary:v10];
    }

    else
    {
      [(PLModelMigrator *)self _orderedAssetsToImportInLibrary:v10 cameraRollOnly:0];
    }
    v48 = ;

    v50 = 0;
    v49 = 0;
    v22 = pthread_self();
    pthread_getschedparam(v22, &v49, &v50);
    HIDWORD(v44) = v50.sched_priority;
    v50.sched_priority /= 2;
    v23 = pthread_self();
    pthread_setschedparam(v23, v49, &v50);
    v24 = getpid();
    [v48 count];
    proc_set_cpumon_params();
    LODWORD(v44) = v24;
    [v12 progressFractionForType:{2, v44}];
    v26 = v25;
    v27 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:100 parent:v11 pendingUnitCount:{(v25 * objc_msgSend(v11, "totalUnitCount"))}];
    if (v26 == 1.0)
    {
      v28 = 0.75;
    }

    else
    {
      v28 = 0.05;
    }

    v47 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:100 parent:v27 pendingUnitCount:{llroundf(v28 * objc_msgSend(v11, "totalUnitCount"))}];
    if (v6)
    {
      v29 = [v10 globalValues];
      v30 = [v29 importFilesystemAssetsState] == -1;
    }

    else
    {
      v30 = 0;
    }

    v31 = [(PLModelMigrator *)self _importFileSystemImportAssets:v48 intoLibrary:v10 type:v30 progress:v47];
    v32 = [(PLModelMigrator *)self analyticsEventManager];
    v33 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v31, "count")}];
    [v32 setPayloadValue:v33 forKey:*MEMORY[0x1E69BF758] onEventWithName:*MEMORY[0x1E69BF740]];

    if ([v12 isLegacyRecoveryEnabled])
    {
      [(PLModelMigrator *)self filesystemImportResultsUpdateKeywordWithImportedAssets:v31];
    }

    if (!v6)
    {
      v34 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:100 parent:v27 pendingUnitCount:{llround((1.0 - v28) * objc_msgSend(v11, "totalUnitCount"))}];
      v35 = [(PLModelMigrator *)self pathManager];
      v36 = [PLRebuildJournalManager isEnabledWithPathManager:v35 error:0];

      if (v36)
      {
        v37 = [v10 libraryServicesManager];
        v38 = [v37 rebuildJournalManager];
        v39 = [v10 managedObjectContext];
        [v38 recreateNonAssetsInManagedObjectContext:v39 progress:v34];
      }

      else
      {
        [v10 recreateAlbumsAndPersonsFromMetadata];
        [v34 setCompletedUnitCount:{objc_msgSend(v34, "totalUnitCount")}];
      }
    }

    v40 = PLMigrationGetLog();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
      *buf = 134217984;
      v52 = v41 - v18;
      _os_log_impl(&dword_19BF1F000, v40, OS_LOG_TYPE_DEFAULT, "Migration took %1.1fs", buf, 0xCu);
    }

    [v10 cleanupAfterImportAllDCIMAssets];
    v42 = PLMigrationGetLog();
    if (os_log_type_enabled(v42, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v42, OS_LOG_TYPE_DEFAULT, "Finished file system import", buf, 2u);
    }

    proc_set_cpumon_defaults();
    v50.sched_priority = v45;
    v43 = pthread_self();
    pthread_setschedparam(v43, v49, &v50);

    objc_autoreleasePoolPop(context);
  }
}

- (void)_rebuildAssetsFromJournal:(id)a3 inLibrary:(id)a4 progress:(id)a5 progressFraction:(id)a6
{
  v32 = *MEMORY[0x1E69E9840];
  v9 = a3;
  v10 = a4;
  v11 = a5;
  v12 = a6;
  [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
  v14 = v13;
  v15 = PLMigrationGetLog();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
  {
    [MEMORY[0x1E696AF00] callStackSymbols];
    v16 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    *buf = 138412290;
    v31 = v16;
    _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_DEFAULT, "Asset journal rebuild started: %@", buf, 0xCu);
  }

  v29 = 0;
  v28 = 0;
  v17 = pthread_self();
  pthread_getschedparam(v17, &v28, &v29);
  sched_priority = v29.sched_priority;
  v29.sched_priority /= 2;
  v19 = pthread_self();
  pthread_setschedparam(v19, v28, &v29);
  v20 = MEMORY[0x1E696AE38];
  v21 = [v11 totalUnitCount];
  [v12 progressFractionForType:0];
  v23 = [v20 progressWithTotalUnitCount:100 parent:v11 pendingUnitCount:llroundf(v22 * v21)];
  v24 = [v10 managedObjectContext];
  [v9 recreateAssetsInManagedObjectContext:v24 options:0 progress:v23];

  v25 = PLMigrationGetLog();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
  {
    [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
    *buf = 134217984;
    v31 = v26 - v14;
    _os_log_impl(&dword_19BF1F000, v25, OS_LOG_TYPE_DEFAULT, "Asset journal rebuild finished, duration: %1.1fs", buf, 0xCu);
  }

  v29.sched_priority = sched_priority;
  v27 = pthread_self();
  pthread_setschedparam(v27, v28, &v29);
}

- (id)_orderedAssetsToImportInLibrary:(id)a3 cameraRollOnly:(BOOL)a4
{
  v4 = a4;
  v66 = *MEMORY[0x1E69E9840];
  v7 = a3;
  if (([(PLPhotoLibraryPathManager *)self->_pathManager isDCIM]& 1) == 0)
  {
    v42 = [MEMORY[0x1E696AAA8] currentHandler];
    [v42 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:2303 description:@"Expected DCIM library"];
  }

  v8 = [MEMORY[0x1E695DF70] array];
  v9 = objc_alloc_init(MEMORY[0x1E695DFA8]);
  v63 = [v8 count];
  v52 = objc_alloc_init(MEMORY[0x1E696AC08]);
  [(PLModelMigrator *)self setFileManager:?];
  v10 = MEMORY[0x1E695DFF8];
  v11 = [(PLPhotoLibraryPathManager *)self->_pathManager photoDirectoryWithType:1];
  v12 = [v10 fileURLWithPath:v11 isDirectory:1];

  v13 = [v12 URLByAppendingPathComponent:@"PhotoData"];
  v51 = [v13 URLByAppendingPathComponent:@"CPLAssets"];
  v50 = [v12 URLByAppendingPathComponent:*MEMORY[0x1E69BFF38]];
  v53 = [v13 URLByAppendingPathComponent:@"Locked"];
  v14 = v12;
  v15 = objc_alloc_init(MEMORY[0x1E695DF70]);
  v49 = [v14 URLByAppendingPathComponent:*MEMORY[0x1E69BFCE0]];
  v16 = [PLRebuildableDirectory rebuildableDirectoryWithURL:"rebuildableDirectoryWithURL:isCPLAssets:isPhotoStream:photoLibrary:startTime:" isCPLAssets:self->_startTime isPhotoStream:? photoLibrary:? startTime:?];
  if (v16)
  {
    [v15 addObject:v16];
  }

  v48 = v16;
  v54 = self;
  if (!v4)
  {
    v46 = v13;
    v45 = [v13 URLByAppendingPathComponent:@"Sync"];
    v17 = [PLRebuildableDirectory rebuildableDirectoryWithURL:"rebuildableDirectoryWithURL:isCPLAssets:isPhotoStream:photoLibrary:startTime:" isCPLAssets:self->_startTime isPhotoStream:? photoLibrary:? startTime:?];
    if (v17)
    {
      [v15 addObject:v17];
    }

    v44 = v17;
    v47 = v14;
    v18 = v7;
    v19 = [PLRebuildableDirectory rebuildableDirectoryWithURL:v51 isCPLAssets:1 isPhotoStream:0 photoLibrary:v7 startTime:self->_startTime];
    if (v19)
    {
      [v15 addObject:v19];
    }

    v61 = 0u;
    v62 = 0u;
    v59 = 0u;
    v60 = 0u;
    v20 = [v52 enumeratorAtURL:v50 includingPropertiesForKeys:0 options:0 errorHandler:{&__block_literal_global_372_22358, v19}];
    v21 = [v20 countByEnumeratingWithState:&v59 objects:v65 count:16];
    if (v21)
    {
      v22 = v21;
      v23 = *v60;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v60 != v23)
          {
            objc_enumerationMutation(v20);
          }

          v25 = [PLRebuildableDirectory rebuildableDirectoryWithURL:*(*(&v59 + 1) + 8 * i) isCPLAssets:0 isPhotoStream:1 photoLibrary:v18 startTime:v54->_startTime];
          if (v25)
          {
            [v15 addObject:v25];
          }
        }

        v22 = [v20 countByEnumeratingWithState:&v59 objects:v65 count:16];
      }

      while (v22);
    }

    v26 = [v53 URLByAppendingPathComponent:@"CPLAssets"];
    v27 = [PLRebuildableDirectory rebuildableDirectoryWithURL:v26 isCPLAssets:1 isPhotoStream:0 photoLibrary:v18 startTime:v54->_startTime];
    if (v27)
    {
      [v15 addObject:v27];
    }

    v28 = [v53 URLByAppendingPathComponent:@"DCIM"];
    v29 = [PLRebuildableDirectory rebuildableDirectoryWithURL:v28 isCPLAssets:0 isPhotoStream:0 photoLibrary:v18 startTime:v54->_startTime];
    if (v29)
    {
      [v15 addObject:v29];
    }

    v7 = v18;
    v13 = v46;
    v14 = v47;
  }

  v57 = 0u;
  v58 = 0u;
  v55 = 0u;
  v56 = 0u;
  v30 = v15;
  v31 = [v30 countByEnumeratingWithState:&v55 objects:v64 count:16];
  if (v31)
  {
    v32 = v31;
    v33 = *v56;
    do
    {
      for (j = 0; j != v32; ++j)
      {
        if (*v56 != v33)
        {
          objc_enumerationMutation(v30);
        }

        [*(*(&v55 + 1) + 8 * j) gatherAssetsToImport:v8 pendingAssetsCount:&v63 onDiskURLsToSkip:v9 cameraRollOnly:v4];
      }

      v32 = [v30 countByEnumeratingWithState:&v55 objects:v64 count:16];
    }

    while (v32);
  }

  [(PLModelMigrator *)v54 _addUBFBundleScopedOrderedAssetsToImport:v8 onDiskURLsToSkip:v9];
  if (!v4)
  {
    v35 = [v7 filesystemImportProgressAlbum];
    v36 = [v7 globalValues];
    v37 = v13;
    v38 = [v36 isRebuildComplete];

    v39 = v38 == 0;
    v13 = v37;
    if (v39)
    {
      v40 = 24;
    }

    else
    {
      v40 = 8;
    }

    [v35 setPendingItemsType:v40];
    [v35 setPendingItemsCount:v63];
  }

  [v8 sortUsingComparator:&__block_literal_global_378];

  return v8;
}

uint64_t __66__PLModelMigrator__orderedAssetsToImportInLibrary_cameraRollOnly___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v13 = *MEMORY[0x1E69E9840];
  v4 = a2;
  v5 = a3;
  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = [v4 path];
    v9 = 138412546;
    v10 = v7;
    v11 = 2112;
    v12 = v5;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "Unable to enumerate '%@': %@", &v9, 0x16u);
  }

  return 1;
}

- (id)_orderedAssetsToImportInLibrary:(id)a3
{
  v4 = MEMORY[0x1E695DF70];
  v5 = a3;
  v6 = [v4 array];
  v7 = objc_alloc_init(MEMORY[0x1E695DFA8]);
  v8 = objc_alloc_init(MEMORY[0x1E696AC08]);
  [(PLModelMigrator *)self setFileManager:v8];
  [(PLModelMigrator *)self _addUBFBundleScopedOrderedAssetsToImport:v6 onDiskURLsToSkip:v7];
  v9 = [v5 filesystemImportProgressAlbum];
  v10 = [v5 globalValues];

  LODWORD(v5) = [v10 isRebuildComplete];
  if (v5)
  {
    v11 = 8;
  }

  else
  {
    v11 = 24;
  }

  [v9 setPendingItemsType:v11];
  [v9 setPendingItemsCount:{objc_msgSend(v6, "count")}];
  [v6 sortUsingComparator:&__block_literal_global_355_22367];

  return v6;
}

- (void)_addUBFBundleScopedOrderedAssetsToImport:(id)a3 onDiskURLsToSkip:(id)a4
{
  v6 = a3;
  v7 = a4;
  pathManager = self->_pathManager;
  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = __77__PLModelMigrator__addUBFBundleScopedOrderedAssetsToImport_onDiskURLsToSkip___block_invoke;
  v11[3] = &unk_1E7568C50;
  v11[4] = self;
  v12 = v7;
  v13 = v6;
  v9 = v6;
  v10 = v7;
  [(PLPhotoLibraryPathManager *)pathManager enumerateBundleScopesWithBlock:v11];
}

void __77__PLModelMigrator__addUBFBundleScopedOrderedAssetsToImport_onDiskURLsToSkip___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3, void *a4)
{
  v12 = a4;
  if ([MEMORY[0x1E69BF2A0] bundleScopeShouldBePersistedForRebuild:a2])
  {
    v6 = MEMORY[0x1E695DFF8];
    v7 = [v12 photoDirectoryWithType:4];
    v8 = [v6 fileURLWithPath:v7 isDirectory:1];

    v9 = [MEMORY[0x1E695DEC8] arrayWithObjects:{*MEMORY[0x1E695DC30], *MEMORY[0x1E695DAA8], *MEMORY[0x1E695DB78], 0}];
    v10 = [*(a1 + 32) fileManager];
    v11 = [v10 enumeratorAtURL:v8 includingPropertiesForKeys:v9 options:0 errorHandler:&__block_literal_global_351];

    [PLRebuildableDirectory collectFileURLs:v11 urlsToSkip:*(a1 + 40) forAddingToAlbum:0 intoAssetsArray:*(a1 + 48) assetsKind:0 testCreationDates:1 startTime:*(*(a1 + 32) + 8) pathManager:v12];
  }
}

- (void)dontImportFileSystemDataIntoDatabaseWithPhotoLibrary:(id)a3
{
  v4 = a3;
  v8 = v4;
  if (v4)
  {
    v5 = v4;
  }

  else
  {
    v5 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator dontImportFileSystemDataIntoDatabaseWithPhotoLibrary:]"];
  }

  v6 = v5;
  v7 = [v5 globalValues];
  [v7 dontImportFileSystemDataIntoDatabase];
}

- (void)_repairPotentialModelCorruptionInLibrary:(id)a3
{
  v12 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = v4;
  if (v4)
  {
    v7[0] = MEMORY[0x1E69E9820];
    v7[1] = 3221225472;
    v7[2] = __60__PLModelMigrator__repairPotentialModelCorruptionInLibrary___block_invoke;
    v7[3] = &unk_1E7578848;
    v8 = v4;
    v9 = self;
    [v8 performTransactionAndWait:v7];
    v6 = v8;
  }

  else
  {
    v6 = PLMigrationGetLog();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446210;
      v11 = "[PLModelMigrator _repairPotentialModelCorruptionInLibrary:]";
      _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_ERROR, "%{public}s can't access photoLibrary: <rdar://problem/39763084>", buf, 0xCu);
    }
  }
}

void __60__PLModelMigrator__repairPotentialModelCorruptionInLibrary___block_invoke(uint64_t a1)
{
  v101[5] = *MEMORY[0x1E69E9840];
  v52 = objc_alloc_init(MEMORY[0x1E695D5C8]);
  [v52 setName:@"objectID"];
  v1 = [MEMORY[0x1E696ABC8] expressionForEvaluatedObject];
  [v52 setExpression:v1];

  [v52 setExpressionResultType:2000];
  v56 = [*(a1 + 32) managedObjectContext];
  v2 = MEMORY[0x1E695D5E0];
  v3 = +[PLManagedAsset entityName];
  v53 = [v2 fetchRequestWithEntityName:v3];

  v101[0] = @"directory";
  v101[1] = @"filename";
  v101[2] = @"uuid";
  v101[3] = @"savedAssetType";
  v101[4] = v52;
  v4 = [MEMORY[0x1E695DEC8] arrayWithObjects:v101 count:5];
  [v53 setPropertiesToFetch:v4];

  [v53 setResultType:2];
  v5 = [MEMORY[0x1E695DFA8] set];
  v6 = [MEMORY[0x1E695DFA8] set];
  v7 = [MEMORY[0x1E695DFA8] set];
  v8 = [MEMORY[0x1E695DFA8] set];
  v90 = 0;
  v91 = &v90;
  v92 = 0x2020000000;
  v93 = 0;
  v86 = 0;
  v87 = &v86;
  v88 = 0x2020000000;
  v89 = 0;
  v82 = 0;
  v83 = &v82;
  v84 = 0x2020000000;
  v85 = 0;
  v73[0] = MEMORY[0x1E69E9820];
  v73[1] = 3221225472;
  v73[2] = __60__PLModelMigrator__repairPotentialModelCorruptionInLibrary___block_invoke_2;
  v73[3] = &unk_1E7568C28;
  v74 = @"objectID";
  v48 = v5;
  v75 = v48;
  v79 = &v82;
  v80 = &v86;
  v49 = v6;
  v76 = v49;
  v9 = v7;
  v77 = v9;
  v81 = &v90;
  v50 = v8;
  v78 = v50;
  v10 = [v56 enumerateObjectsFromFetchRequest:v53 count:0 usingDefaultBatchSizeWithBlock:v73];
  if ([v9 count])
  {
    [*(a1 + 40) removeUnpairedTimelapsePreviewsInContext:v56 fromDuplicatedUUIDs:v9];
    if (![v9 count])
    {
      v11 = PLMigrationGetLog();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 136446210;
        v97 = "[PLModelMigrator _repairPotentialModelCorruptionInLibrary:]_block_invoke";
        _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "%{public}s deleted all unpaired timelapse video previews, resolved UUID corruption", buf, 0xCu);
      }

      *(v91 + 24) = 0;
    }
  }

  v71 = 0u;
  v72 = 0u;
  v69 = 0u;
  v70 = 0u;
  obj = v9;
  v12 = [obj countByEnumeratingWithState:&v69 objects:v100 count:16];
  if (v12)
  {
    v55 = *v70;
    do
    {
      v57 = v12;
      for (i = 0; i != v57; ++i)
      {
        if (*v70 != v55)
        {
          objc_enumerationMutation(obj);
        }

        v14 = *(*(&v69 + 1) + 8 * i);
        v15 = MEMORY[0x1E695D5E0];
        v16 = +[PLManagedAsset entityName];
        v17 = [v15 fetchRequestWithEntityName:v16];

        v18 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K == %@", @"uuid", v14];
        [v17 setPredicate:v18];

        [v17 setFetchBatchSize:100];
        v68 = 0;
        v19 = [v56 executeFetchRequest:v17 error:&v68];
        v58 = v68;
        if ([v19 count] > 1)
        {
          v66 = 0u;
          v67 = 0u;
          v64 = 0u;
          v65 = 0u;
          v20 = v19;
          v21 = [v20 countByEnumeratingWithState:&v64 objects:v95 count:16];
          if (v21)
          {
            v22 = *v65;
            do
            {
              for (j = 0; j != v21; ++j)
              {
                if (*v65 != v22)
                {
                  objc_enumerationMutation(v20);
                }

                v24 = *(*(&v64 + 1) + 8 * j);
                v25 = [MEMORY[0x1E69BF320] UUIDString];
                [v24 setUuid:v25];
                [v24 setCloudAssetGUID:0];
                [v24 persistMetadataToFilesystem];
              }

              v21 = [v20 countByEnumeratingWithState:&v64 objects:v95 count:16];
            }

            while (v21);
          }
        }

        else
        {
          v20 = PLMigrationGetLog();
          if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
          {
            *buf = 138543618;
            v97 = v14;
            v98 = 2112;
            v99 = v58;
            _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "Didn't find multiple assets for duplicated UUID during data migration: %{public}@ error: %@", buf, 0x16u);
          }
        }
      }

      v12 = [obj countByEnumeratingWithState:&v69 objects:v100 count:16];
    }

    while (v12);
  }

  if ([v50 count])
  {
    v26 = MEMORY[0x1E695D5E0];
    v27 = +[PLManagedAsset entityName];
    v28 = [v26 fetchRequestWithEntityName:v27];

    v29 = [MEMORY[0x1E696AE18] predicateWithFormat:@"SELF in %@", v50];
    [v28 setPredicate:v29];

    v63 = 0;
    v30 = [v56 executeFetchRequest:v28 error:&v63];
    v31 = v63;
    if (v30)
    {
      v32 = [v30 count];
      if (v32 == [v50 count])
      {
        v61 = 0u;
        v62 = 0u;
        v59 = 0u;
        v60 = 0u;
        v33 = v30;
        v34 = [v33 countByEnumeratingWithState:&v59 objects:v94 count:16];
        if (v34)
        {
          v35 = *v60;
          do
          {
            for (k = 0; k != v34; ++k)
            {
              if (*v60 != v35)
              {
                objc_enumerationMutation(v33);
              }

              v37 = *(*(&v59 + 1) + 8 * k);
              v38 = [MEMORY[0x1E69BF320] UUIDString];
              [v37 setUuid:v38];
              [v37 setCloudAssetGUID:0];
              [v37 persistMetadataToFilesystem];
            }

            v34 = [v33 countByEnumeratingWithState:&v59 objects:v94 count:16];
          }

          while (v34);
        }
      }

      else
      {
        v33 = PLMigrationGetLog();
        if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
        {
          v39 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v30, "count")}];
          v40 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(v50, "count")}];
          *buf = 138412546;
          v97 = v39;
          v98 = 2112;
          v99 = v40;
          _os_log_impl(&dword_19BF1F000, v33, OS_LOG_TYPE_ERROR, "Fetched assets count: %@ objects with missing uuids count: %@", buf, 0x16u);
        }
      }
    }

    else
    {
      v33 = PLMigrationGetLog();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v97 = v31;
        _os_log_impl(&dword_19BF1F000, v33, OS_LOG_TYPE_ERROR, "Error occured during data migration: %@", buf, 0xCu);
      }
    }
  }

  else
  {
    v28 = v53;
  }

  if (*(v91 + 24) == 1)
  {
    v41 = PLMigrationGetLog();
    if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v41, OS_LOG_TYPE_ERROR, "Found duplicate UUIDs in the database during data migration; triggering rebuild!", buf, 2u);
    }

    v42 = [MEMORY[0x1E69BF328] mapSavedAssetType:*(v83 + 12) unknown:6 photoBooth:6 photoStream:14 camera:6 cloudShared:15 cameraConnectionKit:6 cloudPhotoLibrary:6 wallpaper_UNUSED:6 momentShared:6 placeholder:6 referenced:6 alternate:6 guest:6 companionSynced:6 recovered:6 legacyImport:6 collectionShare:6 unrecognized:6];
    v43 = [*(a1 + 40) pathManager];
    [v43 setSqliteErrorForRebuildReason:v42 allowsExit:1];

    v44 = [*(a1 + 32) libraryServicesManager];
    [v44 shutdownLibraryWithDescription:@"duplicate UUIDs found during data migration"];
  }

  else
  {
    if (*(v87 + 24) != 1)
    {
      goto LABEL_51;
    }

    v45 = PLMigrationGetLog();
    if (os_log_type_enabled(v45, OS_LOG_TYPE_FAULT))
    {
      v46 = *(v83 + 12);
      *buf = 67109120;
      LODWORD(v97) = v46;
      _os_log_impl(&dword_19BF1F000, v45, OS_LOG_TYPE_FAULT, "Found duplicate paths for savedAssetType %hd in the database during data migration", buf, 8u);
    }

    [MEMORY[0x1E69BF328] maskForTriggerRebuildForPathCorruptionExclusions];
    if (PLValidatedSavedAssetTypeApplies())
    {
      v44 = PLMigrationGetLog();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v44, OS_LOG_TYPE_ERROR, "Do not trigger rebuild for duplicated paths", buf, 2u);
      }
    }

    else
    {
      v47 = [*(a1 + 40) pathManager];
      [v47 setSqliteErrorForRebuildReason:7 allowsExit:1];

      v44 = [*(a1 + 32) libraryServicesManager];
      [v44 shutdownLibraryWithDescription:@"duplicate paths found during data migration"];
    }
  }

LABEL_51:
  _Block_object_dispose(&v82, 8);
  _Block_object_dispose(&v86, 8);
  _Block_object_dispose(&v90, 8);
}

void __60__PLModelMigrator__repairPotentialModelCorruptionInLibrary___block_invoke_2(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x1E69E9840];
  v3 = a2;
  v4 = [v3 objectForKey:@"directory"];
  v5 = [v3 objectForKey:@"filename"];
  v6 = [v3 objectForKey:*(a1 + 32)];
  v7 = [v3 objectForKey:@"uuid"];
  if ([v4 length] && objc_msgSend(v5, "length"))
  {
    v8 = [v4 stringByAppendingPathComponent:v5];
    if ([*(a1 + 40) containsObject:v8])
    {
      v9 = [v3 objectForKey:@"savedAssetType"];
      *(*(*(a1 + 72) + 8) + 24) = [v9 integerValue];

      *(*(*(a1 + 80) + 8) + 24) = 1;
      v10 = PLMigrationGetLog();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v11 = [MEMORY[0x1E69BF220] descriptionWithPath:v8];
        v12 = *(*(*(a1 + 72) + 8) + 24);
        v20 = 138413058;
        v21 = v11;
        v22 = 2114;
        v23 = v7;
        v24 = 2114;
        v25 = v6;
        v26 = 1024;
        v27 = v12;
        _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "Found duplicate during data migration for path %@), uuid %{public}@, objectID %{public}@, savedAssetType %hd", &v20, 0x26u);
      }
    }

    else
    {
      [*(a1 + 40) addObject:v8];
    }
  }

  if ([*(a1 + 48) containsObject:v7])
  {
    v13 = [v3 objectForKey:@"savedAssetType"];
    *(*(*(a1 + 72) + 8) + 24) = [v13 integerValue];

    [*(a1 + 56) addObject:v7];
    *(*(*(a1 + 88) + 8) + 24) = 1;
    v14 = [v4 stringByAppendingPathComponent:v5];
    v15 = PLMigrationGetLog();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = [MEMORY[0x1E69BF220] descriptionWithPath:v14];
      v17 = *(*(*(a1 + 72) + 8) + 24);
      v20 = 138544130;
      v21 = v7;
      v22 = 2112;
      v23 = v16;
      v24 = 2114;
      v25 = v6;
      v26 = 1024;
      v27 = v17;
      _os_log_impl(&dword_19BF1F000, v15, OS_LOG_TYPE_ERROR, "Found duplicate asset UUID during data migration for uuid: %{public}@, path %@, objectID %{public}@, savedAssetType %hd", &v20, 0x26u);
    }
  }

  else
  {
    if (v7)
    {
      v18 = *(a1 + 48);
      v19 = v7;
    }

    else
    {
      v18 = *(a1 + 64);
      v19 = v6;
    }

    [v18 addObject:v19];
  }
}

- (void)removeUnpairedTimelapsePreviewsInContext:(id)a3 fromDuplicatedUUIDs:(id)a4
{
  v66[2] = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = a4;
  v7 = MEMORY[0x1E695D5E0];
  v8 = +[PLManagedAsset entityName];
  v9 = [v7 fetchRequestWithEntityName:v8];

  v10 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K in %@", @"uuid", v6];
  v11 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K = %d AND %K = %d", @"kind", 1, @"kindSubtype", 102];
  v12 = MEMORY[0x1E696AB28];
  v66[0] = v10;
  v66[1] = v11;
  v13 = [MEMORY[0x1E695DEC8] arrayWithObjects:v66 count:2];
  v14 = [v12 andPredicateWithSubpredicates:v13];
  [v9 setPredicate:v14];

  v15 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"uuid" ascending:1];
  v65[0] = v15;
  v16 = [MEMORY[0x1E696AEB0] sortDescriptorWithKey:@"duration" ascending:1];
  v65[1] = v16;
  v17 = [MEMORY[0x1E695DEC8] arrayWithObjects:v65 count:2];
  [v9 setSortDescriptors:v17];

  v57 = 0;
  v18 = [v5 executeFetchRequest:v9 error:&v57];
  v19 = v57;
  v20 = v19;
  if (v18)
  {
    v42 = v19;
    v44 = v11;
    v45 = v10;
    v46 = v9;
    v47 = v6;
    v48 = v5;
    v21 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v22 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v53 = 0u;
    v54 = 0u;
    v55 = 0u;
    v56 = 0u;
    v43 = v18;
    obj = v18;
    v23 = [obj countByEnumeratingWithState:&v53 objects:v64 count:16];
    if (v23)
    {
      v24 = v23;
      v25 = *v54;
      v26 = v22;
      do
      {
        for (i = 0; i != v24; ++i)
        {
          if (*v54 != v25)
          {
            objc_enumerationMutation(obj);
          }

          v28 = *(*(&v53 + 1) + 8 * i);
          [v28 duration];
          v30 = v29;
          v31 = PLMigrationGetLog();
          v32 = os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT);
          if (v30 == 0.0)
          {
            v33 = v21;
            if (v32)
            {
              v34 = [v28 uuid];
              v35 = [v28 mainFileURL];
              v36 = [v35 path];
              *buf = 136446722;
              v59 = "[PLModelMigrator removeUnpairedTimelapsePreviewsInContext:fromDuplicatedUUIDs:]";
              v60 = 2114;
              v61 = v34;
              v62 = 2112;
              v63 = v36;
              _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_DEFAULT, "%{public}s found zero-duration, unpaired, timelapse preview %{public}@ missing video path %@", buf, 0x20u);

              v22 = v26;
              v33 = v21;
            }
          }

          else
          {
            v33 = v22;
            if (v32)
            {
              v37 = [v28 uuid];
              v38 = [v28 mainFileURL];
              v39 = [v38 path];
              *buf = 136446722;
              v59 = "[PLModelMigrator removeUnpairedTimelapsePreviewsInContext:fromDuplicatedUUIDs:]";
              v60 = 2114;
              v61 = v37;
              v62 = 2112;
              v63 = v39;
              _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_DEFAULT, "%{public}s found unpaired timelapse video %{public}@ with valid path %@", buf, 0x20u);

              v22 = v26;
              v33 = v26;
            }
          }

          v40 = [v28 uuid];
          [v33 setObject:v28 forKeyedSubscript:v40];
        }

        v24 = [obj countByEnumeratingWithState:&v53 objects:v64 count:16];
      }

      while (v24);
    }

    v50[0] = MEMORY[0x1E69E9820];
    v50[1] = 3221225472;
    v50[2] = __80__PLModelMigrator_removeUnpairedTimelapsePreviewsInContext_fromDuplicatedUUIDs___block_invoke;
    v50[3] = &unk_1E7568C00;
    v51 = v21;
    v6 = v47;
    v52 = v47;
    v41 = v21;
    [v22 enumerateKeysAndObjectsUsingBlock:v50];

    v5 = v48;
    v10 = v45;
    v9 = v46;
    v18 = v43;
    v11 = v44;
    v20 = v42;
  }

  else
  {
    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446466;
      v59 = "[PLModelMigrator removeUnpairedTimelapsePreviewsInContext:fromDuplicatedUUIDs:]";
      v60 = 2112;
      v61 = v20;
      _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "%{public}s failed to fetch unpaired timelapse %@", buf, 0x16u);
    }
  }
}

void __80__PLModelMigrator_removeUnpairedTimelapsePreviewsInContext_fromDuplicatedUUIDs___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v20 = *MEMORY[0x1E69E9840];
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) objectForKeyedSubscript:v5];
  if (v7)
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = [v6 objectID];
      v10 = [v6 mainFileURL];
      v11 = [v10 path];
      v12 = 136446978;
      v13 = "[PLModelMigrator removeUnpairedTimelapsePreviewsInContext:fromDuplicatedUUIDs:]_block_invoke";
      v14 = 2114;
      v15 = v5;
      v16 = 2114;
      v17 = v9;
      v18 = 2112;
      v19 = v11;
      _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "%{public}s deleting unpaired, timelapse preview %{public}@ -> final video %{public}@ with path %@", &v12, 0x2Au);
    }

    [v7 deleteFromDatabaseOnly];
    [*(a1 + 40) removeObject:v5];
  }
}

- (void)cleanupModelForDataMigrationForRestoreType:(int64_t)a3
{
  v29 = *MEMORY[0x1E69E9840];
  v5 = PLMigrationGetLog();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    if ((a3 - 1) > 2)
    {
      v6 = @"none";
    }

    else
    {
      v6 = off_1E7573E80[a3 - 1];
    }

    v7 = v6;
    qos_class_self();
    v8 = PLStringFromQoSClass();
    *buf = 138543618;
    v26 = v7;
    v27 = 2114;
    v28 = v8;
    _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_DEFAULT, "Clean up model after data migration for restore type %{public}@ at QoS: %{public}@", buf, 0x16u);
  }

  v9 = PLMigrationGetLog();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Data migrator plugin is requesting library migration, updating in-flight device restore migration state", buf, 2u);
  }

  v10 = [(PLModelMigrator *)self deviceRestoreMigrationSupport];
  [v10 setDataMigratorPluginHasRequestedLibraryMigration:1];

  v11 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator cleanupModelForDataMigrationForRestoreType:]"];
  v12 = v11;
  if (v11)
  {
    v13 = [v11 managedObjectContext];
    v14 = [v13 persistentStoreCoordinator];
    v15 = [v14 persistentStores];
    v16 = [v15 firstObject];

    v17 = PLMigrationGetLog();
    v18 = v17;
    if (v16)
    {
      if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEFAULT, "Photo library loaded successfully", buf, 2u);
      }

      [(PLModelMigrator *)self _recordCurrentVersionMetadataIfNeededForDataMigrationInPersistentStore:v16];
    }

    else
    {
      if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412546;
        v26 = v12;
        v27 = 2082;
        v28 = "[PLModelMigrator cleanupModelForDataMigrationForRestoreType:]";
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Failed to access persistent store on photo library %@ for %{public}s", buf, 0x16u);
      }
    }
  }

  else
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446210;
      v26 = "[PLModelMigrator cleanupModelForDataMigrationForRestoreType:]";
      _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_ERROR, "Failed to load photo library for %{public}s", buf, 0xCu);
    }
  }

  v19 = objc_alloc_init(PLGreenController);
  if (a3)
  {
    v20 = PLMigrationGetLog();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 134217984;
      v26 = a3;
      _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Resetting resources after restore %ld", buf, 0xCu);
    }

    v23[0] = MEMORY[0x1E69E9820];
    v23[1] = 3221225472;
    v23[2] = __62__PLModelMigrator_cleanupModelForDataMigrationForRestoreType___block_invoke;
    v23[3] = &unk_1E75781E8;
    v24 = v12;
    [v24 performTransactionAndWait:v23];
    [(PLModelMigrator *)self handleGreenChanges:v19];
  }

  if ([(PLGreenController *)v19 isGreenStateValid])
  {
    v21 = [(PLGreenController *)v19 currentGreenValues];
    v22 = [v12 globalValues];
    [v22 setGreenValues:v21];
  }

  [v12 dataMigratorSupportCleanupModelForDataMigrationPurgeMissingSynced];
  [(PLModelMigrator *)self _repairPotentialModelCorruptionInLibrary:v12];
}

void __62__PLModelMigrator_cleanupModelForDataMigrationForRestoreType___block_invoke(uint64_t a1)
{
  v16 = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) managedObjectContext];
  v11 = 0;
  v3 = [PLInternalResource batchResetFileIDInManagedObjectContext:v2 error:&v11];
  v4 = v11;

  if (!v3)
  {
    v5 = PLMigrationGetLog();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446466;
      v13 = "[PLModelMigrator cleanupModelForDataMigrationForRestoreType:]_block_invoke";
      v14 = 2112;
      v15 = v4;
      _os_log_impl(&dword_19BF1F000, v5, OS_LOG_TYPE_ERROR, "%{public}s Failed to reset internal resource fileID after restore: %@", buf, 0x16u);
    }
  }

  v6 = [*(a1 + 32) managedObjectContext];
  v10 = v4;
  v7 = [PLManagedAsset markUnavailableComputeSyncResourcesWithManagedObjectContext:v6 error:&v10];
  v8 = v10;

  if (!v7)
  {
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      *buf = 136446466;
      v13 = "[PLModelMigrator cleanupModelForDataMigrationForRestoreType:]_block_invoke";
      v14 = 2112;
      v15 = v8;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "%{public}s Failed to mark unavailable compute sync resoures after restore: %@", buf, 0x16u);
    }
  }
}

- (void)handleGreenChanges:(id)a3
{
  v4 = a3;
  v5 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator handleGreenChanges:]"];
  v8[0] = MEMORY[0x1E69E9820];
  v8[1] = 3221225472;
  v8[2] = __38__PLModelMigrator_handleGreenChanges___block_invoke;
  v8[3] = &unk_1E7578848;
  v9 = v5;
  v10 = v4;
  v6 = v4;
  v7 = v5;
  [v7 performTransactionAndWait:v8];
}

void __38__PLModelMigrator_handleGreenChanges___block_invoke(uint64_t a1)
{
  v28[2] = *MEMORY[0x1E69E9840];
  v2 = [*(a1 + 32) globalValues];
  v3 = [v2 greenValues];

  if (([*(a1 + 40) greenValuesSimilarToGreenValues:v3] & 1) == 0)
  {
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_DEFAULT, "Green values are different from the backup one, invalidating the reverse geocoding data", buf, 2u);
    }

    v5 = [*(a1 + 32) managedObjectContext];
    v6 = [MEMORY[0x1E696ABC8] expressionForConstantValue:0];
    v7 = MEMORY[0x1E695D560];
    v8 = +[PLAdditionalAssetAttributes entityName];
    v9 = [v7 batchUpdateRequestWithEntityName:v8];

    v27[0] = @"reverseLocationDataIsValid";
    v27[1] = @"reverseLocationData";
    v28[0] = MEMORY[0x1E695E110];
    v28[1] = v6;
    v10 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v28 forKeys:v27 count:2];
    [v9 setPropertiesToUpdate:v10];

    [v9 setResultType:2];
    v20 = 0;
    v11 = [v5 executeRequest:v9 error:&v20];
    v12 = v20;
    v13 = PLMigrationGetLog();
    v14 = v13;
    if (v11)
    {
      if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
      {
        v15 = [v11 result];
        *buf = 138412290;
        v22 = v15;
        v16 = "Invalidated reverse geocoding data due to green changes for %@ assets";
        v17 = v14;
        v18 = OS_LOG_TYPE_DEFAULT;
        v19 = 12;
LABEL_9:
        _os_log_impl(&dword_19BF1F000, v17, v18, v16, buf, v19);
      }
    }

    else if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v15 = [v12 userInfo];
      *buf = 136315650;
      v22 = "[PLModelMigrator handleGreenChanges:]_block_invoke";
      v23 = 2112;
      v24 = v12;
      v25 = 2112;
      v26 = v15;
      v16 = "%s: failed to update: %@ %@";
      v17 = v14;
      v18 = OS_LOG_TYPE_ERROR;
      v19 = 32;
      goto LABEL_9;
    }
  }
}

- (void)_migratePersonContactInfo
{
  v2 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator _migratePersonContactInfo]"];
  [PLPersonContactInfoMigrator migratePersonContactInfoInPhotoLibrary:v2];
}

- (void)_loadFacesFileSystemDataIntoDatabase
{
  v3 = [MEMORY[0x1E69BF360] transaction:"-[PLModelMigrator _loadFacesFileSystemDataIntoDatabase]"];
  v4 = [(PLModelMigrator *)self newShortLivedLibraryWithName:"[PLModelMigrator _loadFacesFileSystemDataIntoDatabase]"];
  [(PLModelMigrator *)self setLoadingFacesFromFileSystem:1];
  v9[0] = MEMORY[0x1E69E9820];
  v9[1] = 3221225472;
  v9[2] = __55__PLModelMigrator__loadFacesFileSystemDataIntoDatabase__block_invoke;
  v9[3] = &unk_1E75781E8;
  v10 = v4;
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __55__PLModelMigrator__loadFacesFileSystemDataIntoDatabase__block_invoke_278;
  v7[3] = &unk_1E7578848;
  v7[4] = self;
  v8 = v3;
  v5 = v3;
  v6 = v4;
  [v6 performTransaction:v9 completionHandler:v7];
}

uint64_t __55__PLModelMigrator__loadFacesFileSystemDataIntoDatabase__block_invoke(uint64_t a1)
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT))
  {
    *v4 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_DEFAULT, "Starting import of file system faces", v4, 2u);
  }

  return [*(a1 + 32) recreatePersonsFromMetadata];
}

uint64_t __55__PLModelMigrator__loadFacesFileSystemDataIntoDatabase__block_invoke_278(uint64_t a1)
{
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_DEFAULT))
  {
    *v4 = 0;
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_DEFAULT, "Finished import of file system faces", v4, 2u);
  }

  [*(a1 + 32) setLoadingFacesFromFileSystem:0];
  return [*(a1 + 40) stillAlive];
}

- (void)setLoadingFacesFromFileSystem:(BOOL)a3
{
  pthread_mutex_lock(&sLoadingFacesFromFileSystemLock);
  sLoadingFacesFromFileSystem = a3;

  pthread_mutex_unlock(&sLoadingFacesFromFileSystemLock);
}

- (BOOL)isLoadingFacesFromFileSystem
{
  pthread_mutex_lock(&sLoadingFacesFromFileSystemLock);
  v2 = sLoadingFacesFromFileSystem;
  pthread_mutex_unlock(&sLoadingFacesFromFileSystemLock);
  return v2;
}

- (void)_loadFileSystemDataIntoDatabaseIfNeededWithReason:(id)a3 progress:(id)a4 requestBackgroundMigrationRegistration:(BOOL *)a5
{
  v50 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = [(PLModelMigrator *)self newShortLivedLibraryForRebuildWithName:"[PLModelMigrator _loadFileSystemDataIntoDatabaseIfNeededWithReason:progress:requestBackgroundMigrationRegistration:]"];
  v11 = [v10 globalValues];
  v12 = [(PLModelMigrator *)self deviceRestoreMigrationSupport];
  v13 = [(PLModelMigrator *)self pathManager];
  if (![v13 isDeviceRestoreSupported])
  {

    goto LABEL_7;
  }

  v14 = [v12 isRestoreFromBackupSourceCloud];

  if (!v14)
  {
LABEL_7:
    v18 = 0;
    goto LABEL_8;
  }

  v15 = [(PLModelMigrator *)self postProcessingToken];
  v16 = [v15 isModelMigrationRestorePostProcessingComplete];

  if ((v16 & 1) == 0)
  {
    v18 = @"OTA restore post-processing not yet complete (did not find post-processing complete token)";
LABEL_23:
    v32 = PLMigrationGetLog();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
    {
      v33 = [(PLModelMigrator *)self postProcessingToken];
      v34 = [v33 needsToPrepareForBackgroundRestore];
      v35 = @"NO";
      if (v34)
      {
        v35 = @"YES";
      }

      *buf = 138543618;
      v47 = v8;
      v48 = 2114;
      v49 = v35;
      _os_log_impl(&dword_19BF1F000, v32, OS_LOG_TYPE_DEFAULT, "Ignoring request to load file system data during OTA restore [%{public}@] needs to prepare for background restore is %{public}@", buf, 0x16u);
    }

    v36 = PLMigrationGetLog();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138543362;
      v47 = v18;
      _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEFAULT, "OTA Restore status: %{public}@", buf, 0xCu);
    }

    [v9 setCompletedUnitCount:{objc_msgSend(v9, "totalUnitCount")}];
    goto LABEL_21;
  }

  v45 = 0;
  v17 = [v12 isOTARestoreInProgressWithStatus:&v45];
  v18 = v45;
  if (v17)
  {
    goto LABEL_23;
  }

LABEL_8:
  v37 = v12;
  v19 = v18;
  v20 = v8;
  v21 = [objc_alloc(MEMORY[0x1E695E000]) initWithSuiteName:@"com.apple.mobileslideshow"];
  v22 = [v21 BOOLForKey:@"com.apple.Photos.SuppressFileSystemImport"];

  if (v22)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 138412290;
      v47 = @"com.apple.Photos.SuppressFileSystemImport";
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Ignoring request to load file system data - %@ user default is enabled", buf, 0xCu);
    }

    v8 = v20;
    if (([v11 didImportFileSystemAssets] & 1) == 0)
    {
      [v11 setImportFilesystemAssetsState:1];
    }

    v24 = [(PLModelMigrator *)self pathManager];
    v25 = [PLRebuildJournalManager isEnabledWithPathManager:v24 error:0];

    if (v25)
    {
      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v47 = @"com.apple.Photos.SuppressFileSystemImport";
        _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, "Unsupported configuration! Journals and %@ user default are both enabled", buf, 0xCu);
      }
    }
  }

  else
  {
    v27 = [(PLModelMigrator *)self pathManager];
    v28 = 0;
    if ([PLRebuildJournalManager isEnabledWithPathManager:v27 error:0])
    {
      v29 = [v10 libraryServicesManager];
      v28 = [v29 rebuildJournalManager];
    }

    v38[0] = MEMORY[0x1E69E9820];
    v38[1] = 3221225472;
    v38[2] = __117__PLModelMigrator__loadFileSystemDataIntoDatabaseIfNeededWithReason_progress_requestBackgroundMigrationRegistration___block_invoke;
    v38[3] = &unk_1E7568BD8;
    v38[4] = self;
    v39 = v10;
    v40 = v11;
    v8 = v20;
    v41 = v20;
    v42 = v28;
    v30 = v9;
    v43 = v30;
    v44 = a5;
    v31 = v28;
    [v39 performTransactionAndWait:v38];
    [v30 setCompletedUnitCount:{objc_msgSend(v30, "totalUnitCount")}];
  }

  v18 = v19;
  v12 = v37;
LABEL_21:
}

void __117__PLModelMigrator__loadFileSystemDataIntoDatabaseIfNeededWithReason_progress_requestBackgroundMigrationRegistration___block_invoke(uint64_t a1)
{
  v31 = *MEMORY[0x1E69E9840];
  if ([*(a1 + 32) _isFileSystemImportRequiredForLibrary:*(a1 + 40)])
  {
    v2 = [*(a1 + 48) isRebuildComplete];
    v3 = PLMigrationGetLog();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
    {
      v4 = *(a1 + 56);
      v27 = 138412546;
      v28 = v4;
      v29 = 1024;
      v30 = v2;
      _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_DEFAULT, "Starting import of file system assets [%@], rebuild complete: %d", &v27, 0x12u);
    }

    if ((v2 & 1) == 0)
    {
      [*(a1 + 64) notifyWillRebuild];
      v5 = [*(a1 + 40) libraryServicesManager];
      v6 = [v5 readyForAnalysis];
      [v6 resetReadyForAnalysisState];
    }

    v7 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:100 parent:*(a1 + 72) pendingUnitCount:{objc_msgSend(*(a1 + 72), "totalUnitCount") - 1}];
    v8 = [[PLModelMigratorRebuildProgressFraction alloc] initWithLegacyRecoveryEnabled:0];
    v9 = [*(a1 + 32) analyticsEventManager];
    v10 = [*(a1 + 32) pathManager];
    if (+[PLRebuildJournalManager isEnabledWithPathManager:error:](PLRebuildJournalManager, "isEnabledWithPathManager:error:", v10, 0) && [*(a1 + 48) isJournalRebuildRequired])
    {
      v11 = [*(a1 + 72) isCancelled];

      if ((v11 & 1) == 0)
      {
        [(PLModelMigratorRebuildProgressFraction *)v8 setRebuildEnabled:1];
        [v9 startRecordingTimedEventToken];
        v13 = v12;
        [*(a1 + 32) _rebuildAssetsFromJournal:*(a1 + 64) inLibrary:*(a1 + 40) progress:v7 progressFraction:v8];
        [v9 stopRecordingTimedEventWithToken:*MEMORY[0x1E69BF760] forKey:*MEMORY[0x1E69BF740] onEventWithName:v13];
        if (([*(a1 + 72) isCancelled] & 1) == 0)
        {
          [*(a1 + 48) setJournalRebuildRequired:0];
        }

        v14 = [PLBackgroundModelMigration isBackgroundMigrationRegistrationAfterRebuildRequiredWithLibrary:*(a1 + 40)];
        v15 = *(a1 + 80);
        if (v15)
        {
          *v15 = v14;
        }
      }
    }

    else
    {
    }

    if ([*(a1 + 72) isCancelled])
    {
      v17 = *MEMORY[0x1E69BF740];
    }

    else
    {
      [v9 startRecordingTimedEventToken];
      v19 = v18;
      [*(a1 + 32) _importAllDCIMAssetsInLibrary:*(a1 + 40) progress:v7 progressFraction:v8 rebuildComplete:v2];
      v17 = *MEMORY[0x1E69BF740];
      [v9 stopRecordingTimedEventWithToken:*MEMORY[0x1E69BF748] forKey:*MEMORY[0x1E69BF740] onEventWithName:v19];
      if (([*(a1 + 72) isCancelled] & 1) == 0)
      {
        if ((v2 & 1) == 0)
        {
          [*(a1 + 48) setRebuildComplete];
          [*(a1 + 64) notifyRebuildComplete];
        }

        [*(a1 + 48) setImportFilesystemAssetsState:1];
      }
    }

    v20 = *MEMORY[0x1E69BF778];
    v21 = [v9 valueForKey:*MEMORY[0x1E69BF778] onEventWithName:v17];

    if (!v21)
    {
      [v9 setPayloadValue:*(a1 + 56) forKey:v20 onEventWithName:v17];
    }

    v22 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:{objc_msgSend(*(a1 + 32), "_assetCountForLibrary:", *(a1 + 40))}];
    [v9 setPayloadValue:v22 forKey:*MEMORY[0x1E69BF780] onEventWithName:v17];

    v23 = [v9 valueForKey:*MEMORY[0x1E69BF750] onEventWithName:v17];
    v24 = [v23 BOOLValue];

    v25 = [v9 valueForKey:*MEMORY[0x1E69BF758] onEventWithName:v17];
    v26 = [v25 unsignedIntegerValue];

    if (![(PLModelMigratorRebuildProgressFraction *)v8 isRebuildEnabled]&& (v24 & 1) == 0 && !v26)
    {
      [v9 removeEventWithName:v17];
    }
  }

  else
  {
    v7 = PLMigrationGetLog();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v16 = *(a1 + 56);
      v27 = 138412290;
      v28 = v16;
      _os_log_impl(&dword_19BF1F000, v7, OS_LOG_TYPE_DEFAULT, "File system import already done, ignoring request [%@]", &v27, 0xCu);
    }
  }
}

- (BOOL)_isFileSystemImportRequiredForLibrary:(id)a3
{
  v4 = [a3 globalValues];
  v5 = [v4 importFilesystemAssetsState];
  v6 = v5 != 1;
  if (v5 == -1 && [v4 isRebuildComplete] && -[PLModelMigrator _isFilesystemImportConfigurationDisabled](self, "_isFilesystemImportConfigurationDisabled"))
  {
    [v4 setImportFilesystemAssetsState:1];
    v6 = 0;
  }

  return v6;
}

- (BOOL)_isFilesystemImportConfigurationDisabled
{
  v21 = *MEMORY[0x1E69E9840];
  v3 = objc_alloc(MEMORY[0x1E695DFF8]);
  v4 = [(PLModelMigrator *)self pathManager];
  v5 = [v4 cplDataDirectoryCreateIfNeeded:0];
  v6 = [v3 initFileURLWithPath:v5 isDirectory:1];

  v7 = [objc_alloc(MEMORY[0x1E6994AA0]) initWithClientLibraryBaseURL:v6];
  v8 = [v7 valueForKey:@"feature.version.filesystemimport"];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 integerValue];
    v11 = PLMigrationGetLog();
    v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);
    v13 = v10 <= 0;
    v14 = v10 > 0;
    if (v13)
    {
      if (v12)
      {
        v17 = 138543618;
        v18 = v9;
        v19 = 2048;
        v20 = 0;
        v15 = "ModelMigrator: Asset recovery filesystem import allowed via configuration version: %{public}@, build version: %ld";
        goto LABEL_8;
      }
    }

    else if (v12)
    {
      v17 = 138543618;
      v18 = v9;
      v19 = 2048;
      v20 = 0;
      v15 = "ModelMigrator: Asset recovery filesystem import prevented via configuration version: %{public}@, build version: %ld";
LABEL_8:
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, v15, &v17, 0x16u);
    }

    goto LABEL_10;
  }

  v14 = 0;
LABEL_10:

  return v14;
}

- (id)_eventNameFromDate:(id)a3
{
  v3 = MEMORY[0x1E696AB78];
  v4 = a3;
  v5 = objc_alloc_init(v3);
  [v5 setDateStyle:2];
  v6 = [v5 stringFromDate:v4];

  return v6;
}

- (void)_generateAlbumMetadataFromLastiTunesSyncedPlist
{
  v71 = *MEMORY[0x1E69E9840];
  v3 = [(PLModelMigrator *)self pathManager];
  if ([v3 isDCIM])
  {
    v4 = objc_autoreleasePoolPush();
    v5 = [(PLModelMigrator *)self _iTunesPhotosLastSyncMetadata];
    v6 = [v5 objectForKey:@"updates"];
    v65 = 0;
    v7 = [v3 iTunesSyncedAssetsDirectory];
    if ([v6 count])
    {
      v8 = [MEMORY[0x1E696AC08] defaultManager];
      if (![v8 fileExistsAtPath:v7 isDirectory:&v65])
      {
        goto LABEL_43;
      }

      v50 = self;
      v9 = v65;

      if (v9 == 1)
      {
        v45 = v7;
        v47 = v5;
        v48 = v4;
        v8 = [v3 iTunesSyncedFaceDataDirectory];
        v10 = MEMORY[0x1E695DFF8];
        v49 = v3;
        v11 = [v3 persistedAlbumDataDirectoryCreateIfNeeded:1 error:0];
        v56 = [v10 fileURLWithPath:v11 isDirectory:1];

        v12 = [MEMORY[0x1E696AC08] defaultManager];
        v57 = [v12 fileExistsAtPath:v8];

        v51 = [MEMORY[0x1E695DF70] array];
        v13 = [MEMORY[0x1E695DF70] array];
        v14 = [MEMORY[0x1E695DF70] array];
        v61 = 0u;
        v62 = 0u;
        v63 = 0u;
        v64 = 0u;
        v46 = v6;
        v15 = v6;
        v16 = v14;
        obj = v15;
        v17 = [v15 countByEnumeratingWithState:&v61 objects:v70 count:16];
        v55 = v14;
        if (!v17)
        {
          goto LABEL_36;
        }

        v18 = v17;
        v52 = 0;
        v59 = *v62;
        v53 = v13;
        v54 = v8;
        while (1)
        {
          v19 = 0;
          do
          {
            if (*v62 != v59)
            {
              objc_enumerationMutation(obj);
            }

            v20 = *(*(&v61 + 1) + 8 * v19);
            v21 = [v20 objectForKey:@"itemType"];
            if ([v21 isEqual:@"Asset"])
            {
              v22 = [v20 objectForKey:@"faces"];
              v23 = v22;
              if ((v57 & 1) == 0 && [v22 count])
              {
                if ((v52 & 1) == 0)
                {
                  v60 = 0;
                  v24 = [MEMORY[0x1E69BF238] createDirectoryAtPath:v8 error:&v60];
                  v25 = v60;
                  if ((v24 & 1) == 0)
                  {
                    v26 = PLMigrationGetLog();
                    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
                    {
                      *buf = 138412546;
                      v67 = v8;
                      v68 = 2112;
                      v69 = v25;
                      _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, "Unable to create directory: %@, reason: %@", buf, 0x16u);
                    }
                  }
                }

                v27 = [v20 objectForKey:@"uuid"];
                v28 = [v8 stringByAppendingPathComponent:v27];
                v29 = [v28 stringByAppendingPathExtension:@"plist"];

                v30 = [MEMORY[0x1E696AE40] dataWithPropertyList:v23 format:100 options:0 error:0];
                [v30 writeToFile:v29 options:1073741825 error:0];

                v52 = 1;
              }

              goto LABEL_28;
            }

            if (([v21 isEqual:@"Album"] & 1) == 0 && !objc_msgSend(v21, "isEqual:", @"Event"))
            {
              v23 = PLMigrationGetLog();
              if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
              {
                *buf = 138412290;
                v67 = v20;
                _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "*** Found unknown element: %@", buf, 0xCu);
              }

              goto LABEL_28;
            }

            if ([v21 isEqual:@"Album"])
            {
              v31 = [v20 objectForKey:@"subclass"];
              v32 = [v31 unsignedIntValue];

              if (v32 == 3)
              {
                v33 = 15;
                v13 = v16;
                goto LABEL_27;
              }

              if (v32 == 5)
              {
                goto LABEL_29;
              }

              if (v32 != 4)
              {
                v33 = 1550;
                v13 = v51;
                goto LABEL_27;
              }
            }

            v33 = 1551;
LABEL_27:
            v34 = [v20 objectForKey:@"uuid"];
            [v13 addObject:v34];

            v35 = [PLPersistedAlbumMetadata alloc];
            v36 = [v20 objectForKey:@"albumName"];
            v37 = [v20 objectForKey:@"uuid"];
            v38 = [v20 objectForKey:@"cloudGUID"];
            v39 = [MEMORY[0x1E696AD98] numberWithInt:v33];
            v40 = [v20 objectForKey:@"assetUUIDs"];
            v23 = [(PLPersistedAlbumMetadata *)v35 initWithTitle:v36 uuid:v37 cloudGUID:v38 kind:v39 assetUUIDs:v40 persistedAlbumDataDirectory:v56];

            [v23 setAllowsOverwrite:0];
            [v23 persistAlbumData];
            v13 = v53;
            v8 = v54;
            v16 = v55;
LABEL_28:

LABEL_29:
            ++v19;
          }

          while (v18 != v19);
          v41 = [obj countByEnumeratingWithState:&v61 objects:v70 count:16];
          v18 = v41;
          if (!v41)
          {
LABEL_36:

            if ([v51 count])
            {
              v42 = [(PLModelMigrator *)v50 pathManager];
              [PLManagedAlbumList persistAlbumListUUIDs:v51 type:0 pathManager:v42 allowsOverwrite:0];
            }

            v5 = v47;
            v4 = v48;
            v7 = v45;
            v6 = v46;
            if ([v13 count])
            {
              v43 = [(PLModelMigrator *)v50 pathManager];
              [PLManagedAlbumList persistAlbumListUUIDs:v13 type:1 pathManager:v43 allowsOverwrite:0];
            }

            if ([v55 count])
            {
              v44 = [(PLModelMigrator *)v50 pathManager];
              [PLManagedAlbumList persistAlbumListUUIDs:v55 type:2 pathManager:v44 allowsOverwrite:0];
            }

            v3 = v49;
LABEL_43:

            break;
          }
        }
      }
    }

    objc_autoreleasePoolPop(v4);
  }
}

- (id)_iTunesPhotosLastSyncMetadata
{
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 isDCIM];

  if (v4)
  {
    v5 = MEMORY[0x1E695DF20];
    v6 = [(PLModelMigrator *)self pathManager];
    v7 = [v6 iTunesPhotosLastSyncMetadataFilePath];
    v8 = [v5 dictionaryWithContentsOfFile:v7];

    if (![v8 count])
    {
      v9 = MEMORY[0x1E695DF20];
      v10 = [(PLModelMigrator *)self pathManager];
      v11 = [v10 iTunesPhotosSyncMetadataFilePath];
      v12 = [v9 dictionaryWithContentsOfFile:v11];

      v8 = v12;
    }
  }

  else
  {
    v8 = 0;
  }

  return v8;
}

- (id)generatePathToAssetUUIDRecoveryMapping
{
  if ((PLIsAssetsd() & 1) == 0)
  {
    v9 = [MEMORY[0x1E696AAA8] currentHandler];
    v10 = NSStringFromSelector(a2);
    [v9 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:1558 description:{@"%@ only valid in assetsd!", v10}];
  }

  v4 = PLMigrationGetLog();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_DEBUG, "Creating path to uuid mappings for UUID recovery", buf, 2u);
  }

  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 photosDatabasePath];

  v7 = [objc_opt_class() extractPathToAssetUUIDRecoveryMappingFromDatabasePath:v6];

  return v7;
}

- (void)archiveAssetUUIDForPathPlist:(id)a3
{
  v41 = *MEMORY[0x1E69E9840];
  v5 = a3;
  v6 = PLMigrationGetLog();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v6, OS_LOG_TYPE_DEFAULT, "Archiving asset path to uuid mappings", buf, 2u);
  }

  v7 = self;
  objc_sync_enter(v7);
  v8 = archivedAssetUUIDForPathDictionary;
  archivedAssetUUIDForPathDictionary = 0;

  v9 = [(PLModelMigrator *)v7 pathManager];
  v31 = 0;
  v32 = 0;
  v10 = [v9 photosDatabasePath];
  [PLManagedObjectContext getPersistentStoreURL:&v32 options:&v31 forDatabasePath:v10];
  v27 = v9;
  v28 = v32;
  v11 = v31;

  v12 = *MEMORY[0x1E695D4A8];
  v30 = 0;
  v13 = [MEMORY[0x1E695D6C0] metadataForPersistentStoreOfType:v12 URL:v28 options:v11 error:&v30];
  v14 = v30;
  v15 = v14;
  v16 = 0;
  if (v13 && !v14)
  {
    v16 = [v13 valueForKey:*MEMORY[0x1E695D4B8]];
  }

  v17 = [v5 count];
  if (v16)
  {
    [v5 setObject:v16 forKey:@"storeUUID"];
  }

  if (v5)
  {
    v25 = v17;
    v18 = [MEMORY[0x1E696AE40] dataWithPropertyList:v5 format:100 options:0 error:0];
    v19 = [(PLModelMigrator *)v7 pathManager];
    v26 = [v19 assetUUIDRecoveryMappingPath];

    if (v18)
    {
      v29 = 0;
      v20 = [v18 writeToFile:v26 options:1073741825 error:&v29];
      v21 = v29;
      if (v20)
      {
        v22 = PLMigrationGetLog();
        if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
        {
          v23 = NSStringFromSelector(a2);
          *buf = 138543874;
          v34 = v23;
          v35 = 2048;
          v36 = v25;
          v37 = 2114;
          v38 = v16;
          _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@ -- saved %ld asset mappings for store %{public}@", buf, 0x20u);
        }

LABEL_16:

        goto LABEL_17;
      }
    }

    else
    {
      v21 = 0;
    }

    v22 = PLMigrationGetLog();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      v24 = NSStringFromSelector(a2);
      *buf = 138544130;
      v34 = v24;
      v35 = 2048;
      v36 = v25;
      v37 = 2114;
      v38 = v16;
      v39 = 2114;
      v40 = v21;
      _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "%{public}@ -- failed to save %ld asset mappings for store %{public}@: %{public}@", buf, 0x2Au);
    }

    goto LABEL_16;
  }

LABEL_17:

  objc_sync_exit(v7);
}

- (id)archivedAssetUUIDForURL:(id)a3
{
  v47 = *MEMORY[0x1E69E9840];
  v4 = a3;
  v5 = [v4 path];
  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 photoDirectoryWithType:1];
  if ([v5 hasPrefix:@"/private"])
  {
    v8 = [v5 substringFromIndex:{objc_msgSend(@"/private", "length")}];

    v5 = v8;
  }

  if ([v5 hasPrefix:v7])
  {
    v9 = [v5 substringFromIndex:{objc_msgSend(v7, "length") + (objc_msgSend(v7, "hasSuffix:", @"/"}];

    v5 = v9;
  }

  v10 = self;
  objc_sync_enter(v10);
  v11 = archivedAssetUUIDForPathDictionary;
  if (!archivedAssetUUIDForPathDictionary)
  {
    v34 = [v6 assetUUIDRecoveryMappingPath];
    v12 = [objc_alloc(MEMORY[0x1E695DF20]) initWithContentsOfFile:v34];
    v13 = archivedAssetUUIDForPathDictionary;
    archivedAssetUUIDForPathDictionary = v12;

    v37 = 0;
    v38 = 0;
    v14 = [v6 photosDatabasePath];
    [PLManagedObjectContext getPersistentStoreURL:&v38 options:&v37 forDatabasePath:v14];
    v32 = v38;
    v33 = v37;

    v15 = *MEMORY[0x1E695D4A8];
    v36 = 0;
    v16 = [MEMORY[0x1E695D6C0] metadataForPersistentStoreOfType:v15 URL:v32 options:v33 error:&v36];
    v17 = v36;
    v18 = 0;
    v31 = v17;
    if (v16 && !v17)
    {
      v18 = [v16 valueForKey:{*MEMORY[0x1E695D4B8], 0}];
    }

    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = NSStringFromSelector(a2);
      v21 = [archivedAssetUUIDForPathDictionary objectForKey:@"storeUUID"];
      *buf = 138412802;
      v40 = v20;
      v41 = 2112;
      v42 = v18;
      v43 = 2112;
      v44 = v21;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_DEFAULT, "%@ -- store %@ vs. plist %@", buf, 0x20u);
    }

    v22 = [archivedAssetUUIDForPathDictionary objectForKey:@"storeUUID"];
    v23 = [v18 isEqualToString:v22];

    if ((v23 & 1) == 0)
    {
      v24 = objc_opt_new();
      v25 = archivedAssetUUIDForPathDictionary;
      archivedAssetUUIDForPathDictionary = v24;
    }

    v11 = archivedAssetUUIDForPathDictionary;
  }

  v26 = [v11 objectForKey:{v5, v31}];
  objc_sync_exit(v10);

  v27 = PLMigrationGetLog();
  if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
  {
    v28 = NSStringFromSelector(a2);
    v29 = [v4 path];
    *buf = 138413058;
    v40 = v28;
    v41 = 2112;
    v42 = v29;
    v43 = 2112;
    v44 = v5;
    v45 = 2112;
    v46 = v26;
    _os_log_impl(&dword_19BF1F000, v27, OS_LOG_TYPE_DEBUG, "%@ %@[%@] -> %@", buf, 0x2Au);
  }

  return v26;
}

- (BOOL)isPhotoLibraryDatabaseReadyForOpen:(id *)a3
{
  if ((PLIsAssetsd() & 1) == 0)
  {
    v17 = [MEMORY[0x1E696AAA8] currentHandler];
    [v17 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:1453 description:@"Only Assetsd should be checking if isPhotoLibraryDatabaseReadyForOpen!"];
  }

  v6 = [MEMORY[0x1E69BF238] fileManager];
  v7 = [(PLModelMigrator *)self pathManager];
  v8 = [v7 photosDatabasePath];
  v9 = [v6 fileExistsAtPath:v8];

  if (!v9)
  {
    return 0;
  }

  os_unfair_lock_lock(&self->_storeMetadataLock);
  v10 = objc_opt_class();
  v11 = [(PLModelMigrator *)self pathManager];
  v12 = [v10 _readNumberWithKey:@"PLModelVersion" fromMetadataWithMOC:0 pathManager:v11 error:0];

  os_unfair_lock_unlock(&self->_storeMetadataLock);
  if (![(PLModelMigrator *)self checkForceRebuildIndicatorFile])
  {
    v16 = [v12 integerValue];
    v13 = v16 == [objc_opt_class() currentModelVersion];
    if (!a3)
    {
      goto LABEL_7;
    }

    goto LABEL_6;
  }

  v13 = 0;
  if (a3)
  {
LABEL_6:
    v14 = v12;
    *a3 = v12;
  }

LABEL_7:

  return v13;
}

- (BOOL)updateCompletedMigrationStateWithError:(id *)a3
{
  os_unfair_lock_lock(&self->_storeMetadataLock);
  v5 = objc_opt_class();
  v6 = *MEMORY[0x1E69BFEE0];
  v7 = [(PLModelMigrator *)self pathManager];
  LOBYTE(a3) = [v5 _writeNumber:&unk_1F0FBBD40 forKey:v6 pathManager:v7 error:a3];

  os_unfair_lock_unlock(&self->_storeMetadataLock);
  return a3;
}

- (int64_t)legacyMigrationState
{
  os_unfair_lock_lock(&self->_storeMetadataLock);
  v3 = objc_opt_class();
  v4 = *MEMORY[0x1E69BFEE0];
  v5 = [(PLModelMigrator *)self pathManager];
  v19 = 0;
  v6 = [v3 _readNumberWithKey:v4 fromMetadataWithMOC:0 pathManager:v5 error:&v19];
  v7 = v19;
  v8 = [v6 integerValue];

  os_unfair_lock_unlock(&self->_storeMetadataLock);
  if (!v8)
  {
    os_unfair_lock_lock(&self->_storeMetadataLock);
    v9 = objc_opt_class();
    v10 = [(PLModelMigrator *)self pathManager];
    v18 = v7;
    v11 = [v9 _readNumberWithKey:@"PLModelVersion" fromMetadataWithMOC:0 pathManager:v10 error:&v18];
    v12 = v18;

    os_unfair_lock_unlock(&self->_storeMetadataLock);
    v8 = 4 * (v11 == 0);

    v7 = v12;
  }

  if (v7)
  {
    v13 = [v7 userInfo];
    v14 = [v13 objectForKeyedSubscript:*MEMORY[0x1E695D488]];

    if (v14)
    {
      v15 = [v14 intValue];
      if (v15 == 26 || v15 == 11)
      {
        v8 = 3;
      }
    }
  }

  return v8;
}

- (void)importAfterCrash:(id)a3 completionBlock:(id)a4
{
  v8 = a3;
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  [(PLModelMigrator *)self _importAfterCrash:v8 completionBlock:v6];
  objc_autoreleasePoolPop(v7);
}

- (void)migratePersonContactInfo
{
  v3 = objc_autoreleasePoolPush();
  [(PLModelMigrator *)self _migratePersonContactInfo];

  objc_autoreleasePoolPop(v3);
}

- (void)loadFacesFileSystemDataIntoDatabase
{
  v3 = objc_autoreleasePoolPush();
  [(PLModelMigrator *)self _loadFacesFileSystemDataIntoDatabase];

  objc_autoreleasePoolPop(v3);
}

- (void)loadFileSystemDataIntoDatabaseIfNeededWithReason:(id)a3 completionHandler:(id)a4
{
  v7 = a3;
  v8 = a4;
  if (!v7)
  {
    v16 = [MEMORY[0x1E696AAA8] currentHandler];
    [v16 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:1306 description:{@"Invalid parameter not satisfying: %@", @"reason != nil"}];
  }

  v23 = MEMORY[0x1E69E9820];
  v24 = 3221225472;
  v25 = __86__PLModelMigrator_loadFileSystemDataIntoDatabaseIfNeededWithReason_completionHandler___block_invoke;
  v26 = &unk_1E75781E8;
  v27 = self;
  PLRunWithUnfairLock();
  v9 = [MEMORY[0x1E696AE38] progressWithTotalUnitCount:100];
  v10 = [MEMORY[0x1E69BF360] transaction:"-[PLModelMigrator loadFileSystemDataIntoDatabaseIfNeededWithReason:completionHandler:]"];
  fileSystemLoadQueue = self->_fileSystemLoadQueue;
  block[0] = MEMORY[0x1E69E9820];
  block[1] = 3221225472;
  block[2] = __86__PLModelMigrator_loadFileSystemDataIntoDatabaseIfNeededWithReason_completionHandler___block_invoke_2;
  block[3] = &unk_1E7576EE8;
  v18 = v7;
  v19 = self;
  v21 = v10;
  v22 = v8;
  v20 = v9;
  v12 = v10;
  v13 = v8;
  v14 = v9;
  v15 = v7;
  dispatch_async(fileSystemLoadQueue, block);
}

void __86__PLModelMigrator_loadFileSystemDataIntoDatabaseIfNeededWithReason_completionHandler___block_invoke_2(uint64_t a1)
{
  v2 = +[PLModelMigrator waitForDataMigratorToExit];
  v3 = *(a1 + 32);
  if (v2)
  {
    v4 = [*(a1 + 32) stringByAppendingString:@"(after waiting for data migrator to exit)"];

    v3 = v4;
  }

  v8 = 0;
  [*(a1 + 40) _loadFileSystemDataIntoDatabaseIfNeededWithReason:v3 progress:*(a1 + 48) requestBackgroundMigrationRegistration:&v8];
  v6 = MEMORY[0x1E69E9820];
  v7 = *(a1 + 40);
  PLRunWithUnfairLock();
  v5 = *(a1 + 64);
  if (v5)
  {
    (*(v5 + 16))(v5, v8);
  }

  [*(a1 + 56) stillAlive];
}

- (int64_t)loadFileSystemDataInProgressCount
{
  v4 = 0;
  v5 = &v4;
  v6 = 0x2020000000;
  v7 = 0;
  PLRunWithUnfairLock();
  v2 = v5[3];
  _Block_object_dispose(&v4, 8);
  return v2;
}

- (void)loadFileSystemAssetsNotifyCompleted:(id)a3
{
  v4 = a3;
  p_fileSystemLoadQueue = &self->_fileSystemLoadQueue;
  fileSystemLoadQueue = self->_fileSystemLoadQueue;
  v6 = p_fileSystemLoadQueue[1];
  block[0] = MEMORY[0x1E69E9820];
  block[1] = 3221225472;
  block[2] = __55__PLModelMigrator_loadFileSystemAssetsNotifyCompleted___block_invoke;
  block[3] = &unk_1E7576AA0;
  v10 = v4;
  v8 = v4;
  dispatch_group_notify(v6, fileSystemLoadQueue, block);
}

- (BOOL)_recordCurrentVersionMetadataInPersistentStore:(id)a3 migrationType:(int64_t)a4 forceRebuildReason:(id)a5 sourceModelVersion:(id)a6 updateLegacyMigrationState:(BOOL)a7 journalRebuildRequred:(BOOL)a8
{
  v47 = a7;
  v52[1] = *MEMORY[0x1E69E9840];
  v43 = a6;
  v42 = a5;
  v11 = a3;
  os_unfair_lock_lock(&self->_recordMigrationMetadataLock);
  v12 = [(PLModelMigrator *)self _migrationHistoryOriginFromLatestDataMigration];
  v46 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v11 name:"[PLModelMigrator _recordCurrentVersionMetadataInPersistentStore:migrationType:forceRebuildReason:sourceModelVersion:updateLegacyMigrationState:journalRebuildRequred:]" concurrencyType:1];

  v13 = [(PLModelMigrator *)self options];
  v14 = [v13 objectForKeyedSubscript:@"PLPhotoLibraryCreateOptions"];

  v41 = v14;
  if (v14)
  {
    v15 = MEMORY[0x1E69BF188];
    v16 = [(PLModelMigrator *)self pathManager];
    v17 = [v16 libraryURL];
    v18 = [v15 appPrivateDataForLibraryURL:v17];

    v51 = @"PLPhotoLibraryCreateOptions";
    v52[0] = v14;
    v19 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v52 forKeys:&v51 count:1];
    v48 = 0;
    LODWORD(v16) = [v18 setValue:v19 forKey:@"PLModelMigrator.CreateOptions" error:&v48];
    v20 = v48;

    v21 = PLMigrationGetLog();
    v22 = v21;
    if (v16)
    {
      if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
      {
        *buf = 0;
        v23 = "persisted library create options to appPrivateData";
        v24 = v22;
        v25 = OS_LOG_TYPE_INFO;
        v26 = 2;
LABEL_8:
        _os_log_impl(&dword_19BF1F000, v24, v25, v23, buf, v26);
      }
    }

    else if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v50 = v20;
      v23 = "failed to persist library create options to appPrivateData. Error: %@";
      v24 = v22;
      v25 = OS_LOG_TYPE_ERROR;
      v26 = 12;
      goto LABEL_8;
    }

    v27 = [v14 unsignedIntegerValue];
    goto LABEL_10;
  }

  v27 = 0;
LABEL_10:
  v28 = MGCopyAnswer();
  v29 = MGCopyAnswer();
  v30 = [(PLModelMigrator *)self pathManager];
  v31 = CPLStatusFromPathManager(v30);

  v32 = [(PLModelMigrator *)self pathManager];
  v33 = [v32 libraryURL];
  v34 = PLIsCloudPhotoLibraryEnabledForPhotoLibraryURL(v33);

  v35 = [(PLModelMigrator *)self pathManager];
  v36 = [v31 initialSyncDate];
  LOBYTE(v40) = v34;
  WORD1(v39) = v12;
  LOBYTE(v39) = a8;
  v37 = [PLMigrationHistory recordCurrentMigrationStateInManagedObjectContext:v46 withPathManager:v35 migrationType:a4 forceRebuildReason:v42 sourceModelVersion:v43 updateLegacyMigrationState:v47 journalRebuildRequred:v39 origin:v27 libraryCreateOptions:v28 hardwareModel:v29 deviceUniqueID:v40 cplEnabled:v36 initialSyncDate:?];

  [(PLModelMigrator *)self setDidRecordCurrentMigrationMetadata:v37];
  os_unfair_lock_unlock(&self->_recordMigrationMetadataLock);

  return v37;
}

- (void)_recordCurrentVersionMetadataIfNeededForDataMigrationInPersistentStore:(id)a3
{
  v5 = a3;
  os_unfair_lock_lock(&self->_recordMigrationMetadataLock);
  v4 = [(PLModelMigrator *)self didRecordCurrentMigrationMetadata];
  os_unfair_lock_unlock(&self->_recordMigrationMetadataLock);
  if (!v4)
  {
    [(PLModelMigrator *)self _recordCurrentVersionMetadataInPersistentStore:v5 migrationType:0 forceRebuildReason:0 sourceModelVersion:0 updateLegacyMigrationState:0 journalRebuildRequred:0];
  }
}

- (signed)_migrationHistoryOriginFromLatestDataMigration
{
  v3 = [(PLModelMigrator *)self deviceRestoreMigrationSupport];
  v4 = [(PLModelMigrator *)self pathManager];
  if (![v4 isDeviceRestoreSupported])
  {

LABEL_14:
    if ([v3 isEraseWithoutRestore])
    {
      v6 = 9;
    }

    else
    {
      v6 = 8;
    }

    goto LABEL_17;
  }

  v5 = [v3 isRestoreFromBackup];

  if (!v5)
  {
    goto LABEL_14;
  }

  if ([v3 isRestoreFromBackupSourceCloud])
  {
    v6 = 2;
  }

  else
  {
    v6 = 0;
  }

  if ([v3 isRestoreFromBackupSourceMegaBackup])
  {
    v6 = 7;
  }

  if ([v3 isRestoreFromBackupSourceiTunes])
  {
    v6 = 1;
  }

  if ([v3 isRestoreFromBackupSourceDeviceToDevice])
  {
    v6 = 3;
  }

LABEL_17:

  return v6;
}

- (int64_t)createNewDatabaseWithMigrationType:(int64_t)a3 forceRebuildReason:(id)a4 coordinator:(id)a5 error:(id *)a6
{
  v157 = *MEMORY[0x1E69E9840];
  v11 = a4;
  v12 = a5;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v122 = [MEMORY[0x1E696AAA8] currentHandler];
    v123 = NSStringFromSelector(a2);
    [v122 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:952 description:{@"%@ can only be called from assetsd", v123}];
  }

  if ((a3 | 2) != 3)
  {
    v13 = [MEMORY[0x1E696AAA8] currentHandler];
    [v13 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:953 description:{@"Invalid parameter not satisfying: %@", @"requestedType == PLMigrationTypeCreated || requestedType == PLMigrationTypeRebuild"}];
  }

  v14 = [(PLModelMigrator *)self pathManager];
  v15 = [v14 isSystemPhotoLibraryPathManager];
  if (a3 == 4)
  {
    v16 = 0;
    goto LABEL_7;
  }

  v130 = a2;
  v16 = 0;
  if ([PLRebuildJournalManager isEnabledWithPathManager:v14 error:0])
  {
    v152 = 0;
    v20 = [PLRebuildJournalManager existingJournalsCompatibleForRebuild:v14 error:&v152];
    v16 = v152;
    if (!v20)
    {
      v26 = PLMigrationGetLog();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v154 = v16;
        _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, "Existing journals are incompatible for rebuild %@", buf, 0xCu);
      }

LABEL_7:
      v151 = 0;
      v17 = 4;
      v18 = v16;
      if (v16)
      {
LABEL_8:
        if (a6)
        {
          v19 = v18;
          *a6 = v18;
        }

        v16 = v18;
        goto LABEL_140;
      }

      goto LABEL_127;
    }
  }

  v151 = 0;
  v21 = PLMigrationGetLog();
  v132 = a6;
  v133 = v15;
  if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
  {
    v22 = PLStringFromMigrationType(a3, 1);
    v23 = [v14 libraryURL];
    *buf = 138543618;
    v154 = v22;
    v155 = 2112;
    v156 = v23;
    _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "Started %{public}@ of %@", buf, 0x16u);

    a6 = v132;
  }

  v150 = 0;
  v24 = [(PLModelMigrator *)self _createPhotoDataDirectoryIfNecessary:&v151 error:&v150];
  v25 = v150;
  if (v24)
  {

    context = objc_autoreleasePoolPush();
    v127 = v12;
    if (v151)
    {
      v129 = [MEMORY[0x1E695DF90] dictionary];
      v125 = a3;
    }

    else
    {
      v27 = [v14 photosDatabasePath];
      v28 = [MEMORY[0x1E696AC08] defaultManager];
      v29 = [v28 fileExistsAtPath:v27];

      if (v29)
      {
        v30 = [v14 libraryURL];
        if (v30)
        {
          v31 = [v14 capabilities];
          v32 = [v31 isCentralizedCacheDeleteCapable];

          if (v32)
          {
            v33 = PLMigrationGetLog();
            if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
            {
              *buf = 138412290;
              v154 = v30;
              _os_log_impl(&dword_19BF1F000, v33, OS_LOG_TYPE_DEFAULT, "Clearing purgeable flags before rebuild for photo library at %@", buf, 0xCu);
            }

            if (![PLCacheDeleteSupport clearPurgeableFlagsForAllResourcesInPhotoLibraryURL:v30])
            {
              v34 = PLMigrationGetLog();
              if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
              {
                *buf = 138412290;
                v154 = v30;
                _os_log_impl(&dword_19BF1F000, v34, OS_LOG_TYPE_ERROR, "Failed to clear purgeable flags for photo library %@", buf, 0xCu);
              }
            }
          }
        }

        v35 = PLMigrationGetLog();
        if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v35, OS_LOG_TYPE_DEFAULT, "Trying to persist path->uuid mapping", buf, 2u);
        }

        v129 = [(PLModelMigrator *)self generatePathToAssetUUIDRecoveryMapping];
        [PLManagedObjectContext removePhotosDatabaseWithPathManager:v14];
        v125 = 1;
      }

      else
      {
        v30 = PLMigrationGetLog();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v27;
          _os_log_impl(&dword_19BF1F000, v30, OS_LOG_TYPE_ERROR, "No store file to move aside at %@", buf, 0xCu);
        }

        v129 = 0;
        v125 = a3;
      }
    }

    v128 = v11;
    v36 = PLMigrationGetLog();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v36, OS_LOG_TYPE_DEFAULT, "Removing derivatives", buf, 2u);
    }

    if ([PLRebuildJournalManager isEnabledWithPathManager:v14 error:0])
    {
      v37 = [(PLModelMigrator *)self pathManager];
      v38 = [PLRebuildJournalManager assetJournalExists:v37 error:0];

      if (v38)
      {
        [v14 photoDirectoryCreationMaskResetWithType:11];
        v149 = 0;
        v39 = [v14 photoDirectoryWithType:11 createIfNeeded:1 error:&v149];
        v40 = v149;

        if (!v39)
        {
          v41 = PLMigrationGetLog();
          if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412290;
            v154 = v40;
            _os_log_impl(&dword_19BF1F000, v41, OS_LOG_TYPE_ERROR, "Error obtaining path for thumbs directory: %@", buf, 0xCu);
          }
        }

        v42 = [(PLModelMigrator *)self pathManager];
        [(PLThumbnailManagerCore *)PLThumbnailManager removeThumbnailTablesUnsupportedOnly:0 withPathManager:v42];

        v43 = [(PLModelMigrator *)self pathManager];
        v44 = [(PLThumbnailManagerCore *)PLThumbnailManager thumbnailConfigurationDictWithPathManager:v43];

        v45 = [(PLModelMigrator *)self pathManager];
        v46 = 1;
        [(PLThumbnailManagerCore *)PLThumbnailManager stampThumbnailConfiguration:v44 toFile:1 withPathManager:v45];
        goto LABEL_88;
      }
    }

    v47 = [(PLModelMigrator *)self pathManager];
    [(PLThumbnailManagerCore *)PLThumbnailManager removeThumbnailTablesUnsupportedOnly:0 withPathManager:v47];

    v148 = 0;
    v48 = [v14 photoDirectoryWithType:12 createIfNeeded:0 error:&v148];
    v49 = v148;
    if (v48)
    {
      v50 = [MEMORY[0x1E69BF238] fileManager];
      v147 = v49;
      v51 = [v50 removeItemAtPath:v48 error:&v147];
      v52 = v147;

      if ((v51 & 1) == 0)
      {
        v53 = PLIsErrorFileNotFound();

        if (v53)
        {
          goto LABEL_58;
        }

        v50 = PLMigrationGetLog();
        if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v52;
          _os_log_impl(&dword_19BF1F000, v50, OS_LOG_TYPE_ERROR, "Error removing master thumbs directory: %@", buf, 0xCu);
        }
      }
    }

    else
    {
      v50 = PLMigrationGetLog();
      if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v154 = v49;
        _os_log_impl(&dword_19BF1F000, v50, OS_LOG_TYPE_ERROR, "Error obtaining path for master thumbs directory: %@", buf, 0xCu);
      }

      v52 = v49;
    }

LABEL_58:
    v124 = v48;
    if (![v14 isDCIM])
    {
LABEL_71:
      v61 = [MEMORY[0x1E696AC08] defaultManager];
      v62 = [v14 photoDirectoryWithType:10];
      v144 = v52;
      v63 = [v61 removeItemAtPath:v62 error:&v144];
      v64 = v144;

      if ((v63 & 1) == 0)
      {
        v65 = PLMigrationGetLog();
        if (os_log_type_enabled(v65, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v64;
          _os_log_impl(&dword_19BF1F000, v65, OS_LOG_TYPE_ERROR, "Error removing derivatives directory: %@", buf, 0xCu);
        }
      }

      [v14 photoDirectoryCreationMaskResetWithType:10];
      [v14 photoDirectoryCreationMaskResetWithType:11];
      [v14 photoDirectoryCreationMaskResetWithType:12];
      v143 = v64;
      v66 = [v14 photoDirectoryWithType:10 createIfNeeded:1 error:&v143];
      v67 = v143;

      if (!v66)
      {
        v68 = PLMigrationGetLog();
        if (os_log_type_enabled(v68, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v67;
          _os_log_impl(&dword_19BF1F000, v68, OS_LOG_TYPE_ERROR, "Error obtaining path for derivatives directory: %@", buf, 0xCu);
        }
      }

      v142 = v67;
      v69 = [v14 photoDirectoryWithType:11 createIfNeeded:1 error:&v142];
      v70 = v142;

      if (!v69)
      {
        v71 = PLMigrationGetLog();
        if (os_log_type_enabled(v71, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v70;
          _os_log_impl(&dword_19BF1F000, v71, OS_LOG_TYPE_ERROR, "Error obtaining path for thumbs directory: %@", buf, 0xCu);
        }
      }

      v141 = v70;
      v72 = [v14 photoDirectoryWithType:12 createIfNeeded:1 error:&v141];
      v40 = v141;

      if (!v72)
      {
        v73 = PLMigrationGetLog();
        if (os_log_type_enabled(v73, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v40;
          _os_log_impl(&dword_19BF1F000, v73, OS_LOG_TYPE_ERROR, "Error obtaining path for master thumbs directory: %@", buf, 0xCu);
        }
      }

      v74 = [(PLModelMigrator *)self pathManager];
      v45 = [(PLThumbnailManagerCore *)PLThumbnailManager thumbnailConfigurationDictWithPathManager:v74];

      v75 = [(PLModelMigrator *)self pathManager];
      [(PLThumbnailManagerCore *)PLThumbnailManager stampThumbnailConfiguration:v45 toFile:1 withPathManager:v75];

      v46 = 0;
      v44 = v124;
LABEL_88:

      [v14 removePartialVideoDirectory];
      [v14 removeComputeDirectory];
      v76 = PLMigrationGetLog();
      if (os_log_type_enabled(v76, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v76, OS_LOG_TYPE_DEFAULT, "Creating database", buf, 2u);
      }

      [(PLModelMigrator *)self _repairMetadataAndSingletonsForMigrationType:a3 forceRebuildReason:v11 journalRebuildRequired:v46];
      [(PLModelMigrator *)self archiveAssetUUIDForPathPlist:v129];
      v77 = v133;
      if (v133)
      {
        v78 = PLMigrationGetLog();
        if (os_log_type_enabled(v78, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v78, OS_LOG_TYPE_DEFAULT, "Telling mstreamd to forget everything", buf, 2u);
        }

        [PLPhotoSharingHelper forgetSharingPersonID:0];
        v79 = +[PLNotificationManager sharedManager];
        [v79 discardAllNotifications];
      }

      v137[0] = MEMORY[0x1E69E9820];
      v137[1] = 3221225472;
      v137[2] = __91__PLModelMigrator_createNewDatabaseWithMigrationType_forceRebuildReason_coordinator_error___block_invoke;
      v137[3] = &unk_1E7568BA8;
      v80 = v14;
      v139 = self;
      v140 = v130;
      v138 = v80;
      [v80 enumerateBundleScopesWithBlock:v137];
      if (([v80 isDCIM] & v133) == 1)
      {
        v81 = PLMigrationGetLog();
        if (os_log_type_enabled(v81, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v81, OS_LOG_TYPE_DEFAULT, "Removing photo cloud sharing data directory", buf, 2u);
        }

        v136 = 0;
        v82 = [PLPhotoSharingHelper removeCloudSharingDirectories:&v136];
        v83 = v136;
        v77 = v133;
        if (!v82)
        {
          v84 = v40;
          v85 = PLMigrationGetLog();
          if (os_log_type_enabled(v85, OS_LOG_TYPE_DEFAULT))
          {
            *buf = 138412290;
            v154 = v83;
            _os_log_impl(&dword_19BF1F000, v85, OS_LOG_TYPE_DEFAULT, "Failed to remove photo cloud sharing data directory: %@", buf, 0xCu);
          }

          v40 = v84;
        }
      }

      if (PLPlatformSearchSupported())
      {
        v86 = PLMigrationGetLog();
        if (os_log_type_enabled(v86, OS_LOG_TYPE_INFO))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v86, OS_LOG_TYPE_INFO, "Dropping any prior search index", buf, 2u);
        }

        v87 = [(PLModelMigrator *)self pathManager];
        v88 = [v87 libraryURL];
        v89 = [PLLibraryServicesManager libraryServicesManagerForLibraryURL:v88];

        v90 = [v89 searchIndexingEngine];
        v91 = [MEMORY[0x1E696AEC0] stringWithFormat:@"new database (force rebuild reason: %@)", v11];
        [v90 dropSearchIndexWithSourceName:v91 completion:0];

        v77 = v133;
      }

      [(PLModelMigrator *)self applyDataProtectionToAllPhotosFilesOnce];
      if (([v80 isDCIM] & v77) == 1 && -[PLModelMigrator isCloudPhotoLibraryEnabled](self, "isCloudPhotoLibraryEnabled"))
      {
        v92 = [(PLModelMigrator *)self deviceRestoreMigrationSupport];
        if ([v92 isRestoreFromBackup])
        {
          v93 = [(PLModelMigrator *)self postProcessingToken];
          v94 = [v93 isModelMigrationRestorePostProcessingComplete];

          if (!v94)
          {
            goto LABEL_115;
          }
        }

        else
        {
        }

        v95 = PLMigrationGetLog();
        if (os_log_type_enabled(v95, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v95, OS_LOG_TYPE_DEFAULT, "Generating album metadata from iTunes lastsynced plist", buf, 2u);
        }

        [(PLModelMigrator *)self _generateAlbumMetadataFromLastiTunesSyncedPlist];
      }

LABEL_115:
      v96 = [v11 integerValue];
      if (v96 >= 1)
      {
        v97 = v96;
        v98 = [(PLModelMigrator *)self analyticsEventManager];
        v99 = [MEMORY[0x1E696AD98] numberWithInteger:v97];
        [v99 stringValue];
        v131 = v14;
        v100 = self;
        v101 = v80;
        v102 = v16;
        v103 = a3;
        v105 = v104 = v40;
        v106 = *MEMORY[0x1E69BF740];
        [v98 setPayloadValue:v105 forKey:*MEMORY[0x1E69BF770] onEventWithName:*MEMORY[0x1E69BF740]];

        v40 = v104;
        a3 = v103;
        v16 = v102;
        v80 = v101;
        self = v100;
        v14 = v131;

        v107 = [(PLModelMigrator *)self analyticsEventManager];
        v108 = PLRebuildReasonToShortString(v97);
        v109 = v106;
        v11 = v128;
        [v107 setPayloadValue:v108 forKey:*MEMORY[0x1E69BF768] onEventWithName:v109];
      }

      v110 = [(PLModelMigrator *)self pathManager];
      [PLModelMigrationAction_CPLPrompting shouldRepromptUserIfNeededWithPathManager:v110];

      objc_autoreleasePoolPop(context);
      v17 = v125;
      if (v125 == 1)
      {
        v12 = v127;
        if ([v80 isDCIM])
        {
          v111 = MEMORY[0x1E695DFF8];
          v112 = [v80 photoDirectoryWithType:2];
          v17 = 1;
          v113 = [v111 fileURLWithPath:v112 isDirectory:1];

          v135 = v16;
          LOBYTE(v111) = [MEMORY[0x1E69BF2A8] setTimeMachineExclusionAttribute:0 url:v113 error:&v135];
          v18 = v135;

          if ((v111 & 1) == 0)
          {
            v114 = PLMigrationGetLog();
            if (os_log_type_enabled(v114, OS_LOG_TYPE_ERROR))
            {
              *buf = 138412290;
              v154 = v18;
              _os_log_impl(&dword_19BF1F000, v114, OS_LOG_TYPE_ERROR, "Failed to remove the exclusion attribute on PhotoData dir during rebuild: %@", buf, 0xCu);
            }

            v17 = 4;
          }
        }

        else
        {
          v17 = 1;
          v18 = v16;
        }
      }

      else
      {
        v18 = v16;
        v12 = v127;
      }

      a6 = v132;
      v15 = v133;
      if (v18)
      {
        goto LABEL_8;
      }

LABEL_127:
      if (a3 == 3 && v17 == 3)
      {
        v116 = v15;
      }

      else
      {
        v116 = 0;
      }

      if (v116 == 1)
      {
        v117 = MEMORY[0x1E69BF2A0];
        v118 = [v14 libraryURL];
        v134 = 0;
        LOBYTE(v117) = [v117 setSystemLibraryURL:v118 options:0 error:&v134];
        v119 = v134;

        if ((v117 & 1) == 0)
        {
          v120 = PLMigrationGetLog();
          if (os_log_type_enabled(v120, OS_LOG_TYPE_ERROR))
          {
            *buf = 138412290;
            v154 = v119;
            _os_log_impl(&dword_19BF1F000, v120, OS_LOG_TYPE_ERROR, "Error setting SPL URL after creation: %@", buf, 0xCu);
          }
        }

        v16 = 0;
        v17 = 3;
      }

      else
      {
        v16 = 0;
      }

      goto LABEL_140;
    }

    v146 = v52;
    v54 = [v14 photoDirectoryWithType:31 createIfNeeded:0 error:&v146];
    v55 = v146;

    if (!v54)
    {
      v58 = PLMigrationGetLog();
      if (os_log_type_enabled(v58, OS_LOG_TYPE_ERROR))
      {
        *buf = 138412290;
        v154 = v55;
        _os_log_impl(&dword_19BF1F000, v58, OS_LOG_TYPE_ERROR, "Error obtaining path for local video key frames directory: %@", buf, 0xCu);
      }

      v52 = v55;
      goto LABEL_70;
    }

    v56 = [MEMORY[0x1E69BF238] fileManager];
    v145 = v55;
    v57 = [v56 removeItemAtPath:v54 error:&v145];
    v52 = v145;

    if (v57)
    {
    }

    else
    {
      v59 = PLIsErrorFileNotFound();

      if ((v59 & 1) == 0)
      {
        v60 = PLMigrationGetLog();
        if (os_log_type_enabled(v60, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412290;
          v154 = v52;
          _os_log_impl(&dword_19BF1F000, v60, OS_LOG_TYPE_ERROR, "Error removing local video key frames directory: %@", buf, 0xCu);
        }

        goto LABEL_70;
      }
    }

    [v14 photoDirectoryCreationMaskResetWithType:31];
LABEL_70:

    goto LABEL_71;
  }

  if (a6)
  {
    v25 = v25;
    *a6 = v25;
  }

  v17 = 4;
LABEL_140:

  return v17;
}

void __91__PLModelMigrator_createNewDatabaseWithMigrationType_forceRebuildReason_coordinator_error___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3)
{
  v24 = *MEMORY[0x1E69E9840];
  if (([MEMORY[0x1E69BF2A0] bundleScopeShouldBePersistedForRebuild:a2] & 1) == 0)
  {
    v6 = [*(a1 + 32) photoDirectoryWithType:a3];
    if (a2 && a3 != 1)
    {
      v7 = [*(a1 + 32) baseDirectory];
      if ([v6 isEqualToString:v7])
      {
      }

      else
      {
        v8 = [*(a1 + 32) baseDirectory];
        v9 = [v6 hasPrefix:v8];

        if (v9)
        {
          goto LABEL_7;
        }
      }
    }

    v10 = [MEMORY[0x1E696AAA8] currentHandler];
    [v10 handleFailureInMethod:*(a1 + 48) object:*(a1 + 40) file:@"PLModelMigrator.m" lineNumber:1110 description:{@"Attempted to remove main bundle directory, bundleScope: %d, pathType, %d, path: %@", a2, a3, v6}];

LABEL_7:
    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 67109378;
      v19 = a2;
      v20 = 2112;
      v21 = v6;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Removing resources for bundle scope %d at path %@", buf, 0x12u);
    }

    v12 = [MEMORY[0x1E696AC08] defaultManager];
    v17 = 0;
    v13 = [v12 removeItemAtPath:v6 error:&v17];
    v14 = v17;
    if (v13)
    {
    }

    else
    {
      v15 = PLIsErrorFileNotFound();

      if ((v15 & 1) == 0)
      {
        v16 = PLMigrationGetLog();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
        {
          *buf = 67109634;
          v19 = a2;
          v20 = 2112;
          v21 = v6;
          v22 = 2112;
          v23 = v14;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_ERROR, "Couldn't remove bundle scope %d on library creation at path %@: %@", buf, 0x1Cu);
        }

        goto LABEL_16;
      }
    }

    [*(a1 + 32) photoDirectoryCreationMaskResetWithType:a3];
LABEL_16:
  }
}

- (int64_t)promptUserIfNeededForRebuildReason:(id)a3 migrationError:(id)a4
{
  v28 = *MEMORY[0x1E69E9840];
  v6 = a3;
  v7 = a4;
  if ([objc_opt_class() shouldPromptUserForLibrarySchemaMismatch] && objc_msgSend(objc_opt_class(), "shouldPromptUserForRebuildWithLibraryPathManager:", self->_pathManager))
  {
    if (v6)
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        v9 = [v6 integerValue];
        if ((v9 - 1) > 0x14)
        {
          v10 = @"PLRebuildReasonUnknown";
        }

        else
        {
          v10 = off_1E7573690[v9 - 1];
        }

        v16 = v10;
        *buf = 138543362;
        v27 = v16;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Skipping rebuild prompt due to force rebuild: %{public}@", buf, 0xCu);
      }

LABEL_14:
      v11 = 0;
LABEL_36:

      goto LABEL_37;
    }

    if ((PLIsErrorEqualToCode() & 1) == 0 && (PLIsErrorEqualToCode() & 1) == 0)
    {
      v8 = PLMigrationGetLog();
      if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
      {
        *buf = 138412290;
        v27 = v7;
        _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_DEFAULT, "Skipping rebuild prompt due to non-prompting migration error: %@", buf, 0xCu);
      }

      goto LABEL_14;
    }

    v12 = MEMORY[0x1E696AEC0];
    v13 = [(__CFString *)v7 userInfo];
    v14 = [v13 objectForKeyedSubscript:*MEMORY[0x1E696A278]];
    v15 = v14;
    if (v14)
    {
      v8 = [v12 stringWithFormat:@"Photos cannot proceed with the library in its current state.\n\n%@\n\nSelect Rebuild to allow rebuild of the photo library database (possible data loss) or Not now to stop now and leave it as-is", v14];
    }

    else
    {
      v17 = [(__CFString *)v7 debugDescription];
      v8 = [v12 stringWithFormat:@"Photos cannot proceed with the library in its current state.\n\n%@\n\nSelect Rebuild to allow rebuild of the photo library database (possible data loss) or Not now to stop now and leave it as-is", v17];
    }

    v18 = [[PLRebuildUserNotification alloc] initWithMessage:v8];
    v19 = [(PLRebuildUserNotification *)v18 showAlertAndWaitForResponse];
    if (v19 != 2)
    {
      v11 = v19;
      if (v19 == 1)
      {
        v24 = PLMigrationGetLog();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v24, OS_LOG_TYPE_DEFAULT, "prompted user for rebuild: user responded with Rebuild, allowing rebuild", buf, 2u);
        }

        v22 = [objc_alloc(MEMORY[0x1E695E000]) initWithSuiteName:@"com.apple.mobileslideshow"];
        [v22 setBool:0 forKey:@"com.apple.Photos.PreventRebuild"];
        v23 = PLMigrationGetLog();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "user prompt updated prevent rebuild: NO", buf, 2u);
        }

        v11 = 1;
        goto LABEL_34;
      }

      if (v19)
      {
LABEL_35:

        goto LABEL_36;
      }

      v20 = PLMigrationGetLog();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        *buf = 0;
        _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "User prompt timed out. Assuming user does not want rebuild, changing response to Not Now.", buf, 2u);
      }
    }

    v21 = PLMigrationGetLog();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_DEFAULT, "prompted user for rebuild: user responded with Not Now, preventing rebuild", buf, 2u);
    }

    v22 = [objc_alloc(MEMORY[0x1E695E000]) initWithSuiteName:@"com.apple.mobileslideshow"];
    [v22 setBool:1 forKey:@"com.apple.Photos.PreventRebuild"];
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      v11 = 2;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "user prompt: updated prevent rebuild: YES", buf, 2u);
    }

    else
    {
      v11 = 2;
    }

LABEL_34:

    goto LABEL_35;
  }

  v11 = 0;
LABEL_37:

  return v11;
}

- (BOOL)_createPhotoDataDirectoryIfNecessary:(BOOL *)a3 error:(id *)a4
{
  v45 = *MEMORY[0x1E69E9840];
  v7 = objc_alloc_init(MEMORY[0x1E696AC08]);
  v8 = [(PLModelMigrator *)self pathManager];
  v9 = [v8 photosDatabasePath];

  v10 = [v9 stringByDeletingLastPathComponent];
  v11 = [v7 fileExistsAtPath:v10 isDirectory:0];
  if ((v11 & 1) == 0)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_DEFAULT, "Creating missing directory for database", buf, 2u);
    }

    v40 = 0;
    v24 = [v7 createDirectoryAtPath:v10 withIntermediateDirectories:1 attributes:0 error:&v40];
    v13 = v40;
    if (v24)
    {
      goto LABEL_8;
    }

    v28 = PLMigrationGetLog();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v42 = v10;
      v43 = 2112;
      v44 = v13;
      _os_log_impl(&dword_19BF1F000, v28, OS_LOG_TYPE_ERROR, "Unable to create database directory at %@: %@", buf, 0x16u);
    }

    if (a4)
    {
      v29 = v13;
      *a4 = v13;
    }

LABEL_20:

    v25 = 0;
    goto LABEL_21;
  }

  v12 = [(PLModelMigrator *)self pathManager];
  v13 = [v12 photoDirectoryWithType:6];

  v39 = 0;
  LOBYTE(v12) = [v7 createDirectoryAtPath:v13 withIntermediateDirectories:1 attributes:0 error:&v39];
  v14 = v39;
  if ((v12 & 1) == 0)
  {
    v26 = PLMigrationGetLog();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v42 = v13;
      v43 = 2112;
      v44 = v14;
      _os_log_impl(&dword_19BF1F000, v26, OS_LOG_TYPE_ERROR, "Unable to create private cache subdirectory at %@: %@", buf, 0x16u);
    }

    if (a4)
    {
      v27 = v14;
      *a4 = v14;
    }

    goto LABEL_20;
  }

  v35 = v7;
  v36 = v10;
  v37 = v9;
  v33 = a3;
  v34 = a4;
  v15 = objc_alloc_init(MEMORY[0x1E696AB78]);
  [v15 setDateFormat:@"yyyyMMdd-HHmmssZZZZZ"];
  v16 = [MEMORY[0x1E695DF00] date];
  v17 = [v15 stringFromDate:v16];

  v18 = [@"CreateDatabase_" stringByAppendingString:v17];
  v19 = [v13 stringByAppendingPathComponent:v18];
  v20 = [MEMORY[0x1E695DEF0] data];
  v38 = v14;
  v21 = [v20 writeToFile:v19 options:0 error:&v38];
  v22 = v38;

  if (v21)
  {

    a3 = v33;
    v10 = v36;
    v9 = v37;
    v7 = v35;
LABEL_8:

    if (a3)
    {
      *a3 = v11 ^ 1;
    }

    v25 = 1;
    goto LABEL_21;
  }

  v31 = PLMigrationGetLog();
  if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
  {
    *buf = 138543618;
    v42 = v18;
    v43 = 2112;
    v44 = v13;
    _os_log_impl(&dword_19BF1F000, v31, OS_LOG_TYPE_ERROR, "Unable to write file %{public}@ to cacheDir %@", buf, 0x16u);
  }

  if (v34)
  {
    v32 = v22;
    *v34 = v22;
  }

  v25 = 0;
  v10 = v36;
  v9 = v37;
  v7 = v35;
LABEL_21:

  return v25;
}

- (BOOL)shouldCreateDatabase
{
  if ((PLIsAssetsd() & 1) == 0)
  {
    v17 = [MEMORY[0x1E696AAA8] currentHandler];
    [v17 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:801 description:@"Only Assetsd should be checking if _shouldCreateDatabase!"];
  }

  v4 = [MEMORY[0x1E69BF238] fileManager];
  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 photosDatabasePath];
  v7 = [v4 fileExistsAtPath:v6];

  if (!v7)
  {
    v13 = PLMigrationGetLog();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v18 = 0;
      v14 = "Should create database: database is missing";
      v15 = &v18;
      goto LABEL_11;
    }

LABEL_12:

    return 1;
  }

  v8 = [(PLModelMigrator *)self pathManager];
  v9 = [v8 isDeviceRestoreSupported];

  if (v9)
  {
    v10 = [(PLModelMigrator *)self postProcessingToken];
    if ([v10 needsToPrepareForBackgroundRestore])
    {
      v11 = [(PLModelMigrator *)self postProcessingToken];
      v12 = [v11 isBackgroundRestorePostProcessingInProgressTokenValid];

      if ((v12 & 1) == 0)
      {
        v13 = PLMigrationGetLog();
        if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
        {
          v19 = 0;
          v14 = "Should create database: post processing token is invalid (too many failed attempts to restore with the existing database)";
          v15 = &v19;
LABEL_11:
          _os_log_impl(&dword_19BF1F000, v13, OS_LOG_TYPE_INFO, v14, v15, 2u);
          goto LABEL_12;
        }

        goto LABEL_12;
      }
    }

    else
    {
    }
  }

  return 0;
}

- (int64_t)migrateOrCreateDatabaseIfNecessaryWithPersistentContainer:(id)a3 migrationPolicy:(unsigned int)a4 error:(id *)a5
{
  v6 = *&a4;
  v46[1] = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = objc_autoreleasePoolPush();
  v10 = [(PLModelMigrator *)self shouldCreateDatabase];
  v11 = PLMigrationGetLog();
  v12 = os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT);
  if (v10)
  {
    v38 = v9;
    if (v12)
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Attempting create new database", buf, 2u);
    }

    v40 = 0;
    v13 = [(PLModelMigrator *)self createNewDatabaseWithMigrationType:3 forceRebuildReason:0 coordinator:0 error:&v40];
    v14 = v40;
    v15 = [(PLModelMigrator *)self analyticsEventManager];
    v16 = [MEMORY[0x1E696AD98] numberWithInt:v13 != 4];
    v17 = *MEMORY[0x1E69BF6A8];
    [v15 setPayloadValue:v16 forKey:*MEMORY[0x1E69BF6C0] onEventWithName:*MEMORY[0x1E69BF6A8]];

    v18 = [MEMORY[0x1E696AD98] numberWithInt:{+[PLModelMigrator currentModelVersion](PLModelMigrator, "currentModelVersion")}];
    v19 = [v18 stringValue];
    [v15 setPayloadValue:v19 forKey:*MEMORY[0x1E69BF6B8] onEventWithName:v17];

    [v15 setPayloadValue:v14 forKey:*MEMORY[0x1E69BF6B0] onEventWithName:v17];
    v20 = v14;
LABEL_5:

    v9 = v38;
    goto LABEL_11;
  }

  if (v12)
  {
    *buf = 0;
    _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Attempting open existing database", buf, 2u);
  }

  v39 = 0;
  v13 = [v8 configureSharedPersistentStoreCoordinatorAndMigrateOrRebuildIfNecessaryWithModelMigrator:self migrationPolicy:v6 error:&v39];
  v15 = v39;
  if (v13 != 4)
  {
    v21 = [(PLModelMigrator *)self options];

    if (!v21)
    {
      v38 = v9;
      v14 = [v8 sharedPersistentStoreCoordinatorWithError:0];
      v27 = [(PLModelMigrator *)self managedObjectContextForMigrationWithName:"migrateOrCreateDatabaseIfNecessaryWithPersistentContainer" persistentStoreCoordinator:v14 concurrencyType:1];
      v28 = [[PLGlobalValues alloc] initWithManagedObjectContext:v27];
      v29 = [(PLGlobalValues *)v28 libraryCreateOptions];
      if (v29)
      {
        v30 = v29;
        v36 = v28;
        v37 = v27;
        v31 = [(PLModelMigrator *)self options];

        if (v31)
        {
          v32 = [(PLModelMigrator *)self options];
          v33 = [v32 mutableCopy];

          v34 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:v30];
          [v33 setObject:v34 forKeyedSubscript:@"PLPhotoLibraryCreateOptions"];

          [(PLModelMigrator *)self setOptions:v33];
        }

        else
        {
          v45 = @"PLPhotoLibraryCreateOptions";
          v33 = [MEMORY[0x1E696AD98] numberWithUnsignedInteger:v30];
          v46[0] = v33;
          v35 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v46 forKeys:&v45 count:1];
          [(PLModelMigrator *)self setOptions:v35];
        }

        v28 = v36;
        v27 = v37;
      }

      v20 = v15;
      goto LABEL_5;
    }
  }

  v20 = v15;
LABEL_11:

  [(NSProgress *)self->_progress setCompletedUnitCount:[(NSProgress *)self->_progress totalUnitCount]];
  v22 = PLMigrationGetLog();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = PLStringFromMigrationPolicyOptions(v6);
    v24 = PLStringFromMigrationType(v13, 0);
    *buf = 138543618;
    v42 = v23;
    v43 = 2114;
    v44 = v24;
    _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_DEFAULT, "migrateOrCreateDatabaseIfNecessary policy:%{public}@ result: %{public}@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  if (a5)
  {
    v25 = v20;
    *a5 = v20;
  }

  return v13;
}

- (int64_t)checkForceRebuildIndicatorFile
{
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 sqliteErrorIndicatorFileExists];

  return v4 && !self->_didCreateSqliteErrorFileForLightweightMigration;
}

- (BOOL)debug_resetThumbnailsAndInitiateRebuildRequestInStore:(id)a3
{
  v4 = *MEMORY[0x1E695D708];
  v5 = a3;
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator debug_resetThumbnailsAndInitiateRebuildRequestInStore:]" concurrencyType:v4];
  v7 = [(PLModelMigrator *)self _migrationThumbnailManagerWithStore:v5];

  LOBYTE(v5) = [v7 resetThumbnailsForced:1 isMissingTables:0 inContext:v6];
  return v5;
}

- (BOOL)_removeEvents:(id)a3
{
  v39 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v24 = [MEMORY[0x1E696AAA8] currentHandler];
    v25 = NSStringFromSelector(a2);
    [v24 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:678 description:{@"%@ can be called only from assetsd.", v25}];
  }

  aSelector = a2;
  v6 = objc_autoreleasePoolPush();
  v7 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _removeEvents:]" concurrencyType:*MEMORY[0x1E695D708]];
  v8 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"GenericAlbum"];
  v9 = MEMORY[0x1E696AE18];
  v10 = [MEMORY[0x1E696AD98] numberWithInt:12];
  v11 = [v9 predicateWithFormat:@"kind == %@", v10];

  [v8 setPredicate:v11];
  v33 = 0;
  v12 = [v7 executeFetchRequest:v8 error:&v33];
  v13 = v33;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v32 = 0u;
  v14 = v12;
  v15 = [v14 countByEnumeratingWithState:&v29 objects:v38 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v30;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v30 != v17)
        {
          objc_enumerationMutation(v14);
        }

        [*(*(&v29 + 1) + 8 * i) delete];
      }

      v16 = [v14 countByEnumeratingWithState:&v29 objects:v38 count:16];
    }

    while (v16);
  }

  if ([v7 hasChanges])
  {
    v19 = v6;
    v28 = 0;
    v20 = [v7 save:&v28];
    v21 = v28;
    if ((v20 & 1) == 0)
    {
      v22 = PLMigrationGetLog();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
      {
        aSelectora = NSStringFromSelector(aSelector);
        *buf = 138412546;
        v35 = aSelectora;
        v36 = 2112;
        v37 = v21;
        _os_log_impl(&dword_19BF1F000, v22, OS_LOG_TYPE_ERROR, "%@ failed: %@", buf, 0x16u);
      }
    }

    v6 = v19;
  }

  else
  {
    v20 = 1;
  }

  [v7 reset];

  objc_autoreleasePoolPop(v6);
  return v20;
}

- (BOOL)_forceSoftResetSync
{
  if ((PLIsAssetsd() & 1) == 0)
  {
    v10 = [MEMORY[0x1E696AAA8] currentHandler];
    v11 = NSStringFromSelector(a2);
    [v10 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:666 description:{@"%@ can be called only from assetsd.", v11}];
  }

  v4 = +[PLPhotoLibraryBundleController sharedBundleController];
  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 libraryURL];
  v7 = [v4 openBundleAtLibraryURL:v6];

  v8 = [v7 indicatorFileCoordinator];
  [v8 forceSoftResetSync];

  return 1;
}

- (BOOL)_disableICloudPhoto
{
  if ((PLIsAssetsd() & 1) == 0)
  {
    v8 = [MEMORY[0x1E696AAA8] currentHandler];
    v9 = NSStringFromSelector(a2);
    [v8 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:655 description:{@"%@ can be called only from assetsd.", v9}];
  }

  v4 = [(PLModelMigrator *)self pathManager];
  v5 = [v4 libraryURL];
  v6 = [PLLibraryServicesManager libraryServicesManagerForLibraryURL:v5];

  [v6 setICloudPhotosEnabledInternal:0];
  return 1;
}

- (BOOL)_verifyCloudAssetsLocalAvailability:(id)a3
{
  v41 = *MEMORY[0x1E69E9840];
  v5 = a3;
  if ((PLIsAssetsd() & 1) == 0)
  {
    v25 = [MEMORY[0x1E696AAA8] currentHandler];
    v26 = NSStringFromSelector(a2);
    [v25 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:618 description:{@"%@ can be called only from assetsd.", v26}];
  }

  aSelector = a2;
  v29 = objc_autoreleasePoolPush();
  v30 = v5;
  v6 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v5 name:"[PLModelMigrator _verifyCloudAssetsLocalAvailability:]" concurrencyType:*MEMORY[0x1E695D708]];
  v7 = [MEMORY[0x1E696AC08] defaultManager];
  v28 = [MEMORY[0x1E695D5E0] fetchRequestWithEntityName:@"CloudResource"];
  v8 = [v6 executeFetchRequest:? error:?];
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v35 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v32 objects:v40 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = 0;
    v12 = 0;
    v13 = *v33;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v33 != v13)
        {
          objc_enumerationMutation(v8);
        }

        v15 = *(*(&v32 + 1) + 8 * i);
        v16 = [v15 filePath];
        [v15 setIsLocallyAvailable:{objc_msgSend(v7, "fileExistsAtPath:isDirectory:", v16, 0)}];

        v11 += [v15 isLocallyAvailable];
      }

      v12 += v10;
      v10 = [v8 countByEnumeratingWithState:&v32 objects:v40 count:16];
    }

    while (v10);
  }

  else
  {
    v11 = 0;
    v12 = 0;
  }

  v17 = PLMigrationGetLog();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
  {
    *buf = 134218240;
    v37 = v11;
    v38 = 2048;
    v39 = v12;
    _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_DEFAULT, "%llu out of %llu resources are available locally", buf, 0x16u);
  }

  if ([v6 hasChanges])
  {
    v31 = 0;
    v18 = [v6 save:&v31];
    v19 = v31;
    v20 = v29;
    if ((v18 & 1) == 0)
    {
      v21 = PLMigrationGetLog();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        v22 = NSStringFromSelector(aSelector);
        *buf = 138412546;
        v37 = v22;
        v38 = 2112;
        v39 = v19;
        _os_log_impl(&dword_19BF1F000, v21, OS_LOG_TYPE_ERROR, "%@ failed: %@", buf, 0x16u);
      }
    }

    v23 = v30;
  }

  else
  {
    v18 = 1;
    v20 = v29;
    v23 = v30;
  }

  [v6 reset];

  objc_autoreleasePoolPop(v20);
  return v18;
}

- (id)managedObjectContextForMigrationInStore:(id)a3 name:(const char *)a4 concurrencyType:(unint64_t)a5
{
  v8 = [a3 persistentStoreCoordinator];
  v9 = [(PLModelMigrator *)self managedObjectContextForMigrationWithName:a4 persistentStoreCoordinator:v8 concurrencyType:a5];

  return v9;
}

- (id)managedObjectContextForMigrationWithName:(const char *)a3 persistentStoreCoordinator:(id)a4 concurrencyType:(unint64_t)a5
{
  v9 = a4;
  v10 = *MEMORY[0x1E695D708];
  if (a5 != 1 && v10 != a5)
  {
    v17 = [MEMORY[0x1E696AAA8] currentHandler];
    [v17 handleFailureInMethod:a2 object:self file:@"PLModelMigrator.m" lineNumber:589 description:@"unexpected concurrency type for migration context"];
  }

  pl_dispatch_once();
  v11 = managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType__pl_once_object_21;
  v12 = [objc_alloc(MEMORY[0x1E695D628]) initWithConcurrencyType:a5];
  v13 = [MEMORY[0x1E696AEC0] stringWithUTF8String:a3];
  [v12 setName:v13];

  [v12 setPersistentStoreCoordinator:v9];
  [v12 setMergePolicy:v11];
  if (v10 == a5)
  {
    v14 = [(PLModelMigrator *)self pathManager];
    v15 = [v12 userInfo];
    [v15 setObject:v14 forKeyedSubscript:@"com.apple.photos.PLModelMigratorPathManagerKey"];
  }

  else
  {
    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __103__PLModelMigrator_managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType___block_invoke_2;
    v18[3] = &unk_1E7578848;
    v19 = v12;
    v20 = self;
    [v19 performBlockAndWait:v18];
  }

  return v12;
}

void __103__PLModelMigrator_managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType___block_invoke_2(uint64_t a1)
{
  v3 = [*(a1 + 40) pathManager];
  v2 = [*(a1 + 32) userInfo];
  [v2 setObject:v3 forKeyedSubscript:@"com.apple.photos.PLModelMigratorPathManagerKey"];
}

void __103__PLModelMigrator_managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType___block_invoke()
{
  v0 = [(NSMergePolicy *)[PLMergePolicy alloc] initWithMergeType:2];
  v1 = managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType__pl_once_object_21;
  managedObjectContextForMigrationWithName_persistentStoreCoordinator_concurrencyType__pl_once_object_21 = v0;
}

- (BOOL)_fixIncorrectThumbnailTablesInStore:(id)a3 deferHintChanges:(BOOL)a4
{
  v4 = a4;
  v6 = a3;
  v7 = [(PLModelMigrator *)self pathManager];
  [(PLThumbnailManagerCore *)PLThumbnailManager removeThumbnailTablesUnsupportedOnly:1 withPathManager:v7];

  v8 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v6 name:"[PLModelMigrator _fixIncorrectThumbnailTablesInStore:deferHintChanges:]" concurrencyType:*MEMORY[0x1E695D708]];
  v9 = objc_opt_class();
  v10 = [(PLModelMigrator *)self _migrationThumbnailManagerWithStore:v6];

  LOBYTE(v4) = [v9 resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager:v10 deferHintChanges:v4 inContext:v8];
  return v4;
}

- (BOOL)postProcessThumbnailsOnlyIfVersionMismatchOrMissing:(BOOL *)a3 coordinator:(id)a4
{
  v6 = a4;
  v7 = [(PLModelMigrator *)self pathManager];
  v8 = [(PLThumbnailManagerCore *)PLThumbnailManager hasThumbnailConfigMismatchWithPathManager:v7 comparedToConfigPhase:1];

  v9 = [(PLModelMigrator *)self pathManager];
  v10 = [(PLThumbnailManagerCore *)PLThumbnailManager isMissingThumbnailTablesWithPathManager:v9];

  if (PLIsAssetsdProxyService() || !v8 && !v10)
  {
    if (a3)
    {
      *a3 = 0;
    }

    v15 = 1;
  }

  else
  {
    if (a3)
    {
      *a3 = 1;
    }

    v11 = [v6 persistentStores];
    v12 = [v11 firstObject];

    v13 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:v12 name:"[PLModelMigrator postProcessThumbnailsOnlyIfVersionMismatchOrMissing:coordinator:]" concurrencyType:*MEMORY[0x1E695D708]];
    v14 = [(PLModelMigrator *)self _migrationThumbnailManagerWithStore:v12];
    v15 = [v14 resetThumbnailsForced:0 isMissingTables:v10 inContext:v13];
  }

  return v15;
}

- (unint64_t)_assetCountForContext:(id)a3
{
  v3 = a3;
  v10 = 0;
  v11 = &v10;
  v12 = 0x2020000000;
  v13 = 0;
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __41__PLModelMigrator__assetCountForContext___block_invoke;
  v7[3] = &unk_1E7578910;
  v9 = &v10;
  v4 = v3;
  v8 = v4;
  [v4 performBlockAndWait:v7];
  v5 = v11[3];

  _Block_object_dispose(&v10, 8);
  return v5;
}

void __41__PLModelMigrator__assetCountForContext___block_invoke(uint64_t a1)
{
  v13 = *MEMORY[0x1E69E9840];
  v2 = objc_alloc(MEMORY[0x1E695D5E0]);
  v3 = +[PLManagedAsset entityName];
  v4 = [v2 initWithEntityName:v3];

  v5 = *(a1 + 32);
  v10 = 0;
  v6 = [v5 countForFetchRequest:v4 error:&v10];
  v7 = v10;
  *(*(*(a1 + 40) + 8) + 24) = v6;
  v8 = *(*(a1 + 40) + 8);
  if (*(v8 + 24) == 0x7FFFFFFFFFFFFFFFLL)
  {
    *(v8 + 24) = 0;
    v9 = PLMigrationGetLog();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      *buf = 138543362;
      v12 = v7;
      _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_ERROR, "Failed to count the number of assets. Error: %{public}@", buf, 0xCu);
    }
  }
}

- (unint64_t)_assetCountForLibrary:(id)a3
{
  v4 = [a3 managedObjectContext];
  v5 = [(PLModelMigrator *)self _assetCountForContext:v4];

  return v5;
}

- (unint64_t)assetCountForStore:(id)a3
{
  v4 = [(PLModelMigrator *)self managedObjectContextForMigrationInStore:a3 name:"[PLModelMigrator assetCountForStore:]" concurrencyType:1];
  v5 = [(PLModelMigrator *)self _assetCountForContext:v4];

  return v5;
}

- (void)_validateCurrentModelVersionAttempt:(int64_t)a3
{
  v13 = *MEMORY[0x1E69E9840];
  if ((PLIsAssetsd() & 1) == 0)
  {
    v5 = [MEMORY[0x1E69BF2A0] systemLibraryURL];
    v6 = [PLPhotoLibraryBundleController sharedAssetsdClientForPhotoLibraryURL:v5];
    v7 = [v6 libraryClient];
    v8 = [v7 getCurrentModelVersion];

    if (a3 <= 9 && v8 == -1)
    {
      v9 = PLMigrationGetLog();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
      {
        v10[0] = 67109376;
        v10[1] = a3 + 1;
        v11 = 1024;
        v12 = 10;
        _os_log_impl(&dword_19BF1F000, v9, OS_LOG_TYPE_DEFAULT, "Error getting current model version. Will retry (%d/%d).", v10, 0xEu);
      }

      sleep(1u);
      [(PLModelMigrator *)self _validateCurrentModelVersionAttempt:a3 + 1];
    }

    else if (v8 == -1)
    {
      [(PLModelMigrator *)self _validateCurrentModelVersionFailedWithNoVersionFromServer];
    }

    else if (v8 != +[PLModelMigrator currentModelVersion])
    {
      [(PLModelMigrator *)self _validateCurrentModelVersionFailedWithMismatchedVersion:v8];
    }
  }
}

- (void)_validateCurrentModelVersionFailedWithMismatchedVersion:(int64_t)a3
{
  objc_opt_class();
  v4 = PLMigrationGetLog();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
  {
    v5[0] = 67109634;
    v5[1] = [objc_opt_class() currentModelVersion];
    v6 = 2048;
    v7 = a3;
    v8 = 2112;
    v9 = @"Your Photos installation appears to be broken, reinstall root and reboot";
    _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_ERROR, "Cannot open or create database with model version %d, assetsd is using model version %lld. %@", v5, 0x1Cu);
  }

  __break(1u);
}

- (void)_validateCurrentModelVersionFailedWithNoVersionFromServer
{
  objc_opt_class();
  v2 = PLMigrationGetLog();
  if (os_log_type_enabled(v2, OS_LOG_TYPE_ERROR))
  {
    v6[0] = 67109378;
    v6[1] = [objc_opt_class() currentModelVersion];
    v7 = 2112;
    v8 = @"Your Photos installation appears to be broken, reinstall root and reboot";
    _os_log_impl(&dword_19BF1F000, v2, OS_LOG_TYPE_ERROR, "Cannot open or create database with model version %d, assetsd failed to validate current model version. This is most likely because assetsd is misconfigured, missing or cannot run.  %@", v6, 0x12u);
  }

  v3 = PLMigrationGetLog();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
  {
    LOWORD(v6[0]) = 0;
    _os_log_impl(&dword_19BF1F000, v3, OS_LOG_TYPE_ERROR, "Triggering stackshot report to diagnose assetsd state", v6, 2u);
  }

  v4 = dlopen("/System/Library/PrivateFrameworks/CrashReporterSupport.framework/CrashReporterSupport", 1);
  v5 = dlsym(v4, "WriteStackshotReport");
  if (v5)
  {
    v5(@"_validateCurrentModelVersionFailedWithNoVersionFromServer", 3131746989);
  }

  __break(1u);
}

- (BOOL)isCloudPhotoLibraryEnabled
{
  v2 = [(PLModelMigrator *)self pathManager];
  v3 = [v2 libraryURL];
  v4 = PLIsCloudPhotoLibraryEnabledForPhotoLibraryURL(v3);

  return v4;
}

- (id)newShortLivedLibraryForRebuildWithName:(const char *)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v5 = objc_alloc_init(PLPhotoLibraryOptions);
  [(PLPhotoLibraryOptions *)v5 setRequiredState:6];
  [(PLPhotoLibraryOptions *)v5 setRefreshesAfterSave:0];
  [(PLPhotoLibraryOptions *)v5 setLibraryRole:3];
  [(PLPhotoLibraryOptions *)v5 setAutomaticallyPinToFirstFetch:0];
  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 libraryURL];

  v14 = 0;
  v8 = [PLPhotoLibrary newPhotoLibraryWithName:a3 loadedFromURL:v7 options:v5 error:&v14];
  v9 = v14;
  if (!v8)
  {
    v12 = PLMigrationGetLog();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v16 = v7;
      v17 = 2112;
      v18 = v9;
      _os_log_impl(&dword_19BF1F000, v12, OS_LOG_TYPE_ERROR, "failed to load photo library with url %@, error: %@", buf, 0x16u);
    }

    goto LABEL_6;
  }

  v10 = [(PLModelMigrator *)self pathManager];
  v11 = [PLRebuildJournalManager isEnabledWithPathManager:v10 error:0];

  if (!v11)
  {
    v12 = [v8 managedObjectContext];
    [v12 setChangeSource:2];
LABEL_6:
  }

  return v8;
}

- (id)newShortLivedLibraryWithName:(const char *)a3
{
  v17 = *MEMORY[0x1E69E9840];
  v5 = objc_alloc_init(PLPhotoLibraryOptions);
  [(PLPhotoLibraryOptions *)v5 setRequiredState:6];
  [(PLPhotoLibraryOptions *)v5 setRefreshesAfterSave:0];
  v6 = [(PLModelMigrator *)self pathManager];
  v7 = [v6 libraryURL];

  v12 = 0;
  v8 = [PLPhotoLibrary newPhotoLibraryWithName:a3 loadedFromURL:v7 options:v5 error:&v12];
  v9 = v12;
  if (!v8)
  {
    v10 = PLMigrationGetLog();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v14 = v7;
      v15 = 2112;
      v16 = v9;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "failed to load photo library with url %@, error: %@", buf, 0x16u);
    }
  }

  return v8;
}

- (id)newDeviceRestoreMigrationSupport
{
  v3 = [(PLModelMigrator *)self pathManager];
  v4 = [v3 isDeviceRestoreSupported];

  if (!v4)
  {
    return 0;
  }

  v5 = [(PLModelMigrator *)self pathManager];
  v6 = [v5 libraryURL];
  v7 = [PLLibraryServicesManager libraryServicesManagerForLibraryURL:v6];

  v8 = [[PLDeviceRestoreMigrationSupport alloc] initWithLibraryServicesManager:v7];
  return v8;
}

- (id)_migrationThumbnailManagerWithStore:(id)a3
{
  v4 = a3;
  v5 = self;
  objc_sync_enter(v5);
  thumbnailManager = v5->_thumbnailManager;
  if (!thumbnailManager)
  {
    v7 = [[PLThumbnailManager alloc] initWithPhotoLibraryPathManager:v5->_pathManager storeFromMigration:v4];
    v8 = v5->_thumbnailManager;
    v5->_thumbnailManager = v7;

    thumbnailManager = v5->_thumbnailManager;
  }

  v9 = thumbnailManager;
  objc_sync_exit(v5);

  return v9;
}

- (PLModelMigrator)initWithPathManager:(id)a3
{
  v5 = a3;
  v47.receiver = self;
  v47.super_class = PLModelMigrator;
  v6 = [(PLModelMigrator *)&v47 init];
  if (v6)
  {
    [MEMORY[0x1E695DF00] timeIntervalSinceReferenceDate];
    v6->_startTime = v7;
    objc_storeStrong(&v6->_pathManager, a3);
    v6->_recordMigrationMetadataLock._os_unfair_lock_opaque = 0;
    *&v6->_storeMetadataLock._os_unfair_lock_opaque = 0;
    v6->_fileSystemLoadInProgressLock._os_unfair_lock_opaque = 0;
    v8 = dispatch_queue_attr_make_with_autorelease_frequency(0, DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM);
    v9 = pl_dispatch_queue_create_with_qos_and_fallback_qos();
    fileSystemLoadQueue = v6->_fileSystemLoadQueue;
    v6->_fileSystemLoadQueue = v9;

    v11 = dispatch_group_create();
    fileSystemLoadGroup = v6->_fileSystemLoadGroup;
    v6->_fileSystemLoadGroup = v11;

    v13 = objc_initWeak(&location, v6);
    v14 = objc_alloc(MEMORY[0x1E69BF270]);
    v44[0] = MEMORY[0x1E69E9820];
    v44[1] = 3221225472;
    v44[2] = __39__PLModelMigrator_initWithPathManager___block_invoke;
    v44[3] = &unk_1E7576828;
    objc_copyWeak(&v45, &location);
    v15 = [v14 initWithBlock:v44];
    objc_destroyWeak(&v45);
    objc_destroyWeak(&location);
    lazyCoreAnalyticsEventManager = v6->_lazyCoreAnalyticsEventManager;
    v6->_lazyCoreAnalyticsEventManager = v15;

    v17 = objc_initWeak(&location, v6);
    v18 = objc_alloc(MEMORY[0x1E69BF270]);
    v42[0] = MEMORY[0x1E69E9820];
    v42[1] = 3221225472;
    v42[2] = __39__PLModelMigrator_initWithPathManager___block_invoke_2;
    v42[3] = &unk_1E7576828;
    objc_copyWeak(&v43, &location);
    v19 = [v18 initWithBlock:v42];
    objc_destroyWeak(&v43);
    objc_destroyWeak(&location);
    lazyDeviceRestoreMigrationSupport = v6->_lazyDeviceRestoreMigrationSupport;
    v6->_lazyDeviceRestoreMigrationSupport = v19;

    v21 = objc_initWeak(&location, v6);
    v22 = objc_alloc(MEMORY[0x1E69BF270]);
    v40[0] = MEMORY[0x1E69E9820];
    v40[1] = 3221225472;
    v40[2] = __39__PLModelMigrator_initWithPathManager___block_invoke_3;
    v40[3] = &unk_1E7576828;
    objc_copyWeak(&v41, &location);
    v23 = [v22 initWithBlock:v40];
    objc_destroyWeak(&v41);
    objc_destroyWeak(&location);
    lazyDeviceRestoreMigrationPostProcessingSupport = v6->_lazyDeviceRestoreMigrationPostProcessingSupport;
    v6->_lazyDeviceRestoreMigrationPostProcessingSupport = v23;

    v25 = objc_initWeak(&location, v6);
    v26 = objc_alloc(MEMORY[0x1E69BF270]);
    v38[0] = MEMORY[0x1E69E9820];
    v38[1] = 3221225472;
    v38[2] = __39__PLModelMigrator_initWithPathManager___block_invoke_4;
    v38[3] = &unk_1E7576828;
    objc_copyWeak(&v39, &location);
    v27 = [v26 initWithRetriableBlock:v38];
    objc_destroyWeak(&v39);
    objc_destroyWeak(&location);
    lazyMigrationLogger = v6->_lazyMigrationLogger;
    v6->_lazyMigrationLogger = v27;

    v29 = [MEMORY[0x1E696AE38] discreteProgressWithTotalUnitCount:1];
    progress = v6->_progress;
    v6->_progress = v29;

    v31 = objc_initWeak(&location, v6);
    v32 = objc_alloc(MEMORY[0x1E69BF270]);
    v36[0] = MEMORY[0x1E69E9820];
    v36[1] = 3221225472;
    v36[2] = __39__PLModelMigrator_initWithPathManager___block_invoke_5;
    v36[3] = &unk_1E7576828;
    objc_copyWeak(&v37, &location);
    v33 = [v32 initWithBlock:v36];
    objc_destroyWeak(&v37);
    objc_destroyWeak(&location);
    lazyGraphCache = v6->_lazyGraphCache;
    v6->_lazyGraphCache = v33;
  }

  return v6;
}

id __39__PLModelMigrator_initWithPathManager___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = objc_alloc_init(MEMORY[0x1E69BF1F0]);
  }

  else
  {
    v2 = 0;
  }

  return v2;
}

id __39__PLModelMigrator_initWithPathManager___block_invoke_2(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = WeakRetained;
  if (WeakRetained)
  {
    v3 = [WeakRetained newDeviceRestoreMigrationSupport];
  }

  else
  {
    v3 = 0;
  }

  return v3;
}

PLDeviceRestoreMigrationPostProcessingSupport *__39__PLModelMigrator_initWithPathManager___block_invoke_3(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = [[PLDeviceRestoreMigrationPostProcessingSupport alloc] initWithModelMigrator:WeakRetained];
  }

  else
  {
    v2 = 0;
  }

  return v2;
}

id __39__PLModelMigrator_initWithPathManager___block_invoke_4(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = [MEMORY[0x1E69BF210] setupWithLibraryIdentifier:0 type:1];
  }

  else
  {
    v2 = 0;
  }

  return v2;
}

PLGraphCache *__39__PLModelMigrator_initWithPathManager___block_invoke_5(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = objc_alloc_init(PLGraphCache);
  }

  else
  {
    v2 = 0;
  }

  return v2;
}

+ (BOOL)rebuildMomentsInContext:(id)a3 pathManager:(id)a4 deleteExistingMoments:(BOOL)a5 targetedAssetOIDs:(id)a6
{
  v7 = a5;
  v9 = a3;
  v10 = a4;
  v11 = a6;
  if (PLPlatformMomentsSupported())
  {
    v12 = [[PLMomentGenerationDataManager alloc] initWithManagedObjectContext:v9 pathManagerForLightweightMigration:v10];
    pl_dispatch_once();
    [PLMomentGenerationDataManager setManagerMomentarilyBlessed:v12];
    v13 = objc_alloc_init(MEMORY[0x1E695DF90]);
    v14 = v13;
    if (v7)
    {
      [v13 setObject:MEMORY[0x1E695E118] forKeyedSubscript:PLMomentGenerationShouldDeleteAllMomentsKey];
    }

    if ([v11 count])
    {
      [v14 setObject:v11 forKeyedSubscript:PLMomentGenerationTargetedAssetOIDsKey];
    }

    v15 = [(PLMomentGenerationDataManager *)v12 generator];
    [v15 rebuildAllMomentsWithOptions:v14 completionHandler:0];

    v18[0] = MEMORY[0x1E69E9820];
    v18[1] = 3221225472;
    v18[2] = __95__PLModelMigrator_rebuildMomentsInContext_pathManager_deleteExistingMoments_targetedAssetOIDs___block_invoke;
    v18[3] = &unk_1E75781E8;
    v19 = v12;
    v16 = v12;
    [(PLMomentGenerationDataManager *)v16 performBlock:v18 synchronously:1 completionHandler:0];
  }

  return 1;
}

void __95__PLModelMigrator_rebuildMomentsInContext_pathManager_deleteExistingMoments_targetedAssetOIDs___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x1E69E9840];
  v1 = *(a1 + 32);
  v6 = 0;
  v2 = [v1 orphanedAssetIDsWithError:&v6];
  v3 = v6;
  if ([v2 count])
  {
    v4 = PLMigrationGetLog();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = [v2 count];
      *buf = 67109378;
      v8 = v5;
      v9 = 2112;
      v10 = v2;
      _os_log_impl(&dword_19BF1F000, v4, OS_LOG_TYPE_ERROR, "Orphaned asset IDs (%d) detected after rebuilding moments: %@", buf, 0x12u);
    }
  }
}

+ (id)schemaIncompatibilityDetailsForStoreMetadata:(id)a3 model:(id)a4
{
  v31 = *MEMORY[0x1E69E9840];
  v5 = a4;
  v6 = [a3 objectForKey:@"NSStoreModelVersionHashes"];
  v24 = v5;
  v7 = [v5 entityVersionHashesByName];
  v8 = MEMORY[0x1E695DFA8];
  v9 = [v6 allKeys];
  v10 = [v8 setWithArray:v9];

  v11 = MEMORY[0x1E695DFD8];
  v12 = [v7 allKeys];
  v13 = [v11 setWithArray:v12];
  [v10 unionSet:v13];

  v25 = [MEMORY[0x1E695DF90] dictionary];
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  v14 = v10;
  v15 = [v14 countByEnumeratingWithState:&v26 objects:v30 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v27;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v27 != v17)
        {
          objc_enumerationMutation(v14);
        }

        v19 = *(*(&v26 + 1) + 8 * i);
        v20 = [v6 objectForKeyedSubscript:v19];
        v21 = [v7 objectForKeyedSubscript:v19];
        if ((PLObjectIsEqual() & 1) == 0)
        {
          v22 = [MEMORY[0x1E696AEC0] stringWithFormat:@"model(%@) vs. store(%@)", v21, v20];
          [v25 setObject:v22 forKeyedSubscript:v19];
        }
      }

      v16 = [v14 countByEnumeratingWithState:&v26 objects:v30 count:16];
    }

    while (v16);
  }

  return v25;
}

+ (BOOL)shouldImportAssetsFromDCIMSubDirectoryAtURL:(id)a3 assetsKind:(int *)a4
{
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v24 = 0;
  v7 = [v5 getResourceValue:&v24 forKey:*MEMORY[0x1E695DC30] error:0];
  v8 = v24;
  if (v7)
  {
    v9 = [MEMORY[0x1E696AE88] scannerWithString:v8];
    [v9 setCharactersToBeSkipped:0];
    v23 = 0;
    if ([v9 scanInt:&v23])
    {
      v10 = (v23 - 100) > 0x1863B;
    }

    else
    {
      v10 = 1;
    }

    if (v10)
    {
      v11 = 0;
    }

    else
    {
      v13 = [MEMORY[0x1E696AB08] alphanumericCharacterSet];
      v22 = 0;
      v14 = [v9 scanCharactersFromSet:v13 intoString:&v22];
      v15 = v22;
      v11 = v15;
      if (v14)
      {
        v16 = [v9 isAtEnd];

        if (v16)
        {
          v17 = [v11 isEqualToString:@"APPLE"];
          v18 = [v11 isEqualToString:@"IMPRT"];
          v19 = [v11 isEqualToString:@"SYNCD"];
          v12 = v19 | v18 | v17;
          if (a4)
          {
            if (v17)
            {
              v20 = 0;
            }

            else
            {
              v20 = 7;
            }

            if (v18)
            {
              v20 = 1;
            }

            if (v19)
            {
              v20 = 4;
            }

            *a4 = v20;
          }

          goto LABEL_22;
        }
      }

      else
      {
      }
    }

    v12 = 0;
LABEL_22:

    goto LABEL_23;
  }

  v12 = 0;
LABEL_23:

  objc_autoreleasePoolPop(v6);
  return v12 & 1;
}

+ (id)extractPathToAssetUUIDRecoveryMappingFromDatabasePath:(id)a3
{
  v26 = *MEMORY[0x1E69E9840];
  v3 = a3;
  v4 = [MEMORY[0x1E695DF90] dictionary];
  v5 = objc_autoreleasePoolPush();
  v6 = PLOpenSQLTransactionWithDBPath([v3 UTF8String]);
  v7 = v6;
  if (v6)
  {
    ppStmt = 0;
    v8 = sqlite3_prepare_v2(v6, "SELECT zdirectory, zfilename, zuuid FROM zasset;", -1, &ppStmt, 0);
    if (v8)
    {
      goto LABEL_22;
    }

    while (sqlite3_step(ppStmt) == 100)
    {
      v9 = objc_autoreleasePoolPush();
      v10 = sqlite3_column_text(ppStmt, 0);
      if (v10)
      {
        v11 = [MEMORY[0x1E696AEC0] stringWithUTF8String:v10];
      }

      else
      {
        v11 = 0;
      }

      v12 = sqlite3_column_text(ppStmt, 1);
      if (v12)
      {
        v13 = [MEMORY[0x1E696AEC0] stringWithUTF8String:v12];
      }

      else
      {
        v13 = 0;
      }

      v14 = [v11 stringByAppendingPathComponent:v13];
      if ([v14 length])
      {
        v15 = sqlite3_column_text(ppStmt, 2);
        if (v15)
        {
          v16 = [MEMORY[0x1E696AEC0] stringWithUTF8String:v15];
        }

        else
        {
          v16 = 0;
        }

        if ([v16 length])
        {
          [v4 setObject:v16 forKey:v14];
        }
      }

      objc_autoreleasePoolPop(v9);
    }

    v8 = sqlite3_finalize(ppStmt);
    if (v8)
    {
LABEL_22:
      v18 = PLMigrationGetLog();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = sqlite3_errmsg(v7);
        *buf = 67109378;
        v23 = v8;
        v24 = 2080;
        v25 = v19;
        _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Failed to fetch path to uuid mappings %d %s", buf, 0x12u);
      }

      PLRollbackSQLTransactionAndCloseDB(v7);
    }

    else
    {
      PLCommitSQLTransactionAndCloseDB(v7);
    }
  }

  else
  {
    v17 = PLMigrationGetLog();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v17, OS_LOG_TYPE_ERROR, "Failed to open database for extracting path to uuid mappings", buf, 2u);
    }
  }

  objc_autoreleasePoolPop(v5);

  return v4;
}

+ (BOOL)_writeNumber:(id)a3 forKey:(id)a4 pathManager:(id)a5 error:(id *)a6
{
  v38 = *MEMORY[0x1E69E9840];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  context = objc_autoreleasePoolPush();
  v28 = v10;
  v32 = 0;
  v33 = 0;
  v11 = [v10 photosDatabasePath];
  [PLManagedObjectContext getPersistentStoreURL:&v33 options:&v32 forDatabasePath:v11];
  v12 = v33;
  v13 = v32;

  v14 = *MEMORY[0x1E695D4A8];
  v31 = 0;
  v15 = [MEMORY[0x1E695D6C0] metadataForPersistentStoreOfType:v14 URL:v12 options:v13 error:&v31];
  v16 = v31;
  if (v15)
  {
    v17 = v16 == 0;
  }

  else
  {
    v17 = 0;
  }

  if (!v17)
  {
    v18 = v16;
    v19 = PLMigrationGetLog();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v35 = v9;
      v36 = 2112;
      v37 = v18;
      _os_log_impl(&dword_19BF1F000, v19, OS_LOG_TYPE_ERROR, "Failed to get metadata while setting %@ %@", buf, 0x16u);
    }

    goto LABEL_9;
  }

  v19 = [v15 valueForKey:v9];
  if (([v19 isEqual:v8]& 1) != 0)
  {
    v18 = 0;
LABEL_9:
    v20 = 1;
    v21 = a6;
    goto LABEL_15;
  }

  v22 = [v15 mutableCopy];
  v26 = v8;
  [v22 setObject:v8 forKey:v9];
  v30 = 0;
  v20 = [MEMORY[0x1E695D6C0] setMetadata:v22 forPersistentStoreOfType:v14 URL:v12 options:v13 error:&v30];
  v18 = v30;
  v21 = a6;
  if ((v20 & 1) == 0)
  {
    v23 = PLMigrationGetLog();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v35 = v9;
      v36 = 2112;
      v37 = v18;
      _os_log_impl(&dword_19BF1F000, v23, OS_LOG_TYPE_ERROR, "Failed to set %@ %@", buf, 0x16u);
    }
  }

  v8 = v26;
LABEL_15:

  objc_autoreleasePoolPop(context);
  if (v21 && v18)
  {
    v24 = v18;
    *v21 = v18;
  }

  return v20;
}

+ (BOOL)_readBooleanFlagWithKey:(id)a3 fromMetadataWithMOC:(id)a4 pathManager:(id)a5
{
  v5 = [a1 _readNumberWithKey:a3 fromMetadataWithMOC:a4 pathManager:a5 error:0];
  v6 = [v5 BOOLValue];

  return v6;
}

+ (id)_readNumberWithKey:(id)a3 fromMetadataWithMOC:(id)a4 pathManager:(id)a5 error:(id *)a6
{
  v9 = a3;
  v10 = a4;
  v11 = a5;
  v12 = objc_autoreleasePoolPush();
  if (v10)
  {
    v13 = [v10 persistentStoreCoordinator];
    v14 = [v13 persistentStores];
    if ([v14 count])
    {
      v15 = [v14 firstObject];
      v16 = [v13 metadataForPersistentStore:v15];

      if (v16)
      {
        v17 = 0;
        goto LABEL_7;
      }
    }

    else
    {
    }
  }

  v27 = 0;
  v28 = 0;
  v18 = [v11 photosDatabasePath];
  [PLManagedObjectContext getPersistentStoreURL:&v28 options:&v27 forDatabasePath:v18];
  v19 = v28;
  v20 = v27;

  v21 = *MEMORY[0x1E695D4A8];
  v26 = 0;
  v16 = [MEMORY[0x1E695D6C0] metadataForPersistentStoreOfType:v21 URL:v19 options:v20 error:&v26];
  v17 = v26;

LABEL_7:
  if (v16)
  {
    v22 = v17 == 0;
  }

  else
  {
    v22 = 0;
  }

  if (v22)
  {
    v23 = [v16 valueForKey:v9];

    objc_autoreleasePoolPop(v12);
  }

  else
  {

    objc_autoreleasePoolPop(v12);
    v23 = 0;
    if (a6 && v17)
    {
      v24 = v17;
      v23 = 0;
      *a6 = v17;
    }
  }

  return v23;
}

+ (BOOL)waitForDataMigratorToExit
{
  v4 = 0;
  v5 = &v4;
  v6 = 0x2020000000;
  v7 = 0;
  if (PLPlatformWaitsForDataMigrator())
  {
    pl_dispatch_once();
  }

  v2 = *(v5 + 24);
  _Block_object_dispose(&v4, 8);
  return v2;
}

void __44__PLModelMigrator_waitForDataMigratorToExit__block_invoke(uint64_t a1)
{
  v12 = 0;
  v13 = &v12;
  v14 = 0x2020000000;
  v2 = getDMIsMigrationNeededSymbolLoc_ptr;
  v15 = getDMIsMigrationNeededSymbolLoc_ptr;
  if (!getDMIsMigrationNeededSymbolLoc_ptr)
  {
    v8 = MEMORY[0x1E69E9820];
    v9 = 3221225472;
    v10 = __getDMIsMigrationNeededSymbolLoc_block_invoke;
    v11 = &unk_1E7577EA0;
    v3 = DataMigrationLibrary();
    v13[3] = dlsym(v3, "DMIsMigrationNeeded");
    getDMIsMigrationNeededSymbolLoc_ptr = v13[3];
    v2 = v13[3];
  }

  _Block_object_dispose(&v12, 8);
  if (!v2)
  {
    v6 = [MEMORY[0x1E696AAA8] currentHandler];
    v7 = [MEMORY[0x1E696AEC0] stringWithUTF8String:"BOOL PLDMIsMigrationNeeded(void)"];
    [v6 handleFailureInFunction:v7 file:@"PLModelMigrator.m" lineNumber:185 description:{@"%s", dlerror(), v8, v9, v10, v11}];
LABEL_12:

    __break(1u);
    return;
  }

  if (!v2())
  {
    return;
  }

  *(*(*(a1 + 32) + 8) + 24) = 1;
  v12 = 0;
  v13 = &v12;
  v14 = 0x2020000000;
  v4 = getDMPerformMigrationIfNeededSymbolLoc_ptr;
  v15 = getDMPerformMigrationIfNeededSymbolLoc_ptr;
  if (!getDMPerformMigrationIfNeededSymbolLoc_ptr)
  {
    v8 = MEMORY[0x1E69E9820];
    v9 = 3221225472;
    v10 = __getDMPerformMigrationIfNeededSymbolLoc_block_invoke;
    v11 = &unk_1E7577EA0;
    v5 = DataMigrationLibrary();
    v13[3] = dlsym(v5, "DMPerformMigrationIfNeeded");
    getDMPerformMigrationIfNeededSymbolLoc_ptr = v13[3];
    v4 = v13[3];
  }

  _Block_object_dispose(&v12, 8);
  if (!v4)
  {
    v6 = [MEMORY[0x1E696AAA8] currentHandler];
    v7 = [MEMORY[0x1E696AEC0] stringWithUTF8String:"void PLDMPerformMigrationIfNeeded(void)"];
    [v6 handleFailureInFunction:v7 file:@"PLModelMigrator.m" lineNumber:186 description:{@"%s", dlerror(), v8, v9, v10, v11}];
    goto LABEL_12;
  }

  v4();
}

+ (BOOL)shouldPromptUserForRebuildWithLibraryPathManager:(id)a3
{
  v19 = *MEMORY[0x1E69E9840];
  v3 = a3;
  if ([v3 isSystemPhotoLibraryPathManager])
  {
    v4 = 1;
  }

  else
  {
    v5 = MEMORY[0x1E69BF2A0];
    v6 = [v3 libraryURL];
    v7 = [v5 wellKnownPhotoLibraryIdentifierForURL:v6];

    if (v7 > 1)
    {
      v4 = 0;
    }

    else
    {
      v8 = [v3 libraryURL];
      v14 = 0;
      v9 = [PLPhotoLibraryIdentifier photoLibraryIdentifierWithPhotoLibraryURL:v8 createIfMissing:1 error:&v14];
      v10 = v14;

      if (!v9)
      {
        v11 = PLMigrationGetLog();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
        {
          *buf = 138412546;
          v16 = v3;
          v17 = 2112;
          v18 = v10;
          _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "Failed to create identifier for library with path manager %@ %@.", buf, 0x16u);
        }
      }

      v12 = [v9 containerIdentifier];
      v4 = [v12 containsString:@"com.apple."];
    }
  }

  return v4;
}

+ (BOOL)markAssetsWithThumbsForTableRebuildInContext:(id)a3
{
  v3 = a3;
  v10 = 0;
  v11 = &v10;
  v12 = 0x2020000000;
  v13 = 1;
  v7[0] = MEMORY[0x1E69E9820];
  v7[1] = 3221225472;
  v7[2] = __64__PLModelMigrator_markAssetsWithThumbsForTableRebuildInContext___block_invoke;
  v7[3] = &unk_1E7578910;
  v4 = v3;
  v8 = v4;
  v9 = &v10;
  [v4 pl_performBlockAndWait:v7];
  v5 = *(v11 + 24);

  _Block_object_dispose(&v10, 8);
  return v5;
}

void __64__PLModelMigrator_markAssetsWithThumbsForTableRebuildInContext___block_invoke(uint64_t a1)
{
  v16[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D5E0];
  v3 = +[PLManagedAsset entityName];
  v4 = [v2 fetchRequestWithEntityName:v3];

  v16[0] = @"thumbnailIndex";
  v5 = [MEMORY[0x1E695DEC8] arrayWithObjects:v16 count:1];
  [v4 setPropertiesToFetch:v5];

  [v4 setFetchBatchSize:100];
  v6 = [MEMORY[0x1E696AE18] predicateWithFormat:@"%K >= %d", @"thumbnailIndex", 0];
  [v4 setPredicate:v6];

  v7 = [*(a1 + 32) executeFetchRequest:v4 error:0];
  v8 = [*(a1 + 32) enumerateWithIncrementalSaveUsingObjects:v7 withBlock:&__block_literal_global_96];
  v9 = PLMigrationGetLog();
  v10 = v9;
  if (v8)
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      *buf = 136315394;
      v13 = "+[PLModelMigrator markAssetsWithThumbsForTableRebuildInContext:]_block_invoke";
      v14 = 2112;
      v15 = v8;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_ERROR, "%s: failed to mark assets for table thumb rebuild: %@", buf, 0x16u);
    }

    *(*(*(a1 + 40) + 8) + 24) = 0;
  }

  else
  {
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v10, OS_LOG_TYPE_DEFAULT, "Marked assets for table thumb rebuild.", buf, 2u);
    }

    v11 = PLMigrationGetLog();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      *buf = 0;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Rebuilding image request hints...", buf, 2u);
    }

    *(*(*(a1 + 40) + 8) + 24) = [PLResourceInstaller resetImageRequestHintsInContext:*(a1 + 32)];
  }
}

+ (BOOL)resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager:(id)a3 deferHintChanges:(BOOL)a4 inContext:(id)a5
{
  v7 = a3;
  v8 = a5;
  v16 = 0;
  v17 = &v16;
  v18 = 0x2020000000;
  v19 = 1;
  [v7 addRebuildThumbnailsRequest];
  v12[0] = MEMORY[0x1E69E9820];
  v12[1] = 3221225472;
  v12[2] = __136__PLModelMigrator_resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager_deferHintChanges_inContext___block_invoke;
  v12[3] = &unk_1E7573CD8;
  v9 = v8;
  v15 = a4;
  v13 = v9;
  v14 = &v16;
  [v9 pl_performBlockAndWait:v12];
  if (v17[3])
  {
    v10 = 1;
  }

  else
  {
    [v7 removeRebuildThumbnailsRequest:"+[PLModelMigrator resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager:deferHintChanges:inContext:]"];
    v10 = *(v17 + 24);
  }

  _Block_object_dispose(&v16, 8);
  return v10 & 1;
}

void __136__PLModelMigrator_resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager_deferHintChanges_inContext___block_invoke(uint64_t a1)
{
  v27[1] = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D560];
  v3 = +[PLManagedAsset entityName];
  v4 = [v2 batchUpdateRequestWithEntityName:v3];

  [v4 setResultType:2];
  v26 = @"thumbnailIndex";
  v5 = [MEMORY[0x1E696AD98] numberWithInt:0xFFFFFFFFLL];
  v27[0] = v5;
  v6 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v27 forKeys:&v26 count:1];
  [v4 setPropertiesToUpdate:v6];

  v7 = *(a1 + 32);
  v19 = 0;
  v8 = [v7 executeRequest:v4 error:&v19];
  v9 = v19;
  v10 = PLMigrationGetLog();
  v11 = v10;
  if (v8)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = [v8 result];
      *buf = 138412290;
      v21 = v12;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_DEFAULT, "Reset thumbnailIndex on %@ assets", buf, 0xCu);
    }

    v13 = [v8 result];
    v14 = [v13 integerValue];

    if (v14 >= 1)
    {
      v15 = *(a1 + 48);
      v16 = PLMigrationGetLog();
      v17 = os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT);
      if (v15 == 1)
      {
        if (v17)
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Deferring image request hints rebuild", buf, 2u);
        }
      }

      else
      {
        if (v17)
        {
          *buf = 0;
          _os_log_impl(&dword_19BF1F000, v16, OS_LOG_TYPE_DEFAULT, "Rebuilding image request hints...", buf, 2u);
        }

        *(*(*(a1 + 40) + 8) + 24) = [PLResourceInstaller resetImageRequestHintsInContext:*(a1 + 32)];
      }
    }
  }

  else
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v18 = [v9 userInfo];
      *buf = 136315650;
      v21 = "+[PLModelMigrator resetThumbnailIndexesAndInitiateThumbnailRebuildRequestIfSuccessfulForForThumbnailManager:deferHintChanges:inContext:]_block_invoke";
      v22 = 2112;
      v23 = v9;
      v24 = 2112;
      v25 = v18;
      _os_log_impl(&dword_19BF1F000, v11, OS_LOG_TYPE_ERROR, "%s: failed to update: %@ %@", buf, 0x20u);
    }

    *(*(*(a1 + 40) + 8) + 24) = 0;
  }
}

- (void)filesystemImportResultsUpdateKeywordWithImportedAssets:(id)a3
{
  v4 = a3;
  if ([v4 count])
  {
    v5 = [v4 firstObject];
    v6 = [v5 photoLibrary];

    v8[0] = MEMORY[0x1E69E9820];
    v8[1] = 3221225472;
    v8[2] = __84__PLModelMigrator_Recovery__filesystemImportResultsUpdateKeywordWithImportedAssets___block_invoke;
    v8[3] = &unk_1E75761B8;
    v9 = v6;
    v10 = v4;
    v11 = self;
    v7 = v6;
    [v7 performTransaction:v8];
  }
}

void __84__PLModelMigrator_Recovery__filesystemImportResultsUpdateKeywordWithImportedAssets___block_invoke(id *a1)
{
  v21 = *MEMORY[0x1E69E9840];
  v2 = MEMORY[0x1E695D5E0];
  v3 = +[PLManagedAsset entityName];
  v4 = [v2 fetchRequestWithEntityName:v3];

  [v4 setFetchBatchSize:100];
  v5 = [a1[4] managedObjectContext];
  v18 = 0;
  v6 = [v5 countForFetchRequest:v4 error:&v18];
  v7 = v18;

  if (v6 == 0x7FFFFFFFFFFFFFFFLL)
  {
    v8 = PLMigrationGetLog();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412290;
      v20 = v7;
      _os_log_impl(&dword_19BF1F000, v8, OS_LOG_TYPE_ERROR, "Post filesystem import, failed to obtain asset count. Error: %@", buf, 0xCu);
    }

    goto LABEL_6;
  }

  if (v6 > [a1[5] count])
  {
    v8 = objc_alloc_init(MEMORY[0x1E696AB78]);
    [v8 setDateStyle:2];
    [v8 setTimeStyle:2];
    v9 = PLServicesLocalizedFrameworkStringForAssetsd();
    v10 = [MEMORY[0x1E695DF00] now];
    v17 = [v8 stringFromDate:v10];
    v11 = PFStringWithValidatedFormat();

    v12 = [PLKeywordManager alloc];
    v13 = [a1[6] pathManager];
    v14 = [(PLKeywordManager *)v12 initWithPathManager:v13];

    v15 = [MEMORY[0x1E695DFD8] setWithArray:a1[5]];
    v16 = [a1[4] managedObjectContext];
    [(PLKeywordManager *)v14 setKeyword:v11 forAssets:v15 managedObjectContext:v16];

LABEL_6:
  }
}

+ (BOOL)enumerateObjectsWithIncrementalSaveDefaultBatchSizeFetchRequest:(id)a3 managedObjectContext:(id)a4 count:(unint64_t *)a5 error:(id *)a6 block:(id)a7
{
  v11 = a4;
  v12 = a7;
  v13 = a3;
  [v13 setFetchBatchSize:100];
  v20 = 0;
  v14 = [v11 executeFetchRequest:v13 error:&v20];

  v15 = v20;
  if (v14)
  {
    v16 = [v11 enumerateWithIncrementalSaveUsingObjects:v14 withBlock:v12];

    v15 = v16;
    if (!v16)
    {
      v18 = 1;
      if (!a5)
      {
        goto LABEL_7;
      }

      goto LABEL_6;
    }
  }

  if (a6)
  {
    v17 = v15;
    *a6 = v15;
  }

  v18 = 0;
  if (a5)
  {
LABEL_6:
    *a5 = [v14 count];
  }

LABEL_7:

  return v18;
}

+ (BOOL)executeBatchUpdateWithEntityName:(id)a3 predicate:(id)a4 propertiesToUpdate:(id)a5 managedObjectContext:(id)a6 error:(id *)a7
{
  v33 = *MEMORY[0x1E69E9840];
  v11 = a3;
  v12 = a4;
  v13 = a5;
  v14 = MEMORY[0x1E695D560];
  v15 = a6;
  v16 = [v14 batchUpdateRequestWithEntityName:v11];
  [v16 setPredicate:v12];
  [v16 setPropertiesToUpdate:v13];
  [v16 setResultType:2];
  v24 = 0;
  v17 = [v15 executeRequest:v16 error:&v24];

  v18 = v24;
  v19 = PLMigrationGetLog();
  v20 = v19;
  if (v17)
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v21 = [v17 result];
      *buf = 138413058;
      v26 = v21;
      v27 = 2112;
      v28 = v11;
      v29 = 2112;
      v30 = v12;
      v31 = 2112;
      v32 = v13;
      _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_DEFAULT, "Batch updated %@ %@ objects with predicate %@, updated properties %@", buf, 0x2Au);
    }
  }

  else
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      *buf = 138413058;
      v26 = v11;
      v27 = 2112;
      v28 = v12;
      v29 = 2112;
      v30 = v13;
      v31 = 2112;
      v32 = v18;
      _os_log_impl(&dword_19BF1F000, v20, OS_LOG_TYPE_ERROR, "Batch update request failed, for entity %@, predicate %@, properties to update %@, error: %@", buf, 0x2Au);
    }

    if (a7)
    {
      v22 = v18;
      *a7 = v18;
    }
  }

  return v17 != 0;
}

+ (BOOL)executeBatchDeleteWithEntityName:(id)a3 predicate:(id)a4 managedObjectContext:(id)a5 error:(id *)a6
{
  v27 = *MEMORY[0x1E69E9840];
  v9 = a3;
  v10 = MEMORY[0x1E695D5E0];
  v11 = a5;
  v12 = a4;
  v13 = [v10 fetchRequestWithEntityName:v9];
  [v13 setPredicate:v12];

  v14 = [objc_alloc(MEMORY[0x1E695D538]) initWithFetchRequest:v13];
  [v14 setResultType:2];
  v22 = 0;
  v15 = [v11 executeRequest:v14 error:&v22];

  v16 = v22;
  v17 = PLMigrationGetLog();
  v18 = v17;
  if (v16)
  {
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      *buf = 138412546;
      v24 = v9;
      v25 = 2112;
      v26 = v16;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_ERROR, "Batch delete of %@ returned error: %@", buf, 0x16u);
    }

    if (a6)
    {
      v19 = v16;
      *a6 = v16;
    }
  }

  else
  {
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEBUG))
    {
      v20 = [v15 result];
      *buf = 138412546;
      v24 = v9;
      v25 = 2112;
      v26 = v20;
      _os_log_impl(&dword_19BF1F000, v18, OS_LOG_TYPE_DEBUG, "Batch delete of %@ with result: %@", buf, 0x16u);
    }
  }

  return v16 == 0;
}

@end