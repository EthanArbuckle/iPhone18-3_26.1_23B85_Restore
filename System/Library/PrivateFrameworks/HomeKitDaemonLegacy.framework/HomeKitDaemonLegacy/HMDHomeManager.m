@interface HMDHomeManager
+ (BOOL)doesSaveReasonAffectHomeManager:(id)a3;
+ (BOOL)doesSaveReasonAffectOnlyLocalData:(id)a3;
+ (BOOL)doesSaveReasonNotAffectLocalData:(id)a3;
+ (BOOL)doesSaveReasonRequireForceSyncToWatch:(id)a3;
+ (BOOL)isThisDeviceAdminOfHome:(id)a3;
+ (BOOL)shouldIgnoreExpectedConfigurationVersionUpdateForReason:(id)a3;
+ (BOOL)shouldIncrementGenerationCounterForReason:(id)a3;
+ (id)_getIntentGroupClientIdentifierSalt;
+ (id)convertSaveReasonToTransactionReason:(id)a3;
+ (id)createIdentifierSalt:(id)a3 deviceSpecific:(BOOL)a4;
+ (id)deriveIntentGroupIdentifierFromBaseUUID:(id)a3;
+ (id)emptyModelObjectWithChangeType:(unint64_t)a3 homeManagerUUID:(id)a4;
+ (id)getAccessoryCacheForIdentifier:(id)a3;
+ (id)getAllBackingStoreObjects:(int64_t)a3 primaryHomeUUID:(id)a4 cloudZone:(id)a5 appData:(id)a6;
+ (id)getContainersToCleanUp;
+ (id)getUniqueDeviceIdSalt;
+ (id)logCategory;
+ (id)remotePeerDeviceAddress:(id)a3;
+ (id)saltForDeviceSpecificIdentifier;
+ (unint64_t)legacyDataSizeLimit;
+ (void)_eraseAllAccessoryKeysAndIdentifiers;
+ (void)relaunchHomedDueToResetConfigurationWithDelay:(double)a3;
+ (void)removeAccessoryCacheForIdentifier:(id)a3;
+ (void)saveAccessoryCache:(id)a3 forIdentifier:(id)a4;
- (BOOL)_addWatch:(id)a3 toAssociatedList:(id)a4;
- (BOOL)_associateAccessories:(id)a3 withHomes:(id)a4;
- (BOOL)_capabilitiesAreSupported:(id)a3;
- (BOOL)_configureHomes:(id)a3 uncommittedTransactions:(id)a4;
- (BOOL)_configureHomesImpl:(id)a3 uncommittedTransactions:(id)a4;
- (BOOL)_findAnyAccessoryWithIdentities:(id)a3 inAccessoryServers:(id)a4;
- (BOOL)_handleAccessoryDiagnosticStateQueryWithResponse:(id)a3 accessory:(id)a4 hasAdditionalRequest:(BOOL)a5 error:(id)a6 completion:(id)a7;
- (BOOL)_handleControllerKeyAvailable;
- (BOOL)_onlyHH2SharedHomesExist;
- (BOOL)_processTestModeCurrentHomeOverride:(id)a3 error:(id *)a4;
- (BOOL)_processTestModeHomeAccessControlOverride:(id)a3 error:(id *)a4;
- (BOOL)_processTestModeHomeLocationStatusOverride:(id)a3 error:(id *)a4;
- (BOOL)_processTestModeOverridesPayload:(id)a3 error:(id *)a4;
- (BOOL)_processTestModeSkipHH2MigrationOverride:(id)a3 error:(id *)a4;
- (BOOL)_processTestModeUpdateHomeLocation:(id)a3 error:(id *)a4;
- (BOOL)_removeAndAddKeyPair:(id)a3 userName:(id)a4 eraseReason:(unint64_t)a5;
- (BOOL)_setPrimaryHome:(id)a3 idsDataSync:(BOOL)a4;
- (BOOL)_shouldDecodeMessage:(id)a3 error:(id *)a4;
- (BOOL)_shouldHandleHomeDataSync:(id)a3 remoteHome:(id)a4 sourceDeviceVersion:(id)a5;
- (BOOL)_submitSpamReportToIDS:(id)a3;
- (BOOL)_updateAccessoriesConfigured;
- (BOOL)_updateIncomingInvitesPresent;
- (BOOL)_updatePreferencesForConfiguredHomes;
- (BOOL)_updatePreferencesForCurrentHome;
- (BOOL)_zonesFetched;
- (BOOL)areThereAnyTTSUSessionsOngoing;
- (BOOL)canHH2MigrationBeStarted:(id *)a3;
- (BOOL)canPerformDryRunOfHH2Migration;
- (BOOL)checkConflictInHomeNamespaceWithName:(id)a3 options:(unint64_t)a4 namespaceUUID:(id)a5 error:(id *)a6;
- (BOOL)dataSyncInProgressWithState:(unint64_t *)a3 withMessage:(id)a4;
- (BOOL)expectingInvitationResponseForIdentifier:(id)a3;
- (BOOL)getOrCreateControllerPublicKey:(id *)a3 controllerUsername:(id *)a4 error:(id *)a5;
- (BOOL)hasClientRequestedMediaAccessoryControl:(id)a3;
- (BOOL)hasHAPAccessoryInAnyHome;
- (BOOL)hasMediaSystemHints;
- (BOOL)hasValidControllerKeyToSave;
- (BOOL)hasiCloudAndControllerKey;
- (BOOL)isAccessAllowedWhenLocked;
- (BOOL)isActive;
- (BOOL)isCloudAccountActive;
- (BOOL)isCurrentResidentDeviceRunningThreadNetwork:(id)a3;
- (BOOL)isHH1EOLEnabled;
- (BOOL)isHH1EOLForResidentDeviceRunningSoftwareVersion:(id)a3;
- (BOOL)isNetworkConnectionAvailable;
- (BOOL)isPairedWithWatch;
- (BOOL)isResidentCapable;
- (BOOL)isResidentEnabled;
- (BOOL)isSignedIntoiCloud;
- (BOOL)isStartThreadNetworkInProgress;
- (BOOL)isThisDesignatedFMFDevice;
- (BOOL)legacyZoneHasRecordsAvailable;
- (BOOL)moveDirectlyToHH2;
- (BOOL)moveDirectlyToHH2IfOnlyHH2SharedHomesExist;
- (BOOL)needHH2UpgradeRecommendation;
- (BOOL)operationsWithIdentifiers:(id)a3 outOperations:(id *)a4;
- (BOOL)postSyncDataUpdatedNotification;
- (BOOL)restoreMediaSystemHintsFromDisk;
- (BOOL)setLocalPairingIdentity:(id)a3 error:(id *)a4;
- (BOOL)shouldAcceptInvitationPayload:(id)a3 error:(id *)a4;
- (BOOL)shouldClearDeviceSetupFollowUp;
- (BOOL)userWithMergeIdIsMemberOfAHome:(id)a3;
- (BOOL)zoneFetchFailed;
- (HMDDevice)companionDevice;
- (HMDHomeManager)init;
- (HMDHomeManager)initWithMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 metricsManager:(id)a10 configuringStateController:(id)a11 diagnosticInfoController:(id)a12 currentAccessorySetupMetricDispatcher:(id)a13 uncommittedTransactions:(id)a14 featuresDataSource:(id)a15;
- (HMDHomeManager)initWithMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 metricsManager:(id)a10 darwinNotificationProvider:(id)a11 notificationCenter:(id)a12 dataSource:(id)a13 appleAccountManager:(id)a14 remoteAccountManager:(id)a15 userDefaults:(id)a16 hmdUserDefaults:(id)a17 biomeEventManager:(id)a18 logEventSubmitter:(id)a19 widgetConfigurationReader:(id)a20 configuringStateController:(id)a21 diagnosticInfoController:(id)a22 currentAccessorySetupMetricDispatcher:(id)a23 uncommittedTransactions:(id)a24 featuresDataSource:(id)a25;
- (HMFBoolean)overrideCurrentHomeUUIDToNil;
- (NSArray)homes;
- (NSDate)lastSoftwareUpdateDate;
- (NSSet)homeUUIDsWithAutoAddWalletKeySuppressed;
- (NSString)currentEventSource;
- (NSUUID)currentHomeUUID;
- (NSUUID)currentHomeUUIDOverride;
- (_TtCE19HomeKitDaemonLegacyCSo14HMDHomeManagerP33_7BC8BE0E1B3C7A1C5B9B66E8847D7B1815SwiftExtensions)_swiftExtensions;
- (double)setupEndTimestamp;
- (double)setupStartTimestamp;
- (id)__computedCurrentHomeUUID;
- (id)__dumpHomeManagerDataWithPrivacyLevel:(unint64_t)a3;
- (id)__generateAssistantTeamIdentifier;
- (id)_accessoryOfCurrentDevice;
- (id)_appleMediaAccessoryOfCurrentDevice;
- (id)_checkActionSetNameConflict:(id)a3 withNamespaceUUIDs:(id)a4;
- (id)_checkNameConflict:(id)a3 withNamespaceUUIDs:(id)a4;
- (id)_compressHomeData:(id)a3;
- (id)_computedCurrentHomeUUID;
- (id)_currentHome;
- (id)_decodeDiagnosticInfoFromLocalResponse:(id)a3;
- (id)_destinationFromMessage:(id)a3;
- (id)_deviceForIdentifier:(id)a3;
- (id)_diagnosticInfoFromRemoteResponse:(id)a3;
- (id)_dumpHomeManagerDataWithPrivacyLevel:(unint64_t)a3;
- (id)_filterAccessories:(id)a3 inHome:(id)a4;
- (id)_filterAccessories:(id)a3 withIdentifiers:(id)a4;
- (id)_findHomeConfigurationModelChange:(id)a3;
- (id)_findHomeModel:(id)a3;
- (id)_findHomeModelChange:(id)a3;
- (id)_findHomeOwnerModelChange:(id)a3;
- (id)_findHomeSharedUserModelChange:(id)a3;
- (id)_getAssistantHashingData;
- (id)_getListOfUsersToPushMetadataChangesTo;
- (id)_getRequestedState:(id)a3 activity:(id)a4 privacyLevel:(unint64_t)a5;
- (id)_homeDataForPersistentStoreIncrementingGeneration:(BOOL)a3 reason:(id)a4;
- (id)_homeFromEventIdentifier:(id)a3;
- (id)_homeWithAssistantIdentifier:(id)a3;
- (id)_homeWithName:(id)a3;
- (id)_homeWithUUID:(id)a3;
- (id)_homeWithUniqueIdentifier:(id)a3 forClientIdentifierSalt:(id)a4;
- (id)_homeWithZoneID:(id)a3;
- (id)_homesWithName:(id)a3;
- (id)_legacyContainer;
- (id)_legacyHomeAcceptedZoneIDFromHomeUUID:(id)a3;
- (id)_legacyHomeZoneIDFromHomeUUID:(id)a3;
- (id)_loadCloudTransactionForRemoteHome:(id)a3 localHome:(id)a4 cachedHome:(id)a5 version:(int64_t)a6;
- (id)_mediaRouteIdentifierForAccessory:(id)a3;
- (id)_performPreHH2RebootTasks;
- (id)_prepareAnswerForRequestedCapabilities:(id)a3;
- (id)_prepareDataForDevicesOnSameAccountForHome:(id)a3 remoteGateway:(BOOL)a4 isAtLeastV4:(BOOL)a5 migrateToHH2:(BOOL)a6;
- (id)_prepareHomesVersionDict;
- (id)_pushChangesToAllUsersOfAllHomesForMigration;
- (id)_remotePeers;
- (id)_runtimeState;
- (id)_scrubRequestedCapabilities:(id)a3 fromMessage:(id)a4;
- (id)_statusPayloadForMessage:(id)a3;
- (id)_trackIncomingInvitationFromAccount:(id)a3 mergeID:(id)a4 idsInvitationIdentifier:(id)a5 payload:(id)a6 invitationState:(int64_t)a7 error:(id *)a8;
- (id)_userPushCachedGetDeviceForUser:(id)a3;
- (id)_zoneInformationWithUUID:(id)a3;
- (id)accessAllowedWhenLockedSettingFileName;
- (id)accessoriesMatchingIdentifier:(id)a3;
- (id)accessorySetupMetricDispatcherForAccessoryUUID:(id)a3;
- (id)accessorySetupMetricDispatchersForHome:(id)a3;
- (id)accessoryWithHomeUUID:(id)a3 accessoryUUID:(id)a4;
- (id)accessoryWithIDSIdentifier:(id)a3;
- (id)accessoryWithUUID:(id)a3;
- (id)activeAccountIdentifier;
- (id)addName:(id)a3 namespace:(id)a4;
- (id)backingStoreObjects:(int64_t)a3;
- (id)createCloudDatabaseAndPerformInitialSync:(id)a3;
- (id)createCurrentAccessoryCapabilities;
- (id)createCurrentResidentCapabilities;
- (id)currentAccessory;
- (id)currentAccessoryHome;
- (id)currentAccessoryHomeUUID;
- (id)currentAccessoryUUID;
- (id)currentMediaGroupsAggregateConsumer;
- (id)delegatingRouter:(id)a3 filteredTopics:(id)a4 forRouter:(id)a5;
- (id)deleteLocalZone:(id)a3 localDatabase:(id)a4 containerID:(id)a5;
- (id)destinationIdentifierForMediaSystem:(id)a3 role:(unint64_t)a4;
- (id)eventRouterServerDiagnosticInfo;
- (id)filterHomes:(id)a3 isSPIEntitled:(BOOL)a4;
- (id)firstSetupSessionIdentifierOutputStartTime:(double *)a3;
- (id)generateDataForSharedHomeModel:(id)a3;
- (id)generatePayloadFromHome:(id)a3 forAdmin:(BOOL)a4 user:(id)a5 supportedFeatures:(id)a6;
- (id)getOrCreateLocalPairingIdentity:(id *)a3;
- (id)homeUUIDFromHints;
- (id)homeUUIDsWithAutoAddWalletKeySuppressedSync;
- (id)homesToSendForNonSPIClients;
- (id)hubAccessoriesWithHomeUUID:(id)a3 forSiriEndpointProfileMessageHandler:(id)a4;
- (id)identifiersOfAccessories:(id)a3;
- (id)identifiersOfAccessoriesForHome:(id)a3;
- (id)languageListProviderForHomeUUID:(id)a3;
- (id)lastUserAddRemoveTimestamp;
- (id)mediaGroupUsingHintsForHomeUUID:(id)a3 accessoryUUID:(id)a4;
- (id)mediaSystemForAppleMediaAccessory:(id)a3;
- (id)mediaSystemUUIDFromHints;
- (id)messageDestination;
- (id)modelObjectWithChangeType:(unint64_t)a3 version:(int64_t)a4;
- (id)multiUserSettingsForMultiUserSettingsMetricsEventDispatcherDataSource;
- (id)needsOnboardingForHomeUUID:(id)a3 accessoryUUID:(id)a4;
- (id)pairedAccessories;
- (id)peerAccessoryRoleFromHints;
- (id)peerAccessoryUUIDFromHints;
- (id)removeName:(id)a3 namespace:(id)a4;
- (id)replaceName:(id)a3 withNewName:(id)a4 inNamespaces:(id)a5;
- (id)settingsControllerForAccessoryUUID:(id)a3 homeUUID:(id)a4;
- (id)setupSessionIdentifierForAccessoryUUID:(id)a3 outStartTime:(double *)a4;
- (id)sharedUserAcceptEventBuilderForHomeUuid:(id)a3;
- (id)topicNameForMediaGroupParticipantDataLocalStorage:(id)a3;
- (id)userUUIDForMessage:(id)a3 homeUUID:(id)a4;
- (id)userWithMergeID:(id)a3;
- (id)validateHomeName:(id)a3;
- (int64_t)numberOfAccessoryWithNewFirmwareAvailable;
- (int64_t)numberOfPendingIncomingInvitation;
- (unint64_t)generationCounter;
- (unint64_t)numHomes;
- (unint64_t)statusForMessage:(id)a3;
- (unsigned)_nextTransactionIdentifier;
- (void)__accountAddedDevice:(id)a3;
- (void)__accountRegistryAddedAccount:(id)a3;
- (void)__accountRegistryRemovedAccount:(id)a3;
- (void)__accountRemovedDevice:(id)a3;
- (void)__handleAppleAccountUpdated:(id)a3;
- (void)__handleAppleAccountUpdated:(id)a3 previousAccount:(id)a4;
- (void)__handleCompanionUpdated:(id)a3;
- (void)__handleDeviceCapabilitiesUpdated:(id)a3;
- (void)__handleDeviceUpdatedNotification:(id)a3;
- (void)__handleInitialFetch:(id)a3;
- (void)__handleRequestFetchHomeConfiguration:(id)a3;
- (void)__handleUpdatedCurrentDevice:(id)a3;
- (void)__handleWatchConnected:(id)a3;
- (void)__handleWatchDisconnected:(id)a3;
- (void)__sendUpdateRequestToAdminForInvitation:(id)a3 homeUUID:(id)a4 invitationState:(int64_t)a5 authStatus:(id)a6;
- (void)__setLastSyncedAssistantConfigurationVersion:(unint64_t)a3;
- (void)__startupFirewallRuleManagerForMessage:(id)a3 completion:(id)a4;
- (void)_acceptHomeInviteFromAccount:(id)a3 message:(id)a4 trackInvite:(BOOL)a5;
- (void)_accessoriesAreLocallyReachableOnTransientDevice:(BOOL)a3 forHome:(id)a4;
- (void)_accountAvailabilityChanged:(BOOL)a3;
- (void)_addCloudZone:(id)a3 ownerName:(id)a4;
- (void)_addCurrentResidentDeviceToHomes:(id)a3;
- (void)_addIncomingInvitation:(id)a3;
- (void)_addPendingDataSyncAcksForUser:(id)a3 forHome:(id)a4;
- (void)_addSyncOperation:(id)a3;
- (void)_addSyncOperation:(id)a3 forWatchWithIdentifier:(id)a4;
- (void)_addWatch:(id)a3 completionHandler:(id)a4;
- (void)_archiveSyncDataForHome:(id)a3;
- (void)_archiveSyncDataForHome:(id)a3 toUser:(id)a4;
- (void)_assistantSyncDataChanged:(id)a3;
- (void)_auditDuplicatePreviouslyAddedAccessory:(id)a3;
- (void)_auditKeychainEntries;
- (void)_cancelAccessoryFinderTimer;
- (void)_changePrimaryHome:(id)a3;
- (void)_checkAndAddWatchDevices:(id)a3 resend:(BOOL)a4 requestFromWatch:(BOOL)a5;
- (void)_checkAndInformCompanionDevice;
- (void)_checkForAccountChanged;
- (void)_checkForRemotePeers;
- (void)_checkForRemotePeersAndRegisterForRemoteNotifications:(BOOL)a3;
- (void)_checkHH1EOLStatusAndRelaunchIfNeeded;
- (void)_cleanChangesIfNoAddChangeObjectID:(id)a3 completion:(id)a4;
- (void)_cleanHomeManagerZoneInformationWithoutHome;
- (void)_determineEmptyHomesForOwnersWithCompletionHandler:(id)a3;
- (void)_determineLegacyLocalChanges:(id)a3;
- (void)_determineLocalChangesAndSchedulePush;
- (void)_dumpToLog:(id)a3 withState:(id)a4;
- (void)_electCompanionForRemoteAccess:(id)a3;
- (void)_electRemoteAccessDeviceForHome:(id)a3 retryCount:(unint64_t)a4;
- (void)_electRemoteAccessPeerForHome:(id)a3 retryCount:(unint64_t)a4;
- (void)_electRemoteGatewayForHomesAfterReachabilityChanges;
- (void)_eraseLocalHomeConfiguration;
- (void)_eraseLocalHomeConfigurationAfterSignOut;
- (void)_eraseLocalHomeConfigurationAndDeleteMetadata:(BOOL)a3 reason:(unint64_t)a4 completionQueue:(id)a5 completion:(id)a6;
- (void)_eraseLocalHomeConfigurationWithReason:(unint64_t)a3;
- (void)_eraseLocalHomeData;
- (void)_eraseLocalMetadata;
- (void)_fetchAllZones:(id)a3;
- (void)_fetchDataFromCloud;
- (void)_fetchHasOnlyEmptyHomesWithCompletion:(id)a3;
- (void)_findCloudHomeZonesToIgnore:(id)a3;
- (void)_findRemotePeerContainingAccessories:(id)a3 forHome:(id)a4;
- (void)_findZoneInformationWithoutHome:(id)a3;
- (void)_fragmentationStream:(id)a3 didCloseWithError:(id)a4;
- (void)_fragmentationStream:(id)a3 didReceiveData:(id)a4 transactionIdentifier:(unsigned __int16)a5 error:(id)a6;
- (void)_generateAssistantSyncDataAndIncrementVersion:(BOOL)a3 requestSync:(BOOL)a4 urgent:(BOOL)a5 completion:(id)a6;
- (void)_handleAccessAllowedWhenLockedRequest:(id)a3;
- (void)_handleAccessHomeInvite:(id)a3;
- (void)_handleAccessHomeInviteFromAccount:(id)a3 mergeID:(id)a4 idsInvitationIdentifier:(id)a5 payload:(id)a6 messageResponseHandler:(id)a7;
- (void)_handleAccessoryDiagnosticQueryWithOptions:(unint64_t)a3 accessory:(id)a4 accessoryUUID:(id)a5 mediaRouteID:(id)a6 additionalFetchKeys:(id)a7 filteringKeyPaths:(id)a8 remoteMessageTimeout:(double)a9 remoteMessageRestriction:(unint64_t)a10 completion:(id)a11;
- (void)_handleAccessoryDiagnosticStateQuery:(id)a3;
- (void)_handleAccountAvailabilityChanged:(id)a3;
- (void)_handleAccountStatusDeterminedWithError:(id)a3 homeDataRecordExists:(BOOL)a4 metadataRecordExists:(BOOL)a5 completion:(id)a6;
- (void)_handleAddRemoteAccessRequest:(id)a3;
- (void)_handleAreYouAtHome:(id)a3;
- (void)_handleAssistantSyncDataRequest:(id)a3;
- (void)_handleAttemptHH2AutoMigrationMessage:(id)a3;
- (void)_handleClearMobileAssetsInfoRequest:(id)a3;
- (void)_handleCompanionKeysSync:(id)a3;
- (void)_handleConnectivityInfoRequest:(id)a3;
- (void)_handleContactStoreChanged;
- (void)_handleCurrentAccessoryAddedNotification:(id)a3;
- (void)_handleCurrentAccessoryRemovedNotification:(id)a3;
- (void)_handleCurrentHomeChanged:(id)a3;
- (void)_handleDeviceSetupConfiguringStateQuery:(id)a3;
- (void)_handleDeviceSetupSessionClose:(id)a3;
- (void)_handleDeviceSetupSessionOpen:(id)a3;
- (void)_handleDiagnosticInfo:(id)a3;
- (void)_handleDismissBulletinRequest:(id)a3;
- (void)_handleDismissDialogRequest:(id)a3;
- (void)_handleDoYouSeeUnpairedAccessories:(id)a3;
- (void)_handleDumpDatabase:(id)a3;
- (void)_handleDumpState:(id)a3;
- (void)_handleElectDeviceForIDSSession:(id)a3;
- (void)_handleEnableResidentForThisDeviceRequest:(id)a3;
- (void)_handleEnableUARPPacketCaptureRequest:(id)a3;
- (void)_handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest:(id)a3;
- (void)_handleFetchDevicesMessage:(id)a3;
- (void)_handleFetchModifyHome:(id)a3 isLegacyTransaction:(BOOL)a4 completion:(id)a5;
- (void)_handleFetchObjectChange:(id)a3 home:(id)a4 isLegacyTransaction:(BOOL)a5 completion:(id)a6;
- (void)_handleFetchSetupMode:(id)a3;
- (void)_handleGetTLVForJSON:(id)a3;
- (void)_handleHH2SentinelZonePresent:(id)a3;
- (void)_handleHomeDataSync:(id)a3;
- (void)_handleHomeManagerSyncWalletKeysPassSerialNumbersMessage:(id)a3;
- (void)_handleHomeManagerTransactionsFetched:(id)a3 stagedTransaction:(id)a4 mustReplay:(id)a5 cloudConflict:(BOOL)a6 transactionError:(id)a7 syncCompletion:(id)a8;
- (void)_handleHomeUpdateRequiredRequest:(id)a3;
- (void)_handleHomeUtilRemoteMessageRequest:(id)a3;
- (void)_handleHomeUtilSetOverridesMessage:(id)a3;
- (void)_handleHomesConfigSync:(id)a3;
- (void)_handleMetadataSync:(id)a3;
- (void)_handleNetworkFirewallAddOverridesRequest:(id)a3;
- (void)_handleNetworkFirewallDumpCloudRecordsRequest:(id)a3;
- (void)_handleNetworkFirewallDumpLocalRulesRequest:(id)a3;
- (void)_handleNetworkFirewallDumpPairedMetadataRequest:(id)a3;
- (void)_handleNetworkFirewallFetchCloudChangesRequest:(id)a3;
- (void)_handleNetworkFirewallRemoveLocalRulesRequest:(id)a3;
- (void)_handleNetworkFirewallRemoveOverridesRequest:(id)a3;
- (void)_handleNetworkMismatchInfo:(id)a3;
- (void)_handlePairingIdentityRequest:(id)a3;
- (void)_handlePing:(id)a3;
- (void)_handlePrepareForDiagnosticExtension:(id)a3;
- (void)_handleQueryHomeNamespace:(id)a3;
- (void)_handleQueryMetadata:(id)a3;
- (void)_handleQueryVersionInformation:(id)a3;
- (void)_handleQueryiCloudSwitchState:(id)a3;
- (void)_handleRemoteSessionTornDownNotification:(id)a3;
- (void)_handleRemoveAccount:(id)a3;
- (void)_handleRemoveAllHomeKitPairingIdentities:(id)a3;
- (void)_handleRemoveHomeOperation:(id)a3 message:(id)a4;
- (void)_handleRequestAddHome:(id)a3;
- (void)_handleRequestFetchHomeConfiguration:(id)a3;
- (void)_handleRequestForCompanionKeysSync:(id)a3;
- (void)_handleRequestIsUserUsingHomeKit:(id)a3;
- (void)_handleRequestRemoveHome:(id)a3;
- (void)_handleRequestRuntimeStateUpdate:(id)a3;
- (void)_handleRequestSetPrimaryHome:(id)a3;
- (void)_handleRequestToCancelHomeInvitation:(id)a3 saveReason:(id)a4;
- (void)_handleRequestToUpdateHomeInvitationFromInviter:(id)a3;
- (void)_handleRequestToUpdateHomeInvitationFromLocalUser:(id)a3;
- (void)_handleResetConfiguration:(id)a3;
- (void)_handleResetHome:(id)a3;
- (void)_handleResolveAccount:(id)a3;
- (void)_handleRetrieveVendorIdentifier:(id)a3;
- (void)_handleSaveRequest:(id)a3;
- (void)_handleSetMetadata:(id)a3;
- (void)_handleSignificantTimeChange;
- (void)_handleSwitchSetupMode:(id)a3;
- (void)_handleTestHH2Migration:(id)a3;
- (void)_handleTestModeConfigRequest:(id)a3;
- (void)_handleTransactionsFetched:(id)a3 stagedTransaction:(id)a4 mustReplay:(id)a5 zoneID:(id)a6 cloudConflict:(BOOL)a7 transactionError:(id)a8 syncCompletion:(id)a9;
- (void)_handleUpdateMobileAssetsRequest:(id)a3;
- (void)_handleUpdatedCurrentDevice:(id)a3;
- (void)_handleUpdateiCloudSwitchState:(id)a3;
- (void)_handleUserRemoved:(id)a3;
- (void)_handleXPCConnectionNotification:(id)a3;
- (void)_incrementAssistantGenerationCounter;
- (void)_initializeAutoMigration;
- (void)_loadHomeManagerHomeModelChanges:(id)a3 mustReplay:(id)a4 legacyPush:(BOOL)a5 home:(id)a6 completion:(id)a7;
- (void)_loadHomeManagerTransactionsToPush:(id)a3 mustReplay:(id)a4 forLegacyPush:(BOOL)a5 includeAllChanges:(BOOL)a6 completion:(id)a7;
- (void)_loadHomeZonesFromCache:(id)a3 completion:(id)a4;
- (void)_loadMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 uncommittedTransactions:(id)a10 reloadData:(BOOL)a11;
- (void)_logState:(id)a3 key:(id)a4 indent:(id)a5;
- (void)_maybeCreateLegacyHomeAcceptedZone:(id)a3;
- (void)_migrateUniqueIdentifierPrefsIfNeeded;
- (void)_monitorMemoryUsage;
- (void)_monitorReachability;
- (void)_notifyClientsOfUpdatedStatus;
- (void)_notifyCurrentHomeUpdated:(id)a3 isLocalUpdate:(BOOL)a4;
- (void)_notifyMetricsManagerOfConfigurationChange;
- (void)_notifyXPCClientsOfHomeConfigurationChange;
- (void)_notifyXPCClientsOfUpdatedDevices;
- (void)_pairedSyncDidStart;
- (void)_performAutoMigrationToHH2WithIsDryRun:(BOOL)a3 completionHandler:(id)a4;
- (void)_performPostSaveRequestActionsWithRequest:(id)a3;
- (void)_postIncomingInvitationStateChangedNotification:(id)a3 newInvitationState:(int64_t)a4;
- (void)_postMergeWatchPush;
- (void)_postPreferencesChangedNotification;
- (void)_processAnyPendingRequestsForRemoteAccess:(BOOL)a3;
- (void)_processFetchZonesResults:(id)a3 completion:(id)a4;
- (void)_processLocalRequestToUpdateHomeInvitation:(id)a3 newState:(int64_t)a4 authStatus:(id)a5 logEventBuilder:(id)a6;
- (void)_processRemoveHomeModels:(id)a3 processIndex:(unint64_t)a4 completion:(id)a5;
- (void)_processRemoveUserManagementOperationModel:(id)a3 message:(id)a4;
- (void)_processRequestToUpdateHomeInvitation:(id)a3 invitationState:(int64_t)a4 homeUUID:(id)a5 authStatus:(id)a6 invitationSource:(unint64_t)a7 messageName:(id)a8 message:(id)a9;
- (void)_processSharedHomeModel:(id)a3 message:(id)a4;
- (void)_processUserManagementOperationModel:(id)a3 message:(id)a4;
- (void)_pruneExpiredIncomingInvitations;
- (void)_pushChangesForHome:(id)a3 toRegularUsersOfHome:(id)a4 adminUsersOfHome:(id)a5;
- (void)_pushChangesForHome:(id)a3 toRemoteDevicesOnSameAccount:(id)a4 addedUser:(id)a5;
- (void)_pushChangesToAllUsersOfAllHomes;
- (void)_pushChangesToUsers:(id)a3 forHome:(id)a4;
- (void)_pushChangesToUsersThatHaveNotAcknowledged;
- (void)_pushChangesToWatch:(id)a3 payload:(id)a4 group:(id)a5 completionHandler:(id)a6;
- (void)_pushMetadataChangesToUsers;
- (void)_pushMetadataToCloud;
- (void)_pushUserRemovedForHome:(id)a3;
- (void)_pushZoneInfromationForHome:(id)a3;
- (void)_queryLegacyHomeAndAcceptedZoneExists:(id)a3 completion:(id)a4;
- (void)_registerForConfiguringStateMessages;
- (void)_registerForFrameworkSwitch;
- (void)_registerForMediaSystemHintsMessages;
- (void)_registerForMessages;
- (void)_registerHH1EOLMessageFilter;
- (void)_reloadHomeDataFromLocalStore:(BOOL)a3;
- (void)_remoteAccessHealthMonitorTimerDidFire:(id)a3;
- (void)_removeAllUsersOfHome:(id)a3;
- (void)_removeConfigurationVersionForHome:(id)a3;
- (void)_removeCurrentResidentDeviceFromHomes:(id)a3;
- (void)_removeFromAssociatedPeers:(id)a3 home:(id)a4;
- (void)_removeFromUnassociatedPeers:(id)a3 home:(id)a4;
- (void)_removeHome:(id)a3 withMessage:(id)a4 saveToStore:(BOOL)a5 notifyUsers:(BOOL)a6 shouldRemovePairings:(BOOL)a7;
- (void)_removeIncomingInvitation:(id)a3;
- (void)_removePendingDataSyncAcksForUser:(id)a3 forHome:(id)a4;
- (void)_requestHomeDataSync;
- (void)_resetCloudOperationRetryCounters;
- (void)_resetSiriSyncNotification;
- (void)_retryCloudOperationWithName:(id)a3 completionHandler:(id)a4;
- (void)_runFetchHomeFromCloudZone:(id)a3 cloudConflict:(BOOL)a4 syncCompletion:(id)a5;
- (void)_runFetchHomeManagerCloudConflict:(BOOL)a3 syncCompletion:(id)a4;
- (void)_runUploadHomeConfigToCloud:(id)a3 rowIDs:(id)a4 reasons:(id)a5 forcePush:(BOOL)a6 syncCompletion:(id)a7;
- (void)_runUploadHomeConfigToCloudForcePush:(BOOL)a3 reason:(id)a4 syncCompletion:(id)a5;
- (void)_runUploadHomeToCloud:(id)a3 syncCompletion:(id)a4;
- (void)_saveAssistantHashingData:(id)a3;
- (void)_saveWithReason:(id)a3 information:(id)a4 saveOptions:(unint64_t)a5;
- (void)_saveWithRequest:(id)a3;
- (void)_schedulePostFetch;
- (void)_schedulePushChangesToAllUsersOfAllHomes;
- (void)_scheduleSendHomeDataToAllWatches;
- (void)_scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded;
- (void)_sendCurrentHomeToWatch:(id)a3;
- (void)_sendFragmentedMessage:(id)a3 messageIndex:(unint64_t)a4 messageIdentity:(id)a5 userID:(id)a6 destination:(id)a7 completionHandler:(id)a8;
- (void)_sendHomeDataToWatch:(id)a3 migrateToHH2:(BOOL)a4 completionHandler:(id)a5;
- (void)_sendKeysToWatch:(id)a3 completionHandler:(id)a4;
- (void)_sendUserAdded:(id)a3 destination:(id)a4 toHome:(id)a5;
- (void)_sendUserRemoved:(id)a3 fromHome:(id)a4 pairingUsername:(id)a5 pushToCloud:(BOOL)a6 completionHandler:(id)a7;
- (void)_setAccountAvailabilityChanged;
- (void)_setAppDataWithMessage:(id)a3;
- (void)_setAssistantSyncRequest:(id)a3;
- (void)_setHomekitAssistantConfigurationVersion:(unint64_t)a3;
- (void)_setHomekitAssistantNumEntities:(unint64_t)a3;
- (void)_setUniqueDeviceIdSalt:(id)a3;
- (void)_signpostAssistantSyncDataNotification;
- (void)_signpostAssistantSyncDataRequestHandled;
- (void)_startAccessoryFinderTimer;
- (void)_startAccessoryFinderTimerExpired;
- (void)_startCloudOperationRetryWithTimeout:(unint64_t)a3 completionHandler:(id)a4;
- (void)_startHH2MigrationWithShouldSkipKeyRollOperations:(BOOL)a3 forceMigrationFailureForTesting:(BOOL)a4 isAutoMigration:(BOOL)a5 dryRun:(BOOL)a6 completionHandler:(id)a7;
- (void)_startScanningForAccessories:(id)a3;
- (void)_startTimerToResetCloudOperationRetryCounter;
- (void)_stopCloudOperationRetryTimer;
- (void)_stopTrackingRemovedHomeUserMergeId:(id)a3;
- (void)_storeAllLocalSettingsForThisDevice;
- (void)_teardownRemoteAccessForHome:(id)a3;
- (void)_teardownRemoteAccessForHomeCommon:(id)a3 isCompanion:(BOOL)a4;
- (void)_teardownRemoteAccessForHomeThroughCompanion:(id)a3;
- (void)_trackRemovedHomeUserMergeId:(id)a3;
- (void)_updateCloudDataSyncWithAccountState:(BOOL)a3;
- (void)_updateCurrentHomeIfNecessary;
- (void)_updateCurrentUserEligibleForOwnerToAutoMigration;
- (void)_updateGenerationCounterWithReason:(id)a3 sourceUUID:(id)a4 shouldNotifyClients:(BOOL)a5;
- (void)_updateHome:(id)a3 configurationVersion:(int64_t)a4;
- (void)_updateHomeManagerModelChangesAsPushed:(id)a3 legacyPush:(BOOL)a4;
- (void)_updateHomeManagerModelChangesAsPushed:(id)a3 pushMask:(unint64_t)a4 completion:(id)a5;
- (void)_updateHomesDiscoveredBonjourServicesMetrics;
- (void)_updateModelChangesAsPushed:(id)a3 home:(id)a4 pushMask:(unint64_t)a5 completion:(id)a6;
- (void)_updateResidentEnabledOnThisDevice:(BOOL)a3 forceNotify:(BOOL)a4 message:(id)a5;
- (void)_updateUserPushCachedForUser:(id)a3 device:(id)a4;
- (void)_uploadHomeConfigToCloud:(BOOL)a3 withDelay:(double)a4 reason:(id)a5;
- (void)_uploadHomeManagerToCloudSyncCompletion:(id)a3;
- (void)_uploadHomeManagerToCloudWithDelay:(double)a3;
- (void)_uploadHomeToCloud:(id)a3 withDelay:(double)a4;
- (void)_uploadTransaction:(id)a3 home:(id)a4 completion:(id)a5;
- (void)accessoriesAreLocallyReachableOnTransientDevice:(BOOL)a3 forHome:(id)a4;
- (void)accessoryBrowserDidFindNewAccessory;
- (void)accountAvailabilityChanged:(id)a3;
- (void)addAccessorySetupMetricDispatcher:(id)a3;
- (void)addHome:(id)a3;
- (void)addSharedUserAcceptEventBuilder:(id)a3 forHomeUuid:(id)a4;
- (void)addTransactionAfterPush:(id)a3;
- (void)addWalletKeyWithHomeUUID:(id)a3 reason:(id)a4;
- (void)applyOnboardingSelections:(id)a3 accessoryUUID:(id)a4 homeUUID:(id)a5 completion:(id)a6;
- (void)archiveServerToken:(id)a3;
- (void)assistantSyncDataChanged:(id)a3;
- (void)atHomeLevelChanged:(int64_t)a3 formerLevel:(int64_t)a4 home:(id)a5;
- (void)auditDuplicatePreviouslyAddedAccessory:(id)a3;
- (void)autoAddWalletKeysOncePerDeviceSetup;
- (void)autoMigrateToHH2WithCompletionHandler:(id)a3;
- (void)checkAndMoveDirectlyToHH2IfOnlyHH2SharedHomesExistAllowEmptyOwnedHomes:(BOOL)a3;
- (void)checkAndProcessHH2UpgradeRecommendation;
- (void)checkAndPushMetadataToUser:(id)a3 destination:(id)a4 userInfo:(id)a5;
- (void)checkForRemotePeers;
- (void)cleanupOperationsForAccessory:(id)a3 user:(id)a4 completion:(id)a5;
- (void)clearMediaSystemHints:(BOOL)a3;
- (void)cloudHomeSettingsUpdated:(id)a3;
- (void)configureForWalletKey;
- (void)configureRetailDemoModeWithKeyPair:(id)a3 controllerName:(id)a4 demoAccessories:(id)a5 completionHandler:(id)a6;
- (void)configureSwiftExtensions;
- (void)controllerKeyPairGenerated:(id)a3;
- (void)dataSyncInProgressUpdatedNotification:(id)a3;
- (void)dealloc;
- (void)deleteAllZonesFromContainer:(id)a3;
- (void)deleteZonesFromLegacyAndCameraContainers;
- (void)deregisterForSignificantTimeChangeNotification;
- (void)determineEmptyHomesForSharedUsersWithCompletionHandler:(id)a3;
- (void)determineLocalChangesAndSchedulePush;
- (void)dismissBulletinOnAllMyTransientDevicesWithContext:(id)a3;
- (void)dryRunHH2MigrationWithCompletionHandler:(id)a3;
- (void)electDeviceForUser:(id)a3 destination:(id)a4 deviceCapabilities:(id)a5 queue:(id)a6 completionHandler:(id)a7;
- (void)electRemoteAccessPeerForHome:(id)a3;
- (void)enableUserListeningHistoryForHomeUUID:(id)a3 accessoryUUID:(id)a4 userUUID:(id)a5;
- (void)eraseLocalHomeData;
- (void)evaluateToPushMetadataWhenHomeKitInUse;
- (void)fetchAndUpdatePCSStatus;
- (void)fetchDiagnosticStateWithOptions:(unint64_t)a3 accessoryUUID:(id)a4 additionalFetchKeys:(id)a5 filteringKeyPaths:(id)a6 remoteMessageTimeout:(double)a7 remoteMessageRestriction:(unint64_t)a8 completion:(id)a9;
- (void)fetchHasOnlyEmptyHomesWithCompletion:(id)a3;
- (void)fetchHomeDataFromCloudWithCloudConflict:(BOOL)a3 withDelay:(double)a4;
- (void)fetchHomeFromCloudZone:(id)a3 cloudConflict:(BOOL)a4 withDelay:(double)a5;
- (void)fetchHomeManagerCloudConflict:(BOOL)a3 withDelay:(double)a4;
- (void)fetchSetupDiagnosticStateWithOptions:(unint64_t)a3 accessoryUUID:(id)a4 remoteMessageTimeout:(double)a5 remoteMessageRestriction:(unint64_t)a6 completion:(id)a7;
- (void)finalizeRetailDemoModeWithAllowEditing:(BOOL)a3 completionHandler:(id)a4;
- (void)findAccessoriesNotOnWiFiWithCurrentWiFi:(HMFWiFiNetworkInfo *)a3 completionHandler:(id)a4;
- (void)forceCloudFetch;
- (void)forcePushLocalDataToCloud:(id)a3;
- (void)fragmentationStream:(id)a3 didCloseWithError:(id)a4;
- (void)fragmentationStream:(id)a3 didReceiveData:(id)a4 transactionIdentifier:(unsigned __int16)a5 error:(id)a6;
- (void)handleAccountSettingsUpdate:(id)a3;
- (void)handleAddMediaSystemHints:(id)a3;
- (void)handleAutoAddWalletKeySupressionAssertionAcquireMessage:(id)a3;
- (void)handleAutoAddWalletKeySupressionAssertionReleaseMessage:(id)a3;
- (void)handleContactStoreChanged:(id)a3;
- (void)handleDataFragmentedSync:(id)a3;
- (void)handleFindVendorAccessoryRequest:(id)a3;
- (void)handleHomeCurrentDeviceResidentEligibleNotification:(id)a3;
- (void)handleMetadataDictionary:(id)a3 message:(id)a4;
- (void)handleRemoteUserClientCloudShareRepairRequest:(id)a3;
- (void)handleRemoteUserClientCloudShareRequest:(id)a3;
- (void)handleRemoveMediaSystemHints:(id)a3;
- (void)handleSiriSyncDataRequest:(id)a3;
- (void)handleVendorInfoUpdated:(id)a3;
- (void)handleXPCConnectionDeactivatedNotification:(id)a3;
- (void)idsServerBagDidUpdate:(id)a3;
- (void)initSwiftExtensions;
- (void)initializeHH2FrameworkSwitch;
- (void)initializeMediaGroupParticipantDataLocalStorage;
- (void)invalidate;
- (void)maybeStashOwnerMetadataForPostMigrationPingUsingMigratorRecord:(id)a3;
- (void)mediaGroupParticipantLocalDataStorage:(id)a3 didChangeDestinationIdentifier:(id)a4 forDestinationControllerIdentifier:(id)a5;
- (void)memoryMonitor:(id)a3 didReceiveMemoryEvent:(int64_t)a4;
- (void)migrateLocalHomeTheaterDataForCurrentAccessory:(id)a3 currentMediaSystem:(id)a4;
- (void)migrateLocalMediaGroupParticipantData;
- (void)migrateLocalStereoPairDataForCurrentMediaSystem:(id)a3;
- (void)migrateModelObjectsToCloud:(int64_t)a3 schemaVersion:(int64_t)a4;
- (void)multiUserStatusController:(id)a3 statusDidChange:(int64_t)a4;
- (void)networkMonitorIsReachable:(id)a3;
- (void)networkMonitorIsUnreachable:(id)a3;
- (void)notifyClientsOfUserSettingsChangeWithReason:(id)a3 sourceUUID:(id)a4;
- (void)notifyClientsResidentCapable:(BOOL)a3;
- (void)notifyZonesCloudZoneReady:(id)a3;
- (void)pairedSyncDidStart:(id)a3;
- (void)performPostSaveRequestActionsWithReason:(id)a3;
- (void)performPostSaveRequestActionsWithRequest:(id)a3;
- (void)pingDevice:(id)a3 secure:(BOOL)a4 restrictToLocalNetwork:(BOOL)a5 completionHandler:(id)a6;
- (void)postFinishSetupForCurrentAccessoryFollowUpIfNeeded;
- (void)postHH2UpgradeRecommendationBulletin;
- (void)prepareForDiagnosticExtension:(id)a3;
- (void)processAnyPendingRequestsForRemoteAccess;
- (void)processAppDataModelRemove:(id)a3 message:(id)a4;
- (void)processAppDataModelUpdate:(id)a3 message:(id)a4;
- (void)processCloudZoneModelAdd:(id)a3 message:(id)a4;
- (void)processCloudZoneModelRemoved:(id)a3 message:(id)a4;
- (void)processHomeManagerModelUpdate:(id)a3 message:(id)a4;
- (void)processHomeModelAdd:(id)a3 message:(id)a4;
- (void)processHomeModelRemoved:(id)a3 message:(id)a4;
- (void)processMetadataModel:(id)a3 message:(id)a4;
- (void)processRequestToUpdateHomeInvitation:(id)a3 invitationState:(int64_t)a4 homeUUID:(id)a5 authStatus:(id)a6 invitationSource:(unint64_t)a7 messageName:(id)a8 message:(id)a9;
- (void)processSharedHomeModelRemoved:(id)a3 message:(id)a4;
- (void)processSharedHomeModelUpdate:(id)a3 message:(id)a4;
- (void)processTransactionsFromHomeDataSync:(id)a3 accessories:(id)a4 version:(int64_t)a5 completion:(id)a6;
- (void)pushMetadataToAllWatches;
- (void)refreshHomeDataAndArchiveLocallyWithIsAutoMigration:(BOOL)a3 completion:(id)a4;
- (void)registerForSignificantTimeChangeNotification;
- (void)registerForXPCClientConnectionMessages;
- (void)reloadHomeDataFromLocalStore:(BOOL)a3;
- (void)removeAccessorySetupMetricDispatcherForAccessoryUUID:(id)a3;
- (void)removeAllHomeKitPairingIdentitiesAfterSignOut;
- (void)removeFromUnassociatedPeers:(id)a3 home:(id)a4;
- (void)removeHome:(id)a3;
- (void)removeHomeWalletKeysExcludingSerialNumbers:(id)a3 flow:(id)a4;
- (void)removeSharedUserAcceptEventBuilderForHomeUuid:(id)a3;
- (void)reprocessUserManagementModels;
- (void)resetTTSUHH2SettingsMigrationKey;
- (void)saveAccessAllowedWhenLockedSettingToLocalDisk;
- (void)saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:(id)a3;
- (void)saveMediaSystemHintsWithHomeUUIDString:(id)a3 mediaSystemUUIDString:(id)a4 peerAccessoryUUIDString:(id)a5 peerAccessoryRoleString:(id)a6 persistToDisk:(BOOL)a7;
- (void)saveToPersistentStoreForHH2MigrationWithCompletionHandler:(id)a3;
- (void)saveWithRequest:(id)a3;
- (void)schedulePostFetch;
- (void)scheduleRemovalForHome:(id)a3 message:(id)a4 options:(id)a5;
- (void)sendFragmentedMessageForData:(id)a3 objectUUID:(id)a4 withMessageName:(id)a5 toUser:(id)a6 destination:(id)a7 completionHandler:(id)a8;
- (void)sendHomeDataToAllWatchesWithCompletion:(id)a3;
- (void)sendPairingIdentity:(id)a3 includePrivateKey:(BOOL)a4 requestMessage:(id)a5;
- (void)sendRequestForInvitation:(id)a3 homeUUID:(id)a4 payload:(id)a5 invitationState:(int64_t)a6 responseHandler:(id)a7;
- (void)sendSecureMessage:(id)a3 target:(id)a4 userID:(id)a5 destination:(id)a6 responseQueue:(id)a7 responseHandler:(id)a8;
- (void)sendUnsecureMessage:(id)a3 target:(id)a4 userID:(id)a5 responseQueue:(id)a6 responseHandler:(id)a7;
- (void)sendUserAdded:(id)a3 destination:(id)a4 toHome:(id)a5;
- (void)sendUserRemoved:(id)a3 fromHome:(id)a4 pairingUsername:(id)a5 pushToCloud:(BOOL)a6 completionHandler:(id)a7;
- (void)setAccessAllowedWhenLocked:(BOOL)a3;
- (void)setAppDataWithMessage:(id)a3;
- (void)setCurrentHomeUUID:(id)a3;
- (void)setCurrentHomeUUIDOverride:(id)a3;
- (void)setGenerationCounter:(unint64_t)a3;
- (void)setHomes:(id)a3;
- (void)setLastUserAddRemoveTimestamp;
- (void)setNeedsOnboardingCompleteWitHomeUUID:(id)a3 accessoryUUID:(id)a4 completion:(id)a5;
- (void)setOverrideCurrentHomeUUIDToNil:(id)a3;
- (void)setPostSyncDataUpdatedNotification:(BOOL)a3;
- (void)setSetupEndTimestamp:(double)a3;
- (void)setSetupStartTimestamp:(double)a3;
- (void)setupSession:(id)a3 didCloseWithError:(id)a4;
- (void)setupSession:(id)a3 didReceiveAccessoryWithUUID:(id)a4;
- (void)startFindMyHandler;
- (void)startIndexing;
- (void)startLocalTransport;
- (void)startWithCompletionHandler:(id)a3;
- (void)stashSharedHomeInfoNotYetMigrated;
- (void)stopLocalTransport;
- (void)syncWalletKeyPassSerialNumbersToWatch:(id)a3 withCompletion:(id)a4;
- (void)teardownRemoteAccessForHome:(id)a3;
- (void)timerDidFire:(id)a3;
- (void)transactionObjectRemoved:(id)a3 message:(id)a4;
- (void)transactionObjectUpdated:(id)a3 newValues:(id)a4 message:(id)a5;
- (void)updateAccountAvailabilityChanged:(id)a3;
- (void)updateCurrentUserEligibleForOwnerToAutoMigration;
- (void)updateGenerationCounterWithReason:(id)a3 sourceUUID:(id)a4 shouldNotifyClients:(BOOL)a5;
- (void)updateHomeKitInUsePreferences;
- (void)updatePowerAssertion;
- (void)updateUserPushCachedForUser:(id)a3 device:(id)a4;
- (void)uploadHomeConfigToCloud:(BOOL)a3 withDelay:(double)a4;
- (void)uploadHomeManagerToCloudWithDelay:(double)a3;
- (void)uploadHomeToCloudZone:(id)a3 withDelay:(double)a4;
- (void)userManagementOperationDidFinish:(id)a3;
- (void)verifyCurrentDeviceResidentStatus;
- (void)verifyHomeDataFromCloud:(id)a3;
- (void)waitForHH2SentinelZoneToBeRemoved;
- (void)writeAssistantCurrentHome:(id)a3;
@end

@implementation HMDHomeManager

- (void)handleFindVendorAccessoryRequest:(id)a3
{
  v5 = __swift_instantiateConcreteTypeFromMangledNameV2(qword_27F5A2C48, &unk_253D48880);
  v6 = *(*(v5 - 8) + 64);
  MEMORY[0x28223BE20](v5 - 8);
  v8 = &v13 - v7;
  v9 = sub_253CD0B58();
  (*(*(v9 - 8) + 56))(v8, 1, 1, v9);
  v10 = swift_allocObject();
  v10[2] = 0;
  v10[3] = 0;
  v10[4] = self;
  v10[5] = a3;
  v11 = a3;
  v12 = self;
  sub_25324690C(0, 0, v8, &unk_253D48DF8, v10);
}

- (_TtCE19HomeKitDaemonLegacyCSo14HMDHomeManagerP33_7BC8BE0E1B3C7A1C5B9B66E8847D7B1815SwiftExtensions)_swiftExtensions
{
  v2 = self;
  result = [(HMDHomeManager *)v2 swiftExtensions];
  if (result)
  {
    sub_253CD0E18();
    swift_unknownObjectRelease();

    sub_2531FF150(&v5, &v6);
    _s15SwiftExtensionsCMa_0();
    swift_dynamicCast();

    return v4;
  }

  else
  {
    __break(1u);
  }

  return result;
}

- (void)initSwiftExtensions
{
  v2 = self;
  sub_253226AD4();
}

- (void)configureSwiftExtensions
{
  v2 = self;
  sub_253226C08();
}

- (void)findAccessoriesNotOnWiFiWithCurrentWiFi:(HMFWiFiNetworkInfo *)a3 completionHandler:(id)a4
{
  v7 = __swift_instantiateConcreteTypeFromMangledNameV2(qword_27F5A2C48, &unk_253D48880);
  v8 = *(*(v7 - 8) + 64);
  MEMORY[0x28223BE20](v7 - 8);
  v10 = &v18 - v9;
  v11 = _Block_copy(a4);
  v12 = swift_allocObject();
  v12[2] = a3;
  v12[3] = v11;
  v12[4] = self;
  v13 = sub_253CD0B58();
  (*(*(v13 - 8) + 56))(v10, 1, 1, v13);
  v14 = swift_allocObject();
  v14[2] = 0;
  v14[3] = 0;
  v14[4] = &unk_253D49248;
  v14[5] = v12;
  v15 = swift_allocObject();
  v15[2] = 0;
  v15[3] = 0;
  v15[4] = &unk_253D48C28;
  v15[5] = v14;
  v16 = a3;
  v17 = self;
  sub_253227FA0(0, 0, v10, &unk_253D48C30, v15);
}

- (void)startFindMyHandler
{
  v2 = __swift_instantiateConcreteTypeFromMangledNameV2(qword_27F5A2C48, &unk_253D48880);
  v3 = *(*(v2 - 8) + 64);
  MEMORY[0x28223BE20](v2 - 8);
  v5 = &v8 - v4;
  v6 = sub_253CD0B58();
  (*(*(v6 - 8) + 56))(v5, 1, 1, v6);
  v7 = swift_allocObject();
  *(v7 + 16) = 0;
  *(v7 + 24) = 0;
  sub_25324690C(0, 0, v5, &unk_253D49238, v7);
}

- (BOOL)isThisDesignatedFMFDevice
{
  v2 = self;
  v3 = [(HMDHomeManager *)v2 fmfHandler];
  if (v3)
  {
    v4 = [(HMDFMFHandlerProtocol *)v3 isThisDesignatedFMFDevice];

    swift_unknownObjectRelease();
    LOBYTE(v3) = v4;
  }

  else
  {
    __break(1u);
  }

  return v3;
}

- (void)startIndexing
{
  v3 = __swift_instantiateConcreteTypeFromMangledNameV2(qword_27F5A2C48, &unk_253D48880);
  v4 = *(*(v3 - 8) + 64);
  MEMORY[0x28223BE20](v3 - 8);
  v6 = &v10 - v5;
  v7 = sub_253CD0B58();
  (*(*(v7 - 8) + 56))(v6, 1, 1, v7);
  v8 = swift_allocObject();
  v8[2] = 0;
  v8[3] = 0;
  v8[4] = self;
  v9 = self;
  sub_253246C0C(0, 0, v6, &unk_253D49228, v8);
}

- (void)_handleSignificantTimeChange
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

void __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke(uint64_t a1)
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v1 = [*(a1 + 32) homes];
  v2 = [v1 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v2)
  {
    v3 = v2;
    v4 = *v11;
    do
    {
      for (i = 0; i != v3; ++i)
      {
        if (*v11 != v4)
        {
          objc_enumerationMutation(v1);
        }

        v6 = *(*(&v10 + 1) + 8 * i);
        v7 = [v6 workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __69__HMDHomeManager_SignificantTimeChange___handleSignificantTimeChange__block_invoke_2;
        block[3] = &unk_279735D00;
        block[4] = v6;
        dispatch_async(v7, block);
      }

      v3 = [v1 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v3);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)deregisterForSignificantTimeChangeNotification
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEBUG, "%{public}@De-Registering for Significant time change event.", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  DarwinNotifyCenter = CFNotificationCenterGetDarwinNotifyCenter();
  CFNotificationCenterRemoveObserver(DarwinNotifyCenter, v4, @"SignificantTimeChangeNotification", 0);
  v8 = *MEMORY[0x277D85DE8];
}

- (void)registerForSignificantTimeChangeNotification
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEBUG, "%{public}@Registering for Significant time change event.", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  DarwinNotifyCenter = CFNotificationCenterGetDarwinNotifyCenter();
  CFNotificationCenterAddObserver(DarwinNotifyCenter, v4, significantTimeDidChangeNotification, @"SignificantTimeChangeNotification", 0, CFNotificationSuspensionBehaviorDeliverImmediately);
  v8 = *MEMORY[0x277D85DE8];
}

- (id)lastUserAddRemoveTimestamp
{
  v2 = [(HMDHomeManager *)self userDefaults];
  v3 = [v2 objectForKey:@"hh1LastSharedUserAddRemoveTimestamp"];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  return v4;
}

- (void)setLastUserAddRemoveTimestamp
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self userDefaults];
  v4 = [MEMORY[0x277CBEAA8] now];
  [v3 setObject:v4 forKey:@"hh1LastSharedUserAddRemoveTimestamp"];

  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Updating last shared user add/remove timestamp", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85DE8];
}

- (void)updatePowerAssertion
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self homes];
  v4 = [v3 count];
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v9 = HMFBooleanToString();
    v12 = 138543618;
    v13 = v8;
    v14 = 2112;
    v15 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Setting network access required (power assertion) to %@", &v12, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = [(HMDHomeManager *)v6 powerManager];
  [v10 setNetworkAccessRequired:v4 != 0];

  v11 = *MEMORY[0x277D85DE8];
}

- (id)userUUIDForMessage:(id)a3 homeUUID:(id)a4
{
  v27 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  if (v8)
  {
    v9 = [v6 userForHome:v8];
    if (v9)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v21 = 138543874;
        v22 = v13;
        v23 = 2112;
        v24 = v9;
        v25 = 2112;
        v26 = v6;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Getting user %@ from message %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v10);
      v14 = [v9 uuid];
    }

    else
    {
      v14 = 0;
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      v21 = 138543618;
      v22 = v18;
      v23 = 2112;
      v24 = v7;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, "%{public}@Failed to get user from message due to no home with uuid: %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    v14 = 0;
  }

  v19 = *MEMORY[0x277D85DE8];

  return v14;
}

- (void)enableUserListeningHistoryForHomeUUID:(id)a3 accessoryUUID:(id)a4 userUUID:(id)a5
{
  v22 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = [(HMDHomeManager *)self _homeWithUUID:v8];
  v12 = v11;
  if (v11)
  {
    [v11 enableUserListeningHistoryForAccessoryUUID:v9 userUUID:v10];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v16;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@Failed to enable ULH due to no home with uuid: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (id)hubAccessoriesWithHomeUUID:(id)a3 forSiriEndpointProfileMessageHandler:(id)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self _homeWithUUID:v6];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 hubAccessories];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v6;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to get hub accessories due to no home with uuid: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v10 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v10;
}

- (id)accessoryWithHomeUUID:(id)a3 accessoryUUID:(id)a4
{
  v28 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self homes];
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke;
  v22[3] = &unk_2797323C0;
  v9 = v6;
  v23 = v9;
  v10 = [v8 na_firstObjectPassingTest:v22];

  if (v10)
  {
    v11 = [v10 accessories];
    v12 = [v11 copy];

    v20[0] = MEMORY[0x277D85DD0];
    v20[1] = 3221225472;
    v20[2] = __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke_11;
    v20[3] = &unk_27972C828;
    v21 = v7;
    v13 = [v12 na_firstObjectPassingTest:v20];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543618;
      v25 = v17;
      v26 = 2112;
      v27 = v9;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    v13 = 0;
  }

  v18 = *MEMORY[0x277D85DE8];

  return v13;
}

uint64_t __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __78__HMDHomeManager_SiriEndpointOnboarding__accessoryWithHomeUUID_accessoryUUID___block_invoke_11(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (void)applyOnboardingSelections:(id)a3 accessoryUUID:(id)a4 homeUUID:(id)a5 completion:(id)a6
{
  v24 = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a4;
  v12 = a5;
  v13 = a6;
  v14 = objc_autoreleasePoolPush();
  v15 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    v20 = 138543618;
    v21 = v17;
    v22 = 2112;
    v23 = v10;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Apply onboarding selections to the controller manager: %@", &v20, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  v18 = [(HMDHomeManager *)v15 compositeSettingsControllerManager];
  [v18 applyOnboardingSelections:v10 accessoryUUID:v11 homeUUID:v12 completion:v13];

  v19 = *MEMORY[0x277D85DE8];
}

- (void)setNeedsOnboardingCompleteWitHomeUUID:(id)a3 accessoryUUID:(id)a4 completion:(id)a5
{
  v59 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = [(HMDHomeManager *)self homes];
  v53[0] = MEMORY[0x277D85DD0];
  v53[1] = 3221225472;
  v53[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke;
  v53[3] = &unk_2797323C0;
  v12 = v8;
  v54 = v12;
  v13 = [v11 na_firstObjectPassingTest:v53];

  if (v13)
  {
    v14 = [v13 accessories];
    v15 = [v14 copy];

    v51[0] = MEMORY[0x277D85DD0];
    v51[1] = 3221225472;
    v51[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_5;
    v51[3] = &unk_27972C828;
    v16 = v9;
    v52 = v16;
    v17 = [v15 na_firstObjectPassingTest:v51];
    v18 = v17;
    if (v17)
    {
      v47 = v9;
      v19 = v17;
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v20 = v19;
      }

      else
      {
        v20 = 0;
      }

      v21 = v20;

      v22 = [v21 needsOnboarding];
      if (v22 && (v23 = v22, [v21 needsOnboarding], v24 = objc_claimAutoreleasedReturnValue(), v25 = objc_msgSend(v24, "integerValue"), v24, v23, v25 == 2))
      {
        v26 = objc_autoreleasePoolPush();
        v27 = self;
        v28 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
        {
          v29 = HMFGetLogIdentifier();
          *buf = 138543362;
          v56 = v29;
          _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Skipping needsOnboarding transaction since there's no change.", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v26);
        v10[2](v10, 0);
      }

      else
      {
        v34 = objc_autoreleasePoolPush();
        v35 = self;
        v36 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
        {
          v37 = HMFGetLogIdentifier();
          *buf = 138543362;
          v56 = v37;
          _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Starting Updating needsOnboarding", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v34);
        v38 = [v13 backingStore];
        v39 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v40 = [v38 transaction:@"Updating needsOnboarding" options:v39];

        v41 = [v21 transactionWithObjectChangeType:2];
        [v41 setNeedsOnboarding:&unk_286627DC0];
        [v40 add:v41];
        v49[0] = MEMORY[0x277D85DD0];
        v49[1] = 3221225472;
        v49[2] = __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_9;
        v49[3] = &unk_279733F30;
        v49[4] = v35;
        v50 = v10;
        [v40 run:v49];
      }

      v9 = v47;
    }

    else
    {
      v42 = objc_autoreleasePoolPush();
      v43 = self;
      v44 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v45 = v48 = v9;
        *buf = 138543618;
        v56 = v45;
        v57 = 2112;
        v58 = v16;
        _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_ERROR, "%{public}@Accessory is not found. accessoryUUID: %@", buf, 0x16u);

        v9 = v48;
      }

      objc_autoreleasePoolPop(v42);
      v21 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      (v10)[2](v10, v21);
    }
  }

  else
  {
    v30 = objc_autoreleasePoolPush();
    v31 = self;
    v32 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
    {
      v33 = HMFGetLogIdentifier();
      *buf = 138543618;
      v56 = v33;
      v57 = 2112;
      v58 = v12;
      _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v30);
    v15 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
    (v10)[2](v10, v15);
  }

  v46 = *MEMORY[0x277D85DE8];
}

uint64_t __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_5(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

void __105__HMDHomeManager_SiriEndpointOnboarding__setNeedsOnboardingCompleteWitHomeUUID_accessoryUUID_completion___block_invoke_9(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = v6;
  if (v3)
  {
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543618;
      v12 = v8;
      v13 = 2112;
      v14 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_ERROR, "%{public}@Updating needsOnboarding reported error: %@", &v11, 0x16u);
    }
  }

  else if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Updating needsOnboarding success", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v4);
  (*(*(a1 + 40) + 16))();

  v10 = *MEMORY[0x277D85DE8];
}

- (id)needsOnboardingForHomeUUID:(id)a3 accessoryUUID:(id)a4
{
  v41 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self homes];
  v35[0] = MEMORY[0x277D85DD0];
  v35[1] = 3221225472;
  v35[2] = __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke;
  v35[3] = &unk_2797323C0;
  v9 = v6;
  v36 = v9;
  v10 = [v8 na_firstObjectPassingTest:v35];

  if (v10)
  {
    v11 = [v10 accessories];
    v12 = [v11 copy];

    v30 = MEMORY[0x277D85DD0];
    v31 = 3221225472;
    v32 = __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke_1;
    v33 = &unk_27972C828;
    v13 = v7;
    v34 = v13;
    v14 = [v12 na_firstObjectPassingTest:&v30];
    if (v14)
    {
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v15 = v14;
      }

      else
      {
        v15 = 0;
      }

      v16 = v15;
      v17 = [v16 needsOnboarding];

      if (v17)
      {
        v18 = [v17 integerValue] == 0;
      }

      else
      {
        v18 = 1;
      }

      v23 = [MEMORY[0x277CCABB0] numberWithBool:v18];
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      v25 = self;
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
      {
        v27 = HMFGetLogIdentifier();
        *buf = 138543618;
        v38 = v27;
        v39 = 2112;
        v40 = v13;
        _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Accessory is not found. accessoryUUID: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v24);
      v23 = MEMORY[0x277CBEC38];
    }
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = self;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v22;
      v39 = 2112;
      v40 = v9;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@Home is not found. homeUUID: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v19);
    v23 = 0;
  }

  v28 = *MEMORY[0x277D85DE8];

  return v23;
}

uint64_t __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 hmf_isEqualToUUID:*(a1 + 32)];

  return v4;
}

uint64_t __83__HMDHomeManager_SiriEndpointOnboarding__needsOnboardingForHomeUUID_accessoryUUID___block_invoke_1(uint64_t a1, void *a2)
{
  v3 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;
  if (v5)
  {
    v6 = [v3 uuid];
    v7 = [v6 hmf_isEqualToUUID:*(a1 + 32)];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)_mediaRouteIdentifierForAccessory:(id)a3
{
  v3 = [(HMDHomeManager *)self accessoryWithUUID:a3];
  v4 = v3;
  if (v3)
  {
    v5 = [v3 identifier];
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (id)_decodeDiagnosticInfoFromLocalResponse:(id)a3
{
  v18 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 hmf_dataForKey:*MEMORY[0x277CD0120]];
  if (v5)
  {
    v6 = [objc_alloc(MEMORY[0x277CD16B8]) initWithData:v5];
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *MEMORY[0x277CCFC70];
      v14 = 138543618;
      v15 = v10;
      v16 = 2112;
      v17 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@Response does not contain key %@", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v6 = 0;
  }

  v12 = *MEMORY[0x277D85DE8];

  return v6;
}

- (id)_diagnosticInfoFromRemoteResponse:(id)a3
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = *MEMORY[0x277CCFC70];
  v6 = [v4 hmf_dataForKey:*MEMORY[0x277CCFC70]];
  v7 = v6;
  if (v6)
  {
    v8 = v6;
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v12;
      v17 = 2112;
      v18 = v5;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@Response does not contain key %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = *MEMORY[0x277D85DE8];

  return v7;
}

- (void)_handleAccessoryDiagnosticQueryWithOptions:(unint64_t)a3 accessory:(id)a4 accessoryUUID:(id)a5 mediaRouteID:(id)a6 additionalFetchKeys:(id)a7 filteringKeyPaths:(id)a8 remoteMessageTimeout:(double)a9 remoteMessageRestriction:(unint64_t)a10 completion:(id)a11
{
  v16 = a3;
  v71 = *MEMORY[0x277D85DE8];
  v18 = a4;
  v39 = a5;
  v40 = a6;
  v37 = a7;
  v38 = a8;
  v43 = a11;
  v44 = [v18 home];
  v19 = [v18 deviceForDirectMessaging];
  v41 = [v44 currentUser];
  v42 = [(HMDHomeManager *)self uuid];
  if (v41 && ([v41 isOwner] & 1) == 0)
  {
    v21 = [v44 messageTargetUUID];

    v20 = @"HMD.accessoryDiagnosticInfo.s";
    v42 = v21;
  }

  else
  {
    v20 = @"HMD.accessoryDiagnosticInfo.o";
  }

  if (!v19)
  {
    v22 = objc_autoreleasePoolPush();
    v23 = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543618;
      *&buf[4] = v25;
      *&buf[12] = 2112;
      *&buf[14] = v18;
      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@No device for messaging for accessory %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v22);
  }

  v26 = dispatch_group_create();
  v27 = v26;
  *buf = 0;
  *&buf[8] = buf;
  *&buf[16] = 0x2020000000;
  v70 = 0;
  v28 = v16 & 2;
  if ((v16 & 1) != 0 && v19)
  {
    dispatch_group_enter(v26);
    v29 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke;
    block[3] = &unk_279725E88;
    v52 = v42;
    v53 = v19;
    v54 = v39;
    v55 = v40;
    v56 = v37;
    v57 = v38;
    v58 = v20;
    v65 = a9;
    v59 = self;
    v63 = buf;
    v64 = a10;
    v60 = v18;
    v66 = v28 >> 1;
    v62 = v43;
    v61 = v27;
    dispatch_async(v29, block);

    if (!v28)
    {
      goto LABEL_18;
    }

    goto LABEL_17;
  }

  if ((v16 & 2) != 0)
  {
LABEL_17:
    v35 = [(HMDHomeManager *)self workQueue];
    v45[0] = MEMORY[0x277D85DD0];
    v45[1] = 3221225472;
    v45[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_2;
    v45[3] = &unk_2797346B8;
    v50 = buf;
    v45[4] = self;
    v46 = v39;
    v47 = v40;
    v48 = v18;
    v49 = v43;
    dispatch_group_notify(v27, v35, v45);

    goto LABEL_18;
  }

  v30 = objc_autoreleasePoolPush();
  v31 = self;
  v32 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
  {
    v33 = HMFGetLogIdentifier();
    *v67 = 138543362;
    v68 = v33;
    _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, "%{public}@No query will be performed.", v67, 0xCu);
  }

  objc_autoreleasePoolPop(v30);
  v34 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
  (*(v43 + 2))(v43, 0, v34);

LABEL_18:
  _Block_object_dispose(buf, 8);

  v36 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke(uint64_t a1)
{
  v32[3] = *MEMORY[0x277D85DE8];
  v2 = [[HMDRemoteDeviceMessageDestination alloc] initWithTarget:*(a1 + 32) device:*(a1 + 40)];
  v31[0] = @"uuid";
  v3 = [*(a1 + 48) UUIDString];
  v4 = *(a1 + 56);
  v5 = *(a1 + 64);
  v32[0] = v3;
  v32[1] = v4;
  v6 = *MEMORY[0x277CD0110];
  v31[1] = @"identifier";
  v31[2] = v6;
  v32[2] = v5;
  v7 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v32 forKeys:v31 count:3];
  v8 = [v7 mutableCopy];

  [v8 setObject:*(a1 + 72) forKeyedSubscript:*MEMORY[0x277CD0130]];
  v9 = [HMDRemoteMessage secureMessageWithName:*(a1 + 80) qualityOfService:-1 destination:v2 messagePayload:v8 restriction:*(a1 + 128)];
  v10 = [v9 mutableCopy];

  [v10 setTimeout:*(a1 + 136)];
  v11 = objc_autoreleasePoolPush();
  v12 = *(a1 + 88);
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v15 = *(a1 + 48);
    *buf = 138543618;
    v28 = v14;
    v29 = 2112;
    v30 = v15;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Performing accessory diagnostic fetch for accessory %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_21;
  v22[3] = &unk_279725E60;
  v25 = *(a1 + 120);
  v21 = *(a1 + 88);
  v16 = *(&v21 + 1);
  v26 = *(a1 + 144);
  v17 = *(a1 + 112);
  *&v18 = *(a1 + 104);
  *(&v18 + 1) = v17;
  v23 = v21;
  v24 = v18;
  [v10 setResponseHandler:v22];
  v19 = [*(a1 + 88) messageDispatcher];
  [v19 sendMessage:v10];

  v20 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_2(uint64_t a1)
{
  v17 = *MEMORY[0x277D85DE8];
  if ((*(*(*(a1 + 72) + 8) + 24) & 1) == 0)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 32);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      v6 = *(a1 + 40);
      *buf = 138543618;
      v14 = v5;
      v15 = 2112;
      v16 = v6;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Performing accessory diagnostic fetch using rapport %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    v7 = [*(a1 + 32) configuringStateController];
    v10[0] = MEMORY[0x277D85DD0];
    v10[1] = 3221225472;
    v10[2] = __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_23;
    v10[3] = &unk_2797274F8;
    v10[4] = *(a1 + 32);
    v8 = *(a1 + 48);
    v11 = *(a1 + 56);
    v12 = *(a1 + 64);
    [v7 queryConfiguringState:v8 additionalKeys:MEMORY[0x277CBEBF8] withCompletion:v10];
  }

  v9 = *MEMORY[0x277D85DE8];
}

void __211__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticQueryWithOptions_accessory_accessoryUUID_mediaRouteID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke_21(uint64_t a1, uint64_t a2, uint64_t a3)
{
  *(*(*(a1 + 64) + 8) + 24) = [*(a1 + 32) _handleAccessoryDiagnosticStateQueryWithResponse:a3 accessory:*(a1 + 40) hasAdditionalRequest:*(a1 + 72) error:a2 completion:*(a1 + 56)];
  v4 = *(a1 + 48);

  dispatch_group_leave(v4);
}

- (void)_handleAccessoryDiagnosticStateQuery:(id)a3
{
  v35 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 messagePayload];
  v6 = [v5 hmf_numberForKey:*MEMORY[0x277CD0128]];
  v7 = [v6 integerValue];

  if (v7)
  {
    v8 = [v4 uuidForKey:*MEMORY[0x277CD0108]];
    if (v8)
    {
      v9 = [(HMDHomeManager *)self accessoryWithUUID:v8];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v10 = v9;
      }

      else
      {
        v10 = 0;
      }

      v11 = v10;

      v12 = [v11 identifier];
      if (v12)
      {
        v13 = [v4 messagePayload];
        v14 = [v13 objectForKey:*MEMORY[0x277CD0130]];

        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v15 = v14;
        }

        else
        {
          v15 = 0;
        }

        v16 = v15;

        v31[0] = MEMORY[0x277D85DD0];
        v31[1] = 3221225472;
        v31[2] = __73__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticStateQuery___block_invoke;
        v31[3] = &unk_279734EB8;
        v32 = v4;
        [(HMDHomeManager *)self _handleAccessoryDiagnosticQueryWithOptions:v7 accessory:v11 accessoryUUID:v8 mediaRouteID:v12 additionalFetchKeys:MEMORY[0x277CBEBF8] filteringKeyPaths:v16 remoteMessageTimeout:10.0 remoteMessageRestriction:9 completion:v31];

        v17 = v32;
      }

      else
      {
        v26 = objc_autoreleasePoolPush();
        v27 = self;
        v28 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
        {
          v29 = HMFGetLogIdentifier();
          *buf = 138543362;
          v34 = v29;
          _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_ERROR, "%{public}@mediaRouteIdentifier is nil", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v26);
        v17 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
        [v4 respondWithError:v17];
      }
    }

    else
    {
      v22 = objc_autoreleasePoolPush();
      v23 = self;
      v24 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        v25 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v25;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_ERROR, "%{public}@Could not determine accessory UUID", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [v4 respondWithError:v11];
    }
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v34 = v21;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Invalid fetch options", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v8];
  }

  v30 = *MEMORY[0x277D85DE8];
}

uint64_t __73__HMDHomeManager_ConfiguringState___handleAccessoryDiagnosticStateQuery___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3)
{
  v3 = *(a1 + 32);
  if (a3)
  {
    return [v3 respondWithError:?];
  }

  else
  {
    return [v3 respondWithPayload:a2];
  }
}

- (BOOL)_handleAccessoryDiagnosticStateQueryWithResponse:(id)a3 accessory:(id)a4 hasAdditionalRequest:(BOOL)a5 error:(id)a6 completion:(id)a7
{
  v37 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v13 = a4;
  v14 = a6;
  v15 = a7;
  if (!v14)
  {
    v21 = [(HMDHomeManager *)self _diagnosticInfoFromRemoteResponse:v12];
    v20 = v21 != 0;
    v22 = objc_autoreleasePoolPush();
    v23 = self;
    v24 = HMFGetOSLogHandle();
    v25 = v24;
    if (v21)
    {
      if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v26;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@Responding with diagnostic Info", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      v31 = *MEMORY[0x277CD0120];
      v32 = v21;
      v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v32 forKeys:&v31 count:1];
      v15[2](v15, v27, 0);
    }

    else
    {
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v30;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_ERROR, "%{public}@Failed to decode the response", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      if (a5)
      {
        goto LABEL_16;
      }

      v27 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      (v15)[2](v15, 0, v27);
    }

LABEL_16:
    goto LABEL_17;
  }

  v16 = objc_autoreleasePoolPush();
  v17 = self;
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
  {
    v19 = HMFGetLogIdentifier();
    *buf = 138543618;
    v34 = v19;
    v35 = 2112;
    v36 = v14;
    _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Query message failed, error: (%@): ", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v16);
  if (!a5)
  {
    (v15)[2](v15, 0, v14);
  }

  v20 = 0;
LABEL_17:

  v28 = *MEMORY[0x277D85DE8];
  return v20;
}

- (void)_handleDeviceSetupConfiguringStateQuery:(id)a3
{
  v28 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:*MEMORY[0x277CD1FE8]];
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543874;
    v23 = v9;
    v24 = 2112;
    v25 = v4;
    v26 = 2112;
    v27 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Handle query message %@ with mediaRouteID %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  if (!v5)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = v7;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v23 = v16;
      v17 = "%{public}@mediaRouteIdentifier is nil";
LABEL_10:
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, v17, buf, 0xCu);
    }

LABEL_11:

    objc_autoreleasePoolPop(v13);
    v18 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
    [v4 respondWithError:v18];

    goto LABEL_12;
  }

  v10 = [(HMDHomeManager *)v7 configuringStateController];

  if (!v10)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = v7;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v23 = v16;
      v17 = "%{public}@Configuring controller is nil";
      goto LABEL_10;
    }

    goto LABEL_11;
  }

  v11 = [(HMDHomeManager *)v7 configuringStateController];
  v12 = [v5 UUIDString];
  v20[0] = MEMORY[0x277D85DD0];
  v20[1] = 3221225472;
  v20[2] = __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke;
  v20[3] = &unk_2797354B8;
  v20[4] = v7;
  v21 = v4;
  [v11 queryConfiguringState:v12 additionalKeys:MEMORY[0x277CBEBF8] withCompletion:v20];

LABEL_12:
  v19 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) workQueue];
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke_2;
  v12[3] = &unk_279734870;
  v8 = *(a1 + 32);
  v9 = *(a1 + 40);
  v13 = v6;
  v14 = v8;
  v15 = v9;
  v16 = v5;
  v10 = v5;
  v11 = v6;
  dispatch_async(v7, v12);
}

void __76__HMDHomeManager_ConfiguringState___handleDeviceSetupConfiguringStateQuery___block_invoke_2(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 40);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = HMFGetLogIdentifier();
      v6 = *(a1 + 32);
      v18 = 138543618;
      v19 = v5;
      v20 = 2112;
      v21 = v6;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_ERROR, "%{public}@Query message failed, error: (%@): ", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    [*(a1 + 48) respondWithError:*(a1 + 32)];
  }

  else
  {
    v7 = [*(a1 + 40) _diagnosticInfoFromRemoteResponse:*(a1 + 56)];
    v8 = [HMDAppleMediaAccessoryDiagnosticInfoController diagnosticInfoDescriptionWithData:v7];

    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    v12 = v11;
    if (v8)
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v18 = 138543618;
        v19 = v13;
        v20 = 2112;
        v21 = v8;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Query message sent, response: %@", &v18, 0x16u);
      }

      objc_autoreleasePoolPop(v9);
      [*(a1 + 48) respondWithPayload:v8];
    }

    else
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        v18 = 138543362;
        v19 = v14;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Failed to decode the response", &v18, 0xCu);
      }

      objc_autoreleasePoolPop(v9);
      v15 = *(a1 + 48);
      v16 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:2];
      [v15 respondWithError:v16];
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_registerForConfiguringStateMessages
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = *MEMORY[0x277CD00F0];
    *buf = 138543618;
    v19 = v6;
    v20 = 2112;
    v21 = v7;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for %@ message for device setup configuring state query", buf, 0x16u);
  }

  else
  {
    v7 = *MEMORY[0x277CD00F0];
  }

  objc_autoreleasePoolPop(v3);
  v8 = [(HMDHomeManager *)v4 messageDispatcher];
  v9 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v17 = v9;
  v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v17 count:1];
  [v8 registerForMessage:v7 receiver:v4 policies:v10 selector:sel__handleDeviceSetupConfiguringStateQuery_];

  v11 = [(HMDHomeManager *)v4 messageDispatcher];
  v12 = *MEMORY[0x277CD01B8];
  v13 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v16 = v13;
  v14 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
  [v11 registerForMessage:v12 receiver:v4 policies:v14 selector:sel__handleAccessoryDiagnosticStateQuery_];

  v15 = *MEMORY[0x277D85DE8];
}

- (void)fetchDiagnosticStateWithOptions:(unint64_t)a3 accessoryUUID:(id)a4 additionalFetchKeys:(id)a5 filteringKeyPaths:(id)a6 remoteMessageTimeout:(double)a7 remoteMessageRestriction:(unint64_t)a8 completion:(id)a9
{
  v45 = *MEMORY[0x277D85DE8];
  v16 = a4;
  v17 = a5;
  v18 = a6;
  v19 = a9;
  if (v16)
  {
    v20 = [(HMDHomeManager *)self _mediaRouteIdentifierForAccessory:v16];
    if (v20)
    {
      v21 = v20;
      v22 = [(HMDHomeManager *)self configuringStateController];

      if (v22)
      {
        v23 = [(HMDHomeManager *)self accessoryWithUUID:v16];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v24 = v23;
        }

        else
        {
          v24 = 0;
        }

        v25 = v24;

        v41[0] = MEMORY[0x277D85DD0];
        v41[1] = 3221225472;
        v41[2] = __177__HMDHomeManager_ConfiguringState__fetchDiagnosticStateWithOptions_accessoryUUID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke;
        v41[3] = &unk_279725E38;
        v41[4] = self;
        v42 = v19;
        [(HMDHomeManager *)self _handleAccessoryDiagnosticQueryWithOptions:a3 accessory:v25 accessoryUUID:v16 mediaRouteID:v21 additionalFetchKeys:v17 filteringKeyPaths:v18 remoteMessageTimeout:a7 remoteMessageRestriction:a8 completion:v41];
      }

      else
      {
        v35 = objc_autoreleasePoolPush();
        v36 = self;
        v37 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
        {
          v38 = HMFGetLogIdentifier();
          *buf = 138543362;
          v44 = v38;
          _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as the controller is nil", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v35);
        v39 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        (*(v19 + 2))(v19, 0, v39);
      }
    }

    else
    {
      v30 = objc_autoreleasePoolPush();
      v31 = self;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
      {
        v33 = HMFGetLogIdentifier();
        *buf = 138543362;
        v44 = v33;
        _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as peer identifier is nil", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v30);
      v34 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (*(v19 + 2))(v19, 0, v34);

      v21 = 0;
    }
  }

  else
  {
    v26 = objc_autoreleasePoolPush();
    v27 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      *buf = 138543362;
      v44 = v29;
      _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Cannot query configuring state as accessory UUID is nil", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v26);
    v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(v19 + 2))(v19, 0, v21);
  }

  v40 = *MEMORY[0x277D85DE8];
}

void __177__HMDHomeManager_ConfiguringState__fetchDiagnosticStateWithOptions_accessoryUUID_additionalFetchKeys_filteringKeyPaths_remoteMessageTimeout_remoteMessageRestriction_completion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 32);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v10;
      v19 = 2112;
      v20 = v6;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@Query configuring state failed with error: (%@): ", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    (*(*(a1 + 40) + 16))();
  }

  else
  {
    v11 = [*(a1 + 32) _decodeDiagnosticInfoFromLocalResponse:v5];
    (*(*(a1 + 40) + 16))();
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v15;
      v19 = 2112;
      v20 = v11;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Query message sent, response: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)fetchSetupDiagnosticStateWithOptions:(unint64_t)a3 accessoryUUID:(id)a4 remoteMessageTimeout:(double)a5 remoteMessageRestriction:(unint64_t)a6 completion:(id)a7
{
  v18 = *MEMORY[0x277D85DE8];
  v17 = *MEMORY[0x277CD0118];
  v12 = MEMORY[0x277CBEA60];
  v13 = a7;
  v14 = a4;
  v15 = [v12 arrayWithObjects:&v17 count:1];
  [(HMDHomeManager *)self fetchDiagnosticStateWithOptions:a3 accessoryUUID:v14 additionalFetchKeys:v15 filteringKeyPaths:MEMORY[0x277CBEBF8] remoteMessageTimeout:a6 remoteMessageRestriction:v13 completion:a5, v17, v18];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_maybeCreateLegacyHomeAcceptedZone:(id)a3
{
  v4 = a3;
  if (v4)
  {
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke;
    v9[3] = &unk_2797275C0;
    v9[4] = self;
    v10 = v4;
    v5 = v4;
    [(HMDHomeManager *)self _queryLegacyHomeAndAcceptedZoneExists:v5 completion:v9];
  }

  else
  {
    v6 = _HMFPreconditionFailure();
    __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke(v6, v7, v8);
  }
}

void __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke(uint64_t a1, char a2, int a3)
{
  v48[1] = *MEMORY[0x277D85DE8];
  if ((a2 & 1) == 0)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v10 = *(a1 + 40);
      *buf = 138543618;
      v41 = v7;
      v42 = 2112;
      v43 = v10;
      v9 = "%{public}@Skip creating home accepted zone since no legacy home %@ was found";
      goto LABEL_7;
    }

LABEL_8:

    objc_autoreleasePoolPop(v4);
    goto LABEL_17;
  }

  if (a3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v8 = *(a1 + 40);
      *buf = 138543618;
      v41 = v7;
      v42 = 2112;
      v43 = v8;
      v9 = "%{public}@Skip creating home accepted zone for home %@ since it already exists";
LABEL_7:
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, v9, buf, 0x16u);

      goto LABEL_8;
    }

    goto LABEL_8;
  }

  v11 = [*(a1 + 32) _legacyContainer];
  v12 = [v11 privateCloudDatabase];
  v13 = objc_alloc(MEMORY[0x277CBC5E8]);
  v14 = [*(a1 + 32) _legacyHomeAcceptedZoneIDFromHomeUUID:*(a1 + 40)];
  v15 = [v13 initWithZoneID:v14];

  if (v15)
  {
    v16 = objc_alloc(MEMORY[0x277CBC490]);
    v48[0] = v15;
    v17 = [MEMORY[0x277CBEA60] arrayWithObjects:v48 count:1];
    v18 = [v16 initWithRecordZonesToSave:v17 recordZoneIDsToDelete:0];

    v37 = v12;
    [v18 setDatabase:v12];
    v19 = [v18 operationID];
    v20 = objc_autoreleasePoolPush();
    v21 = *(a1 + 32);
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v23 = v36 = v11;
      v24 = *(a1 + 40);
      [v15 zoneID];
      v25 = v35 = v20;
      v26 = [v25 zoneName];
      *buf = 138544130;
      v41 = v23;
      v42 = 2112;
      v43 = v24;
      v44 = 2112;
      v45 = v26;
      v46 = 2112;
      v47 = v19;
      _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Saving legacy home accepted zone for home/zoneAccepted (%@/%@) with operation ID %@", buf, 0x2Au);

      v20 = v35;
      v11 = v36;
    }

    objc_autoreleasePoolPop(v20);
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke_13;
    v38[3] = &unk_279727598;
    v38[4] = *(a1 + 32);
    v39 = v19;
    v27 = v19;
    [v18 setModifyRecordZonesCompletionBlock:v38];
    v12 = v37;
    v28 = [v37 operationQueue];
    [v28 addOperation:v18];
  }

  else
  {
    v29 = objc_autoreleasePoolPush();
    v30 = *(a1 + 32);
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
    {
      v32 = HMFGetLogIdentifier();
      v33 = *(a1 + 40);
      *buf = 138543618;
      v41 = v32;
      v42 = 2112;
      v43 = v33;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Failed to determine legacy accepted zoneID for home %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
  }

LABEL_17:
  v34 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_LegacyHomeZone___maybeCreateLegacyHomeAcceptedZone___block_invoke_13(uint64_t a1, void *a2, void *a3, void *a4)
{
  v22 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 32);
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = *(a1 + 40);
    v16 = 138543874;
    v17 = v13;
    v18 = 2112;
    v19 = v14;
    v20 = 2112;
    v21 = v9;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Completed saving legacy home accepted zone with operation ID %@ and error %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v10);
  v15 = *MEMORY[0x277D85DE8];
}

- (void)_queryLegacyHomeAndAcceptedZoneExists:(id)a3 completion:(id)a4
{
  v46[2] = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  if (!v6)
  {
    _HMFPreconditionFailure();
  }

  v8 = v7;
  v9 = [(HMDHomeManager *)self _legacyContainer];
  v10 = [v9 privateCloudDatabase];
  v11 = [(HMDHomeManager *)self _legacyHomeZoneIDFromHomeUUID:v6];
  v12 = [(HMDHomeManager *)self _legacyHomeAcceptedZoneIDFromHomeUUID:v6];
  v13 = v12;
  if (v11 && v12)
  {
    v32 = v9;
    v14 = objc_alloc(MEMORY[0x277CBC3D0]);
    v46[0] = v11;
    v46[1] = v13;
    v15 = [MEMORY[0x277CBEA60] arrayWithObjects:v46 count:2];
    v16 = [v14 initWithRecordZoneIDs:v15];

    v31 = v10;
    [v16 setDatabase:v10];
    v17 = [v16 operationID];
    v18 = objc_autoreleasePoolPush();
    v19 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v21 = v30 = v8;
      v22 = [v11 zoneName];
      *buf = 138544130;
      v39 = v21;
      v40 = 2112;
      v41 = v6;
      v42 = 2112;
      v43 = v22;
      v44 = 2112;
      v45 = v17;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Querying the legacy container for existing home/zone (%@/%@) with operation ID %@", buf, 0x2Au);

      v8 = v30;
    }

    objc_autoreleasePoolPop(v18);
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __83__HMDHomeManager_LegacyHomeZone___queryLegacyHomeAndAcceptedZoneExists_completion___block_invoke;
    v33[3] = &unk_279727570;
    v33[4] = v19;
    v34 = v17;
    v35 = v11;
    v36 = v13;
    v37 = v8;
    v23 = v17;
    [v16 setFetchRecordZonesCompletionBlock:v33];
    v10 = v31;
    v24 = [v31 operationQueue];
    [v24 addOperation:v16];

    v9 = v32;
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543618;
      v39 = v28;
      v40 = 2112;
      v41 = v6;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Failed to determine legacy zoneID for home %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v8[2](v8, 0, 0);
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __83__HMDHomeManager_LegacyHomeZone___queryLegacyHomeAndAcceptedZoneExists_completion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v31 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    *buf = 138543874;
    v26 = v10;
    v27 = 2112;
    v28 = v11;
    v29 = 2112;
    v30 = v6;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Completed fetching record zone with operation ID %@ and error %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  if (v5)
  {
    [v5 objectForKeyedSubscript:*(a1 + 48)];

    [v5 objectForKeyedSubscript:*(a1 + 56)];
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v24 = v6;
      v15 = HMFGetLogIdentifier();
      v16 = HMFBooleanToString();
      v17 = HMFBooleanToString();
      *buf = 138543874;
      v26 = v15;
      v27 = 2112;
      v28 = v16;
      v29 = 2112;
      v30 = v17;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Legacy home zone exists = %@ and legacy home accepted zone = %@", buf, 0x20u);

      v6 = v24;
    }

    objc_autoreleasePoolPop(v12);
    v18 = *(*(a1 + 64) + 16);
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = *(a1 + 32);
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543362;
      v26 = v22;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to determine legacy zones returning that neither home zone or home accepted zone exist", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v19);
    v18 = *(*(a1 + 64) + 16);
  }

  v18();

  v23 = *MEMORY[0x277D85DE8];
}

- (id)_legacyHomeAcceptedZoneIDFromHomeUUID:(id)a3
{
  v3 = a3;
  if (v3)
  {
    v4 = v3;
    v5 = [HMDHome zoneIDFromHomeUUID:v3];
    v6 = MEMORY[0x277CCACA8];
    v7 = [v5 UUIDString];
    v8 = [v6 stringWithFormat:@"%@_accepted", v7];

    v9 = objc_alloc(MEMORY[0x277CBC5F8]);
    v10 = [v9 initWithZoneName:v8 ownerName:*MEMORY[0x277CBBF28]];

    return v10;
  }

  else
  {
    v12 = _HMFPreconditionFailure();
    return [(HMDHomeManager *)v12 _legacyHomeZoneIDFromHomeUUID:v13, v14];
  }
}

- (id)_legacyHomeZoneIDFromHomeUUID:(id)a3
{
  v3 = a3;
  if (v3)
  {
    v4 = v3;
    v5 = [HMDHome zoneIDFromHomeUUID:v3];
    v6 = objc_alloc(MEMORY[0x277CBC5F8]);
    v7 = [v5 UUIDString];
    v8 = [v6 initWithZoneName:v7 ownerName:*MEMORY[0x277CBBF28]];

    return v8;
  }

  else
  {
    v10 = _HMFPreconditionFailure();
    return [(HMDHomeManager *)v10 _legacyContainer];
  }
}

- (id)_legacyContainer
{
  v2 = objc_alloc(MEMORY[0x277CBC220]);
  v3 = [v2 initWithContainerIdentifier:@"com.apple.willow.config" environment:cloudKitContainerEnvironment];
  v4 = [objc_alloc(MEMORY[0x277CBC218]) initWithContainerID:v3];

  return v4;
}

- (void)autoAddWalletKeysOncePerDeviceSetup
{
  v38 = *MEMORY[0x277D85DE8];
  v24 = objc_alloc_init(HMDHomeWalletDataSource);
  v22 = [(HMDHomeWalletDataSource *)v24 numberValueFromNoBackupStoreWithKey:@"HMDHomeManagerRecordInitialWalletKeysOncePerDevice"];
  if (([v22 BOOLValue] & 1) == 0)
  {
    v3 = [HMDWalletPassLibrary alloc];
    v4 = [(HMDHomeManager *)self workQueue];
    v5 = [(HMDWalletPassLibrary *)v3 initWithWorkQueue:v4];

    v6 = +[HMDHomeKeyDataRecorder sharedRecorder];
    v7 = [(HMDWalletPassLibrary *)v5 walletKeys];
    v8 = [v7 allObjects];
    [v6 recordInitialWalletKeys:v8];

    [(HMDHomeWalletDataSource *)v24 persistNumberValueToNoBackupStore:MEMORY[0x277CBEC38] withKey:@"HMDHomeManagerRecordInitialWalletKeysOncePerDevice"];
  }

  v9 = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [v9 UUID];
    *buf = 138543618;
    v35 = v13;
    v36 = 2112;
    v37 = v14;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Auto add wallet keys once per device setup", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  v31 = 0u;
  v32 = 0u;
  v29 = 0u;
  v30 = 0u;
  obj = [(HMDHomeManager *)v11 homes];
  v15 = [obj countByEnumeratingWithState:&v29 objects:v33 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v30;
    do
    {
      for (i = 0; i != v16; ++i)
      {
        if (*v30 != v17)
        {
          objc_enumerationMutation(obj);
        }

        v19 = *(*(&v29 + 1) + 8 * i);
        v20 = [v19 workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __61__HMDHomeManager_Wallet__autoAddWalletKeysOncePerDeviceSetup__block_invoke;
        block[3] = &unk_279734870;
        block[4] = v19;
        v26 = v24;
        v27 = v11;
        v28 = v9;
        dispatch_async(v20, block);
      }

      v16 = [obj countByEnumeratingWithState:&v29 objects:v33 count:16];
    }

    while (v16);
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager_Wallet__autoAddWalletKeysOncePerDeviceSetup__block_invoke(id *a1)
{
  v35 = *MEMORY[0x277D85DE8];
  v2 = MEMORY[0x277CCAD78];
  v3 = [a1[4] uuid];
  v4 = [@"D4F5EA54-226C-44B6-B7CD-45DA59BE5B1F" dataUsingEncoding:4];
  v5 = [v2 hmf_UUIDWithNamespace:v3 data:v4];
  v6 = [v5 UUIDString];

  v7 = [a1[5] numberValueFromNoBackupStoreWithKey:v6];
  v8 = objc_autoreleasePoolPush();
  v9 = a1[6];
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v12 = [a1[7] UUID];
    v13 = a1[4];
    v27 = 138544130;
    v28 = v11;
    v29 = 2112;
    v30 = v12;
    v31 = 2112;
    v32 = v13;
    v33 = 2112;
    v34 = v6;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Auto add wallet key preference key for home %@:%@", &v27, 0x2Au);
  }

  objc_autoreleasePoolPop(v8);
  v14 = [v7 BOOLValue];
  v15 = objc_autoreleasePoolPush();
  v16 = a1[6];
  v17 = HMFGetOSLogHandle();
  v18 = os_log_type_enabled(v17, OS_LOG_TYPE_INFO);
  if (v14)
  {
    if (v18)
    {
      v19 = HMFGetLogIdentifier();
      v20 = [a1[7] UUID];
      v21 = a1[4];
      v27 = 138543874;
      v28 = v19;
      v29 = 2112;
      v30 = v20;
      v31 = 2112;
      v32 = v21;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Already auto added wallet key once per device setup for home: %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v15);
  }

  else
  {
    if (v18)
    {
      v22 = HMFGetLogIdentifier();
      v23 = [a1[7] UUID];
      v24 = a1[4];
      v27 = 138543874;
      v28 = v22;
      v29 = 2112;
      v30 = v23;
      v31 = 2112;
      v32 = v24;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Auto adding wallet key once per device setup for home: %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v15);
    v25 = [a1[4] walletKeyManager];
    [v25 autoAddWalletKeyWithFlow:a1[7]];

    [a1[5] persistNumberValueToNoBackupStore:MEMORY[0x277CBEC38] withKey:v6];
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (void)removeHomeWalletKeysExcludingSerialNumbers:(id)a3 flow:(id)a4
{
  v53 = *MEMORY[0x277D85DE8];
  v41 = a3;
  v40 = a4;
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [v40 UUID];
    *buf = 138543874;
    v48 = v9;
    v49 = 2112;
    v50 = v10;
    v51 = 2112;
    v52 = v41;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Removing home wallet keys with serial number not in: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v11 = [HMDWalletPassLibrary alloc];
  v12 = [(HMDHomeManager *)v7 workQueue];
  v13 = [(HMDWalletPassLibrary *)v11 initWithWorkQueue:v12];

  v38 = v13;
  v14 = [(HMDWalletPassLibrary *)v13 walletKeys];
  v15 = objc_autoreleasePoolPush();
  v16 = v7;
  v17 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
  {
    v18 = HMFGetLogIdentifier();
    v19 = [v40 UUID];
    *buf = 138543874;
    v48 = v18;
    v49 = 2112;
    v50 = v19;
    v51 = 2112;
    v52 = v14;
    _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Existing home keys in wallet: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v15);
  v44 = 0u;
  v45 = 0u;
  v42 = 0u;
  v43 = 0u;
  obj = v14;
  v20 = [obj countByEnumeratingWithState:&v42 objects:v46 count:16];
  if (v20)
  {
    v22 = v20;
    v23 = *v43;
    *&v21 = 138543874;
    v37 = v21;
    do
    {
      for (i = 0; i != v22; ++i)
      {
        if (*v43 != v23)
        {
          objc_enumerationMutation(obj);
        }

        v25 = *(*(&v42 + 1) + 8 * i);
        v26 = [v25 serialNumber];
        v27 = [v41 containsObject:v26];

        if ((v27 & 1) == 0)
        {
          v28 = objc_autoreleasePoolPush();
          v29 = v16;
          v30 = v16;
          v31 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
          {
            v32 = HMFGetLogIdentifier();
            v33 = [v40 UUID];
            *buf = v37;
            v48 = v32;
            v49 = 2112;
            v50 = v33;
            v51 = 2112;
            v52 = v25;
            _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@[Flow: %@] Removing wallet key that doesn't belong to any home: %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v28);
          v34 = [v25 typeIdentifier];
          v35 = [v25 serialNumber];
          [(HMDWalletPassLibrary *)v38 removePassWithTypeIdentifier:v34 serialNumber:v35 flow:v40];

          v16 = v29;
        }
      }

      v22 = [obj countByEnumeratingWithState:&v42 objects:v46 count:16];
    }

    while (v22);
  }

  v36 = *MEMORY[0x277D85DE8];
}

- (NSSet)homeUUIDsWithAutoAddWalletKeySuppressed
{
  os_unfair_lock_lock_with_options();
  v3 = [(HMDHomeManager *)self homeUUIDsWithAutoAddWalletKeySuppressedSync];
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)handleXPCConnectionDeactivatedNotification:(id)a3
{
  v35 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 userInfo];
  v6 = [v5 objectForKeyedSubscript:@"connection"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if (!v8)
  {
    _HMFPreconditionFailure();
  }

  v9 = objc_autoreleasePoolPush();
  v10 = self;
  v11 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
  {
    v12 = HMFGetLogIdentifier();
    *buf = 138543618;
    v32 = v12;
    v33 = 2112;
    v34 = v8;
    _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Handling wallet key assertion when xpc connection was removed: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  os_unfair_lock_lock_with_options();
  v13 = [(HMDHomeManager *)v10 homeUUIDsWithAutoAddWalletKeySuppressedSync];
  v14 = [v13 mutableCopy];

  v15 = [(HMDHomeManager *)v10 homeUUIDsByWalletKeyAssertionXPCConnection];
  [v15 removeObjectForKey:v8];

  v16 = [(HMDHomeManager *)v10 homeUUIDsWithAutoAddWalletKeySuppressedSync];
  [v14 minusSet:v16];

  os_unfair_lock_unlock(&v10->_lock);
  if ([v14 count])
  {
    v17 = objc_autoreleasePoolPush();
    v18 = v10;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543618;
      v32 = v20;
      v33 = 2112;
      v34 = v14;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Auto adding wallet key due to xpc connection was removed for homes with UUIDs: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    v21 = v14;
    v22 = [v21 countByEnumeratingWithState:&v26 objects:v30 count:16];
    if (v22)
    {
      v23 = *v27;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v27 != v23)
          {
            objc_enumerationMutation(v21);
          }

          [(HMDHomeManager *)v18 addWalletKeyWithHomeUUID:*(*(&v26 + 1) + 8 * i) reason:@"connection removed", v26];
        }

        v22 = [v21 countByEnumeratingWithState:&v26 objects:v30 count:16];
      }

      while (v22);
    }
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (id)homeUUIDsWithAutoAddWalletKeySuppressedSync
{
  v21 = *MEMORY[0x277D85DE8];
  os_unfair_lock_assert_owner(&self->_lock);
  v3 = [MEMORY[0x277CBEB58] set];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v4 = [(HMDHomeManager *)self homeUUIDsByWalletKeyAssertionXPCConnection];
  v5 = [v4 countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v17;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v17 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v16 + 1) + 8 * i);
        v10 = [(HMDHomeManager *)self homeUUIDsByWalletKeyAssertionXPCConnection];
        v11 = [v10 objectForKey:v9];
        v12 = [v11 allObjects];
        [v3 addObjectsFromArray:v12];
      }

      v6 = [v4 countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v6);
  }

  v13 = [v3 copy];
  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)addWalletKeyWithHomeUUID:(id)a3 reason:(id)a4
{
  v33 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self _homeWithUUID:v6];
  if (v8)
  {
    v9 = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
    v10 = objc_autoreleasePoolPush();
    v11 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [v9 UUID];
      *buf = 138544130;
      v26 = v13;
      v27 = 2112;
      v28 = v14;
      v29 = 2112;
      v30 = v6;
      v31 = 2112;
      v32 = v7;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Auto adding for wallet key for home with uuid: %@ reason: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v10);
    v15 = [v8 workQueue];
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __58__HMDHomeManager_Wallet__addWalletKeyWithHomeUUID_reason___block_invoke;
    v22[3] = &unk_2797359B0;
    v23 = v8;
    v24 = v9;
    v16 = v9;
    dispatch_async(v15, v22);
  }

  else
  {
    v17 = objc_autoreleasePoolPush();
    v18 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543874;
      v26 = v20;
      v27 = 2112;
      v28 = v6;
      v29 = 2112;
      v30 = v7;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Not auto adding wallet key for home with uuid: %@ reason: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager_Wallet__addWalletKeyWithHomeUUID_reason___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) walletKeyManager];
  [v2 autoAddWalletKeyWithFlow:*(a1 + 40)];
}

- (void)handleAutoAddWalletKeySupressionAssertionReleaseMessage:(id)a3
{
  v48 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [v4 messagePayload];
    v42 = 138543874;
    v43 = v9;
    v44 = 2112;
    v45 = v4;
    v46 = 2112;
    v47 = v10;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Handling auto add wallet key suppression assertion release message: %@, payload: %@", &v42, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v11 = [v4 transport];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = v11;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  if (v13)
  {
    v14 = [v4 uuidForKey:*MEMORY[0x277CD0298]];
    if (v14)
    {
      os_unfair_lock_lock_with_options();
      v15 = [(HMDHomeManager *)v7 homeUUIDsByWalletKeyAssertionXPCConnection];
      v16 = [v15 objectForKey:v13];

      v17 = [v16 containsObject:v14];
      v18 = v17;
      if (v17)
      {
        [v16 removeObject:v14];
      }

      v19 = [(HMDHomeManager *)v7 homeUUIDsWithAutoAddWalletKeySuppressedSync];
      v20 = [v19 containsObject:v14];

      os_unfair_lock_unlock(&v7->_lock);
      if (v18)
      {
        [v4 respondWithSuccess];
        if (v20)
        {
          v21 = objc_autoreleasePoolPush();
          v22 = v7;
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            v42 = 138543618;
            v43 = v24;
            v44 = 2112;
            v45 = v14;
            _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Not auto adding wallet key for home with uuid: %@ after assertion was released because of some other pending assertion", &v42, 0x16u);
          }

          objc_autoreleasePoolPop(v21);
        }

        else
        {
          [(HMDHomeManager *)v7 addWalletKeyWithHomeUUID:v14 reason:@"assertion released"];
        }
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        v37 = v7;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          v42 = 138543874;
          v43 = v39;
          v44 = 2112;
          v45 = v14;
          v46 = 2112;
          v47 = v13;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_INFO, "%{public}@Could not find any any assertion for home with uuid: %@ for connection: %@", &v42, 0x20u);
        }

        objc_autoreleasePoolPop(v36);
        v40 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        [v4 respondWithError:v40];
      }
    }

    else
    {
      v30 = objc_autoreleasePoolPush();
      v31 = v7;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        v33 = HMFGetLogIdentifier();
        v34 = [v4 messagePayload];
        v42 = 138543618;
        v43 = v33;
        v44 = 2112;
        v45 = v34;
        _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, "%{public}@Missing home uuid parameter in message payload: %@", &v42, 0x16u);
      }

      objc_autoreleasePoolPop(v30);
      v35 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [v4 respondWithError:v35];

      v14 = 0;
    }
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = v7;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      v28 = HMFGetLogIdentifier();
      v29 = [v4 transport];
      v42 = 138543618;
      v43 = v28;
      v44 = 2112;
      v45 = v29;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_ERROR, "%{public}@Received auto add wallet key suppression assertion release message from unknown transport: %@", &v42, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [v4 respondWithError:v14];
  }

  v41 = *MEMORY[0x277D85DE8];
}

- (void)handleAutoAddWalletKeySupressionAssertionAcquireMessage:(id)a3
{
  v36 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [v4 messagePayload];
    v30 = 138543874;
    v31 = v9;
    v32 = 2112;
    v33 = v4;
    v34 = 2112;
    v35 = v10;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Handling auto add wallet key suppression assertion acquire message: %@, payload: %@", &v30, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v11 = [v4 transport];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = v11;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  if (v13)
  {
    v14 = [v4 uuidForKey:*MEMORY[0x277CD0298]];
    if (v14)
    {
      os_unfair_lock_lock_with_options();
      v15 = [(HMDHomeManager *)v7 homeUUIDsByWalletKeyAssertionXPCConnection];
      v16 = [v15 objectForKey:v13];

      if (!v16)
      {
        v16 = [MEMORY[0x277CBEB58] set];
        v17 = [(HMDHomeManager *)v7 homeUUIDsByWalletKeyAssertionXPCConnection];
        [v17 setObject:v16 forKey:v13];
      }

      [v16 addObject:v14];

      os_unfair_lock_unlock(&v7->_lock);
      [v4 respondWithSuccess];
    }

    else
    {
      v23 = objc_autoreleasePoolPush();
      v24 = v7;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
      {
        v26 = HMFGetLogIdentifier();
        v27 = [v4 messagePayload];
        v30 = 138543618;
        v31 = v26;
        v32 = 2112;
        v33 = v27;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_ERROR, "%{public}@Missing home uuid parameter in message payload: %@", &v30, 0x16u);
      }

      objc_autoreleasePoolPop(v23);
      v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [v4 respondWithError:v28];

      v14 = 0;
    }
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = v7;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      v22 = [v4 transport];
      v30 = 138543618;
      v31 = v21;
      v32 = 2112;
      v33 = v22;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Received auto add wallet key suppression assertion acquire message from unknown transport: %@", &v30, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [v4 respondWithError:v14];
  }

  v29 = *MEMORY[0x277D85DE8];
}

- (void)configureForWalletKey
{
  v13[1] = *MEMORY[0x277D85DE8];
  v3 = [HMDXPCMessagePolicy policyWithEntitlements:131077];
  v4 = [(HMDHomeManager *)self messageDispatcher];
  v5 = *MEMORY[0x277CD0098];
  v13[0] = v3;
  v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v13 count:1];
  [v4 registerForMessage:v5 receiver:self policies:v6 selector:sel_handleAutoAddWalletKeySupressionAssertionAcquireMessage_];

  v7 = [(HMDHomeManager *)self messageDispatcher];
  v8 = *MEMORY[0x277CD00A0];
  v12 = v3;
  v9 = [MEMORY[0x277CBEA60] arrayWithObjects:&v12 count:1];
  [v7 registerForMessage:v8 receiver:self policies:v9 selector:sel_handleAutoAddWalletKeySupressionAssertionReleaseMessage_];

  v10 = [(HMDHomeManager *)self notificationCenter];
  [v10 addObserver:self selector:sel_handleXPCConnectionDeactivatedNotification_ name:@"HMDXPCClientConnectionDidDeactivateNotification" object:0];

  v11 = *MEMORY[0x277D85DE8];
}

- (id)mediaGroupUsingHintsForHomeUUID:(id)a3 accessoryUUID:(id)a4
{
  v30 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self mediaSystemHints];

  if (v8)
  {
    v9 = [(HMDHomeManager *)self homeUUIDFromHints];
    v10 = [(HMDHomeManager *)self mediaSystemUUIDFromHints];
    v11 = [(HMDHomeManager *)self peerAccessoryUUIDFromHints];
    v12 = [(HMDHomeManager *)self peerAccessoryRoleFromHints];
    v13 = v12;
    v14 = 0;
    if (v9 && v10 && v11 && v12)
    {
      if ([v6 hmf_isEqualToUUID:v9])
      {
        v15 = [MEMORY[0x277CD1C08] roomNameSentinel];
        v16 = [MEMORY[0x277CD1C10] leftRole];
        v17 = [v13 isEqual:v16];

        if (v17)
        {
          v18 = v11;
        }

        else
        {
          v18 = v7;
        }

        if (v17)
        {
          v19 = v7;
        }

        else
        {
          v19 = v11;
        }

        v20 = v18;
        v21 = v19;
        v14 = [objc_alloc(MEMORY[0x277CD1C08]) initWithIdentifier:v10 parentIdentifier:v6 name:v15 defaultName:1 associatedGroupIdentifier:0 leftDestinationIdentifier:v20 rightDestinationIdentifier:v21];
      }

      else
      {
        v22 = objc_autoreleasePoolPush();
        v23 = self;
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v29 = v25;
          _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_ERROR, "%{public}@Home UUID is different from the current accessory home UUID", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v22);
        v14 = 0;
      }
    }
  }

  else
  {
    v14 = 0;
  }

  v26 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)peerAccessoryRoleFromHints
{
  v3 = [(HMDHomeManager *)self mediaSystemHints];

  if (v3)
  {
    v4 = [(HMDHomeManager *)self mediaSystemHints];
    v5 = [v4 peerAccessoryRoleString];
    v6 = StringAsHMMediaSystemRoleType();

    v7 = [objc_alloc(MEMORY[0x277CD1C10]) initWithRole:v6];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)peerAccessoryUUIDFromHints
{
  v3 = [(HMDHomeManager *)self mediaSystemHints];
  if (v3)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    v5 = [(HMDHomeManager *)self mediaSystemHints];
    v6 = [v5 peerAccessoryUUIDString];
    v7 = [v4 initWithUUIDString:v6];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)mediaSystemUUIDFromHints
{
  v3 = [(HMDHomeManager *)self mediaSystemHints];
  if (v3)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    v5 = [(HMDHomeManager *)self mediaSystemHints];
    v6 = [v5 mediaSystemUUIDString];
    v7 = [v4 initWithUUIDString:v6];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (id)homeUUIDFromHints
{
  v3 = [(HMDHomeManager *)self mediaSystemHints];
  if (v3)
  {
    v4 = objc_alloc(MEMORY[0x277CCAD78]);
    v5 = [(HMDHomeManager *)self mediaSystemHints];
    v6 = [v5 mediaSystemHomeUUIDString];
    v7 = [v4 initWithUUIDString:v6];
  }

  else
  {
    v7 = 0;
  }

  return v7;
}

- (BOOL)hasMediaSystemHints
{
  v3 = [(HMDHomeManager *)self mediaSystemHints];
  if (v3)
  {
    v4 = [(HMDHomeManager *)self mediaSystemHints];
    v5 = [v4 mediaSystemHomeUUIDString];
    if (v5)
    {
      v6 = [(HMDHomeManager *)self mediaSystemHints];
      v7 = [v6 mediaSystemUUIDString];
      if (v7)
      {
        v8 = [(HMDHomeManager *)self mediaSystemHints];
        v9 = [v8 peerAccessoryUUIDString];
        if (v9)
        {
          v10 = [(HMDHomeManager *)self mediaSystemHints];
          v11 = [v10 peerAccessoryRoleString];
          v12 = v11 != 0;
        }

        else
        {
          v12 = 0;
        }
      }

      else
      {
        v12 = 0;
      }
    }

    else
    {
      v12 = 0;
    }
  }

  else
  {
    v12 = 0;
  }

  return v12;
}

- (BOOL)restoreMediaSystemHintsFromDisk
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Ask to restore the media system hints from previously saved hints", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [(HMDHomeManager *)v4 userDefaults];
  v8 = [v7 objectForKey:*MEMORY[0x277CD2450]];

  v9 = [(HMDHomeManager *)v4 userDefaults];
  v10 = [v9 objectForKey:*MEMORY[0x277CD2470]];

  v11 = [(HMDHomeManager *)v4 userDefaults];
  v12 = [v11 objectForKey:*MEMORY[0x277CD24A0]];

  v13 = [(HMDHomeManager *)v4 userDefaults];
  v14 = [v13 objectForKey:*MEMORY[0x277CD2498]];

  if (v8)
  {
    v15 = v10 == 0;
  }

  else
  {
    v15 = 1;
  }

  v17 = v15 || v12 == 0 || v14 == 0;
  v18 = !v17;
  if (!v17)
  {
    v19 = [[HMDMediaSystemHints alloc] initWithMediaSystemHomeUUIDString:v8 mediaSystemUUIDString:v10 peerAccessoryUUIDString:v12 peerAccessoryRoleString:v14];
    [(HMDHomeManager *)v4 setMediaSystemHints:v19];
  }

  v20 = *MEMORY[0x277D85DE8];
  return v18;
}

- (void)clearMediaSystemHints:(BOOL)a3
{
  v3 = a3;
  v22 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [(HMDHomeManager *)v6 mediaSystemHints];
    v10 = HMFBooleanToString();
    v16 = 138543874;
    v17 = v8;
    v18 = 2112;
    v19 = v9;
    v20 = 2112;
    v21 = v10;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Ask to clear the media system hints %@, persist to disk: %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)v6 setMediaSystemHints:0];
  if (v3)
  {
    v11 = [(HMDHomeManager *)v6 userDefaults];
    [v11 removeObjectForKey:*MEMORY[0x277CD2450]];

    v12 = [(HMDHomeManager *)v6 userDefaults];
    [v12 removeObjectForKey:*MEMORY[0x277CD2470]];

    v13 = [(HMDHomeManager *)v6 userDefaults];
    [v13 removeObjectForKey:*MEMORY[0x277CD24A0]];

    v14 = [(HMDHomeManager *)v6 userDefaults];
    [v14 removeObjectForKey:*MEMORY[0x277CD2498]];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)saveMediaSystemHintsWithHomeUUIDString:(id)a3 mediaSystemUUIDString:(id)a4 peerAccessoryUUIDString:(id)a5 peerAccessoryRoleString:(id)a6 persistToDisk:(BOOL)a7
{
  v7 = a7;
  v46 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v13 = a4;
  v14 = a5;
  v15 = a6;
  v16 = [(HMDHomeManager *)self mediaSystemHints];

  if (v16)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v20 = v38 = v7;
      v21 = [(HMDHomeManager *)v18 mediaSystemHints];
      *buf = 138543618;
      v41 = v20;
      v42 = 2112;
      v43 = v21;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Overwriting existing media system hints %@", buf, 0x16u);

      v7 = v38;
    }

    objc_autoreleasePoolPop(v17);
  }

  v22 = [[HMDMediaSystemHints alloc] initWithMediaSystemHomeUUIDString:v12 mediaSystemUUIDString:v13 peerAccessoryUUIDString:v14 peerAccessoryRoleString:v15];
  [(HMDHomeManager *)self setMediaSystemHints:v22];

  v23 = objc_autoreleasePoolPush();
  v24 = self;
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
  {
    v26 = HMFGetLogIdentifier();
    v27 = [(HMDHomeManager *)v24 mediaSystemHints];
    HMFBooleanToString();
    v39 = v15;
    v28 = v14;
    v29 = v13;
    v30 = v12;
    v32 = v31 = v7;
    *buf = 138543874;
    v41 = v26;
    v42 = 2112;
    v43 = v27;
    v44 = 2112;
    v45 = v32;
    _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Set media system hints to %@, persist to disk: %@", buf, 0x20u);

    v7 = v31;
    v12 = v30;
    v13 = v29;
    v14 = v28;
    v15 = v39;
  }

  objc_autoreleasePoolPop(v23);
  if (v7)
  {
    v33 = [(HMDHomeManager *)v24 userDefaults];
    [v33 setObject:v12 forKey:*MEMORY[0x277CD2450]];

    v34 = [(HMDHomeManager *)v24 userDefaults];
    [v34 setObject:v13 forKey:*MEMORY[0x277CD2470]];

    v35 = [(HMDHomeManager *)v24 userDefaults];
    [v35 setObject:v14 forKey:*MEMORY[0x277CD24A0]];

    v36 = [(HMDHomeManager *)v24 userDefaults];
    [v36 setObject:v15 forKey:*MEMORY[0x277CD2498]];
  }

  v37 = *MEMORY[0x277D85DE8];
}

- (void)handleRemoveMediaSystemHints:(id)a3
{
  v12 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Handling remove media system hints message", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)v6 clearMediaSystemHints:0];
  [v4 respondWithSuccess];

  v9 = *MEMORY[0x277D85DE8];
}

- (void)handleAddMediaSystemHints:(id)a3
{
  v29 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v27 = 138543362;
    v28 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Handling add media system hints message", &v27, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [v4 messagePayload];
  v10 = [v9 objectForKeyedSubscript:*MEMORY[0x277CD2450]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v11 = v10;
  }

  else
  {
    v11 = 0;
  }

  v12 = v11;

  v13 = [v4 messagePayload];
  v14 = [v13 objectForKeyedSubscript:*MEMORY[0x277CD2470]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v15 = v14;
  }

  else
  {
    v15 = 0;
  }

  v16 = v15;

  v17 = [v4 messagePayload];
  v18 = [v17 objectForKeyedSubscript:*MEMORY[0x277CD24A0]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v19 = v18;
  }

  else
  {
    v19 = 0;
  }

  v20 = v19;

  v21 = [v4 messagePayload];
  v22 = [v21 objectForKeyedSubscript:*MEMORY[0x277CD2498]];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v23 = v22;
  }

  else
  {
    v23 = 0;
  }

  v24 = v23;

  if (v12 && v16 && v20 && v24)
  {
    [(HMDHomeManager *)v6 saveMediaSystemHintsWithHomeUUIDString:v12 mediaSystemUUIDString:v16 peerAccessoryUUIDString:v20 peerAccessoryRoleString:v24 persistToDisk:0];
    [v4 respondWithSuccess];
  }

  else
  {
    v25 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [v4 respondWithError:v25];
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (void)_registerForMediaSystemHintsMessages
{
  v19 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v18 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for media system hints messages", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v8 = [(HMDHomeManager *)v4 messageDispatcher];
  v9 = *MEMORY[0x277CD2090];
  v16 = v7;
  v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
  [v8 registerForMessage:v9 receiver:v4 policies:v10 selector:sel_handleAddMediaSystemHints_];

  v11 = [(HMDHomeManager *)v4 messageDispatcher];
  v12 = *MEMORY[0x277CD2510];
  v15 = v7;
  v13 = [MEMORY[0x277CBEA60] arrayWithObjects:&v15 count:1];
  [v11 registerForMessage:v12 receiver:v4 policies:v13 selector:sel_handleRemoveMediaSystemHints_];

  v14 = *MEMORY[0x277D85DE8];
}

- (void)prepareForDiagnosticExtension:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v22 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Triggering memory exception.", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85F48];
  corpse_task_port = 0;
  if (task_generate_corpse(v9, &corpse_task_port))
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v12;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Failed to generate a corpse task for memory exception reporting.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [v4 respondWithError:v13];
  }

  else
  {
    v14 = [MEMORY[0x277D0F8E0] processInfo];
    v15 = [v14 executableURL];
    v16 = [v15 path];
    [v16 UTF8String];
    v17 = dispatch_get_global_queue(-32768, 0);
    v19 = v4;
    ReportMemoryExceptionFromTask();

    v13 = v19;
  }

  v18 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_DiagnosticExtension__prepareForDiagnosticExtension___block_invoke(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  [*(a1 + 32) respondWithPayload:0 error:v3];
  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v8 = 138543618;
    v9 = v6;
    v10 = 2112;
    v11 = v3;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Memory exception reporting completed with error: %@", &v8, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  mach_port_deallocate(*MEMORY[0x277D85F48], *(a1 + 40));

  v7 = *MEMORY[0x277D85DE8];
}

- (void)_handleAssistantSyncDataRequest:(id)a3
{
  v32 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  if ([(HMDHomeManager *)self isDataSyncInProgressWithMessage:v4])
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v31 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Data sync in progress - do not sync data to Siri servers", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    [v4 respondWithPayload:0];
  }

  else
  {
    v10 = [v4 clientIdentifier];
    if (v10)
    {
      v11 = v10;
    }

    else
    {
      v11 = @"com.apple.homeutil";
    }

    if (hasAssistantHashingKeyChanged())
    {
      v12 = 0;
    }

    else
    {
      v12 = [v4 stringForKey:*MEMORY[0x277CD26A8]];
    }

    objc_initWeak(buf, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke;
    aBlock[3] = &unk_279733910;
    aBlock[4] = self;
    objc_copyWeak(&v28, buf);
    v13 = v12;
    v26 = v13;
    v27 = v4;
    v14 = _Block_copy(aBlock);
    if (v13 || isWatch())
    {
      v14[2](v14);
    }

    else
    {
      v16 = [(HMDHomeManager *)self __generateAssistantTeamIdentifier];
      [(HMDHomeManager *)self _setAssistantSyncRequest:v11];
      v23 = 0u;
      v24 = 0u;
      v21 = 0u;
      v22 = 0u;
      v17 = [(HMDHomeManager *)self homes];
      v18 = [v17 countByEnumeratingWithState:&v21 objects:v29 count:16];
      if (v18)
      {
        v19 = *v22;
        do
        {
          v20 = 0;
          do
          {
            if (*v22 != v19)
            {
              objc_enumerationMutation(v17);
            }

            [*(*(&v21 + 1) + 8 * v20++) resetAccessoryHashedRouteIdentifiers];
          }

          while (v18 != v20);
          v18 = [v17 countByEnumeratingWithState:&v21 objects:v29 count:16];
        }

        while (v18);
      }

      [(HMDHomeManager *)self _generateAssistantSyncDataAndIncrementVersion:1 requestSync:0 urgent:0 completion:v14];
    }

    objc_destroyWeak(&v28);
    objc_destroyWeak(buf);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke(id *a1)
{
  v2 = [a1[4] gatherer];
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_2;
  v3[3] = &unk_2797353D0;
  objc_copyWeak(&v6, a1 + 7);
  v4 = a1[5];
  v5 = a1[6];
  [v2 getSyncEntityObjectsWithCompletionHandler:v3];

  objc_destroyWeak(&v6);
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_2(id *a1, void *a2)
{
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v5 = WeakRetained;
  if (WeakRetained)
  {
    v6 = [WeakRetained workQueue];
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_3;
    v7[3] = &unk_279734870;
    v7[4] = v5;
    v8 = a1[4];
    v9 = v3;
    v10 = a1[5];
    dispatch_async(v6, v7);
  }
}

void __61__HMDHomeManager_Assistant___handleAssistantSyncDataRequest___block_invoke_3(uint64_t a1)
{
  v31 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) assistantGenerationCounter];
  [*(a1 + 32) __setLastSyncedAssistantConfigurationVersion:v2];
  v3 = objc_autoreleasePoolPush();
  v4 = *(a1 + 32);
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = *(a1 + 40);
    v8 = [*(a1 + 32) _getAssistantHashingData];
    *buf = 138544130;
    v24 = v6;
    v25 = 2112;
    v26 = v7;
    v27 = 2048;
    v28 = v2;
    v29 = 2112;
    v30 = v8;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Siri sync validity %@, assistantConfigurationVersion %tu - assistant identifier %@", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v3);
  v9 = *(a1 + 48);
  v21 = @"kSiriSyncDataEntitiesKey";
  v22 = v9;
  v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v22 forKeys:&v21 count:1];
  [*(a1 + 56) respondWithPayload:v10];
  v11 = *(a1 + 40);
  if (v11)
  {
    v12 = [v11 componentsSeparatedByString:@":"];
    v13 = [v12 firstObject];
    v14 = v13;
    if (v13)
    {
      [v13 cStringUsingEncoding:4];
    }
  }

  if ([*(a1 + 32) siriSyncNotificationTime])
  {
    mach_absolute_time();
    UpTicksToMilliseconds();
    [*(a1 + 32) siriSyncNotificationTime];
  }

  [*(a1 + 32) _resetSiriSyncNotification];
  if ([*(a1 + 32) assistantIdentifierChanged])
  {
    [*(a1 + 32) setAssistantIdentifierChanged:0];
    v15 = *(a1 + 32);
    v16 = [v15 uuid];
    [v15 updateGenerationCounterWithReason:@"AssistantIdentifierChanged" sourceUUID:v16 shouldNotifyClients:1];
  }

  [*(a1 + 32) _signpostAssistantSyncDataRequestHandled];
  v17 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
  [v17 markSetupEndStage:8 error:0];

  v18 = +[HMDHelper sharedHelper];
  v19 = [v18 hashedRouteIDForIdentifier:@"A77C551E-C3FA-414E-ACD8-A7DF3D64E9D6"];

  CFPreferencesSetAppValue(@"HMDAssistantLastHashingKey", v19, *MEMORY[0x277CD0030]);
  v20 = *MEMORY[0x277D85DE8];
}

- (void)writeAssistantCurrentHome:(id)a3
{
  v27 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = MEMORY[0x277CBEBC0];
  v6 = [v4 urlString];
  v7 = [v5 URLWithString:v6];

  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v12 = [v4 name];
    v13 = [(HMDHomeManager *)v9 currentHomeUUID];
    v14 = [v13 UUIDString];
    v19 = 138544130;
    v20 = v11;
    v21 = 2112;
    v22 = v7;
    v23 = 2112;
    v24 = v12;
    v25 = 2112;
    v26 = v14;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Notifying assistant that current home updated to: %@ (%@/%@)", &v19, 0x2Au);
  }

  objc_autoreleasePoolPop(v8);
  v15 = *MEMORY[0x277CD20B8];
  v16 = [v7 absoluteString];
  v17 = *MEMORY[0x277CD0028];
  [(HMDHomeManager *)v9 _setHomeConfigurationKey:v15 value:v16 applicationIdentifier:*MEMORY[0x277CD0028]];
  -[HMDHomeManager _setHomeConfigurationKey:value:applicationIdentifier:](v9, "_setHomeConfigurationKey:value:applicationIdentifier:", *MEMORY[0x277CD20C0], [v4 name], v17);
  notify_post("com.apple.homed.current-home.changed");

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_resetSiriSyncNotification
{
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  [(HMDHomeManager *)self setSiriSyncNotificationTime:0];
}

- (void)_setAssistantSyncRequest:(id)a3
{
  v22 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v16 = 138543618;
    v17 = v9;
    v18 = 2112;
    v19 = v4;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Assistant sync data re-generation requested due to reason: %@", &v16, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if (![(HMDHomeManager *)v7 siriSyncNotificationTime])
  {
    mach_absolute_time();
    [(HMDHomeManager *)v7 setSiriSyncNotificationTime:UpTicksToMilliseconds()];
  }

  if (v4 && [v4 isEqual:@"SyncStateCompleted"])
  {
    v10 = objc_autoreleasePoolPush();
    v11 = v7;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [(HMDHomeManager *)v11 assistantGenerationCounter];
      v16 = 138543874;
      v17 = v13;
      v18 = 2112;
      v19 = v4;
      v20 = 2048;
      v21 = v14;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Posting an urgent sync notification after %@: %tu", &v16, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    [(HMDHomeManager *)v11 _generateAssistantSyncDataAndIncrementVersion:1 requestSync:1 urgent:1 completion:0];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)_assistantSyncDataChanged:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  [(HMDHomeManager *)self _setAssistantSyncRequest:v4];
  v6 = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];
  LOBYTE(v5) = [v6 isRunning];

  if ((v5 & 1) == 0)
  {
    v7 = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];
    [v7 resume];
  }
}

- (void)_generateAssistantSyncDataAndIncrementVersion:(BOOL)a3 requestSync:(BOOL)a4 urgent:(BOOL)a5 completion:(id)a6
{
  v8 = a3;
  v10 = a6;
  v11 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v11);

  if (v8)
  {
    [(HMDHomeManager *)self _incrementAssistantGenerationCounter];
  }

  v12 = [(HMDHomeManager *)self currentHomeUUID];
  v13 = [(HMDHomeManager *)self _homeWithUUID:v12];

  objc_initWeak(&location, self);
  v14 = [(HMDHomeManager *)self gatherer];
  v17[0] = MEMORY[0x277D85DD0];
  v17[1] = 3221225472;
  v17[2] = __105__HMDHomeManager_Assistant___generateAssistantSyncDataAndIncrementVersion_requestSync_urgent_completion___block_invoke;
  v17[3] = &unk_27972C220;
  objc_copyWeak(&v20, &location);
  v15 = v13;
  v18 = v15;
  v21 = a4;
  v22 = a5;
  v16 = v10;
  v19 = v16;
  [v14 gatherHomeKitObjectsWithCompletion:v17];

  objc_destroyWeak(&v20);
  objc_destroyWeak(&location);
}

void __105__HMDHomeManager_Assistant___generateAssistantSyncDataAndIncrementVersion_requestSync_urgent_completion___block_invoke(uint64_t a1, uint64_t a2)
{
  v21 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  [WeakRetained writeAssistantCurrentHome:*(a1 + 32)];
  [WeakRetained _setHomekitAssistantNumEntities:a2];
  if (*(a1 + 56) == 1)
  {
    v5 = [WeakRetained currentAccessorySetupMetricDispatcher];
    [v5 markSetupBeginStage:8 error:0];

    v6 = objc_autoreleasePoolPush();
    v7 = WeakRetained;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v9;
      v19 = 2048;
      v20 = [v7 assistantGenerationCounter];
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Generated sync data and posted sync data changed notification with siri generation counter: %tu", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    if (*(a1 + 57))
    {
      v10 = "com.apple.assistant.sync_homekit_urgent";
    }

    else
    {
      v10 = "com.apple.assistant.sync_homekit_now";
    }

    notify_post(v10);
    [v7 _signpostAssistantSyncDataNotification];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = WeakRetained;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2048;
      v20 = [v12 assistantGenerationCounter];
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Generated sync data with siri generation counter: %tu", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *(a1 + 40);
  if (v15)
  {
    (*(v15 + 16))();
  }

  [WeakRetained setPostSyncDataUpdatedNotification:1];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_incrementAssistantGenerationCounter
{
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  [(HMDHomeManager *)self setAssistantGenerationCounter:[(HMDHomeManager *)self assistantGenerationCounter]+ 1];
  v4 = [(HMDHomeManager *)self assistantGenerationCounter];

  [(HMDHomeManager *)self _setHomekitAssistantConfigurationVersion:v4];
}

- (void)__setLastSyncedAssistantConfigurationVersion:(unint64_t)a3
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedLong:a3];
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kLastSyncedAssistantConfigurationVersionKey" value:v4];
}

- (void)_setHomekitAssistantNumEntities:(unint64_t)a3
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:a3];

  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantConfigurationNumberOfEntitiesKey" value:v4];
}

- (void)_setHomekitAssistantConfigurationVersion:(unint64_t)a3
{
  v4 = [MEMORY[0x277CCABB0] numberWithUnsignedLong:a3];
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantConfigurationVersionKey" value:v4];
}

- (void)_saveAssistantHashingData:(id)a3
{
  v4 = *MEMORY[0x277CD0028];
  v5 = a3;
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kAssistantTeamIdentifier" value:v5 applicationIdentifier:v4];
  [(HMDHomeManager *)self _setAssistantHashingData:v5];
}

- (id)_getAssistantHashingData
{
  v3 = CFPreferencesCopyAppValue(@"kAssistantTeamIdentifier", *MEMORY[0x277CD0028]);
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  if (v5)
  {
    v6 = v5;
    v7 = v3;
  }

  else
  {
    v7 = [(HMDHomeManager *)self __generateAssistantTeamIdentifier];
  }

  return v7;
}

- (id)__generateAssistantTeamIdentifier
{
  v3 = [MEMORY[0x277CCAD78] UUID];
  v4 = [v3 hm_convertToData];

  [(HMDHomeManager *)self _saveAssistantHashingData:v4];
  [(HMDHomeManager *)self setAssistantIdentifierChanged:1];

  return v4;
}

- (id)multiUserSettingsForMultiUserSettingsMetricsEventDispatcherDataSource
{
  v35 = *MEMORY[0x277D85DE8];
  [(HMDHomeManager *)self homes];
  v30 = 0u;
  v31 = 0u;
  v32 = 0u;
  obj = v33 = 0u;
  v26 = [obj countByEnumeratingWithState:&v30 objects:v34 count:16];
  if (v26)
  {
    v28 = 0;
    v29 = 0;
    v27 = 0;
    v2 = 0;
    v3 = 0;
    v4 = 0;
    v5 = 0;
    v6 = 0;
    v7 = 0;
    v8 = 0;
    v25 = *v31;
    do
    {
      for (i = 0; i != v26; ++i)
      {
        if (*v31 != v25)
        {
          objc_enumerationMutation(obj);
        }

        v10 = [*(*(&v30 + 1) + 8 * i) multiUserSettings];
        v11 = [v10 numSharedUsers];
        v8 += [v11 unsignedIntValue];

        v12 = [v10 numUsersWithSettings];
        v7 += [v12 unsignedIntValue];

        v13 = [v10 numUsersWithIdentifyVoiceOff];
        v6 += [v13 unsignedIntValue];

        v14 = [v10 numUsersWithPlayBackInfluencesForYouOff];
        v5 += [v14 unsignedIntValue];

        v15 = [v10 numUsersCloudShareTrustNotConfigured];
        v29 += [v15 unsignedIntValue];

        v16 = [v10 numUsersSharedBackingStoreNotStarted];
        v28 += [v16 unsignedIntValue];

        v17 = [v10 numUsersSharedBackingStoreRunning];
        v27 += [v17 unsignedIntValue];

        v18 = [v10 numUsersSharedBackingStoreNotRunningDueToError];
        v2 += [v18 unsignedIntValue];

        v19 = [v10 numUsersSharedBackingStoreNotRunningDueToStopped];
        v3 += [v19 unsignedIntValue];

        v20 = [v10 numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation];
        v4 += [v20 unsignedIntValue];
      }

      v26 = [obj countByEnumeratingWithState:&v30 objects:v34 count:16];
    }

    while (v26);
  }

  else
  {
    v28 = 0;
    v29 = 0;
    v27 = 0;
    v2 = 0;
    v3 = 0;
    v4 = 0;
    v5 = 0;
    v6 = 0;
    v7 = 0;
    v8 = 0;
  }

  v21 = [objc_alloc(MEMORY[0x277CD1C20]) initWithNumSharedUsers:v8 numUsersWithSettings:v7 numUsersWithIdentifyVoiceOff:v6 numUsersWithPlayBackInfluencesForYouOff:v5 numUsersCloudShareTrustNotConfigured:v29 numUsersSharedBackingStoreNotStarted:v28 numUsersSharedBackingStoreRunning:v27 numUsersSharedBackingStoreNotRunningDueToError:v2 numUsersSharedBackingStoreNotRunningDueToStopped:v3 numUsersSharedBackingStoreSharedZoneWaitingForShareInvitation:v4];

  v22 = *MEMORY[0x277D85DE8];

  return v21;
}

- (void)checkAndProcessHH2UpgradeRecommendation
{
  [(HMDHomeManager *)self _scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded];
  if (self)
  {
    v3 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __93__HMDHomeManager_HH2UpgradeRecommendation___postHH2UpgradeRecommendationFollowUpItemIfNeeded__block_invoke;
    block[3] = &unk_279735D00;
    block[4] = self;
    dispatch_async(v3, block);
  }
}

- (void)_scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded
{
  if (a1)
  {
    v2 = [a1 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __103__HMDHomeManager_HH2UpgradeRecommendation___scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded__block_invoke;
    block[3] = &unk_279735D00;
    block[4] = a1;
    dispatch_async(v2, block);
  }
}

void __93__HMDHomeManager_HH2UpgradeRecommendation___postHH2UpgradeRecommendationFollowUpItemIfNeeded__block_invoke(uint64_t a1)
{
  if ([*(a1 + 32) needHH2UpgradeRecommendation])
  {
    v2 = [*(a1 + 32) isHH1EOLEnabled];
    v4 = +[HMDDeviceSetupManager sharedManager];
    v3 = [v4 followUpManager];
    [v3 startAdvertisingHH2UpgradeRecommendationCFU:v2];
  }

  else
  {
    v4 = +[HMDDeviceSetupManager sharedManager];
    v3 = [v4 followUpManager];
    [v3 stopAdvertisingHH2UpgradeRecommendationCFU];
  }
}

void __103__HMDHomeManager_HH2UpgradeRecommendation___scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded__block_invoke(uint64_t a1)
{
  v70 = *MEMORY[0x277D85DE8];
  if ([*(a1 + 32) needHH2UpgradeRecommendation])
  {
    v2 = [*(a1 + 32) homes];
    v3 = [v2 na_any:&__block_literal_global_148678];

    if (v3)
    {
      v4 = [*(a1 + 32) userDefaults];
      v5 = [v4 objectForKey:@"HMDHH2UpgradeRecomendedVersion"];

      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v6 = v5;
      }

      else
      {
        v6 = 0;
      }

      v7 = v6;

      if (v7)
      {
        v8 = [objc_alloc(MEMORY[0x277D0F8F8]) initWithString:v7];
        v9 = [MEMORY[0x277D0F8E8] productInfo];
        v10 = [v9 softwareVersion];

        v11 = [v10 majorVersion];
        v12 = 0;
        if (v11 <= [v8 majorVersion])
        {
          v17 = [v10 majorVersion];
          if (v17 != [v8 majorVersion] || (v18 = objc_msgSend(v10, "minorVersion"), v18 <= objc_msgSend(v8, "minorVersion")))
          {
            v12 = 1;
          }
        }
      }

      else
      {
        v12 = 0;
      }

      v19 = *(a1 + 32);
      v20 = 0x277CBE000uLL;
      if (v19)
      {
        v21 = [*(a1 + 32) idsServerBag];
        v22 = [v21 hh2UpgradeRecommendationRepostInterval];

        if (!v22)
        {
          goto LABEL_26;
        }

        v23 = [v22 integerValue];
        v24 = [v19 userDefaults];
        v25 = [v24 objectForKey:@"HMDHH2UpgradeRecomendedDate"];

        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v26 = v25;
        }

        else
        {
          v26 = 0;
        }

        v27 = v26;

        v28 = objc_autoreleasePoolPush();
        v29 = v19;
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
        {
          v31 = HMFGetLogIdentifier();
          *buf = 138543618;
          v67 = v31;
          v68 = 2112;
          v69 = v27;
          _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@HH2UpgradeRecommendation: Last posted on %@", buf, 0x16u);

          v20 = 0x277CBE000;
        }

        objc_autoreleasePoolPop(v28);
        if (v27)
        {
          v32 = [MEMORY[0x277CBEA80] currentCalendar];
          v33 = [v32 dateByAddingUnit:16 value:v23 toDate:v27 options:0];
        }

        else
        {
LABEL_26:
          v33 = 0;
        }
      }

      else
      {
        v33 = 0;
      }

      if (v33)
      {
        v34 = 0;
      }

      else
      {
        v34 = v12;
      }

      if (!v34)
      {
        v35 = [*(v20 + 2728) now];
        v65 = v35;
        if (v12)
        {
          v36 = v33;
        }

        else
        {
          v36 = v35;
        }

        v37 = v36;
        v38 = v20;
        v63 = v37;
        if (*(a1 + 32))
        {
          v39 = MEMORY[0x277CBEAB8];
          v40 = v37;
          v41 = objc_alloc_init(v39);
          [v41 setHour:{14, v63, v65}];
          [v41 setMinute:0];
          v42 = [MEMORY[0x277CBEA80] currentCalendar];
          v43 = [*(v38 + 2728) now];
          v44 = [v43 laterDate:v40];

          v45 = [v42 nextDateAfterDate:v44 matchingComponents:v41 options:1024];
        }

        else
        {
          v45 = 0;
        }

        v46 = [*(v38 + 2728) now];
        [v45 timeIntervalSinceDate:v46];
        v48 = v47;

        v49 = objc_autoreleasePoolPush();
        v50 = *(a1 + 32);
        v51 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
        {
          v52 = HMFGetLogIdentifier();
          *buf = 138543618;
          v67 = v52;
          v68 = 2112;
          v69 = v45;
          _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_INFO, "%{public}@HH2UpgradeRecommendation: Scheduling to post at %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v49);
        v53 = *(a1 + 32);
        if (v53)
        {
          v54 = [*(a1 + 32) homeUpgradeRecommendationTimer];

          if (v54)
          {
            v55 = [v53 homeUpgradeRecommendationTimer];
            [v55 cancel];

            [v53 setHomeUpgradeRecommendationTimer:0];
          }

          v56 = *(a1 + 32);
          if (v56)
          {
            v57 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:1 options:v48];
            [v56 setHomeUpgradeRecommendationTimer:v57];

            v58 = [v56 homeUpgradeRecommendationTimer];
            [v58 setDelegate:v56];

            v59 = [v56 homeUpgradeRecommendationTimer];
            v60 = [v56 workQueue];
            [v59 setDelegateQueue:v60];

            v61 = [v56 homeUpgradeRecommendationTimer];
            [v61 resume];
          }
        }
      }
    }

    else
    {
      v13 = objc_autoreleasePoolPush();
      v14 = *(a1 + 32);
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543362;
        v67 = v16;
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@No reachable accessories do not schedule Home update recommendation.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v13);
    }
  }

  v62 = *MEMORY[0x277D85DE8];
}

- (void)postHH2UpgradeRecommendationBulletin
{
  if ([(HMDHomeManager *)self isHH1EOLEnabled])
  {
    v3 = 2;
  }

  else
  {
    v3 = 0;
  }

  v4 = +[HMDBulletinBoard sharedBulletinBoard];
  [v4 insertHH2UpgradeRecommendationBulletin:v3];

  v5 = [(HMDHomeManager *)self userDefaults];
  v6 = [MEMORY[0x277D0F8E8] productInfo];
  v7 = [v6 softwareVersion];
  v8 = [v7 versionString];
  [v5 setObject:v8 forKey:@"HMDHH2UpgradeRecomendedVersion"];

  v9 = [(HMDHomeManager *)self userDefaults];
  v10 = [MEMORY[0x277CBEAA8] now];
  [v9 setObject:v10 forKey:@"HMDHH2UpgradeRecomendedDate"];

  [(HMDHomeManager *)self _scheduleToPostNextHH2UpgradeRecommendationBulletinIfNeeded];
}

- (void)_handleXPCConnectionNotification:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __77__HMDHomeManager_HH2UpgradeRecommendation___handleXPCConnectionNotification___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __77__HMDHomeManager_HH2UpgradeRecommendation___handleXPCConnectionNotification___block_invoke(uint64_t a1)
{
  v29 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 objectForKeyedSubscript:@"connection"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  if (v5)
  {
    v6 = [v5 processInfo];
    v7 = [v6 applicationInfo];

    if (v7)
    {
      v8 = [v7 bundleIdentifier];
      v9 = [v8 hasPrefix:@"com.apple"];

      if ((v9 & 1) == 0)
      {
        v10 = objc_autoreleasePoolPush();
        v11 = *(a1 + 40);
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
        {
          v13 = HMFGetLogIdentifier();
          v14 = [v7 bundleIdentifier];
          *buf = 138543618;
          v26 = v13;
          v27 = 2112;
          v28 = v14;
          _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Pop up Home update required dialogue for app: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v10);
        v15 = +[HMDUIDialogPresenter sharedUIDialogPresenter];
        v16 = *(a1 + 40);
        v17 = [v16 workQueue];
        v24[0] = MEMORY[0x277D85DD0];
        v24[1] = 3221225472;
        v24[2] = __77__HMDHomeManager_HH2UpgradeRecommendation___handleXPCConnectionNotification___block_invoke_27;
        v24[3] = &unk_279734468;
        v24[4] = *(a1 + 40);
        [v15 requestHomeUpdateRequiredDialogueWithContext:v16 queue:v17 completionHandler:v24];
      }
    }
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = *(a1 + 40);
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      v22 = *(a1 + 32);
      *buf = 138543618;
      v26 = v21;
      v27 = 2112;
      v28 = v22;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Received connection did start notification, but no connection object was found: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
  }

  v23 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager_HH2UpgradeRecommendation___handleXPCConnectionNotification___block_invoke_27(uint64_t a1, int a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_INFO);
  if (a2)
  {
    if (v7)
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543618;
      v12 = v8;
      v13 = 2112;
      v14 = @"com.apple.Home-private://homeHubUpdate";
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Going to launch Home update URL: %@", &v11, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    launchURL(@"com.apple.Home-private://homeHubUpdate");
  }

  else
  {
    if (v7)
    {
      v9 = HMFGetLogIdentifier();
      v11 = 138543362;
      v12 = v9;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@User did not choose to launch Home app", &v11, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)registerForXPCClientConnectionMessages
{
  if ([(HMDHomeManager *)self isHH1EOLEnabled])
  {
    v3 = [(HMDHomeManager *)self notificationCenter];
    [v3 addObserver:self selector:sel__handleXPCConnectionNotification_ name:@"HMDXPCClientConnectionDidStartNotification" object:0];
  }
}

- (BOOL)needHH2UpgradeRecommendation
{
  v17 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CC1E80] defaultWorkspace];
  v4 = [v3 applicationIsInstalled:*MEMORY[0x277CCFE40]];

  if (v4)
  {
    v14 = 0u;
    v15 = 0u;
    v12 = 0u;
    v13 = 0u;
    v5 = [(HMDHomeManager *)self homes];
    v6 = [v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
    if (v6)
    {
      v7 = *v13;
      while (2)
      {
        for (i = 0; i != v6; ++i)
        {
          if (*v13 != v7)
          {
            objc_enumerationMutation(v5);
          }

          v9 = *(*(&v12 + 1) + 8 * i);
          if ([v9 isOwnerUser] && (objc_msgSend(v9, "isUpdatedToHH2") & 1) == 0 && !HMDIsEmptyHome(v9))
          {
            LOBYTE(v6) = 1;
            goto LABEL_15;
          }
        }

        v6 = [v5 countByEnumeratingWithState:&v12 objects:v16 count:16];
        if (v6)
        {
          continue;
        }

        break;
      }
    }

LABEL_15:
  }

  else
  {
    LOBYTE(v6) = 0;
  }

  v10 = *MEMORY[0x277D85DE8];
  return v6;
}

- (void)resetTTSUHH2SettingsMigrationKey
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Going to delete the TTSU HH2 settings migration key", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [(HMDHomeManager *)v4 userDefaults];
  [v7 removeObjectForKey:@"mi.hh2"];

  v8 = *MEMORY[0x277D85DE8];
}

- (id)createCloudDatabaseAndPerformInitialSync:(id)a3
{
  v50 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v45 = v8;
    v46 = 2112;
    v47 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Creating cloud database from container : [%@]", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = objc_alloc(MEMORY[0x277CBC220]);
  v10 = [v9 initWithContainerIdentifier:@"com.apple.willow.config" environment:cloudKitContainerEnvironment];
  v11 = [objc_alloc(MEMORY[0x277D17050]) initWithContainerID:v10];
  v12 = objc_alloc(MEMORY[0x277D17048]);
  v13 = +[HMDDatabase defaultDatabase];
  v14 = [v13 localDatabase];
  v43 = 0;
  v15 = [v12 initWithLocalDatabase:v14 configuration:v11 error:&v43];
  v16 = v43;

  v17 = objc_autoreleasePoolPush();
  v18 = v6;
  v19 = HMFGetOSLogHandle();
  v20 = v19;
  if (v15)
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543618;
      v45 = v21;
      v46 = 2112;
      v47 = v15;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Going to performInitialCloudSync for %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v22 = dispatch_group_create();
    dispatch_group_enter(v22);
    v23 = [v15 performInitialCloudSync];
    v40[0] = MEMORY[0x277D85DD0];
    v40[1] = 3221225472;
    v40[2] = __72__HMDHomeManager_ResetConfig__createCloudDatabaseAndPerformInitialSync___block_invoke;
    v40[3] = &unk_279733A98;
    v40[4] = v18;
    v24 = v15;
    v41 = v24;
    v25 = v22;
    v42 = v25;
    v26 = [v23 addCompletionBlock:v40];
    v27 = dispatch_time(0, 30000000000);
    if (dispatch_group_wait(v25, v27))
    {
      v39 = v11;
      v28 = v10;
      v29 = v16;
      v30 = objc_autoreleasePoolPush();
      v31 = v18;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v33 = v38 = v4;
        *buf = 138543618;
        v45 = v33;
        v46 = 2112;
        v47 = v24;
        _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Timed out while waiting to perform initial sync on %@", buf, 0x16u);

        v4 = v38;
      }

      objc_autoreleasePoolPop(v30);
      v16 = v29;
      v10 = v28;
      v11 = v39;
    }

    v34 = v24;
  }

  else
  {
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v35 = HMFGetLogIdentifier();
      *buf = 138543874;
      v45 = v35;
      v46 = 2112;
      v47 = v4;
      v48 = 2112;
      v49 = v16;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Failed to create cloud database with containerID %@: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
  }

  v36 = *MEMORY[0x277D85DE8];

  return v15;
}

void __72__HMDHomeManager_ResetConfig__createCloudDatabaseAndPerformInitialSync___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    v13 = 138543874;
    v14 = v10;
    v15 = 2112;
    v16 = v11;
    v17 = 2112;
    v18 = v6;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Initial cloud sync finished on %@ with error: %@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 48));

  v12 = *MEMORY[0x277D85DE8];
}

- (id)deleteLocalZone:(id)a3 localDatabase:(id)a4 containerID:(id)a5
{
  v32 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = objc_autoreleasePoolPush();
  v12 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v14;
    v28 = 2112;
    v29 = v8;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Going to open local zone [%@] and delete it", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v11);
  v15 = objc_alloc_init(MEMORY[0x277D170F8]);
  [v15 setCreateIfNeeded:0];
  v25 = 0;
  v16 = [v9 openZoneWithZoneID:v8 configuration:v15 error:&v25];
  v17 = v25;
  if (v16)
  {
    v18 = [v9 removeZone:v16];
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = v12;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543874;
      v27 = v22;
      v28 = 2112;
      v29 = v8;
      v30 = 2112;
      v31 = v17;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Failed to open local zone with zoneID %@: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v19);
    v18 = 0;
  }

  v23 = *MEMORY[0x277D85DE8];

  return v18;
}

- (void)deleteAllZonesFromContainer:(id)a3
{
  v58 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v53 = v8;
    v54 = 2112;
    v55 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Asked to delete all the zones from container : [%@]", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 createCloudDatabaseAndPerformInitialSync:v4];
  v10 = objc_autoreleasePoolPush();
  v11 = v6;
  v12 = HMFGetOSLogHandle();
  v13 = v12;
  if (v9)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v15 = MEMORY[0x277CCABB0];
      v16 = [v9 privateZoneIDs];
      v17 = [v15 numberWithUnsignedInteger:{objc_msgSend(v16, "count")}];
      *buf = 138543874;
      v53 = v14;
      v54 = 2112;
      v55 = v4;
      v56 = 2112;
      v57 = v17;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] There are %@ zones", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    v18 = [MEMORY[0x277CBEB18] array];
    v19 = [v9 privateZoneIDs];
    v49[0] = MEMORY[0x277D85DD0];
    v49[1] = 3221225472;
    v49[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke;
    v49[3] = &unk_279730B00;
    v49[4] = v11;
    v20 = v9;
    v50 = v20;
    v21 = v18;
    v51 = v21;
    [v19 hmf_enumerateWithAutoreleasePoolUsingBlock:v49];

    v22 = [v20 localDatabase];
    v23 = [v22 fetchZonesWithError:0];

    if ([v23 count])
    {
      v24 = dispatch_group_create();
      dispatch_group_enter(v24);
      v45[0] = MEMORY[0x277D85DD0];
      v45[1] = 3221225472;
      v45[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_183;
      v45[3] = &unk_279730B28;
      v45[4] = v11;
      v46 = v20;
      v25 = v4;
      v47 = v25;
      v26 = v21;
      v48 = v26;
      [v23 hmf_enumerateWithAutoreleasePoolUsingBlock:v45];
      v27 = MEMORY[0x277D2C900];
      v28 = [MEMORY[0x277D2C938] immediateScheduler];
      v29 = [v27 combineAllFutures:v26 ignoringErrors:1 scheduler:v28];
      v43[0] = MEMORY[0x277D85DD0];
      v43[1] = 3221225472;
      v43[2] = __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_2;
      v43[3] = &unk_279734D18;
      v43[4] = v11;
      v30 = v24;
      v44 = v30;
      v31 = [v29 addCompletionBlock:v43];

      v32 = objc_autoreleasePoolPush();
      v33 = v11;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543618;
        v53 = v35;
        v54 = 2112;
        v55 = v25;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Finished deleting zones for container : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v32);
      dispatch_group_wait(v30, 0xFFFFFFFFFFFFFFFFLL);
    }

    else
    {
      v37 = objc_autoreleasePoolPush();
      v38 = v11;
      v39 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
      {
        v40 = HMFGetLogIdentifier();
        v41 = [v20 containerID];
        *buf = 138543618;
        v53 = v40;
        v54 = 2112;
        v55 = v41;
        _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] No local zones to delete", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v37);
    }
  }

  else
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v36 = HMFGetLogIdentifier();
      *buf = 138543618;
      v53 = v36;
      v54 = 2112;
      v55 = v4;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Unable to create cloud database for container : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
  }

  v42 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke(id *a1, void *a2)
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = a1[4];
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = [a1[5] containerID];
    v9 = [v3 name];
    v12 = 138543874;
    v13 = v7;
    v14 = 2112;
    v15 = v8;
    v16 = 2112;
    v17 = v9;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : [%@] Going to delete [%@]", &v12, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  v10 = [a1[5] removePrivateZoneWithID:v3];
  [a1[6] addObject:v10];

  v11 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_183(uint64_t a1, void *a2)
{
  v3 = *(a1 + 32);
  v4 = *(a1 + 40);
  v5 = a2;
  v6 = [v4 localDatabase];
  v8 = [v3 deleteLocalZone:v5 localDatabase:v6 containerID:*(a1 + 48)];

  v7 = v8;
  if (v8)
  {
    [*(a1 + 56) addObject:v8];
    v7 = v8;
  }
}

void __59__HMDHomeManager_ResetConfig__deleteAllZonesFromContainer___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v16 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v12 = 138543618;
    v13 = v10;
    v14 = 2112;
    v15 = v6;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : >> Deleting cloud & local zones finished with error: %@", &v12, 0x16u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 40));

  v11 = *MEMORY[0x277D85DE8];
}

- (void)deleteZonesFromLegacyAndCameraContainers
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v11 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Asked to delete all zones from legacy & camera containers", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [objc_opt_class() getContainersToCleanUp];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __71__HMDHomeManager_ResetConfig__deleteZonesFromLegacyAndCameraContainers__block_invoke;
  v9[3] = &unk_279730AD8;
  v9[4] = v4;
  [v7 hmf_enumerateWithAutoreleasePoolUsingBlock:v9];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalMetadata
{
  v2 = [(HMDHomeManager *)self mobileAssetManager];
  [v2 purgeAllInstalledAssets];

  +[HMDHAPMetadata updateLocalMetadataWithBuiltinMetadata];
}

- (void)_eraseLocalHomeConfigurationAndDeleteMetadata:(BOOL)a3 reason:(unint64_t)a4 completionQueue:(id)a5 completion:(id)a6
{
  v30 = *MEMORY[0x277D85DE8];
  v9 = a5;
  v10 = a6;
  v11 = objc_autoreleasePoolPush();
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v13;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Resetting local configuration, users and keys for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v11);
  v14 = dispatch_group_create();
  dispatch_group_enter(v14);
  objc_initWeak(buf, self);
  v15 = [(HMDHomeManager *)self syncManager];
  v25[0] = MEMORY[0x277D85DD0];
  v25[1] = 3221225472;
  v25[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke;
  v25[3] = &unk_279732E78;
  objc_copyWeak(&v27, buf);
  v16 = v14;
  v26 = v16;
  [v15 pauseAndWaitForCurrentOperationCompletion:v25];

  v17 = [(HMDHomeManager *)self workQueue];
  v21[0] = MEMORY[0x277D85DD0];
  v21[1] = 3221225472;
  v21[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_174;
  v21[3] = &unk_279730AB0;
  objc_copyWeak(v24, buf);
  v24[1] = a4;
  v22 = v9;
  v23 = v10;
  v18 = v9;
  v19 = v10;
  dispatch_group_notify(v16, v17, v21);

  objc_destroyWeak(v24);
  objc_destroyWeak(&v27);
  objc_destroyWeak(buf);

  v20 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = +[HMDUserManagementOperationManager sharedManager];
    [v3 cancelAllOperations];

    v20 = 0u;
    v21 = 0u;
    v18 = 0u;
    v19 = 0u;
    obj = [WeakRetained homes];
    v4 = [obj countByEnumeratingWithState:&v18 objects:v22 count:16];
    if (v4)
    {
      v5 = v4;
      v6 = *v19;
      do
      {
        v7 = 0;
        do
        {
          if (*v19 != v6)
          {
            objc_enumerationMutation(obj);
          }

          v8 = *(*(&v18 + 1) + 8 * v7);
          dispatch_group_enter(*(a1 + 32));
          v9 = [v8 name];
          v10 = MEMORY[0x277D0F818];
          v15[0] = MEMORY[0x277D85DD0];
          v15[1] = 3221225472;
          v15[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_2;
          v15[3] = &unk_279730A88;
          v15[4] = WeakRetained;
          v16 = v9;
          v17 = *(a1 + 32);
          v11 = v9;
          v12 = [v10 messageWithName:@"kResetConfigRequestKey" messagePayload:0 responseHandler:v15];
          [WeakRetained _removeHome:v8 withMessage:v12 saveToStore:0 notifyUsers:0 shouldRemovePairings:1];

          ++v7;
        }

        while (v5 != v7);
        v5 = [obj countByEnumeratingWithState:&v18 objects:v22 count:16];
      }

      while (v5);
    }

    [WeakRetained setHomeManagerZoneFirstFetch:1];
    dispatch_group_leave(*(a1 + 32));
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_174(uint64_t a1)
{
  v36 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained setPrimaryHomeUUID:0];
    [v3 _updateCurrentHomeIfNecessary];
    v4 = [MEMORY[0x277CFEC78] systemStore];
    v5 = [v4 removeControllerKeyPairWithError:0];
    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    v8 = v7;
    if (v5)
    {
      if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
      {
        v9 = HMFGetLogIdentifier();
        *buf = 138543362;
        v33 = v9;
        _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Removed controller key", buf, 0xCu);
      }
    }

    else if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v33 = v10;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : Failed removing controller key", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    [v3 _eraseLocalHomeConfigurationWithReason:*(a1 + 56)];
    v11 = +[HMDBackingStore resetBackingStore];
    if (v11)
    {
      v12 = objc_autoreleasePoolPush();
      v13 = v3;
      v14 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
      {
        v15 = HMFGetLogIdentifier();
        *buf = 138543618;
        v33 = v15;
        v34 = 2112;
        v35 = v11;
        _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : resetBackingStore completed with error: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v12);
    }

    v16 = objc_autoreleasePoolPush();
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543362;
      v33 = v18;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Completed configuration reset", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v19 = [v3 cloudDataSyncManager];

    if (v19)
    {
      v20 = [v3 cloudDataSyncManager];
      v28[0] = MEMORY[0x277D85DD0];
      v28[1] = 3221225472;
      v28[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_175;
      v28[3] = &unk_2797346E0;
      objc_copyWeak(&v31, (a1 + 48));
      v30 = *(a1 + 40);
      v29 = *(a1 + 32);
      [v20 resetCloudCache:v28];

      objc_destroyWeak(&v31);
    }

    else
    {
      v22 = [v3 syncManager];
      [v22 cancelOperations];

      v23 = [v3 syncManager];
      [v23 resume];

      v24 = *(a1 + 40);
      if (v24)
      {
        v25 = *(a1 + 32);
        if (v25)
        {
          v26[0] = MEMORY[0x277D85DD0];
          v26[1] = 3221225472;
          v26[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_3;
          v26[3] = &unk_2797348C0;
          v27 = v24;
          dispatch_async(v25, v26);
        }
      }
    }
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_175(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    v4 = [WeakRetained syncManager];
    [v4 cancelOperations];

    v5 = [v3 syncManager];
    [v5 resume];
  }

  v6 = *(a1 + 40);
  if (v6)
  {
    v7 = *(a1 + 32);
    if (v7)
    {
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_2_176;
      block[3] = &unk_2797348C0;
      v9 = v6;
      dispatch_async(v7, block);
    }
  }
}

void __111__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAndDeleteMetadata_reason_completionQueue_completion___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = *(a1 + 32);
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    v13 = 138543874;
    v14 = v10;
    v15 = 2112;
    v16 = v11;
    v17 = 2112;
    v18 = v5;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Removed home %@ - error %@", &v13, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  dispatch_group_leave(*(a1 + 48));

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfigurationAfterSignOut
{
  v27 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v24 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Erase local data on this device since we signed out of iCloud", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [HMDPersistentStore resetConfiguration:2];
  [(HMDHomeManager *)v4 resetTTSUHH2SettingsMigrationKey];
  v7 = +[HMDUserManagementOperationManager sharedManager];
  [v7 cancelAllOperations];

  [(HMDHomeManager *)v4 removeAllHomeKitPairingIdentitiesAfterSignOut];
  [(HMDHomeManager *)v4 _eraseLocalHomeConfiguration];
  [(HMDHomeManager *)v4 _eraseLocalMetadata];
  v8 = +[HMDBackingStore resetBackingStore];
  if (v8)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = v4;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v24 = v12;
      v25 = 2112;
      v26 = v8;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@[Reset Config] : resetBackingStore completed with error: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = [(HMDHomeManager *)v4 cloudDataSyncManager];

  if (v13)
  {
    objc_initWeak(buf, v4);
    v14 = [(HMDHomeManager *)v4 cloudDataSyncManager];
    v21[0] = MEMORY[0x277D85DD0];
    v21[1] = 3221225472;
    v21[2] = __71__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAfterSignOut__block_invoke;
    v21[3] = &unk_279734708;
    objc_copyWeak(&v22, buf);
    [v14 resetCloudCache:v21];

    objc_destroyWeak(&v22);
    objc_destroyWeak(buf);
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = v4;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEFAULT))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543362;
      v24 = v18;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Posting notification kCloudServerTokenDataResetNotification to clear server token data on the cloud data sync manager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
    v19 = [MEMORY[0x277CCAB98] defaultCenter];
    [v19 postNotificationName:@"kCloudServerTokenDataResetNotification" object:v16];
  }

  [objc_opt_class() relaunchHomedDueToResetConfigurationWithDelay:2.0];

  v20 = *MEMORY[0x277D85DE8];
}

void __71__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationAfterSignOut__block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543362;
      v12 = v8;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@[Reset Config] : Posting notification kCloudServerTokenDataResetNotification to clear server token data on the cloud data sync manager", &v11, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    v9 = [MEMORY[0x277CCAB98] defaultCenter];
    [v9 postNotificationName:@"kCloudServerTokenDataResetNotification" object:v6];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfiguration
{
  v32 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v31 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Resetting local configuration and accessory keys for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v27 = 0u;
  v28 = 0u;
  v25 = 0u;
  v26 = 0u;
  v6 = [(HMDHomeManager *)self homes];
  v7 = [v6 countByEnumeratingWithState:&v25 objects:v29 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v26;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v26 != v9)
        {
          objc_enumerationMutation(v6);
        }

        v11 = *(*(&v25 + 1) + 8 * i);
        v12 = [v11 name];
        v13 = [(HMDHomeManager *)self uuid];
        v14 = [(HMDHomeManager *)self removeName:v12 namespace:v13];

        v15 = [(HMDHomeManager *)self nameValidator];
        v16 = [v11 uuid];
        v17 = [v15 removeNamespace:v16];

        v18 = [v11 uuid];
        [(HMDHomeManager *)self _removeConfigurationVersionForHome:v18];
      }

      v8 = [v6 countByEnumeratingWithState:&v25 objects:v29 count:16];
    }

    while (v8);
  }

  [(HMDHomeManager *)self setPrimaryHomeUUID:0];
  [(HMDHomeManager *)self setRecoveryVersion:0];
  [(HMDHomeManager *)self _updateCurrentHomeIfNecessary];
  v19 = [(HMDHomeManager *)self backingStore];
  v20 = [v19 lookup];
  [v20 resetObjects];

  [(HMDHomeManager *)self _eraseLocalHomeConfigurationWithReason:1];
  v21 = objc_autoreleasePoolPush();
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
  {
    v23 = HMFGetLogIdentifier();
    *buf = 138543362;
    v31 = v23;
    _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Completed erasing local home configuration", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v21);
  v24 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeConfigurationWithReason:(unint64_t)a3
{
  v71 = *MEMORY[0x277D85DE8];
  +[HMDHomeManager _eraseAllAccessoryKeysAndIdentifiers];
  v53 = self;
  v4 = [(HMDHomeManager *)self keyTransferAgent];
  [v4 resetConfig];

  v5 = [(HMDHomeManager *)v53 messageDispatcher];
  [v5 reset];

  v6 = [(HMDHomeManager *)v53 identityRegistry];
  [v6 reset];

  v7 = [(HMDHomeManager *)v53 accountRegistry];
  [v7 reset];

  v52 = [MEMORY[0x277CFEC78] systemStore];
  v66 = 0;
  [v52 updateCurrentiCloudIdentifier:0 controllerPairingIdentifier:0 error:&v66];
  v50 = v66;
  v8 = MEMORY[0x277CBEB18];
  v9 = [(HMDHomeManager *)v53 homes];
  v54 = [v8 arrayWithCapacity:{objc_msgSend(v9, "count")}];

  v64 = 0u;
  v65 = 0u;
  v62 = 0u;
  v63 = 0u;
  v10 = [(HMDHomeManager *)v53 homes];
  v11 = [v10 countByEnumeratingWithState:&v62 objects:v70 count:16];
  if (v11)
  {
    v12 = *v63;
    v13 = MEMORY[0x277D85DD0];
    do
    {
      v14 = 0;
      do
      {
        if (*v63 != v12)
        {
          objc_enumerationMutation(v10);
        }

        v15 = *(*(&v62 + 1) + 8 * v14);
        *buf = 0;
        v16 = [MEMORY[0x277D0F7C0] futureWithPromise:buf];
        v60[0] = v13;
        v60[1] = 3221225472;
        v60[2] = __70__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationWithReason___block_invoke;
        v60[3] = &unk_279735D00;
        v61 = *buf;
        [v15 stopThreadNetworkWithCompletion:1 completion:v60];
        [v54 addObject:v16];
        [v15 resetConfiguration];

        ++v14;
      }

      while (v11 != v14);
      v11 = [v10 countByEnumeratingWithState:&v62 objects:v70 count:16];
    }

    while (v11);
  }

  [(HMDHomeManager *)v53 setHomes:MEMORY[0x277CBEBF8]];
  v17 = [(HMDHomeManager *)v53 cloudDataSyncStateFilter];
  v18 = [(HMDHomeManager *)v53 homes];
  [v17 updateTotalHomes:{objc_msgSend(v18, "count")}];

  v19 = [(HMDHomeManager *)v53 accessoryBrowserInternal];
  [v19 resetConfiguration];

  v20 = objc_autoreleasePoolPush();
  v21 = v53;
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v23;
    v68 = 2048;
    v69 = a3;
    _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@_eraseLocalHomeConfigurationWithReason: ==== reason is... %lu", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v20);
  [HMDPersistentStore resetConfiguration:a3];
  v24 = [(HMDHomeManager *)v21 lastEventStore];
  [v24 resetEventStore];

  v25 = [(HMDHomeManager *)v21 cloudZones];
  [v25 removeAllObjects];

  [(HMDHomeManager *)v21 setAppData:0];
  objc_initWeak(&location, v21);
  v26 = [(HMDHomeManager *)v21 msgFilterChain];
  v27 = [(HMDHomeManager *)v21 workQueue];
  v57[0] = MEMORY[0x277D85DD0];
  v57[1] = 3221225472;
  v57[2] = __70__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationWithReason___block_invoke_162;
  v57[3] = &unk_279732FD8;
  objc_copyWeak(&v58, &location);
  [v26 resetConfiguration:v27 completionHandler:v57];

  v28 = [(HMDHomeManager *)v21 pendingResponsesForAccessoryFinder];
  [v28 removeAllObjects];

  v29 = [(HMDHomeManager *)v21 associatedRemotePeers];
  [v29 removeAllObjects];

  v30 = [(HMDHomeManager *)v21 unassociatedRemotePeers];
  [v30 removeAllObjects];

  v31 = [(HMDHomeManager *)v21 pendingRemoteSessions];
  [v31 removeAllObjects];

  v32 = [(HMDHomeManager *)v21 pendingResidentSetupSessions];
  [v32 removeAllObjects];

  v33 = [(HMDHomeManager *)v21 uuidsOfRemovedHomes];
  [v33 removeAllObjects];

  v34 = [(HMDHomeManager *)v21 incomingInvitations];
  [v34 removeAllObjects];

  [(HMDHomeManager *)v21 updateHomeKitInUsePreferences];
  v35 = +[HMDBulletinBoard sharedBulletinBoard];
  [v35 removeAllBulletins];
  [v35 refreshHomeBadgeNumber];
  [(HMDHomeManager *)v21 _eraseLocalMetadata];
  [(HMDHomeManager *)v21 _checkForRemotePeers];
  [(HMDHomeManager *)v21 assistantSyncDataChanged:@"kResetConfigRequestKey"];
  CFPreferencesSetAppValue(@"HMDAssistantLastHashingKey", 0, *MEMORY[0x277CD0030]);
  v36 = [(HMDHomeManager *)v21 uuid];
  [(HMDHomeManager *)v21 updateGenerationCounterWithReason:@"Erase local home configuration" sourceUUID:v36 shouldNotifyClients:1];

  v37 = [MEMORY[0x277CCAB98] defaultCenter];
  [v37 postNotificationName:@"HMDHomeManagerLocalHomeDataRemovedNotification" object:0];

  v55 = 0;
  v56 = 0;
  v38 = objc_autoreleasePoolPush();
  v39 = v21;
  v40 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
  {
    v41 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v41;
    _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_DEFAULT, "%{public}@Waiting for thread network shutdown to complete", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v38);
  v42 = [MEMORY[0x277D0F7C0] allSettled:v54];
  v43 = [v42 waitForResult:&v56 orError:&v55 withTimeout:4.0];

  v44 = objc_autoreleasePoolPush();
  v45 = v39;
  if (v43)
  {
    v46 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
    {
      v47 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v47;
      _os_log_impl(&dword_2531F8000, v46, OS_LOG_TYPE_DEFAULT, "%{public}@Thread network shutdown completed - continuing with reset config", buf, 0xCu);
    }
  }

  else
  {
    v46 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
    {
      v48 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v48;
      _os_log_impl(&dword_2531F8000, v46, OS_LOG_TYPE_ERROR, "%{public}@Gave up waiting for thread network shutdown", buf, 0xCu);
    }
  }

  objc_autoreleasePoolPop(v44);
  objc_destroyWeak(&v58);
  objc_destroyWeak(&location);

  v49 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager_ResetConfig___eraseLocalHomeConfigurationWithReason___block_invoke_162(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    v2 = [WeakRetained cloudDataSyncManager];
    [v2 updateServerTokenStatusOnCloudFilter];

    WeakRetained = v3;
  }
}

void __69__HMDHomeManager_ResetConfig___eraseConfiguration_completionHandler___block_invoke(uint64_t a1, void *a2)
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v5 = v3;
    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [v5 hmd_conciseCKError];
      v10 = [v9 shortDescription];
      *buf = 138543618;
      v19 = v8;
      v20 = 2112;
      v21 = v10;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Cloud reset completed with error: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    if (v5 && [v5 code] != 75)
    {
      if ([v5 code] != 78)
      {
        v13 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:67 userInfo:0];

        v5 = v13;
      }

      (*(*(a1 + 32) + 16))();
    }

    else
    {
      v11 = *(a1 + 48);
      v12 = [WeakRetained workQueue];
      v15[0] = MEMORY[0x277D85DD0];
      v15[1] = 3221225472;
      v15[2] = __69__HMDHomeManager_ResetConfig___eraseConfiguration_completionHandler___block_invoke_153;
      v15[3] = &unk_279730A10;
      objc_copyWeak(&v17, (a1 + 40));
      v16 = *(a1 + 32);
      [WeakRetained _eraseLocalHomeConfigurationAndDeleteMetadata:v11 & 1 completionQueue:v12 completion:v15];

      objc_destroyWeak(&v17);
    }
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __69__HMDHomeManager_ResetConfig___eraseConfiguration_completionHandler___block_invoke_153(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained updateAccountAvailabilityChanged:*(a1 + 32)];
    WeakRetained = v3;
  }
}

- (void)_handleResetConfiguration:(id)a3
{
  v4 = a3;
  [HMDResetConfigPostCleanup writePostCleanupRecordWithReason:1 steps:-1];
  +[HMDHH2FrameworkSwitch removeHH2EnablementPreferenceKey];
  v5 = [v4 BOOLForKey:@"kResetConfigMetadataKey"];
  v6 = [objc_alloc(MEMORY[0x277D0F770]) initWithName:@"Reset Config" parent:0 options:1];
  [v6 begin];
  v7 = v6;
  v11 = v7;
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __57__HMDHomeManager_ResetConfig___handleResetConfiguration___block_invoke;
  v9[3] = &unk_2797358C8;
  v9[4] = self;
  v8 = v4;
  v10 = v8;
  [(HMDHomeManager *)self _eraseConfiguration:v5 completionHandler:v9];

  __HMFActivityScopeLeave();
}

void __57__HMDHomeManager_ResetConfig___handleResetConfiguration___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  [*(a1 + 32) waitForHH2SentinelZoneToBeRemoved];
  v4 = [*(a1 + 32) logEventSubmitter];
  v5 = +[HMDConfigurationResetLogEvent configurationReset];
  [v4 submitLogEvent:v5 error:v3];

  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v8;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@[Reset Config] : Sending cloud reset status to client with error: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  [*(a1 + 40) respondWithPayload:0 error:v3];
  v9 = *(a1 + 32);
  [objc_opt_class() relaunchHomedDueToResetConfigurationWithDelay:2.0];

  v10 = *MEMORY[0x277D85DE8];
}

+ (id)getContainersToCleanUp
{
  v7[3] = *MEMORY[0x277D85DE8];
  v2 = MEMORY[0x277CBEB98];
  v7[0] = @"com.apple.homekit";
  v7[1] = @"com.apple.homekit.camera.clips";
  v7[2] = @"com.apple.willow.config";
  v3 = [MEMORY[0x277CBEA60] arrayWithObjects:v7 count:3];
  v4 = [v2 setWithArray:v3];

  v5 = *MEMORY[0x277D85DE8];

  return v4;
}

+ (void)relaunchHomedDueToResetConfigurationWithDelay:(double)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  v6 = a1;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v13 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Scheduling homed relaunch due to reset configuration. (Either user logged out or user issued reset-config SPI", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = dispatch_time(0, a3);
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __77__HMDHomeManager_ResetConfig__relaunchHomedDueToResetConfigurationWithDelay___block_invoke;
  block[3] = &__block_descriptor_40_e5_v8__0l;
  block[4] = v6;
  dispatch_after(v9, MEMORY[0x277D85CD0], block);
  v10 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager_ResetConfig__relaunchHomedDueToResetConfigurationWithDelay___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = +[HMDLaunchHandler sharedHandler];
  v3 = objc_alloc(MEMORY[0x277CCAD78]);
  v4 = [v3 initWithUUIDString:*MEMORY[0x277CD23C8]];
  [v2 registerRelaunchClientWithUUID:v4];

  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 32);
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Going to relaunch homed due to resetConfiguration", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  _Exit(0);
}

+ (void)_eraseAllAccessoryKeysAndIdentifiers
{
  v32 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CFEC78] systemStore];
  v27 = 0;
  v4 = [v3 removeAllAccessoryKeys:&v27];
  v5 = v27;
  v6 = objc_autoreleasePoolPush();
  v7 = a1;
  v8 = HMFGetOSLogHandle();
  v9 = v8;
  if (v4)
  {
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v10;
    v11 = "%{public}@[Reset Config] : Removed all accessory keys from controller";
    v12 = v9;
    v13 = OS_LOG_TYPE_INFO;
    v14 = 12;
  }

  else
  {
    if (!os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    *buf = 138543618;
    v29 = v10;
    v30 = 2112;
    v31 = v5;
    v11 = "%{public}@[Reset Config] : Could not remove all accessory keys from controller (%@)";
    v12 = v9;
    v13 = OS_LOG_TYPE_ERROR;
    v14 = 22;
  }

  _os_log_impl(&dword_2531F8000, v12, v13, v11, buf, v14);

LABEL_7:
  objc_autoreleasePoolPop(v6);
  v26 = v5;
  v15 = [v3 deleteAllPeripheralIdentifiers:&v26];
  v16 = v26;

  v17 = objc_autoreleasePoolPush();
  v18 = v7;
  v19 = HMFGetOSLogHandle();
  v20 = os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT);
  if (v15)
  {
    if (v20)
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v29 = v21;
      v22 = "%{public}@[Reset Config] : Removed all Bluetooth peripheral identifiers.";
      v23 = v19;
      v24 = 12;
LABEL_12:
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, v22, buf, v24);
    }
  }

  else if (v20)
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v29 = v21;
    v30 = 2112;
    v31 = v16;
    v22 = "%{public}@[Reset Config] : Could not remove all Bluetooth peripheral identifiers (%@).";
    v23 = v19;
    v24 = 22;
    goto LABEL_12;
  }

  objc_autoreleasePoolPop(v17);
  v25 = *MEMORY[0x277D85DE8];
}

- (void)_sendFragmentedMessage:(id)a3 messageIndex:(unint64_t)a4 messageIdentity:(id)a5 userID:(id)a6 destination:(id)a7 completionHandler:(id)a8
{
  v14 = a3;
  v15 = a5;
  v16 = a6;
  v17 = a7;
  v18 = a8;
  objc_initWeak(&location, self);
  v19 = [(HMDHomeManager *)self messageDispatcher];
  v20 = [v14 objectAtIndexedSubscript:a4];
  v21 = [(HMDHomeManager *)self uuid];
  v22 = [(HMDHomeManager *)self workQueue];
  v28[0] = MEMORY[0x277D85DD0];
  v28[1] = 3221225472;
  v28[2] = __124__HMDHomeManager_FragmentMessage___sendFragmentedMessage_messageIndex_messageIdentity_userID_destination_completionHandler___block_invoke;
  v28[3] = &unk_279730BD8;
  objc_copyWeak(v34, &location);
  v34[1] = a4;
  v23 = v14;
  v29 = v23;
  v24 = v15;
  v30 = v24;
  v25 = v18;
  v33 = v25;
  v26 = v16;
  v31 = v26;
  v27 = v17;
  v32 = v27;
  [v19 sendSecureMessage:v20 target:v21 userID:v26 destination:v27 responseQueue:v22 responseHandler:v28];

  objc_destroyWeak(v34);
  objc_destroyWeak(&location);
}

void __124__HMDHomeManager_FragmentMessage___sendFragmentedMessage_messageIndex_messageIdentity_userID_destination_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v42 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (WeakRetained)
  {
    v8 = *(a1 + 80);
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [*(a1 + 32) count];
      v13 = *(a1 + 40);
      *buf = 138544130;
      v35 = v11;
      v36 = 2048;
      v37 = (v8 + 1);
      v38 = 2048;
      v39 = v12;
      v40 = 2112;
      v41 = v13;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Sent packet %tu/%tu with identity %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v9);
    if (v5)
    {
      v31 = v6;
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        v17 = [v5 localizedDescription];
        v18 = *(a1 + 48);
        *buf = 138543874;
        v35 = v16;
        v36 = 2112;
        v37 = v17;
        v38 = 2112;
        v39 = v18;
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Received %@ from user %@, cancel message", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      v19 = *(a1 + 40);
      v32[0] = @"kHomeDataFragmentIdentityKey";
      v32[1] = @"kHomeDataFragmentNumberKey";
      v33[0] = v19;
      v33[1] = &unk_28662A190;
      v20 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v33 forKeys:v32 count:2];
      v21 = [MEMORY[0x277D0F818] messageWithName:@"kHomeDataFragmentedSyncRequestKey" messagePayload:v20];
      v22 = [WeakRetained messageDispatcher];
      v23 = [WeakRetained uuid];
      v24 = *(a1 + 48);
      v25 = *(a1 + 56);
      v26 = [WeakRetained workQueue];
      [v22 sendSecureMessage:v21 target:v23 userID:v24 destination:v25 responseQueue:v26 responseHandler:&__block_literal_global_162153];

      v27 = *(a1 + 64);
      v6 = v31;
      if (v27)
      {
        (*(v27 + 16))(v27, v5, v31);
      }
    }

    else
    {
      v28 = *(a1 + 80);
      if (v28 == [*(a1 + 32) count] - 1 || objc_msgSend(v6, "hmf_BOOLForKey:", @"kDataSyncResponseCancelKey"))
      {
        v29 = *(a1 + 64);
        if (v29)
        {
          (*(v29 + 16))(v29, 0, v6);
        }
      }

      else
      {
        [WeakRetained _sendFragmentedMessage:*(a1 + 32) messageIndex:*(a1 + 80) + 1 messageIdentity:*(a1 + 40) userID:*(a1 + 48) destination:*(a1 + 56) completionHandler:*(a1 + 64)];
      }
    }
  }

  v30 = *MEMORY[0x277D85DE8];
}

- (void)_fragmentationStream:(id)a3 didReceiveData:(id)a4 transactionIdentifier:(unsigned __int16)a5 error:(id)a6
{
  v55 = *MEMORY[0x277D85DE8];
  v9 = a3;
  v10 = a4;
  v11 = a6;
  if (v10)
  {
    v44 = 0u;
    v45 = 0u;
    v42 = 0u;
    v43 = 0u;
    v12 = [(HMDHomeManager *)self pendingFragmentationStream];
    v13 = [v12 allKeys];

    v14 = [v13 countByEnumeratingWithState:&v42 objects:v54 count:16];
    if (v14)
    {
      v40 = v11;
      v41 = v10;
      v15 = 0;
      v16 = *v43;
LABEL_4:
      v17 = 0;
      v18 = v15;
      while (1)
      {
        if (*v43 != v16)
        {
          objc_enumerationMutation(v13);
        }

        v19 = *(*(&v42 + 1) + 8 * v17);
        v20 = [(HMDHomeManager *)self pendingFragmentationStream];
        v15 = [v20 objectForKeyedSubscript:v19];

        v21 = [v15 fragmentationStream];

        if (v21 == v9)
        {
          break;
        }

        v17 = v17 + 1;
        v18 = v15;
        if (v14 == v17)
        {
          v14 = [v13 countByEnumeratingWithState:&v42 objects:v54 count:16];
          if (v14)
          {
            goto LABEL_4;
          }

          v11 = v40;
          v10 = v41;
          goto LABEL_24;
        }
      }

      v14 = v19;

      if (v14)
      {
        v22 = v15 == 0;
      }

      else
      {
        v22 = 1;
      }

      if (v22)
      {
        v11 = v40;
        v10 = v41;
        goto LABEL_25;
      }

      v23 = MEMORY[0x277D0F818];
      v24 = [v15 lastMessage];
      v25 = [v23 messageWithMessage:v24 messagePayload:0];
      v13 = [v25 mutableCopy];

      v26 = [v15 lastMessage];
      v27 = [v26 destination];
      [v13 setDestination:v27];

      v28 = [v15 lastMessage];
      v29 = [v28 remoteSenderContext];
      [v13 setRemoteSenderContext:v29];

      [v15 close];
      v30 = [(HMDHomeManager *)self pendingFragmentationStream];
      [v30 removeObjectForKey:v14];

      v31 = [v15 lastMessage];
      v32 = [v31 stringForKey:@"kDataFragmentMessageNameKey"];

      v33 = objc_autoreleasePoolPush();
      v34 = HMFGetOSLogHandle();
      v35 = os_log_type_enabled(v34, OS_LOG_TYPE_INFO);
      v11 = v40;
      if (v35)
      {
        v36 = HMFGetLogIdentifier();
        *buf = 138543618;
        v51 = v36;
        v52 = 2112;
        v53 = v32;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@Full message received with name %@, calling the handle method.", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v33);
      v10 = v41;
      if ([v32 isEqualToString:@"kMetadataDataSyncRequestKey"])
      {
        v48 = @"kHAPMetadataDataKey";
        v49 = v41;
        v37 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v49 forKeys:&v48 count:1];
        [v13 setMessagePayload:v37];

        [(HMDHomeManager *)self _handleMetadataSync:v13];
      }

      else
      {
        v46 = @"kHomeDataKey";
        v47 = v41;
        v38 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v47 forKeys:&v46 count:1];
        [v13 setMessagePayload:v38];

        [(HMDHomeManager *)self _handleHomeDataSync:v13];
      }
    }

    else
    {
      v15 = 0;
    }

LABEL_24:

LABEL_25:
  }

  v39 = *MEMORY[0x277D85DE8];
}

- (void)_fragmentationStream:(id)a3 didCloseWithError:(id)a4
{
  v23 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v6 = [(HMDHomeManager *)self pendingFragmentationStream];
  v7 = [v6 allKeys];

  v8 = [v7 countByEnumeratingWithState:&v18 objects:v22 count:16];
  v9 = 0;
  if (v8)
  {
    v10 = *v19;
LABEL_3:
    v11 = 0;
    v12 = v9;
    while (1)
    {
      if (*v19 != v10)
      {
        objc_enumerationMutation(v7);
      }

      v13 = *(*(&v18 + 1) + 8 * v11);
      v14 = [(HMDHomeManager *)self pendingFragmentationStream];
      v9 = [v14 objectForKeyedSubscript:v13];

      v15 = [v9 fragmentationStream];

      if (v15 == v5)
      {
        break;
      }

      v11 = v11 + 1;
      v12 = v9;
      if (v8 == v11)
      {
        v8 = [v7 countByEnumeratingWithState:&v18 objects:v22 count:16];
        if (v8)
        {
          goto LABEL_3;
        }

        goto LABEL_15;
      }
    }

    v8 = v13;

    if (v8)
    {
      v16 = v9 == 0;
    }

    else
    {
      v16 = 1;
    }

    if (!v16)
    {
      [v9 close];
      v7 = [(HMDHomeManager *)self pendingFragmentationStream];
      [v7 removeObjectForKey:v8];
      goto LABEL_15;
    }
  }

  else
  {
LABEL_15:
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)handleDataFragmentedSync:(id)a3
{
  v102[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:@"kHomeDataFragmentIdentityKey"];
  v6 = [v4 stringForKey:@"kHomeUUID"];
  v7 = [v4 numberForKey:@"kHomeDataFragmentNumberKey"];
  v8 = [v4 numberForKey:@"kHomeDataFragmentTotalCountKey"];
  if (v5 && v7)
  {
    v85 = 0;
    v9 = [(HMDHomeManager *)self _shouldDecodeMessage:v4 error:&v85];
    v10 = v85;
    if (!v9)
    {
      v26 = objc_autoreleasePoolPush();
      v27 = self;
      v28 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v28, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v79 = v5;
        v29 = v6;
        v30 = v10;
        v32 = v31 = v8;
        [v4 remoteUserPairingIdentity];
        v34 = v33 = v7;
        *buf = 138543618;
        v88 = v32;
        v89 = 2112;
        v90 = v34;
        _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_ERROR, "%{public}@Rejecting home data sync - Sync not from trusted account %@", buf, 0x16u);

        v7 = v33;
        v8 = v31;
        v10 = v30;
        v6 = v29;
        v5 = v79;
      }

      objc_autoreleasePoolPop(v26);
      v35 = [v4 responseHandler];

      if (!v35)
      {
        goto LABEL_28;
      }

      v12 = [v4 responseHandler];
      v99 = @"kDataSyncResponseCancelKey";
      v100 = MEMORY[0x277CBEC38];
      v36 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v100 forKeys:&v99 count:1];
      (v12)[2](v12, v10, v36);
      goto LABEL_26;
    }

    if (![v7 unsignedIntegerValue])
    {
      v37 = [(HMDHomeManager *)self pendingFragmentationStream];
      v12 = [v37 objectForKeyedSubscript:v5];

      if (v12)
      {
        [v12 close];
        v38 = [(HMDHomeManager *)self pendingFragmentationStream];
        [v38 removeObjectForKey:v5];

        [v4 respondWithPayload:0];
      }

      goto LABEL_27;
    }

    if (v6 && v8)
    {
      v11 = [(HMDHomeManager *)self pendingFragmentationStream];
      v12 = [v11 objectForKeyedSubscript:v5];

      if ([v7 unsignedIntegerValue] == 1)
      {
        if (v12)
        {
          v13 = [(HMDHomeManager *)self pendingFragmentationStream];
          [v13 objectForKeyedSubscript:v5];
          v14 = v5;
          v15 = v6;
          v16 = v10;
          v18 = v17 = v8;
          [v18 close];

          v8 = v17;
          v10 = v16;
          v6 = v15;
          v5 = v14;

          v19 = [(HMDHomeManager *)self pendingFragmentationStream];
          [v19 removeObjectForKey:v14];
        }

        v20 = [HMDFragmentationStreamTuple tupleWithFragmentationStreamForObject:v6 delegate:self];

        v21 = [(HMDHomeManager *)self pendingFragmentationStream];
        [v21 setObject:v20 forKeyedSubscript:v5];

        v12 = v20;
        goto LABEL_31;
      }

      if (v12)
      {
LABEL_31:
        v76 = v8;
        v77 = v7;
        v47 = objc_alloc(MEMORY[0x277CFEB60]);
        v48 = [v4 dataForKey:@"kHomeDataFragmentKey"];
        v49 = [v47 initWithFragmentedPacketData:v48];

        v50 = objc_autoreleasePoolPush();
        v51 = HMFGetOSLogHandle();
        v52 = v51;
        if (v49)
        {
          v78 = v49;
          v74 = v10;
          v75 = v6;
          if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
          {
            v53 = HMFGetLogIdentifier();
            *buf = 138543874;
            v88 = v53;
            v89 = 2112;
            v90 = v5;
            v91 = 2112;
            v92 = v78;
            _os_log_impl(&dword_2531F8000, v52, OS_LOG_TYPE_INFO, "%{public}@Processing fragmentation packet with identity %@: %@", buf, 0x20u);
          }

          v80 = v5;

          objc_autoreleasePoolPop(v50);
          [v12 setLastMessage:v4];
          v73 = v12;
          v54 = [v12 fragmentationStream];
          [v54 receivedFragmentedPacket:v78];

          v83 = 0u;
          v84 = 0u;
          v81 = 0u;
          v82 = 0u;
          v55 = [(HMDHomeManager *)self pendingFragmentationStream];
          v56 = [v55 allKeys];

          v57 = [v56 countByEnumeratingWithState:&v81 objects:v86 count:16];
          if (v57)
          {
            v58 = v57;
            v59 = *v82;
            do
            {
              v60 = 0;
              do
              {
                if (*v82 != v59)
                {
                  objc_enumerationMutation(v56);
                }

                v61 = *(*(&v81 + 1) + 8 * v60);
                v62 = [(HMDHomeManager *)self pendingFragmentationStream];
                v63 = [v62 objectForKeyedSubscript:v61];
                v64 = [v63 isExpired];

                if (v64)
                {
                  v65 = [(HMDHomeManager *)self pendingFragmentationStream];
                  v66 = [v65 objectForKeyedSubscript:v61];
                  [v66 close];

                  v67 = [(HMDHomeManager *)self pendingFragmentationStream];
                  [v67 removeObjectForKey:v61];
                }

                ++v60;
              }

              while (v58 != v60);
              v58 = [v56 countByEnumeratingWithState:&v81 objects:v86 count:16];
            }

            while (v58);
          }

          v7 = v77;
          v68 = [v77 unsignedIntegerValue];
          v8 = v76;
          if (v68 != [v76 unsignedIntegerValue])
          {
            [v4 respondWithPayload:0];
          }

          v36 = v78;
          v5 = v80;
          v10 = v74;
          v6 = v75;
          v12 = v73;
        }

        else
        {
          if (os_log_type_enabled(v51, OS_LOG_TYPE_ERROR))
          {
            v69 = HMFGetLogIdentifier();
            *buf = 138543362;
            v88 = v69;
            _os_log_impl(&dword_2531F8000, v52, OS_LOG_TYPE_ERROR, "%{public}@Received invalid fragmented payload", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v50);
          v36 = [v4 responseHandler];

          if (v36)
          {
            v70 = [v4 responseHandler];
            v93 = @"kDataSyncResponseCancelKey";
            v94 = MEMORY[0x277CBEC38];
            v71 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v94 forKeys:&v93 count:1];
            (v70)[2](v70, 0, v71);

            v36 = 0;
          }

          v8 = v76;
          v7 = v77;
        }

        goto LABEL_26;
      }

      v72 = [v4 responseHandler];

      if (!v72)
      {
        goto LABEL_28;
      }

      v12 = [v4 responseHandler];
      v95 = @"kDataSyncResponseCancelKey";
      v96 = MEMORY[0x277CBEC38];
      v43 = MEMORY[0x277CBEAC0];
      v44 = &v96;
      v45 = &v95;
    }

    else
    {
      v39 = objc_autoreleasePoolPush();
      v40 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v40, OS_LOG_TYPE_ERROR))
      {
        v41 = HMFGetLogIdentifier();
        *buf = 138543362;
        v88 = v41;
        _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_ERROR, "%{public}@Received fragmented message without an objectUUID or total count", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v39);
      v42 = [v4 responseHandler];

      if (!v42)
      {
        goto LABEL_28;
      }

      v12 = [v4 responseHandler];
      v97 = @"kDataSyncResponseCancelKey";
      v98 = MEMORY[0x277CBEC38];
      v43 = MEMORY[0x277CBEAC0];
      v44 = &v98;
      v45 = &v97;
    }

    v36 = [v43 dictionaryWithObjects:v44 forKeys:v45 count:1];
    (v12)[2](v12, 0, v36);
LABEL_26:

    goto LABEL_27;
  }

  v22 = objc_autoreleasePoolPush();
  v23 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
  {
    v24 = HMFGetLogIdentifier();
    *buf = 138543362;
    v88 = v24;
    _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Received fragmented message with bad header", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v22);
  v25 = [v4 responseHandler];

  if (v25)
  {
    v10 = [v4 responseHandler];
    v101 = @"kDataSyncResponseCancelKey";
    v102[0] = MEMORY[0x277CBEC38];
    v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v102 forKeys:&v101 count:1];
    (*(v10 + 2))(v10, 0, v12);
LABEL_27:

LABEL_28:
  }

  v46 = *MEMORY[0x277D85DE8];
}

- (void)sendFragmentedMessageForData:(id)a3 objectUUID:(id)a4 withMessageName:(id)a5 toUser:(id)a6 destination:(id)a7 completionHandler:(id)a8
{
  v55 = *MEMORY[0x277D85DE8];
  v14 = a3;
  v44 = a4;
  v43 = a5;
  v15 = a6;
  v16 = a7;
  v17 = a8;
  v18 = [MEMORY[0x277CCAD78] UUID];
  v45 = [v18 UUIDString];

  v19 = [MEMORY[0x277CFEB68] fragmentationPacketsForData:v14 maxLength:maximumDataSyncFragmentSize transactionIdentifier:{-[HMDHomeManager _nextTransactionIdentifier](self, "_nextTransactionIdentifier")}];
  if (v19)
  {
    v38 = v17;
    v39 = v16;
    v40 = v15;
    v41 = v14;
    v42 = [MEMORY[0x277CBEB18] array];
    v46 = 0u;
    v47 = 0u;
    v48 = 0u;
    v49 = 0u;
    v37 = v19;
    v20 = v19;
    v21 = [v20 countByEnumeratingWithState:&v46 objects:v52 count:16];
    if (v21)
    {
      v22 = v21;
      v23 = *v47;
      v24 = 1;
      do
      {
        for (i = 0; i != v22; ++i)
        {
          if (*v47 != v23)
          {
            objc_enumerationMutation(v20);
          }

          v26 = *(*(&v46 + 1) + 8 * i);
          v50[0] = @"kHomeUUID";
          v50[1] = @"kHomeDataFragmentIdentityKey";
          v51[0] = v44;
          v51[1] = v45;
          v50[2] = @"kHomeDataFragmentKey";
          v27 = [v26 serialize];
          v51[2] = v27;
          v50[3] = @"kHomeDataFragmentNumberKey";
          v28 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v24];
          v51[3] = v28;
          v50[4] = @"kHomeDataFragmentTotalCountKey";
          v29 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v20, "count")}];
          v50[5] = @"kDataFragmentMessageNameKey";
          v51[4] = v29;
          v51[5] = v43;
          v30 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v51 forKeys:v50 count:6];

          v31 = [MEMORY[0x277D0F848] messageWithName:@"kHomeDataFragmentedSyncRequestKey" messagePayload:v30];
          [v42 addObject:v31];
          ++v24;
        }

        v22 = [v20 countByEnumeratingWithState:&v46 objects:v52 count:16];
      }

      while (v22);
    }

    v32 = v42;
    v16 = v39;
    v15 = v40;
    v17 = v38;
    [(HMDHomeManager *)self _sendFragmentedMessage:v42 messageIndex:0 messageIdentity:v45 userID:v40 destination:v39 completionHandler:v38];
    v14 = v41;
    v19 = v37;
    goto LABEL_14;
  }

  v33 = objc_autoreleasePoolPush();
  v34 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
  {
    v35 = HMFGetLogIdentifier();
    *buf = 138543362;
    v54 = v35;
    _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_ERROR, "%{public}@Failed to fragment data sync, aborting", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v33);
  if (v17)
  {
    v32 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    v17[2](v17, v32, 0);
LABEL_14:
  }

  v36 = *MEMORY[0x277D85DE8];
}

- (void)memoryMonitor:(id)a3 didReceiveMemoryEvent:(int64_t)a4
{
  v20 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
  {
    v10 = HMFGetLogIdentifier();
    *v19 = 138543362;
    *&v19[4] = v10;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_FAULT, "%{public}@Received process memory event", v19, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  *v19 = 0;
  [(HMDHomeManager *)v8 dataSyncInProgressWithState:v19 withMessage:0];
  v11 = [(HMDHomeManager *)v8 logEventSubmitter];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = v11;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  [v13 handleMemoryEvent:a4];
  v14 = [HMDProcessMemoryPressureNotificationLogEvent alloc];
  v15 = [(HMDProcessMemoryPressureNotificationLogEvent *)v14 initWithProcessMemoryEvent:a4 dataSyncState:*v19];
  v16 = [(HMDHomeManager *)v8 logEventSubmitter];
  [v16 submitLogEvent:v15];

  v17 = [(HMDHomeManager *)v8 memoryTracker];
  [v17 trackMemoryUsageWithReason:2];

  v18 = *MEMORY[0x277D85DE8];
}

- (BOOL)isHH1EOLForResidentDeviceRunningSoftwareVersion:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self idsServerBag];
  v6 = [v5 hh1EOLMinimumResidentVersion];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self idsServerBag];
    v8 = [v7 hh1EOLMinimumResidentVersion];
    v9 = [v4 isAtLeastVersion:v8];
  }

  else
  {
    v9 = 0;
  }

  return v9;
}

- (BOOL)isHH1EOLEnabled
{
  v31 = *MEMORY[0x277D85DE8];
  if (!_os_feature_enabled_impl() || (enableRetailDemoSetup & 1) != 0)
  {
    goto LABEL_3;
  }

  v6 = [(HMDHomeManager *)self userDefaults];
  v7 = [v6 BOOLForKey:@"HH1EOLEnabled"];

  if (v7)
  {
LABEL_11:
    v3 = 1;
    goto LABEL_4;
  }

  v8 = [(HMDHomeManager *)self idsServerBag];
  v9 = [v8 hh1EOLMininumControllerHomeKitVersion];
  if (v9)
  {
    v10 = v9;
    v11 = +[HMDHomeKitVersion currentVersion];
    v12 = [(HMDHomeManager *)self idsServerBag];
    v13 = [v12 hh1EOLMininumControllerHomeKitVersion];
    v14 = [v11 isAtLeastVersion:v13];

    if (v14)
    {
      v15 = objc_autoreleasePoolPush();
      v16 = self;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543362;
        v30 = v18;
        _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@HH1 EOL minimum version met.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v15);
      goto LABEL_11;
    }
  }

  else
  {
  }

  if (!isInternalBuild())
  {
LABEL_3:
    v3 = 0;
    goto LABEL_4;
  }

  v19 = [(HMDHomeManager *)self appleAccountManager];
  v20 = [v19 account];
  v21 = [v20 modelIdentifier];

  if (v21)
  {
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __33__HMDHomeManager_isHH1EOLEnabled__block_invoke;
    v26[3] = &unk_2797359B0;
    v27 = v21;
    v28 = self;
    if (isHH1EOLEnabled_onceToken != -1)
    {
      dispatch_once(&isHH1EOLEnabled_onceToken, v26);
    }

    v3 = isHH1EOLEnabled_hh1EOLEnabled;
  }

  else
  {
    v22 = objc_autoreleasePoolPush();
    v23 = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543362;
      v30 = v25;
      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@HH1 EOL is enabled as current account identifier is nil.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v22);
    v3 = 1;
  }

LABEL_4:
  v4 = *MEMORY[0x277D85DE8];
  return v3;
}

void __33__HMDHomeManager_isHH1EOLEnabled__block_invoke(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  v14 = 0;
  v2 = [*(a1 + 32) hmf_bytesAsData];
  v3 = [v2 hm_generateSHA256];

  [v3 getBytes:&v14 length:8];
  v4 = v14;
  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 40);
  v7 = HMFGetOSLogHandle();
  v8 = os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT);
  if (v4)
  {
    if (v8)
    {
      v9 = HMFGetLogIdentifier();
      v10 = *(a1 + 32);
      *buf = 138543874;
      v16 = v9;
      v17 = 2112;
      v18 = v10;
      v19 = 2048;
      v20 = v14;
      v11 = "%{public}@HH1 EOL is enabled for user: %@ based on UUID hash: %tu";
LABEL_6:
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, v11, buf, 0x20u);
    }
  }

  else if (v8)
  {
    v9 = HMFGetLogIdentifier();
    v12 = *(a1 + 32);
    *buf = 138543874;
    v16 = v9;
    v17 = 2112;
    v18 = v12;
    v19 = 2048;
    v20 = v14;
    v11 = "%{public}@HH1 EOL is not enabled for user: %@ based on UUID hash: %tu";
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v5);
  isHH1EOLEnabled_hh1EOLEnabled = v4 & 1;

  v13 = *MEMORY[0x277D85DE8];
}

- (void)removeSharedUserAcceptEventBuilderForHomeUuid:(id)a3
{
  v4 = a3;
  if (v4)
  {
    v6 = v4;
    os_unfair_lock_lock_with_options();
    v5 = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    [v5 removeObjectForKey:v6];

    os_unfair_lock_unlock(&self->_lock);
    v4 = v6;
  }
}

- (id)sharedUserAcceptEventBuilderForHomeUuid:(id)a3
{
  v4 = a3;
  if (v4)
  {
    os_unfair_lock_lock_with_options();
    v5 = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    v6 = [v5 objectForKeyedSubscript:v4];

    os_unfair_lock_unlock(&self->_lock);
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

- (void)addSharedUserAcceptEventBuilder:(id)a3 forHomeUuid:(id)a4
{
  v10 = a3;
  v6 = a4;
  if (v10 && v6)
  {
    os_unfair_lock_lock_with_options();
    v7 = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];

    if (!v7)
    {
      v8 = objc_alloc_init(MEMORY[0x277CBEB38]);
      [(HMDHomeManager *)self setPendingSharedUserAcceptLogEventBuilders:v8];
    }

    v9 = [(HMDHomeManager *)self pendingSharedUserAcceptLogEventBuilders];
    [v9 setObject:v10 forKeyedSubscript:v6];

    os_unfair_lock_unlock(&self->_lock);
  }
}

- (void)_signpostAssistantSyncDataRequestHandled
{
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    *v3 = 0;
    _os_signpost_emit_with_name_impl(&dword_2531F8000, logger, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "AssistantSyncDataRequestHandled", "", v3, 2u);
  }
}

- (void)_signpostAssistantSyncDataNotification
{
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    *v3 = 0;
    _os_signpost_emit_with_name_impl(&dword_2531F8000, logger, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "NotifyAssistantSyncDataReadiness", "", v3, 2u);
  }
}

- (void)_handlePrepareForDiagnosticExtension:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ((isInternalBuild() & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
    {
      v10 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v10;
      v21 = 2112;
      v22 = v4;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_FAULT, "%{public}@Should never call _handlePrepareForDiagnosticExtension in non-internal builds: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 52;
    goto LABEL_10;
  }

  v5 = [v4 name];
  v6 = [v5 isEqualToString:*MEMORY[0x277CD02F0]];

  if ((v6 & 1) == 0)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v16;
      v21 = 2112;
      v22 = v4;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@Received bad message in _handlePrepareForDiagnosticExtension: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 3;
LABEL_10:
    v17 = [v11 hmErrorWithCode:v12];
    [v4 respondWithError:v17];

    goto LABEL_11;
  }

  [(HMDHomeManager *)self prepareForDiagnosticExtension:v4];
LABEL_11:

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleDumpDatabase:(id)a3
{
  v24 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ((isInternalBuild() & 1) == 0)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_FAULT))
    {
      v11 = HMFGetLogIdentifier();
      v20 = 138543618;
      v21 = v11;
      v22 = 2112;
      v23 = v4;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_FAULT, "%{public}@Should never call _handleDumpDatabase in non-internal builds: %@", &v20, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    v12 = MEMORY[0x277CCA9B8];
    v13 = 52;
    goto LABEL_10;
  }

  v5 = [v4 name];
  v6 = [v5 isEqualToString:*MEMORY[0x277CD0158]];

  if ((v6 & 1) == 0)
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      v20 = 138543618;
      v21 = v17;
      v22 = 2112;
      v23 = v4;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Received bad message in _handleDumpDatabase: %@", &v20, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    v12 = MEMORY[0x277CCA9B8];
    v13 = 3;
LABEL_10:
    v7 = [v12 hmErrorWithCode:v13];
    goto LABEL_11;
  }

  v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48 description:0 reason:@"Database dump only supported in ROAR mode" suggestion:0];
LABEL_11:
  v18 = v7;
  [v4 respondWithError:v7];

  v19 = *MEMORY[0x277D85DE8];
}

- (BOOL)expectingInvitationResponseForIdentifier:(id)a3
{
  v32 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    v28 = 0u;
    v29 = 0u;
    v26 = 0u;
    v27 = 0u;
    v5 = [(HMDHomeManager *)self homes];
    v6 = [v5 countByEnumeratingWithState:&v26 objects:v31 count:16];
    if (v6)
    {
      v7 = v6;
      v8 = *v27;
      v21 = *v27;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v27 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v26 + 1) + 8 * i);
          v22 = 0u;
          v23 = 0u;
          v24 = 0u;
          v25 = 0u;
          v11 = [v10 outgoingInvitations];
          v12 = [v11 countByEnumeratingWithState:&v22 objects:v30 count:16];
          if (v12)
          {
            v13 = v12;
            v14 = *v23;
            while (2)
            {
              for (j = 0; j != v13; ++j)
              {
                if (*v23 != v14)
                {
                  objc_enumerationMutation(v11);
                }

                v16 = [*(*(&v22 + 1) + 8 * j) identifier];
                v17 = [v16 isEqual:v4];

                if (v17)
                {

                  v18 = 1;
                  goto LABEL_21;
                }
              }

              v13 = [v11 countByEnumeratingWithState:&v22 objects:v30 count:16];
              if (v13)
              {
                continue;
              }

              break;
            }
          }

          v8 = v21;
        }

        v7 = [v5 countByEnumeratingWithState:&v26 objects:v31 count:16];
        v18 = 0;
      }

      while (v7);
    }

    else
    {
      v18 = 0;
    }

LABEL_21:
  }

  else
  {
    v18 = 0;
  }

  v19 = *MEMORY[0x277D85DE8];
  return v18;
}

- (BOOL)userWithMergeIdIsMemberOfAHome:(id)a3
{
  v58 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v47 = 0u;
  v48 = 0u;
  v49 = 0u;
  v50 = 0u;
  v38 = self;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 countByEnumeratingWithState:&v47 objects:v57 count:16];
  if (v6)
  {
    v7 = *v48;
    v37 = *v48;
    while (2)
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v48 != v7)
        {
          objc_enumerationMutation(v5);
        }

        v9 = *(*(&v47 + 1) + 8 * i);
        v10 = [v9 userWithMergeID:{v4, v37}];
        v11 = v10 == 0;

        if (!v11)
        {
LABEL_22:

          goto LABEL_23;
        }

        v45 = 0u;
        v46 = 0u;
        v43 = 0u;
        v44 = 0u;
        v12 = [v9 removedUsers];
        v13 = [v12 countByEnumeratingWithState:&v43 objects:v56 count:16];
        if (v13)
        {
          v14 = *v44;
          while (2)
          {
            for (j = 0; j != v13; ++j)
            {
              if (*v44 != v14)
              {
                objc_enumerationMutation(v12);
              }

              v16 = [*(*(&v43 + 1) + 8 * j) mergeID];
              v17 = [v16 isEqualToString:v4];

              if (v17)
              {

                goto LABEL_22;
              }
            }

            v13 = [v12 countByEnumeratingWithState:&v43 objects:v56 count:16];
            if (v13)
            {
              continue;
            }

            break;
          }
        }

        v7 = v37;
      }

      v6 = [v5 countByEnumeratingWithState:&v47 objects:v57 count:16];
      v7 = v37;
      if (v6)
      {
        continue;
      }

      break;
    }
  }

  os_unfair_lock_lock_with_options();
  if ([(NSMutableSet *)v38->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:v4])
  {
    v18 = objc_autoreleasePoolPush();
    v19 = v38;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543618;
      v53 = v21;
      v54 = 2112;
      v55 = v4;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Merge ID %@ found in list of removed homes", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    os_unfair_lock_unlock(&v38->_lock);
LABEL_23:
    v22 = 1;
  }

  else
  {
    os_unfair_lock_unlock(&v38->_lock);
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    v25 = [(HMDHomeManager *)v38 incomingInvitations];
    v26 = [v25 copy];

    v27 = [v26 countByEnumeratingWithState:&v39 objects:v51 count:16];
    if (v27)
    {
      v28 = *v40;
      while (2)
      {
        for (k = 0; k != v27; ++k)
        {
          if (*v40 != v28)
          {
            objc_enumerationMutation(v26);
          }

          v30 = *(*(&v39 + 1) + 8 * k);
          if ([v30 isAccepted])
          {
            v31 = [v30 inviterMergeID];
            v32 = [v31 isEqual:v4];

            if (v32)
            {

              goto LABEL_23;
            }
          }
        }

        v27 = [v26 countByEnumeratingWithState:&v39 objects:v51 count:16];
        if (v27)
        {
          continue;
        }

        break;
      }
    }

    v33 = objc_autoreleasePoolPush();
    v34 = v38;
    v35 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
    {
      v36 = HMFGetLogIdentifier();
      *buf = 138543618;
      v53 = v36;
      v54 = 2112;
      v55 = v4;
      _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_DEFAULT, "%{public}@Home Membership Verifier unable to find user with mergeID %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v33);
    v22 = 0;
  }

  v23 = *MEMORY[0x277D85DE8];
  return v22;
}

- (id)createCurrentResidentCapabilities
{
  v3 = objc_alloc_init(HMDMobileGestaltClient);
  v4 = [MEMORY[0x277D0F8E8] productInfo];
  v5 = +[HMDHomeKitVersion currentVersion];
  v6 = [(HMDHomeManager *)self featuresDataSource];
  v7 = v4;
  v8 = v3;
  v9 = v5;
  v10 = v6;
  if (!productIsResidentCapable(v7))
  {
    v62 = 0;
    goto LABEL_80;
  }

  v11 = productSupportsCameraRecording(v7);
  if (productSupportsRouterManagement(v7))
  {
    v12 = 2;
  }

  else
  {
    v12 = 0;
  }

  v13 = productSupportsShortcutActions(v7);
  v14 = 4;
  if (!v13)
  {
    v14 = 0;
  }

  v99 = v14;
  v15 = productSupportsMediaActions(v7);
  v16 = 8;
  if (!v15)
  {
    v16 = 0;
  }

  v98 = v16;
  v17 = productSupportsFirmwareUpdate(v7);
  v18 = 32;
  if (!v17)
  {
    v18 = 0;
  }

  v112 = v18;
  v19 = productSupportsResidentFirmwareUpdate(v7);
  v20 = 64;
  if (!v19)
  {
    v20 = 0;
  }

  v119 = v20;
  v21 = productSupportsCameraActivityZones(v7);
  v22 = 128;
  if (!v21)
  {
    v22 = 0;
  }

  v118 = v22;
  v23 = productSupportsCameraActivityZones(v7);
  v24 = 256;
  if (!v23)
  {
    v24 = 0;
  }

  v117 = v24;
  v25 = productSupportsCameraActivityZones(v7);
  v26 = 512;
  if (!v25)
  {
    v26 = 0;
  }

  v116 = v26;
  v27 = productSupportsCameraActivityZones(v7);
  v28 = 1024;
  if (!v27)
  {
    v28 = 0;
  }

  v115 = v28;
  v29 = productSupportsAnnounce(v7);
  v30 = 2048;
  if (!v29)
  {
    v30 = 0;
  }

  v114 = v30;
  v31 = productSupportsWakeOnLAN(v7);
  v32 = 4096;
  if (!v31)
  {
    v32 = 0;
  }

  v113 = v32;
  v33 = productSupportsLockNotificationContext(v7);
  v34 = 0x2000;
  if (!v33)
  {
    v34 = 0;
  }

  v111 = v34;
  v35 = productSupportsLockNotificationContext(v7);
  v36 = 0x4000;
  if (!v35)
  {
    v36 = 0;
  }

  v110 = v36;
  v37 = productSupportsLockNotificationContext(v7);
  v38 = 0x8000;
  if (!v37)
  {
    v38 = 0;
  }

  v109 = v38;
  v39 = productSupportsLockNotificationContext(v7);
  v40 = 0x10000;
  if (!v39)
  {
    v40 = 0;
  }

  v108 = v40;
  v41 = productSupportsLockNotificationContext(v7);
  v42 = 0x20000;
  if (!v41)
  {
    v42 = 0;
  }

  v107 = v42;
  v43 = productSupportsSiriEndpointSetup(v7);
  v44 = 0x80000;
  if (!v43)
  {
    v44 = 0;
  }

  v106 = v44;
  v45 = productSupportsCustomMediaApplicationDestination(v7);
  v46 = 0x100000;
  if (!v45)
  {
    v46 = 0;
  }

  v105 = v46;
  v47 = productSupportsUnifiedMediaNotifications(v7);
  v48 = 0x200000;
  if (!v47)
  {
    v48 = 0;
  }

  v104 = v48;
  v49 = productSupportsHomeHub(v7, v8);
  v50 = 0x400000;
  if (!v49)
  {
    v50 = 0;
  }

  v103 = v50;
  AccessoryCommunication = productSupportsResidentFirstAccessoryCommunication(v7);
  v52 = 0x800000;
  if (!AccessoryCommunication)
  {
    v52 = 0;
  }

  v102 = v52;
  v53 = productSupportsThreadNetworkCredentialSharing(v7, v8, v9);
  v54 = 0x1000000;
  if (!v53)
  {
    v54 = 0;
  }

  v101 = v54;
  v55 = productSupportsMatterSharedAdminPairing(v7, v8, v9);
  v56 = 0x2000000;
  if (!v55)
  {
    v56 = 0;
  }

  v100 = v56;
  v57 = v7;
  v58 = v8;
  v59 = v9;
  v60 = [v57 softwareVersion];
  v61 = v60;
  if (v60)
  {
    [v60 operatingSystemVersion];
  }

  v94 = *MEMORY[0x277D0F5F8];
  v63 = *(MEMORY[0x277D0F5F8] + 16);
  if (HMFOperatingSystemVersionCompare() == 1)
  {
    v97 = 0;
  }

  else
  {
    IsResidentCapable = productIsResidentCapable(v57);
    v65 = 0x10000000;
    if (!IsResidentCapable)
    {
      v65 = 0;
    }

    v97 = v65;
  }

  v66 = productSupportsMatterOwnerCertFetch(v57, v58, v59);
  v67 = 0x100000000;
  if (!v66)
  {
    v67 = 0;
  }

  v96 = v67;
  v68 = v57;
  v69 = [v68 softwareVersion];
  v70 = v69;
  if (v69)
  {
    [v69 operatingSystemVersion];
  }

  v71 = v11;

  v72 = [v68 productPlatform];
  v73 = [v68 productClass];

  if ((v73 | 2) == 6 && v72 == 4)
  {
    v95 = (HMFOperatingSystemVersionCompare() != 1) << 33;
  }

  else
  {
    v95 = 0;
  }

  v74 = v68;
  v75 = [v74 softwareVersion];
  v76 = v75;
  if (v75)
  {
    [v75 operatingSystemVersion];
  }

  v77 = v12 | v71;

  v78 = [v74 productPlatform];
  v79 = [v74 productClass];

  if ((v79 | 2) != 6 || v78 != 4)
  {
    goto LABEL_72;
  }

  if (HMFOperatingSystemVersionCompare() != 1)
  {
    v80 = 0x400000000;
    goto LABEL_73;
  }

  if (isInternalBuild())
  {
    v120 = *MEMORY[0x277D0F690];
    v122 = *(MEMORY[0x277D0F690] + 16);
    v80 = (HMFOperatingSystemVersionCompare() != 1) << 34;
  }

  else
  {
LABEL_72:
    v80 = 0;
  }

LABEL_73:
  v81 = v74;
  [v81 productPlatform];
  [v81 productClass];

  v82 = v81;
  v83 = [v82 softwareVersion];
  v84 = v83;
  if (v83)
  {
    [v83 operatingSystemVersion];
  }

  v85 = v77 | v99 | v98 | v112;

  v86 = [v82 productPlatform];
  v87 = [v82 productClass];

  if ((v87 | 2) == 6 && v86 == 4)
  {
    v121 = *MEMORY[0x277D0F5E0];
    v123 = *(MEMORY[0x277D0F5E0] + 16);
    v88 = (HMFOperatingSystemVersionCompare() != 1) << 37;
  }

  else
  {
    v88 = 0;
  }

  v89 = v85 | v119 | v118 | v117 | v116 | v115 | v114 | v113 | v111 | v110 | v109 | v108 | v107 | v106 | v105 | v104 | v103 | v102 | v101 | v100;
  v90 = v97 | v96 | v95 | v80 | v88;
  v91 = objc_alloc(MEMORY[0x277CD1D60]);
  v92 = [MEMORY[0x277CCAD78] UUID];
  v62 = [v91 initWithTagUUID:v92 capabilities:v89 | v90];

LABEL_80:

  return v62;
}

- (id)createCurrentAccessoryCapabilities
{
  v3 = objc_alloc_init(HMDMobileGestaltClient);
  v4 = [MEMORY[0x277D0F8E8] productInfo];
  v5 = +[HMDHomeKitVersion currentVersion];
  v6 = [(HMDHomeManager *)self featuresDataSource];
  v7 = v5;
  v8 = v3;
  v9 = v4;
  v145 = productSupportsKeychainSync(v9);
  v144 = productSupportsDeviceSetup(v9);
  v143 = productSupportsKeyTransferClient(v9, v8, v7);
  v141 = productSupportsKeyTransferServer(v9);
  v142 = productSupportsStandaloneMode(v9);
  v140 = productSupportsCloudDataSync(v9);
  v139 = productSupportsWholeHouseAudio(v9);
  v10 = productSupportsAssistantAccessControl(v9);
  v138 = productSupportsHomeInvitation(v9);
  v11 = productSupportsTargetControl(v9);
  v137 = productSupportsMultiUser(v9);
  v12 = productSupportsHomeLevelLocationServiceSetting(v9);
  v135 = productSupportsCompanionInitiatedRestart(v9);
  v133 = productSupportsMusicAlarm(v9);
  v131 = productSupportsAnnounce(v9);
  v129 = productSupportsThirdPartyMusic(v9);
  v127 = productSupportsPreferredMediaUser(v9);
  v125 = productSupportsThirdPartyMusic(v9);
  v123 = productSupportsUserMediaSettings(v9);
  v120 = productSupportsCoordinationDoorbellChime(v9);
  v118 = productSupportsHomeHub(v9, v8);
  v146 = v8;
  v13 = productSupportsAudioReturnChannel(v9, v8);
  v116 = productSupportsUserMediaSettings(v9);
  v114 = productSupportsCaptiveNetworks(v9);
  v112 = productSupportsMessagedHomePodSettings(v9, v7);
  v110 = productSupportsMediaActions(v9);
  v108 = productSupportsRMVonAppleTV(v9);
  v106 = productSupportsJustSiri(v9);
  v14 = v9;
  v15 = [v14 softwareVersion];
  v16 = v15;
  if (v15)
  {
    [v15 operatingSystemVersion];
  }

  v17 = [v14 productPlatform];
  v18 = [v14 productClass];

  v19 = 0;
  if (v18 == 6 && v17 == 4)
  {
    v147 = *MEMORY[0x277D0F680];
    v153 = *(MEMORY[0x277D0F680] + 16);
    v19 = (HMFOperatingSystemVersionCompare() != 1) << 31;
  }

  v122 = v19;
  v103 = productSupportsCoordinationFreeDoorbellChime(v14);
  v100 = productSupportsCompanionInitiatedObliterate(v14);
  v20 = v14;
  v21 = [v20 productPlatform];
  v22 = [v20 productClass];
  v23 = [v20 softwareVersion];

  if (v23)
  {
    [v23 operatingSystemVersion];
  }

  v24 = 0;
  if (v22 == 4 && v21 == 4)
  {
    v148 = *MEMORY[0x277D0F5F8];
    v154 = *(MEMORY[0x277D0F5F8] + 16);
    v24 = (HMFOperatingSystemVersionCompare() != 1) << 34;
  }

  v105 = v24;
  v25 = [v20 productClass];
  v26 = v20;
  v27 = [v26 softwareVersion];
  v28 = v27;
  if (v27)
  {
    [v27 operatingSystemVersion];
  }

  v29 = [v26 productPlatform];
  v30 = [v26 productClass];

  v31 = 0;
  if (v30 == 6 && v29 == 4)
  {
    v149 = *MEMORY[0x277D0F5E0];
    v155 = *(MEMORY[0x277D0F5E0] + 16);
    v31 = (HMFOperatingSystemVersionCompare() != 1) << 36;
  }

  v102 = v31;
  v32 = v6;
  v33 = v26;
  v34 = [v33 softwareVersion];
  v35 = v34;
  if (v34)
  {
    [v34 operatingSystemVersion];
  }

  v36 = [v33 productPlatform];
  v37 = [v33 productClass];

  v38 = 0;
  if (v37 == 6 && v36 == 4)
  {
    v150 = *MEMORY[0x277D0F5E8];
    v156 = *(MEMORY[0x277D0F5E8] + 16);
    if (HMFOperatingSystemVersionCompare() == 1)
    {
      v38 = 0;
    }

    else
    {
      v39 = [v32 isStereoOdeonTTSUBypassingPrimaryEnabled];
      v38 = 0x4000000000;
      if (!v39)
      {
        v38 = 0;
      }
    }
  }

  v99 = v38;

  v40 = v32;
  v41 = v33;
  v42 = [v41 softwareVersion];
  v43 = v42;
  if (v42)
  {
    [v42 operatingSystemVersion];
  }

  v44 = [v41 productPlatform];
  v45 = [v41 productClass];

  if ((v45 | 2) == 6 && v44 == 4 && (v151 = *MEMORY[0x277D0F298], v157 = *(MEMORY[0x277D0F298] + 16), HMFOperatingSystemVersionCompare() != 1) && [v40 isNetworkDiagnosticsEnabled])
  {
    v46 = [v40 isWifiPickerApiEnabled];
    v47 = 0x8000000000;
    if (!v46)
    {
      v47 = 0;
    }

    v97 = v47;
  }

  else
  {
    v97 = 0;
  }

  v48 = v40;
  v49 = v41;
  v50 = [v49 softwareVersion];
  v51 = v50;
  if (v50)
  {
    [v50 operatingSystemVersion];
  }

  v52 = [v49 productPlatform];
  v53 = [v49 productClass];

  v54 = 0;
  v98 = v49;
  if (v53 == 6 && v52 == 4)
  {
    v152 = *MEMORY[0x277D0F298];
    v158 = *(MEMORY[0x277D0F298] + 16);
    if (HMFOperatingSystemVersionCompare() == 1)
    {
      v54 = 0;
    }

    else
    {
      v55 = [v48 isCrossfadeAsAirplaySourceEnabled];
      v54 = 0x10000000000;
      if (!v55)
      {
        v54 = 0;
      }
    }
  }

  v96 = v54;
  v56 = 0x200000000;
  if (!v100)
  {
    v56 = 0;
  }

  v101 = v56;
  v57 = 0x100000000;
  if (!v103)
  {
    v57 = 0;
  }

  v104 = v57;
  if (v106)
  {
    v58 = 0x40000000;
  }

  else
  {
    v58 = 0;
  }

  v59 = 0x20000000;
  if (!v108)
  {
    v59 = 0;
  }

  v107 = v58;
  v109 = v59;
  if (v110)
  {
    v60 = 0x8000000;
  }

  else
  {
    v60 = 0;
  }

  v61 = 0x4000000;
  if (!v112)
  {
    v61 = 0;
  }

  v111 = v60;
  v113 = v61;
  if (v114)
  {
    v62 = 0x2000000;
  }

  else
  {
    v62 = 0;
  }

  v63 = 0x1000000;
  if (!v116)
  {
    v63 = 0;
  }

  v115 = v62;
  v117 = v63;
  v64 = 0x800000;
  if (!v13)
  {
    v64 = 0;
  }

  v95 = v64;
  if (v118)
  {
    v65 = 0x400000;
  }

  else
  {
    v65 = 0;
  }

  v66 = 0x200000;
  if (!v120)
  {
    v66 = 0;
  }

  v119 = v65;
  v121 = v66;
  if (v123)
  {
    v67 = 0x100000;
  }

  else
  {
    v67 = 0;
  }

  v68 = 0x80000;
  if (!v125)
  {
    v68 = 0;
  }

  v124 = v67;
  v126 = v68;
  if (v127)
  {
    v69 = 0x20000;
  }

  else
  {
    v69 = 0;
  }

  v70 = 0x10000;
  if (!v129)
  {
    v70 = 0;
  }

  v128 = v69;
  v130 = v70;
  if (v131)
  {
    v71 = 0x4000;
  }

  else
  {
    v71 = 0;
  }

  v72 = 0x2000;
  if (!v133)
  {
    v72 = 0;
  }

  v132 = v71;
  v134 = v72;
  v73 = 4096;
  if (!v135)
  {
    v73 = 0;
  }

  v136 = v73;
  v74 = 2048;
  if (!v12)
  {
    v74 = 0;
  }

  v94 = v74;
  if (v137)
  {
    v75 = 1024;
  }

  else
  {
    v75 = 0;
  }

  if (v11)
  {
    v76 = 512;
  }

  else
  {
    v76 = 0;
  }

  if (v138)
  {
    v77 = 256;
  }

  else
  {
    v77 = 0;
  }

  if (v10)
  {
    v78 = 128;
  }

  else
  {
    v78 = 0;
  }

  v79 = 2;
  if (!v144)
  {
    v79 = 0;
  }

  v80 = v79 | v145;
  v81 = 4;
  if (!v143)
  {
    v81 = 0;
  }

  v82 = 8;
  if (!v141)
  {
    v82 = 0;
  }

  v83 = v80 | v81 | v82;
  v84 = 16;
  if (!v142)
  {
    v84 = 0;
  }

  v85 = 32;
  if (!v140)
  {
    v85 = 0;
  }

  v86 = v48;
  v87 = v84 | v85;
  if (v139)
  {
    v88 = 64;
  }

  else
  {
    v88 = 0;
  }

  v89 = v83 | v87 | v88 | v78 | v77 | v76 | v75 | v94 | v136 | v134 | v132 | v130 | v128 | v126 | v124 | v121 | v119 | v95 | v117 | v115 | v113 | v111 | v109 | v107 | v122 | v104 | v101 | v105 | (((v25 & 0xFFFFFFFFFFFFFFFDLL) == 4) << 35);
  v90 = objc_alloc(MEMORY[0x277CD1678]);
  v91 = [MEMORY[0x277CCAD78] UUID];
  v92 = [v90 initWithTagUUID:v91 capabilities:v89 | v102 | v99 | v97 | v96];

  return v92;
}

- (id)currentAccessoryHomeUUID
{
  v2 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  if (v4)
  {
    v5 = [v4 home];
    v6 = [v5 uuid];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

- (id)currentAccessoryUUID
{
  v2 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  if (v4)
  {
    v5 = [v4 uuid];
  }

  else
  {
    v5 = 0;
  }

  return v5;
}

- (id)currentAccessoryHome
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  if (v3)
  {
    v4 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
    v5 = [v4 home];
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to get current accessory home due to no current accessory", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v5 = 0;
  }

  v10 = *MEMORY[0x277D85DE8];

  return v5;
}

- (id)currentMediaGroupsAggregateConsumer
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self currentAccessoryHome];
  v4 = v3;
  if (v3)
  {
    v5 = [v3 mediaGroupsAggregateConsumer];
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to get current media groups aggregate consumer due to no current accessory home", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v5 = 0;
  }

  v10 = *MEMORY[0x277D85DE8];

  return v5;
}

- (void)mediaGroupParticipantLocalDataStorage:(id)a3 didChangeDestinationIdentifier:(id)a4 forDestinationControllerIdentifier:(id)a5
{
  v20 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = [(HMDHomeManager *)self currentMediaGroupsAggregateConsumer];
  v12 = v11;
  if (v11)
  {
    if (v9)
    {
      [v11 unstageNullDestinationForCurrentDestinationController];
    }

    else
    {
      [v11 stageNullDestinationForCurrentDestinationControllerIdentifier:v10];
    }
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@Failed to stage current destination controller change due to no current consumer", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (id)topicNameForMediaGroupParticipantDataLocalStorage:(id)a3
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  v6 = v5;
  if (v5)
  {
    v7 = [v5 home];
    v8 = v7;
    if (v7)
    {
      v9 = MEMORY[0x277CD16F0];
      v10 = *MEMORY[0x277CCEA70];
      v11 = [v7 uuid];
      v12 = [v6 uuid];
      v13 = [v9 topicFromSuffixID:v10 homeUUID:v11 accessoryUUID:v12];
    }

    else
    {
      v18 = objc_autoreleasePoolPush();
      v19 = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
      {
        v21 = HMFGetLogIdentifier();
        v24 = 138543362;
        v25 = v21;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Failed to get media group participant data topic name due to no home on current accessory", &v24, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      v13 = 0;
    }
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
    {
      v17 = HMFGetLogIdentifier();
      v24 = 138543362;
      v25 = v17;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Failed to get media group participant data topic name due to no current accessory", &v24, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
    v13 = 0;
  }

  v22 = *MEMORY[0x277D85DE8];

  return v13;
}

- (BOOL)isStartThreadNetworkInProgress
{
  v25 = *MEMORY[0x277D85DE8];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v3 = [(HMDHomeManager *)self homes];
  v4 = [v3 countByEnumeratingWithState:&v16 objects:v24 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v17;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v17 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v16 + 1) + 8 * i);
        if ([v8 startThreadNetworkInProgress])
        {
          v10 = objc_autoreleasePoolPush();
          v11 = self;
          v12 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
          {
            v13 = HMFGetLogIdentifier();
            *buf = 138543618;
            v21 = v13;
            v22 = 2112;
            v23 = v8;
            _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@thread start in progress for %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v10);
          v9 = 1;
          goto LABEL_13;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v16 objects:v24 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  v9 = 0;
LABEL_13:

  v14 = *MEMORY[0x277D85DE8];
  return v9;
}

- (BOOL)isCurrentResidentDeviceRunningThreadNetwork:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  if (a3)
  {
    v11 = 0u;
    v12 = 0u;
    v9 = 0u;
    v10 = 0u;
    v3 = [(HMDHomeManager *)self homes];
    v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
    if (v4)
    {
      v5 = *v10;
      while (2)
      {
        for (i = 0; i != v4; ++i)
        {
          if (*v10 != v5)
          {
            objc_enumerationMutation(v3);
          }

          if ([*(*(&v9 + 1) + 8 * i) isCurrentDeviceAvailableResident])
          {
            LOBYTE(v4) = 1;
            goto LABEL_12;
          }
        }

        v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
        if (v4)
        {
          continue;
        }

        break;
      }
    }

LABEL_12:
  }

  else
  {
    LOBYTE(v4) = 0;
  }

  v7 = *MEMORY[0x277D85DE8];
  return v4;
}

- (id)setupSessionIdentifierForAccessoryUUID:(id)a3 outStartTime:(double *)a4
{
  v5 = [(HMDHomeManager *)self accessorySetupMetricDispatcherForAccessoryUUID:a3];
  v6 = v5;
  if (v5)
  {
    if (a4)
    {
      v7 = [v5 trackingInfo];
      *a4 = [v7 startTime];
    }

    v8 = [v6 setupSessionIdentifier];
  }

  else
  {
    v8 = 0;
    if (a4)
    {
      *a4 = 0.0;
    }
  }

  return v8;
}

- (id)accessorySetupMetricDispatchersForHome:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __57__HMDHomeManager_accessorySetupMetricDispatchersForHome___block_invoke;
  v9[3] = &unk_279732E08;
  v6 = v4;
  v10 = v6;
  v7 = [(NSMutableArray *)accessorySetupMetricDispatchers na_filter:v9];

  os_unfair_lock_unlock(&self->_lock);

  return v7;
}

- (id)firstSetupSessionIdentifierOutputStartTime:(double *)a3
{
  os_unfair_lock_lock_with_options();
  if ([(NSMutableArray *)self->_accessorySetupMetricDispatchers count])
  {
    v5 = [(NSMutableArray *)self->_accessorySetupMetricDispatchers firstObject];
    v6 = v5;
    if (a3)
    {
      v7 = [v5 trackingInfo];
      *a3 = [v7 startTime];
    }

    v8 = [v6 setupSessionIdentifier];
  }

  else
  {
    v8 = 0;
    if (a3)
    {
      *a3 = 0.0;
    }
  }

  os_unfair_lock_unlock(&self->_lock);

  return v8;
}

- (void)removeAccessorySetupMetricDispatcherForAccessoryUUID:(id)a3
{
  v4 = a3;
  if (v4)
  {
    os_unfair_lock_lock_with_options();
    accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __71__HMDHomeManager_removeAccessorySetupMetricDispatcherForAccessoryUUID___block_invoke;
    v7[3] = &unk_279732E08;
    v8 = v4;
    v6 = [(NSMutableArray *)accessorySetupMetricDispatchers na_firstObjectPassingTest:v7];
    if (v6)
    {
      [(NSMutableArray *)self->_accessorySetupMetricDispatchers removeObject:v6];
    }

    os_unfair_lock_unlock(&self->_lock);
  }
}

uint64_t __71__HMDHomeManager_removeAccessorySetupMetricDispatcherForAccessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 trackingInfo];
  v4 = [v3 accessoryUUID];
  v5 = [v4 hmf_isEqualToUUID:*(a1 + 32)];

  return v5;
}

- (void)addAccessorySetupMetricDispatcher:(id)a3
{
  v7 = a3;
  os_unfair_lock_lock_with_options();
  if (!self->_accessorySetupMetricDispatchers)
  {
    v4 = [MEMORY[0x277CBEB18] array];
    accessorySetupMetricDispatchers = self->_accessorySetupMetricDispatchers;
    self->_accessorySetupMetricDispatchers = v4;
  }

  v6 = [(HMDHomeManager *)self accessorySetupMetricDispatchers];
  [v6 addObject:v7];

  os_unfair_lock_unlock(&self->_lock);
}

- (id)accessorySetupMetricDispatcherForAccessoryUUID:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  v5 = [(HMDHomeManager *)self accessorySetupMetricDispatchers];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __65__HMDHomeManager_accessorySetupMetricDispatcherForAccessoryUUID___block_invoke;
  v9[3] = &unk_279732E08;
  v6 = v4;
  v10 = v6;
  v7 = [v5 na_firstObjectPassingTest:v9];

  os_unfair_lock_unlock(&self->_lock);

  return v7;
}

uint64_t __65__HMDHomeManager_accessorySetupMetricDispatcherForAccessoryUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 trackingInfo];
  v4 = [v3 accessoryUUID];
  v5 = [v4 hmf_isEqualToUUID:*(a1 + 32)];

  return v5;
}

- (void)_handleEnableUARPPacketCaptureRequest:(id)a3
{
  v25 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 BOOLForKey:*MEMORY[0x277CD0190]];
  v6 = [v4 stringForKey:*MEMORY[0x277CD01A0]];
  v7 = v6;
  if (v5)
  {
    v8 = v6 == 0;
  }

  else
  {
    v8 = 0;
  }

  if (!v8)
  {
    v9 = [(HMDHomeManager *)self accessoryFirmwareUpdateManager];
    v10 = v9;
    if (v5)
    {
      v11 = [v9 startUARPPacketCapture:v7];

      if ((v11 & 1) == 0)
      {
        v12 = objc_autoreleasePoolPush();
        v13 = self;
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
        {
          v15 = HMFGetLogIdentifier();
          v21 = 138543618;
          v22 = v15;
          v23 = 2112;
          v24 = @"Request to enable UARP packet capture failed";
          v16 = "%{public}@%@";
          v17 = v14;
          v18 = 22;
LABEL_11:
          _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, v16, &v21, v18);

          goto LABEL_12;
        }

        goto LABEL_12;
      }
    }

    else
    {
      [v9 stopUARPPacketCapture];
    }

    [v4 respondWithSuccess];
    goto LABEL_15;
  }

  v12 = objc_autoreleasePoolPush();
  v13 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    v15 = HMFGetLogIdentifier();
    v21 = 138543362;
    v22 = v15;
    v16 = "%{public}@Request to enable UARP packet capture is missing capture path";
    v17 = v14;
    v18 = 12;
    goto LABEL_11;
  }

LABEL_12:

  objc_autoreleasePoolPop(v12);
  v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [v4 respondWithError:v19];

LABEL_15:
  v20 = *MEMORY[0x277D85DE8];
}

- (void)_handleHH2SentinelZonePresent:(id)a3
{
  v13 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v11 = 138543362;
    v12 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@HH2 sentinel zone detected", &v11, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 uuid];
  [(HMDHomeManager *)v6 updateGenerationCounterWithReason:@"HH2 sentinel zone detected" sourceUUID:v9 shouldNotifyClients:1];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)handleSiriSyncDataRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __44__HMDHomeManager_handleSiriSyncDataRequest___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)assistantSyncDataChanged:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __43__HMDHomeManager_assistantSyncDataChanged___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)setPostSyncDataUpdatedNotification:(BOOL)a3
{
  os_unfair_lock_lock_with_options();
  self->_postSyncDataUpdatedNotification = a3;

  os_unfair_lock_unlock(&self->_lock);
}

- (BOOL)postSyncDataUpdatedNotification
{
  os_unfair_lock_lock_with_options();
  postSyncDataUpdatedNotification = self->_postSyncDataUpdatedNotification;
  os_unfair_lock_unlock(&self->_lock);
  return postSyncDataUpdatedNotification;
}

- (void)_handleCurrentAccessoryAddedNotification:(id)a3
{
  v4 = [(HMDHomeManager *)self capabilitiesController];
  [v4 currentAccessoryDidBecomeAvailable];

  [(HMDHomeManager *)self _updateCurrentHomeIfNecessary];
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __59__HMDHomeManager__handleCurrentAccessoryAddedNotification___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v5, block);
}

- (void)_handleCurrentAccessoryRemovedNotification:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __61__HMDHomeManager__handleCurrentAccessoryRemovedNotification___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __61__HMDHomeManager__handleCurrentAccessoryRemovedNotification___block_invoke(uint64_t a1)
{
  v27 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 hmf_UUIDForKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

  if (v3)
  {
    v4 = *(a1 + 40);
    os_unfair_lock_lock_with_options();
    v5 = [*(a1 + 40) lastRemovedCurrentAccessoryUUID];
    v6 = [v3 hmf_isEqualToUUID:v5];

    if (v6)
    {
      os_unfair_lock_unlock(v4 + 6);
      v7 = [*(a1 + 40) capabilitiesController];
      [v7 didRemoveCurrentAccessory:v3];
    }

    else
    {
      [*(a1 + 40) setLastRemovedCurrentAccessoryUUID:v3];
      os_unfair_lock_unlock(v4 + 6);
      v13 = [*(a1 + 40) capabilitiesController];
      [v13 didRemoveCurrentAccessory:v3];

      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 40);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = HMFGetLogIdentifier();
        v23 = 138543618;
        v24 = v17;
        v25 = 2112;
        v26 = v3;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Last removed current accessory changed to %@", &v23, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v18 = [*(a1 + 40) userDefaults];
      v19 = [v3 UUIDString];
      [v18 setObject:v19 forKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

      [*(a1 + 40) resetTTSUHH2SettingsMigrationKey];
      v20 = *(a1 + 40);
      v21 = [v20 uuid];
      [v20 _updateGenerationCounterWithReason:@"CurrentAccessoryRemoved" sourceUUID:v21 shouldNotifyClients:1];
    }

    [*(a1 + 40) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 40);
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = *(a1 + 32);
      v23 = 138543618;
      v24 = v11;
      v25 = 2112;
      v26 = v12;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_ERROR, "%{public}@Last removed current accessory uuid missing from notification : %@", &v23, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (unint64_t)numHomes
{
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 count];

  return v3;
}

- (BOOL)isSignedIntoiCloud
{
  v2 = +[HMDAppleAccountManager sharedManager];
  v3 = [v2 isLoggedInToPrimaryAccount];

  return v3;
}

- (id)delegatingRouter:(id)a3 filteredTopics:(id)a4 forRouter:(id)a5
{
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = objc_autoreleasePoolPush();
  v12 = [MEMORY[0x277CBEA60] array];
  v13 = [(HMDHomeManager *)self registrationForwardingEventRouter];

  if (v13 == v8)
  {
    v14 = v10;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v15 = v14;
    }

    else
    {
      v15 = 0;
    }

    v16 = v15;

    v17 = [(HMDHomeManager *)self memoryEventRouter];
    v18 = [v17 synchronousSubscriptionProvider];

    if (v18 == v14)
    {
      v21 = v9;
    }

    else
    {
      if (!v16)
      {
        goto LABEL_11;
      }

      v19 = [v16 identifier];

      if (!v19)
      {
        goto LABEL_11;
      }

      v20 = [v16 identifier];
      v21 = [HMDHomeEventsGenerated forwardingTopicsWithTopics:v9 forHomeRouterWithUUID:v20];

      v12 = v20;
    }

    v12 = v21;
LABEL_11:
  }

  objc_autoreleasePoolPop(v11);

  return v12;
}

- (id)_currentHome
{
  v21 = *MEMORY[0x277D85DE8];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v3 = [(HMDHomeManager *)self homes];
  v4 = [v3 countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v17;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v17 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v16 + 1) + 8 * i);
        v9 = [v8 uuid];
        v10 = [(HMDHomeManager *)self currentHomeUUID];
        v11 = [v9 hmf_isEqualToUUID:v10];

        if (v11)
        {
          v12 = v8;
          goto LABEL_11;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v16 objects:v20 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  v3 = [(HMDHomeManager *)self homes];
  v12 = [v3 firstObject];
LABEL_11:
  v13 = v12;

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (BOOL)isNetworkConnectionAvailable
{
  v3 = [(HMDHomeManager *)self reachabilityMonitor];

  if (!v3)
  {
    return 0;
  }

  v4 = [(HMDHomeManager *)self reachabilityMonitor];
  v5 = [v4 isReachable];

  return v5;
}

- (BOOL)isCloudAccountActive
{
  v2 = [(HMDHomeManager *)self cloudDataSyncManager];
  v3 = [v2 accountActive];

  return v3;
}

- (BOOL)legacyZoneHasRecordsAvailable
{
  v2 = [(HMDHomeManager *)self cloudDataSyncManager];
  v3 = [v2 legacyZoneHasRecordsAvailable];

  return v3;
}

- (void)multiUserStatusController:(id)a3 statusDidChange:(int64_t)a4
{
  v5 = [(HMDHomeManager *)self uuid:a3];
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"MultiUserStatusChanged" sourceUUID:v5 shouldNotifyClients:1];
}

- (void)handleRemoteUserClientCloudShareRepairRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self userCloudShareManager];
  [v5 handleRemoteUserClientCloudShareRepairRequest:v4];
}

- (void)handleRemoteUserClientCloudShareRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self userCloudShareManager];
  [v5 handleRemoteUserClientCloudShareRequest:v4];
}

- (void)_cleanChangesIfNoAddChangeObjectID:(id)a3 completion:(id)a4
{
  v48 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  if (v6)
  {
    *&v45 = 0;
    *(&v45 + 1) = &v45;
    v46 = 0x2020000000;
    v47 = 0;
    v8 = [MEMORY[0x277CBEB58] set];
    objc_initWeak(&location, self);
    v9 = [HMDBackingStoreLogFetchOperation alloc];
    v35[0] = MEMORY[0x277D85DD0];
    v35[1] = 3221225472;
    v35[2] = __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke;
    v35[3] = &unk_279732D90;
    objc_copyWeak(&v39, &location);
    v10 = v6;
    v36 = v10;
    v11 = v8;
    v37 = v11;
    v38 = &v45;
    v12 = [(HMDBackingStoreLogFetchOperation *)v9 initWithNeedsPushTo:2 result:v35];
    v26 = MEMORY[0x277D85DD0];
    v27 = 3221225472;
    v28 = __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke_1574;
    v29 = &unk_279732DE0;
    objc_copyWeak(&v34, &location);
    v33 = &v45;
    v13 = v11;
    v30 = v13;
    v14 = v10;
    v31 = v14;
    v32 = v7;
    [(HMDBackingStoreOperation *)v12 setResultBlock:&v26];
    v15 = objc_autoreleasePoolPush();
    v16 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_DEBUG))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543618;
      v42 = v18;
      v43 = 2112;
      v44 = v14;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_DEBUG, "%{public}@Cleaning of objects for %@ from home manager datastore started", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    v19 = [(HMDHomeManager *)v16 backingStore:v26];
    [v19 submit:v12];

    objc_destroyWeak(&v34);
    objc_destroyWeak(&v39);
    objc_destroyWeak(&location);

    _Block_object_dispose(&v45, 8);
  }

  else
  {
    v20 = objc_autoreleasePoolPush();
    v21 = self;
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
    {
      v23 = HMFGetLogIdentifier();
      LODWORD(v45) = 138543362;
      *(&v45 + 4) = v23;
      _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_ERROR, "%{public}@ObjectID must be defined", &v45, 0xCu);
    }

    objc_autoreleasePoolPop(v20);
    v24 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    (*(v7 + 2))(v7, 0, v24);
  }

  v25 = *MEMORY[0x277D85DE8];
}

uint64_t __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v44 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  v38 = 0u;
  v11 = v7;
  v12 = [v11 countByEnumeratingWithState:&v35 objects:v43 count:16];
  if (v12)
  {
    v13 = v12;
    v32 = v9;
    v33 = v8;
    v14 = *v36;
    v34 = a1;
    while (2)
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v36 != v14)
        {
          objc_enumerationMutation(v11);
        }

        v16 = *(*(&v35 + 1) + 8 * i);
        v17 = [v16 uuid];
        v18 = [v17 isEqual:*(a1 + 32)];

        if (v18)
        {
          if ([v16 objectChangeType] == 1 && !objc_msgSend(*(a1 + 40), "count"))
          {
            v29 = 0;
            *(*(*(a1 + 48) + 8) + 24) = 1;
            goto LABEL_16;
          }

          v19 = objc_autoreleasePoolPush();
          v20 = WeakRetained;
          v21 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v21, OS_LOG_TYPE_DEBUG))
          {
            HMFGetLogIdentifier();
            v22 = v13;
            v23 = v14;
            v24 = v11;
            v26 = v25 = WeakRetained;
            *buf = 138543618;
            v40 = v26;
            v41 = 2112;
            v42 = v16;
            _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_DEBUG, "%{public}@Removing object change from home manager transaction store %@", buf, 0x16u);

            WeakRetained = v25;
            v11 = v24;
            v14 = v23;
            v13 = v22;
            a1 = v34;
          }

          objc_autoreleasePoolPop(v19);
          v27 = *(a1 + 40);
          v28 = [MEMORY[0x277CCABB0] numberWithUnsignedLongLong:{objc_msgSend(v16, "bsoLogRowID")}];
          [v27 addObject:v28];
        }
      }

      v13 = [v11 countByEnumeratingWithState:&v35 objects:v43 count:16];
      if (v13)
      {
        continue;
      }

      break;
    }

    v29 = 1;
LABEL_16:
    v9 = v32;
    v8 = v33;
  }

  else
  {
    v29 = 1;
  }

  v30 = *MEMORY[0x277D85DE8];
  return v29;
}

void __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke_1574(uint64_t a1, void *a2)
{
  v31 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  v5 = WeakRetained;
  if (v3 || !WeakRetained || (*(*(*(a1 + 56) + 8) + 24) & 1) != 0 || ![*(a1 + 32) count])
  {
    v17 = *(a1 + 48);
    if (v17)
    {
      (*(v17 + 16))(v17, *(*(*(a1 + 56) + 8) + 24), v3);
    }
  }

  else
  {
    v6 = [HMDBackingStoreLogUpdateOperation alloc];
    v7 = [*(a1 + 32) allObjects];
    v8 = [(HMDBackingStoreLogUpdateOperation *)v6 initWithRowIDs:v7 successfullyPushedTo:3];

    v19 = MEMORY[0x277D85DD0];
    v20 = 3221225472;
    v21 = __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke_2;
    v22 = &unk_279732DB8;
    objc_copyWeak(&v26, (a1 + 64));
    v23 = *(a1 + 40);
    v9 = *(a1 + 48);
    v10 = *(a1 + 56);
    v24 = v9;
    v25 = v10;
    [(HMDBackingStoreOperation *)v8 setResultBlock:&v19];
    v11 = objc_autoreleasePoolPush();
    v12 = v5;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEBUG))
    {
      v14 = HMFGetLogIdentifier();
      v15 = *(a1 + 40);
      *buf = 138543618;
      v28 = v14;
      v29 = 2112;
      v30 = v15;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of objects for %@ in home manager datastore", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v16 = [v12 backingStore];
    [v16 submit:v8];

    objc_destroyWeak(&v26);
  }

  v18 = *MEMORY[0x277D85DE8];
}

void __64__HMDHomeManager__cleanChangesIfNoAddChangeObjectID_completion___block_invoke_2(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v9 = *(a1 + 32);
    v12 = 138543618;
    v13 = v8;
    v14 = 2112;
    v15 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Cleaned objects for %@ in home manager datastore", &v12, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = *(a1 + 40);
  if (v10)
  {
    (*(v10 + 16))(v10, *(*(*(a1 + 48) + 8) + 24), v3);
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (id)modelObjectWithChangeType:(unint64_t)a3 version:(int64_t)a4
{
  v6 = objc_opt_class();
  v7 = [(HMDHomeManager *)self uuid];
  v8 = [v6 emptyModelObjectWithChangeType:a3 homeManagerUUID:v7];

  v9 = [(HMDHomeManager *)self primaryHomeUUID];

  if (v9)
  {
    v10 = [(HMDHomeManager *)self primaryHomeUUID];
    v11 = [v10 UUIDString];
    [v8 setPrimaryHomeUUID:v11];
  }

  v12 = [(HMDHomeManager *)self cloudZones];
  v13 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:v12];
  [v8 setCloudZoneInformation:v13];

  return v8;
}

- (id)backingStoreObjects:(int64_t)a3
{
  v5 = [MEMORY[0x277CBEB18] array];
  v6 = [(HMDHomeManager *)self modelObjectWithChangeType:1 version:a3];
  [v5 addObject:v6];

  if (a3 >= 3)
  {
    v7 = [(HMDHomeManager *)self appData];

    if (v7)
    {
      v8 = [(HMDHomeManager *)self appData];
      v9 = [v8 modelObjectWithChangeType:1];
      [v5 addObject:v9];
    }
  }

  return v5;
}

- (void)transactionObjectRemoved:(id)a3 message:(id)a4
{
  v41 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v37 = 138543618;
    v38 = v11;
    v39 = 2112;
    v40 = v6;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@transactionObjectRemoved: %@", &v37, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v12 = v6;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v13 = v12;
  }

  else
  {
    v13 = 0;
  }

  v14 = v13;

  if (v14)
  {
    [(HMDHomeManager *)v9 processHomeModelRemoved:v14 message:v7];
LABEL_38:

    goto LABEL_39;
  }

  v15 = v12;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v16 = v15;
  }

  else
  {
    v16 = 0;
  }

  v17 = v16;

  if (v17)
  {
    [(HMDHomeManager *)v9 processSharedHomeModelRemoved:v17 message:v7];
    goto LABEL_38;
  }

  v18 = v15;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v19 = v18;
  }

  else
  {
    v19 = 0;
  }

  v20 = v19;

  if (v20)
  {
    [(HMDHomeManager *)v9 _processRemoveUserManagementOperationModel:v20 message:v7];
    goto LABEL_38;
  }

  v21 = v18;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v22 = v21;
  }

  else
  {
    v22 = 0;
  }

  v23 = v22;

  if (v23)
  {
    [(HMDHomeManager *)v9 processCloudZoneModelRemoved:v23 message:v7];
    goto LABEL_38;
  }

  v24 = v21;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v25 = v24;
  }

  else
  {
    v25 = 0;
  }

  v26 = v25;

  if (v26)
  {
    [(HMDHomeManager *)v9 processAppDataModelRemove:v26 message:v7];
    goto LABEL_38;
  }

  v27 = v24;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v28 = v27;
  }

  else
  {
    v28 = 0;
  }

  v29 = v28;

  if (v29)
  {
    v30 = [(HMDHomeManager *)v9 appleAccountManager];
    v31 = [v30 account];
    v32 = [v31 modelIdentifier];
    v33 = [v29 uuid];
    if ([v32 isEqual:v33])
    {
    }

    else
    {
      v34 = [v30 isModelCurrentAccount:v29];

      if ((v34 & 1) == 0)
      {
        v35 = [(HMDHomeManager *)v9 remoteAccountManager];
        [v35 processAccountModelRemove:v29 message:v7];

        goto LABEL_37;
      }
    }

    [v30 processAccountModelRemove:v29 message:v7];
LABEL_37:

    goto LABEL_38;
  }

LABEL_39:

  v36 = *MEMORY[0x277D85DE8];
}

- (void)transactionObjectUpdated:(id)a3 newValues:(id)a4 message:(id)a5
{
  v55 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = v9;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v12 = v11;
  }

  else
  {
    v12 = 0;
  }

  v13 = v12;

  if (v13)
  {
    v14 = [v13 uuid];
    v15 = [(HMDHomeManager *)self _homeWithUUID:v14];

    if (v15)
    {
      [v15 transactionObjectUpdated:v13 newValues:v11 message:v10];
    }

    else
    {
      [(HMDHomeManager *)self processHomeModelAdd:v13 message:v10];
      if (+[HMDHAPMetadata shouldUploadToCloudAfterHomedReady])
      {
        v19 = [(HMDHomeManager *)self homes];
        v20 = [v19 count];

        if (v20 == 1)
        {
          v21 = objc_autoreleasePoolPush();
          v22 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
          {
            v23 = HMFGetLogIdentifier();
            v53 = 138543362;
            v54 = v23;
            _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@This is the first home being added and metadata upload flag is set.", &v53, 0xCu);
          }

          objc_autoreleasePoolPop(v21);
          [(HMDHomeManager *)self evaluateToPushMetadataWhenHomeKitInUse];
        }
      }
    }

    goto LABEL_17;
  }

  v16 = v11;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v17 = v16;
  }

  else
  {
    v17 = 0;
  }

  v18 = v17;

  if (v18)
  {
    [(HMDHomeManager *)self processSharedHomeModelUpdate:v18 message:v10];
LABEL_18:

    goto LABEL_19;
  }

  v25 = v16;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v26 = v25;
  }

  else
  {
    v26 = 0;
  }

  v27 = v26;

  if (v27)
  {
    [(HMDHomeManager *)self processHomeManagerModelUpdate:v27 message:v10];
    goto LABEL_18;
  }

  v28 = v25;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v29 = v28;
  }

  else
  {
    v29 = 0;
  }

  v30 = v29;

  if (v30)
  {
    v31 = [v30 parentUUID];
    v32 = [(HMDHomeManager *)self _homeWithUUID:v31];

    [v32 transactionObjectUpdated:v8 newValues:v30 message:v10];
    goto LABEL_18;
  }

  v33 = v28;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v34 = v33;
  }

  else
  {
    v34 = 0;
  }

  v35 = v34;

  if (v35)
  {
    [(HMDHomeManager *)self _processUserManagementOperationModel:v35 message:v10];
    goto LABEL_18;
  }

  v36 = v33;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v37 = v36;
  }

  else
  {
    v37 = 0;
  }

  v38 = v37;

  if (v38)
  {
    [(HMDHomeManager *)self processCloudZoneModelAdd:v38 message:v10];
    goto LABEL_18;
  }

  v39 = v36;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v40 = v39;
  }

  else
  {
    v40 = 0;
  }

  v41 = v40;

  if (v41)
  {
    [(HMDHomeManager *)self processAppDataModelUpdate:v41 message:v10];
    goto LABEL_18;
  }

  v42 = v39;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v43 = v42;
  }

  else
  {
    v43 = 0;
  }

  v44 = v43;

  if (v44)
  {
    [(HMDHomeManager *)self processMetadataModel:v44 message:v10];
    goto LABEL_18;
  }

  v45 = v42;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v46 = v45;
  }

  else
  {
    v46 = 0;
  }

  v47 = v46;

  if (v47)
  {
    v15 = [(HMDHomeManager *)self appleAccountManager];
    v48 = [v15 account];
    v49 = [v48 modelIdentifier];
    v50 = [v47 uuid];
    if ([v49 isEqual:v50])
    {
    }

    else
    {
      v51 = [v15 isModelCurrentAccount:v47];

      if ((v51 & 1) == 0)
      {
        v52 = [(HMDHomeManager *)self remoteAccountManager];
        [v52 processAccountModel:v47 message:v10];

        goto LABEL_17;
      }
    }

    [v15 processAccountModel:v47 message:v10];
LABEL_17:

    goto LABEL_18;
  }

LABEL_19:

  v24 = *MEMORY[0x277D85DE8];
}

- (id)userWithMergeID:(id)a3
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) userWithMergeID:v4];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (void)archiveServerToken:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __37__HMDHomeManager_archiveServerToken___block_invoke;
  block[3] = &unk_279735D00;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, block);
}

- (void)_remoteAccessHealthMonitorTimerDidFire:(id)a3
{
  v21 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    *buf = 138543362;
    v20 = v7;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@Remote access health monitor timer fired, checking state for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v16 = 0u;
  v17 = 0u;
  v14 = 0u;
  v15 = 0u;
  v8 = [(HMDHomeManager *)self homes];
  v9 = [v8 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v15;
    do
    {
      v12 = 0;
      do
      {
        if (*v15 != v11)
        {
          objc_enumerationMutation(v8);
        }

        [*(*(&v14 + 1) + 8 * v12++) remoteAccessHealthMonitorTimerDidFire];
      }

      while (v10 != v12);
      v10 = [v8 countByEnumeratingWithState:&v14 objects:v18 count:16];
    }

    while (v10);
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (void)timerDidFire:(id)a3
{
  v57 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = [(HMDHomeManager *)self watchSyncRetryContextByRetryTimer];
  v7 = [v6 objectForKey:v4];

  if (v7)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v51 = 138543874;
      v52 = v11;
      v53 = 2112;
      v54 = v7;
      v55 = 2112;
      v56 = v4;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Retrying watch sync with retry context:%@ when timer fired: %@", &v51, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v12 = [(HMDHomeManager *)v9 watchSyncRetryContextByRetryTimer];
    [v12 removeObjectForKey:v4];

    v13 = [HMDWatchSync alloc];
    v14 = [v7 watchSync];
    v15 = [v14 identifier];
    v16 = [v7 watchSync];
    v17 = -[HMDWatchSync initWithIdentifier:syncOption:](v13, "initWithIdentifier:syncOption:", v15, [v16 syncOption]);

    v18 = [v7 watchIdentifier];
    [(HMDHomeManager *)v9 _addSyncOperation:v17 forWatchWithIdentifier:v18];
  }

  else
  {
    v20 = [(HMDHomeManager *)self remoteAccessHealthMonitorTimer];

    if (v20 == v4)
    {
      [(HMDHomeManager *)self _remoteAccessHealthMonitorTimerDidFire:v4];
    }

    else
    {
      v21 = [(HMDHomeManager *)self watchPushDelayTimer];

      if (v21 == v4)
      {
        v31 = objc_autoreleasePoolPush();
        v32 = self;
        v33 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
        {
          v34 = HMFGetLogIdentifier();
          v51 = 138543362;
          v52 = v34;
          _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_DEFAULT, "%{public}@Watch push delay timer fired, pushing to watches", &v51, 0xCu);
        }

        objc_autoreleasePoolPop(v31);
        [(HMDHomeManager *)v32 _sendHomeDataToAllWatchesWithCompletion:0];
      }

      else
      {
        v22 = [(HMDHomeManager *)self sharedHomesPushDelayTimer];

        if (v22 == v4)
        {
          v35 = objc_autoreleasePoolPush();
          v36 = self;
          v37 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
          {
            v38 = HMFGetLogIdentifier();
            v51 = 138543362;
            v52 = v38;
            _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_DEFAULT, "%{public}@Shared homed push delay timer fired, pushing to shared users", &v51, 0xCu);
          }

          objc_autoreleasePoolPop(v35);
          [(HMDHomeManager *)v36 _pushChangesToAllUsersOfAllHomes];
        }

        else
        {
          v23 = [(HMDHomeManager *)self homeUpgradeRecommendationTimer];

          if (v23 == v4)
          {
            v39 = objc_autoreleasePoolPush();
            v40 = self;
            v41 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
            {
              v42 = HMFGetLogIdentifier();
              v51 = 138543362;
              v52 = v42;
              _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_DEFAULT, "%{public}@Timer fired to postHH2UpgradeRecommendationBulletin", &v51, 0xCu);
            }

            objc_autoreleasePoolPop(v39);
            [(HMDHomeManager *)v40 postHH2UpgradeRecommendationBulletin];
          }

          else
          {
            v24 = [(HMDHomeManager *)self debounceHomesUpdateTimer];

            if (v24 == v4)
            {
              v43 = objc_autoreleasePoolPush();
              v44 = self;
              v45 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT))
              {
                v46 = HMFGetLogIdentifier();
                v51 = 138543362;
                v52 = v46;
                _os_log_impl(&dword_2531F8000, v45, OS_LOG_TYPE_DEFAULT, "%{public}@Debounce homes update timer has fired, posting homed did update notification", &v51, 0xCu);
              }

              objc_autoreleasePoolPop(v43);
              [(HMDHomeManager *)v44 _notifyXPCClientsOfHomeConfigurationChange];
            }

            else
            {
              v25 = [(HMDHomeManager *)self memoryMonitorLogEventTimer];

              if (v25 == v4)
              {
                v47 = objc_autoreleasePoolPush();
                v48 = self;
                v49 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
                {
                  v50 = HMFGetLogIdentifier();
                  v51 = 138543362;
                  v52 = v50;
                  _os_log_impl(&dword_2531F8000, v49, OS_LOG_TYPE_DEFAULT, "%{public}@Memory monitor log event timer has fired", &v51, 0xCu);
                }

                objc_autoreleasePoolPop(v47);
                [(HMDHomeManager *)v48 _monitorMemoryUsage];
                [(HMDHomeManager *)v48 _updateHomesDiscoveredBonjourServicesMetrics];
              }

              else
              {
                v26 = [(HMDHomeManager *)self debounceRegenerateAssistantSyncDataTimer];

                if (v26 == v4)
                {
                  v27 = objc_autoreleasePoolPush();
                  v28 = self;
                  v29 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
                  {
                    v30 = HMFGetLogIdentifier();
                    v51 = 138543362;
                    v52 = v30;
                    _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEFAULT, "%{public}@Debounce Siri sync timer has fired, re-generating Siri sync data", &v51, 0xCu);
                  }

                  objc_autoreleasePoolPop(v27);
                  [(HMDHomeManager *)v28 _generateAssistantSyncDataAndIncrementVersion:1 requestSync:1 urgent:0 completion:0];
                }
              }
            }
          }
        }
      }
    }
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)__handleWatchDisconnected:(id)a3
{
  v4 = [a3 userInfo];
  v5 = [v4 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  workQueue = self->_workQueue;
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __44__HMDHomeManager___handleWatchDisconnected___block_invoke;
  v10[3] = &unk_2797359B0;
  v10[4] = self;
  v11 = v7;
  v9 = v7;
  dispatch_async(workQueue, v10);
}

uint64_t __44__HMDHomeManager___handleWatchDisconnected___block_invoke(uint64_t a1)
{
  v13 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v9 = 138543618;
    v10 = v5;
    v11 = 2112;
    v12 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that connected watch was removed: %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 32) _checkAndAddWatchDevicesWithResend:0];
  v8 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)__handleWatchConnected:(id)a3
{
  v4 = [a3 userInfo];
  v5 = [v4 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  workQueue = self->_workQueue;
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __41__HMDHomeManager___handleWatchConnected___block_invoke;
  v10[3] = &unk_2797359B0;
  v10[4] = self;
  v11 = v7;
  v9 = v7;
  dispatch_async(workQueue, v10);
}

uint64_t __41__HMDHomeManager___handleWatchConnected___block_invoke(uint64_t a1)
{
  v13 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v9 = 138543618;
    v10 = v5;
    v11 = 2112;
    v12 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that connected watch was added: %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 32) _checkAndAddWatchDevicesWithResend:0];
  v8 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)setupSession:(id)a3 didCloseWithError:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __49__HMDHomeManager_setupSession_didCloseWithError___block_invoke;
  block[3] = &unk_279734960;
  block[4] = self;
  v12 = v6;
  v13 = v7;
  v9 = v7;
  v10 = v6;
  dispatch_async(v8, block);
}

void __49__HMDHomeManager_setupSession_didCloseWithError___block_invoke(uint64_t a1)
{
  v77 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) identifier];
    v7 = *(a1 + 48);
    *buf = 138543874;
    v72 = v5;
    v73 = 2112;
    v74 = v6;
    v75 = 2112;
    v76 = v7;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Setup Session : %@, closed with error: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v2);
  v8 = [*(a1 + 40) setupTrackingInfo];
  v9 = [v8 accessoryUUID];
  if (v9)
  {
    v10 = [*(a1 + 32) accessorySetupMetricDispatcherForAccessoryUUID:v9];
    [v10 updateTrackingInfo:v8];
  }

  else
  {
    v10 = 0;
  }

  v11 = [*(a1 + 40) role] | v10;
  v70 = v11 == 0;
  if (!v11)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = [*(a1 + 40) identifier];
      *buf = 138543874;
      v72 = v15;
      v73 = 2112;
      v74 = v16;
      v75 = 2112;
      v76 = v9;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Setup Session : %@, did not find existing setup metric dispatcher for accessory uuid: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v12);
    v17 = [HMDAccessorySetupMetricDispatcher alloc];
    v18 = [*(a1 + 32) workQueue];
    v19 = [*(a1 + 40) identifier];
    v10 = [(HMDAccessorySetupMetricDispatcher *)v17 initWithQueue:v18 trackingInfo:v8 setupSessionIdentifier:v19 homeManager:*(a1 + 32)];

    [v10 setDelegate:*(a1 + 32)];
  }

  if ([*(a1 + 40) role] == 1)
  {
    v20 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];

    if (v20)
    {
      v21 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
      [v21 markSetupBeginStage:2 error:*(a1 + 48)];
    }
  }

  if (!*(a1 + 48))
  {
    if (v9)
    {
      v22 = [*(a1 + 32) accessoryWithUUID:v9];
      LODWORD(context) = v22 != 0;
      if (v22)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = *(a1 + 32);
        v25 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
        {
          v26 = HMFGetLogIdentifier();
          v27 = [*(a1 + 40) identifier];
          *buf = 138543874;
          v72 = v26;
          v73 = 2112;
          v74 = v27;
          v75 = 2112;
          v76 = v22;
          _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@Submitting Repair Setup Session metric : %@ as accessory is already in the home %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v23);
        [v10 markRepairSessionComplete];
      }
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      v29 = *(a1 + 32);
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v31 = HMFGetLogIdentifier();
        v32 = [*(a1 + 40) identifier];
        *buf = 138543618;
        v72 = v31;
        v73 = 2112;
        v74 = v32;
        _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Submitting Setup Session metric : %@ as accessory was not provided in setup payload", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v28);
      LODWORD(context) = 1;
    }

    v33 = [v8 accessoryIDSIdentifier];

    if (v33)
    {
      v34 = objc_alloc(MEMORY[0x277CCAD78]);
      v35 = [v8 accessoryIDSIdentifier];
      v36 = [v34 initWithUUIDString:v35];

      if (v36)
      {
        v37 = [*(a1 + 32) accessoryWithIDSIdentifier:v36];
        if (v37)
        {
          contexta = objc_autoreleasePoolPush();
          v38 = *(a1 + 32);
          v39 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
          {
            v40 = HMFGetLogIdentifier();
            v41 = [*(a1 + 40) identifier];
            *buf = 138543874;
            v72 = v40;
            v73 = 2112;
            v74 = v41;
            v75 = 2112;
            v76 = v37;
            _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Submitting Repair Setup Session metric : %@ as accessory with matching IDS identifier is already in the home %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(contexta);
          [v10 markRepairSessionComplete];
          LODWORD(contexta) = 1;
        }
      }
    }

    v42 = [v8 accessoryCategory];
    v43 = [v42 categoryType];
    v44 = [v43 isEqualToString:*MEMORY[0x277CCE870]];

    if (v44)
    {
      v45 = objc_autoreleasePoolPush();
      v46 = *(a1 + 32);
      v47 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v47, OS_LOG_TYPE_INFO))
      {
        v48 = HMFGetLogIdentifier();
        v49 = [*(a1 + 40) identifier];
        *buf = 138543874;
        v72 = v48;
        v73 = 2112;
        v74 = v49;
        v75 = 2112;
        v76 = v9;
        _os_log_impl(&dword_2531F8000, v47, OS_LOG_TYPE_INFO, "%{public}@Submitting Setup Session metric : %@ as accessory is an ATV %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v45);
    }

    else if (!contextb)
    {
      if (v70)
      {
        [*(a1 + 32) addAccessorySetupMetricDispatcher:v10];
      }

      goto LABEL_38;
    }

    [v10 submit];
    [*(a1 + 32) removeAccessorySetupMetricDispatcherForAccessoryUUID:v9];
LABEL_38:
    v50 = [*(a1 + 40) setupTrackingInfo];
    [*(a1 + 32) setSetupEndTimestamp:{objc_msgSend(v50, "endTime")}];

    goto LABEL_39;
  }

  [v10 submit];
  [*(a1 + 32) removeAccessorySetupMetricDispatcherForAccessoryUUID:v9];
LABEL_39:
  v51 = *(a1 + 32);
  os_unfair_lock_lock_with_options();
  v52 = [*(a1 + 32) deviceSetupSessions];
  [v52 removeObject:*(a1 + 40)];

  os_unfair_lock_unlock(v51 + 6);
  if (!*(a1 + 48) && [*(a1 + 40) role] == 1)
  {
    v53 = [MEMORY[0x277CFEC78] systemStore];
    v54 = [v53 getLocalPairingIdentity:0];
    v55 = v54 == 0;

    if (!v55)
    {
      v56 = objc_autoreleasePoolPush();
      v57 = *(a1 + 32);
      v58 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v58, OS_LOG_TYPE_INFO))
      {
        v59 = HMFGetLogIdentifier();
        *buf = 138543362;
        v72 = v59;
        _os_log_impl(&dword_2531F8000, v58, OS_LOG_TYPE_INFO, "%{public}@Resetting legacy key transfer and starting cloud fetch", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v56);
      v60 = [*(a1 + 32) keyTransferAgent];
      [v60 resetConfig];

      [*(a1 + 32) _updateCloudDataSyncWithAccountState:1];
      v61 = [MEMORY[0x277CBEB38] dictionary];
      [v61 setObject:*(a1 + 48) forKeyedSubscript:@"TTSU.error"];
      v62 = *(a1 + 32);
      v63 = [v61 copy];
      logAndPostNotification(@"TTSU.Finished.NotificationKey", v62, v63);

      v64 = [*(a1 + 32) userDefaults];
      [v64 setBool:1 forKey:@"TTSU.Finished"];
    }
  }

  if ([*(a1 + 40) role] == 1)
  {
    v65 = [*(a1 + 32) currentAccessorySetupMetricDispatcher];
    [v65 markSetupEndStage:2 error:*(a1 + 48)];
  }

  v66 = *MEMORY[0x277D85DE8];
}

- (void)setupSession:(id)a3 didReceiveAccessoryWithUUID:(id)a4
{
  v25 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
  {
    v11 = HMFGetLogIdentifier();
    v12 = [v6 identifier];
    v19 = 138543874;
    v20 = v11;
    v21 = 2112;
    v22 = v12;
    v23 = 2112;
    v24 = v7;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Setup Session : %@, received accessory uuid: %@", &v19, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  if (![v6 role])
  {
    v13 = [HMDAccessorySetupMetricDispatcher alloc];
    v14 = [(HMDHomeManager *)v9 workQueue];
    v15 = [v6 setupTrackingInfo];
    v16 = [v6 identifier];
    v17 = [(HMDAccessorySetupMetricDispatcher *)v13 initWithQueue:v14 trackingInfo:v15 setupSessionIdentifier:v16 homeManager:v9];

    [(HMDAccessorySetupMetricDispatcher *)v17 setDelegate:v9];
    [(HMDHomeManager *)v9 addAccessorySetupMetricDispatcher:v17];
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)__handleCompanionUpdated:(id)a3
{
  v4 = +[HMDCompanionManager sharedManager];
  v5 = [v4 companion];

  v6 = [(HMDHomeManager *)self workQueue];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __43__HMDHomeManager___handleCompanionUpdated___block_invoke;
  v8[3] = &unk_2797359B0;
  v9 = v5;
  v10 = self;
  v7 = v5;
  dispatch_async(v6, v8);
}

void __43__HMDHomeManager___handleCompanionUpdated___block_invoke(uint64_t a1)
{
  v29 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEBUG))
  {
    v4 = HMFGetLogIdentifier();
    v5 = *(a1 + 32);
    *buf = 138543618;
    v26 = v4;
    v27 = 2112;
    v28 = v5;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that the companion changed: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  [*(a1 + 40) _checkAndInformCompanionDevice];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v26 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Electing companion based off of changed companion device", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v6);
  v22 = 0u;
  v23 = 0u;
  v20 = 0u;
  v21 = 0u;
  v9 = [*(a1 + 40) homes];
  v10 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v21;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v21 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v20 + 1) + 8 * i);
        v15 = *(a1 + 40);
        v16 = [v14 uuid];
        [v15 electRemoteAccessPeerForHome:v16];

        if (*(a1 + 32))
        {
          v17 = [v14 primaryResident];
          v18 = [v17 device];
        }

        else
        {
          v18 = 0;
        }

        [v14 resubscribeForNotificationsOnResident:v18];
      }

      v11 = [v9 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v11);
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleUpdatedCurrentDevice:(id)a3
{
  v47 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v44 = v8;
    v45 = 2112;
    v46 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Received notification that current device was updated: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if (v4)
  {
    [(HMDHomeManager *)self startLocalTransport];
  }

  else
  {
    [(HMDHomeManager *)self stopLocalTransport];
  }

  v9 = +[HMDDeviceCapabilities deviceCapabilities];
  v10 = [v9 isResidentCapable];

  if (v10)
  {
    if (v4)
    {
      [(HMDHomeManager *)self notifyClientsResidentCapable:1];
      if (![(HMDHomeManager *)self residentEnabledState])
      {
        v11 = [v4 productInfo];
        v12 = [v11 productClass];

        if (v12 == 3)
        {
          v39 = 0u;
          v40 = 0u;
          v37 = 0u;
          v38 = 0u;
          v13 = [(HMDHomeManager *)self homes];
          v14 = [v13 countByEnumeratingWithState:&v37 objects:v42 count:16];
          if (v14)
          {
            v15 = *v38;
            while (2)
            {
              for (i = 0; i != v14; ++i)
              {
                if (*v38 != v15)
                {
                  objc_enumerationMutation(v13);
                }

                v17 = *(*(&v37 + 1) + 8 * i);
                if ([v17 isOwnerUser])
                {
                  v18 = [v17 residentCapableDevices];
                  v19 = [v18 containsObject:v4];

                  if (v19)
                  {
                    v22 = objc_autoreleasePoolPush();
                    v23 = self;
                    v24 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
                    {
                      v25 = HMFGetLogIdentifier();
                      *buf = 138543362;
                      v44 = v25;
                      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in one or more homes, enabling ourselves as a resident device", buf, 0xCu);
                    }

                    objc_autoreleasePoolPop(v22);
                    v14 = 1;
                    goto LABEL_25;
                  }
                }
              }

              v14 = [v13 countByEnumeratingWithState:&v37 objects:v42 count:16];
              if (v14)
              {
                continue;
              }

              break;
            }
          }

LABEL_25:

          v20 = self;
          v21 = v14;
        }

        else
        {
          v20 = self;
          v21 = 1;
        }

        [(HMDHomeManager *)v20 _updateResidentEnabledOnThisDevice:v21 forceNotify:0 message:0];
      }
    }

    else
    {
      [(HMDHomeManager *)self notifyClientsResidentCapable:0];
    }
  }

  v35 = 0u;
  v36 = 0u;
  v33 = 0u;
  v34 = 0u;
  v26 = [(HMDHomeManager *)self homes];
  v27 = [v26 countByEnumeratingWithState:&v33 objects:v41 count:16];
  if (v27)
  {
    v28 = v27;
    v29 = *v34;
    do
    {
      for (j = 0; j != v28; ++j)
      {
        if (*v34 != v29)
        {
          objc_enumerationMutation(v26);
        }

        v31 = [*(*(&v33 + 1) + 8 * j) migrateOwnedTriggers];
        if (v31)
        {
          [(HMDHomeManager *)self _saveWithReason:@"kAddTriggerRequestKey" information:v31 postSyncNotification:0];
        }
      }

      v28 = [v26 countByEnumeratingWithState:&v33 objects:v41 count:16];
    }

    while (v28);
  }

  v32 = *MEMORY[0x277D85DE8];
}

- (void)__handleUpdatedCurrentDevice:(id)a3
{
  v4 = [a3 userInfo];
  v5 = [v4 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  if ([v7 isCurrentDevice])
  {
    v8 = [(HMDHomeManager *)self workQueue];
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __47__HMDHomeManager___handleUpdatedCurrentDevice___block_invoke;
    v9[3] = &unk_2797359B0;
    v9[4] = self;
    v10 = v7;
    dispatch_async(v8, v9);
  }
}

- (void)__handleDeviceCapabilitiesUpdated:(id)a3
{
  v20[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self appleAccountManager];
  v6 = [v5 device];

  if (v6)
  {
    v7 = [v4 object];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = v7;
    }

    else
    {
      v8 = 0;
    }

    v9 = v8;

    if (v9)
    {
      v10 = [v6 capabilities];

      if (v10 == v9)
      {
        v11 = [v4 userInfo];
        v12 = MEMORY[0x277CBEB98];
        v20[0] = objc_opt_class();
        v13 = [MEMORY[0x277CBEA60] arrayWithObjects:v20 count:1];
        v14 = [v12 setWithArray:v13];
        v15 = [v11 hmf_arrayForKey:@"HMDDeviceCapabilitiesUpdatedDifferingFieldsNotificationKey" ofClasses:v14];

        if ([v15 count])
        {
          v16 = [(HMDHomeManager *)self workQueue];
          v18[0] = MEMORY[0x277D85DD0];
          v18[1] = 3221225472;
          v18[2] = __52__HMDHomeManager___handleDeviceCapabilitiesUpdated___block_invoke;
          v18[3] = &unk_2797359B0;
          v18[4] = self;
          v19 = v6;
          dispatch_async(v16, v18);
        }
      }
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)verifyCurrentDeviceResidentStatus
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_verifyCurrentDeviceResidentStatus__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

uint64_t __51__HMDHomeManager_verifyCurrentDeviceResidentStatus__block_invoke(uint64_t a1)
{
  result = [*(a1 + 32) isResidentCapable];
  if (result)
  {
    v3 = *(a1 + 32);
    v4 = [v3 isResidentEnabled];

    return [v3 _updateResidentEnabledOnThisDevice:v4 forceNotify:1 message:0];
  }

  return result;
}

- (void)__accountRegistryRemovedAccount:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __50__HMDHomeManager___accountRegistryRemovedAccount___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __50__HMDHomeManager___accountRegistryRemovedAccount___block_invoke(uint64_t a1)
{
  v20 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 40);
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v16 = 138543618;
    v17 = v9;
    v18 = 2112;
    v19 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that account was removed: %@", &v16, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if ([v5 isCurrentAccount])
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v16 = 138543362;
      v17 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@The removed account is the current account", &v16, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    [*(a1 + 40) stopLocalTransport];
    v14 = [*(a1 + 40) cloudDataSyncStateFilter];
    [v14 updateCurrentAccount:v5];

    [*(a1 + 40) saveWithReason:@"currentAccountUpdated" information:0 saveOptions:0];
    +[HMDHH2FrameworkSwitch switchBackToHH1AndDoNotLaunchDueToPrimaryAccountRemoval];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)__accountRegistryAddedAccount:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __48__HMDHomeManager___accountRegistryAddedAccount___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __48__HMDHomeManager___accountRegistryAddedAccount___block_invoke(uint64_t a1)
{
  v46 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) userInfo];
  v3 = [v2 objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v4 = v3;
  }

  else
  {
    v4 = 0;
  }

  v5 = v4;

  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 40);
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543618;
    v43 = v9;
    v44 = 2112;
    v45 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that account was added: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if ([v5 isCurrentAccount])
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543618;
      v43 = v13;
      v44 = 2112;
      v45 = v5;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Received notification that current account changed to: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [*(a1 + 40) cloudDataSyncStateFilter];
    v29 = v5;
    [v14 updateCurrentAccount:v5];

    v38 = 0u;
    v39 = 0u;
    v36 = 0u;
    v37 = 0u;
    obj = [*(a1 + 40) homes];
    v15 = [obj countByEnumeratingWithState:&v36 objects:v41 count:16];
    if (v15)
    {
      v16 = v15;
      v31 = *v37;
      do
      {
        for (i = 0; i != v16; ++i)
        {
          if (*v37 != v31)
          {
            objc_enumerationMutation(obj);
          }

          v18 = *(*(&v36 + 1) + 8 * i);
          v32 = 0u;
          v33 = 0u;
          v34 = 0u;
          v35 = 0u;
          v19 = [v18 triggers];
          v20 = [v19 countByEnumeratingWithState:&v32 objects:v40 count:16];
          if (v20)
          {
            v21 = v20;
            v22 = *v33;
            do
            {
              for (j = 0; j != v21; ++j)
              {
                if (*v33 != v22)
                {
                  objc_enumerationMutation(v19);
                }

                v24 = *(*(&v32 + 1) + 8 * j);
                v25 = [v24 owningDevice];

                if (!v25)
                {
                  v26 = [*(a1 + 40) appleAccountManager];
                  v27 = [v26 device];
                  [v24 setOwningDevice:v27];
                }
              }

              v21 = [v19 countByEnumeratingWithState:&v32 objects:v40 count:16];
            }

            while (v21);
          }
        }

        v16 = [obj countByEnumeratingWithState:&v36 objects:v41 count:16];
      }

      while (v16);
    }

    [*(a1 + 40) saveWithReason:@"currentAccountUpdated" information:0 saveOptions:0];
    v5 = v29;
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchDevicesMessage:(id)a3
{
  v15[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v14 = *MEMORY[0x277CD00F8];
  v6 = MEMORY[0x277CBEB98];
  v7 = [(HMDHomeManager *)self appleAccountManager];
  v8 = [v7 account];
  v9 = [v8 devices];
  v10 = [v6 setWithArray:v9];
  v11 = encodeRootObjectForIncomingXPCMessage(v10, 0);
  v15[0] = v11;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v15 forKeys:&v14 count:1];
  [v4 respondWithPayload:v12];

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_notifyXPCClientsOfUpdatedDevices
{
  v27[1] = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  v4 = MEMORY[0x277D0F818];
  v5 = *MEMORY[0x277CD0100];
  v26 = *MEMORY[0x277CD00F8];
  v6 = MEMORY[0x277CBEB98];
  v7 = [(HMDHomeManager *)self appleAccountManager];
  v8 = [v7 account];
  v9 = [v8 devices];
  v10 = [v6 setWithArray:v9];
  v11 = encodeRootObjectForIncomingXPCMessage(v10, 0);
  v27[0] = v11;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v27 forKeys:&v26 count:1];
  v13 = [v4 entitledMessageWithName:v5 messagePayload:v12];

  v14 = objc_autoreleasePoolPush();
  v15 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    v18 = [v13 shortDescription];
    v22 = 138543618;
    v23 = v17;
    v24 = 2112;
    v25 = v18;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Notifying clients of updated devices with message: %@", &v22, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  v19 = [(HMDHomeManager *)v15 messageDispatcher];
  v20 = [(HMDHomeManager *)v15 uuid];
  [v19 sendMessage:v13 target:v20];

  v21 = *MEMORY[0x277D85DE8];
}

- (void)__accountRemovedDevice:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __41__HMDHomeManager___accountRemovedDevice___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __41__HMDHomeManager___accountRemovedDevice___block_invoke(uint64_t a1)
{
  v30 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = [*(a1 + 32) userInfo];
  v6 = [v5 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if ([v4 isCurrentAccount])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v27 = v12;
      v28 = 2112;
      v29 = v8;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Received notification that device was removed from our account: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    v23 = 0u;
    v24 = 0u;
    v21 = 0u;
    v22 = 0u;
    v13 = [*(a1 + 40) homes];
    v14 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v22;
      do
      {
        for (i = 0; i != v15; ++i)
        {
          if (*v22 != v16)
          {
            objc_enumerationMutation(v13);
          }

          v18 = *(*(&v21 + 1) + 8 * i);
          if ([v18 isOwnerUser])
          {
            [v18 removeResidentCapableDevice:v8];
          }
        }

        v15 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
      }

      while (v15);
    }

    [*(a1 + 40) _checkForRemotePeers];
    v19 = [*(a1 + 40) cloudDataSyncStateFilter];
    [v19 updateCurrentAccount:v4];

    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
    [*(a1 + 40) _updateCurrentUserEligibleForOwnerToAutoMigration];
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)__handleDeviceUpdatedNotification:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __52__HMDHomeManager___handleDeviceUpdatedNotification___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __52__HMDHomeManager___handleDeviceUpdatedNotification___block_invoke(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 40);
  v7 = HMFGetOSLogHandle();
  v8 = v7;
  if (v4)
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v9;
      v17 = 2112;
      v18 = v4;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Received notification that device updated: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
    [*(a1 + 40) _updateCurrentUserEligibleForOwnerToAutoMigration];
  }

  else
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 32) object];
      v12 = [*(a1 + 32) object];
      v15 = 138543874;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      v19 = 2112;
      v20 = objc_opt_class();
      v13 = v20;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Notification object was not an HMDDevice: %@ (%@)", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)__accountAddedDevice:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __39__HMDHomeManager___accountAddedDevice___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __39__HMDHomeManager___accountAddedDevice___block_invoke(uint64_t a1)
{
  v19 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) object];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  v5 = [*(a1 + 32) userInfo];
  v6 = [v5 objectForKeyedSubscript:@"HMDDeviceNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v8 = v7;

  if ([v4 isCurrentAccount])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v15 = 138543618;
      v16 = v12;
      v17 = 2112;
      v18 = v8;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Received notification that device was added to our account: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [*(a1 + 40) _checkForRemotePeers];
    v13 = [*(a1 + 40) cloudDataSyncStateFilter];
    [v13 updateCurrentAccount:v4];

    [*(a1 + 40) _notifyXPCClientsOfUpdatedDevices];
    [*(a1 + 40) _updateCurrentUserEligibleForOwnerToAutoMigration];
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_checkHH1EOLStatusAndRelaunchIfNeeded
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __55__HMDHomeManager__checkHH1EOLStatusAndRelaunchIfNeeded__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

void __55__HMDHomeManager__checkHH1EOLStatusAndRelaunchIfNeeded__block_invoke(uint64_t a1)
{
  v19 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) lastKnownIsHH1EOLEnabled];

  if (!v2)
  {
LABEL_10:
    v12 = *MEMORY[0x277D85DE8];
    return;
  }

  v13 = [*(a1 + 32) lastKnownIsHH1EOLEnabled];
  if (([v13 BOOLValue] & 1) == 0)
  {
    v4 = [*(a1 + 32) isHH1EOLEnabled];

    if (v4)
    {
      v5 = objc_autoreleasePoolPush();
      v6 = *(a1 + 32);
      v7 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
      {
        v8 = HMFGetLogIdentifier();
        *buf = 138543618;
        v16 = v8;
        v17 = 2048;
        v18 = 0x3FF0000000000000;
        _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Due to HH1 EOL enablement will relaunch homed after: %f seconds", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v5);
      v9 = dispatch_walltime(0, 1000000000);
      v10 = [*(a1 + 32) workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __55__HMDHomeManager__checkHH1EOLStatusAndRelaunchIfNeeded__block_invoke_1569;
      block[3] = &unk_279735D00;
      block[4] = *(a1 + 32);
      dispatch_after(v9, v10, block);

      v11 = [MEMORY[0x277CCABB0] numberWithBool:{objc_msgSend(*(a1 + 32), "isHH1EOLEnabled")}];
      [*(a1 + 32) setLastKnownIsHH1EOLEnabled:v11];
    }

    goto LABEL_10;
  }

  v3 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__checkHH1EOLStatusAndRelaunchIfNeeded__block_invoke_1569(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Setting HH1EOLEnabled to YES and relaunching...", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 32) userDefaults];
  [v6 setBool:objc_msgSend(*(a1 + 32) forKey:{"isHH1EOLEnabled"), @"HH1EOLEnabled"}];

  v7 = +[HMDMainDriver driver];
  [v7 relaunch];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_updateCurrentUserEligibleForOwnerToAutoMigration
{
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  v4 = [(HMDHomeManager *)self hh2AutoMigrationEligibilityChecker];
  v5[0] = MEMORY[0x277D85DD0];
  v5[1] = 3221225472;
  v5[2] = __67__HMDHomeManager__updateCurrentUserEligibleForOwnerToAutoMigration__block_invoke;
  v5[3] = &unk_279732D68;
  v5[4] = self;
  [v4 fetchIsCurrentUserEligibleForMigrationByOwnerWithCompletion:v5];
}

void __67__HMDHomeManager__updateCurrentUserEligibleForOwnerToAutoMigration__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v20 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v7 = [*(a1 + 32) homes];
  v8 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v16;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v16 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v15 + 1) + 8 * i);
        if (([v12 isOwnerUser] & 1) == 0)
        {
          v13 = [v12 currentUser];
          [v13 updateSupportsHH2MigrationByOwnerManual:objc_msgSend(v5 supportsHH2MigrationByOwnerAuto:{"isEligible"), objc_msgSend(v6, "isEligible")}];
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
    }

    while (v9);
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)updateCurrentUserEligibleForOwnerToAutoMigration
{
  workQueue = self->_workQueue;
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __66__HMDHomeManager_updateCurrentUserEligibleForOwnerToAutoMigration__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(workQueue, block);
}

- (void)accessoryBrowserDidFindNewAccessory
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __53__HMDHomeManager_accessoryBrowserDidFindNewAccessory__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

- (void)saveAccessAllowedWhenLockedSettingToLocalDisk
{
  v30[1] = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v29 = @"kAccessAllowedWhenLockedKey";
  v4 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isAccessAllowedWhenLocked](self, "isAccessAllowedWhenLocked")}];
  v30[0] = v4;
  v5 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v30 forKeys:&v29 count:1];

  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v23 = 138543618;
    v24 = v9;
    v25 = 2112;
    v26 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Storing access allowed when locked :[%@]", &v23, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  v10 = [objc_alloc(MEMORY[0x277CCAAB0]) initRequiringSecureCoding:1];
  [v10 encodeObject:v5 forKey:*MEMORY[0x277CCA308]];
  [v10 finishEncoding];
  v11 = [v10 encodedData];
  if (v11)
  {
    v12 = [(HMDHomeManager *)v7 accessAllowedWhenLockedSettingFileName];
    v13 = [HMDPersistentStore writeData:v11 toStorePath:v12 dataLabel:@"AccessAllowedWhenLockedSetting"];
    v14 = objc_autoreleasePoolPush();
    v15 = v7;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
    {
      v17 = HMFGetLogIdentifier();
      v23 = 138543874;
      v24 = v17;
      v25 = 2112;
      v26 = v13;
      v27 = 2112;
      v28 = v12;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Stored [%@] bytes to [%@]", &v23, 0x20u);
    }

    objc_autoreleasePoolPop(v14);
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = v7;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v21 = HMFGetLogIdentifier();
      v23 = 138543618;
      v24 = v21;
      v25 = 2112;
      v26 = v5;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Nothing to store as there is no data after archiving %@", &v23, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
  }

  objc_autoreleasePoolPop(v3);
  v22 = *MEMORY[0x277D85DE8];
}

- (id)accessAllowedWhenLockedSettingFileName
{
  v2 = MEMORY[0x277CCACA8];
  v3 = hh1ToHH2PerDeviceMigrationDirectoryPath;
  v4 = [v2 stringWithFormat:@"%@/AllowedAccessWhenLockedSetting.plist", v3];

  return v4;
}

- (void)_handleAccessAllowedWhenLockedRequest:(id)a3
{
  v21 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v18 = v8;
    v19 = 2112;
    v20 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Asked to update access allowed when locked : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v16 = 0;
  v9 = [v4 BOOLForKey:@"kAccessAllowedWhenLockedKey" keyPresent:&v16];
  if (v16)
  {
    [(HMDHomeManager *)v6 _updateAccessAllowedWhenLocked:v9 message:v4];
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    v11 = v6;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Unable to find the key in the message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v14];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (BOOL)dataSyncInProgressWithState:(unint64_t *)a3 withMessage:(id)a4
{
  v6 = a4;
  v7 = [(HMDHomeManager *)self cloudDataSyncStateFilter];

  if (v7)
  {
    v8 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v9 = [v8 dataSyncInProgressWithState:a3 withMessage:v6];
  }

  else
  {
    v9 = 0;
    if (a3)
    {
      *a3 = 1;
    }
  }

  return v9;
}

- (unint64_t)statusForMessage:(id)a3
{
  v48 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self appleAccountManager];
  v6 = +[HMDDeviceCapabilities deviceCapabilities];
  v7 = [v6 supportsDeviceSetup];

  if (!v7)
  {
    goto LABEL_7;
  }

  v8 = [v5 accountContext];

  if (v8)
  {
    v9 = [MEMORY[0x277CFEC78] systemStore];
    v10 = [v9 getLocalPairingIdentity:0];

    if (!v10)
    {
      v13 = objc_autoreleasePoolPush();
      v21 = self;
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v16;
        v17 = "%{public}@Device setup required, no account pairing identity";
        goto LABEL_12;
      }

      goto LABEL_13;
    }

    v11 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v12 = [v11 decryptionFailed];

    if (v12)
    {
      v13 = objc_autoreleasePoolPush();
      v14 = self;
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v16;
        v17 = "%{public}@Device setup required, unable to decrypt cloud data";
LABEL_12:
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, v17, buf, 0xCu);

        goto LABEL_13;
      }

      goto LABEL_13;
    }

LABEL_7:
    v18 = 0;
    v19 = 1;
    goto LABEL_14;
  }

  v13 = objc_autoreleasePoolPush();
  v20 = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
  {
    v16 = HMFGetLogIdentifier();
    *buf = 138543362;
    v43 = v16;
    v17 = "%{public}@Device setup required, no active account";
    goto LABEL_12;
  }

LABEL_13:

  objc_autoreleasePoolPop(v13);
  v19 = 0;
  v18 = 16;
LABEL_14:
  v41 = 0;
  if ([(HMDHomeManager *)self dataSyncInProgressWithState:&v41 withMessage:v4])
  {
    v22 = objc_autoreleasePoolPush();
    v23 = self;
    v24 = HMFGetOSLogHandle();
    v25 = os_log_type_enabled(v24, OS_LOG_TYPE_INFO);
    if (v19)
    {
      if (v25)
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v26;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Busy, data sync in progress", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
      v18 |= 1uLL;
    }

    else
    {
      if (v25)
      {
        v27 = HMFGetLogIdentifier();
        *buf = 138543362;
        v43 = v27;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Suppressing busy status while device setup required", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v22);
    }
  }

  v28 = [v5 accountContext];

  if (!v28)
  {
    v29 = objc_autoreleasePoolPush();
    v30 = self;
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543362;
      v43 = v32;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@No account", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v29);
    v18 |= 0x20uLL;
  }

  v33 = objc_autoreleasePoolPush();
  v34 = self;
  v35 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
  {
    v36 = HMFGetLogIdentifier();
    v37 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v18];
    [v5 isLoggedInToPrimaryAccount];
    v38 = HMFBooleanToString();
    *buf = 138543874;
    v43 = v36;
    v44 = 2112;
    v45 = v37;
    v46 = 2112;
    v47 = v38;
    _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_INFO, "%{public}@status : %@, %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v33);
  v39 = *MEMORY[0x277D85DE8];
  return v18;
}

- (id)_statusPayloadForMessage:(id)a3
{
  v31[4] = *MEMORY[0x277D85DE8];
  v29 = 0;
  v4 = a3;
  v5 = [(HMDHomeManager *)self statusForMessage:v4];
  [(HMDHomeManager *)self dataSyncInProgressWithState:&v29 withMessage:v4];

  v6 = [(HMDHomeManager *)self multiUserStatusController];
  [v6 didUpdateDataSyncState:v29];

  if ((enableRetailDemoSetup & 1) != 0 || [(HMDHomeManager *)self demoFinalized])
  {
    v5 = 0;
    v29 = 1;
  }

  if (isInternalBuild())
  {
    v7 = [MEMORY[0x277D0F8D0] sharedPreferences];
    v8 = [v7 preferenceForKey:@"HMDHomeManagerForceOverrideDataSyncStateAndStatus"];
    v9 = [v8 BOOLValue];

    if (v9)
    {
      v10 = [MEMORY[0x277D0F8D0] sharedPreferences];
      v11 = [v10 preferenceForKey:@"HMDHomeManagerDataSyncStateOverride"];
      v12 = [v11 numberValue];
      v29 = [v12 unsignedIntegerValue];

      v13 = [MEMORY[0x277D0F8D0] sharedPreferences];
      v14 = [v13 preferenceForKey:@"HMDHomeManagerStatusOverride"];
      v15 = [v14 numberValue];
      v5 = [v15 unsignedIntegerValue];
    }
  }

  v16 = [(HMDHomeManager *)self metricsManager];
  v17 = [v16 deviceStateManager];
  [v17 updateWithDataSyncState:v29];

  v18 = [(HMDHomeManager *)self metricsManager];
  v19 = [v18 deviceStateManager];
  [v19 updateWithHomeManagerStatus:v5];

  v30[0] = *MEMORY[0x277CD00D8];
  v20 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v29];
  v31[0] = v20;
  v30[1] = *MEMORY[0x277CD0398];
  v21 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v5];
  v31[1] = v21;
  v30[2] = @"kConfigGenerationCounterKey";
  v22 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{-[HMDHomeManager generationCounter](self, "generationCounter")}];
  v31[2] = v22;
  v30[3] = *MEMORY[0x277CD02B0];
  v23 = MEMORY[0x277CCABB0];
  v24 = [(HMDHomeManager *)self multiUserStatusController];
  v25 = [v23 numberWithInteger:{objc_msgSend(v24, "multiUserState")}];
  v31[3] = v25;
  v26 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v31 forKeys:v30 count:4];

  v27 = *MEMORY[0x277D85DE8];

  return v26;
}

- (void)_notifyClientsOfUpdatedStatus
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  v4 = [(HMDHomeManager *)self uuid];
  [(HMDHomeManager *)self _updateGenerationCounterWithReason:@"DataSyncStatusUpdate" sourceUUID:v4 shouldNotifyClients:0];

  v5 = objc_alloc(MEMORY[0x277D0F818]);
  v6 = *MEMORY[0x277CD03A0];
  v7 = [(HMDHomeManager *)self messageDestination];
  v8 = [(HMDHomeManager *)self _statusPayloadForMessage:0];
  v9 = [v5 initWithName:v6 destination:v7 payload:v8];

  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [v9 messagePayload];
    v18 = 138543618;
    v19 = v13;
    v20 = 2112;
    v21 = v14;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Notifying clients of updated status message payload: %@", &v18, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  v15 = [(HMDHomeManager *)v11 messageDispatcher];
  [v15 sendMessage:v9];

  v16 = [(HMDHomeManager *)v11 notificationCenter];
  [v16 postNotificationName:@"HMDHomeManagerDataSyncInProgressChangedNotification" object:v11];

  v17 = *MEMORY[0x277D85DE8];
}

- (BOOL)areThereAnyTTSUSessionsOngoing
{
  v18 = *MEMORY[0x277D85DE8];
  os_unfair_lock_lock_with_options();
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = MEMORY[0x277CCABB0];
    v8 = [(HMDHomeManager *)v4 deviceSetupSessions];
    v9 = [v7 numberWithUnsignedInteger:{objc_msgSend(v8, "count")}];
    v14 = 138543618;
    v15 = v6;
    v16 = 2112;
    v17 = v9;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Ongoing TTSU sessions : %@", &v14, 0x16u);
  }

  objc_autoreleasePoolPop(v3);
  v10 = [(HMDHomeManager *)v4 deviceSetupSessions];
  v11 = [v10 hmf_isEmpty];

  os_unfair_lock_unlock(&self->_lock);
  v12 = *MEMORY[0x277D85DE8];
  return v11 ^ 1;
}

- (void)_handleDeviceSetupSessionOpen:(id)a3
{
  v55 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v47 = [v4 uuidForKey:*MEMORY[0x277CCFCA8]];
  v5 = [v4 numberForKey:*MEMORY[0x277CCFCC0]];
  v48 = v5;
  if (v47)
  {
    v6 = v5 == 0;
  }

  else
  {
    v6 = 1;
  }

  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v52 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Invalid message parameters", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v11];
  }

  else
  {
    v12 = [v4 activity];
    [(HMDHomeManager *)self setSetupActivity:v12];

    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v17 = HMFGetLogIdentifier();
      [(HMDHomeManager *)v14 setupStartTimestamp];
      *buf = 138543618;
      v52 = v17;
      v53 = 2048;
      v54 = v18;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_DEFAULT, "%{public}@Noting setup start system time: %f", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v19 = [(HMDHomeManager *)v14 setupActivity];
    [v19 begin];

    v20 = [(HMDHomeManager *)v14 appleAccountManager];
    v11 = [v20 device];

    v21 = [(HMDHomeManager *)v14 setupActivity];
    v49[0] = @"currentHomeUUID";
    v22 = [(HMDHomeManager *)v14 currentHomeUUID];
    v23 = HMDailyRotatedUUID();
    v24 = [v23 UUIDString];
    v25 = v24;
    v26 = @"nil current home UUID";
    if (v24)
    {
      v26 = v24;
    }

    v50[0] = v26;
    v49[1] = @"productClass";
    v27 = MEMORY[0x277CCABB0];
    v28 = [v11 productInfo];
    v29 = [v27 numberWithInteger:{objc_msgSend(v28, "productClass")}];
    v50[1] = v29;
    v49[2] = @"productType";
    v30 = [MEMORY[0x277CCABB0] numberWithLong:MGGetProductType()];
    v50[2] = v30;
    v31 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v50 forKeys:v49 count:3];

    v32 = [(HMDHomeManager *)v14 setupActivity];
    [v32 markWithReason:@"HMDHomeManager._handleDeviceSetupSessionOpen"];

    v33 = [v48 integerValue];
    if ([HMDDeviceSetupSession isRoleSupported:v33])
    {
      v34 = [[HMDDeviceSetupSession alloc] initWithIdentifier:v47 role:v33 homeManager:v14];
      v35 = [(HMDDeviceSetupSession *)v34 setupTrackingInfo];
      -[HMDHomeManager setSetupStartTimestamp:](v14, "setSetupStartTimestamp:", [v35 startTime]);

      [(HMDDeviceSetupSession *)v34 setDelegate:v14];
      os_unfair_lock_lock_with_options();
      v36 = [(HMDHomeManager *)v14 deviceSetupSessions];
      [v36 addObject:v34];

      os_unfair_lock_unlock(&v14->_lock);
      v37 = objc_autoreleasePoolPush();
      v38 = v14;
      v39 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
      {
        v40 = HMFGetLogIdentifier();
        v41 = [(HMDDeviceSetupSession *)v34 identifier];
        *buf = 138543618;
        v52 = v40;
        v53 = 2112;
        v54 = v41;
        _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@New TTSU session created: [%@]", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v37);
      [v4 respondWithSuccess];
    }

    else
    {
      v42 = objc_autoreleasePoolPush();
      v43 = v14;
      v44 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
      {
        v45 = HMFGetLogIdentifier();
        *buf = 138543618;
        v52 = v45;
        v53 = 2048;
        v54 = v33;
        _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Unsupported role: %tu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v42);
      v34 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
      [v4 respondWithError:v34];
    }
  }

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_handleDeviceSetupSessionClose:(id)a3
{
  v47 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    LODWORD(buf) = 138543362;
    *(&buf + 4) = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received HMDHomeManager close session message", &buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [v4 uuidForKey:*MEMORY[0x277CCFCA8]];
  if (v9)
  {
    *&buf = 0;
    *(&buf + 1) = &buf;
    v45 = 0x2020000000;
    v46 = 0;
    v10 = objc_autoreleasePoolPush();
    v11 = v6;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [(HMDHomeManager *)v11 deviceSetupSessions];
      *v38 = 138543874;
      v39 = v13;
      v40 = 2112;
      v41 = v9;
      v42 = 2048;
      v43 = [v14 count];
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@HMDHomeManager close session %@. Total current sessions %lu", v38, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    v15 = [(HMDHomeManager *)v11 deviceSetupSessions];
    v30 = MEMORY[0x277D85DD0];
    v31 = 3221225472;
    v32 = __49__HMDHomeManager__handleDeviceSetupSessionClose___block_invoke;
    v33 = &unk_279732D40;
    v16 = v9;
    v34 = v16;
    v35 = v11;
    v17 = v4;
    v36 = v17;
    p_buf = &buf;
    [v15 hmf_enumerateWithAutoreleasePoolUsingBlock:&v30];

    if ((*(*(&buf + 1) + 24) & 1) == 0)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = v11;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v21 = HMFGetLogIdentifier();
        v22 = [(HMDHomeManager *)v19 deviceSetupSessions:v30];
        v23 = [v22 count];
        *v38 = 138543874;
        v39 = v21;
        v40 = 2112;
        v41 = v16;
        v42 = 2048;
        v43 = v23;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@Didn't close session %@ due to session not found (already closed?). Total current sessions %lu", v38, 0x20u);
      }

      objc_autoreleasePoolPop(v18);
      [v17 respondWithSuccess];
    }

    _Block_object_dispose(&buf, 8);
  }

  else
  {
    v24 = objc_autoreleasePoolPush();
    v25 = v6;
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
    {
      v27 = HMFGetLogIdentifier();
      LODWORD(buf) = 138543362;
      *(&buf + 4) = v27;
      _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_ERROR, "%{public}@Received close session message without UUID. Respond with error.", &buf, 0xCu);
    }

    objc_autoreleasePoolPop(v24);
    v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v28];
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __49__HMDHomeManager__handleDeviceSetupSessionClose___block_invoke(uint64_t a1, void *a2, uint64_t a3, _BYTE *a4)
{
  v19 = *MEMORY[0x277D85DE8];
  v6 = a2;
  v7 = [v6 identifier];
  v8 = [v7 isEqual:*(a1 + 32)];

  if (v8)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 40);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v13 = [v6 identifier];
      v15 = 138543618;
      v16 = v12;
      v17 = 2112;
      v18 = v13;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Found close session: %@", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [v6 close:*(a1 + 48)];
    *a4 = 1;
    *(*(*(a1 + 56) + 8) + 24) = 1;
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_handleRemoveAllHomeKitPairingIdentities:(id)a3
{
  v39 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v36 = v8;
    v37 = 2112;
    v38 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Going to delete all the HomeKit pairing identities before TTSU: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [MEMORY[0x277CFEC78] systemStore];
  if (!v9)
  {
    v22 = objc_autoreleasePoolPush();
    v23 = v6;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
    {
      v25 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v25;
      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_ERROR, "%{public}@Could not find key chain store instance.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v22);
    v20 = MEMORY[0x277CCA9B8];
    v21 = 20;
    goto LABEL_13;
  }

  v10 = [MEMORY[0x277CB8F48] defaultStore];
  v11 = [v10 aa_primaryAppleAccount];

  if (v11)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = v6;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Cannot remove all the keys as the primary account is logged in.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    v16 = objc_autoreleasePoolPush();
    v17 = v13;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_FAULT))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_FAULT, "%{public}@Remove All HomeKit Pairing Identity was called with a logged in Account : ", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v20 = MEMORY[0x277CCA9B8];
    v21 = 10;
LABEL_13:
    v26 = [v20 hmErrorWithCode:v21];
    [v4 respondWithError:v26];
    goto LABEL_14;
  }

  v34 = 0;
  v28 = [v9 removeControllerKeyPairLeaveTombstone:0 error:&v34];
  v26 = v34;
  if (v28)
  {
    [v4 respondWithSuccess];
  }

  else
  {
    v29 = objc_autoreleasePoolPush();
    v30 = v6;
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543618;
      v36 = v32;
      v37 = 2112;
      v38 = v26;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_ERROR, "%{public}@Failed to remove all the HomeKit pairing identities : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
    v33 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    [v4 respondWithError:v33];
  }

LABEL_14:

  v27 = *MEMORY[0x277D85DE8];
}

- (void)removeAllHomeKitPairingIdentitiesAfterSignOut
{
  v3 = [MEMORY[0x277D0F818] messageWithName:@"removeAllHomeKitPairingIdentitiesDueToSignOut" messagePayload:MEMORY[0x277CBEC10]];
  [(HMDHomeManager *)self _handleRemoveAllHomeKitPairingIdentities:v3];
}

- (double)setupEndTimestamp
{
  os_unfair_lock_lock_with_options();
  setupEndTimestamp = self->_setupEndTimestamp;
  os_unfair_lock_unlock(&self->_lock);
  return setupEndTimestamp;
}

- (void)setSetupEndTimestamp:(double)a3
{
  v17 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543618;
    v14 = v8;
    v15 = 2048;
    v16 = a3;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Saving current accessory setup end timestamp: %f", &v13, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 userDefaults];
  v10 = v9;
  if (fabs(a3) >= 2.22044605e-16)
  {
    v11 = [MEMORY[0x277CCABB0] numberWithDouble:a3];
    [v10 setObject:v11 forKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
  }

  else
  {
    [v9 removeObjectForKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
  }

  os_unfair_lock_lock_with_options();
  v6->_setupEndTimestamp = a3;
  os_unfair_lock_unlock(&v6->_lock);
  v12 = *MEMORY[0x277D85DE8];
}

- (double)setupStartTimestamp
{
  os_unfair_lock_lock_with_options();
  setupStartTimestamp = self->_setupStartTimestamp;
  os_unfair_lock_unlock(&self->_lock);
  return setupStartTimestamp;
}

- (void)setSetupStartTimestamp:(double)a3
{
  v17 = *MEMORY[0x277D85DE8];
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543618;
    v14 = v8;
    v15 = 2048;
    v16 = a3;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Saving current accessory setup timestamp: %f", &v13, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 userDefaults];
  v10 = v9;
  if (fabs(a3) >= 2.22044605e-16)
  {
    v11 = [MEMORY[0x277CCABB0] numberWithDouble:a3];
    [v10 setObject:v11 forKey:@"HMDCurrentAccessorySetupStartUptimeKey"];
  }

  else
  {
    [v9 removeObjectForKey:@"HMDCurrentAccessorySetupStartUptimeKey"];

    [(HMDHomeManager *)v6 setSetupEndTimestamp:0.0];
  }

  os_unfair_lock_lock_with_options();
  v6->_setupStartTimestamp = a3;
  os_unfair_lock_unlock(&v6->_lock);
  v12 = *MEMORY[0x277D85DE8];
}

- (void)pingDevice:(id)a3 secure:(BOOL)a4 restrictToLocalNetwork:(BOOL)a5 completionHandler:(id)a6
{
  v9 = a3;
  v10 = a6;
  v11 = [HMDRemoteDeviceMessageDestination alloc];
  v12 = [(HMDHomeManager *)self uuid];
  v13 = [(HMDRemoteDeviceMessageDestination *)v11 initWithTarget:v12 device:v9];

  if (a4)
  {
    v14 = [HMDRemoteMessage secureMessageWithName:@"kPingInternalRequestKey" qualityOfService:25 destination:v13 messagePayload:MEMORY[0x277CBEC10] restriction:-1];
  }

  else
  {
    v15 = [v9 globalHandles];
    v16 = [v15 count];

    if (v16 == 1)
    {
      v17 = [v9 globalHandles];
      v18 = [v17 firstObject];
      [(HMDRemoteDeviceMessageDestination *)v13 setPreferredHandle:v18];
    }

    v14 = [HMDRemoteMessage messageWithName:@"kPingInternalRequestKey" qualityOfService:25 destination:v13 messagePayload:MEMORY[0x277CBEC10] restriction:-1];
  }

  v19 = v14;
  objc_initWeak(&location, self);
  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke;
  v22[3] = &unk_2797355F8;
  objc_copyWeak(&v24, &location);
  v20 = v10;
  v23 = v20;
  [v19 setResponseHandler:v22];
  v21 = [(HMDHomeManager *)self messageDispatcher];
  [v21 sendMessage:v19 completionHandler:0];

  objc_destroyWeak(&v24);
  objc_destroyWeak(&location);
}

void __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v8 = objc_autoreleasePoolPush();
  v9 = WeakRetained;
  v10 = HMFGetOSLogHandle();
  v11 = v10;
  if (v5)
  {
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v23 = v12;
      v24 = 2112;
      v25 = v5;
      v13 = "%{public}@Failed to respond to ping with error: %@";
      v14 = v11;
      v15 = OS_LOG_TYPE_DEFAULT;
      v16 = 22;
LABEL_6:
      _os_log_impl(&dword_2531F8000, v14, v15, v13, buf, v16);
    }
  }

  else if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v12 = HMFGetLogIdentifier();
    *buf = 138543362;
    v23 = v12;
    v13 = "%{public}@Successfully responded to ping";
    v14 = v11;
    v15 = OS_LOG_TYPE_INFO;
    v16 = 12;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v8);
  if (v9 && *(a1 + 32))
  {
    v17 = [v9 workQueue];
    v19[0] = MEMORY[0x277D85DD0];
    v19[1] = 3221225472;
    v19[2] = __77__HMDHomeManager_pingDevice_secure_restrictToLocalNetwork_completionHandler___block_invoke_1534;
    v19[3] = &unk_279735738;
    v21 = *(a1 + 32);
    v20 = v5;
    dispatch_async(v17, v19);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handlePing:(id)a3
{
  v54 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:@"kIdentifierKey"];
  if (v5)
  {
    v34 = v4;
    v35 = self;
    v46 = 0u;
    v47 = 0u;
    v44 = 0u;
    v45 = 0u;
    v6 = [(HMDHomeManager *)self accountRegistry];
    v7 = [v6 accounts];

    obj = v7;
    v8 = [v7 countByEnumeratingWithState:&v44 objects:v53 count:16];
    if (v8)
    {
      v9 = v8;
      v37 = *v45;
      while (2)
      {
        for (i = 0; i != v9; ++i)
        {
          if (*v45 != v37)
          {
            objc_enumerationMutation(obj);
          }

          v11 = *(*(&v44 + 1) + 8 * i);
          v40 = 0u;
          v41 = 0u;
          v42 = 0u;
          v43 = 0u;
          v12 = [v11 devices];
          v13 = [v12 countByEnumeratingWithState:&v40 objects:v52 count:16];
          if (v13)
          {
            v14 = v13;
            v15 = *v41;
LABEL_9:
            v16 = 0;
            while (1)
            {
              if (*v41 != v15)
              {
                objc_enumerationMutation(v12);
              }

              v17 = *(*(&v40 + 1) + 8 * v16);
              v18 = [v17 identifier];
              v19 = [v18 isEqual:v5];

              if (v19)
              {
                break;
              }

              if (v14 == ++v16)
              {
                v14 = [v12 countByEnumeratingWithState:&v40 objects:v52 count:16];
                if (v14)
                {
                  goto LABEL_9;
                }

                goto LABEL_15;
              }
            }

            v20 = v17;

            if (!v20)
            {
              continue;
            }

            v4 = v34;
            if ([v34 BOOLForKey:*MEMORY[0x277CD02A8]])
            {
              v29 = +[HMDSecureRemoteMessageTransport defaultTransport];
              v30 = [v29 deviceMonitor];

              [v30 startMonitoringDevice:v20 withInitialReachability:0 forClient:v35];
            }

            v31 = [v34 BOOLForKey:*MEMORY[0x277CD0358]];
            v32 = [v34 BOOLForKey:*MEMORY[0x277CD0290]];
            v38[0] = MEMORY[0x277D85DD0];
            v38[1] = 3221225472;
            v38[2] = __30__HMDHomeManager__handlePing___block_invoke;
            v38[3] = &unk_2797359D8;
            v39 = v34;
            [(HMDHomeManager *)v35 pingDevice:v20 secure:v31 restrictToLocalNetwork:v32 completionHandler:v38];

            goto LABEL_29;
          }

LABEL_15:
        }

        v9 = [obj countByEnumeratingWithState:&v44 objects:v53 count:16];
        if (v9)
        {
          continue;
        }

        break;
      }
    }

    v21 = objc_autoreleasePoolPush();
    v22 = v35;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543618;
      v49 = v24;
      v50 = 2112;
      v51 = v5;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Failed to find device with identifier: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v21);
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    v4 = v34;
  }

  else
  {
    v25 = objc_autoreleasePoolPush();
    v26 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_ERROR))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543362;
      v49 = v28;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_ERROR, "%{public}@Message is missing device identifier", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v25);
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
  }

  [v4 respondWithError:v20];
LABEL_29:

  v33 = *MEMORY[0x277D85DE8];
}

void __30__HMDHomeManager__handlePing___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = [*(a1 + 32) responseHandler];

  if (v3)
  {
    v4 = [*(a1 + 32) responseHandler];
    (v4)[2](v4, v5, 0);
  }
}

- (void)_handleRemoveAccount:(id)a3
{
  v79 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 messagePayload];
  v6 = [v5 valueForKey:@"kIdentifierKey"];

  if (v6)
  {
    v7 = [v4 uuidForKey:@"kIdentifierKey"];
    if (v7)
    {
      v68 = v4;
      v72 = 0u;
      v73 = 0u;
      v70 = 0u;
      v71 = 0u;
      v8 = [(HMDHomeManager *)self accountRegistry];
      v9 = [v8 accounts];

      v10 = [v9 countByEnumeratingWithState:&v70 objects:v78 count:16];
      if (v10)
      {
        v11 = v10;
        v12 = *v71;
LABEL_5:
        v13 = 0;
        while (1)
        {
          if (*v71 != v12)
          {
            objc_enumerationMutation(v9);
          }

          v14 = *(*(&v70 + 1) + 8 * v13);
          v15 = [v14 identifier];
          v16 = [v15 identifier];
          v17 = [v16 hmf_isEqualToUUID:v7];

          if (v17)
          {
            break;
          }

          if (v11 == ++v13)
          {
            v11 = [v9 countByEnumeratingWithState:&v70 objects:v78 count:16];
            if (v11)
            {
              goto LABEL_5;
            }

            goto LABEL_11;
          }
        }

        v25 = v14;

        if (!v25)
        {
          goto LABEL_24;
        }

        v4 = v68;
        goto LABEL_19;
      }

LABEL_11:

LABEL_24:
      v34 = objc_autoreleasePoolPush();
      v35 = self;
      v36 = HMFGetOSLogHandle();
      v4 = v68;
      if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
      {
        v37 = HMFGetLogIdentifier();
        *buf = 138543618;
        v75 = v37;
        v76 = 2112;
        v77 = v7;
        _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to find matching account with identifier: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v34);
      v25 = [v68 responseHandler];

      if (!v25)
      {
        goto LABEL_46;
      }

      v38 = 2;
    }

    else
    {
      v39 = objc_autoreleasePoolPush();
      v40 = self;
      v41 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v41, OS_LOG_TYPE_ERROR))
      {
        v42 = HMFGetLogIdentifier();
        *buf = 138543362;
        v75 = v42;
        _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_ERROR, "%{public}@Message is missing account identifier", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v39);
      v25 = [v4 responseHandler];

      if (!v25)
      {
        goto LABEL_46;
      }

      v38 = 3;
    }

    v43 = MEMORY[0x277CCA9B8];
    goto LABEL_33;
  }

  v18 = [v4 messagePayload];
  v19 = *MEMORY[0x277CD00E8];
  v20 = [v18 valueForKey:*MEMORY[0x277CD00E8]];

  if (!v20)
  {
    v46 = objc_autoreleasePoolPush();
    v47 = self;
    v48 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      v49 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v49;
      v50 = "%{public}@Message is missing account identifier";
LABEL_42:
      _os_log_impl(&dword_2531F8000, v48, OS_LOG_TYPE_ERROR, v50, buf, 0xCu);
    }

LABEL_43:

    objc_autoreleasePoolPop(v46);
    v55 = [v4 responseHandler];

    if (!v55)
    {
      v25 = 0;
      goto LABEL_47;
    }

    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    v44 = [v4 responseHandler];
    v44[2](v44, v7, 0);
    goto LABEL_45;
  }

  v21 = [v4 stringForKey:v19];
  if (!v21)
  {
    v46 = objc_autoreleasePoolPush();
    v47 = self;
    v48 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v48, OS_LOG_TYPE_ERROR))
    {
      v49 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v49;
      v50 = "%{public}@Message is missing account handle";
      goto LABEL_42;
    }

    goto LABEL_43;
  }

  v7 = v21;
  v22 = [HMDAccountHandle accountHandleForDestination:v21];
  if (!v22)
  {
    v57 = objc_autoreleasePoolPush();
    v58 = self;
    v59 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v59, OS_LOG_TYPE_ERROR))
    {
      v60 = HMFGetLogIdentifier();
      *buf = 138543618;
      v75 = v60;
      v76 = 2112;
      v77 = v7;
      _os_log_impl(&dword_2531F8000, v59, OS_LOG_TYPE_ERROR, "%{public}@Invalid account handle: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v57);
    v25 = [v4 responseHandler];

    if (!v25)
    {
      goto LABEL_46;
    }

    v43 = MEMORY[0x277CCA9B8];
    v38 = 19;
LABEL_33:
    v44 = [v43 hmErrorWithCode:v38];
    v45 = [v4 responseHandler];
    v45[2](v45, v44, 0);

LABEL_45:
    v25 = 0;
    goto LABEL_46;
  }

  v23 = v22;
  v69 = 0;
  v24 = +[HMDAccountRegistry sharedRegistry];
  v25 = [v24 accountForHandle:v23 exists:&v69];

  if ((v69 & 1) == 0)
  {
    v61 = objc_autoreleasePoolPush();
    v62 = self;
    v63 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_ERROR))
    {
      v64 = HMFGetLogIdentifier();
      *buf = 138543618;
      v75 = v64;
      v76 = 2112;
      v77 = v23;
      _os_log_impl(&dword_2531F8000, v63, OS_LOG_TYPE_ERROR, "%{public}@Failed to find account with handle: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v61);
    v65 = [v4 responseHandler];

    if (v65)
    {
      v66 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v67 = [v4 responseHandler];
      (v67)[2](v67, v66, 0);
    }

    goto LABEL_46;
  }

LABEL_19:
  v26 = [v25 isCurrentAccount];
  v27 = objc_autoreleasePoolPush();
  v28 = self;
  v29 = HMFGetOSLogHandle();
  v30 = v29;
  if (v26)
  {
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v31;
      _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Cannot remove current account", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v27);
    v32 = [v4 responseHandler];

    if (v32)
    {
      v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
      v33 = [v4 responseHandler];
      v33[2](v33, v7, 0);

LABEL_46:
    }
  }

  else
  {
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      v51 = HMFGetLogIdentifier();
      v52 = [v25 shortDescription];
      *buf = 138543618;
      v75 = v51;
      v76 = 2112;
      v77 = v52;
      _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_DEFAULT, "%{public}@Removing account: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v27);
    v53 = [(HMDHomeManager *)v28 remoteAccountManager];
    [v53 removeAccount:v25];

    v54 = [v4 responseHandler];

    if (v54)
    {
      v7 = [v4 responseHandler];
      v7[2](v7, 0, 0);
      goto LABEL_46;
    }
  }

LABEL_47:

  v56 = *MEMORY[0x277D85DE8];
}

- (void)_handleResolveAccount:(id)a3
{
  v27 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD00E8]];
  if (v5)
  {
    v6 = [HMDAccountHandle accountHandleForDestination:v5];
    if (v6)
    {
      objc_initWeak(location, self);
      v7 = +[HMDAccountRegistry sharedRegistry];
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __40__HMDHomeManager__handleResolveAccount___block_invoke;
      v21[3] = &unk_279732D18;
      objc_copyWeak(&v23, location);
      v22 = v4;
      [v7 _resolveAccountForHandle:v6 completionHandler:v21];

      objc_destroyWeak(&v23);
      objc_destroyWeak(location);
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = self;
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        *location = 138543618;
        *&location[4] = v17;
        v25 = 2112;
        v26 = v5;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Invalid account handle: %@", location, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v6 = [v4 responseHandler];

      if (v6)
      {
        v18 = [MEMORY[0x277CCA9B8] hmErrorWithCode:19];
        v19 = [v4 responseHandler];
        (v19)[2](v19, v18, 0);

        v6 = 0;
      }
    }

    goto LABEL_12;
  }

  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
  {
    v11 = HMFGetLogIdentifier();
    *location = 138543362;
    *&location[4] = v11;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_ERROR, "%{public}@Message is missing account handle", location, 0xCu);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [v4 responseHandler];

  if (v12)
  {
    v6 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    v13 = [v4 responseHandler];
    (v13)[2](v13, v6, 0);

LABEL_12:
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__handleResolveAccount___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v8 = objc_autoreleasePoolPush();
  v9 = WeakRetained;
  v10 = HMFGetOSLogHandle();
  v11 = v10;
  if (v5)
  {
    if (!os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_7;
    }

    v12 = HMFGetLogIdentifier();
    v13 = [v5 shortDescription];
    v17 = 138543618;
    v18 = v12;
    v19 = 2112;
    v20 = v13;
    _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Resolved account: %@", &v17, 0x16u);
  }

  else
  {
    if (!os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v12 = HMFGetLogIdentifier();
    v17 = 138543618;
    v18 = v12;
    v19 = 2112;
    v20 = v6;
    _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@Failed to resolved account with error: %@", &v17, 0x16u);
  }

LABEL_7:
  objc_autoreleasePoolPop(v8);
  v14 = [*(a1 + 32) responseHandler];

  if (v14)
  {
    v15 = [*(a1 + 32) responseHandler];
    (v15)[2](v15, v6, 0);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_removeCurrentResidentDeviceFromHomes:(id)a3
{
  v33 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = +[HMDDeviceCapabilities deviceCapabilities];
  v6 = [v5 isResidentCapable];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self appleAccountManager];
    v8 = [v7 device];

    v29 = 0u;
    v30 = 0u;
    v27 = 0u;
    v28 = 0u;
    v22 = v4;
    v9 = v4;
    v10 = [v9 countByEnumeratingWithState:&v27 objects:v32 count:16];
    if (v10)
    {
      v11 = v10;
      v12 = *v28;
      do
      {
        for (i = 0; i != v11; ++i)
        {
          if (*v28 != v12)
          {
            objc_enumerationMutation(v9);
          }

          v14 = *(*(&v27 + 1) + 8 * i);
          if (v8)
          {
LABEL_8:
            if ([v14 isOwnerUser])
            {
              [v14 removeResidentCapableDevice:v8];
            }
          }

          else
          {
            v25 = 0u;
            v26 = 0u;
            v23 = 0u;
            v24 = 0u;
            v15 = [v14 residentCapableDevices];
            v16 = [v15 countByEnumeratingWithState:&v23 objects:v31 count:16];
            if (v16)
            {
              v17 = v16;
              v18 = *v24;
LABEL_12:
              v19 = 0;
              while (1)
              {
                if (*v24 != v18)
                {
                  objc_enumerationMutation(v15);
                }

                v20 = *(*(&v23 + 1) + 8 * v19);
                if ([v20 isCurrentDevice])
                {
                  break;
                }

                if (v17 == ++v19)
                {
                  v17 = [v15 countByEnumeratingWithState:&v23 objects:v31 count:16];
                  if (v17)
                  {
                    goto LABEL_12;
                  }

                  goto LABEL_18;
                }
              }

              v8 = v20;

              if (v8)
              {
                goto LABEL_8;
              }
            }

            else
            {
LABEL_18:

              v8 = 0;
            }
          }
        }

        v11 = [v9 countByEnumeratingWithState:&v27 objects:v32 count:16];
      }

      while (v11);
    }

    v4 = v22;
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_addCurrentResidentDeviceToHomes:(id)a3
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ([(HMDHomeManager *)self isResidentEnabled])
  {
    v5 = [(HMDHomeManager *)self appleAccountManager];
    v6 = [v5 device];

    if (v6)
    {
      v7 = [v6 capabilities];
      v8 = [v7 isResidentCapable];

      if (v8)
      {
        v21 = 0u;
        v22 = 0u;
        v19 = 0u;
        v20 = 0u;
        v9 = v4;
        v10 = [v9 countByEnumeratingWithState:&v19 objects:v23 count:16];
        if (v10)
        {
          v11 = v10;
          v12 = *v20;
          do
          {
            for (i = 0; i != v11; ++i)
            {
              if (*v20 != v12)
              {
                objc_enumerationMutation(v9);
              }

              v14 = *(*(&v19 + 1) + 8 * i);
              if ([v14 isOwnerUser] && objc_msgSend(v14, "hasReachableAccessories"))
              {
                [v14 addResidentCapableDevice:v6];
              }
            }

            v11 = [v9 countByEnumeratingWithState:&v19 objects:v23 count:16];
          }

          while (v11);
        }
      }
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543362;
      v25 = v17;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEBUG, "%{public}@Not adding ourselves as a resident as we are disabled as a resident", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)handleHomeCurrentDeviceResidentEligibleNotification:(id)a3
{
  v4 = a3;
  v5 = +[HMDDeviceCapabilities deviceCapabilities];
  v6 = [v5 isResidentCapable];

  if (v6)
  {
    v7 = [v4 object];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = v7;
    }

    else
    {
      v8 = 0;
    }

    v9 = v8;

    if ([v9 hasReachableAccessories])
    {
      v10 = [(HMDHomeManager *)self workQueue];
      v11[0] = MEMORY[0x277D85DD0];
      v11[1] = 3221225472;
      v11[2] = __70__HMDHomeManager_handleHomeCurrentDeviceResidentEligibleNotification___block_invoke;
      v11[3] = &unk_2797359B0;
      v11[4] = self;
      v12 = v9;
      dispatch_async(v10, v11);
    }
  }
}

void __70__HMDHomeManager_handleHomeCurrentDeviceResidentEligibleNotification___block_invoke(uint64_t a1)
{
  v4[1] = *MEMORY[0x277D85DE8];
  v1 = *(a1 + 32);
  v4[0] = *(a1 + 40);
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v4 count:1];
  [v1 _addCurrentResidentDeviceToHomes:v2];

  v3 = *MEMORY[0x277D85DE8];
}

- (void)_updateResidentEnabledOnThisDevice:(BOOL)a3 forceNotify:(BOOL)a4 message:(id)a5
{
  v5 = a4;
  v6 = a3;
  v41 = *MEMORY[0x277D85DE8];
  v8 = a5;
  if ([(HMDHomeManager *)self isResidentCapable])
  {
    v9 = [(HMDHomeManager *)self residentEnabledState];
    if (v6)
    {
      if (v9 != 2)
      {
        [(HMDHomeManager *)self setResidentEnabledState:2];
        v5 = 1;
      }

      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543362;
        v40 = v13;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Enabled as a resident device, adding ourselves as a resident to all homes", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v10);
      v14 = [(HMDHomeManager *)v11 homes];
      [(HMDHomeManager *)v11 _addCurrentResidentDeviceToHomes:v14];

      v15 = [(HMDHomeManager *)v11 messageDispatcher];
      [v15 enableMessageServer];
    }

    else
    {
      if (v9 != 1)
      {
        v5 = 1;
        [(HMDHomeManager *)self setResidentEnabledState:1];
      }

      v20 = objc_autoreleasePoolPush();
      v21 = self;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543362;
        v40 = v23;
        _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@Disabled as a resident device, removing ourselves as a resident from all homes", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v20);
      v24 = [(HMDHomeManager *)v21 homes];
      [(HMDHomeManager *)v21 _removeCurrentResidentDeviceFromHomes:v24];

      v15 = [(HMDHomeManager *)v21 messageDispatcher];
      [v15 disableMessageServer];
    }
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = self;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v40 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Not resident capable, removing ourselves as a resident from all homes", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v15 = [(HMDHomeManager *)v17 homes];
    [(HMDHomeManager *)v17 _removeCurrentResidentDeviceFromHomes:v15];
  }

  if (v8 || v5)
  {
    v37 = @"kResidentEnabledKey";
    v25 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentEnabled](self, "isResidentEnabled")}];
    v38 = v25;
    v26 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v38 forKeys:&v37 count:1];

    v27 = MEMORY[0x277D0F818];
    v28 = [v8 identifier];
    v29 = [v27 entitledMessageWithName:@"kResidentEnabledForThisDeviceUpdatedNotificationKey" identifier:v28 messagePayload:v26];

    v30 = [(HMDHomeManager *)self messageDispatcher];
    v31 = [(HMDHomeManager *)self uuid];
    v35[0] = MEMORY[0x277D85DD0];
    v35[1] = 3221225472;
    v35[2] = __73__HMDHomeManager__updateResidentEnabledOnThisDevice_forceNotify_message___block_invoke;
    v35[3] = &unk_279735D00;
    v36 = v8;
    [v30 sendMessage:v29 target:v31 andInvokeCompletionHandler:v35];

    v32 = [(HMDHomeManager *)self notificationCenter];
    [v32 postNotificationName:@"HMDHomeManagerResidentEnabledChangedNotification" object:self userInfo:v26];
  }

  v33 = [v8 name];
  [(HMDHomeManager *)self saveWithReason:v33 information:0 saveOptions:0];

  v34 = *MEMORY[0x277D85DE8];
}

void __73__HMDHomeManager__updateResidentEnabledOnThisDevice_forceNotify_message___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) responseHandler];

  if (v2)
  {
    v3 = [*(a1 + 32) responseHandler];
    (*(v3 + 2))(v3, 0, 0);
  }
}

- (void)_handleEnableResidentForThisDeviceRequest:(id)a3
{
  v4 = a3;
  v9 = 0;
  v5 = [v4 BOOLForKey:@"kResidentEnabledKey" keyPresent:&v9];
  if (v9 == 1)
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:v5 forceNotify:0 message:v4];
  }

  else
  {
    v6 = [v4 responseHandler];

    if (v6)
    {
      v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      v8 = [v4 responseHandler];
      (v8)[2](v8, v7, 0);
    }
  }
}

- (void)notifyClientsResidentCapable:(BOOL)a3
{
  v3 = a3;
  v13[1] = *MEMORY[0x277D85DE8];
  v5 = MEMORY[0x277D0F818];
  v12 = @"kResidentCapableDeviceKey";
  v6 = [MEMORY[0x277CCABB0] numberWithBool:?];
  v13[0] = v6;
  v7 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v13 forKeys:&v12 count:1];
  v8 = [v5 entitledMessageWithName:@"kResidentDeviceCapableUpdatedNotificationKey" messagePayload:v7];

  v9 = [(HMDHomeManager *)self messageDispatcher];
  v10 = [(HMDHomeManager *)self uuid];
  [v9 sendMessage:v8 target:v10 andInvokeCompletionHandler:0];

  if (v3 && [(HMDHomeManager *)self isResidentEnabled])
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:1 forceNotify:1 message:0];
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (BOOL)isResidentEnabled
{
  v3 = [(HMDHomeManager *)self isResidentCapable];
  if (v3)
  {
    LOBYTE(v3) = [(HMDHomeManager *)self residentEnabledState]== 2;
  }

  return v3;
}

- (BOOL)isResidentCapable
{
  v2 = +[HMDDeviceCapabilities deviceCapabilities];
  v3 = [v2 isResidentCapable];

  return v3;
}

- (void)processAppDataModelRemove:(id)a3 message:(id)a4
{
  v5 = a4;
  [(HMDHomeManager *)self setAppData:0];
  [v5 respondWithPayload:0];
}

- (void)processAppDataModelUpdate:(id)a3 message:(id)a4
{
  v25 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self appData];

  if (v8)
  {
    v9 = [(HMDHomeManager *)self appData];
    [v9 updateWithModel:v6];
  }

  else
  {
    v10 = [HMDApplicationData alloc];
    v11 = [v6 appDataDictionary];
    v12 = [(HMDHomeManager *)self uuid];
    v13 = [(HMDApplicationData *)v10 initWithDictionary:v11 parentUUID:v12];
    [(HMDHomeManager *)self setAppData:v13];

    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
    {
      v17 = HMFGetLogIdentifier();
      v18 = [v6 appDataDictionary];
      v21 = 138543618;
      v22 = v17;
      v23 = 2112;
      v24 = v18;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEBUG, "%{public}@Updating the application data : %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v19 = [v7 transactionResult];
  [v19 markChanged];
  [v7 respondWithPayload:0];

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_setAppDataWithMessage:(id)a3
{
  v31 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = @"com.apple.homekit-entitledclient.identifer";
  v6 = [(HMDHomeManager *)self appData];
  v7 = [v6 copy];
  v26 = 0;
  v8 = [v4 appDataDictionaryWithError:&v26];
  v9 = v26;
  if (v8)
  {
    v10 = objc_autoreleasePoolPush();
    v11 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543618;
      v28 = v13;
      v29 = 2112;
      v30 = v8;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Client needs to set home manager appData to %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    if ([v8 count])
    {
      if (!v7)
      {
        v14 = [HMDApplicationData alloc];
        v15 = [(HMDHomeManager *)v11 uuid];
        v7 = [(HMDApplicationData *)v14 initWithParentUUID:v15];
      }

      [(HMDApplicationData *)v7 setApplicationData:v8 forIdentifier:@"com.apple.homekit-entitledclient.identifer"];
      v16 = [(HMDApplicationData *)v7 modelObjectWithChangeType:1];
      v17 = v16;
      if (!v6)
      {
        [v16 setObjectChangeType:1];
      }
    }

    else
    {
      [(HMDApplicationData *)v7 removeApplicationDataForIdentifier:@"com.apple.homekit-entitledclient.identifer"];
      if (v7)
      {
        v17 = [(HMDApplicationData *)v7 modelObjectWithChangeType:1];
      }

      else
      {
        v17 = 0;
      }
    }

    v18 = [(HMDHomeManager *)v11 mobileAssetManager];

    if (!v18)
    {
      v19 = objc_alloc_init(HMDMobileAssetManager);
      [(HMDHomeManager *)v11 setMobileAssetManager:v19];
    }

    v20 = [(HMDHomeManager *)v11 mobileAssetManager];
    [v20 handleMetadataAssetUpdated];

    if (v17)
    {
      v21 = [(HMDHomeManager *)v11 backingStore];
      v22 = [v4 name];
      v23 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v24 = [v21 transaction:v22 options:v23];

      [v24 add:v17 withMessage:v4];
      [v24 run];
    }

    else
    {
      [v4 respondWithPayload:0];
    }
  }

  else
  {
    [v4 respondWithError:v9];
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (void)setAppDataWithMessage:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __40__HMDHomeManager_setAppDataWithMessage___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)_teardownRemoteAccessForHomeCommon:(id)a3 isCompanion:(BOOL)a4
{
  v4 = a4;
  v38 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [(HMDHomeManager *)self _homeWithUUID:v6];
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = [v6 UUIDString];
    *buf = 138543618;
    v35 = v10;
    v36 = 2112;
    v37 = v11;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Tearing down any previously setup remote access for home: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [(HMDHomeManager *)self messageDispatcher];
  v13 = v12;
  if (v4)
  {
    [v12 setCompanionDevice:0 forHome:v7];
  }

  else
  {
    [v12 setRemoteAccessDevice:0 forHome:v7];
  }

  v31 = 0u;
  v32 = 0u;
  v29 = 0u;
  v30 = 0u;
  v14 = [(HMDHomeManager *)self pendingRemoteSessions];
  v15 = [v14 countByEnumeratingWithState:&v29 objects:v33 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v30;
LABEL_8:
    v18 = 0;
    while (1)
    {
      if (*v30 != v17)
      {
        objc_enumerationMutation(v14);
      }

      v19 = *(*(&v29 + 1) + 8 * v18);
      v20 = [(HMDHomeManager *)self pendingRemoteSessions];
      v21 = [v20 objectForKeyedSubscript:v19];

      if ([v21 isEqual:v6])
      {
        break;
      }

      if (v16 == ++v18)
      {
        v16 = [v14 countByEnumeratingWithState:&v29 objects:v33 count:16];
        if (v16)
        {
          goto LABEL_8;
        }

        goto LABEL_14;
      }
    }

    v22 = v19;

    if (!v22)
    {
      goto LABEL_20;
    }

    v23 = objc_autoreleasePoolPush();
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
    {
      v25 = HMFGetLogIdentifier();
      v26 = [v22 UUIDString];
      *buf = 138543618;
      v35 = v25;
      v36 = 2112;
      v37 = v26;
      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Clearing pending remote session with identifier %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v23);
    v27 = [(HMDHomeManager *)self pendingRemoteSessions];
    [v27 removeObjectForKey:v22];
  }

  else
  {
LABEL_14:
    v22 = v14;
  }

LABEL_20:
  v28 = *MEMORY[0x277D85DE8];
}

- (void)_teardownRemoteAccessForHomeThroughCompanion:(id)a3
{
  v4 = a3;
  if (isWatch())
  {
    [(HMDHomeManager *)self _teardownRemoteAccessForHomeCommon:v4 isCompanion:1];
  }
}

- (void)_teardownRemoteAccessForHome:(id)a3
{
  v7 = a3;
  v4 = [(HMDHomeManager *)self _homeWithUUID:?];
  v5 = [v4 residentDeviceManager];
  v6 = [v5 isResidentAvailable];

  if ((v6 & 1) == 0)
  {
    [(HMDHomeManager *)self _teardownRemoteAccessForHomeCommon:v7 isCompanion:0];
  }
}

- (void)teardownRemoteAccessForHome:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __46__HMDHomeManager_teardownRemoteAccessForHome___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)sendRequestForInvitation:(id)a3 homeUUID:(id)a4 payload:(id)a5 invitationState:(int64_t)a6 responseHandler:(id)a7
{
  v11 = a7;
  v12 = a5;
  v13 = a4;
  v14 = [a3 invitationData];
  v15 = [MEMORY[0x277D0F818] internalMessageWithName:@"kUpdateHomeInvitationStateInternalRequestKey" messagePayload:v12];

  v16 = [v14 inviterUserID];
  v17 = [(HMDHomeManager *)self workQueue];
  v20[0] = MEMORY[0x277D85DD0];
  v20[1] = 3221225472;
  v20[2] = __92__HMDHomeManager_sendRequestForInvitation_homeUUID_payload_invitationState_responseHandler___block_invoke;
  v20[3] = &unk_279732CF0;
  v21 = v15;
  v22 = v11;
  v18 = v15;
  v19 = v11;
  [(HMDHomeManager *)self sendUnsecureMessage:v18 target:v13 userID:v16 responseQueue:v17 responseHandler:v20];
}

void __92__HMDHomeManager_sendRequestForInvitation_homeUUID_payload_invitationState_responseHandler___block_invoke(uint64_t a1, void *a2)
{
  v3 = *(a1 + 32);
  v2 = *(a1 + 40);
  v4 = a2;
  v5 = [v3 name];
  (*(v2 + 16))(v2, v5, v4);
}

- (void)__sendUpdateRequestToAdminForInvitation:(id)a3 homeUUID:(id)a4 invitationState:(int64_t)a5 authStatus:(id)a6
{
  v51[2] = *MEMORY[0x277D85DE8];
  v10 = a3;
  v35 = a4;
  v34 = a6;
  v50[0] = @"kInvitationIdentifierKey";
  v11 = [v10 identifier];
  v12 = [v11 UUIDString];
  v50[1] = @"kInvitationStateKey";
  v51[0] = v12;
  v13 = [MEMORY[0x277CCABB0] numberWithInteger:a5];
  v51[1] = v13;
  v14 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v51 forKeys:v50 count:2];
  v15 = [v14 mutableCopy];

  if (a5 == 3)
  {
    v16 = objc_autoreleasePoolPush();
    v17 = self;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v49 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Get or create controller key before sending invite accept", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v46 = 0;
    v47 = 0;
    v20 = [(HMDHomeManager *)v17 getOrCreateControllerPublicKey:&v47 controllerUsername:&v46 error:0];
    v21 = v47;
    v22 = v46;
    if (v20)
    {
      [v15 setObject:v21 forKeyedSubscript:@"kControllerPublicKey"];
      [v15 setObject:v22 forKeyedSubscript:@"kControllerPairingNameKey"];
    }

    v23 = [(HMDHomeManager *)v17 appleAccountManager];
    v24 = [v23 account];
    v25 = [v24 primaryHandle];

    if (v25)
    {
      v26 = +[HMDAccountHandleFormatter defaultFormatter];
      v27 = [v26 stringForObjectValue:v25];

      if (v27)
      {
        [v15 setObject:v27 forKeyedSubscript:@"kUserIDKey"];
      }
    }

    v28 = [v10 inviterAccount];
    if (v28)
    {
      v29 = +[HMDIdentityRegistry sharedRegistry];
      v30 = [v10 inviterIdentity];
      [v29 registerIdentity:v30 account:v28 object:v10];
    }

    if (v34)
    {
      [v34 addToPayload:v15];
    }
  }

  objc_initWeak(buf, self);
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __94__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus___block_invoke;
  aBlock[3] = &unk_279732CA0;
  objc_copyWeak(&v45, buf);
  aBlock[4] = self;
  v31 = v10;
  v44 = v31;
  v32 = _Block_copy(aBlock);
  if (a5 == 3)
  {
    objc_initWeak(&location, self);
    v36[0] = MEMORY[0x277D85DD0];
    v36[1] = 3221225472;
    v36[2] = __94__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus___block_invoke_1531;
    v36[3] = &unk_279732CC8;
    objc_copyWeak(v41, &location);
    v37 = v31;
    v38 = v35;
    v39 = v15;
    v41[1] = 3;
    v40 = v32;
    [(HMDHomeManager *)self addIssuerKeyToMessagePayload:v39 invitation:v37 completion:v36];

    objc_destroyWeak(v41);
    objc_destroyWeak(&location);
  }

  else
  {
    [(HMDHomeManager *)self sendRequestForInvitation:v31 homeUUID:v35 payload:v15 invitationState:a5 responseHandler:v32];
  }

  objc_destroyWeak(&v45);
  objc_destroyWeak(buf);

  v33 = *MEMORY[0x277D85DE8];
}

void __94__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus___block_invoke(id *a1, void *a2, void *a3)
{
  v38 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  if (!WeakRetained)
  {
    goto LABEL_18;
  }

  v8 = objc_autoreleasePoolPush();
  v9 = a1[4];
  v10 = HMFGetOSLogHandle();
  v11 = os_log_type_enabled(v10, OS_LOG_TYPE_INFO);
  if (!v6)
  {
    if (v11)
    {
      v23 = HMFGetLogIdentifier();
      v24 = [a1[5] describeWithFormat];
      v32 = 138543618;
      v33 = v23;
      v34 = 2112;
      v35 = v24;
      v25 = "%{public}@Modified invitation state for invite %@";
LABEL_13:
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, v25, &v32, 0x16u);
    }

LABEL_14:

    objc_autoreleasePoolPop(v8);
    goto LABEL_18;
  }

  if (v11)
  {
    v12 = HMFGetLogIdentifier();
    v13 = [a1[5] describeWithFormat];
    v32 = 138543874;
    v33 = v12;
    v34 = 2112;
    v35 = v13;
    v36 = 2112;
    v37 = v6;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Failed to modify invitation state for invite %@ due to error %@", &v32, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  v14 = [v6 code];
  v15 = [v6 code];
  v16 = [v6 code];
  v17 = [v6 code];
  if (v15 != 1006 && v17 != 1008)
  {
    if (v16 == 1007)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = a1[4];
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
      {
        v21 = HMFGetLogIdentifier();
        v22 = [a1[5] describeWithFormat];
        v32 = 138543618;
        v33 = v21;
        v34 = 2112;
        v35 = v22;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Updating invitation (%@) to accepted and pending to match sender state", &v32, 0x16u);
      }

      objc_autoreleasePoolPop(v18);
      [WeakRetained _postIncomingInvitationStateChangedNotification:a1[5] newInvitationState:5];
      [WeakRetained saveWithReason:v5 information:0 postSyncNotification:0];
      goto LABEL_18;
    }

    if (v14 != 2)
    {
      goto LABEL_18;
    }

    v8 = objc_autoreleasePoolPush();
    v9 = a1[4];
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v23 = HMFGetLogIdentifier();
      v24 = [a1[5] describeWithFormat];
      v32 = 138543618;
      v33 = v23;
      v34 = 2112;
      v35 = v24;
      v25 = "%{public}@Inviter did not find invitation (%@), ignoring response";
      goto LABEL_13;
    }

    goto LABEL_14;
  }

  v26 = objc_autoreleasePoolPush();
  v27 = a1[4];
  v28 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
  {
    v29 = HMFGetLogIdentifier();
    v30 = [a1[5] describeWithFormat];
    v32 = 138543618;
    v33 = v29;
    v34 = 2112;
    v35 = v30;
    _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Updating invitation (%@) to expired since sender could not find it or it was expired", &v32, 0x16u);
  }

  objc_autoreleasePoolPop(v26);
  [a1[5] expire];
LABEL_18:

  v31 = *MEMORY[0x277D85DE8];
}

void __94__HMDHomeManager___sendUpdateRequestToAdminForInvitation_homeUUID_invitationState_authStatus___block_invoke_1531(uint64_t a1, uint64_t a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (!a2 && WeakRetained)
  {
    v5 = WeakRetained;
    [WeakRetained sendRequestForInvitation:*(a1 + 32) homeUUID:*(a1 + 40) payload:*(a1 + 48) invitationState:*(a1 + 72) responseHandler:*(a1 + 56)];
    WeakRetained = v5;
  }
}

- (BOOL)getOrCreateControllerPublicKey:(id *)a3 controllerUsername:(id *)a4 error:(id *)a5
{
  v30 = *MEMORY[0x277D85DE8];
  v25 = 0;
  v9 = [(HMDHomeManager *)self getOrCreateLocalPairingIdentity:&v25];
  v10 = v25;
  v11 = v10;
  if (v10)
  {
    if (a5)
    {
      v12 = v10;
      *a5 = v11;
    }

    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v16 = HMFGetLogIdentifier();
    *buf = 138543618;
    v27 = v16;
    v28 = 2112;
    v29 = v11;
    v17 = "%{public}@Failed to get or create local pairing identity: %@";
    v18 = v15;
    v19 = OS_LOG_TYPE_INFO;
    v20 = 22;
    goto LABEL_6;
  }

  if (!v9)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      goto LABEL_7;
    }

    v16 = HMFGetLogIdentifier();
    *buf = 138543362;
    v27 = v16;
    v17 = "%{public}@Unable to get identity but no error provided";
    v18 = v15;
    v19 = OS_LOG_TYPE_DEFAULT;
    v20 = 12;
LABEL_6:
    _os_log_impl(&dword_2531F8000, v18, v19, v17, buf, v20);

LABEL_7:
    objc_autoreleasePoolPop(v13);
    v21 = 0;
    goto LABEL_14;
  }

  if (a3)
  {
    v22 = [v9 publicKey];
    *a3 = [v22 data];
  }

  if (a4)
  {
    *a4 = [v9 identifier];
  }

  v21 = 1;
LABEL_14:

  v23 = *MEMORY[0x277D85DE8];
  return v21;
}

- (id)getOrCreateLocalPairingIdentity:(id *)a3
{
  v79 = *MEMORY[0x277D85DE8];
  v4 = [MEMORY[0x277CFEC78] systemStore];
  v71 = 0;
  v72 = 0;
  v69 = 0;
  v70 = 0;
  v5 = [v4 getAllAvailableControllerPublicKeys:&v72 secretKeys:&v71 userNames:&v70 error:&v69];
  v6 = v72;
  v7 = v71;
  v8 = v70;
  v9 = v69;

  if (v5)
  {
    v10 = v9 == 0;
  }

  else
  {
    v10 = 0;
  }

  if (v10 && v6 != 0 && v8 != 0)
  {
    if ([v8 count])
    {
      v13 = [v8 count];
      if (v13 == [v6 count])
      {
        v14 = [v6 objectAtIndexedSubscript:0];
        v15 = [v7 objectAtIndexedSubscript:0];
        v16 = [v8 objectAtIndexedSubscript:0];
        if ([v8 count] < 2)
        {
          v44 = [MEMORY[0x277CFEC78] systemStore];
          v45 = [v44 activeControllerPairingIdentifier];

          if (v45)
          {
LABEL_39:
            v41 = a3;
            goto LABEL_40;
          }

          v60 = v7;
          v17 = objc_autoreleasePoolPush();
          v46 = self;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v76 = v20;
            v77 = 2112;
            v78 = v16;
            v21 = "%{public}@Setting controller key as active as none was found: %@";
            goto LABEL_37;
          }
        }

        else
        {
          v60 = v7;
          v17 = objc_autoreleasePoolPush();
          v18 = self;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v76 = v20;
            v77 = 2112;
            v78 = v16;
            v21 = "%{public}@Found multiple controller keys, using first entry as the controller username: %@";
LABEL_37:
            _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_DEFAULT, v21, buf, 0x16u);
          }
        }

        objc_autoreleasePoolPop(v17);
        v47 = [MEMORY[0x277CFEC78] systemStore];
        [v47 updateActiveControllerPairingIdentifier:v16];

        v7 = v60;
        goto LABEL_39;
      }
    }
  }

  v22 = +[HMDDeviceCapabilities deviceCapabilities];
  if (![v22 supportsKeychainSync])
  {
    v39 = +[HMDDeviceCapabilities deviceCapabilities];
    if ([v39 isRemoteGatewayCapable])
    {
      v40 = +[HMDKeyTransferAgentServer isPeerAvailable];

      if (!v40)
      {
        goto LABEL_18;
      }
    }

    else
    {
    }

    v29 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    v16 = 0;
    v15 = 0;
    v14 = 0;
    goto LABEL_30;
  }

LABEL_18:
  v61 = v7;
  v23 = objc_autoreleasePoolPush();
  v24 = self;
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
  {
    v26 = HMFGetLogIdentifier();
    *buf = 138543362;
    v76 = v26;
    _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Local controller key does not exist, creating one", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v23);
  v27 = [MEMORY[0x277CFEC78] systemStore];
  v67 = 0;
  v68 = 0;
  v65 = v9;
  v66 = 0;
  v28 = [v27 getControllerPublicKey:&v68 secretKey:&v67 username:&v66 allowCreation:1 error:&v65];
  v14 = v68;
  v15 = v67;
  v16 = v66;
  v29 = v65;

  if (!v28)
  {
    v7 = v61;
    goto LABEL_31;
  }

  v30 = objc_autoreleasePoolPush();
  v31 = v24;
  v32 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v32, OS_LOG_TYPE_DEFAULT))
  {
    v33 = HMFGetLogIdentifier();
    *buf = 138543362;
    v76 = v33;
    _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_DEFAULT, "%{public}@Created new local controller key, forcing push to HomeManager zone to anchor key...", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v30);
  v34 = [HMDHomeManagerModel alloc];
  v35 = [(HMDHomeManager *)v31 uuid];
  v9 = [(HMDBackingStoreModelObject *)v34 initWithObjectChangeType:1 uuid:v35 parentUUID:0];

  [(HMDHomeManagerModel *)v9 setControllerKeyIdentifier:v16];
  v36 = [(HMDHomeManager *)v31 backingStore];
  v37 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
  v38 = [v36 transaction:@"HMD.hm" options:v37];

  [v38 add:v9 withMessage:0];
  [v38 run];

  v7 = v61;
LABEL_30:

LABEL_31:
  v41 = a3;
  if (v29)
  {
    if (a3)
    {
      v42 = v29;
      v43 = 0;
      *a3 = v29;
      goto LABEL_48;
    }

    goto LABEL_47;
  }

LABEL_40:
  if (v14 && v15 && v16)
  {
    v48 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v14];
    v49 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v15];
    v43 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:v16 publicKey:v48 privateKey:v49 permissions:0];

    v29 = 0;
    goto LABEL_48;
  }

  if (v41)
  {
    v62 = MEMORY[0x277CCA9B8];
    v50 = *MEMORY[0x277CCFD28];
    v73 = *MEMORY[0x277CCA450];
    [MEMORY[0x277CCA8D8] mainBundle];
    v64 = v15;
    v52 = v51 = v41;
    v53 = [v52 localizedStringForKey:@"Unable to get local pairing identity" value:&stru_286509E58 table:0];
    v74 = v53;
    [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v74 forKeys:&v73 count:1];
    v54 = v14;
    v55 = v6;
    v57 = v56 = v7;
    *v51 = [v62 errorWithDomain:v50 code:2 userInfo:v57];
    v15 = v64;

    v7 = v56;
    v6 = v55;
    v14 = v54;
  }

  v29 = 0;
LABEL_47:
  v43 = 0;
LABEL_48:

  v58 = *MEMORY[0x277D85DE8];

  return v43;
}

- (BOOL)_submitSpamReportToIDS:(id)a3
{
  v51 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [MEMORY[0x277CBEB38] dictionary];
  v6 = +[HMDAppleAccountManager sharedManager];
  v7 = [v6 account];
  v8 = [v7 handles];
  v9 = [v8 firstObject];
  v10 = [v9 remoteDestinationString];

  v11 = [v4 inviterUserID];
  if (!v11)
  {
    goto LABEL_15;
  }

  v12 = v11;
  v13 = [v4 homeName];
  if (!v13)
  {
    goto LABEL_14;
  }

  v14 = v13;
  v15 = [v4 identifier];
  if (!v15)
  {

LABEL_14:
    goto LABEL_15;
  }

  v16 = v15;
  v17 = [v4 startDate];

  if (v17 && v10)
  {
    v18 = [v4 inviterUserID];
    [v5 setObject:v18 forKeyedSubscript:*MEMORY[0x277D18A70]];

    v19 = [v4 homeName];
    [v5 setObject:v19 forKeyedSubscript:@"home-name"];

    v20 = [v4 identifier];
    v21 = [v20 UUIDString];
    [v5 setObject:v21 forKeyedSubscript:*MEMORY[0x277D18A60]];

    v22 = MEMORY[0x277CCABB0];
    v23 = [v4 startDate];
    [v23 timeIntervalSince1970];
    v25 = [v22 numberWithInteger:v24];
    [v5 setObject:v25 forKeyedSubscript:*MEMORY[0x277D18A80]];

    [v5 setObject:v10 forKeyedSubscript:*MEMORY[0x277D18A68]];
    [v5 setObject:@"HomeKitInviteSpam" forKeyedSubscript:*MEMORY[0x277D18A78]];
    v26 = objc_autoreleasePoolPush();
    v27 = self;
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      v29 = HMFGetLogIdentifier();
      v45 = 138543618;
      v46 = v29;
      v47 = 2112;
      v48 = v5;
      _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Reporting invitation as spam: %@", &v45, 0x16u);
    }

    objc_autoreleasePoolPop(v26);
    v30 = +[HMDIDSServiceManager sharedManager];
    v31 = [v30 service];

    v32 = [v5 copy];
    v33 = [v31 reportSpamMessage:v32];

    if ((v33 & 1) == 0)
    {
      v34 = objc_autoreleasePoolPush();
      v35 = v27;
      v36 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_FAULT))
      {
        v37 = HMFGetLogIdentifier();
        v45 = 138543362;
        v46 = v37;
        _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_FAULT, "%{public}@Spam report was rejected for some reason. Please file a bug.", &v45, 0xCu);
      }

      objc_autoreleasePoolPop(v34);
    }

    goto LABEL_18;
  }

LABEL_15:
  v38 = objc_autoreleasePoolPush();
  v39 = self;
  v40 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v40, OS_LOG_TYPE_ERROR))
  {
    v41 = HMFGetLogIdentifier();
    v42 = [v4 identifier];
    v45 = 138543874;
    v46 = v41;
    v47 = 2112;
    v48 = v42;
    v49 = 2112;
    v50 = v10;
    _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_ERROR, "%{public}@Unexpected nil value for invitation %@, reporter %@", &v45, 0x20u);
  }

  objc_autoreleasePoolPop(v38);
  v33 = 0;
LABEL_18:

  v43 = *MEMORY[0x277D85DE8];
  return v33;
}

- (void)_processLocalRequestToUpdateHomeInvitation:(id)a3 newState:(int64_t)a4 authStatus:(id)a5 logEventBuilder:(id)a6
{
  v59 = *MEMORY[0x277D85DE8];
  v9 = a3;
  v10 = a5;
  v11 = a6;
  v12 = [v9 identifier];
  v13 = [v12 UUIDString];

  v14 = objc_autoreleasePoolPush();
  v15 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    [v9 identifier];
    v48 = v13;
    v18 = v11;
    v20 = v19 = v10;
    v21 = [v20 UUIDString];
    v22 = [MEMORY[0x277CD1A88] homeInvitationStateDescription:a4];
    *buf = 138543874;
    v54 = v17;
    v55 = 2112;
    v56 = v21;
    v57 = 2112;
    v58 = v22;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@[HomeManager] Processing request to update invitation %@ to state %@", buf, 0x20u);

    v10 = v19;
    v11 = v18;
    v13 = v48;
  }

  objc_autoreleasePoolPop(v14);
  v23 = +[HMDBulletinBoard sharedBulletinBoard];
  [v23 removeBulletinWithRecordID:v13];

  v51[0] = @"kBulletinRecordIDKey";
  v51[1] = @"kInvitationIdentifierKey";
  v52[0] = v13;
  v52[1] = v13;
  v51[2] = @"kInvitationStateKey";
  v24 = [MEMORY[0x277CCABB0] numberWithInteger:a4];
  v52[2] = v24;
  v51[3] = *MEMORY[0x277CD23D0];
  v25 = [v9 homeName];
  v52[3] = v25;
  v51[4] = *MEMORY[0x277CD0640];
  v26 = [v9 homeUUID];
  v27 = [v26 UUIDString];
  v52[4] = v27;
  v28 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v52 forKeys:v51 count:5];
  [(HMDHomeManager *)v15 dismissBulletinOnAllMyTransientDevicesWithContext:v28];

  v29 = [v9 resolutionHandler];

  if (v29)
  {
    if (a4 == 3)
    {
      [v9 accept];
    }

    else
    {
      [v9 decline];
    }
  }

  else
  {
    v30 = [v9 homeUUID];
    [(HMDHomeManager *)v15 __sendUpdateRequestToAdminForInvitation:v9 homeUUID:v30 invitationState:a4 authStatus:v10];

    if (a4 == 3)
    {
      v49 = v13;
      [(HMDHomeManager *)v15 _postIncomingInvitationStateChangedNotification:v9 newInvitationState:5];
      v31 = [(HMDHomeManager *)v15 uuidsOfRemovedHomes];
      v32 = [v9 homeUUID];
      v33 = [v31 containsObject:v32];

      if (v33)
      {
        v34 = [(HMDHomeManager *)v15 uuidsOfRemovedHomes];
        v35 = [v9 homeUUID];
        [v34 removeObject:v35];

        v36 = objc_autoreleasePoolPush();
        v37 = v15;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          v40 = [v9 homeUUID];
          v41 = [v40 UUIDString];
          *buf = 138543618;
          v54 = v39;
          v55 = 2112;
          v56 = v41;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v36);
      }

      v42 = [v9 homeUUID];
      v43 = [(HMDHomeManager *)v15 _homeWithUUID:v42];
      v44 = [v43 owner];
      v45 = [v44 account];
      v46 = [v45 senderCorrelationIdentifier];

      [(HMDHomeManager *)v15 _stopTrackingRemovedHomeUserMergeId:v46];
      v13 = v49;
    }

    else
    {
      [(HMDHomeManager *)v15 _removeIncomingInvitation:v9];
      [(HMDHomeManager *)v15 _postIncomingInvitationStateChangedNotification:v9 newInvitationState:a4];
    }

    [(HMDHomeManager *)v15 _saveWithReason:@"kUpdateInvitationStateRequestKey" postSyncNotification:0];
    [(HMDHomeManager *)v15 _updateIncomingInvitesPresent];
  }

  v47 = *MEMORY[0x277D85DE8];
}

- (void)_processRequestToUpdateHomeInvitation:(id)a3 invitationState:(int64_t)a4 homeUUID:(id)a5 authStatus:(id)a6 invitationSource:(unint64_t)a7 messageName:(id)a8 message:(id)a9
{
  v68 = *MEMORY[0x277D85DE8];
  v14 = a3;
  v15 = a5;
  v16 = a6;
  v57 = a8;
  v17 = a9;
  v18 = [(HMDHomeManager *)self incomingInvitations];
  v19 = [v18 hmf_firstObjectWithValue:v14 forKeyPath:@"identifier"];

  if (!v19)
  {
    v26 = v16;
    v27 = objc_autoreleasePoolPush();
    v28 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v30 = v29 = v15;
      v31 = [v14 UUIDString];
      *buf = 138543618;
      v61 = v30;
      v62 = 2112;
      v63 = v31;
      _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Invalid invite identifier specified %@", buf, 0x16u);

      v15 = v29;
    }

    objc_autoreleasePoolPop(v27);
    v20 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    [v17 respondWithError:v20];
    v16 = v26;
    goto LABEL_25;
  }

  v20 = [HMDHomeInviteLogEvent updateWithInvitationState:a4 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
  if (v20)
  {
    v21 = [(HMDHomeManager *)self logEventSubmitter];
    [v21 submitLogEvent:v20];
  }

  if (a4 > 7 || ((1 << a4) & 0xD8) == 0)
  {
    v48 = [MEMORY[0x277CCA9B8] hmErrorWithCode:43];
    [v17 respondWithError:v48];

LABEL_25:
    v25 = v57;
    goto LABEL_26;
  }

  v22 = [v19 identifier];
  v23 = [v22 UUIDString];

  v24 = [v19 isExpired];
  v56 = v23;
  if (a4 == 7 || v24)
  {
    v53 = v16;
    v54 = v15;
    v55 = v14;
    v32 = [v17 numberForKey:@"kInvitationResponseOptionsKey"];
    v33 = [v32 integerValue];

    v34 = objc_autoreleasePoolPush();
    v35 = self;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
    {
      v51 = v34;
      v37 = HMFGetLogIdentifier();
      [v19 isExpired];
      HMFBooleanToString();
      v38 = v50 = v17;
      v39 = HMFBooleanToString();
      HMFBooleanToString();
      v40 = v52 = v33;
      *buf = 138544130;
      v61 = v37;
      v62 = 2112;
      v63 = v38;
      v64 = 2112;
      v65 = v39;
      v66 = 2112;
      v67 = v40;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Invitation has expired (%@) or was ignored (%@) / reported as spam (%@), removing and notifying clients.", buf, 0x2Au);

      v33 = v52;
      v34 = v51;

      v17 = v50;
    }

    objc_autoreleasePoolPop(v34);
    if (v33)
    {
      [(HMDHomeManager *)v35 _submitSpamReportToIDS:v19];
    }

    v58[0] = @"kBulletinRecordIDKey";
    v58[1] = @"kInvitationIdentifierKey";
    v59[0] = v23;
    v59[1] = v23;
    v58[2] = @"kInvitationStateKey";
    v41 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v19, "invitationState", v50)}];
    v59[2] = v41;
    v58[3] = *MEMORY[0x277CD23D0];
    v42 = [v19 homeName];
    v59[3] = v42;
    v58[4] = *MEMORY[0x277CD0640];
    v43 = [v19 homeUUID];
    v44 = [v43 UUIDString];
    v59[4] = v44;
    v45 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v59 forKeys:v58 count:5];
    [(HMDHomeManager *)v35 dismissBulletinOnAllMyTransientDevicesWithContext:v45];

    if ([v19 isExpired])
    {
      v46 = 6;
    }

    else
    {
      v46 = 7;
    }

    [(HMDHomeManager *)v35 _postIncomingInvitationStateChangedNotification:v19 newInvitationState:v46];
    [(HMDHomeManager *)v35 _removeIncomingInvitation:v19];
    v25 = v57;
    [(HMDHomeManager *)v35 _saveWithReason:v57 postSyncNotification:0];
    if (a4 == 3)
    {
      v47 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:23 userInfo:0];
    }

    else
    {
      v47 = 0;
    }

    v15 = v54;
    v14 = v55;
    v16 = v53;
    [v17 respondWithPayload:0 error:v47];
  }

  else
  {
    [(HMDHomeManager *)self _processLocalRequestToUpdateHomeInvitation:v19 newState:a4 authStatus:v16 logEventBuilder:0];
    [v17 respondWithPayload:0];
    v25 = v57;
  }

LABEL_26:
  v49 = *MEMORY[0x277D85DE8];
}

- (void)processRequestToUpdateHomeInvitation:(id)a3 invitationState:(int64_t)a4 homeUUID:(id)a5 authStatus:(id)a6 invitationSource:(unint64_t)a7 messageName:(id)a8 message:(id)a9
{
  v15 = a3;
  v16 = a5;
  v17 = a6;
  v18 = a8;
  v19 = a9;
  v20 = [(HMDHomeManager *)self workQueue];
  v26[0] = MEMORY[0x277D85DD0];
  v26[1] = 3221225472;
  v26[2] = __128__HMDHomeManager_processRequestToUpdateHomeInvitation_invitationState_homeUUID_authStatus_invitationSource_messageName_message___block_invoke;
  v26[3] = &unk_279732C78;
  v26[4] = self;
  v27 = v15;
  v28 = v16;
  v29 = v17;
  v32 = a4;
  v33 = a7;
  v30 = v18;
  v31 = v19;
  v21 = v19;
  v22 = v18;
  v23 = v17;
  v24 = v16;
  v25 = v15;
  dispatch_async(v20, v26);
}

- (void)_handleRequestToUpdateHomeInvitationFromLocalUser:(id)a3
{
  v11 = a3;
  v4 = [v11 uuidForKey:@"kInvitationIdentifierKey"];
  v5 = [v11 numberForKey:@"kInvitationStateKey"];
  v6 = [v11 uuidForKey:*MEMORY[0x277CD0640]];
  v7 = [MEMORY[0x277CD1F00] authWithMessage:v11];
  if (v4 && v5 && v6)
  {
    v8 = [v5 integerValue];
    v9 = [v11 name];
    [(HMDHomeManager *)self _processRequestToUpdateHomeInvitation:v4 invitationState:v8 homeUUID:v6 authStatus:v7 invitationSource:1 messageName:v9 message:v11];
  }

  else
  {
    v9 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    v10 = [v11 responseHandler];
    (v10)[2](v10, v9, 0);
  }
}

- (void)_handleRequestToCancelHomeInvitation:(id)a3 saveReason:(id)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 identifier];
  v9 = [v8 UUIDString];

  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [v6 describeWithFormat];
    v17 = 138543618;
    v18 = v13;
    v19 = 2112;
    v20 = v14;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Updating invitation %@ to canceled due to request from inviter", &v17, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  v15 = +[HMDBulletinBoard sharedBulletinBoard];
  [v15 removeBulletinWithRecordID:v9];

  [(HMDHomeManager *)v11 _postIncomingInvitationStateChangedNotification:v6 newInvitationState:1];
  [(HMDHomeManager *)v11 _removeIncomingInvitation:v6];
  [(HMDHomeManager *)v11 _saveWithReason:v7 postSyncNotification:0];

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestToUpdateHomeInvitationFromInviter:(id)a3
{
  v24 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:@"kInvitationIdentifierKey"];
  v6 = [v4 numberForKey:@"kInvitationStateKey"];
  v7 = v6;
  if (!v5 || !v6)
  {
    v9 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    [v4 respondWithError:v9];
    goto LABEL_12;
  }

  v8 = [(HMDHomeManager *)self incomingInvitations];
  v9 = [v8 hmf_firstObjectWithValue:v5 forKeyPath:@"identifier"];

  if (!v9)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [v5 UUIDString];
      v20 = 138543618;
      v21 = v13;
      v22 = 2112;
      v23 = v14;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Invalid invite identifier specified %@", &v20, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 2;
    goto LABEL_11;
  }

  if ([v7 integerValue] != 1)
  {
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 43;
LABEL_11:
    v18 = [v15 errorWithDomain:v16 code:v17 userInfo:0];
    [v4 respondWithError:v18];

    goto LABEL_12;
  }

  v10 = [v4 name];
  [(HMDHomeManager *)self _handleRequestToCancelHomeInvitation:v9 saveReason:v10];

LABEL_12:
  v19 = *MEMORY[0x277D85DE8];
}

- (void)_pruneExpiredIncomingInvitations
{
  v37 = *MEMORY[0x277D85DE8];
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v2 = [(HMDHomeManager *)self incomingInvitations];
  v3 = [v2 copy];

  obj = v3;
  v4 = [v3 countByEnumeratingWithState:&v28 objects:v36 count:16];
  if (v4)
  {
    v5 = v4;
    v27 = *v29;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v29 != v27)
        {
          objc_enumerationMutation(obj);
        }

        v7 = *(*(&v28 + 1) + 8 * i);
        v8 = [MEMORY[0x277CBEAA8] date];
        v9 = [v7 endDate];
        v10 = [v8 compare:v9];

        if (v10 != -1)
        {
          [v7 updateInvitationState:6];
          v11 = [v7 identifier];
          v12 = objc_autoreleasePoolPush();
          v13 = self;
          v14 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
          {
            v15 = HMFGetLogIdentifier();
            v16 = [v7 describeWithFormat];
            *buf = 138543618;
            v33 = v15;
            v34 = 2112;
            v35 = v16;
            _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Pruning invitation %@ as expired", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v12);
          v17 = +[HMDBulletinBoard sharedBulletinBoard];
          v18 = [v11 UUIDString];
          [v17 removeBulletinWithRecordID:v18];

          -[HMDHomeManager _postIncomingInvitationStateChangedNotification:newInvitationState:](v13, "_postIncomingInvitationStateChangedNotification:newInvitationState:", v7, [v7 invitationState]);
          [(HMDHomeManager *)v13 _removeIncomingInvitation:v7];
          [(HMDHomeManager *)v13 saveWithReason:@"kAccessHomeInviteRequestKey" information:0 postSyncNotification:0];
          v19 = objc_autoreleasePoolPush();
          v20 = v13;
          v21 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
          {
            v22 = HMFGetLogIdentifier();
            v23 = [(HMDHomeManager *)v20 incomingInvitations];
            *buf = 138543618;
            v33 = v22;
            v34 = 2112;
            v35 = v23;
            _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Incoming invitations after pruning: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v19);
        }
      }

      v5 = [obj countByEnumeratingWithState:&v28 objects:v36 count:16];
    }

    while (v5);
  }

  v24 = *MEMORY[0x277D85DE8];
}

- (int64_t)numberOfPendingIncomingInvitation
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v2 = [(HMDHomeManager *)self incomingInvitations];
  v3 = [v2 copy];

  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = 0;
    v7 = *v12;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v7)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v11 + 1) + 8 * i) invitationState] == 2)
        {
          ++v6;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v5);
  }

  else
  {
    v6 = 0;
  }

  v9 = *MEMORY[0x277D85DE8];
  return v6;
}

- (void)_removeIncomingInvitation:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    os_unfair_lock_lock_with_options();
    v5 = [(HMDHomeManager *)self incomingInvitations];
    [v5 removeObject:v4];

    os_unfair_lock_unlock(&self->_lock);
    [(HMDHomeManager *)self _updateIncomingInvitesPresent];
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Unexpected nil invitation", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v10 = +[HMDTTRManager sharedManager];
    [v10 requestRadarWithDisplayReason:@"detected issue related to HomeKit Shared User functionality" radarTitle:@"Unexpected nil invitation detected" componentName:@"HomeKit" componentVersion:@"Users+Invitations" componentID:938670];
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_addIncomingInvitation:(id)a3
{
  v16 = *MEMORY[0x277D85DE8];
  v4 = a3;
  os_unfair_lock_lock_with_options();
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [v4 describeWithFormat];
    v12 = 138543618;
    v13 = v8;
    v14 = 2112;
    v15 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Added the invitation object to the list : %@", &v12, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = [(HMDHomeManager *)v6 incomingInvitations];
  [v10 addObject:v4];

  os_unfair_lock_unlock(&self->_lock);
  [(HMDHomeManager *)v6 _updateIncomingInvitesPresent];

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_handleGetTLVForJSON:(id)a3
{
  v13[1] = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = [v3 dataForKey:*MEMORY[0x277CD0270]];
  if (v4)
  {
    v11 = 0;
    v5 = [HMDNetworkRouterFirewallRuleManagerUtils dumpTLVsFromJSONData:v4 error:&v11];
    v6 = v11;
    v7 = v6;
    if (v5)
    {
      v12 = *MEMORY[0x277CD0278];
      v13[0] = v5;
      v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v13 forKeys:&v12 count:1];
      [v3 respondWithPayload:v8];
    }

    else
    {
      if (!v6)
      {
        v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      }

      [v3 respondWithError:v7];
    }
  }

  else
  {
    v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    [v3 respondWithError:v9];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallFetchCloudChangesRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 BOOLForKey:*MEMORY[0x277CD0AE0]];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke;
  v7[3] = &unk_279732C50;
  v9 = v5;
  v8 = v4;
  v6 = v4;
  [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v6 completion:v7];
}

void __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3 = *(a1 + 40);
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke_2;
  v4[3] = &unk_279732C28;
  v5 = *(a1 + 32);
  [a2 forceFetchCloudChangesAndForceChangeNotifications:v3 completion:v4];
}

uint64_t __65__HMDHomeManager__handleNetworkFirewallFetchCloudChangesRequest___block_invoke_2(uint64_t a1, uint64_t a2, uint64_t a3)
{
  v3 = *(a1 + 32);
  if (a2)
  {
    a3 = 0;
  }

  return [v3 respondWithPayload:0 error:a3];
}

- (void)_handleNetworkFirewallRemoveLocalRulesRequest:(id)a3
{
  v4 = a3;
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke;
  v6[3] = &unk_279732C00;
  v7 = v4;
  v5 = v4;
  [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v5 completion:v6];
}

void __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __64__HMDHomeManager__handleNetworkFirewallRemoveLocalRulesRequest___block_invoke_2;
  v3[3] = &unk_2797359D8;
  v4 = *(a1 + 32);
  [a2 removeAllLocalRulesWithCompletion:v3];
}

- (void)_handleNetworkFirewallDumpPairedMetadataRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0AC0]];
  v6 = [v4 stringForKey:*MEMORY[0x277CD0AC8]];
  v7 = [v4 stringForKey:*MEMORY[0x277CD0AA8]];
  v8 = [v4 BOOLForKey:*MEMORY[0x277CD0AB0]];
  v9 = [v4 BOOLForKey:*MEMORY[0x277CD0AD0]];
  if ((v5 != 0) != (v6 != 0))
  {
    goto LABEL_8;
  }

  if (v7 && v6 == 0)
  {
    goto LABEL_8;
  }

  v11 = v9;
  if (!v7)
  {
    v12 = 0;
    goto LABEL_11;
  }

  v12 = [objc_alloc(MEMORY[0x277D0F940]) initWithString:v7];
  if (v12)
  {
LABEL_11:
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke;
    v15[3] = &unk_279732BD8;
    v16 = v4;
    v17 = v5;
    v18 = v6;
    v19 = v12;
    v20 = v8;
    v21 = v11;
    v14 = v12;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v16 completion:v15];

    goto LABEL_9;
  }

LABEL_8:
  v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [v4 respondWithError:v13];

LABEL_9:
}

void __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke_2;
  aBlock[3] = &unk_279732B38;
  v7 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  [v4 dumpPairedMetadataForProductGroup:*(a1 + 40) productNumber:*(a1 + 48) firmwareVersion:*(a1 + 56) ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v5];
}

void __66__HMDHomeManager__handleNetworkFirewallDumpPairedMetadataRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0AD8];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallDumpLocalRulesRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0A88]];
  v6 = [v4 stringForKey:*MEMORY[0x277CD0A90]];
  v7 = [v4 stringForKey:*MEMORY[0x277CD0A70]];
  v8 = [v4 BOOLForKey:*MEMORY[0x277CD0A78]];
  v9 = [v4 BOOLForKey:*MEMORY[0x277CD0A98]];
  if (v6)
  {
    v10 = v5 == 0;
  }

  else
  {
    v10 = 0;
  }

  if (v10)
  {
    goto LABEL_11;
  }

  if (v7 && v6 == 0)
  {
    goto LABEL_11;
  }

  v12 = v9;
  if (!v7)
  {
    v13 = 0;
    goto LABEL_14;
  }

  v13 = [objc_alloc(MEMORY[0x277D0F940]) initWithString:v7];
  if (v13)
  {
LABEL_14:
    v16[0] = MEMORY[0x277D85DD0];
    v16[1] = 3221225472;
    v16[2] = __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke;
    v16[3] = &unk_279732BD8;
    v17 = v4;
    v18 = v6;
    v19 = v5;
    v20 = v13;
    v21 = v8;
    v22 = v12;
    v15 = v13;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v17 completion:v16];

    goto LABEL_12;
  }

LABEL_11:
  v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [v4 respondWithError:v14];

LABEL_12:
}

void __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke_2;
  aBlock[3] = &unk_279732B38;
  v8 = *(a1 + 32);
  v4 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  v5 = *(a1 + 48);
  if (v6)
  {
    [v3 dumpLocalRulesForProductGroup:v5 productNumber:v6 firmwareVersion:*(a1 + 56) ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }

  else if (v5)
  {
    [v3 dumpLocalRulesForProductGroup:v5 ignoreOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }

  else
  {
    [v3 dumpAllLocalRulesIgnoringOverrides:*(a1 + 64) rawOutput:*(a1 + 65) completion:v4];
  }
}

void __62__HMDHomeManager__handleNetworkFirewallDumpLocalRulesRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0AA0];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleNetworkFirewallRemoveOverridesRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0B00]];
  v6 = [v4 stringForKey:*MEMORY[0x277CD0B08]];
  if (v6)
  {
    v7 = v5 == 0;
  }

  else
  {
    v7 = 0;
  }

  if (v7)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v8];
  }

  else
  {
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke;
    v9[3] = &unk_279732BB0;
    v10 = v4;
    v11 = v5;
    v12 = v6;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v10 completion:v9];
  }
}

void __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __63__HMDHomeManager__handleNetworkFirewallRemoveOverridesRequest___block_invoke_2;
  aBlock[3] = &unk_2797359D8;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (v6)
  {
    [v4 removeOverridesForProductGroup:v6 productNumber:*(a1 + 48) completion:v5];
  }

  else
  {
    [v4 removeAllOverridesWithCompletion:v5];
  }
}

- (void)_handleNetworkFirewallAddOverridesRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 dataForKey:*MEMORY[0x277CD0A20]];
  if (v5)
  {
    v6 = [v4 BOOLForKey:*MEMORY[0x277CD0A30]];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke;
    v8[3] = &unk_279732B88;
    v9 = v4;
    v11 = v6;
    v10 = v5;
    [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v9 completion:v8];
  }

  else
  {
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v7];
  }
}

void __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __60__HMDHomeManager__handleNetworkFirewallAddOverridesRequest___block_invoke_2;
  aBlock[3] = &unk_2797359D8;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (*(a1 + 48) == 1)
  {
    [v4 setOverrides:v6 completion:v5];
  }

  else
  {
    [v4 addOverrides:v6 completion:v5];
  }
}

- (void)_handleNetworkFirewallDumpCloudRecordsRequest:(id)a3
{
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0A48]];
  v6 = [v4 stringForKey:*MEMORY[0x277CD0A50]];
  v7 = [v4 BOOLForKey:*MEMORY[0x277CD0A58]];
  v8 = [v4 BOOLForKey:*MEMORY[0x277CD0A38]];
  v9 = [v4 BOOLForKey:*MEMORY[0x277CD0A68]];
  if (!v5 || [v5 length])
  {
    if (v6)
    {
      v10 = [v6 length];
      if (v5)
      {
        v11 = v10 == 0;
      }

      else
      {
        v11 = 1;
      }

      if (!v11)
      {
        goto LABEL_12;
      }
    }

    else if (v5 || (v8 & 1) != 0)
    {
LABEL_12:
      v13[0] = MEMORY[0x277D85DD0];
      v13[1] = 3221225472;
      v13[2] = __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke;
      v13[3] = &unk_279732B60;
      v14 = v4;
      v17 = v8;
      v15 = v5;
      v18 = v7;
      v16 = v6;
      v19 = v9;
      [(HMDHomeManager *)self __startupFirewallRuleManagerForMessage:v14 completion:v13];

      goto LABEL_13;
    }
  }

  v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  [v4 respondWithError:v12];

LABEL_13:
}

void __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke(uint64_t a1, void *a2)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke_2;
  aBlock[3] = &unk_279732B38;
  v8 = *(a1 + 32);
  v4 = a2;
  v5 = _Block_copy(aBlock);
  v6 = *(a1 + 40);
  if (*(a1 + 56) == 1)
  {
    [v4 listCloudRecordsForProductGroup:v6 rawOutput:*(a1 + 57) completion:v5];
  }

  else
  {
    [v4 dumpCloudRecordsForProductGroup:v6 productNumber:*(a1 + 48) rawOutput:*(a1 + 57) verifySignatures:*(a1 + 58) completion:v5];
  }
}

void __64__HMDHomeManager__handleNetworkFirewallDumpCloudRecordsRequest___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v20[1] = *MEMORY[0x277D85DE8];
  v5 = a2;
  if (v5)
  {
    v6 = MEMORY[0x277CCA9B8];
    v7 = a3;
    v8 = [v5 domain];
    v9 = [v5 code];
    v19 = *MEMORY[0x277CCA450];
    v10 = [v5 debugDescription];
    v20[0] = v10;
    v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v20 forKeys:&v19 count:1];
    v12 = [v6 errorWithDomain:v8 code:v9 userInfo:v11];

    [*(a1 + 32) respondWithError:v12];
  }

  else
  {
    v13 = *(a1 + 32);
    v17 = *MEMORY[0x277CD0A60];
    v18 = a3;
    v14 = MEMORY[0x277CBEAC0];
    v15 = a3;
    v12 = [v14 dictionaryWithObjects:&v18 forKeys:&v17 count:1];
    [v13 respondWithPayload:v12];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)__startupFirewallRuleManagerForMessage:(id)a3 completion:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [HMDTransientRuleManagerClient alloc];
  v9 = [v6 identifier];
  v10 = [v9 UUIDString];
  v11 = [(HMDTransientRuleManagerClient *)v8 initWithDescription:v10];

  v12 = +[HMDNetworkRouterFirewallRuleManager sharedInstance];
  v17[0] = MEMORY[0x277D85DD0];
  v17[1] = 3221225472;
  v17[2] = __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke;
  v17[3] = &unk_279732B10;
  v17[4] = self;
  v18 = v6;
  v19 = v12;
  v20 = v11;
  v21 = v7;
  v13 = v7;
  v14 = v11;
  v15 = v12;
  v16 = v6;
  [v15 startupForClient:v14 completion:v17];
}

void __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      *buf = 138543618;
      v18 = v7;
      v19 = 2112;
      v20 = v3;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to start up rule manager: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    [*(a1 + 40) respondWithError:v3];
  }

  else
  {
    v8 = [*(a1 + 40) responseHandler];
    v13[0] = MEMORY[0x277D85DD0];
    v13[1] = 3221225472;
    v13[2] = __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke_1521;
    v13[3] = &unk_279732AE8;
    v14 = *(a1 + 48);
    v15 = *(a1 + 56);
    v16 = v8;
    v9 = *(a1 + 40);
    v10 = v8;
    [v9 setResponseHandler:v13];
    v11 = *(a1 + 48);
    (*(*(a1 + 64) + 16))();
  }

  v12 = *MEMORY[0x277D85DE8];
}

void __68__HMDHomeManager___startupFirewallRuleManagerForMessage_completion___block_invoke_1521(uint64_t a1, void *a2, void *a3)
{
  v7 = a2;
  v5 = a3;
  [*(a1 + 32) shutdownForClient:*(a1 + 40)];
  v6 = *(a1 + 48);
  if (v6)
  {
    (*(v6 + 16))(v6, v7, v5);
  }
}

- (void)_logState:(id)a3 key:(id)a4 indent:(id)a5
{
  v55 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = v10;
  if (v10)
  {
    [v10 indentationByLevels:1];
  }

  else
  {
    [MEMORY[0x277D0F908] indentation];
  }
  v35 = ;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v32 = v11;
    v33 = v9;
    v34 = v8;
    v41 = 0u;
    v42 = 0u;
    v43 = 0u;
    v44 = 0u;
    v12 = v8;
    v13 = [v12 countByEnumeratingWithState:&v41 objects:v54 count:16];
    if (v13)
    {
      v14 = v13;
      v15 = *v42;
      v36 = *MEMORY[0x277D0F170];
      v16 = 0x277CCA000uLL;
      do
      {
        for (i = 0; i != v14; ++i)
        {
          if (*v42 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v18 = *(*(&v41 + 1) + 8 * i);
          v19 = *(v16 + 3240);
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            if (([v18 isEqualToString:v36] & 1) == 0)
            {
              v20 = [v12 objectForKey:v18];
              [(HMDHomeManager *)self _logState:v20 key:v18 indent:v35];

              v16 = 0x277CCA000;
            }
          }

          else
          {
            v21 = objc_autoreleasePoolPush();
            v22 = self;
            v23 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
            {
              v24 = HMFGetLogIdentifier();
              v25 = objc_opt_class();
              *buf = 138544130;
              v47 = v24;
              v48 = 2112;
              v49 = v25;
              v50 = 2112;
              v51 = v18;
              v52 = 2112;
              v53 = v12;
              _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Cannot include key of non-NSString class %@: %@ in %@", buf, 0x2Au);

              v16 = 0x277CCA000;
            }

            objc_autoreleasePoolPop(v21);
          }
        }

        v14 = [v12 countByEnumeratingWithState:&v41 objects:v54 count:16];
      }

      while (v14);
    }

    v9 = v33;
    v8 = v34;
    v11 = v32;
LABEL_27:

    goto LABEL_28;
  }

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v26 = v8;
    v27 = [v26 countByEnumeratingWithState:&v37 objects:v45 count:16];
    if (v27)
    {
      v28 = v27;
      v29 = *v38;
      do
      {
        for (j = 0; j != v28; ++j)
        {
          if (*v38 != v29)
          {
            objc_enumerationMutation(v26);
          }

          [(HMDHomeManager *)self _logState:*(*(&v37 + 1) + 8 * j) key:v9 indent:v11];
        }

        v28 = [v26 countByEnumeratingWithState:&v37 objects:v45 count:16];
      }

      while (v28);
    }

    goto LABEL_27;
  }

LABEL_28:

  v31 = *MEMORY[0x277D85DE8];
}

- (void)_dumpToLog:(id)a3 withState:(id)a4
{
  v8 = a3;
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  [(HMDHomeManager *)self _logState:v8 key:0 indent:0];
  [(HMDHomeManager *)self _logState:v6 key:0 indent:0];
  objc_autoreleasePoolPop(v7);
}

- (id)_destinationFromMessage:(id)a3
{
  v4 = a3;
  v15 = MEMORY[0x277D85DD0];
  v16 = 3221225472;
  v17 = __42__HMDHomeManager__destinationFromMessage___block_invoke;
  v18 = &unk_279732AC0;
  v19 = self;
  v5 = v4;
  v20 = v5;
  v6 = _Block_copy(&v15);
  v7 = [v5 uuidForKey:{@"HomeUtilRemoteMessageTargetKey", v15, v16, v17, v18, v19}];
  if (v7)
  {
    v8 = [v5 stringForKey:@"HomeUtilRemoteMessageDestinationKey"];
    if (v8)
    {
      v9 = [HMDDeviceHandle deviceHandleForDestination:v8];
      if (v9)
      {
        v10 = [(HMDHomeManager *)self accountRegistry];
        v11 = [v10 deviceForHandle:v9];

        v12 = [[HMDRemoteDeviceMessageDestination alloc] initWithTarget:v7 device:v11];
      }

      else
      {
        v11 = [HMDAccountHandle accountHandleForDestination:v8];
        if (v11)
        {
          v13 = [v5 dictionaryForKey:@"HomeUtilRemoteMessageDeviceCapabilitiesKey"];
          v12 = [[HMDRemoteAccountMessageDestination alloc] initWithTarget:v7 handle:v11 multicast:v13 == 0 deviceCapabilities:v13];
        }

        else
        {
          v6[2](v6, @"Unknown device, account or home destination");
          v12 = 0;
        }
      }
    }

    else
    {
      v6[2](v6, @"Remote destination string is missing");
      v12 = 0;
    }
  }

  else
  {
    v6[2](v6, @"Target UUID is missing");
    v12 = 0;
  }

  return v12;
}

void __42__HMDHomeManager__destinationFromMessage___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_ERROR, "%{public}@HomeUtilRemoteMessageRequest: Invalid parameter: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *(a1 + 40);
  v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3 description:v3 reason:0 suggestion:0];
  [v8 respondWithError:v9];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_handleClearMobileAssetsInfoRequest:(id)a3
{
  v3 = MEMORY[0x277CCA9B8];
  v4 = a3;
  v5 = [v3 hmErrorWithCode:48];
  [v4 respondWithError:v5];
}

- (void)_handleUpdateMobileAssetsRequest:(id)a3
{
  v3 = MEMORY[0x277CCA9B8];
  v4 = a3;
  v5 = [v3 hmErrorWithCode:48];
  [v4 respondWithError:v5];
}

- (void)_handleHomeUtilRemoteMessageRequest:(id)a3
{
  v35 = *MEMORY[0x277D85DE8];
  v4 = a3;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke;
  aBlock[3] = &unk_279732AC0;
  aBlock[4] = self;
  v5 = v4;
  v30 = v5;
  v6 = _Block_copy(aBlock);
  v7 = [v5 stringForKey:@"HomeUtilRemoteMessageMessageNameKey"];
  if (v7)
  {
    v8 = [(HMDHomeManager *)self _destinationFromMessage:v5];
    if (v8)
    {
      v9 = [v5 dictionaryForKey:@"HomeUtilRemoteMessagePayloadKey"];
      v10 = [v5 numberForKey:@"HomeUtilRemoteMessageRestrictionKey"];
      v25 = v10;
      if (v10)
      {
        v11 = [v10 unsignedIntegerValue];
      }

      else
      {
        v11 = -1;
      }

      v12 = [v5 BOOLForKey:@"HomeUtilRemoteMessageIsSecureKey"];
      v13 = [v5 BOOLForKey:@"HomeUtilRemoteMessageIsOnewayKey"];
      v14 = v13;
      if (v13)
      {
        v15 = 3;
      }

      else
      {
        v15 = 0;
      }

      v16 = [[HMDRemoteMessage alloc] initWithName:v7 destination:v8 payload:v9 type:v15 timeout:v12 secure:v11 restriction:0.0];
      if ((v14 & 1) == 0)
      {
        v17 = [v5 responseHandler];
        [(HMDRemoteMessage *)v16 setResponseHandler:v17];
      }

      v18 = objc_autoreleasePoolPush();
      v19 = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        HMFGetLogIdentifier();
        v21 = v24 = v9;
        *buf = 138543618;
        v32 = v21;
        v33 = 2112;
        v34 = v16;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@HomeUtilRemoteMessageRequest: Sending message: %@", buf, 0x16u);

        v9 = v24;
      }

      objc_autoreleasePoolPop(v18);
      v22 = [(HMDHomeManager *)v19 messageDispatcher];
      v26[0] = MEMORY[0x277D85DD0];
      v26[1] = 3221225472;
      v26[2] = __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke_1506;
      v26[3] = &unk_279735878;
      v28 = v15;
      v27 = v5;
      [v22 sendMessage:v16 completionHandler:v26];
    }
  }

  else
  {
    v6[2](v6, @"Message name is missing");
  }

  v23 = *MEMORY[0x277D85DE8];
}

void __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_ERROR, "%{public}@HomeUtilRemoteMessageRequest: Invalid parameter: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v8 = *(a1 + 40);
  v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3 description:v3 reason:0 suggestion:0];
  [v8 respondWithError:v9];

  v10 = *MEMORY[0x277D85DE8];
}

uint64_t __54__HMDHomeManager__handleHomeUtilRemoteMessageRequest___block_invoke_1506(uint64_t result, uint64_t a2)
{
  if (*(result + 40) == 3)
  {
    return [*(result + 32) respondWithPayload:0 error:a2];
  }

  return result;
}

- (void)_handleHomeUtilSetOverridesMessage:(id)a3
{
  v21 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 dictionaryForKey:@"kConfigTestingOverrideKey"];
  if (!v5)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [v4 messagePayload];
      *buf = 138543874;
      v16 = v11;
      v17 = 2112;
      v18 = @"kConfigTestingOverrideKey";
      v19 = 2112;
      v20 = v12;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_ERROR, "%{public}@Cannot handle set overrides message: No value for %@ in payload: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    goto LABEL_7;
  }

  v14 = 0;
  v6 = [(HMDHomeManager *)self _processTestModeOverridesPayload:v5 error:&v14];
  v7 = v14;
  if (!v6)
  {
LABEL_7:
    [v4 respondWithError:v7];
    goto LABEL_8;
  }

  [v4 respondWithSuccess];
LABEL_8:

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_handleTestModeConfigRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self accessoryBrowserInternal];
  v6 = [v4 messagePayload];
  v9 = 0;
  v7 = [v5 handleTestModeConfigRequestPayload:v6 error:&v9];
  v8 = v9;

  if (v7)
  {
    [v4 respondWithPayload:v7];
  }

  else
  {
    [v4 respondWithError:v8];
  }
}

- (BOOL)_processTestModeOverridesPayload:(id)a3 error:(id *)a4
{
  v6 = a3;
  v7 = [v6 hmf_dictionaryForKey:@"kConfigTestingOverrideCurrentHomeKey"];
  if (v7)
  {
    v8 = [(HMDHomeManager *)self _processTestModeCurrentHomeOverride:v7 error:a4];
  }

  else
  {
    v9 = [v6 hmf_dictionaryForKey:@"kConfigTestingOverrideHomeLocationStatusKey"];
    if (v9)
    {
      v8 = [(HMDHomeManager *)self _processTestModeHomeLocationStatusOverride:v9 error:a4];
    }

    else
    {
      v10 = [v6 hmf_dictionaryForKey:@"kConfigTestingOverrideHomeAccessControlKey"];
      if (v10)
      {
        v8 = [(HMDHomeManager *)self _processTestModeHomeAccessControlOverride:v10 error:a4];
      }

      else
      {
        v11 = [v6 hmf_dictionaryForKey:@"kConfigTestingOverrideSkipHH2MigrationCheckDictionaryKey"];
        if (v11)
        {
          v8 = [(HMDHomeManager *)self _processTestModeSkipHH2MigrationOverride:v11 error:a4];
        }

        else
        {
          v12 = [v6 hmf_dictionaryForKey:@"kConfigTestingUpdateHomeLocationKey"];
          if (v12)
          {
            v8 = [(HMDHomeManager *)self _processTestModeUpdateHomeLocation:v12 error:a4];
          }

          else if (a4)
          {
            [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
            *a4 = v8 = 0;
          }

          else
          {
            v8 = 0;
          }
        }
      }
    }
  }

  return v8;
}

- (BOOL)_processTestModeSkipHH2MigrationOverride:(id)a3 error:(id *)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeSkipHH2MigrationOverride:v6 error:a4];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set skip HH2 migration override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (a4)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *a4 = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeHomeAccessControlOverride:(id)a3 error:(id *)a4
{
  v22 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (!v8)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v15;
      v20 = 2112;
      v21 = v7;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home access control override: no home found with UUID: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    if (a4)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *a4 = v11 = 0;
      goto LABEL_9;
    }

LABEL_8:
    v11 = 0;
    goto LABEL_9;
  }

  if (![v8 _processTestModeHomeAccessControlOverride:v6 error:a4])
  {
    goto LABEL_8;
  }

  v10 = [(HMDHomeManager *)self uuid];
  v11 = 1;
  [(HMDHomeManager *)self updateGenerationCounterWithReason:@"kTestModeHomeAccessControlOverride" sourceUUID:v10 shouldNotifyClients:1];

LABEL_9:
  v16 = *MEMORY[0x277D85DE8];
  return v11;
}

- (BOOL)_processTestModeUpdateHomeLocation:(id)a3 error:(id *)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeUpdateHomeLocation:v6 error:a4];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home location override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (a4)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *a4 = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeHomeLocationStatusOverride:(id)a3 error:(id *)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v8 = [(HMDHomeManager *)self _homeWithUUID:v7];
  v9 = v8;
  if (v8)
  {
    v10 = [v8 _processTestModeHomeLocationStatusOverride:v6 error:a4];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v7;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot set home location status override: no home found with UUID: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (a4)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
      *a4 = v10 = 0;
    }

    else
    {
      v10 = 0;
    }
  }

  v15 = *MEMORY[0x277D85DE8];
  return v10;
}

- (BOOL)_processTestModeCurrentHomeOverride:(id)a3 error:(id *)a4
{
  v24 = *MEMORY[0x277D85DE8];
  v6 = a3;
  if ([v6 hmf_BOOLForKey:@"kConfigTestingResetOverrideKey"])
  {
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:0];
LABEL_7:
    v12 = [(HMDHomeManager *)self __computedCurrentHomeUUID];
    v13 = 1;
    [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v12 isLocalUpdate:1];

    goto LABEL_8;
  }

  if ([v6 hmf_BOOLForKey:@"kConfigTestingOverrideToNilKey"])
  {
    v7 = [MEMORY[0x277D0F788] BOOLeanWithBool:1];
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:v7];

    goto LABEL_7;
  }

  v8 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v9 = [(HMDHomeManager *)self _homeWithUUID:v8];
  if (v9)
  {
    v10 = v9;
    [(HMDHomeManager *)self setCurrentHomeUUIDOverride:v8];
    v11 = [MEMORY[0x277D0F788] BOOLeanWithBool:0];
    [(HMDHomeManager *)self setOverrideCurrentHomeUUIDToNil:v11];

    goto LABEL_7;
  }

  v16 = objc_autoreleasePoolPush();
  v17 = self;
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
  {
    v19 = HMFGetLogIdentifier();
    v20 = 138543618;
    v21 = v19;
    v22 = 2112;
    v23 = v8;
    _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Cannot set current home override: no home found with UUID: %@", &v20, 0x16u);
  }

  objc_autoreleasePoolPop(v16);
  if (a4)
  {
    *a4 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2 description:0 reason:@"Could not find home with provided UUID" suggestion:0];
  }

  v13 = 0;
LABEL_8:

  v14 = *MEMORY[0x277D85DE8];
  return v13;
}

- (void)finalizeRetailDemoModeWithAllowEditing:(BOOL)a3 completionHandler:(id)a4
{
  v47 = *MEMORY[0x277D85DE8];
  v6 = a4;
  v7 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v7);

  if (!a3)
  {
    v29 = v6;
    v42 = 0u;
    v43 = 0u;
    v40 = 0u;
    v41 = 0u;
    v8 = [(HMDHomeManager *)self homes];
    v9 = [v8 countByEnumeratingWithState:&v40 objects:v46 count:16];
    if (v9)
    {
      v10 = v9;
      v11 = *v41;
      do
      {
        v12 = 0;
        do
        {
          if (*v41 != v11)
          {
            objc_enumerationMutation(v8);
          }

          v13 = *(*(&v40 + 1) + 8 * v12);
          v14 = [MEMORY[0x277CCAD78] UUID];
          v15 = [v14 UUIDString];
          [v13 setOwnerName:v15];

          v38 = 0u;
          v39 = 0u;
          v36 = 0u;
          v37 = 0u;
          v16 = [v13 users];
          v17 = [v16 countByEnumeratingWithState:&v36 objects:v45 count:16];
          if (v17)
          {
            v18 = v17;
            v19 = *v37;
            do
            {
              v20 = 0;
              do
              {
                if (*v37 != v19)
                {
                  objc_enumerationMutation(v16);
                }

                [*(*(&v36 + 1) + 8 * v20++) setPrivilege:0];
              }

              while (v18 != v20);
              v18 = [v16 countByEnumeratingWithState:&v36 objects:v45 count:16];
            }

            while (v18);
          }

          ++v12;
        }

        while (v12 != v10);
        v10 = [v8 countByEnumeratingWithState:&v40 objects:v46 count:16];
      }

      while (v10);
    }

    v6 = v29;
  }

  v34 = 0u;
  v35 = 0u;
  v32 = 0u;
  v33 = 0u;
  v21 = [(HMDHomeManager *)self homes];
  v22 = [v21 countByEnumeratingWithState:&v32 objects:v44 count:16];
  if (v22)
  {
    v23 = v22;
    v24 = *v33;
    do
    {
      v25 = 0;
      do
      {
        if (*v33 != v24)
        {
          objc_enumerationMutation(v21);
        }

        [*(*(&v32 + 1) + 8 * v25++) configureNaturalLightingForDemoMode];
      }

      while (v23 != v25);
      v23 = [v21 countByEnumeratingWithState:&v32 objects:v44 count:16];
    }

    while (v23);
  }

  self->_demoFinalized = 1;
  [(HMDHomeManager *)self _setHomeConfigurationKey:*MEMORY[0x277CD2370] value:*MEMORY[0x277CBED28]];
  [(HMDHomeManager *)self saveWithReason:@"kUpdateUserAccessRequestKey" information:0 saveOptions:0];
  v26 = dispatch_time(0, 1000000000);
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __75__HMDHomeManager_finalizeRetailDemoModeWithAllowEditing_completionHandler___block_invoke;
  block[3] = &unk_279735738;
  block[4] = self;
  v31 = v6;
  v27 = v6;
  dispatch_after(v26, MEMORY[0x277D85CD0], block);

  v28 = *MEMORY[0x277D85DE8];
}

void __75__HMDHomeManager_finalizeRetailDemoModeWithAllowEditing_completionHandler___block_invoke(uint64_t a1)
{
  v2 = [HMDBackingStoreFetchArchiveOperation alloc];
  v6 = MEMORY[0x277D85DD0];
  v7 = 3221225472;
  v8 = __75__HMDHomeManager_finalizeRetailDemoModeWithAllowEditing_completionHandler___block_invoke_2;
  v9 = &unk_279732A98;
  v3 = *(a1 + 40);
  v10 = *(a1 + 32);
  v11 = v3;
  v4 = [(HMDBackingStoreFetchArchiveOperation *)v2 initWithFetchResult:&v6];
  v5 = [*(a1 + 32) backingStore];
  [v5 submit:v4];

  [(HMDBackingStoreFetchArchiveOperation *)v4 waitUntilFinished];
}

void __75__HMDHomeManager_finalizeRetailDemoModeWithAllowEditing_completionHandler___block_invoke_2(uint64_t a1, void *a2, void *a3, void *a4)
{
  v29 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  if (v7)
  {
    v24 = v9;
    v10 = [HMDPersistentStore encryptDataWithControllerKey:v7 error:&v24];
    v11 = v24;

    if (v10)
    {
      (*(*(a1 + 40) + 16))();
    }

    else
    {
      v17 = objc_autoreleasePoolPush();
      v18 = *(a1 + 32);
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543618;
        v26 = v20;
        v27 = 2112;
        v28 = v11;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_ERROR, "%{public}@Failed to encrypt home data with %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v17);
      v21 = *(a1 + 40);
      v22 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
      (*(v21 + 16))(v21, 0, v22);

      v10 = 0;
    }

    v9 = v11;
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 32);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v26 = v15;
      v27 = 2112;
      v28 = v9;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Could not load home data from archived file with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v16 = *(a1 + 40);
    v10 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
    (*(v16 + 16))(v16, 0, v10);
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)configureRetailDemoModeWithKeyPair:(id)a3 controllerName:(id)a4 demoAccessories:(id)a5 completionHandler:(id)a6
{
  v45 = *MEMORY[0x277D85DE8];
  v28 = a3;
  v10 = a4;
  v11 = a5;
  v12 = a6;
  v13 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v13);

  objc_initWeak(&location, self);
  v14 = MEMORY[0x277CCAAB0];
  v15 = [v11 copy];
  v37 = 0;
  v16 = [v14 archivedDataWithRootObject:v15 requiringSecureCoding:1 error:&v37];
  v17 = v37;

  if (v17 || (HMDHomeKitDaemonDemoModePersistencePath(), v18 = objc_claimAutoreleasedReturnValue(), v19 = [v16 writeToURL:v18 atomically:1], v18, (v19 & 1) == 0))
  {
    v21 = objc_autoreleasePoolPush();
    v22 = self;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = HMFGetLogIdentifier();
      v25 = HMDHomeKitDaemonDemoModePersistencePath();
      *buf = 138543874;
      v40 = v24;
      v41 = 2112;
      v42 = v25;
      v43 = 2112;
      v44 = v17;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Failed to persist demo accessories to %@: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v21);
    v26 = [(HMDHomeManager *)v22 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __102__HMDHomeManager_configureRetailDemoModeWithKeyPair_controllerName_demoAccessories_completionHandler___block_invoke;
    block[3] = &unk_279735738;
    v36 = v12;
    v35 = v17;
    dispatch_async(v26, block);
  }

  else
  {
    v20 = [(HMDHomeManager *)self workQueue];
    v29[0] = MEMORY[0x277D85DD0];
    v29[1] = 3221225472;
    v29[2] = __102__HMDHomeManager_configureRetailDemoModeWithKeyPair_controllerName_demoAccessories_completionHandler___block_invoke_2;
    v29[3] = &unk_279732A70;
    objc_copyWeak(&v33, &location);
    v30 = v28;
    v31 = v10;
    v32 = v12;
    [(HMDHomeManager *)self _eraseLocalHomeConfigurationAndDeleteMetadata:1 reason:4 completionQueue:v20 completion:v29];

    objc_destroyWeak(&v33);
  }

  objc_destroyWeak(&location);
  v27 = *MEMORY[0x277D85DE8];
}

void __102__HMDHomeManager_configureRetailDemoModeWithKeyPair_controllerName_demoAccessories_completionHandler___block_invoke(uint64_t a1)
{
  v1 = *(a1 + 40);
  if (*(a1 + 32))
  {
    v2 = *(v1 + 16);
    v3 = *(a1 + 40);

    v2(v3);
  }

  else
  {
    v4 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:11];
    (*(v1 + 16))(v1, v4);
  }
}

void __102__HMDHomeManager_configureRetailDemoModeWithKeyPair_controllerName_demoAccessories_completionHandler___block_invoke_2(uint64_t a1, int a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (a2 && [WeakRetained _removeAndAddKeyPair:*(a1 + 32) userName:*(a1 + 40) eraseReason:4])
  {
    v4 = [MEMORY[0x277CFEC78] systemStore];
    [v4 updateActiveControllerPairingIdentifier:*(a1 + 40)];

    (*(*(a1 + 48) + 16))();
  }

  else
  {
    v5 = *(a1 + 48);
    v6 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
    (*(v5 + 16))(v5, v6);
  }
}

- (id)__dumpHomeManagerDataWithPrivacyLevel:(unint64_t)a3
{
  v78 = *MEMORY[0x277D85DE8];
  v4 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:7];
  v5 = [MEMORY[0x277CCAB68] string];
  v66 = [MEMORY[0x277CCA8D8] mainBundle];
  v6 = [v66 infoDictionary];
  v7 = [v6 objectForKey:*MEMORY[0x277CBED58]];
  [v5 appendFormat:@"homed: %@  ", v7];

  v8 = +[HMDHAPMetadata getSharedInstance];
  v9 = +[HMDHAPMetadata getBuiltinInstance];
  v10 = [v8 schemaVersion];
  v65 = v8;
  v11 = [v8 version];
  v12 = [v9 schemaVersion];
  v64 = v9;
  v13 = [v9 version];
  [v5 appendFormat:@"Metadata - Current: %@/%@   Builtin: %@/%@\n", v10, v11, v12, v13];

  v67 = v5;
  [v4 setObject:v5 forKeyedSubscript:*MEMORY[0x277D0F0B0]];
  v14 = MEMORY[0x277CCACA8];
  v15 = [(HMDHomeManager *)self primaryHomeUUID];
  v16 = [v15 UUIDString];
  v17 = [(HMDHomeManager *)self currentHomeUUID];
  v18 = [v17 UUIDString];
  [(HMDHomeManager *)self isAccessAllowedWhenLocked];
  v19 = HMFBooleanToString();
  v20 = getLastSyncedAssistantConfigurationVersion();
  v21 = getAssistantConfigurationSnapshot();
  v22 = [v14 stringWithFormat:@"Primary Home: %@, Current Home: %@, Allow locked access: %@, Siri lastSyncedVersion: %@  currentSyncSnapshot: %@", v16, v18, v19, v20, v21];

  v63 = v22;
  [v4 setObject:v22 forKeyedSubscript:*MEMORY[0x277D0F0C0]];
  v23 = [(HMDHomeManager *)self syncManager];
  v24 = [v23 dumpState];
  [v4 setObject:v24 forKeyedSubscript:*MEMORY[0x277D0F178]];

  v25 = [(HMDHomeManager *)self appData];
  v26 = [v25 dumpStateWithPrivacyLevel:a3];
  [v4 setObject:v26 forKeyedSubscript:*MEMORY[0x277D0F050]];

  v27 = [(HMDHomeManager *)self homes];
  v28 = [v27 count];

  if (v28)
  {
    v29 = MEMORY[0x277CBEB18];
    v30 = [(HMDHomeManager *)self homes];
    v31 = [v29 arrayWithCapacity:{objc_msgSend(v30, "count")}];

    v32 = [(HMDHomeManager *)self homes];
    v74[0] = MEMORY[0x277D85DD0];
    v74[1] = 3221225472;
    v74[2] = __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke;
    v74[3] = &unk_279732A20;
    v75 = v31;
    v76 = a3;
    v33 = v31;
    [v32 hmf_enumerateWithAutoreleasePoolUsingBlock:v74];

    [v4 setObject:v33 forKey:*MEMORY[0x277D0F0B8]];
  }

  v34 = [MEMORY[0x277CFEC78] systemStore];
  v35 = [v34 dumpState];
  [v4 setObject:v35 forKey:*MEMORY[0x277D0F0F0]];

  v36 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:2];
  v37 = [MEMORY[0x277CBEB18] array];
  v70 = 0u;
  v71 = 0u;
  v72 = 0u;
  v73 = 0u;
  v38 = [(HMDHomeManager *)self incomingInvitations];
  v39 = [v38 copy];

  v40 = [v39 countByEnumeratingWithState:&v70 objects:v77 count:16];
  if (v40)
  {
    v41 = v40;
    v42 = *v71;
    do
    {
      for (i = 0; i != v41; ++i)
      {
        if (*v71 != v42)
        {
          objc_enumerationMutation(v39);
        }

        v44 = [*(*(&v70 + 1) + 8 * i) describeWithFormat];
        [v37 addObject:v44];
      }

      v41 = [v39 countByEnumeratingWithState:&v70 objects:v77 count:16];
    }

    while (v41);
  }

  [v36 setObject:v37 forKeyedSubscript:*MEMORY[0x277D0F0D8]];
  v45 = [MEMORY[0x277CBEB18] array];
  v46 = [(HMDHomeManager *)self homes];
  v68[0] = MEMORY[0x277D85DD0];
  v68[1] = 3221225472;
  v68[2] = __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke_2;
  v68[3] = &unk_279732398;
  v47 = v45;
  v69 = v47;
  [v46 hmf_enumerateWithAutoreleasePoolUsingBlock:v68];

  [v36 setObject:v47 forKeyedSubscript:*MEMORY[0x277D0F110]];
  [v4 setObject:v36 forKeyedSubscript:*MEMORY[0x277D0F0E0]];
  v48 = MEMORY[0x277CCACA8];
  v49 = (_os_feature_enabled_impl() & 1) != 0 || CFPreferencesGetAppBooleanValue(@"MatterTTU", @"/Library/Managed Preferences/mobile/com.apple.homed.plist", 0) != 0;
  v50 = [v48 stringWithFormat:@"%d", v49];
  [v4 setObject:v50 forKeyedSubscript:@"HM_FEATURE_MATTER_TTU_ENABLED_FEATURE_OR_PROFILE"];

  v51 = [MEMORY[0x277CCACA8] stringWithFormat:@"%d", 1];
  [v4 setObject:v51 forKeyedSubscript:@"HM_FEATURE_UWB_ENABLED_FEATURE_AND_PROFILE"];

  v52 = [MEMORY[0x277CCACA8] stringWithFormat:@"%d", isFeatureMatteriPhoneOnlyPairingControlEnabled()];
  [v4 setObject:v52 forKeyedSubscript:@"iPhoneOnlyPairingAndControl (iPOP)"];

  v53 = MEMORY[0x277CCACA8];
  v54 = [(HMDHomeManager *)self currentDeviceAliroVersion];
  v55 = [v53 stringWithFormat:@"%@", v54];
  [v4 setObject:v55 forKeyedSubscript:@"Current device Aliro version"];

  v56 = +[HMDHomeKeyDataRecorder sharedRecorder];
  v57 = [v56 records];
  [v4 setObject:v57 forKeyedSubscript:@"Home Key Change Records"];

  v58 = objc_alloc_init(MEMORY[0x277CD55A8]);
  v59 = [v58 storedValuesByKey];
  [v4 setObject:v59 forKeyedSubscript:@"System Commissioner Key-Value Store"];

  v60 = *MEMORY[0x277D85DE8];

  return v4;
}

void __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 dumpStateWithPrivacyLevel:*(a1 + 40)];
  [v2 addObject:v3];
}

void __56__HMDHomeManager___dumpHomeManagerDataWithPrivacyLevel___block_invoke_2(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v3 = [a2 outgoingInvitations];
  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v12;
    do
    {
      v7 = 0;
      do
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(a1 + 32);
        v9 = [*(*(&v11 + 1) + 8 * v7) describeWithFormat];
        [v8 addObject:v9];

        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v5);
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (id)_dumpHomeManagerDataWithPrivacyLevel:(unint64_t)a3
{
  v5 = objc_autoreleasePoolPush();
  v6 = [(HMDHomeManager *)self __dumpHomeManagerDataWithPrivacyLevel:a3];
  objc_autoreleasePoolPop(v5);

  return v6;
}

- (void)_handleNetworkMismatchInfo:(id)a3
{
  v17 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (isInternalBuild())
  {
    v5 = +[HMDMainDriver driver];
    v6 = [v5 currentWiFiNetworkInfo];
    v13[0] = MEMORY[0x277D85DD0];
    v13[1] = 3221225472;
    v13[2] = __45__HMDHomeManager__handleNetworkMismatchInfo___block_invoke;
    v13[3] = &unk_279732A48;
    v13[4] = self;
    v14 = v4;
    [(HMDHomeManager *)self findAccessoriesNotOnWiFiWithCurrentWiFi:v6 completionHandler:v13];
  }

  else
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v16 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@Not internal build NetworkMismatchInfo message not allowed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [v4 respondWithError:v11];
  }

  v12 = *MEMORY[0x277D85DE8];
}

void __45__HMDHomeManager__handleNetworkMismatchInfo___block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_DEFAULT))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543618;
    v10 = v7;
    v11 = 2112;
    v12 = v3;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_DEFAULT, "%{public}@wifi mismatch accessories %@", &v9, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 40) respondWithSuccess];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_handleDiagnosticInfo:(id)a3
{
  v22[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (isInternalBuild())
  {
    v5 = [(HMDHomeManager *)self appleMediaAccessoryDiagnosticInfoController];
    v22[0] = *MEMORY[0x277CD0118];
    v6 = [MEMORY[0x277CBEA60] arrayWithObjects:v22 count:1];
    v7 = [v5 diagnosticInfoDataWithAdditionalKeys:v6];

    v8 = [HMDAppleMediaAccessoryDiagnosticInfoController diagnosticInfoDescriptionWithData:v7];
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v12;
      v20 = 2112;
      v21 = v8;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Obtained diagnostic Info %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    [v4 respondWithPayload:v8];
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@Not internal build DiagnosticInfo message not allowed", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    [v4 respondWithError:v7];
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_handleDumpState:(id)a3
{
  v4 = a3;
  v5 = [v4 arrayForKey:*MEMORY[0x277CD2260]];
  if ([v5 count])
  {
    v6 = [v5 containsObject:*MEMORY[0x277CD2200]];
  }

  else
  {
    v6 = 1;
  }

  v7 = [v4 messagePayload];
  v8 = [v7 hmf_numberForKey:*MEMORY[0x277CD0740]];
  v9 = [v8 unsignedIntValue];

  v10 = [v4 activity];
  v11 = [(HMDHomeManager *)self _getRequestedState:v5 activity:v10 privacyLevel:v9];

  v12 = objc_autoreleasePoolPush();
  if (v6 & 1) != 0 || ([v5 containsObject:*MEMORY[0x277CD0188]])
  {
    v13 = +[HMDXPCMessageCountTracker sharedTracker];
    v14 = [v13 stateDump];
    [v11 setObject:v14 forKeyedSubscript:@"XPC Message Count Tracker"];

    v15 = +[HMDXPCMessageTransport defaultTransport];
    v16 = [v15 stateDump];
    [v11 setObject:v16 forKeyedSubscript:@"Default XPC Transport"];

    v17 = +[HMDXPCMessageTransport accessorySetupTransport];
    v18 = [v17 stateDump];
    [v11 setObject:v18 forKeyedSubscript:@"Accessory Setup XPC Transport"];

    objc_autoreleasePoolPop(v12);
    v19 = objc_autoreleasePoolPush();
    if (v6)
    {
      v20 = *MEMORY[0x277CD0168];
      goto LABEL_10;
    }
  }

  else
  {
    objc_autoreleasePoolPop(v12);
    v19 = objc_autoreleasePoolPush();
  }

  v20 = *MEMORY[0x277CD0168];
  if (([v5 containsObject:*MEMORY[0x277CD0168]] & 1) == 0)
  {
    objc_autoreleasePoolPop(v19);
    v23 = objc_autoreleasePoolPush();
    goto LABEL_13;
  }

LABEL_10:
  v21 = [(HMDHomeManager *)self compositeSettingsControllerManager];
  v22 = [v21 dumpStateInfo];
  [v11 setObject:v22 forKeyedSubscript:v20];

  objc_autoreleasePoolPop(v19);
  v23 = objc_autoreleasePoolPush();
  if (v6)
  {
    v24 = *MEMORY[0x277CD0178];
LABEL_14:
    v25 = [MEMORY[0x277CBEB38] dictionary];
    v26 = [(HMDHomeManager *)self eventRouterXPCServer];
    v27 = [v26 dumpStateDescription];
    [v25 setObject:v27 forKeyedSubscript:@"XPCServer"];

    v28 = [(HMDHomeManager *)self homes];
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __35__HMDHomeManager__handleDumpState___block_invoke;
    v38[3] = &unk_279732398;
    v39 = v25;
    v29 = v25;
    [v28 hmf_enumerateWithAutoreleasePoolUsingBlock:v38];

    v30 = [v29 copy];
    [v11 setObject:v30 forKeyedSubscript:v24];

    goto LABEL_15;
  }

LABEL_13:
  v24 = *MEMORY[0x277CD0178];
  if ([v5 containsObject:*MEMORY[0x277CD0178]])
  {
    goto LABEL_14;
  }

LABEL_15:
  objc_autoreleasePoolPop(v23);
  v31 = [(HMDHomeManager *)self _dumpHomeManagerDataWithPrivacyLevel:v9];
  if ([v5 containsObject:*MEMORY[0x277CD0170]] && objc_msgSend(v4, "isEntitledForStateDump"))
  {
    [v11 setObject:v31 forKeyedSubscript:*MEMORY[0x277CD2220]];
  }

  else
  {
    [(HMDHomeManager *)self _dumpToLog:v31 withState:v11];
  }

  v32 = [MEMORY[0x277CCABB0] numberWithBool:0];
  [v11 setObject:v32 forKeyedSubscript:*MEMORY[0x277CD0258]];

  v33 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isThisDesignatedFMFDevice](self, "isThisDesignatedFMFDevice")}];
  [v11 setObject:v33 forKeyedSubscript:*MEMORY[0x277CD0268]];

  v34 = CFPreferencesCopyMultiple(0, *MEMORY[0x277CD0030], *MEMORY[0x277CBF040], *MEMORY[0x277CBF030]);
  [v11 setObject:v34 forKeyedSubscript:*MEMORY[0x277CD2278]];

  v35 = [(HMDHomeManager *)self powerManager];
  if ([v35 isPowerAsserted])
  {
    v36 = @"YES";
  }

  else
  {
    v36 = @"NO";
  }

  [v11 setObject:v36 forKeyedSubscript:*MEMORY[0x277CCFD00]];

  v37 = [v11 copy];
  [v4 respondWithPayload:v37];
}

void __35__HMDHomeManager__handleDumpState___block_invoke(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 eventRouterDumpStateInfo];
  [v2 addEntriesFromDictionary:v3];
}

- (id)_getRequestedState:(id)a3 activity:(id)a4 privacyLevel:(unint64_t)a5
{
  v254 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = objc_opt_new();
  v11 = [v8 count];
  v12 = &unk_253D4B000;
  v13 = MEMORY[0x277CD2268];
  v227 = v10;
  v225 = v9;
  v226 = self;
  v228 = a5;
  if (v11 && ([v8 containsObject:*MEMORY[0x277CD2200]] & 1) == 0)
  {
    if (![v8 containsObject:*MEMORY[0x277CD2218]])
    {
      goto LABEL_44;
    }

    v224 = 0;
  }

  else
  {
    v224 = 1;
  }

  v14 = [MEMORY[0x277CBEB18] array];
  v15 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumHomes", maximumHomes];
  [v14 addObject:v15];

  v16 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumAccessoriesPerHome", maximumAccessoriesPerHome];
  [v14 addObject:v16];

  v17 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumRoomsPerHome", maximumRoomsPerHome];
  [v14 addObject:v17];

  v18 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumZonesPerHome", maximumZonesPerHome];
  [v14 addObject:v18];

  v19 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumTriggersPerHome", maximumTriggersPerHome];
  [v14 addObject:v19];

  v20 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumActionSetsPerHome", maximumActionSetsPerHome];
  [v14 addObject:v20];

  v21 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServiceGroupsPerHome", maximumServiceGroupsPerHome];
  [v14 addObject:v21];

  v22 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumUsersPerHome", maximumUsersPerHome];
  [v14 addObject:v22];

  v23 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumRoomsPerZone", maximumRoomsPerZone];
  [v14 addObject:v23];

  v24 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumActionsPerActionSet", maximumActionsPerActionSet];
  [v14 addObject:v24];

  v25 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServicesPerServiceGroup", maximumServicesPerServiceGroup];
  [v14 addObject:v25];

  v26 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumAccessoriesPerBridge", maximumAccessoriesPerBridge];
  [v14 addObject:v26];

  v27 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumServicesPerAccessory", maximumServicesPerAccessory];
  [v14 addObject:v27];

  v28 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumCharacteristicsPerService", maximumCharacteristicsPerService];
  [v14 addObject:v28];

  v29 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maximumDataSyncFragmentSize", maximumDataSyncFragmentSize];
  [v14 addObject:v29];

  v30 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %f", @"minimumTimerRecurrence", minimumTimerRecurrence];
  [v14 addObject:v30];

  v31 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudPushBatchLimit", cloudPushBatchLimit];
  [v14 addObject:v31];

  v32 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"maxCloudOperationRetries", maxCloudOperationRetries];
  [v14 addObject:v32];

  v33 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudUploadTimerInterval", cloudUploadTimerInterval];
  [v14 addObject:v33];

  v34 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudZoneUploadTimerInitialInterval", cloudZoneUploadTimerInitialInterval];
  [v14 addObject:v34];

  v35 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"cloudZoneUploadTimerInterval", cloudZoneUploadTimerInterval];
  [v14 addObject:v35];

  v36 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"aggressiveControllerKeyPollInterval", aggressiveControllerKeyPollInterval];
  [v14 addObject:v36];

  v37 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"watchdogControllerKeyPollTimeout", watchdogControllerKeyPollTimeout];
  [v14 addObject:v37];

  v38 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyPollInterval", controllerKeyPollInterval];
  [v14 addObject:v38];

  v39 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"keychainPopupTimerInterval", keychainPopupTimerInterval];
  [v14 addObject:v39];

  v40 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"checkRemoteAccessTimeout", checkRemoteAccessTimeout];
  [v14 addObject:v40];

  v41 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsCommitTimeout", hrsCommitTimeoutNanoseconds];
  [v14 addObject:v41];

  v42 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsIdleClientTimeout", hrsIdleClientTimeoutNanoseconds];
  [v14 addObject:v42];

  v43 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsIdleServertTimeout", hrsIdleServertTimeoutNanoseconds];
  [v14 addObject:v43];

  v44 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendInternalRequestTimeout", hrsSendInternalRequestTimeoutNanoseconds];
  [v14 addObject:v44];

  v45 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendInternalRequestToWatchTimeout", hrsSendInternalRequestToWatchTimeoutNanoseconds];
  [v14 addObject:v45];

  v46 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"hrsSendUserRequestTimeout", hrsSendUserRequestTimeoutNanoseconds];
  [v14 addObject:v46];

  v47 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"maximumSecureRemoteStreams", maximumSecureRemoteStreams];
  [v14 addObject:v47];

  v48 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %f", @"secureSessionMessageTimeout", secureSessionMessageTimeout];
  [v14 addObject:v48];

  v49 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"DeviceConnectionKeepAliveTimerPeriod", deviceConnectionKeepAliveTimerPeriod];
  [v14 addObject:v49];

  v50 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"DeviceConnectionKeepAliveResponseTimeoutPeriod", deviceConnectionKeepAliveResponseTimeoutPeriod];
  [v14 addObject:v50];

  v51 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedResolutions", supportedResolutions];
  [v14 addObject:v51];

  v52 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedVideoCodecs", supportedVideoCodecs];
  [v14 addObject:v52];

  v53 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedAudioCodecs", supportedAudioCodecs];
  [v14 addObject:v53];

  v54 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SupportedSRTPAuths", supportedSRTPAuths];
  [v14 addObject:v54];

  v55 = MEMORY[0x277CCACA8];
  v56 = HMFBooleanToString();
  v57 = [v55 stringWithFormat:@"%@: %@", @"CameraStreamNetworkAdaptation", v56];
  [v14 addObject:v57];

  v58 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"RTPPtime", rtpPtime];
  [v14 addObject:v58];

  v59 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"SnapshotResolution", snapshotResolution];
  [v14 addObject:v59];

  v60 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"MaximumSimultaneousRemoteStreams", maximumSimultaneousRemoteStreams];
  [v14 addObject:v60];

  v61 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %g", @"SnapshotCacheValidPeriod", snapshotCacheValidPeriod];
  [v14 addObject:v61];

  v62 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"BulletinSecureTriggerTimeoutInSeconds", bulletinSecureTriggerTimeoutInSeconds];
  [v14 addObject:v62];

  v63 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"BroadcastKeyRefreshTimeInSeconds", broadcastKeyRefreshTimeInSeconds];
  [v14 addObject:v63];

  v64 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"BluetoothGSNMaxValue", bluetoothGSNMaxValue];
  [v14 addObject:v64];

  v65 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"btleReachabilityTimer", btleReachabilityTimerNanoseconds];
  [v14 addObject:v65];

  v66 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"btleReachabilityLeeway", btleReachabilityLeewayNanoseconds];
  [v14 addObject:v66];

  v67 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"btleReachabilityProbeReduceFactor", btleReachabilityProbeReduceFactor];
  [v14 addObject:v67];

  v68 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"remotePendingResponseTimer", remotePendingResponseTimerNanoseconds];
  [v14 addObject:v68];

  v69 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"remotePendingResponseLeeway", remotePendingResponseLeewayNanoseconds];
  [v14 addObject:v69];

  v70 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lu", @"remotePendingResponseDecayScale", remotePendingResponseDecayScale];
  [v14 addObject:v70];

  v71 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorHealthTimerTimeInterval", remoteDeviceMonitorHealthTimerTimeInterval];
  [v14 addObject:v71];

  v72 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorRetryTimerMinimumTimeInterval", remoteDeviceMonitorRetryTimerMinimumTimeInterval];
  [v14 addObject:v72];

  v73 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"remoteDeviceMonitorRetryTimerMaximumTimeInterval", remoteDeviceMonitorRetryTimerMaximumTimeInterval];
  [v14 addObject:v73];

  v74 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"remoteDeviceMonitorRetryTimerFactor", remoteDeviceMonitorRetryTimerFactor];
  [v14 addObject:v74];

  v75 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"accessoryConnectivityWaitPeriod", accessoryConnectivityWaitPeriod];
  [v14 addObject:v75];

  v76 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"cloudDataSyncInProgressWaitPeriod", cloudDataSyncInProgressWaitPeriod];
  [v14 addObject:v76];

  v77 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyNotLandingWaitPeriod", controllerKeyNotLandingWaitPeriod];
  [v14 addObject:v77];

  v78 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %llu", @"controllerKeyNotLandingShortCircuitWaitPeriod", controllerKeyNotLandingShortCircuitWaitPeriod];
  [v14 addObject:v78];

  v79 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"assistantClientReadWriteTimeout", assistantClientReadWriteTimeoutSeconds];
  [v14 addObject:v79];

  v80 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"assistantClientActionSetTimeout", assistantClientActionSetTimeoutSeconds];
  [v14 addObject:v80];

  v81 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"disableNotificationsDeferPeriod", disableNotificationsDeferPeriod];
  [v14 addObject:v81];

  v82 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"coalesceNotificationsPeriod", coalesceNotificationsPeriod];
  [v14 addObject:v82];

  v83 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"delayNotificationsPeriod", delayNotificationsPeriod];
  [v14 addObject:v83];

  v84 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pendingResponseTickPeriod", pendingResponseTickPeriod];
  [v14 addObject:v84];

  v85 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pendingResponseMaxPeriod", pendingResponseMaxPeriod];
  [v14 addObject:v85];

  v86 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"kRemoteReachabilitNotificationsDeferPeriod", remoteReachabilityNotificationsDeferPeriod];
  [v14 addObject:v86];

  v87 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"kRemoteReachabilityDeregistrationDeferPeriod", remoteReachabilityDeregistrationDeferPeriod];
  [v14 addObject:v87];

  if (skipAuthPromptDialog)
  {
    v88 = @"YES";
  }

  else
  {
    v88 = @"NO";
  }

  v89 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"allowSkipMFIPrompt", v88];
  [v14 addObject:v89];

  if (showAuthDialog)
  {
    v90 = @"YES";
  }

  else
  {
    v90 = @"NO";
  }

  v91 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"showAuthDialog", v90];
  [v14 addObject:v91];

  if (disableCloudDataSync)
  {
    v92 = @"YES";
  }

  else
  {
    v92 = @"NO";
  }

  v93 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"DisableCloudDataSync", v92];
  [v14 addObject:v93];

  if (disableLegacyCloudDataSync)
  {
    v94 = @"YES";
  }

  else
  {
    v94 = @"NO";
  }

  v95 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"DisableLegacyCloudDataSync", v94];
  [v14 addObject:v95];

  if (enableWakeNotifications)
  {
    v96 = @"YES";
  }

  else
  {
    v96 = @"NO";
  }

  v97 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"EnableWakeNotifications", v96];
  [v14 addObject:v97];

  v98 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pairingInterruptionGracePeriod", pairingInterruptionGracePeriod];
  [v14 addObject:v98];

  v99 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"pairingReconfirmWaitPeriod", pairingReconfirmWaitPeriod];
  [v14 addObject:v99];

  v100 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"vendorInfoFetchPeriod", vendorInfoFetchPeriod];
  [v14 addObject:v100];

  v101 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"attestationInfoFetchPeriod", attestationInfoFetchPeriod];
  [v14 addObject:v101];

  v102 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"keyTransferBroadcastMaximumDelay", keyTransferBroadcastMaximumDelay];
  [v14 addObject:v102];

  v103 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"vendorInfoDatabaseServerURLOverride", vendorInfoDatabaseServerURLOverride];
  [v14 addObject:v103];

  v104 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"appleConfigurationServer", appleConfigurationServer];
  [v14 addObject:v104];

  v105 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"homeKitConfigurationPath", homeKitConfigurationPath];
  [v14 addObject:v105];

  v106 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"mediaBrowserProcessingInterval", mediaBrowserProcessingInterval];
  [v14 addObject:v106];

  v107 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"disableReprivsionBrowsingPeriodInMinutes", disableReprivsionBrowsingPeriodInMinutes];
  [v14 addObject:v107];

  v108 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %lf", @"authServerRetryTimeIntervalInSeconds", authServerRetryTimeIntervalInSeconds];
  [v14 addObject:v108];

  v109 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"authServerRetryCount", authServerRetryCount];
  v110 = v14;
  [v14 addObject:v109];

  v250 = 0u;
  v251 = 0u;
  v248 = 0u;
  v249 = 0u;
  obj = preferredPrimaryForHome;
  v111 = [obj countByEnumeratingWithState:&v248 objects:v253 count:16];
  if (v111)
  {
    v112 = v111;
    v113 = *v249;
    do
    {
      for (i = 0; i != v112; ++i)
      {
        if (*v249 != v113)
        {
          objc_enumerationMutation(obj);
        }

        v115 = *(*(&v248 + 1) + 8 * i);
        v116 = MEMORY[0x277CCACA8];
        v117 = [v115 UUIDString];
        v118 = [preferredPrimaryForHome objectForKey:v115];
        v119 = [v118 UUIDString];
        v120 = [v116 stringWithFormat:@"%@: %@: %@", @"preferredPrimaryForHome", v117, v119];
        [v110 addObject:v120];
      }

      v112 = [obj countByEnumeratingWithState:&v248 objects:v253 count:16];
    }

    while (v112);
  }

  if (disableWACBrowser)
  {
    v121 = @"YES";
  }

  else
  {
    v121 = @"NO";
  }

  v122 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"disableWACBrowser", v121];
  v123 = v110;
  [v110 addObject:v122];

  if (delayBatchedReadWrite)
  {
    v124 = @"YES";
  }

  else
  {
    v124 = @"NO";
  }

  v125 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"delayBatchedReadWrite", v124];
  [v110 addObject:v125];

  if (enableNetworkLogging)
  {
    v126 = @"YES";
  }

  else
  {
    v126 = @"NO";
  }

  v127 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"enableNetworkLogging", v126];
  [v110 addObject:v127];

  v128 = MEMORY[0x277CCACA8];
  v129 = CKContainerEnvironmentString();
  v130 = [v128 stringWithFormat:@"%@: %@", @"cloudKitEnvironment", v129];
  [v110 addObject:v130];

  if (allowAnonymousServerConnections)
  {
    v131 = @"YES";
  }

  else
  {
    v131 = @"NO";
  }

  v132 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %@", @"allowAnonymousServerConnections", v131];
  [v110 addObject:v132];

  v133 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceFeedRefreshInMinutes", presenceFeedRefreshInMinutes];
  [v110 addObject:v133];

  v134 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceMonitorAuditInMinutes", presenceMonitorAuditInMinutes];
  [v110 addObject:v134];

  v135 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"presenceMonitorRefreshGracePeriodInMinutes", presenceMonitorRefreshGracePeriodInMinutes];
  [v110 addObject:v135];

  v136 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"startCharacteristicsMonitorWaitPeriod", startCharacteristicsMonitorWaitPeriod];
  [v110 addObject:v136];

  v137 = [MEMORY[0x277CCACA8] stringWithFormat:@"%@: %tu", @"requestHomeDataSyncRetryPeriodInMinutes", requestHomeDataSyncRetryPeriodInMinutes];
  [v110 addObject:v137];

  v138 = [v110 copy];
  v10 = v227;
  if ([v138 count])
  {
    [v227 setObject:v138 forKeyedSubscript:*MEMORY[0x277CD2218]];
  }

  self = v226;
  v12 = &unk_253D4B000;
  a5 = v228;
  v13 = MEMORY[0x277CD2268];
  if (v224)
  {
    v139 = 1;
    goto LABEL_46;
  }

LABEL_44:
  if (![v8 containsObject:*MEMORY[0x277CD2270]])
  {
    goto LABEL_50;
  }

  v139 = 0;
LABEL_46:
  v140 = [(HMDHomeManager *)self accessoryBrowserInternal];
  v141 = [v140 dumpUnassociatedAccessories];

  if ([v141 count])
  {
    [v10 setObject:v141 forKeyedSubscript:*MEMORY[0x277CD2270]];
  }

  if (v139)
  {
    v142 = 1;
    goto LABEL_52;
  }

LABEL_50:
  if (![v8 containsObject:*MEMORY[0x277CD2240]])
  {
    goto LABEL_56;
  }

  v142 = 0;
LABEL_52:
  v143 = MEMORY[0x277CBEB18];
  v144 = [(HMDHomeManager *)self homes];
  v145 = [v143 arrayWithCapacity:{objc_msgSend(v144, "count")}];

  v146 = [(HMDHomeManager *)self homes];
  v246[0] = MEMORY[0x277D85DD0];
  v246[1] = v12[103];
  v246[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke;
  v246[3] = &unk_279732398;
  v147 = v145;
  v247 = v147;
  [v146 hmf_enumerateWithAutoreleasePoolUsingBlock:v246];

  if ([v147 count])
  {
    v148 = [v147 copy];
    [v10 setObject:v148 forKeyedSubscript:*MEMORY[0x277CD2240]];
  }

  if (v142)
  {
    v149 = 1;
    goto LABEL_58;
  }

LABEL_56:
  if (![v8 containsObject:*v13])
  {
    goto LABEL_63;
  }

  v149 = 0;
LABEL_58:
  v150 = [MEMORY[0x277CCAB68] string];
  v151 = [(HMDHomeManager *)self residentMesh];

  if (v151)
  {
    v152 = [(HMDHomeManager *)self residentMesh];
    v153 = [v152 stateDump];
    [v150 appendString:v153];
  }

  else
  {
    [v150 appendString:{@"No Resident mesh (not resident capable device, or hasn't completely started up)."}];
  }

  [v10 setObject:v150 forKeyedSubscript:*v13];

  if (v149)
  {
    v154 = 1;
    goto LABEL_65;
  }

LABEL_63:
  if (![v8 containsObject:*MEMORY[0x277CD21F0]])
  {
    goto LABEL_71;
  }

  v154 = 0;
LABEL_65:
  v155 = [MEMORY[0x277CCAB68] string];
  v156 = [(HMDHomeManager *)self appleAccountManager];
  v157 = [v156 device];

  if (v157)
  {
    v158 = [v157 name];
    v159 = [v157 identifier];
    v160 = [v159 UUIDString];
    [v155 appendFormat:@"Current Device %@(%@)\n", v158, v160];
  }

  v161 = [(HMDHomeManager *)self accountRegistry];
  v162 = [v161 accounts];
  v244[0] = MEMORY[0x277D85DD0];
  v244[1] = v12[103];
  v244[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_2;
  v244[3] = &unk_2797329F8;
  v163 = v155;
  v245 = v163;
  [v162 hmf_enumerateWithAutoreleasePoolUsingBlock:v244];

  if ([v163 length])
  {
    [v10 setObject:v163 forKeyedSubscript:*MEMORY[0x277CD21F0]];
  }

  a5 = v228;
  if (v154)
  {
    v164 = 1;
    goto LABEL_73;
  }

LABEL_71:
  v165 = *MEMORY[0x277CD2250];
  if (![v8 containsObject:*MEMORY[0x277CD2250]])
  {
    goto LABEL_78;
  }

  v164 = 0;
LABEL_73:
  v166 = [(HMDHomeManager *)self accessoryBrowserInternal];
  v167 = [v166 dumpRegisteredPairedAccessories];

  if ([v167 length])
  {
    [v10 setObject:v167 forKeyedSubscript:*MEMORY[0x277CD2250]];
  }

  if (v164)
  {
    v168 = 1;
    goto LABEL_81;
  }

  v165 = *MEMORY[0x277CD2250];
LABEL_78:
  if (([v8 containsObject:v165] & 1) == 0 && !objc_msgSend(v8, "containsObject:", *MEMORY[0x277CD2270]))
  {
    goto LABEL_85;
  }

  v168 = 0;
LABEL_81:
  v169 = [(HMDHomeManager *)self accessoryBrowser];
  v170 = [v169 dumpBrowsingConnections];

  if ([v170 length])
  {
    [v10 setObject:v170 forKeyedSubscript:*MEMORY[0x277CD2208]];
  }

  if (v168)
  {
    v171 = 1;
    goto LABEL_87;
  }

LABEL_85:
  if (![v8 containsObject:*MEMORY[0x277CD2248]])
  {
    goto LABEL_100;
  }

  v171 = 0;
LABEL_87:
  v172 = [MEMORY[0x277CCAB68] string];
  v240 = 0u;
  v241 = 0u;
  v242 = 0u;
  v243 = 0u;
  v173 = +[HMDUserManagementOperationManager sharedManager];
  v174 = [v173 operations];

  v175 = [v174 countByEnumeratingWithState:&v240 objects:v252 count:16];
  if (v175)
  {
    v176 = v175;
    v177 = *v241;
    v178 = 1;
    do
    {
      for (j = 0; j != v176; ++j)
      {
        if (*v241 != v177)
        {
          objc_enumerationMutation(v174);
        }

        v180 = *(*(&v240 + 1) + 8 * j);
        if (v178)
        {
          [v172 appendFormat:@"Pending User Management Operations\n"];
        }

        [v172 appendFormat:@"\tOperation = %@\n", v180];
        v178 = 0;
      }

      v176 = [v174 countByEnumeratingWithState:&v240 objects:v252 count:16];
      v178 = 0;
    }

    while (v176);
  }

  self = v226;
  v10 = v227;
  if ([v172 length])
  {
    [v227 setObject:v172 forKeyedSubscript:*MEMORY[0x277CD2248]];
  }

  a5 = v228;
  v12 = &unk_253D4B000;
  if (v171)
  {
    v181 = [(HMDHomeManager *)v226 messageDispatcher];
    v182 = [v181 secureRemoteTransport];
    v183 = [v182 dumpStateWithPrivacyLevel:v228];
    [v227 setObject:v183 forKeyedSubscript:@"RemoteMessaging"];

    v184 = 1;
    goto LABEL_104;
  }

LABEL_100:
  if ([v8 containsObject:*MEMORY[0x277CD2258]])
  {
    v185 = [(HMDHomeManager *)self messageDispatcher];
    v186 = [v185 secureRemoteTransport];
    v187 = [v186 dumpStateWithPrivacyLevel:a5];
    [v10 setObject:v187 forKeyedSubscript:@"RemoteMessaging"];
  }

  if (![v8 containsObject:*MEMORY[0x277CD21F8]])
  {
    if (isWatch())
    {
      goto LABEL_123;
    }

    goto LABEL_110;
  }

  v184 = 0;
LABEL_104:
  v188 = [MEMORY[0x277CBEB38] dictionary];
  v189 = [(HMDHomeManager *)self homes];
  v237[0] = MEMORY[0x277D85DD0];
  v237[1] = v12[103];
  v237[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_3;
  v237[3] = &unk_279732A20;
  v190 = v188;
  v238 = v190;
  v239 = a5;
  [v189 hmf_enumerateWithAutoreleasePoolUsingBlock:v237];

  if ([v190 count])
  {
    v191 = [v190 copy];
    [v10 setObject:v191 forKeyedSubscript:*MEMORY[0x277CD21F8]];
  }

  if (!isWatch())
  {
    if (v184)
    {
      v192 = 1;
      goto LABEL_112;
    }

LABEL_110:
    if (![v8 containsObject:*MEMORY[0x277CD2210]])
    {
      goto LABEL_116;
    }

    v192 = 0;
LABEL_112:
    v193 = [MEMORY[0x277CCAB68] string];
    v194 = [(HMDHomeManager *)self homes];
    v235[0] = MEMORY[0x277D85DD0];
    v235[1] = v12[103];
    v235[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_4;
    v235[3] = &unk_279732398;
    v195 = v193;
    v236 = v195;
    [v194 hmf_enumerateWithAutoreleasePoolUsingBlock:v235];

    if ([v195 length])
    {
      [v10 setObject:v195 forKeyedSubscript:*MEMORY[0x277CD2210]];
    }

    if (v192)
    {
      v184 = 1;
LABEL_118:
      v196 = [MEMORY[0x277CBEB38] dictionary];
      v197 = [(HMDHomeManager *)self homes];
      v232[0] = MEMORY[0x277D85DD0];
      v232[1] = v12[103];
      v232[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_5;
      v232[3] = &unk_279732A20;
      v198 = v196;
      v233 = v198;
      v234 = a5;
      [v197 hmf_enumerateWithAutoreleasePoolUsingBlock:v232];

      if ([v198 count])
      {
        v199 = [v198 copy];
        [v10 setObject:v199 forKeyedSubscript:*MEMORY[0x277CD2230]];
      }

      goto LABEL_121;
    }

LABEL_116:
    if (![v8 containsObject:*MEMORY[0x277CD2230]])
    {
      goto LABEL_123;
    }

    v184 = 0;
    goto LABEL_118;
  }

LABEL_121:
  if (v184)
  {
    v200 = [(HMDHomeManager *)self syncManager];
    v201 = [v200 dumpState];
    [v10 setObject:v201 forKeyedSubscript:*MEMORY[0x277D0F178]];

    v202 = *MEMORY[0x277D0F050];
    v203 = [(HMDHomeManager *)self appData];
    v204 = [v203 dumpStateWithPrivacyLevel:a5];
    [v10 setObject:v204 forKeyedSubscript:v202];

    v205 = [MEMORY[0x277CFEC78] systemStore];
    v206 = [v205 dumpState];
    [v10 setObject:v206 forKeyedSubscript:*MEMORY[0x277D0F0F0]];

    v207 = *MEMORY[0x277CD2238];
    v208 = v225;
LABEL_130:
    v218 = [MEMORY[0x277CBEB18] array];
    v219 = [(HMDHomeManager *)self homes];
    v230[0] = MEMORY[0x277D85DD0];
    v230[1] = v12[103];
    v230[2] = __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_6;
    v230[3] = &unk_279732398;
    v220 = v218;
    v231 = v220;
    [v219 hmf_enumerateWithAutoreleasePoolUsingBlock:v230];

    [v10 setObject:v220 forKeyedSubscript:v207];
    goto LABEL_131;
  }

LABEL_123:
  v209 = *MEMORY[0x277D0F178];
  if ([v8 containsObject:*MEMORY[0x277D0F178]])
  {
    v210 = [(HMDHomeManager *)self syncManager];
    v211 = [v210 dumpState];
    [v10 setObject:v211 forKeyedSubscript:v209];
  }

  v212 = *MEMORY[0x277D0F050];
  if ([v8 containsObject:*MEMORY[0x277D0F050]])
  {
    v213 = [(HMDHomeManager *)self appData];
    v214 = [v213 dumpStateWithPrivacyLevel:a5];
    [v10 setObject:v214 forKeyedSubscript:v212];
  }

  v215 = *MEMORY[0x277D0F0F0];
  v208 = v225;
  if ([v8 containsObject:*MEMORY[0x277D0F0F0]])
  {
    v216 = [MEMORY[0x277CFEC78] systemStore];
    v217 = [v216 dumpState];
    [v10 setObject:v217 forKeyedSubscript:v215];
  }

  v207 = *MEMORY[0x277CD2238];
  if ([v8 containsObject:*MEMORY[0x277CD2238]])
  {
    goto LABEL_130;
  }

LABEL_131:
  v221 = v10;

  v222 = *MEMORY[0x277D85DE8];
  return v10;
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [MEMORY[0x277CBEB38] dictionaryWithCapacity:3];
  v5 = [v3 accessories];
  v6 = MEMORY[0x277CCACA8];
  v7 = [v3 name];
  v8 = [v6 stringWithFormat:@"Home: %@", v7];
  [v4 setObject:v8 forKeyedSubscript:*MEMORY[0x277D0F0B8]];

  v9 = [v3 primaryResident];
  v10 = [v9 dumpState];

  v11 = MEMORY[0x277CCACA8];
  v12 = [v10 objectForKeyedSubscript:*MEMORY[0x277D0F170]];
  v13 = [v11 stringWithFormat:@"Resident: %@", v12];
  [v4 setObject:v13 forKeyedSubscript:*MEMORY[0x277D0F138]];

  v14 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v5, "count")}];
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v15 = v5;
  v16 = [v15 countByEnumeratingWithState:&v23 objects:v27 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v24;
    do
    {
      v19 = 0;
      do
      {
        if (*v24 != v18)
        {
          objc_enumerationMutation(v15);
        }

        v20 = [*(*(&v23 + 1) + 8 * v19) dumpSimpleState];
        [v14 addObject:v20];

        ++v19;
      }

      while (v17 != v19);
      v17 = [v15 countByEnumeratingWithState:&v23 objects:v27 count:16];
    }

    while (v17);
  }

  if ([v14 count])
  {
    v21 = [v14 copy];
    [v4 setObject:v21 forKeyedSubscript:*MEMORY[0x277D0F028]];
  }

  [*(a1 + 32) addObject:v4];

  v22 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_2(uint64_t a1, void *a2)
{
  v58 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = *(a1 + 32);
  v5 = [v3 shortDescription];
  [v4 appendFormat:@"Account %@:\n", v5];

  v53 = 0u;
  v54 = 0u;
  v51 = 0u;
  v52 = 0u;
  v6 = [v3 handles];
  v7 = [v6 countByEnumeratingWithState:&v51 objects:v57 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v52;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v52 != v9)
        {
          objc_enumerationMutation(v6);
        }

        [*(a1 + 32) appendFormat:@"\t%@\n", *(*(&v51 + 1) + 8 * i)];
      }

      v8 = [v6 countByEnumeratingWithState:&v51 objects:v57 count:16];
    }

    while (v8);
  }

  v11 = [v3 devices];
  v12 = [v11 count];

  if (v12)
  {
    v49 = 0u;
    v50 = 0u;
    v47 = 0u;
    v48 = 0u;
    v31 = v3;
    obj = [v3 devices];
    v34 = [obj countByEnumeratingWithState:&v47 objects:v56 count:16];
    if (v34)
    {
      v33 = *v48;
      do
      {
        v13 = 0;
        do
        {
          if (*v48 != v33)
          {
            objc_enumerationMutation(obj);
          }

          v14 = *(*(&v47 + 1) + 8 * v13);
          v37 = *(a1 + 32);
          v42 = [v14 name];
          v39 = [v14 identifier];
          v41 = [v39 UUIDString];
          v38 = [v14 version];
          v40 = v13;
          if (v38)
          {
            v35 = [v14 version];
            v36 = v35;
          }

          else
          {
            v36 = @"Unknown";
          }

          v15 = [v14 productInfo];
          [v15 productPlatform];
          v16 = HMFProductPlatformToString();
          v17 = [v14 productInfo];
          [v17 productClass];
          v18 = HMFProductClassToString();
          v19 = [v14 productInfo];
          v20 = [v19 softwareVersion];
          v21 = [v20 versionString];
          [v37 appendFormat:@"\tDevice %@(%@), Version = %@, Platform = %@, Class = %@, OS = %@\n", v42, v41, v36, v16, v18, v21];

          if (v38)
          {
          }

          v45 = 0u;
          v46 = 0u;
          v43 = 0u;
          v44 = 0u;
          v22 = [v14 handles];
          v23 = [v22 countByEnumeratingWithState:&v43 objects:v55 count:16];
          if (v23)
          {
            v24 = v23;
            v25 = *v44;
            do
            {
              for (j = 0; j != v24; ++j)
              {
                if (*v44 != v25)
                {
                  objc_enumerationMutation(v22);
                }

                [*(a1 + 32) appendFormat:@"\t\t%@\n", *(*(&v43 + 1) + 8 * j)];
              }

              v24 = [v22 countByEnumeratingWithState:&v43 objects:v55 count:16];
            }

            while (v24);
          }

          v27 = [v14 capabilities];

          if (v27)
          {
            v28 = *(a1 + 32);
            v29 = [v14 capabilities];
            [v28 appendFormat:@"\t\t%@\n", v29];
          }

          v13 = v40 + 1;
        }

        while (v40 + 1 != v34);
        v34 = [obj countByEnumeratingWithState:&v47 objects:v56 count:16];
      }

      while (v34);
    }

    v3 = v31;
  }

  v30 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_3(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCACA8];
  v4 = a2;
  v5 = [v4 name];
  v6 = [v4 uuid];
  v8 = [v3 stringWithFormat:@"%@/%@", v5, v6];

  v7 = [v4 dumpActionSetDescriptionWithPrivacyLevel:*(a1 + 40)];

  [*(a1 + 32) setObject:v7 forKeyedSubscript:v8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_4(uint64_t a1, void *a2)
{
  v2 = *(a1 + 32);
  v3 = [a2 dumpCharacteristicNotificationRegistry];
  [v2 appendString:v3];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_5(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCACA8];
  v4 = a2;
  v5 = [v4 name];
  v6 = [v4 uuid];
  v8 = [v3 stringWithFormat:@"%@/%@", v5, v6];

  v7 = [v4 dumpMediaSessionDescriptionWithPrivacyLevel:*(a1 + 40)];

  [*(a1 + 32) setObject:v7 forKeyedSubscript:v8];
}

void __59__HMDHomeManager__getRequestedState_activity_privacyLevel___block_invoke_6(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v3 = [a2 accessories];
  v4 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v11;
    do
    {
      v7 = 0;
      do
      {
        if (*v11 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = [*(*(&v10 + 1) + 8 * v7) dumpNetworkState];
        if (v8)
        {
          [*(a1 + 32) addObject:v8];
        }

        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v5);
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_handleQueryVersionInformation:(id)a3
{
  v19[1] = *MEMORY[0x277D85DE8];
  v3 = MEMORY[0x277CCAB68];
  v4 = a3;
  v5 = [v3 string];
  v6 = [MEMORY[0x277CCA8D8] mainBundle];
  v7 = [v6 infoDictionary];
  v8 = [v7 objectForKey:*MEMORY[0x277CBED58]];
  [v5 appendFormat:@"homed: %@\n", v8];

  v9 = +[HMDHAPMetadata getSharedInstance];
  v10 = +[HMDHAPMetadata getBuiltinInstance];
  v11 = [v9 schemaVersion];
  v12 = [v9 version];
  v13 = [v10 schemaVersion];
  v14 = [v10 version];
  [v5 appendFormat:@"Metadata - Current: %@/%@   Builtin: %@/%@\n", v11, v12, v13, v14];

  v18 = @"kHomeKitVersionStringKey";
  v19[0] = v5;
  v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v19 forKeys:&v18 count:1];
  v16 = [v4 responseHandler];

  (v16)[2](v16, 0, v15);
  v17 = *MEMORY[0x277D85DE8];
}

- (void)_handleContactStoreChanged
{
  v34 = *MEMORY[0x277D85DE8];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v3 = [(HMDHomeManager *)self incomingInvitations];
  v4 = [v3 copy];

  v5 = [v4 countByEnumeratingWithState:&v24 objects:v33 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = 0;
    v8 = *v25;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v25 != v8)
        {
          objc_enumerationMutation(v4);
        }

        v7 |= [*(*(&v24 + 1) + 8 * i) refreshDisplayName];
      }

      v6 = [v4 countByEnumeratingWithState:&v24 objects:v33 count:16];
    }

    while (v6);
  }

  else
  {
    LOBYTE(v7) = 0;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543618;
    v30 = v13;
    v31 = 1024;
    v32 = v7 & 1;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Handling contact store changed with saveToStore: %{BOOL}d", buf, 0x12u);
  }

  objc_autoreleasePoolPop(v10);
  v22 = 0u;
  v23 = 0u;
  v20 = 0u;
  v21 = 0u;
  v14 = [(HMDHomeManager *)v11 homes];
  v15 = [v14 countByEnumeratingWithState:&v20 objects:v28 count:16];
  if (v15)
  {
    v16 = v15;
    v17 = *v21;
    do
    {
      for (j = 0; j != v16; ++j)
      {
        if (*v21 != v17)
        {
          objc_enumerationMutation(v14);
        }

        [*(*(&v20 + 1) + 8 * j) refreshUserDisplayNames];
      }

      v16 = [v14 countByEnumeratingWithState:&v20 objects:v28 count:16];
    }

    while (v16);
  }

  if (v7)
  {
    [(HMDHomeManager *)v11 saveWithReason:@"userDisplayNameUpdated" information:0 saveOptions:0];
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)handleContactStoreChanged:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __44__HMDHomeManager_handleContactStoreChanged___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

- (void)processMetadataModel:(id)a3 message:(id)a4
{
  v63 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v7 = [v6 transactionResult];
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = +[HMDBackingStoreTransactionOptions stringForHMDBackingStoreTransactionSource:](HMDBackingStoreTransactionActions, "stringForHMDBackingStoreTransactionSource:", [v7 source]);
    *buf = 138543618;
    v54 = v10;
    v55 = 2112;
    v56 = v11;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Receiving metadata model from %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [v5 metadataVersion];
  v13 = [v12 unsignedIntegerValue];

  v14 = [v5 schemaVersion];
  v15 = [v14 unsignedIntegerValue];

  v16 = +[HMDHAPMetadata getSharedInstance];
  v17 = [v16 version];
  v18 = [v17 unsignedIntegerValue];

  v19 = +[HMDHAPMetadata getSharedInstance];
  v20 = [v19 schemaVersion];
  v21 = [v20 unsignedIntegerValue];

  v22 = objc_autoreleasePoolPush();
  v23 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
  {
    v24 = HMFGetLogIdentifier();
    *buf = 138544386;
    v54 = v24;
    v55 = 2048;
    v56 = v13;
    v57 = 2048;
    v58 = v15;
    v59 = 2048;
    v60 = v18;
    v61 = 2048;
    v62 = v21;
    _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@The new metadata has version %tu, schema version %tu, current version %tu, schema %tu", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v22);
  if (v21 == v15)
  {
    v25 = v7;
    if (v13 <= v18)
    {
      if (v13 >= v18)
      {
        +[HMDHAPMetadata shouldUploadToCloudAfterHomedReady];
        v45 = objc_autoreleasePoolPush();
        v46 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v46, OS_LOG_TYPE_INFO))
        {
          v47 = HMFGetLogIdentifier();
          v48 = +[HMDHAPMetadata shouldUploadToCloudAfterHomedReady];
          v49 = "NO";
          if (v48)
          {
            v49 = "YES";
          }

          *buf = 138543618;
          v54 = v47;
          v55 = 2080;
          v56 = v49;
          _os_log_impl(&dword_2531F8000, v46, OS_LOG_TYPE_INFO, "%{public}@Metadata should be uploaded to cloud after homed is ready: %s", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v45);
        [v7 markChanged];
        goto LABEL_29;
      }

      if ([v7 source] != 2)
      {
LABEL_29:
        +[HMDHAPMetadata resetShouldUploadToCloudAfterHomedReady];
        goto LABEL_30;
      }

      v36 = +[HMDPersistentStore loadPlainMetadataDictionary];
      [(HMDHomeManager *)self handleMetadataDictionary:v36 message:0];
LABEL_18:

      goto LABEL_29;
    }

    v26 = [v5 rawPlist];
    v52 = 0;
    v27 = [HMDHAPMetadata metadataWithDictionary:v26 error:&v52];
    v28 = v52;

    v29 = objc_autoreleasePoolPush();
    v30 = HMFGetOSLogHandle();
    v31 = v30;
    if (!v28 && v27)
    {
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        v33 = [v27 version];
        v34 = [v27 schemaVersion];
        *buf = 138543874;
        v54 = v32;
        v55 = 2112;
        v56 = v33;
        v57 = 2112;
        v58 = v34;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Updating current metadata to the new metadata %@/%@.", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v29);
      v35 = [v5 metadataDictionary];
      [HMDHAPMetadata updateLocalMetadataWithMetadata:v35];

      v36 = +[HMDHAPMetadata getSharedInstance];

      [v7 markSaveToAssistant];
      [v7 markChanged];
      [(HMDHomeManager *)self _pushMetadataChangesToUsers];
      [(HMDHomeManager *)self pushMetadataToAllWatches];
      [(HMDHomeManager *)self _notifyMetadata:v36 limitToSPIClients:0 message:v6 invokeResponseHandler:1];
      [(HMDHomeManager *)self _notifyMetadata:v36 limitToSPIClients:1 message:v6 invokeResponseHandler:0];
      goto LABEL_18;
    }

    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      v40 = HMFGetLogIdentifier();
      v41 = [v5 rawPlist];
      *buf = 138543618;
      v54 = v40;
      v55 = 2112;
      v56 = v41;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_ERROR, "%{public}@Failed to init metadata with dictionary %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v29);
    v42 = [v6 responseHandler];

    if (v42)
    {
      v43 = [v6 responseHandler];
      v44 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      (v43)[2](v43, v44, 0);
    }
  }

  else
  {
    v37 = objc_autoreleasePoolPush();
    v38 = HMFGetOSLogHandle();
    v25 = v7;
    if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
    {
      v39 = HMFGetLogIdentifier();
      *buf = 138543362;
      v54 = v39;
      _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_ERROR, "%{public}@Schema is compatible, not processing this metadata.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v37);
  }

LABEL_30:

  v50 = *MEMORY[0x277D85DE8];
}

uint64_t __82__HMDHomeManager__notifyMetadata_limitToSPIClients_message_invokeResponseHandler___block_invoke(uint64_t result)
{
  if (*(result + 40) == 1)
  {
    return [*(result + 32) respondWithPayload:0];
  }

  return result;
}

- (void)handleMetadataDictionary:(id)a3 message:(id)a4
{
  v23 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [HMDHAPMetadataModel modelWithDictionary:v6];
  if (v8)
  {
    v9 = [(HMDHomeManager *)self backingStore];
    v10 = +[HMDBackingStoreTransactionOptions defaultMetadataCloudOptions];
    v11 = [v9 transaction:@"MetadataUpdate" options:v10];

    [v11 add:v8 withMessage:v7];
    [v11 run];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v14;
      v21 = 2112;
      v22 = v6;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to generate metadata model object from dictionary %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v15 = [v7 responseHandler];

    if (v15)
    {
      v16 = [v7 responseHandler];
      v17 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      (v16)[2](v16, v17, 0);
    }
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)evaluateToPushMetadataWhenHomeKitInUse
{
  v15[1] = *MEMORY[0x277D85DE8];
  objc_initWeak(&location, self);
  v3 = [HMDBackingStoreCacheFetchModelObjects alloc];
  v4 = +[HMDHAPMetadataModel metadataModelObjectUUID];
  v15[0] = v4;
  v5 = [MEMORY[0x277CBEA60] arrayWithObjects:v15 count:1];
  v9 = MEMORY[0x277D85DD0];
  v10 = 3221225472;
  v11 = __56__HMDHomeManager_evaluateToPushMetadataWhenHomeKitInUse__block_invoke;
  v12 = &unk_279732580;
  objc_copyWeak(&v13, &location);
  v6 = [(HMDBackingStoreCacheFetchModelObjects *)v3 initWithUUIDs:v5 fetchResult:&v9];

  v7 = [(HMDHomeManager *)self backingStore:v9];
  [v7 submit:v6];

  objc_destroyWeak(&v13);
  objc_destroyWeak(&location);
  v8 = *MEMORY[0x277D85DE8];
}

uint64_t __56__HMDHomeManager_evaluateToPushMetadataWhenHomeKitInUse__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v36 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (!v6)
  {
    v8 = [v5 firstObject];
    v9 = [v8 object];

    v10 = [v9 metadataVersion];
    v11 = [v10 unsignedIntegerValue];

    v12 = [v9 schemaVersion];
    v25 = [v12 unsignedIntegerValue];

    v13 = +[HMDHAPMetadata getSharedInstance];
    v14 = [v13 version];
    v15 = [v14 unsignedIntegerValue];

    v16 = +[HMDHAPMetadata getSharedInstance];
    v17 = [v16 schemaVersion];
    v18 = [v17 unsignedIntegerValue];

    v19 = objc_autoreleasePoolPush();
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138544386;
      v27 = v21;
      v28 = 2048;
      v29 = v11;
      v30 = 2048;
      v31 = v25;
      v32 = 2048;
      v33 = v15;
      v34 = 2048;
      v35 = v18;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@The metadata in transaction store has version %tu, schema version %tu, current version %tu, schema %tu", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v19);
    if (v18 == 1 && v15 > v11)
    {
      v22 = +[HMDPersistentStore loadPlainMetadataDictionary];
      [WeakRetained handleMetadataDictionary:v22 message:0];
    }
  }

  v23 = *MEMORY[0x277D85DE8];
  return 0;
}

- (void)_handleHomeManagerSyncWalletKeysPassSerialNumbersMessage:(id)a3
{
  v33 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v5);

  v6 = [MEMORY[0x277D0F7B8] internalOnlyInitializer];
  v7 = objc_autoreleasePoolPush();
  v8 = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = [v6 UUID];
    *buf = 138543874;
    v26 = v10;
    v27 = 2112;
    v28 = v11;
    v29 = 2112;
    v30 = v4;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@[NewFlow: %@ {Feature:Home Key}] Handling message to sync wallet keys pass serial numbers: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  v12 = [(__CFString *)v4 arrayForKey:@"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers"];
  v13 = [v12 na_map:&__block_literal_global_1386];

  if (v13)
  {
    v14 = [MEMORY[0x277CBEB98] setWithArray:v13];
    [(HMDHomeManager *)v8 removeHomeWalletKeysExcludingSerialNumbers:v14 flow:v6];
    v23 = @"kDataSyncResponseAckKey";
    v24 = MEMORY[0x277CBEC38];
    v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v24 forKeys:&v23 count:1];
    [(__CFString *)v4 respondWithPayload:v15];
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = v8;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
    {
      v19 = HMFGetLogIdentifier();
      v20 = [v6 UUID];
      v21 = [(__CFString *)v4 messagePayload];
      *buf = 138544130;
      v26 = v19;
      v27 = 2112;
      v28 = v20;
      v29 = 2112;
      v30 = @"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers";
      v31 = 2112;
      v32 = v21;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@[Flow: %@] Payload of message to sync wallet keys pass serial numbers is missing key %@: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v16);
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [(__CFString *)v4 respondWithError:v14];
  }

  v22 = *MEMORY[0x277D85DE8];
}

void *__75__HMDHomeManager__handleHomeManagerSyncWalletKeysPassSerialNumbersMessage___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  return v3;
}

- (void)_handleMetadataSync:(id)a3
{
  v38 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ([v4 remoteRestriction] == 4)
  {
    v5 = [v4 dataForKey:@"kHAPMetadataDataKey"];
    v6 = [v5 hmd_uncompressedData];

    v7 = MEMORY[0x277CCAAC8];
    v8 = +[HMDHAPMetadataModel allowedTypes];
    v29 = 0;
    v9 = [v7 unarchivedObjectOfClasses:v8 fromData:v6 error:&v29];
    v10 = v29;

    if (v6 && v9)
    {
      [(HMDHomeManager *)self handleMetadataDictionary:v9 message:0];
      v11 = [v4 responseHandler];

      if (!v11)
      {
LABEL_19:

        goto LABEL_20;
      }

      v12 = [v4 responseHandler];
      v30 = @"kDataSyncResponseAckKey";
      v31 = MEMORY[0x277CBEC38];
      v13 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v31 forKeys:&v30 count:1];
      v12[2](v12, 0, v13);
    }

    else
    {
      v19 = objc_autoreleasePoolPush();
      v20 = self;
      v21 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
      {
        v22 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v22;
        _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to receive metadata update", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v19);
      if (v6)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = v20;
        v25 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
        {
          v26 = HMFGetLogIdentifier();
          *buf = 138543618;
          v35 = v26;
          v36 = 2112;
          v37 = v10;
          _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive hap metadata model from metadata data: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v23);
      }

      v27 = [v4 responseHandler];

      if (!v27)
      {
        goto LABEL_19;
      }

      v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      v13 = [v4 responseHandler];
      v13[2](v13, v12, 0);
    }

    goto LABEL_19;
  }

  v14 = objc_autoreleasePoolPush();
  v15 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    *buf = 138543618;
    v35 = v17;
    v36 = 2112;
    v37 = v4;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Dropping metadata sync: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  v18 = [v4 responseHandler];

  if (v18)
  {
    v6 = [v4 responseHandler];
    v32 = @"kDataSyncResponseAckKey";
    v33 = MEMORY[0x277CBEC38];
    v10 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v33 forKeys:&v32 count:1];
    (v6)[2](v6, 0, v10);
LABEL_20:
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_handleSetMetadata:(id)a3
{
  v4 = a3;
  v5 = [v4 stringForKey:@"kMetadataPlistPathKey"];
  v10 = v5;
  if (v5)
  {
    v6 = MEMORY[0x277CBEBC0];
    v7 = [@"file://" stringByAppendingString:v5];
    v8 = [v6 URLWithString:v7];

    v9 = [MEMORY[0x277CBEAC0] dictionaryWithContentsOfURL:v8];
    [(HMDHomeManager *)self handleMetadataDictionary:v9 message:v4];

    v4 = v8;
  }

  else
  {
    +[HMDHAPMetadata updateLocalMetadataWithBuiltinMetadata];
    [v4 respondWithPayload:0];
  }
}

- (void)_handleQueryMetadata:(id)a3
{
  v17[1] = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = [v3 stringForKey:@"kMetadataPlistPathKey"];
  if (!v4)
  {
    v8 = [v3 numberForKey:@"kMetadataDictionaryTypeKey"];
    v9 = [v8 unsignedIntegerValue];
    if (v9 == 1)
    {
      v10 = +[HMDHAPMetadata getSharedInstance];
    }

    else
    {
      if (v9)
      {
        v5 = 0;
        goto LABEL_10;
      }

      v10 = +[HMDHAPMetadata getBuiltinInstance];
    }

    v5 = v10;
LABEL_10:

    goto LABEL_11;
  }

  v15 = 0;
  v5 = [HMDHAPMetadata metadataWithPath:v4 error:&v15];
  v6 = v15;
  if (v6)
  {
    v7 = v6;
    [v3 respondWithError:v6];
    goto LABEL_15;
  }

LABEL_11:
  v11 = [v5 rawPlist];
  v12 = v11;
  if (v11)
  {
    v16 = @"kMetadataDictionaryKey";
    v17[0] = v11;
    v13 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v17 forKeys:&v16 count:1];
    [v3 respondWithPayload:v13];

    v7 = 0;
  }

  else
  {
    v7 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:1001 userInfo:0];
    [v3 respondWithError:v7];
  }

LABEL_15:
  v14 = *MEMORY[0x277D85DE8];
}

- (void)idsServerBagDidUpdate:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v12 = 138543362;
    v13 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@idsServerBagDidUpdate delegate called", &v12, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)v6 updateCurrentUserEligibleForOwnerToAutoMigration];
  [(HMDHomeManager *)v6 _checkHH1EOLStatusAndRelaunchIfNeeded];
  [(HMDHomeManager *)v6 checkAndProcessHH2UpgradeRecommendation];
  v9 = [(HMDHomeManager *)v6 uuid];
  [(HMDHomeManager *)v6 updateGenerationCounterWithReason:@"IDS server bag updated" sourceUUID:v9 shouldNotifyClients:1];

  v10 = [v4 useDeferredResolutionStrategy];
  [MEMORY[0x277CFEA40] setUseDeferredResolutionStrategy:v10];

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_eraseLocalHomeData
{
  v16 = *MEMORY[0x277D85DE8];
  [(HMDHomeManager *)self _eraseLocalHomeConfiguration];
  v3 = +[HMDBackingStore resetBackingStore];
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = self;
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      *buf = 138543618;
      v13 = v7;
      v14 = 2112;
      v15 = v3;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_ERROR, "%{public}@resetBackingStore completed with error: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
  }

  objc_initWeak(buf, self);
  v8 = [(HMDHomeManager *)self cloudDataSyncManager];
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __37__HMDHomeManager__eraseLocalHomeData__block_invoke;
  v10[3] = &unk_279734708;
  objc_copyWeak(&v11, buf);
  [v8 resetCloudCache:v10];

  objc_destroyWeak(&v11);
  objc_destroyWeak(buf);

  v9 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__eraseLocalHomeData__block_invoke(uint64_t a1, uint64_t a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v3 = [WeakRetained syncManager];
  [v3 cancelOperations];

  v4 = [WeakRetained syncManager];
  [v4 resume];

  if (!a2)
  {
    [WeakRetained updateAccountAvailabilityChanged:0];
  }
}

- (void)eraseLocalHomeData
{
  v3 = [(HMDHomeManager *)self syncManager];
  [v3 pause];

  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __36__HMDHomeManager_eraseLocalHomeData__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

- (void)_handleAccountAvailabilityChanged:(id)a3
{
  v57 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self activeAccountIdentifier];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v54 = v8;
    v55 = 2112;
    v56 = v5;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Received CKAccountChangedNotification and current identifier is %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  if (v5)
  {
    v9 = [MEMORY[0x277CFEC78] systemStore];
    v51 = 0;
    v52 = 0;
    v50 = 0;
    v10 = [v9 getCurrentiCloudIdentifier:&v52 controllerPairingIdentifier:&v51 error:&v50];
    v11 = v52;
    v12 = v51;
    v37 = v50;
    if (v10 && [v11 length] && objc_msgSend(v12, "length"))
    {
      if ([v11 length] && (objc_msgSend(v11, "isEqualToIgnoringCase:", v5) & 1) == 0)
      {
        objc_initWeak(&location, self);
        v23 = [v11 isEqualToString:@"__HomeKit_NoAccount_Identifier__"];
        v24 = objc_autoreleasePoolPush();
        if (v23)
        {
          v25 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
          {
            v26 = HMFGetLogIdentifier();
            *buf = 138543362;
            v54 = v26;
            _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@Current controller is the sentinel controller, determining what to do with local data", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v24);
          [(HMDHomeManager *)self setAccountActive:1];
          v27 = [(HMDHomeManager *)self cloudDataSyncManager];
          v28 = [(HMDHomeManager *)self accountActive];
          v42[0] = MEMORY[0x277D85DD0];
          v42[1] = 3221225472;
          v42[2] = __52__HMDHomeManager__handleAccountAvailabilityChanged___block_invoke;
          v42[3] = &unk_2797329B0;
          v47 = v4;
          objc_copyWeak(&v48, &location);
          v43 = v9;
          v44 = v12;
          v45 = self;
          v46 = v5;
          [v27 updateAccountStatusChanged:v28 completionHandler:v42];

          objc_destroyWeak(&v48);
        }

        else
        {
          v29 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
          {
            v30 = HMFGetLogIdentifier();
            *buf = 138543618;
            v54 = v30;
            v55 = 2112;
            v56 = v5;
            _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_INFO, "%{public}@Removing controller key for previous identifier %@ and deleting local home data", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v24);
          v41 = v37;
          [v9 removeControllerKeyPairForIdentifier:v12 leaveTombstone:0 error:&v41];
          v31 = v41;

          [(HMDHomeManager *)self _eraseLocalHomeConfiguration];
          v37 = +[HMDBackingStore resetBackingStore];

          if (v37)
          {
            context = objc_autoreleasePoolPush();
            v32 = self;
            v33 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
            {
              v34 = HMFGetLogIdentifier();
              *buf = 138543618;
              v54 = v34;
              v55 = 2112;
              v56 = v37;
              _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_ERROR, "%{public}@resetBackingStore completed with error: %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(context);
          }

          objc_initWeak(buf, self);
          v35 = [(HMDHomeManager *)self cloudDataSyncManager];
          v38[0] = MEMORY[0x277D85DD0];
          v38[1] = 3221225472;
          v38[2] = __52__HMDHomeManager__handleAccountAvailabilityChanged___block_invoke_1374;
          v38[3] = &unk_279734508;
          objc_copyWeak(&v40, buf);
          v39 = v4;
          [v35 resetCloudCache:v38];

          objc_destroyWeak(&v40);
          objc_destroyWeak(buf);
        }

        objc_destroyWeak(&location);
      }

      else
      {
        v13 = objc_autoreleasePoolPush();
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          *buf = 138543362;
          v54 = v15;
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@User has re-signed into previously signed account, determining account status from CK", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v13);
        [(HMDHomeManager *)self _updateCloudDataSyncWithAccountState:1 completion:v4];
      }
    }

    else
    {
      [(HMDHomeManager *)self _updateCloudDataSyncWithAccountState:1 completion:v4];
      v16 = objc_autoreleasePoolPush();
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543362;
        v54 = v18;
        _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@We don't have any controller keys for current iCloud account.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
    }
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v54 = v21;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Dropping CKAccountChangedNotification since the current identifier is invalid", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v19);
    if (v4)
    {
      v4[2](v4);
    }
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (id)activeAccountIdentifier
{
  if (a1)
  {
    v1 = [a1 appleAccountManager];
    v2 = [v1 accountContext];
    v3 = [v2 identifier];
  }

  else
  {
    v3 = 0;
  }

  return v3;
}

void __52__HMDHomeManager__handleAccountAvailabilityChanged___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3, void *a4)
{
  v38 = *MEMORY[0x277D85DE8];
  v7 = a4;
  if (!v7 || (a2 & 1) != 0)
  {
    WeakRetained = objc_loadWeakRetained((a1 + 72));
    if (WeakRetained)
    {
      if (v7 || a2)
      {
        v23 = objc_autoreleasePoolPush();
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
        {
          v25 = HMFGetLogIdentifier();
          v26 = "don't ";
          *buf = 138543874;
          v33 = v25;
          if (a2)
          {
            v26 = "";
          }

          v34 = 2112;
          v35 = v7;
          v36 = 2080;
          v37 = v26;
          _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Received account update with error: %@, and we %shave a record in the cloud, erasing local data", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v23);
        v27 = *(a1 + 32);
        v28 = *(a1 + 40);
        v31 = v7;
        [v27 removeControllerKeyPairForIdentifier:v28 leaveTombstone:1 error:&v31];
        v22 = v31;

        [*(a1 + 48) _eraseLocalHomeConfiguration];
      }

      else
      {
        v15 = *(a1 + 56);
        v16 = *(a1 + 32);
        v17 = *(a1 + 40);
        v30 = 0;
        [v16 updateCurrentiCloudIdentifier:v15 controllerPairingIdentifier:v17 error:&v30];
        v18 = v30;
        v19 = objc_autoreleasePoolPush();
        v20 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
        {
          v21 = HMFGetLogIdentifier();
          *buf = 138543362;
          v33 = v21;
          _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Received account update that we don't have anything in the cloud, going to push local data", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        v22 = 0;
      }

      [WeakRetained _handleAccountStatusDeterminedWithError:v22 homeDataRecordExists:a2 metadataRecordExists:a3 completion:*(a1 + 64)];
      v7 = v22;
    }
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [v7 hmd_conciseCKError];
      v12 = [v11 shortDescription];
      *buf = 138543618;
      v33 = v10;
      v34 = 2112;
      v35 = v12;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Failed to determine account status from CK due to error: %@, continuing to use sentinel controller", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    v13 = *(a1 + 64);
    if (v13)
    {
      (*(v13 + 16))();
    }
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __52__HMDHomeManager__handleAccountAvailabilityChanged___block_invoke_1374(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _updateCloudDataSyncWithAccountState:1 completion:*(a1 + 32)];
    WeakRetained = v3;
  }
}

- (void)updateAccountAvailabilityChanged:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self cloudAccount];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __51__HMDHomeManager_updateAccountAvailabilityChanged___block_invoke;
  v7[3] = &unk_279732988;
  objc_copyWeak(&v9, &location);
  v6 = v4;
  v8 = v6;
  [v5 addAccountOperation:v7];

  objc_destroyWeak(&v9);
  objc_destroyWeak(&location);
}

void __51__HMDHomeManager_updateAccountAvailabilityChanged___block_invoke(uint64_t a1, void *a2)
{
  v8 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v4 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained _handleAccountAvailabilityChanged:v8];
    v5 = *(a1 + 32);
    if (v5)
    {
      (*(v5 + 16))(v5, 0);
    }
  }

  else
  {
    if (v8)
    {
      v8[2](v8);
    }

    v6 = *(a1 + 32);
    if (v6)
    {
      v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
      (*(v6 + 16))(v6, v7);
    }
  }
}

- (void)_handleRemoteSessionTornDownNotification:(id)a3
{
  v31 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 userInfo];
  v6 = [v5 hmf_UUIDForKey:*MEMORY[0x277CD0640]];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self _homeWithUUID:v6];
    v8 = [v7 residentDeviceManager];
    v9 = [v8 isResidentAvailable];

    if ((v9 & 1) == 0)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v12 = HMFGetLogIdentifier();
        v25 = 138543618;
        v26 = v12;
        v27 = 2112;
        v28 = v7;
        _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Receive notification that remote access was torn down for home %@", &v25, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      if (v7)
      {
        v13 = objc_autoreleasePoolPush();
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          v16 = [v7 name];
          v17 = [v7 uuid];
          v18 = [v17 UUIDString];
          v25 = 138543874;
          v26 = v15;
          v27 = 2112;
          v28 = v16;
          v29 = 2112;
          v30 = v18;
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Re-electing new resident device for home: %@ (%@)", &v25, 0x20u);
        }

        objc_autoreleasePoolPop(v13);
        v19 = [v7 uuid];
        [(HMDHomeManager *)self _teardownRemoteAccessForHome:v19];

        v20 = [v7 uuid];
        [(HMDHomeManager *)self _electRemoteAccessPeerForHome:v20];
      }
    }
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      v23 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v23;
      _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Receive notification that remote access was torn down for an unknown home, re-checking if we need to spin up remote access for any of our homes", &v25, 0xCu);
    }

    objc_autoreleasePoolPop(v21);
    [(HMDHomeManager *)self _checkForRemotePeers];
  }

  v24 = *MEMORY[0x277D85DE8];
}

- (void)_electCompanionForRemoteAccess:(id)a3
{
  v22 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self _homeWithUUID:v4];
  if (v5)
  {
    v6 = [(HMDHomeManager *)self associatedRemotePeers];
    v7 = [v6 objectForKeyedSubscript:v4];

    if ([v7 count])
    {
      v8 = [v7 anyObject];
      v9 = [HMDDevice deviceWithDestination:v8];
      v10 = [(HMDHomeManager *)self messageDispatcher];
      [v10 setCompanionDevice:v9 forHome:v5];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        v18 = 138543618;
        v19 = v16;
        v20 = 2112;
        v21 = v4;
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@There are no remote peers for this home: %@", &v18, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      [(HMDHomeManager *)self _teardownRemoteAccessForHomeThroughCompanion:v4];
    }
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v18 = 138543618;
      v19 = v13;
      v20 = 2112;
      v21 = v4;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Home with UUID not found: %@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_electRemoteAccessDeviceForHome:(id)a3 retryCount:(unint64_t)a4
{
  v103 = *MEMORY[0x277D85DE8];
  v49 = a3;
  v4 = [(HMDHomeManager *)self _homeWithUUID:?];
  v59 = v4;
  if (v4)
  {
    if ([v4 isResidentSupported])
    {
      v5 = objc_autoreleasePoolPush();
      v6 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v7 = HMFGetLogIdentifier();
        *buf = 138543618;
        *&buf[4] = v7;
        *&buf[12] = 2112;
        *&buf[14] = v49;
        _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Skipping electing remote access for home, %@, with a resident device", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v5);
    }

    else
    {
      v8 = [(HMDHomeManager *)self associatedRemotePeers];
      v48 = [v8 objectForKeyedSubscript:v49];

      if ([v48 count])
      {
        v9 = [(HMDHomeManager *)self pendingRemoteSessions];
        v47 = [v9 allValues];

        if ([v47 containsObject:v49])
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v12 = HMFGetLogIdentifier();
            v13 = [v49 UUIDString];
            *buf = 138543618;
            *&buf[4] = v12;
            *&buf[12] = 2112;
            *&buf[14] = v13;
            _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@We have a pending election for home: %@, dropping this request", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v10);
        }

        else
        {
          v14 = [(HMDHomeManager *)self identifiersOfAccessoriesForHome:v59];
          v51 = [v14 allObjects];

          v55 = [MEMORY[0x277CCAD78] UUID];
          v15 = [(HMDHomeManager *)self pendingRemoteSessions];
          [v15 setObject:v49 forKeyedSubscript:v55];

          v16 = objc_autoreleasePoolPush();
          v17 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
          {
            v18 = HMFGetLogIdentifier();
            v19 = [v55 UUIDString];
            *buf = 138544130;
            *&buf[4] = v18;
            *&buf[12] = 2112;
            *&buf[14] = v59;
            *&buf[22] = 2112;
            v101 = v19;
            LOWORD(v102) = 2048;
            *(&v102 + 2) = [v48 count];
            _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Spinning up remote access for home, %@, for session %@, pinging total of %lu peers", buf, 0x2Au);
          }

          objc_autoreleasePoolPop(v16);
          v86[0] = 0;
          v86[1] = v86;
          v86[2] = 0x2020000000;
          v87 = 0;
          *buf = 0;
          *&buf[8] = buf;
          *&buf[16] = 0x3032000000;
          v101 = __Block_byref_object_copy__172847;
          *&v102 = __Block_byref_object_dispose__172848;
          *(&v102 + 1) = 0;
          v84[0] = 0;
          v84[1] = v84;
          v84[2] = 0x3032000000;
          v84[3] = __Block_byref_object_copy__172847;
          v84[4] = __Block_byref_object_dispose__172848;
          v85 = 0;
          group = dispatch_group_create();
          v80 = 0u;
          v81 = 0u;
          v82 = 0u;
          v83 = 0u;
          obj = v48;
          v20 = [obj countByEnumeratingWithState:&v80 objects:v99 count:16];
          if (v20)
          {
            v53 = 0;
            v58 = *v81;
            v50 = *MEMORY[0x277CD0640];
            do
            {
              for (i = 0; i != v20; ++i)
              {
                if (*v81 != v58)
                {
                  objc_enumerationMutation(obj);
                }

                v22 = *(*(&v80 + 1) + 8 * i);
                v23 = [v59 users];
                v24 = [v23 hmf_firstObjectWithValue:v22 forKeyPath:@"userID"];

                objc_opt_class();
                if (objc_opt_isKindOfClass())
                {
                  v25 = v24;
                  if ([v25 configurationState] == 2)
                  {
                    v92 = @"kRequestedCapabilitiesKey";
                    v90 = @"kHomedVersionKey";
                    v26 = homedVersion;
                    v91 = v26;
                    v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v91 forKeys:&v90 count:1];
                    v93 = v27;
                    v28 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v93 forKeys:&v92 count:1];

                    v88[0] = v50;
                    v29 = [v59 uuid];
                    v30 = [v29 UUIDString];
                    v89[0] = v30;
                    v89[1] = v51;
                    v88[1] = @"kAccessoryIdentitiesKey";
                    v88[2] = @"kRemoteSessionIdentifierKey";
                    v31 = [v55 UUIDString];
                    v89[2] = v31;
                    v32 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v89 forKeys:v88 count:3];

                    v33 = [MEMORY[0x277D0F818] internalMessageWithName:@"kAreYouAtHomeRequestKey" messagePayload:v32];
                    dispatch_group_enter(group);
                    objc_initWeak(location, self);
                    v34 = [(HMDHomeManager *)self workQueue];
                    v70[0] = MEMORY[0x277D85DD0];
                    v70[1] = 3221225472;
                    v70[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke;
                    v70[3] = &unk_279732938;
                    v70[4] = self;
                    v35 = v33;
                    v71 = v35;
                    v72 = v22;
                    objc_copyWeak(v79, location);
                    v73 = v59;
                    v76 = buf;
                    v77 = v84;
                    v36 = v55;
                    v79[1] = a4;
                    v74 = v36;
                    v78 = v86;
                    v75 = group;
                    [(HMDHomeManager *)self electDeviceForUser:v22 destination:v22 deviceCapabilities:v28 queue:v34 completionHandler:v70];

                    objc_destroyWeak(v79);
                    objc_destroyWeak(location);
                  }

                  else
                  {
                    v40 = objc_autoreleasePoolPush();
                    v41 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
                    {
                      v42 = HMFGetLogIdentifier();
                      v43 = [v25 displayName];
                      *location = 138543618;
                      *&location[4] = v42;
                      v95 = 2112;
                      v96 = v43;
                      _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_INFO, "%{public}@Skipping resident %@ since it is disabled", location, 0x16u);
                    }

                    objc_autoreleasePoolPop(v40);
                    ++v53;
                  }
                }

                else
                {
                  v37 = objc_autoreleasePoolPush();
                  v38 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
                  {
                    v39 = HMFGetLogIdentifier();
                    *location = 138543874;
                    *&location[4] = v39;
                    v95 = 2112;
                    v96 = v24;
                    v97 = 2112;
                    v98 = v22;
                    _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_ERROR, "%{public}@Found user %@ when looking for a resident user if userID %@", location, 0x20u);
                  }

                  objc_autoreleasePoolPop(v37);
                }
              }

              v20 = [obj countByEnumeratingWithState:&v80 objects:v99 count:16];
            }

            while (v20);
          }

          else
          {
            v53 = 0;
          }

          v44 = [(HMDHomeManager *)self workQueue];
          block[0] = MEMORY[0x277D85DD0];
          block[1] = 3221225472;
          block[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_1372;
          block[3] = &unk_279732960;
          v61 = v55;
          v62 = self;
          v69 = v53;
          v63 = obj;
          v64 = v49;
          v66 = buf;
          v65 = v59;
          v67 = v86;
          v68 = a4;
          v45 = v55;
          dispatch_group_notify(group, v44, block);

          _Block_object_dispose(v84, 8);
          _Block_object_dispose(buf, 8);

          _Block_object_dispose(v86, 8);
        }
      }
    }

    v4 = v59;
  }

  v46 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v40 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  if (v7)
  {
    WeakRetained = objc_loadWeakRetained((a1 + 104));
    if (WeakRetained)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543362;
        v39 = v13;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Failed to elect device for remote session", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
    }

    dispatch_group_leave(*(a1 + 72));
  }

  else
  {
    v14 = [*(a1 + 32) messageDispatcher];
    v26 = *(a1 + 40);
    v15 = [*(a1 + 32) uuid];
    v25 = *(a1 + 48);
    v16 = [v8 destination];
    v17 = [*(a1 + 32) workQueue];
    v27[0] = MEMORY[0x277D85DD0];
    v27[1] = 3221225472;
    v27[2] = __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_2;
    v27[3] = &unk_279732910;
    objc_copyWeak(v37, (a1 + 104));
    v18 = v8;
    v19 = *(a1 + 32);
    v28 = v18;
    v29 = v19;
    v20 = *(a1 + 56);
    v21 = *(a1 + 48);
    v30 = v20;
    v31 = v21;
    v32 = v9;
    v35 = *(a1 + 80);
    v22 = *(a1 + 64);
    v37[1] = *(a1 + 112);
    v23 = *(a1 + 96);
    v33 = v22;
    v36 = v23;
    v34 = *(a1 + 72);
    [v14 sendSecureMessage:v26 target:v15 userID:v25 destination:v16 responseQueue:v17 responseHandler:v27];

    objc_destroyWeak(v37);
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_1372(uint64_t a1)
{
  v33 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v5 = [*(a1 + 32) UUIDString];
    v27 = 138543618;
    v28 = v4;
    v29 = 2112;
    v30 = v5;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Remote access election completed for session %@", &v27, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 40) pendingRemoteSessions];
  [v6 removeObjectForKey:*(a1 + 32)];

  v7 = *(a1 + 96);
  if ([*(a1 + 48) count] == v7)
  {
    [*(a1 + 40) _teardownRemoteAccessForHome:*(a1 + 56)];
    goto LABEL_17;
  }

  if (*(*(*(a1 + 72) + 8) + 40))
  {
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 64) uuid];
      v12 = [v11 UUIDString];
      v13 = [*(*(*(a1 + 72) + 8) + 40) userID];
      v27 = 138543874;
      v28 = v10;
      v29 = 2112;
      v30 = v12;
      v31 = 2112;
      v32 = v13;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Setting up remote access for home, %@, with resident %@", &v27, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v14 = [*(*(*(a1 + 72) + 8) + 40) userID];
    v15 = [HMDDevice deviceWithDestination:v14];

    v16 = [*(a1 + 40) messageDispatcher];
    [v16 setRemoteAccessDevice:v15 forHome:*(a1 + 64)];

LABEL_16:
    goto LABEL_17;
  }

  v17 = *(*(*(a1 + 80) + 8) + 24);
  v18 = objc_autoreleasePoolPush();
  v19 = HMFGetOSLogHandle();
  v20 = os_log_type_enabled(v19, OS_LOG_TYPE_INFO);
  if (v17 != 1)
  {
    if (v20)
    {
      v24 = HMFGetLogIdentifier();
      v25 = [*(a1 + 64) uuid];
      v27 = 138543618;
      v28 = v24;
      v29 = 2112;
      v30 = v25;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Not setting up remote access for home, %@, as no available residents were found", &v27, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v15 = [*(a1 + 40) messageDispatcher];
    [v15 setRemoteAccessDevice:0 forHome:*(a1 + 64)];
    goto LABEL_16;
  }

  if (v20)
  {
    v21 = HMFGetLogIdentifier();
    v22 = [*(a1 + 56) UUIDString];
    v23 = *(a1 + 88) + 1;
    v27 = 138543874;
    v28 = v21;
    v29 = 2112;
    v30 = v22;
    v31 = 2048;
    v32 = v23;
    _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Failed to setup remote session for home with UUID %@, retry attempt %ld", &v27, 0x20u);
  }

  objc_autoreleasePoolPop(v18);
  [*(a1 + 40) _electRemoteAccessPeerForHome:*(a1 + 56) retryCount:*(a1 + 88) + 1];
LABEL_17:
  v26 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__electRemoteAccessDeviceForHome_retryCount___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v65 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 112));
  if (WeakRetained)
  {
    if (!v5 && v6)
    {
      v8 = [v6 hmf_BOOLForKey:@"kAtHomeStateKey"];
      v9 = [v6 hmf_UUIDForKey:@"kRemoteSessionIdentifierKey"];
      v10 = v9;
      if (!v8 || !v9)
      {
        v36 = objc_autoreleasePoolPush();
        v37 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
        {
          v38 = HMFGetLogIdentifier();
          v39 = *(a1 + 72);
          *buf = 138543618;
          v56 = v38;
          v57 = 2112;
          v58 = v39;
          _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is not at home", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v36);
        goto LABEL_44;
      }

      v11 = [*(a1 + 32) destination];
      v12 = [WeakRetained pendingRemoteSessions];
      v13 = [v12 objectForKeyedSubscript:v10];

      if (!v13)
      {
        v40 = objc_autoreleasePoolPush();
        v41 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v43 = v42 = v11;
          *buf = 138543618;
          v56 = v43;
          v57 = 2112;
          v58 = v42;
          _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is at home, dropping setting up remote access since we tore the session down", buf, 0x16u);

          v11 = v42;
        }

        objc_autoreleasePoolPop(v40);
        goto LABEL_43;
      }

      v14 = *(a1 + 40);
      v15 = [*(a1 + 48) uuid];
      v16 = [v14 _homeWithUUID:v15];

      v17 = [v16 users];
      v18 = [v17 hmf_firstObjectWithValue:*(a1 + 56) forKeyPath:@"userID"];

      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v19 = v18;
      }

      else
      {
        v19 = 0;
      }

      v20 = v19;

      if (!v20 || [v20 configurationState] != 2)
      {
LABEL_42:

LABEL_43:
LABEL_44:

        goto LABEL_45;
      }

      context = objc_autoreleasePoolPush();
      v21 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
      {
        HMFGetLogIdentifier();
        v49 = v16;
        v23 = v22 = v11;
        *buf = 138543618;
        v56 = v23;
        v57 = 2112;
        v58 = v22;
        _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Received response that %@ is at home", buf, 0x16u);

        v11 = v22;
        v16 = v49;
      }

      objc_autoreleasePoolPop(context);
      v24 = [*(a1 + 64) objectForKeyedSubscript:@"kHomedVersionKey"];
      if (v24)
      {
        v25 = v24;
      }

      else
      {
        v25 = &unk_28662BF48;
      }

      v26 = *(*(a1 + 88) + 8);
      v28 = *(v26 + 40);
      v27 = (v26 + 40);
      if (v28)
      {
        v29 = *(*(*(a1 + 96) + 8) + 40);
        if (!v29 || [v29 compare:v25] != -1)
        {
          contexta = objc_autoreleasePoolPush();
          v30 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
          {
            HMFGetLogIdentifier();
            v31 = v50 = v11;
            *buf = 138543874;
            v56 = v31;
            v57 = 2112;
            v58 = v50;
            v59 = 2112;
            v60 = v25;
            _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Dropping resident %@ (%@) as a resident with a higher homed version was found", buf, 0x20u);

            v11 = v50;
          }

          objc_autoreleasePoolPop(contexta);
          goto LABEL_41;
        }

        v48 = objc_autoreleasePoolPush();
        contextb = HMFGetOSLogHandle();
        if (os_log_type_enabled(contextb, OS_LOG_TYPE_INFO))
        {
          v47 = HMFGetLogIdentifier();
          [*(*(*(a1 + 88) + 8) + 40) userID];
          v44 = v51 = v11;
          v45 = *(*(*(a1 + 96) + 8) + 40);
          *buf = 138544386;
          v56 = v47;
          v57 = 2112;
          v58 = v51;
          v59 = 2112;
          v60 = v25;
          v61 = 2112;
          v62 = v44;
          v63 = 2112;
          v64 = v45;
          _os_log_impl(&dword_2531F8000, contextb, OS_LOG_TYPE_INFO, "%{public}@Preferring %@ (%@) over %@ (%@) due to higher homed version", buf, 0x34u);

          v11 = v51;
        }

        objc_autoreleasePoolPop(v48);
        v27 = (*(*(a1 + 88) + 8) + 40);
      }

      objc_storeStrong(v27, v19);
      objc_storeStrong((*(*(a1 + 96) + 8) + 40), v25);
LABEL_41:

      goto LABEL_42;
    }

    v32 = objc_autoreleasePoolPush();
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v56 = v34;
      _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_INFO, "%{public}@Failed to send secure message to elect device for remote session", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v32);
    if (v5)
    {
      v10 = [v5 domain];
      if (![v10 isEqualToString:*MEMORY[0x277CCA590]] || objc_msgSend(v5, "code") != -6722 && objc_msgSend(v5, "code") != -6752)
      {
        goto LABEL_44;
      }

      v35 = *(a1 + 120);

      if (v35 <= 1)
      {
        *(*(*(a1 + 104) + 8) + 24) = 1;
      }
    }
  }

LABEL_45:
  dispatch_group_leave(*(a1 + 80));

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_electRemoteAccessPeerForHome:(id)a3 retryCount:(unint64_t)a4
{
  v6 = a3;
  if (isWatch())
  {
    [(HMDHomeManager *)self _electCompanionForRemoteAccess:v6];
  }

  else
  {
    [(HMDHomeManager *)self _electRemoteAccessDeviceForHome:v6 retryCount:a4];
  }
}

- (void)electRemoteAccessPeerForHome:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __47__HMDHomeManager_electRemoteAccessPeerForHome___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)_electRemoteGatewayForHomesAfterReachabilityChanges
{
  v35 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v29 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Reachability changed from not reachable to reachable, checking remote access setup for all homes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v26 = 0u;
  v27 = 0u;
  v24 = 0u;
  v25 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v6 = [obj countByEnumeratingWithState:&v24 objects:v34 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v25;
    v22 = self;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v25 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v10 = *(*(&v24 + 1) + 8 * i);
        v11 = objc_autoreleasePoolPush();
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          v14 = [v10 name];
          v15 = [v10 uuid];
          [v15 UUIDString];
          v16 = v7;
          v18 = v17 = v8;
          *buf = 138543874;
          v29 = v13;
          v30 = 2112;
          v31 = v14;
          v32 = 2112;
          v33 = v18;
          _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Triggering election of resident device for remote access for home %@ (%@)", buf, 0x20u);

          v8 = v17;
          v7 = v16;
          self = v22;
        }

        objc_autoreleasePoolPop(v11);
        v19 = [v10 uuid];
        [(HMDHomeManager *)self _teardownRemoteAccessForHome:v19];

        v20 = [v10 uuid];
        [(HMDHomeManager *)self _electRemoteAccessPeerForHome:v20];
      }

      v7 = [obj countByEnumeratingWithState:&v24 objects:v34 count:16];
    }

    while (v7);
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_findRemotePeerContainingAccessories:(id)a3 forHome:(id)a4
{
  v59 = *MEMORY[0x277D85DE8];
  v38 = a3;
  v6 = a4;
  if (!isAppleTV())
  {
    v40 = v6;
    v48 = 0u;
    v49 = 0u;
    v46 = 0u;
    v47 = 0u;
    obj = [(HMDHomeManager *)self unassociatedRemotePeers];
    v7 = [obj countByEnumeratingWithState:&v46 objects:v58 count:16];
    if (v7)
    {
      v41 = *v47;
      v37 = *MEMORY[0x277CD0640];
      *&v8 = 138543874;
      v36 = v8;
      do
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v47 != v41)
          {
            objc_enumerationMutation(obj);
          }

          v10 = *(*(&v46 + 1) + 8 * i);
          v11 = [v10 capabilities];
          v12 = [v11 isResidentCapable];

          if ((v12 & 1) == 0)
          {
            v13 = [(HMDHomeManager *)self pendingResidentSetupSessions];
            v14 = [v10 remoteDestinationString];
            v15 = [v13 containsObject:v14];

            if (v15)
            {
              v16 = objc_autoreleasePoolPush();
              v17 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
              {
                v18 = HMFGetLogIdentifier();
                v19 = [v40 uuid];
                v20 = [v19 UUIDString];
                *buf = v36;
                v53 = v18;
                v54 = 2112;
                v55 = v10;
                v56 = 2112;
                v57 = v20;
                _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@We have a pending request to look for unpaired accessories to device, %@, for home: %@, dropping this request", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v16);
            }

            else
            {
              v21 = [(HMDHomeManager *)self pendingResidentSetupSessions];
              v22 = [v10 remoteDestinationString];
              [v21 addObject:v22];

              v50[0] = @"kAccessoryIdentitiesKey";
              v50[1] = v37;
              v51[0] = v38;
              v23 = [v40 uuid];
              v24 = [v23 UUIDString];
              v51[1] = v24;
              v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v51 forKeys:v50 count:2];

              v26 = [HMDRemoteDeviceMessageDestination alloc];
              v27 = [(HMDHomeManager *)self uuid];
              v28 = [(HMDRemoteDeviceMessageDestination *)v26 initWithTarget:v27 device:v10];

              v29 = objc_autoreleasePoolPush();
              v30 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
              {
                v31 = HMFGetLogIdentifier();
                v32 = [v40 uuid];
                *buf = v36;
                v53 = v31;
                v54 = 2112;
                v55 = v10;
                v56 = 2112;
                v57 = v32;
                _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Requesting remote gateway, %@, to look for accessories in home %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v29);
              v33 = [MEMORY[0x277D0F818] internalMessageWithName:@"kDoYouSeeUnpairedAccessoriesKey" destination:v28 messagePayload:v25];
              objc_initWeak(buf, self);
              v42[0] = MEMORY[0x277D85DD0];
              v42[1] = 3221225472;
              v42[2] = __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke;
              v42[3] = &unk_279735248;
              objc_copyWeak(&v45, buf);
              v43 = v40;
              v44 = v10;
              [v33 setResponseHandler:v42];
              v34 = [(HMDHomeManager *)self messageDispatcher];
              [v34 sendMessage:v33 completionHandler:0];

              objc_destroyWeak(&v45);
              objc_destroyWeak(buf);
            }
          }
        }

        v7 = [obj countByEnumeratingWithState:&v46 objects:v58 count:16];
      }

      while (v7);
    }

    v6 = v40;
  }

  v35 = *MEMORY[0x277D85DE8];
}

void __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v8 = WeakRetained;
  if (WeakRetained)
  {
    v9 = [WeakRetained workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke_2;
    block[3] = &unk_2797352C0;
    v13 = v5;
    v14 = v6;
    v10 = *(a1 + 32);
    v11 = *(a1 + 40);
    v15 = v10;
    v16 = v11;
    v17 = v8;
    dispatch_async(v9, block);
  }
}

void __63__HMDHomeManager__findRemotePeerContainingAccessories_forHome___block_invoke_2(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32) || (v7 = *(a1 + 40)) == 0)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
    {
      v4 = HMFGetLogIdentifier();
      v5 = *(a1 + 56);
      v6 = *(a1 + 32);
      v15 = 138543874;
      v16 = v4;
      v17 = 2112;
      v18 = v5;
      v19 = 2112;
      v20 = v6;
      _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Remote peer, %@, failed to look for accessories with error:%@", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v2);
  }

  else
  {
    v8 = [v7 hmf_BOOLForKey:@"kAtHomeStateKey"];
    v9 = [*(a1 + 40) hmf_stringForKey:@"kDeviceNameKey"];
    v10 = v9;
    if (v8)
    {
      v11 = v9 == 0;
    }

    else
    {
      v11 = 1;
    }

    if (!v11)
    {
      [*(a1 + 48) addUnconfiguredResidentDevice:*(a1 + 56)];
    }
  }

  v12 = [*(a1 + 64) pendingResidentSetupSessions];
  v13 = [*(a1 + 56) remoteDestinationString];
  [v12 removeObject:v13];

  v14 = *MEMORY[0x277D85DE8];
}

- (void)atHomeLevelChanged:(int64_t)a3 formerLevel:(int64_t)a4 home:(id)a5
{
  v6 = [(HMDHomeManager *)self workQueue:a3];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __54__HMDHomeManager_atHomeLevelChanged_formerLevel_home___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v6, block);
}

- (void)_accessoriesAreLocallyReachableOnTransientDevice:(BOOL)a3 forHome:(id)a4
{
  v4 = a3;
  v29 = *MEMORY[0x277D85DE8];
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    if (v4)
    {
      v10 = "";
    }

    else
    {
      v10 = "not ";
    }

    v11 = [v6 UUIDString];
    v12 = [(HMDHomeManager *)self unassociatedRemotePeers];
    v21 = 138544130;
    v22 = v9;
    v23 = 2080;
    v24 = v10;
    v25 = 2112;
    v26 = v11;
    v27 = 2048;
    v28 = [v12 count];
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Accessories are %slocally reachable for home %@, peers %lu", &v21, 0x2Au);
  }

  objc_autoreleasePoolPop(v7);
  if (v4 && !isWatch())
  {
    v13 = [(HMDHomeManager *)self _homeWithUUID:v6];
    [v13 isOwnerUser];
    v14 = [HMDHomeManager isThisDeviceAdminOfHome:v13];
    if (v13)
    {
      v15 = v14;
      v16 = [(HMDHomeManager *)self unassociatedRemotePeers];
      if ([v16 count] == 0 || !v15 || !objc_msgSend(v13, "allowsRemoteAccess"))
      {
LABEL_14:

        goto LABEL_15;
      }

      v17 = [v13 currentUser];
      v18 = [v17 isRemoteAccessAllowed];

      if (v18)
      {
        v19 = [(HMDHomeManager *)self identifiersOfAccessoriesForHome:v13];
        v16 = [v19 allObjects];

        if ([v16 count])
        {
          [(HMDHomeManager *)self _findRemotePeerContainingAccessories:v16 forHome:v13];
        }

        goto LABEL_14;
      }
    }

LABEL_15:
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_removeFromAssociatedPeers:(id)a3 home:(id)a4
{
  v26 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  [(HMDHomeManager *)self _remotePeers];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v8 = v24 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v22;
    while (2)
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v22 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v21 + 1) + 8 * i);
        v14 = [v13 remoteDestinationString];
        v15 = [v14 isEqualToString:v6];

        if (v15)
        {
          v16 = [(HMDHomeManager *)self unassociatedRemotePeers];
          [v16 addObject:v13];

          if (v7)
          {
            v17 = [(HMDHomeManager *)self associatedRemotePeers];
            v18 = [v7 uuid];
            v19 = [v17 objectForKeyedSubscript:v18];

            if (v19)
            {
              [v19 removeObject:v6];
            }
          }

          goto LABEL_14;
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
      if (v10)
      {
        continue;
      }

      break;
    }
  }

LABEL_14:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_removeFromUnassociatedPeers:(id)a3 home:(id)a4
{
  v29 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self _remotePeers];
  v24 = 0u;
  v25 = 0u;
  v26 = 0u;
  v27 = 0u;
  v9 = [v8 countByEnumeratingWithState:&v24 objects:v28 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v25;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v25 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v24 + 1) + 8 * i);
        v14 = [v13 remoteDestinationString];
        v15 = [v14 isEqualToString:v6];

        if (v15)
        {
          v16 = [(HMDHomeManager *)self unassociatedRemotePeers];
          [v16 removeObject:v13];

          v17 = [v13 remoteDestinationString];
          [v7 removeUnconfiguredResidentDeviceWithUserID:v17];

          if (v7)
          {
            v18 = [(HMDHomeManager *)self associatedRemotePeers];
            v19 = [v7 uuid];
            v20 = [v18 objectForKeyedSubscript:v19];

            if (!v20)
            {
              v20 = [MEMORY[0x277CBEB58] set];
              v21 = [(HMDHomeManager *)self associatedRemotePeers];
              v22 = [v7 uuid];
              [v21 setObject:v20 forKeyedSubscript:v22];
            }

            [v20 addObject:v6];
          }
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v24 objects:v28 count:16];
    }

    while (v10);
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)removeFromUnassociatedPeers:(id)a3 home:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_removeFromUnassociatedPeers_home___block_invoke;
  block[3] = &unk_279734960;
  block[4] = self;
  v12 = v6;
  v13 = v7;
  v9 = v7;
  v10 = v6;
  dispatch_async(v8, block);
}

- (void)_checkForRemotePeersAndRegisterForRemoteNotifications:(BOOL)a3
{
  v158 = a3;
  v3 = self;
  v225 = *MEMORY[0x277D85DE8];
  v4 = [(HMDHomeManager *)self unassociatedRemotePeers];
  [v4 removeAllObjects];

  v5 = [(HMDHomeManager *)v3 associatedRemotePeers];
  [v5 removeAllObjects];

  if (isWatch() || (-[HMDHomeManager appleAccountManager](v3, "appleAccountManager"), v6 = objc_claimAutoreleasedReturnValue(), [v6 account], v7 = objc_claimAutoreleasedReturnValue(), v7, v6, v7))
  {
    v165 = [MEMORY[0x277CBEB18] array];
    v204 = 0u;
    v205 = 0u;
    v206 = 0u;
    v207 = 0u;
    v8 = [(HMDHomeManager *)v3 homes];
    v9 = [v8 countByEnumeratingWithState:&v204 objects:v224 count:16];
    if (v9)
    {
      v10 = v9;
      v11 = *v205;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v205 != v11)
          {
            objc_enumerationMutation(v8);
          }

          v13 = [*(*(&v204 + 1) + 8 * i) users];
          [v165 addObjectsFromArray:v13];
        }

        v10 = [v8 countByEnumeratingWithState:&v204 objects:v224 count:16];
      }

      while (v10);
    }

    v14 = [(HMDHomeManager *)v3 _remotePeers];
    v15 = [MEMORY[0x277D0F8E8] productInfo];
    v16 = [v15 productClass];

    v155 = v3;
    if (v16 == 1)
    {
      v167 = v14;
      v17 = [(HMDHomeManager *)v3 watchManager];
      v18 = [v17 watches];

      v19 = [MEMORY[0x277CBEB58] setWithCapacity:{objc_msgSend(v18, "count")}];
      v200 = 0u;
      v201 = 0u;
      v202 = 0u;
      v203 = 0u;
      v20 = v18;
      v21 = [v20 countByEnumeratingWithState:&v200 objects:v223 count:16];
      if (v21)
      {
        v22 = v21;
        v23 = *v201;
        do
        {
          for (j = 0; j != v22; ++j)
          {
            if (*v201 != v23)
            {
              objc_enumerationMutation(v20);
            }

            v25 = [*(*(&v200 + 1) + 8 * j) remoteDestinationString];
            [v19 addObject:v25];
          }

          v22 = [v20 countByEnumeratingWithState:&v200 objects:v223 count:16];
        }

        while (v22);
      }

      v198 = 0u;
      v199 = 0u;
      v196 = 0u;
      v197 = 0u;
      v26 = [(HMDHomeManager *)v3 homes];
      v27 = [v26 countByEnumeratingWithState:&v196 objects:v222 count:16];
      if (v27)
      {
        v28 = v27;
        v29 = *v197;
        do
        {
          for (k = 0; k != v28; ++k)
          {
            if (*v197 != v29)
            {
              objc_enumerationMutation(v26);
            }

            [*(*(&v196 + 1) + 8 * k) auditUsersForNotifications:v19];
          }

          v28 = [v26 countByEnumeratingWithState:&v196 objects:v222 count:16];
        }

        while (v28);
      }

      v194 = 0u;
      v195 = 0u;
      v192 = 0u;
      v193 = 0u;
      v31 = [(HMDHomeManager *)v3 fullSyncedWatchPeers];
      v32 = [v31 copy];

      v33 = [v32 countByEnumeratingWithState:&v192 objects:v221 count:16];
      if (v33)
      {
        v34 = v33;
        v35 = *v193;
        do
        {
          for (m = 0; m != v34; ++m)
          {
            if (*v193 != v35)
            {
              objc_enumerationMutation(v32);
            }

            v37 = *(*(&v192 + 1) + 8 * m);
            if (([v19 containsObject:v37] & 1) == 0)
            {
              v38 = objc_autoreleasePoolPush();
              v39 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
              {
                v40 = HMFGetLogIdentifier();
                *buf = 138543618;
                v210 = v40;
                v211 = 2112;
                v212 = v37;
                _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Fully synced watch %@ is no more paired", buf, 0x16u);

                v3 = v155;
              }

              objc_autoreleasePoolPop(v38);
              v41 = [(HMDHomeManager *)v3 fullSyncedWatchPeers];
              [v41 removeObject:v37];
            }
          }

          v34 = [v32 countByEnumeratingWithState:&v192 objects:v221 count:16];
        }

        while (v34);
      }

      v14 = v167;
    }

    v159 = [MEMORY[0x277CBEB58] set];
    v42 = objc_autoreleasePoolPush();
    v43 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
    {
      v44 = HMFGetLogIdentifier();
      *buf = 138543362;
      v210 = v44;
      _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@Checking for updated list of devices for remote access", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v42);
    v190 = 0u;
    v191 = 0u;
    v188 = 0u;
    v189 = 0u;
    obj = v14;
    v160 = [obj countByEnumeratingWithState:&v188 objects:v220 count:16];
    v45 = 0;
    if (v160)
    {
      v157 = *v189;
      do
      {
        for (n = 0; n != v160; ++n)
        {
          if (*v189 != v157)
          {
            objc_enumerationMutation(obj);
          }

          v47 = *(*(&v188 + 1) + 8 * n);
          v48 = [v47 remoteDestinationString];

          if (v48)
          {
            v49 = [v47 remoteDestinationString];
            [v159 addObject:v49];
          }

          v50 = objc_autoreleasePoolPush();
          v51 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
          {
            v52 = HMFGetLogIdentifier();
            *buf = 138543618;
            v210 = v52;
            v211 = 2112;
            v212 = v47;
            _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_INFO, "%{public}@Detected device: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v50);
          v53 = [v47 remoteDestinationString];
          v54 = [v165 hmf_firstObjectWithValue:v53 forKeyPath:@"userID"];

          if (isWatch())
          {
            v156 = n;
            v162 = v45;
            v186 = 0u;
            v187 = 0u;
            v184 = 0u;
            v185 = 0u;
            v170 = [(HMDHomeManager *)v3 homes];
            v55 = [v170 countByEnumeratingWithState:&v184 objects:v219 count:16];
            if (v55)
            {
              v56 = v55;
              v57 = *v185;
              do
              {
                v58 = 0;
                v59 = v54;
                v168 = v56;
                do
                {
                  if (*v185 != v57)
                  {
                    objc_enumerationMutation(v170);
                  }

                  v60 = *(*(&v184 + 1) + 8 * v58);
                  v61 = [v60 users];
                  v62 = [v47 remoteDestinationString];
                  v63 = [v61 hmf_firstObjectWithValue:v62 forKeyPath:@"userID"];

                  if (!v63)
                  {
                    v64 = v47;
                    v65 = [[HMDResidentUser alloc] initWithDevice:v47 home:v60 pairingIdentity:0 configurationState:2];
                    [(HMDUser *)v65 setHome:v60];
                    [v165 addObject:v65];
                    [v60 addCompanionAsResidentUser:v65];
                    v66 = objc_autoreleasePoolPush();
                    v67 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v67, OS_LOG_TYPE_INFO))
                    {
                      v68 = HMFGetLogIdentifier();
                      v69 = [v60 name];
                      *buf = 138543618;
                      v210 = v68;
                      v211 = 2112;
                      v212 = v69;
                      _os_log_impl(&dword_2531F8000, v67, OS_LOG_TYPE_INFO, "%{public}@Created and added a new resident user to home: %@ for watch", buf, 0x16u);
                    }

                    objc_autoreleasePoolPop(v66);
                    v47 = v64;
                    v56 = v168;
                  }

                  v54 = v63;

                  ++v58;
                  v59 = v54;
                }

                while (v56 != v58);
                v56 = [v170 countByEnumeratingWithState:&v184 objects:v219 count:16];
              }

              while (v56);
            }

            v3 = v155;
            n = v156;
            v45 = v162;
          }

          if (v54 && (objc_opt_class(), (objc_opt_isKindOfClass() & 1) != 0))
          {
            v70 = v54;
            if (([v70 updateWithDevice:v47] & 1) != 0 || !objc_msgSend(v70, "configurationState"))
            {
              [v70 setConfigurationState:2];
              v45 = 1;
            }

            else
            {
              v71 = n;
              v182 = 0u;
              v183 = 0u;
              v180 = 0u;
              v181 = 0u;
              v72 = [(HMDHomeManager *)v3 homes];
              v73 = [v72 countByEnumeratingWithState:&v180 objects:v218 count:16];
              if (v73)
              {
                v74 = v73;
                v75 = *v181;
                do
                {
                  for (ii = 0; ii != v74; ++ii)
                  {
                    if (*v181 != v75)
                    {
                      objc_enumerationMutation(v72);
                    }

                    v77 = [*(*(&v180 + 1) + 8 * ii) usersPendingUserManagementOperations];
                    if ([v77 containsObject:v70])
                    {
                      v78 = [v70 configurationState];

                      if (v78 == 1)
                      {
                        [v70 setConfigurationState:2];
                        v45 = 1;
                      }
                    }

                    else
                    {
                    }
                  }

                  v74 = [v72 countByEnumeratingWithState:&v180 objects:v218 count:16];
                }

                while (v74);
              }

              v3 = v155;
              n = v71;
            }
          }

          else
          {
            v79 = [(HMDHomeManager *)v3 unassociatedRemotePeers];
            [v79 addObject:v47];

            v80 = objc_autoreleasePoolPush();
            v81 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v81, OS_LOG_TYPE_INFO))
            {
              v82 = HMFGetLogIdentifier();
              *buf = 138543618;
              v210 = v82;
              v211 = 2112;
              v212 = v47;
              _os_log_impl(&dword_2531F8000, v81, OS_LOG_TYPE_INFO, "%{public}@Adding remote peer, %@, to unassociated list", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v80);
          }
        }

        v160 = [obj countByEnumeratingWithState:&v188 objects:v220 count:16];
      }

      while (v160);
    }

    v83 = objc_autoreleasePoolPush();
    v84 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v84, OS_LOG_TYPE_INFO))
    {
      v85 = HMFGetLogIdentifier();
      v86 = [(HMDHomeManager *)v3 unassociatedRemotePeers];
      v87 = [v86 count];
      *buf = 138543618;
      v210 = v85;
      v211 = 2048;
      v212 = v87;
      _os_log_impl(&dword_2531F8000, v84, OS_LOG_TYPE_INFO, "%{public}@Total unassociated peers %ld", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v83);
    v88 = [(HMDHomeManager *)v3 appleAccountManager];
    v89 = [v88 device];
    v90 = [v89 identifier];

    v153 = [MEMORY[0x277CBEB18] array];
    v176 = 0u;
    v177 = 0u;
    v178 = 0u;
    v179 = 0u;
    v169 = v165;
    v91 = [v169 countByEnumeratingWithState:&v176 objects:v217 count:16];
    if (v91)
    {
      v93 = v91;
      v94 = *v177;
      *&v92 = 138543362;
      v152 = v92;
      v164 = v90;
      v161 = *v177;
      v163 = v45;
      do
      {
        v95 = 0;
        v166 = v93;
        do
        {
          if (*v177 != v94)
          {
            objc_enumerationMutation(v169);
          }

          v96 = *(*(&v176 + 1) + 8 * v95);
          v97 = [v90 UUIDString];
          v98 = [v96 pairingUsername];
          v99 = [v97 isEqualToString:v98];

          if (!v99)
          {
            if (shouldLogPrivateInformation())
            {
              v171 = [v96 userID];
            }

            else
            {
              v104 = @"...";
              v171 = @"...";
            }

            v105 = [v96 home];
            v106 = objc_autoreleasePoolPush();
            v107 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v107, OS_LOG_TYPE_INFO))
            {
              v108 = HMFGetLogIdentifier();
              v109 = [v96 home];
              v110 = [v109 name];
              [v96 isRemoteGateway];
              v111 = HMFBooleanToString();
              *buf = 138544130;
              v210 = v108;
              v211 = 2112;
              v212 = v171;
              v213 = 2112;
              v214 = v110;
              v215 = 2112;
              v216 = v111;
              _os_log_impl(&dword_2531F8000, v107, OS_LOG_TYPE_INFO, "%{public}@Existing user: %@, for home: %@, isRemoteGateway: %@", buf, 0x2Au);

              v94 = v161;
              v93 = v166;

              v90 = v164;
            }

            objc_autoreleasePoolPop(v106);
            if (![v96 isRemoteGateway])
            {
              goto LABEL_126;
            }

            [v105 isOwnerUser];
            v112 = [HMDHomeManager isThisDeviceAdminOfHome:v105]|| isWatch();
            v113 = [v96 userID];
            v114 = [v159 containsObject:v113];
            if ((v114 & 1) == 0 && !v112)
            {
              v115 = [v96 userID];

              if (v115)
              {
                goto LABEL_107;
              }

LABEL_120:
              if (v112)
              {
                v134 = objc_autoreleasePoolPush();
                v135 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v135, OS_LOG_TYPE_INFO))
                {
                  v136 = HMFGetLogIdentifier();
                  v137 = [v96 userID];
                  *buf = 138543618;
                  v210 = v136;
                  v211 = 2112;
                  v212 = v137;
                  _os_log_impl(&dword_2531F8000, v135, OS_LOG_TYPE_INFO, "%{public}@Previous associated remote peer %@ has been removed", buf, 0x16u);

                  v93 = v166;
                }

                objc_autoreleasePoolPop(v134);
                [v153 addObject:v96];
                v138 = objc_autoreleasePoolPush();
                v139 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v139, OS_LOG_TYPE_DEBUG))
                {
                  v140 = HMFGetLogIdentifier();
                  *buf = v152;
                  v210 = v140;
                  _os_log_impl(&dword_2531F8000, v139, OS_LOG_TYPE_DEBUG, "%{public}@Remove resident device", buf, 0xCu);
                }

                objc_autoreleasePoolPop(v138);
              }

LABEL_126:

              goto LABEL_127;
            }

            if (!v114)
            {
              goto LABEL_120;
            }

LABEL_107:
            v116 = objc_autoreleasePoolPush();
            v117 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v117, OS_LOG_TYPE_INFO))
            {
              v118 = HMFGetLogIdentifier();
              v119 = [v96 userID];
              v120 = [v96 home];
              v121 = [v120 name];
              *buf = 138543874;
              v210 = v118;
              v211 = 2112;
              v212 = v119;
              v213 = 2112;
              v214 = v121;
              _os_log_impl(&dword_2531F8000, v117, OS_LOG_TYPE_INFO, "%{public}@Adding remote peer %@ for home %@", buf, 0x20u);

              v3 = v155;
              v90 = v164;

              v94 = v161;
            }

            objc_autoreleasePoolPop(v116);
            v122 = [(HMDHomeManager *)v3 associatedRemotePeers];
            v123 = [v105 uuid];
            v124 = [v122 objectForKeyedSubscript:v123];

            if (!v124)
            {
              v124 = [MEMORY[0x277CBEB58] set];
              v125 = [(HMDHomeManager *)v3 associatedRemotePeers];
              v126 = [v105 uuid];
              [v125 setObject:v124 forKeyedSubscript:v126];
            }

            v127 = [v96 userID];
            [v124 addObject:v127];

            v128 = [v96 userID];
            if (([v159 containsObject:v128] | v112))
            {
LABEL_117:
            }

            else
            {
              objc_opt_class();
              isKindOfClass = objc_opt_isKindOfClass();

              if (isKindOfClass)
              {
                v128 = v96;
                if (![v128 configurationState])
                {
                  v130 = objc_autoreleasePoolPush();
                  v131 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v131, OS_LOG_TYPE_INFO))
                  {
                    v132 = HMFGetLogIdentifier();
                    v133 = [v128 userID];
                    *buf = 138543618;
                    v210 = v132;
                    v211 = 2112;
                    v212 = v133;
                    _os_log_impl(&dword_2531F8000, v131, OS_LOG_TYPE_INFO, "%{public}@[HMDHomeManager] Unknown configuration state, enabling '%@'", buf, 0x16u);

                    v90 = v164;
                    v94 = v161;
                  }

                  objc_autoreleasePoolPop(v130);
                  [v128 setConfigurationState:2];
                }

                goto LABEL_117;
              }
            }

            v93 = v166;
            goto LABEL_126;
          }

          v100 = objc_autoreleasePoolPush();
          v101 = v3;
          v102 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v102, OS_LOG_TYPE_INFO))
          {
            v103 = HMFGetLogIdentifier();
            *buf = 138543618;
            v210 = v103;
            v211 = 2112;
            v212 = v96;
            _os_log_impl(&dword_2531F8000, v102, OS_LOG_TYPE_INFO, "%{public}@Skipping resident user representing ourselves: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v100);
LABEL_127:
          ++v95;
          LOBYTE(v45) = v163;
        }

        while (v93 != v95);
        v93 = [v169 countByEnumeratingWithState:&v176 objects:v217 count:16];
      }

      while (v93);
    }

    v174 = 0u;
    v175 = 0u;
    v172 = 0u;
    v173 = 0u;
    v141 = [(HMDHomeManager *)v3 homes];
    v142 = [v141 countByEnumeratingWithState:&v172 objects:v208 count:16];
    if (v142)
    {
      v143 = v142;
      v144 = *v173;
      do
      {
        for (jj = 0; jj != v143; ++jj)
        {
          if (*v173 != v144)
          {
            objc_enumerationMutation(v141);
          }

          v146 = *(*(&v172 + 1) + 8 * jj);
          v147 = [(HMDHomeManager *)v3 unassociatedRemotePeers];
          [v146 notifyNewRemotePeersFound:objc_msgSend(v147 remoteUsersRemoved:"count") != 0 forceRemoteNotificationRegistration:{v153, v158}];
        }

        v143 = [v141 countByEnumeratingWithState:&v172 objects:v208 count:16];
      }

      while (v143);
    }

    if (v45)
    {
      [(HMDHomeManager *)v3 _saveWithReason:@"legacyResidentUpdated" postSyncNotification:0];
    }
  }

  else
  {
    v149 = objc_autoreleasePoolPush();
    v150 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v150, OS_LOG_TYPE_INFO))
    {
      v151 = HMFGetLogIdentifier();
      *buf = 138543362;
      v210 = v151;
      _os_log_impl(&dword_2531F8000, v150, OS_LOG_TYPE_INFO, "%{public}@No active IDS account, cannot check for remote peers.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v149);
  }

  v148 = *MEMORY[0x277D85DE8];
}

- (id)_remotePeers
{
  v26[1] = *MEMORY[0x277D85DE8];
  if (isWatch())
  {
    v3 = [(HMDHomeManager *)self companionManager];
    v4 = [v3 companion];

    if (v4)
    {
      v26[0] = v4;
      v5 = [MEMORY[0x277CBEA60] arrayWithObjects:v26 count:1];
    }

    else
    {
      v5 = 0;
    }
  }

  else
  {
    v6 = [(HMDHomeManager *)self appleAccountManager];
    v7 = [v6 account];
    v4 = [v7 devices];

    v8 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v4, "count")}];
    v21 = 0u;
    v22 = 0u;
    v23 = 0u;
    v24 = 0u;
    v9 = [(HMDHomeManager *)self appleAccountManager];
    v10 = [v9 account];
    v11 = [v10 devices];

    v12 = [v11 countByEnumeratingWithState:&v21 objects:v25 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v22;
      do
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v22 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v21 + 1) + 8 * i);
          v17 = [v16 capabilities];
          if ([v17 isRemoteGatewayCapable])
          {
            v18 = [v16 isCurrentDevice];

            if ((v18 & 1) == 0)
            {
              [v8 addObject:v16];
            }
          }

          else
          {
          }
        }

        v13 = [v11 countByEnumeratingWithState:&v21 objects:v25 count:16];
      }

      while (v13);
    }

    v5 = [v8 copy];
  }

  v19 = *MEMORY[0x277D85DE8];

  return v5;
}

- (void)_checkForRemotePeers
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __38__HMDHomeManager__checkForRemotePeers__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

- (void)checkForRemotePeers
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __37__HMDHomeManager_checkForRemotePeers__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

- (BOOL)isPairedWithWatch
{
  v2 = [(HMDHomeManager *)self watchManager];
  v3 = [v2 isPairedWithWatch];

  return v3;
}

- (void)_checkAndInformCompanionDevice
{
  v30 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self companionManager];
  v4 = [v3 companion];

  if ((v4 != 0) != [(HMDHomeManager *)self companionReachable])
  {
    [(HMDHomeManager *)self setCompanionReachable:v4 != 0];
    v5 = +[HMDWatchSystemState sharedState];
    [v5 setCompanionReachable:v4 != 0];

    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v27 = v8;
      v28 = 1024;
      v29 = [(HMDHomeManager *)self companionReachable];
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Companion is reachable: %d", buf, 0x12u);
    }

    objc_autoreleasePoolPop(v6);
    if (v4)
    {
      v9 = [HMDRemoteDeviceMessageDestination alloc];
      v10 = [(HMDHomeManager *)self uuid];
      v11 = [(HMDRemoteDeviceMessageDestination *)v9 initWithTarget:v10 device:v4];

      v12 = [MEMORY[0x277D0F818] messageWithName:@"kRequestForCompanionKeysSyncInternalRequestKey" qualityOfService:9 destination:v11 payload:0];
      v13 = [(HMDHomeManager *)self messageDispatcher];
      [v13 sendMessage:v12 completionHandler:0];
    }

    [(HMDHomeManager *)self _checkForRemotePeers];
    if (![(HMDHomeManager *)self companionReachable])
    {
      v23 = 0u;
      v24 = 0u;
      v21 = 0u;
      v22 = 0u;
      v14 = [(HMDHomeManager *)self homes];
      v15 = [v14 countByEnumeratingWithState:&v21 objects:v25 count:16];
      if (v15)
      {
        v16 = v15;
        v17 = *v22;
        do
        {
          v18 = 0;
          do
          {
            if (*v22 != v17)
            {
              objc_enumerationMutation(v14);
            }

            v19 = [*(*(&v21 + 1) + 8 * v18) uuid];
            [(HMDHomeManager *)self _teardownRemoteAccessForHomeThroughCompanion:v19];

            ++v18;
          }

          while (v16 != v18);
          v16 = [v14 countByEnumeratingWithState:&v21 objects:v25 count:16];
        }

        while (v16);
      }
    }
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (HMDDevice)companionDevice
{
  v2 = [(HMDHomeManager *)self companionManager];
  v3 = [v2 companion];

  return v3;
}

- (void)syncWalletKeyPassSerialNumbersToWatch:(id)a3 withCompletion:(id)a4
{
  v48 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 version];
  v9 = +[HMDHomeKitVersion version8];
  v10 = [v8 isAtLeastVersion:v9];

  if (v10)
  {
    v11 = [v6 remoteDestinationString];
    v12 = [(HMDHomeManager *)self homes];
    v13 = [v12 na_map:&__block_literal_global_1355];

    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    v17 = os_log_type_enabled(v16, OS_LOG_TYPE_INFO);
    if (v13)
    {
      if (v17)
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543874;
        v43 = v18;
        v44 = 2112;
        v45 = v13;
        v46 = 2112;
        v47 = v11;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Syncing wallet key pass serial numbers: %@ to watch: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      v19 = [(HMDHomeManager *)v15 uuid];
      v20 = [HMDMessageDispatcher destinationWithTarget:v19 userID:0 destination:v11 multicast:0];

      if (v20)
      {
        v40 = @"HMDHomeMangerMessageKeyHomeWalletKeysPassSerialNumbers";
        v41 = v13;
        v21 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v41 forKeys:&v40 count:1];
        v22 = [MEMORY[0x277D0F848] messageWithName:@"HMDHomeManagerSyncWalletKeysPassSerialNumbersMessage" qualityOfService:17 destination:v20 payload:v21];
        [v22 setSecureRemote:1];
        [v22 setRemoteRestriction:4];
        objc_initWeak(buf, v15);
        v23 = [(HMDHomeManager *)v15 workQueue];
        v32 = MEMORY[0x277D85DD0];
        v33 = 3221225472;
        v34 = __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_1356;
        v35 = &unk_2797328E8;
        v24 = v23;
        v36 = v24;
        objc_copyWeak(&v39, buf);
        v37 = v11;
        v38 = v7;
        [v22 setResponseHandler:&v32];
        v25 = [(HMDHomeManager *)v15 messageDispatcher:v32];
        [v25 sendMessage:v22];

        objc_destroyWeak(&v39);
        objc_destroyWeak(buf);
      }

      else
      {
        v27 = objc_autoreleasePoolPush();
        v28 = v15;
        v29 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
        {
          v30 = HMFGetLogIdentifier();
          *buf = 138543618;
          v43 = v30;
          v44 = 2112;
          v45 = v11;
          _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot sync wallet pass serial numbers to watch: could not create message destination for deviceId: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v27);
        v7[2](v7);
      }
    }

    else
    {
      if (v17)
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543618;
        v43 = v26;
        v44 = 2112;
        v45 = v11;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Did not find any wallet key pass serial numbers to sync to watch: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v7[2](v7);
    }
  }

  else
  {
    v7[2](v7);
  }

  v31 = *MEMORY[0x277D85DE8];
}

void __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_1356(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = *(a1 + 32);
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_2;
  block[3] = &unk_2797328C0;
  objc_copyWeak(&v16, (a1 + 56));
  v12 = *(a1 + 40);
  v8 = *(a1 + 48);
  v14 = v5;
  v15 = v8;
  v13 = v6;
  v9 = v5;
  v10 = v6;
  dispatch_async(v7, block);

  objc_destroyWeak(&v16);
}

void __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke_2(uint64_t a1)
{
  v24 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    v3 = [*(a1 + 40) hmf_BOOLForKey:@"kDataSyncResponseAckKey"];
    v4 = objc_autoreleasePoolPush();
    v5 = WeakRetained;
    v6 = HMFGetOSLogHandle();
    v7 = v6;
    if (v3)
    {
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v8 = HMFGetLogIdentifier();
        v9 = *(a1 + 32);
        v18 = 138543618;
        v19 = v8;
        v20 = 2112;
        v21 = v9;
        v10 = "%{public}@Successfully synced wallet key pass serial numbers to watch: %@";
        v11 = v7;
        v12 = OS_LOG_TYPE_INFO;
        v13 = 22;
LABEL_9:
        _os_log_impl(&dword_2531F8000, v11, v12, v10, &v18, v13);
      }
    }

    else if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v15 = *(a1 + 32);
      v16 = *(a1 + 48);
      v18 = 138543874;
      v19 = v8;
      v20 = 2112;
      v21 = v15;
      v22 = 2112;
      v23 = v16;
      v10 = "%{public}@Failed to sync wallet key pass serials numbers to watch %@:%@";
      v11 = v7;
      v12 = OS_LOG_TYPE_ERROR;
      v13 = 32;
      goto LABEL_9;
    }

LABEL_10:

    goto LABEL_11;
  }

  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v14 = *(a1 + 32);
    v18 = 138543618;
    v19 = v7;
    v20 = 2112;
    v21 = v14;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@HomeManager became nil while syncing wallet key pass serial numbers to watch: %@", &v18, 0x16u);
    goto LABEL_10;
  }

LABEL_11:

  objc_autoreleasePoolPop(v4);
  (*(*(a1 + 56) + 16))();

  v17 = *MEMORY[0x277D85DE8];
}

id __71__HMDHomeManager_syncWalletKeyPassSerialNumbersToWatch_withCompletion___block_invoke(uint64_t a1, void *a2)
{
  v2 = [a2 walletKeyManager];
  v3 = [v2 passSerialNumber];

  return v3;
}

- (void)_sendHomeDataToWatch:(id)a3 migrateToHH2:(BOOL)a4 completionHandler:(id)a5
{
  v75 = a4;
  v119 = *MEMORY[0x277D85DE8];
  v80 = a3;
  v71 = a5;
  val = self;
  v7 = [(HMDHomeManager *)self watchManager];
  v72 = [v7 connectedWatchFromDeviceID:v80];

  if (!-[HMDHomeManager accountActive](self, "accountActive") || ([v72 capabilities], v8 = objc_claimAutoreleasedReturnValue(), v9 = objc_msgSend(v8, "supportsCloudDataSync"), v8, !v9))
  {
    context = objc_autoreleasePoolPush();
    *buf = 0;
    *&buf[8] = buf;
    *&buf[16] = 0x3032000000;
    v116 = __Block_byref_object_copy__172847;
    v117 = __Block_byref_object_dispose__172848;
    v118 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-home-to-watch"];
    group = dispatch_group_create();
    v15 = [v72 version];
    v16 = +[HMDHomeKitVersion version4];
    v74 = [v15 isAtLeastVersion:v16];

    v17 = [(HMDHomeManager *)val associatedWatchPeers];
    v78 = [v17 objectForKeyedSubscript:v80];

    objc_initWeak(&location, val);
    [(HMDHomeManager *)val homes];
    v99 = 0u;
    v100 = 0u;
    v97 = 0u;
    obj = v98 = 0u;
    v18 = [obj countByEnumeratingWithState:&v97 objects:v114 count:16];
    if (v18)
    {
      v19 = 0;
      v77 = *v98;
      do
      {
        for (i = 0; i != v18; ++i)
        {
          if (*v98 != v77)
          {
            objc_enumerationMutation(obj);
          }

          v21 = *(*(&v97 + 1) + 8 * i);
          v22 = [v21 configurationVersion];
          v23 = [v78 homeConfig];
          v24 = [v21 uuid];
          v25 = [v23 objectForKeyedSubscript:v24];

          v26 = [v21 watchSkipVersionCheck];
          if (v25)
          {
            v27 = v26;
          }

          else
          {
            v27 = 1;
          }

          if ((v27 & 1) != 0 || [v25 integerValue] != v22)
          {
            v33 = objc_autoreleasePoolPush();
            v34 = val;
            v35 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
            {
              v36 = HMFGetLogIdentifier();
              v37 = [v21 name];
              *v106 = 138543874;
              v107 = v36;
              v108 = 2112;
              v109 = v37;
              v110 = 2112;
              v111 = v80;
              _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_INFO, "%{public}@Sending over the data for home %@ to watch %@", v106, 0x20u);
            }

            objc_autoreleasePoolPop(v33);
            v38 = [(HMDHomeManager *)v34 _prepareDataForDevicesOnSameAccountForHome:v21 remoteGateway:0 isAtLeastV4:v74 migrateToHH2:v75];
            v92[0] = MEMORY[0x277D85DD0];
            v92[1] = 3221225472;
            v92[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke;
            v92[3] = &unk_279732828;
            objc_copyWeak(v96, &location);
            v93 = v80;
            v94 = v21;
            v96[1] = v22;
            v95 = v34;
            [(HMDHomeManager *)v34 _pushChangesToWatch:v93 payload:v38 group:group completionHandler:v92];

            objc_destroyWeak(v96);
            v19 = 1;
          }

          else
          {
            v28 = objc_autoreleasePoolPush();
            v29 = val;
            v30 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
            {
              v31 = HMFGetLogIdentifier();
              v32 = [v21 name];
              *v106 = 138544130;
              v107 = v31;
              v108 = 2112;
              v109 = v32;
              v110 = 2112;
              v111 = v25;
              v112 = 2048;
              v113 = v22;
              _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Not sending home data for %@ as the config versions match (W: %@, C: %ld)", v106, 0x2Au);
            }

            objc_autoreleasePoolPop(v28);
          }
        }

        v18 = [obj countByEnumeratingWithState:&v97 objects:v114 count:16];
      }

      while (v18);

      if (v19)
      {
        v39 = 1;
LABEL_39:
        v68 = [(HMDHomeManager *)val workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1352;
        block[3] = &unk_279732878;
        block[4] = val;
        v82 = v80;
        v85 = buf;
        v84 = v71;
        v86 = v39;
        v83 = v72;
        dispatch_group_notify(group, v68, block);

        objc_destroyWeak(&location);
        _Block_object_dispose(buf, 8);

        objc_autoreleasePoolPop(context);
        goto LABEL_40;
      }
    }

    else
    {
    }

    v40 = [(HMDHomeManager *)val primaryHomeUUID];
    if (!v40)
    {
      goto LABEL_30;
    }

    v41 = [v78 primaryHome];
    v42 = [(HMDHomeManager *)val primaryHomeUUID];
    v43 = HMFEqualObjects();

    if ((v43 & 1) == 0)
    {
      v49 = objc_autoreleasePoolPush();
      v50 = val;
      v51 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
      {
        v52 = HMFGetLogIdentifier();
        v53 = [v78 primaryHome];
        v54 = [v53 UUIDString];
        v55 = [(HMDHomeManager *)v50 primaryHomeUUID];
        v56 = [v55 UUIDString];
        *v106 = 138543874;
        v107 = v52;
        v108 = 2112;
        v109 = v54;
        v110 = 2112;
        v111 = v56;
        _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_INFO, "%{public}@Primary home has been updated from %@ to %@, sending primary home update", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v49);
      v57 = [(HMDHomeManager *)v50 primaryHomeUUID];
      v104 = @"kPrimaryHomeUUIDKey";
      v58 = [v57 UUIDString];
      v105 = v58;
      v59 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v105 forKeys:&v104 count:1];

      v102 = @"kHomeDataKey";
      v60 = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v59, v74, 0);
      v103 = v60;
      v61 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v103 forKeys:&v102 count:1];

      v62 = objc_autoreleasePoolPush();
      v63 = v50;
      v64 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v64, OS_LOG_TYPE_INFO))
      {
        v65 = HMFGetLogIdentifier();
        v66 = [v57 UUIDString];
        *v106 = 138543874;
        v107 = v65;
        v108 = 2112;
        v109 = v66;
        v110 = 2112;
        v111 = v80;
        _os_log_impl(&dword_2531F8000, v64, OS_LOG_TYPE_INFO, "%{public}@Sending over the data for primary home update to %@ to watch %@", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v62);
      v87[0] = MEMORY[0x277D85DD0];
      v87[1] = 3221225472;
      v87[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1351;
      v87[3] = &unk_279732850;
      objc_copyWeak(&v91, &location);
      v88 = v80;
      v67 = v57;
      v89 = v67;
      v90 = v63;
      [(HMDHomeManager *)v63 _pushChangesToWatch:v88 payload:v61 group:group completionHandler:v87];

      objc_destroyWeak(&v91);
    }

    else
    {
LABEL_30:
      v44 = objc_autoreleasePoolPush();
      v45 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_INFO))
      {
        v46 = HMFGetLogIdentifier();
        v47 = [v78 primaryHome];
        v48 = [(HMDHomeManager *)val primaryHomeUUID];
        *v106 = 138543874;
        v107 = v46;
        v108 = 2112;
        v109 = v47;
        v110 = 2112;
        v111 = v48;
        _os_log_impl(&dword_2531F8000, v45, OS_LOG_TYPE_INFO, "%{public}@Not sending primary home update as they match: (W: %@, C: %@)", v106, 0x20u);
      }

      objc_autoreleasePoolPop(v44);
    }

    v39 = 0;
    goto LABEL_39;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = val;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543618;
    *&buf[4] = v13;
    *&buf[12] = 2112;
    *&buf[14] = v72;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Paired watch %@ supports cloud data sync - skipping sending home data", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v10);
  if (v71)
  {
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
    (*(v71 + 2))(v71, 0, v14);
  }

LABEL_40:

  v69 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke(uint64_t a1, int a2)
{
  v29 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    if (a2)
    {
      v6 = [WeakRetained associatedWatchPeers];
      v7 = [v6 objectForKeyedSubscript:*(a1 + 32)];

      v8 = [MEMORY[0x277CCABB0] numberWithInteger:*(a1 + 64)];
      v9 = [*(a1 + 40) uuid];
      [v7 setConfigVersion:v8 forHome:v9];

      v10 = objc_autoreleasePoolPush();
      v11 = *(a1 + 48);
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v14 = *(a1 + 32);
        v15 = [*(a1 + 40) name];
        v23 = 138543874;
        v24 = v13;
        v25 = 2112;
        v26 = v14;
        v27 = 2112;
        v28 = v15;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Received ACK from watch %@ for data corresponding to home %@", &v23, 0x20u);
      }

      objc_autoreleasePoolPop(v10);
    }

    else
    {
      v16 = objc_autoreleasePoolPush();
      v17 = *(a1 + 48);
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = HMFGetLogIdentifier();
        v20 = [*(a1 + 40) name];
        v21 = *(a1 + 32);
        v23 = 138543874;
        v24 = v19;
        v25 = 2112;
        v26 = v20;
        v27 = 2112;
        v28 = v21;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Failed to send data for home %@ to watch %@", &v23, 0x20u);
      }

      objc_autoreleasePoolPop(v16);
    }
  }

  v22 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1351(uint64_t a1, int a2)
{
  v27 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    if (a2)
    {
      v6 = [WeakRetained associatedWatchPeers];
      v7 = [v6 objectForKeyedSubscript:*(a1 + 32)];

      [v7 setPrimaryHome:*(a1 + 40)];
      v8 = objc_autoreleasePoolPush();
      v9 = *(a1 + 48);
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        v12 = *(a1 + 32);
        v13 = *(a1 + 40);
        v21 = 138543874;
        v22 = v11;
        v23 = 2112;
        v24 = v12;
        v25 = 2112;
        v26 = v13;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Received ACK from watch %@ for primary home update to %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v8);
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 48);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        v19 = *(a1 + 32);
        v18 = *(a1 + 40);
        v21 = 138543874;
        v22 = v17;
        v23 = 2112;
        v24 = v18;
        v25 = 2112;
        v26 = v19;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to primary home update %@ to watch %@", &v21, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
    }
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_1352(uint64_t a1)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_2;
  aBlock[3] = &unk_2797332C0;
  v2 = *(a1 + 40);
  aBlock[4] = *(a1 + 32);
  v8 = v2;
  v6 = *(a1 + 56);
  v3 = v6;
  v9 = v6;
  v4 = _Block_copy(aBlock);
  v5 = v4;
  if (*(a1 + 72))
  {
    [*(a1 + 32) syncWalletKeyPassSerialNumbersToWatch:*(a1 + 48) withCompletion:v4];
  }

  else
  {
    (*(v4 + 2))(v4);
  }
}

uint64_t __70__HMDHomeManager__sendHomeDataToWatch_migrateToHH2_completionHandler___block_invoke_2(uint64_t a1)
{
  v15 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v11 = 138543618;
    v12 = v5;
    v13 = 2112;
    v14 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Finished pushing home data changes to watch: %@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *(*(a1 + 56) + 8);
  v8 = *(v7 + 40);
  *(v7 + 40) = 0;

  result = *(a1 + 48);
  if (result)
  {
    result = (*(result + 16))(result, 1, 0);
  }

  v10 = *MEMORY[0x277D85DE8];
  return result;
}

uint64_t __74__HMDHomeManager__sendHomeDataToAllWatchesMigrateToHH2_completionHandler___block_invoke_2(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

- (void)sendHomeDataToAllWatchesWithCompletion:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __57__HMDHomeManager_sendHomeDataToAllWatchesWithCompletion___block_invoke;
  v7[3] = &unk_279735738;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

uint64_t __57__HMDHomeManager_sendHomeDataToAllWatchesWithCompletion___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Syncing home data to all watches", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = [*(a1 + 32) watchPushDelayTimer];
  [v6 suspend];

  result = [*(a1 + 32) _sendHomeDataToAllWatchesWithCompletion:*(a1 + 40)];
  v8 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_scheduleSendHomeDataToAllWatches
{
  v10 = *MEMORY[0x277D85DE8];
  if (isiOSDevice())
  {
    v3 = [(HMDHomeManager *)self watchPushDelayTimer];
    [v3 resume];

    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v8 = 138543362;
      v9 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Kicking watch push delay", &v8, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v7 = *MEMORY[0x277D85DE8];
}

- (BOOL)_addWatch:(id)a3 toAssociatedList:(id)a4
{
  v39[3] = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v7 hmf_numberForKey:@"kHomedVersionKey"];
  v9 = [v7 hmf_numberForKey:@"kMetadataInfoSchemaVersionKey"];
  v10 = [v7 hmf_numberForKey:@"kMetadataInfoVersionKey"];
  v11 = v10;
  if (v9)
  {
    v12 = v10 == 0;
  }

  else
  {
    v12 = 1;
  }

  v13 = !v12;
  if (v12)
  {
    v25 = objc_autoreleasePoolPush();
    v26 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v29 = v28 = v13;
      *buf = 138543362;
      v35 = v29;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Information from watch does not contain metadata version", buf, 0xCu);

      v13 = v28;
    }

    objc_autoreleasePoolPop(v25);
  }

  else
  {
    v32 = v13;
    if (!v8)
    {
      v8 = &unk_28662BF38;
    }

    v14 = [(HMDHomeManager *)self associatedWatchPeers];
    v15 = v6;
    v16 = v14;
    v33 = v15;
    v17 = [v14 objectForKeyedSubscript:?];

    if (!v17)
    {
      v17 = [[HMDWatchConfiguration alloc] initWithUniqueID:v33];
      v18 = [(HMDHomeManager *)self associatedWatchPeers];
      [v18 setObject:v17 forKeyedSubscript:v33];
    }

    v38[0] = @"kMetadataInfoSchemaVersionKey";
    v38[1] = @"kMetadataInfoVersionKey";
    v39[0] = v9;
    v39[1] = v11;
    v38[2] = @"kHomedVersionKey";
    v39[2] = v8;
    v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v39 forKeys:v38 count:3];
    [(HMDWatchConfiguration *)v17 setMetadataConfig:v19];

    v20 = [v7 hmf_dictionaryForKey:@"kHomeConfigHomesKey"];
    [(HMDWatchConfiguration *)v17 setHomeConfiguration:v20];
    v21 = [v7 hmf_UUIDForKey:@"kPrimaryHomeUUIDKey"];
    [(HMDWatchConfiguration *)v17 setPrimaryHome:v21];

    v22 = objc_autoreleasePoolPush();
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v24;
      v36 = 2112;
      v37 = v17;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Added/Updated %@ in associated watch peers", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v22);
    v6 = v33;
    v13 = v32;
  }

  v30 = *MEMORY[0x277D85DE8];
  return v13;
}

- (void)_sendKeysToWatch:(id)a3 completionHandler:(id)a4
{
  v54 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [MEMORY[0x277CFEC78] systemStore];
  v42 = 0;
  v43 = 0;
  v40 = 0;
  v41 = 0;
  v9 = [v8 getControllerPublicKey:&v43 secretKey:0 keyPair:&v42 username:&v41 allowCreation:0 error:&v40];
  v31 = v43;
  v32 = v42;
  v10 = v41;
  v29 = v40;

  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke;
  aBlock[3] = &unk_279732788;
  v11 = v7;
  v39 = v11;
  v12 = _Block_copy(aBlock);
  v13 = objc_autoreleasePoolPush();
  v14 = HMFGetOSLogHandle();
  v15 = os_log_type_enabled(v14, OS_LOG_TYPE_INFO);
  if (v9)
  {
    if (v15)
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138544130;
      v47 = v16;
      v48 = 2112;
      v49 = v6;
      v50 = 2112;
      v51 = v10;
      v52 = 2112;
      v53 = v31;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Adding Watch %@ to be associated with this device, controller name: %@, public key: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v13);
    v44[0] = @"kControllerKeyPairKey";
    v44[1] = @"kControllerPairingNameKey";
    v45[0] = v32;
    v45[1] = v10;
    v44[2] = @"kControllerUniqueDeviceIdSaltKey";
    v17 = +[HMDHomeManager saltForDeviceSpecificIdentifier];
    v45[2] = v17;
    v44[3] = @"kControllerAssistantTeamIdentifierKey";
    v18 = [(HMDHomeManager *)self _getAssistantHashingData];
    v45[3] = v18;
    v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v45 forKeys:v44 count:4];
    v20 = [v19 mutableCopy];

    v21 = [HMDDevice deviceWithDestination:v6];
    v22 = [HMDRemoteDeviceMessageDestination alloc];
    v23 = [(HMDHomeManager *)self uuid];
    v24 = [(HMDRemoteDeviceMessageDestination *)v22 initWithTarget:v23 device:v21];

    v25 = [MEMORY[0x277D0F848] messageWithName:@"kCompanionKeysSyncInternalRequestKey" qualityOfService:17 destination:v24 payload:v20];
    [v25 setSecureRemote:1];
    [v25 setRemoteRestriction:4];
    objc_initWeak(buf, self);
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke_1346;
    v33[3] = &unk_2797327D8;
    objc_copyWeak(&v37, buf);
    v35 = v12;
    v34 = v6;
    v36 = v11;
    [v25 setResponseHandler:v33];
    v26 = [(HMDHomeManager *)self messageDispatcher];
    [v26 sendMessage:v25 completionHandler:0];

    objc_destroyWeak(&v37);
    objc_destroyWeak(buf);
  }

  else
  {
    if (v15)
    {
      v27 = HMFGetLogIdentifier();
      *buf = 138543362;
      v47 = v27;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Cannot extract the key pair", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:{-1, v29}];
    (*(v12 + 2))(v12, 0, v20);
  }

  v28 = *MEMORY[0x277D85DE8];
}

uint64_t __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

void __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke_1346(id *a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 7);
  v8 = WeakRetained;
  if (WeakRetained)
  {
    v9 = [WeakRetained workQueue];
    v12[0] = MEMORY[0x277D85DD0];
    v12[1] = 3221225472;
    v12[2] = __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke_2;
    v12[3] = &unk_2797327B0;
    v13 = v5;
    v17 = a1[5];
    v14 = v8;
    v15 = a1[4];
    v16 = v6;
    v18 = a1[6];
    dispatch_async(v9, v12);
  }

  else
  {
    v10 = a1[5];
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23];
    v10[2](v10, 0, v11);
  }
}

void __53__HMDHomeManager__sendKeysToWatch_completionHandler___block_invoke_2(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
    {
      v4 = HMFGetLogIdentifier();
      v5 = *(a1 + 32);
      v18 = 138543618;
      v19 = v4;
      v20 = 2114;
      v21 = v5;
      _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_ERROR, "%{public}@Received error for companion keys request: %{public}@", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    v6 = *(a1 + 32);
    (*(*(a1 + 64) + 16))();
  }

  else
  {
    v7 = [*(a1 + 40) fullSyncedWatchPeers];
    [v7 addObject:*(a1 + 48)];

    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *(a1 + 48);
      v18 = 138543618;
      v19 = v10;
      v20 = 2112;
      v21 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Adding %@ to fully synced device list", &v18, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    v12 = [*(a1 + 40) _addWatch:*(a1 + 48) toAssociatedList:*(a1 + 56)];
    v13 = *(a1 + 40);
    if (v12)
    {
      [v13 _sendHomeDataToWatch:*(a1 + 48) completionHandler:*(a1 + 72)];
    }

    else
    {
      v14 = [v13 associatedWatchPeers];
      [v14 removeObjectForKey:*(a1 + 48)];

      v15 = *(a1 + 64);
      v16 = [MEMORY[0x277CCA9B8] hmErrorWithCode:-1];
      (*(v15 + 16))(v15, 0, v16);
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_addWatch:(id)a3 completionHandler:(id)a4
{
  v33[1] = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [HMDDevice deviceWithDestination:v6];
  v9 = [HMDRemoteDeviceMessageDestination alloc];
  v10 = [(HMDHomeManager *)self uuid];
  v11 = [(HMDRemoteDeviceMessageDestination *)v9 initWithTarget:v10 device:v8];

  v12 = [(HMDHomeManager *)self currentHomeUUID];

  if (v12)
  {
    v32 = @"kCurrentHomeUUIDKey";
    v13 = [(HMDHomeManager *)self currentHomeUUID];
    v14 = [v13 UUIDString];
    v33[0] = v14;
    v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v33 forKeys:&v32 count:1];
  }

  else
  {
    v30 = @"kNoCurrentHomeKey";
    v31 = MEMORY[0x277CBEC38];
    v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v31 forKeys:&v30 count:1];
  }

  v16 = [MEMORY[0x277D0F848] messageWithName:@"kHomeConfigInternalRequestKey" qualityOfService:17 destination:v11 payload:v15];
  objc_initWeak(&location, self);
  v21 = MEMORY[0x277D85DD0];
  v22 = 3221225472;
  v23 = __46__HMDHomeManager__addWatch_completionHandler___block_invoke;
  v24 = &unk_2797328E8;
  v17 = v7;
  v27 = v17;
  objc_copyWeak(&v28, &location);
  v25 = self;
  v18 = v6;
  v26 = v18;
  [v16 setResponseHandler:&v21];
  v19 = [(HMDHomeManager *)self messageDispatcher:v21];
  [v19 sendMessage:v16 completionHandler:0];

  objc_destroyWeak(&v28);
  objc_destroyWeak(&location);

  v20 = *MEMORY[0x277D85DE8];
}

void __46__HMDHomeManager__addWatch_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __46__HMDHomeManager__addWatch_completionHandler___block_invoke_2;
  aBlock[3] = &unk_279732788;
  v23 = *(a1 + 48);
  v7 = _Block_copy(aBlock);
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v9 = WeakRetained;
  if (WeakRetained)
  {
    v10 = [WeakRetained workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __46__HMDHomeManager__addWatch_completionHandler___block_invoke_3;
    block[3] = &unk_279734848;
    v16 = v5;
    v21 = v7;
    v17 = v6;
    v11 = v9;
    v12 = *(a1 + 32);
    v13 = *(a1 + 40);
    v18 = v11;
    v19 = v12;
    v20 = v13;
    dispatch_async(v10, block);

    v14 = v16;
  }

  else
  {
    v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23];
    (*(v7 + 2))(v7, 0, v14);
  }
}

uint64_t __46__HMDHomeManager__addWatch_completionHandler___block_invoke_2(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

uint64_t __46__HMDHomeManager__addWatch_completionHandler___block_invoke_3(uint64_t a1)
{
  v111 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_ERROR))
    {
      v4 = HMFGetLogIdentifier();
      v5 = *(a1 + 32);
      *buf = 138543618;
      v108 = v4;
      v109 = 2114;
      v110 = v5;
      _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_ERROR, "%{public}@Received error for home config request: %{public}@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v2);
    v6 = *(a1 + 32);
    v7 = *(*(a1 + 72) + 16);
    goto LABEL_52;
  }

  v8 = [*(a1 + 40) hmf_dictionaryForKey:@"kHomeConfigHomesKey"];
  v9 = MEMORY[0x277CBEB58];
  v10 = [v8 allKeys];
  v11 = [v9 setWithArray:v10];

  v12 = [*(a1 + 48) _prepareHomesVersionDict];
  v13 = MEMORY[0x277CBEB58];
  v14 = [v12 allKeys];
  v15 = [v13 setWithArray:v14];

  [v11 minusSet:v15];
  if ([v11 count])
  {
    v16 = objc_autoreleasePoolPush();
    v17 = *(a1 + 56);
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543618;
      v108 = v19;
      v109 = 2112;
      v110 = v11;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Complete sync is required because the following homes have been removed: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v16);
    v20 = 1;
    goto LABEL_45;
  }

  v21 = [*(a1 + 40) hmf_dataForKey:@"kControllerUniqueDeviceIdSaltKey"];
  if (!v21)
  {
    v23 = [*(a1 + 48) fullSyncedWatchPeers];
    v24 = [v23 containsObject:*(a1 + 64)];

    if ((v24 & 1) == 0)
    {
      v38 = objc_autoreleasePoolPush();
      v39 = *(a1 + 56);
      v40 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v40, OS_LOG_TYPE_INFO))
      {
        HMFGetLogIdentifier();
        v42 = v41 = v8;
        *buf = 138543362;
        v108 = v42;
        _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_INFO, "%{public}@Full sync has not happened happened before, need to rsync everything again", buf, 0xCu);

        v8 = v41;
      }

      objc_autoreleasePoolPop(v38);
LABEL_43:
      v20 = 1;
      goto LABEL_44;
    }

LABEL_14:

    v25 = [*(a1 + 40) objectForKey:@"pairingIdentity"];

    v26 = *(a1 + 40);
    if (v25)
    {
      v27 = [v26 hmf_dataForKey:@"pairingIdentity"];
      if (v27)
      {
        v28 = [MEMORY[0x277CCAAC8] deserializeObjectWithData:v27 allowedClass:objc_opt_class() frameworkClasses:MEMORY[0x277CBEBF8]];
        if (v28)
        {
          v21 = v28;

          goto LABEL_57;
        }

        v49 = objc_autoreleasePoolPush();
        v50 = *(a1 + 56);
        v51 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
        {
          HMFGetLogIdentifier();
          v53 = v52 = v8;
          *buf = 138543362;
          v108 = v53;
          _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to deserialize pairing identity", buf, 0xCu);

          v8 = v52;
        }

        objc_autoreleasePoolPop(v49);
      }
    }

    else
    {
      v27 = [v26 hmf_dataForKey:@"kControllerKeyPairKey"];
      v43 = [*(a1 + 40) hmf_stringForKey:@"kControllerPairingNameKey"];
      v44 = v43;
      if (v27 && v43)
      {
        v101 = v8;
        v45 = [MEMORY[0x277CFEC78] systemStore];
        v103 = 0;
        v104 = 0;
        v46 = [v45 deserializeKeyPair:v27 publicKey:&v104 secretKey:0 error:&v103];
        v47 = v104;
        v97 = v103;

        if (v46)
        {
          v48 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v47];
          v21 = [objc_alloc(MEMORY[0x277D0F8A8]) initWithIdentifier:v44 publicKey:v48 privateKey:0];
        }

        else
        {
          context = objc_autoreleasePoolPush();
          v70 = *(a1 + 56);
          v71 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v71, OS_LOG_TYPE_DEFAULT))
          {
            v72 = HMFGetLogIdentifier();
            *buf = 138543362;
            v108 = v72;
            _os_log_impl(&dword_2531F8000, v71, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to deserialize key pair", buf, 0xCu);
          }

          objc_autoreleasePoolPop(context);
          v21 = 0;
        }

        v8 = v101;
        if (v21)
        {
LABEL_57:
          v73 = [MEMORY[0x277CFEC78] systemStore];
          v102 = 0;
          v33 = [v73 getLocalPairingIdentity:&v102];
          v22 = v102;

          v20 = v33 != 0;
          if (v33)
          {
            if ([v21 isEqual:v33])
            {

              goto LABEL_60;
            }

            v100 = v8;
            contexta = objc_autoreleasePoolPush();
            v89 = *(a1 + 56);
            v90 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v90, OS_LOG_TYPE_INFO))
            {
              HMFGetLogIdentifier();
              v91 = v99 = v22;
              *buf = 138543618;
              v108 = v91;
              v109 = 2112;
              v110 = v21;
              _os_log_impl(&dword_2531F8000, v90, OS_LOG_TYPE_INFO, "%{public}@Watch pairing identity incorrect: %@", buf, 0x16u);

              v22 = v99;
            }

            objc_autoreleasePoolPop(contexta);
          }

          else
          {
            v98 = v22;
            v100 = v8;
            v84 = objc_autoreleasePoolPush();
            v85 = *(a1 + 56);
            v86 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v86, OS_LOG_TYPE_ERROR))
            {
              HMFGetLogIdentifier();
              v87 = contextb = v84;
              *buf = 138543362;
              v108 = v87;
              _os_log_impl(&dword_2531F8000, v86, OS_LOG_TYPE_ERROR, "%{public}@Companion does not have local pairing identity, so cannot add the watch", buf, 0xCu);

              v84 = contextb;
            }

            objc_autoreleasePoolPop(v84);
            v88 = [*(a1 + 48) associatedWatchPeers];
            [v88 removeObjectForKey:*(a1 + 64)];

            v22 = v98;
          }

          goto LABEL_21;
        }

        goto LABEL_38;
      }
    }

LABEL_38:
    v54 = [*(a1 + 48) fullSyncedWatchPeers];
    v55 = [v54 containsObject:*(a1 + 64)];

    if (v55)
    {
      v21 = 0;
LABEL_60:

      v74 = objc_autoreleasePoolPush();
      v75 = *(a1 + 56);
      v76 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v76, OS_LOG_TYPE_INFO))
      {
        v77 = HMFGetLogIdentifier();
        v78 = *(a1 + 64);
        *buf = 138543618;
        v108 = v77;
        v109 = 2112;
        v110 = v78;
        _os_log_impl(&dword_2531F8000, v76, OS_LOG_TYPE_INFO, "%{public}@Adding watch %@ associated watch peers", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v74);
      if ([*(a1 + 48) _addWatch:*(a1 + 64) toAssociatedList:*(a1 + 40)])
      {
        v79 = objc_autoreleasePoolPush();
        v80 = *(a1 + 56);
        v81 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v81, OS_LOG_TYPE_INFO))
        {
          v82 = HMFGetLogIdentifier();
          *buf = 138543362;
          v108 = v82;
          _os_log_impl(&dword_2531F8000, v81, OS_LOG_TYPE_INFO, "%{public}@Scheduling partial push to watch", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v79);
        [*(a1 + 48) _scheduleSendHomeDataToAllWatches];
        v60 = 0;
        v20 = 1;
      }

      else
      {
        v83 = [*(a1 + 48) associatedWatchPeers];
        [v83 removeObjectForKey:*(a1 + 64)];

        v20 = 0;
        v60 = 0;
      }

      goto LABEL_46;
    }

    v56 = objc_autoreleasePoolPush();
    v57 = *(a1 + 56);
    v58 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v58, OS_LOG_TYPE_INFO))
    {
      v59 = HMFGetLogIdentifier();
      *buf = 138543362;
      v108 = v59;
      _os_log_impl(&dword_2531F8000, v58, OS_LOG_TYPE_INFO, "%{public}@Full sync has not happened happened before, need to rsync everything again", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v56);
    v21 = 0;
    goto LABEL_43;
  }

  v22 = +[HMDHomeManager saltForDeviceSpecificIdentifier];
  v20 = v22 != 0;
  if (v22)
  {
    if (([v21 isEqualToData:v22] & 1) == 0)
    {
      v100 = v8;
      v34 = objc_autoreleasePoolPush();
      v35 = *(a1 + 56);
      v36 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
      {
        HMFGetLogIdentifier();
        v37 = v96 = v34;
        *buf = 138543362;
        v108 = v37;
        _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Device ID salts mismatched", buf, 0xCu);

        v34 = v96;
      }

      objc_autoreleasePoolPop(v34);
      goto LABEL_25;
    }

    goto LABEL_14;
  }

  v100 = v8;
  v29 = objc_autoreleasePoolPush();
  v30 = *(a1 + 56);
  v31 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v31, OS_LOG_TYPE_ERROR))
  {
    HMFGetLogIdentifier();
    v32 = v95 = v29;
    *buf = 138543362;
    v108 = v32;
    _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_ERROR, "%{public}@Companion does not have device ID salt, so cannot add the watch", buf, 0xCu);

    v29 = v95;
  }

  objc_autoreleasePoolPop(v29);
  v33 = [*(a1 + 48) associatedWatchPeers];
  [v33 removeObjectForKey:*(a1 + 64)];
LABEL_21:

LABEL_25:
  v8 = v100;
LABEL_44:

LABEL_45:
  v60 = 1;
LABEL_46:

  if (v20 && v60)
  {
    v61 = objc_autoreleasePoolPush();
    v62 = *(a1 + 56);
    v63 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_INFO))
    {
      v64 = HMFGetLogIdentifier();
      v65 = *(a1 + 64);
      *buf = 138543618;
      v108 = v64;
      v109 = 2112;
      v110 = v65;
      _os_log_impl(&dword_2531F8000, v63, OS_LOG_TYPE_INFO, "%{public}@Watch %@ needs a complete sync", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v61);
    v66 = *(a1 + 48);
    v105 = *(a1 + 64);
    v106 = &unk_28662A2E0;
    v67 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v106 forKeys:&v105 count:1];
    [v66 _addSyncOperation:v67];
  }

  v7 = *(*(a1 + 72) + 16);
LABEL_52:
  result = v7();
  v69 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_pairedSyncDidStart
{
  v60 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self watchSyncStateMap];
  v4 = [v3 count];

  if (v4)
  {
    objc_initWeak(&location, self);
    v52 = 0u;
    v53 = 0u;
    v50 = 0u;
    v51 = 0u;
    v5 = [(HMDHomeManager *)self watchSyncStateMap];
    obj = [v5 copy];

    v6 = [obj countByEnumeratingWithState:&v50 objects:v59 count:16];
    if (v6)
    {
      v42 = 0;
      v44 = *v51;
      do
      {
        v45 = v6;
        for (i = 0; i != v45; ++i)
        {
          if (*v51 != v44)
          {
            objc_enumerationMutation(obj);
          }

          v8 = *(*(&v50 + 1) + 8 * i);
          v9 = [(HMDHomeManager *)self watchSyncStateMap];
          v10 = [v9 objectForKeyedSubscript:v8];

          v11 = [v10 currentSync];
          if ([v11 inProgress])
          {
            v12 = objc_autoreleasePoolPush();
            v13 = self;
            v14 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
            {
              v15 = HMFGetLogIdentifier();
              *buf = 138543618;
              v56 = v15;
              v57 = 2112;
              v58 = v11;
              _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@%@ is in progress", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v12);
          }

          else
          {
            aBlock[0] = MEMORY[0x277D85DD0];
            aBlock[1] = 3221225472;
            aBlock[2] = __37__HMDHomeManager__pairedSyncDidStart__block_invoke;
            aBlock[3] = &unk_279732760;
            aBlock[4] = self;
            v16 = v11;
            v47 = v16;
            v48 = v8;
            objc_copyWeak(&v49, &location);
            v17 = _Block_copy(aBlock);
            v18 = [(HMDHomeManager *)self associatedWatchPeers];
            [v18 removeObjectForKey:v8];

            v19 = [v16 syncOption];
            if (v19 == 1)
            {
              [v16 setInProgress:1];
              v24 = objc_autoreleasePoolPush();
              v25 = self;
              v26 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
              {
                v27 = HMFGetLogIdentifier();
                *buf = 138543618;
                v56 = v27;
                v57 = 2112;
                v58 = v8;
                _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Starting complete sync for %@", buf, 0x16u);
              }

              objc_autoreleasePoolPop(v24);
              [(HMDHomeManager *)v25 _sendKeysToWatch:v8 completionHandler:v17];
            }

            else if (v19 == 2)
            {
              [v16 setInProgress:1];
              v20 = objc_autoreleasePoolPush();
              v21 = self;
              v22 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
              {
                v23 = HMFGetLogIdentifier();
                *buf = 138543618;
                v56 = v23;
                v57 = 2112;
                v58 = v8;
                _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Starting partial sync for %@", buf, 0x16u);
              }

              objc_autoreleasePoolPop(v20);
              [(HMDHomeManager *)v21 _addWatch:v8 completionHandler:v17];
            }

            else
            {
              v28 = objc_autoreleasePoolPush();
              v29 = self;
              v30 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
              {
                v31 = HMFGetLogIdentifier();
                v32 = [v16 syncOption];
                *buf = 138543618;
                v56 = v31;
                v57 = 2048;
                v58 = v32;
                _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Unknown option %tu", buf, 0x16u);
              }

              objc_autoreleasePoolPop(v28);
              v42 = 1;
            }

            objc_destroyWeak(&v49);
          }
        }

        v6 = [obj countByEnumeratingWithState:&v50 objects:v59 count:16];
      }

      while (v6);

      if (v42)
      {
        v33 = objc_autoreleasePoolPush();
        v34 = self;
        v35 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
        {
          v36 = HMFGetLogIdentifier();
          *buf = 138543362;
          v56 = v36;
          _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_INFO, "%{public}@Notifying PairedSync that sync is done", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v33);
        [(HMDPairedSync *)v34->_pairedSync syncComplete];
      }
    }

    else
    {
    }

    objc_destroyWeak(&location);
  }

  else
  {
    v37 = objc_autoreleasePoolPush();
    v38 = self;
    v39 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
    {
      v40 = HMFGetLogIdentifier();
      *buf = 138543362;
      v56 = v40;
      _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Notifying PairedSync that sync is done", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v37);
    [(HMDPairedSync *)v38->_pairedSync syncComplete];
  }

  v41 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__pairedSyncDidStart__block_invoke(uint64_t a1, int a2, void *a3)
{
  v66 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 32);
  v8 = HMFGetOSLogHandle();
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_INFO);
  if (a2)
  {
    if (!v9)
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    v11 = *(a1 + 40);
    v12 = *(a1 + 48);
    *v63 = 138543874;
    *&v63[4] = v10;
    *&v63[12] = 2112;
    *&v63[14] = v11;
    *&v63[22] = 2112;
    v64 = v12;
    v13 = "%{public}@Successfully completed paired sync: %@ for watch: %@";
    v14 = v8;
    v15 = 32;
  }

  else
  {
    if (!v9)
    {
      goto LABEL_7;
    }

    v10 = HMFGetLogIdentifier();
    v16 = *(a1 + 40);
    v17 = *(a1 + 48);
    *v63 = 138544130;
    *&v63[4] = v10;
    *&v63[12] = 2112;
    *&v63[14] = v16;
    *&v63[22] = 2112;
    v64 = v17;
    LOWORD(v65) = 2112;
    *(&v65 + 2) = v5;
    v13 = "%{public}@Failed to complete paired sync: %@ for watch: %@:%@";
    v14 = v8;
    v15 = 42;
  }

  _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, v13, v63, v15);

LABEL_7:
  objc_autoreleasePoolPop(v6);
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v19 = [WeakRetained watchSyncStateMap];
  v20 = [v19 objectForKeyedSubscript:*(a1 + 48)];

  if (v20)
  {
    if ([v20 removeSync])
    {
      v21 = [v20 currentSync];
      v22 = [*(a1 + 40) syncOption];
      if (v22 == [v21 syncOption])
      {
        v23 = 0;
      }

      else
      {
        v23 = !+[HMDWatchSyncState isNewBetter:present:](HMDWatchSyncState, "isNewBetter:present:", [*(a1 + 40) syncOption], objc_msgSend(v21, "syncOption"));
      }

      v29 = objc_autoreleasePoolPush();
      v30 = *(a1 + 32);
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        *v63 = 138543362;
        *&v63[4] = v32;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@There are more options remaining, restarting the paired sync", v63, 0xCu);
      }

      objc_autoreleasePoolPop(v29);
      [*(a1 + 32) _pairedSyncDidStart];
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      v25 = *(a1 + 32);
      v26 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
      {
        v27 = HMFGetLogIdentifier();
        v28 = *(a1 + 48);
        *v63 = 138543618;
        *&v63[4] = v27;
        *&v63[12] = 2112;
        *&v63[14] = v28;
        _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Removing %@ from watch sync state", v63, 0x16u);
      }

      objc_autoreleasePoolPop(v24);
      v21 = [WeakRetained watchSyncStateMap];
      [v21 removeObjectForKey:*(a1 + 48)];
      v23 = 1;
    }

    v33 = [*(a1 + 32) watchSyncRetryContextBySyncIdentifier];
    v34 = [*(a1 + 40) identifier];
    v35 = [v33 objectForKeyedSubscript:v34];

    if (v23 && [v5 code] == 8)
    {
      v36 = [*(a1 + 32) watchSyncRetryContextBySyncIdentifier];
      v37 = [*(a1 + 40) identifier];
      [v36 setObject:0 forKeyedSubscript:v37];

      if (v35)
      {
        v38 = [v35 retryAttempt] + 1;
      }

      else
      {
        v38 = 0;
      }

      v46 = [HMDWatchSyncRetryContext createWithWatchIdentifier:*(a1 + 48) watchSync:*(a1 + 40) retryAttempt:v38, *v63, *&v63[16], v64, v65];

      if (v46)
      {
        v47 = [*(a1 + 32) watchSyncRetryContextBySyncIdentifier];
        v48 = [*(a1 + 40) identifier];
        [v47 setObject:v46 forKeyedSubscript:v48];

        v49 = objc_alloc(MEMORY[0x277D0F920]);
        [v46 retryInterval];
        v50 = [v49 initWithTimeInterval:0 options:?];
        [v50 setDelegate:*(a1 + 32)];
        v51 = [*(a1 + 32) workQueue];
        [v50 setDelegateQueue:v51];

        v52 = [*(a1 + 32) watchSyncRetryContextByRetryTimer];
        [v52 setObject:v46 forKey:v50];

        [v50 resume];
        v53 = objc_autoreleasePoolPush();
        v54 = *(a1 + 32);
        v55 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v55, OS_LOG_TYPE_INFO))
        {
          v56 = HMFGetLogIdentifier();
          *v63 = 138543874;
          *&v63[4] = v56;
          *&v63[12] = 2112;
          *&v63[14] = v50;
          *&v63[22] = 2112;
          v64 = v46;
          _os_log_impl(&dword_2531F8000, v55, OS_LOG_TYPE_INFO, "%{public}@Started retry timer for watch sync retry context %@:%@", v63, 0x20u);
        }

        objc_autoreleasePoolPop(v53);
      }

      else
      {
        v57 = objc_autoreleasePoolPush();
        v58 = *(a1 + 32);
        v59 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v59, OS_LOG_TYPE_INFO))
        {
          v60 = HMFGetLogIdentifier();
          v61 = *(a1 + 40);
          *v63 = 138543618;
          *&v63[4] = v60;
          *&v63[12] = 2112;
          *&v63[14] = v61;
          _os_log_impl(&dword_2531F8000, v59, OS_LOG_TYPE_INFO, "%{public}@Finished retrying watch sync: %@", v63, 0x16u);
        }

        objc_autoreleasePoolPop(v57);
      }
    }

    else if (v35)
    {
      v39 = objc_autoreleasePoolPush();
      v40 = *(a1 + 32);
      v41 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
      {
        v42 = HMFGetLogIdentifier();
        v43 = *(a1 + 40);
        *v63 = 138543618;
        *&v63[4] = v42;
        *&v63[12] = 2112;
        *&v63[14] = v43;
        _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_INFO, "%{public}@Resetting retry context for watch sync: %@", v63, 0x16u);
      }

      objc_autoreleasePoolPop(v39);
      v44 = [*(a1 + 32) watchSyncRetryContextBySyncIdentifier];
      v45 = [*(a1 + 40) identifier];
      [v44 setObject:0 forKeyedSubscript:v45];
    }
  }

  v62 = *MEMORY[0x277D85DE8];
}

- (void)pairedSyncDidStart:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __37__HMDHomeManager_pairedSyncDidStart___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

- (void)_addSyncOperation:(id)a3 forWatchWithIdentifier:(id)a4
{
  v67 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v47 = v7;
  if (([v6 isRetry] & 1) == 0)
  {
    v57 = 0u;
    v58 = 0u;
    v55 = 0u;
    v56 = 0u;
    v8 = [(HMDHomeManager *)self watchSyncRetryContextBySyncIdentifier];
    v9 = [v8 copy];

    v7 = v47;
    obj = v9;
    v50 = [v9 countByEnumeratingWithState:&v55 objects:v66 count:16];
    if (!v50)
    {
      goto LABEL_26;
    }

    v49 = *v56;
    *&v10 = 138543874;
    v44 = v10;
    v45 = self;
    v46 = v6;
    while (1)
    {
      for (i = 0; i != v50; ++i)
      {
        if (*v56 != v49)
        {
          objc_enumerationMutation(obj);
        }

        v12 = *(*(&v55 + 1) + 8 * i);
        v13 = [(HMDHomeManager *)self watchSyncRetryContextBySyncIdentifier];
        v14 = [v13 objectForKeyedSubscript:v12];

        v15 = [v14 watchIdentifier];
        v16 = [v15 isEqual:v7];

        if (v16)
        {
          v17 = [v6 syncOption];
          v18 = [v14 watchSync];
          if (v17 == [v18 syncOption])
          {
          }

          else
          {
            v19 = [v6 syncOption];
            v20 = [v14 watchSync];
            v21 = +[HMDWatchSyncState isNewBetter:present:](HMDWatchSyncState, "isNewBetter:present:", v19, [v20 syncOption]);

            if (!v21)
            {
              goto LABEL_24;
            }
          }

          v22 = objc_autoreleasePoolPush();
          v23 = self;
          v24 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
          {
            v25 = HMFGetLogIdentifier();
            *buf = v44;
            v61 = v25;
            v62 = 2112;
            v63 = v14;
            v64 = 2112;
            v65 = v6;
            _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Resetting retry context: %@ because a new operation got scheduled: %@", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v22);
          v26 = [(HMDHomeManager *)v23 watchSyncRetryContextBySyncIdentifier];
          [v26 setObject:0 forKeyedSubscript:v12];

          v53 = 0u;
          v54 = 0u;
          v51 = 0u;
          v52 = 0u;
          v27 = [(HMDHomeManager *)v23 watchSyncRetryContextByRetryTimer];
          v28 = [v27 copy];

          v29 = [v28 countByEnumeratingWithState:&v51 objects:v59 count:16];
          if (v29)
          {
            v30 = v29;
            v31 = *v52;
            while (2)
            {
              for (j = 0; j != v30; ++j)
              {
                if (*v52 != v31)
                {
                  objc_enumerationMutation(v28);
                }

                v33 = *(*(&v51 + 1) + 8 * j);
                v34 = [(HMDHomeManager *)v23 watchSyncRetryContextByRetryTimer];
                v35 = [v34 objectForKey:v33];

                if (v35 == v14)
                {
                  v36 = [(HMDHomeManager *)v23 watchSyncRetryContextByRetryTimer];
                  [v36 removeObjectForKey:v33];

                  goto LABEL_23;
                }
              }

              v30 = [v28 countByEnumeratingWithState:&v51 objects:v59 count:16];
              if (v30)
              {
                continue;
              }

              break;
            }
          }

LABEL_23:

          v6 = v46;
          v7 = v47;
          self = v45;
        }

LABEL_24:
      }

      v50 = [obj countByEnumeratingWithState:&v55 objects:v66 count:16];
      if (!v50)
      {
LABEL_26:

        break;
      }
    }
  }

  [(HMDHomeManager *)self watchSyncStateMap];
  v38 = v37 = self;
  v39 = [v38 objectForKeyedSubscript:v7];

  if (!v39)
  {
    v40 = [HMDWatchSyncState alloc];
    v41 = [(HMDHomeManager *)v37 pairedSync];
    v39 = [(HMDWatchSyncState *)v40 initWithDeviceId:v47 pairedSync:v41];

    v7 = v47;
    v42 = [(HMDHomeManager *)v37 watchSyncStateMap];
    [v42 setObject:v39 forKeyedSubscript:v47];
  }

  [(HMDWatchSyncState *)v39 addNewSync:v6];

  v43 = *MEMORY[0x277D85DE8];
}

- (void)_addSyncOperation:(id)a3
{
  v31 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    *buf = 138543618;
    v28 = v7;
    v29 = 2112;
    v30 = v4;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@New sync state dictionary: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = [(HMDHomeManager *)self watchSyncStateMap];
    *buf = 138543618;
    v28 = v10;
    v29 = 2112;
    v30 = v11;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Current sync state dictionary: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v24 = 0u;
  v25 = 0u;
  v22 = 0u;
  v23 = 0u;
  v12 = v4;
  v13 = [v12 countByEnumeratingWithState:&v22 objects:v26 count:16];
  if (v13)
  {
    v14 = v13;
    v15 = *v23;
    do
    {
      for (i = 0; i != v14; ++i)
      {
        if (*v23 != v15)
        {
          objc_enumerationMutation(v12);
        }

        v17 = *(*(&v22 + 1) + 8 * i);
        v18 = [v12 objectForKeyedSubscript:{v17, v22}];
        v19 = [v18 unsignedIntegerValue];

        v20 = [[HMDWatchSync alloc] initWithSyncOption:v19];
        [(HMDHomeManager *)self _addSyncOperation:v20 forWatchWithIdentifier:v17];
      }

      v14 = [v12 countByEnumeratingWithState:&v22 objects:v26 count:16];
    }

    while (v14);
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_checkAndAddWatchDevices:(id)a3 resend:(BOOL)a4 requestFromWatch:(BOOL)a5
{
  v48 = a5;
  v5 = a4;
  v71 = *MEMORY[0x277D85DE8];
  v7 = a3;
  v8 = objc_autoreleasePoolPush();
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138543618;
    v68 = v10;
    v69 = 2112;
    v70 = v7;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Found watches: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
  v11 = [MEMORY[0x277CBEB18] array];
  v51 = [MEMORY[0x277CBEB38] dictionary];
  v60 = 0u;
  v61 = 0u;
  v62 = 0u;
  v63 = 0u;
  obj = v7;
  v12 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
  if (v12)
  {
    v13 = v12;
    v14 = *v61;
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v61 != v14)
        {
          objc_enumerationMutation(obj);
        }

        v16 = [*(*(&v60 + 1) + 8 * i) remoteDestinationString];
        if (v5)
        {
          [v51 setObject:&unk_28662A2E0 forKeyedSubscript:v16];
          v17 = objc_autoreleasePoolPush();
          v18 = HMFGetOSLogHandle();
          if (!os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
          {
            goto LABEL_20;
          }

          v19 = HMFGetLogIdentifier();
          *buf = 138543618;
          v68 = v19;
          v69 = 2112;
          v70 = v16;
          v20 = v18;
          v21 = "%{public}@Need to send complete config to watch %@";
        }

        else
        {
          v22 = [(HMDHomeManager *)self associatedWatchPeers];
          v23 = [v22 objectForKey:v16];

          if (v23)
          {
            if (v48)
            {
              [v51 setObject:&unk_28662A2F8 forKeyedSubscript:v16];
              v17 = objc_autoreleasePoolPush();
              v18 = HMFGetOSLogHandle();
              if (!os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
              {
                goto LABEL_20;
              }

              v19 = HMFGetLogIdentifier();
              *buf = 138543618;
              v68 = v19;
              v69 = 2112;
              v70 = v16;
              v20 = v18;
              v21 = "%{public}@Watch %@ has asked to resend the home config";
            }

            else
            {
              v17 = objc_autoreleasePoolPush();
              v18 = HMFGetOSLogHandle();
              if (!os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
              {
                goto LABEL_20;
              }

              v19 = HMFGetLogIdentifier();
              *buf = 138543618;
              v68 = v19;
              v69 = 2112;
              v70 = v16;
              v20 = v18;
              v21 = "%{public}@Watch %@ is already associated";
            }
          }

          else
          {
            [v51 setObject:&unk_28662A2F8 forKeyedSubscript:v16];
            v17 = objc_autoreleasePoolPush();
            v18 = HMFGetOSLogHandle();
            if (!os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
            {
              goto LABEL_20;
            }

            v19 = HMFGetLogIdentifier();
            *buf = 138543618;
            v68 = v19;
            v69 = 2112;
            v70 = v16;
            v20 = v18;
            v21 = "%{public}@Discovered watch %@, checking its config";
          }
        }

        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, v21, buf, 0x16u);

LABEL_20:
        objc_autoreleasePoolPop(v17);
        [v11 addObject:v16];
      }

      v13 = [obj countByEnumeratingWithState:&v60 objects:v66 count:16];
    }

    while (v13);
  }

  v24 = [(HMDHomeManager *)self associatedWatchPeers];
  v25 = [v24 copy];

  v58 = 0u;
  v59 = 0u;
  v56 = 0u;
  v57 = 0u;
  v26 = v25;
  v27 = [v26 countByEnumeratingWithState:&v56 objects:v65 count:16];
  if (v27)
  {
    v28 = v27;
    v29 = *v57;
    do
    {
      for (j = 0; j != v28; ++j)
      {
        if (*v57 != v29)
        {
          objc_enumerationMutation(v26);
        }

        v31 = *(*(&v56 + 1) + 8 * j);
        if (([v11 containsObject:v31] & 1) == 0)
        {
          v32 = objc_autoreleasePoolPush();
          v33 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
          {
            v34 = HMFGetLogIdentifier();
            *buf = 138543618;
            v68 = v34;
            v69 = 2112;
            v70 = v31;
            _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_INFO, "%{public}@Watch %@ is no longer associated with this device", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v32);
          v35 = [(HMDHomeManager *)self associatedWatchPeers];
          [v35 removeObjectForKey:v31];
        }
      }

      v28 = [v26 countByEnumeratingWithState:&v56 objects:v65 count:16];
    }

    while (v28);
  }

  v49 = v26;

  v54 = 0u;
  v55 = 0u;
  v52 = 0u;
  v53 = 0u;
  v36 = [(HMDHomeManager *)self watchSyncStateMap];
  v37 = [v36 copy];

  v38 = [v37 countByEnumeratingWithState:&v52 objects:v64 count:16];
  if (v38)
  {
    v39 = v38;
    v40 = *v53;
    do
    {
      for (k = 0; k != v39; ++k)
      {
        if (*v53 != v40)
        {
          objc_enumerationMutation(v37);
        }

        v42 = *(*(&v52 + 1) + 8 * k);
        if (([v11 containsObject:v42] & 1) == 0)
        {
          v43 = objc_autoreleasePoolPush();
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
          {
            v45 = HMFGetLogIdentifier();
            *buf = 138543618;
            v68 = v45;
            v69 = 2112;
            v70 = v42;
            _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_INFO, "%{public}@Watch %@ is not paired with this device anymore. Taking it off the sync state list", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v43);
          v46 = [(HMDHomeManager *)self watchSyncStateMap];
          [v46 removeObjectForKey:v42];
        }
      }

      v39 = [v37 countByEnumeratingWithState:&v52 objects:v64 count:16];
    }

    while (v39);
  }

  [(HMDHomeManager *)self _addSyncOperation:v51];
  v47 = *MEMORY[0x277D85DE8];
}

- (void)controllerKeyPairGenerated:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __45__HMDHomeManager_controllerKeyPairGenerated___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

uint64_t __45__HMDHomeManager_controllerKeyPairGenerated___block_invoke(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v4;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Controller key pair has been generated, sending them over to watch", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 32) _checkAndAddWatchDevicesWithResend:1];
  v6 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_handleAreYouAtHome:(id)a3
{
  v46 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:*MEMORY[0x277CD0640]];
  v6 = [v4 stringForKey:@"kRemoteSessionIdentifierKey"];
  v7 = v6;
  if (v5)
  {
    v8 = v6 == 0;
  }

  else
  {
    v8 = 1;
  }

  if (!v8)
  {
    v15 = [(HMDHomeManager *)self _homeWithUUID:v5];
    v16 = objc_autoreleasePoolPush();
    v17 = self;
    v18 = HMFGetOSLogHandle();
    v19 = os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT);
    if (v15)
    {
      if (v19)
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543618;
        v43 = v20;
        v44 = 2112;
        v45 = v15;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@Received request to determine if we are at home: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v16);
      v21 = [v15 homeLocation];
      v22 = [v4 responseHandler];

      if (v22)
      {
        v23 = [MEMORY[0x277CCABB0] numberWithBool:{v21 == 1, @"kAtHomeStateKey"}];
        v41[0] = v23;
        v40[1] = @"kDeviceNameKey";
        v24 = deviceName();
        v40[2] = @"kRemoteSessionIdentifierKey";
        v41[1] = v24;
        v41[2] = v7;
        v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v41 forKeys:v40 count:3];

        v26 = [v4 responseHandler];
        (v26)[2](v26, 0, v25);
      }

      v27 = [v4 destination];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v28 = v27;
      }

      else
      {
        v28 = 0;
      }

      v14 = v28;

      if (v21 != 1 || !v14)
      {
        goto LABEL_28;
      }

      v29 = objc_autoreleasePoolPush();
      v30 = v17;
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        v33 = [v14 device];
        *buf = 138543618;
        v43 = v32;
        v44 = 2112;
        v45 = v33;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@This device can act as remote gateway for peer, requesting reverse connection to device: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v29);
      v34 = [(HMDHomeManager *)v30 messageDispatcher];
      v35 = [v34 secureRemoteTransport];
      v36 = [v14 device];
      [v35 openSecureSessionToDevice:v36 completionHandler:&__block_literal_global_1339];
    }

    else
    {
      if (v19)
      {
        v37 = HMFGetLogIdentifier();
        *buf = 138543618;
        v43 = v37;
        v44 = 2112;
        v45 = v5;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot find home: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v16);
      v38 = [v4 responseHandler];

      if (!v38)
      {
        v15 = 0;
        goto LABEL_29;
      }

      v14 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v34 = [v4 responseHandler];
      (v34)[2](v34, v14, 0);
    }

LABEL_28:
LABEL_29:

    goto LABEL_30;
  }

  v9 = objc_autoreleasePoolPush();
  v10 = self;
  v11 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
  {
    v12 = HMFGetLogIdentifier();
    *buf = 138543618;
    v43 = v12;
    v44 = 2112;
    v45 = v4;
    _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for message %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  v13 = [v4 responseHandler];

  if (v13)
  {
    v15 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    v14 = [v4 responseHandler];
    (*(v14 + 2))(v14, v15, 0);
    goto LABEL_28;
  }

LABEL_30:

  v39 = *MEMORY[0x277D85DE8];
}

void __38__HMDHomeManager__handleAreYouAtHome___block_invoke(uint64_t a1, void *a2)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = a2;
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543618;
    v8 = v5;
    v9 = 2112;
    v10 = v2;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Setup a reverse connection to client that requested remote access with error: %@", &v7, 0x16u);
  }

  objc_autoreleasePoolPop(v3);
  v6 = *MEMORY[0x277D85DE8];
}

- (BOOL)_handleControllerKeyAvailable
{
  v36 = *MEMORY[0x277D85DE8];
  if (isWatch())
  {
    v3 = 0;
  }

  else
  {
    v4 = [MEMORY[0x277CFEC78] systemStore];
    v28 = 0;
    v29 = 0;
    v27 = 0;
    [v4 getCurrentiCloudIdentifier:&v29 controllerPairingIdentifier:&v28 error:&v27];
    v5 = v29;
    v6 = v28;
    v7 = v27;
    v25 = v7;
    v26 = 0;
    v8 = [v4 getControllerPublicKey:0 secretKey:0 username:&v26 allowCreation:0 error:&v25];
    v9 = v26;
    v10 = v25;

    v3 = 0;
    if (v8)
    {
      v11 = [v9 isEqualToString:v6];
      v12 = [(HMDHomeManager *)self activeAccountIdentifier];
      v13 = v12;
      if (v12 && (![v12 isEqualToString:v5] || (objc_msgSend(v9, "isEqualToString:", v6) & 1) == 0))
      {
        v14 = objc_autoreleasePoolPush();
        v15 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v16 = v22 = v14;
          *buf = 138543874;
          v31 = v16;
          v32 = 2112;
          v33 = v13;
          v34 = 2112;
          v35 = v9;
          _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Updating to the current iCloud controller identifier %@ and pairing user name %@", buf, 0x20u);

          v14 = v22;
        }

        objc_autoreleasePoolPop(v14);
        v24 = 0;
        [v4 updateCurrentiCloudIdentifier:v13 controllerPairingIdentifier:v9 error:&v24];
      }

      v3 = v11 ^ 1;
      if ((v11 & 1) == 0)
      {
        v17 = objc_autoreleasePoolPush();
        v18 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v19 = v23 = v17;
          *buf = 138543362;
          v31 = v19;
          _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Controller user name changed, re-adding the watch", buf, 0xCu);

          v17 = v23;
        }

        objc_autoreleasePoolPop(v17);
        [(HMDHomeManager *)self _checkAndAddWatchDevicesWithResend:1];
      }
    }
  }

  v20 = *MEMORY[0x277D85DE8];
  return v3;
}

- (void)cloudHomeSettingsUpdated:(id)a3
{
  v4 = a3;
  v5 = +[HMDAppleAccountSettings sharedSettings];
  v6 = [v5 isHomeEnabled];

  v7 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __43__HMDHomeManager_cloudHomeSettingsUpdated___block_invoke;
  block[3] = &unk_279734938;
  v11 = v6;
  block[4] = self;
  v10 = v4;
  v8 = v4;
  dispatch_async(v7, block);
}

void __43__HMDHomeManager_cloudHomeSettingsUpdated___block_invoke(uint64_t a1)
{
  v34 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = v5;
    v7 = "not ";
    if (*(a1 + 48))
    {
      v7 = "";
    }

    *buf = 138543618;
    v31 = v5;
    v32 = 2080;
    v33 = v7;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@HomeKit iCloud data class switch was modified to %senabled", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v8 = [*(a1 + 32) cloudDataSyncStateFilter];
  [v8 updateiCloudSwitchState:*(a1 + 48)];

  if ([*(a1 + 32) accountActive])
  {
    if (*(a1 + 48) == 1)
    {
      v9 = [*(a1 + 40) userInfo];
      v10 = [v9 hmf_numberForKey:@"kIsUserInitiated"];
      v11 = [v10 BOOLValue];

      if (v11)
      {
        v12 = [*(a1 + 32) syncManager];
        [v12 pause];

        objc_initWeak(buf, *(a1 + 32));
        v13 = [*(a1 + 32) cloudDataSyncManager];
        v28[0] = MEMORY[0x277D85DD0];
        v28[1] = 3221225472;
        v28[2] = __43__HMDHomeManager_cloudHomeSettingsUpdated___block_invoke_1337;
        v28[3] = &unk_279734708;
        objc_copyWeak(&v29, buf);
        [v13 resetCloudCache:v28];

        objc_destroyWeak(&v29);
        objc_destroyWeak(buf);
      }

      [*(a1 + 32) _updateCloudDataSyncWithAccountState:{objc_msgSend(*(a1 + 32), "accountActive")}];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 32);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
      {
        v17 = HMFGetLogIdentifier();
        *buf = 138543362;
        v31 = v17;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Posting notification kCloudServerTokenDataResetNotification to clear server token data because iCloud switch is disabled", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v14);
      v18 = [*(a1 + 32) notificationCenter];
      [v18 postNotificationName:@"kCloudServerTokenDataResetNotification" object:*(a1 + 32)];

      v19 = [*(a1 + 40) userInfo];
      v20 = [v19 hmf_numberForKey:@"kIsUserInitiated"];
      v21 = [v20 BOOLValue];

      if (v21)
      {
        v22 = +[HMDBackingStore resetBackingStore];
        if (v22)
        {
          v23 = objc_autoreleasePoolPush();
          v24 = *(a1 + 32);
          v25 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
          {
            v26 = HMFGetLogIdentifier();
            *buf = 138543618;
            v31 = v26;
            v32 = 2112;
            v33 = v22;
            _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_ERROR, "%{public}@BackingStore reset finished with error: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v23);
        }
      }
    }
  }

  v27 = *MEMORY[0x277D85DE8];
}

void __43__HMDHomeManager_cloudHomeSettingsUpdated___block_invoke_1337(uint64_t a1, uint64_t a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v3 = [WeakRetained syncManager];
  [v3 cancelOperations];

  v4 = [WeakRetained syncManager];
  [v4 resume];

  if (!a2)
  {
    [WeakRetained updateAccountAvailabilityChanged:0];
  }
}

- (void)_handleUpdateiCloudSwitchState:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __49__HMDHomeManager__handleUpdateiCloudSwitchState___block_invoke;
  aBlock[3] = &unk_2797338E8;
  objc_copyWeak(&v13, &location);
  v5 = v4;
  v12 = v5;
  v6 = _Block_copy(aBlock);
  v10 = 0;
  v7 = [v5 BOOLForKey:@"kiCloudSwitchStateKey" keyPresent:&v10];
  if (v10 == 1 && (v8 = v7, [(HMDHomeManager *)self accountActive]))
  {
    v9 = +[HMDAppleAccountSettings sharedSettings];
    [v9 updateHomeEnabled:v8 completionHandler:v6];
  }

  else
  {
    v9 = +[HMDAppleAccountSettings sharedSettings];
    [v9 updateHomeEnabled:0 completionHandler:v6];
  }

  objc_destroyWeak(&v13);
  objc_destroyWeak(&location);
}

void __49__HMDHomeManager__handleUpdateiCloudSwitchState___block_invoke(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (v3)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      v12 = 138543618;
      v13 = v8;
      v14 = 2112;
      v15 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to update iCloud state with error: %@", &v12, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = [*(a1 + 32) responseHandler];

  if (v9)
  {
    v10 = [*(a1 + 32) responseHandler];
    (v10)[2](v10, v3, 0);
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_handleQueryiCloudSwitchState:(id)a3
{
  v11[1] = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = +[HMDAppleAccountSettings sharedSettings];
  v5 = [v4 isHomeEnabled];

  v6 = [v3 responseHandler];

  v10 = @"kiCloudSwitchStateKey";
  v7 = [MEMORY[0x277CCABB0] numberWithBool:v5];
  v11[0] = v7;
  v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v11 forKeys:&v10 count:1];
  (v6)[2](v6, 0, v8);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_auditDuplicatePreviouslyAddedAccessory:(id)a3
{
  v4 = a3;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = v4;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;
  v7 = v4;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v8 = v7;
  }

  else
  {
    v8 = 0;
  }

  v9 = v8;

  if (v6 | v9)
  {
    v10 = dispatch_time(0, 60000000000);
    v11 = [(HMDHomeManager *)self workQueue];
    v12[0] = MEMORY[0x277D85DD0];
    v12[1] = 3221225472;
    v12[2] = __58__HMDHomeManager__auditDuplicatePreviouslyAddedAccessory___block_invoke;
    v12[3] = &unk_279734870;
    v12[4] = self;
    v13 = v7;
    v14 = v6;
    v15 = v9;
    dispatch_after(v10, v11, v12);
  }
}

void __58__HMDHomeManager__auditDuplicatePreviouslyAddedAccessory___block_invoke(uint64_t a1)
{
  v80 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v57 = a1;
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v71 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Auditing accessories", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = a1;
  v7 = [*(a1 + 40) home];

  if (v7)
  {
    v68 = 0u;
    v69 = 0u;
    v66 = 0u;
    v67 = 0u;
    obj = [*(a1 + 32) homes];
    v8 = [obj countByEnumeratingWithState:&v66 objects:v79 count:16];
    if (!v8)
    {
      goto LABEL_43;
    }

    v10 = v8;
    v11 = *v67;
    *&v9 = 138544130;
    v54 = v9;
    v55 = *v67;
    while (1)
    {
      v12 = 0;
      v56 = v10;
      do
      {
        if (*v67 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v66 + 1) + 8 * v12);
        if (![v13 isOwnerUser])
        {
          goto LABEL_41;
        }

        v64 = 0u;
        v65 = 0u;
        v62 = 0u;
        v63 = 0u;
        v14 = [v13 accessories];
        v15 = [v14 countByEnumeratingWithState:&v62 objects:v78 count:16];
        if (!v15)
        {
LABEL_40:

          goto LABEL_41;
        }

        v16 = v15;
        v17 = *v63;
        v59 = v12;
        v60 = *v63;
LABEL_12:
        v18 = 0;
        v61 = v16;
        while (1)
        {
          if (*v63 != v17)
          {
            objc_enumerationMutation(v14);
          }

          v19 = *(*(&v62 + 1) + 8 * v18);
          v20 = *(v6 + 48);
          if (!v20)
          {
            goto LABEL_20;
          }

          v21 = [v20 serialNumber];
          if (!v21)
          {
            goto LABEL_20;
          }

          v22 = v21;
          v23 = v14;
          [*(v6 + 48) uuid];
          v25 = v24 = v6;
          v26 = [v19 uuid];
          if (![v25 hmf_isEqualToUUID:v26])
          {
            break;
          }

          v14 = v23;
          v6 = v24;
          v17 = v60;
          v16 = v61;
LABEL_20:
          v30 = *(v6 + 56);
          if (v30)
          {
            v31 = v19 == v30;
          }

          else
          {
            v31 = 1;
          }

          if (!v31)
          {
            v32 = v19;
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v33 = v32;
            }

            else
            {
              v33 = 0;
            }

            v34 = v33;

            if (v34)
            {
              v35 = [*(v6 + 56) identifier];
              v36 = [v34 identifier];
              v37 = [v35 isEqual:v36];

              if (v37)
              {
                v38 = objc_autoreleasePoolPush();
                v39 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v39, OS_LOG_TYPE_INFO))
                {
                  v40 = HMFGetLogIdentifier();
                  v41 = *(v57 + 56);
                  v42 = [v41 identifier];
                  *buf = v54;
                  v71 = v40;
                  v72 = 2112;
                  v73 = v34;
                  v74 = 2112;
                  v75 = v41;
                  v76 = 2112;
                  v77 = v42;
                  _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Found an existing media accessory (%@) match the newly added hap accessory (%@) with device identifier %@, trying to remove it.", buf, 0x2Au);
                }

                objc_autoreleasePoolPop(v38);
                v11 = v55;
                v10 = v56;
                v12 = v59;
                v6 = v57;
LABEL_39:
                [v32 sendRemovalRequest];
                v14 = v32;
                goto LABEL_40;
              }
            }
          }

          if (v16 == ++v18)
          {
            v16 = [v14 countByEnumeratingWithState:&v62 objects:v78 count:16];
            if (v16)
            {
              goto LABEL_12;
            }

            v11 = v55;
            v10 = v56;
            v12 = v59;
            goto LABEL_40;
          }
        }

        v27 = [*(v24 + 48) serialNumber];
        v28 = [v19 serialNumber];
        v29 = [v27 isEqual:v28];

        v14 = v23;
        v6 = v24;
        v17 = v60;
        v16 = v61;
        if (!v29)
        {
          goto LABEL_20;
        }

        v43 = objc_autoreleasePoolPush();
        v44 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
        {
          v45 = HMFGetLogIdentifier();
          v46 = *(v57 + 48);
          v47 = [v46 serialNumber];
          *buf = v54;
          v71 = v45;
          v72 = 2112;
          v73 = v19;
          v74 = 2112;
          v75 = v46;
          v76 = 2112;
          v77 = v47;
          _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_INFO, "%{public}@Found an existing accessory (%@) match the newly added accessory (%@) with serialNumber %@, trying to remove it.", buf, 0x2Au);
        }

        objc_autoreleasePoolPop(v43);
        v32 = v19;

        v11 = v55;
        v10 = v56;
        v12 = v59;
        v6 = v57;
        if (v32)
        {
          goto LABEL_39;
        }

LABEL_41:
        ++v12;
      }

      while (v12 != v10);
      v10 = [obj countByEnumeratingWithState:&v66 objects:v79 count:16];
      if (!v10)
      {
LABEL_43:

        goto LABEL_47;
      }
    }
  }

  v48 = objc_autoreleasePoolPush();
  v49 = *(a1 + 32);
  v50 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v50, OS_LOG_TYPE_ERROR))
  {
    v51 = HMFGetLogIdentifier();
    v52 = *(a1 + 40);
    *buf = 138543618;
    v71 = v51;
    v72 = 2112;
    v73 = v52;
    _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_ERROR, "%{public}@Skipping audit as accessory (%@) or home has been removed", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v48);
LABEL_47:
  v53 = *MEMORY[0x277D85DE8];
}

- (void)auditDuplicatePreviouslyAddedAccessory:(id)a3
{
  v4 = [a3 userInfo];
  v5 = [v4 objectForKeyedSubscript:@"HMDAccessoryNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v6 = v5;
  }

  else
  {
    v6 = 0;
  }

  v7 = v6;

  [(HMDHomeManager *)self _auditDuplicatePreviouslyAddedAccessory:v7];
}

- (void)_handleRetrieveVendorIdentifier:(id)a3
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = [v3 responseHandler];

  if (v4)
  {
    v5 = [v3 stringForKey:@"kCompanionApplicationIdentifierKey"];
    if (!v5)
    {
      goto LABEL_8;
    }

    v6 = +[HMDApplicationVendorIDStore sharedStore];
    v7 = [v6 vendorIDForApplicationBundleID:v5];

    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543874;
      v21 = v10;
      v22 = 2112;
      v23 = v7;
      v24 = 2112;
      v25 = v5;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Retrieved vendor ID %@ for application bundle ID: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    if (v7 && (v18 = @"kCompanionApplicationVendorIdentifierKey", v19 = v7, [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v19 forKeys:&v18 count:1], v11 = objc_claimAutoreleasedReturnValue(), v7, v11))
    {
      v12 = 0;
    }

    else
    {
LABEL_8:
      v12 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
      v11 = 0;
    }

    v13 = [v3 responseHandler];
    (v13)[2](v13, v12, v11);
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v21 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@No response handler set for the retrieve vendor identifier message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestForCompanionKeysSync:(id)a3
{
  v8 = a3;
  v4 = [(HMDHomeManager *)self watchManager];
  v5 = [v4 connectedWatches];
  [(HMDHomeManager *)self _checkAndAddWatchDevices:v5 resend:0 requestFromWatch:1];

  v6 = [v8 responseHandler];

  if (v6)
  {
    v7 = [v8 responseHandler];
    v7[2](v7, 0, 0);
  }
}

- (BOOL)_removeAndAddKeyPair:(id)a3 userName:(id)a4 eraseReason:(unint64_t)a5
{
  v42 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  [(HMDHomeManager *)self _eraseLocalHomeConfigurationWithReason:a5];
  v10 = [MEMORY[0x277CFEC78] systemStore];
  v11 = [v10 removeControllerKeyPairWithError:0];
  v12 = objc_autoreleasePoolPush();
  v13 = HMFGetOSLogHandle();
  v14 = v13;
  if (v11)
  {
    if (!os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      goto LABEL_7;
    }

    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v41 = v15;
    v16 = "%{public}@Removed controller key from store";
    v17 = v14;
    v18 = OS_LOG_TYPE_INFO;
  }

  else
  {
    if (!os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_7;
    }

    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v41 = v15;
    v16 = "%{public}@Failed removing controller key from store";
    v17 = v14;
    v18 = OS_LOG_TYPE_ERROR;
  }

  _os_log_impl(&dword_2531F8000, v17, v18, v16, buf, 0xCu);

LABEL_7:
  objc_autoreleasePoolPop(v12);
  v39 = 0;
  v19 = [v10 saveKeyPair:v8 username:v9 syncable:0 error:&v39];
  v20 = v39;
  v21 = v20;
  if (v19)
  {
    v37 = v20;
    v38 = 0;
    LODWORD(v22) = [v10 deserializeKeyPair:v8 publicKey:&v38 secretKey:0 error:&v37];
    v23 = v38;
    v24 = v37;

    if (v22)
    {
      v25 = [(HMDHomeManager *)self appleAccountManager];
      v26 = [v25 account];

      if (v26)
      {
        v27 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v23];
        v28 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:v9 publicKey:v27 privateKey:0 permissions:0];
        v29 = +[HMDIdentityRegistry sharedRegistry];
        [v29 registerIdentity:v28 account:v26 object:v26];
      }
    }

    else
    {
      v32 = objc_autoreleasePoolPush();
      v33 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
      {
        v34 = HMFGetLogIdentifier();
        *buf = 138543362;
        v41 = v34;
        _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_INFO, "%{public}@Deserialize of key pair failed", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
    }

    v21 = v24;
  }

  else
  {
    v30 = objc_autoreleasePoolPush();
    v22 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543362;
      v41 = v31;
      _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Failed to save key pair", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v30);
    LOBYTE(v22) = 0;
  }

  v35 = *MEMORY[0x277D85DE8];
  return v22;
}

- (void)__handleInitialFetch:(id)a3
{
  v4 = [a3 userInfo];
  v5 = [v4 hmf_UUIDForKey:@"HMDCR.id"];

  v6 = [(HMDHomeManager *)self workQueue];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __39__HMDHomeManager___handleInitialFetch___block_invoke;
  v8[3] = &unk_2797359B0;
  v9 = v5;
  v10 = self;
  v7 = v5;
  dispatch_async(v6, v8);
}

void __39__HMDHomeManager___handleInitialFetch___block_invoke(uint64_t a1)
{
  v14 = *MEMORY[0x277D85DE8];
  if (!*(a1 + 32))
  {
    v2 = objc_autoreleasePoolPush();
    v3 = *(a1 + 40);
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Received legacy fetch, controller key established.", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    v6 = [*(a1 + 40) appleAccountManager];
    v7 = [v6 account];

    v8 = [MEMORY[0x277CFEC78] systemStore];
    v9 = [v8 getLocalPairingIdentity:0];

    if (v7 && v9)
    {
      v10 = +[HMDIdentityRegistry sharedRegistry];
      [v10 registerIdentity:v9 account:v7 object:v7];
    }
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)__handleAppleAccountUpdated:(id)a3 previousAccount:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __62__HMDHomeManager___handleAppleAccountUpdated_previousAccount___block_invoke;
  block[3] = &unk_279734960;
  v12 = v7;
  v13 = v6;
  v14 = self;
  v9 = v6;
  v10 = v7;
  dispatch_async(v8, block);
}

void __62__HMDHomeManager___handleAppleAccountUpdated_previousAccount___block_invoke(uint64_t a1)
{
  v28 = *MEMORY[0x277D85DE8];
  v2 = [MEMORY[0x277CFEC78] systemStore];
  v3 = [v2 getLocalPairingIdentity:0];

  if (*(a1 + 32))
  {
    v4 = v3 == 0;
  }

  else
  {
    v4 = 1;
  }

  if (!v4)
  {
    v5 = +[HMDIdentityRegistry sharedRegistry];
    [v5 deregisterIdentity:v3 object:*(a1 + 32)];
  }

  if (*(a1 + 40) && v3)
  {
    v6 = +[HMDIdentityRegistry sharedRegistry];
    [v6 registerIdentity:v3 account:*(a1 + 40) object:*(a1 + 40)];
  }

  [*(a1 + 48) _notifyClientsOfUpdatedStatus];
  [*(a1 + 48) postFinishSetupForCurrentAccessoryFollowUpIfNeeded];
  if (*(a1 + 40))
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 48);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v26 = 138543362;
      v27 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign in", &v26, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    if (isWatch())
    {
      [*(a1 + 48) _updateCloudDataSyncWithAccountState:1];
    }

    else
    {
      v18 = objc_autoreleasePoolPush();
      v19 = *(a1 + 48);
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
      {
        v21 = HMFGetLogIdentifier();
        v26 = 138543362;
        v27 = v21;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Clearing CloudKit account status", &v26, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      [*(a1 + 48) setCloudkitAccountStatusDetermined:0];
    }

    [*(a1 + 48) setBackOffOperationInProgress:0];
    v22 = [*(a1 + 48) cloudDataSyncStateFilter];
    [v22 updateiCloudAccountActive:1];

    [*(a1 + 48) _resetCloudOperationRetryCounters];
    v23 = [*(a1 + 48) multiUserStatusController];
    [v23 didChangeHasActiveAccountState:0];

    v24 = [*(a1 + 48) notificationCenter];
    [v24 postNotificationName:@"HMDHomeManagerKeyTransferResetTimerNotification" object:*(a1 + 48) userInfo:0];
  }

  else if (*(a1 + 32))
  {
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 48);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v14 = HMFGetLogIdentifier();
      v26 = 138543362;
      v27 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEFAULT, "%{public}@Handling account sign out", &v26, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    v15 = [*(a1 + 48) multiUserStatusController];
    [v15 didChangeHasActiveAccountState:0];

    [*(a1 + 48) _eraseLocalHomeConfigurationAfterSignOut];
    [*(a1 + 48) _updateCloudDataSyncWithAccountState:0];
    v16 = [*(a1 + 48) cloudDataSyncStateFilter];
    [v16 updateiCloudAccountActive:0];

    [*(a1 + 48) setBackOffOperationInProgress:0];
    [*(a1 + 48) setCloudkitAccountStatusDetermined:0];
    [*(a1 + 48) _resetCloudOperationRetryCounters];
    v17 = [HMDPersistentStore archiveCloudServerTokenData:0];
    [*(a1 + 48) updatePowerAssertion];
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (void)__handleAppleAccountUpdated:(id)a3
{
  v4 = a3;
  v5 = [v4 userInfo];
  v6 = [v5 objectForKeyedSubscript:@"HMDAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v7 = v6;
  }

  else
  {
    v7 = 0;
  }

  v12 = v7;

  v8 = [v4 userInfo];

  v9 = [v8 objectForKeyedSubscript:@"HMDPreviousAccountNotificationKey"];

  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v10 = v9;
  }

  else
  {
    v10 = 0;
  }

  v11 = v10;

  [(HMDHomeManager *)self __handleAppleAccountUpdated:v12 previousAccount:v11];
}

- (BOOL)setLocalPairingIdentity:(id)a3 error:(id *)a4
{
  v43 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [MEMORY[0x277CFEC78] systemStore];
  v8 = [v7 getLocalPairingIdentity:0];
  if ([v8 isEqual:v6])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v40 = v12;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Skipping updating pairing identity, it matches current identity", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
    v13 = 1;
  }

  else
  {
    v14 = [(HMDHomeManager *)self homes];
    v15 = [v14 count];

    if (v15)
    {
      v16 = objc_autoreleasePoolPush();
      v17 = self;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        *buf = 138543362;
        v40 = v19;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Found some existing homes which must be some cruft from last user. Going to clean it up before setting up this device for HH1", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      [(HMDHomeManager *)v17 _eraseLocalHomeConfiguration];
    }

    if ([v7 saveLocalPairingIdentity:v6 syncable:0 error:a4])
    {
      v20 = [v6 publicPairingIdentity];
      v38 = 0;
      v21 = [HMDPersistentStore controllerUsernameForPairingIdentity:v20 error:&v38];
      v22 = v38;

      v13 = v21 != 0;
      v23 = objc_autoreleasePoolPush();
      v24 = self;
      v25 = HMFGetOSLogHandle();
      v26 = v25;
      if (v21)
      {
        if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
        {
          v27 = HMFGetLogIdentifier();
          *buf = 138543362;
          v40 = v27;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_DEFAULT, "%{public}@Updating controller username on setting local pairing identity", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v23);
        [v7 updateActiveControllerPairingIdentifier:v21];
        v28 = [(HMDHomeManager *)v24 appleAccountManager];
        v29 = [v28 account];

        if (v29)
        {
          v30 = +[HMDIdentityRegistry sharedRegistry];
          [v30 registerIdentity:v6 account:v29 object:v29];
        }
      }

      else
      {
        if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
        {
          v35 = HMFGetLogIdentifier();
          *buf = 138543618;
          v40 = v35;
          v41 = 2112;
          v42 = v22;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_ERROR, "%{public}@Unable to find or set pairing identity as active. error: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v23);
      }
    }

    else
    {
      v31 = objc_autoreleasePoolPush();
      v32 = self;
      v33 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
      {
        v34 = HMFGetLogIdentifier();
        *buf = 138543362;
        v40 = v34;
        _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to save local pairing identity", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v31);
      v13 = 0;
    }
  }

  v36 = *MEMORY[0x277D85DE8];
  return v13;
}

- (void)_handleCompanionKeysSync:(id)a3
{
  v36 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 dataForKey:@"kControllerKeyPairKey"];
  v6 = [v4 stringForKey:@"kControllerPairingNameKey"];
  v7 = [v4 dataForKey:@"kControllerUniqueDeviceIdSaltKey"];
  v8 = [v4 dataForKey:@"kControllerAssistantTeamIdentifierKey"];
  v9 = [v4 responseHandler];

  if (v9)
  {
    if (v5 && v7 && v8)
    {
      v31 = v6;
      if ([(HMDHomeManager *)self _removeAndAddKeyPair:v5 userName:v6 eraseReason:1])
      {
        v10 = +[HMDHAPMetadata getSharedInstance];
        v32[0] = @"kHomedVersionKey";
        v11 = homedVersion;
        v33[0] = v11;
        v32[1] = @"kMetadataInfoVersionKey";
        v12 = [v10 version];
        v33[1] = v12;
        v32[2] = @"kMetadataInfoSchemaVersionKey";
        v13 = [v10 schemaVersion];
        v33[2] = v13;
        v14 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v33 forKeys:v32 count:3];

        [(HMDHomeManager *)self _setUniqueDeviceIdSalt:v7];
        [(HMDHomeManager *)self _saveAssistantHashingData:v8];
      }

      else
      {
        v23 = objc_autoreleasePoolPush();
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v35 = v25;
          _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Failed to save the key pair to keychain", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v23);
        v14 = 0;
      }

      v26 = objc_autoreleasePoolPush();
      v27 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
      {
        v28 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v28;
        _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Answering Companion Sync request", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v26);
      v29 = [v4 responseHandler];
      (v29)[2](v29, 0, v14);

      v6 = v31;
    }

    else
    {
      v18 = objc_autoreleasePoolPush();
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v20;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_ERROR, "%{public}@Key pair/salts are missing the companion key sync message", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      v21 = [v4 responseHandler];
      v22 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (v21)[2](v21, v22, 0);
    }
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v17;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@No response handler", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v15);
  }

  v30 = *MEMORY[0x277D85DE8];
}

- (void)_handleHomesConfigSync:(id)a3
{
  v45 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = +[HMDHAPMetadata getSharedInstance];
  v6 = [MEMORY[0x277CBEB38] dictionary];
  v7 = homedVersion;
  [v6 setObject:v7 forKeyedSubscript:@"kHomedVersionKey"];

  v8 = [v5 version];
  [v6 setObject:v8 forKeyedSubscript:@"kMetadataInfoVersionKey"];

  v9 = [v5 schemaVersion];
  [v6 setObject:v9 forKeyedSubscript:@"kMetadataInfoSchemaVersionKey"];

  v10 = [(HMDHomeManager *)self primaryHomeUUID];

  if (v10)
  {
    v11 = [(HMDHomeManager *)self primaryHomeUUID];
    v12 = [v11 UUIDString];
    [v6 setObject:v12 forKeyedSubscript:@"kPrimaryHomeUUIDKey"];
  }

  v13 = [v4 messagePayload];
  v14 = [v13 hmf_UUIDForKey:@"kCurrentHomeUUIDKey"];

  if (v14)
  {
    [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v14 isLocalUpdate:0];
  }

  v15 = [(HMDHomeManager *)self _prepareHomesVersionDict];
  if (v15)
  {
    [v6 setObject:v15 forKeyedSubscript:@"kHomeConfigHomesKey"];
  }

  v16 = [v4 remoteSourceDevice];
  v17 = [v16 version];
  v18 = +[HMDHomeKitVersion version4_1];
  v19 = [v17 isAtLeastVersion:v18];

  if (!v19)
  {
    v25 = objc_autoreleasePoolPush();
    v26 = self;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      *buf = 138543362;
      v42 = v28;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Responding with legacy pairing identity", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v25);
    v29 = [MEMORY[0x277CFEC78] systemStore];
    v38 = 0;
    v39 = 0;
    v37 = 0;
    [v29 getControllerPublicKey:0 secretKey:0 keyPair:&v39 username:&v38 allowCreation:0 error:&v37];
    v22 = v39;
    v23 = v38;
    v21 = v37;

    if (v22)
    {
      [v6 setObject:v22 forKeyedSubscript:@"kControllerKeyPairKey"];
    }

    if (v23)
    {
      [v6 setObject:v23 forKeyedSubscript:@"kControllerPairingNameKey"];
    }

    goto LABEL_16;
  }

  v20 = [MEMORY[0x277CFEC78] systemStore];
  v40 = 0;
  v21 = [v20 getLocalPairingIdentity:&v40];
  v22 = v40;

  if (v21)
  {
    v23 = [v21 publicPairingIdentity];
    v24 = encodeRootObject();
    [v6 setObject:v24 forKeyedSubscript:@"pairingIdentity"];

LABEL_16:
    goto LABEL_17;
  }

  v33 = objc_autoreleasePoolPush();
  v34 = self;
  v35 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v35, OS_LOG_TYPE_DEFAULT))
  {
    v36 = HMFGetLogIdentifier();
    *buf = 138543618;
    v42 = v36;
    v43 = 2112;
    v44 = v22;
    _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to get local pairing identity with error: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v33);
  v21 = 0;
LABEL_17:

  v30 = +[HMDHomeManager getUniqueDeviceIdSalt];
  if (v30)
  {
    [v6 setObject:v30 forKeyedSubscript:@"kControllerUniqueDeviceIdSaltKey"];
  }

  v31 = [v4 responseHandler];
  (v31)[2](v31, 0, v6);

  v32 = *MEMORY[0x277D85DE8];
}

- (id)_prepareHomesVersionDict
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CBEB38] dictionary];
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v4 = [(HMDHomeManager *)self homes];
  v5 = [v4 countByEnumeratingWithState:&v16 objects:v20 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v17;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v17 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v16 + 1) + 8 * i);
        v10 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v9, "configurationVersion")}];
        v11 = [v9 uuid];
        v12 = [v11 UUIDString];
        [v3 setObject:v10 forKeyedSubscript:v12];
      }

      v6 = [v4 countByEnumeratingWithState:&v16 objects:v20 count:16];
    }

    while (v6);
  }

  if ([v3 count])
  {
    v13 = [v3 copy];
  }

  else
  {
    v13 = 0;
  }

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)processTransactionsFromHomeDataSync:(id)a3 accessories:(id)a4 version:(int64_t)a5 completion:(id)a6
{
  v67[1] = *MEMORY[0x277D85DE8];
  v10 = a3;
  v44 = a4;
  v43 = a6;
  v67[0] = v10;
  v11 = [MEMORY[0x277CBEA60] arrayWithObjects:v67 count:1];
  [(HMDHomeManager *)self _associateAccessories:v44 withHomes:v11];

  [v10 fixupHomeAfterDecoding];
  v12 = [v10 uuid];
  v13 = [(HMDHomeManager *)self _homeWithUUID:v12];

  v42 = [v10 sharedHomeSourceVersion];
  v14 = objc_autoreleasePoolPush();
  v15 = [(HMDHomeManager *)self _loadCloudTransactionForRemoteHome:v10 localHome:v13 cachedHome:0 version:a5];
  objc_autoreleasePoolPop(v14);
  if ([v15 count])
  {
    v16 = [(HMDHomeManager *)self _findHomeModel:v15];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v17 = v16;
    }

    else
    {
      v17 = 0;
    }

    v41 = v17;

    if (!v13 && v41)
    {
      v18 = [v15 mutableCopy];
      [v18 removeObject:v41];
      v19 = [v18 copy];

      v15 = v19;
    }

    objc_initWeak(&location, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke;
    aBlock[3] = &unk_2797326E8;
    objc_copyWeak(&v63, &location);
    v20 = v10;
    v60 = v20;
    v21 = v43;
    v62 = v21;
    v22 = v42;
    v61 = v22;
    v23 = _Block_copy(aBlock);
    v52[0] = MEMORY[0x277D85DD0];
    v52[1] = 3221225472;
    v52[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1330;
    v52[3] = &unk_279732710;
    objc_copyWeak(&v58, &location);
    v24 = v21;
    v56 = v24;
    v25 = v22;
    v53 = v25;
    v54 = v20;
    v15 = v15;
    v55 = v15;
    v26 = v23;
    v57 = v26;
    v27 = _Block_copy(v52);
    v28 = v27;
    if (v13)
    {
      (*(v27 + 2))(v27, 0);
    }

    else
    {
      if (v41)
      {
        v33 = [(HMDHomeManager *)self backingStore];
        v34 = +[HMDBackingStoreTransactionOptions defaultIDSOptions];
        v35 = [v33 transaction:@"kTransactionUpdate" options:v34];

        [v35 add:v41 withMessage:0];
        v45[0] = MEMORY[0x277D85DD0];
        v45[1] = 3221225472;
        v45[2] = __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1331;
        v45[3] = &unk_279732738;
        objc_copyWeak(&v51, &location);
        v48 = v24;
        v46 = v25;
        v47 = v15;
        v49 = v26;
        v50 = v28;
        [v35 run:v45];

        objc_destroyWeak(&v51);
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        v37 = self;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_ERROR))
        {
          v39 = HMFGetLogIdentifier();
          *buf = 138543362;
          v66 = v39;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_ERROR, "%{public}@Must have home model to create home because it does not already exist", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v36);
        if (!v24)
        {
          goto LABEL_21;
        }

        v35 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
        (v24[2])(v24, 0, 0, v35);
      }
    }

LABEL_21:

    objc_destroyWeak(&v58);
    objc_destroyWeak(&v63);
    objc_destroyWeak(&location);

    goto LABEL_22;
  }

  v29 = objc_autoreleasePoolPush();
  v30 = self;
  v31 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
  {
    v32 = HMFGetLogIdentifier();
    *buf = 138543362;
    v66 = v32;
    _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@No changes to home", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v29);
  if (v43)
  {
    v43[2]();
  }

LABEL_22:

  v40 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke(uint64_t a1, void *a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v5 = [*(a1 + 32) uuid];
    v6 = [WeakRetained _homeWithUUID:v5];

    v7 = [WeakRetained incomingInvitations];
    v8 = [v6 uuid];
    v9 = [v7 hmf_firstObjectWithValue:v8 forKeyPath:@"homeUUID"];

    if (v9)
    {
      v10 = objc_autoreleasePoolPush();
      v11 = WeakRetained;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v18 = [v6 uuid];
        [v18 UUIDString];
        v14 = v19 = v10;
        v15 = [v9 describeWithFormat];
        *buf = 138543874;
        v21 = v13;
        v22 = 2112;
        v23 = v14;
        v24 = 2112;
        v25 = v15;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Found home with UUID %@ in invite %@, removing it since it was accepted", buf, 0x20u);

        v10 = v19;
      }

      objc_autoreleasePoolPop(v10);
      [v11 _postIncomingInvitationStateChangedNotification:v9 newInvitationState:3];
      [v11 _removeIncomingInvitation:v9];
    }
  }

  v16 = *(a1 + 48);
  if (v16)
  {
    (*(v16 + 16))(v16, 1, *(a1 + 40), 0);
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1330(uint64_t a1, void *a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  v5 = WeakRetained;
  if (v3)
  {
    v6 = *(a1 + 56);
    if (v6)
    {
      (*(v6 + 16))(v6, 0, *(a1 + 32), v3);
    }
  }

  else if (WeakRetained)
  {
    v7 = [*(a1 + 40) uuid];
    v8 = [v5 _homeWithUUID:v7];

    v9 = [v8 sharedHomeUpdateHandler];
    [v9 pause];

    v20 = v8;
    v10 = [v8 backingStore];
    v11 = +[HMDBackingStoreTransactionOptions defaultIDSOptions];
    v12 = [v10 transaction:@"kTransactionUpdate" options:v11];

    v23 = 0u;
    v24 = 0u;
    v21 = 0u;
    v22 = 0u;
    v13 = *(a1 + 48);
    v14 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
    if (v14)
    {
      v15 = v14;
      v16 = *v22;
      do
      {
        v17 = 0;
        do
        {
          if (*v22 != v16)
          {
            objc_enumerationMutation(v13);
          }

          v18 = *(*(&v21 + 1) + 8 * v17);
          objc_opt_class();
          if ((objc_opt_isKindOfClass() & 1) == 0)
          {
            [v12 add:v18 withMessage:0];
          }

          ++v17;
        }

        while (v15 != v17);
        v15 = [v13 countByEnumeratingWithState:&v21 objects:v25 count:16];
      }

      while (v15);
    }

    [v12 run:*(a1 + 64)];
  }

  v19 = *MEMORY[0x277D85DE8];
}

void __85__HMDHomeManager_processTransactionsFromHomeDataSync_accessories_version_completion___block_invoke_1331(uint64_t a1, void *a2)
{
  v6 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (v6)
  {
    v4 = *(a1 + 48);
    if (v4)
    {
      (*(v4 + 16))(v4, 0, *(a1 + 32), v6);
    }
  }

  else if (WeakRetained)
  {
    if ([*(a1 + 40) count])
    {
      v5 = *(a1 + 64);
    }

    else
    {
      v5 = *(a1 + 56);
    }

    (*(v5 + 16))(v5, 0);
  }
}

- (void)_processSharedHomeModel:(id)a3 message:(id)a4
{
  v47[7] = *MEMORY[0x277D85DE8];
  v33 = a3;
  v31 = a4;
  v41[0] = 0;
  v41[1] = v41;
  v41[2] = 0x3032000000;
  v41[3] = __Block_byref_object_copy__172847;
  v41[4] = __Block_byref_object_dispose__172848;
  v42 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.handle-home-sync"];
  v6 = MEMORY[0x277CBEB98];
  v47[0] = objc_opt_class();
  v47[1] = objc_opt_class();
  v47[2] = objc_opt_class();
  v47[3] = objc_opt_class();
  v47[4] = objc_opt_class();
  v47[5] = objc_opt_class();
  v47[6] = objc_opt_class();
  v7 = [MEMORY[0x277CBEA60] arrayWithObjects:v47 count:7];
  v32 = [v6 setWithArray:v7];

  v8 = objc_alloc(MEMORY[0x277CCAAC8]);
  v9 = [v33 homeData];
  v40 = 0;
  v10 = [v8 initForReadingFromData:v9 error:&v40];
  v11 = v40;

  [v10 _allowDecodingCyclesInSecureMode];
  v12 = *MEMORY[0x277CCA308];
  v39 = v11;
  v13 = [v10 decodeTopLevelObjectOfClasses:v32 forKey:v12 error:&v39];
  v30 = v39;

  if (!v13)
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      *buf = 138543618;
      v44 = v17;
      v45 = 2112;
      v46 = v30;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive home from shared home model's home data: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = v13;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v19 = v18;
  }

  else
  {
    v19 = 0;
  }

  v20 = v19;

  v21 = [v20 objectForKeyedSubscript:@"kHomeDataBlobKey"];
  v22 = [v20 objectForKeyedSubscript:@"kAccessoriesDataBlobKey"];
  v23 = [v20 hmf_numberForKey:@"kHomeDataVersionKey"];
  v24 = v23;
  if (v23)
  {
    v25 = [v23 integerValue];
    if (!v21)
    {
      goto LABEL_13;
    }

    goto LABEL_12;
  }

  v25 = 0;
  if (v21)
  {
LABEL_12:
    [(HMDHomeManager *)self setHomeDataLoadedFromArchive:1, v30];
    v26 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    [v26 updateLocalDataDecryptionFailed:0];

    v27 = [v21 zoneID];
    v28 = [v21 ownerName];
    [(HMDHomeManager *)self _addCloudZone:v27 ownerName:v28];

    objc_initWeak(buf, self);
    v34[0] = MEMORY[0x277D85DD0];
    v34[1] = 3221225472;
    v34[2] = __50__HMDHomeManager__processSharedHomeModel_message___block_invoke;
    v34[3] = &unk_2797326C0;
    objc_copyWeak(&v38, buf);
    v35 = v21;
    v36 = v31;
    v37 = v41;
    [(HMDHomeManager *)self processTransactionsFromHomeDataSync:v35 accessories:v22 version:v25 completion:v34];

    objc_destroyWeak(&v38);
    objc_destroyWeak(buf);
  }

LABEL_13:

  _Block_object_dispose(v41, 8);
  v29 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__processSharedHomeModel_message___block_invoke(uint64_t a1, uint64_t a2, void *a3, void *a4)
{
  v38[1] = *MEMORY[0x277D85DE8];
  v7 = a3;
  v8 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v10 = WeakRetained;
  if (!v8 && WeakRetained)
  {
    v11 = [*(a1 + 32) uuid];
    v12 = [v10 _homeWithUUID:v11];

    if (v12)
    {
      v13 = v7;
      v14 = [*(a1 + 40) name];
      v15 = [v14 isEqualToString:@"kTransactionUpdate"];

      if ((v15 & 1) == 0)
      {
        v16 = [*(a1 + 40) destination];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v17 = v16;
        }

        else
        {
          v17 = 0;
        }

        v18 = v17;

        v19 = [v18 device];

        v20 = [v19 version];

        v13 = v20;
      }

      v21 = [v12 sharedHomeUpdateHandler];
      v32[0] = MEMORY[0x277D85DD0];
      v32[1] = 3221225472;
      v32[2] = __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_2;
      v32[3] = &unk_279732698;
      objc_copyWeak(&v35, (a1 + 56));
      v33 = *(a1 + 40);
      v36 = a2;
      v22 = v12;
      v34 = v22;
      [v21 receivedHomeDataFromSourceVersion:v13 forceUpdateVersion:a2 completion:v32];

      v23 = [v22 presenceFeeder];
      [v23 homeDataProcessed];

      objc_destroyWeak(&v35);
    }

    goto LABEL_14;
  }

  if (!v8)
  {
LABEL_14:
    v26 = [*(a1 + 40) responseHandler];

    if (v26)
    {
      v37 = @"kDataSyncResponseAckKey";
      v38[0] = MEMORY[0x277CBEC38];
      v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v38 forKeys:&v37 count:1];
      v28 = [*(a1 + 40) responseHandler];
      (v28)[2](v28, 0, v27);
    }

    goto LABEL_16;
  }

  v24 = [*(a1 + 40) responseHandler];

  if (v24)
  {
    v25 = [*(a1 + 40) responseHandler];
    (v25)[2](v25, v8, 0);
  }

LABEL_16:
  v29 = *(*(a1 + 48) + 8);
  v30 = *(v29 + 40);
  *(v29 + 40) = 0;

  v31 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_2(uint64_t a1, int a2)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v5 = [*(a1 + 32) name];
    if ([v5 isEqualToString:@"kTransactionUpdate"])
    {
    }

    else
    {
      v6 = *(a1 + 56);

      if ((v6 & 1) != 0 || a2)
      {
        v7 = [*(a1 + 40) sharedHomeModel];
        v8 = [WeakRetained backingStore];
        v9 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v10 = [v8 transaction:@"kTransactionIDSUpdate" options:v9];

        [v10 add:v7 withMessage:0];
        v12[0] = MEMORY[0x277D85DD0];
        v12[1] = 3221225472;
        v12[2] = __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_3;
        v12[3] = &unk_279734D88;
        v13 = *(a1 + 40);
        v14 = *(a1 + 32);
        v15 = WeakRetained;
        [v10 save:v12];
      }
    }

    v11 = [*(a1 + 40) sharedHomeUpdateHandler];
    [v11 resume];
  }
}

void __50__HMDHomeManager__processSharedHomeModel_message___block_invoke_3(id *a1)
{
  v11[1] = *MEMORY[0x277D85DE8];
  v10 = *MEMORY[0x277CD0640];
  v2 = [a1[4] uuid];
  v3 = [v2 UUIDString];
  v11[0] = v3;
  v4 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v11 forKeys:&v10 count:1];

  v5 = [HMDHomeSaveRequest alloc];
  v6 = a1[4];
  v7 = [a1[5] name];
  v8 = [(HMDHomeSaveRequest *)v5 initWithHome:v6 reason:v7 information:v4 postSyncNotification:1 objectChange:1];

  [a1[6] saveWithRequest:v8];
  v9 = *MEMORY[0x277D85DE8];
}

- (void)processSharedHomeModelUpdate:(id)a3 message:(id)a4
{
  v6 = a3;
  v7 = a4;
  objc_initWeak(&location, self);
  v8 = [(HMDHomeManager *)self workQueue];
  v11[0] = MEMORY[0x277D85DD0];
  v11[1] = 3221225472;
  v11[2] = __55__HMDHomeManager_processSharedHomeModelUpdate_message___block_invoke;
  v11[3] = &unk_279732670;
  objc_copyWeak(&v14, &location);
  v12 = v6;
  v13 = v7;
  v9 = v7;
  v10 = v6;
  dispatch_async(v8, v11);

  objc_destroyWeak(&v14);
  objc_destroyWeak(&location);
}

void __55__HMDHomeManager_processSharedHomeModelUpdate_message___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  [WeakRetained _processSharedHomeModel:*(a1 + 32) message:*(a1 + 40)];
}

- (id)_loadCloudTransactionForRemoteHome:(id)a3 localHome:(id)a4 cachedHome:(id)a5 version:(int64_t)a6
{
  v210 = *MEMORY[0x277D85DE8];
  v9 = a3;
  v10 = a4;
  v11 = a5;
  v145 = v10;
  v141 = [v10 backingStoreObjects:a6];
  v143 = v9;
  v12 = [v9 backingStoreObjects:a6];
  v158 = [v12 mutableCopy];

  v142 = v11;
  v148 = a6;
  v149 = [v11 backingStoreObjects:a6];
  v13 = objc_autoreleasePoolPush();
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543618;
    v202 = v15;
    v203 = 2048;
    v204 = a6;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Received data with home-data-version %tu", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v13);
  v193 = 0u;
  v194 = 0u;
  v191 = 0u;
  v192 = 0u;
  obj = [v158 copy];
  v16 = [obj countByEnumeratingWithState:&v191 objects:v209 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v192;
    v150 = *v192;
    do
    {
      v19 = 0;
      v151 = v17;
      do
      {
        if (*v192 != v18)
        {
          objc_enumerationMutation(obj);
        }

        v20 = *(*(&v191 + 1) + 8 * v19);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v21 = v20;
        }

        else
        {
          v21 = 0;
        }

        v22 = v21;

        if (v22)
        {
          if (![v22 propertyWasSet:@"uniqueIdentifier"] || (objc_msgSend(v22, "uniqueIdentifier"), v23 = objc_claimAutoreleasedReturnValue(), v23, !v23))
          {
            v156 = v22;
            v41 = v19;
            v42 = objc_autoreleasePoolPush();
            v43 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
            {
              v44 = HMFGetLogIdentifier();
              v45 = objc_opt_class();
              v46 = NSStringFromClass(v45);
              v47 = [v20 bsoType];
              v48 = [v20 uuid];
              v49 = [v48 UUIDString];
              *buf = 138544130;
              v202 = v44;
              v203 = 2112;
              v204 = v46;
              v205 = 2112;
              v206 = v47;
              v207 = 2112;
              v208 = v49;
              _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object (uuid: %@) from remote that has a null / unset uniqueIdentifier (no way to recover).", buf, 0x2Au);

              v17 = v151;
              v18 = v150;
            }

            objc_autoreleasePoolPop(v42);
            [v158 removeObject:v20];
            v19 = v41;
            goto LABEL_62;
          }
        }

        v24 = [v20 uuid];

        if (!v24)
        {
          v156 = v22;
          v50 = v20;
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            v51 = v50;
          }

          else
          {
            v51 = 0;
          }

          v52 = v51;

          if (v52)
          {
            v185 = 0u;
            v186 = 0u;
            v183 = 0u;
            v184 = 0u;
            v53 = [v145 users];
            v54 = [v53 countByEnumeratingWithState:&v183 objects:v199 count:16];
            v55 = v50;
            if (v54)
            {
              v56 = v54;
              v163 = v50;
              v147 = v19;
              v57 = *v184;
              while (2)
              {
                for (i = 0; i != v56; ++i)
                {
                  if (*v184 != v57)
                  {
                    objc_enumerationMutation(v53);
                  }

                  v59 = *(*(&v183 + 1) + 8 * i);
                  v60 = [v59 pairingUsername];
                  v61 = [(HMDUserModel *)v52 pairingIdentity];
                  v62 = [v61 objectForKey:@"HAP.identifier"];
                  v63 = [v60 isEqual:v62];

                  if (v63)
                  {
                    v64 = [HMDUserModel alloc];
                    v65 = [(HMDBackingStoreModelObject *)v52 bsoDataVersion];
                    v66 = [(HMDBackingStoreModelObject *)v52 objectChangeType];
                    v67 = [v59 uuid];
                    v68 = [(HMDBackingStoreModelObject *)v52 parentUUID];
                    v55 = [(HMDBackingStoreModelObject *)v64 initWithVersion:v65 changeType:v66 uuid:v67 parentUUID:v68];

                    v69 = [(HMDBackingStoreModelObject *)v55 merge:v52];
                    goto LABEL_48;
                  }
                }

                v56 = [v53 countByEnumeratingWithState:&v183 objects:v199 count:16];
                if (v56)
                {
                  continue;
                }

                break;
              }

              v55 = v52;
LABEL_48:
              v18 = v150;
              v19 = v147;
              v50 = v163;
            }

            v70 = [(HMDBackingStoreModelObject *)v55 uuid];

            v17 = v151;
            if (v70)
            {
              goto LABEL_61;
            }

            v71 = objc_autoreleasePoolPush();
            v72 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
            {
              v88 = HMFGetLogIdentifier();
              v89 = objc_opt_class();
              v90 = NSStringFromClass(v89);
              v91 = [(HMDBackingStoreModelObject *)v50 bsoType];
              *buf = 138543874;
              v202 = v88;
              v203 = 2112;
              v204 = v90;
              v205 = 2112;
              v206 = v91;
              _os_log_impl(&dword_2531F8000, v72, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object from remote that has a null UUID (tried to match via pairing ID and failed).", buf, 0x20u);

              v18 = v150;
            }
          }

          else
          {
            v71 = objc_autoreleasePoolPush();
            v72 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v72, OS_LOG_TYPE_INFO))
            {
              v73 = HMFGetLogIdentifier();
              v74 = objc_opt_class();
              v75 = NSStringFromClass(v74);
              v76 = [(HMDBackingStoreModelObject *)v50 bsoType];
              *buf = 138543874;
              v202 = v73;
              v203 = 2112;
              v204 = v75;
              v205 = 2112;
              v206 = v76;
              _os_log_impl(&dword_2531F8000, v72, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Got %@/%@ object from remote that has a null UUID (and no way to recover).", buf, 0x20u);
            }

            v55 = 0;
          }

          objc_autoreleasePoolPop(v71);
          [v158 removeObject:v50];
LABEL_61:

LABEL_62:
          v22 = v156;
          goto LABEL_63;
        }

        if (v148 <= 3)
        {
          v25 = v20;
          objc_opt_class();
          v26 = (objc_opt_isKindOfClass() & 1) != 0 ? v25 : 0;
          v27 = v26;

          if (v27)
          {
            v189 = 0u;
            v190 = 0u;
            v187 = 0u;
            v188 = 0u;
            v162 = [v145 users];
            v28 = [v162 countByEnumeratingWithState:&v187 objects:v200 count:16];
            if (v28)
            {
              v29 = v28;
              v144 = v25;
              v155 = v22;
              v146 = v19;
              v30 = *v188;
              while (2)
              {
                for (j = 0; j != v29; ++j)
                {
                  if (*v188 != v30)
                  {
                    objc_enumerationMutation(v162);
                  }

                  v32 = *(*(&v187 + 1) + 8 * j);
                  v33 = [v32 uuid];
                  v34 = [(HMDBackingStoreModelObject *)v27 uuid];
                  if ([v33 isEqual:v34])
                  {
                  }

                  else
                  {
                    v35 = [v32 pairingUsername];
                    [(HMDUserModel *)v27 pairingIdentity];
                    v160 = v32;
                    v37 = v36 = v29;
                    [v37 objectForKey:@"HAP.identifier"];
                    v39 = v38 = v27;
                    v40 = [v35 isEqual:v39];

                    v27 = v38;
                    v29 = v36;

                    if (v40)
                    {
                      v77 = objc_autoreleasePoolPush();
                      v78 = HMFGetOSLogHandle();
                      if (os_log_type_enabled(v78, OS_LOG_TYPE_INFO))
                      {
                        v79 = HMFGetLogIdentifier();
                        *buf = 138543874;
                        v202 = v79;
                        v203 = 2112;
                        v204 = v160;
                        v205 = 2112;
                        v206 = v38;
                        _os_log_impl(&dword_2531F8000, v78, OS_LOG_TYPE_INFO, "%{public}@Found an existing user %@, MERGING properties from %@", buf, 0x20u);
                      }

                      objc_autoreleasePoolPop(v77);
                      v80 = [HMDUserModel alloc];
                      v81 = [(HMDBackingStoreModelObject *)v38 bsoDataVersion];
                      v82 = [(HMDBackingStoreModelObject *)v38 objectChangeType];
                      v83 = [v160 uuid];
                      v84 = [(HMDBackingStoreModelObject *)v38 parentUUID];
                      v85 = [(HMDBackingStoreModelObject *)v80 initWithVersion:v81 changeType:v82 uuid:v83 parentUUID:v84];

                      v86 = [(HMDBackingStoreModelObject *)v85 merge:v38];
                      v87 = v85;

                      [v158 removeObject:v144];
                      [v158 addObject:v87];

                      v25 = v87;
                      goto LABEL_57;
                    }
                  }
                }

                v29 = [v162 countByEnumeratingWithState:&v187 objects:v200 count:16];
                if (v29)
                {
                  continue;
                }

                break;
              }

              v25 = v27;
LABEL_57:
              v18 = v150;
              v17 = v151;
              v19 = v146;
              v22 = v155;
            }

            else
            {
              v17 = v151;
            }
          }
        }

LABEL_63:

        v19 = v19 + 1;
      }

      while (v19 != v17);
      v92 = [obj countByEnumeratingWithState:&v191 objects:v209 count:16];
      v17 = v92;
    }

    while (v92);
  }

  v164 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v158, "count") + objc_msgSend(v141, "count")}];
  v179 = 0u;
  v180 = 0u;
  v181 = 0u;
  v182 = 0u;
  v152 = v141;
  v161 = [v152 countByEnumeratingWithState:&v179 objects:v198 count:16];
  if (v161)
  {
    v157 = *v180;
    do
    {
      for (k = 0; k != v161; ++k)
      {
        if (*v180 != v157)
        {
          objc_enumerationMutation(v152);
        }

        v94 = *(*(&v179 + 1) + 8 * k);
        v175 = 0u;
        v176 = 0u;
        v177 = 0u;
        v178 = 0u;
        v95 = v158;
        v96 = [v95 countByEnumeratingWithState:&v175 objects:v197 count:16];
        if (v96)
        {
          v97 = v96;
          v98 = *v176;
LABEL_75:
          v99 = 0;
          while (1)
          {
            if (*v176 != v98)
            {
              objc_enumerationMutation(v95);
            }

            v100 = *(*(&v175 + 1) + 8 * v99);
            v101 = [v94 uuid];
            v102 = [v100 uuid];
            v103 = [v101 isEqual:v102];

            if (v103)
            {
              break;
            }

            if (v97 == ++v99)
            {
              v97 = [v95 countByEnumeratingWithState:&v175 objects:v197 count:16];
              if (v97)
              {
                goto LABEL_75;
              }

              goto LABEL_81;
            }
          }

          v104 = v100;

          if (!v104)
          {
            goto LABEL_92;
          }

          [v95 removeObject:v104];
          obja = v104;
          [v104 setObjectChangeType:2];
          v173 = 0u;
          v174 = 0u;
          v171 = 0u;
          v172 = 0u;
          v105 = v149;
          v106 = [v105 countByEnumeratingWithState:&v171 objects:v196 count:16];
          if (v106)
          {
            v107 = v106;
            v108 = *v172;
LABEL_85:
            v109 = 0;
            while (1)
            {
              if (*v172 != v108)
              {
                objc_enumerationMutation(v105);
              }

              v110 = *(*(&v171 + 1) + 8 * v109);
              v111 = [v94 uuid];
              v112 = [v110 uuid];
              v113 = [v111 isEqual:v112];

              if (v113)
              {
                break;
              }

              if (v107 == ++v109)
              {
                v107 = [v105 countByEnumeratingWithState:&v171 objects:v196 count:16];
                if (v107)
                {
                  goto LABEL_85;
                }

                goto LABEL_91;
              }
            }

            v118 = v110;

            if (!v118)
            {
              goto LABEL_101;
            }

            v170 = 0;
            v119 = obja;
            [(HMDBackingStoreModelObject *)v118 diff:obja differingFields:&v170];
            v120 = v170;
            if ([(HMDUserModel *)v120 count])
            {
              v121 = objc_autoreleasePoolPush();
              v122 = self;
              v123 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v123, OS_LOG_TYPE_INFO))
              {
                v124 = HMFGetLogIdentifier();
                *buf = 138543874;
                v202 = v124;
                v203 = 2112;
                v204 = obja;
                v205 = 2112;
                v206 = v120;
                _os_log_impl(&dword_2531F8000, v123, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Object was changed since last push or fetch: object %@ has diff %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v121);
              [v164 addObject:obja];
              [(HMDBackingStoreModelObject *)v118 dumpDebug:@"CACHED: "];
              [obja dumpDebug:@"REMOTE: "];
            }
          }

          else
          {
LABEL_91:

LABEL_101:
            v169 = 0;
            v119 = obja;
            [v94 diff:obja differingFields:&v169];
            v118 = v169;
            if ([(HMDUserModel *)v118 count])
            {
              v125 = objc_autoreleasePoolPush();
              v126 = self;
              v127 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v127, OS_LOG_TYPE_INFO))
              {
                v128 = HMFGetLogIdentifier();
                *buf = 138543874;
                v202 = v128;
                v203 = 2112;
                v204 = obja;
                v205 = 2112;
                v206 = v118;
                _os_log_impl(&dword_2531F8000, v127, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: object %@ has diff %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v125);
              [v164 addObject:obja];
              [v94 dumpDebug:@"LOCAL: "];
              [obja dumpDebug:@"REMOTE: "];
            }
          }
        }

        else
        {
LABEL_81:

LABEL_92:
          v114 = objc_autoreleasePoolPush();
          v115 = self;
          v116 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v116, OS_LOG_TYPE_INFO))
          {
            v117 = HMFGetLogIdentifier();
            *buf = 138543618;
            v202 = v117;
            v203 = 2112;
            v204 = v94;
            _os_log_impl(&dword_2531F8000, v116, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: local object %@ deleted", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v114);
          [v94 setObjectChangeType:3];
          [v164 addObject:v94];
          [v94 dumpDebug:@"LOCAL:"];
        }
      }

      v161 = [v152 countByEnumeratingWithState:&v179 objects:v198 count:16];
    }

    while (v161);
  }

  v167 = 0u;
  v168 = 0u;
  v165 = 0u;
  v166 = 0u;
  v129 = v158;
  v130 = [v129 countByEnumeratingWithState:&v165 objects:v195 count:16];
  if (v130)
  {
    v131 = v130;
    v132 = *v166;
    do
    {
      for (m = 0; m != v131; ++m)
      {
        if (*v166 != v132)
        {
          objc_enumerationMutation(v129);
        }

        v134 = *(*(&v165 + 1) + 8 * m);
        v135 = objc_autoreleasePoolPush();
        v136 = self;
        v137 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v137, OS_LOG_TYPE_INFO))
        {
          v138 = HMFGetLogIdentifier();
          *buf = 138543618;
          v202 = v138;
          v203 = 2112;
          v204 = v134;
          _os_log_impl(&dword_2531F8000, v137, OS_LOG_TYPE_INFO, "%{public}@[Legacy Merge] Change from cloud: remote object %@ added", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v135);
        [v134 setObjectChangeType:1];
        [v164 addObject:v134];
        [v134 dumpDebug:@"REMOTE: "];
      }

      v131 = [v129 countByEnumeratingWithState:&v165 objects:v195 count:16];
    }

    while (v131);
  }

  v139 = *MEMORY[0x277D85DE8];

  return v164;
}

- (BOOL)_shouldDecodeMessage:(id)a3 error:(id *)a4
{
  v51 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v36 = [v6 remoteUserPairingIdentity];
  v7 = [v6 remoteSenderContext];
  v8 = [v7 mergeID];

  v43 = 0u;
  v44 = 0u;
  v41 = 0u;
  v42 = 0u;
  v35 = self;
  v9 = [(HMDHomeManager *)self homes];
  v10 = [v9 countByEnumeratingWithState:&v41 objects:v50 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v42;
LABEL_3:
    v13 = 0;
    while (1)
    {
      if (*v42 != v12)
      {
        objc_enumerationMutation(v9);
      }

      v14 = *(*(&v41 + 1) + 8 * v13);
      v15 = [v6 matchingRemoteIdentityUserForHome:v14];

      if (v15)
      {
        break;
      }

      if (v11 == ++v13)
      {
        v11 = [v9 countByEnumeratingWithState:&v41 objects:v50 count:16];
        if (v11)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v27 = objc_autoreleasePoolPush();
    v28 = v35;
    v29 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v29, OS_LOG_TYPE_DEBUG))
    {
      goto LABEL_25;
    }

    v30 = HMFGetLogIdentifier();
    v31 = [v14 name];
    *buf = 138543618;
    v47 = v30;
    v48 = 2112;
    v49 = v31;
    _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEBUG, "%{public}@Received home sync from owner of known home %@", buf, 0x16u);
  }

  else
  {
LABEL_9:
    v34 = a4;

    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v16 = [(HMDHomeManager *)v35 incomingInvitations];
    v9 = [v16 copy];

    v17 = [v9 countByEnumeratingWithState:&v37 objects:v45 count:16];
    if (!v17)
    {
LABEL_18:

      if (v34)
      {
        [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        *v34 = v26 = 0;
      }

      else
      {
        v26 = 0;
      }

      goto LABEL_26;
    }

    v18 = v17;
    v19 = *v38;
LABEL_11:
    v20 = 0;
    while (1)
    {
      if (*v38 != v19)
      {
        objc_enumerationMutation(v9);
      }

      v21 = *(*(&v37 + 1) + 8 * v20);
      v22 = [v21 inviterIdentity];
      v23 = [v22 isEqual:v36];

      v24 = [v21 inviterMergeID];
      v25 = [v24 isEqual:v8];

      if ([v21 isAccepted])
      {
        if ((v23 | v25))
        {
          break;
        }
      }

      if (v18 == ++v20)
      {
        v18 = [v9 countByEnumeratingWithState:&v37 objects:v45 count:16];
        if (v18)
        {
          goto LABEL_11;
        }

        goto LABEL_18;
      }
    }

    v27 = objc_autoreleasePoolPush();
    v28 = v35;
    v29 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v29, OS_LOG_TYPE_DEBUG))
    {
      goto LABEL_25;
    }

    v30 = HMFGetLogIdentifier();
    *buf = 138543618;
    v47 = v30;
    v48 = 2112;
    v49 = v21;
    _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEBUG, "%{public}@Received home sync from accepted invitation %@", buf, 0x16u);
  }

LABEL_25:
  objc_autoreleasePoolPop(v27);

  v26 = 1;
LABEL_26:

  v32 = *MEMORY[0x277D85DE8];
  return v26;
}

- (void)_handleHomeDataSync:(id)a3
{
  v221 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v183 = 0;
  v6 = [(HMDHomeManager *)self _shouldDecodeMessage:v4 error:&v183];
  v7 = v183;
  if (v6)
  {
    v8 = [v4 dataForKey:@"kHomeDataKey"];
    if (!v8)
    {
      v60 = objc_autoreleasePoolPush();
      v61 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v61, OS_LOG_TYPE_ERROR))
      {
        v62 = HMFGetLogIdentifier();
        *buf = 138543362;
        v208 = v62;
        _os_log_impl(&dword_2531F8000, v61, OS_LOG_TYPE_ERROR, "%{public}@Failed to receive home data", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v60);
      v63 = [v4 responseHandler];

      if (!v63)
      {
        goto LABEL_100;
      }

      v64 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v9 = [v4 responseHandler];
      v9[2](v9, v64, 0);
LABEL_99:

LABEL_100:
      goto LABEL_101;
    }

    v173 = v5;
    v172 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.handle-home-sync"];
    v9 = [v8 hmd_uncompressedData];
    if (!v9)
    {
      v9 = v8;
    }

    v10 = MEMORY[0x277CBEB98];
    v196[0] = objc_opt_class();
    v196[1] = objc_opt_class();
    v196[2] = objc_opt_class();
    v196[3] = objc_opt_class();
    v196[4] = objc_opt_class();
    v196[5] = objc_opt_class();
    v196[6] = objc_opt_class();
    v11 = [MEMORY[0x277CBEA60] arrayWithObjects:v196 count:7];
    v12 = [v10 setWithArray:v11];

    v182 = 0;
    v13 = [objc_alloc(MEMORY[0x277CCAAC8]) initForReadingFromData:v9 error:&v182];
    v174 = v182;
    [v13 _allowDecodingCyclesInSecureMode];
    v170 = v13;
    v171 = v12;
    v14 = [v13 decodeObjectOfClasses:v12 forKey:*MEMORY[0x277CCA308]];
    if (!v14)
    {
      v15 = v9;
      v16 = objc_autoreleasePoolPush();
      v17 = self;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v20 = v19 = v8;
        *buf = 138543618;
        v208 = v20;
        v209 = 2112;
        v210 = v174;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive home from uncompressed data: %@", buf, 0x16u);

        v8 = v19;
      }

      objc_autoreleasePoolPop(v16);
      v9 = v15;
    }

    v21 = v14;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v22 = v21;
    }

    else
    {
      v22 = 0;
    }

    v23 = v22;

    v169 = v23;
    v24 = [v23 objectForKeyedSubscript:@"kHomeDataBlobKey"];
    [v24 _removeCorruptAccessories];
    v194 = @"kDataSyncResponseAckKey";
    v195 = MEMORY[0x277CBEC38];
    v168 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v195 forKeys:&v194 count:1];
    if (!v24)
    {
      goto LABEL_88;
    }

    v165 = v21;
    v166 = v8;
    v167 = v9;
    v162 = v7;
    v25 = self;
    v164 = v24;
    v26 = v24;
    v163 = v4;
    v175 = v4;
    v179 = v25;
    v181 = v26;
    v188 = 0u;
    v189 = 0u;
    v190 = 0u;
    v191 = 0u;
    obj = [(HMDHomeManager *)v179 homes];
    v27 = [obj countByEnumeratingWithState:&v188 objects:buf count:16];
    if (v27)
    {
      v28 = v27;
      v29 = *v189;
      while (2)
      {
        for (i = 0; i != v28; ++i)
        {
          if (*v189 != v29)
          {
            objc_enumerationMutation(obj);
          }

          v31 = *(*(&v188 + 1) + 8 * i);
          v32 = objc_autoreleasePoolPush();
          v33 = v179;
          v34 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v34, OS_LOG_TYPE_DEBUG))
          {
            v35 = HMFGetLogIdentifier();
            v36 = [v181 uuid];
            *v201 = 138543874;
            v202 = v35;
            v203 = 2112;
            v204 = v36;
            v205 = 2112;
            v206 = v31;
            _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_DEBUG, "%{public}@Looking for home uuid %@, currentHome:  %@", v201, 0x20u);
          }

          objc_autoreleasePoolPop(v32);
          v37 = [v31 uuid];
          if (v37)
          {
            v38 = v37;
            v39 = [v31 uuid];
            v40 = [v181 uuid];
            v41 = [v39 hmf_isEqualToUUID:v40];

            if (v41)
            {
              v65 = [v31 owner];
              v53 = [v65 pairingIdentity];
              v66 = v53;

              v67 = [v31 owner];
              v68 = [v67 account];
              v54 = [v68 senderCorrelationIdentifier];
              v69 = v54;

              v70 = objc_autoreleasePoolPush();
              v71 = v33;
              v72 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v72, OS_LOG_TYPE_DEBUG))
              {
                v73 = HMFGetLogIdentifier();
                *v201 = 138543618;
                v202 = v73;
                v203 = 2112;
                v204 = v54;
                _os_log_impl(&dword_2531F8000, v72, OS_LOG_TYPE_DEBUG, "%{public}@Found current home account mergeID %@", v201, 0x16u);
              }

              objc_autoreleasePoolPop(v70);
              v74 = [v31 owner];
              v44 = [v74 account];
              v75 = v44;

LABEL_44:
              v76 = 1;
              goto LABEL_53;
            }
          }
        }

        v28 = [obj countByEnumeratingWithState:&v188 objects:buf count:16];
        if (v28)
        {
          continue;
        }

        break;
      }
    }

    v186 = 0u;
    v187 = 0u;
    v184 = 0u;
    v185 = 0u;
    v42 = [(HMDHomeManager *)v179 incomingInvitations];
    v43 = [v42 copy];

    obj = v43;
    v44 = [v43 countByEnumeratingWithState:&v184 objects:v201 count:16];
    if (v44)
    {
      v45 = *v185;
LABEL_26:
      v46 = 0;
      while (1)
      {
        if (*v185 != v45)
        {
          objc_enumerationMutation(obj);
        }

        v47 = *(*(&v184 + 1) + 8 * v46);
        v48 = [v47 homeUUID];
        if (v48)
        {
          v49 = v48;
          v50 = [v47 homeUUID];
          v51 = [v181 uuid];
          v52 = [v50 hmf_isEqualToUUID:v51];

          if (v52)
          {
            break;
          }
        }

        if (v44 == ++v46)
        {
          v44 = [obj countByEnumeratingWithState:&v184 objects:v201 count:16];
          if (v44)
          {
            goto LABEL_26;
          }

          goto LABEL_33;
        }
      }

      v77 = [v47 isAccepted];
      v78 = objc_autoreleasePoolPush();
      v79 = v179;
      v80 = HMFGetOSLogHandle();
      v81 = os_log_type_enabled(v80, OS_LOG_TYPE_INFO);
      if (v77)
      {
        if (v81)
        {
          v82 = HMFGetLogIdentifier();
          *v197 = 138543618;
          v198 = v82;
          v199 = 2112;
          v200 = v47;
          _os_log_impl(&dword_2531F8000, v80, OS_LOG_TYPE_INFO, "%{public}@Received home sync for invitation: %@", v197, 0x16u);
        }

        objc_autoreleasePoolPop(v78);
        v53 = [v47 inviterIdentity];
        v83 = v53;
        v44 = [v47 inviterAccount];
        v84 = v44;
        v54 = [v47 inviterMergeID];
        v85 = v54;
        goto LABEL_44;
      }

      if (v81)
      {
        v86 = HMFGetLogIdentifier();
        *v197 = 138543618;
        v198 = v86;
        v199 = 2112;
        v200 = v47;
        _os_log_impl(&dword_2531F8000, v80, OS_LOG_TYPE_INFO, "%{public}@Received home sync for unaccepted invitation: %@", v197, 0x16u);
      }

      objc_autoreleasePoolPop(v78);
      v53 = 0;
      v54 = 0;
      v44 = 0;
    }

    else
    {
LABEL_33:
      v53 = 0;
      v54 = 0;
    }

    v76 = 0;
LABEL_53:
    v8 = v166;

    v87 = v53;
    v88 = v54;
    v89 = v44;
    v90 = objc_autoreleasePoolPush();
    v91 = v179;
    v92 = HMFGetOSLogHandle();
    v93 = v92;
    if ((v76 & 1) == 0)
    {
      if (os_log_type_enabled(v92, OS_LOG_TYPE_ERROR))
      {
        v117 = HMFGetLogIdentifier();
        *buf = 138543618;
        v208 = v117;
        v209 = 2112;
        v210 = v181;
        _os_log_impl(&dword_2531F8000, v93, OS_LOG_TYPE_ERROR, "%{public}@Unable to determine current owner of home: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v90);
      v114 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v118 = v114;
      v116 = 0;
      goto LABEL_68;
    }

    if (os_log_type_enabled(v92, OS_LOG_TYPE_DEBUG))
    {
      v94 = HMFGetLogIdentifier();
      *buf = 138544130;
      v208 = v94;
      v209 = 2112;
      v210 = v175;
      v211 = 2112;
      v212 = v87;
      v213 = 2112;
      v214 = v88;
      _os_log_impl(&dword_2531F8000, v93, OS_LOG_TYPE_DEBUG, "%{public}@Found owner identity, checking message: %@, against pairing identity: %@, mergeID: %@", buf, 0x2Au);
    }

    objc_autoreleasePoolPop(v90);
    v95 = [v175 remoteSenderContext];
    v96 = [v95 mergeID];
    v97 = [v88 isEqualToString:v96];

    v98 = [v87 identifier];
    v99 = [v175 remoteSenderContext];
    v100 = [v99 pairingIdentityIdentifier];
    v101 = v97 | [v98 isEqualToString:v100];

    v102 = [v175 remoteUserPairingIdentity];
    v103 = v101 | [v87 isEqual:v102];

    if ([v89 isAuthenticated])
    {
      v104 = [v175 remoteSourceDevice];
      v105 = [v104 account];
      v106 = [v89 isEqual:v105];

      if ((v106 & v103 & 1) == 0)
      {
LABEL_58:
        v107 = objc_autoreleasePoolPush();
        v108 = v91;
        v109 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v109, OS_LOG_TYPE_ERROR))
        {
          HMFGetLogIdentifier();
          v110 = obja = v88;
          [v89 isAuthenticated];
          v176 = HMFBooleanToString();
          [v175 remoteSourceDevice];
          v111 = v180 = v107;
          v112 = [v111 account];
          v113 = HMFBooleanToString();
          *buf = 138544898;
          v208 = v110;
          v209 = 2112;
          v210 = v181;
          v211 = 2112;
          v212 = v175;
          v213 = 2112;
          v214 = v89;
          v215 = 2112;
          v216 = v176;
          v217 = 2112;
          v218 = v112;
          v219 = 2112;
          v220 = v113;
          _os_log_impl(&dword_2531F8000, v109, OS_LOG_TYPE_ERROR, "%{public}@Received unexpected home data sync for home: %@, message: %@, ownerAccount: %@, ownerAccount.isAuthenticated: %@, sourceDevice.account: %@, isValidOwnerAccountIdentity: %@", buf, 0x48u);

          v107 = v180;
          v88 = obja;
        }

        objc_autoreleasePoolPop(v107);
        v114 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        v115 = v114;
        v116 = 0;
        v8 = v166;
LABEL_68:

        v123 = v114;
        v9 = v167;
        if ((v116 & 1) == 0)
        {
          v131 = [(HMDHomeManager *)v91 uuidsOfRemovedHomes];
          v132 = [v181 uuid];
          v133 = [v131 containsObject:v132];

          v7 = v162;
          v4 = v163;
          v5 = v173;
          if (v133)
          {
            v134 = objc_autoreleasePoolPush();
            v135 = v91;
            v136 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v136, OS_LOG_TYPE_INFO))
            {
              v137 = HMFGetLogIdentifier();
              *buf = 138543618;
              v208 = v137;
              v209 = 2112;
              v210 = v181;
              _os_log_impl(&dword_2531F8000, v136, OS_LOG_TYPE_INFO, "%{public}@Rejecting home data sync, home was removed: %@", buf, 0x16u);

              v9 = v167;
            }

            objc_autoreleasePoolPop(v134);
            v138 = [v175 responseHandler];

            v24 = v164;
            v129 = v168;
            if (!v138)
            {
              goto LABEL_79;
            }

            v139 = [v175 responseHandler];
            v192 = @"kDataSyncResponseNAckKey";
            v193 = MEMORY[0x277CBEC38];
            v140 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v193 forKeys:&v192 count:1];
            (v139)[2](v139, 0, v140);

            v21 = v165;
          }

          else
          {
            v153 = [v175 responseHandler];

            if (!v153)
            {
              v24 = v164;
              v21 = v165;
              v129 = v168;
              goto LABEL_97;
            }

            v139 = [v175 responseHandler];
            (v139)[2](v139, v123, 0);
            v24 = v164;
            v21 = v165;
            v129 = v168;
          }

          goto LABEL_97;
        }

        [v181 isOwnerUser];
        v7 = v162;
        v4 = v163;
        if ([HMDHomeManager isThisDeviceAdminOfHome:v181])
        {
          v124 = objc_autoreleasePoolPush();
          v125 = v91;
          v126 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v126, OS_LOG_TYPE_INFO))
          {
            v127 = HMFGetLogIdentifier();
            *buf = 138543618;
            v208 = v127;
            v209 = 2112;
            v210 = v181;
            _os_log_impl(&dword_2531F8000, v126, OS_LOG_TYPE_INFO, "%{public}@Dropping remote home sync to owner: %@", buf, 0x16u);

            v9 = v167;
          }

          objc_autoreleasePoolPop(v124);
          v128 = [v175 responseHandler];

          v24 = v164;
          v129 = v168;
          v5 = v173;
          if (v128)
          {
            v130 = [v175 responseHandler];
            v130[2](v130, 0, v168);
          }

LABEL_79:
          v21 = v165;
          goto LABEL_97;
        }

        v141 = [v181 uuid];
        v142 = [(HMDHomeManager *)v91 _homeWithUUID:v141];

        v143 = [v175 destination];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v144 = v143;
        }

        else
        {
          v144 = 0;
        }

        v145 = v144;

        v146 = [v145 device];

        v147 = [v146 version];

        LODWORD(v146) = [(HMDHomeManager *)v91 _shouldHandleHomeDataSync:v142 remoteHome:v181 sourceDeviceVersion:v147];
        v24 = v164;
        v21 = v165;
        if (v146)
        {
          if (([v181 isOwnerUser] & 1) == 0)
          {
            v154 = [HMDSharedHomeModel alloc];
            v155 = [v181 uuid];
            v156 = [(HMDHomeManager *)v91 uuid];
            v123 = [(HMDBackingStoreModelObject *)v154 initWithObjectChangeType:1 uuid:v155 parentUUID:v156];

            [(HMDSharedHomeModel *)v123 setHomeData:v167];
            v157 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v181, "configurationVersion")}];
            [(HMDSharedHomeModel *)v123 setConfigurationVersion:v157];

            v158 = [(HMDHomeManager *)v91 homes];
            v159 = [v158 count];

            if (!v159)
            {
              v160 = [v181 uuid];
              [(HMDHomeManager *)v91 setPrimaryHomeUUID:v160];
            }

            [(HMDHomeManager *)v91 transactionObjectUpdated:0 newValues:v123 message:v175, v162];
            v24 = v164;
            v21 = v165;
            v129 = v168;
            v5 = v173;
            goto LABEL_97;
          }

          v148 = objc_autoreleasePoolPush();
          v149 = v91;
          v150 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v150, OS_LOG_TYPE_ERROR))
          {
            v151 = HMFGetLogIdentifier();
            *buf = 138543618;
            v208 = v151;
            v209 = 2112;
            v210 = v181;
            _os_log_impl(&dword_2531F8000, v150, OS_LOG_TYPE_ERROR, "%{public}@Received unexpected home data sync for owned home %@", buf, 0x16u);

            v9 = v167;
          }

          objc_autoreleasePoolPop(v148);
          v24 = v164;
          v21 = v165;
        }

LABEL_88:
        v152 = [v4 responseHandler];

        v129 = v168;
        v5 = v173;
        if (!v152)
        {
LABEL_98:

          v64 = v172;
          goto LABEL_99;
        }

        v123 = [v4 responseHandler];
        (*&v123->super._bsoDataVersionOverride)(v123, 0, v168);
LABEL_97:

        goto LABEL_98;
      }
    }

    else if ((v103 & 1) == 0)
    {
      goto LABEL_58;
    }

    v119 = objc_autoreleasePoolPush();
    v120 = v91;
    v121 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v121, OS_LOG_TYPE_DEBUG))
    {
      v122 = HMFGetLogIdentifier();
      *buf = 138543618;
      v208 = v122;
      v209 = 2112;
      v210 = v175;
      _os_log_impl(&dword_2531F8000, v121, OS_LOG_TYPE_DEBUG, "%{public}@Accepting home data sync: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v119);
    v114 = 0;
    v116 = 1;
    goto LABEL_68;
  }

  v55 = objc_autoreleasePoolPush();
  v56 = self;
  v57 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
  {
    v58 = HMFGetLogIdentifier();
    v59 = [v4 remoteUserPairingIdentity];
    *buf = 138543618;
    v208 = v58;
    v209 = 2112;
    v210 = v59;
    _os_log_impl(&dword_2531F8000, v57, OS_LOG_TYPE_ERROR, "%{public}@Rejecting home data sync - Sync not from trusted account %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v55);
  [v4 respondWithError:v7];
LABEL_101:

  objc_autoreleasePoolPop(v5);
  v161 = *MEMORY[0x277D85DE8];
}

- (void)_handleHomeUpdateRequiredRequest:(id)a3
{
  v40 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [v4 identifier];
    *buf = 138543618;
    v35 = v8;
    v36 = 2112;
    v37 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Handling HH2 upgrade notification request messageID %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = [(HMDHomeManager *)v6 userDefaults];
  v11 = [v10 integerForKey:@"HMDHomeManagerHH2UpgradePushNotificationCount"];

  v12 = [(HMDHomeManager *)v6 idsServerBag];
  v13 = [v12 homeUpdateRequiredNotificationThreshold];

  if (!v13)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = v6;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v21;
      v36 = 2048;
      v37 = v11;
      v22 = "%{public}@Posting HH2 Upgrade bulletin notification (count: %ld, no serverbag threshold)";
      v23 = v19;
      v24 = 22;
      goto LABEL_9;
    }

LABEL_10:

    objc_autoreleasePoolPop(v17);
    v25 = +[HMDBulletinBoard sharedBulletinBoard];
    [v25 insertHH2UpgradeRecommendationBulletin:1];

    v26 = [(HMDHomeManager *)v18 userDefaults];
    [v26 setInteger:v11 + 1 forKey:@"HMDHomeManagerHH2UpgradePushNotificationCount"];

    v27 = 0;
    goto LABEL_14;
  }

  v14 = [(HMDHomeManager *)v6 idsServerBag];
  v15 = [v14 homeUpdateRequiredNotificationThreshold];
  v16 = [v15 unsignedIntValue];

  v17 = objc_autoreleasePoolPush();
  v18 = v6;
  v19 = HMFGetOSLogHandle();
  v20 = os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT);
  if (v11 < v16)
  {
    if (v20)
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543874;
      v35 = v21;
      v36 = 2048;
      v37 = v11;
      v38 = 2048;
      v39 = v16;
      v22 = "%{public}@Posting HH2 Upgrade bulletin notification (count: %ld, threshold: %ld)";
      v23 = v19;
      v24 = 32;
LABEL_9:
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, v22, buf, v24);

      goto LABEL_10;
    }

    goto LABEL_10;
  }

  if (v20)
  {
    v28 = HMFGetLogIdentifier();
    *buf = 138543874;
    v35 = v28;
    v36 = 2048;
    v37 = v11;
    v38 = 2048;
    v39 = v16;
    _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_DEFAULT, "%{public}@Threshold exceeded for HH2 Upgrade notifications (count: %ld, threshold: %ld), not posting bulletin", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v17);
  v27 = 1;
LABEL_14:
  v29 = [MEMORY[0x277CCABB0] numberWithBool:{v27, *MEMORY[0x277CD0230]}];
  v33 = v29;
  v30 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v33 forKeys:&v32 count:1];
  [v4 respondWithPayload:v30];

  v31 = *MEMORY[0x277D85DE8];
}

- (BOOL)_shouldHandleHomeDataSync:(id)a3 remoteHome:(id)a4 sourceDeviceVersion:(id)a5
{
  v39 = *MEMORY[0x277D85DE8];
  v7 = a3;
  v8 = a4;
  v9 = a5;
  if (isWatch())
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = 1;
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v31 = 138543362;
      v32 = v13;
      v14 = "%{public}@Adding or updating home on the watch";
LABEL_12:
      v21 = v11;
      v22 = 12;
LABEL_13:
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, v14, &v31, v22);

      goto LABEL_30;
    }

    goto LABEL_30;
  }

  if (v7)
  {
    v15 = [v7 sharedHomeUpdateHandler];
    if ([v15 pendingRequestDataFromResident])
    {
      v16 = [v7 sharedHomeSourceVersion];
      v17 = [v9 isGreaterThanVersion:v16];

      if (v17)
      {
        v18 = [v8 configurationVersion];
        if (v18 < [v7 configurationVersion])
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v19 = HMFGetLogIdentifier();
            v31 = 138543874;
            v32 = v19;
            v33 = 2048;
            v34 = [v7 configurationVersion];
            v35 = 2048;
            v36 = [v8 configurationVersion];
            v20 = "%{public}@Pending request data from resident is active, Local home is at version %ld and incoming home version is at %ld, discarding changes and sending ack";
LABEL_24:
            v27 = v11;
            v28 = 32;
            goto LABEL_25;
          }

          goto LABEL_26;
        }

        goto LABEL_16;
      }
    }

    else
    {
    }

    v23 = [v8 configurationVersion];
    if (v23 <= [v7 configurationVersion])
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v31 = 138543874;
        v32 = v19;
        v33 = 2048;
        v34 = [v7 configurationVersion];
        v35 = 2048;
        v36 = [v8 configurationVersion];
        v20 = "%{public}@Local home is at version %ld and incoming home version is at %ld, discarding changes and sending ack";
        goto LABEL_24;
      }

LABEL_26:
      v12 = 0;
      goto LABEL_30;
    }

LABEL_16:
    if (v9)
    {
      v24 = +[HMDHomeKitVersion version3];
      if ([v9 isAtLeastVersion:v24] && objc_msgSend(v7, "expectedConfigurationVersion"))
      {
        v25 = [v7 expectedConfigurationVersion];
        v26 = [v8 configurationVersion];

        if (v25 > v26)
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v19 = HMFGetLogIdentifier();
            v31 = 138544130;
            v32 = v19;
            v33 = 2048;
            v34 = [v7 configurationVersion];
            v35 = 2048;
            v36 = [v7 expectedConfigurationVersion];
            v37 = 2048;
            v38 = [v8 configurationVersion];
            v20 = "%{public}@Local is config version is at %ld and expected config version %ld and incoming home config version is at %ld, discarding changes and sending ack";
            v27 = v11;
            v28 = 42;
LABEL_25:
            _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, v20, &v31, v28);

            goto LABEL_26;
          }

          goto LABEL_26;
        }
      }

      else
      {
      }
    }

    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = 1;
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      goto LABEL_30;
    }

    v13 = HMFGetLogIdentifier();
    v31 = 138544130;
    v32 = v13;
    v33 = 2048;
    v34 = [v7 configurationVersion];
    v35 = 2048;
    v36 = [v7 expectedConfigurationVersion];
    v37 = 2048;
    v38 = [v8 configurationVersion];
    v14 = "%{public}@Local is config version is at %ld and expected config version %ld and incoming home config version is at %ld, accepting new changes";
    v12 = 1;
    v21 = v11;
    v22 = 42;
    goto LABEL_13;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = HMFGetOSLogHandle();
  v12 = 1;
  if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v31 = 138543362;
    v32 = v13;
    v14 = "%{public}@Receiving a new shared home";
    goto LABEL_12;
  }

LABEL_30:

  objc_autoreleasePoolPop(v10);
  v29 = *MEMORY[0x277D85DE8];
  return v12;
}

- (void)fragmentationStream:(id)a3 didReceiveData:(id)a4 transactionIdentifier:(unsigned __int16)a5 error:(id)a6
{
  v10 = a3;
  v11 = a4;
  v12 = a6;
  if (v11)
  {
    v13 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __81__HMDHomeManager_fragmentationStream_didReceiveData_transactionIdentifier_error___block_invoke;
    block[3] = &unk_279732648;
    block[4] = self;
    v15 = v10;
    v16 = v11;
    v18 = a5;
    v17 = v12;
    dispatch_async(v13, block);
  }
}

- (void)fragmentationStream:(id)a3 didCloseWithError:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __56__HMDHomeManager_fragmentationStream_didCloseWithError___block_invoke;
  block[3] = &unk_279734960;
  block[4] = self;
  v12 = v6;
  v13 = v7;
  v9 = v7;
  v10 = v6;
  dispatch_async(v8, block);
}

- (void)processSharedHomeModelRemoved:(id)a3 message:(id)a4
{
  v25 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 uuid];
  if (v8)
  {
    v9 = [(HMDHomeManager *)self _homeWithUUID:v8];
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    v12 = v11;
    if (v9)
    {
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v21 = 138543618;
        v22 = v13;
        v23 = 2112;
        v24 = v9;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Attempting to remove home %@ since we are no longer part of the home", &v21, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      [(HMDHomeManager *)self _removeHome:v9 withMessage:v7 saveToStore:1 notifyUsers:0 shouldRemovePairings:0];
      goto LABEL_13;
    }

    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v16 = HMFGetLogIdentifier();
      v17 = [v8 UUIDString];
      v21 = 138543618;
      v22 = v16;
      v23 = 2112;
      v24 = v17;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Home %@ not found for user", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v18 = [v7 responseHandler];

    if (!v18)
    {
      goto LABEL_13;
    }

    v15 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
    v19 = [v7 responseHandler];
    v19[2](v19, v15, 0);

LABEL_12:
LABEL_13:

    goto LABEL_14;
  }

  v14 = [v7 responseHandler];

  if (v14)
  {
    v9 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    v15 = [v7 responseHandler];
    (v15)[2](v15, v9, 0);
    goto LABEL_12;
  }

LABEL_14:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_handleUserRemoved:(id)a3
{
  v25 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:*MEMORY[0x277CD0640]];
  v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
  if (v6)
  {
    v7 = v4;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v8 = v7;
    }

    else
    {
      v8 = 0;
    }

    v9 = v8;

    if ([v7 isRemote] && objc_msgSend(v9, "restriction") != 4)
    {
      v10 = __isUserInMessagePartOfHome(self, v6, v7);
      if (([v10 isOwner] & 1) == 0)
      {
        v14 = objc_autoreleasePoolPush();
        v15 = self;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
        {
          v17 = HMFGetLogIdentifier();
          v21 = 138543618;
          v22 = v17;
          v23 = 2112;
          v24 = v7;
          _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Only owner can remove homes: %@", &v21, 0x16u);
        }

        objc_autoreleasePoolPop(v14);
        v18 = [v7 responseHandler];

        if (v18)
        {
          v19 = [v7 responseHandler];
          v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
          (v19)[2](v19, v20, 0);
        }

        goto LABEL_10;
      }
    }

    v10 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    [(HMDHomeManager *)self scheduleRemovalForHome:v6 message:v7 options:v10];
LABEL_10:

LABEL_13:
    goto LABEL_14;
  }

  v11 = [v4 responseHandler];

  if (v11)
  {
    v9 = [v4 responseHandler];
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(v9 + 2))(v9, v12, 0);

    goto LABEL_13;
  }

LABEL_14:

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_handleResetHome:(id)a3
{
  v41 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:*MEMORY[0x277CD0640]];
  if (v5)
  {
    v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
    if (v6)
    {
      v7 = v6;
      v8 = v4;
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v9 = v8;
      }

      else
      {
        v9 = 0;
      }

      v10 = v9;

      if (![v8 isRemote] || objc_msgSend(v10, "restriction") == 4)
      {
        goto LABEL_10;
      }

      v11 = __isUserInMessagePartOfHome(self, v7, v8);
      if ([v11 isOwner])
      {

LABEL_10:
        v12 = objc_autoreleasePoolPush();
        v13 = self;
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          v37 = 138543618;
          v38 = v15;
          v39 = 2112;
          v40 = v7;
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Received request to reset configuration for home %@", &v37, 0x16u);
        }

        objc_autoreleasePoolPop(v12);
        v16 = objc_autoreleasePoolPush();
        v17 = v13;
        v18 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
        {
          v19 = HMFGetLogIdentifier();
          v37 = 138543618;
          v38 = v19;
          v39 = 2112;
          v40 = v7;
          _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Attempting to reset home %@ by removing it", &v37, 0x16u);
        }

        objc_autoreleasePoolPop(v16);
        [(HMDHomeManager *)v17 _removeHome:v7 withMessage:v8 saveToStore:1 notifyUsers:1 shouldRemovePairings:0];
        goto LABEL_21;
      }

      v30 = objc_autoreleasePoolPush();
      v31 = self;
      v32 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v32, OS_LOG_TYPE_ERROR))
      {
        v33 = HMFGetLogIdentifier();
        v37 = 138543618;
        v38 = v33;
        v39 = 2112;
        v40 = v8;
        _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, "%{public}@Only owner can remove homes: %@", &v37, 0x16u);
      }

      objc_autoreleasePoolPop(v30);
      v34 = [v8 responseHandler];

      if (v34)
      {
        v35 = [v8 responseHandler];
        v36 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        (v35)[2](v35, v36, 0);
      }
    }

    else
    {
      v24 = objc_autoreleasePoolPush();
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
      {
        v26 = HMFGetLogIdentifier();
        v27 = [v5 UUIDString];
        v37 = 138543618;
        v38 = v26;
        v39 = 2112;
        v40 = v27;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@Cannot reset home %@ since it could not be found", &v37, 0x16u);
      }

      objc_autoreleasePoolPop(v24);
      v10 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
      v28 = [v4 responseHandler];
      (v28)[2](v28, v10, 0);

      v7 = 0;
    }
  }

  else
  {
    v20 = objc_autoreleasePoolPush();
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v22 = HMFGetLogIdentifier();
      v23 = [v4 name];
      v37 = 138543618;
      v38 = v22;
      v39 = 2112;
      v40 = v23;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for message %@", &v37, 0x16u);
    }

    objc_autoreleasePoolPop(v20);
    v7 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    v10 = [v4 responseHandler];
    (*(v10 + 2))(v10, v7, 0);
  }

LABEL_21:

  v29 = *MEMORY[0x277D85DE8];
}

- (void)_removeAllUsersOfHome:(id)a3
{
  v78[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v77 = *MEMORY[0x277CD0640];
  v52 = v4;
  v5 = [v4 uuid];
  v6 = [v5 UUIDString];
  v78[0] = v6;
  v53 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v78 forKeys:&v77 count:1];

  v66 = 0u;
  v67 = 0u;
  v64 = 0u;
  v65 = 0u;
  obj = [(HMDHomeManager *)self associatedWatchPeers];
  v7 = [obj countByEnumeratingWithState:&v64 objects:v76 count:16];
  if (v7)
  {
    v8 = *v65;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v65 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v10 = *(*(&v64 + 1) + 8 * i);
        v11 = objc_autoreleasePoolPush();
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          v14 = [v52 name];
          *buf = 138543874;
          v71 = v13;
          v72 = 2112;
          v73 = v14;
          v74 = 2112;
          v75 = v10;
          _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Sending the remove home for %@ to watch %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v11);
        v15 = [HMDDevice deviceWithDestination:v10];
        v16 = [HMDRemoteDeviceMessageDestination alloc];
        v17 = [(HMDHomeManager *)self uuid];
        v18 = [(HMDRemoteDeviceMessageDestination *)v16 initWithTarget:v17 device:v15];

        v19 = [MEMORY[0x277D0F818] internalMessageWithName:@"kUserResetHomeConfigRequestKey" destination:v18 messagePayload:v53];
        v20 = [(HMDHomeManager *)self messageDispatcher];
        [v20 sendMessage:v19 completionHandler:0];
      }

      v7 = [obj countByEnumeratingWithState:&v64 objects:v76 count:16];
    }

    while (v7);
  }

  v62 = 0u;
  v63 = 0u;
  v60 = 0u;
  v61 = 0u;
  v21 = [v52 users];
  v22 = [v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
  if (v22)
  {
    v23 = *v61;
    do
    {
      for (j = 0; j != v22; ++j)
      {
        if (*v61 != v23)
        {
          objc_enumerationMutation(v21);
        }

        v25 = [*(*(&v60 + 1) + 8 * j) account];
        v26 = [v25 senderCorrelationIdentifier];
        [(HMDHomeManager *)self _trackRemovedHomeUserMergeId:v26];
      }

      v22 = [v21 countByEnumeratingWithState:&v60 objects:v69 count:16];
    }

    while (v22);
  }

  [v52 isOwnerUser];
  if ([HMDHomeManager isThisDeviceAdminOfHome:v52])
  {
    v27 = [v52 users];
    v28 = [v27 copy];

    v58 = 0u;
    v59 = 0u;
    v56 = 0u;
    v57 = 0u;
    v49 = v28;
    v29 = [v49 countByEnumeratingWithState:&v56 objects:v68 count:16];
    if (v29)
    {
      obja = *v57;
      *&v30 = 138543874;
      v48 = v30;
      do
      {
        for (k = 0; k != v29; ++k)
        {
          if (*v57 != obja)
          {
            objc_enumerationMutation(v49);
          }

          v32 = *(*(&v56 + 1) + 8 * k);
          v33 = [v52 currentUser];
          v34 = [v32 isEqual:v33];

          if ((v34 & 1) == 0)
          {
            objc_opt_class();
            isKindOfClass = objc_opt_isKindOfClass();
            v36 = [(HMDHomeManager *)self uuid];
            v37 = [v32 userID];
            if (isKindOfClass)
            {
              v38 = [v32 userID];
              v39 = [HMDMessageDispatcher destinationWithTarget:v36 userID:v37 destination:v38 multicast:0];
            }

            else
            {
              v39 = [HMDMessageDispatcher destinationWithTarget:v36 userID:v37 destination:0 multicast:0];
            }

            if (v39)
            {
              v40 = [HMDRemoteMessage secureMessageWithName:@"kUserResetHomeConfigRequestKey" destination:v39 messagePayload:v53];
              objc_initWeak(buf, self);
              v54[0] = MEMORY[0x277D85DD0];
              v54[1] = 3221225472;
              v54[2] = __40__HMDHomeManager__removeAllUsersOfHome___block_invoke;
              v54[3] = &unk_279733AE8;
              v54[4] = v32;
              objc_copyWeak(&v55, buf);
              [v40 setResponseHandler:v54];
              v41 = [(HMDHomeManager *)self messageDispatcher];
              [v41 sendMessage:v40 completionHandler:0];

              objc_destroyWeak(&v55);
              objc_destroyWeak(buf);
            }

            else
            {
              v42 = objc_autoreleasePoolPush();
              v43 = self;
              v44 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
              {
                v45 = HMFGetLogIdentifier();
                v46 = [v32 userID];
                *buf = v48;
                v71 = v45;
                v72 = 2112;
                v73 = v32;
                v74 = 2112;
                v75 = v46;
                _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot notify user %@ of home reset: could not create message destination for userID: %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v42);
            }
          }
        }

        v29 = [v49 countByEnumeratingWithState:&v56 objects:v68 count:16];
      }

      while (v29);
    }
  }

  v47 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__removeAllUsersOfHome___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v25 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [*(a1 + 32) home];
    *buf = 138543874;
    v20 = v9;
    v21 = 2112;
    v22 = v10;
    v23 = 2112;
    v24 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Reset home for user %@ with error: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v7);
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained && [*(a1 + 32) isRemoteGateway])
  {
    v12 = [WeakRetained workQueue];
    v16[0] = MEMORY[0x277D85DD0];
    v16[1] = 3221225472;
    v16[2] = __40__HMDHomeManager__removeAllUsersOfHome___block_invoke_1305;
    v16[3] = &unk_2797359B0;
    v13 = WeakRetained;
    v14 = *(a1 + 32);
    v17 = v13;
    v18 = v14;
    dispatch_async(v12, v16);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__removeAllUsersOfHome___block_invoke_1305(uint64_t a1)
{
  v2 = *(a1 + 32);
  v4 = [*(a1 + 40) userID];
  v3 = [*(a1 + 40) home];
  [v2 _removeFromAssociatedPeers:v4 home:v3];
}

- (void)_sendUserRemoved:(id)a3 fromHome:(id)a4 pairingUsername:(id)a5 pushToCloud:(BOOL)a6 completionHandler:(id)a7
{
  v43 = a6;
  location[2] = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a4;
  v39 = a5;
  v45 = a7;
  v12 = MEMORY[0x277D0F818];
  v58 = *MEMORY[0x277CD0640];
  v13 = [v11 uuid];
  v14 = [v13 UUIDString];
  v59 = v14;
  v15 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v59 forKeys:&v58 count:1];
  v16 = [v12 internalMessageWithName:@"kUserRemovedRequestKey" messagePayload:v15];

  if ([v10 isRemoteGateway])
  {
    v41 = [v10 userID];
  }

  else
  {
    v41 = 0;
  }

  v62 = @"kDeviceClassTypeKey";
  v63 = @"kDeviceClassTypeTransient";
  v64[0] = @"kRequiredCapabilitiesKey";
  v17 = MEMORY[0x277CBEAC0];
  v18 = @"kDeviceClassTypeTransient";
  v19 = [v17 dictionaryWithObjects:&v63 forKeys:&v62 count:1];
  v64[1] = @"kRequestedCapabilitiesKey";
  location[0] = v19;
  v60[0] = @"kHomedVersionKey";
  v60[1] = @"kHomeKitVersionStringKey";
  v61[0] = homedVersion;
  v20 = homedVersion;
  v21 = +[HMDHomeKitVersion currentVersion];
  v22 = [v21 versionString];
  v61[1] = v22;
  v23 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v61 forKeys:v60 count:2];
  location[1] = v23;
  v40 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:location forKeys:v64 count:2];

  objc_initWeak(location, self);
  v24 = [v10 userID];
  v25 = [(HMDHomeManager *)self workQueue];
  v51[0] = MEMORY[0x277D85DD0];
  v51[1] = 3221225472;
  v51[2] = __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke;
  v51[3] = &unk_279732620;
  objc_copyWeak(&v56, location);
  v37 = v45;
  v55 = v37;
  v46 = v11;
  v52 = v46;
  v26 = v10;
  v53 = v26;
  v38 = v16;
  v54 = v38;
  [(HMDHomeManager *)self electDeviceForUser:v24 destination:v41 deviceCapabilities:v40 queue:v25 completionHandler:v51];

  if (v43)
  {
    v44 = [MEMORY[0x277CBEB58] set];
    v49 = 0u;
    v50 = 0u;
    v47 = 0u;
    v48 = 0u;
    v27 = [v46 users];
    v28 = [v27 countByEnumeratingWithState:&v47 objects:v57 count:16];
    if (!v28)
    {
      goto LABEL_18;
    }

    v29 = *v48;
    while (1)
    {
      for (i = 0; i != v28; ++i)
      {
        if (*v48 != v29)
        {
          objc_enumerationMutation(v27);
        }

        v31 = *(*(&v47 + 1) + 8 * i);
        if ([v31 isRemoteGateway])
        {
          v32 = [v31 userID];
          v33 = [v26 userID];
          if ([v32 isEqualToString:v33])
          {
          }

          else
          {
            v34 = [v46 currentUser];
            v35 = [v31 isEqual:v34];

            if (v35)
            {
              continue;
            }

            v32 = [v31 userID];
            [v44 addObject:v32];
          }
        }
      }

      v28 = [v27 countByEnumeratingWithState:&v47 objects:v57 count:16];
      if (!v28)
      {
LABEL_18:

        [(HMDHomeManager *)self _pushChangesToUsers:v44 forHome:v46];
        [(HMDHomeManager *)self setUploadHomeDataToCloud:1];
        [(HMDHomeManager *)self _pushChangesToCloud:0 withDelay:0.0];

        break;
      }
    }
  }

  objc_destroyWeak(&v56);
  objc_destroyWeak(location);

  v36 = *MEMORY[0x277D85DE8];
}

void __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v37 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if (v7)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = WeakRetained;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        v15 = *(a1 + 32);
        *buf = 138543618;
        v34 = v14;
        v35 = 2112;
        v36 = v15;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Failed to elect device to send request to remove user from home: %@", buf, 0x16u);
      }

LABEL_14:

      objc_autoreleasePoolPop(v11);
      (*(*(a1 + 56) + 16))();
      goto LABEL_15;
    }

    if (([*(a1 + 32) containsRemovedUser:*(a1 + 40)] & 1) == 0)
    {
      v11 = objc_autoreleasePoolPush();
      v12 = WeakRetained;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v25 = HMFGetLogIdentifier();
        *buf = 138543362;
        v34 = v25;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Skipping send remove user message due to the user being removed from removed user list", buf, 0xCu);
      }

      goto LABEL_14;
    }

    v28 = [WeakRetained messageDispatcher];
    v27 = *(a1 + 48);
    v21 = [WeakRetained uuid];
    v22 = [*(a1 + 40) userID];
    v23 = [v8 destination];
    v24 = [WeakRetained workQueue];
    v29[0] = MEMORY[0x277D85DD0];
    v29[1] = 3221225472;
    v29[2] = __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke_1301;
    v29[3] = &unk_279731AF8;
    objc_copyWeak(&v32, (a1 + 64));
    v30 = *(a1 + 40);
    v31 = *(a1 + 56);
    [v28 sendSecureMessage:v27 target:v21 userID:v22 destination:v23 responseQueue:v24 responseHandler:v29];

    objc_destroyWeak(&v32);
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543362;
      v34 = v18;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, "%{public}@Lost reference to home manager while electing a device to remove user", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v19 = *(a1 + 56);
    if (v19)
    {
      v20 = [MEMORY[0x277CCA9B8] hmfErrorWithCode:8];
      (*(v19 + 16))(v19, v20, v9);
    }
  }

LABEL_15:

  v26 = *MEMORY[0x277D85DE8];
}

void __90__HMDHomeManager__sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke_1301(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = WeakRetained;
    v10 = HMFGetOSLogHandle();
    v11 = v10;
    if (v5)
    {
      if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
      {
        v12 = HMFGetLogIdentifier();
        v22 = 138543618;
        v23 = v12;
        v24 = 2112;
        v25 = v5;
        v13 = "%{public}@User removed message responded with error: %@";
        v14 = v11;
        v15 = OS_LOG_TYPE_ERROR;
LABEL_10:
        _os_log_impl(&dword_2531F8000, v14, v15, v13, &v22, 0x16u);
      }
    }

    else if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v19 = *(a1 + 32);
      v22 = 138543618;
      v23 = v12;
      v24 = 2112;
      v25 = v19;
      v13 = "%{public}@Successfully removed user: %@";
      v14 = v11;
      v15 = OS_LOG_TYPE_INFO;
      goto LABEL_10;
    }

    objc_autoreleasePoolPop(v8);
    (*(*(a1 + 40) + 16))(*(a1 + 40), v5, v6, v20);
    goto LABEL_12;
  }

  v16 = objc_autoreleasePoolPush();
  v17 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v17, OS_LOG_TYPE_ERROR))
  {
    v18 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v18;
    _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, "%{public}@Lost reference to home manager while sending remove user message", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v16);
LABEL_12:

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_sendUserAdded:(id)a3 destination:(id)a4 toHome:(id)a5
{
  v53 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v41 = a4;
  v9 = a5;
  if (shouldLogPrivateInformation())
  {
    v10 = [v8 userID];
  }

  else
  {
    v10 = @"...";
    v11 = @"...";
  }

  v12 = shouldLogPrivateInformation();
  v13 = v41;
  if (!v12)
  {
    v13 = @"...";
  }

  v14 = v13;
  v15 = objc_autoreleasePoolPush();
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    *buf = 138543874;
    v48 = v17;
    v49 = 2112;
    v50 = v10;
    v51 = 2112;
    v52 = v14;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Going to send home configuration to added user %@ at %@ and all resident devices", buf, 0x20u);
  }

  v35 = v14;

  objc_autoreleasePoolPop(v15);
  if ([v8 isRemoteGateway])
  {
    v18 = objc_autoreleasePoolPush();
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543618;
      v48 = v20;
      v49 = 2112;
      v50 = v10;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Removing resident user %@ from unassociated list", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v21 = [v8 userID];
    [(HMDHomeManager *)self _removeFromUnassociatedPeers:v21 home:v9];
  }

  v36 = v10;
  v37 = self;
  v22 = [MEMORY[0x277CBEB18] array];
  v40 = [MEMORY[0x277CBEB18] array];
  [MEMORY[0x277CBEB18] array];
  v39 = v38 = v9;
  v42 = 0u;
  v43 = 0u;
  v44 = 0u;
  v45 = 0u;
  v23 = [v9 users];
  v24 = [v23 countByEnumeratingWithState:&v42 objects:v46 count:16];
  if (v24)
  {
    v25 = v24;
    v26 = *v43;
    do
    {
      for (i = 0; i != v25; ++i)
      {
        if (*v43 != v26)
        {
          objc_enumerationMutation(v23);
        }

        v28 = *(*(&v42 + 1) + 8 * i);
        v29 = [v28 isRemoteGateway];
        v30 = [v28 userID];
        if (v29)
        {
          v31 = v22;
LABEL_24:
          [v31 addObject:v30];

          continue;
        }

        v32 = [v8 userID];
        v33 = [(HMDHomeDataPushDestination *)v30 isEqualToString:v32];

        if (v41 && v33)
        {
          v30 = [[HMDHomeDataPushDestination alloc] initWithUser:v28 destination:v41];
          [(HMDHomeDataPushDestination *)v30 setIgnoreConfigCompare:1];
          if ([v28 isAdministrator])
          {
            v31 = v39;
          }

          else
          {
            v31 = v40;
          }

          goto LABEL_24;
        }
      }

      v25 = [v23 countByEnumeratingWithState:&v42 objects:v46 count:16];
    }

    while (v25);
  }

  [(HMDHomeManager *)v37 _pushChangesForHome:v38 toRemoteDevicesOnSameAccount:v22 addedUser:v8];
  [(HMDHomeManager *)v37 _pushChangesForHome:v38 toRegularUsersOfHome:v40 adminUsersOfHome:v39];

  v34 = *MEMORY[0x277D85DE8];
}

- (void)_acceptHomeInviteFromAccount:(id)a3 message:(id)a4 trackInvite:(BOOL)a5
{
  v5 = a5;
  v68 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = [v9 messagePayload];
  v11 = [v10 objectForKeyedSubscript:@"kRequestedCapabilitiesKey"];

  v12 = objc_autoreleasePoolPush();
  v13 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v65 = v15;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Handling request for getting controller identity for home invite request", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v12);
  if (v8)
  {
    v16 = [v9 dataForKey:@"kControllerPublicKey"];
    v17 = [v9 stringForKey:@"kControllerPairingNameKey"];
    v18 = v17;
    if (v16 && v17)
    {
      v19 = v11;
      v56 = v16;
      v20 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v16];
      v21 = [objc_alloc(MEMORY[0x277CFEC20]) initWithIdentifier:v18 publicKey:v20 privateKey:0 permissions:0];
      v22 = +[HMDIdentityRegistry sharedRegistry];
      [v22 registerIdentity:v21 account:v8 object:v13];

      v60 = 0;
      v61 = 0;
      v59 = 0;
      LOBYTE(v22) = [(HMDHomeManager *)v13 getOrCreateControllerPublicKey:&v61 controllerUsername:&v60 error:&v59];
      v58 = v61;
      v57 = v60;
      v23 = v59;
      v24 = v23;
      if (v22)
      {
        v52 = v23;
        if (v5)
        {
          v25 = [v9 remoteSenderContext];
          v26 = [v25 mergeID];
          v27 = [v9 messagePayload];
          v28 = [(HMDHomeManager *)v13 _trackIncomingInvitationFromAccount:v8 mergeID:v26 idsInvitationIdentifier:0 payload:v27 invitationState:5 error:0];
        }

        v54 = v8;
        v29 = objc_autoreleasePoolPush();
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
        {
          v31 = HMFGetLogIdentifier();
          *buf = 138543618;
          v65 = v31;
          v66 = 2112;
          v67 = v58;
          _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Preparing response for request for controller info: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v29);
        v32 = [MEMORY[0x277CBEB38] dictionary];
        v62[0] = @"kControllerPublicKey";
        v33 = v58;
        if (!v58)
        {
          v33 = [MEMORY[0x277CBEB68] null];
        }

        v55 = v20;
        v63[0] = v33;
        v63[1] = v57;
        v62[1] = @"kControllerPairingNameKey";
        v62[2] = @"kInviteAcceptedKey";
        v63[2] = MEMORY[0x277CBEC38];
        v34 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v63 forKeys:v62 count:{3, v52}];
        [v32 addEntriesFromDictionary:v34];

        if (!v58)
        {
        }

        v35 = [(HMDHomeManager *)v13 appleAccountManager];
        v36 = [v35 account];
        v37 = [v36 primaryHandle];

        v8 = v54;
        if (v37)
        {
          v38 = +[HMDAccountHandleFormatter defaultFormatter];
          v39 = [v38 stringForObjectValue:v37];

          if (v39)
          {
            [v32 setObject:v39 forKeyedSubscript:@"kUserIDKey"];
          }
        }

        v40 = [(HMDHomeManager *)v13 _prepareAnswerForRequestedCapabilities:v19];
        if (v40)
        {
          [v32 addEntriesFromDictionary:v40];
        }

        [(HMDHomeManager *)v13 _updateIncomingInvitesPresent];
        v41 = [v9 responseHandler];
        v41[2](v41, 0, v32);

        v20 = v55;
        v11 = v19;
        v24 = v53;
      }

      else
      {
        v32 = [v9 responseHandler];
        (v32)[2](v32, v24, 0);
        v11 = v19;
      }

      v16 = v56;
    }

    else
    {
      v47 = objc_autoreleasePoolPush();
      v48 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v48, OS_LOG_TYPE_DEFAULT))
      {
        v49 = HMFGetLogIdentifier();
        v50 = [v9 name];
        *buf = 138543618;
        v65 = v49;
        v66 = 2112;
        v67 = v50;
        _os_log_impl(&dword_2531F8000, v48, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for message %@, missing controller or public key", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v47);
      v20 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
      v21 = [v9 responseHandler];
      (v21)[2](v21, v20, 0);
    }

    goto LABEL_32;
  }

  v42 = objc_autoreleasePoolPush();
  v43 = v13;
  v44 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
  {
    v45 = HMFGetLogIdentifier();
    *buf = 138543618;
    v65 = v45;
    v66 = 2112;
    v67 = v9;
    _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_ERROR, "%{public}@Failed to resolve inviter account for message: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v42);
  v46 = [v9 responseHandler];

  if (v46)
  {
    v16 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    v18 = [v9 responseHandler];
    (v18)[2](v18, v16, 0);
LABEL_32:
  }

  v51 = *MEMORY[0x277D85DE8];
}

- (void)_postIncomingInvitationStateChangedNotification:(id)a3 newInvitationState:(int64_t)a4
{
  v28[1] = *MEMORY[0x277D85DE8];
  v6 = a3;
  [v6 updateInvitationState:a4];
  v28[0] = v6;
  v7 = [MEMORY[0x277CBEA60] arrayWithObjects:v28 count:1];
  v8 = encodeRootObjectForIncomingXPCMessage(v7, 0);

  v26 = @"kInvitationsDataKey";
  v27 = v8;
  v9 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v27 forKeys:&v26 count:1];
  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [MEMORY[0x277CCABB0] numberWithInteger:a4];
    v15 = [v6 describeWithFormat];
    v20 = 138543874;
    v21 = v13;
    v22 = 2112;
    v23 = v14;
    v24 = 2112;
    v25 = v15;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Posting incoming state update to clients: %@ / %@", &v20, 0x20u);
  }

  objc_autoreleasePoolPop(v10);
  v16 = [MEMORY[0x277D0F818] entitledMessageWithName:@"kUserInvitationsUpdatedNotificationKey" messagePayload:v9];
  v17 = [(HMDHomeManager *)v11 messageDispatcher];
  v18 = [(HMDHomeManager *)v11 uuid];
  [v17 sendMessage:v16 target:v18];

  v19 = *MEMORY[0x277D85DE8];
}

- (id)_trackIncomingInvitationFromAccount:(id)a3 mergeID:(id)a4 idsInvitationIdentifier:(id)a5 payload:(id)a6 invitationState:(int64_t)a7 error:(id *)a8
{
  v103 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v78 = a4;
  v72 = a5;
  v80 = a6;
  v13 = objc_autoreleasePoolPush();
  v79 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543874;
    v91 = v15;
    v92 = 2112;
    v93 = v12;
    v94 = 2112;
    v95 = v80;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Incoming invitation from account %@ with payload: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v13);
  v76 = [v80 hmf_stringForKey:*MEMORY[0x277CD23D0]];
  v16 = [v80 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v77 = [v80 hmf_UUIDForKey:@"kInvitationIdentifierKey"];
  v73 = [v80 hmf_dateForKey:@"kInvitationExpiryDateKey"];
  v88 = 0u;
  v89 = 0u;
  v86 = 0u;
  v87 = 0u;
  v17 = [(HMDHomeManager *)v79 incomingInvitations];
  v18 = [v17 copy];

  v19 = [v18 countByEnumeratingWithState:&v86 objects:v102 count:16];
  if (v19)
  {
    v20 = *v87;
LABEL_5:
    v21 = 0;
    while (1)
    {
      if (*v87 != v20)
      {
        objc_enumerationMutation(v18);
      }

      v22 = *(*(&v86 + 1) + 8 * v21);
      v23 = [v22 homeUUID];
      if ([v23 isEqual:v16])
      {
        v24 = [v22 inviterAccount];
        v25 = [v24 isRelatedToAccount:v12];

        if (v25)
        {
          v26 = v22;

          if (!v26)
          {
            goto LABEL_18;
          }

          if ([(HMDHomeInvitation *)v26 isExpired])
          {
            v27 = v26;
            goto LABEL_19;
          }

          v51 = objc_autoreleasePoolPush();
          v52 = v79;
          v53 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v53, OS_LOG_TYPE_DEFAULT))
          {
            v54 = HMFGetLogIdentifier();
            v55 = [v12 shortDescription];
            v56 = [v16 UUIDString];
            *buf = 138544130;
            v91 = v54;
            v92 = 2112;
            v93 = v55;
            v94 = 2112;
            v95 = v76;
            v96 = 2112;
            v97 = v56;
            _os_log_impl(&dword_2531F8000, v53, OS_LOG_TYPE_DEFAULT, "%{public}@Ignoring invite since we are already tracking an invite from account %@ for home %@(%@)", buf, 0x2Au);
          }

          objc_autoreleasePoolPop(v51);
          if (a7 == 5)
          {
            v45 = 0;
            goto LABEL_40;
          }

          goto LABEL_46;
        }
      }

      else
      {
      }

      if (v19 == ++v21)
      {
        v19 = [v18 countByEnumeratingWithState:&v86 objects:v102 count:16];
        if (v19)
        {
          goto LABEL_5;
        }

        break;
      }
    }
  }

LABEL_18:
  v27 = 0;
LABEL_19:
  v28 = [v80 hmf_dataForKey:@"kControllerPublicKey"];
  v75 = [v80 hmf_stringForKey:@"kControllerPairingNameKey"];
  if (v28 && v75)
  {
    v71 = [objc_alloc(MEMORY[0x277D0F8B0]) initWithPairingKeyData:v28];
    v69 = [objc_alloc(MEMORY[0x277D0F8A8]) initWithIdentifier:v75 publicKey:v71 privateKey:0];
    if ([(HMDHomeInvitation *)v27 isExpired])
    {
      v29 = objc_autoreleasePoolPush();
      v30 = v79;
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        v33 = [v12 shortDescription];
        *buf = 138543618;
        v91 = v32;
        v92 = 2112;
        v93 = v33;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Existing invitation from user (%@) was expired, recreating a new invitation", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v29);
      [(HMDHomeManager *)v30 _postIncomingInvitationStateChangedNotification:v27 newInvitationState:6];
      [(HMDHomeManager *)v30 _removeIncomingInvitation:v27];
    }

    v26 = [[HMDIncomingHomeInvitation alloc] initWithInviterAccount:v12 invitationIdentifier:v77 invitationState:a7 homeName:v76 homeUUID:v16 inviterIdentity:v69 inviterMergeID:v78 expiryDate:v73];

    v34 = objc_autoreleasePoolPush();
    v35 = v79;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
    {
      v37 = HMFGetLogIdentifier();
      *buf = 138543874;
      v91 = v37;
      v92 = 2112;
      v93 = v78;
      v94 = 2112;
      v95 = v77;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Received incoming invitation from mergeID %@ for invite %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v34);
    v38 = [(HMDHomeManager *)v35 workQueue];
    [(HMDHomeInvitation *)v26 setClientQueue:v38];

    objc_initWeak(&location, v35);
    objc_initWeak(&from, v26);
    v81[0] = MEMORY[0x277D85DD0];
    v81[1] = 3221225472;
    v81[2] = __116__HMDHomeManager__trackIncomingInvitationFromAccount_mergeID_idsInvitationIdentifier_payload_invitationState_error___block_invoke;
    v81[3] = &unk_279733938;
    objc_copyWeak(&v82, &location);
    objc_copyWeak(&v83, &from);
    v81[4] = v35;
    [(HMDHomeInvitation *)v26 setExpirationHandler:v81];
    [(HMDHomeManager *)v35 _addIncomingInvitation:v26];
    [(HMDHomeManager *)v35 _postIncomingInvitationStateChangedNotification:v26 newInvitationState:a7];
    context = objc_autoreleasePoolPush();
    v39 = v35;
    v40 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
    {
      v67 = HMFGetLogIdentifier();
      v66 = [(HMDHomeInvitation *)v26 identifier];
      v41 = [v66 UUIDString];
      v42 = [MEMORY[0x277CD1A88] homeInvitationStateDescription:a7];
      v43 = [v12 shortDescription];
      v44 = [v16 UUIDString];
      *buf = 138544642;
      v91 = v67;
      v92 = 2112;
      v93 = v41;
      v94 = 2112;
      v95 = v42;
      v96 = 2112;
      v97 = v43;
      v98 = 2112;
      v99 = v76;
      v100 = 2112;
      v101 = v44;
      _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_DEFAULT, "%{public}@Tracking incoming invite %@ with state %@ from account %@ for home %@(%@)", buf, 0x3Eu);
    }

    objc_autoreleasePoolPop(context);
    objc_destroyWeak(&v83);
    objc_destroyWeak(&v82);
    objc_destroyWeak(&from);
    objc_destroyWeak(&location);

    if (a7 == 5)
    {
      v45 = 1;
LABEL_40:
      v57 = [(HMDHomeManager *)v79 uuidsOfRemovedHomes];
      v58 = [v57 containsObject:v16];

      if (v58)
      {
        v59 = [(HMDHomeManager *)v79 uuidsOfRemovedHomes];
        [v59 removeObject:v16];

        v60 = objc_autoreleasePoolPush();
        v61 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v61, OS_LOG_TYPE_INFO))
        {
          v62 = HMFGetLogIdentifier();
          v63 = [v16 UUIDString];
          *buf = 138543618;
          v91 = v62;
          v92 = 2112;
          v93 = v63;
          _os_log_impl(&dword_2531F8000, v61, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v60);
        [(HMDHomeManager *)v79 _stopTrackingRemovedHomeUserMergeId:v78];
      }

      else
      {
        [(HMDHomeManager *)v79 _stopTrackingRemovedHomeUserMergeId:v78];
        if (!v45)
        {
          goto LABEL_46;
        }
      }
    }

    [(HMDHomeManager *)v79 _saveWithReason:@"Incoming invitations updated" postSyncNotification:0];
LABEL_46:
    v27 = v26;
    v50 = v27;
  }

  else
  {
    v46 = objc_autoreleasePoolPush();
    v47 = v79;
    v48 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v48, OS_LOG_TYPE_DEFAULT))
    {
      v49 = HMFGetLogIdentifier();
      *buf = 138543618;
      v91 = v49;
      v92 = 2112;
      v93 = v77;
      _os_log_impl(&dword_2531F8000, v48, OS_LOG_TYPE_DEFAULT, "%{public}@Bad request for invitation with ID %@, missing controller or public key", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v46);
    if (a8)
    {
      *a8 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:3 userInfo:0];
    }

    v50 = 0;
  }

  v64 = *MEMORY[0x277D85DE8];

  return v50;
}

void __116__HMDHomeManager__trackIncomingInvitationFromAccount_mergeID_idsInvitationIdentifier_payload_invitationState_error___block_invoke(id *a1)
{
  v17 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained(a1 + 5);
  if (WeakRetained)
  {
    v3 = objc_loadWeakRetained(a1 + 6);
    v4 = +[HMDBulletinBoard sharedBulletinBoard];
    v5 = [v3 identifier];
    v6 = [v5 UUIDString];
    [v4 removeBulletinWithRecordID:v6];

    [WeakRetained _postIncomingInvitationStateChangedNotification:v3 newInvitationState:{objc_msgSend(v3, "invitationState")}];
    [a1[4] _removeIncomingInvitation:v3];
    [WeakRetained saveWithReason:@"kAccessHomeInviteRequestKey" information:0 postSyncNotification:0];
    v7 = objc_autoreleasePoolPush();
    v8 = a1[4];
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [a1[4] incomingInvitations];
      v13 = 138543618;
      v14 = v10;
      v15 = 2112;
      v16 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@New incomingInvitations after expiration: %@", &v13, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_handleDismissDialogRequest:(id)a3
{
  v24 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:@"kDialogContextKey"];
  v17 = 0;
  v6 = [v4 BOOLForKey:@"kDialogSelectionKey" keyPresent:&v17];
  if (v5 && v17 == 1)
  {
    v7 = v6;
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v11 = "canceled";
      *buf = 138543874;
      v19 = v10;
      if (v7)
      {
        v11 = "accepted";
      }

      v20 = 2112;
      v21 = v5;
      v22 = 2080;
      v23 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Received message from peer device to dismiss dialog with context %@, selection: %s", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v12 = +[HMDUIDialogPresenter sharedUIDialogPresenter];
    v13 = [(HMDHomeManager *)self workQueue];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __46__HMDHomeManager__handleDismissDialogRequest___block_invoke;
    v15[3] = &unk_279735D00;
    v16 = v5;
    [v12 dismissPendingDialogDueToPeerDeviceSelection:v7 context:v16 queue:v13 completionHandler:v15];
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __46__HMDHomeManager__handleDismissDialogRequest___block_invoke(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEFAULT))
  {
    v4 = HMFGetLogIdentifier();
    v5 = *(a1 + 32);
    v7 = 138543618;
    v8 = v4;
    v9 = 2112;
    v10 = v5;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_DEFAULT, "%{public}@Dismissed dialog with context %@", &v7, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *MEMORY[0x277D85DE8];
}

- (void)_handleDismissBulletinRequest:(id)a3
{
  v41 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:@"kBulletinRecordIDKey"];
  if (v5)
  {
    v6 = objc_autoreleasePoolPush();
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v8;
      v39 = 2112;
      v40 = v5;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received message from peer device to dismiss bulletin with record ID %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v6);
    v9 = +[HMDBulletinBoard sharedBulletinBoard];
    [v9 removeBulletinWithRecordID:v5];

    v10 = [v4 numberForKey:@"kInvitationStateKey"];
    v11 = v10;
    if (!v10)
    {
      goto LABEL_20;
    }

    v12 = [v10 unsignedIntegerValue];
    v13 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v5];
    v14 = [(HMDHomeManager *)self incomingInvitations];
    v15 = [v14 hmf_firstObjectWithValue:v13 forKeyPath:@"identifier"];

    if (v15)
    {
      if ((v12 - 6) < 2 || v12 == 4)
      {
        [(HMDHomeManager *)self _postIncomingInvitationStateChangedNotification:v15 newInvitationState:v12];
        [(HMDHomeManager *)self _removeIncomingInvitation:v15];
LABEL_18:
        v33 = [v4 name];
        [(HMDHomeManager *)self _saveWithReason:v33 postSyncNotification:0];

LABEL_19:
        [(HMDHomeManager *)self _updateIncomingInvitesPresent];

LABEL_20:
        goto LABEL_21;
      }

      if (v12 == 3)
      {
        v16 = objc_alloc(MEMORY[0x277CCAD78]);
        v17 = [v4 stringForKey:*MEMORY[0x277CD0640]];
        v18 = [v16 initWithUUIDString:v17];

        [(HMDHomeManager *)self _postIncomingInvitationStateChangedNotification:v15 newInvitationState:5];
        v19 = [(HMDHomeManager *)self uuidsOfRemovedHomes];
        v20 = [v19 containsObject:v18];

        if (v20)
        {
          v21 = [(HMDHomeManager *)self uuidsOfRemovedHomes];
          [v21 removeObject:v18];

          v22 = objc_autoreleasePoolPush();
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            [v18 UUIDString];
            v25 = v35 = v22;
            *buf = 138543618;
            v38 = v24;
            v39 = 2112;
            v40 = v25;
            _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);

            v22 = v35;
          }

          objc_autoreleasePoolPop(v22);
        }

        v26 = [(HMDHomeManager *)self _homeWithUUID:v18];
        v27 = [v26 owner];
        v28 = [v27 account];
        [v28 senderCorrelationIdentifier];
        v29 = v36 = v18;

        [(HMDHomeManager *)self _stopTrackingRemovedHomeUserMergeId:v29];
        goto LABEL_18;
      }
    }

    v30 = objc_autoreleasePoolPush();
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v32;
      v39 = 2112;
      v40 = v5;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_DEFAULT, "%{public}@Dismiss bulletin request received with no matching invitation: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v30);
    goto LABEL_19;
  }

LABEL_21:

  v34 = *MEMORY[0x277D85DE8];
}

- (void)dismissBulletinOnAllMyTransientDevicesWithContext:(id)a3
{
  v21 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self appleAccountManager];
  v6 = [v5 account];
  v7 = [v6 handles];
  v8 = [v7 firstObject];

  if (v8)
  {
    v9 = [HMDRemoteAccountMessageDestination alloc];
    v10 = [(HMDHomeManager *)self uuid];
    v11 = [(HMDRemoteAccountMessageDestination *)v9 initWithTarget:v10 handle:v8 multicast:1];

    v12 = [MEMORY[0x277D0F818] internalMessageWithName:@"kDismissBulletinInternalRequestKey" destination:v11 messagePayload:v4];
    v13 = [(HMDHomeManager *)self messageDispatcher];
    [v13 sendMessage:v12];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v17 = HMFGetLogIdentifier();
      v19 = 138543362;
      v20 = v17;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot find own account handle to send message to dismiss bulletin on all devices", &v19, 0xCu);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleAccessHomeInviteFromAccount:(id)a3 mergeID:(id)a4 idsInvitationIdentifier:(id)a5 payload:(id)a6 messageResponseHandler:(id)a7
{
  v12 = a3;
  v13 = a4;
  v14 = a5;
  v15 = a6;
  v16 = a7;
  v17 = [HMDHomeInviteLogEvent updateWithState:1 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
  if (v17)
  {
    v18 = [(HMDHomeManager *)self logEventSubmitter];
    [v18 submitLogEvent:v17];
  }

  v29 = 0;
  v19 = [(HMDHomeManager *)self shouldAcceptInvitationPayload:v15 error:&v29];
  v20 = v29;
  if (v19)
  {
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke;
    aBlock[3] = &unk_2797325F8;
    aBlock[4] = self;
    v24 = v15;
    v28 = v16;
    v21 = v12;
    v25 = v21;
    v26 = v13;
    v27 = v14;
    v22 = _Block_copy(aBlock);
    [v21 isOfKnownPersonWithCompletion:v22];
  }

  else if (v16)
  {
    (*(v16 + 2))(v16, v20, 0);
  }
}

void __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke(id *a1, char a2)
{
  v4 = a1 + 4;
  v5 = [a1[4] workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke_2;
  block[3] = &unk_2797325D0;
  v6 = a1[5];
  v17 = a2;
  *&v7 = v6;
  *(&v7 + 1) = *v4;
  v11 = v7;
  v16 = a1[9];
  v8 = a1[6];
  v9 = a1[7];
  *&v10 = v8;
  *(&v10 + 1) = v9;
  v13 = v11;
  v14 = v10;
  v15 = a1[8];
  dispatch_async(v5, block);
}

void __116__HMDHomeManager__handleAccessHomeInviteFromAccount_mergeID_idsInvitationIdentifier_payload_messageResponseHandler___block_invoke_2(uint64_t a1)
{
  v38 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) hmf_stringForKey:*MEMORY[0x277CD23D0]];
  if (*(a1 + 80) & 1) != 0 || ([*(a1 + 40) shouldAcceptInvitationWithHomeName:v2])
  {
    v3 = *(a1 + 48);
    v4 = *(a1 + 56);
    v5 = *(a1 + 64);
    v7 = *(a1 + 32);
    v6 = *(a1 + 40);
    v33 = 0;
    v8 = [v6 _trackIncomingInvitationFromAccount:v3 mergeID:v4 idsInvitationIdentifier:v5 payload:v7 invitationState:2 error:&v33];
    v9 = v33;
    v10 = [*(a1 + 32) hmf_BOOLForKey:@"HMDHomeSuppressInviteNotificationKey"];
    if (v9 && (v11 = *(a1 + 72)) != 0)
    {
      (*(v11 + 16))(*(a1 + 72), v9, 0);
    }

    else if (v8)
    {
      if (v10)
      {
        v12 = objc_autoreleasePoolPush();
        v13 = *(a1 + 40);
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          *buf = 138543362;
          v35 = v15;
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Suppressing home invite notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v12);
        v16 = [HMDHomeInviteLogEvent updateWithState:3 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
        if (v16)
        {
          v17 = [*(a1 + 40) logEventSubmitter];
          [v17 submitLogEvent:v16];
        }
      }

      else
      {
        v16 = +[HMDBulletinBoard sharedBulletinBoard];
        v24 = *(a1 + 80);
        v25 = objc_autoreleasePoolPush();
        v26 = *(a1 + 40);
        v27 = HMFGetOSLogHandle();
        v28 = os_log_type_enabled(v27, OS_LOG_TYPE_INFO);
        if (v24 == 1)
        {
          if (v28)
          {
            v29 = HMFGetLogIdentifier();
            *buf = 138543362;
            v35 = v29;
            _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Inserting notification because inviter is a known person.", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v25);
          v30 = [v16 insertBulletinForIncomingInvitation:v8];
        }

        else
        {
          if (v28)
          {
            v31 = HMFGetLogIdentifier();
            *buf = 138543362;
            v35 = v31;
            _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Suppressing home invite notification because inviter is not a known person.", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v25);
        }

        [v16 refreshHomeBadgeNumber];
      }
    }

    goto LABEL_27;
  }

  v18 = objc_autoreleasePoolPush();
  v19 = *(a1 + 40);
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v35 = v21;
    v36 = 2112;
    v37 = v2;
    _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload due to invalid home name: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v18);
  v9 = [HMDHomeInviteLogEvent updateWithState:2 isFMFDevice:isThisDeviceDesignatedFMFDevice()];
  if (v9)
  {
    v22 = [*(a1 + 40) logEventSubmitter];
    [v22 submitLogEvent:v9];
  }

  v23 = *(a1 + 72);
  if (v23)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    (*(v23 + 16))(v23, v8, 0);
LABEL_27:
  }

  v32 = *MEMORY[0x277D85DE8];
}

- (BOOL)shouldAcceptInvitationPayload:(id)a3 error:(id *)a4
{
  v44 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [v6 hmf_stringForKey:*MEMORY[0x277CD23D0]];
  v8 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
  v9 = v8;
  if (v7)
  {
    v10 = v8 == 0;
  }

  else
  {
    v10 = 1;
  }

  if (!v10)
  {
    v16 = [(HMDHomeManager *)self _homeWithUUID:v8];
    v17 = v16;
    if (v16)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = self;
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
      {
        v21 = HMFGetLogIdentifier();
        v38 = 138543618;
        v39 = v21;
        v40 = 2112;
        v41 = v9;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because home already exists for homeUUID: %@", &v38, 0x16u);
      }

      objc_autoreleasePoolPop(v18);
      if (a4)
      {
        v22 = 1;
LABEL_27:
        [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:v22 userInfo:0];
        *a4 = v15 = 0;
        goto LABEL_29;
      }
    }

    else
    {
      v23 = +[HMDDeviceCapabilities deviceCapabilities];
      v24 = [v23 supportsHomeInvitation];

      if (v24)
      {
        v25 = [(HMDHomeManager *)self homes];
        v26 = [v25 count];
        v27 = maximumHomes;

        if (v26 < v27)
        {
          v15 = 1;
LABEL_29:

          goto LABEL_30;
        }

        v32 = objc_autoreleasePoolPush();
        v33 = self;
        v34 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
        {
          v35 = HMFGetLogIdentifier();
          v38 = 138543362;
          v39 = v35;
          _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because invitee has already maximum allowed homes", &v38, 0xCu);
        }

        objc_autoreleasePoolPop(v32);
        if (a4)
        {
          v22 = 49;
          goto LABEL_27;
        }
      }

      else
      {
        v28 = objc_autoreleasePoolPush();
        v29 = self;
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
        {
          v31 = HMFGetLogIdentifier();
          v38 = 138543362;
          v39 = v31;
          _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because device does not support invitations", &v38, 0xCu);
        }

        objc_autoreleasePoolPop(v28);
        if (a4)
        {
          v22 = 10;
          goto LABEL_27;
        }
      }
    }

    v15 = 0;
    goto LABEL_29;
  }

  v11 = objc_autoreleasePoolPush();
  v12 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
  {
    v14 = HMFGetLogIdentifier();
    v38 = 138543874;
    v39 = v14;
    v40 = 2112;
    v41 = v7;
    v42 = 2112;
    v43 = v9;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot accept invitation payload because homeName: %@ or homeUUID: %@ is missing", &v38, 0x20u);
  }

  objc_autoreleasePoolPop(v11);
  if (a4)
  {
    [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    *a4 = v15 = 0;
  }

  else
  {
    v15 = 0;
  }

LABEL_30:

  v36 = *MEMORY[0x277D85DE8];
  return v15;
}

- (void)_handleAccessHomeInvite:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 remoteSourceID];
  if (!v5)
  {
    v7 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    v8 = [v4 responseHandler];
    (v8)[2](v8, v7, 0);
    goto LABEL_9;
  }

  v6 = [v4 remoteSourceDevice];
  v7 = [v6 account];

  if (v7)
  {
    v8 = [v4 remoteSenderContext];
    v9 = [v8 mergeID];
    v10 = [v4 messagePayload];
    v11 = [v4 responseHandler];
    [(HMDHomeManager *)self _handleAccessHomeInviteFromAccount:v7 mergeID:v9 idsInvitationIdentifier:0 payload:v10 messageResponseHandler:v11];

LABEL_9:
    goto LABEL_10;
  }

  v12 = objc_autoreleasePoolPush();
  v13 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
  {
    v15 = HMFGetLogIdentifier();
    v19 = 138543618;
    v20 = v15;
    v21 = 2112;
    v22 = v4;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Failed to resolve inviter account for message: %@", &v19, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  v16 = [v4 responseHandler];

  if (v16)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    v17 = [v4 responseHandler];
    v17[2](v17, v8, 0);

    goto LABEL_9;
  }

LABEL_10:

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_handleAddRemoteAccessRequest:(id)a3
{
  v28 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = +[HMDDeviceCapabilities deviceCapabilities];
  v6 = [v5 isResidentCapable];

  if (!v6)
  {
    v11 = MEMORY[0x277CCA9B8];
    v12 = *MEMORY[0x277CCFD28];
    v13 = 10;
LABEL_7:
    v14 = [v11 errorWithDomain:v12 code:v13 userInfo:0];
    v15 = [v4 responseHandler];
    (v15)[2](v15, v14, 0);
LABEL_8:

    goto LABEL_9;
  }

  if (+[HMDKeyTransferAgentServer isPeerAvailable])
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v24 = 138543618;
      v25 = v10;
      v26 = 2112;
      v27 = v4;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Rejecting remote access request, key transfer peer is available: %@", &v24, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = *MEMORY[0x277CCFD28];
    v13 = 48;
    goto LABEL_7;
  }

  v17 = [v4 remoteSourceDevice];
  v14 = [v17 account];

  if (v14)
  {
    [(HMDHomeManager *)self _acceptHomeInviteFromAccount:v14 message:v4 trackInvite:1];
    goto LABEL_9;
  }

  v18 = objc_autoreleasePoolPush();
  v19 = self;
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    v24 = 138543362;
    v25 = v21;
    _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Failed to resolve inviter account", &v24, 0xCu);
  }

  objc_autoreleasePoolPop(v18);
  v22 = [v4 responseHandler];

  if (v22)
  {
    v15 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    v23 = [v4 responseHandler];
    v23[2](v23, v15, 0);

    goto LABEL_8;
  }

LABEL_9:

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleDoYouSeeUnpairedAccessories:(id)a3
{
  v35 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0640]];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v32 = v8;
    v33 = 2112;
    v34 = v5;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received request to determine if we are at home %@ for unpaired accessories", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  v9 = +[HMDDeviceCapabilities deviceCapabilities];
  v10 = [v9 isResidentCapable];

  if (!v10)
  {
    v18 = objc_autoreleasePoolPush();
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
    {
      v20 = HMFGetLogIdentifier();
      *buf = 138543362;
      v32 = v20;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_DEFAULT, "%{public}@This device is not capable to access as a remote access point", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 10;
    goto LABEL_11;
  }

  if (+[HMDKeyTransferAgentServer isPeerAvailable])
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543618;
      v32 = v14;
      v33 = 2112;
      v34 = v4;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Rejecting remote access request, key transfer peer is available: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v15 = MEMORY[0x277CCA9B8];
    v16 = *MEMORY[0x277CCFD28];
    v17 = 48;
LABEL_11:
    v21 = [v15 errorWithDomain:v16 code:v17 userInfo:0];
    v22 = [v4 responseHandler];
    (v22)[2](v22, v21, 0);
    goto LABEL_12;
  }

  v21 = [v4 arrayForKey:@"kAccessoryIdentitiesKey"];
  v24 = [(HMDHomeManager *)self accessoryBrowserInternal];
  v22 = [v24 discoveredAccessoryServers];

  if ([(HMDHomeManager *)self _findAnyAccessoryWithIdentities:v21 inAccessoryServers:v22])
  {
    v25 = [MEMORY[0x277CCABB0] numberWithBool:{1, @"kAtHomeStateKey"}];
    v29[1] = @"kDeviceNameKey";
    v30[0] = v25;
    v26 = deviceName();
    v30[1] = v26;
    v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v30 forKeys:v29 count:2];

    v28 = [v4 responseHandler];
    (v28)[2](v28, 0, v27);
  }

  else
  {
    [(HMDHomeManager *)self _startScanningForAccessories:v4];
  }

LABEL_12:

  v23 = *MEMORY[0x277D85DE8];
}

- (BOOL)_findAnyAccessoryWithIdentities:(id)a3 inAccessoryServers:(id)a4
{
  v20 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  if ([v5 count] && objc_msgSend(v6, "count"))
  {
    v17 = 0u;
    v18 = 0u;
    v15 = 0u;
    v16 = 0u;
    v7 = v5;
    v8 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
    if (v8)
    {
      v9 = *v16;
      while (2)
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v16 != v9)
          {
            objc_enumerationMutation(v7);
          }

          v11 = [MEMORY[0x277CFE9F8] serverIdentifierWithUniqueIdentifier:{*(*(&v15 + 1) + 8 * i), v15}];
          v12 = [v6 containsObject:v11];

          if (v12)
          {
            LOBYTE(v8) = 1;
            goto LABEL_14;
          }
        }

        v8 = [v7 countByEnumeratingWithState:&v15 objects:v19 count:16];
        if (v8)
        {
          continue;
        }

        break;
      }
    }

LABEL_14:
  }

  else
  {
    LOBYTE(v8) = 0;
  }

  v13 = *MEMORY[0x277D85DE8];
  return v8;
}

- (void)_startScanningForAccessories:(id)a3
{
  v24 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0640]];
  v6 = objc_autoreleasePoolPush();
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [v4 name];
    v18 = 138543874;
    v19 = v8;
    v20 = 2112;
    v21 = v5;
    v22 = 2112;
    v23 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Received request to determine if we are at home %@ for message %@", &v18, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v10 = [(HMDHomeManager *)self accessoryFinderTimer];

  if (!v10)
  {
    [(HMDHomeManager *)self _startAccessoryFinderTimer];
    v11 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [v11 stopDiscoveringAccessories];

    v12 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [v12 startDiscoveringAccessories];

    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Starting timer to discover all accessories", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  v16 = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  [v16 addObject:v4];

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_processAnyPendingRequestsForRemoteAccess:(BOOL)a3
{
  v76 = *MEMORY[0x277D85DE8];
  v4 = [MEMORY[0x277CBEB58] set];
  v62 = 0u;
  v63 = 0u;
  v64 = 0u;
  v65 = 0u;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 countByEnumeratingWithState:&v62 objects:v75 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v63;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v63 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = [*(*(&v62 + 1) + 8 * i) hapAccessoryServerIdentifiers];
        [v4 unionSet:v10];
      }

      v7 = [v5 countByEnumeratingWithState:&v62 objects:v75 count:16];
    }

    while (v7);
  }

  v11 = [v4 mutableCopy];
  v12 = [(HMDHomeManager *)self accessoryBrowserInternal];
  v13 = [v12 discoveredAccessoryServers];
  [v11 unionSet:v13];

  v55 = [MEMORY[0x277CBEB18] array];
  v58 = 0u;
  v59 = 0u;
  v60 = 0u;
  v61 = 0u;
  obj = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  v52 = v11;
  v57 = [obj countByEnumeratingWithState:&v58 objects:v74 count:16];
  if (v57)
  {
    v56 = *v59;
    v49 = *MEMORY[0x277CCFD28];
    v50 = *MEMORY[0x277CD0640];
    v51 = self;
    do
    {
      for (j = 0; j != v57; ++j)
      {
        if (*v59 != v56)
        {
          objc_enumerationMutation(obj);
        }

        v15 = *(*(&v58 + 1) + 8 * j);
        v16 = [v15 name];
        v17 = [v16 isEqualToString:@"kDoYouSeeUnpairedAccessoriesKey"];

        v18 = v11;
        if (v17 & 1) != 0 || ([v15 name], v19 = objc_claimAutoreleasedReturnValue(), v20 = objc_msgSend(v19, "isEqualToString:", @"kAreYouAtHomeRequestKey"), v19, v18 = v4, (v20))
        {
          v21 = v18;
          v22 = [v15 arrayForKey:@"kAccessoryIdentitiesKey"];
          v23 = [(HMDHomeManager *)self _findAnyAccessoryWithIdentities:v22 inAccessoryServers:v21];
          if (v23 || a3)
          {
            v27 = v4;
            v72[0] = @"kAtHomeStateKey";
            v28 = [MEMORY[0x277CCABB0] numberWithBool:v23];
            v73[0] = v28;
            v72[1] = @"kHomedVersionKey";
            v29 = homedVersion;
            v73[1] = v29;
            v72[2] = @"kDeviceNameKey";
            v30 = deviceName();
            v73[2] = v30;
            v31 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v73 forKeys:v72 count:3];

            v32 = [v15 stringForKey:v50];
            v33 = objc_autoreleasePoolPush();
            v34 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
            {
              v35 = HMFGetLogIdentifier();
              *buf = 138543874;
              v67 = v35;
              v68 = 2112;
              v69 = v31;
              v70 = 2112;
              v71 = v32;
              _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@Sending response %@ for home %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v33);
            v36 = [v15 responseHandler];
            (v36)[2](v36, 0, v31);

            [v55 addObject:v15];
            v4 = v27;
            self = v51;
            v11 = v52;
          }

          else
          {
            v24 = objc_autoreleasePoolPush();
            v25 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
            {
              v26 = HMFGetLogIdentifier();
              *buf = 138543618;
              v67 = v26;
              v68 = 2112;
              v69 = v21;
              _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Did not find any of the accessories in the list %@ but there is a timer pending, continuing to scan", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v24);
          }

          goto LABEL_27;
        }

        [v55 addObject:v15];
        v37 = objc_autoreleasePoolPush();
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEFAULT))
        {
          v39 = HMFGetLogIdentifier();
          v40 = [v15 name];
          *buf = 138543618;
          v67 = v39;
          v68 = 2112;
          v69 = v40;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_DEFAULT, "%{public}@There is an invalid message in the pending responses for accessory finder %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v37);
        v41 = [v15 responseHandler];

        if (v41)
        {
          v21 = [MEMORY[0x277CCA9B8] errorWithDomain:v49 code:3 userInfo:0];
          v22 = [v15 responseHandler];
          (v22)[2](v22, v21, 0);
LABEL_27:

          continue;
        }
      }

      v57 = [obj countByEnumeratingWithState:&v58 objects:v74 count:16];
    }

    while (v57);
  }

  v42 = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  [v42 removeObjectsInArray:v55];

  v43 = [(HMDHomeManager *)self pendingResponsesForAccessoryFinder];
  v44 = [v43 count];

  if (!v44)
  {
    v45 = objc_autoreleasePoolPush();
    v46 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v46, OS_LOG_TYPE_DEFAULT))
    {
      v47 = HMFGetLogIdentifier();
      *buf = 138543362;
      v67 = v47;
      _os_log_impl(&dword_2531F8000, v46, OS_LOG_TYPE_DEFAULT, "%{public}@Processed all requests for accessory scan for remote access, stopping scan timer", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v45);
    [(HMDHomeManager *)self _cancelAccessoryFinderTimer];
  }

  v48 = *MEMORY[0x277D85DE8];
}

- (void)processAnyPendingRequestsForRemoteAccess
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __58__HMDHomeManager_processAnyPendingRequestsForRemoteAccess__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

- (void)_cancelAccessoryFinderTimer
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self accessoryFinderTimer];

  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
    {
      v6 = HMFGetLogIdentifier();
      v11 = 138543362;
      v12 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Cancelling accessory finder timer", &v11, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    v7 = [(HMDHomeManager *)self accessoryFinderTimer];
    dispatch_source_cancel(v7);

    [(HMDHomeManager *)self setAccessoryFinderTimer:0];
    v8 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [v8 stopDiscoveringAccessories];

    v9 = [(HMDHomeManager *)self accessoryBrowserInternal];
    [v9 setManagerDelegate:0];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_startAccessoryFinderTimerExpired
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Timer expired, and stopping request to discover accessories", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [(HMDHomeManager *)self _processAnyPendingRequestsForRemoteAccess:1];
  v6 = [(HMDHomeManager *)self accessoryBrowserInternal];
  [v6 stopDiscoveringAccessories];

  v7 = [(HMDHomeManager *)self accessoryBrowserInternal];
  [v7 setManagerDelegate:0];

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_startAccessoryFinderTimer
{
  v3 = [(HMDHomeManager *)self workQueue];
  v4 = dispatch_source_create(MEMORY[0x277D85D38], 0, 0, v3);
  [(HMDHomeManager *)self setAccessoryFinderTimer:v4];

  v5 = [(HMDHomeManager *)self accessoryFinderTimer];
  v6 = dispatch_time(0, 10000000000);
  dispatch_source_set_timer(v5, v6, 0xFFFFFFFFFFFFFFFFLL, 0x2FAF080uLL);

  objc_initWeak(&location, self);
  v7 = [(HMDHomeManager *)self accessoryFinderTimer];
  v10 = MEMORY[0x277D85DD0];
  v11 = 3221225472;
  v12 = __44__HMDHomeManager__startAccessoryFinderTimer__block_invoke;
  v13 = &unk_279732FD8;
  objc_copyWeak(&v14, &location);
  dispatch_source_set_event_handler(v7, &v10);

  v8 = [(HMDHomeManager *)self accessoryFinderTimer:v10];
  dispatch_resume(v8);

  v9 = [(HMDHomeManager *)self accessoryBrowserInternal];
  [v9 setManagerDelegate:self];

  objc_destroyWeak(&v14);
  objc_destroyWeak(&location);
}

void __44__HMDHomeManager__startAccessoryFinderTimer__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = WeakRetained;
    [WeakRetained _startAccessoryFinderTimerExpired];
    WeakRetained = v2;
  }
}

- (void)networkMonitorIsUnreachable:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __46__HMDHomeManager_networkMonitorIsUnreachable___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __46__HMDHomeManager_networkMonitorIsUnreachable___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) reachabilityMonitor];
  v3 = [v2 isEqual:*(a1 + 40)];

  v4 = *(a1 + 32);
  if (v3)
  {

    [v4 _reachabilityMonitorChanged:0];
  }

  else
  {
    v5 = [v4 cloudReachabilityMonitor];
    v6 = [v5 isEqual:*(a1 + 40)];

    if (v6)
    {
      v7 = *(a1 + 32);

      [v7 _cloudReachabilityMonitorChanged:0];
    }
  }
}

- (void)networkMonitorIsReachable:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __44__HMDHomeManager_networkMonitorIsReachable___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __44__HMDHomeManager_networkMonitorIsReachable___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) reachabilityMonitor];
  v3 = [v2 isEqual:*(a1 + 40)];

  v4 = *(a1 + 32);
  if (v3)
  {

    [v4 _reachabilityMonitorChanged:1];
  }

  else
  {
    v5 = [v4 cloudReachabilityMonitor];
    v6 = [v5 isEqual:*(a1 + 40)];

    if (v6)
    {
      v7 = *(a1 + 32);

      [v7 _cloudReachabilityMonitorChanged:1];
    }
  }
}

void __51__HMDHomeManager__cloudReachabilityMonitorChanged___block_invoke(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = objc_autoreleasePoolPush();
  v3 = WeakRetained;
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Re-querying account status since we are reachable", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  [v3 _updateCloudDataSyncWithAccountState:{objc_msgSend(v3, "accountActive")}];

  v6 = *MEMORY[0x277D85DE8];
}

void __51__HMDHomeManager__cloudReachabilityMonitorChanged___block_invoke_1288(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = objc_autoreleasePoolPush();
  v3 = WeakRetained;
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Cloud network connection is available and we have pending transactions, pushing to the cloud", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  [v3 _determineLocalChangesAndSchedulePush];

  v6 = *MEMORY[0x277D85DE8];
}

- (void)_monitorReachability
{
  v31 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self reachabilityMonitor];

  if (!v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = self;
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v27 = 138543362;
      v28 = v7;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Creating network reachability monitor", &v27, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    v8 = [objc_alloc(MEMORY[0x277D0F868]) initWithNetAddress:0];
    [(HMDHomeManager *)v5 setReachabilityMonitor:v8];

    v9 = [(HMDHomeManager *)v5 reachabilityMonitor];
    [v9 setDelegate:v5];

    v10 = [(HMDHomeManager *)v5 reachabilityMonitor];
    v11 = [v10 isReachable];

    if (v11)
    {
      [(HMDHomeManager *)v5 _reachabilityMonitorChanged:1];
    }
  }

  v12 = [(HMDHomeManager *)self cloudReachabilityMonitor];

  if (!v12)
  {
    v13 = [MEMORY[0x277D0F8D0] sharedPreferences];
    v14 = [v13 preferenceForKey:@"cloudReachabilityMonitorHostname"];
    v15 = [v14 stringValue];

    if (v15)
    {
      v16 = v15;
    }

    else
    {
      v16 = @"gateway.icloud.com";
    }

    v17 = objc_autoreleasePoolPush();
    v18 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
    {
      v20 = HMFGetLogIdentifier();
      v27 = 138543618;
      v28 = v20;
      v29 = 2112;
      v30 = v16;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Creating cloud network reachability monitor for host: %@", &v27, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v21 = [objc_alloc(MEMORY[0x277D0F858]) initWithHostname:v16];
    v22 = [objc_alloc(MEMORY[0x277D0F868]) initWithNetAddress:v21];
    [(HMDHomeManager *)v18 setCloudReachabilityMonitor:v22];

    v23 = [(HMDHomeManager *)v18 cloudReachabilityMonitor];
    [v23 setDelegate:v18];

    v24 = [(HMDHomeManager *)v18 cloudReachabilityMonitor];
    v25 = [v24 isReachable];

    if (v25)
    {
      [(HMDHomeManager *)v18 _cloudReachabilityMonitorChanged:1];
    }
  }

  v26 = *MEMORY[0x277D85DE8];
}

- (id)eventRouterServerDiagnosticInfo
{
  v2 = [(HMDHomeManager *)self currentAccessory];
  v3 = [v2 home];
  v4 = [v3 eventRouterServerDiagnosticInfo];

  return v4;
}

- (id)currentAccessory
{
  v2 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;

  return v3;
}

- (void)userManagementOperationDidFinish:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __51__HMDHomeManager_userManagementOperationDidFinish___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __51__HMDHomeManager_userManagementOperationDidFinish___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) accessory];
  v7 = [v2 home];

  [v7 userManagementOperationDidFinish:*(a1 + 32)];
  v3 = [*(a1 + 40) backingStore];
  v4 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
  v5 = [v3 transaction:@"kUserManagementOperationRemovedKey" options:v4];

  v6 = [*(a1 + 32) modelObjectWithChangeType:3];
  [v5 add:v6];

  [v5 run];
}

- (void)cleanupOperationsForAccessory:(id)a3 user:(id)a4 completion:(id)a5
{
  v8 = a3;
  v9 = a4;
  v10 = a5;
  v11 = [(HMDHomeManager *)self workQueue];
  v15[0] = MEMORY[0x277D85DD0];
  v15[1] = 3221225472;
  v15[2] = __64__HMDHomeManager_cleanupOperationsForAccessory_user_completion___block_invoke;
  v15[3] = &unk_279734578;
  v15[4] = self;
  v16 = v8;
  v17 = v9;
  v18 = v10;
  v12 = v10;
  v13 = v9;
  v14 = v8;
  dispatch_async(v11, v15);
}

void __64__HMDHomeManager_cleanupOperationsForAccessory_user_completion___block_invoke(id *a1)
{
  v63 = *MEMORY[0x277D85DE8];
  v2 = [a1[4] backingStore];
  v3 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
  v4 = [v2 transaction:@"kUserManagementOperationRemovedKey" options:v3];

  v54 = 0u;
  v55 = 0u;
  v53 = 0u;
  v52 = 0u;
  v5 = +[HMDUserManagementOperationManager sharedManager];
  v6 = [v5 operations];

  obj = v6;
  v7 = [v6 countByEnumeratingWithState:&v52 objects:v62 count:16];
  if (v7)
  {
    v9 = v7;
    v10 = *v53;
    *&v8 = 138543874;
    v41 = v8;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        v12 = v4;
        if (*v53 != v10)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v52 + 1) + 8 * i);
        v14 = a1[5];
        v15 = [v13 accessory];
        v16 = [v15 identifier];
        v17 = [v14 isEqualToString:v16];

        v18 = a1[6];
        v19 = [v13 user];
        v20 = [v19 pairingIdentity];
        v21 = [v18 isEqual:v20];

        v4 = v12;
        if (v17 && (a1[6] == 0) | v21 & 1)
        {
          v22 = objc_autoreleasePoolPush();
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            v25 = [a1[4] shortDescription];
            *buf = v41;
            v57 = v24;
            v58 = 2112;
            v59 = v25;
            v60 = 2112;
            v61 = v13;
            _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@[%@] Dropping prior operation: %@", buf, 0x20u);

            v4 = v12;
          }

          objc_autoreleasePoolPop(v22);
          v26 = [v13 modelObjectWithChangeType:3];
          [v4 add:v26];
        }
      }

      v9 = [obj countByEnumeratingWithState:&v52 objects:v62 count:16];
    }

    while (v9);
  }

  v27 = dispatch_group_create();
  v28 = [a1[4] unprocessedOperationModelIdentifiers];
  v29 = [v28 count];

  if (v29)
  {
    dispatch_group_enter(v27);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __64__HMDHomeManager_cleanupOperationsForAccessory_user_completion___block_invoke_1275;
    aBlock[3] = &unk_2797325A8;
    v47 = a1[5];
    v30 = a1[6];
    v31 = a1[4];
    v48 = v30;
    v49 = v31;
    v50 = v4;
    v51 = v27;
    v32 = _Block_copy(aBlock);
    v33 = [a1[4] backingStore];
    v34 = [HMDBackingStoreCacheFetchModelObjects alloc];
    v35 = [a1[4] unprocessedOperationModelIdentifiers];
    v36 = [v35 allObjects];
    v37 = [(HMDBackingStoreCacheFetchModelObjects *)v34 initWithUUIDs:v36 fetchResult:v32];
    [v33 submit:v37];
  }

  v38 = [a1[4] workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __64__HMDHomeManager_cleanupOperationsForAccessory_user_completion___block_invoke_2;
  block[3] = &unk_279735738;
  v44 = v4;
  v45 = a1[7];
  v39 = v4;
  dispatch_group_notify(v27, v38, block);

  v40 = *MEMORY[0x277D85DE8];
}

uint64_t __64__HMDHomeManager_cleanupOperationsForAccessory_user_completion___block_invoke_1275(uint64_t a1, void *a2)
{
  v27 = *MEMORY[0x277D85DE8];
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  obj = a2;
  v3 = [obj countByEnumeratingWithState:&v22 objects:v26 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v23;
    do
    {
      v6 = 0;
      do
      {
        if (*v23 != v5)
        {
          objc_enumerationMutation(obj);
        }

        v7 = [*(*(&v22 + 1) + 8 * v6) object];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v8 = v7;
        }

        else
        {
          v8 = 0;
        }

        v9 = v8;

        if (v9)
        {
          v10 = *(a1 + 32);
          v11 = [v9 accessoryPairingIdentity];
          v12 = [v11 identifier];
          v13 = [v10 isEqualToString:v12];

          v14 = *(a1 + 40);
          v15 = [v9 userPairingIdentity];
          v16 = [v14 isEqual:v15];

          if (v13)
          {
            if ((*(a1 + 40) == 0) | v16 & 1)
            {
              v17 = [*(a1 + 48) unprocessedOperationModelIdentifiers];
              v18 = [v9 uuid];
              [v17 removeObject:v18];

              [v9 setObjectChangeType:3];
              [*(a1 + 56) add:v9];
            }
          }
        }

        ++v6;
      }

      while (v4 != v6);
      v4 = [obj countByEnumeratingWithState:&v22 objects:v26 count:16];
    }

    while (v4);
  }

  dispatch_group_leave(*(a1 + 64));

  v19 = *MEMORY[0x277D85DE8];
  return 0;
}

- (BOOL)operationsWithIdentifiers:(id)a3 outOperations:(id *)a4
{
  v46 = *MEMORY[0x277D85DE8];
  v6 = a3;
  if ([v6 count])
  {
    v28 = a4;
    v7 = +[HMDUserManagementOperationManager sharedManager];
    v33 = [v7 operations];

    [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v6, "count")}];
    v30 = v29 = v6;
    v40 = 0u;
    v41 = 0u;
    v42 = 0u;
    v43 = 0u;
    obj = v6;
    v8 = [obj countByEnumeratingWithState:&v40 objects:v45 count:16];
    if (v8)
    {
      v9 = v8;
      v32 = 0;
      v10 = *v41;
      v11 = 0x277CCA000uLL;
      v31 = *v41;
      do
      {
        v12 = 0;
        v34 = v9;
        do
        {
          if (*v41 != v10)
          {
            objc_enumerationMutation(obj);
          }

          v13 = [objc_alloc(*(v11 + 3448)) initWithUUIDString:*(*(&v40 + 1) + 8 * v12)];
          v14 = [(HMDHomeManager *)self unprocessedOperationModelIdentifiers];
          v15 = [v14 containsObject:v13];

          if (v15)
          {
            v32 = 1;
          }

          else
          {
            v38 = 0u;
            v39 = 0u;
            v36 = 0u;
            v37 = 0u;
            v16 = v33;
            v17 = [v16 countByEnumeratingWithState:&v36 objects:v44 count:16];
            if (v17)
            {
              v18 = v17;
              v19 = *v37;
              while (2)
              {
                for (i = 0; i != v18; ++i)
                {
                  if (*v37 != v19)
                  {
                    objc_enumerationMutation(v16);
                  }

                  v21 = *(*(&v36 + 1) + 8 * i);
                  v22 = [v21 identifier];
                  v23 = [v13 isEqual:v22];

                  if (v23)
                  {
                    if (([v21 isFinished] & 1) == 0)
                    {
                      [v30 addObject:v21];
                    }

                    goto LABEL_20;
                  }
                }

                v18 = [v16 countByEnumeratingWithState:&v36 objects:v44 count:16];
                if (v18)
                {
                  continue;
                }

                break;
              }
            }

LABEL_20:

            v10 = v31;
            v11 = 0x277CCA000;
            v9 = v34;
          }

          ++v12;
        }

        while (v12 != v9);
        v9 = [obj countByEnumeratingWithState:&v40 objects:v45 count:16];
      }

      while (v9);
    }

    else
    {
      v32 = 0;
    }

    if (v28 && [v30 count])
    {
      v25 = v30;
      *v28 = v30;
    }

    v24 = (v32 & 1) != 0 || [v30 count] != 0;
    v6 = v29;
  }

  else
  {
    v24 = 0;
  }

  v26 = *MEMORY[0x277D85DE8];
  return v24;
}

- (void)_processRemoveUserManagementOperationModel:(id)a3 message:(id)a4
{
  v37 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v31 = 0u;
  v8 = +[HMDUserManagementOperationManager sharedManager];
  v9 = [v8 operations];

  v10 = [v9 countByEnumeratingWithState:&v28 objects:v36 count:16];
  if (v10)
  {
    v27 = self;
    v11 = *v29;
    while (2)
    {
      for (i = 0; i != v10; i = i + 1)
      {
        if (*v29 != v11)
        {
          objc_enumerationMutation(v9);
        }

        v13 = *(*(&v28 + 1) + 8 * i);
        v14 = [v13 identifier];
        v15 = [v6 uuid];
        v16 = [v14 isEqual:v15];

        if (v16)
        {
          v10 = v13;
          goto LABEL_11;
        }
      }

      v10 = [v9 countByEnumeratingWithState:&v28 objects:v36 count:16];
      if (v10)
      {
        continue;
      }

      break;
    }

LABEL_11:
    self = v27;
  }

  v17 = [v7 transactionResult];
  [v17 markChanged];

  if (v10)
  {
    if (([v10 isFinished] & 1) == 0)
    {
      [v10 cancel];
    }

    v18 = +[HMDUserManagementOperationManager sharedManager];
    [v18 removeOperation:v10];
  }

  else
  {
    v19 = objc_autoreleasePoolPush();
    v20 = self;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
    {
      v22 = HMFGetLogIdentifier();
      v23 = [v6 uuid];
      v24 = [v23 UUIDString];
      *buf = 138543618;
      v33 = v22;
      v34 = 2112;
      v35 = v24;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@Remove UserManagementOperation: Could not match operation with identifier %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v19);
    v18 = [(HMDHomeManager *)v20 unprocessedOperationModelIdentifiers];
    v25 = [v6 uuid];
    [v18 removeObject:v25];
  }

  [v7 respondWithPayload:0];
  v26 = *MEMORY[0x277D85DE8];
}

- (void)_processUserManagementOperationModel:(id)a3 message:(id)a4
{
  v176 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v160 = 0u;
  v161 = 0u;
  v162 = 0u;
  v163 = 0u;
  v7 = +[HMDUserManagementOperationManager sharedManager];
  v8 = [v7 operations];

  v9 = [v8 countByEnumeratingWithState:&v160 objects:v175 count:16];
  if (!v9)
  {

    goto LABEL_13;
  }

  v10 = v9;
  v135 = v6;
  v11 = 0;
  v12 = *v161;
  do
  {
    for (i = 0; i != v10; ++i)
    {
      if (*v161 != v12)
      {
        objc_enumerationMutation(v8);
      }

      v14 = *(*(&v160 + 1) + 8 * i);
      v15 = [v14 identifier];
      v16 = [v5 uuid];
      v17 = [v15 isEqual:v16];

      if (v17)
      {
        v18 = v14;

        v11 = v18;
      }
    }

    v10 = [v8 countByEnumeratingWithState:&v160 objects:v175 count:16];
  }

  while (v10);

  v6 = v135;
  if (!v11)
  {
LABEL_13:
    v20 = [v5 expirationDate];

    if (!v20)
    {
      goto LABEL_15;
    }

    v21 = [v5 expirationDate];
    v22 = [MEMORY[0x277CBEAA8] date];
    [v21 timeIntervalSinceDate:v22];
    v24 = v23;

    if (v24 <= 0.0)
    {
      v55 = objc_autoreleasePoolPush();
      v56 = self;
      v57 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v57, OS_LOG_TYPE_INFO))
      {
        v58 = HMFGetLogIdentifier();
        *buf = 138543362;
        v165 = v58;
        _os_log_impl(&dword_2531F8000, v57, OS_LOG_TYPE_INFO, "%{public}@UserManagementOperation has already expired, deleting", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v55);
      v59 = [(HMDHomeManager *)v56 backingStore];
      v60 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v61 = [v59 transaction:@"kUserManagementOperationRemovedKey" options:v60];

      [v5 setObjectChangeType:3];
      [v61 add:v5];
      [v61 run];
      [v6 respondWithPayload:0];
    }

    else
    {
LABEL_15:
      v25 = [(HMDHomeManager *)self unprocessedOperationModelIdentifiers];
      v26 = [v5 uuid];
      [v25 addObject:v26];

      v27 = [v5 operationType];

      if (v27)
      {
        v28 = [v6 transactionResult];
        [v28 markChanged];

        v29 = [v5 operationType];
        v132 = [v29 integerValue];

        v30 = [v5 accessoryPairingIdentity];
        v31 = [v5 accessoryPairingIdentity];
        objc_opt_class();
        isKindOfClass = objc_opt_isKindOfClass();

        if (isKindOfClass)
        {
          v33 = MEMORY[0x277CCAAC8];
          v34 = objc_opt_class();
          v35 = [v5 accessoryPairingIdentity];
          v159 = 0;
          v36 = [v33 unarchivedObjectOfClass:v34 fromData:v35 error:&v159];
          v37 = v159;

          if (!v36)
          {
            v38 = objc_autoreleasePoolPush();
            v39 = self;
            v40 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v40, OS_LOG_TYPE_ERROR))
            {
              v41 = HMFGetLogIdentifier();
              *buf = 138543618;
              v165 = v41;
              v166 = 2112;
              v167 = v37;
              _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive accessory pairing identity from the model's accessory pairing identity data: %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v38);
          }

          v30 = v36;
        }

        v42 = [v5 userPairingIdentity];
        v43 = [v5 userPairingIdentity];
        objc_opt_class();
        v44 = objc_opt_isKindOfClass();

        if (v44)
        {
          v45 = MEMORY[0x277CCAAC8];
          v46 = objc_opt_class();
          v47 = [v5 userPairingIdentity];
          v158 = 0;
          v48 = [v45 unarchivedObjectOfClass:v46 fromData:v47 error:&v158];
          v49 = v158;

          v50 = self;
          if (!v48)
          {
            v51 = objc_autoreleasePoolPush();
            v52 = self;
            v53 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v53, OS_LOG_TYPE_ERROR))
            {
              v54 = HMFGetLogIdentifier();
              *buf = 138543618;
              v165 = v54;
              v166 = 2112;
              v167 = v49;
              _os_log_impl(&dword_2531F8000, v53, OS_LOG_TYPE_ERROR, "%{public}@Failed to unarchive user pairing identity from the model's user pairing identity data: %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v51);
            v50 = self;
          }

          v138 = v48;
        }

        else
        {
          v138 = v42;
          v50 = self;
        }

        v142 = v30;
        if (v30)
        {
          v136 = v6;
          v156 = 0u;
          v157 = 0u;
          v154 = 0u;
          v155 = 0u;
          v68 = [(HMDHomeManager *)v50 pairedAccessories];
          v69 = [v68 countByEnumeratingWithState:&v154 objects:v174 count:16];
          if (v69)
          {
            v70 = v69;
            v71 = *v155;
            while (2)
            {
              for (j = 0; j != v70; ++j)
              {
                if (*v155 != v71)
                {
                  objc_enumerationMutation(v68);
                }

                v73 = *(*(&v154 + 1) + 8 * j);
                if ([(__CFString *)v73 conformsToProtocol:&unk_286699670])
                {
                  v74 = v73;
                }

                else
                {
                  v74 = 0;
                }

                v75 = v74;

                if (v75)
                {
                  v76 = [(__CFString *)v75 pairingIdentity];
                  v77 = [v142 isEqual:v76];

                  if (v77)
                  {
                    goto LABEL_56;
                  }
                }

                else
                {
                  v78 = v73;
                  v79 = [(__CFString *)v73 identifier];
                  v80 = [v142 identifier];
                  v81 = [v79 isEqualToString:v80];

                  if (v81)
                  {
                    v73 = v78;
                    goto LABEL_56;
                  }
                }
              }

              v70 = [v68 countByEnumeratingWithState:&v154 objects:v174 count:16];
              if (v70)
              {
                continue;
              }

              break;
            }
          }

          v73 = 0;
LABEL_56:

          v6 = v136;
          v50 = self;
        }

        else
        {
          v73 = 0;
        }

        v82 = [(__CFString *)v73 home];
        v83 = v82;
        v133 = v73;
        v134 = v82;
        if (v73 && v82)
        {
          if (v138)
          {
            [(__CFString *)v82 users];
            v150 = 0u;
            v151 = 0u;
            v152 = 0u;
            v84 = v153 = 0u;
            v85 = [v84 countByEnumeratingWithState:&v150 objects:v173 count:16];
            if (v85)
            {
              v86 = v85;
              v87 = *v151;
LABEL_62:
              v88 = 0;
              while (1)
              {
                if (*v151 != v87)
                {
                  objc_enumerationMutation(v84);
                }

                v89 = *(*(&v150 + 1) + 8 * v88);
                v90 = [v89 pairingIdentity];
                v91 = [v90 isEqual:v138];

                if (v91)
                {
                  break;
                }

                if (v86 == ++v88)
                {
                  v86 = [v84 countByEnumeratingWithState:&v150 objects:v173 count:16];
                  if (v86)
                  {
                    goto LABEL_62;
                  }

                  goto LABEL_68;
                }
              }

              v100 = v89;

              v50 = self;
              if (!v100)
              {
                goto LABEL_85;
              }

              v137 = v6;
              v149 = 0;
              v131 = v100;
              v11 = [(__CFString *)v134 prepareUserManagementOperationForUser:v100 accessory:v133 type:v132 model:v5 error:&v149];
              v130 = v149;
              v145 = 0u;
              v146 = 0u;
              v147 = 0u;
              v148 = 0u;
              v101 = +[HMDUserManagementOperationManager sharedManager];
              v102 = [v101 operations];

              obj = v102;
              v103 = [v102 countByEnumeratingWithState:&v145 objects:v172 count:16];
              if (v103)
              {
                v104 = v103;
                v105 = *v146;
                do
                {
                  for (k = 0; k != v104; ++k)
                  {
                    if (*v146 != v105)
                    {
                      objc_enumerationMutation(obj);
                    }

                    v107 = *(*(&v145 + 1) + 8 * k);
                    v108 = [v5 dependencies];
                    v109 = [v107 identifier];
                    v110 = [v109 UUIDString];
                    v111 = [v108 containsObject:v110];

                    if (v111)
                    {
                      [v11 addDependency:v107];
                    }
                  }

                  v104 = [obj countByEnumeratingWithState:&v145 objects:v172 count:16];
                }

                while (v104);
              }

              v112 = [v5 ownerPairingIdentity];
              [v11 setOwnerPairingIdentity:v112];

              obja = objc_autoreleasePoolPush();
              v113 = self;
              v114 = HMFGetOSLogHandle();
              v115 = v114;
              v116 = v142;
              v19 = v130;
              if (v130)
              {
                v6 = v137;
                v117 = v138;
                v118 = v131;
                if (os_log_type_enabled(v114, OS_LOG_TYPE_ERROR))
                {
                  HMFGetLogIdentifier();
                  v119 = v140 = v113;
                  *buf = 138543874;
                  v165 = v119;
                  v166 = 2112;
                  v167 = v133;
                  v168 = 2112;
                  v169 = v131;
                  _os_log_impl(&dword_2531F8000, v115, OS_LOG_TYPE_ERROR, "%{public}@Add UserManagementOperation: Failed to add accessory pairing - accessory %@, user %@", buf, 0x20u);

                  v113 = v140;
                }

                objc_autoreleasePoolPop(obja);
              }

              else
              {
                v6 = v137;
                v117 = v138;
                v118 = v131;
                if (os_log_type_enabled(v114, OS_LOG_TYPE_DEFAULT))
                {
                  v123 = HMFGetLogIdentifier();
                  v141 = v113;
                  if ((v132 - 1) > 2)
                  {
                    v124 = @"unknown";
                  }

                  else
                  {
                    v124 = off_27972B528[v132 - 1];
                  }

                  v125 = v124;
                  *buf = 138544130;
                  v165 = v123;
                  v166 = 2112;
                  v167 = v125;
                  v168 = 2112;
                  v169 = v133;
                  v170 = 2112;
                  v171 = v131;
                  _os_log_impl(&dword_2531F8000, v115, OS_LOG_TYPE_DEFAULT, "%{public}@Add UserManagementOperation: Successfully added operation - type: %@, accessory %@, user %@", buf, 0x2Au);

                  v113 = v141;
                }

                objc_autoreleasePoolPop(obja);
                [v11 updateDelegate:v113];
                +[HMDUserManagementOperationManager sharedManager];
                v127 = v126 = v113;
                [v127 addOperation:v11];

                v128 = [(HMDHomeManager *)v126 unprocessedOperationModelIdentifiers];
                v129 = [v5 uuid];
                [v128 removeObject:v129];

                v19 = 0;
              }

              LOBYTE(v120) = 1;
              goto LABEL_90;
            }

LABEL_68:

            v50 = self;
          }

LABEL_85:
          v92 = objc_autoreleasePoolPush();
          v93 = v50;
          v94 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v94, OS_LOG_TYPE_ERROR))
          {
            v95 = HMFGetLogIdentifier();
            v96 = [v138 identifier];
            *buf = 138543618;
            v165 = v95;
            v166 = 2112;
            v167 = v96;
            v97 = "%{public}@Add UserManagementOperation: Invalid parameter - user %@";
            v98 = v94;
            v99 = 22;
            goto LABEL_87;
          }
        }

        else
        {
          v92 = objc_autoreleasePoolPush();
          v93 = v50;
          v94 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v94, OS_LOG_TYPE_ERROR))
          {
            v95 = HMFGetLogIdentifier();
            v96 = [v142 identifier];
            *buf = 138543874;
            v165 = v95;
            v166 = 2112;
            v167 = v96;
            v168 = 2112;
            v169 = v83;
            v97 = "%{public}@Add UserManagementOperation: Invalid parameter - accessory: %@, home: %@";
            v98 = v94;
            v99 = 32;
LABEL_87:
            _os_log_impl(&dword_2531F8000, v98, OS_LOG_TYPE_ERROR, v97, buf, v99);
          }
        }

        objc_autoreleasePoolPop(v92);
        v120 = [v6 responseHandler];

        if (!v120)
        {
          v11 = 0;
          v19 = 0;
          v116 = v142;
          v117 = v138;
LABEL_92:

          if ((v120 & 1) == 0)
          {
            goto LABEL_96;
          }

          goto LABEL_93;
        }

        v118 = [v6 responseHandler];
        v120 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
        v118[2](v118, v120, 0);

        LOBYTE(v120) = 0;
        v11 = 0;
        v19 = 0;
        v116 = v142;
        v117 = v138;
LABEL_90:

        goto LABEL_92;
      }

      v62 = objc_autoreleasePoolPush();
      v63 = self;
      v64 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v64, OS_LOG_TYPE_ERROR))
      {
        v65 = HMFGetLogIdentifier();
        *buf = 138543362;
        v165 = v65;
        _os_log_impl(&dword_2531F8000, v64, OS_LOG_TYPE_ERROR, "%{public}@Add UserManagementOperation: Nil parameter - operationType", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v62);
      v66 = [v6 responseHandler];

      if (!v66)
      {
        v11 = 0;
        v19 = 0;
        goto LABEL_96;
      }

      v61 = [v6 responseHandler];
      v67 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
      (v61)[2](v61, v67, 0);
    }

    v11 = 0;
    v19 = 0;
LABEL_95:

    goto LABEL_96;
  }

  [v11 setDelegate:self];
  v19 = 0;
LABEL_93:
  v121 = [v6 responseHandler];

  if (v121)
  {
    v61 = [v6 responseHandler];
    (v61)[2](v61, v19, 0);
    goto LABEL_95;
  }

LABEL_96:

  v122 = *MEMORY[0x277D85DE8];
}

- (void)reprocessUserManagementModels
{
  v3 = [(HMDHomeManager *)self unprocessedOperationModelIdentifiers];
  v4 = [v3 count];

  if (v4)
  {
    objc_initWeak(&location, self);
    v11 = MEMORY[0x277D85DD0];
    v12 = 3221225472;
    v13 = __47__HMDHomeManager_reprocessUserManagementModels__block_invoke;
    v14 = &unk_279732580;
    objc_copyWeak(&v15, &location);
    v5 = _Block_copy(&v11);
    v6 = [(HMDHomeManager *)self backingStore:v11];
    v7 = [HMDBackingStoreCacheFetchModelObjects alloc];
    v8 = [(HMDHomeManager *)self unprocessedOperationModelIdentifiers];
    v9 = [v8 allObjects];
    v10 = [(HMDBackingStoreCacheFetchModelObjects *)v7 initWithUUIDs:v9 fetchResult:v5];
    [v6 submit:v10];

    objc_destroyWeak(&v15);
    objc_destroyWeak(&location);
  }
}

uint64_t __47__HMDHomeManager_reprocessUserManagementModels__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v37 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v8 = WeakRetained;
  if (WeakRetained)
  {
    v27 = v6;
    v9 = [WeakRetained backingStore];
    v10 = +[HMDBackingStoreTransactionOptions defaultLocalOptions];
    v29 = [v9 transaction:@"kUserManagementOperationAddedKey" options:v10];

    v32 = 0u;
    v33 = 0u;
    v30 = 0u;
    v31 = 0u;
    v28 = v5;
    v11 = v5;
    v12 = [v11 countByEnumeratingWithState:&v30 objects:v34 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v31;
      do
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v31 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v30 + 1) + 8 * i);
          v17 = [v8 unprocessedOperationModelIdentifiers];
          v18 = [v16 object];
          v19 = [v18 uuid];
          v20 = [v17 containsObject:v19];

          if (v20)
          {
            v21 = [v16 object];
            [v29 add:v21];
          }
        }

        v13 = [v11 countByEnumeratingWithState:&v30 objects:v34 count:16];
      }

      while (v13);
    }

    [v29 run];
    v6 = v27;
    v5 = v28;
  }

  else
  {
    v22 = objc_autoreleasePoolPush();
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543362;
      v36 = v24;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Missing self: [HMDHomeManager reprocessUserManagementModels]", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v22);
  }

  v25 = *MEMORY[0x277D85DE8];
  return 0;
}

- (void)handleVendorInfoUpdated:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke;
  v7[3] = &unk_2797359B0;
  v8 = v4;
  v9 = self;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  v10 = [*(a1 + 32) userInfo];
  v11 = [v10 hmf_arrayForKey:@"ChangedManufacturer"];
  if (v11)
  {
    v1 = dispatch_group_create();
    v20[0] = 0;
    v20[1] = v20;
    v20[2] = 0x2020000000;
    v21 = 0;
    v16 = 0u;
    v17 = 0u;
    v18 = 0u;
    v19 = 0u;
    v2 = [*(a1 + 40) homes];
    v3 = [v2 countByEnumeratingWithState:&v16 objects:v22 count:16];
    if (v3)
    {
      v4 = *v17;
      do
      {
        v5 = 0;
        do
        {
          if (*v17 != v4)
          {
            objc_enumerationMutation(v2);
          }

          v6 = *(*(&v16 + 1) + 8 * v5);
          dispatch_group_enter(v1);
          v13[0] = MEMORY[0x277D85DD0];
          v13[1] = 3221225472;
          v13[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_2;
          v13[3] = &unk_279732558;
          v15 = v20;
          v14 = v1;
          [v6 notifyClientOfVendorInfoUpdatedForManufacturers:v11 withCompletion:v13];

          ++v5;
        }

        while (v3 != v5);
        v3 = [v2 countByEnumeratingWithState:&v16 objects:v22 count:16];
      }

      while (v3);
    }

    v7 = [*(a1 + 40) workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_3;
    block[3] = &unk_279734898;
    block[4] = *(a1 + 40);
    block[5] = v20;
    dispatch_group_notify(v1, v7, block);

    _Block_object_dispose(v20, 8);
  }

  v8 = *MEMORY[0x277D85DE8];
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_2(uint64_t a1, int a2)
{
  if (a2)
  {
    *(*(*(a1 + 40) + 8) + 24) = 1;
  }

  dispatch_group_leave(*(a1 + 32));
}

void __42__HMDHomeManager_handleVendorInfoUpdated___block_invoke_3(uint64_t a1)
{
  if (*(*(*(a1 + 40) + 8) + 24) == 1)
  {
    v1 = *(a1 + 32);
    v2 = [v1 uuid];
    [v1 _updateGenerationCounterWithReason:@"VendorInfoUpdated" sourceUUID:v2 shouldNotifyClients:0];
  }

  v3 = +[HMDBulletinBoard sharedBulletinBoard];
  [v3 refreshHomeBadgeNumber];
}

- (void)_handleElectDeviceForIDSSession:(id)a3
{
  v48 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 messagePayload];
  v6 = [v5 hmf_dictionaryForKey:@"kRequiredCapabilitiesKey"];

  v7 = [v4 messagePayload];
  v8 = [v7 hmf_dictionaryForKey:@"kRequestedCapabilitiesKey"];

  if (isWatch())
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEBUG))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v43 = v12;
      v13 = "%{public}@### Watch is current device so ignoring IDS Elect";
      v14 = v11;
      v15 = OS_LOG_TYPE_DEBUG;
LABEL_13:
      _os_log_impl(&dword_2531F8000, v14, v15, v13, buf, 0xCu);
    }

LABEL_14:

    objc_autoreleasePoolPop(v9);
    goto LABEL_15;
  }

  v16 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v17 = [v16 dataSyncInProgressWithState:0 withMessage:0];

  if (v17)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      goto LABEL_14;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543362;
    v43 = v12;
    v13 = "%{public}@### Cloud data sync is in progress so ignoring IDS Elect";
LABEL_12:
    v14 = v11;
    v15 = OS_LOG_TYPE_INFO;
    goto LABEL_13;
  }

  if (![(HMDHomeManager *)self _capabilitiesAreSupported:v6])
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      goto LABEL_14;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543362;
    v43 = v12;
    v13 = "%{public}@### All capabilities are not met so ignoring IDS Elect";
    goto LABEL_12;
  }

  v18 = [(HMDHomeManager *)self homes];
  v40[0] = MEMORY[0x277D85DD0];
  v40[1] = 3221225472;
  v40[2] = __50__HMDHomeManager__handleElectDeviceForIDSSession___block_invoke;
  v40[3] = &unk_279732278;
  v19 = v4;
  v41 = v19;
  v20 = [v18 hmf_objectPassingTest:v40];

  v21 = [v19 remoteSenderContext];
  v22 = [v21 accountIdentifier];

  if (v22)
  {
    v23 = +[HMDIdentityRegistry sharedRegistry];
    v24 = [v23 identitiesForAccountIdentifier:v22];
  }

  else
  {
    v24 = MEMORY[0x277CBEBF8];
  }

  v26 = [v24 count];
  if (v20 || v26)
  {
    v32 = [(HMDHomeManager *)self _scrubRequestedCapabilities:v8 fromMessage:v19];
    v31 = [(HMDHomeManager *)self _prepareAnswerForRequestedCapabilities:v32];

    context = objc_autoreleasePoolPush();
    v33 = self;
    v34 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v35 = v37 = v24;
      [v19 shortDescription];
      v36 = v38 = v20;
      *buf = 138543874;
      v43 = v35;
      v44 = 2114;
      v45 = v36;
      v46 = 2112;
      v47 = v31;
      _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@Answering %{public}@ request with response: %@", buf, 0x20u);

      v20 = v38;
      v24 = v37;
    }

    objc_autoreleasePoolPop(context);
    [v19 respondWithPayload:v31];
  }

  else
  {
    v27 = objc_autoreleasePoolPush();
    v28 = self;
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543362;
      v43 = v30;
      _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_ERROR, "%{public}@### Message user not allowed to perform this request", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v27);
    v31 = 0;
  }

LABEL_15:
  v25 = *MEMORY[0x277D85DE8];
}

BOOL __50__HMDHomeManager__handleElectDeviceForIDSSession___block_invoke(uint64_t a1, uint64_t a2)
{
  v2 = [*(a1 + 32) userForHome:a2];
  v3 = v2 != 0;

  return v3;
}

- (id)_scrubRequestedCapabilities:(id)a3 fromMessage:(id)a4
{
  v23 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 mutableCopy];
  v9 = [v6 objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];

  if (v9)
  {
    v10 = *MEMORY[0x277CD0640];
    v11 = [v6 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
    v12 = [(HMDHomeManager *)self _homeWithUUID:v11];
    if (v12)
    {
      v13 = [v7 userForHome:v12];

      if (!v13)
      {
        v14 = objc_autoreleasePoolPush();
        v15 = self;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v17 = HMFGetLogIdentifier();
          v21 = 138543362;
          v22 = v17;
          _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Purging home info request for capabilities from user that is not a part of the home", &v21, 0xCu);
        }

        objc_autoreleasePoolPop(v14);
        [v8 removeObjectForKey:v10];
        [v8 removeObjectForKey:@"kHomeConfigurationVersionKey"];
      }
    }
  }

  v18 = [v8 copy];

  v19 = *MEMORY[0x277D85DE8];

  return v18;
}

- (id)_prepareAnswerForRequestedCapabilities:(id)a3
{
  v35 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_alloc_init(MEMORY[0x277CBEB38]);
  v6 = +[HMDHAPMetadata getSharedInstance];
  v7 = [v4 objectForKeyedSubscript:@"kDeviceClassTypeKey"];

  if (v7)
  {
    v8 = getDeviceClass();
    [v5 setObject:v8 forKeyedSubscript:@"kDeviceClassTypeKey"];
  }

  v9 = [v4 objectForKeyedSubscript:@"kHomedVersionKey"];

  if (v9)
  {
    v10 = homedVersion;
    [v5 setObject:v10 forKeyedSubscript:@"kHomedVersionKey"];
  }

  v11 = [v4 objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];

  if (v11)
  {
    v12 = *MEMORY[0x277CD0640];
    v13 = [v4 hmf_UUIDForKey:*MEMORY[0x277CD0640]];
    v14 = [(HMDHomeManager *)self currentHomeConfigurations];
    v15 = [v14 objectForKeyedSubscript:v13];

    if (v13 && v15)
    {
      v16 = [v13 UUIDString];
      [v5 setObject:v16 forKeyedSubscript:v12];

      [v5 setObject:v15 forKeyedSubscript:@"kHomeConfigurationVersionKey"];
    }

    else
    {
      v17 = objc_autoreleasePoolPush();
      v18 = self;
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        v29 = 138543874;
        v30 = v20;
        v31 = 2114;
        v32 = v13;
        v33 = 2114;
        v34 = v15;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Home UUID %{public}@ or Configuration Version %{public}@ is nil", &v29, 0x20u);
      }

      objc_autoreleasePoolPop(v17);
    }
  }

  if (v6)
  {
    v21 = [v6 version];
    [v5 setObject:v21 forKeyedSubscript:@"kMetadataInfoVersionKey"];

    v22 = [v6 schemaVersion];
    [v5 setObject:v22 forKeyedSubscript:@"kMetadataInfoSchemaVersionKey"];

    v23 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v6, "incomplete") ^ 1}];
    [v5 setObject:v23 forKeyedSubscript:@"kMetadataInfoCompletenessKey"];
  }

  v24 = [v4 objectForKeyedSubscript:@"kHomedSupportedFeaturesKey"];

  if (v24)
  {
    v25 = homedSupportedFeatures;
    [v5 setObject:v25 forKeyedSubscript:@"kHomedSupportedFeaturesKey"];
  }

  v26 = [v5 copy];

  v27 = *MEMORY[0x277D85DE8];

  return v26;
}

- (BOOL)_capabilitiesAreSupported:(id)a3
{
  v64 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v58 = v8;
    v59 = 2114;
    v60 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Checking for capabilities %{public}@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v54 = 0u;
  v55 = 0u;
  v52 = 0u;
  v53 = 0u;
  v9 = v4;
  v10 = [v9 countByEnumeratingWithState:&v52 objects:v63 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v53;
    v47 = *MEMORY[0x277CD0640];
    v45 = *v53;
    v46 = v6;
    while (2)
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v53 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v52 + 1) + 8 * i);
        if ([v14 isEqualToString:{@"kDeviceClassTypeKey", v45, v46}])
        {
          v15 = [v9 hmf_stringForKey:@"kDeviceClassTypeKey"];
          v16 = getDeviceClass();
          v17 = [v15 isEqualToString:v16];

          if ((v17 & 1) == 0)
          {
            goto LABEL_38;
          }
        }

        else if ([v14 isEqualToString:@"kHomedVersionKey"])
        {
          v18 = [v9 hmf_numberForKey:@"kHomedVersionKey"];
          v19 = homedVersion;
          v20 = [v18 compare:v19];

          if (v20 == 1)
          {
            goto LABEL_38;
          }
        }

        else
        {
          if ([v14 isEqualToString:v47])
          {
            v21 = [v9 hmf_UUIDForKey:v47];
            v22 = [(HMDHomeManager *)v6 currentHomeConfigurations];
            v23 = [v22 objectForKeyedSubscript:v21];

            if (!v21 || !v23)
            {
              v41 = objc_autoreleasePoolPush();
              v42 = v6;
              v43 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
              {
                v44 = HMFGetLogIdentifier();
                *buf = 138543874;
                v58 = v44;
                v59 = 2114;
                v60 = v21;
                v61 = 2114;
                v62 = v23;
                _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@Home UUID %{public}@ or Configuration Version %{public}@ is nil", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v41);
LABEL_37:

LABEL_38:
              v34 = 0;
              goto LABEL_40;
            }
          }

          else
          {
            if (![v14 isEqualToString:@"kHomedSupportedFeaturesKey"])
            {
              goto LABEL_38;
            }

            v24 = [v9 hmf_arrayForKey:@"kHomedSupportedFeaturesKey"];
            v23 = homedSupportedFeatures;
            v25 = objc_autoreleasePoolPush();
            v26 = v6;
            v27 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
            {
              v28 = HMFGetLogIdentifier();
              *buf = 138543874;
              v58 = v28;
              v59 = 2114;
              v60 = v24;
              v61 = 2114;
              v62 = v23;
              _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_DEBUG, "%{public}@Checking for required features: %{public}@, ours: %{public}@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v25);
            v50 = 0u;
            v51 = 0u;
            v48 = 0u;
            v49 = 0u;
            v21 = v24;
            v29 = [v21 countByEnumeratingWithState:&v48 objects:v56 count:16];
            if (v29)
            {
              v30 = v29;
              v31 = *v49;
              while (2)
              {
                for (j = 0; j != v30; ++j)
                {
                  if (*v49 != v31)
                  {
                    objc_enumerationMutation(v21);
                  }

                  v33 = *(*(&v48 + 1) + 8 * j);
                  if (([v23 containsObject:v33] & 1) == 0)
                  {
                    v35 = objc_autoreleasePoolPush();
                    v36 = v26;
                    v37 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
                    {
                      v38 = HMFGetLogIdentifier();
                      *buf = 138543618;
                      v58 = v38;
                      v59 = 2114;
                      v60 = v33;
                      _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_INFO, "%{public}@### Feature: %{public}@ not supported", buf, 0x16u);
                    }

                    objc_autoreleasePoolPop(v35);
                    goto LABEL_37;
                  }
                }

                v30 = [v21 countByEnumeratingWithState:&v48 objects:v56 count:16];
                if (v30)
                {
                  continue;
                }

                break;
              }
            }

            v12 = v45;
            v6 = v46;
          }
        }
      }

      v11 = [v9 countByEnumeratingWithState:&v52 objects:v63 count:16];
      v34 = 1;
      if (v11)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v34 = 1;
  }

LABEL_40:

  v39 = *MEMORY[0x277D85DE8];
  return v34;
}

- (void)_removeConfigurationVersionForHome:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __53__HMDHomeManager__removeConfigurationVersionForHome___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __53__HMDHomeManager__removeConfigurationVersionForHome___block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) currentHomeConfigurations];
  [v2 removeObjectForKey:*(a1 + 40)];
}

- (void)_updateHome:(id)a3 configurationVersion:(int64_t)a4
{
  v6 = a3;
  v7 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager__updateHome_configurationVersion___block_invoke;
  block[3] = &unk_279732F10;
  block[4] = self;
  v10 = v6;
  v11 = a4;
  v8 = v6;
  dispatch_async(v7, block);
}

void __51__HMDHomeManager__updateHome_configurationVersion___block_invoke(uint64_t a1)
{
  v3 = [MEMORY[0x277CCABB0] numberWithInteger:*(a1 + 48)];
  v2 = [*(a1 + 32) currentHomeConfigurations];
  [v2 setObject:v3 forKeyedSubscript:*(a1 + 40)];
}

- (void)_handleRequestIsUserUsingHomeKit:(id)a3
{
  v14[2] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 count];

  if (v6)
  {
    v13[0] = @"kHomeKitInUseKey";
    v13[1] = @"kHomeKitUsingCloudKey";
    v14[0] = MEMORY[0x277CBEC38];
    v7 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager accountActive](self, "accountActive")}];
    v14[1] = v7;
    v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v14 forKeys:v13 count:2];
  }

  else
  {
    v11[0] = @"kHomeKitInUseKey";
    v11[1] = @"kHomeKitUsingCloudKey";
    v12[0] = MEMORY[0x277CBEC28];
    v12[1] = MEMORY[0x277CBEC28];
    v8 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v12 forKeys:v11 count:2];
  }

  v9 = [v4 responseHandler];

  (v9)[2](v9, 0, v8);
  v10 = *MEMORY[0x277D85DE8];
}

- (void)processCloudZoneModelRemoved:(id)a3 message:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [v6 uuid];
  v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:v8];

  if (v9)
  {
    v10 = [(HMDHomeManager *)self cloudZones];
    [v10 removeObject:v9];

    v11 = [v7 transactionResult];
    [v11 markChanged];
    v12 = [v9 uuid];
    v13 = [(HMDHomeManager *)self _homeWithZoneID:v12];

    if (v13)
    {
      v14 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
      [(HMDHomeManager *)self scheduleRemovalForHome:v13 message:0 options:v14];
    }

    else
    {
      v14 = [(HMDHomeManager *)self cloudDataSyncManager];
      v16 = [v9 uuid];
      v17 = [v16 UUIDString];
      [v14 removeHomeZoneName:v17];
    }

    if ([v6 requiresHomeManagerUpdate])
    {
      v18 = [(HMDHomeManager *)self backingStore];
      v19 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v20 = [v18 transaction:@"kHomeManagerUpdatedKey" options:v19];

      v21 = [HMDHomeManagerModel alloc];
      v22 = [(HMDHomeManager *)self uuid];
      v23 = [(HMDBackingStoreModelObject *)v21 initWithObjectChangeType:1 uuid:v22 parentUUID:0];

      v24 = [(HMDHomeManager *)self cloudZones];
      v25 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:v24];
      [(HMDHomeManagerModel *)v23 setCloudZoneInformation:v25];

      [v20 add:v23 withMessage:0];
      objc_initWeak(&location, self);
      v26 = MEMORY[0x277D85DD0];
      v27 = 3221225472;
      v28 = __55__HMDHomeManager_processCloudZoneModelRemoved_message___block_invoke;
      v29 = &unk_279734708;
      objc_copyWeak(&v30, &location);
      [v20 save:&v26];
      objc_destroyWeak(&v30);
      objc_destroyWeak(&location);
    }

    [v7 respondWithPayload:{0, v26, v27, v28, v29}];
    goto LABEL_10;
  }

  v15 = [v7 responseHandler];

  if (v15)
  {
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    v13 = [v7 responseHandler];
    (v13)[2](v13, v11, 0);
LABEL_10:
  }
}

void __55__HMDHomeManager_processCloudZoneModelRemoved_message___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Update zone information in home manager with error %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [v6 _saveWithReason:@"kHomeManagerUpdatedKey" postSyncNotification:0];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)processCloudZoneModelAdd:(id)a3 message:(id)a4
{
  v42 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 uuid];
  v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:v8];

  v10 = objc_autoreleasePoolPush();
  v11 = self;
  v12 = HMFGetOSLogHandle();
  v13 = os_log_type_enabled(v12, OS_LOG_TYPE_INFO);
  if (v9)
  {
    if (v13)
    {
      v14 = HMFGetLogIdentifier();
      v15 = [v6 ownerName];
      *buf = 138543618;
      v39 = v14;
      v40 = 2112;
      v41 = v15;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Processing zone model update %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    [(HMDCloudZoneInformation *)v9 updateCloudZoneInformationWithModel:v6 message:v7];
  }

  else
  {
    if (v13)
    {
      v16 = HMFGetLogIdentifier();
      v17 = [v6 ownerName];
      *buf = 138543618;
      v39 = v16;
      v40 = 2112;
      v41 = v17;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Processing zone model add %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v18 = [HMDCloudZoneInformation alloc];
    v19 = [v6 ownerName];
    v20 = [v6 uuid];
    v9 = [(HMDCloudZoneInformation *)v18 initWithOwnerName:v19 uuid:v20];

    [(HMDCloudZoneInformation *)v9 updateCloudZoneInformationWithModel:v6 message:v7];
    v21 = [(HMDHomeManager *)v11 cloudZones];
    [v21 addObject:v9];

    v22 = [(HMDHomeManager *)v11 cloudDataSyncManager];
    v23 = [(HMDCloudZoneInformation *)v9 uuid];
    v24 = [v23 UUIDString];
    v25 = [(HMDCloudZoneInformation *)v9 ownerName];
    [v22 addHomeZoneName:v24 owner:v25];
  }

  v26 = [v7 transactionResult];
  [v26 markChanged];
  if ([v6 requiresHomeManagerUpdate])
  {
    v27 = [(HMDHomeManager *)v11 backingStore];
    v28 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v29 = [v27 transaction:@"kHomeManagerUpdatedKey" options:v28];

    v30 = [HMDHomeManagerModel alloc];
    v31 = [(HMDHomeManager *)v11 uuid];
    v32 = [(HMDBackingStoreModelObject *)v30 initWithObjectChangeType:1 uuid:v31 parentUUID:0];

    v33 = [(HMDHomeManager *)v11 cloudZones];
    v34 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:v33];
    [(HMDHomeManagerModel *)v32 setCloudZoneInformation:v34];

    [v29 add:v32 withMessage:0];
    objc_initWeak(buf, v11);
    v36[0] = MEMORY[0x277D85DD0];
    v36[1] = 3221225472;
    v36[2] = __51__HMDHomeManager_processCloudZoneModelAdd_message___block_invoke;
    v36[3] = &unk_279734708;
    objc_copyWeak(&v37, buf);
    [v29 save:v36];
    objc_destroyWeak(&v37);
    objc_destroyWeak(buf);
  }

  [v7 respondWithPayload:0];

  v35 = *MEMORY[0x277D85DE8];
}

void __51__HMDHomeManager_processCloudZoneModelAdd_message___block_invoke(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Update zone information in home manager with error %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [v6 _saveWithReason:@"kHomeManagerUpdatedKey" postSyncNotification:0];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)addTransactionAfterPush:(id)a3
{
  if (a3)
  {
    v4 = a3;
    v5 = [(HMDHomeManager *)self backingStore];
    v6 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v12 = [v5 transaction:@"kHomeManagerCloudZoneAddedKey" options:v6];

    v7 = [HMDCloudZoneInformationModel alloc];
    v8 = [v4 uuid];
    v9 = [(HMDHomeManager *)self uuid];
    v10 = [(HMDBackingStoreModelObject *)v7 initWithObjectChangeType:1 uuid:v8 parentUUID:v9];

    v11 = [v4 ownerName];

    [(HMDCloudZoneInformationModel *)v10 setOwnerName:v11];
    [(HMDCloudZoneInformationModel *)v10 setRequiresHomeManagerUpdate:1];
    [v12 add:v10 withMessage:0];
    [v12 run];
  }
}

- (void)_addCloudZone:(id)a3 ownerName:(id)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = v7;
  if (v6)
  {
    if (v7)
    {
      v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:v6];
      if (!v9)
      {
        v9 = [[HMDCloudZoneInformation alloc] initWithOwnerName:v8 uuid:v6];
        v10 = [(HMDHomeManager *)self cloudZones];
        [v10 addObject:v9];
      }
    }

    else
    {
      v11 = objc_autoreleasePoolPush();
      v12 = self;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
      {
        v14 = HMFGetLogIdentifier();
        v15 = [v6 UUIDString];
        v17 = 138543618;
        v18 = v14;
        v19 = 2112;
        v20 = v15;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot add zone because the ownerName was not specified, %@", &v17, 0x16u);
      }

      objc_autoreleasePoolPop(v11);
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (BOOL)zoneFetchFailed
{
  v14 = *MEMORY[0x277D85DE8];
  v9 = 0u;
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v2 = [(HMDHomeManager *)self cloudZones];
  v3 = [v2 copy];

  v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
  if (v4)
  {
    v5 = *v10;
    while (2)
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v10 != v5)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v9 + 1) + 8 * i) didFetchFailed])
        {
          LOBYTE(v4) = 1;
          goto LABEL_11;
        }
      }

      v4 = [v3 countByEnumeratingWithState:&v9 objects:v13 count:16];
      if (v4)
      {
        continue;
      }

      break;
    }
  }

LABEL_11:

  v7 = *MEMORY[0x277D85DE8];
  return v4;
}

- (BOOL)_zonesFetched
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v2 = [(HMDHomeManager *)self cloudZones];
  v3 = [v2 copy];

  v4 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v12;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v3);
        }

        if ([*(*(&v11 + 1) + 8 * i) isFirstFetch])
        {
          v8 = 0;
          goto LABEL_11;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v11 objects:v15 count:16];
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  v8 = 1;
LABEL_11:

  v9 = *MEMORY[0x277D85DE8];
  return v8;
}

- (void)processHomeManagerModelUpdate:(id)a3 message:(id)a4
{
  v27 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  if ([v6 propertyWasSet:@"primaryHomeUUID"])
  {
    v8 = [v6 primaryHomeUUID];

    if (v8)
    {
      v9 = objc_alloc(MEMORY[0x277CCAD78]);
      v10 = [v6 primaryHomeUUID];
      v11 = [v9 initWithUUIDString:v10];

      v12 = [(HMDHomeManager *)self primaryHomeUUID];
      v13 = HMFEqualObjects();

      if ((v13 & 1) == 0)
      {
        v14 = objc_autoreleasePoolPush();
        v15 = self;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v17 = HMFGetLogIdentifier();
          v23 = 138543618;
          v24 = v17;
          v25 = 2112;
          v26 = v11;
          _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Applying primary home UUID: %@", &v23, 0x16u);
        }

        objc_autoreleasePoolPop(v14);
        [(HMDHomeManager *)v15 setPrimaryHomeUUID:v11];
        v18 = objc_opt_new();
        v19 = [(HMDHomeManager *)v15 primaryHomeUUID];
        [v18 setObject:v19 forKeyedSubscript:@"HMDPrimaryHomeUUIDKey"];

        v20 = [MEMORY[0x277CCAB98] defaultCenter];
        [v20 postNotificationName:@"HMDNotificationPrimaryHomeDidChange" object:v15 userInfo:v18];
      }
    }
  }

  v21 = [v7 transactionResult];
  [v21 markChanged];
  [v7 respondWithSuccess];

  v22 = *MEMORY[0x277D85DE8];
}

- (void)_changePrimaryHome:(id)a3
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    v5 = [(HMDHomeManager *)self primaryHomeUUID];
    v6 = HMFEqualObjects();

    if ((v6 & 1) == 0)
    {
      v7 = objc_autoreleasePoolPush();
      v8 = self;
      v9 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
      {
        v10 = HMFGetLogIdentifier();
        v11 = [(HMDHomeManager *)v8 primaryHomeUUID];
        v20 = 138543874;
        v21 = v10;
        v22 = 2112;
        v23 = v11;
        v24 = 2112;
        v25 = v4;
        _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Updating the primary home from %@ to %@", &v20, 0x20u);
      }

      objc_autoreleasePoolPop(v7);
      v12 = [HMDHomeManagerModel alloc];
      v13 = [(HMDHomeManager *)v8 uuid];
      v14 = [(HMDBackingStoreModelObject *)v12 initWithObjectChangeType:1 uuid:v13 parentUUID:0];

      v15 = [v4 UUIDString];
      [(HMDHomeManagerModel *)v14 setPrimaryHomeUUID:v15];

      v16 = [(HMDHomeManager *)v8 backingStore];
      v17 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v18 = [v16 transaction:@"HMD.hm" options:v17];

      [v18 add:v14 withMessage:0];
      [v18 run];
    }
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestSetPrimaryHome:(id)a3
{
  v16 = a3;
  v4 = [v16 uuidForKey:*MEMORY[0x277CD0640]];
  if (v4)
  {
    v5 = [(HMDHomeManager *)self _homeWithUUID:v4];
    if (v5)
    {
      v6 = [HMDHomeManagerModel alloc];
      v7 = [(HMDHomeManager *)self uuid];
      v8 = [(HMDBackingStoreModelObject *)v6 initWithObjectChangeType:1 uuid:v7 parentUUID:0];

      v9 = [v4 UUIDString];
      [(HMDHomeManagerModel *)v8 setPrimaryHomeUUID:v9];

      v10 = [(HMDHomeManager *)self backingStore];
      v11 = [v16 name];
      v12 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v13 = [v10 transaction:v11 options:v12];

      [v13 add:v8 withMessage:v16];
      [v13 run];
    }

    else
    {
      v15 = [v16 responseHandler];

      if (!v15)
      {
        v5 = 0;
        goto LABEL_10;
      }

      v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      v13 = [v16 responseHandler];
      (v13)[2](v13, v8, 0);
    }
  }

  else
  {
    v14 = [v16 responseHandler];

    if (!v14)
    {
      goto LABEL_11;
    }

    v5 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    v8 = [v16 responseHandler];
    (*&v8->super._bsoDataVersionOverride)(v8, v5, 0);
  }

LABEL_10:
LABEL_11:
}

- (void)processHomeModelRemoved:(id)a3 message:(id)a4
{
  v29 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v23 = 138543874;
    v24 = v11;
    v25 = 2112;
    v26 = v6;
    v27 = 2112;
    v28 = v7;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Removing home model : %@ due to message: %@", &v23, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [v6 uuid];
  if (v12)
  {
    v13 = [(HMDHomeManager *)v9 _homeWithUUID:v12];
    if (v13)
    {
      v14 = v13;
      v15 = [v7 transactionResult];
      v16 = [v15 source] == 1;

      [(HMDHomeManager *)v9 _removeHome:v14 withMessage:v7 saveToStore:1 notifyUsers:1 shouldRemovePairings:v16];
    }

    else
    {
      v19 = [v7 responseHandler];

      if (v19)
      {
        v20 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:2 userInfo:0];
        v21 = [v7 responseHandler];
        (v21)[2](v21, v20, 0);
      }

      v14 = 0;
    }

    goto LABEL_11;
  }

  v17 = [v7 responseHandler];

  if (v17)
  {
    v14 = [MEMORY[0x277CCA9B8] errorWithDomain:*MEMORY[0x277CCFD28] code:20 userInfo:0];
    v18 = [v7 responseHandler];
    (v18)[2](v18, v14, 0);

LABEL_11:
  }

  v22 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestRemoveHome:(id)a3
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:*MEMORY[0x277CD0640]];
  v6 = [(HMDHomeManager *)self _homeWithUUID:v5];
  if (v6)
  {
    if ([v4 isEntitledForSPIAccess])
    {
      [(HMDHomeManager *)self _handleRemoveHomeOperation:v6 message:v4];
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543618;
        v23 = v13;
        v24 = 2112;
        v25 = v6;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Presenting delete home confirmation dialog to user for %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v14 = +[HMDUIDialogPresenter sharedUIDialogPresenter];
      v15 = [v6 name];
      v16 = [(HMDHomeManager *)v11 workQueue];
      v18[0] = MEMORY[0x277D85DD0];
      v18[1] = 3221225472;
      v18[2] = __43__HMDHomeManager__handleRequestRemoveHome___block_invoke;
      v18[3] = &unk_279732530;
      v18[4] = v11;
      v19 = v5;
      v20 = v6;
      v21 = v4;
      [v14 requestUserPermissionForDeletionOfHomeWithName:v15 withContext:v19 queue:v16 completionHandler:v18];
    }
  }

  else
  {
    v7 = [v4 responseHandler];

    if (v7)
    {
      v8 = [v4 responseHandler];
      v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      (v8)[2](v8, v9, 0);
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __43__HMDHomeManager__handleRequestRemoveHome___block_invoke(uint64_t a1, int a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = v7;
    v9 = @"delete home";
    if (a2)
    {
      v9 = @"cancel";
    }

    v22 = 138543618;
    v23 = v7;
    v24 = 2112;
    v25 = v9;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@User selected %@", &v22, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  if ((a2 & 1) == 0)
  {
    v13 = [*(a1 + 32) _homeWithUUID:*(a1 + 40)];
    if (v13)
    {
      v11 = v13;
      [*(a1 + 32) _handleRemoveHomeOperation:*(a1 + 48) message:*(a1 + 56)];
    }

    else
    {
      v14 = objc_autoreleasePoolPush();
      v15 = *(a1 + 32);
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
      {
        v17 = HMFGetLogIdentifier();
        v18 = *(a1 + 40);
        v22 = 138543618;
        v23 = v17;
        v24 = 2112;
        v25 = v18;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Home Removal failed because no home found for %@", &v22, 0x16u);
      }

      objc_autoreleasePoolPop(v14);
      v11 = [*(a1 + 56) responseHandler];

      if (v11)
      {
        v19 = [*(a1 + 56) responseHandler];
        v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        (v19)[2](v19, v20, 0);

        v11 = 0;
      }
    }

    goto LABEL_14;
  }

  v10 = [*(a1 + 56) responseHandler];

  if (v10)
  {
    v11 = [*(a1 + 56) responseHandler];
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23];
    (v11)[2](v11, v12, 0);

LABEL_14:
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (void)_handleRemoveHomeOperation:(id)a3 message:(id)a4
{
  v6 = a4;
  v7 = a3;
  v8 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
  [(HMDHomeManager *)self scheduleRemovalForHome:v7 message:v6 options:v8];
}

- (void)scheduleRemovalForHome:(id)a3 message:(id)a4 options:(id)a5
{
  location[3] = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  if (v8)
  {
    v11 = v8;
    v12 = [v11 name];
    v13 = [v11 zoneID];
    v14 = [v9 name];
    v15 = v14;
    v16 = @"kHomeManagerUpdatedKey";
    if (v14)
    {
      v16 = v14;
    }

    v17 = v16;

    v18 = [(HMDHomeManager *)self syncManager];
    objc_initWeak(location, self);
    v30[0] = MEMORY[0x277D85DD0];
    v30[1] = 3221225472;
    v30[2] = __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke;
    v30[3] = &unk_279732508;
    objc_copyWeak(&v38, location);
    v19 = v11;
    v31 = v19;
    v20 = v17;
    v32 = v20;
    v33 = v10;
    v34 = v9;
    v21 = v13;
    v35 = v21;
    v22 = v12;
    v36 = v22;
    v23 = v18;
    v37 = v23;
    [v23 pauseAndWaitForCurrentOperationCompletion:v30];

    objc_destroyWeak(&v38);
    objc_destroyWeak(location);

    goto LABEL_9;
  }

  v24 = objc_autoreleasePoolPush();
  v25 = self;
  v26 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
  {
    v27 = HMFGetLogIdentifier();
    LODWORD(location[0]) = 138543362;
    *(location + 4) = v27;
    _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_ERROR, "%{public}@Cannot schedule removal of home because the home was not specified", location, 0xCu);
  }

  objc_autoreleasePoolPop(v24);
  v28 = [v9 responseHandler];

  if (v28)
  {
    v19 = [v9 responseHandler];
    v22 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    (*(v19 + 2))(v19, v22, 0);
LABEL_9:
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 88));
  if (WeakRetained)
  {
    v3 = [*(a1 + 32) deletedBackingStoreObject];
    v4 = [WeakRetained backingStore];
    v5 = [v4 transaction:*(a1 + 40) options:*(a1 + 48)];

    [v5 add:v3 withMessage:*(a1 + 56)];
    v6[0] = MEMORY[0x277D85DD0];
    v6[1] = 3221225472;
    v6[2] = __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke_2;
    v6[3] = &unk_2797324E0;
    objc_copyWeak(&v11, (a1 + 88));
    v7 = *(a1 + 48);
    v8 = *(a1 + 64);
    v9 = *(a1 + 72);
    v10 = *(a1 + 80);
    [v5 run:v6];

    objc_destroyWeak(&v11);
  }

  else
  {
    [*(a1 + 80) resume];
  }
}

void __57__HMDHomeManager_scheduleRemovalForHome_message_options___block_invoke_2(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  v5 = WeakRetained;
  if (!v3 && WeakRetained && [*(a1 + 32) source] != 1)
  {
    v6 = [v5 cloudDataSyncManager];
    v7 = [*(a1 + 40) UUIDString];
    [v6 removeHomeZoneName:v7];
  }

  v8 = objc_autoreleasePoolPush();
  v9 = v5;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v12 = *(a1 + 48);
    v14 = 138543874;
    v15 = v11;
    v16 = 2112;
    v17 = v12;
    v18 = 2112;
    v19 = v3;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Resume sync manager after finishing removing home %@ - error %@", &v14, 0x20u);
  }

  objc_autoreleasePoolPop(v8);
  [*(a1 + 56) resume];

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_removeHome:(id)a3 withMessage:(id)a4 saveToStore:(BOOL)a5 notifyUsers:(BOOL)a6 shouldRemovePairings:(BOOL)a7
{
  v33 = a7;
  v45 = *MEMORY[0x277D85DE8];
  v11 = a3;
  v12 = a4;
  v13 = [v11 uuid];
  v14 = [v11 owner];
  v15 = [v14 account];
  v16 = [v15 senderCorrelationIdentifier];

  v17 = [(HMDHomeManager *)self pendingHomesBeingRemoved];
  [v17 addObject:v13];

  v18 = [v12 transactionResult];
  [v18 markChanged];
  v19 = objc_autoreleasePoolPush();
  v20 = self;
  v21 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
  {
    HMFGetLogIdentifier();
    v32 = v18;
    v22 = v31 = a5;
    [v11 name];
    v24 = v23 = a6;
    *buf = 138543618;
    v42 = v22;
    v43 = 2112;
    v44 = v24;
    _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Removing all accessories for home %@", buf, 0x16u);

    a6 = v23;
    a5 = v31;
    v18 = v32;
  }

  objc_autoreleasePoolPop(v19);
  v25 = [(HMDHomeManager *)v20 workQueue];
  v34[0] = MEMORY[0x277D85DD0];
  v34[1] = 3221225472;
  v34[2] = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke;
  v34[3] = &unk_2797324B8;
  v34[4] = v20;
  v35 = v11;
  v39 = a6;
  v36 = v13;
  v37 = v16;
  v40 = a5;
  v38 = v12;
  v26 = v12;
  v27 = v16;
  v28 = v13;
  v29 = v11;
  [v29 removeAllHomeContentsAndAccessoryPairings:v33 queue:v25 completionHandler:v34];

  v30 = *MEMORY[0x277D85DE8];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke(uint64_t a1)
{
  v82 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) name];
    *buf = 138543618;
    v79 = v5;
    v80 = 2112;
    v81 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Removing home %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = +[HMDBulletinBoard sharedBulletinBoard];
  [v7 removeBulletinsForHome:*(a1 + 40)];
  if (*(a1 + 72) == 1)
  {
    [*(a1 + 32) _removeAllUsersOfHome:*(a1 + 40)];
  }

  [*(a1 + 40) unconfigure];
  [*(a1 + 32) removeHome:*(a1 + 40)];
  v8 = [*(a1 + 32) pendingHomesBeingRemoved];
  [v8 removeObject:*(a1 + 48)];

  [*(a1 + 40) stopThreadNetwork:0];
  if ([*(a1 + 40) isOwnerUser])
  {
    v9 = [*(a1 + 32) homes];
    v10 = [v9 na_any:&__block_literal_global_1202];

    if ((v10 & 1) == 0)
    {
      v11 = [*(a1 + 32) workQueue];
      v70 = MEMORY[0x277D85DD0];
      v71 = 3221225472;
      v72 = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_2;
      v73 = &unk_2797359B0;
      v12 = *(a1 + 40);
      v74 = *(a1 + 32);
      v75 = v12;
      dispatch_async(v11, &v70);
    }
  }

  v13 = [*(a1 + 40) uuid];
  v14 = [*(a1 + 32) primaryHomeUUID];
  v15 = [v13 isEqual:v14];

  if (v15)
  {
    v16 = [*(a1 + 32) homes];
    v17 = [v16 firstObject];

    v18 = *(a1 + 32);
    v19 = [v17 uuid];
    [v18 _changePrimaryHome:v19];
  }

  v20 = [*(a1 + 40) uuid];
  v21 = [*(a1 + 32) currentHomeUUID];
  v22 = [v20 isEqual:v21];

  if (v22)
  {
    [*(a1 + 32) setLastCurrentHomeUUID:0];
    [*(a1 + 32) _updateCurrentHomeIfNecessary];
  }

  [*(a1 + 32) updateHomeKitInUsePreferences];
  v23 = [*(a1 + 32) cloudDataSyncStateFilter];
  v24 = [*(a1 + 32) homes];
  [v23 updateTotalHomes:{objc_msgSend(v24, "count")}];

  v25 = [*(a1 + 32) nameValidator];
  v26 = [*(a1 + 40) uuid];
  v27 = [v25 removeNamespace:v26];

  v28 = *(a1 + 32);
  v29 = [*(a1 + 40) uuid];
  [v28 _removeConfigurationVersionForHome:v29];

  v30 = *(a1 + 32);
  v31 = [*(a1 + 40) name];
  v32 = [*(a1 + 32) uuid];
  v33 = [v30 removeName:v31 namespace:v32];

  if (v33)
  {
    v34 = objc_autoreleasePoolPush();
    v35 = *(a1 + 32);
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_DEFAULT))
    {
      v37 = HMFGetLogIdentifier();
      v38 = [*(a1 + 40) name];
      *buf = 138543618;
      v79 = v37;
      v80 = 2112;
      v81 = v38;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_DEFAULT, "%{public}@Failed to remove home name '%@' from homeManager namespace", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v34);
  }

  if (([*(a1 + 40) isOwnerUser] & 1) == 0 && !isWatch())
  {
    v39 = [*(a1 + 32) uuidsOfRemovedHomes];
    v40 = [v39 containsObject:*(a1 + 48)];

    if ((v40 & 1) == 0)
    {
      v41 = [*(a1 + 32) uuidsOfRemovedHomes];
      [v41 addObject:*(a1 + 48)];

      v42 = objc_autoreleasePoolPush();
      v43 = *(a1 + 32);
      v44 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
      {
        v45 = HMFGetLogIdentifier();
        v46 = [*(a1 + 48) UUIDString];
        *buf = 138543618;
        v79 = v45;
        v80 = 2112;
        v81 = v46;
        _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_INFO, "%{public}@Adding home with UUID %@ to the uuids of guest homes removed locally", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v42);
    }

    [*(a1 + 32) _trackRemovedHomeUserMergeId:*(a1 + 56)];
  }

  if (*(a1 + 73) == 1)
  {
    v47 = *(a1 + 32);
    v48 = [*(a1 + 64) name];
    [v47 _saveWithReason:v48 postSyncNotification:1];
  }

  v49 = [*(a1 + 64) transactionResult];
  v50 = [v49 source] == 1;
  v51 = *(a1 + 32);
  v52 = [*(a1 + 40) zoneID];
  [v51 _removeCloudZone:v52 updateHomeManager:v50];

  v53 = [*(a1 + 32) compositeSettingsControllerManager];
  v54 = [*(a1 + 40) uuid];
  [v53 removeHomeZone:v54];

  v55 = objc_autoreleasePoolPush();
  v56 = *(a1 + 32);
  v57 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v57, OS_LOG_TYPE_INFO))
  {
    v58 = HMFGetLogIdentifier();
    v59 = [*(a1 + 40) name];
    *buf = 138543618;
    v79 = v58;
    v80 = 2112;
    v81 = v59;
    _os_log_impl(&dword_2531F8000, v57, OS_LOG_TYPE_INFO, "%{public}@Removed home: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v55);
  [*(a1 + 64) respondWithSuccess];
  v60 = *(a1 + 40);
  v76 = @"HMDHomeNotificationKey";
  v77 = v60;
  v61 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v77 forKeys:&v76 count:1];
  logAndPostNotification(@"HMDHomeRemovedNotification", *(a1 + 32), v61);
  [*(a1 + 40) handleHomeWasRemoved];
  v62 = [*(a1 + 32) lastEventStoreController];
  v63 = [*(a1 + 40) uuid];
  [v62 didRemoveHome:v63];

  [*(a1 + 32) updateCurrentUserEligibleForOwnerToAutoMigration];
  v64 = objc_autoreleasePoolPush();
  v65 = *(a1 + 32);
  v66 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v66, OS_LOG_TYPE_INFO))
  {
    v67 = HMFGetLogIdentifier();
    v68 = *(a1 + 40);
    *buf = 138543618;
    v79 = v67;
    v80 = 2112;
    v81 = v68;
    _os_log_impl(&dword_2531F8000, v66, OS_LOG_TYPE_INFO, "%{public}@The home should be gone : %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v64);
  v69 = *MEMORY[0x277D85DE8];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_2(uint64_t a1)
{
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_3;
  aBlock[3] = &unk_2797359D8;
  aBlock[4] = *(a1 + 32);
  v2 = _Block_copy(aBlock);
  [*(a1 + 40) removeThreadNetworkPreferredNetworkWithCompletion:v2];
}

void __87__HMDHomeManager__removeHome_withMessage_saveToStore_notifyUsers_shouldRemovePairings___block_invoke_3(uint64_t a1, void *a2)
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v7 = HMFGetLogIdentifier();
      v9 = 138543362;
      v10 = v7;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_ERROR, "%{public}@Failed to delete preferred Thread network credentials - continuing anyways", &v9, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)processHomeModelAdd:(id)a3 message:(id)a4
{
  v254[1] = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  logger = self->_logger;
  if (os_signpost_enabled(logger))
  {
    v9 = logger;
    v10 = [v6 uuid];
    v11 = [v6 parentUUID];
    *buf = 138412546;
    v244 = v10;
    v245 = 2112;
    v246 = v11;
    _os_signpost_emit_with_name_impl(&dword_2531F8000, v9, OS_SIGNPOST_INTERVAL_BEGIN, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "identifier=%{signpost.description:attribute}@ parentIdentifier=%{signpost.description:attribute}@ ", buf, 0x16u);
  }

  v12 = [(HMDHomeManager *)self setupActivity];

  if (v12)
  {
    v13 = [(HMDHomeManager *)self setupActivity];
    v253 = @"HMDHomeModelUUID";
    v14 = [v6 uuid];
    v15 = HMDailyRotatedUUID();
    v16 = [v15 UUIDString];
    v17 = v16;
    v18 = @"no uuid";
    if (v16)
    {
      v18 = v16;
    }

    v254[0] = v18;
    v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v254 forKeys:&v253 count:1];

    v20 = [(HMDHomeManager *)self setupActivity];
    [v20 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];
  }

  v221 = [v6 name];
  if (v221)
  {
    v21 = objc_alloc(MEMORY[0x277D0F8B0]);
    v22 = [v6 ownerPublicKey];
    v23 = [v21 initWithPairingKeyData:v22];

    v24 = objc_alloc(MEMORY[0x277D0F8A8]);
    v25 = [v6 ownerName];
    v26 = [v24 initWithIdentifier:v25 publicKey:v23 privateKey:0];

    v27 = [v6 ownerUserID];
    v28 = [HMDUser ownerWithUserID:v27 home:0 pairingIdentity:v26 homeManager:self];

    v219 = v28;
    if (v28)
    {
      v29 = [v6 ownerUUID];
      if (v29)
      {
        v30 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v29];
        [v28 setUUID:v30];
      }

      v31 = [v7 transactionResult];
      v32 = objc_autoreleasePoolPush();
      v33 = self;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
      {
        v35 = HMFGetLogIdentifier();
        v36 = +[HMDBackingStoreTransactionOptions stringForHMDBackingStoreTransactionSource:](HMDBackingStoreTransactionOptions, "stringForHMDBackingStoreTransactionSource:", [v31 source]);
        *buf = 138543618;
        v244 = v35;
        v245 = 2112;
        v246 = v36;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@Process Home Model Add source: %@", buf, 0x16u);

        v28 = v219;
      }

      objc_autoreleasePoolPop(v32);
      v218 = v31;
      v214 = v7;
      v210 = self;
      if ([v31 source] == 1)
      {
        v37 = [MEMORY[0x277CFEC78] systemStore];
        v38 = [(HMDHomeManager *)v33 activeAccountIdentifier];
        if (!v38)
        {
          v235 = 0;
          v236 = 0;
          v39 = [v37 getCurrentiCloudIdentifier:&v236 controllerPairingIdentifier:&v235 error:0];
          v38 = v236;
          v40 = v235;
          if (!v39 || !-[__CFString length](v38, "length") || ![v40 length])
          {
            v41 = objc_autoreleasePoolPush();
            v42 = v33;
            v43 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
            {
              HMFGetLogIdentifier();
              v45 = v44 = v6;
              *buf = 138543362;
              v244 = v45;
              _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@We don't have an active iCloud account, using the sentinel account identifier to remember the controller key", buf, 0xCu);

              v6 = v44;
            }

            objc_autoreleasePoolPop(v41);
            v38 = @"__HomeKit_NoAccount_Identifier__";
            self = v210;
          }

          v28 = v219;
        }

        v46 = [v28 pairingUsername];
        [v37 updateCurrentiCloudIdentifier:v38 controllerPairingIdentifier:v46 error:0];
      }

      v47 = [v6 defaultRoomUUID];

      if (v47)
      {
        v48 = objc_alloc(MEMORY[0x277CCAD78]);
        v49 = [v6 defaultRoomUUID];
        v50 = [v48 initWithUUIDString:v49];
      }

      else
      {
        v50 = 0;
      }

      v97 = MEMORY[0x277CD1F00];
      v98 = [v6 presenceAuthorizationStatus];
      v99 = [v97 authWithNumber:v98];

      v100 = [HMDHome alloc];
      v101 = [v6 uuid];
      v102 = objc_alloc_init(HMDHomeDefaultDataSource);
      v216 = v50;
      v213 = v99;
      v103 = [(HMDHome *)v100 initWithName:v221 uuid:v101 defaultRoomUUID:v50 owner:v28 homeManager:v33 presenceAuth:v99 dataSource:v102];

      v104 = [(HMDHomeManager *)v33 nameValidator];
      v105 = [(HMDHome *)v103 uuid];
      v106 = [v104 addNamespace:v105];

      v107 = [(HMDHome *)v103 name];
      v108 = [(HMDHomeManager *)v33 uuid];
      v109 = [(HMDHomeManager *)v33 addName:v107 namespace:v108];

      v110 = [(HMDHome *)v103 roomForEntireHome];
      v111 = [v110 name];
      v112 = [(HMDHome *)v103 uuid];
      v113 = [(HMDHomeManager *)v33 addName:v111 namespace:v112];

      v114 = objc_autoreleasePoolPush();
      v115 = v33;
      v116 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v116, OS_LOG_TYPE_INFO))
      {
        v117 = HMFGetLogIdentifier();
        v118 = [v28 pairingUsername];
        *buf = 138543874;
        v244 = v117;
        v245 = 2112;
        v246 = v221;
        v247 = 2112;
        v248 = v118;
        _os_log_impl(&dword_2531F8000, v116, OS_LOG_TYPE_INFO, "%{public}@Created home %@ with administrator %@", buf, 0x20u);

        v28 = v219;
      }

      objc_autoreleasePoolPop(v114);
      v119 = [(HMDHome *)v103 uuid];
      [(HMDHomeManager *)v115 _updateHome:v119 configurationVersion:[(HMDHome *)v103 configurationVersion]];

      [(HMDHomeManager *)v115 addHome:v103];
      [(HMDHome *)v103 refreshUserDisplayNames];
      v120 = v218;
      v7 = v214;
      v226 = v103;
      if ([v218 source] == 1)
      {
        v208 = v6;
        v121 = objc_autoreleasePoolPush();
        v122 = v115;
        v123 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v123, OS_LOG_TYPE_INFO))
        {
          v124 = HMFGetLogIdentifier();
          v125 = [(HMDHome *)v103 name];
          *buf = 138543618;
          v244 = v124;
          v245 = 2112;
          v246 = v125;
          _os_log_impl(&dword_2531F8000, v123, OS_LOG_TYPE_INFO, "%{public}@Saving addition objects created during creation of home %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v121);
        [(HMDHome *)v103 setupBackingStore];
        v126 = [(HMDHome *)v103 backingStore];
        v127 = [v214 name];
        v128 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v129 = [v126 transaction:v127 options:v128];

        v130 = [(HMDHome *)v103 backingStoreObjects:4];
        v231 = 0u;
        v232 = 0u;
        v233 = 0u;
        v234 = 0u;
        v131 = [v130 countByEnumeratingWithState:&v231 objects:v242 count:16];
        if (v131)
        {
          v132 = v131;
          v133 = *v232;
          do
          {
            for (i = 0; i != v132; ++i)
            {
              if (*v232 != v133)
              {
                objc_enumerationMutation(v130);
              }

              v135 = *(*(&v231 + 1) + 8 * i);
              objc_opt_class();
              isKindOfClass = objc_opt_isKindOfClass();

              if ((isKindOfClass & 1) == 0 || !v135)
              {
                [v129 add:v135 withMessage:0];
              }
            }

            v132 = [v130 countByEnumeratingWithState:&v231 objects:v242 count:16];
          }

          while (v132);
        }

        [v129 save];

        v6 = v208;
        self = v210;
        v120 = v218;
        v28 = v219;
        v103 = v226;
      }

      v137 = v120;
      v138 = [v120 source];
      [(HMDHome *)v103 configureWithHomeManager:v115 accessoriesPresent:0 uncommittedTransactions:MEMORY[0x277CBEBF8] source:v138];
      if ([(HMDHome *)v103 isOwnerUser])
      {
        v139 = +[HMDDeviceCapabilities deviceCapabilities];
        v140 = [v139 isResidentCapable];

        if (v140)
        {
          v141 = [(HMDHomeManager *)v115 notificationCenter];
          [v141 addObserver:v115 selector:sel_handleHomeCurrentDeviceResidentEligibleNotification_ name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:v103];

          v142 = [(HMDHomeManager *)v115 appleAccountManager];
          v143 = [v142 device];

          v144 = [v214 name];
          if ([v144 isEqualToString:*MEMORY[0x277CD2080]])
          {
            v145 = [(HMDHomeManager *)v115 capabilitiesController];
            v146 = [v145 currentResidentCapabilities];
            if (v146)
            {
              v147 = v146;
              v148 = [(HMDHomeManager *)v115 isResidentEnabled];

              v28 = v219;
              if (v148)
              {
                v149 = [(HMDHome *)v103 residentCapableDevices];
                v150 = [v149 containsObject:v143];

                if ((v150 & 1) == 0)
                {
                  [(HMDHome *)v103 addResidentCapableDevice:v143];
                }
              }
            }

            else
            {

              v28 = v219;
            }
          }

          else
          {
          }

          v137 = v218;
        }
      }

      [(HMDHomeManager *)v115 updateHomeKitInUsePreferences];
      v151 = [(HMDHomeManager *)v115 cloudDataSyncStateFilter];
      v152 = [(HMDHomeManager *)v115 homes];
      [v151 updateTotalHomes:{objc_msgSend(v152, "count")}];

      v153 = [v214 mutableCopy];
      [v153 setResponseHandler:0];
      v212 = v153;
      v154 = [v153 copy];
      v155 = [(HMDHome *)v103 updateHomeWithModel:v6 message:v154];

      v156 = [HMDHomeSaveRequest alloc];
      v157 = [v214 name];
      v158 = [(HMDHomeSaveRequest *)v156 initWithHome:v103 reason:v157 information:0 postSyncNotification:1 objectChange:1];

      v211 = v158;
      [(HMDHomeManager *)v115 _saveWithRequest:v158];
      v159 = [(HMDHome *)v103 zoneID];
      v160 = [(HMDHome *)v103 ownerName];
      [(HMDHomeManager *)v115 _addCloudZone:v159 ownerName:v160];

      v161 = objc_autoreleasePoolPush();
      v162 = v115;
      v163 = HMFGetOSLogHandle();
      v220 = v162;
      if (os_log_type_enabled(v163, OS_LOG_TYPE_INFO))
      {
        v164 = HMFGetLogIdentifier();
        *buf = 138543618;
        v244 = v164;
        v245 = 2112;
        v246 = v221;
        _os_log_impl(&dword_2531F8000, v163, OS_LOG_TYPE_INFO, "%{public}@Add home: %@", buf, 0x16u);

        v162 = v220;
      }

      objc_autoreleasePoolPop(v161);
      v165 = [(HMDHomeManager *)v162 homes];
      v79 = v137;
      if ([v165 count] == 1)
      {
        v217 = 1;
      }

      else
      {
        v166 = [(HMDHomeManager *)v162 primaryHomeUUID];
        if (v166)
        {
          v217 = 0;
        }

        else
        {
          v217 = [v137 source] != 1;
        }
      }

      v167 = [(HMDHomeManager *)v162 uuidsOfRemovedHomes];
      v168 = [(HMDHome *)v103 uuid];
      v169 = v162;
      v170 = [v167 containsObject:v168];

      if (v170)
      {
        v171 = [(HMDHomeManager *)v169 uuidsOfRemovedHomes];
        v172 = [(HMDHome *)v103 uuid];
        [v171 removeObject:v172];

        v173 = objc_autoreleasePoolPush();
        v174 = v169;
        v175 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v175, OS_LOG_TYPE_INFO))
        {
          v176 = HMFGetLogIdentifier();
          [(HMDHome *)v103 uuid];
          v178 = v177 = self;
          v179 = [v178 UUIDString];
          *buf = 138543618;
          v244 = v176;
          v245 = 2112;
          v246 = v179;
          _os_log_impl(&dword_2531F8000, v175, OS_LOG_TYPE_INFO, "%{public}@Removing home with UUID %@ from uuids of guest homes removed locally since invite was accepted", buf, 0x16u);

          self = v177;
          v103 = v226;
          v79 = v218;

          v7 = v214;
          v28 = v219;
        }

        objc_autoreleasePoolPop(v173);
        v169 = v220;
      }

      v180 = [(HMDHome *)v103 owner];
      v181 = [v180 account];
      v182 = [v181 senderCorrelationIdentifier];
      [(HMDHomeManager *)v169 _stopTrackingRemovedHomeUserMergeId:v182];

      v240[0] = @"kHomeDataKey";
      if ([v7 isEntitledForSPIAccess])
      {
        encodeRootObjectForSPIClients(v103);
      }

      else
      {
        encodeRootObjectForIncomingXPCMessage(v103, 0);
      }
      v183 = ;
      v241[0] = v183;
      v240[1] = *MEMORY[0x277CD0260];
      v184 = [MEMORY[0x277CCABB0] numberWithBool:v217];
      v241[1] = v184;
      v185 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v241 forKeys:v240 count:2];
      [v7 respondWithPayload:v185];

      if (-[HMDHome isOwnerUser](v103, "isOwnerUser") && [v79 source] == 1)
      {
        v209 = v6;
        v186 = [(HMDHome *)v103 backingStore];
        v187 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
        v223 = [v186 transaction:@"kBuiltinActionSetsKey" options:v187];

        v229 = 0u;
        v230 = 0u;
        v227 = 0u;
        v228 = 0u;
        obj = [(HMDHome *)v103 builtInActionSetInfo];
        v188 = [obj countByEnumeratingWithState:&v227 objects:v239 count:16];
        if (v188)
        {
          v189 = v188;
          v190 = *v228;
          v191 = *MEMORY[0x277CD2050];
          v192 = *MEMORY[0x277CD2040];
          v193 = *MEMORY[0x277CD2048];
          do
          {
            for (j = 0; j != v189; ++j)
            {
              if (*v228 != v190)
              {
                objc_enumerationMutation(obj);
              }

              v195 = *(*(&v227 + 1) + 8 * j);
              v196 = [HMDActionSetModel alloc];
              v197 = [v195 hmf_UUIDForKey:v191];
              v198 = [(HMDHome *)v226 uuid];
              v199 = [(HMDBackingStoreModelObject *)v196 initWithObjectChangeType:1 uuid:v197 parentUUID:v198];

              v200 = [v195 hmf_stringForKey:v192];
              [(HMDActionSetModel *)v199 setName:v200];

              v201 = [v195 hmf_stringForKey:v193];
              [(HMDActionSetModel *)v199 setType:v201];

              [v223 add:v199 withMessage:0];
            }

            v189 = [obj countByEnumeratingWithState:&v227 objects:v239 count:16];
          }

          while (v189);
        }

        [v223 save];
        v6 = v209;
        self = v210;
        v7 = v214;
        v79 = v218;
        v28 = v219;
        v103 = v226;
      }

      v237 = *MEMORY[0x277CD0640];
      v202 = [(HMDHome *)v103 uuid];
      v238 = v202;
      v203 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v238 forKeys:&v237 count:1];

      v204 = [(HMDHomeManager *)v220 notificationCenter];
      [v204 postNotificationName:@"HMDHomeAddedNotification" object:v220 userInfo:v203];

      v205 = self->_logger;
      if (os_signpost_enabled(v205))
      {
        *buf = 0;
        _os_signpost_emit_with_name_impl(&dword_2531F8000, v205, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
      }

      v26 = v216;
      if (v217)
      {
        v206 = [(HMDHome *)v103 uuid];
        [(HMDHomeManager *)v220 _changePrimaryHome:v206];

        [(HMDHomeManager *)v220 _updateCurrentHomeIfNecessary];
      }

      [(HMDHomeManager *)v220 updateCurrentUserEligibleForOwnerToAutoMigration];
    }

    else
    {
      v71 = v23;
      v72 = objc_autoreleasePoolPush();
      v73 = self;
      v74 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v74, OS_LOG_TYPE_ERROR))
      {
        HMFGetLogIdentifier();
        v75 = v7;
        v77 = v76 = v26;
        *buf = 138543618;
        v244 = v77;
        v245 = 2112;
        v246 = v221;
        _os_log_impl(&dword_2531F8000, v74, OS_LOG_TYPE_ERROR, "%{public}@Failed to create owner user while trying to create home with name %@", buf, 0x16u);

        v26 = v76;
        v7 = v75;
      }

      objc_autoreleasePoolPop(v72);
      v78 = [v7 responseHandler];

      v79 = v71;
      if (v78)
      {
        v80 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        v81 = [v7 responseHandler];
        (v81)[2](v81, v80, 0);

        v82 = [(HMDHomeManager *)v73 setupActivity];

        if (v82)
        {
          v225 = [(HMDHomeManager *)v73 setupActivity];
          v249[0] = @"errorCode";
          v215 = v26;
          v83 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v80, "code")}];
          v249[1] = @"HMDHomeModelUUID";
          v250[0] = v83;
          v84 = [v6 uuid];
          HMDailyRotatedUUID();
          v86 = v85 = self;
          v87 = [v86 UUIDString];
          v88 = v7;
          v89 = v87;
          v90 = @"no uuid";
          if (v87)
          {
            v90 = v87;
          }

          v250[1] = v90;
          v91 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v250 forKeys:v249 count:2];

          v7 = v88;
          self = v85;

          v28 = 0;
          v26 = v215;

          v92 = [(HMDHomeManager *)v73 setupActivity];
          [v92 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];

          v93 = self->_logger;
          if (os_signpost_enabled(v93))
          {
            v94 = v93;
            v95 = [v80 stringValueSafe];
            *buf = 138412290;
            v244 = v95;
            _os_signpost_emit_with_name_impl(&dword_2531F8000, v94, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "Error=%{signpost.description:attribute}@ ", buf, 0xCu);
          }
        }
      }

      v96 = self->_logger;
      if (os_signpost_enabled(v96))
      {
        *buf = 0;
        _os_signpost_emit_with_name_impl(&dword_2531F8000, v96, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
      }
    }

LABEL_104:
    goto LABEL_105;
  }

  v51 = [v7 responseHandler];

  if (v51)
  {
    v28 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
    v52 = [v7 responseHandler];
    (v52)[2](v52, v28, 0);

    v53 = [(HMDHomeManager *)self setupActivity];

    if (v53)
    {
      v224 = [(HMDHomeManager *)self setupActivity];
      v251[0] = @"errorCode";
      v54 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v28, "code")}];
      v252[0] = v54;
      v251[1] = @"domain";
      v55 = [v28 domain];
      v56 = v55;
      v57 = &stru_286509E58;
      if (v55)
      {
        v57 = v55;
      }

      v252[1] = v57;
      v251[2] = @"HMDHomeModelUUID";
      v58 = [v6 uuid];
      HMDailyRotatedUUID();
      v60 = v59 = v28;
      v61 = [v60 UUIDString];
      v62 = self;
      v63 = v61;
      v64 = @"no uuid";
      if (v61)
      {
        v64 = v61;
      }

      v252[2] = v64;
      v65 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v252 forKeys:v251 count:3];

      self = v62;
      v28 = v59;

      v66 = [(HMDHomeManager *)v62 setupActivity];
      [v66 markWithReason:@"HMDHomeManager.processHomeModelAdd.processHomeModelAdd"];

      v67 = v62->_logger;
      if (os_signpost_enabled(v67))
      {
        v68 = v67;
        v69 = [v28 stringValueSafe];
        *buf = 138412290;
        v244 = v69;
        _os_signpost_emit_with_name_impl(&dword_2531F8000, v68, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "Error=%{signpost.description:attribute}@ ", buf, 0xCu);
      }
    }

    v70 = self->_logger;
    if (os_signpost_enabled(v70))
    {
      *buf = 0;
      _os_signpost_emit_with_name_impl(&dword_2531F8000, v70, OS_SIGNPOST_INTERVAL_END, 0xEEEEB0B5B2B2EEEELL, "HomeModelAdd", "", buf, 2u);
    }

    goto LABEL_104;
  }

LABEL_105:

  v207 = *MEMORY[0x277D85DE8];
}

- (id)validateHomeName:(id)a3
{
  v20 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = HMMaxLengthForNaming();
  if ([v4 length] > v5)
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@New name is longer than the pre-defined max length", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v10 = MEMORY[0x277CCA9B8];
    v11 = 46;
    goto LABEL_7;
  }

  v12 = [(HMDHomeManager *)self _homeWithName:v4];

  if (v12)
  {
    v10 = MEMORY[0x277CCA9B8];
    v11 = 32;
LABEL_7:
    v13 = [v10 hmErrorWithCode:v11];
    goto LABEL_8;
  }

  v16 = [(HMDHomeManager *)self uuid];
  v13 = [(HMDHomeManager *)self addName:v4 namespace:v16];

  if (v13 && [v13 code] == 31)
  {
    v17 = [MEMORY[0x277CCA9B8] hmErrorWithCode:32];

    v13 = v17;
  }

LABEL_8:

  v14 = *MEMORY[0x277D85DE8];

  return v13;
}

- (void)_handleRequestAddHome:(id)a3
{
  v108 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self hh2FrameworkSwitch];
  v6 = [v5 checkExistenceOfHH2SentinelZone];

  if (!v6)
  {
    if ([(HMDHomeManager *)self isHH1EOLEnabled])
    {
      v15 = [(HMDHomeManager *)self activeAccountIdentifier];

      if (!v15)
      {
        v81 = objc_autoreleasePoolPush();
        v82 = self;
        v83 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v83, OS_LOG_TYPE_ERROR))
        {
          v84 = HMFGetLogIdentifier();
          *buf = 138543362;
          v103 = v84;
          _os_log_impl(&dword_2531F8000, v83, OS_LOG_TYPE_ERROR, "%{public}@No iCloud account. Creating home is not allowed.", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v81);
        v11 = MEMORY[0x277CCA9B8];
        v12 = 2040;
        goto LABEL_5;
      }
    }

    if (isWatch())
    {
LABEL_35:
      v14 = [v4 stringForKey:*MEMORY[0x277CD23D0]];
      if (v14)
      {
        v50 = [(HMDHomeManager *)self homes];
        v51 = [v50 count];
        v52 = maximumHomes;

        if (v51 < v52)
        {
          v53 = [v4 uuidForKey:*MEMORY[0x277CD0B10]];
          v54 = [HMDUser ownerWithUserID:0 home:0 pairingIdentity:0 homeManager:self];
          if (v54)
          {
            v55 = [(HMDHomeManager *)self validateHomeName:v14];
            if (!v55)
            {
              v56 = objc_autoreleasePoolPush();
              v57 = self;
              v58 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v58, OS_LOG_TYPE_INFO))
              {
                v59 = HMFGetLogIdentifier();
                *buf = 138543618;
                v103 = v59;
                v104 = 2112;
                v105 = v14;
                _os_log_impl(&dword_2531F8000, v58, OS_LOG_TYPE_INFO, "%{public}@Added home:%@ to namespace", buf, 0x16u);
              }

              objc_autoreleasePoolPop(v56);
              v60 = [HMDUser UUIDWithUserID:0 forHomeIdentifier:v53 uuid:0 pairingIdentity:0];
              [v54 setUUID:v60];

              v61 = [HMDHome alloc];
              v62 = [MEMORY[0x277CCAD78] UUID];
              v63 = objc_alloc_init(HMDHomeDefaultDataSource);
              v64 = [(HMDHome *)v61 initWithName:v14 uuid:v53 defaultRoomUUID:v62 owner:v54 homeManager:v57 presenceAuth:0 dataSource:v63];

              v65 = [(HMDHome *)v64 modelObjectWithChangeType:1];
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v66 = v65;
              }

              else
              {
                v66 = 0;
              }

              v67 = v66;

              if (v67)
              {
                v68 = objc_alloc_init(MEMORY[0x277CBEAA8]);
                [v67 setCreationDate:v68];

                v69 = [(HMDHomeManager *)v57 backingStore];
                v70 = [v4 name];
                +[HMDBackingStoreTransactionOptions defaultXPCOptions];
                v95 = v57;
                v72 = v71 = v64;
                v73 = [v69 transaction:v70 options:v72];

                v64 = v71;
                [v73 add:v67 withMessage:v4];
                v96[0] = MEMORY[0x277D85DD0];
                v96[1] = 3221225472;
                v96[2] = __40__HMDHomeManager__handleRequestAddHome___block_invoke;
                v96[3] = &unk_2797358C8;
                v96[4] = v95;
                v97 = v14;
                [v73 run:v96];
              }

              v74 = 0;
              goto LABEL_60;
            }
          }

          else
          {
            v55 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
          }

          v74 = v55;
          [v4 respondWithError:v55];
LABEL_60:

          goto LABEL_61;
        }

        v77 = objc_autoreleasePoolPush();
        v78 = self;
        v79 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v79, OS_LOG_TYPE_INFO))
        {
          v80 = HMFGetLogIdentifier();
          *buf = 138543618;
          v103 = v80;
          v104 = 2112;
          v105 = v14;
          _os_log_impl(&dword_2531F8000, v79, OS_LOG_TYPE_INFO, "%{public}@Can't add home %@; already at maximum homes", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v77);
        v75 = MEMORY[0x277CCA9B8];
        v76 = 49;
      }

      else
      {
        v75 = MEMORY[0x277CCA9B8];
        v76 = 20;
      }

      v53 = [v75 hmErrorWithCode:v76];
      [v4 respondWithError:v53];
LABEL_61:

      goto LABEL_62;
    }

    v16 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v17 = [v16 isiCloudSwitchEnabled];

    v18 = [(HMDHomeManager *)self cloudDataSource];
    v19 = [v18 isControllerKeyAvailable];

    if (v17)
    {
      if ((v19 & 1) == 0)
      {
        v85 = [(HMDHomeManager *)self cloudDataSyncManager];
        if ([v85 isFirstDBQueryRun])
        {
          v86 = [(HMDHomeManager *)self missingHomeDataRecord];

          if (v86)
          {
            v21 = 0;
            goto LABEL_34;
          }
        }

        else
        {
        }

        v88 = objc_autoreleasePoolPush();
        v89 = self;
        v90 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v90, OS_LOG_TYPE_ERROR))
        {
          v91 = HMFGetLogIdentifier();
          v92 = [(HMDHomeManager *)v89 cloudDataSyncManager];
          [v92 isFirstDBQueryRun];
          v93 = HMFBooleanToString();
          [(HMDHomeManager *)v89 missingHomeDataRecord];
          v94 = HMFBooleanToString();
          *buf = 138543874;
          v103 = v91;
          v104 = 2112;
          v105 = v93;
          v106 = 2112;
          v107 = v94;
          _os_log_impl(&dword_2531F8000, v90, OS_LOG_TYPE_ERROR, "%{public}@Cannot create controller key without all conditions good dbquery: %@, homerecord: %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v88);
        v13 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        goto LABEL_6;
      }

      v20 = [MEMORY[0x277CFEC78] systemStore];
      v101 = 0;
      [v20 getControllerPublicKey:0 secretKey:0 username:&v101 allowCreation:0 forAccessory:0 error:0];
      v21 = v101;

      v22 = objc_autoreleasePoolPush();
      v23 = self;
      v24 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
      {
        v25 = HMFGetLogIdentifier();
        *buf = 138543618;
        v103 = v25;
        v104 = 2112;
        v105 = v21;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Got the active controller pairing identifier : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v22);
      v26 = [(HMDHomeManager *)v23 cloudDataSyncManager];
      if ([v26 isFirstDBQueryRun] && -[HMDHomeManager cloudkitAccountStatusDetermined](v23, "cloudkitAccountStatusDetermined") && -[HMDHomeManager missingHomeDataRecord](v23, "missingHomeDataRecord"))
      {
        v27 = [MEMORY[0x277CFEC78] systemStore];
        v28 = [v27 activeControllerPairingIdentifier];

        if (v28 || !v21)
        {
          goto LABEL_34;
        }

        v29 = objc_autoreleasePoolPush();
        v30 = v23;
        v31 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = HMFGetLogIdentifier();
          *buf = 138543618;
          v103 = v32;
          v104 = 2112;
          v105 = v21;
          _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_DEFAULT, "%{public}@Setting the active controller pairing identifier : %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v29);
        v26 = [MEMORY[0x277CFEC78] systemStore];
        [v26 updateActiveControllerPairingIdentifier:v21];
      }
    }

    else
    {
      v33 = objc_autoreleasePoolPush();
      v34 = self;
      v35 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v35, OS_LOG_TYPE_ERROR))
      {
        v36 = HMFGetLogIdentifier();
        *buf = 138543362;
        v103 = v36;
        _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_ERROR, "%{public}@Don't have iCloud switch enabled will allow creation of new controller key", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v33);
      v99 = 0;
      v100 = 0;
      v98 = 0;
      v37 = [(HMDHomeManager *)v34 getOrCreateControllerPublicKey:&v100 controllerUsername:&v99 error:&v98];
      v26 = v100;
      v21 = v99;
      v38 = v98;
      if (v37)
      {
        v39 = [MEMORY[0x277CFEC78] systemStore];
        v40 = [v39 activeControllerPairingIdentifier];

        if (!v40)
        {
          v41 = objc_autoreleasePoolPush();
          v42 = v34;
          v43 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
          {
            v44 = HMFGetLogIdentifier();
            *buf = 138543362;
            v103 = v44;
            _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@No active controller username when iCloud switch off", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v41);
          if (v21)
          {
            v45 = objc_autoreleasePoolPush();
            v46 = v42;
            v47 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v47, OS_LOG_TYPE_DEFAULT))
            {
              v48 = HMFGetLogIdentifier();
              *buf = 138543618;
              v103 = v48;
              v104 = 2112;
              v105 = v21;
              _os_log_impl(&dword_2531F8000, v47, OS_LOG_TYPE_DEFAULT, "%{public}@Setting the active controller pairing identifier with iCloud switch off : %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v45);
            v49 = [MEMORY[0x277CFEC78] systemStore];
            [v49 updateActiveControllerPairingIdentifier:v21];
          }
        }
      }
    }

LABEL_34:
    goto LABEL_35;
  }

  v7 = objc_autoreleasePoolPush();
  v8 = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
  {
    v10 = HMFGetLogIdentifier();
    *buf = 138543362;
    v103 = v10;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@HH2 sentinel zone exist but we are not running in HH2 mode. Creating a new home is not allowed in this case", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v7);
  v11 = MEMORY[0x277CCA9B8];
  v12 = 9009;
LABEL_5:
  v13 = [v11 hmPrivateErrorWithCode:v12];
LABEL_6:
  v14 = v13;
  [v4 respondWithError:v13];
LABEL_62:

  v87 = *MEMORY[0x277D85DE8];
}

void __40__HMDHomeManager__handleRequestAddHome___block_invoke(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 32);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v8 = *(a1 + 40);
      v14 = 138543874;
      v15 = v7;
      v16 = 2112;
      v17 = v8;
      v18 = 2112;
      v19 = v3;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Removing home:%@ from namespace on transaction error %@.", &v14, 0x20u);
    }

    objc_autoreleasePoolPop(v4);
    v10 = *(a1 + 32);
    v9 = *(a1 + 40);
    v11 = [v10 uuid];
    v12 = [v10 removeName:v9 namespace:v11];
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (id)_findHomeConfigurationModelChange:(id)a3
{
  v17 = *MEMORY[0x277D85DE8];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v3 = a3;
  v4 = [v3 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v4)
  {
    v5 = *v13;
    while (2)
    {
      for (i = 0; i != v4; i = i + 1)
      {
        if (*v13 != v5)
        {
          objc_enumerationMutation(v3);
        }

        v7 = *(*(&v12 + 1) + 8 * i);
        v8 = [v7 objectChange];
        objc_opt_class();
        isKindOfClass = objc_opt_isKindOfClass();

        if ((isKindOfClass & 1) != 0 && v8)
        {
          v4 = v7;
          goto LABEL_12;
        }
      }

      v4 = [v3 countByEnumeratingWithState:&v12 objects:v16 count:16];
      if (v4)
      {
        continue;
      }

      break;
    }
  }

LABEL_12:

  v10 = *MEMORY[0x277D85DE8];

  return v4;
}

- (id)_findHomeModel:(id)a3
{
  v20 = *MEMORY[0x277D85DE8];
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v18 = 0u;
  v3 = a3;
  v4 = [v3 countByEnumeratingWithState:&v15 objects:v19 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v16;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v16 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v15 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v9 = v8;
        }

        else
        {
          v9 = 0;
        }

        v10 = v9;

        if (v10)
        {

LABEL_17:
          v12 = v8;
          goto LABEL_18;
        }

        v8 = v8;
        objc_opt_class();
        isKindOfClass = objc_opt_isKindOfClass();

        if ((isKindOfClass & 1) != 0 && v8)
        {
          goto LABEL_17;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v15 objects:v19 count:16];
      v12 = 0;
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v12 = 0;
  }

LABEL_18:

  v13 = *MEMORY[0x277D85DE8];

  return v12;
}

- (id)_findHomeSharedUserModelChange:(id)a3
{
  v36 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v28 = [MEMORY[0x277CBEB38] dictionary];
  v31 = 0u;
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v4 = v3;
  v5 = [v4 countByEnumeratingWithState:&v31 objects:v35 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v32;
    v27 = v4;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v32 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = *(*(&v31 + 1) + 8 * i);
        v10 = [v9 objectChange];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v11 = v10;
        }

        else
        {
          v11 = 0;
        }

        v12 = v11;

        if (v12)
        {
          v13 = objc_opt_class();
          if (v13 == objc_opt_class())
          {
            v14 = [v12 privilege];
            v15 = [v14 integerValue];

            if (v15 != 3)
            {
              v16 = [v12 pairingIdentity];

              if (v16)
              {
                v17 = MEMORY[0x277CFEC20];
                v18 = [v12 pairingIdentity];
                v19 = [v17 hmd_pairingIdentityWithDictionary:v18];

                if (v19)
                {
                  v30 = objc_alloc(MEMORY[0x277D0F8A8]);
                  v29 = [v19 identifier];
                  v20 = [v19 publicKey];
                  v21 = [v19 privateKey];
                  v22 = [v30 initWithIdentifier:v29 publicKey:v20 privateKey:v21];

                  v23 = v22;
                  v24 = [v28 objectForKeyedSubscript:v22];
                  if (!v24)
                  {
                    v24 = [MEMORY[0x277CBEB18] array];
                    [v28 setObject:v24 forKeyedSubscript:v23];
                  }

                  [v24 addObject:v9];

                  v4 = v27;
                }
              }
            }
          }
        }
      }

      v6 = [v4 countByEnumeratingWithState:&v31 objects:v35 count:16];
    }

    while (v6);
  }

  v25 = *MEMORY[0x277D85DE8];

  return v28;
}

- (id)_findHomeOwnerModelChange:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = [MEMORY[0x277CBEB18] array];
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v5 = v3;
  v6 = [v5 countByEnumeratingWithState:&v18 objects:v22 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v19;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v19 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v18 + 1) + 8 * i);
        v11 = [v10 objectChange];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v12 = v11;
        }

        else
        {
          v12 = 0;
        }

        v13 = v12;

        if (v13)
        {
          v14 = [v13 privilege];
          v15 = [v14 integerValue];

          if (v15 == 3)
          {
            [v4 addObject:v10];
          }
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v18 objects:v22 count:16];
    }

    while (v7);
  }

  v16 = *MEMORY[0x277D85DE8];

  return v4;
}

- (id)_findHomeModelChange:(id)a3
{
  v22 = *MEMORY[0x277D85DE8];
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v3 = a3;
  v4 = [v3 countByEnumeratingWithState:&v17 objects:v21 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v18;
    while (2)
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v18 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v17 + 1) + 8 * i);
        v9 = [v8 objectChange];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v10 = v9;
        }

        else
        {
          v10 = 0;
        }

        v11 = v10;

        if (v11)
        {

LABEL_17:
          v14 = v8;
          goto LABEL_18;
        }

        v12 = [v8 objectChange];
        objc_opt_class();
        isKindOfClass = objc_opt_isKindOfClass();

        if ((isKindOfClass & 1) != 0 && v12)
        {
          goto LABEL_17;
        }
      }

      v5 = [v3 countByEnumeratingWithState:&v17 objects:v21 count:16];
      v14 = 0;
      if (v5)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v14 = 0;
  }

LABEL_18:

  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (void)_handleCurrentHomeChanged:(id)a3
{
  v8 = a3;
  v4 = [v8 messagePayload];
  v5 = [v4 hmf_UUIDForKey:@"kCurrentHomeUUIDKey"];

  [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v5 isLocalUpdate:0];
  v6 = [v8 responseHandler];

  if (v6)
  {
    v7 = [v8 responseHandler];
    v7[2](v7, 0, 0);
  }
}

- (void)_sendCurrentHomeToWatch:(id)a3
{
  v27 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 version];
  v6 = +[HMDHomeKitVersion version3];
  v7 = [v5 isAtLeastVersion:v6];

  if (v7)
  {
    v8 = [(HMDHomeManager *)self currentHomeUUID];

    if (v8)
    {
      v23 = @"kCurrentHomeUUIDKey";
      v9 = [(HMDHomeManager *)self currentHomeUUID];
      v10 = [v9 UUIDString];
      v24 = v10;
      v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v24 forKeys:&v23 count:1];
    }

    else
    {
      v21 = @"kNoCurrentHomeKey";
      v22 = MEMORY[0x277CBEC38];
      v11 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v22 forKeys:&v21 count:1];
    }

    v15 = [HMDRemoteDeviceMessageDestination alloc];
    v16 = [(HMDHomeManager *)self uuid];
    v17 = [(HMDRemoteDeviceMessageDestination *)v15 initWithTarget:v16 device:v4];

    v18 = [MEMORY[0x277D0F818] messageWithName:@"kCurrentHomeChangedNotificationKey" qualityOfService:9 destination:v17 payload:v11];
    v19 = [(HMDHomeManager *)self messageDispatcher];
    [v19 sendMessage:v18 completionHandler:0];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v26 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Not sending current home update to legacy watch", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (void)_notifyCurrentHomeUpdated:(id)a3 isLocalUpdate:(BOOL)a4
{
  v4 = a4;
  v50 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [(HMDHomeManager *)self currentHomeUUID];
  if (!HMFEqualObjects())
  {
    if (v6)
    {
      v12 = [(HMDHomeManager *)self _homeWithUUID:v6];
      if (isAppleTV() && v12 && ([v12 isOwnerUser] & 1) == 0)
      {
        v13 = objc_autoreleasePoolPush();
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          v16 = [v6 UUIDString];
          *buf = 138543618;
          v45 = v15;
          v46 = 2112;
          v47 = v16;
          v17 = "%{public}@Not updating current home since user is not owner of home %@";
LABEL_17:
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, v17, buf, 0x16u);

          goto LABEL_18;
        }

        goto LABEL_18;
      }
    }

    else
    {
      v12 = 0;
    }

    if (!isWatch() || ![(HMDHomeManager *)self companionReachable]|| !v4)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543874;
        v45 = v20;
        v46 = 2112;
        v47 = v7;
        v48 = 2112;
        v49 = v6;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Updating the current home from %@ to %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v18);
      [(HMDHomeManager *)self setCurrentHomeUUID:v6];
      [(HMDHomeManager *)self _updatePreferencesForCurrentHome];
      if (v6)
      {
        [(HMDHomeManager *)self setLastCurrentHomeUUID:v6];
        v42 = @"kCurrentHomeUUIDKey";
        v21 = [v6 UUIDString];
        v43 = v21;
        v22 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v43 forKeys:&v42 count:1];
      }

      else
      {
        v40 = @"kNoCurrentHomeKey";
        v41 = MEMORY[0x277CBEC38];
        v22 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v41 forKeys:&v40 count:1];
      }

      v23 = [MEMORY[0x277D0F818] entitledMessageWithName:@"kCurrentHomeChangedNotificationKey" messagePayload:v22];
      v24 = [(HMDHomeManager *)self messageDispatcher];
      v25 = [(HMDHomeManager *)self uuid];
      [v24 sendMessage:v23 target:v25];

      v37 = 0u;
      v38 = 0u;
      v35 = 0u;
      v36 = 0u;
      v26 = [(HMDHomeManager *)self watchManager];
      v27 = [v26 watches];

      v28 = [v27 countByEnumeratingWithState:&v35 objects:v39 count:16];
      if (v28)
      {
        v29 = v28;
        v30 = *v36;
        do
        {
          for (i = 0; i != v29; ++i)
          {
            if (*v36 != v30)
            {
              objc_enumerationMutation(v27);
            }

            [(HMDHomeManager *)self _sendCurrentHomeToWatch:*(*(&v35 + 1) + 8 * i)];
          }

          v29 = [v27 countByEnumeratingWithState:&v35 objects:v39 count:16];
        }

        while (v29);
      }

      [(HMDHomeManager *)self writeAssistantCurrentHome:v12];
      v32 = objc_opt_new();
      [v32 setObject:v6 forKeyedSubscript:@"HMDCurrentHomeUUIDKey"];
      [v32 setObject:v7 forKeyedSubscript:@"HMDPreviousHomeUUIDKey"];
      v33 = [MEMORY[0x277CCAB98] defaultCenter];
      [v33 postNotificationName:@"HMDNotificationCurrentHomeDidChange" object:self userInfo:v32];

      goto LABEL_32;
    }

    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = [v6 UUIDString];
      *buf = 138543618;
      v45 = v15;
      v46 = 2112;
      v47 = v16;
      v17 = "%{public}@Rejecting locally updated current home (%@) on watch since companion is in range";
      goto LABEL_17;
    }

LABEL_18:

    objc_autoreleasePoolPop(v13);
LABEL_32:

    goto LABEL_33;
  }

  v8 = objc_autoreleasePoolPush();
  v9 = self;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    *buf = 138543618;
    v45 = v11;
    v46 = 2112;
    v47 = v6;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Current home is already %@, not notifying", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v8);
LABEL_33:

  v34 = *MEMORY[0x277D85DE8];
}

- (void)_updateCurrentHomeIfNecessary
{
  v3 = [(HMDHomeManager *)self _computedCurrentHomeUUID];
  [(HMDHomeManager *)self _notifyCurrentHomeUpdated:v3 isLocalUpdate:1];
}

- (id)_computedCurrentHomeUUID
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self currentHomeUUID];
  v4 = [(HMDHomeManager *)self _homeWithUUID:v3];

  if ([v4 homeLocation] != 1)
  {
LABEL_10:
    v15 = [(HMDHomeManager *)self __computedCurrentHomeUUID];
    goto LABEL_11;
  }

  v5 = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
  v6 = [v5 home];
  v7 = v6;
  if (v6)
  {
    v8 = [v6 uuid];
    v9 = [v4 uuid];
    v10 = [v8 hmf_isEqualToUUID:v9];

    if (!v10)
    {
      v16 = objc_autoreleasePoolPush();
      v17 = self;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v22 = 138543362;
        v23 = v19;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Current home does not match current accessory home, recalculating...", &v22, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      goto LABEL_10;
    }
  }

  v11 = objc_autoreleasePoolPush();
  v12 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v22 = 138543362;
    v23 = v14;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Last current home still has AtHome status, stay as current home", &v22, 0xCu);
  }

  objc_autoreleasePoolPop(v11);
  v15 = [v4 uuid];

LABEL_11:
  v20 = *MEMORY[0x277D85DE8];

  return v15;
}

- (id)__computedCurrentHomeUUID
{
  v50 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self overrideCurrentHomeUUIDToNil];
  v4 = v3;
  if (v3)
  {
    if ([v3 BOOLValue])
    {
      v5 = 0;
    }

    else
    {
      v5 = [(HMDHomeManager *)self currentHomeUUIDOverride];
    }
  }

  else
  {
    v6 = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
    v7 = [v6 home];
    if (v7)
    {
      v8 = objc_autoreleasePoolPush();
      v9 = self;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543618;
        v47 = v11;
        v48 = 2112;
        v49 = v7;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Returning current accessory home %@ as current home", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v8);
      v5 = [v7 uuid];
    }

    else
    {
      v40 = v6;
      v12 = objc_alloc(MEMORY[0x277CBEB18]);
      v13 = [(HMDHomeManager *)self homes];
      v14 = [v12 initWithCapacity:{objc_msgSend(v13, "count")}];

      v43 = 0u;
      v44 = 0u;
      v41 = 0u;
      v42 = 0u;
      v15 = [(HMDHomeManager *)self homes];
      v16 = [v15 countByEnumeratingWithState:&v41 objects:v45 count:16];
      if (v16)
      {
        v17 = v16;
        v18 = *v42;
        while (2)
        {
          for (i = 0; i != v17; ++i)
          {
            if (*v42 != v18)
            {
              objc_enumerationMutation(v15);
            }

            v20 = *(*(&v41 + 1) + 8 * i);
            if ([v20 homeLocation] == 3 || objc_msgSend(v20, "homeLocation") == 1)
            {
              v21 = [v20 uuid];
              v22 = [(HMDHomeManager *)self primaryHomeUUID];
              v23 = [v21 isEqual:v22];

              if (v23)
              {
                v30 = objc_autoreleasePoolPush();
                v31 = self;
                v32 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
                {
                  v33 = HMFGetLogIdentifier();
                  *buf = 138543618;
                  v47 = v33;
                  v48 = 2112;
                  v49 = v20;
                  _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@New nominated current home is primary home : %@", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v30);
                v5 = [v20 uuid];

                goto LABEL_27;
              }

              [v14 addObject:v20];
            }
          }

          v17 = [v15 countByEnumeratingWithState:&v41 objects:v45 count:16];
          if (v17)
          {
            continue;
          }

          break;
        }
      }

      if ([v14 count])
      {
        [v14 sortUsingComparator:&__block_literal_global_1177];
        v24 = objc_autoreleasePoolPush();
        v25 = self;
        v26 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          v28 = [v14 firstObject];
          *buf = 138543618;
          v47 = v27;
          v48 = 2112;
          v49 = v28;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@New nominated current home is %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v24);
        v29 = [v14 firstObject];
        v5 = [v29 uuid];
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        v37 = self;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          *buf = 138543362;
          v47 = v39;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_INFO, "%{public}@There is no current home", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v36);
        v5 = 0;
      }

LABEL_27:
      v6 = v40;
      v4 = 0;
      v7 = 0;
    }
  }

  v34 = *MEMORY[0x277D85DE8];

  return v5;
}

uint64_t __43__HMDHomeManager___computedCurrentHomeUUID__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v4 = a3;
  v5 = [a2 uuid];
  v6 = [v5 UUIDString];
  v7 = [v4 uuid];

  v8 = [v7 UUIDString];
  v9 = [v6 compare:v8];

  return v9;
}

- (void)_handleConnectivityInfoRequest:(id)a3
{
  v73 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 responseHandler];

  if (v5)
  {
    if ([v4 isEntitledForSPIAccess])
    {
      if ([v4 isRemote])
      {
        v6 = objc_autoreleasePoolPush();
        v7 = self;
        v8 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
        {
          v9 = HMFGetLogIdentifier();
          *buf = 138543618;
          v70 = v9;
          v71 = 2112;
          v72 = v4;
          v10 = "%{public}@This message should only be passed over XPC: %@";
          v11 = v8;
          v12 = OS_LOG_TYPE_DEFAULT;
LABEL_12:
          _os_log_impl(&dword_2531F8000, v11, v12, v10, buf, 0x16u);
        }

LABEL_13:

        objc_autoreleasePoolPop(v6);
        v17 = [v4 responseHandler];
        v18 = [MEMORY[0x277CCA9B8] hmErrorWithCode:17];
        v17[2](v17, v18, 0);
LABEL_14:

        goto LABEL_15;
      }

      v20 = [v4 proxyConnection];
      v21 = [v20 entitlements];

      if ((v21 & 0x100) != 0)
      {
        v17 = [v4 stringForKey:@"kIdentifierKey"];
        v22 = objc_autoreleasePoolPush();
        v23 = self;
        v24 = HMFGetOSLogHandle();
        v25 = os_log_type_enabled(v24, OS_LOG_TYPE_INFO);
        if (v17)
        {
          v53 = v4;
          if (v25)
          {
            v26 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v26;
            v71 = 2112;
            v72 = v17;
            _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve connectivity info for identifier : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
          v63 = 0u;
          v64 = 0u;
          v61 = 0u;
          v62 = 0u;
          v52 = v23;
          obj = [(HMDHomeManager *)v23 homes];
          v56 = [obj countByEnumeratingWithState:&v61 objects:v68 count:16];
          if (v56)
          {
            v55 = *v62;
            while (2)
            {
              for (i = 0; i != v56; ++i)
              {
                if (*v62 != v55)
                {
                  objc_enumerationMutation(obj);
                }

                v28 = *(*(&v61 + 1) + 8 * i);
                v57 = 0u;
                v58 = 0u;
                v59 = 0u;
                v60 = 0u;
                v29 = [v28 accessories];
                v30 = [v29 copy];

                v31 = [v30 countByEnumeratingWithState:&v57 objects:v67 count:16];
                if (v31)
                {
                  v32 = v31;
                  v33 = *v58;
LABEL_29:
                  v34 = 0;
                  while (1)
                  {
                    if (*v58 != v33)
                    {
                      objc_enumerationMutation(v30);
                    }

                    v35 = *(*(&v57 + 1) + 8 * v34);
                    objc_opt_class();
                    v36 = (objc_opt_isKindOfClass() & 1) != 0 ? v35 : 0;
                    v37 = v36;

                    v38 = [v37 identifier];
                    v39 = HMFAreStringsEqualIgnoringCase();

                    if (v39)
                    {
                      break;
                    }

                    if (v32 == ++v34)
                    {
                      v32 = [v30 countByEnumeratingWithState:&v57 objects:v67 count:16];
                      if (v32)
                      {
                        goto LABEL_29;
                      }

                      goto LABEL_41;
                    }
                  }

                  v40 = [v37 connectivityInfo];
                  v41 = encodeRootObject();
                  if (!v41)
                  {

                    goto LABEL_41;
                  }

                  v49 = v41;
                  v4 = v53;
                  v50 = [v53 responseHandler];
                  v65 = *MEMORY[0x277CCE9C8];
                  v66 = v49;
                  v51 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v66 forKeys:&v65 count:1];
                  (v50)[2](v50, 0, v51);

                  v18 = obj;
                  goto LABEL_51;
                }

LABEL_41:
              }

              v56 = [obj countByEnumeratingWithState:&v61 objects:v68 count:16];
              if (v56)
              {
                continue;
              }

              break;
            }
          }

          v42 = objc_autoreleasePoolPush();
          v43 = v52;
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
          {
            v45 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v45;
            v71 = 2112;
            v72 = v17;
            _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_INFO, "%{public}@Unable to get connectivity info accessory identifier: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v42);
          v4 = v53;
          v18 = [v53 responseHandler];
          v46 = MEMORY[0x277CCA9B8];
          v47 = 2;
        }

        else
        {
          if (v25)
          {
            v48 = HMFGetLogIdentifier();
            *buf = 138543618;
            v70 = v48;
            v71 = 2112;
            v72 = v4;
            _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve identifier from message: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
          v18 = [v4 responseHandler];
          v46 = MEMORY[0x277CCA9B8];
          v47 = 3;
        }

        v30 = [v46 hmErrorWithCode:v47];
        (v18)[2](v18, v30, 0);
LABEL_51:

        goto LABEL_14;
      }

      v6 = objc_autoreleasePoolPush();
      v7 = self;
      v8 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
      {
        goto LABEL_13;
      }

      v9 = HMFGetLogIdentifier();
      *buf = 138543618;
      v70 = v9;
      v71 = 2112;
      v72 = v4;
      v10 = "%{public}@Unable to retrieve connectivity info due to insufficient privileges for message: %@";
    }

    else
    {
      v6 = objc_autoreleasePoolPush();
      v7 = self;
      v8 = HMFGetOSLogHandle();
      if (!os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
      {
        goto LABEL_13;
      }

      v9 = HMFGetLogIdentifier();
      *buf = 138543618;
      v70 = v9;
      v71 = 2112;
      v72 = v4;
      v10 = "%{public}@Unable to retrieve connectivity info due to insufficient internal privileges for message: %@";
    }

    v11 = v8;
    v12 = OS_LOG_TYPE_INFO;
    goto LABEL_12;
  }

  v13 = objc_autoreleasePoolPush();
  v14 = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
  {
    v16 = HMFGetLogIdentifier();
    *buf = 138543618;
    v70 = v16;
    v71 = 2112;
    v72 = v4;
    _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@No response handler in _handleConnectivityInfoRequest: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v13);
LABEL_15:

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest:(id)a3
{
  v36 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 uuidForKey:@"kIdentifierKey"];
  if (v5)
  {
    v6 = [(HMDHomeManager *)self homes];
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __90__HMDHomeManager__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest___block_invoke;
    v26[3] = &unk_2797323C0;
    v7 = v5;
    v27 = v7;
    v8 = [v6 na_firstObjectPassingTest:v26];

    if (v8)
    {
      v9 = [v8 currentUser];
      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      v13 = os_log_type_enabled(v12, OS_LOG_TYPE_INFO);
      if (v9)
      {
        if (v13)
        {
          v14 = HMFGetLogIdentifier();
          *buf = 138544130;
          v29 = v14;
          v30 = 2112;
          v31 = v9;
          v32 = 2112;
          v33 = v8;
          v34 = 2112;
          v35 = v7;
          _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve pairing identity for current user (%@) in home (%@) with accessory identifier : %@", buf, 0x2Au);
        }

        objc_autoreleasePoolPop(v10);
        [v9 fetchPairingIdentityForClientWithMessage:v4];
      }

      else
      {
        if (v13)
        {
          v24 = HMFGetLogIdentifier();
          *buf = 138543618;
          v29 = v24;
          v30 = 2112;
          v31 = v8;
          _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@No current user in home: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v10);
        v9 = 0;
      }
    }

    else
    {
      v20 = objc_autoreleasePoolPush();
      v21 = self;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543618;
        v29 = v23;
        v30 = 2112;
        v31 = v7;
        _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Unable to find accessory (%@) in any home", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v20);
      v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
      [v4 respondWithError:v9];
    }

    v19 = v27;
  }

  else
  {
    v15 = objc_autoreleasePoolPush();
    v16 = self;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      *buf = 138543618;
      v29 = v18;
      v30 = 2112;
      v31 = v4;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve accessory unique identifier from message: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    v19 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
    [v4 respondWithError:v19];
  }

  v25 = *MEMORY[0x277D85DE8];
}

BOOL __90__HMDHomeManager__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest___block_invoke(uint64_t a1, void *a2)
{
  v2 = [a2 accessoryWithSPIClientIdentifier:*(a1 + 32)];
  v3 = v2 != 0;

  return v3;
}

- (void)_handlePairingIdentityRequest:(id)a3
{
  v71 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 proxyConnection];
  v6 = [v5 entitlements];

  v7 = [v4 stringForKey:@"kIdentifierKey"];
  if (v7)
  {
    v49 = v6;
    v51 = v4;
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543618;
      v68 = v11;
      v69 = 2112;
      v70 = v7;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Received request to retrieve pairing identity for identifier : %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    v50 = v9;
    v12 = [(HMDHomeManager *)v9 homes];
    v48 = [v12 countByEnumeratingWithState:&v60 objects:v66 count:16];
    if (v48)
    {
      v13 = *v61;
      v47 = *v61;
      do
      {
        for (i = 0; i != v48; ++i)
        {
          if (*v61 != v13)
          {
            objc_enumerationMutation(v12);
          }

          v15 = *(*(&v60 + 1) + 8 * i);
          v56 = 0u;
          v57 = 0u;
          v58 = 0u;
          v59 = 0u;
          v16 = [v15 accessories];
          v17 = [v16 copy];

          v18 = [v17 countByEnumeratingWithState:&v56 objects:v65 count:16];
          if (v18)
          {
            v19 = v18;
            v20 = *v57;
            while (2)
            {
              for (j = 0; j != v19; ++j)
              {
                if (*v57 != v20)
                {
                  objc_enumerationMutation(v17);
                }

                v22 = __pairingIdentityForAccessory(*(*(&v56 + 1) + 8 * j));
                v23 = [v22 identifier];
                v24 = HMFAreStringsEqualIgnoringCase();

                if (v24)
                {
                  v4 = v51;
                  [(HMDHomeManager *)v50 sendPairingIdentity:v22 includePrivateKey:(v49 >> 4) & 1 requestMessage:v51];

                  goto LABEL_38;
                }
              }

              v19 = [v17 countByEnumeratingWithState:&v56 objects:v65 count:16];
              if (v19)
              {
                continue;
              }

              break;
            }
          }

          v13 = v47;
        }

        v48 = [v12 countByEnumeratingWithState:&v60 objects:v66 count:16];
      }

      while (v48);
    }

    v54 = 0u;
    v55 = 0u;
    v52 = 0u;
    v53 = 0u;
    v25 = +[HMDUserManagementOperationManager sharedManager];
    v12 = [v25 operations];

    v26 = [v12 countByEnumeratingWithState:&v52 objects:v64 count:16];
    if (v26)
    {
      v27 = v26;
      v28 = *v53;
      while (2)
      {
        for (k = 0; k != v27; ++k)
        {
          if (*v53 != v28)
          {
            objc_enumerationMutation(v12);
          }

          v30 = [*(*(&v52 + 1) + 8 * k) accessory];
          v31 = __pairingIdentityForAccessory(v30);
          v32 = [v31 identifier];
          v33 = HMFAreStringsEqualIgnoringCase();

          if (v33)
          {
            v42 = objc_autoreleasePoolPush();
            v43 = v50;
            v44 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v44, OS_LOG_TYPE_INFO))
            {
              v45 = HMFGetLogIdentifier();
              *buf = 138543618;
              v68 = v45;
              v69 = 2112;
              v70 = v7;
              _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_INFO, "%{public}@Found accessory with pairing identifier %@ in user management operations", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v42);
            v4 = v51;
            [(HMDHomeManager *)v43 sendPairingIdentity:v31 includePrivateKey:(v49 >> 4) & 1 requestMessage:v51];

            goto LABEL_38;
          }
        }

        v27 = [v12 countByEnumeratingWithState:&v52 objects:v64 count:16];
        if (v27)
        {
          continue;
        }

        break;
      }
    }

    v34 = objc_autoreleasePoolPush();
    v35 = v50;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
    {
      v37 = HMFGetLogIdentifier();
      *buf = 138543618;
      v68 = v37;
      v69 = 2112;
      v70 = v7;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve pairing identity for accessory: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v34);
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    v4 = v51;
  }

  else
  {
    v38 = objc_autoreleasePoolPush();
    v39 = self;
    v40 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v40, OS_LOG_TYPE_INFO))
    {
      v41 = HMFGetLogIdentifier();
      *buf = 138543618;
      v68 = v41;
      v69 = 2112;
      v70 = v4;
      _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve identifier from message: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v38);
    v12 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  }

  [v4 respondWithError:v12];
LABEL_38:

  v46 = *MEMORY[0x277D85DE8];
}

- (void)sendPairingIdentity:(id)a3 includePrivateKey:(BOOL)a4 requestMessage:(id)a5
{
  v38 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a5;
  if (a4)
  {
    v10 = v8;
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v11 = v10;
    }

    else
    {
      v11 = 0;
    }

    v12 = v11;

    if (v12)
    {
      v13 = objc_alloc(MEMORY[0x277D0F8A8]);
      v14 = [v12 identifier];
      v15 = [v12 publicKey];
      v16 = [v12 privateKey];
      v17 = [v13 initWithIdentifier:v14 publicKey:v15 privateKey:v16];
    }

    else
    {
      v17 = v10;
    }
  }

  else
  {
    v17 = [v8 publicPairingIdentity];
  }

  v18 = objc_autoreleasePoolPush();
  v19 = self;
  v20 = HMFGetOSLogHandle();
  v21 = os_log_type_enabled(v20, OS_LOG_TYPE_INFO);
  if (v17)
  {
    if (v21)
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v22;
      v36 = 2112;
      v37 = v8;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Sending the pairing identity %@ to client", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v23 = encodeRootObject();
    v24 = v23;
    if (v23)
    {
      v32 = *MEMORY[0x277CCEC20];
      v33 = v23;
      v25 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v33 forKeys:&v32 count:1];
      [v9 respondWithPayload:v25];
    }

    else
    {
      v27 = objc_autoreleasePoolPush();
      v28 = v19;
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543618;
        v35 = v30;
        v36 = 2112;
        v37 = v8;
        _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_ERROR, "%{public}@Unable to encode the pairing identity : %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v27);
      v25 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
      [v9 respondWithError:v25];
    }
  }

  else
  {
    if (v21)
    {
      v26 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v26;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Unable to retrieve pairing identity", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    v24 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
    [v9 respondWithError:v24];
  }

  v31 = *MEMORY[0x277D85DE8];
}

- (BOOL)hasClientRequestedMediaAccessoryControl:(id)a3
{
  v4 = [a3 clientIdentifier];
  if (v4)
  {
    v5 = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __58__HMDHomeManager_hasClientRequestedMediaAccessoryControl___block_invoke;
    v8[3] = &unk_2797323C0;
    v9 = v4;
    v6 = [v5 na_any:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

- (void)_handleRequestRuntimeStateUpdate:(id)a3
{
  v4 = a3;
  v5 = [v4 homeManagerOptions];
  v6 = [v4 isEntitledForSPIAccess];
  if ((v5 & 0x18741) != 0)
  {
    v7 = v6;
    v8 = [(HMDHomeManager *)self hasClientRequestedMediaAccessoryControl:v4];
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __51__HMDHomeManager__handleRequestRuntimeStateUpdate___block_invoke;
    v9[3] = &unk_279732458;
    v10 = v4;
    [(HMDHomeManager *)self _getRuntimeStateUpdateForHomeManager:v7 includeMediaAccessorySessionState:v8 options:v5 includeResidentDeviceState:v7 completion:v9];
  }

  else
  {
    [v4 respondWithPayload:0];
  }
}

void __51__HMDHomeManager__handleRequestRuntimeStateUpdate___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = [*(a1 + 32) responseHandler];

  if (v3)
  {
    v4 = [*(a1 + 32) responseHandler];
    (v4)[2](v4, 0, v5);
  }
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke(id *a1, void *a2)
{
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 7);
  v5 = WeakRetained;
  if (WeakRetained)
  {
    v6 = [WeakRetained workQueue];
    v7[0] = MEMORY[0x277D85DD0];
    v7[1] = 3221225472;
    v7[2] = __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_2;
    v7[3] = &unk_279734870;
    v8 = v3;
    v9 = a1[4];
    v10 = a1[5];
    v11 = a1[6];
    dispatch_async(v6, v7);
  }
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_3(uint64_t a1)
{
  if (*(a1 + 56) == 1)
  {
    v2 = *(a1 + 32);
    v3 = [*(a1 + 40) _runtimeState];
    [v2 addEntriesFromDictionary:v3];
  }

  v4 = *(a1 + 48);
  v5 = [*(a1 + 32) copy];
  (*(v4 + 16))(v4, v5);
}

void __135__HMDHomeManager__getRuntimeStateUpdateForHomeManager_includeMediaAccessorySessionState_options_includeResidentDeviceState_completion___block_invoke_2(uint64_t a1)
{
  v2 = *(a1 + 32);
  if (v2)
  {
    [*(a1 + 40) setObject:v2 forKey:*(a1 + 48)];
  }

  v3 = *(a1 + 56);

  dispatch_group_leave(v3);
}

- (id)_runtimeState
{
  v16[4] = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self currentHomeUUID];

  if (v3)
  {
    v4 = @"kCurrentHomeUUIDKey";
    v5 = @"kCurrentHomeUUIDKey";
    v6 = [(HMDHomeManager *)self currentHomeUUID];
    v7 = [v6 UUIDString];
  }

  else
  {
    v4 = @"kNoCurrentHomeKey";
    v8 = @"kNoCurrentHomeKey";
    v7 = MEMORY[0x277CBEC38];
  }

  v15[0] = @"kResidentCapableDeviceKey";
  v9 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentCapable](self, "isResidentCapable")}];
  v16[0] = v9;
  v15[1] = @"kResidentEnabledKey";
  v10 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isResidentEnabled](self, "isResidentEnabled")}];
  v16[1] = v10;
  v15[2] = @"kAccessAllowedWhenLockedKey";
  v11 = [MEMORY[0x277CCABB0] numberWithBool:{-[HMDHomeManager isAccessAllowedWhenLocked](self, "isAccessAllowedWhenLocked")}];
  v15[3] = v4;
  v16[2] = v11;
  v16[3] = v7;
  v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v16 forKeys:v15 count:4];

  v13 = *MEMORY[0x277D85DE8];

  return v12;
}

- (void)__handleRequestFetchHomeConfiguration:(id)a3
{
  v254[1] = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 homeManagerOptions];
  v230 = [v4 isEntitledForSPIAccess];
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    [v4 clientName];
    v10 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    v11 = HMHomeManagerOptionsShortDescription();
    *buf = 138543874;
    v241 = v9;
    v242 = 2112;
    v243 = v10;
    v244 = 2112;
    v245 = v11;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Received fetch from client, %@, with options: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v6);
  v12 = MEMORY[0x277CBEB38];
  v253 = *MEMORY[0x277CD02D8];
  v13 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v5];
  v254[0] = v13;
  v14 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v254 forKeys:&v253 count:1];
  v15 = [v12 dictionaryWithDictionary:v14];

  v238 = 0;
  v16 = [(HMDHomeManager *)v7 dataSyncInProgressWithState:&v238 withMessage:v4];
  v17 = objc_autoreleasePoolPush();
  v18 = v7;
  v19 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
  {
    HMFGetLogIdentifier();
    v21 = v20 = v15;
    HMFBooleanToString();
    v22 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
    HMHomeManagerDataSyncStateToString();
    v23 = v16;
    v24 = v4;
    v26 = v25 = v5;
    *buf = 138543874;
    v241 = v21;
    v242 = 2112;
    v243 = v22;
    v244 = 2112;
    v245 = v26;
    _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Handling fetch home configuration request, data sync in progress : %@ data sync state: %@", buf, 0x20u);

    v5 = v25;
    v4 = v24;
    v16 = v23;

    v15 = v20;
  }

  objc_autoreleasePoolPop(v17);
  if (![v4 BOOLForKey:@"kCanUseCachedHomeConfigurationKey"])
  {
    v34 = [v4 numberForKey:@"kConfigGenerationCounterKey"];
    v35 = [v4 numberForKey:@"kHAPMetadataVersionKey"];
    v36 = v35;
    if (!v34 || !v35)
    {
      [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
      v38 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
      [v4 respondWithError:*&v38];
      goto LABEL_120;
    }

    if (isAppleTV() && v16)
    {
      v37 = MEMORY[0x277CCA9B8];
      [(HMDHomeManager *)v18 _statusPayloadForMessage:v4];
      v38 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
      v39 = [v37 hmErrorWithCode:77 userInfo:*&v38];
      [v4 respondWithError:v39];

LABEL_120:
      goto LABEL_121;
    }

    v226 = v5;
    v229 = v15;
    v40 = [v4 proxyConnection];
    v41 = [v40 processInfo];
    v237 = 0;
    v42 = [v41 clientIdentifierSalt:&v237];
    v38 = COERCE_DOUBLE(v237);

    if (!v42)
    {
      v55 = objc_autoreleasePoolPush();
      v56 = v18;
      v57 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v57, OS_LOG_TYPE_ERROR))
      {
        v58 = HMFGetLogIdentifier();
        *buf = 138543618;
        v241 = v58;
        v242 = 2112;
        v243 = v38;
        _os_log_impl(&dword_2531F8000, v57, OS_LOG_TYPE_ERROR, "%{public}@Cannot send out home data because client identifier salt could not be determined: %@", buf, 0x16u);

        v42 = 0;
      }

      objc_autoreleasePoolPop(v55);
      [v4 respondWithError:*&v38];
      v15 = v229;
      goto LABEL_119;
    }

    [v229 setObject:v42 forKeyedSubscript:@"kIdentifierSaltKey"];
    if ([v4 isEntitledForAssistantIdentifiers])
    {
      v43 = [(HMDHomeManager *)v18 _getAssistantHashingData];
      [v229 setObject:v43 forKeyedSubscript:*MEMORY[0x277CD0088]];
    }

    v225 = v16;
    v218 = v42;
    v219 = v38;
    v44 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{-[HMDHomeManager generationCounter](v18, "generationCounter")}];
    [v229 setObject:v44 forKeyedSubscript:@"kConfigGenerationCounterKey"];

    v45 = +[HMDHAPMetadata getSharedInstance];
    v46 = [v45 version];

    if (v46)
    {
      v47 = [v45 version];
      [v229 setObject:v47 forKeyedSubscript:@"kHAPMetadataVersionKey"];
    }

    v48 = [(HMDHomeManager *)v18 _statusPayloadForMessage:v4];
    [v229 addEntriesFromDictionary:v48];

    v224 = v34;
    v49 = [v34 unsignedIntegerValue];
    v50 = [(HMDHomeManager *)v18 generationCounter];
    v222 = v36;
    v51 = [v36 unsignedIntegerValue];
    v223 = v45;
    v52 = [v45 version];
    v53 = [v52 unsignedIntegerValue];

    if (v230)
    {
      v54 = ![(HMDHomeManager *)v18 cacheUseAllowed];
    }

    else
    {
      v54 = 0;
    }

    v59 = [(HMDHomeManager *)v18 hasClientRequestedMediaAccessoryControl:v4];
    v228 = v18;
    v221 = v54;
    if (v54)
    {
      v217 = v59;
      v60 = objc_autoreleasePoolPush();
      v61 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v61, OS_LOG_TYPE_INFO))
      {
        v62 = HMFGetLogIdentifier();
        HMFBooleanToString();
        v63 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
        v64 = HMFBooleanToString();
        *buf = 138543874;
        v241 = v62;
        v242 = 2112;
        v243 = v63;
        v244 = 2112;
        v245 = v64;
        _os_log_impl(&dword_2531F8000, v61, OS_LOG_TYPE_INFO, "%{public}@Forcing SPI entitled client to not use cached home configuration homeCounterMatch %@  metadataVersionMatch %@", buf, 0x20u);
      }

      v216 = v51 != v53;

      objc_autoreleasePoolPop(v60);
      v65 = 0x277CCA000;
      v66 = v226;
      v67 = v225;
    }

    else
    {
      v66 = v226;
      if (v49 == v50 && v51 == v53)
      {
        v79 = objc_autoreleasePoolPush();
        v80 = v18;
        v81 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v81, OS_LOG_TYPE_DEFAULT))
        {
          v82 = HMFGetLogIdentifier();
          v83 = COERCE_DOUBLE([(HMDHomeManager *)v80 generationCounter]);
          v84 = [v223 version];
          [v4 clientIdentifier];
          v85 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
          *buf = 138544130;
          v241 = v82;
          v242 = 2048;
          v243 = v83;
          v244 = 2112;
          v245 = v84;
          v246 = 2112;
          v247 = v85;
          _os_log_impl(&dword_2531F8000, v81, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager generation counter %lu/metadata version %@ matches the client(%@)", buf, 0x2Au);
        }

        objc_autoreleasePoolPop(v79);
        v86 = 1;
        v65 = 0x277CCA000;
        v15 = v229;
        goto LABEL_102;
      }

      v216 = v51 != v53;
      v217 = v59;
      v65 = 0x277CCA000;
      v67 = v225;
      if (v49 == v50)
      {
LABEL_92:
        v86 = v217 & v66 & !v67;
        v15 = v229;
        if ((v216 | v221))
        {
          v161 = HMIsHAPMetadataNeededForHMHomeManagerOptions();
          v162 = objc_autoreleasePoolPush();
          v163 = v228;
          v164 = HMFGetOSLogHandle();
          v165 = os_log_type_enabled(v164, OS_LOG_TYPE_DEFAULT);
          if (v161)
          {
            v227 = v86;
            if (v165)
            {
              v166 = HMFGetLogIdentifier();
              [v223 version];
              v167 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
              *buf = 138543874;
              v241 = v166;
              v242 = 2112;
              v243 = v167;
              v244 = 2112;
              v245 = v222;
              _os_log_impl(&dword_2531F8000, v164, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager HAP metadata version %@ does not match client's value of %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v162);
            [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
            v169 = v168;
            v170 = +[HMDHAPMetadata getSharedInstance];
            v171 = [v170 xpcData:{objc_msgSend(v4, "isEntitledForSPIAccess")}];
            [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
            v173 = v172;
            v174 = objc_autoreleasePoolPush();
            v175 = v163;
            v176 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v176, OS_LOG_TYPE_DEFAULT))
            {
              v177 = HMFGetLogIdentifier();
              *buf = 138543618;
              v241 = v177;
              v242 = 2048;
              v243 = v173 - v169;
              _os_log_impl(&dword_2531F8000, v176, OS_LOG_TYPE_DEFAULT, "%{public}@Time to encode metadata: %.4f s", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v174);
            [v229 setObject:v171 forKeyedSubscript:@"kHAPMetadataDataKey"];
            v178 = v175;
            v15 = v229;
            [(HMDHomeManager *)v178 setCacheUseAllowed:0];

            v86 = v227;
          }

          else
          {
            if (v165)
            {
              v179 = HMFGetLogIdentifier();
              HMHomeManagerOptionsToString();
              v180 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
              [v4 clientName];
              v182 = v181 = v86;
              *buf = 138543874;
              v241 = v179;
              v242 = 2112;
              v243 = v180;
              v244 = 2112;
              v245 = v182;
              _os_log_impl(&dword_2531F8000, v164, OS_LOG_TYPE_DEFAULT, "%{public}@Client has not requested access to HAP accessories (options %@) - not sending metadata to [%@]", buf, 0x20u);

              v86 = v181;
            }

            objc_autoreleasePoolPop(v162);
            v65 = 0x277CCA000uLL;
          }
        }

LABEL_102:
        if (v230)
        {
          v183 = @"com.apple.homekit-entitledclient.identifer";
          v184 = [(HMDHomeManager *)v228 _runtimeState];
          [v15 addEntriesFromDictionary:v184];

          [v15 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:@"kCanCacheHomeConfigurationKey"];
          v185 = [*(v65 + 2992) numberWithBool:{-[HMDHomeManager cacheUseAllowed](v228, "cacheUseAllowed")}];
          [v15 setObject:v185 forKeyedSubscript:@"kCanUseCachedHomeConfigurationKey"];

          if (![(HMDHomeManager *)v228 cacheUseAllowed])
          {
            [(HMDHomeManager *)v228 setCacheUseAllowed:1];
          }

          v186 = *(v65 + 2992);
          v187 = [(HMDHomeManager *)v228 keyTransferAgent];
          v188 = [v186 numberWithUnsignedInteger:{objc_msgSend(v187, "residentProvisioningStatus")}];
          [v15 setObject:v188 forKeyedSubscript:@"kProvisioningStatusKey"];

          if (v86)
          {
            [v15 setObject:MEMORY[0x277CBEC38] forKey:*MEMORY[0x277CD0350]];
          }

          v189 = @"com.apple.homekit-entitledclient.identifer";
        }

        else
        {
          v189 = [v4 clientIdentifier];
        }

        v190 = [(HMDHomeManager *)v228 appData];
        v191 = [v190 applicationDataForIdentifier:v189];
        [v15 setObject:v191 forKeyedSubscript:@"kAppDataInformationKey"];

        v192 = [*(v65 + 2992) numberWithBool:0];
        [v15 setObject:v192 forKeyedSubscript:*MEMORY[0x277CD0258]];

        v193 = [(HMDHomeManager *)v228 hh2FrameworkSwitch];

        if (v193)
        {
          v194 = [(HMDHomeManager *)v228 hh2FrameworkSwitch];
          v195 = [v194 checkExistenceOfHH2SentinelZone];

          v196 = [*(v65 + 2992) numberWithBool:v195];
          [v15 setObject:v196 forKeyedSubscript:*MEMORY[0x277CD03E8]];
        }

        v197 = [*(v65 + 2992) numberWithBool:{-[HMDHomeManager isHH2MigrationInProgress](v228, "isHH2MigrationInProgress")}];
        [v15 setObject:v197 forKeyedSubscript:*MEMORY[0x277CD0220]];

        v198 = +[HMDHH2MigratorRecord lastMigrationFailure];
        [v15 setObject:v198 forKeyedSubscript:*MEMORY[0x277CD0218]];

        if (_os_feature_enabled_impl())
        {
          v199 = [(HMDHomeManager *)v228 idsServerBag];
          v200 = [v199 isHH2ManualMigrationEnabled];
        }

        else
        {
          v200 = 0;
        }

        v201 = [MEMORY[0x277D0F8D0] sharedPreferences];
        v202 = [v201 preferenceForKey:@"hh2ManualMigrationAvailableOverride"];

        v203 = [v202 value];

        if (v203)
        {
          block[0] = MEMORY[0x277D85DD0];
          block[1] = 3221225472;
          block[2] = __56__HMDHomeManager___handleRequestFetchHomeConfiguration___block_invoke;
          block[3] = &unk_2797359B0;
          block[4] = v228;
          v204 = v202;
          v232 = v204;
          if (__handleRequestFetchHomeConfiguration__onceToken != -1)
          {
            dispatch_once(&__handleRequestFetchHomeConfiguration__onceToken, block);
          }

          v200 = [v204 BOOLValue];
        }

        v205 = [*(v65 + 2992) numberWithBool:v200];
        [v15 setObject:v205 forKeyedSubscript:*MEMORY[0x277CD0208]];

        v206 = [(HMDHomeManager *)v228 idsServerBag];
        v207 = [v206 homeSafetySecurityEnabled];

        v208 = [*(v65 + 2992) numberWithBool:v207];
        [v15 setObject:v208 forKeyedSubscript:*MEMORY[0x277CD0248]];

        v209 = [*(v65 + 2992) numberWithBool:{-[HMDHomeManager shouldPostHH2UpgradeRequired](v228, "shouldPostHH2UpgradeRequired")}];
        [v15 setObject:v209 forKeyedSubscript:*MEMORY[0x277CD0380]];

        v210 = [v15 copy];
        [v4 respondWithPayload:v210];

        v34 = v224;
        v36 = v222;
        v42 = v218;
        v38 = v219;
LABEL_119:

        goto LABEL_120;
      }
    }

    v68 = objc_autoreleasePoolPush();
    v69 = v228;
    v70 = HMFGetOSLogHandle();
    v220 = v69;
    if (os_log_type_enabled(v70, OS_LOG_TYPE_DEFAULT))
    {
      v71 = HMFGetLogIdentifier();
      v72 = COERCE_DOUBLE([(HMDHomeManager *)v220 generationCounter]);
      v73 = [v4 clientIdentifier];
      v74 = COERCE_DOUBLE([v224 unsignedIntegerValue]);
      *buf = 138544386;
      v75 = "";
      v241 = v71;
      if (v221)
      {
        v75 = " (forced to update anyways)";
      }

      v242 = 2048;
      v243 = v72;
      v66 = v226;
      v244 = 2112;
      v245 = v73;
      v246 = 2048;
      v247 = v74;
      v248 = 2080;
      v249 = v75;
      _os_log_impl(&dword_2531F8000, v70, OS_LOG_TYPE_DEFAULT, "%{public}@Home manager generation counter %lu does not match client's (%@) value of %lu%s.", buf, 0x34u);

      v67 = v225;
      v69 = v220;
    }

    objc_autoreleasePoolPop(v68);
    if ((*&v66 & 0x19FCDLL) == 0)
    {
      if ((v66 & 0x10) != 0)
      {
        v92 = [(HMDHomeManager *)v69 _accessoryOfCurrentDevice];
        [v92 home];
        v93 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());

        if (v93 != 0.0)
        {
          v94 = objc_autoreleasePoolPush();
          v95 = v220;
          v96 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v96, OS_LOG_TYPE_INFO))
          {
            v97 = HMFGetLogIdentifier();
            *buf = 138543618;
            v241 = v97;
            v242 = 2112;
            v243 = v93;
            _os_log_impl(&dword_2531F8000, v96, OS_LOG_TYPE_INFO, "%{public}@Encoding home containing current device's accessory: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v94);
          v239 = v93;
          v98 = [MEMORY[0x277CBEA60] arrayWithObjects:&v239 count:1];
          v99 = encodeRootObjectForIncomingXPCMessage(v98, v4);
          [v229 setObject:v99 forKeyedSubscript:@"kHomeDataKey"];

          if (v230)
          {
            v100 = [(HMDHomeManager *)v95 currentHomeUUID];
            v101 = [*&v93 uuid];
            v102 = [v100 isEqual:v101];

            if (v102)
            {
              v103 = [(HMDHomeManager *)v95 currentHomeUUID];
              v104 = [v103 UUIDString];
              [v229 setObject:v104 forKeyedSubscript:@"kCurrentHomeUUIDKey"];
            }
          }
        }

        v67 = v225;
      }

      else
      {
        v87 = objc_autoreleasePoolPush();
        v88 = v69;
        v89 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v89, OS_LOG_TYPE_DEFAULT))
        {
          v90 = HMFGetLogIdentifier();
          HMHomeManagerOptionsToString();
          v91 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
          *buf = 138543618;
          v241 = v90;
          v242 = 2112;
          v243 = v91;
          _os_log_impl(&dword_2531F8000, v89, OS_LOG_TYPE_DEFAULT, "%{public}@Not sending home data as the client has not requested it in their options: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v87);
      }

      goto LABEL_91;
    }

    v76 = [(HMDHomeManager *)v69 homes];
    v77 = v229;
    if (!isAppleTV() || ([v4 isEntitledForSPIAccess] & 1) != 0)
    {
      v78 = v76;
      goto LABEL_75;
    }

    v105 = [(HMDHomeManager *)v69 currentHomeUUID];
    v106 = v105;
    if (v105)
    {
      v107 = v105;
    }

    else
    {
      v107 = [(HMDHomeManager *)v69 lastCurrentHomeUUID];
    }

    v108 = v69;
    v109 = v107;

    v110 = MEMORY[0x277CBEB18];
    v111 = [(HMDHomeManager *)v108 homes];
    v78 = [v110 arrayWithCapacity:{objc_msgSend(v111, "count")}];

    v235 = 0u;
    v236 = 0u;
    v233 = 0u;
    v234 = 0u;
    v112 = v76;
    v113 = [v112 countByEnumeratingWithState:&v233 objects:v252 count:16];
    if (!v113)
    {
LABEL_74:

      v77 = v229;
      v66 = v226;
      v69 = v220;
LABEL_75:
      v121 = [(HMDHomeManager *)v69 filterHomes:v78 isSPIEntitled:v230];

      [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
      v123 = v122;
      v215 = v121;
      v124 = encodeRootObjectForIncomingXPCMessage(v121, v4);
      v125 = [(HMDHomeManager *)v69 incomingInvitations];
      v126 = [v125 copy];
      v127 = encodeRootObjectForIncomingXPCMessage(v126, 0);

      [MEMORY[0x277CBEAA8] timeIntervalSinceReferenceDate];
      v129 = v128;
      v130 = objc_autoreleasePoolPush();
      v131 = v69;
      v132 = HMFGetOSLogHandle();
      v214 = v124;
      if (os_log_type_enabled(v132, OS_LOG_TYPE_DEFAULT))
      {
        v133 = HMFGetLogIdentifier();
        v213 = v130;
        [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v215, "count")}];
        v134 = COERCE_DOUBLE(objc_claimAutoreleasedReturnValue());
        v135 = MEMORY[0x277CCABB0];
        v136 = [(HMDHomeManager *)v131 homes];
        v137 = [v135 numberWithUnsignedInteger:{objc_msgSend(v136, "count")}];
        v138 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v127, "length") + objc_msgSend(v214, "length")}];
        v139 = [v4 clientIdentifier];
        *buf = 138544642;
        v241 = v133;
        v212 = v127;
        v140 = v133;
        v242 = 2112;
        v243 = v134;
        v244 = 2112;
        v245 = v137;
        v246 = 2048;
        v247 = v129 - v123;
        v248 = 2112;
        v249 = v138;
        v250 = 2112;
        v251 = v139;
        _os_log_impl(&dword_2531F8000, v132, OS_LOG_TYPE_DEFAULT, "%{public}@Number of homes - %@ / %@, Time to encode homes: %.4f s, Size: %@ bytes, client: %@", buf, 0x3Eu);

        v130 = v213;
        v66 = v226;

        v77 = v229;
        v124 = v214;

        v127 = v212;
      }

      objc_autoreleasePoolPop(v130);
      [v77 setObject:v124 forKeyedSubscript:@"kHomeDataKey"];
      [v77 setObject:v127 forKeyedSubscript:@"kIncomingHomeInvitationsKey"];
      v141 = [(HMDHomeManager *)v131 lastRemovedCurrentAccessoryUUID];
      v142 = [v141 UUIDString];
      [v77 setObject:v142 forKeyedSubscript:*MEMORY[0x277CD0288]];

      v143 = [(HMDHomeManager *)v131 userDefaults];
      v144 = [v143 objectForKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];

      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v145 = v144;
      }

      else
      {
        v145 = 0;
      }

      v146 = v145;

      v147 = [v146 allKeys];

      [v77 setObject:v147 forKeyedSubscript:*MEMORY[0x277CD0378]];
      v148 = [(HMDHomeManager *)v131 primaryHomeUUID];

      v65 = 0x277CCA000uLL;
      v67 = v225;
      v149 = v127;
      v150 = v215;
      if (!v148)
      {
        goto LABEL_86;
      }

      v151 = [(HMDHomeManager *)v131 primaryHomeUUID];
      v152 = [v215 hmf_firstObjectWithUUID:v151];

      if (v152)
      {
        v153 = v77;
        v154 = [(HMDHomeManager *)v131 primaryHomeUUID];
      }

      else
      {
        v149 = v127;
        if (![v215 count])
        {
LABEL_86:
          if (v230)
          {
            v157 = [(HMDHomeManager *)v131 currentHomeUUID];

            if (v157)
            {
              v158 = [(HMDHomeManager *)v131 currentHomeUUID];
              v159 = [v158 UUIDString];
              [v77 setObject:v159 forKeyedSubscript:@"kCurrentHomeUUIDKey"];

              v150 = v215;
            }

            v160 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v150, "count")}];
            [v77 setObject:v160 forKeyedSubscript:@"kHomeCountKey"];
          }

LABEL_91:
          [(HMDHomeManager *)v220 setCacheUseAllowed:0];
          goto LABEL_92;
        }

        v153 = v77;
        v152 = [v215 firstObject];
        v154 = [v152 uuid];
      }

      v155 = v154;
      v156 = [v154 UUIDString];
      [v153 setObject:v156 forKeyedSubscript:@"kPrimaryHomeUUIDKey"];

      v77 = v153;
      v149 = v127;
      v150 = v215;
      goto LABEL_86;
    }

    v114 = v113;
    v115 = *v234;
LABEL_63:
    v116 = 0;
    while (1)
    {
      if (*v234 != v115)
      {
        objc_enumerationMutation(v112);
      }

      v117 = *(*(&v233 + 1) + 8 * v116);
      if (!v109)
      {
        break;
      }

      v118 = [v117 uuid];
      v119 = [v118 isEqual:v109];

      if (v119)
      {
        goto LABEL_68;
      }

LABEL_69:
      if (v114 == ++v116)
      {
        v120 = [v112 countByEnumeratingWithState:&v233 objects:v252 count:16];
        v114 = v120;
        if (!v120)
        {
          goto LABEL_74;
        }

        goto LABEL_63;
      }
    }

    if (![v117 isOwnerUser])
    {
      goto LABEL_69;
    }

LABEL_68:
    [v78 addObject:v117];
    goto LABEL_69;
  }

  v27 = [v4 isEntitledForSPIAccess];
  if (v27 && v5 != -1)
  {
    v28 = objc_autoreleasePoolPush();
    v29 = v18;
    v30 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
    {
      HMFGetLogIdentifier();
      v32 = v31 = v15;
      *buf = 138543362;
      v241 = v32;
      _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Client has specified partial options, not using cache", buf, 0xCu);

      v15 = v31;
    }

    objc_autoreleasePoolPop(v28);
    v27 = 0;
  }

  v33 = [MEMORY[0x277CCABB0] numberWithBool:v27];
  [v15 setObject:v33 forKeyedSubscript:@"kCanUseCachedHomeConfigurationKey"];

  v34 = [v15 copy];
  [v4 respondWithPayload:v34];
LABEL_121:

  v211 = *MEMORY[0x277D85DE8];
}

void __56__HMDHomeManager___handleRequestFetchHomeConfiguration___block_invoke(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v6 = [*(a1 + 40) BOOLValue];
    v8 = 138543618;
    v9 = v5;
    v10 = 1024;
    v11 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@hh2ManualMigrationAvailableOverride detected. Setting to %d", &v8, 0x12u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = *MEMORY[0x277D85DE8];
}

- (void)_handleRequestFetchHomeConfiguration:(id)a3
{
  v6 = a3;
  v4 = objc_autoreleasePoolPush();
  v5 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"homed.xpc.fetch.homeConfiguration."];
  [(HMDHomeManager *)self __handleRequestFetchHomeConfiguration:v6];

  objc_autoreleasePoolPop(v4);
}

- (id)_appleMediaAccessoryOfCurrentDevice
{
  v20 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  v4 = v3;
  if (v3)
  {
    v5 = v3;
    objc_opt_class();
    v6 = objc_opt_isKindOfClass() & 1;
    if (v6)
    {
      v7 = v5;
    }

    else
    {
      v7 = 0;
    }

    v8 = v7;

    if (v6)
    {
      v9 = v5;
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = HMFGetLogIdentifier();
        v16 = 138543618;
        v17 = v13;
        v18 = 2112;
        v19 = v5;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Failed to get apple media accessory for current accessory: %@", &v16, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v9 = 0;
    }
  }

  else
  {
    v9 = 0;
  }

  v14 = *MEMORY[0x277D85DE8];

  return v9;
}

- (id)_accessoryOfCurrentDevice
{
  v27 = *MEMORY[0x277D85DE8];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 countByEnumeratingWithState:&v21 objects:v26 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v22;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v22 != v5)
        {
          objc_enumerationMutation(v2);
        }

        v7 = *(*(&v21 + 1) + 8 * i);
        v17 = 0u;
        v18 = 0u;
        v19 = 0u;
        v20 = 0u;
        v8 = [v7 accessories];
        v9 = [v8 countByEnumeratingWithState:&v17 objects:v25 count:16];
        if (v9)
        {
          v10 = v9;
          v11 = *v18;
          while (2)
          {
            for (j = 0; j != v10; ++j)
            {
              if (*v18 != v11)
              {
                objc_enumerationMutation(v8);
              }

              v13 = *(*(&v17 + 1) + 8 * j);
              if ([v13 isCurrentAccessory])
              {
                v14 = v13;

                goto LABEL_19;
              }
            }

            v10 = [v8 countByEnumeratingWithState:&v17 objects:v25 count:16];
            if (v10)
            {
              continue;
            }

            break;
          }
        }
      }

      v4 = [v2 countByEnumeratingWithState:&v21 objects:v26 count:16];
      v14 = 0;
    }

    while (v4);
  }

  else
  {
    v14 = 0;
  }

LABEL_19:

  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)filterHomes:(id)a3 isSPIEntitled:(BOOL)a4
{
  v4 = a4;
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __44__HMDHomeManager_filterHomes_isSPIEntitled___block_invoke;
  v10[3] = &unk_2797323C0;
  v10[4] = self;
  v5 = [a3 na_filter:v10];
  v6 = v5;
  if (v4)
  {
    v7 = v5;
  }

  else
  {
    v7 = [v5 na_filter:&__block_literal_global_1162];
  }

  v8 = v7;

  return v8;
}

BOOL __44__HMDHomeManager_filterHomes_isSPIEntitled___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [v3 currentUser];

  if (!v4)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 32);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v11 = 138543618;
      v12 = v8;
      v13 = 2112;
      v14 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@There is no current user for : %@", &v11, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  v9 = *MEMORY[0x277D85DE8];
  return v4 != 0;
}

- (id)homesToSendForNonSPIClients
{
  v3 = [MEMORY[0x277CBEB18] array];
  v4 = [(HMDHomeManager *)self homes];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __45__HMDHomeManager_homesToSendForNonSPIClients__block_invoke;
  v8[3] = &unk_279732398;
  v9 = v3;
  v5 = v3;
  [v4 hmf_enumerateWithAutoreleasePoolUsingBlock:v8];

  v6 = [v5 copy];

  return v6;
}

void __45__HMDHomeManager_homesToSendForNonSPIClients__block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  if ([v3 isAccessToHomeAllowed])
  {
    [*(a1 + 32) addObject:v3];
  }
}

- (void)_retryCloudOperationWithName:(id)a3 completionHandler:(id)a4
{
  v35 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self cloudOperationRetryCount];
  v9 = maxCloudOperationRetries;
  if (maxCloudOperationRetries >= 7)
  {
    v9 = 7;
  }

  if (v8 >= v9)
  {
    v14 = [(HMDHomeManager *)self cloudOperationRetryTimer];

    if (v14)
    {
      v15 = objc_autoreleasePoolPush();
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
      {
        v17 = HMFGetLogIdentifier();
        *buf = 138543362;
        v30 = v17;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@We have an outstanding max retry reset timer, ignoring this reachability change", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v15);
    }

    else
    {
      v18 = +[HMDDeviceCapabilities deviceCapabilities];
      v19 = [v18 supportsKeychainSync];

      v20 = objc_autoreleasePoolPush();
      v21 = HMFGetOSLogHandle();
      v22 = os_log_type_enabled(v21, OS_LOG_TYPE_INFO);
      if (v19)
      {
        if (v22)
        {
          v23 = HMFGetLogIdentifier();
          *buf = 138543618;
          v30 = v23;
          v31 = 2112;
          v32 = v6;
          _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Exceeded the total number of attempts for cloud operation: %@, kicking counter reset-timer", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v20);
        [(HMDHomeManager *)self _startTimerToResetCloudOperationRetryCounter];
      }

      else
      {
        if (v22)
        {
          v24 = HMFGetLogIdentifier();
          *buf = 138543618;
          v30 = v24;
          v31 = 2112;
          v32 = v6;
          _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Exceeded the total number of attempts for cloud operation: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v20);
        [(HMDHomeManager *)self setBackOffOperationInProgress:0];
        [(HMDHomeManager *)self _resetCloudOperationRetryCounters];
      }
    }
  }

  else if (![(HMDHomeManager *)self backOffOperationInProgress])
  {
    v10 = _retryCloudOperationWithName_completionHandler__retryIntervalInSeconds[[(HMDHomeManager *)self cloudOperationRetryCount]];
    v11 = objc_autoreleasePoolPush();
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543874;
      v30 = v13;
      v31 = 2112;
      v32 = v6;
      v33 = 2048;
      v34 = v10;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Going to re-try cloud operation: %@ in %ld secs", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v11);
    [(HMDHomeManager *)self setBackOffOperationInProgress:1];
    objc_initWeak(buf, self);
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __65__HMDHomeManager__retryCloudOperationWithName_completionHandler___block_invoke;
    v26[3] = &unk_279731EB8;
    objc_copyWeak(&v28, buf);
    v27 = v7;
    [(HMDHomeManager *)self _startCloudOperationRetryWithTimeout:v10 completionHandler:v26];

    objc_destroyWeak(&v28);
    objc_destroyWeak(buf);
  }

  v25 = *MEMORY[0x277D85DE8];
}

void __65__HMDHomeManager__retryCloudOperationWithName_completionHandler___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    [WeakRetained _stopCloudOperationRetryTimer];
  }

  (*(*(a1 + 32) + 16))();
}

- (void)_startTimerToResetCloudOperationRetryCounter
{
  objc_initWeak(&location, self);
  v3[0] = MEMORY[0x277D85DD0];
  v3[1] = 3221225472;
  v3[2] = __62__HMDHomeManager__startTimerToResetCloudOperationRetryCounter__block_invoke;
  v3[3] = &unk_279732FD8;
  objc_copyWeak(&v4, &location);
  [(HMDHomeManager *)self _startCloudOperationRetryWithTimeout:7200 completionHandler:v3];
  objc_destroyWeak(&v4);
  objc_destroyWeak(&location);
}

void __62__HMDHomeManager__startTimerToResetCloudOperationRetryCounter__block_invoke(uint64_t a1)
{
  v13 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained setBackOffOperationInProgress:0];
    [v2 _resetCloudOperationRetryCounters];
    v3 = objc_autoreleasePoolPush();
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      *buf = 138543362;
      v12 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Resetting cloud operation re-try counter", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    v6 = [v2 cloudReachabilityMonitor];
    v7 = [v6 isReachable];

    if (v7)
    {
      v9[0] = MEMORY[0x277D85DD0];
      v9[1] = 3221225472;
      v9[2] = __62__HMDHomeManager__startTimerToResetCloudOperationRetryCounter__block_invoke_1159;
      v9[3] = &unk_279735D00;
      v10 = v2;
      [v10 _retryCloudOperationWithName:@"push data to cloud" completionHandler:v9];
    }
  }

  v8 = *MEMORY[0x277D85DE8];
}

uint64_t __62__HMDHomeManager__startTimerToResetCloudOperationRetryCounter__block_invoke_1159(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v4;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Network connection is available schedule push if there are pending transactions", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 32) _determineLocalChangesAndSchedulePush];
  v6 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_notifyMetricsManagerOfConfigurationChange
{
  v2 = [(HMDHomeManager *)self metricsManager];
  [v2 homeKitConfigurationChanged];
}

- (void)_registerForMessages
{
  v369 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v368 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEBUG, "%{public}@Registering for contact store change notifications", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [(HMDHomeManager *)v4 notificationCenter];
  [v7 addObserver:v4 selector:sel_handleContactStoreChanged_ name:*MEMORY[0x277CBD140] object:0];

  v8 = objc_autoreleasePoolPush();
  v9 = v4;
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_DEBUG))
  {
    v11 = HMFGetLogIdentifier();
    *buf = 138543362;
    v368 = v11;
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEBUG, "%{public}@Registering remote account message filter", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v8);
  v12 = [HMDRemoteAccountMessageFilter alloc];
  v13 = [(HMDHomeManager *)v9 messageDestination];
  v366[0] = @"kAccessHomeInviteRequestKey";
  v366[1] = @"kHomeDataSyncRequestKey";
  v366[2] = @"kHomeDataFragmentedSyncRequestKey";
  v366[3] = @"kUpdateHomeInvitationStateInternalRequestKey";
  v366[4] = @"kUserRemovedRequestKey";
  v366[5] = @"kUserResetHomeConfigRequestKey";
  v366[6] = @"kElectDeviceForIDSSessionKey";
  v14 = [MEMORY[0x277CBEA60] arrayWithObjects:v366 count:7];
  v15 = [(HMDRemoteAccountMessageFilter *)v12 initWithTarget:v13 allowedMessages:v14];

  v16 = [(HMDHomeManager *)v9 msgFilterChain];
  v296 = v15;
  [v16 addMessageFilter:v15];

  v17 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v17 setRequiresSecureMessage:0];
  [v17 setRequiresAccountMessage:0];
  [v17 setTransportRestriction:-1];
  v295 = v17;
  v297 = [v17 copy];
  v18 = [(HMDHomeManager *)v9 messageDispatcher];
  v19 = *MEMORY[0x277CD01D8];
  v20 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v365[0] = v20;
  v21 = [HMDXPCBackgroundMessagePolicy policyWithEntitlementRequirement:0];
  v365[1] = v21;
  v292 = *MEMORY[0x277CD06C8];
  v22 = *MEMORY[0x277CD06C8];
  v293 = *MEMORY[0x277CCFE40];
  v364[0] = *MEMORY[0x277CCFE40];
  v364[1] = v22;
  v23 = [MEMORY[0x277CBEA60] arrayWithObjects:v364 count:2];
  v24 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v23];
  v365[2] = v24;
  v25 = [MEMORY[0x277CBEA60] arrayWithObjects:v365 count:3];
  [v18 registerForMessage:v19 receiver:v9 policies:v25 selector:sel__handleRequestFetchHomeConfiguration_];

  v26 = [(HMDHomeManager *)v9 messageDispatcher];
  v27 = *MEMORY[0x277CD2508];
  v28 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
  v363[0] = v28;
  v29 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v363[1] = v29;
  v30 = [MEMORY[0x277CBEA60] arrayWithObjects:v363 count:2];
  [v26 registerForMessage:v27 receiver:v9 policies:v30 selector:sel__handleRequestRemoveHome_];

  v31 = [(HMDHomeManager *)v9 messageDispatcher];
  v32 = *MEMORY[0x277CD2080];
  v33 = [HMDConfigurationMessagePolicy policyWithOperationTypes:1];
  v362[0] = v33;
  v34 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v362[1] = v34;
  v35 = [MEMORY[0x277CBEA60] arrayWithObjects:v362 count:2];
  [v31 registerForMessage:v32 receiver:v9 policies:v35 selector:sel__handleRequestAddHome_];

  v36 = [(HMDHomeManager *)v9 messageDispatcher];
  v37 = *MEMORY[0x277CD2670];
  v38 = [HMDConfigurationMessagePolicy policyWithOperationTypes:2];
  v361[0] = v38;
  v39 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v361[1] = v39;
  v40 = [MEMORY[0x277CBEA60] arrayWithObjects:v361 count:2];
  [v36 registerForMessage:v37 receiver:v9 policies:v40 selector:sel__handleRequestSetPrimaryHome_];

  v41 = [(HMDHomeManager *)v9 messageDispatcher];
  v42 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v360 = v42;
  v43 = [MEMORY[0x277CBEA60] arrayWithObjects:&v360 count:1];
  [v41 registerForMessage:@"kQueryHomeKitUsageStateRequestKey" receiver:v9 policies:v43 selector:sel__handleRequestIsUserUsingHomeKit_];

  v44 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v44 setRequiresSecureMessage:0];
  [v44 setAllowsAnonymousMessage:1];
  v45 = [v44 copy];
  v46 = [(HMDHomeManager *)v9 messageDispatcher];
  v294 = v45;
  v359 = v45;
  v47 = [MEMORY[0x277CBEA60] arrayWithObjects:&v359 count:1];
  [v46 registerForMessage:@"kElectDeviceForIDSSessionKey" receiver:v9 policies:v47 selector:sel__handleElectDeviceForIDSSession_];

  v48 = +[HMDDeviceCapabilities deviceCapabilities];
  LODWORD(v47) = [v48 supportsHomeInvitation];

  if (v47)
  {
    v49 = [(HMDHomeManager *)v9 messageDispatcher];
    v358 = v297;
    v50 = [MEMORY[0x277CBEA60] arrayWithObjects:&v358 count:1];
    [v49 registerForMessage:@"kAccessHomeInviteRequestKey" receiver:v9 policies:v50 selector:sel__handleAccessHomeInvite_];
  }

  if (isAppleTV())
  {
    v51 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v51 setRequiresSecureMessage:0];
    [v51 setRequiresAccountMessage:1];
    [v51 setTransportRestriction:-1];
    v52 = [v51 copy];
    v53 = [(HMDHomeManager *)v9 messageDispatcher];
    v357 = v52;
    v54 = [MEMORY[0x277CBEA60] arrayWithObjects:&v357 count:1];
    [v53 registerForMessage:@"kAddRemoteAccessRequestKey" receiver:v9 policies:v54 selector:sel__handleAddRemoteAccessRequest_];

    v55 = [(HMDHomeManager *)v9 messageDispatcher];
    v356 = v52;
    v56 = [MEMORY[0x277CBEA60] arrayWithObjects:&v356 count:1];
    [v55 registerForMessage:@"kDoYouSeeUnpairedAccessoriesKey" receiver:v9 policies:v56 selector:sel__handleDoYouSeeUnpairedAccessories_];

    v57 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v57 setAllowsAnonymousMessage:1];
    v58 = [v57 copy];
    v59 = [(HMDHomeManager *)v9 messageDispatcher];
    v355 = v58;
    v60 = [MEMORY[0x277CBEA60] arrayWithObjects:&v355 count:1];
    [v59 registerForMessage:@"kAreYouAtHomeRequestKey" receiver:v9 policies:v60 selector:sel__handleAreYouAtHome_];
  }

  v61 = +[HMDDeviceCapabilities deviceCapabilities];
  v62 = [v61 isResidentCapable];

  if (v62)
  {
    v63 = [(HMDHomeManager *)v9 messageDispatcher];
    v64 = [HMDConfigurationMessagePolicy policyWithOperationTypes:7];
    v354[0] = v64;
    v65 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v354[1] = v65;
    v66 = [MEMORY[0x277CBEA60] arrayWithObjects:v354 count:2];
    [v63 registerForMessage:@"kUpdateResidentEnabledOnThisDeviceRequestKey" receiver:v9 policies:v66 selector:sel__handleEnableResidentForThisDeviceRequest_];
  }

  if (+[HMDDeviceCapabilities supportsDismissUserNotificationAndDialog])
  {
    v67 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v67 setRequiresSecureMessage:0];
    [v67 setRequiresAccountMessage:1];
    [v67 setTransportRestriction:-1];
    v68 = [v67 copy];
    v69 = [(HMDHomeManager *)v9 messageDispatcher];
    v353 = v68;
    v70 = [MEMORY[0x277CBEA60] arrayWithObjects:&v353 count:1];
    [v69 registerForMessage:@"kDismissBulletinInternalRequestKey" receiver:v9 policies:v70 selector:sel__handleDismissBulletinRequest_];

    v71 = [(HMDHomeManager *)v9 messageDispatcher];
    v352 = v68;
    v72 = [MEMORY[0x277CBEA60] arrayWithObjects:&v352 count:1];
    [v71 registerForMessage:@"kDismissDialogInternalRequestKey" receiver:v9 policies:v72 selector:sel__handleDismissDialogRequest_];
  }

  if (isiOSDevice() || isWatch())
  {
    v73 = [(HMDHomeManager *)v9 messageDispatcher];
    v74 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v351 = v74;
    v75 = [MEMORY[0x277CBEA60] arrayWithObjects:&v351 count:1];
    [v73 registerForMessage:@"kUpdateAccessAllowedWhenLockedRequestKey" receiver:v9 policies:v75 selector:sel__handleAccessAllowedWhenLockedRequest_];
  }

  v76 = [(HMDHomeManager *)v9 messageDispatcher];
  v77 = *MEMORY[0x277CD0228];
  v78 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v350 = v78;
  v79 = [MEMORY[0x277CBEA60] arrayWithObjects:&v350 count:1];
  [v76 registerForMessage:v77 receiver:v9 policies:v79 selector:sel__handleHomeUpdateRequiredRequest_];

  v80 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
  [v80 setAllowsAnonymousMessage:1];
  v81 = [v80 copy];
  v82 = [(HMDHomeManager *)v9 messageDispatcher];
  v349 = v81;
  v83 = [MEMORY[0x277CBEA60] arrayWithObjects:&v349 count:1];
  [v82 registerForMessage:@"kHomeDataSyncRequestKey" receiver:v9 policies:v83 selector:sel__handleHomeDataSync_];

  v84 = [(HMDHomeManager *)v9 messageDispatcher];
  v348 = v81;
  v85 = [MEMORY[0x277CBEA60] arrayWithObjects:&v348 count:1];
  [v84 registerForMessage:@"kHomeDataFragmentedSyncRequestKey" receiver:v9 policies:v85 selector:sel_handleDataFragmentedSync_];

  v86 = [(HMDHomeManager *)v9 messageDispatcher];
  v347 = v81;
  v87 = [MEMORY[0x277CBEA60] arrayWithObjects:&v347 count:1];
  [v86 registerForMessage:@"kUserRemovedRequestKey" receiver:v9 policies:v87 selector:sel__handleUserRemoved_];

  v88 = [(HMDHomeManager *)v9 messageDispatcher];
  v346 = v81;
  v89 = [MEMORY[0x277CBEA60] arrayWithObjects:&v346 count:1];
  [v88 registerForMessage:@"kUserResetHomeConfigRequestKey" receiver:v9 policies:v89 selector:sel__handleResetHome_];

  if (isWatch())
  {
    v90 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v90 setRequiresSecureMessage:1];
    [v90 setRoles:1];
    v91 = [v90 copy];
    v92 = [(HMDHomeManager *)v9 messageDispatcher];
    v345 = v91;
    v93 = [MEMORY[0x277CBEA60] arrayWithObjects:&v345 count:1];
    [v92 registerForMessage:@"kCompanionKeysSyncInternalRequestKey" receiver:v9 policies:v93 selector:sel__handleCompanionKeysSync_];

    v94 = [(HMDHomeManager *)v9 messageDispatcher];
    v344 = v91;
    v95 = [MEMORY[0x277CBEA60] arrayWithObjects:&v344 count:1];
    [v94 registerForMessage:@"kHomeConfigInternalRequestKey" receiver:v9 policies:v95 selector:sel__handleHomesConfigSync_];

    v96 = [(HMDHomeManager *)v9 messageDispatcher];
    v343 = v91;
    v97 = [MEMORY[0x277CBEA60] arrayWithObjects:&v343 count:1];
    [v96 registerForMessage:@"kCurrentHomeChangedNotificationKey" receiver:v9 policies:v97 selector:sel__handleCurrentHomeChanged_];

    v98 = [(HMDHomeManager *)v9 messageDispatcher];
    v342 = v91;
    v99 = [MEMORY[0x277CBEA60] arrayWithObjects:&v342 count:1];
    [v98 registerForMessage:@"kMetadataDataSyncRequestKey" receiver:v9 policies:v99 selector:sel__handleMetadataSync_];

    v100 = [(HMDHomeManager *)v9 messageDispatcher];
    v341 = v91;
    v101 = [MEMORY[0x277CBEA60] arrayWithObjects:&v341 count:1];
    [v100 registerForMessage:@"HMDHomeManagerSyncWalletKeysPassSerialNumbersMessage" receiver:v9 policies:v101 selector:sel__handleHomeManagerSyncWalletKeysPassSerialNumbersMessage_];
  }

  if (isiOSDevice())
  {
    v102 = +[(HMDRemoteMessagePolicy *)HMDMutableRemoteMessagePolicy];
    [v102 setRequiresSecureMessage:1];
    [v102 setRoles:2];
    v103 = [v102 copy];
    v104 = [(HMDHomeManager *)v9 messageDispatcher];
    v340 = v103;
    v105 = [MEMORY[0x277CBEA60] arrayWithObjects:&v340 count:1];
    [v104 registerForMessage:@"kRequestForCompanionKeysSyncInternalRequestKey" receiver:v9 policies:v105 selector:sel__handleRequestForCompanionKeysSync_];

    v106 = [(HMDHomeManager *)v9 messageDispatcher];
    v339 = v103;
    v107 = [MEMORY[0x277CBEA60] arrayWithObjects:&v339 count:1];
    [v106 registerForMessage:@"kRetrieveVendorIdentifierInternalKey" receiver:v9 policies:v107 selector:sel__handleRetrieveVendorIdentifier_];
  }

  v108 = [[HMDHH2AutoMigrationEligibilityChecker alloc] initWithHomeManager:v9];
  [(HMDHomeManager *)v9 setHh2AutoMigrationEligibilityChecker:v108];

  [(HMDHomeManager *)v9 _registerForFrameworkSwitch];
  if (+[HMDAppleAccountSettings supportsCloudSettings])
  {
    v109 = [(HMDHomeManager *)v9 messageDispatcher];
    v110 = *MEMORY[0x277CD0318];
    v111 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v337[0] = v293;
    v337[1] = v292;
    v338[0] = v111;
    v112 = [MEMORY[0x277CBEA60] arrayWithObjects:v337 count:2];
    v113 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v112];
    v338[1] = v113;
    [MEMORY[0x277CBEA60] arrayWithObjects:v338 count:2];
    v115 = v114 = v44;
    [v109 registerForMessage:v110 receiver:v9 policies:v115 selector:sel__handleQueryiCloudSwitchState_];

    v116 = [(HMDHomeManager *)v9 messageDispatcher];
    v117 = *MEMORY[0x277CD03C8];
    v118 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v336[0] = v118;
    v335[0] = v293;
    v335[1] = v292;
    v119 = *MEMORY[0x277CCFD78];
    v335[2] = *MEMORY[0x277CCFD68];
    v335[3] = v119;
    v335[4] = *MEMORY[0x277CD1218];
    v120 = [MEMORY[0x277CBEA60] arrayWithObjects:v335 count:5];
    v121 = [HMDXPCiCloudSwitchMessagePolicy policyWithBundleIdentifiers:v120];
    v336[1] = v121;
    v122 = [MEMORY[0x277CBEA60] arrayWithObjects:v336 count:2];
    [v116 registerForMessage:v117 receiver:v9 policies:v122 selector:sel__handleUpdateiCloudSwitchState_];

    v44 = v114;
  }

  v123 = [(HMDHomeManager *)v9 messageDispatcher];
  v124 = *MEMORY[0x277CD02F8];
  v125 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v334 = v125;
  v126 = [MEMORY[0x277CBEA60] arrayWithObjects:&v334 count:1];
  [v123 registerForMessage:v124 receiver:v9 policies:v126 selector:sel__handleQueryHomeNamespace_];

  v127 = [(HMDHomeManager *)v9 messageDispatcher];
  v128 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v333 = v128;
  v129 = [MEMORY[0x277CBEA60] arrayWithObjects:&v333 count:1];
  [v127 registerForMessage:@"kResetConfigRequestKey" receiver:v9 policies:v129 selector:sel__handleResetConfiguration_];

  v130 = [MEMORY[0x277D0F8E8] productInfo];
  v131 = [v130 productVariant];

  if (v131 == 3)
  {
    v132 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v332 = v132;
    v133 = [MEMORY[0x277CBEA60] arrayWithObjects:&v332 count:1];

    v134 = [(HMDHomeManager *)v9 messageDispatcher];
    v135 = *MEMORY[0x277CD0300];
    v136 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v331 = v136;
    v137 = [MEMORY[0x277CBEA60] arrayWithObjects:&v331 count:1];
    [v134 registerForMessage:v135 receiver:v9 policies:v137 selector:sel__handleQueryMetadata_];

    v138 = [(HMDHomeManager *)v9 messageDispatcher];
    v139 = *MEMORY[0x277CD0368];
    v140 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v330 = v140;
    v141 = [MEMORY[0x277CBEA60] arrayWithObjects:&v330 count:1];
    [v138 registerForMessage:v139 receiver:v9 policies:v141 selector:sel__handleSetMetadata_];

    v142 = [(HMDHomeManager *)v9 messageDispatcher];
    v143 = *MEMORY[0x277CD0310];
    v144 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v329 = v144;
    v145 = [MEMORY[0x277CBEA60] arrayWithObjects:&v329 count:1];
    [v142 registerForMessage:v143 receiver:v9 policies:v145 selector:sel__handleQueryVersionInformation_];

    v146 = [(HMDHomeManager *)v9 messageDispatcher];
    v147 = *MEMORY[0x277CD0180];
    v148 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v328 = v148;
    v149 = [MEMORY[0x277CBEA60] arrayWithObjects:&v328 count:1];
    [v146 registerForMessage:v147 receiver:v9 policies:v149 selector:sel__handleDumpState_];

    v150 = [(HMDHomeManager *)v9 messageDispatcher];
    [v150 registerForMessage:*MEMORY[0x277CD01C0] receiver:v9 policies:v133 selector:sel__handleDiagnosticInfo_];

    v151 = [(HMDHomeManager *)v9 messageDispatcher];
    [v151 registerForMessage:*MEMORY[0x277CD02C0] receiver:v9 policies:v133 selector:sel__handleNetworkMismatchInfo_];
  }

  v152 = [(HMDHomeManager *)v9 messageDispatcher];
  v153 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v327 = v153;
  v154 = [MEMORY[0x277CBEA60] arrayWithObjects:&v327 count:1];
  [v152 registerForMessage:@"kUpdateInvitationStateRequestKey" receiver:v9 policies:v154 selector:sel__handleRequestToUpdateHomeInvitationFromLocalUser_];

  v155 = [(HMDHomeManager *)v9 messageDispatcher];
  v326 = v297;
  v156 = [MEMORY[0x277CBEA60] arrayWithObjects:&v326 count:1];
  [v155 registerForMessage:@"kUpdateHomeInvitationStateInternalRequestKey" receiver:v9 policies:v156 selector:sel__handleRequestToUpdateHomeInvitationFromInviter_];

  v157 = [(HMDHomeManager *)v9 messageDispatcher];
  v158 = *MEMORY[0x277CD0360];
  v159 = [HMDConfigurationMessagePolicy policyWithOperationTypes:7];
  v325[0] = v159;
  v160 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v325[1] = v160;
  v161 = [MEMORY[0x277CBEA60] arrayWithObjects:v325 count:2];
  [v157 registerForMessage:v158 receiver:v9 policies:v161 selector:sel__handleSetAppData_];

  v162 = [(HMDHomeManager *)v9 messageDispatcher];
  v163 = +[HMDRemoteMessagePolicy defaultSecurePolicy];
  v324 = v163;
  v164 = [MEMORY[0x277CBEA60] arrayWithObjects:&v324 count:1];
  [v162 registerForMessage:@"kSystemLogCaptureRequestKey" receiver:v9 policies:v164 selector:sel__handleSysdiagnoseRequest_];

  if (!isWatch())
  {
    v165 = [(HMDHomeManager *)v9 messageDispatcher];
    v166 = *MEMORY[0x277CCFCB0];
    v167 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v323 = v167;
    v168 = [MEMORY[0x277CBEA60] arrayWithObjects:&v323 count:1];
    [v165 registerForMessage:v166 receiver:v9 policies:v168 selector:sel__handleDeviceSetupSessionOpen_];

    v169 = [(HMDHomeManager *)v9 messageDispatcher];
    v170 = *MEMORY[0x277CCFC88];
    v171 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v322 = v171;
    v172 = [MEMORY[0x277CBEA60] arrayWithObjects:&v322 count:1];
    [v169 registerForMessage:v170 receiver:v9 policies:v172 selector:sel__handleDeviceSetupSessionClose_];
  }

  [(HMDHomeManager *)v9 _registerForConfiguringStateMessages];
  if (isInternalBuild())
  {
    v173 = [(HMDHomeManager *)v9 messageDispatcher];
    v174 = *MEMORY[0x277CD0330];
    v175 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v321 = v175;
    v176 = [MEMORY[0x277CBEA60] arrayWithObjects:&v321 count:1];
    [v173 registerForMessage:v174 receiver:v9 policies:v176 selector:sel__handleResolveAccount_];

    v177 = [(HMDHomeManager *)v9 messageDispatcher];
    v178 = *MEMORY[0x277CD0320];
    v179 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v320 = v179;
    v180 = [MEMORY[0x277CBEA60] arrayWithObjects:&v320 count:1];
    [v177 registerForMessage:v178 receiver:v9 policies:v180 selector:sel__handleRemoveAccount_];

    v181 = [(HMDHomeManager *)v9 messageDispatcher];
    v182 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v319 = v182;
    v183 = [MEMORY[0x277CBEA60] arrayWithObjects:&v319 count:1];
    [v181 registerForMessage:@"kPingInternalRequestKey" receiver:v9 policies:v183 selector:sel__handlePing_];

    v184 = [(HMDHomeManager *)v9 messageDispatcher];
    v185 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v318 = v185;
    v186 = [MEMORY[0x277CBEA60] arrayWithObjects:&v318 count:1];
    [v184 registerForMessage:@"HomeUtilConfigTestingModeMessage" receiver:v9 policies:v186 selector:sel__handleTestModeConfigRequest_];

    v187 = [(HMDHomeManager *)v9 messageDispatcher];
    v188 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v317 = v188;
    v189 = [MEMORY[0x277CBEA60] arrayWithObjects:&v317 count:1];
    [v187 registerForMessage:@"HomeUtilSetOverridesMessage" receiver:v9 policies:v189 selector:sel__handleHomeUtilSetOverridesMessage_];

    v190 = [(HMDHomeManager *)v9 messageDispatcher];
    v191 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v316 = v191;
    v192 = [MEMORY[0x277CBEA60] arrayWithObjects:&v316 count:1];
    [v190 registerForMessage:@"HomeUtilRemoteMessageRequestMessage" receiver:v9 policies:v192 selector:sel__handleHomeUtilRemoteMessageRequest_];

    v193 = [(HMDHomeManager *)v9 messageDispatcher];
    v194 = *MEMORY[0x277CD03C0];
    v195 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v315 = v195;
    v196 = [MEMORY[0x277CBEA60] arrayWithObjects:&v315 count:1];
    [v193 registerForMessage:v194 receiver:v9 policies:v196 selector:sel__handleUpdateMobileAssetsRequest_];

    v197 = [(HMDHomeManager *)v9 messageDispatcher];
    v198 = *MEMORY[0x277CD00B0];
    v199 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v314 = v199;
    v200 = [MEMORY[0x277CBEA60] arrayWithObjects:&v314 count:1];
    [v197 registerForMessage:v198 receiver:v9 policies:v200 selector:sel__handleClearMobileAssetsInfoRequest_];
  }

  v201 = [(HMDHomeManager *)v9 messageDispatcher];
  v202 = *MEMORY[0x277CD0348];
  v203 = [HMDXPCMessagePolicy policyWithEntitlements:1];
  v313 = v203;
  v204 = [MEMORY[0x277CBEA60] arrayWithObjects:&v313 count:1];
  [v201 registerForMessage:v202 receiver:v9 policies:v204 selector:sel__handleRequestRuntimeStateUpdate_];

  v205 = [(HMDHomeManager *)v9 messageDispatcher];
  v206 = *MEMORY[0x277CD02E0];
  v207 = [HMDXPCMessagePolicy policyWithEntitlements:13];
  v312 = v207;
  v208 = [MEMORY[0x277CBEA60] arrayWithObjects:&v312 count:1];
  [v205 registerForMessage:v206 receiver:v9 policies:v208 selector:sel__handlePairingIdentityRequest_];

  v209 = [(HMDHomeManager *)v9 messageDispatcher];
  v210 = *MEMORY[0x277CD01C8];
  v211 = [HMDXPCMessagePolicy policyWithEntitlements:13];
  v311 = v211;
  v212 = [MEMORY[0x277CBEA60] arrayWithObjects:&v311 count:1];
  [v209 registerForMessage:v210 receiver:v9 policies:v212 selector:sel__handleFetchCurrentUserPairingIdentityForHomeContainingAccessoryRequest_];

  v213 = [(HMDHomeManager *)v9 messageDispatcher];
  v214 = *MEMORY[0x277CD01D0];
  v215 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v310 = v215;
  v216 = [MEMORY[0x277CBEA60] arrayWithObjects:&v310 count:1];
  [v213 registerForMessage:v214 receiver:v9 policies:v216 selector:sel__handleFetchDevicesMessage_];

  if (isInternalBuild())
  {
    v217 = [(HMDHomeManager *)v9 messageDispatcher];
    v218 = *MEMORY[0x277CD0A40];
    v219 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v309 = v219;
    v220 = [MEMORY[0x277CBEA60] arrayWithObjects:&v309 count:1];
    [v217 registerForMessage:v218 receiver:v9 policies:v220 selector:sel__handleNetworkFirewallDumpCloudRecordsRequest_];

    v221 = [(HMDHomeManager *)v9 messageDispatcher];
    v222 = *MEMORY[0x277CD0A28];
    v223 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v308[0] = v223;
    v224 = [HMDConfigurationMessagePolicy policyWithOperationTypes:3];
    v308[1] = v224;
    v225 = [MEMORY[0x277CBEA60] arrayWithObjects:v308 count:2];
    [v221 registerForMessage:v222 receiver:v9 policies:v225 selector:sel__handleNetworkFirewallAddOverridesRequest_];

    v226 = [(HMDHomeManager *)v9 messageDispatcher];
    v227 = *MEMORY[0x277CD0AF8];
    v228 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v307[0] = v228;
    v229 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
    v307[1] = v229;
    v230 = [MEMORY[0x277CBEA60] arrayWithObjects:v307 count:2];
    [v226 registerForMessage:v227 receiver:v9 policies:v230 selector:sel__handleNetworkFirewallRemoveOverridesRequest_];

    v231 = [(HMDHomeManager *)v9 messageDispatcher];
    v232 = *MEMORY[0x277CD0A80];
    v233 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v306 = v233;
    v234 = [MEMORY[0x277CBEA60] arrayWithObjects:&v306 count:1];
    [v231 registerForMessage:v232 receiver:v9 policies:v234 selector:sel__handleNetworkFirewallDumpLocalRulesRequest_];

    v235 = [(HMDHomeManager *)v9 messageDispatcher];
    v236 = *MEMORY[0x277CD0AB8];
    v237 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v305 = v237;
    v238 = [MEMORY[0x277CBEA60] arrayWithObjects:&v305 count:1];
    [v235 registerForMessage:v236 receiver:v9 policies:v238 selector:sel__handleNetworkFirewallDumpPairedMetadataRequest_];

    v239 = [(HMDHomeManager *)v9 messageDispatcher];
    v240 = *MEMORY[0x277CD0AF0];
    v241 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v304[0] = v241;
    v242 = [HMDConfigurationMessagePolicy policyWithOperationTypes:4];
    v304[1] = v242;
    v243 = [MEMORY[0x277CBEA60] arrayWithObjects:v304 count:2];
    [v239 registerForMessage:v240 receiver:v9 policies:v243 selector:sel__handleNetworkFirewallRemoveLocalRulesRequest_];

    v244 = [(HMDHomeManager *)v9 messageDispatcher];
    v245 = *MEMORY[0x277CD0AE8];
    v246 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v303 = v246;
    v247 = [MEMORY[0x277CBEA60] arrayWithObjects:&v303 count:1];
    [v244 registerForMessage:v245 receiver:v9 policies:v247 selector:sel__handleNetworkFirewallFetchCloudChangesRequest_];

    v248 = [(HMDHomeManager *)v9 messageDispatcher];
    v249 = *MEMORY[0x277CD00D0];
    v250 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v302 = v250;
    v251 = [MEMORY[0x277CBEA60] arrayWithObjects:&v302 count:1];
    [v248 registerForMessage:v249 receiver:v9 policies:v251 selector:sel__handleGetTLVForJSON_];
  }

  v252 = [(HMDHomeManager *)v9 messageDispatcher];
  v253 = *MEMORY[0x277CD0198];
  v254 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v301 = v254;
  v255 = [MEMORY[0x277CBEA60] arrayWithObjects:&v301 count:1];
  [v252 registerForMessage:v253 receiver:v9 policies:v255 selector:sel__handleEnableUARPPacketCaptureRequest_];

  if (isInternalBuild())
  {
    v256 = [(HMDHomeManager *)v9 messageDispatcher];
    v257 = *MEMORY[0x277CD0158];
    v258 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v300 = v258;
    v259 = [MEMORY[0x277CBEA60] arrayWithObjects:&v300 count:1];
    [v256 registerForMessage:v257 receiver:v9 policies:v259 selector:sel__handleDumpDatabase_];
  }

  if (isInternalBuild())
  {
    v260 = [(HMDHomeManager *)v9 messageDispatcher];
    v261 = *MEMORY[0x277CD02F0];
    v262 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v299 = v262;
    v263 = [MEMORY[0x277CBEA60] arrayWithObjects:&v299 count:1];
    [v260 registerForMessage:v261 receiver:v9 policies:v263 selector:sel__handlePrepareForDiagnosticExtension_];
  }

  v264 = [(HMDHomeManager *)v9 userCloudShareManager];
  v265 = [(HMDHomeManager *)v9 messageDispatcher];
  [v264 configureWithMessageDispatcher:v265];

  v266 = [(HMDHomeManager *)v9 messageDispatcher];
  v267 = *MEMORY[0x277CD00C8];
  v268 = [HMDXPCMessagePolicy policyWithEntitlements:261];
  v298 = v268;
  v269 = [MEMORY[0x277CBEA60] arrayWithObjects:&v298 count:1];
  [v266 registerForMessage:v267 receiver:v9 policies:v269 selector:sel__handleConnectivityInfoRequest_];

  if (isiOSDevice())
  {
    v270 = [(HMDHomeManager *)v9 notificationCenter];
    [v270 addObserver:v9 selector:sel_controllerKeyPairGenerated_ name:*MEMORY[0x277CFED00] object:0];

    v271 = [(HMDHomeManager *)v9 notificationCenter];
    [v271 addObserver:v9 selector:sel_forcePushLocalDataToCloud_ name:@"kCloudDataSyncTimerExpiredNotification" object:0];
  }

  v272 = [(HMDHomeManager *)v9 notificationCenter];
  [v272 addObserver:v9 selector:sel_dataSyncInProgressUpdatedNotification_ name:@"kCloudDataSyncInProgressUpdatedNotification" object:0];

  v273 = [(HMDHomeManager *)v9 notificationCenter];
  [v273 addObserver:v9 selector:sel__handleSaveRequest_ name:@"HMDHomeManagerSaveRequestNotificationKey" object:0];

  v274 = [(HMDHomeManager *)v9 notificationCenter];
  [v274 addObserver:v9 selector:sel_handleVendorInfoUpdated_ name:@"kHMDVendorInfoUpdatedNotification" object:0];

  v275 = [(HMDHomeManager *)v9 notificationCenter];
  [v275 addObserver:v9 selector:sel_auditDuplicatePreviouslyAddedAccessory_ name:@"HMDHomeThisOwnerDeviceAddedAccessoryNotification" object:0];

  v276 = [(HMDHomeManager *)v9 notificationCenter];
  [v276 addObserver:v9 selector:sel___handleInitialFetch_ name:@"HMDCloudZoneReadyNotification" object:0];

  v277 = [(HMDHomeManager *)v9 notificationCenter];
  [v277 addObserver:v9 selector:sel___handleAppleAccountUpdated_ name:@"HMDAppleAccountManagerAccountUpdatedNotification" object:0];

  v278 = [(HMDHomeManager *)v9 notificationCenter];
  v279 = +[HMDAccountRegistry sharedRegistry];
  [v278 addObserver:v9 selector:sel___accountRegistryAddedAccount_ name:@"HMDAccountRegistryAddedAccountNotification" object:v279];

  v280 = [(HMDHomeManager *)v9 notificationCenter];
  v281 = +[HMDAccountRegistry sharedRegistry];
  [v280 addObserver:v9 selector:sel___accountRegistryRemovedAccount_ name:@"HMDAccountRegistryRemovedAccountNotification" object:v281];

  v282 = [(HMDHomeManager *)v9 notificationCenter];
  [v282 addObserver:v9 selector:sel___accountAddedDevice_ name:@"HMDAccountAddedDeviceNotification" object:0];

  v283 = [(HMDHomeManager *)v9 notificationCenter];
  [v283 addObserver:v9 selector:sel___handleDeviceUpdatedNotification_ name:@"HMDDeviceUpdatedNotification" object:0];

  v284 = [(HMDHomeManager *)v9 notificationCenter];
  [v284 addObserver:v9 selector:sel___accountRemovedDevice_ name:@"HMDAccountRemovedDeviceNotification" object:0];

  v285 = [(HMDHomeManager *)v9 notificationCenter];
  [v285 addObserver:v9 selector:sel___handleHMDFMFStatusUpdateNotification_ name:@"HMDFMFStatusUpdateNotification" object:0];

  v286 = [(HMDHomeManager *)v9 notificationCenter];
  v287 = [(HMDHomeManager *)v9 messageDispatcher];
  [v286 addObserver:v9 selector:sel__handleRemoteSessionTornDownNotification_ name:@"HMDMessageDispatcherRemoteSessionTornDownNotification" object:v287];

  v288 = [MEMORY[0x277CCA9A0] defaultCenter];
  [v288 addObserver:v9 selector:sel__handleSEUpdatedAliroVersions name:@"com.apple.secureelementservice.acwg.event.versions.did.update" object:0];

  v289 = [MEMORY[0x277CBEB98] setWithArray:&unk_286627310];
  v290 = [MEMORY[0x277D0F810] memoryMonitor];
  [v290 addObserver:v9 debounceInterval:v289 events:0.0];
  [(HMDHomeManager *)v9 registerNotificationsForPowerManagement];
  [(HMDHomeManager *)v9 configureForWalletKey];

  v291 = *MEMORY[0x277D85DE8];
}

- (BOOL)_setPrimaryHome:(id)a3 idsDataSync:(BOOL)a4
{
  v4 = a4;
  v30 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = [(HMDHomeManager *)self primaryHomeUUID];
  v8 = v6;
  v9 = [(HMDHomeManager *)self homes];
  v10 = [v9 count];

  if (!v10)
  {

    v11 = 0;
    if ((HMFEqualObjects() & 1) == 0)
    {
      goto LABEL_12;
    }

LABEL_8:
    v12 = 0;
    goto LABEL_15;
  }

  if (v8 && (!v4 || isWatch()))
  {
    v11 = v8;
    if ((HMFEqualObjects() & 1) == 0)
    {
      goto LABEL_12;
    }

LABEL_10:
    v12 = 0;
    v11 = v8;
    goto LABEL_15;
  }

  v13 = [(HMDHomeManager *)self homes];
  v14 = [v13 hmf_firstObjectWithUUID:v7];

  if (v14)
  {
    goto LABEL_10;
  }

  v15 = [(HMDHomeManager *)self homes];
  v16 = [v15 firstObject];

  v11 = [v16 uuid];

  v17 = HMFEqualObjects();
  if (v17)
  {
    goto LABEL_8;
  }

LABEL_12:
  v18 = objc_autoreleasePoolPush();
  v19 = self;
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    v24 = 138543874;
    v25 = v21;
    v26 = 2112;
    v27 = v7;
    v28 = 2112;
    v29 = v11;
    _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Updating the primary home from %@ to %@", &v24, 0x20u);
  }

  objc_autoreleasePoolPop(v18);
  [(HMDHomeManager *)v19 setPrimaryHomeUUID:v11];
  [(HMDHomeManager *)v19 _updateCurrentHomeIfNecessary];
  v12 = 1;
LABEL_15:

  v22 = *MEMORY[0x277D85DE8];
  return v12;
}

- (BOOL)_associateAccessories:(id)a3 withHomes:(id)a4
{
  v48 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v33 = a4;
  v6 = [MEMORY[0x277CBEB38] dictionary];
  v38 = 0u;
  v39 = 0u;
  v40 = 0u;
  v41 = 0u;
  v7 = v5;
  v8 = [v7 countByEnumeratingWithState:&v38 objects:v47 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = 0;
    v11 = *v39;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v39 != v11)
        {
          objc_enumerationMutation(v7);
        }

        v13 = *(*(&v38 + 1) + 8 * i);
        v14 = [v13 home];
        v15 = [v14 uuid];

        if (v15)
        {
          v16 = [v6 hmf_mutableArrayForKey:v15];
          if (!v16)
          {
            v16 = [MEMORY[0x277CBEB18] array];
            [v6 setObject:v16 forKey:v15];
          }

          [v16 addObject:v13];
        }

        else
        {
          v17 = objc_autoreleasePoolPush();
          v18 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
          {
            v19 = HMFGetLogIdentifier();
            *buf = 138543618;
            v44 = v19;
            v45 = 2112;
            v46 = v13;
            _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@###### Unassociated accessory %@ - dropping", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v17);
          v10 = 1;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v38 objects:v47 count:16];
    }

    while (v9);
  }

  else
  {
    v10 = 0;
  }

  v36 = 0u;
  v37 = 0u;
  v34 = 0u;
  v35 = 0u;
  v20 = v33;
  v21 = [v20 countByEnumeratingWithState:&v34 objects:v42 count:16];
  if (v21)
  {
    v22 = v21;
    v23 = *v35;
    do
    {
      for (j = 0; j != v22; ++j)
      {
        if (*v35 != v23)
        {
          objc_enumerationMutation(v20);
        }

        v25 = *(*(&v34 + 1) + 8 * j);
        v26 = [v25 accessories];
        v27 = [v26 count];

        if (!v27)
        {
          v28 = [v25 uuid];
          v29 = [v6 hmf_mutableArrayForKey:v28];

          [v25 setAccessories:v29];
          v30 = [v25 uuid];
          [v6 removeObjectForKey:v30];
        }
      }

      v22 = [v20 countByEnumeratingWithState:&v34 objects:v42 count:16];
    }

    while (v22);
  }

  v31 = *MEMORY[0x277D85DE8];
  return v10 & 1;
}

- (void)_auditKeychainEntries
{
  v80 = *MEMORY[0x277D85DE8];
  v58 = [MEMORY[0x277CBEB38] dictionary];
  v59 = self;
  v69 = 0u;
  v70 = 0u;
  v71 = 0u;
  v72 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v54 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
  if (v54)
  {
    v53 = *v70;
    do
    {
      v3 = 0;
      do
      {
        if (*v70 != v53)
        {
          objc_enumerationMutation(obj);
        }

        v55 = v3;
        v4 = *(*(&v69 + 1) + 8 * v3);
        v65 = 0u;
        v66 = 0u;
        v67 = 0u;
        v68 = 0u;
        v60 = [v4 accessories];
        v5 = [v60 countByEnumeratingWithState:&v65 objects:v78 count:16];
        if (v5)
        {
          v6 = v5;
          v7 = *v66;
          do
          {
            for (i = 0; i != v6; ++i)
            {
              if (*v66 != v7)
              {
                objc_enumerationMutation(v60);
              }

              v9 = *(*(&v65 + 1) + 8 * i);
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v10 = v9;
              }

              else
              {
                v10 = 0;
              }

              v11 = v10;

              if (!v11)
              {
                v16 = v9;
                objc_opt_class();
                if (objc_opt_isKindOfClass())
                {
                  v17 = v16;
                }

                else
                {
                  v17 = 0;
                }

                v13 = v17;

                if (v13)
                {
                  v18 = [v13 identifier];

                  if (!v18)
                  {
                    v19 = objc_autoreleasePoolPush();
                    v20 = v59;
                    v21 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v21, OS_LOG_TYPE_ERROR))
                    {
                      v22 = HMFGetLogIdentifier();
                      *buf = 138543618;
                      v75 = v22;
                      v76 = 2112;
                      v77 = v13;
                      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_ERROR, "%{public}@Failed to add accessory %@ to the audit accessory list since identifier is nil", buf, 0x16u);
                    }

                    objc_autoreleasePoolPop(v19);
                  }
                }

                goto LABEL_27;
              }

              v12 = [v11 pairingUsername];
              if (v12 || ([v11 identifier], (v12 = objc_claimAutoreleasedReturnValue()) != 0))
              {
                v13 = v12;
                v14 = [v11 publicKey];

                if (v14)
                {
                  v15 = [v11 publicKey];
                  [v58 setObject:v15 forKey:v13];

LABEL_27:
                  goto LABEL_34;
                }

                v23 = objc_autoreleasePoolPush();
                v24 = v59;
                v25 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v25, OS_LOG_TYPE_ERROR))
                {
                  v26 = HMFGetLogIdentifier();
                  v27 = [v11 name];
                  *buf = 138543618;
                  v75 = v26;
                  v76 = 2112;
                  v77 = v27;
                  _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_ERROR, "%{public}@A HAP accessory '%@' with a public key - removing from list of of keychain entries", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v23);
              }

              else
              {
                v28 = objc_autoreleasePoolPush();
                v29 = v59;
                v30 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
                {
                  v31 = HMFGetLogIdentifier();
                  v32 = [v11 name];
                  *buf = 138543618;
                  v75 = v31;
                  v76 = 2112;
                  v77 = v32;
                  _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to add accessory %@ to the audit accessory list for keychain cleanup", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v28);
              }

LABEL_34:
            }

            v6 = [v60 countByEnumeratingWithState:&v65 objects:v78 count:16];
          }

          while (v6);
        }

        v3 = v55 + 1;
      }

      while (v55 + 1 != v54);
      v54 = [obj countByEnumeratingWithState:&v69 objects:v79 count:16];
    }

    while (v54);
  }

  v33 = [MEMORY[0x277CFEC78] systemStore];
  v34 = [v33 auditKeysOfManagedAccessories:v58];
  v35 = v34;
  if (v34)
  {
    v56 = v34;
    v57 = v33;
    v63 = 0u;
    v64 = 0u;
    v61 = 0u;
    v62 = 0u;
    v36 = v34;
    v37 = [v36 countByEnumeratingWithState:&v61 objects:v73 count:16];
    if (v37)
    {
      v38 = v37;
      v39 = *v62;
      do
      {
        for (j = 0; j != v38; ++j)
        {
          if (*v62 != v39)
          {
            objc_enumerationMutation(v36);
          }

          v41 = *(*(&v61 + 1) + 8 * j);
          v42 = objc_autoreleasePoolPush();
          v43 = v59;
          v44 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
          {
            v45 = HMFGetLogIdentifier();
            v46 = [v41 description];
            *buf = 138543618;
            v75 = v45;
            v76 = 2112;
            v77 = v46;
            _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Removed spurious keychain entry: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v42);
        }

        v38 = [v36 countByEnumeratingWithState:&v61 objects:v73 count:16];
      }

      while (v38);
    }

    v35 = v56;
    v33 = v57;
  }

  else
  {
    v47 = objc_autoreleasePoolPush();
    v48 = v59;
    v49 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_DEFAULT))
    {
      v50 = HMFGetLogIdentifier();
      *buf = 138543362;
      v75 = v50;
      _os_log_impl(&dword_2531F8000, v49, OS_LOG_TYPE_DEFAULT, "%{public}@Audit keychain entries failed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v47);
  }

  v51 = *MEMORY[0x277D85DE8];
}

- (id)_deviceForIdentifier:(id)a3
{
  v22 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v4];
  if (v5)
  {
    v19 = 0u;
    v20 = 0u;
    v17 = 0u;
    v18 = 0u;
    v6 = [(HMDHomeManager *)self appleAccountManager];
    v7 = [v6 account];
    v8 = [v7 devices];

    v9 = [v8 countByEnumeratingWithState:&v17 objects:v21 count:16];
    if (v9)
    {
      v10 = *v18;
      while (2)
      {
        for (i = 0; i != v9; i = i + 1)
        {
          if (*v18 != v10)
          {
            objc_enumerationMutation(v8);
          }

          v12 = *(*(&v17 + 1) + 8 * i);
          v13 = [v12 identifier];
          v14 = [v5 isEqual:v13];

          if (v14)
          {
            v9 = v12;
            goto LABEL_12;
          }
        }

        v9 = [v8 countByEnumeratingWithState:&v17 objects:v21 count:16];
        if (v9)
        {
          continue;
        }

        break;
      }
    }

LABEL_12:
  }

  else
  {
    v9 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v9;
}

- (id)_filterAccessories:(id)a3 inHome:(id)a4
{
  v25 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v19 = [MEMORY[0x277CBEB18] array];
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v7 = v5;
  v8 = [v7 countByEnumeratingWithState:&v20 objects:v24 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v21;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v21 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v20 + 1) + 8 * i);
        v13 = [v12 home];
        v14 = [v13 uuid];
        v15 = [v6 uuid];
        v16 = [v14 isEqual:v15];

        if (v16)
        {
          [v19 addObject:v12];
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v20 objects:v24 count:16];
    }

    while (v9);
  }

  v17 = *MEMORY[0x277D85DE8];

  return v19;
}

- (id)_filterAccessories:(id)a3 withIdentifiers:(id)a4
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v20 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v5, "count")}];
  v21 = 0u;
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v7 = v5;
  v8 = [v7 countByEnumeratingWithState:&v21 objects:v25 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v22;
    do
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v22 != v10)
        {
          objc_enumerationMutation(v7);
        }

        v12 = *(*(&v21 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v13 = v12;
        }

        else
        {
          v13 = 0;
        }

        v14 = v13;

        if (v14)
        {
          v15 = [v14 uniqueIdentifier];
          v16 = [v6 containsObject:v15];

          if (v16)
          {
            [v20 addObject:v12];
          }
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v21 objects:v25 count:16];
    }

    while (v9);
  }

  v17 = [v20 copy];
  v18 = *MEMORY[0x277D85DE8];

  return v17;
}

- (id)identifiersOfAccessories:(id)a3
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = [MEMORY[0x277CBEB58] set];
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v5 = v3;
  v6 = [v5 countByEnumeratingWithState:&v17 objects:v21 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v18;
    do
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v18 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = *(*(&v17 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v11 = v10;
        }

        else
        {
          v11 = 0;
        }

        v12 = v11;

        if (v12)
        {
          v13 = [v12 uniqueIdentifier];
          [v4 addObject:v13];
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v17 objects:v21 count:16];
    }

    while (v7);
  }

  v14 = [v4 copy];
  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (id)identifiersOfAccessoriesForHome:(id)a3
{
  v4 = [a3 accessories];
  v5 = [(HMDHomeManager *)self identifiersOfAccessories:v4];

  return v5;
}

void __66__HMDHomeManager__updateCloudDataSyncWithAccountState_completion___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3, void *a4)
{
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v8 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained _handleAccountStatusDeterminedWithError:v9 homeDataRecordExists:a2 metadataRecordExists:a3 completion:*(a1 + 32)];
  }
}

- (void)_updateCloudDataSyncWithAccountState:(BOOL)a3
{
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self cloudAccount];
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __55__HMDHomeManager__updateCloudDataSyncWithAccountState___block_invoke;
  v6[3] = &unk_279732340;
  objc_copyWeak(&v7, &location);
  v8 = a3;
  [v5 addAccountOperation:v6];

  objc_destroyWeak(&v7);
  objc_destroyWeak(&location);
}

void __55__HMDHomeManager__updateCloudDataSyncWithAccountState___block_invoke(uint64_t a1, void *a2)
{
  v5 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v4 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained _updateCloudDataSyncWithAccountState:*(a1 + 40) completion:v5];
  }

  else if (v5)
  {
    v5[2]();
  }
}

- (void)forceCloudFetch
{
  objc_initWeak(&location, self);
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __33__HMDHomeManager_forceCloudFetch__block_invoke;
  block[3] = &unk_279732E78;
  objc_copyWeak(&v5, &location);
  block[4] = self;
  dispatch_async(v3, block);

  objc_destroyWeak(&v5);
  objc_destroyWeak(&location);
}

void __33__HMDHomeManager_forceCloudFetch__block_invoke(uint64_t a1)
{
  v15 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v12 = 0u;
    v13 = 0u;
    v10 = 0u;
    v11 = 0u;
    v3 = [*(a1 + 32) homes];
    v4 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
    if (v4)
    {
      v5 = v4;
      v6 = *v11;
      do
      {
        for (i = 0; i != v5; ++i)
        {
          if (*v11 != v6)
          {
            objc_enumerationMutation(v3);
          }

          v8 = *(*(&v10 + 1) + 8 * i);
          [v8 setExpectedConfigurationVersion:0];
          [v8 setSharedHomeSourceVersion:0];
        }

        v5 = [v3 countByEnumeratingWithState:&v10 objects:v14 count:16];
      }

      while (v5);
    }

    [WeakRetained _fetchHomeDataFromCloudWithCloudConflict:0 forceFetch:1 withDelay:0 accountCompletion:0.0];
    [WeakRetained _requestHomeDataSync];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_requestHomeDataSync
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v11;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v11 != v5)
        {
          objc_enumerationMutation(v2);
        }

        v7 = *(*(&v10 + 1) + 8 * i);
        if (([v7 isOwnerUser] & 1) == 0)
        {
          v8 = [v7 sharedHomeUpdateHandler];
          [v8 requestHomeDataSync];
        }
      }

      v4 = [v2 countByEnumeratingWithState:&v10 objects:v14 count:16];
    }

    while (v4);
  }

  v9 = *MEMORY[0x277D85DE8];
}

void __106__HMDHomeManager__runFetchHomeDataFromCloudWithCloudConflict_forceFetch_accountCompletion_syncCompletion___block_invoke(uint64_t a1, uint64_t a2, void *a3)
{
  v59 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 32);
  v7 = HMFGetOSLogHandle();
  v8 = v7;
  if (!v4)
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v22 = HMFGetLogIdentifier();
      *buf = 138543362;
      v56 = v22;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Finished fetching legacy zone", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    WeakRetained = objc_loadWeakRetained((a1 + 80));
    if (!WeakRetained)
    {
      goto LABEL_27;
    }

    v24 = WeakRetained;
    [*(a1 + 40) loadObjectChanges];
    v25 = dispatch_group_create();
    v26 = *(a1 + 40);
    v27 = [*(a1 + 48) metadataObjectID];
    v28 = [v26 changeWithObjectID:v27];

    if (v28 && ([v28 isDeleted] & 1) == 0)
    {
      v29 = objc_autoreleasePoolPush();
      v30 = v24;
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        *buf = 138543362;
        v56 = v32;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Metadata record was updated in the legacy zone, not processing", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v29);
    }

    v33 = objc_autoreleasePoolPush();
    v11 = v24;
    v34 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
    {
      v35 = HMFGetLogIdentifier();
      *buf = 138543362;
      v56 = v35;
      _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@Ignoring cloud legacy records, data will not be merged", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v33);
    v36 = *(a1 + 40);
    v37 = [*(a1 + 48) homeDataV3ObjectID];
    v38 = [v36 changeWithObjectID:v37];
    if (v38)
    {
    }

    else
    {
      v41 = *(a1 + 40);
      v42 = [*(a1 + 48) homeDataObjectID];
      v43 = [v41 changeWithObjectID:v42];

      if (!v43)
      {
LABEL_32:
        v45 = [v11 workQueue];
        block[0] = MEMORY[0x277D85DD0];
        block[1] = 3221225472;
        block[2] = __106__HMDHomeManager__runFetchHomeDataFromCloudWithCloudConflict_forceFetch_accountCompletion_syncCompletion___block_invoke_944;
        block[3] = &unk_2797322F0;
        objc_copyWeak(&v53, (a1 + 80));
        v50 = *(a1 + 40);
        v51 = *(a1 + 48);
        v54 = *(a1 + 88);
        v48 = *(a1 + 64);
        v46 = v48;
        v52 = v48;
        dispatch_group_notify(v25, v45, block);

        objc_destroyWeak(&v53);
        goto LABEL_33;
      }
    }

    v44 = [[HMDHomeSaveRequest alloc] initWithReason:@"HMDHomeManagerLegacyZoneFetchSomething" information:0 postSyncNotification:0];
    [v11 saveWithRequest:v44];

    goto LABEL_32;
  }

  if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543618;
    v56 = v9;
    v57 = 2112;
    v58 = v4;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to fetch legacy zone: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v10 = objc_loadWeakRetained((a1 + 80));
  if (v10)
  {
    v11 = v10;
    v12 = [v4 domain];
    if ([v12 isEqualToString:*MEMORY[0x277CBBF50]])
    {
      v13 = [v4 userInfo];

      if (!v13)
      {
        goto LABEL_13;
      }

      v14 = [v4 userInfo];
      v12 = [v14 hmf_numberForKey:*MEMORY[0x277CBBF68]];

      if (v12 && !*(a1 + 56))
      {
        v15 = objc_autoreleasePoolPush();
        v16 = v11;
        v17 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
        {
          v18 = HMFGetLogIdentifier();
          *buf = 138543618;
          v56 = v18;
          v57 = 2112;
          v58 = v12;
          _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Rescheduling legacy fetch changes with delay %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v15);
        v19 = *(a1 + 88);
        v20 = *(a1 + 89);
        [v12 doubleValue];
        [v16 _fetchHomeDataFromCloudWithCloudConflict:v19 forceFetch:v20 withDelay:0 accountCompletion:?];
      }
    }

LABEL_13:
    [*(a1 + 40) setOsTransaction:0];
    v21 = *(a1 + 64);
    if (v21)
    {
      (*(v21 + 16))(v21, v4);
    }

    goto LABEL_33;
  }

LABEL_27:
  [*(a1 + 40) setOsTransaction:0];
  v39 = *(a1 + 64);
  if (v39)
  {
    v40 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    (*(v39 + 16))(v39, v40);
  }

  v11 = 0;
LABEL_33:

  v47 = *MEMORY[0x277D85DE8];
}

void __106__HMDHomeManager__runFetchHomeDataFromCloudWithCloudConflict_forceFetch_accountCompletion_syncCompletion___block_invoke_944(uint64_t a1)
{
  v29 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    v3 = *(a1 + 32);
    v4 = [*(a1 + 40) homeDataObjectID];
    v5 = [v3 changeWithObjectID:v4];

    v6 = [*(a1 + 40) hasRecordsAvailable];
    if (v5)
    {
      v7 = 1;
    }

    else
    {
      v7 = v6;
    }

    v8 = objc_autoreleasePoolPush();
    v9 = WeakRetained;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = v5 != 0;
      v12 = HMFGetLogIdentifier();
      v13 = [MEMORY[0x277CCABB0] numberWithBool:v11];
      v14 = [MEMORY[0x277CCABB0] numberWithBool:v7];
      v23 = 138543874;
      v24 = v12;
      v25 = 2112;
      v26 = v13;
      v27 = 2112;
      v28 = v14;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Completed processing legacy zone recordWasFetched: %@, dataIsAvailable: %@", &v23, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    [*(a1 + 32) updateCloudCache];
    v15 = [v9 cloudDataSyncManager];
    [v15 updateServerTokenStatusOnCloudFilter];

    if ([*(a1 + 32) iCloudSwitchStateEnabled] && (!v7 || *(*(*(a1 + 56) + 8) + 24) == 1))
    {
      v16 = objc_autoreleasePoolPush();
      v17 = v9;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
      {
        v19 = HMFGetLogIdentifier();
        v23 = 138543362;
        v24 = v19;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Updating data sync state on processing legacy zone.", &v23, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      v20 = [v17 cloudDataSyncManager];
      [v20 updateCloudDataSyncFilterState:1];
    }

    [v9 _postMergeWatchPush];
    if (*(a1 + 72) == 1)
    {
      [v9 _pushChangesToCloud:0 withDelay:0.0];
    }

    [*(a1 + 32) setOsTransaction:0];
    v21 = *(a1 + 48);
    if (v21)
    {
      (*(v21 + 16))(v21, 0);
    }
  }

  v22 = *MEMORY[0x277D85DE8];
}

void __98__HMDHomeManager__fetchHomeDataFromCloudWithCloudConflict_forceFetch_withDelay_accountCompletion___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v11 = a2;
  v7 = a3;
  if (!a4)
  {
    WeakRetained = objc_loadWeakRetained((a1 + 40));
    if (WeakRetained)
    {
      [WeakRetained _runFetchHomeDataFromCloudWithCloudConflict:objc_msgSend(v7 forceFetch:"isCloudConflict") accountCompletion:*(a1 + 48) syncCompletion:{*(a1 + 32), v11}];
    }

    goto LABEL_8;
  }

  v8 = *(a1 + 32);
  if (v8)
  {
    v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23];
    (*(v8 + 16))(v8, 0, 0, v9);
  }

  if (v11)
  {
    WeakRetained = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    v11[2](v11, WeakRetained);
LABEL_8:
  }
}

- (void)fetchHomeDataFromCloudWithCloudConflict:(BOOL)a3 withDelay:(double)a4
{
  objc_initWeak(&location, self);
  v7 = [(HMDHomeManager *)self workQueue];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __68__HMDHomeManager_fetchHomeDataFromCloudWithCloudConflict_withDelay___block_invoke;
  v8[3] = &unk_279731BC0;
  objc_copyWeak(v9, &location);
  v10 = a3;
  v9[1] = *&a4;
  dispatch_async(v7, v8);

  objc_destroyWeak(v9);
  objc_destroyWeak(&location);
}

void __68__HMDHomeManager_fetchHomeDataFromCloudWithCloudConflict_withDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _fetchHomeDataFromCloudWithCloudConflict:*(a1 + 48) forceFetch:0 withDelay:0 accountCompletion:*(a1 + 40)];
    WeakRetained = v3;
  }
}

- (void)verifyHomeDataFromCloud:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __42__HMDHomeManager_verifyHomeDataFromCloud___block_invoke;
  block[3] = &unk_279731EB8;
  objc_copyWeak(&v9, &location);
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, block);

  objc_destroyWeak(&v9);
  objc_destroyWeak(&location);
}

void __42__HMDHomeManager_verifyHomeDataFromCloud___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _fetchHomeDataFromCloudWithCloudConflict:0 forceFetch:0 withDelay:*(a1 + 32) accountCompletion:0.0];
    WeakRetained = v3;
  }
}

- (void)_fetchDataFromCloud
{
  v29 = *MEMORY[0x277D85DE8];
  if ((disableCloudDataSync & 1) == 0)
  {
    v3 = +[HMDDeviceCapabilities deviceCapabilities];
    if ([v3 supportsCloudDataSync])
    {
      objc_initWeak(&location, self);
      v4 = [(HMDHomeManager *)self cloudDataSyncManager];
      v22[0] = MEMORY[0x277D85DD0];
      v22[1] = 3221225472;
      v22[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke;
      v22[3] = &unk_279732FD8;
      objc_copyWeak(&v23, &location);
      [v4 setCloudDataDeletedNotificationBlock:v22];

      v5 = [(HMDHomeManager *)self cloudDataSyncManager];
      v20[0] = MEMORY[0x277D85DD0];
      v20[1] = 3221225472;
      v20[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke_934;
      v20[3] = &unk_279732FD8;
      objc_copyWeak(&v21, &location);
      [v5 setCloudMetadataDeletedNotificationBlock:v20];

      v6 = [(HMDHomeManager *)self cloudDataSyncManager];
      v18[0] = MEMORY[0x277D85DD0];
      v18[1] = 3221225472;
      v18[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke_935;
      v18[3] = &unk_279732FD8;
      objc_copyWeak(&v19, &location);
      [v6 setControllerKeyAvailableNotificationBlock:v18];

      v7 = [(HMDHomeManager *)self cloudDataSyncManager];
      v16[0] = MEMORY[0x277D85DD0];
      v16[1] = 3221225472;
      v16[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke_936;
      v16[3] = &unk_279732FD8;
      objc_copyWeak(&v17, &location);
      [v7 setDataDecryptionFailedHandler:v16];

      v8 = [(HMDHomeManager *)self activeAccountIdentifier];
      v9 = objc_autoreleasePoolPush();
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543618;
        v26 = v11;
        v27 = 2112;
        v28 = v8;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Current user account identifier is %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v9);
      [(HMDHomeManager *)self _updateCloudDataSyncWithAccountState:v8 != 0];
      v12 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
      [v12 updateiCloudAccountActive:v8 != 0];

      objc_destroyWeak(&v17);
      objc_destroyWeak(&v19);
      objc_destroyWeak(&v21);
      objc_destroyWeak(&v23);
      objc_destroyWeak(&location);
    }

    else
    {
      v13 = [(HMDHomeManager *)self activeAccountIdentifier];
      v14 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
      [v14 updateiCloudAccountActive:v13 != 0];
    }
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = WeakRetained;
  if (WeakRetained)
  {
    v3 = [WeakRetained workQueue];
    v4[0] = MEMORY[0x277D85DD0];
    v4[1] = 3221225472;
    v4[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke_2;
    v4[3] = &unk_279734468;
    v4[4] = v2;
    [v2 _eraseLocalHomeConfigurationAndDeleteMetadata:0 completionQueue:v3 completion:v4];
  }
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke_934(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v2 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained _eraseLocalMetadata];
    v3 = objc_autoreleasePoolPush();
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      v7 = 138543362;
      v8 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Cloud data was deleted, deleted local metadata", &v7, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
  }

  v6 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke_935(uint64_t a1)
{
  v8 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
    {
      v4 = HMFGetLogIdentifier();
      v6 = 138543362;
      v7 = v4;
      _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Received notification that controller key is available", &v6, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    [WeakRetained _handleControllerKeyAvailable];
  }

  v5 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke_936(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = WeakRetained;
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
    {
      v5 = HMFGetLogIdentifier();
      *buf = 138543362;
      v10 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Decryption failed. Cancelling operations in queue.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    v6 = [v3 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __37__HMDHomeManager__fetchDataFromCloud__block_invoke_937;
    block[3] = &unk_279735D00;
    block[4] = v3;
    dispatch_async(v6, block);
  }

  v7 = *MEMORY[0x277D85DE8];
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke_937(uint64_t a1)
{
  v1 = [*(a1 + 32) syncManager];
  [v1 cancelOperations];
}

void __37__HMDHomeManager__fetchDataFromCloud__block_invoke_2(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  [*(a1 + 32) updateAccountAvailabilityChanged:0];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v4;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Cloud data was deleted, deleted local home data, posting Key Transfer Reset Timer Notification.", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v5 = [*(a1 + 32) notificationCenter];
  [v5 postNotificationName:@"HMDHomeManagerKeyTransferResetTimerNotification" object:0];

  v6 = *MEMORY[0x277D85DE8];
}

- (void)_postMergeWatchPush
{
  v78 = *MEMORY[0x277D85DE8];
  if (isiOSDevice())
  {
    v3 = MEMORY[0x277CBEB18];
    v4 = [(HMDHomeManager *)self associatedWatchPeers];
    v49 = [v3 arrayWithCapacity:{objc_msgSend(v4, "count")}];

    v5 = MEMORY[0x277CBEB18];
    v6 = [(HMDHomeManager *)self associatedWatchPeers];
    v48 = [v5 arrayWithCapacity:{objc_msgSend(v6, "count")}];

    v7 = MEMORY[0x277CBEB58];
    v8 = [(HMDHomeManager *)self homes];
    v51 = [v7 setWithCapacity:{objc_msgSend(v8, "count")}];

    v66 = 0u;
    v67 = 0u;
    v64 = 0u;
    v65 = 0u;
    v9 = [(HMDHomeManager *)self homes];
    v10 = [v9 countByEnumeratingWithState:&v64 objects:v77 count:16];
    if (v10)
    {
      v11 = v10;
      v12 = *v65;
      do
      {
        v13 = 0;
        do
        {
          if (*v65 != v12)
          {
            objc_enumerationMutation(v9);
          }

          v14 = [*(*(&v64 + 1) + 8 * v13) uuid];
          [v51 addObject:v14];

          ++v13;
        }

        while (v11 != v13);
        v11 = [v9 countByEnumeratingWithState:&v64 objects:v77 count:16];
      }

      while (v11);
    }

    v62 = 0u;
    v63 = 0u;
    v60 = 0u;
    v61 = 0u;
    obj = [(HMDHomeManager *)self associatedWatchPeers];
    v15 = [obj countByEnumeratingWithState:&v60 objects:v76 count:16];
    if (v15)
    {
      v17 = v15;
      v18 = *v61;
      *&v16 = 138543874;
      v47 = v16;
      do
      {
        v19 = 0;
        do
        {
          if (*v61 != v18)
          {
            objc_enumerationMutation(obj);
          }

          v20 = *(*(&v60 + 1) + 8 * v19);
          v21 = [(HMDHomeManager *)self associatedWatchPeers];
          v22 = [v21 objectForKeyedSubscript:v20];

          v23 = MEMORY[0x277CBEB58];
          v24 = [v22 homeConfig];
          v25 = [v24 allKeys];
          v26 = [v23 setWithArray:v25];

          [v26 minusSet:v51];
          if ([v26 count])
          {
            v27 = objc_autoreleasePoolPush();
            v28 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
            {
              v29 = HMFGetLogIdentifier();
              *buf = v47;
              v71 = v29;
              v72 = 2112;
              v73 = v20;
              v74 = 2112;
              v75 = v26;
              _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Complete sync to watch %@ is required because the following homes have been removed: %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v27);
            v30 = [(HMDHomeManager *)self watchManager];
            v31 = [v30 connectedWatchFromDeviceID:v20];

            if (v31)
            {
              [v49 addObject:v31];
            }
          }

          else
          {
            [v48 addObject:v20];
          }

          ++v19;
        }

        while (v17 != v19);
        v17 = [obj countByEnumeratingWithState:&v60 objects:v76 count:16];
      }

      while (v17);
    }

    if ([v49 count])
    {
      v32 = [(HMDHomeManager *)self watchPushDelayTimer];
      [v32 suspend];

      v33 = objc_autoreleasePoolPush();
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_DEFAULT))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543362;
        v71 = v35;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_DEFAULT, "%{public}@Removing scheduled watch push delay and pushing immediately", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v33);
      v58 = 0u;
      v59 = 0u;
      v56 = 0u;
      v57 = 0u;
      v36 = v48;
      v37 = [v36 countByEnumeratingWithState:&v56 objects:v69 count:16];
      if (v37)
      {
        v38 = v37;
        v39 = *v57;
        do
        {
          v40 = 0;
          do
          {
            if (*v57 != v39)
            {
              objc_enumerationMutation(v36);
            }

            [(HMDHomeManager *)self _sendHomeDataToWatch:*(*(&v56 + 1) + 8 * v40++) completionHandler:0];
          }

          while (v38 != v40);
          v38 = [v36 countByEnumeratingWithState:&v56 objects:v69 count:16];
        }

        while (v38);
      }

      [(HMDHomeManager *)self _checkAndAddWatchDevices:v49 resend:1 requestFromWatch:0];
      v54 = 0u;
      v55 = 0u;
      v52 = 0u;
      v53 = 0u;
      v41 = [(HMDHomeManager *)self homes];
      v42 = [v41 countByEnumeratingWithState:&v52 objects:v68 count:16];
      if (v42)
      {
        v43 = v42;
        v44 = *v53;
        do
        {
          v45 = 0;
          do
          {
            if (*v53 != v44)
            {
              objc_enumerationMutation(v41);
            }

            [*(*(&v52 + 1) + 8 * v45++) setWatchSkipVersionCheck:0];
          }

          while (v43 != v45);
          v43 = [v41 countByEnumeratingWithState:&v52 objects:v68 count:16];
        }

        while (v43);
      }
    }

    else
    {
      [(HMDHomeManager *)self _scheduleSendHomeDataToAllWatches];
    }
  }

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_checkForAccountChanged
{
  v27 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self activeAccountIdentifier];
  v4 = [MEMORY[0x277CFEC78] systemStore];
  v19 = 0;
  v20 = 0;
  v18 = 0;
  v5 = [v4 getCurrentiCloudIdentifier:&v20 controllerPairingIdentifier:&v19 error:&v18];
  v6 = v20;
  v7 = v19;
  v8 = v18;
  if (v5 && [v6 length] && objc_msgSend(v7, "length") && objc_msgSend(v3, "length"))
  {
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543874;
      v22 = v11;
      v23 = 2112;
      v24 = v3;
      v25 = 2112;
      v26 = v6;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Checking for account changed on bootup, current account identifier %@, last known account identifier %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v9);
    if (([v6 isEqualToIgnoringCase:v3] & 1) == 0 && (objc_msgSend(v6, "isEqualToString:", @"__HomeKit_NoAccount_Identifier__") & 1) == 0)
    {
      v12 = objc_autoreleasePoolPush();
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        *buf = 138543618;
        v22 = v14;
        v23 = 2112;
        v24 = v7;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Current account is different since the last time known, removing controller key for identifier %@ and deleting local home data", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v12);
      v17 = v8;
      [v4 removeControllerKeyPairForIdentifier:v7 leaveTombstone:0 error:&v17];
      v15 = v17;

      [(HMDHomeManager *)self _eraseLocalHomeConfiguration];
      v8 = v15;
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (id)mediaSystemForAppleMediaAccessory:(id)a3
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) mediaSystemForAppleMediaAccessory:v4];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (id)destinationIdentifierForMediaSystem:(id)a3 role:(unint64_t)a4
{
  v45 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v34 = 0u;
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  v7 = [v6 components];
  v8 = [v7 countByEnumeratingWithState:&v34 objects:v44 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v35;
LABEL_3:
    v11 = 0;
    while (1)
    {
      if (*v35 != v10)
      {
        objc_enumerationMutation(v7);
      }

      v12 = *(*(&v34 + 1) + 8 * v11);
      v13 = [v12 role];
      v14 = [v13 type];

      if (v14 == a4)
      {
        break;
      }

      if (v9 == ++v11)
      {
        v9 = [v7 countByEnumeratingWithState:&v34 objects:v44 count:16];
        if (v9)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }

    v15 = v12;

    if (!v15)
    {
      goto LABEL_16;
    }

    v16 = [v15 accessory];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v17 = v16;
    }

    else
    {
      v17 = 0;
    }

    v18 = v17;

    v19 = [v18 audioDestination];
    v20 = [v19 uniqueIdentifier];

    if (v20)
    {
      v21 = v20;
    }

    else
    {
      v28 = objc_autoreleasePoolPush();
      v29 = self;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
      {
        v31 = HMFGetLogIdentifier();
        *buf = 138543874;
        v39 = v31;
        v40 = 2112;
        v41 = v15;
        v42 = 2112;
        v43 = v18;
        _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to get destination identifier on component: %@ accessory: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v28);
    }
  }

  else
  {
LABEL_9:

LABEL_16:
    v22 = objc_autoreleasePoolPush();
    v23 = self;
    v24 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
    {
      v25 = HMFGetLogIdentifier();
      v26 = HMMediaSystemRoleTypeAsString();
      v27 = [v6 components];
      *buf = 138543874;
      v39 = v25;
      v40 = 2112;
      v41 = v26;
      v42 = 2112;
      v43 = v27;
      _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_ERROR, "%{public}@Failed to get destination identifier due to no component with role: %@ components: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v22);
    v20 = 0;
  }

  v32 = *MEMORY[0x277D85DE8];

  return v20;
}

- (void)saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 home];
  v6 = [v5 uuid];

  v7 = [(HMDHomeManager *)self userDefaults];
  v8 = v7;
  if (v6 && v7)
  {
    v9 = [HMDMediaGroupsStageManager alloc];
    v10 = [(HMDHomeManager *)self userDefaults];
    v11 = [(HMDMediaGroupsStageManager *)v9 initWithIdentifier:v6 userDefaults:v10];

    [(HMDMediaGroupsStageManager *)v11 saveAssociatedGroupDataForLegacyCurrentAccessory:v4];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      v17 = 138543874;
      v18 = v15;
      v19 = 2112;
      v20 = v6;
      v21 = 2112;
      v22 = v8;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Failed to save associated group data due to missing homeUUID: %@ userDefaults: %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalStereoPairDataForCurrentMediaSystem:(id)a3
{
  v45 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543618;
    v38 = v8;
    v39 = 2112;
    v40 = v4;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Migrating current media system: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [v4 configuredName];
  v10 = v9;
  if (v9)
  {
    v11 = v9;
  }

  else
  {
    v11 = [MEMORY[0x277CD1C08] roomNameSentinel];
  }

  v12 = v11;
  v13 = [v4 audioDestination];
  v14 = [v13 audioGroupIdentifier];

  v15 = [(HMDHomeManager *)v6 destinationIdentifierForMediaSystem:v4 role:1];
  v16 = [(HMDHomeManager *)v6 destinationIdentifierForMediaSystem:v4 role:2];
  v17 = [v4 home];
  v18 = [v17 uuid];

  if (v15 && v16 && v18)
  {
    v34 = v14;
    v19 = v12;
    v20 = objc_alloc(MEMORY[0x277CD1C08]);
    v21 = [v4 uuid];
    v22 = [v20 initWithIdentifier:v21 parentIdentifier:v18 name:v12 defaultName:v10 == 0 associatedGroupIdentifier:v34 leftDestinationIdentifier:v15 rightDestinationIdentifier:v16];

    v23 = [(HMDHomeManager *)v6 mediaGroupParticipantDataLocalStorage];
    v24 = [v4 uuid];
    [v23 updateAudioGroupIdentifier:v24];

    v25 = [(HMDHomeManager *)v6 mediaGroupParticipantDataLocalStorage];
    v26 = [v22 encodeToProtoBufferData];
    v36 = v26;
    v27 = [MEMORY[0x277CBEA60] arrayWithObjects:&v36 count:1];
    [v25 updateBackupGroupData:v27];

    v12 = v19;
    v14 = v34;
  }

  else
  {
    v28 = objc_autoreleasePoolPush();
    v29 = v6;
    v30 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      HMFGetLogIdentifier();
      v35 = v14;
      v32 = v31 = v12;
      *buf = 138544130;
      v38 = v32;
      v39 = 2112;
      v40 = v15;
      v41 = 2112;
      v42 = v16;
      v43 = 2112;
      v44 = v18;
      _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Failed to migrate current media system due to missing group data dependencies leftDestinationIdentifier: %@ rightDestinationIdentifier: %@ homeIdentifier: %@", buf, 0x2Au);

      v12 = v31;
      v14 = v35;
    }

    objc_autoreleasePoolPop(v28);
  }

  v33 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalHomeTheaterDataForCurrentAccessory:(id)a3 currentMediaSystem:(id)a4
{
  v28 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 audioDestinationControllerData];
  if (v8)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
    {
      v12 = HMFGetLogIdentifier();
      v24 = 138543618;
      v25 = v12;
      v26 = 2112;
      v27 = v8;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Migrating current destination controller data: %@", &v24, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
    v13 = [(HMDHomeManager *)v10 mediaGroupParticipantDataLocalStorage];
    [v13 updateDestinationControllerData:v8];
  }

  v14 = [v6 audioDestination];
  v15 = [v14 mutableCopy];

  if (v15)
  {
    v16 = [v7 uuid];
    if (v16)
    {
      [v15 setAudioGroupIdentifier:v16];
    }

    else
    {
      v17 = [v15 audioGroupIdentifier];
      [v15 setAudioGroupIdentifier:v17];
    }

    v18 = objc_autoreleasePoolPush();
    v19 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      v24 = 138543618;
      v25 = v21;
      v26 = 2112;
      v27 = v15;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Migrating current destination: %@", &v24, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
    v22 = [(HMDHomeManager *)v19 mediaGroupParticipantDataLocalStorage];
    [v22 updateMediaDestination:v15];
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)migrateLocalMediaGroupParticipantData
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self _appleMediaAccessoryOfCurrentDevice];
  if (v3)
  {
    v4 = [(HMDHomeManager *)self mediaSystemForAppleMediaAccessory:v3];
    v5 = objc_autoreleasePoolPush();
    v6 = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Migrating local media group participant data for current accessory: %@", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [(HMDHomeManager *)v6 migrateLocalHomeTheaterDataForCurrentAccessory:v3 currentMediaSystem:v4];
    if (v4)
    {
      [(HMDHomeManager *)v6 migrateLocalStereoPairDataForCurrentMediaSystem:v4];
    }

    [(HMDHomeManager *)v6 saveAssociatedGroupDataForPostMigrationStagingWithCurrentAccessory:v3];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)initializeMediaGroupParticipantDataLocalStorage
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self uuid];
  v4 = [(HMDHomeManager *)self userDefaults];
  v5 = [(HMDHomeManager *)self eventForwarder];
  v6 = [(HMDHomeManager *)self eventStoreReadHandle];
  v7 = v6;
  if (v3 && v4 && v5 && v6)
  {
    v8 = objc_alloc_init(HMDMediaGroupsAggregatorBackupReceiver);
    v9 = [[HMDMediaGroupParticipantLocalDataStorage alloc] initWithIdentifier:v3 backUpReciever:v8 userDefaults:v4 eventForwarder:v5 eventStoreReadHandle:v7];
    [(HMDMediaGroupsAggregatorBackupReceiver *)v8 setDelegate:v9];
    [(HMDMediaGroupParticipantLocalDataStorage *)v9 setDataSource:self];
    [(HMDMediaGroupParticipantLocalDataStorage *)v9 setDelegate:self];
    mediaGroupParticipantDataLocalStorage = self->_mediaGroupParticipantDataLocalStorage;
    self->_mediaGroupParticipantDataLocalStorage = v9;
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v16 = 138544386;
      v17 = v14;
      v18 = 2112;
      v19 = v3;
      v20 = 2112;
      v21 = v4;
      v22 = 2112;
      v23 = v5;
      v24 = 2112;
      v25 = v7;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to configure media group participant data local storage with dependencies homeManagerUUID: %@ userDefaults: %@ eventForwarder: %@ eventStoreReadHandle: %@", &v16, 0x34u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (BOOL)_configureHomesImpl:(id)a3 uncommittedTransactions:(id)a4
{
  v82 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v68 = a4;
  [(HMDHomeManager *)self setHomes:v6];
  v7 = [HMDNameValidator alloc];
  v8 = [(HMDHomeManager *)self uuid];
  v9 = [(HMDNameValidator *)v7 initWithUUID:v8];
  [(HMDHomeManager *)self setNameValidator:v9];

  v10 = [(HMDHomeManager *)self notificationCenter];
  [v10 removeObserver:self name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:0];

  v67 = [MEMORY[0x277CBEB18] array];
  v63 = [(HMDHomeManager *)self isResidentEnabled];
  v71 = 0u;
  v72 = 0u;
  v73 = 0u;
  v74 = 0u;
  obj = v6;
  v11 = [obj countByEnumeratingWithState:&v71 objects:v81 count:16];
  if (!v11)
  {
    LOBYTE(v14) = 0;
    goto LABEL_35;
  }

  v13 = v11;
  v14 = 0;
  v15 = *v72;
  *&v12 = 138543618;
  v62 = v12;
  v65 = self;
  do
  {
    v16 = 0;
    do
    {
      if (*v72 != v15)
      {
        objc_enumerationMutation(obj);
      }

      v17 = *(*(&v71 + 1) + 8 * v16);
      v18 = objc_autoreleasePoolPush();
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v70 = v18;
        v19 = v17;
        v20 = objc_autoreleasePoolPush();
        v21 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
        {
          HMFGetLogIdentifier();
          v22 = v13;
          v23 = v15;
          v25 = v24 = v14;
          v26 = [v19 name];
          v27 = [v19 ownerName];
          *buf = 138543874;
          v76 = v25;
          v77 = 2112;
          v78 = v26;
          v79 = 2112;
          v80 = v27;
          _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Found home %@ with administrator %@", buf, 0x20u);

          v14 = v24;
          v15 = v23;
          v13 = v22;
          self = v65;
        }

        objc_autoreleasePoolPop(v20);
        v28 = [(HMDHomeManager *)self nameValidator];
        v29 = [v19 uuid];
        v30 = [v28 addNamespace:v29];

        v14 |= [v19 configureWithHomeManager:self accessoriesPresent:v67 uncommittedTransactions:v68 source:0];
        v31 = [v19 name];
        v32 = [(HMDHomeManager *)self uuid];
        v33 = [(HMDHomeManager *)self addName:v31 namespace:v32];

        v34 = [v19 uuid];
        -[HMDHomeManager _updateHome:configurationVersion:](self, "_updateHome:configurationVersion:", v34, [v19 configurationVersion]);

        if ([v19 isOwnerUser] && (+[HMDDeviceCapabilities deviceCapabilities](HMDDeviceCapabilities, "deviceCapabilities"), v35 = objc_claimAutoreleasedReturnValue(), v36 = objc_msgSend(v35, "isResidentCapable"), v35, v36))
        {
          v66 = v14;
          v37 = [(HMDHomeManager *)self notificationCenter];
          [v37 addObserver:self selector:sel_handleHomeCurrentDeviceResidentEligibleNotification_ name:@"HMDHomeCurrentDeviceHasReachableAccessories" object:v19];

          v38 = [(HMDHomeManager *)self appleAccountManager];
          v39 = [v38 device];

          v40 = [(HMDHomeManager *)self capabilitiesController];
          v41 = [v40 currentResidentCapabilities];
          if (v41 && [(HMDHomeManager *)self isResidentEnabled])
          {
            v42 = [v19 hasReachableAccessories];

            if (v42)
            {
              v43 = [v19 residentCapableDevices];
              v44 = v39;
              v45 = [v43 containsObject:v39];

              v14 = v66;
              if ((v45 & 1) == 0)
              {
                [v19 addResidentCapableDevice:v44];
                context = objc_autoreleasePoolPush();
                v46 = HMFGetOSLogHandle();
                v66 = 1;
                if (os_log_type_enabled(&v46->super.super, OS_LOG_TYPE_INFO))
                {
                  v47 = HMFGetLogIdentifier();
                  v48 = [v44 name];
                  v49 = [v19 name];
                  *buf = 138543874;
                  v76 = v47;
                  v77 = 2112;
                  v78 = v48;
                  v79 = 2112;
                  v80 = v49;
                  v66 = 1;
                  _os_log_impl(&dword_2531F8000, &v46->super.super, OS_LOG_TYPE_INFO, "%{public}@Configuration changed: add resident capable device %@ to %@", buf, 0x20u);
                }

                goto LABEL_25;
              }

              goto LABEL_26;
            }
          }

          else
          {
          }

          v14 = v66;
          if ([(HMDHomeManager *)self isResidentEnabled])
          {
            v44 = v39;
            goto LABEL_26;
          }

          v50 = [v19 residentCapableDevices];
          v44 = v39;
          v51 = [v50 containsObject:v39];

          if (v51)
          {
            context = objc_autoreleasePoolPush();
            v46 = self;
            v52 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v52, OS_LOG_TYPE_INFO))
            {
              v53 = HMFGetLogIdentifier();
              *buf = v62;
              v76 = v53;
              v77 = 2112;
              v78 = v19;
              _os_log_impl(&dword_2531F8000, v52, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in home, %@, enabling ourselves as a resident device", buf, 0x16u);
            }

            v63 = 1;
LABEL_25:
            v18 = v70;

            objc_autoreleasePoolPop(context);
            v14 = v66;
          }

          else
          {
LABEL_26:
            v18 = v70;
          }
        }

        else
        {
          v18 = v70;
        }
      }

      objc_autoreleasePoolPop(v18);
      ++v16;
    }

    while (v13 != v16);
    v54 = [obj countByEnumeratingWithState:&v71 objects:v81 count:16];
    v13 = v54;
  }

  while (v54);
LABEL_35:

  v55 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v56 = [(HMDHomeManager *)self homes];
  [v55 updateTotalHomes:{objc_msgSend(v56, "count")}];

  v57 = [(HMDHomeManager *)self isResidentEnabled];
  v58 = v63;
  if (v58 != v57)
  {
    [(HMDHomeManager *)self _updateResidentEnabledOnThisDevice:v58 forceNotify:0 message:0];
  }

  v59 = [(HMDHomeManager *)self idsServerBag];
  [v59 configure];

  v60 = *MEMORY[0x277D85DE8];
  return v14 & 1;
}

- (BOOL)_configureHomes:(id)a3 uncommittedTransactions:(id)a4
{
  v25 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  [(HMDHomeManager *)self startLocalTransport];
  v8 = dispatch_group_create();
  dispatch_group_enter(v8);
  v9 = +[HMDLocation sharedManager];
  v19[0] = MEMORY[0x277D85DD0];
  v19[1] = 3221225472;
  v19[2] = __58__HMDHomeManager__configureHomes_uncommittedTransactions___block_invoke;
  v19[3] = &unk_279735D00;
  v10 = v8;
  v20 = v10;
  [v9 beingConfigured:1 completionHandler:v19];

  dispatch_group_wait(v10, 0xFFFFFFFFFFFFFFFFLL);
  v11 = [(HMDHomeManager *)self _configureHomesImpl:v6 uncommittedTransactions:v7];
  v12 = objc_autoreleasePoolPush();
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v15 = HMFBooleanToString();
    *buf = 138543618;
    v22 = v14;
    v23 = 2112;
    v24 = v15;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Configured homes with result: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  v16 = +[HMDLocation sharedManager];
  [v16 beingConfigured:0 completionHandler:0];

  v17 = *MEMORY[0x277D85DE8];
  return v11;
}

- (id)_checkActionSetNameConflict:(id)a3 withNamespaceUUIDs:(id)a4
{
  v40 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self nameValidator];
  v25 = v6;
  v9 = [v8 despaceName:v6];

  v36 = 0u;
  v37 = 0u;
  v34 = 0u;
  v35 = 0u;
  obj = v7;
  v28 = [obj countByEnumeratingWithState:&v34 objects:v39 count:16];
  if (!v28)
  {
    v21 = 0;
    goto LABEL_24;
  }

  v27 = *v35;
  while (2)
  {
    for (i = 0; i != v28; ++i)
    {
      if (*v35 != v27)
      {
        objc_enumerationMutation(obj);
      }

      v11 = [(HMDHomeManager *)self _homeWithUUID:*(*(&v34 + 1) + 8 * i)];
      if (!v11)
      {
        v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:2];
        v22 = 0;
LABEL_23:

        goto LABEL_24;
      }

      v32 = 0u;
      v33 = 0u;
      v30 = 0u;
      v31 = 0u;
      v29 = v11;
      v12 = [v11 actionSets];
      v13 = [v12 countByEnumeratingWithState:&v30 objects:v38 count:16];
      if (v13)
      {
        v14 = v13;
        v15 = *v31;
LABEL_9:
        v16 = 0;
        while (1)
        {
          if (*v31 != v15)
          {
            objc_enumerationMutation(v12);
          }

          v17 = *(*(&v30 + 1) + 8 * v16);
          v18 = [(HMDHomeManager *)self nameValidator];
          v19 = [v17 name];
          v20 = [v18 despaceName:v19];

          if ([v9 isEqualToString:v20])
          {
            break;
          }

          if (v14 == ++v16)
          {
            v14 = [v12 countByEnumeratingWithState:&v30 objects:v38 count:16];
            if (v14)
            {
              goto LABEL_9;
            }

            goto LABEL_15;
          }
        }

        v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:31];

        if (!v21)
        {
          goto LABEL_17;
        }

        v22 = v29;
        goto LABEL_23;
      }

LABEL_15:

LABEL_17:
    }

    v21 = 0;
    v28 = [obj countByEnumeratingWithState:&v34 objects:v39 count:16];
    if (v28)
    {
      continue;
    }

    break;
  }

LABEL_24:

  v23 = *MEMORY[0x277D85DE8];

  return v21;
}

- (id)_checkNameConflict:(id)a3 withNamespaceUUIDs:(id)a4
{
  v22 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v17 = 0u;
  v18 = 0u;
  v19 = 0u;
  v20 = 0u;
  v7 = a4;
  v8 = [v7 countByEnumeratingWithState:&v17 objects:v21 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v18;
LABEL_3:
    v11 = 0;
    while (1)
    {
      if (*v18 != v10)
      {
        objc_enumerationMutation(v7);
      }

      v12 = *(*(&v17 + 1) + 8 * v11);
      v13 = [(HMDHomeManager *)self nameValidator];
      v14 = [v13 checkForConflict:v6 namespace:v12];

      if (v14)
      {
        break;
      }

      if (v9 == ++v11)
      {
        v9 = [v7 countByEnumeratingWithState:&v17 objects:v21 count:16];
        if (v9)
        {
          goto LABEL_3;
        }

        goto LABEL_9;
      }
    }
  }

  else
  {
LABEL_9:
    v14 = 0;
  }

  v15 = *MEMORY[0x277D85DE8];

  return v14;
}

- (void)stopLocalTransport
{
  v10 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    v5 = HMFGetLogIdentifier();
    v8 = 138543362;
    v9 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEBUG, "%{public}@Stopping local transport", &v8, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v6 = [(HMDHomeManager *)self messageDispatcher];
  [v6 configureHTTPTransport:0];

  v7 = *MEMORY[0x277D85DE8];
}

- (void)startLocalTransport
{
  v18 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self appleAccountManager];
  v4 = [v3 device];

  if (v4)
  {
    v5 = [HMDHTTPDevice alloc];
    v6 = [v4 identifier];
    v7 = [(HMDHTTPDevice *)v5 initWithIdentifier:v6];

    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEBUG))
    {
      v10 = HMFGetLogIdentifier();
      v14 = 138543618;
      v15 = v10;
      v16 = 2112;
      v17 = v7;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEBUG, "%{public}@Starting local transport for %@", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    if ([(HMDHomeManager *)self isResidentEnabled])
    {
      v11 = [(HMDHomeManager *)self messageDispatcher];
      [v11 enableMessageServer];
    }

    v12 = [(HMDHomeManager *)self messageDispatcher];
    [v12 configureHTTPTransport:v7];
  }

  v13 = *MEMORY[0x277D85DE8];
}

- (id)messageDestination
{
  v3 = objc_alloc(MEMORY[0x277D0F820]);
  v4 = [(HMDHomeManager *)self messageTargetUUID];
  v5 = [v3 initWithTarget:v4];

  return v5;
}

- (void)accessoriesAreLocallyReachableOnTransientDevice:(BOOL)a3 forHome:(id)a4
{
  v6 = a4;
  v7 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __74__HMDHomeManager_accessoriesAreLocallyReachableOnTransientDevice_forHome___block_invoke;
  block[3] = &unk_279734938;
  v11 = a3;
  block[4] = self;
  v10 = v6;
  v8 = v6;
  dispatch_async(v7, block);
}

- (void)_setUniqueDeviceIdSalt:(id)a3
{
  v11 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v7;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Saving the device identifier salt", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)self _setHomeConfigurationKey:@"kUniqueDeviceIdentifierSaltkey" value:v4 applicationIdentifier:*MEMORY[0x277CD0028]];

  v8 = *MEMORY[0x277D85DE8];
}

- (BOOL)_updateAccessoriesConfigured
{
  v122 = *MEMORY[0x277D85DE8];
  if (![(HMDHomeManager *)self hasLoadedData])
  {
    v24 = 0;
    goto LABEL_104;
  }

  v114 = 0u;
  v115 = 0u;
  v112 = 0u;
  v113 = 0u;
  v99 = self;
  obj = [(HMDHomeManager *)self homes];
  v102 = [obj countByEnumeratingWithState:&v112 objects:v121 count:16];
  if (!v102)
  {
    v106 = 0;
    v107 = 0;
    v3 = 0;
    v104 = 0;
    v4 = 0;
    goto LABEL_46;
  }

  v106 = 0;
  v107 = 0;
  v3 = 0;
  v104 = 0;
  v4 = 0;
  v101 = *v113;
  do
  {
    for (i = 0; i != v102; ++i)
    {
      if (*v113 != v101)
      {
        objc_enumerationMutation(obj);
      }

      v6 = *(*(&v112 + 1) + 8 * i);
      v108 = 0u;
      v109 = 0u;
      v110 = 0u;
      v111 = 0u;
      v105 = v6;
      v7 = [v6 accessories];
      v8 = [v7 countByEnumeratingWithState:&v108 objects:v120 count:16];
      if (v8)
      {
        v9 = v8;
        v103 = i;
        v10 = *v109;
        while (1)
        {
          for (j = 0; j != v9; ++j)
          {
            if (*v109 != v10)
            {
              objc_enumerationMutation(v7);
            }

            v12 = *(*(&v108 + 1) + 8 * j);
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v13 = v12;
            }

            else
            {
              v13 = 0;
            }

            v14 = v13;

            if (v14)
            {
              v15 = v12;
              objc_opt_class();
              if (objc_opt_isKindOfClass())
              {
                v16 = v15;
              }

              else
              {
                v16 = 0;
              }

              v17 = v16;

              if ([v17 isHomePod])
              {
                v18 = [v17 homePodVariant];
                if (v18 > 1)
                {
                  if (v18 == 2)
                  {
                    LOBYTE(v104) = 1;
                    goto LABEL_31;
                  }

                  if (v18 != 3)
                  {
                    goto LABEL_31;
                  }
                }

                else if (v18)
                {
                  if (v18 == 1)
                  {
                    v19 = 1;
                  }

                  else
                  {
                    v19 = v106;
                  }

                  LODWORD(v106) = v19;
LABEL_31:
                  if ([v17 requiresHomeAppForManagement])
                  {
                    HIDWORD(v106) |= [v105 isOwnerUser];
                  }

                  LOBYTE(v107) = 1;
LABEL_34:

                  goto LABEL_35;
                }

                BYTE4(v104) = 1;
                goto LABEL_31;
              }

              HIDWORD(v107) |= [v17 isAppleTV];
              goto LABEL_34;
            }

LABEL_35:
            v20 = v12;
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v21 = v20;
            }

            else
            {
              v21 = 0;
            }

            v22 = v21;

            v23 = [v22 hasTelevisionService];
            v3 |= v23;
          }

          v9 = [v7 countByEnumeratingWithState:&v108 objects:v120 count:16];
          if (!v9)
          {
            v4 = 1;
            i = v103;
            break;
          }
        }
      }
    }

    v102 = [obj countByEnumeratingWithState:&v112 objects:v121 count:16];
  }

  while (v102);
LABEL_46:

  v24 = v107 ^ HMHomeManagerAreAnySpeakersConfigured();
  if (v24)
  {
    v25 = objc_autoreleasePoolPush();
    v26 = v99;
    v27 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
    {
      v28 = HMFGetLogIdentifier();
      v29 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v28;
      v118 = 2112;
      v119 = v29;
      _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for speakers configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v25);
    v30 = MEMORY[0x277CBED10];
    if (v107)
    {
      v30 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v26 _setHomeConfigurationKey:*MEMORY[0x277CD26C0] value:*v30];
    v31 = objc_autoreleasePoolPush();
    v32 = v26;
    v33 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v33, OS_LOG_TYPE_DEFAULT))
    {
      v34 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v34;
      _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_DEFAULT, "%{public}@Posting speakers configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v31);
    v35 = [(HMDHomeManager *)v32 darwinNotificationProvider];
    [v35 notifyPost:*MEMORY[0x277CD0390]];
  }

  if ((v104 & 1) != areAnyHomePodMiniConfigured())
  {
    v36 = objc_autoreleasePoolPush();
    v37 = v99;
    v38 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
    {
      v39 = HMFGetLogIdentifier();
      v40 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v39;
      v118 = 2112;
      v119 = v40;
      _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for HomePod Mini configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v36);
    v41 = MEMORY[0x277CBED10];
    if (v104)
    {
      v41 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v37 _setHomeConfigurationKey:*MEMORY[0x277CD04C8] value:*v41];
    v42 = objc_autoreleasePoolPush();
    v43 = v37;
    v44 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v44, OS_LOG_TYPE_DEFAULT))
    {
      v45 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v45;
      _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_DEFAULT, "%{public}@Posting HomePod Mini configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v42);
    v46 = [(HMDHomeManager *)v43 darwinNotificationProvider];
    [v46 notifyPost:*MEMORY[0x277CD0238]];

    v24 = 1;
  }

  if ((BYTE4(v104) & 1) != areAnyLargeHomePodConfigured())
  {
    v47 = objc_autoreleasePoolPush();
    v48 = v99;
    v49 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v49, OS_LOG_TYPE_INFO))
    {
      v50 = HMFGetLogIdentifier();
      v51 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v50;
      v118 = 2112;
      v119 = v51;
      _os_log_impl(&dword_2531F8000, v49, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for 2nd Gen HomePods configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v47);
    v52 = MEMORY[0x277CBED10];
    if ((v104 & 0x100000000) != 0)
    {
      v52 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v48 _setHomeConfigurationKey:*MEMORY[0x277CD0760] value:*v52];
    v53 = objc_autoreleasePoolPush();
    v54 = v48;
    v55 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_DEFAULT))
    {
      v56 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v56;
      _os_log_impl(&dword_2531F8000, v55, OS_LOG_TYPE_DEFAULT, "%{public}@Posting 2nd Gen HomePods configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v53);
    v57 = [(HMDHomeManager *)v54 darwinNotificationProvider];
    [v57 notifyPost:*MEMORY[0x277CD0280]];

    v24 = 1;
  }

  if ((v106 & 1) != areAnyHomePodsConfigured())
  {
    v58 = objc_autoreleasePoolPush();
    v59 = v99;
    v60 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v60, OS_LOG_TYPE_INFO))
    {
      v61 = HMFGetLogIdentifier();
      v62 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v61;
      v118 = 2112;
      v119 = v62;
      _os_log_impl(&dword_2531F8000, v60, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for HomePods configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v58);
    v63 = MEMORY[0x277CBED10];
    if (v106)
    {
      v63 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v59 _setHomeConfigurationKey:*MEMORY[0x277CD04D8] value:*v63];
    v64 = objc_autoreleasePoolPush();
    v65 = v59;
    v66 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v66, OS_LOG_TYPE_DEFAULT))
    {
      v67 = HMFGetLogIdentifier();
      *buf = 138543362;
      v117 = v67;
      _os_log_impl(&dword_2531F8000, v66, OS_LOG_TYPE_DEFAULT, "%{public}@Posting HomePods present configured changed notification", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v64);
    v68 = [(HMDHomeManager *)v65 darwinNotificationProvider];
    [v68 notifyPost:*MEMORY[0x277CD0240]];

    v24 = 1;
  }

  [(HMDHomeManager *)v99 setHomePodsPresent:v107 & 1 inOwnedHomes:BYTE4(v106) & 1];
  if ((v3 & 1) != HMHomeManagerAreAnyTelevisionAccessoriesConfigured())
  {
    v69 = objc_autoreleasePoolPush();
    v70 = v99;
    v71 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v71, OS_LOG_TYPE_INFO))
    {
      v72 = HMFGetLogIdentifier();
      v73 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v72;
      v118 = 2112;
      v119 = v73;
      _os_log_impl(&dword_2531F8000, v71, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for televisions configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v69);
    v74 = MEMORY[0x277CBED10];
    if (v3)
    {
      v74 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v70 _setHomeConfigurationKey:*MEMORY[0x277CD1228] value:*v74];
    if (v3)
    {
      v75 = objc_autoreleasePoolPush();
      v76 = v70;
      v77 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v77, OS_LOG_TYPE_DEFAULT))
      {
        v78 = HMFGetLogIdentifier();
        *buf = 138543362;
        v117 = v78;
        _os_log_impl(&dword_2531F8000, v77, OS_LOG_TYPE_DEFAULT, "%{public}@Posting Television accessories added notification", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v75);
      v79 = [(HMDHomeManager *)v76 darwinNotificationProvider];
      [v79 notifyPost:*MEMORY[0x277CD03A8]];
    }

    v24 = 1;
  }

  if ((BYTE4(v107) & 1) != HMHomeManagerAreAnyAppleTVAccessoriesConfigured())
  {
    v80 = objc_autoreleasePoolPush();
    v81 = v99;
    v82 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v82, OS_LOG_TYPE_INFO))
    {
      v83 = HMFGetLogIdentifier();
      v84 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v83;
      v118 = 2112;
      v119 = v84;
      _os_log_impl(&dword_2531F8000, v82, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for Apple TV accessories configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v80);
    v85 = MEMORY[0x277CBED10];
    if ((v107 & 0x100000000) != 0)
    {
      v85 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v81 _setHomeConfigurationKey:*MEMORY[0x277CCF248] value:*v85];
    if ((v107 & 0x100000000) != 0)
    {
      v86 = objc_autoreleasePoolPush();
      v87 = v81;
      v88 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v88, OS_LOG_TYPE_DEFAULT))
      {
        v89 = HMFGetLogIdentifier();
        *buf = 138543362;
        v117 = v89;
        _os_log_impl(&dword_2531F8000, v88, OS_LOG_TYPE_DEFAULT, "%{public}@Posting Apple TV accessories added notification", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v86);
      v90 = [(HMDHomeManager *)v87 darwinNotificationProvider];
      [v90 notifyPost:*MEMORY[0x277CD0080]];
    }

    v24 = 1;
  }

  if ((v4 & 1) != HMHomeManagerAreAnyAccessoriesConfigured())
  {
    v91 = objc_autoreleasePoolPush();
    v92 = v99;
    v93 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v93, OS_LOG_TYPE_INFO))
    {
      v94 = HMFGetLogIdentifier();
      v95 = HMFBooleanToString();
      *buf = 138543618;
      v117 = v94;
      v118 = 2112;
      v119 = v95;
      _os_log_impl(&dword_2531F8000, v93, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for accessories configured: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v91);
    v96 = MEMORY[0x277CBED10];
    if (v4)
    {
      v96 = MEMORY[0x277CBED28];
    }

    [(HMDHomeManager *)v92 _setHomeConfigurationKey:*MEMORY[0x277CD1F80] value:*v96];
    v24 = 1;
  }

LABEL_104:
  v97 = *MEMORY[0x277D85DE8];
  return v24 & 1;
}

void __50__HMDHomeManager_setHomePodsPresent_inOwnedHomes___block_invoke(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = v6;
  if (v3)
  {
    if (os_log_type_enabled(v6, OS_LOG_TYPE_ERROR))
    {
      v8 = HMFGetLogIdentifier();
      v9 = *(a1 + 40);
      v10 = IXStringForAppRemovability();
      v17 = 138543874;
      v18 = v8;
      v19 = 2112;
      v20 = v10;
      v21 = 2112;
      v22 = v3;
      v11 = "%{public}@Failed to set Home app removability to %@: %@";
      v12 = v7;
      v13 = OS_LOG_TYPE_ERROR;
      v14 = 32;
LABEL_6:
      _os_log_impl(&dword_2531F8000, v12, v13, v11, &v17, v14);
    }
  }

  else if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v15 = *(a1 + 40);
    v10 = IXStringForAppRemovability();
    v17 = 138543618;
    v18 = v8;
    v19 = 2112;
    v20 = v10;
    v11 = "%{public}@Successfully set Home app removability to %@";
    v12 = v7;
    v13 = OS_LOG_TYPE_INFO;
    v14 = 22;
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v4);
  v16 = *MEMORY[0x277D85DE8];
}

- (void)updateHomeKitInUsePreferences
{
  v23 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasLoadedData])
  {
    v3 = [(HMDHomeManager *)self _updateIncomingInvitesPresent];
    v4 = [(HMDHomeManager *)self _updatePreferencesForConfiguredHomes];
    v5 = [(HMDHomeManager *)self _updatePreferencesForCurrentHome];
    v6 = [(HMDHomeManager *)self _updateAccessoriesConfigured];
    v7 = v6;
    if (v3 || v4 || v5 || v6)
    {
      v8 = objc_autoreleasePoolPush();
      v9 = self;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        v13 = 138544386;
        v14 = v11;
        v15 = 1024;
        v16 = v3;
        v17 = 1024;
        v18 = v4;
        v19 = 1024;
        v20 = v5;
        v21 = 1024;
        v22 = v7;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Posting preferences changed notification due to change in incomingInvites: %{BOOL}d homes: %{BOOL}d}, currentHome: %{BOOL}d, accessoriesConfigured: %{BOOL}d", &v13, 0x24u);
      }

      objc_autoreleasePoolPop(v8);
      [(HMDHomeManager *)v9 _postPreferencesChangedNotification];
    }
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_postPreferencesChangedNotification
{
  v10 = *MEMORY[0x277D85DE8];
  if (a1)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = a1;
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
    {
      v5 = HMFGetLogIdentifier();
      v8 = 138543362;
      v9 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@Posting preferences changed notification", &v8, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    v6 = [v3 darwinNotificationProvider];
    [v6 notifyPost:*MEMORY[0x277CD02E8]];
  }

  v7 = *MEMORY[0x277D85DE8];
}

- (BOOL)_updateIncomingInvitesPresent
{
  v3 = [(HMDHomeManager *)self hasLoadedData];
  if (v3)
  {
    v4 = areIncomingInvitesPresent();
    v5 = [(HMDHomeManager *)self incomingInvitations];
    v6 = [v5 count];

    v7 = +[HMDBulletinBoard sharedBulletinBoard];
    [v7 refreshHomeBadgeNumber];

    if (v4 == (v6 != 0))
    {
      LOBYTE(v3) = 0;
    }

    else
    {
      v8 = MEMORY[0x277CBED10];
      if (v6)
      {
        v8 = MEMORY[0x277CBED28];
      }

      [(HMDHomeManager *)self _setHomeConfigurationKey:*MEMORY[0x277CD23E0] value:*v8];
      LOBYTE(v3) = 1;
    }
  }

  return v3;
}

- (BOOL)_updatePreferencesForCurrentHome
{
  v27 = *MEMORY[0x277D85DE8];
  v4 = [(HMDHomeManager *)self hasLoadedData];
  if (v4)
  {
    v5 = objc_alloc(MEMORY[0x277D0F770]);
    v6 = MEMORY[0x277CCACA8];
    v7 = MEMORY[0x259C01AE0](self, a2);
    v8 = [v6 stringWithFormat:@"%@, %s:%ld", v7, "/Library/Caches/com.apple.xbs/Sources/HomeKit_executables_legacy/Sources/homed/HomeManager/HMDHomeManager.m", 8310];
    v9 = [MEMORY[0x277D0F770] currentActivity];
    v22 = [v5 initWithName:v8 parent:v9];

    v10 = [(HMDHomeManager *)self currentHomeUUID];
    if (v10)
    {
      v11 = [(HMDHomeManager *)self currentHomeUUID];
      v12 = spiClientIdentifierForUUID(v11);
    }

    else
    {
      v12 = 0;
    }

    v13 = HMHomeManagerCurrentHomeSPIClientIdentifier();
    v14 = HMFEqualObjects();
    if ((v14 & 1) == 0)
    {
      v15 = objc_autoreleasePoolPush();
      v16 = self;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543618;
        v24 = v18;
        v25 = 2112;
        v26 = v12;
        _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Setting the preference for current home SPI client identifier: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v15);
      v19 = [v12 UUIDString];
      [(HMDHomeManager *)v16 _setHomeConfigurationKey:*MEMORY[0x277CCFC40] value:v19];
    }

    __HMFActivityScopeLeave();
    LOBYTE(v4) = v14 ^ 1;
  }

  v20 = *MEMORY[0x277D85DE8];
  return v4;
}

- (BOOL)_updatePreferencesForConfiguredHomes
{
  v39 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasLoadedData])
  {
    v4 = objc_alloc(MEMORY[0x277D0F770]);
    v5 = MEMORY[0x277CCACA8];
    v6 = MEMORY[0x259C01AE0](self, a2);
    v7 = [v5 stringWithFormat:@"%@, %s:%ld", v6, "/Library/Caches/com.apple.xbs/Sources/HomeKit_executables_legacy/Sources/homed/HomeManager/HMDHomeManager.m", 8270];
    v8 = [MEMORY[0x277D0F770] currentActivity];
    v34 = [v4 initWithName:v7 parent:v8];

    v9 = [(HMDHomeManager *)self homes];
    v10 = [v9 count];

    v11 = HMHomeManagerConfiguredHomesCount();
    v12 = v10 != v11;
    if (v10 != v11)
    {
      v13 = objc_autoreleasePoolPush();
      v14 = self;
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        *buf = 138543618;
        v36 = v16;
        v37 = 2048;
        v38 = v10;
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for configured homes count: %lu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v13);
      v17 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:v10];
      [(HMDHomeManager *)v14 _setHomeConfigurationKey:*MEMORY[0x277CCFC38] value:v17];
      v18 = v10 > v11;
      v19 = objc_autoreleasePoolPush();
      v20 = v14;
      if (v18)
      {
        v21 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
        {
          v22 = HMFGetLogIdentifier();
          *buf = 138543362;
          v36 = v22;
          _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Posting configured home added notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        v23 = [(HMDHomeManager *)v20 darwinNotificationProvider];
        [v23 notifyPost:*MEMORY[0x277CD00B8]];
      }

      else
      {
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          v25 = HMFGetLogIdentifier();
          *buf = 138543362;
          v36 = v25;
          _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_DEFAULT, "%{public}@Posting configured home removed notification", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v19);
        v23 = [(HMDHomeManager *)v20 darwinNotificationProvider];
        [v23 notifyPost:*MEMORY[0x277CD00C0]];
      }
    }

    if ((v10 != 0) != areHomesConfigured())
    {
      v26 = objc_autoreleasePoolPush();
      v27 = self;
      v28 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
      {
        v29 = HMFGetLogIdentifier();
        v30 = HMFBooleanToString();
        *buf = 138543618;
        v36 = v29;
        v37 = 2112;
        v38 = v30;
        _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Saving and sending the preference for are homes configured: %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v26);
      v31 = MEMORY[0x277CBED10];
      if (v10)
      {
        v31 = MEMORY[0x277CBED28];
      }

      [(HMDHomeManager *)v27 _setHomeConfigurationKey:*MEMORY[0x277CCF250] value:*v31];
      v12 = 1;
    }

    __HMFActivityScopeLeave();
  }

  else
  {
    v12 = 0;
  }

  v32 = *MEMORY[0x277D85DE8];
  return v12;
}

- (id)replaceName:(id)a3 withNewName:(id)a4 inNamespaces:(id)a5
{
  v8 = a5;
  v9 = a4;
  v10 = a3;
  v11 = [(HMDHomeManager *)self nameValidator];
  v12 = [v11 replaceName:v10 withNewName:v9 inNamespaces:v8];

  return v12;
}

- (id)removeName:(id)a3 namespace:(id)a4
{
  v6 = a4;
  v7 = a3;
  v8 = [(HMDHomeManager *)self nameValidator];
  v9 = [v8 removeName:v7 namespace:v6];

  return v9;
}

- (id)addName:(id)a3 namespace:(id)a4
{
  v6 = a4;
  v7 = a3;
  v8 = [(HMDHomeManager *)self nameValidator];
  v9 = [v8 addName:v7 namespace:v6];

  return v9;
}

- (id)_homeFromEventIdentifier:(id)a3
{
  v4 = [a3 componentsSeparatedByString:@"/"];
  v5 = [v4 firstObject];
  v6 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v5];
  v7 = [(HMDHomeManager *)self _homeWithUUID:v6];

  return v7;
}

- (id)_zoneInformationWithUUID:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self cloudZones];
  v6 = [v5 hmf_firstObjectWithUUID:v4];

  return v6;
}

- (id)_homeWithZoneID:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 hmf_firstObjectWithZoneID:v4];

  return v6;
}

- (id)_homeWithAssistantIdentifier:(id)a3
{
  v4 = a3;
  if (v4)
  {
    v5 = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __47__HMDHomeManager__homeWithAssistantIdentifier___block_invoke;
    v8[3] = &unk_279732278;
    v9 = v4;
    v6 = [v5 hmf_objectPassingTest:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

uint64_t __47__HMDHomeManager__homeWithAssistantIdentifier___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 urlString];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homeWithUniqueIdentifier:(id)a3 forClientIdentifierSalt:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self homes];
  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __68__HMDHomeManager__homeWithUniqueIdentifier_forClientIdentifierSalt___block_invoke;
  v13[3] = &unk_2797322A0;
  v14 = v7;
  v15 = v6;
  v9 = v6;
  v10 = v7;
  v11 = [v8 na_firstObjectPassingTest:v13];

  return v11;
}

uint64_t __68__HMDHomeManager__homeWithUniqueIdentifier_forClientIdentifierSalt___block_invoke(uint64_t a1, void *a2)
{
  v3 = MEMORY[0x277CCAD78];
  v4 = [a2 uuid];
  v5 = [v3 hm_deriveUUIDFromBaseUUID:v4 identifierSalt:*(a1 + 32)];

  v6 = [v5 isEqual:*(a1 + 40)];
  return v6;
}

- (id)_homeWithUUID:(id)a3
{
  v4 = a3;
  if (v4)
  {
    v5 = [(HMDHomeManager *)self homes];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __32__HMDHomeManager__homeWithUUID___block_invoke;
    v8[3] = &unk_279732278;
    v9 = v4;
    v6 = [v5 hmf_objectPassingTest:v8];
  }

  else
  {
    v6 = 0;
  }

  return v6;
}

uint64_t __32__HMDHomeManager__homeWithUUID___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 uuid];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homesWithName:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __33__HMDHomeManager__homesWithName___block_invoke;
  v9[3] = &unk_279732278;
  v10 = v4;
  v6 = v4;
  v7 = [v5 hmf_objectsPassingTest:v9];

  return v7;
}

uint64_t __33__HMDHomeManager__homesWithName___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 name];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (id)_homeWithName:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __32__HMDHomeManager__homeWithName___block_invoke;
  v9[3] = &unk_279732278;
  v10 = v4;
  v6 = v4;
  v7 = [v5 hmf_objectPassingTest:v9];

  return v7;
}

uint64_t __32__HMDHomeManager__homeWithName___block_invoke(uint64_t a1, void *a2)
{
  v3 = [a2 name];
  v4 = [v3 isEqual:*(a1 + 32)];

  return v4;
}

- (BOOL)checkConflictInHomeNamespaceWithName:(id)a3 options:(unint64_t)a4 namespaceUUID:(id)a5 error:(id *)a6
{
  v8 = a4;
  v34 = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a5;
  v12 = objc_alloc_init(MEMORY[0x277CBEB18]);
  if ((v8 & 0xD) != 0)
  {
    if (v8)
    {
      v13 = [(HMDHomeManager *)self nameValidator];
      v14 = [v13 validateName:v10];

      if (v14)
      {
        if (a6)
        {
          v15 = v14;
          *a6 = v14;
        }

        goto LABEL_30;
      }
    }

    if (v11)
    {
      [v12 addObject:v11];
      if ((v8 & 4) == 0)
      {
        goto LABEL_25;
      }
    }

    else if ((v8 & 2) != 0)
    {
      v28 = v10;
      v31 = 0u;
      v32 = 0u;
      v29 = 0u;
      v30 = 0u;
      v18 = [(HMDHomeManager *)self homes];
      v19 = [v18 countByEnumeratingWithState:&v29 objects:v33 count:16];
      if (v19)
      {
        v20 = v19;
        v21 = *v30;
        do
        {
          for (i = 0; i != v20; ++i)
          {
            if (*v30 != v21)
            {
              objc_enumerationMutation(v18);
            }

            v23 = [*(*(&v29 + 1) + 8 * i) uuid];
            [v12 addObject:v23];
          }

          v20 = [v18 countByEnumeratingWithState:&v29 objects:v33 count:16];
        }

        while (v20);
      }

      v10 = v28;
      if ((v8 & 4) == 0)
      {
        goto LABEL_25;
      }

      v24 = [(HMDHomeManager *)self uuid];
      [v12 addObject:v24];
    }

    else
    {
      v17 = [(HMDHomeManager *)self uuid];
      [v12 addObject:v17];

      if ((v8 & 4) == 0)
      {
        goto LABEL_25;
      }
    }

    v25 = [(HMDHomeManager *)self _checkNameConflict:v10 withNamespaceUUIDs:v12];
    if (v25)
    {
LABEL_27:
      if (a6)
      {
        v25 = v25;
        *a6 = v25;
      }

      goto LABEL_30;
    }

LABEL_25:
    if ((v8 & 8) == 0 || ([(HMDHomeManager *)self _checkActionSetNameConflict:v10 withNamespaceUUIDs:v12], (v25 = objc_claimAutoreleasedReturnValue()) == 0))
    {
      v16 = 1;
      goto LABEL_32;
    }

    goto LABEL_27;
  }

  if (!a6)
  {
LABEL_30:
    v16 = 0;
    goto LABEL_32;
  }

  [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  *a6 = v16 = 0;
LABEL_32:

  v26 = *MEMORY[0x277D85DE8];
  return v16;
}

- (void)_handleQueryHomeNamespace:(id)a3
{
  v40 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 stringForKey:*MEMORY[0x277CD0308]];
  if (!v5)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      v17 = [v4 messagePayload];
      *buf = 138543618;
      v35 = v16;
      v36 = 2112;
      v37 = v17;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@No name found in query home namespace message payload: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 20;
    goto LABEL_9;
  }

  v6 = HMMaxLengthForNaming();
  if ([v5 length] > v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@New name is longer than the pre-defined max length", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = MEMORY[0x277CCA9B8];
    v12 = 46;
LABEL_9:
    v18 = [v11 hmErrorWithCode:v12];
    [v4 respondWithError:v18];
    goto LABEL_18;
  }

  v19 = [v4 numberForKey:*MEMORY[0x277CD02B8]];
  v20 = [v19 unsignedIntegerValue];

  v18 = [v4 uuidForKey:*MEMORY[0x277CD0640]];
  v21 = objc_autoreleasePoolPush();
  v22 = self;
  v23 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
  {
    v24 = HMFGetLogIdentifier();
    v25 = HMHomeManagerNameValidationOptionsToString();
    *buf = 138543874;
    v35 = v24;
    v36 = 2112;
    v37 = v18;
    v38 = 2112;
    v39 = v25;
    _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Validating name for home UUID %@ with options: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v21);
  v33 = 0;
  v26 = [(HMDHomeManager *)v22 checkConflictInHomeNamespaceWithName:v5 options:v20 namespaceUUID:v18 error:&v33];
  v27 = v33;
  if (v26)
  {
    [v4 respondWithSuccess];
  }

  else
  {
    v28 = objc_autoreleasePoolPush();
    v29 = v22;
    v30 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v30, OS_LOG_TYPE_ERROR))
    {
      v31 = HMFGetLogIdentifier();
      *buf = 138543618;
      v35 = v31;
      v36 = 2112;
      v37 = v27;
      _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_ERROR, "%{public}@Name validation failed: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v28);
    [v4 respondWithError:v27];
  }

LABEL_18:
  v32 = *MEMORY[0x277D85DE8];
}

- (void)_stopTrackingRemovedHomeUserMergeId:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v4 = a3;
  os_unfair_lock_lock_with_options();
  if (v4 && [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:v4])
  {
    [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes removeObject:v4];
    v5 = objc_autoreleasePoolPush();
    v6 = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v4;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Removing user with mergeID %@ from list of mergeIDs of homes removed locally", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  os_unfair_lock_unlock(&self->_lock);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_trackRemovedHomeUserMergeId:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v4 = a3;
  os_unfair_lock_lock_with_options();
  if (v4 && ([(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes containsObject:v4]& 1) == 0)
  {
    [(NSMutableSet *)self->_mergeIDsOfUsersOfRemovedSharedHomes addObject:v4];
    v5 = objc_autoreleasePoolPush();
    v6 = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v10 = 138543618;
      v11 = v8;
      v12 = 2112;
      v13 = v4;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Adding user with mergeID %@ to mergeID of homes removed locally", &v10, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
  }

  os_unfair_lock_unlock(&self->_lock);

  v9 = *MEMORY[0x277D85DE8];
}

- (void)removeHome:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  [(NSMutableArray *)self->_homes removeObject:v4];
  os_unfair_lock_unlock(&self->_lock);
}

- (void)addHome:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  [(NSMutableArray *)self->_homes addObject:v4];
  os_unfair_lock_unlock(&self->_lock);
}

- (void)setHomes:(id)a3
{
  v6 = a3;
  os_unfair_lock_lock_with_options();
  v4 = [v6 mutableCopy];
  homes = self->_homes;
  self->_homes = v4;

  os_unfair_lock_unlock(&self->_lock);
}

- (NSArray)homes
{
  os_unfair_lock_lock_with_options();
  v3 = [(NSMutableArray *)self->_homes copy];
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)setCurrentHomeUUID:(id)a3
{
  v6 = a3;
  os_unfair_lock_lock_with_options();
  overrideCurrentHomeUUIDToNil = self->_overrideCurrentHomeUUIDToNil;
  currentHomeUUIDOverride = v6;
  if (overrideCurrentHomeUUIDToNil)
  {
    if (([(HMFBoolean *)overrideCurrentHomeUUIDToNil BOOLValue]& 1) != 0)
    {
      currentHomeUUIDOverride = 0;
    }

    else
    {
      currentHomeUUIDOverride = self->_currentHomeUUIDOverride;
    }
  }

  objc_storeStrong(&self->_currentHomeUUID, currentHomeUUIDOverride);
  os_unfair_lock_unlock(&self->_lock);
}

- (NSUUID)currentHomeUUID
{
  os_unfair_lock_lock_with_options();
  v3 = self->_currentHomeUUID;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)setOverrideCurrentHomeUUIDToNil:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  overrideCurrentHomeUUIDToNil = self->_overrideCurrentHomeUUIDToNil;
  self->_overrideCurrentHomeUUIDToNil = v4;

  os_unfair_lock_unlock(&self->_lock);
}

- (HMFBoolean)overrideCurrentHomeUUIDToNil
{
  os_unfair_lock_lock_with_options();
  v3 = self->_overrideCurrentHomeUUIDToNil;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)setCurrentHomeUUIDOverride:(id)a3
{
  v4 = a3;
  os_unfair_lock_lock_with_options();
  currentHomeUUIDOverride = self->_currentHomeUUIDOverride;
  self->_currentHomeUUIDOverride = v4;

  os_unfair_lock_unlock(&self->_lock);
}

- (NSUUID)currentHomeUUIDOverride
{
  os_unfair_lock_lock_with_options();
  v3 = self->_currentHomeUUIDOverride;
  os_unfair_lock_unlock(&self->_lock);

  return v3;
}

- (void)_determineLegacyLocalChanges:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    objc_initWeak(&location, self);
    v5 = [HMDBackingStoreLogChangesExistFetchOperation alloc];
    v17[0] = MEMORY[0x277D85DD0];
    v17[1] = 3221225472;
    v17[2] = __47__HMDHomeManager__determineLegacyLocalChanges___block_invoke;
    v17[3] = &unk_279732250;
    objc_copyWeak(&v19, &location);
    v18 = v4;
    v6 = [(HMDBackingStoreLogChangesExistFetchOperation *)v5 initWithNeedsPushTo:1 result:v17];
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEBUG))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEBUG, "%{public}@Fetching datastore for existing V3 changes", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [(HMDHomeManager *)v8 backingStore];
    [v11 submit:v6];

    objc_destroyWeak(&v19);
    objc_destroyWeak(&location);
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Completion block must be specified", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __47__HMDHomeManager__determineLegacyLocalChanges___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v42 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = WeakRetained;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEBUG))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543618;
      v39 = v14;
      v40 = 2112;
      v41 = v9;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEBUG, "%{public}@Completed fetching datastore for existing V3 changes with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (v9)
    {
      v15 = [v12 workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __47__HMDHomeManager__determineLegacyLocalChanges___block_invoke_904;
      block[3] = &unk_279735738;
      v36 = *(a1 + 32);
      v35 = v9;
      dispatch_async(v15, block);

      v16 = v36;
    }

    else
    {
      if (v7 && [v7 count])
      {
        v25 = v8;
        v17 = [MEMORY[0x277CBEB58] set];
        v30 = 0u;
        v31 = 0u;
        v32 = 0u;
        v33 = 0u;
        v18 = [v7 allValues];
        v19 = [v18 countByEnumeratingWithState:&v30 objects:v37 count:16];
        if (v19)
        {
          v20 = v19;
          v21 = *v31;
          do
          {
            v22 = 0;
            do
            {
              if (*v31 != v21)
              {
                objc_enumerationMutation(v18);
              }

              [v17 addObjectsFromArray:*(*(&v30 + 1) + 8 * v22++)];
            }

            while (v20 != v22);
            v20 = [v18 countByEnumeratingWithState:&v30 objects:v37 count:16];
          }

          while (v20);
        }

        v8 = v25;
      }

      else
      {
        v17 = 0;
      }

      v23 = [v12 workQueue];
      v26[0] = MEMORY[0x277D85DD0];
      v26[1] = 3221225472;
      v26[2] = __47__HMDHomeManager__determineLegacyLocalChanges___block_invoke_2;
      v26[3] = &unk_2797355D0;
      v29 = *(a1 + 32);
      v27 = v17;
      v28 = v8;
      v16 = v17;
      dispatch_async(v23, v26);
    }
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __47__HMDHomeManager__determineLegacyLocalChanges___block_invoke_2(void *a1)
{
  v2 = a1[6];
  v3 = a1[4];
  if (v3)
  {
    v7 = [v3 allObjects];
    (*(v2 + 16))(v2, v7, a1[5], 0);
  }

  else
  {
    v4 = a1[5];
    v5 = *(v2 + 16);
    v6 = MEMORY[0x277CBEBF8];

    v5(v2, v6, v4, 0);
  }
}

- (void)_determineLocalChangesAndSchedulePush
{
  v25 = *MEMORY[0x277D85DE8];
  objc_initWeak(&location, self);
  v3 = [HMDBackingStoreLogChangesExistFetchOperation alloc];
  v20[0] = MEMORY[0x277D85DD0];
  v20[1] = 3221225472;
  v20[2] = __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke;
  v20[3] = &unk_279732228;
  objc_copyWeak(&v21, &location);
  v4 = [(HMDBackingStoreLogChangesExistFetchOperation *)v3 initWithNeedsPushTo:2 result:v20];
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v24 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Fetching datastore for existing V4 changes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 backingStore];
  [v9 submit:v4];

  v10 = [HMDBackingStoreLogChangesExistFetchOperation alloc];
  v18[0] = MEMORY[0x277D85DD0];
  v18[1] = 3221225472;
  v18[2] = __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_902;
  v18[3] = &unk_279732228;
  objc_copyWeak(&v19, &location);
  v11 = [(HMDBackingStoreLogChangesExistFetchOperation *)v10 initWithNeedsPushTo:1 result:v18];
  v12 = objc_autoreleasePoolPush();
  v13 = v6;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEBUG))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v24 = v15;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEBUG, "%{public}@Fetching datastore for existing V3 changes", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v12);
  v16 = [(HMDHomeManager *)v13 backingStore];
  [v16 submit:v11];

  objc_destroyWeak(&v19);
  objc_destroyWeak(&v21);
  objc_destroyWeak(&location);
  v17 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v23 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = WeakRetained;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEBUG))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543618;
      v20 = v14;
      v21 = 2112;
      v22 = v9;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEBUG, "%{public}@Completed fetching datastore for existing V4 changes with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (!v9 && [v7 count])
    {
      v15 = [v12 workQueue];
      v17[0] = MEMORY[0x277D85DD0];
      v17[1] = 3221225472;
      v17[2] = __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_900;
      v17[3] = &unk_2797359B0;
      v17[4] = v12;
      v18 = v7;
      dispatch_async(v15, v17);
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_902(uint64_t a1, void *a2, void *a3, void *a4)
{
  v22 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = WeakRetained;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEBUG))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543618;
      v19 = v14;
      v20 = 2112;
      v21 = v9;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEBUG, "%{public}@Completed fetching datastore for existing V3 changes with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (!v9 && [v7 count])
    {
      v15 = [v12 workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_903;
      block[3] = &unk_279735D00;
      block[4] = v12;
      dispatch_async(v15, block);
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

uint64_t __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_903(uint64_t a1)
{
  v10 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v8 = 138543362;
    v9 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Changes detected scheduling push legacy zone", &v8, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 32) _pushChangesToCloud:0 withDelay:0.0];
  v7 = *MEMORY[0x277D85DE8];
  return result;
}

void __55__HMDHomeManager__determineLocalChangesAndSchedulePush__block_invoke_900(uint64_t a1)
{
  v1 = a1;
  v43 = *MEMORY[0x277D85DE8];
  v32 = 0u;
  v33 = 0u;
  v34 = 0u;
  v35 = 0u;
  obj = [*(a1 + 32) homes];
  v2 = [obj countByEnumeratingWithState:&v32 objects:v42 count:16];
  if (v2)
  {
    v4 = v2;
    v5 = *v33;
    *&v3 = 138543874;
    v29 = v3;
    v30 = v1;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v33 != v5)
        {
          objc_enumerationMutation(obj);
        }

        v7 = *(*(&v32 + 1) + 8 * i);
        v8 = *(v1 + 40);
        v9 = [v7 backingStore];
        v10 = [v9 root];
        v11 = [v8 objectForKeyedSubscript:v10];

        if (v11)
        {
          v12 = objc_autoreleasePoolPush();
          v13 = *(v1 + 32);
          v14 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
          {
            v15 = HMFGetLogIdentifier();
            [v7 name];
            v16 = v4;
            v18 = v17 = v5;
            v19 = [v7 zoneID];
            *buf = v29;
            v37 = v15;
            v38 = 2112;
            v39 = v18;
            v40 = 2112;
            v41 = v19;
            _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Scheduling push for pending transactions for home/zone %@/%@", buf, 0x20u);

            v5 = v17;
            v4 = v16;
            v1 = v30;
          }

          objc_autoreleasePoolPop(v12);
          [*(v1 + 32) _uploadHomeToCloud:v7 withDelay:0.0];
        }
      }

      v4 = [obj countByEnumeratingWithState:&v32 objects:v42 count:16];
    }

    while (v4);
  }

  v20 = *(v1 + 40);
  v21 = [*(v1 + 32) backingStore];
  v22 = [v21 root];
  v23 = [v20 objectForKeyedSubscript:v22];

  if (v23)
  {
    v24 = objc_autoreleasePoolPush();
    v25 = *(v1 + 32);
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
    {
      v27 = HMFGetLogIdentifier();
      *buf = 138543362;
      v37 = v27;
      _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Scheduling push for pending transactions for home manager zone", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v24);
    [*(v1 + 32) _uploadHomeManagerToCloudWithDelay:0.0];
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)determineLocalChangesAndSchedulePush
{
  v3 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __54__HMDHomeManager_determineLocalChangesAndSchedulePush__block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v3, block);
}

uint64_t __54__HMDHomeManager_determineLocalChangesAndSchedulePush__block_invoke(uint64_t a1)
{
  v2 = [*(a1 + 32) syncManager];
  [v2 kick];

  v3 = *(a1 + 32);

  return [v3 _determineLocalChangesAndSchedulePush];
}

- (void)_handleTransactionsFetched:(id)a3 stagedTransaction:(id)a4 mustReplay:(id)a5 zoneID:(id)a6 cloudConflict:(BOOL)a7 transactionError:(id)a8 syncCompletion:(id)a9
{
  v112 = a7;
  v165 = *MEMORY[0x277D85DE8];
  v117 = a3;
  v119 = a4;
  v118 = a5;
  v116 = a6;
  v121 = a8;
  v115 = a9;
  v14 = objc_autoreleasePoolPush();
  val = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
  {
    v16 = HMFGetLogIdentifier();
    v17 = [v121 hmd_conciseCKError];
    v18 = [v17 shortDescription];
    *buf = 138543874;
    v154 = v16;
    v155 = 2112;
    v156 = v116;
    v157 = 2112;
    v158 = v18;
    _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Fetched data from zone %@ with error status: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v14);
  if (!v121)
  {
    if ([(HMDHomeManager *)val backOffOperationInProgress])
    {
      [(HMDHomeManager *)val setBackOffOperationInProgress:0];
      v20 = objc_autoreleasePoolPush();
      v21 = val;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
      {
        v23 = HMFGetLogIdentifier();
        *buf = 138543362;
        v154 = v23;
        _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Clearing that we were in a backoff operation", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v20);
    }

    [(HMDHomeManager *)val _resetCloudOperationRetryCounters];
    [(HMDHomeManager *)val setHomeDataLoadedFromArchive:1];
    v24 = [(HMDHomeManager *)val cloudDataSyncStateFilter];
    [v24 updateLocalDataDecryptionFailed:0];

    v109 = [v117 replayTransaction:v118 stagedTransaction:v119];
    v114 = [(HMDHomeManager *)val _findHomeModelChange:v109];
    v110 = [(HMDHomeManager *)val _homeWithZoneID:v116];
    if (!v114)
    {
      v114 = 0;
      v26 = v109;
LABEL_88:
      v88 = v26;
      v89 = [(HMDHomeManager *)val _findHomeConfigurationModelChange:?];
      v90 = v89;
      if (v89)
      {
        v91 = [v89 objectChange];
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v92 = v91;
        }

        else
        {
          v92 = 0;
        }

        v93 = v92;

        if (v93 && [v119 hasValidChanges])
        {
          [v93 setHomeHasLocalChanges:1];
        }
      }

      aBlock[0] = MEMORY[0x277D85DD0];
      aBlock[1] = 3221225472;
      aBlock[2] = __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke_897;
      aBlock[3] = &unk_2797321D8;
      v94 = v117;
      v133 = v94;
      v134 = val;
      v95 = v116;
      v135 = v95;
      v139 = v112;
      v136 = v118;
      v137 = v119;
      v140 = v110 != 0;
      v96 = v115;
      v138 = v96;
      v97 = _Block_copy(aBlock);
      objc_initWeak(&location, val);
      if (v114)
      {
        v98 = [v94 isLegacyTransaction];
        v123[0] = MEMORY[0x277D85DD0];
        v123[1] = 3221225472;
        v123[2] = __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke_898;
        v123[3] = &unk_279732200;
        objc_copyWeak(&v130, &location);
        v124 = v114;
        v125 = v88;
        v126 = v95;
        v128 = v96;
        v129 = v97;
        v127 = v94;
        [(HMDHomeManager *)val _handleFetchModifyHome:v124 isLegacyTransaction:v98 completion:v123];

        objc_destroyWeak(&v130);
      }

      else if ([v88 count] || !v112)
      {
        -[HMDHomeManager _handleFetchObjectChange:home:isLegacyTransaction:completion:](val, "_handleFetchObjectChange:home:isLegacyTransaction:completion:", v88, v110, [v94 isLegacyTransaction], v97);
      }

      else
      {
        v99 = objc_autoreleasePoolPush();
        v100 = val;
        v101 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v101, OS_LOG_TYPE_INFO))
        {
          v102 = HMFGetLogIdentifier();
          *buf = 138543362;
          v154 = v102;
          _os_log_impl(&dword_2531F8000, v101, OS_LOG_TYPE_INFO, "%{public}@Nothing to applied on cloud conflict fetch, force server token to nil", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v99);
        [v94 setUpdatedServerChangeToken:0];
        if (v97)
        {
          (*(v97 + 2))(v97, 0);
        }
      }

      objc_destroyWeak(&location);

      goto LABEL_106;
    }

    if ([v114 isDeleted])
    {
      v111 = MEMORY[0x277CBEBF8];
      v25 = v109;
LABEL_87:

      v26 = v111;
      goto LABEL_88;
    }

    v27 = [v114 objectID];
    v106 = [v119 changeWithObjectID:v27];

    if (v106 && [v106 isDeleted])
    {
      v28 = objc_autoreleasePoolPush();
      v29 = val;
      v30 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
      {
        v31 = HMFGetLogIdentifier();
        v32 = [v114 objectID];
        *buf = 138543618;
        v154 = v31;
        v155 = 2112;
        v156 = v32;
        _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Dropping home %@ because it was deleted locally and has not yet been pushed", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v28);
      v105 = 0;
      v111 = MEMORY[0x277CBEBF8];
      v33 = v114;
      v104 = v109;
LABEL_42:
      v114 = 0;
LABEL_85:

      v25 = v105;
      goto LABEL_86;
    }

    v25 = [v114 objectChange];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v34 = v25;
    }

    else
    {
      v34 = 0;
    }

    v105 = v34;

    if (!v105)
    {
      v104 = [v114 objectChange];
      objc_opt_class();
      if (objc_opt_isKindOfClass())
      {
        v35 = v104;
      }

      else
      {
        v35 = 0;
      }

      v25 = v35;

      if (v25)
      {
        if (!v110)
        {
          goto LABEL_41;
        }

        v36 = [v25 setProperties];
        v37 = [v36 containsObject:@"configurationVersion"];

        if (!v37)
        {
          goto LABEL_41;
        }

        v38 = [v25 configurationVersion];
        v39 = [v38 integerValue];

        if (v39 < [v110 configurationVersion] || objc_msgSend(v110, "expectedConfigurationVersion") && objc_msgSend(v110, "expectedConfigurationVersion") > v39)
        {
          v40 = objc_autoreleasePoolPush();
          v41 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v41, OS_LOG_TYPE_INFO))
          {
            v42 = HMFGetLogIdentifier();
            v43 = [v110 name];
            v44 = [v110 configurationVersion];
            v45 = [v110 expectedConfigurationVersion];
            *buf = 138544386;
            v154 = v42;
            v155 = 2112;
            v156 = v43;
            v157 = 2048;
            v158 = v44;
            v159 = 2048;
            v160 = v45;
            v161 = 2048;
            v162 = v39;
            _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_INFO, "%{public}@Dropping shared home %@ merge because local configuration version %lu or expected configuration version %lu is less that remote %lu", buf, 0x34u);
          }

          objc_autoreleasePoolPop(v40);
          v105 = 0;
          v111 = MEMORY[0x277CBEBF8];
          v33 = v114;
        }

        else
        {
LABEL_41:
          v105 = 0;
          v33 = v114;
          v111 = v109;
        }

        goto LABEL_42;
      }

LABEL_37:
      v111 = v109;
LABEL_86:

      goto LABEL_87;
    }

    if (v110)
    {

      [v119 hasValidChanges];
      v114 = 0;
      goto LABEL_37;
    }

    v111 = [MEMORY[0x277CBEB18] arrayWithArray:v109];
    [v111 removeObject:v114];
    v104 = [(HMDHomeManager *)val _findHomeOwnerModelChange:v109];
    if (!v104)
    {
LABEL_82:
      v33 = [(HMDHomeManager *)val _findHomeSharedUserModelChange:v109];
      if (v33)
      {
        v141[0] = MEMORY[0x277D85DD0];
        v141[1] = 3221225472;
        v141[2] = __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke;
        v141[3] = &unk_2797321B0;
        v142 = v105;
        v143 = val;
        v144 = v111;
        [v33 enumerateKeysAndObjectsUsingBlock:v141];
      }

      goto LABEL_85;
    }

    v46 = objc_alloc(MEMORY[0x277CCAD78]);
    v47 = [v105 ownerUUID];
    v113 = [v46 initWithUUIDString:v47];

    if ([v104 count] == 1)
    {
      v120 = [v104 firstObject];
      goto LABEL_75;
    }

    if ([v104 count] < 2)
    {
      goto LABEL_80;
    }

    v48 = objc_autoreleasePoolPush();
    v49 = val;
    v50 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v50, OS_LOG_TYPE_INFO))
    {
      v51 = HMFGetLogIdentifier();
      *buf = 138543362;
      v154 = v51;
      _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_INFO, "%{public}@Found duplicate owner models", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v48);
    v151 = 0u;
    v152 = 0u;
    v149 = 0u;
    v150 = 0u;
    v52 = v104;
    v53 = [v52 countByEnumeratingWithState:&v149 objects:v164 count:16];
    if (v53)
    {
      v120 = 0;
      v54 = *v150;
      do
      {
        for (i = 0; i != v53; ++i)
        {
          if (*v150 != v54)
          {
            objc_enumerationMutation(v52);
          }

          v56 = *(*(&v149 + 1) + 8 * i);
          v57 = [v56 objectID];
          v58 = [v57 isEqual:v113];

          if (v58)
          {
            v59 = v56;

            v120 = v59;
          }

          v60 = [v56 objectChange];
          v61 = v60;
          if (v60)
          {
            [v60 dumpDebug:@" DUPLICATE: "];
          }
        }

        v53 = [v52 countByEnumeratingWithState:&v149 objects:v164 count:16];
      }

      while (v53);

      if (v120)
      {
        goto LABEL_61;
      }
    }

    else
    {
    }

    v120 = [v52 lastObject];
LABEL_61:
    v62 = objc_autoreleasePoolPush();
    v107 = v49;
    v63 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v63, OS_LOG_TYPE_INFO))
    {
      v64 = HMFGetLogIdentifier();
      v65 = [v120 objectID];
      v66 = [v65 UUIDString];
      *buf = 138543618;
      v154 = v64;
      v155 = 2112;
      v156 = v66;
      _os_log_impl(&dword_2531F8000, v63, OS_LOG_TYPE_INFO, "%{public}@Selecting as owner model %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v62);
    v147 = 0u;
    v148 = 0u;
    v145 = 0u;
    v146 = 0u;
    obj = v52;
    v67 = [obj countByEnumeratingWithState:&v145 objects:v163 count:16];
    if (v67)
    {
      v68 = *v146;
      do
      {
        for (j = 0; j != v67; ++j)
        {
          if (*v146 != v68)
          {
            objc_enumerationMutation(obj);
          }

          v70 = *(*(&v145 + 1) + 8 * j);
          if (([v70 isEqual:v120] & 1) == 0)
          {
            v71 = objc_autoreleasePoolPush();
            v72 = v107;
            v73 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v73, OS_LOG_TYPE_INFO))
            {
              v74 = HMFGetLogIdentifier();
              v75 = [v70 objectID];
              v76 = [v75 UUIDString];
              *buf = 138543618;
              v154 = v74;
              v155 = 2112;
              v156 = v76;
              _os_log_impl(&dword_2531F8000, v73, OS_LOG_TYPE_INFO, "%{public}@Dropping user model from processing %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v71);
            [v111 removeObject:v70];
          }
        }

        v67 = [obj countByEnumeratingWithState:&v145 objects:v163 count:16];
      }

      while (v67);
    }

LABEL_75:
    if (v120)
    {
      v77 = [v120 objectID];
      v78 = [v77 isEqual:v113];

      if ((v78 & 1) == 0)
      {
        v79 = objc_autoreleasePoolPush();
        v80 = val;
        v81 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v81, OS_LOG_TYPE_INFO))
        {
          v82 = HMFGetLogIdentifier();
          v83 = [v105 ownerUUID];
          v84 = [v120 objectID];
          v85 = [v84 UUIDString];
          *buf = 138543874;
          v154 = v82;
          v155 = 2112;
          v156 = v83;
          v157 = 2112;
          v158 = v85;
          _os_log_impl(&dword_2531F8000, v81, OS_LOG_TYPE_INFO, "%{public}@Fixing up home ownerUUID from %@ to %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v79);
        v86 = [v120 objectID];
        v87 = [v86 UUIDString];
        [v105 setOwnerUUID:v87];
      }

      goto LABEL_81;
    }

LABEL_80:
    v120 = 0;
LABEL_81:

    goto LABEL_82;
  }

  [v118 setOsTransaction:0];
  [v119 setOsTransaction:0];
  [v117 setOsTransaction:0];
  v19 = v115;
  if (v115)
  {
    v115[2]();
LABEL_106:
    v19 = v115;
  }

  v103 = *MEMORY[0x277D85DE8];
}

void __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke(id *a1, void *a2, void *a3)
{
  v64 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if ([v6 count] < 2)
  {
    goto LABEL_31;
  }

  v7 = [a1[4] uuid];
  v46 = v5;
  v8 = [HMDUser UUIDWithUserID:0 forHomeIdentifier:v7 uuid:0 pairingIdentity:v5];

  v56 = 0u;
  v57 = 0u;
  v54 = 0u;
  v55 = 0u;
  v9 = v6;
  v10 = [v9 countByEnumeratingWithState:&v54 objects:v63 count:16];
  v47 = a1;
  v44 = v8;
  v45 = v6;
  if (v10)
  {
    v11 = v10;
    v12 = 0;
    v13 = *v55;
    do
    {
      for (i = 0; i != v11; ++i)
      {
        if (*v55 != v13)
        {
          objc_enumerationMutation(v9);
        }

        v15 = *(*(&v54 + 1) + 8 * i);
        v16 = [v15 objectID];
        v17 = [v16 isEqual:v8];

        if (v17)
        {
          v18 = v15;

          v12 = v18;
        }

        v19 = [v15 objectChange];
        v20 = v19;
        if (v19)
        {
          [v19 dumpDebug:@" DUPLICATE: "];
        }
      }

      v11 = [v9 countByEnumeratingWithState:&v54 objects:v63 count:16];
    }

    while (v11);

    a1 = v47;
    v21 = v12;
    if (v12)
    {
      goto LABEL_17;
    }
  }

  else
  {
  }

  v21 = [v9 lastObject];
LABEL_17:
  v49 = v21;
  v22 = objc_autoreleasePoolPush();
  v23 = a1[5];
  v24 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
  {
    v25 = HMFGetLogIdentifier();
    v26 = [v49 objectID];
    v27 = [v26 UUIDString];
    *buf = 138543618;
    v60 = v25;
    v61 = 2112;
    v62 = v27;
    _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Selecting as user model %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v22);
  v52 = 0u;
  v53 = 0u;
  v50 = 0u;
  v51 = 0u;
  v28 = v9;
  v29 = [v28 countByEnumeratingWithState:&v50 objects:v58 count:16];
  if (v29)
  {
    v30 = v29;
    v31 = *v51;
    do
    {
      v32 = 0;
      v33 = v49;
      v48 = v30;
      do
      {
        if (*v51 != v31)
        {
          objc_enumerationMutation(v28);
        }

        v34 = *(*(&v50 + 1) + 8 * v32);
        if (([v34 isEqual:v33] & 1) == 0)
        {
          v35 = objc_autoreleasePoolPush();
          v36 = a1[5];
          v37 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v37, OS_LOG_TYPE_INFO))
          {
            HMFGetLogIdentifier();
            v38 = v31;
            v40 = v39 = v28;
            v41 = [v34 objectID];
            v42 = [v41 UUIDString];
            *buf = 138543618;
            v60 = v40;
            v61 = 2112;
            v62 = v42;
            _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_INFO, "%{public}@Dropping user model from processing %@", buf, 0x16u);

            v33 = v49;
            a1 = v47;

            v28 = v39;
            v31 = v38;
            v30 = v48;
          }

          objc_autoreleasePoolPop(v35);
          [a1[6] removeObject:v34];
        }

        ++v32;
      }

      while (v30 != v32);
      v30 = [v28 countByEnumeratingWithState:&v50 objects:v58 count:16];
    }

    while (v30);
  }

  v6 = v45;
  v5 = v46;
LABEL_31:

  v43 = *MEMORY[0x277D85DE8];
}

void __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke_897(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  [*(a1 + 32) updateCloudCache];
  v4 = [*(a1 + 40) _homeWithZoneID:*(a1 + 48)];
  if (*(a1 + 80) == 1 && ([*(a1 + 32) decryptionFailed] & 1) == 0 && v4)
  {
    [*(a1 + 40) _uploadHomeToCloud:v4 withDelay:0.0];
  }

  [*(a1 + 56) setOsTransaction:0];
  [*(a1 + 64) setOsTransaction:0];
  [*(a1 + 32) setOsTransaction:0];
  if ((*(a1 + 81) & 1) == 0 && v4 || [v4 migrationNeeded])
  {
    v5 = [*(a1 + 32) cloudZone];
    [v4 migrateAfterCloudMerge:v5];
  }

  [*(a1 + 40) _postMergeWatchPush];
  v6 = objc_autoreleasePoolPush();
  v7 = *(a1 + 40);
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v12 = 138543362;
    v13 = v9;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Object change handling complete", &v12, 0xCu);
  }

  objc_autoreleasePoolPop(v6);
  v10 = *(a1 + 72);
  if (v10)
  {
    (*(v10 + 16))(v10, v3);
  }

  v11 = *MEMORY[0x277D85DE8];
}

void __127__HMDHomeManager__handleTransactionsFetched_stagedTransaction_mustReplay_zoneID_cloudConflict_transactionError_syncCompletion___block_invoke_898(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 80));
  if (WeakRetained)
  {
    v5 = [*(a1 + 32) objectChange];
    v6 = [v5 uuid];
    v7 = [WeakRetained _homeWithUUID:v6];

    if (!v7 && [*(a1 + 40) count])
    {
      v8 = objc_autoreleasePoolPush();
      v9 = WeakRetained;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        v12 = *(a1 + 48);
        v17 = 138543618;
        v18 = v11;
        v19 = 2112;
        v20 = v12;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Cannot process fetched changes on home because home is not found for zone %@", &v17, 0x16u);
      }

      objc_autoreleasePoolPop(v8);
      v13 = *(a1 + 64);
      if (!v13)
      {
        goto LABEL_13;
      }

      v14 = *(v13 + 16);
      goto LABEL_12;
    }

    if ([*(a1 + 40) count])
    {
      [WeakRetained _handleFetchObjectChange:*(a1 + 40) home:v7 isLegacyTransaction:objc_msgSend(*(a1 + 56) completion:{"isLegacyTransaction"), *(a1 + 72)}];
    }

    else
    {
      v15 = *(a1 + 72);
      if (v15)
      {
        v14 = *(v15 + 16);
LABEL_12:
        v14();
      }
    }

LABEL_13:
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchObjectChange:(id)a3 home:(id)a4 isLegacyTransaction:(BOOL)a5 completion:(id)a6
{
  v49 = a5;
  v65 = *MEMORY[0x277D85DE8];
  v9 = a3;
  v10 = a4;
  v41 = v9;
  v42 = a6;
  v46 = v10;
  if (![v9 count])
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v61 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Nothing to applied", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    if (v42)
    {
      v42[2](v42, 0);
    }

    goto LABEL_36;
  }

  val = self;
  if (v10)
  {
    [v10 backingStore];
  }

  else
  {
    [(HMDHomeManager *)self backingStore];
  }

  v43 = [MEMORY[0x277CBEB58] set];
  if (v49)
  {
    v15 = +[HMDBackingStoreTransactionOptions defaultLegacyCloudOptions];
    v16 = [v40 transaction:@"kTransactionUpdate" options:v15];
    v45 = 0;
  }

  else
  {
    v17 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
    v16 = [v40 transaction:@"kTransactionUpdate" options:v17];

    v15 = +[HMDBackingStoreTransactionOptions cloudRequiresPushOptions];
    v45 = [v40 transaction:@"kTransactionUpdate" options:v15];
  }

  v58 = 0u;
  v59 = 0u;
  v56 = 0u;
  v57 = 0u;
  obj = v9;
  v18 = [obj countByEnumeratingWithState:&v56 objects:v64 count:16];
  if (!v18)
  {

    goto LABEL_35;
  }

  v44 = 0;
  v19 = *v57;
  do
  {
    for (i = 0; i != v18; ++i)
    {
      if (*v57 != v19)
      {
        objc_enumerationMutation(obj);
      }

      v21 = *(*(&v56 + 1) + 8 * i);
      if (!v49)
      {
        if ([*(*(&v56 + 1) + 8 * i) isPushAfterApply])
        {
          v22 = objc_autoreleasePoolPush();
          v23 = val;
          v24 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
          {
            v25 = HMFGetLogIdentifier();
            v26 = [v21 objectID];
            *buf = 138543618;
            v61 = v25;
            v62 = 2112;
            v63 = v26;
            _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Change should be pushed after being applied: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
          v27 = [v21 objectChange];
          [v45 add:v27 withMessage:0];
          v44 = 1;
        }

        else
        {
          if (((v46 != 0) & [v21 isDropStagedAfterApply]) != 1)
          {
            goto LABEL_27;
          }

          v28 = objc_autoreleasePoolPush();
          v29 = val;
          v30 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
          {
            v31 = HMFGetLogIdentifier();
            v32 = [v21 objectID];
            *buf = 138543618;
            v61 = v31;
            v62 = 2112;
            v63 = v32;
            _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Object conflict, drop all staged changes for object: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v28);
          v27 = [v21 rowIDs];
          [v43 addObjectsFromArray:v27];
        }
      }

LABEL_27:
      v33 = [v21 objectChange];
      [v16 add:v33 withMessage:0];
    }

    v18 = [obj countByEnumeratingWithState:&v56 objects:v64 count:16];
  }

  while (v18);

  if (v44)
  {
    v34 = objc_autoreleasePoolPush();
    v35 = val;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_INFO))
    {
      v37 = HMFGetLogIdentifier();
      *buf = 138543362;
      v61 = v37;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_INFO, "%{public}@Saving changes to push after applying", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v34);
    [v45 save];
    if (v46)
    {
      [(HMDHomeManager *)v35 _uploadHomeToCloud:v46 withDelay:0.0];
    }
  }

LABEL_35:
  objc_initWeak(buf, val);
  v50[0] = MEMORY[0x277D85DD0];
  v50[1] = 3221225472;
  v50[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke;
  v50[3] = &unk_279732188;
  objc_copyWeak(&v54, buf);
  v51 = v46;
  v55 = v49;
  v53 = v42;
  v38 = v43;
  v52 = v38;
  [v16 run:v50];

  objc_destroyWeak(&v54);
  objc_destroyWeak(buf);

LABEL_36:
  v39 = *MEMORY[0x277D85DE8];
}

void __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke(uint64_t a1, void *a2)
{
  v32 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [*(a1 + 32) name];
      *buf = 138543874;
      v27 = v8;
      v28 = 2112;
      v29 = v9;
      v30 = 2112;
      v31 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Applied object changes to home: %@ with error %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
    if (v3)
    {
      if (*(a1 + 48))
      {
        v10 = [v6 workQueue];
        v18[0] = MEMORY[0x277D85DD0];
        v18[1] = 3221225472;
        v18[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_888;
        v18[3] = &unk_279735738;
        v20 = *(a1 + 48);
        v19 = v3;
        dispatch_async(v10, v18);
      }
    }

    else
    {
      aBlock[0] = MEMORY[0x277D85DD0];
      aBlock[1] = 3221225472;
      aBlock[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_883;
      aBlock[3] = &unk_279731D50;
      objc_copyWeak(&v24, (a1 + 56));
      v22 = *(a1 + 32);
      v25 = *(a1 + 64);
      v23 = *(a1 + 48);
      v11 = _Block_copy(aBlock);
      if ([*(a1 + 40) count])
      {
        v12 = objc_autoreleasePoolPush();
        v13 = v6;
        v14 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
        {
          v15 = HMFGetLogIdentifier();
          *buf = 138543362;
          v27 = v15;
          _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Dropping changes for object conflicts", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v12);
        v16 = [*(a1 + 40) allObjects];
        [v13 _updateModelChangesAsPushed:v16 home:*(a1 + 32) pushMask:3 completion:v11];
      }

      else
      {
        v11[2](v11);
      }

      objc_destroyWeak(&v24);
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_883(uint64_t a1)
{
  v22 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v3 = *(a1 + 32);
    if (v3 && ([v3 isOwnerUser] & 1) == 0 && *(a1 + 56) == 1)
    {
      v4 = objc_autoreleasePoolPush();
      v5 = WeakRetained;
      v6 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v7 = HMFGetLogIdentifier();
        *buf = 138543362;
        v21 = v7;
        _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Saving changes to shared home from legacy merge", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v4);
      v8 = [*(a1 + 32) sharedHomeModel];
      v9 = [v5 backingStore];
      v10 = +[HMDBackingStoreTransactionOptions defaultLegacyCloudOptions];
      v11 = [v9 transaction:@"pushSharedHomeModel" options:v10];

      [v11 add:v8 withMessage:0];
      v16[0] = MEMORY[0x277D85DD0];
      v16[1] = 3221225472;
      v16[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_887;
      v16[3] = &unk_2797346E0;
      objc_copyWeak(&v19, (a1 + 48));
      v17 = *(a1 + 32);
      v18 = *(a1 + 40);
      [v11 save:v16];

      objc_destroyWeak(&v19);
      goto LABEL_10;
    }

    if (*(a1 + 40))
    {
      v12 = [WeakRetained workQueue];
      v14[0] = MEMORY[0x277D85DD0];
      v14[1] = 3221225472;
      v14[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_3;
      v14[3] = &unk_2797348C0;
      v15 = *(a1 + 40);
      dispatch_async(v12, v14);

      v8 = v15;
LABEL_10:
    }
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_887(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    v3 = [HMDHomeSaveRequest alloc];
    v4 = [(HMDHomeSaveRequest *)v3 initWithHome:*(a1 + 32) reason:*MEMORY[0x277CD2080] information:0 postSyncNotification:1 objectChange:1];
    [WeakRetained saveWithRequest:v4];
    if (*(a1 + 40))
    {
      v5 = [WeakRetained workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __79__HMDHomeManager__handleFetchObjectChange_home_isLegacyTransaction_completion___block_invoke_2;
      block[3] = &unk_2797348C0;
      v7 = *(a1 + 40);
      dispatch_async(v5, block);
    }
  }
}

- (void)_handleFetchModifyHome:(id)a3 isLegacyTransaction:(BOOL)a4 completion:(id)a5
{
  v6 = a4;
  v53 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a5;
  if (!v8)
  {
    v10 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke;
    block[3] = &unk_2797348C0;
    v48 = v9;
    dispatch_async(v10, block);
  }

  v41 = [MEMORY[0x277CBEB58] set];
  v11 = [(HMDHomeManager *)self backingStore];
  if (v6)
  {
    v12 = +[HMDBackingStoreTransactionOptions defaultLegacyCloudOptions];
    v13 = [v11 transaction:@"kTransactionUpdate" options:v12];

    v14 = 0;
    v15 = 0;
LABEL_13:

    goto LABEL_14;
  }

  v16 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
  v13 = [v11 transaction:@"kTransactionUpdate" options:v16];

  v17 = [(HMDHomeManager *)self backingStore];
  v18 = +[HMDBackingStoreTransactionOptions cloudRequiresPushOptions];
  v15 = [v17 transaction:@"kTransactionUpdate" options:v18];

  if ([v8 isPushAfterApply])
  {
    v19 = objc_autoreleasePoolPush();
    v20 = self;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_INFO))
    {
      v22 = HMFGetLogIdentifier();
      v23 = [v8 objectID];
      *buf = 138543618;
      v50 = v22;
      v51 = 2112;
      v52 = v23;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Change should be pushed after being applied: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v19);
    v11 = [v8 objectChange];
    [v15 add:v11 withMessage:0];
    v14 = 1;
    goto LABEL_13;
  }

  if ([v8 isDropStagedAfterApply])
  {
    v24 = objc_autoreleasePoolPush();
    v25 = self;
    v26 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
    {
      v27 = HMFGetLogIdentifier();
      v28 = [v8 objectID];
      *buf = 138543618;
      v50 = v27;
      v51 = 2112;
      v52 = v28;
      _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Object conflict, drop all staged changes for object: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v24);
    v11 = [v8 rowIDs];
    [v41 addObjectsFromArray:v11];
    v14 = 0;
    goto LABEL_13;
  }

  v14 = 0;
LABEL_14:
  v29 = [v8 objectChange];
  [v13 add:v29 withMessage:0];

  if (v14)
  {
    v30 = objc_autoreleasePoolPush();
    v31 = self;
    v32 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
    {
      v33 = HMFGetLogIdentifier();
      *buf = 138543362;
      v50 = v33;
      _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@Saving changes to push after applying", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v30);
    [v15 save];
    v34 = [v8 objectChange];
    v35 = [v34 uuid];
    v36 = [(HMDHomeManager *)v31 _homeWithUUID:v35];

    if (v36)
    {
      [(HMDHomeManager *)v31 _uploadHomeToCloud:v36 withDelay:0.0];
    }
  }

  objc_initWeak(buf, self);
  v42[0] = MEMORY[0x277D85DD0];
  v42[1] = 3221225472;
  v42[2] = __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_880;
  v42[3] = &unk_2797326E8;
  objc_copyWeak(&v46, buf);
  v37 = v9;
  v45 = v37;
  v38 = v8;
  v43 = v38;
  v39 = v41;
  v44 = v39;
  [v13 run:v42];

  objc_destroyWeak(&v46);
  objc_destroyWeak(buf);

  v40 = *MEMORY[0x277D85DE8];
}

uint64_t __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke(uint64_t a1)
{
  v2 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  v3 = *(a1 + 32);
  if (v3)
  {
    v5 = v2;
    v3 = (*(v3 + 16))();
    v2 = v5;
  }

  return MEMORY[0x2821F96F8](v3, v2);
}

void __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_880(id *a1, void *a2)
{
  v30 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 7);
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v27 = v8;
      v28 = 2112;
      v29 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Home modified with completed with with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    if (v3)
    {
      if (a1[6])
      {
        v9 = [v6 workQueue];
        v20[0] = MEMORY[0x277D85DD0];
        v20[1] = 3221225472;
        v20[2] = __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_882;
        v20[3] = &unk_279735738;
        v22 = a1[6];
        v21 = v3;
        dispatch_async(v9, v20);
      }
    }

    else
    {
      aBlock[0] = MEMORY[0x277D85DD0];
      aBlock[1] = 3221225472;
      aBlock[2] = __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_881;
      aBlock[3] = &unk_279731EB8;
      objc_copyWeak(&v25, a1 + 7);
      v24 = a1[6];
      v10 = _Block_copy(aBlock);
      v11 = [a1[4] objectChange];
      v12 = [v11 uuid];
      v13 = [v6 _homeWithUUID:v12];

      if (v13 && [a1[5] count])
      {
        v14 = objc_autoreleasePoolPush();
        v15 = v6;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v17 = HMFGetLogIdentifier();
          *buf = 138543362;
          v27 = v17;
          _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Dropped changes for object conflicts", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v14);
        v18 = [a1[5] allObjects];
        [v15 _updateModelChangesAsPushed:v18 home:v13 pushMask:3 completion:v10];
      }

      else
      {
        v10[2](v10);
      }

      objc_destroyWeak(&v25);
    }
  }

  v19 = *MEMORY[0x277D85DE8];
}

void __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_881(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v3 = WeakRetained;
  if (WeakRetained && *(a1 + 32))
  {
    v4 = [WeakRetained workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __72__HMDHomeManager__handleFetchModifyHome_isLegacyTransaction_completion___block_invoke_2;
    block[3] = &unk_2797348C0;
    v6 = *(a1 + 32);
    dispatch_async(v4, block);
  }
}

- (void)_runFetchHomeFromCloudZone:(id)a3 cloudConflict:(BOOL)a4 syncCompletion:(id)a5
{
  v35 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a5;
  v10 = [(HMDHomeManager *)self hasiCloudAndControllerKey];
  v11 = objc_autoreleasePoolPush();
  if (v10)
  {
    v12 = objc_autoreleasePoolPush();
    v13 = self;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v32 = v15;
      v33 = 2112;
      v34 = v8;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Fetching home zone changes from the cloud: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v16 = [(HMDHomeManager *)v13 cloudDataSyncManager];
    v17 = [v16 cloudCache];

    v18 = [v8 UUIDString];
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke;
    v26[3] = &unk_279732160;
    v26[4] = v13;
    v27 = v8;
    v28 = v18;
    v29 = v9;
    v30 = a4;
    v19 = v18;
    [v17 homeZoneWithName:v19 owner:&stru_286509E58 completion:v26];

    objc_autoreleasePoolPop(v11);
  }

  else
  {
    v20 = self;
    v21 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v21, OS_LOG_TYPE_DEFAULT))
    {
      v22 = HMFGetLogIdentifier();
      v23 = [v8 UUIDString];
      *buf = 138543618;
      v32 = v22;
      v33 = 2112;
      v34 = v23;
      _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping zone fetch to %@.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    if (v9)
    {
      v24 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75 description:@"Operation was cancelled before it could run" reason:@"iCloud & Controller key was not available" suggestion:@"Make sure that you are signed into iCloud account"];
      (*(v9 + 2))(v9, v24);
    }
  }

  v25 = *MEMORY[0x277D85DE8];
}

void __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) _homeWithZoneID:*(a1 + 40)];
  v8 = v7 == 0;

  v23 = 0;
  v24 = &v23;
  v25 = 0x3032000000;
  v26 = __Block_byref_object_copy__172847;
  v27 = __Block_byref_object_dispose__172848;
  v28 = [[HMDCloudTransaction alloc] initWithType:4 temporaryCache:0 noLocalData:v8];
  [v24[5] updateCloudZone:v5];
  v9 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.fetch-from-zone"];
  [v24[5] setOsTransaction:v9];

  objc_initWeak(&location, *(a1 + 32));
  v10 = [*(a1 + 32) cloudDataSyncManager];
  v11 = v24[5];
  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_2;
  v13[3] = &unk_279732138;
  objc_copyWeak(&v19, &location);
  v18 = &v23;
  v14 = *(a1 + 40);
  v17 = *(a1 + 56);
  v15 = *(a1 + 48);
  v20 = v8;
  v12 = v5;
  v16 = v12;
  v21 = *(a1 + 64);
  [v10 fetchTransaction:v11 completionHandler:v13];

  objc_destroyWeak(&v19);
  objc_destroyWeak(&location);
  _Block_object_dispose(&v23, 8);
}

void __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_2(uint64_t a1, void *a2)
{
  v69 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    v6 = [WeakRetained logEventSubmitter];
    v7 = +[HMDDecryptionCompletedLogEvent decryptionCompletedWithFailure:](HMDDecryptionCompletedLogEvent, "decryptionCompletedWithFailure:", [*(*(*(a1 + 64) + 8) + 40) decryptionFailed]);
    [v6 submitLogEvent:v7];

    v8 = [v5 _zoneInformationWithUUID:*(a1 + 32)];
    v9 = _Block_copy(*(a1 + 56));
    if (!v3 && ![*(*(*(a1 + 64) + 8) + 40) decryptionFailed])
    {
      if (v8)
      {
        [v8 setFetchFailed:0];
        if (([v8 isZoneCreated] & 1) == 0)
        {
          [v5 addTransactionAfterPush:v8];
        }

        aBlock[0] = MEMORY[0x277D85DD0];
        aBlock[1] = 3221225472;
        aBlock[2] = __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_877;
        aBlock[3] = &unk_2797320E8;
        v59 = v8;
        v60 = v5;
        v62 = *(a1 + 80);
        v41 = *(a1 + 56);
        v31 = v41;
        v61 = v41;
        v32 = _Block_copy(aBlock);
      }

      else
      {
        v32 = v9;
      }

      v9 = [v5 _homeWithZoneID:{*(a1 + 32), v41}];
      v33 = [[HMDCloudTransaction alloc] initWithType:4 temporaryCache:1];
      [(HMDCloudTransaction *)v33 updateCloudZone:*(a1 + 48)];
      if (v9)
      {
        v34 = [[HMDCloudTransaction alloc] initWithType:4 temporaryCache:1];
        [(HMDCloudTransaction *)v34 updateCloudZone:*(a1 + 48)];
        v50[0] = MEMORY[0x277D85DD0];
        v50[1] = 3221225472;
        v50[2] = __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_878;
        v50[3] = &unk_279732110;
        v35 = *(a1 + 64);
        v50[4] = v5;
        v51 = v33;
        v56 = v35;
        v52 = v34;
        v36 = *(a1 + 32);
        v57 = *(a1 + 81);
        v53 = v36;
        v54 = 0;
        v55 = v32;
        v37 = v32;
        v38 = v34;
        [v5 _loadHomeModelChanges:v33 mustReplay:v38 legacyPush:0 home:v9 completion:v50];
      }

      else
      {
        v43[0] = MEMORY[0x277D85DD0];
        v43[1] = 3221225472;
        v43[2] = __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_2_879;
        v43[3] = &unk_279731E40;
        v48 = *(a1 + 64);
        v43[4] = v5;
        v44 = v33;
        v39 = *(a1 + 32);
        v49 = *(a1 + 81);
        v45 = v39;
        v46 = 0;
        v47 = v32;
        v38 = v32;
        [v5 _loadHomeManagerTransactionsToPush:v33 mustReplay:0 forLegacyPush:0 includeAllChanges:1 completion:v43];
      }

      goto LABEL_33;
    }

    if ([*(*(*(a1 + 64) + 8) + 40) wasZoneDeleted])
    {
      v10 = [v5 _zoneInformationWithUUID:*(a1 + 32)];
      if ([v10 isZoneCreated])
      {
        v11 = [v5 _homeWithZoneID:*(a1 + 32)];
        if (!v11)
        {
          v12 = [v5 cloudDataSyncManager];
          [v12 removeHomeZoneName:*(a1 + 40)];

          v13 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:*(a1 + 40)];
          [v5 _removeCloudZone:v13 updateHomeManager:1];
        }
      }
    }

    else
    {
      if (v8)
      {
        [v8 setFetchFailed:1];
      }

      v14 = objc_autoreleasePoolPush();
      v15 = v5;
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
      {
        v17 = HMFGetLogIdentifier();
        [v3 hmd_conciseCKError];
        v42 = v8;
        v19 = v18 = v9;
        v20 = [v19 shortDescription];
        *buf = 138543618;
        v64 = v17;
        v65 = 2114;
        v66 = v20;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Not processing fetch with error: %{public}@", buf, 0x16u);

        v9 = v18;
        v8 = v42;
      }

      objc_autoreleasePoolPop(v14);
    }

    v21 = [v3 domain];
    if ([v21 isEqualToString:*MEMORY[0x277CBBF50]])
    {
      v22 = [v3 userInfo];

      if (!v22)
      {
        goto LABEL_22;
      }

      v23 = [v3 userInfo];
      v21 = [v23 hmf_numberForKey:*MEMORY[0x277CBBF68]];

      if (v21)
      {
        v24 = objc_autoreleasePoolPush();
        v25 = v5;
        v26 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          v28 = *(a1 + 40);
          *buf = 138543874;
          v64 = v27;
          v65 = 2112;
          v66 = v28;
          v67 = 2112;
          v68 = v21;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Rescheduling zone fetch %@ with delay %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v24);
        v29 = *(a1 + 32);
        [v21 doubleValue];
        [v25 _fetchHomeFromCloudZone:v29 cloudConflict:0 withDelay:0 completionHandler:?];
      }
    }

LABEL_22:
    [*(*(*(a1 + 64) + 8) + 40) setOsTransaction:0];
    v30 = *(a1 + 56);
    if (v30)
    {
      (*(v30 + 16))(v30, v3);
    }

LABEL_33:
  }

  v40 = *MEMORY[0x277D85DE8];
}

void __74__HMDHomeManager__runFetchHomeFromCloudZone_cloudConflict_syncCompletion___block_invoke_877(uint64_t a1, void *a2)
{
  v29 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if ([*(a1 + 32) isFirstFetch])
  {
    v4 = [*(*(*(a1 + 56) + 8) + 40) hasValidChanges];
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 40);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [*(a1 + 32) uuid];
      v10 = [v9 UUIDString];
      v11 = HMFBooleanToString();
      *buf = 138543874;
      v24 = v8;
      v25 = 2112;
      v26 = v10;
      v27 = 2112;
      v28 = v11;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Zone ready determined for zone: %@; didValuesChange: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 32) setFirstFetch:0];
    v12 = [*(a1 + 40) notificationCenter];
    v13 = [*(a1 + 32) uuid];
    v14 = [v13 UUIDString];
    v22[0] = v14;
    v21[1] = @"HMDCR.stc";
    v15 = [MEMORY[0x277CCABB0] numberWithBool:v4];
    v22[1] = v15;
    v21[2] = @"HMDCR.if";
    v16 = [MEMORY[0x277CCABB0] numberWithInt:*(a1 + 64) ^ 1u];
    v22[2] = v16;
    v17 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v22 forKeys:v21 count:3];
    [v12 postNotificationName:@"HMDCloudZoneReadyNotification" object:0 userInfo:v17];
  }

  if ([*(a1 + 40) _zonesFetched])
  {
    v18 = [*(a1 + 40) cloudDataSyncManager];
    [v18 updateCloudDataSyncFilterState:1];
  }

  v19 = *(a1 + 48);
  if (v19)
  {
    (*(v19 + 16))(v19, v3);
  }

  v20 = *MEMORY[0x277D85DE8];
}

- (BOOL)hasValidControllerKeyToSave
{
  v2 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v3 = [v2 isLocalDataDecryptionFailed];

  return v3 ^ 1;
}

- (BOOL)hasiCloudAndControllerKey
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v4 = [v3 isiCloudSwitchEnabled];

  v5 = [(HMDHomeManager *)self cloudDataSource];
  v6 = [v5 isControllerKeyAvailable];

  v7 = v4 & v6;
  if ((v4 & v6 & 1) == 0)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = HMFGetLogIdentifier();
      v12 = HMFBooleanToString();
      v13 = HMFBooleanToString();
      v16 = 138543874;
      v17 = v11;
      v18 = 2112;
      v19 = v12;
      v20 = 2112;
      v21 = v13;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@iCloud Switch is:%@, controller key is available: %@", &v16, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v14 = *MEMORY[0x277D85DE8];
  return v7;
}

void __84__HMDHomeManager__fetchHomeFromCloudZone_cloudConflict_withDelay_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v11 = a2;
  v7 = a3;
  if (a4)
  {
    if (!v11)
    {
      goto LABEL_9;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:&stru_286509E58];
    v11[2](v11, v8);
  }

  else
  {
    WeakRetained = objc_loadWeakRetained((a1 + 48));
    if (WeakRetained)
    {
      v8 = WeakRetained;
      [WeakRetained _runFetchHomeFromCloudZone:*(a1 + 32) cloudConflict:objc_msgSend(v7 syncCompletion:{"isCloudConflict"), v11}];
    }

    else
    {
      v8 = *(a1 + 40);
      if (v8)
      {
        v10 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled as the HMDHomeManager object went out of scope" reason:@"HMDHomeManager is no longer valid" suggestion:@"Debug... May be..."];
        (v8)[2](v8, v10);

        v8 = 0;
      }
    }
  }

LABEL_9:
}

- (void)fetchHomeFromCloudZone:(id)a3 cloudConflict:(BOOL)a4 withDelay:(double)a5
{
  v8 = a3;
  objc_initWeak(&location, self);
  v9 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __65__HMDHomeManager_fetchHomeFromCloudZone_cloudConflict_withDelay___block_invoke;
  block[3] = &unk_279732098;
  objc_copyWeak(v13, &location);
  v12 = v8;
  v14 = a4;
  v13[1] = *&a5;
  v10 = v8;
  dispatch_async(v9, block);

  objc_destroyWeak(v13);
  objc_destroyWeak(&location);
}

void __65__HMDHomeManager_fetchHomeFromCloudZone_cloudConflict_withDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _fetchHomeFromCloudZone:*(a1 + 32) cloudConflict:*(a1 + 56) withDelay:0 completionHandler:*(a1 + 48)];
    WeakRetained = v3;
  }
}

- (void)notifyZonesCloudZoneReady:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __44__HMDHomeManager_notifyZonesCloudZoneReady___block_invoke;
  block[3] = &unk_279732E78;
  objc_copyWeak(&v9, &location);
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, block);

  objc_destroyWeak(&v9);
  objc_destroyWeak(&location);
}

void __44__HMDHomeManager_notifyZonesCloudZoneReady___block_invoke(uint64_t a1)
{
  v42 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v35 = 0u;
    v36 = 0u;
    v33 = 0u;
    v34 = 0u;
    v3 = *(a1 + 32);
    v32 = [v3 countByEnumeratingWithState:&v33 objects:v41 count:16];
    if (v32)
    {
      v31 = *v34;
      *&v4 = 138543618;
      v28 = v4;
      v29 = v3;
      do
      {
        for (i = 0; i != v32; ++i)
        {
          if (*v34 != v31)
          {
            objc_enumerationMutation(v3);
          }

          v6 = *(*(&v33 + 1) + 8 * i);
          v7 = [v6 hmf_UUIDForKey:{@"HMDCR.id", v28}];
          if (v7)
          {
            v8 = [WeakRetained _zoneInformationWithUUID:v7];
            if (v8)
            {
              v9 = objc_autoreleasePoolPush();
              v10 = WeakRetained;
              v11 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
              {
                HMFGetLogIdentifier();
                v12 = v30 = v9;
                v13 = [v8 uuid];
                [v13 UUIDString];
                v15 = v14 = WeakRetained;
                *buf = v28;
                v38 = v12;
                v39 = 2112;
                v40 = v15;
                _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Zone ready determined for zone: %@", buf, 0x16u);

                v3 = v29;
                WeakRetained = v14;

                v9 = v30;
              }

              objc_autoreleasePoolPop(v9);
              [v8 setFirstFetch:0];
            }

            else
            {
              v20 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:@"1411CE6C-B4DE-4622-A49D-F66FE296D6B5"];
              v21 = [v7 isEqual:v20];

              if (v21)
              {
                v22 = objc_autoreleasePoolPush();
                v23 = WeakRetained;
                v24 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
                {
                  v25 = HMFGetLogIdentifier();
                  *buf = 138543362;
                  v38 = v25;
                  _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Home Manager Zone determined ready", buf, 0xCu);
                }

                objc_autoreleasePoolPop(v22);
                [v23 setHomeManagerZoneFirstFetch:0];
              }
            }
          }

          else
          {
            v16 = objc_autoreleasePoolPush();
            v17 = WeakRetained;
            v18 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
            {
              v19 = HMFGetLogIdentifier();
              *buf = 138543362;
              v38 = v19;
              _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Zone ready determined for legacy zone", buf, 0xCu);
            }

            objc_autoreleasePoolPop(v16);
          }

          v26 = [WeakRetained notificationCenter];
          [v26 postNotificationName:@"HMDCloudZoneReadyNotification" object:0 userInfo:v6];
        }

        v32 = [v3 countByEnumeratingWithState:&v33 objects:v41 count:16];
      }

      while (v32);
    }
  }

  v27 = *MEMORY[0x277D85DE8];
}

- (void)schedulePostFetch
{
  objc_initWeak(&location, self);
  v3 = [(HMDHomeManager *)self workQueue];
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __35__HMDHomeManager_schedulePostFetch__block_invoke;
  v4[3] = &unk_279732FD8;
  objc_copyWeak(&v5, &location);
  dispatch_async(v3, v4);

  objc_destroyWeak(&v5);
  objc_destroyWeak(&location);
}

void __35__HMDHomeManager_schedulePostFetch__block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v2 = WeakRetained;
    [WeakRetained _schedulePostFetch];
    WeakRetained = v2;
  }
}

- (void)_schedulePostFetch
{
  objc_initWeak(&location, self);
  v6 = MEMORY[0x277D85DD0];
  v7 = 3221225472;
  v8 = __36__HMDHomeManager__schedulePostFetch__block_invoke;
  v9 = &unk_279731CB0;
  objc_copyWeak(&v10, &location);
  v3 = _Block_copy(&v6);
  v4 = [HMDSyncOperation postFetchOperationWithBlock:v3, v6, v7, v8, v9];
  v5 = [(HMDHomeManager *)self syncManager];
  [v5 addOperation:v4];

  objc_destroyWeak(&v10);
  objc_destroyWeak(&location);
}

void __36__HMDHomeManager__schedulePostFetch__block_invoke(uint64_t a1, void *a2, uint64_t a3, int a4)
{
  v10 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v7 = WeakRetained;
  if (!WeakRetained || a4)
  {
    if (v10)
    {
      v9 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
      v10[2](v10, v9);
    }
  }

  else
  {
    v8 = [WeakRetained cloudDataSyncManager];
    [v8 cacheDatabaseServerToken];

    if (v10)
    {
      v10[2](v10, 0);
    }
  }
}

- (void)_processFetchZonesResults:(id)a3 completion:(id)a4
{
  v24 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v19 = 0u;
  v20 = 0u;
  v21 = 0u;
  v22 = 0u;
  v7 = v5;
  v8 = [v7 countByEnumeratingWithState:&v19 objects:v23 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = 0;
    v11 = *v20;
    while (2)
    {
      for (i = 0; i != v9; ++i)
      {
        if (*v20 != v11)
        {
          objc_enumerationMutation(v7);
        }

        v13 = *(*(&v19 + 1) + 8 * i);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v14 = v13;
        }

        else
        {
          v14 = 0;
        }

        v15 = v14;

        if (v15)
        {
          if (v10)
          {
            if (HMDIsCKErrorZoneNotFound(v15))
            {
              v13 = v10;
            }

            else
            {
              v17 = v15;
            }
          }

          else
          {
            v16 = v15;
          }

          if (!HMDIsCKErrorZoneNotFound(v13))
          {

            v10 = v13;
            goto LABEL_22;
          }

          v10 = v13;
        }
      }

      v9 = [v7 countByEnumeratingWithState:&v19 objects:v23 count:16];
      if (v9)
      {
        continue;
      }

      break;
    }
  }

  else
  {
    v10 = 0;
  }

LABEL_22:

  if (v6)
  {
    v6[2](v6, v10);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_fetchAllZones:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __33__HMDHomeManager__fetchAllZones___block_invoke;
  block[3] = &unk_279731EB8;
  objc_copyWeak(&v9, &location);
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, block);

  objc_destroyWeak(&v9);
  objc_destroyWeak(&location);
}

void __33__HMDHomeManager__fetchAllZones___block_invoke(uint64_t a1)
{
  v42 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v31 = a1;
    v3 = [MEMORY[0x277CBEB18] array];
    v4 = MEMORY[0x277D2C900];
    v40[0] = MEMORY[0x277D85DD0];
    v40[1] = 3221225472;
    v40[2] = __33__HMDHomeManager__fetchAllZones___block_invoke_2;
    v40[3] = &unk_279732020;
    v40[4] = WeakRetained;
    v5 = [MEMORY[0x277D2C938] immediateScheduler];
    v6 = [v4 futureWithBlock:v40 scheduler:v5];

    v32 = v3;
    v30 = v6;
    [v3 addObject:v6];
    v38 = 0u;
    v39 = 0u;
    v36 = 0u;
    v37 = 0u;
    v7 = [WeakRetained cloudZones];
    v8 = [v7 copy];

    v9 = [v8 countByEnumeratingWithState:&v36 objects:v41 count:16];
    if (v9)
    {
      v10 = v9;
      v11 = *v37;
      do
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v37 != v11)
          {
            objc_enumerationMutation(v8);
          }

          v13 = *(*(&v36 + 1) + 8 * i);
          v14 = [v13 uuid];
          v15 = [v14 UUIDString];

          v16 = [WeakRetained cloudDataSyncManager];
          v17 = [v16 cloudCache];
          v18 = [v17 homeZoneExists:v15];

          if (v18)
          {
            v19 = MEMORY[0x277D2C900];
            v35[0] = MEMORY[0x277D85DD0];
            v35[1] = 3221225472;
            v35[2] = __33__HMDHomeManager__fetchAllZones___block_invoke_870;
            v35[3] = &unk_279732048;
            v35[4] = WeakRetained;
            v35[5] = v13;
            v20 = [MEMORY[0x277D2C938] immediateScheduler];
            v21 = [v19 futureWithBlock:v35 scheduler:v20];

            [v32 addObject:v21];
          }

          else
          {
            v21 = [WeakRetained cloudDataSyncManager];
            v22 = [v13 ownerName];
            [v21 addHomeZoneName:v15 owner:v22];
          }
        }

        v10 = [v8 countByEnumeratingWithState:&v36 objects:v41 count:16];
      }

      while (v10);
    }

    v23 = MEMORY[0x277D2C900];
    v24 = MEMORY[0x277D2C938];
    v25 = [WeakRetained workQueue];
    v26 = [v24 schedulerWithDispatchQueue:v25];
    v27 = [v23 combineAllFutures:v32 ignoringErrors:1 scheduler:v26];
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __33__HMDHomeManager__fetchAllZones___block_invoke_872;
    v33[3] = &unk_279732070;
    v33[4] = WeakRetained;
    v34 = *(v31 + 32);
    v28 = [v27 addSuccessBlock:v33];
  }

  v29 = *MEMORY[0x277D85DE8];
}

void __33__HMDHomeManager__fetchAllZones___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = *(a1 + 32);
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __33__HMDHomeManager__fetchAllZones___block_invoke_3;
  v6[3] = &unk_2797358C8;
  v6[4] = v4;
  v7 = v3;
  v5 = v3;
  [v4 _fetchHomeManagerCloudConflict:0 withDelay:v6 completionHandler:0.0];
}

void __33__HMDHomeManager__fetchAllZones___block_invoke_870(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = *(a1 + 32);
  v5 = [*(a1 + 40) uuid];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __33__HMDHomeManager__fetchAllZones___block_invoke_2_871;
  v7[3] = &unk_279734D88;
  v8 = *(a1 + 32);
  v9 = v3;
  v6 = v3;
  [v4 _fetchHomeFromCloudZone:v5 cloudConflict:0 withDelay:v7 completionHandler:0.0];
}

void __33__HMDHomeManager__fetchAllZones___block_invoke_2_871(id *a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = a1[4];
  v6 = HMFGetOSLogHandle();
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_INFO);
  if (v3)
  {
    if (v7)
    {
      v8 = HMFGetLogIdentifier();
      v9 = [a1[5] uuid];
      v15 = 138543874;
      v16 = v8;
      v17 = 2112;
      v18 = v9;
      v19 = 2112;
      v20 = v3;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Home cloud zone [%@] sync finished with error : %@", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v4);
    [a1[6] finishWithError:v3];
  }

  else
  {
    if (v7)
    {
      v10 = HMFGetLogIdentifier();
      v11 = [a1[5] uuid];
      v15 = 138543618;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Home cloud zone (%@) sync finished successfully", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    v12 = a1[6];
    v13 = NAEmptyResult();
    [v12 finishWithResult:v13];
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __33__HMDHomeManager__fetchAllZones___block_invoke_3(uint64_t a1, void *a2)
{
  v17 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  v7 = os_log_type_enabled(v6, OS_LOG_TYPE_INFO);
  if (v3)
  {
    if (v7)
    {
      v8 = HMFGetLogIdentifier();
      v13 = 138543618;
      v14 = v8;
      v15 = 2112;
      v16 = v3;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@HomeManager cloud sync finished with error : %@", &v13, 0x16u);
    }

    objc_autoreleasePoolPop(v4);
    [*(a1 + 40) finishWithError:v3];
  }

  else
  {
    if (v7)
    {
      v9 = HMFGetLogIdentifier();
      v13 = 138543362;
      v14 = v9;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@HomeManager cloud sync finished successfully", &v13, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    v10 = *(a1 + 40);
    v11 = NAEmptyResult();
    [v10 finishWithResult:v11];
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_runUploadHomeToCloud:(id)a3 syncCompletion:(id)a4
{
  v40 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  if ([(HMDHomeManager *)self hasiCloudAndControllerKey])
  {
    v8 = [(HMDHomeManager *)self _homeWithUUID:v6];
    if (v8 && (-[HMDHomeManager pendingHomesBeingRemoved](self, "pendingHomesBeingRemoved"), v9 = objc_claimAutoreleasedReturnValue(), v10 = [v9 containsObject:v6], v9, !v10))
    {
      v22 = objc_autoreleasePoolPush();
      v23 = objc_autoreleasePoolPush();
      v24 = self;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_DEFAULT))
      {
        v26 = HMFGetLogIdentifier();
        *buf = 138543362;
        v37 = v26;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_DEFAULT, "%{public}@Pushing changes up to the cloud", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v23);
      v27 = [(HMDHomeManager *)v24 cloudDataSyncManager];
      v28 = [v27 cloudCache];

      objc_initWeak(buf, v24);
      v29 = [v8 zoneID];
      v30 = [v29 UUIDString];

      v32[0] = MEMORY[0x277D85DD0];
      v32[1] = 3221225472;
      v32[2] = __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke;
      v32[3] = &unk_279731FF8;
      v32[4] = v24;
      v8 = v8;
      v33 = v8;
      objc_copyWeak(&v35, buf);
      v34 = v7;
      [v28 homeZoneWithName:v30 owner:&stru_286509E58 completion:v32];

      objc_destroyWeak(&v35);
      objc_destroyWeak(buf);

      objc_autoreleasePoolPop(v22);
    }

    else
    {
      v11 = objc_autoreleasePoolPush();
      v12 = self;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        v15 = [v6 UUIDString];
        *buf = 138543618;
        v37 = v14;
        v38 = 2112;
        v39 = v15;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Cannot push home %@ data to the cloud because it was removed", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v11);
      if (v7)
      {
        v16 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52 description:@"Operation not allowed because home was removed" reason:@"HMDHomeManager not allowing operation" suggestion:0];
        (*(v7 + 2))(v7, v16);
      }
    }

    goto LABEL_15;
  }

  v17 = objc_autoreleasePoolPush();
  v18 = self;
  v19 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_DEFAULT))
  {
    v20 = HMFGetLogIdentifier();
    v21 = [v6 UUIDString];
    *buf = 138543618;
    v37 = v20;
    v38 = 2112;
    v39 = v21;
    _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping zone push to %@.", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v17);
  if (v7)
  {
    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75 description:@"Operation was cancelled before it could run" reason:@"iCloud & Controller key was not available" suggestion:@"Make sure that you are signed into iCloud account"];
    (*(v7 + 2))(v7, v8);
LABEL_15:
  }

  v31 = *MEMORY[0x277D85DE8];
}

void __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [[HMDCloudTransaction alloc] initWithType:4 temporaryCache:0];
  [(HMDCloudTransaction *)v7 updateCloudZone:v5];
  v8 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-to-zone"];
  [(HMDCloudTransaction *)v7 setOsTransaction:v8];

  v9 = *(a1 + 32);
  v10 = *(a1 + 40);
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke_2;
  v12[3] = &unk_2797326E8;
  objc_copyWeak(&v16, (a1 + 56));
  v11 = v7;
  v13 = v11;
  v14 = *(a1 + 40);
  v15 = *(a1 + 48);
  [v9 _loadHomeModelChanges:v11 mustReplay:0 legacyPush:0 home:v10 completion:v12];

  objc_destroyWeak(&v16);
}

void __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke_2(uint64_t a1, void *a2)
{
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (!v3 && WeakRetained && [*(a1 + 32) hasValidChanges])
  {
    v6 = *(a1 + 32);
    v7 = *(a1 + 40);
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke_3;
    v9[3] = &unk_279735738;
    v10 = v6;
    v11 = *(a1 + 48);
    [v5 _uploadTransaction:v10 home:v7 completion:v9];
  }

  else
  {
    [*(a1 + 32) setOsTransaction:0];
    v8 = *(a1 + 48);
    if (v8)
    {
      (*(v8 + 16))(v8, v3);
    }
  }
}

uint64_t __55__HMDHomeManager__runUploadHomeToCloud_syncCompletion___block_invoke_3(uint64_t a1)
{
  [*(a1 + 32) setOsTransaction:0];
  result = *(a1 + 40);
  if (result)
  {
    v3 = *(result + 16);

    return v3();
  }

  return result;
}

- (void)_uploadTransaction:(id)a3 home:(id)a4 completion:(id)a5
{
  v8 = a3;
  v9 = a4;
  v10 = a5;
  objc_initWeak(&location, self);
  v11 = [(HMDHomeManager *)self cloudDataSyncManager];
  v15[0] = MEMORY[0x277D85DD0];
  v15[1] = 3221225472;
  v15[2] = __53__HMDHomeManager__uploadTransaction_home_completion___block_invoke;
  v15[3] = &unk_2797326E8;
  objc_copyWeak(&v19, &location);
  v12 = v9;
  v16 = v12;
  v13 = v8;
  v17 = v13;
  v14 = v10;
  v18 = v14;
  [v11 uploadTransaction:v13 completionHandler:v15];

  objc_destroyWeak(&v19);
  objc_destroyWeak(&location);
}

void __53__HMDHomeManager__uploadTransaction_home_completion___block_invoke(uint64_t a1, void *a2)
{
  v54 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (!WeakRetained)
  {
LABEL_19:
    v27 = *(a1 + 48);
    if (v27)
    {
      (*(v27 + 16))();
    }

    goto LABEL_21;
  }

  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [*(a1 + 32) zoneID];
    v10 = [v3 hmd_conciseCKError];
    v11 = [v10 shortDescription];
    *buf = 138543874;
    v49 = v8;
    v50 = 2112;
    v51 = v9;
    v52 = 2112;
    v53 = v11;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Uploaded data to zone %@ with error status: %@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v5);
  if ([v6 backOffOperationInProgress])
  {
    [v6 setBackOffOperationInProgress:0];
    v12 = objc_autoreleasePoolPush();
    v13 = v6;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v49 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Clearing that we were in a backoff operation", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
  }

  if (v3)
  {
    v16 = [v3 domain];
    if ([v16 isEqualToString:*MEMORY[0x277CBBF50]])
    {
      v17 = [v3 userInfo];

      if (!v17)
      {
        goto LABEL_19;
      }

      v18 = [v3 userInfo];
      v16 = [v18 hmf_numberForKey:*MEMORY[0x277CBBF68]];

      if (v16)
      {
        v19 = [*(a1 + 32) uuid];
        v20 = [v19 UUIDString];

        v21 = objc_autoreleasePoolPush();
        v22 = v6;
        v23 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
        {
          v24 = HMFGetLogIdentifier();
          *buf = 138543874;
          v49 = v24;
          v50 = 2112;
          v51 = v20;
          v52 = 2112;
          v53 = v16;
          _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Rescheduling zone push %@ with delay %@", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v21);
        v25 = *(a1 + 32);
        [v16 doubleValue];
        [v22 _uploadHomeToCloud:v25 withDelay:?];
      }
    }

LABEL_18:

    goto LABEL_19;
  }

  if ([*(a1 + 40) wasZoneDeleted])
  {
    v26 = *(a1 + 32);
    if (!v26)
    {
      goto LABEL_19;
    }

    v16 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    [v6 scheduleRemovalForHome:v26 message:0 options:v16];
    goto LABEL_18;
  }

  v29 = *(a1 + 40);
  v30 = [*(a1 + 32) homeConfigurationUUID];
  v31 = [v29 changeWithObjectID:v30];

  if (v31)
  {
    v32 = [v31 objectChange];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v33 = v32;
    }

    else
    {
      v33 = 0;
    }

    v34 = v33;

    if (v34)
    {
      v35 = [v34 configurationVersion];

      if (v35)
      {
        v36 = [v34 configurationVersion];
        v37 = [v36 integerValue];

        v38 = objc_autoreleasePoolPush();
        v39 = v6;
        v40 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v40, OS_LOG_TYPE_DEFAULT))
        {
          HMFGetLogIdentifier();
          v41 = v45 = v39;
          [*(a1 + 32) uuid];
          v42 = v47 = v37;
          [v42 UUIDString];
          v43 = v46 = v38;
          *buf = 138543874;
          v49 = v41;
          v50 = 2112;
          v51 = v43;
          v52 = 2048;
          v53 = v47;
          _os_log_impl(&dword_2531F8000, v40, OS_LOG_TYPE_DEFAULT, "%{public}@Home %@ last pushed configuration version successfully updated to %lu", buf, 0x20u);

          v38 = v46;
          v37 = v47;

          v39 = v45;
        }

        objc_autoreleasePoolPop(v38);
        [*(a1 + 32) setLastSyncedConfigurationVersion:v37];
        [*(a1 + 32) saveWithReason:@"lastSyncedHomeConfigVersion" postSyncNotification:0];
      }
    }
  }

  [v6 _pushZoneInfromationForHome:*(a1 + 32)];
  [v6 _resetCloudOperationRetryCounters];
  v44 = [*(a1 + 40) processedTransactionStoreRowIDs];
  [v6 _updateModelChangesAsPushed:v44 home:*(a1 + 32) pushMask:2 completion:*(a1 + 48)];

  [v6 _schedulePushChangesToAllUsersOfAllHomes];
LABEL_21:

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_pushZoneInfromationForHome:(id)a3
{
  v38 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self cloudDataSyncManager];
  v6 = [v5 cloudCache];
  v7 = [v6 homeManagerZone];

  if (v4 && v7)
  {
    v8 = [v4 zoneID];
    v9 = [(HMDHomeManager *)self _zoneInformationWithUUID:v8];

    if (v9)
    {
      goto LABEL_7;
    }

    v10 = objc_autoreleasePoolPush();
    v11 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      v14 = [v4 name];
      v15 = [v4 zoneID];
      *buf = 138543874;
      v33 = v13;
      v34 = 2112;
      v35 = v14;
      v36 = 2112;
      v37 = v15;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Local zone information missing for home/zone %@/%@, creating", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v10);
    v16 = [v4 zoneID];
    v17 = [v4 ownerName];
    [(HMDHomeManager *)v11 _addCloudZone:v16 ownerName:v17];

    v18 = [v4 zoneID];
    v9 = [(HMDHomeManager *)v11 _zoneInformationWithUUID:v18];

    if (v9)
    {
LABEL_7:
      objc_initWeak(buf, self);
      v19 = [v4 zoneID];
      v28[0] = MEMORY[0x277D85DD0];
      v28[1] = 3221225472;
      v28[2] = __46__HMDHomeManager__pushZoneInfromationForHome___block_invoke;
      v28[3] = &unk_279731FD0;
      objc_copyWeak(&v31, buf);
      v29 = v4;
      v20 = v9;
      v30 = v20;
      [v7 cloudRecordWithObjectID:v19 completionHandler:v28];

      objc_destroyWeak(&v31);
      objc_destroyWeak(buf);
    }

    else
    {
      v22 = objc_autoreleasePoolPush();
      v23 = v11;
      v24 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v24, OS_LOG_TYPE_ERROR))
      {
        v25 = HMFGetLogIdentifier();
        v26 = [v4 name];
        v27 = [v4 zoneID];
        *buf = 138543874;
        v33 = v25;
        v34 = 2112;
        v35 = v26;
        v36 = 2112;
        v37 = v27;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_ERROR, "%{public}@Failed to create local zone information for home/zone %@/%@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v22);
    }
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __46__HMDHomeManager__pushZoneInfromationForHome___block_invoke(id *a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v8 = WeakRetained;
  if (!v5 && WeakRetained)
  {
    v9 = [a1[4] zoneID];
    v10[0] = MEMORY[0x277D85DD0];
    v10[1] = 3221225472;
    v10[2] = __46__HMDHomeManager__pushZoneInfromationForHome___block_invoke_2;
    v10[3] = &unk_279731FA8;
    objc_copyWeak(&v13, a1 + 6);
    v11 = a1[4];
    v12 = a1[5];
    [v8 _cleanChangesIfNoAddChangeObjectID:v9 completion:v10];

    objc_destroyWeak(&v13);
  }
}

void __46__HMDHomeManager__pushZoneInfromationForHome___block_invoke_2(uint64_t a1, char a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained && (a2 & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = WeakRetained;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 32) name];
      v12 = [*(a1 + 32) zoneID];
      v13 = [v12 UUIDString];
      v15 = 138543874;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      v19 = 2112;
      v20 = v13;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Creating zone information for home %@/%@ to push to cloud", &v15, 0x20u);
    }

    objc_autoreleasePoolPop(v7);
    [v8 addTransactionAfterPush:*(a1 + 40)];
  }

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_updateModelChangesAsPushed:(id)a3 home:(id)a4 pushMask:(unint64_t)a5 completion:(id)a6
{
  v9 = a6;
  v10 = a4;
  v11 = a3;
  v12 = [[HMDBackingStoreLogUpdateOperation alloc] initWithRowIDs:v11 successfullyPushedTo:a5];

  v15[0] = MEMORY[0x277D85DD0];
  v15[1] = 3221225472;
  v15[2] = __71__HMDHomeManager__updateModelChangesAsPushed_home_pushMask_completion___block_invoke;
  v15[3] = &unk_279735558;
  v16 = v9;
  v13 = v9;
  [(HMDBackingStoreOperation *)v12 setResultBlock:v15];
  v14 = [v10 backingStore];

  [v14 submit:v12];
}

uint64_t __71__HMDHomeManager__updateModelChangesAsPushed_home_pushMask_completion___block_invoke(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

void __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke(uint64_t a1, void *a2)
{
  v30 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    (*(*(a1 + 72) + 16))();
  }

  else
  {
    v4 = [HMDBackingStoreLogFetchOperation alloc];
    v5 = *(a1 + 88);
    v24[0] = MEMORY[0x277D85DD0];
    v24[1] = 3221225472;
    v24[2] = __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2;
    v24[3] = &unk_279731F58;
    *&v6 = *(a1 + 32);
    *(&v6 + 1) = *(a1 + 40);
    v18 = v6;
    v7 = *(a1 + 48);
    v8 = *(a1 + 56);
    *&v9 = v7;
    *(&v9 + 1) = v8;
    v25 = v18;
    v26 = v9;
    v27 = *(a1 + 64);
    v10 = [(HMDBackingStoreLogFetchOperation *)v4 initWithNeedsPushTo:v5 result:v24];
    v19[0] = MEMORY[0x277D85DD0];
    v19[1] = 3221225472;
    v19[2] = __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_852;
    v19[3] = &unk_2797326E8;
    objc_copyWeak(&v23, (a1 + 80));
    v20 = *(a1 + 64);
    v21 = *(a1 + 32);
    v22 = *(a1 + 72);
    [(HMDBackingStoreOperation *)v10 setResultBlock:v19];
    WeakRetained = objc_loadWeakRetained((a1 + 80));
    v12 = objc_autoreleasePoolPush();
    v13 = WeakRetained;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_DEBUG))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543362;
      v29 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEBUG, "%{public}@Loading changes from home datastore started", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    v16 = [*(a1 + 32) backingStore];
    [v16 submit:v10];

    objc_destroyWeak(&v23);
  }

  v17 = *MEMORY[0x277D85DE8];
}

uint64_t __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2(uint64_t a1, void *a2, void *a3, void *a4)
{
  v43 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v33 = a3;
  v31 = a4;
  v8 = [*(a1 + 32) isOwnerUser];
  v34 = 0u;
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  obj = v7;
  v9 = [obj countByEnumeratingWithState:&v34 objects:v42 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v35;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v35 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v34 + 1) + 8 * i);
        if (v8)
        {
          v14 = objc_autoreleasePoolPush();
          v15 = *(a1 + 40);
          v16 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v16, OS_LOG_TYPE_DEBUG))
          {
            v17 = HMFGetLogIdentifier();
            *buf = 138543618;
            v39 = v17;
            v40 = 2112;
            v41 = v13;
            _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEBUG, "%{public}@Processing home object change %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v14);
          [*(a1 + 48) addChangeWithObjectChange:v13];
          if ([v33 mustReplay])
          {
            v18 = *(a1 + 56);
            if (v18)
            {
              [v18 addChangeWithObjectChange:v13];
            }
          }

          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            goto LABEL_20;
          }
        }

        else
        {
          objc_opt_class();
          isKindOfClass = objc_opt_isKindOfClass();
          v20 = objc_autoreleasePoolPush();
          v21 = *(a1 + 40);
          v22 = HMFGetOSLogHandle();
          v23 = os_log_type_enabled(v22, OS_LOG_TYPE_DEBUG);
          if (isKindOfClass)
          {
            if (v23)
            {
              v24 = HMFGetLogIdentifier();
              *buf = 138543618;
              v39 = v24;
              v40 = 2112;
              v41 = v13;
              _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_DEBUG, "%{public}@Processing shared home object change %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v20);
            [*(a1 + 48) addChangeWithObjectChange:v13];
            if ([v33 mustReplay])
            {
              v25 = *(a1 + 56);
              if (v25)
              {
                [v25 addChangeWithObjectChange:v13];
              }
            }

LABEL_20:
            if ([v13 objectChangeType] == 1)
            {
              [*(a1 + 48) setCreateZone:1];
            }

            continue;
          }

          if (v23)
          {
            v26 = HMFGetLogIdentifier();
            *buf = 138543618;
            v39 = v26;
            v40 = 2112;
            v41 = v13;
            _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_DEBUG, "%{public}@Removing share home object change %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v20);
          v27 = *(a1 + 64);
          v28 = [MEMORY[0x277CCABB0] numberWithUnsignedLongLong:{objc_msgSend(v13, "bsoLogRowID")}];
          [v27 addObject:v28];
        }
      }

      v10 = [obj countByEnumeratingWithState:&v34 objects:v42 count:16];
    }

    while (v10);
  }

  v29 = *MEMORY[0x277D85DE8];
  return 1;
}

void __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_852(id *a1, void *a2)
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 7);
  if (WeakRetained)
  {
    if ([a1[4] count])
    {
      v5 = [HMDBackingStoreLogUpdateOperation alloc];
      v6 = [a1[4] allObjects];
      v7 = [(HMDBackingStoreLogUpdateOperation *)v5 initWithRowIDs:v6 successfullyPushedTo:3];

      v22[0] = MEMORY[0x277D85DD0];
      v22[1] = 3221225472;
      v22[2] = __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2_853;
      v22[3] = &unk_279734708;
      objc_copyWeak(&v23, a1 + 7);
      [(HMDBackingStoreOperation *)v7 setResultBlock:v22];
      v8 = objc_autoreleasePoolPush();
      v9 = WeakRetained;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEBUG))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543362;
        v25 = v11;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of shared home in datastore", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v8);
      v12 = [a1[5] backingStore];
      [v12 submit:v7];

      objc_destroyWeak(&v23);
    }

    v13 = objc_autoreleasePoolPush();
    v14 = WeakRetained;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEBUG))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v25 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_DEBUG, "%{public}@Loading changes from home datastore completed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v17 = [v14 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_854;
    block[3] = &unk_279735738;
    v21 = a1[6];
    v20 = v3;
    dispatch_async(v17, block);
  }

  v18 = *MEMORY[0x277D85DE8];
}

void __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2_853(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of shared home in datastore", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85DE8];
}

uint64_t __78__HMDHomeManager__loadHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_854(uint64_t a1)
{
  result = *(a1 + 40);
  if (result)
  {
    return (*(result + 16))(result, *(a1 + 32));
  }

  return result;
}

- (void)_loadHomeManagerHomeModelChanges:(id)a3 mustReplay:(id)a4 legacyPush:(BOOL)a5 home:(id)a6 completion:(id)a7
{
  v9 = a5;
  v53 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v37 = a4;
  v13 = a6;
  v14 = a7;
  v15 = v14;
  if (v12 && v13)
  {
    if (v9)
    {
      v16 = 1;
    }

    else
    {
      v16 = 2;
    }

    v17 = objc_autoreleasePoolPush();
    v18 = self;
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_DEBUG))
    {
      v20 = HMFGetLogIdentifier();
      v21 = [v13 name];
      *buf = 138543618;
      v50 = v20;
      v51 = 2112;
      v52 = v21;
      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_DEBUG, "%{public}@Find all home change for home %@ in home manager's datastore", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v17);
    v22 = [MEMORY[0x277CBEB58] set];
    objc_initWeak(&location, v18);
    v23 = [HMDBackingStoreLogFetchOperation alloc];
    v42[0] = MEMORY[0x277D85DD0];
    v42[1] = 3221225472;
    v42[2] = __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke;
    v42[3] = &unk_279731F30;
    objc_copyWeak(&v47, &location);
    v43 = v13;
    v24 = v22;
    v44 = v24;
    v45 = v12;
    v46 = v37;
    v25 = [(HMDBackingStoreLogFetchOperation *)v23 initWithNeedsPushTo:v16 result:v42];
    v38[0] = MEMORY[0x277D85DD0];
    v38[1] = 3221225472;
    v38[2] = __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_851;
    v38[3] = &unk_2797346E0;
    objc_copyWeak(&v41, &location);
    v26 = v24;
    v39 = v26;
    v40 = v15;
    [(HMDBackingStoreOperation *)v25 setResultBlock:v38];
    v27 = objc_autoreleasePoolPush();
    v28 = v18;
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEBUG))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543362;
      v50 = v30;
      _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEBUG, "%{public}@Load home change from homemanager datastore started", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v27);
    v31 = [(HMDHomeManager *)v28 backingStore];
    [v31 submit:v25];

    objc_destroyWeak(&v41);
    objc_destroyWeak(&v47);
    objc_destroyWeak(&location);
LABEL_15:

    goto LABEL_16;
  }

  if (v14)
  {
    v32 = objc_autoreleasePoolPush();
    v33 = self;
    v34 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
    {
      v35 = HMFGetLogIdentifier();
      *buf = 138543362;
      v50 = v35;
      _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_ERROR, "%{public}@A cloudTransaction and home when querying for home changes in home manager datastore", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v32);
    v26 = [MEMORY[0x277CCA9B8] hmErrorWithCode:{3, v37}];
    (v15)[2](v15, v26);
    goto LABEL_15;
  }

LABEL_16:

  v36 = *MEMORY[0x277D85DE8];
}

uint64_t __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v45 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v34 = a3;
  v32 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  v8 = [*(a1 + 32) isOwnerUser];
  v36 = 0u;
  v37 = 0u;
  v38 = 0u;
  v39 = 0u;
  v9 = v7;
  v10 = [v9 countByEnumeratingWithState:&v36 objects:v44 count:16];
  if (v10)
  {
    v11 = v10;
    v12 = *v37;
    v33 = v9;
    do
    {
      v13 = 0;
      do
      {
        if (*v37 != v12)
        {
          objc_enumerationMutation(v9);
        }

        v14 = *(*(&v36 + 1) + 8 * v13);
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v15 = [v14 uuid];
          v16 = [*(a1 + 32) uuid];
          if ([v15 isEqual:v16])
          {
            v17 = [v14 objectChangeType];

            if (v17 != 3)
            {
              if ((v8 & 1) != 0 || (objc_opt_class(), (objc_opt_isKindOfClass() & 1) == 0))
              {
                v24 = objc_autoreleasePoolPush();
                v25 = WeakRetained;
                v26 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v26, OS_LOG_TYPE_DEBUG))
                {
                  v27 = HMFGetLogIdentifier();
                  *buf = 138543618;
                  v41 = v27;
                  v42 = 2112;
                  v43 = v14;
                  _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_DEBUG, "%{public}@Processing home object change %@", buf, 0x16u);

                  v9 = v33;
                }

                objc_autoreleasePoolPop(v24);
                [*(a1 + 48) addChangeWithObjectChange:v14];
                if ([v34 mustReplay])
                {
                  v28 = *(a1 + 56);
                  if (v28)
                  {
                    [v28 addChangeWithObjectChange:v14];
                  }
                }

                if ([v14 objectChangeType] == 1)
                {
                  [*(a1 + 48) setCreateZone:1];
                }
              }

              else
              {
                v18 = objc_autoreleasePoolPush();
                v19 = WeakRetained;
                v20 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v20, OS_LOG_TYPE_DEBUG))
                {
                  v21 = HMFGetLogIdentifier();
                  *buf = 138543618;
                  v41 = v21;
                  v42 = 2112;
                  v43 = v14;
                  _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEBUG, "%{public}@Removing share home object change %@", buf, 0x16u);
                }

                objc_autoreleasePoolPop(v18);
                v22 = *(a1 + 40);
                v23 = [MEMORY[0x277CCABB0] numberWithUnsignedLongLong:{objc_msgSend(v14, "bsoLogRowID")}];
                [v22 addObject:v23];

                v9 = v33;
              }
            }
          }

          else
          {
          }
        }

        ++v13;
      }

      while (v11 != v13);
      v29 = [v9 countByEnumeratingWithState:&v36 objects:v44 count:16];
      v11 = v29;
    }

    while (v29);
  }

  v30 = *MEMORY[0x277D85DE8];
  return 1;
}

void __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_851(uint64_t a1, void *a2)
{
  v23 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    if ([*(a1 + 32) count])
    {
      v5 = [HMDBackingStoreLogUpdateOperation alloc];
      v6 = [*(a1 + 32) allObjects];
      v7 = [(HMDBackingStoreLogUpdateOperation *)v5 initWithRowIDs:v6 successfullyPushedTo:3];

      v19[0] = MEMORY[0x277D85DD0];
      v19[1] = 3221225472;
      v19[2] = __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2;
      v19[3] = &unk_279734708;
      objc_copyWeak(&v20, (a1 + 48));
      [(HMDBackingStoreOperation *)v7 setResultBlock:v19];
      v8 = objc_autoreleasePoolPush();
      v9 = WeakRetained;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEBUG))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543362;
        v22 = v11;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of shared home in datastore", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v8);
      v12 = [v9 backingStore];
      [v12 submit:v7];

      objc_destroyWeak(&v20);
    }

    v13 = objc_autoreleasePoolPush();
    v14 = WeakRetained;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEBUG))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_DEBUG, "%{public}@Load home change from homemanager datastore completed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v17 = *(a1 + 40);
    if (v17)
    {
      (*(v17 + 16))(v17, 0);
    }
  }

  v18 = *MEMORY[0x277D85DE8];
}

void __89__HMDHomeManager__loadHomeManagerHomeModelChanges_mustReplay_legacyPush_home_completion___block_invoke_2(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of shared home in datastore", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85DE8];
}

- (void)_uploadHomeToCloud:(id)a3 withDelay:(double)a4
{
  v32 = *MEMORY[0x277D85DE8];
  v6 = a3;
  if ([(HMDHomeManager *)self hasiCloudAndControllerKey])
  {
    v7 = [v6 uuid];
    objc_initWeak(&location, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __47__HMDHomeManager__uploadHomeToCloud_withDelay___block_invoke;
    aBlock[3] = &unk_279731F08;
    objc_copyWeak(&v26, &location);
    v8 = v7;
    v25 = v8;
    v9 = _Block_copy(aBlock);
    v10 = objc_autoreleasePoolPush();
    v11 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543618;
      v29 = v13;
      v30 = 2112;
      v31 = v6;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Uploading object changes for home %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [v6 zoneID];
    v15 = [v14 UUIDString];
    v16 = [HMDSyncOperation cloudZonePushSyncOperation:v15 block:v9];

    v17 = [(HMDHomeManager *)v11 syncManager];
    [v17 addOperation:v16 withDelay:a4];

    objc_destroyWeak(&v26);
    objc_destroyWeak(&location);
  }

  else
  {
    v18 = objc_autoreleasePoolPush();
    v19 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
    {
      v21 = HMFGetLogIdentifier();
      v22 = [v6 name];
      *buf = 138543618;
      v29 = v21;
      v30 = 2112;
      v31 = v22;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEFAULT, "%{public}@Not scheduling zone push for %@.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v18);
  }

  v23 = *MEMORY[0x277D85DE8];
}

void __47__HMDHomeManager__uploadHomeToCloud_withDelay___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v10 = a2;
  v7 = a3;
  if (a4)
  {
    if (!v10)
    {
      goto LABEL_7;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    v10[2](v10, v8);
  }

  else
  {
    WeakRetained = objc_loadWeakRetained((a1 + 40));
    v8 = WeakRetained;
    if (WeakRetained)
    {
      [WeakRetained _runUploadHomeToCloud:*(a1 + 32) syncCompletion:v10];
    }
  }

LABEL_7:
}

- (void)uploadHomeToCloudZone:(id)a3 withDelay:(double)a4
{
  v6 = a3;
  objc_initWeak(&location, self);
  v7 = [(HMDHomeManager *)self workQueue];
  v9[0] = MEMORY[0x277D85DD0];
  v9[1] = 3221225472;
  v9[2] = __50__HMDHomeManager_uploadHomeToCloudZone_withDelay___block_invoke;
  v9[3] = &unk_279731EE0;
  objc_copyWeak(v11, &location);
  v10 = v6;
  v11[1] = *&a4;
  v8 = v6;
  dispatch_async(v7, v9);

  objc_destroyWeak(v11);
  objc_destroyWeak(&location);
}

void __50__HMDHomeManager_uploadHomeToCloudZone_withDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained && *(a1 + 32))
  {
    v4 = WeakRetained;
    v3 = [WeakRetained _homeWithZoneID:?];
    if (v3)
    {
      [v4 _uploadHomeToCloud:v3 withDelay:*(a1 + 48)];
    }

    WeakRetained = v4;
  }
}

- (void)_handleHomeManagerTransactionsFetched:(id)a3 stagedTransaction:(id)a4 mustReplay:(id)a5 cloudConflict:(BOOL)a6 transactionError:(id)a7 syncCompletion:(id)a8
{
  v97 = *MEMORY[0x277D85DE8];
  v62 = a3;
  v63 = a4;
  v64 = a5;
  v65 = a7;
  v61 = a8;
  v14 = objc_autoreleasePoolPush();
  v15 = self;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
  {
    v17 = HMFGetLogIdentifier();
    v18 = [v65 hmd_conciseCKError];
    v19 = [v18 shortDescription];
    *buf = 138543618;
    v94 = v17;
    v95 = 2112;
    v96 = v19;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Fetched data from home manager zone with error status: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v14);
  if (v65)
  {
    [v64 setOsTransaction:0];
    [v63 setOsTransaction:0];
    [v62 setOsTransaction:0];
    v20 = v61;
    if (v61)
    {
      v61[2]();
      goto LABEL_39;
    }

    goto LABEL_40;
  }

  if ([(HMDHomeManager *)v15 backOffOperationInProgress])
  {
    [(HMDHomeManager *)v15 setBackOffOperationInProgress:0];
    v21 = objc_autoreleasePoolPush();
    v22 = v15;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = HMFGetLogIdentifier();
      *buf = 138543362;
      v94 = v24;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, "%{public}@Clearing that we were in a backoff operation", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v21);
  }

  [(HMDHomeManager *)v15 _resetCloudOperationRetryCounters];
  [(HMDHomeManager *)v15 setHomeDataLoadedFromArchive:1];
  v25 = [(HMDHomeManager *)v15 cloudDataSyncStateFilter];
  [v25 updateLocalDataDecryptionFailed:0];

  objc_initWeak(&location, v15);
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke;
  aBlock[3] = &unk_279731E90;
  objc_copyWeak(&v89, &location);
  v26 = v62;
  v85 = v26;
  v90 = a6;
  v27 = v64;
  v86 = v27;
  v28 = v63;
  v87 = v28;
  v88 = v61;
  v59 = _Block_copy(aBlock);
  v60 = [v26 replayTransaction:v27 stagedTransaction:v28];
  if (![v60 count])
  {
    v33 = [(HMDHomeManager *)v15 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_844;
    block[3] = &unk_2797355D0;
    v81 = v26;
    v82 = v15;
    v83 = v59;
    dispatch_async(v33, block);

    v34 = v81;
    goto LABEL_38;
  }

  v66 = [MEMORY[0x277CBEB58] set];
  v29 = [v26 isLegacyTransaction];
  v30 = v29;
  if (v29)
  {
    v31 = [(HMDHomeManager *)v15 backingStore];
    v32 = +[HMDBackingStoreTransactionOptions defaultLegacyCloudOptions];
    v71 = [v31 transaction:@"kTransactionUpdate" options:v32];
    v69 = 0;
  }

  else
  {
    v35 = [(HMDHomeManager *)v15 backingStore];
    v36 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
    v71 = [v35 transaction:@"kTransactionUpdate" options:v36];

    v31 = [(HMDHomeManager *)v15 backingStore];
    v32 = +[HMDBackingStoreTransactionOptions cloudRequiresPushOptions];
    v69 = [v31 transaction:@"kTransactionUpdate" options:v32];
  }

  v78 = 0u;
  v79 = 0u;
  v76 = 0u;
  v77 = 0u;
  obj = v60;
  v37 = [obj countByEnumeratingWithState:&v76 objects:v92 count:16];
  if (!v37)
  {

    goto LABEL_37;
  }

  v68 = 0;
  v38 = *v77;
  v67 = v15;
  do
  {
    for (i = 0; i != v37; ++i)
    {
      if (*v77 != v38)
      {
        objc_enumerationMutation(obj);
      }

      v40 = *(*(&v76 + 1) + 8 * i);
      if ((v30 & 1) == 0)
      {
        if ([*(*(&v76 + 1) + 8 * i) isPushAfterApply])
        {
          v41 = objc_autoreleasePoolPush();
          v42 = v15;
          v43 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
          {
            v44 = HMFGetLogIdentifier();
            v45 = [v40 objectID];
            *buf = 138543618;
            v94 = v44;
            v95 = 2112;
            v96 = v45;
            _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@Change should be pushed after being applied: %@", buf, 0x16u);

            v15 = v67;
          }

          objc_autoreleasePoolPop(v41);
          v46 = [v40 objectChange];
          [v69 add:v46 withMessage:0];
          v68 = 1;
        }

        else
        {
          if (![v40 isDropStagedAfterApply])
          {
            goto LABEL_30;
          }

          v47 = objc_autoreleasePoolPush();
          v48 = v15;
          v49 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v49, OS_LOG_TYPE_INFO))
          {
            v50 = HMFGetLogIdentifier();
            v51 = [v40 objectID];
            *buf = 138543618;
            v94 = v50;
            v95 = 2112;
            v96 = v51;
            _os_log_impl(&dword_2531F8000, v49, OS_LOG_TYPE_INFO, "%{public}@Object conflict, drop all staged changes for object: %@", buf, 0x16u);

            v15 = v67;
          }

          objc_autoreleasePoolPop(v47);
          v46 = [v40 rowIDs];
          [v66 addObjectsFromArray:v46];
        }
      }

LABEL_30:
      v52 = [v40 objectChange];
      [v71 add:v52 withMessage:0];
    }

    v37 = [obj countByEnumeratingWithState:&v76 objects:v92 count:16];
  }

  while (v37);

  if (v68)
  {
    v53 = objc_autoreleasePoolPush();
    v54 = v15;
    v55 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_INFO))
    {
      v56 = HMFGetLogIdentifier();
      *buf = 138543362;
      v94 = v56;
      _os_log_impl(&dword_2531F8000, v55, OS_LOG_TYPE_INFO, "%{public}@Saving changes to push after applying", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v53);
    [v69 save];
    [(HMDHomeManager *)v54 _uploadHomeManagerToCloudWithDelay:0.0];
  }

LABEL_37:
  v72[0] = MEMORY[0x277D85DD0];
  v72[1] = 3221225472;
  v72[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_848;
  v72[3] = &unk_2797346E0;
  objc_copyWeak(&v75, &location);
  v57 = v66;
  v73 = v57;
  v74 = v59;
  [v71 run:v72];

  objc_destroyWeak(&v75);
  v34 = v71;
LABEL_38:

  objc_destroyWeak(&v89);
  objc_destroyWeak(&location);
LABEL_39:
  v20 = v61;
LABEL_40:

  v58 = *MEMORY[0x277D85DE8];
}

void __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke(uint64_t a1, void *a2)
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v20 = 138543362;
      v21 = v8;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Home manager zone fetch completed.", &v20, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    if (v3)
    {
      v9 = objc_autoreleasePoolPush();
      v10 = v6;
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
      {
        v12 = HMFGetLogIdentifier();
        v20 = 138543618;
        v21 = v12;
        v22 = 2112;
        v23 = v3;
        _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@Home manager zone merge failed with error %@, not saving records to cache", &v20, 0x16u);
      }

      objc_autoreleasePoolPop(v9);
    }

    else
    {
      [*(a1 + 32) updateCloudCache];
      if (*(a1 + 72) == 1 && ([*(a1 + 32) decryptionFailed] & 1) == 0)
      {
        [v6 _uploadHomeManagerToCloudWithDelay:0.0];
      }

      if (([*(a1 + 32) decryptionFailed] & 1) == 0 && objc_msgSend(v6, "_zonesFetched"))
      {
        v13 = [v6 cloudDataSyncManager];
        [v13 updateCloudDataSyncFilterState:1];
      }

      [*(a1 + 40) setOsTransaction:0];
      [*(a1 + 48) setOsTransaction:0];
      [*(a1 + 32) setOsTransaction:0];
      [v6 _postMergeWatchPush];
    }
  }

  v14 = objc_autoreleasePoolPush();
  v15 = WeakRetained;
  v16 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
  {
    v17 = HMFGetLogIdentifier();
    v20 = 138543362;
    v21 = v17;
    _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@Finished home manager zone merge", &v20, 0xCu);
  }

  objc_autoreleasePoolPop(v14);
  v18 = *(a1 + 56);
  if (v18)
  {
    (*(v18 + 16))(v18, v3);
  }

  v19 = *MEMORY[0x277D85DE8];
}

void __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_844(uint64_t a1)
{
  v2 = [*(a1 + 32) cloudZone];
  v3 = [v2 hasServerTokenAvailable];

  (*(*(a1 + 48) + 16))();
  if ((v3 & 1) == 0)
  {
    v4 = *(a1 + 40);
    v5 = [v4 uuid];
    [v4 _updateGenerationCounterWithReason:@"No server token available" sourceUUID:v5 shouldNotifyClients:1];
  }
}

void __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_848(id *a1, void *a2)
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543618;
      v19 = v8;
      v20 = 2112;
      v21 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Applied object changes to home manager with error %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    if (v3 || ![a1[4] count])
    {
      v9 = [v6 workQueue];
      v12[0] = MEMORY[0x277D85DD0];
      v12[1] = 3221225472;
      v12[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_2;
      v12[3] = &unk_279735738;
      v14 = a1[5];
      v13 = v3;
      dispatch_async(v9, v12);
    }

    else
    {
      v10 = [a1[4] allObjects];
      v15[0] = MEMORY[0x277D85DD0];
      v15[1] = 3221225472;
      v15[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_849;
      v15[3] = &unk_279731EB8;
      objc_copyWeak(&v17, a1 + 6);
      v16 = a1[5];
      [v6 _updateHomeManagerModelChangesAsPushed:v10 pushMask:3 completion:v15];

      objc_destroyWeak(&v17);
    }
  }

  v11 = *MEMORY[0x277D85DE8];
}

void __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_849(uint64_t a1)
{
  v13 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (WeakRetained)
  {
    v3 = objc_autoreleasePoolPush();
    v4 = WeakRetained;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v12 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Dropping changes for object conflicts", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    v7 = [v4 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __131__HMDHomeManager__handleHomeManagerTransactionsFetched_stagedTransaction_mustReplay_cloudConflict_transactionError_syncCompletion___block_invoke_850;
    block[3] = &unk_2797348C0;
    v10 = *(a1 + 32);
    dispatch_async(v7, block);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_runFetchHomeManagerCloudConflict:(BOOL)a3 syncCompletion:(id)a4
{
  v45 = *MEMORY[0x277D85DE8];
  v6 = a4;
  v7 = [(HMDHomeManager *)self hasiCloudAndControllerKey];
  v8 = objc_autoreleasePoolPush();
  if (v7)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      LODWORD(buf) = 138543362;
      *(&buf + 4) = v12;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Fetching home manager zone changes from the cloud", &buf, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
    v13 = [(HMDHomeManager *)v10 cloudDataSyncManager];
    v14 = [v13 cloudCache];

    v15 = [v14 homeManagerZone];
    if ([(HMDHomeManager *)v10 forceFetchHomeManagerZone])
    {
      v16 = objc_autoreleasePoolPush();
      v17 = v10;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = HMFGetLogIdentifier();
        LODWORD(buf) = 138543362;
        *(&buf + 4) = v19;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Resetting server change token for home manager zone", &buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      [v15 setServerChangeToken:0];
      [(HMDHomeManager *)v17 setForceFetchHomeManagerZone:0];
      v20 = objc_autoreleasePoolPush();
      v21 = v17;
      v22 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
      {
        v23 = HMFGetLogIdentifier();
        LODWORD(buf) = 138543362;
        *(&buf + 4) = v23;
        _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Resetting databaseServerChangeToken because home manager was reset", &buf, 0xCu);
      }

      objc_autoreleasePoolPop(v20);
      [v14 setDatabaseServerChangeToken:0];
      [v14 persistDatabaseServerChangeToken];
    }

    *&buf = 0;
    *(&buf + 1) = &buf;
    v41 = 0x3032000000;
    v42 = __Block_byref_object_copy__172847;
    v43 = __Block_byref_object_dispose__172848;
    v44 = [[HMDCloudTransaction alloc] initWithType:3 temporaryCache:0];
    [*(*(&buf + 1) + 40) updateCloudZone:v15];
    v24 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.fetch-from-hmzone"];
    [*(*(&buf + 1) + 40) setOsTransaction:v24];

    objc_initWeak(&location, v10);
    v25 = [(HMDHomeManager *)v10 cloudDataSyncManager];
    v26 = *(*(&buf + 1) + 40);
    v33[0] = MEMORY[0x277D85DD0];
    v33[1] = 3221225472;
    v33[2] = __67__HMDHomeManager__runFetchHomeManagerCloudConflict_syncCompletion___block_invoke;
    v33[3] = &unk_279731E68;
    objc_copyWeak(&v37, &location);
    p_buf = &buf;
    v35 = v6;
    v27 = v15;
    v34 = v27;
    v38 = a3;
    [v25 fetchTransaction:v26 completionHandler:v33];

    objc_destroyWeak(&v37);
    objc_destroyWeak(&location);
    _Block_object_dispose(&buf, 8);

    objc_autoreleasePoolPop(v8);
  }

  else
  {
    v28 = self;
    v29 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v29, OS_LOG_TYPE_DEFAULT))
    {
      v30 = HMFGetLogIdentifier();
      LODWORD(buf) = 138543362;
      *(&buf + 4) = v30;
      _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping home manager zone fetch", &buf, 0xCu);
    }

    objc_autoreleasePoolPop(v8);
    if (v6)
    {
      v31 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75 description:@"Operation was cancelled before it could run" reason:@"iCloud & Controller key was not available" suggestion:@"Make sure that you are signed into iCloud account"];
      (*(v6 + 2))(v6, v31);
    }
  }

  v32 = *MEMORY[0x277D85DE8];
}

void __67__HMDHomeManager__runFetchHomeManagerCloudConflict_syncCompletion___block_invoke(uint64_t a1, void *a2)
{
  v50 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v5 = WeakRetained;
  if (!WeakRetained)
  {
    goto LABEL_20;
  }

  v6 = [WeakRetained logEventSubmitter];
  v7 = +[HMDDecryptionCompletedLogEvent decryptionCompletedWithFailure:](HMDDecryptionCompletedLogEvent, "decryptionCompletedWithFailure:", [*(*(*(a1 + 48) + 8) + 40) decryptionFailed]);
  [v6 submitLogEvent:v7];

  if (!v3 && ![*(*(*(a1 + 48) + 8) + 40) decryptionFailed])
  {
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __67__HMDHomeManager__runFetchHomeManagerCloudConflict_syncCompletion___block_invoke_842;
    aBlock[3] = &unk_279731E18;
    objc_copyWeak(&v45, (a1 + 56));
    v35 = *(a1 + 40);
    v26 = v35;
    v44 = v35;
    v27 = _Block_copy(aBlock);
    v28 = [[HMDCloudTransaction alloc] initWithType:3 temporaryCache:1];
    [(HMDCloudTransaction *)v28 updateCloudZone:*(a1 + 32)];
    v29 = [[HMDCloudTransaction alloc] initWithType:3 temporaryCache:1];
    [(HMDCloudTransaction *)v29 updateCloudZone:*(a1 + 32)];
    v36[0] = MEMORY[0x277D85DD0];
    v36[1] = 3221225472;
    v36[2] = __67__HMDHomeManager__runFetchHomeManagerCloudConflict_syncCompletion___block_invoke_843;
    v36[3] = &unk_279731E40;
    v30 = *(a1 + 48);
    v36[4] = v5;
    v41 = v30;
    v31 = v28;
    v37 = v31;
    v32 = v29;
    v42 = *(a1 + 64);
    v38 = v32;
    v39 = 0;
    v33 = v27;
    v40 = v33;
    [v5 _loadHomeManagerTransactionsToPush:v31 mustReplay:v32 forLegacyPush:0 includeAllChanges:0 completion:v36];

    objc_destroyWeak(&v45);
    goto LABEL_20;
  }

  v8 = [*(*(*(a1 + 48) + 8) + 40) decryptionFailed];
  v9 = objc_autoreleasePoolPush();
  v10 = v5;
  v11 = HMFGetOSLogHandle();
  v12 = os_log_type_enabled(v11, OS_LOG_TYPE_ERROR);
  if (v8)
  {
    if (v12)
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v47 = v13;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@Not processing fetch because decryption failed", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
    goto LABEL_17;
  }

  if (v12)
  {
    v14 = HMFGetLogIdentifier();
    v15 = [v3 hmd_conciseCKError];
    v16 = [v15 shortDescription];
    *buf = 138543618;
    v47 = v14;
    v48 = 2112;
    v49 = v16;
    _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@Not processing fetch because of error: %{error}@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  v17 = [v3 domain];
  if ([v17 isEqualToString:*MEMORY[0x277CBBF50]])
  {
    v18 = [v3 userInfo];
    v19 = v18 == 0;

    if (v19)
    {
      goto LABEL_17;
    }

    v20 = [v3 userInfo];
    v17 = [v20 hmf_numberForKey:*MEMORY[0x277CBBF68]];

    if (v17)
    {
      v21 = objc_autoreleasePoolPush();
      v22 = v10;
      v23 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = HMFGetLogIdentifier();
        *buf = 138543618;
        v47 = v24;
        v48 = 2112;
        v49 = v17;
        _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, "%{public}@Rescheduling home manager zone fetch with delay %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v21);
      [v17 doubleValue];
      [v22 _fetchHomeManagerCloudConflict:0 withDelay:0 completionHandler:?];
    }
  }

LABEL_17:
  [*(*(*(a1 + 48) + 8) + 40) setOsTransaction:0];
  v25 = *(a1 + 40);
  if (v25)
  {
    (*(v25 + 16))(v25, v3);
  }

LABEL_20:

  v34 = *MEMORY[0x277D85DE8];
}

void __67__HMDHomeManager__runFetchHomeManagerCloudConflict_syncCompletion___block_invoke_842(uint64_t a1, void *a2)
{
  v19 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if ([WeakRetained isHomeManagerZoneFirstFetch])
  {
    v5 = [*(*(*(a1 + 40) + 8) + 40) hasValidChanges];
    v6 = objc_autoreleasePoolPush();
    v7 = WeakRetained;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Home Manager Zone determined ready", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    [v7 setHomeManagerZoneFirstFetch:0];
    v10 = [v7 notificationCenter];
    v11 = [MEMORY[0x277CCABB0] numberWithBool:{v5, @"HMDCR.id", @"HMDCR.stc", @"1411CE6C-B4DE-4622-A49D-F66FE296D6B5"}];
    v16[1] = v11;
    v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v16 forKeys:&v15 count:2];
    [v10 postNotificationName:@"HMDCloudZoneReadyNotification" object:0 userInfo:v12];
  }

  v13 = *(a1 + 32);
  if (v13)
  {
    (*(v13 + 16))(v13, v3);
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__fetchHomeManagerCloudConflict_withDelay_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v11 = a2;
  v7 = a3;
  if (a4)
  {
    if (!v11)
    {
      goto LABEL_9;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    v11[2](v11, v8);
  }

  else
  {
    WeakRetained = objc_loadWeakRetained((a1 + 40));
    if (WeakRetained)
    {
      v8 = WeakRetained;
      [WeakRetained _runFetchHomeManagerCloudConflict:objc_msgSend(v7 syncCompletion:{"isCloudConflict"), v11}];
    }

    else
    {
      v8 = *(a1 + 32);
      if (v8)
      {
        v10 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled as the HMDHomeManager object went out of scope" reason:@"HMDHomeManager is no longer valid" suggestion:@"Debug... May be..."];
        (v8)[2](v8, v10);

        v8 = 0;
      }
    }
  }

LABEL_9:
}

- (void)fetchHomeManagerCloudConflict:(BOOL)a3 withDelay:(double)a4
{
  objc_initWeak(&location, self);
  v6 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __58__HMDHomeManager_fetchHomeManagerCloudConflict_withDelay___block_invoke;
  block[3] = &unk_2797319D8;
  objc_copyWeak(&v8, &location);
  v9 = a3;
  dispatch_async(v6, block);

  objc_destroyWeak(&v8);
  objc_destroyWeak(&location);
}

void __58__HMDHomeManager_fetchHomeManagerCloudConflict_withDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _fetchHomeManagerCloudConflict:*(a1 + 40) withDelay:0 completionHandler:0.0];
    WeakRetained = v3;
  }
}

- (void)_updateHomeManagerModelChangesAsPushed:(id)a3 pushMask:(unint64_t)a4 completion:(id)a5
{
  v8 = a5;
  v9 = a3;
  v10 = [[HMDBackingStoreLogUpdateOperation alloc] initWithRowIDs:v9 successfullyPushedTo:a4];

  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __77__HMDHomeManager__updateHomeManagerModelChangesAsPushed_pushMask_completion___block_invoke;
  v13[3] = &unk_279735558;
  v14 = v8;
  v11 = v8;
  [(HMDBackingStoreOperation *)v10 setResultBlock:v13];
  v12 = [(HMDHomeManager *)self backingStore];
  [v12 submit:v10];
}

uint64_t __77__HMDHomeManager__updateHomeManagerModelChangesAsPushed_pushMask_completion___block_invoke(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

- (void)_updateHomeManagerModelChangesAsPushed:(id)a3 legacyPush:(BOOL)a4
{
  v4 = a4;
  v23 = *MEMORY[0x277D85DE8];
  v6 = a3;
  if ([v6 count])
  {
    if (v4)
    {
      v7 = 1;
    }

    else
    {
      v7 = 2;
    }

    v8 = dispatch_group_create();
    dispatch_group_enter(v8);
    v9 = [[HMDBackingStoreLogUpdateOperation alloc] initWithRowIDs:v6 successfullyPushedTo:v7];
    objc_initWeak(&location, self);
    v17[0] = MEMORY[0x277D85DD0];
    v17[1] = 3221225472;
    v17[2] = __68__HMDHomeManager__updateHomeManagerModelChangesAsPushed_legacyPush___block_invoke;
    v17[3] = &unk_2797338E8;
    objc_copyWeak(&v19, &location);
    v10 = v8;
    v18 = v10;
    [(HMDBackingStoreOperation *)v9 setResultBlock:v17];
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEBUG))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEBUG, "%{public}@Update homemanager datastore items pushed started", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    v15 = [(HMDHomeManager *)v12 backingStore];
    [v15 submit:v9];

    dispatch_group_wait(v10, 0xFFFFFFFFFFFFFFFFLL);
    objc_destroyWeak(&v19);
    objc_destroyWeak(&location);
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __68__HMDHomeManager__updateHomeManagerModelChangesAsPushed_legacyPush___block_invoke(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  dispatch_group_leave(*(a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Update homemanager datastore items pushed completed", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85DE8];
}

- (void)_loadHomeManagerTransactionsToPush:(id)a3 mustReplay:(id)a4 forLegacyPush:(BOOL)a5 includeAllChanges:(BOOL)a6 completion:(id)a7
{
  v9 = a5;
  v65 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v41 = a4;
  v13 = a7;
  if (v12)
  {
    v40 = v13;
    if (v9)
    {
      v14 = 1;
    }

    else
    {
      v14 = 2;
    }

    v15 = [MEMORY[0x277CBEB18] array];
    v16 = [MEMORY[0x277CBEB18] array];
    v17 = [MEMORY[0x277CBEB58] set];
    *&v62 = 0;
    *(&v62 + 1) = &v62;
    v63 = 0x2020000000;
    v64 = 0;
    v18 = objc_autoreleasePoolPush();
    v19 = self;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_DEBUG))
    {
      v21 = HMFGetLogIdentifier();
      *buf = 138543362;
      v61 = v21;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEBUG, "%{public}@Find all home manager changes in datastore", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    objc_initWeak(&location, v19);
    v22 = [HMDBackingStoreLogFetchOperation alloc];
    v48[0] = MEMORY[0x277D85DD0];
    v48[1] = 3221225472;
    v48[2] = __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_825;
    v48[3] = &unk_279731DA0;
    v56 = a6;
    v49 = v12;
    v50 = v41;
    v23 = v16;
    v51 = v23;
    v24 = v15;
    v52 = v24;
    v53 = v19;
    v25 = v17;
    v54 = v25;
    v55 = &v62;
    v26 = [(HMDBackingStoreLogFetchOperation *)v22 initWithNeedsPushTo:v14 result:v48];
    v42[0] = MEMORY[0x277D85DD0];
    v42[1] = 3221225472;
    v42[2] = __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_826;
    v42[3] = &unk_279732DE0;
    objc_copyWeak(&v47, &location);
    v27 = v25;
    v43 = v27;
    v45 = v40;
    v28 = v23;
    v44 = v28;
    v46 = &v62;
    [(HMDBackingStoreOperation *)v26 setResultBlock:v42];
    v29 = objc_autoreleasePoolPush();
    v30 = v19;
    v31 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v31, OS_LOG_TYPE_DEBUG))
    {
      v32 = HMFGetLogIdentifier();
      *buf = 138543362;
      v61 = v32;
      _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_DEBUG, "%{public}@Load transactions from home manager datastore", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v29);
    v33 = [(HMDHomeManager *)v30 backingStore];
    [v33 submit:v26];

    objc_destroyWeak(&v47);
    objc_destroyWeak(&location);
    _Block_object_dispose(&v62, 8);

LABEL_14:
    v13 = v40;
    goto LABEL_15;
  }

  if (v13)
  {
    v40 = v13;
    v34 = objc_autoreleasePoolPush();
    v35 = self;
    v36 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v36, OS_LOG_TYPE_ERROR))
    {
      v37 = HMFGetLogIdentifier();
      LODWORD(v62) = 138543362;
      *(&v62 + 4) = v37;
      _os_log_impl(&dword_2531F8000, v36, OS_LOG_TYPE_ERROR, "%{public}@A cloudTransaction is required query datastore", &v62, 0xCu);
    }

    objc_autoreleasePoolPop(v34);
    v38 = [(HMDHomeManager *)v35 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke;
    block[3] = &unk_2797348C0;
    v59 = v40;
    dispatch_async(v38, block);

    v24 = v59;
    goto LABEL_14;
  }

LABEL_15:

  v39 = *MEMORY[0x277D85DE8];
}

void __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke(uint64_t a1)
{
  v2 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  (*(*(a1 + 32) + 16))();
}

uint64_t __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_825(uint64_t a1, void *a2, void *a3, void *a4)
{
  v85 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v62 = a3;
  v58 = a4;
  v74 = 0u;
  v75 = 0u;
  v76 = 0u;
  v77 = 0u;
  obj = v7;
  v8 = [obj countByEnumeratingWithState:&v74 objects:v84 count:16];
  if (v8)
  {
    v9 = v8;
    v10 = *v75;
    v11 = 0x277CCA000;
    v59 = *v75;
    do
    {
      v12 = 0;
      v60 = v9;
      do
      {
        if (*v75 != v10)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v74 + 1) + 8 * v12);
        if (*(a1 + 88) == 1)
        {
          goto LABEL_7;
        }

        v15 = v13;
        objc_opt_class();
        if (objc_opt_isKindOfClass())
        {
          v16 = v15;
        }

        else
        {
          v16 = 0;
        }

        v17 = v16;

        v65 = v15;
        if (v17)
        {
        }

        else
        {
          v18 = v15;
          objc_opt_class();
          isKindOfClass = objc_opt_isKindOfClass();

          if ((isKindOfClass & 1) == 0 || !v18)
          {
            v13 = v18;
            objc_opt_class();
            if (objc_opt_isKindOfClass())
            {
              v52 = v13;
            }

            else
            {
              v52 = 0;
            }

            v53 = v52;

            if (v53)
            {
              v54 = [v13 objectChangeType];

              if (v54 == 3)
              {
                *(*(*(a1 + 80) + 8) + 24) = 1;
              }
            }

LABEL_7:
            [*(a1 + 32) addChangeWithObjectChange:{v13, v58}];
            if ([v62 mustReplay])
            {
              v14 = *(a1 + 40);
              if (v14)
              {
                [v14 addChangeWithObjectChange:v13];
              }
            }

            goto LABEL_43;
          }
        }

        v20 = v15;
        if ([v15 objectChangeType] == 3)
        {
          v63 = v12;
          [*(a1 + 48) addObject:v15];
          v72 = 0u;
          v73 = 0u;
          v70 = 0u;
          v71 = 0u;
          v64 = [*(a1 + 56) copy];
          v21 = [v64 countByEnumeratingWithState:&v70 objects:v83 count:16];
          if (v21)
          {
            v22 = v21;
            v23 = v15;
            v24 = *v71;
            do
            {
              for (i = 0; i != v22; ++i)
              {
                if (*v71 != v24)
                {
                  objc_enumerationMutation(v64);
                }

                v26 = *(*(&v70 + 1) + 8 * i);
                v27 = [v23 uuid];
                v28 = [v26 uuid];
                v29 = [v27 isEqual:v28];

                if (v29)
                {
                  v30 = objc_autoreleasePoolPush();
                  v31 = *(a1 + 64);
                  v32 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
                  {
                    v33 = HMFGetLogIdentifier();
                    v34 = [v26 uuid];
                    *buf = 138543618;
                    v80 = v33;
                    v81 = 2112;
                    v82 = v34;
                    _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@Dropping added home because it was removed %@", buf, 0x16u);

                    v23 = v65;
                    v11 = 0x277CCA000uLL;
                  }

                  objc_autoreleasePoolPop(v30);
                  [*(a1 + 56) removeObject:v26];
                  v35 = *(a1 + 72);
                  v36 = [*(v11 + 2992) numberWithUnsignedLongLong:{objc_msgSend(v26, "bsoLogRowID")}];
                  [v35 addObject:v36];
                }
              }

              v22 = [v64 countByEnumeratingWithState:&v70 objects:v83 count:16];
            }

            while (v22);
          }
        }

        else
        {
          if ([v15 objectChangeType] != 1)
          {
            goto LABEL_43;
          }

          v63 = v12;
          [*(a1 + 56) addObject:v15];
          v68 = 0u;
          v69 = 0u;
          v66 = 0u;
          v67 = 0u;
          v64 = [*(a1 + 48) copy];
          v37 = [v64 countByEnumeratingWithState:&v66 objects:v78 count:16];
          if (v37)
          {
            v38 = v37;
            v39 = *v67;
            do
            {
              for (j = 0; j != v38; ++j)
              {
                if (*v67 != v39)
                {
                  objc_enumerationMutation(v64);
                }

                v41 = *(*(&v66 + 1) + 8 * j);
                v42 = [v20 uuid];
                v43 = [v41 uuid];
                v44 = [v42 isEqual:v43];

                if (v44)
                {
                  v45 = objc_autoreleasePoolPush();
                  v46 = *(a1 + 64);
                  v47 = HMFGetOSLogHandle();
                  if (os_log_type_enabled(v47, OS_LOG_TYPE_INFO))
                  {
                    v48 = HMFGetLogIdentifier();
                    v49 = [v41 uuid];
                    *buf = 138543618;
                    v80 = v48;
                    v81 = 2112;
                    v82 = v49;
                    _os_log_impl(&dword_2531F8000, v47, OS_LOG_TYPE_INFO, "%{public}@Dropping removed home because it was added %@", buf, 0x16u);

                    v11 = 0x277CCA000uLL;
                  }

                  objc_autoreleasePoolPop(v45);
                  [*(a1 + 48) removeObject:v41];
                  v50 = *(a1 + 72);
                  v51 = [*(v11 + 2992) numberWithUnsignedLongLong:{objc_msgSend(v41, "bsoLogRowID")}];
                  [v50 addObject:v51];
                }

                v20 = v65;
              }

              v38 = [v64 countByEnumeratingWithState:&v66 objects:v78 count:16];
            }

            while (v38);
          }
        }

        v10 = v59;
        v9 = v60;
        v12 = v63;
LABEL_43:
        ++v12;
      }

      while (v12 != v9);
      v55 = [obj countByEnumeratingWithState:&v74 objects:v84 count:16];
      v9 = v55;
    }

    while (v55);
  }

  v56 = *MEMORY[0x277D85DE8];
  return 1;
}

void __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_826(uint64_t a1, void *a2)
{
  v29 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if ([*(a1 + 32) count])
    {
      v5 = [HMDBackingStoreLogUpdateOperation alloc];
      v6 = [*(a1 + 32) allObjects];
      v7 = [(HMDBackingStoreLogUpdateOperation *)v5 initWithRowIDs:v6 successfullyPushedTo:3];

      v25[0] = MEMORY[0x277D85DD0];
      v25[1] = 3221225472;
      v25[2] = __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_2;
      v25[3] = &unk_279734708;
      objc_copyWeak(&v26, (a1 + 64));
      [(HMDBackingStoreOperation *)v7 setResultBlock:v25];
      v8 = objc_autoreleasePoolPush();
      v9 = WeakRetained;
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEBUG))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543362;
        v28 = v11;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEBUG, "%{public}@Scheduling cleanup of obsolete data in datastore", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v8);
      v12 = [v9 backingStore];
      [v12 submit:v7];

      objc_destroyWeak(&v26);
    }

    v13 = objc_autoreleasePoolPush();
    v14 = WeakRetained;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEBUG))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543362;
      v28 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_DEBUG, "%{public}@Finished loading transactions from home manager datastore", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    if (*(a1 + 48))
    {
      v17 = [v14 workQueue];
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_828;
      v21[3] = &unk_279731DC8;
      v23 = *(a1 + 48);
      v18 = *(a1 + 40);
      v19 = *(a1 + 56);
      v22 = v18;
      v24 = v19;
      dispatch_async(v17, v21);
    }
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __107__HMDHomeManager__loadHomeManagerTransactionsToPush_mustReplay_forLegacyPush_includeAllChanges_completion___block_invoke_2(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_DEBUG))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEBUG, "%{public}@Finished cleaning up obsolete data in datastore", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = *MEMORY[0x277D85DE8];
}

- (void)_uploadHomeManagerToCloudSyncCompletion:(id)a3
{
  v28 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self hasiCloudAndControllerKey];
  v6 = objc_autoreleasePoolPush();
  if (v5)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v27 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Pushing changes up to the cloud", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [(HMDHomeManager *)v8 cloudDataSyncManager];
    v12 = [v11 cloudCache];

    v13 = [v12 homeManagerZone];
    v14 = [[HMDCloudTransaction alloc] initWithType:3 temporaryCache:0];
    [(HMDCloudTransaction *)v14 updateCloudZone:v13];
    v15 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-to-hmzone"];
    [(HMDCloudTransaction *)v14 setOsTransaction:v15];

    objc_initWeak(buf, v8);
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke;
    v22[3] = &unk_279731D78;
    objc_copyWeak(&v25, buf);
    v16 = v14;
    v23 = v16;
    v24 = v4;
    [(HMDHomeManager *)v8 _loadHomeManagerTransactionsToPush:v16 mustReplay:0 forLegacyPush:0 includeAllChanges:0 completion:v22];

    objc_destroyWeak(&v25);
    objc_destroyWeak(buf);

    objc_autoreleasePoolPop(v6);
  }

  else
  {
    v17 = self;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v27 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping home manager zone push.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    if (v4)
    {
      v20 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75 description:@"Operation was cancelled before it could run" reason:@"iCloud & Controller key was not available" suggestion:@"Make sure that you are signed into iCloud account"];
      (*(v4 + 2))(v4, v20);
    }
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke(id *a1, void *a2, char a3, void *a4)
{
  v28 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a4;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  if (WeakRetained)
  {
    if (([a1[4] hasValidChanges] & 1) != 0 || objc_msgSend(v7, "count"))
    {
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke_823;
      v21[3] = &unk_279731D50;
      objc_copyWeak(&v24, a1 + 6);
      v22 = a1[4];
      v25 = a3;
      v23 = a1[5];
      [WeakRetained _processRemoveHomeModels:v7 processIndex:0 completion:v21];

      objc_destroyWeak(&v24);
    }

    else
    {
      v11 = objc_autoreleasePoolPush();
      v12 = WeakRetained;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        *buf = 138543362;
        v27 = v14;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@No transaction were loaded from backing store, dropping home manager upload", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
      if ([v12 backOffOperationInProgress])
      {
        [v12 setBackOffOperationInProgress:0];
        v15 = objc_autoreleasePoolPush();
        v16 = v12;
        v17 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
        {
          v18 = HMFGetLogIdentifier();
          *buf = 138543362;
          v27 = v18;
          _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Clearing that we were in a backoff operation", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v15);
      }

      v19 = [a1[4] allTransactionStoreRowIDs];
      [v12 _updateHomeManagerModelChangesAsPushed:v19 legacyPush:0];

      [a1[4] setOsTransaction:0];
      v20 = a1[5];
      if (v20)
      {
        v20[2](v20, 0);
      }
    }
  }

  v10 = *MEMORY[0x277D85DE8];
}

void __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke_823(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    v4 = [WeakRetained cloudDataSyncManager];
    v5 = *(a1 + 32);
    v6[0] = MEMORY[0x277D85DD0];
    v6[1] = 3221225472;
    v6[2] = __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke_2;
    v6[3] = &unk_279731D28;
    objc_copyWeak(&v9, (a1 + 48));
    v7 = *(a1 + 32);
    v10 = *(a1 + 56);
    v8 = *(a1 + 40);
    [v4 uploadTransaction:v5 completionHandler:v6];

    objc_destroyWeak(&v9);
  }
}

void __58__HMDHomeManager__uploadHomeManagerToCloudSyncCompletion___block_invoke_2(uint64_t a1, void *a2)
{
  v33 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [v3 hmd_conciseCKError];
    v10 = [v9 shortDescription];
    v29 = 138543618;
    v30 = v8;
    v31 = 2112;
    v32 = v10;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Uploaded data to home manager zone with error status: %@", &v29, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  if (v6)
  {
    if ([v6 backOffOperationInProgress])
    {
      [v6 setBackOffOperationInProgress:0];
      v11 = objc_autoreleasePoolPush();
      v12 = v6;
      v13 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
      {
        v14 = HMFGetLogIdentifier();
        v29 = 138543362;
        v30 = v14;
        _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Clearing that we were in a backoff operation", &v29, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
    }

    if (v3)
    {
      v15 = [v3 domain];
      if ([v15 isEqualToString:*MEMORY[0x277CBBF50]])
      {
        v16 = [v3 userInfo];

        if (!v16)
        {
          goto LABEL_20;
        }

        v17 = [v3 userInfo];
        v15 = [v17 hmf_numberForKey:*MEMORY[0x277CBBF68]];

        if (v15)
        {
          v18 = objc_autoreleasePoolPush();
          v19 = v6;
          v20 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
          {
            v21 = HMFGetLogIdentifier();
            v29 = 138543618;
            v30 = v21;
            v31 = 2112;
            v32 = v15;
            _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Rescheduling home manager zone push with delay %@", &v29, 0x16u);
          }

          objc_autoreleasePoolPop(v18);
          [v15 doubleValue];
          [v19 _uploadHomeManagerToCloudWithDelay:?];
        }
      }
    }

    else
    {
      [v6 _resetCloudOperationRetryCounters];
      v22 = [*(a1 + 32) processedTransactionStoreRowIDs];
      [v6 _updateHomeManagerModelChangesAsPushed:v22 legacyPush:0];

      if (*(a1 + 56) != 1)
      {
        goto LABEL_20;
      }

      v23 = objc_autoreleasePoolPush();
      v24 = v6;
      v25 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
      {
        v26 = HMFGetLogIdentifier();
        v29 = 138543362;
        v30 = v26;
        _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@At least one zone information model was deleted in the cloud, evaluated if account should migration to HH2", &v29, 0xCu);
      }

      objc_autoreleasePoolPop(v23);
      v15 = [v24 cloudDataSyncStateFilter];
      [v15 evaluateMoveToHH2];
    }
  }

LABEL_20:
  [*(a1 + 32) setOsTransaction:0];
  v27 = *(a1 + 40);
  if (v27)
  {
    (*(v27 + 16))(v27, v3);
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_processRemoveHomeModels:(id)a3 processIndex:(unint64_t)a4 completion:(id)a5
{
  v8 = a3;
  v9 = a5;
  if ([v8 count] <= a4)
  {
    if (v9)
    {
      v9[2](v9);
    }
  }

  else
  {
    v10 = [v8 objectAtIndexedSubscript:a4];
    v11 = [(HMDHomeManager *)self cloudDataSyncManager];
    v12 = [v11 cloudCache];

    v13 = [v10 uuid];
    v14 = [HMDHome zoneIDFromHomeUUID:v13];
    v15 = [v14 UUIDString];

    v18[0] = MEMORY[0x277D85DD0];
    v18[1] = 3221225472;
    v18[2] = __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke;
    v18[3] = &unk_279731D00;
    v18[4] = self;
    v19 = v10;
    v20 = v15;
    v21 = v8;
    v23 = a4;
    v22 = v9;
    v16 = v15;
    v17 = v10;
    [v12 homeZoneWithName:v16 owner:&stru_286509E58 completion:v18];
  }
}

void __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v4 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke_2;
  block[3] = &unk_279731CD8;
  v13 = v3;
  *&v5 = *(a1 + 40);
  *(&v5 + 1) = *(a1 + 32);
  v11 = v5;
  v6 = *(a1 + 48);
  v7 = *(a1 + 56);
  *&v8 = v6;
  *(&v8 + 1) = v7;
  v14 = v11;
  v15 = v8;
  v9 = *(a1 + 64);
  v17 = *(a1 + 72);
  v16 = v9;
  v10 = v3;
  dispatch_async(v4, block);
}

void __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke_2(uint64_t a1)
{
  if (*(a1 + 32))
  {
    v2 = [[HMDCloudTransaction alloc] initWithType:4 temporaryCache:0];
    [(HMDCloudTransaction *)v2 updateCloudZone:*(a1 + 32)];
    [(HMDCloudTransaction *)v2 addChangeWithObjectChange:*(a1 + 40)];
    [(HMDCloudTransaction *)v2 setDeleteZone:1];
    objc_initWeak(&location, *(a1 + 48));
    v3 = [*(a1 + 48) cloudDataSyncManager];
    v14[0] = MEMORY[0x277D85DD0];
    v14[1] = 3221225472;
    v14[2] = __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke_3;
    v14[3] = &unk_279731F80;
    v14[4] = *(a1 + 48);
    v15 = *(a1 + 32);
    objc_copyWeak(v20, &location);
    v16 = *(a1 + 56);
    v4 = v2;
    v17 = v4;
    v5 = *(a1 + 64);
    v7 = *(a1 + 72);
    v6 = *(a1 + 80);
    v18 = v5;
    v20[1] = v6;
    v19 = v7;
    [v3 removeZonesTransactions:v4 completionHandler:v14];

    objc_destroyWeak(v20);
    objc_destroyWeak(&location);
  }

  else
  {
    if (*(a1 + 56))
    {
      v8 = [*(a1 + 48) cloudDataSyncManager];
      [v8 removeHomeZoneName:*(a1 + 56)];

      v9 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:*(a1 + 56)];
      [*(a1 + 48) _removeCloudZone:v9 updateHomeManager:0];
    }

    v10 = *(a1 + 48);
    v11 = *(a1 + 72);
    v12 = *(a1 + 64);
    v13 = *(a1 + 80) + 1;

    [v10 _processRemoveHomeModels:v12 processIndex:v13 completion:v11];
  }
}

void __67__HMDHomeManager__processRemoveHomeModels_processIndex_completion___block_invoke_3(uint64_t a1, void *a2)
{
  v22 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v8 = *(a1 + 40);
    v9 = [v3 hmd_conciseCKError];
    v10 = [v9 shortDescription];
    v16 = 138543874;
    v17 = v7;
    v18 = 2112;
    v19 = v8;
    v20 = 2112;
    v21 = v10;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Removed zone %@ with error status: %@", &v16, 0x20u);
  }

  objc_autoreleasePoolPop(v4);
  WeakRetained = objc_loadWeakRetained((a1 + 80));
  v12 = WeakRetained;
  if (WeakRetained)
  {
    if (!v3)
    {
      if (*(a1 + 48))
      {
        v13 = [WeakRetained cloudDataSyncManager];
        [v13 removeHomeZoneName:*(a1 + 48)];
      }

      [*(a1 + 56) setAllChangedAsProcessed];
      v14 = [*(a1 + 56) processedTransactionStoreRowIDs];
      [v12 _updateHomeManagerModelChangesAsPushed:v14 legacyPush:0];
    }

    [v12 _processRemoveHomeModels:*(a1 + 64) processIndex:*(a1 + 88) + 1 completion:*(a1 + 72)];
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)_uploadHomeManagerToCloudWithDelay:(double)a3
{
  location[3] = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self hasiCloudAndControllerKey])
  {
    objc_initWeak(location, self);
    aBlock[0] = MEMORY[0x277D85DD0];
    aBlock[1] = 3221225472;
    aBlock[2] = __53__HMDHomeManager__uploadHomeManagerToCloudWithDelay___block_invoke;
    aBlock[3] = &unk_279731CB0;
    objc_copyWeak(&v19, location);
    v5 = _Block_copy(aBlock);
    v6 = [(HMDHomeManager *)self cloudDataSyncManager];
    v7 = [v6 homeManagerZone];

    v8 = [v7 zone];
    v9 = [v8 zoneID];
    v10 = [v9 zoneName];
    v11 = [HMDSyncOperation cloudZonePushSyncOperation:v10 block:v5];

    v12 = [(HMDHomeManager *)self syncManager];
    [v12 addOperation:v11 withDelay:a3];

    objc_destroyWeak(&v19);
    objc_destroyWeak(location);
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_DEFAULT))
    {
      v16 = HMFGetLogIdentifier();
      LODWORD(location[0]) = 138543362;
      *(location + 4) = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_DEFAULT, "%{public}@Not scheduling home manager zone push.", location, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
  }

  v17 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager__uploadHomeManagerToCloudWithDelay___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v10 = a2;
  v7 = a3;
  if (a4)
  {
    if (!v10)
    {
      goto LABEL_7;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    v10[2](v10, v8);
  }

  else
  {
    WeakRetained = objc_loadWeakRetained((a1 + 32));
    v8 = WeakRetained;
    if (WeakRetained)
    {
      [WeakRetained _uploadHomeManagerToCloudSyncCompletion:v10];
    }
  }

LABEL_7:
}

- (void)uploadHomeManagerToCloudWithDelay:(double)a3
{
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __52__HMDHomeManager_uploadHomeManagerToCloudWithDelay___block_invoke;
  block[3] = &unk_279731C88;
  objc_copyWeak(v7, &location);
  v7[1] = *&a3;
  dispatch_async(v5, block);

  objc_destroyWeak(v7);
  objc_destroyWeak(&location);
}

void __52__HMDHomeManager_uploadHomeManagerToCloudWithDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _uploadHomeManagerToCloudWithDelay:*(a1 + 40)];
    WeakRetained = v3;
  }
}

- (void)sendUnsecureMessage:(id)a3 target:(id)a4 userID:(id)a5 responseQueue:(id)a6 responseHandler:(id)a7
{
  v38 = *MEMORY[0x277D85DE8];
  v12 = a3;
  v13 = a4;
  v14 = a5;
  v15 = a6;
  v16 = a7;
  v17 = [HMDMessageDispatcher destinationWithTarget:v13 userID:v14 destination:0 multicast:1];
  if (v17)
  {
    [v12 setDestination:v17];
    v18 = [v12 responseHandler];

    if (v16 && !v18)
    {
      v27[0] = MEMORY[0x277D85DD0];
      v27[1] = 3221225472;
      v27[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_2;
      v27[3] = &unk_279732CF0;
      v28 = v15;
      v29 = v16;
      [v12 setResponseHandler:v27];
    }

    v19 = [(HMDHomeManager *)self messageDispatcher];
    [v19 sendMessage:v12 completionHandler:0];
    goto LABEL_11;
  }

  v20 = objc_autoreleasePoolPush();
  v21 = self;
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_DEFAULT))
  {
    v23 = HMFGetLogIdentifier();
    [v12 shortDescription];
    v24 = v26 = v20;
    *buf = 138543874;
    v33 = v23;
    v34 = 2112;
    v35 = v24;
    v36 = 2112;
    v37 = v14;
    _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot send unsecure message %@: could not create message destination for userID: %@", buf, 0x20u);

    v20 = v26;
  }

  objc_autoreleasePoolPop(v20);
  if (v15 && v16)
  {
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke;
    block[3] = &unk_2797348C0;
    v31 = v16;
    dispatch_async(v15, block);
    v19 = v31;
LABEL_11:
  }

  v25 = *MEMORY[0x277D85DE8];
}

void __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke(uint64_t a1)
{
  v1 = *(a1 + 32);
  v2 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
  (*(v1 + 16))(v1, v2, 0);
}

void __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_2(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = *(a1 + 32);
  if (v7)
  {
    v8 = *(a1 + 40);
    if (v8)
    {
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __82__HMDHomeManager_sendUnsecureMessage_target_userID_responseQueue_responseHandler___block_invoke_3;
      block[3] = &unk_2797355D0;
      v12 = v8;
      v10 = v5;
      v11 = v6;
      dispatch_async(v7, block);
    }
  }
}

- (void)sendSecureMessage:(id)a3 target:(id)a4 userID:(id)a5 destination:(id)a6 responseQueue:(id)a7 responseHandler:(id)a8
{
  v14 = a8;
  v15 = a7;
  v16 = a6;
  v17 = a5;
  v18 = a4;
  v19 = a3;
  v20 = [(HMDHomeManager *)self messageDispatcher];
  [v20 sendSecureMessage:v19 target:v18 userID:v17 destination:v16 responseQueue:v15 responseHandler:v14];
}

- (void)electDeviceForUser:(id)a3 destination:(id)a4 deviceCapabilities:(id)a5 queue:(id)a6 completionHandler:(id)a7
{
  v12 = a7;
  v13 = a6;
  v14 = a5;
  v15 = a4;
  v16 = a3;
  v17 = [(HMDHomeManager *)self messageDispatcher];
  [v17 electDeviceForHH1User:v16 destination:v15 deviceCapabilities:v14 responseTimeout:v13 responseQueue:v12 responseHandler:0.0];
}

- (void)sendUserRemoved:(id)a3 fromHome:(id)a4 pairingUsername:(id)a5 pushToCloud:(BOOL)a6 completionHandler:(id)a7
{
  v12 = a3;
  v13 = a4;
  v14 = a5;
  v15 = a7;
  objc_initWeak(&location, self);
  v16 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __89__HMDHomeManager_sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke;
  block[3] = &unk_279731C60;
  objc_copyWeak(&v26, &location);
  v22 = v12;
  v23 = v13;
  v27 = a6;
  v24 = v14;
  v25 = v15;
  v17 = v15;
  v18 = v14;
  v19 = v13;
  v20 = v12;
  dispatch_async(v16, block);

  objc_destroyWeak(&v26);
  objc_destroyWeak(&location);
}

void __89__HMDHomeManager_sendUserRemoved_fromHome_pairingUsername_pushToCloud_completionHandler___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  [WeakRetained _sendUserRemoved:*(a1 + 32) fromHome:*(a1 + 40) pairingUsername:*(a1 + 48) pushToCloud:*(a1 + 72) completionHandler:*(a1 + 56)];
}

- (void)sendUserAdded:(id)a3 destination:(id)a4 toHome:(id)a5
{
  v8 = a3;
  v9 = a4;
  v10 = a5;
  objc_initWeak(&location, self);
  v11 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __51__HMDHomeManager_sendUserAdded_destination_toHome___block_invoke;
  block[3] = &unk_279733910;
  objc_copyWeak(&v19, &location);
  v16 = v8;
  v17 = v9;
  v18 = v10;
  v12 = v10;
  v13 = v9;
  v14 = v8;
  dispatch_async(v11, block);

  objc_destroyWeak(&v19);
  objc_destroyWeak(&location);
}

void __51__HMDHomeManager_sendUserAdded_destination_toHome___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  [WeakRetained _sendUserAdded:*(a1 + 32) destination:*(a1 + 40) toHome:*(a1 + 48)];
}

- (void)notifyClientsOfUserSettingsChangeWithReason:(id)a3 sourceUUID:(id)a4
{
  v6 = MEMORY[0x277CCAB98];
  v7 = a4;
  v9 = a3;
  v8 = [v6 defaultCenter];
  [v8 postNotificationName:@"HMDUserSettingsUpdatedNotificationKey" object:0];

  [(HMDHomeManager *)self updateGenerationCounterWithReason:v9 sourceUUID:v7 shouldNotifyClients:1];
}

- (void)_notifyXPCClientsOfHomeConfigurationChange
{
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  if ([(HMDHomeManager *)self _shouldNotifyClientsAboutGenerationCounterUpdate])
  {
    v4 = MEMORY[0x277D0F818];
    v5 = [(HMDHomeManager *)self messageDestination];
    v9 = [v4 messageWithName:@"kHomesDidUpdateNotificationKey" qualityOfService:9 destination:v5 payload:0];

    v6 = [(HMDHomeManager *)self messageDispatcher];
    [v6 sendMessage:v9];

    v7 = [(HMDHomeManager *)self logEventSubmitter];
    v8 = objc_alloc_init(HMDNotifyXPCClientsOfHomeConfigurationChangeLogEvent);
    [v7 submitLogEvent:v8];

    [(HMDHomeManager *)self _notifyMetricsManagerOfConfigurationChange];
    logAndPostNotification(@"HMDHomeManagerNotifiedXPCClientsOfHomeConfigurationChangeNotification", self, 0);
  }
}

- (void)_updateGenerationCounterWithReason:(id)a3 sourceUUID:(id)a4 shouldNotifyClients:(BOOL)a5
{
  v5 = a5;
  v36 = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v10);

  v11 = objc_autoreleasePoolPush();
  v12 = self;
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
  {
    v14 = HMFGetLogIdentifier();
    v26 = 138544386;
    v27 = v14;
    v28 = 2048;
    v29 = [(HMDHomeManager *)v12 generationCounter]+ 1;
    v30 = 1024;
    v31 = v5;
    v32 = 2114;
    v33 = v8;
    v34 = 2114;
    v35 = v9;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Updating generation counter to %llu (shouldNotifyClients is %d): %{public}@-%{public}@", &v26, 0x30u);
  }

  objc_autoreleasePoolPop(v11);
  [(HMDHomeManager *)v12 setGenerationCounter:[(HMDHomeManager *)v12 generationCounter]+ 1];
  v15 = [(HMDHomeManager *)v12 userDefaults];
  [v15 setInteger:-[HMDHomeManager generationCounter](v12 forKey:{"generationCounter"), @"HMDHomeManagerGenerationCounter"}];

  if ([(HMDHomeManager *)v12 generationCounterToken]!= -1 && [(HMDHomeManager *)v12 _shouldNotifyClientsAboutGenerationCounterUpdate])
  {
    v16 = [(HMDHomeManager *)v12 darwinNotificationProvider];
    [v16 notifySetState:-[HMDHomeManager generationCounterToken](v12 state:{"generationCounterToken"), -[HMDHomeManager generationCounter](v12, "generationCounter")}];

    v17 = [(HMDHomeManager *)v12 darwinNotificationProvider];
    [v17 notifyPost:*MEMORY[0x277CD0200]];
  }

  if ([(HMDHomeManager *)v12 postSyncDataUpdatedNotification])
  {
    [(HMDHomeManager *)v12 setPostSyncDataUpdatedNotification:0];
    v18 = objc_autoreleasePoolPush();
    v19 = v12;
    v20 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
    {
      v21 = HMFGetLogIdentifier();
      v26 = 138543362;
      v27 = v21;
      _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Posting sync data updated notification after updating generation counter", &v26, 0xCu);
    }

    objc_autoreleasePoolPop(v18);
    notify_post(*MEMORY[0x277CCF2C8]);
  }

  v22 = [(HMDHomeManager *)v12 logEventSubmitter];
  v23 = objc_alloc_init(HMDIncrementGenerationCounterLogEvent);
  [v22 submitLogEvent:v23];

  if (v5)
  {
    v24 = [(HMDHomeManager *)v12 debounceHomesUpdateTimer];
    [v24 resume];
  }

  v25 = *MEMORY[0x277D85DE8];
}

- (void)updateGenerationCounterWithReason:(id)a3 sourceUUID:(id)a4 shouldNotifyClients:(BOOL)a5
{
  v8 = a3;
  v9 = a4;
  v10 = [(HMDHomeManager *)self workQueue];
  v13[0] = MEMORY[0x277D85DD0];
  v13[1] = 3221225472;
  v13[2] = __83__HMDHomeManager_updateGenerationCounterWithReason_sourceUUID_shouldNotifyClients___block_invoke;
  v13[3] = &unk_279731C38;
  v13[4] = self;
  v14 = v8;
  v15 = v9;
  v16 = a5;
  v11 = v9;
  v12 = v8;
  dispatch_async(v10, v13);
}

- (void)setGenerationCounter:(unint64_t)a3
{
  os_unfair_lock_lock_with_options();
  self->_generationCounter = a3;

  os_unfair_lock_unlock(&self->_lock);
}

- (unint64_t)generationCounter
{
  os_unfair_lock_lock_with_options();
  generationCounter = self->_generationCounter;
  os_unfair_lock_unlock(&self->_lock);
  return generationCounter;
}

- (void)setAccessAllowedWhenLocked:(BOOL)a3
{
  os_unfair_lock_lock_with_options();
  self->_accessAllowedWhenLocked = a3;

  os_unfair_lock_unlock(&self->_lock);
}

- (BOOL)isAccessAllowedWhenLocked
{
  os_unfair_lock_lock_with_options();
  accessAllowedWhenLocked = self->_accessAllowedWhenLocked;
  os_unfair_lock_unlock(&self->_lock);
  return accessAllowedWhenLocked;
}

- (void)_handleAccountStatusDeterminedWithError:(id)a3 homeDataRecordExists:(BOOL)a4 metadataRecordExists:(BOOL)a5 completion:(id)a6
{
  v83 = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a6;
  v12 = objc_autoreleasePoolPush();
  v13 = self;
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
  {
    v15 = HMFGetLogIdentifier();
    *buf = 138543362;
    v78 = v15;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Account status determined, clearing that we were in a backoff operation", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v12);
  [(HMDHomeManager *)v13 setBackOffOperationInProgress:0];
  if (v10)
  {
    v16 = objc_autoreleasePoolPush();
    v17 = v13;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = HMFGetLogIdentifier();
      v20 = [v10 hmd_conciseCKError];
      v21 = [v20 shortDescription];
      *buf = 138543618;
      v78 = v19;
      v79 = 2114;
      v80 = v21;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@Unable to detect account status due to error: %{public}@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v16);
    [(HMDHomeManager *)v17 setCloudkitAccountStatusDetermined:0];
    v22 = [(HMDHomeManager *)v17 multiUserStatusController];
    [v22 didChangeHasActiveAccountState:0];

    if ([(HMDHomeManager *)v17 accountActive])
    {
      if ([v10 code] == 78 || (objc_msgSend(v10, "hmd_convertedCKError"), v23 = objc_claimAutoreleasedReturnValue(), v24 = v23 == 0, v23, !v24))
      {
        [(HMDHomeManager *)v17 setAccountStatusFailedDueToNetworkFailure:1];
        [(HMDHomeManager *)v17 setCloudOperationRetryCount:[(HMDHomeManager *)v17 cloudOperationRetryCount]+ 1];
        v25 = maxCloudOperationRetries;
        v26 = +[HMDDeviceCapabilities deviceCapabilities];
        v27 = [v26 supportsStandaloneMode];

        if (v27)
        {
          v28 = v25 / 2;
        }

        else
        {
          v28 = v25;
        }

        v29 = objc_autoreleasePoolPush();
        v30 = v17;
        v31 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = HMFGetLogIdentifier();
          v33 = [(HMDHomeManager *)v30 cloudOperationRetryCount];
          *buf = 138543874;
          v78 = v32;
          v79 = 2048;
          v80 = v33;
          v81 = 2048;
          v82 = v28;
          _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_DEFAULT, "%{public}@Current cloud operation retry count: %lu/%lu", buf, 0x20u);
        }

        objc_autoreleasePoolPop(v29);
        if ([(HMDHomeManager *)v30 cloudOperationRetryCount]< v28)
        {
          objc_initWeak(buf, v30);
          v73[0] = MEMORY[0x277D85DD0];
          v73[1] = 3221225472;
          v73[2] = __111__HMDHomeManager__handleAccountStatusDeterminedWithError_homeDataRecordExists_metadataRecordExists_completion___block_invoke;
          v73[3] = &unk_279732FD8;
          objc_copyWeak(&v74, buf);
          [(HMDHomeManager *)v30 _retryCloudOperationWithName:@"query account status after one time failure" completionHandler:v73];
          objc_destroyWeak(&v74);
          objc_destroyWeak(buf);
        }
      }
    }
  }

  else
  {
    [(HMDHomeManager *)v13 setAccountStatusFailedDueToNetworkFailure:0];
    [(HMDHomeManager *)v13 setCloudkitAccountStatusDetermined:1];
    v34 = [(HMDHomeManager *)v13 multiUserStatusController];
    [v34 didChangeHasActiveAccountState:1];

    [(HMDHomeManager *)v13 _resetCloudOperationRetryCounters];
    v35 = objc_autoreleasePoolPush();
    v36 = v13;
    v37 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v37, OS_LOG_TYPE_DEFAULT))
    {
      v38 = HMFGetLogIdentifier();
      *buf = 138543362;
      v78 = v38;
      _os_log_impl(&dword_2531F8000, v37, OS_LOG_TYPE_DEFAULT, "%{public}@Account status detected and we have an active account", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v35);
    [(HMDHomeManager *)v36 _determineLocalChangesAndSchedulePush];
    if (!a5)
    {
      v39 = objc_autoreleasePoolPush();
      v40 = v36;
      v41 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v41, OS_LOG_TYPE_DEFAULT))
      {
        v42 = HMFGetLogIdentifier();
        *buf = 138543362;
        v78 = v42;
        _os_log_impl(&dword_2531F8000, v41, OS_LOG_TYPE_DEFAULT, "%{public}@There is no meta data in the cloud, creating default and pushing to the cloud", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v39);
      [(HMDHomeManager *)v40 _pushMetadataToCloud];
    }

    v43 = objc_autoreleasePoolPush();
    v44 = v36;
    v45 = HMFGetOSLogHandle();
    v46 = os_log_type_enabled(v45, OS_LOG_TYPE_DEFAULT);
    if (a4)
    {
      if (v46)
      {
        v47 = HMFGetLogIdentifier();
        *buf = 138543362;
        v78 = v47;
        _os_log_impl(&dword_2531F8000, v45, OS_LOG_TYPE_DEFAULT, "%{public}@Set missing home data record = NO", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v43);
      [(HMDHomeManager *)v44 setMissingHomeDataRecord:0];
    }

    else
    {
      if (v46)
      {
        v48 = HMFGetLogIdentifier();
        *buf = 138543362;
        v78 = v48;
        _os_log_impl(&dword_2531F8000, v45, OS_LOG_TYPE_DEFAULT, "%{public}@No homeDataRecord found", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v43);
      v49 = objc_autoreleasePoolPush();
      v50 = v44;
      v51 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v51, OS_LOG_TYPE_DEFAULT))
      {
        v52 = HMFGetLogIdentifier();
        *buf = 138543362;
        v78 = v52;
        _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_DEFAULT, "%{public}@Set missing home data record = YES", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v49);
      [(HMDHomeManager *)v50 setMissingHomeDataRecord:1];
      v53 = [MEMORY[0x277CFEC78] systemStore];
      v75 = 0;
      v76 = 0;
      v54 = [v53 getAllAvailableControllerPublicKeys:0 secretKeys:0 userNames:&v76 error:&v75];
      v55 = v76;
      v56 = v75;

      if (v56)
      {
        v57 = 0;
      }

      else
      {
        v57 = v54;
      }

      if (v57 == 1 && v55 && [v55 count] >= 2)
      {
        v58 = objc_autoreleasePoolPush();
        v59 = v50;
        v60 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v60, OS_LOG_TYPE_DEFAULT))
        {
          v61 = HMFGetLogIdentifier();
          v62 = [v55 objectAtIndexedSubscript:0];
          *buf = 138543618;
          v78 = v61;
          v79 = 2112;
          v80 = v62;
          _os_log_impl(&dword_2531F8000, v60, OS_LOG_TYPE_DEFAULT, "%{public}@Found multiple controller keys, and we have no data in the cloud, using first entry as the controller username: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v58);
        v63 = [MEMORY[0x277CFEC78] systemStore];
        v64 = [v55 objectAtIndexedSubscript:0];
        [v63 updateActiveControllerPairingIdentifier:v64];
      }

      else
      {
        v65 = [v55 count] == 0;
        v66 = objc_autoreleasePoolPush();
        v67 = v50;
        v68 = HMFGetOSLogHandle();
        v69 = os_log_type_enabled(v68, OS_LOG_TYPE_DEFAULT);
        if (v65)
        {
          if (v69)
          {
            v71 = HMFGetLogIdentifier();
            *buf = 138543362;
            v78 = v71;
            _os_log_impl(&dword_2531F8000, v68, OS_LOG_TYPE_DEFAULT, "%{public}@No controller keys found can create one.", buf, 0xCu);
          }
        }

        else if (v69)
        {
          v70 = HMFGetLogIdentifier();
          *buf = 138543362;
          v78 = v70;
          _os_log_impl(&dword_2531F8000, v68, OS_LOG_TYPE_DEFAULT, "%{public}@Have exactly one controller key.", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v66);
      }
    }
  }

  if (v11)
  {
    v11[2](v11);
  }

  v72 = *MEMORY[0x277D85DE8];
}

void __111__HMDHomeManager__handleAccountStatusDeterminedWithError_homeDataRecordExists_metadataRecordExists_completion___block_invoke(uint64_t a1)
{
  v9 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_INFO))
  {
    v4 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v4;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_INFO, "%{public}@Re-querying account status", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  [WeakRetained _updateCloudDataSyncWithAccountState:{objc_msgSend(WeakRetained, "accountActive")}];

  v6 = *MEMORY[0x277D85DE8];
}

- (void)forcePushLocalDataToCloud:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __44__HMDHomeManager_forcePushLocalDataToCloud___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

void __44__HMDHomeManager_forcePushLocalDataToCloud___block_invoke(uint64_t a1)
{
  v21 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) homes];
  if ([v2 count])
  {

LABEL_4:
    v5 = objc_autoreleasePoolPush();
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v15 = 138543362;
      v16 = v7;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Force pushing local home data to cloud", &v15, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 32) setNeedToCleanUpKeys:1];
    [*(a1 + 32) setUploadHomeDataToCloud:1];
    [*(a1 + 32) _pushChangesToCloud:1 withDelay:0.0];
    goto LABEL_7;
  }

  v3 = [*(a1 + 32) incomingInvitations];
  v4 = [v3 count];

  if (v4)
  {
    goto LABEL_4;
  }

  v9 = objc_autoreleasePoolPush();
  v10 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
  {
    v11 = HMFGetLogIdentifier();
    v12 = [*(a1 + 32) homes];
    v13 = [v12 count];
    v14 = [*(a1 + 32) incomingInvitations];
    v15 = 138543874;
    v16 = v11;
    v17 = 2048;
    v18 = v13;
    v19 = 2048;
    v20 = [v14 count];
    _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@No homes %tu or incoming invitations %tu present, not force pushing to cloud", &v15, 0x20u);
  }

  objc_autoreleasePoolPop(v9);
LABEL_7:
  v8 = *MEMORY[0x277D85DE8];
}

- (BOOL)shouldClearDeviceSetupFollowUp
{
  v2 = [(HMDHomeManager *)self appleAccountManager];
  v3 = [v2 accountContext];
  v4 = v3 == 0;

  return v4;
}

- (void)postFinishSetupForCurrentAccessoryFollowUpIfNeeded
{
  v3 = [(HMDHomeManager *)self workQueue];
  dispatch_assert_queue_V2(v3);

  if (isAppleTV() && [(HMDHomeManager *)self shouldClearDeviceSetupFollowUp])
  {
    v5 = +[HMDDeviceSetupManager sharedManager];
    v4 = [v5 followUpManager];
    [v4 stopAdvertising:1];
  }
}

- (void)dataSyncInProgressUpdatedNotification:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __56__HMDHomeManager_dataSyncInProgressUpdatedNotification___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

- (void)_resetCloudOperationRetryCounters
{
  v9 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v7 = 138543362;
    v8 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Resetting cloud operation retry tracking counters", &v7, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  [(HMDHomeManager *)self setCloudOperationRetryCount:0];
  [(HMDHomeManager *)self _stopCloudOperationRetryTimer];
  v6 = *MEMORY[0x277D85DE8];
}

- (void)_stopCloudOperationRetryTimer
{
  v11 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self cloudOperationRetryTimer];

  if (v3)
  {
    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v9 = 138543362;
      v10 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Cancelling cloud operation retry timer", &v9, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
    v7 = [(HMDHomeManager *)self cloudOperationRetryTimer];
    dispatch_source_cancel(v7);

    [(HMDHomeManager *)self setCloudOperationRetryTimer:0];
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (void)_startCloudOperationRetryWithTimeout:(unint64_t)a3 completionHandler:(id)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v6 = a4;
  [(HMDHomeManager *)self _stopCloudOperationRetryTimer];
  v7 = [(HMDHomeManager *)self workQueue];
  v8 = dispatch_source_create(MEMORY[0x277D85D38], 0, 0, v7);
  [(HMDHomeManager *)self setCloudOperationRetryTimer:v8];

  v9 = [(HMDHomeManager *)self cloudOperationRetryTimer];
  v10 = dispatch_time(0, 1000000000 * a3);
  dispatch_source_set_timer(v9, v10, 0xFFFFFFFFFFFFFFFFLL, 0x2540BE400uLL);

  v11 = [(HMDHomeManager *)self cloudOperationRetryTimer];
  dispatch_source_set_event_handler(v11, v6);

  v12 = [(HMDHomeManager *)self cloudOperationRetryTimer];
  dispatch_resume(v12);

  v13 = objc_autoreleasePoolPush();
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    v17 = 138543618;
    v18 = v15;
    v19 = 2048;
    v20 = a3;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Starting cloud operation retry timer for %ld secs", &v17, 0x16u);
  }

  objc_autoreleasePoolPop(v13);
  v16 = *MEMORY[0x277D85DE8];
}

- (void)_runUploadHomeConfigToCloud:(id)a3 rowIDs:(id)a4 reasons:(id)a5 forcePush:(BOOL)a6 syncCompletion:(id)a7
{
  v94 = *MEMORY[0x277D85DE8];
  v68 = a3;
  v70 = a4;
  v11 = a5;
  v66 = a7;
  context = objc_autoreleasePoolPush();
  v12 = objc_autoreleasePoolPush();
  v13 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
  {
    v14 = HMFGetLogIdentifier();
    *buf = 138543618;
    v91 = v14;
    v92 = 2112;
    v93 = v11;
    _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEFAULT, "%{public}@Pushing changes up to the legacy cloud with reasons %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  v15 = [(HMDHomeManager *)self cloudDataSyncManager];
  v74 = [v15 cloudCache];

  v75 = [v74 legacyZone];
  v16 = [MEMORY[0x277CBEB18] arrayWithCapacity:{objc_msgSend(v11, "count")}];
  v85 = 0u;
  v86 = 0u;
  v83 = 0u;
  v84 = 0u;
  v17 = v11;
  v18 = [v17 countByEnumeratingWithState:&v83 objects:v89 count:16];
  if (v18)
  {
    v19 = *v84;
    do
    {
      for (i = 0; i != v18; ++i)
      {
        if (*v84 != v19)
        {
          objc_enumerationMutation(v17);
        }

        v21 = *(*(&v83 + 1) + 8 * i);
        if (([v21 isEqualToString:@"kHomeConfigurationVersionKey"] & 1) == 0)
        {
          v87 = @"HM.saveReasonKey";
          v88 = v21;
          v22 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v88 forKeys:&v87 count:1];
          [v16 addObject:v22];
        }
      }

      v18 = [v17 countByEnumeratingWithState:&v83 objects:v89 count:16];
    }

    while (v18);
  }

  objc_initWeak(&location, self);
  aBlock[0] = MEMORY[0x277D85DD0];
  aBlock[1] = 3221225472;
  aBlock[2] = __86__HMDHomeManager__runUploadHomeConfigToCloud_rowIDs_reasons_forcePush_syncCompletion___block_invoke;
  aBlock[3] = &unk_279732188;
  objc_copyWeak(&v80, &location);
  v23 = v68;
  v77 = v23;
  v81 = a6;
  v71 = v70;
  v78 = v71;
  v67 = v66;
  v79 = v67;
  v73 = _Block_copy(aBlock);
  if (-[HMDHomeManager uploadHomeDataToCloud](self, "uploadHomeDataToCloud") || [v71 count])
  {
    v69 = [(HMDHomeManager *)self pairedAccessories];
    v24 = [MEMORY[0x277CCAD78] UUID];
    [(HMDHomeManager *)self setDataTag:v24];

    v25 = objc_alloc_init(HMDMutableHomeData);
    v26 = [(HMDHomeManager *)self homes];
    [(HMDHomeData *)v25 setHomes:v26];

    [(HMDHomeData *)v25 setAccessories:v69];
    v27 = [(HMDHomeManager *)self primaryHomeUUID];
    [(HMDHomeData *)v25 setPrimaryHomeUUID:v27];

    v28 = [(HMDHomeManager *)self lastCurrentHomeUUID];
    [(HMDHomeData *)v25 setLastCurrentHomeUUID:v28];

    [(HMDHomeData *)v25 setDataVersion:4];
    [(HMDHomeData *)v25 setSchemaVersion:5];
    [(HMDHomeData *)v25 setRecoveryVersion:[(HMDHomeManager *)self recoveryVersion]];
    v29 = [(HMDHomeManager *)self dataTag];
    [(HMDHomeData *)v25 setDataTag:v29];

    v30 = [(HMDHomeManager *)self uuidsOfRemovedHomes];
    [(HMDHomeData *)v25 setUUIDsOfRemovedHomes:v30];

    v31 = [(HMDHomeManager *)self incomingInvitations];
    [(HMDHomeData *)v25 setIncomingInvitations:v31];

    v32 = [(HMDHomeManager *)self appleAccountManager];
    v33 = [v32 device];
    v34 = [v33 identifier];
    v35 = [v34 UUIDString];
    [(HMDHomeData *)v25 setCurrentDevice:v35];

    v36 = [v16 copy];
    [(HMDHomeData *)v25 setPendingReasonSaved:v36];

    v37 = [(HMDHomeManager *)self appData];
    [(HMDHomeData *)v25 setApplicationData:v37];

    [(HMDHomeData *)v25 setResidentEnabledState:[(HMDHomeManager *)self residentEnabledState]];
    [(HMDHomeData *)v25 setAccessAllowedWhenLocked:[(HMDHomeManager *)self isAccessAllowedWhenLocked]];
    v38 = [(HMDHomeManager *)self demoAccessories];
    [(HMDHomeData *)v25 setDemoAccessories:v38];

    [(HMDHomeData *)v25 setDemoFinalized:[(HMDHomeManager *)self demoFinalized]];
    v39 = [(HMDMutableHomeData *)v25 copy];
    v40 = [HMDPersistentStore serializeHomeData:v39 localStorage:0 remoteDeviceOnSameAccount:1];

    v41 = [v40 length];
    v42 = +[HMDHomeManager legacyDataSizeLimit];
    v64 = v41 > v42;
    if (v41 > v42)
    {
      v43 = objc_autoreleasePoolPush();
      v44 = self;
      v45 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v45, OS_LOG_TYPE_INFO))
      {
        v46 = HMFGetLogIdentifier();
        v47 = [v40 length];
        *buf = 138543618;
        v91 = v46;
        v92 = 2048;
        v93 = v47;
        _os_log_impl(&dword_2531F8000, v45, OS_LOG_TYPE_INFO, "%{public}@Home Data size if well beyond what can be pushed to legacy zone: %lu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v43);
    }

    else
    {
      v48 = [v75 homeDataModelWithPushDataPush:v40];
      [v23 addChangeWithObjectChange:v48];

      v49 = [v75 homeDataV3ModelWithPushDataPush:v40];
      [v23 addChangeWithObjectChange:v49];
    }
  }

  else
  {
    v64 = 0;
  }

  if ([(HMDHomeManager *)self uploadMetadataToCloud])
  {
    v50 = +[HMDHAPMetadata legacyV3DataForCloud];
    v51 = [v75 metadataModelWithPushDataPush:v50];
    [v23 addChangeWithObjectChange:v51];
  }

  v52 = [v23 hasValidChanges];
  v53 = objc_autoreleasePoolPush();
  v54 = self;
  if (v52)
  {
    v55 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v55, OS_LOG_TYPE_INFO))
    {
      v56 = HMFGetLogIdentifier();
      *buf = 138543362;
      v91 = v56;
      _os_log_impl(&dword_2531F8000, v55, OS_LOG_TYPE_INFO, "%{public}@Attempting to upload new data to legacy zone", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v53);
    v57 = [(HMDHomeManager *)v54 cloudDataSyncManager];
    [v57 uploadLegacyTransaction:v23 completionHandler:v73];

    goto LABEL_34;
  }

  if (v64)
  {
    v58 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v58, OS_LOG_TYPE_INFO))
    {
      v59 = HMFGetLogIdentifier();
      *buf = 138543362;
      v91 = v59;
      _os_log_impl(&dword_2531F8000, v58, OS_LOG_TYPE_INFO, "%{public}@Legacy data is too large to push to the cloud. Cleaning up local data as if legacy push was successful", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v53);
    v60 = v73;
LABEL_33:
    v60[2](v60, 0);
    goto LABEL_34;
  }

  v61 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v61, OS_LOG_TYPE_INFO))
  {
    v62 = HMFGetLogIdentifier();
    *buf = 138543362;
    v91 = v62;
    _os_log_impl(&dword_2531F8000, v61, OS_LOG_TYPE_INFO, "%{public}@Determined there is not data to push to legacy zone", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v53);
  [v23 setOsTransaction:0];
  v60 = v67;
  if (v67)
  {
    goto LABEL_33;
  }

LABEL_34:

  objc_destroyWeak(&v80);
  objc_destroyWeak(&location);

  objc_autoreleasePoolPop(context);
  v63 = *MEMORY[0x277D85DE8];
}

void __86__HMDHomeManager__runUploadHomeConfigToCloud_rowIDs_reasons_forcePush_syncCompletion___block_invoke(uint64_t a1, void *a2)
{
  v38 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [v3 hmd_conciseCKError];
      v10 = [v9 shortDescription];
      v34 = 138543618;
      v35 = v8;
      v36 = 2112;
      v37 = v10;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Uploaded data to legacy zone with error status: %@", &v34, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    if ([v6 backOffOperationInProgress])
    {
      [v6 setBackOffOperationInProgress:0];
      v11 = objc_autoreleasePoolPush();
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
      {
        v13 = HMFGetLogIdentifier();
        v34 = 138543362;
        v35 = v13;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Clearing that we were in a backoff operation", &v34, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
    }

    if (!v3)
    {
      [v6 _resetCloudOperationRetryCounters];
      [v6 setUploadToCloudIsPending:0];
      [v6 _updateHomeManagerModelChangesAsPushed:*(a1 + 40) legacyPush:1];
      if ([v6 uploadMetadataToCloud])
      {
        [v6 _pushMetadataChangesToUsers];
        [v6 setUploadMetadataToCloud:0];
      }

      [v6 setUploadHomeDataToCloud:0];
      if ([v6 needToCleanUpKeys])
      {
        v29 = objc_autoreleasePoolPush();
        v30 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v30, OS_LOG_TYPE_INFO))
        {
          v31 = HMFGetLogIdentifier();
          v34 = 138543362;
          v35 = v31;
          _os_log_impl(&dword_2531F8000, v30, OS_LOG_TYPE_INFO, "%{public}@Need to cleanup the keys in store", &v34, 0xCu);
        }

        objc_autoreleasePoolPop(v29);
        +[HMDPersistentStore cleanupKeysInStore];
      }

      goto LABEL_28;
    }

    [v6 setCloudOperationRetryCount:{objc_msgSend(v6, "cloudOperationRetryCount") + 1}];
    v14 = objc_autoreleasePoolPush();
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
    {
      v16 = HMFGetLogIdentifier();
      v17 = [v6 cloudOperationRetryCount];
      v34 = 138543618;
      v35 = v16;
      v36 = 2048;
      v37 = v17;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Pushing data to cloud failed, current cloud operation retry count: %ld", &v34, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    if (([*(a1 + 32) needConflictResolution] & 1) == 0)
    {
      v18 = objc_autoreleasePoolPush();
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        v34 = 138543362;
        v35 = v20;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Failure was not a result of a conflict, updating watches", &v34, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      [v6 _scheduleSendHomeDataToAllWatches];
    }

    v21 = [v3 domain];
    if ([v21 isEqualToString:*MEMORY[0x277CBBF50]])
    {
      v22 = [v3 userInfo];

      if (!v22)
      {
LABEL_28:
        [v6 setNeedToCleanUpKeys:0];
        goto LABEL_29;
      }

      v23 = [v3 userInfo];
      v21 = [v23 hmf_numberForKey:*MEMORY[0x277CBBF68]];

      if (v21)
      {
        v24 = objc_autoreleasePoolPush();
        v25 = v6;
        v26 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          v34 = 138543618;
          v35 = v27;
          v36 = 2112;
          v37 = v21;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Rescheduling legacy push delay %@", &v34, 0x16u);
        }

        objc_autoreleasePoolPop(v24);
        v28 = *(a1 + 64);
        [v21 doubleValue];
        [v25 _uploadHomeConfigToCloud:v28 withDelay:?];
      }
    }

    goto LABEL_28;
  }

LABEL_29:
  [*(a1 + 32) setOsTransaction:0];
  v32 = *(a1 + 48);
  if (v32)
  {
    (*(v32 + 16))(v32, v3);
  }

  v33 = *MEMORY[0x277D85DE8];
}

- (void)_runUploadHomeConfigToCloudForcePush:(BOOL)a3 reason:(id)a4 syncCompletion:(id)a5
{
  location[3] = *MEMORY[0x277D85DE8];
  v8 = a4;
  v9 = a5;
  if ([(HMDHomeManager *)self hasiCloudAndControllerKey])
  {
    v10 = [(HMDHomeManager *)self cloudDataSyncManager];
    v11 = [v10 cloudCache];

    v12 = [v11 legacyZone];
    v13 = [[HMDCloudTransaction alloc] initWithType:1 temporaryCache:0];
    [(HMDCloudTransaction *)v13 updateCloudZone:v12];
    v14 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-to-cloud"];
    [(HMDCloudTransaction *)v13 setOsTransaction:v14];

    objc_initWeak(location, self);
    v21[0] = MEMORY[0x277D85DD0];
    v21[1] = 3221225472;
    v21[2] = __77__HMDHomeManager__runUploadHomeConfigToCloudForcePush_reason_syncCompletion___block_invoke;
    v21[3] = &unk_279731C10;
    objc_copyWeak(&v25, location);
    v15 = v13;
    v22 = v15;
    v23 = v8;
    v24 = v9;
    v26 = a3;
    [(HMDHomeManager *)self _determineLegacyLocalChanges:v21];

    objc_destroyWeak(&v25);
    objc_destroyWeak(location);

LABEL_7:
    goto LABEL_8;
  }

  v16 = objc_autoreleasePoolPush();
  v17 = self;
  v18 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
  {
    v19 = HMFGetLogIdentifier();
    LODWORD(location[0]) = 138543362;
    *(location + 4) = v19;
    _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@Not pushing changes to the cloud.", location, 0xCu);
  }

  objc_autoreleasePoolPop(v16);
  if (v9)
  {
    v11 = [MEMORY[0x277CCA9B8] hmErrorWithCode:75 description:@"Operation was cancelled before it could run" reason:@"iCloud & Controller key was not available" suggestion:@"Make sure that you are signed into iCloud account"];
    (*(v9 + 2))(v9, v11);
    goto LABEL_7;
  }

LABEL_8:

  v20 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__runUploadHomeConfigToCloudForcePush_reason_syncCompletion___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v21 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if ([v7 count] || (objc_msgSend(WeakRetained, "uploadMetadataToCloud") & 1) != 0)
  {
    [WeakRetained _runUploadHomeConfigToCloud:*(a1 + 32) rowIDs:v7 reasons:v8 forcePush:*(a1 + 64) syncCompletion:*(a1 + 48)];
  }

  else
  {
    v12 = objc_autoreleasePoolPush();
    v13 = WeakRetained;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v19 = 138543362;
      v20 = v15;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Nothing to push to the legacy zone", &v19, 0xCu);
    }

    objc_autoreleasePoolPop(v12);
    [v13 setUploadHomeDataToCloud:0];
    [*(a1 + 32) setOsTransaction:0];
    if (*(a1 + 40))
    {
      v16 = [v13 logEventSubmitter];
      v17 = [HMDCloudSyncUploadReasonLogEvent uploadReason:*(a1 + 40) acceptedLegacyPush:0];
      [v16 submitLogEvent:v17];
    }

    v18 = *(a1 + 48);
    if (v18)
    {
      (*(v18 + 16))(v18, 0);
    }
  }

  v11 = *MEMORY[0x277D85DE8];
}

- (void)_uploadHomeConfigToCloud:(BOOL)a3 withDelay:(double)a4 reason:(id)a5
{
  v6 = a3;
  location[3] = *MEMORY[0x277D85DE8];
  v8 = a5;
  if ((disableLegacyCloudDataSync & 1) == 0)
  {
    if ([(HMDHomeManager *)self hasiCloudAndControllerKey])
    {
      objc_initWeak(location, self);
      aBlock[0] = MEMORY[0x277D85DD0];
      aBlock[1] = 3221225472;
      aBlock[2] = __60__HMDHomeManager__uploadHomeConfigToCloud_withDelay_reason___block_invoke;
      aBlock[3] = &unk_279731BE8;
      objc_copyWeak(&v19, location);
      v20 = v6;
      v18 = v8;
      v9 = _Block_copy(aBlock);
      if (v6)
      {
        [HMDSyncOperation cloudForcePushSyncOperationWithBlock:v9];
      }

      else
      {
        [HMDSyncOperation cloudPushSyncOperationWithBlock:v9];
      }
      v14 = ;
      v15 = [(HMDHomeManager *)self syncManager];
      [v15 addOperation:v14 withDelay:a4];

      objc_destroyWeak(&v19);
      objc_destroyWeak(location);
    }

    else
    {
      v10 = objc_autoreleasePoolPush();
      v11 = self;
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
      {
        v13 = HMFGetLogIdentifier();
        LODWORD(location[0]) = 138543362;
        *(location + 4) = v13;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Not pushing changes to the cloud since cannot push under current conditions.", location, 0xCu);
      }

      objc_autoreleasePoolPop(v10);
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __60__HMDHomeManager__uploadHomeConfigToCloud_withDelay_reason___block_invoke(uint64_t a1, void *a2, void *a3, int a4)
{
  v10 = a2;
  v7 = a3;
  if (a4)
  {
    if (!v10)
    {
      goto LABEL_7;
    }

    v8 = [MEMORY[0x277CCA9B8] hmErrorWithCode:23 description:@"Operation was cancelled before it could run" reason:@"HMDCloudManager cancelled the operation" suggestion:0];
    v10[2](v10, v8);
  }

  else
  {
    WeakRetained = objc_loadWeakRetained((a1 + 40));
    v8 = WeakRetained;
    if (WeakRetained)
    {
      [WeakRetained _runUploadHomeConfigToCloudForcePush:*(a1 + 48) reason:*(a1 + 32) syncCompletion:v10];
    }
  }

LABEL_7:
}

- (void)uploadHomeConfigToCloud:(BOOL)a3 withDelay:(double)a4
{
  objc_initWeak(&location, self);
  v7 = [(HMDHomeManager *)self workQueue];
  v8[0] = MEMORY[0x277D85DD0];
  v8[1] = 3221225472;
  v8[2] = __52__HMDHomeManager_uploadHomeConfigToCloud_withDelay___block_invoke;
  v8[3] = &unk_279731BC0;
  objc_copyWeak(v9, &location);
  v10 = a3;
  v9[1] = *&a4;
  dispatch_async(v7, v8);

  objc_destroyWeak(v9);
  objc_destroyWeak(&location);
}

void __52__HMDHomeManager_uploadHomeConfigToCloud_withDelay___block_invoke(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (WeakRetained)
  {
    v3 = WeakRetained;
    [WeakRetained _uploadHomeConfigToCloud:*(a1 + 48) withDelay:*(a1 + 40)];
    WeakRetained = v3;
  }
}

- (void)_removePendingDataSyncAcksForUser:(id)a3 forHome:(id)a4
{
  v32 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v7 UUIDString];
  v9 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v10 = [v9 objectForKeyedSubscript:v8];

  if (v10)
  {
    [v10 removeObject:v6];
    if (![v10 count])
    {
      v11 = shouldLogPrivateInformation();
      v12 = @"...";
      if (v11)
      {
        v12 = v6;
      }

      v13 = v12;
      v14 = objc_autoreleasePoolPush();
      v15 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
      {
        v16 = HMFGetLogIdentifier();
        v17 = [v7 UUIDString];
        v26 = 138543874;
        v27 = v16;
        v28 = 2112;
        v29 = v13;
        v30 = 2112;
        v31 = v17;
        _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Removing pending data sync ack for user %@ for data corresponding to home %@", &v26, 0x20u);
      }

      objc_autoreleasePoolPop(v14);
      v18 = [(HMDHomeManager *)self pendingDataSyncAcks];
      [v18 removeObjectForKey:v8];
    }
  }

  v19 = objc_autoreleasePoolPush();
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    v22 = [(HMDHomeManager *)self pendingDataSyncAcks];
    v26 = 138543618;
    v27 = v21;
    v28 = 2112;
    v29 = v22;
    _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@Remaining pending data sync acks %@", &v26, 0x16u);
  }

  objc_autoreleasePoolPop(v19);
  v23 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v24 = [HMDPersistentStore archiveIDSDataSyncJournal:v23];

  v25 = *MEMORY[0x277D85DE8];
}

- (void)_addPendingDataSyncAcksForUser:(id)a3 forHome:(id)a4
{
  v28 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = shouldLogPrivateInformation();
  v9 = @"...";
  if (v8)
  {
    v9 = v6;
  }

  v10 = v9;
  v11 = objc_autoreleasePoolPush();
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [v7 UUIDString];
    v22 = 138543874;
    v23 = v13;
    v24 = 2112;
    v25 = v10;
    v26 = 2112;
    v27 = v14;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Adding pending data sync ack for user %@ for data corresponding to home %@", &v22, 0x20u);
  }

  objc_autoreleasePoolPop(v11);
  v15 = [v7 UUIDString];
  v16 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v17 = [v16 objectForKeyedSubscript:v15];

  if (!v17)
  {
    v17 = [MEMORY[0x277CBEB58] set];
    v18 = [(HMDHomeManager *)self pendingDataSyncAcks];
    [v18 setObject:v17 forKeyedSubscript:v15];
  }

  [v17 addObject:v6];
  v19 = [(HMDHomeManager *)self pendingDataSyncAcks];
  v20 = [HMDPersistentStore archiveIDSDataSyncJournal:v19];

  v21 = *MEMORY[0x277D85DE8];
}

- (void)pushMetadataToAllWatches
{
  v18 = *MEMORY[0x277D85DE8];
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v3 = [(HMDHomeManager *)self associatedWatchPeers];
  v4 = [v3 countByEnumeratingWithState:&v13 objects:v17 count:16];
  if (v4)
  {
    v5 = v4;
    v6 = *v14;
    do
    {
      v7 = 0;
      do
      {
        if (*v14 != v6)
        {
          objc_enumerationMutation(v3);
        }

        v8 = *(*(&v13 + 1) + 8 * v7);
        v9 = [(HMDHomeManager *)self associatedWatchPeers];
        v10 = [v9 objectForKey:v8];
        v11 = [v10 metadataConfig];
        [(HMDHomeManager *)self checkAndPushMetadataToUser:v8 destination:v8 userInfo:v11];

        ++v7;
      }

      while (v5 != v7);
      v5 = [v3 countByEnumeratingWithState:&v13 objects:v17 count:16];
    }

    while (v5);
  }

  v12 = *MEMORY[0x277D85DE8];
}

- (void)_pushMetadataChangesToUsers
{
  v72[1] = *MEMORY[0x277D85DE8];
  if (isWatch())
  {
    v3 = objc_autoreleasePoolPush();
    v4 = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v57 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Cannot push metadata changes from watch or simulator to other users.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
  }

  else
  {
    v41 = +[HMDHAPMetadata getSharedInstance];
    if (v41)
    {
      v40 = [(HMDHomeManager *)self _getListOfUsersToPushMetadataChangesTo];
      if ([v40 count] || (-[HMDHomeManager associatedWatchPeers](self, "associatedWatchPeers"), v7 = objc_claimAutoreleasedReturnValue(), v8 = objc_msgSend(v7, "count"), v7, v8))
      {
        v71 = @"kRequestedCapabilitiesKey";
        v69[0] = @"kMetadataInfoVersionKey";
        v9 = [v41 version];
        v70[0] = v9;
        v69[1] = @"kMetadataInfoSchemaVersionKey";
        v10 = [v41 schemaVersion];
        v70[1] = v10;
        v69[2] = @"kMetadataInfoCompletenessKey";
        v11 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v41, "incomplete") ^ 1}];
        v70[2] = v11;
        v69[3] = @"kHomedVersionKey";
        v12 = homedVersion;
        v70[3] = v12;
        v13 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v70 forKeys:v69 count:4];
        v72[0] = v13;
        v43 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v72 forKeys:&v71 count:1];

        v65 = @"kDeviceClassTypeKey";
        v66 = @"kDeviceClassTypeTransient";
        v67[0] = @"kRequiredCapabilitiesKey";
        v14 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v66 forKeys:&v65 count:1];
        v67[1] = @"kRequestedCapabilitiesKey";
        v68[0] = v14;
        v63[0] = @"kMetadataInfoVersionKey";
        v15 = [v41 version];
        v64[0] = v15;
        v63[1] = @"kMetadataInfoSchemaVersionKey";
        v16 = [v41 schemaVersion];
        v64[1] = v16;
        v63[2] = @"kMetadataInfoCompletenessKey";
        v17 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v41, "incomplete") ^ 1}];
        v64[2] = v17;
        v63[3] = @"kHomedVersionKey";
        v18 = homedVersion;
        v64[3] = v18;
        v19 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v64 forKeys:v63 count:4];
        v68[1] = v19;
        v42 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v68 forKeys:v67 count:2];

        objc_initWeak(&location, self);
        v53 = 0u;
        v54 = 0u;
        v51 = 0u;
        v52 = 0u;
        v20 = v40;
        v21 = [v20 countByEnumeratingWithState:&v51 objects:v62 count:16];
        if (v21)
        {
          v44 = *v52;
          do
          {
            v45 = v21;
            for (i = 0; i != v45; ++i)
            {
              if (*v52 != v44)
              {
                objc_enumerationMutation(v20);
              }

              v23 = *(*(&v51 + 1) + 8 * i);
              if ([v20 hmf_BOOLForKey:v23])
              {
                v24 = v23;
                v25 = v43;
              }

              else
              {
                v24 = 0;
                v25 = v42;
              }

              v26 = v25;
              v27 = objc_autoreleasePoolPush();
              v28 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
              {
                v29 = HMFGetLogIdentifier();
                *buf = 138543874;
                v57 = v29;
                v58 = 2112;
                v59 = v23;
                v60 = 2112;
                v61 = v24;
                _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@Preparing for metadata push to user: %@ with destination: %@", buf, 0x20u);
              }

              objc_autoreleasePoolPop(v27);
              v30 = [(HMDHomeManager *)self workQueue];
              v46[0] = MEMORY[0x277D85DD0];
              v46[1] = 3221225472;
              v46[2] = __45__HMDHomeManager__pushMetadataChangesToUsers__block_invoke;
              v46[3] = &unk_279731B98;
              objc_copyWeak(&v50, &location);
              v31 = v20;
              v47 = v31;
              v48 = v23;
              v49 = self;
              [(HMDHomeManager *)self electDeviceForUser:v23 destination:v24 deviceCapabilities:v26 queue:v30 completionHandler:v46];

              objc_destroyWeak(&v50);
            }

            v21 = [v31 countByEnumeratingWithState:&v51 objects:v62 count:16];
          }

          while (v21);
        }

        objc_destroyWeak(&location);
      }

      else
      {
        v36 = objc_autoreleasePoolPush();
        v37 = self;
        v38 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v38, OS_LOG_TYPE_INFO))
        {
          v39 = HMFGetLogIdentifier();
          *buf = 138543362;
          v57 = v39;
          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_INFO, "%{public}@Not pushing metadata changes to anybody as either there are no users or there are no associated watches with this account.", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v36);
      }
    }

    else
    {
      v32 = objc_autoreleasePoolPush();
      v33 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
      {
        v34 = HMFGetLogIdentifier();
        *buf = 138543362;
        v57 = v34;
        _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_ERROR, "%{public}@No metadata to push changes to shared users.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
    }
  }

  v35 = *MEMORY[0x277D85DE8];
}

void __45__HMDHomeManager__pushMetadataChangesToUsers__block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v26 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v11 = WeakRetained;
  if (!v7 && WeakRetained && [*(a1 + 32) hmf_BOOLForKey:*(a1 + 40)])
  {
    v12 = objc_autoreleasePoolPush();
    v13 = *(a1 + 48);
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = *(a1 + 40);
      v22 = 138543618;
      v23 = v15;
      v24 = 2112;
      v25 = v16;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Pushing metadata changes to shared user: %@", &v22, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v19 = a1 + 40;
    v17 = *(a1 + 40);
    v18 = *(v19 + 8);
    v20 = [v8 destination];
    [v18 checkAndPushMetadataToUser:v17 destination:v20 userInfo:v9];
  }

  v21 = *MEMORY[0x277D85DE8];
}

- (id)_getListOfUsersToPushMetadataChangesTo
{
  v45 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CFEC78] systemStore];
  v41 = 0;
  v42 = 0;
  [v3 getControllerPublicKey:0 secretKey:0 username:&v42 allowCreation:0 error:&v41];
  v4 = v42;
  v27 = v41;

  v5 = [MEMORY[0x277CBEB38] dictionary];
  v37 = 0u;
  v38 = 0u;
  v39 = 0u;
  v40 = 0u;
  obj = [(HMDHomeManager *)self homes];
  v6 = [obj countByEnumeratingWithState:&v37 objects:v44 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v38;
    v9 = MEMORY[0x277CBEC38];
    v28 = *v38;
    v29 = v4;
    do
    {
      v10 = 0;
      v30 = v7;
      do
      {
        if (*v38 != v8)
        {
          objc_enumerationMutation(obj);
        }

        v11 = *(*(&v37 + 1) + 8 * v10);
        v12 = [v11 ownerName];
        v13 = [v12 isEqualToString:v4];

        if (v13)
        {
          v32 = v10;
          v35 = 0u;
          v36 = 0u;
          v33 = 0u;
          v34 = 0u;
          v14 = [v11 users];
          v15 = [v14 countByEnumeratingWithState:&v33 objects:v43 count:16];
          if (v15)
          {
            v16 = v15;
            v17 = *v34;
            do
            {
              for (i = 0; i != v16; ++i)
              {
                if (*v34 != v17)
                {
                  objc_enumerationMutation(v14);
                }

                v19 = *(*(&v33 + 1) + 8 * i);
                v20 = [v19 userID];

                if (v20)
                {
                  v21 = v9;
                  if (([v19 isRemoteGateway] & 1) != 0 || (objc_msgSend(v11, "currentUser"), v22 = objc_claimAutoreleasedReturnValue(), v23 = objc_msgSend(v19, "isEqual:", v22), v22, v21 = MEMORY[0x277CBEC28], (v23 & 1) == 0))
                  {
                    v24 = [v19 userID];
                    [v5 setObject:v21 forKeyedSubscript:v24];
                  }
                }
              }

              v16 = [v14 countByEnumeratingWithState:&v33 objects:v43 count:16];
            }

            while (v16);
          }

          v8 = v28;
          v4 = v29;
          v7 = v30;
          v10 = v32;
        }

        ++v10;
      }

      while (v10 != v7);
      v7 = [obj countByEnumeratingWithState:&v37 objects:v44 count:16];
    }

    while (v7);
  }

  v25 = *MEMORY[0x277D85DE8];

  return v5;
}

- (void)checkAndPushMetadataToUser:(id)a3 destination:(id)a4 userInfo:(id)a5
{
  v97[1] = *MEMORY[0x277D85DE8];
  v8 = a3;
  v9 = a4;
  v10 = a5;
  if (!isWatch())
  {
    v11 = +[HMDHAPMetadata getSharedInstance];
    v63 = [v10 hmf_numberForKey:@"kMetadataInfoVersionKey"];
    v64 = [v10 hmf_numberForKey:@"kMetadataInfoSchemaVersionKey"];
    if (v11 && v64 && v63)
    {
      v12 = [v11 schemaVersion];
      if ([v12 isEqualToNumber:v64])
      {
        v13 = [v11 version];
        v14 = [v13 unsignedIntegerValue];
        v15 = v14 > [v63 unsignedIntegerValue];
      }

      else
      {
        v15 = 0;
      }

      v16 = [v10 hmf_numberForKey:@"kMetadataInfoCompletenessKey"];
      v17 = v16;
      if (v16)
      {
        v18 = [v16 BOOLValue];
        if (([v11 incomplete] & 1) == 0 && (v18 & 1) == 0)
        {
          v19 = [v11 schemaVersion];
          if ([v19 isEqualToNumber:v64])
          {
            v20 = [v11 version];
            v61 = [v20 unsignedIntegerValue];
            v21 = v11;
            v22 = v8;
            v23 = v9;
            v24 = [v63 unsignedIntegerValue];

            v25 = v61 == v24;
            v9 = v23;
            v8 = v22;
            v11 = v21;
            if (v25)
            {
              v26 = objc_autoreleasePoolPush();
              v27 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
              {
                v28 = HMFGetLogIdentifier();
                *buf = 138543362;
                v79 = v28;
                _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@Remote metadata is incomplete, local metadata is complete - sending...", buf, 0xCu);
              }

              objc_autoreleasePoolPop(v26);
              goto LABEL_20;
            }
          }

          else
          {
          }
        }
      }

      else
      {
        [v11 incomplete];
      }

      if (v15)
      {
LABEL_20:
        v29 = objc_autoreleasePoolPush();
        v30 = self;
        v31 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v31, OS_LOG_TYPE_DEFAULT))
        {
          v32 = HMFGetLogIdentifier();
          *buf = 138543362;
          v79 = v32;
          _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_DEFAULT, "%{public}@Push metadata changes to the user", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v29);
        context = objc_autoreleasePoolPush();
        v72 = 0;
        v73 = &v72;
        v74 = 0x3032000000;
        v75 = __Block_byref_object_copy__172847;
        v76 = __Block_byref_object_dispose__172848;
        v77 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-metadata"];
        v60 = [v10 hmf_numberForKey:@"kHomedVersionKey"];
        v33 = [HMDHAPMetadata isHomedVersionSupported:?];
        v34 = objc_autoreleasePoolPush();
        if (v33)
        {
          v35 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v35, OS_LOG_TYPE_INFO))
          {
            v36 = HMFGetLogIdentifier();
            *buf = 138543874;
            v79 = v36;
            v80 = 2112;
            v81 = v8;
            v82 = 2112;
            v83 = v60;
            _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_INFO, "%{public}@Push metadata dictionary to user %@ as its version %@ is supported.", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v34);
          v37 = MEMORY[0x277CCAAB0];
          v38 = +[HMDPersistentStore loadPlainMetadataDictionary];
          v39 = [v37 archivedDataWithRootObject:v38 requiringSecureCoding:1 error:0];

          v62 = [v39 hmd_compressedData];

          v40 = +[HMDHAPMetadataModel metadataModelObjectUUID];
          v41 = [v40 UUIDString];
          v69[0] = MEMORY[0x277D85DD0];
          v69[1] = 3221225472;
          v69[2] = __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke;
          v69[3] = &unk_279731B48;
          v70 = v8;
          v71 = &v72;
          [(HMDHomeManager *)v30 sendFragmentedMessageForData:v62 objectUUID:v41 withMessageName:@"kMetadataDataSyncRequestKey" toUser:v70 destination:v9 completionHandler:v69];

          v42 = v70;
        }

        else
        {
          v43 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
          {
            v44 = HMFGetLogIdentifier();
            *buf = 138543874;
            v79 = v44;
            v80 = 2112;
            v81 = v8;
            v82 = 2112;
            v83 = v60;
            _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@Sending old metadata data to %@ as it is a legacy device %@.", buf, 0x20u);
          }

          objc_autoreleasePoolPop(v34);
          v62 = +[HMDHAPMetadata legacyV3DataForIDS];
          v45 = MEMORY[0x277D0F818];
          v96 = @"kHAPMetadataDataKey";
          v97[0] = v62;
          v46 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v97 forKeys:&v96 count:1];
          v42 = [v45 internalMessageWithName:@"kMetadataDataSyncRequestKey" messagePayload:v46];

          objc_initWeak(buf, v30);
          v47 = [(HMDHomeManager *)v30 messageDispatcher];
          v48 = [(HMDHomeManager *)v30 uuid];
          v49 = [(HMDHomeManager *)v30 workQueue];
          v65[0] = MEMORY[0x277D85DD0];
          v65[1] = 3221225472;
          v65[2] = __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke_780;
          v65[3] = &unk_279731B70;
          objc_copyWeak(&v68, buf);
          v66 = v8;
          v67 = &v72;
          [v47 sendSecureMessage:v42 target:v48 userID:v66 destination:v9 responseQueue:v49 responseHandler:v65];

          objc_destroyWeak(&v68);
          objc_destroyWeak(buf);
        }

        v50 = objc_autoreleasePoolPush();
        v51 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v51, OS_LOG_TYPE_INFO))
        {
          v52 = HMFGetLogIdentifier();
          v53 = [v62 length];
          v54 = [v11 schemaVersion];
          v55 = [v11 version];
          v56 = v73[5];
          *buf = 138545410;
          v79 = v52;
          v80 = 2048;
          v81 = v53;
          v82 = 2112;
          v83 = v8;
          v84 = 2112;
          v85 = v9;
          v86 = 2112;
          v87 = v54;
          v88 = 2112;
          v89 = v55;
          v90 = 2112;
          v91 = v64;
          v92 = 2112;
          v93 = v63;
          v94 = 2112;
          v95 = v56;
          _os_log_impl(&dword_2531F8000, v51, OS_LOG_TYPE_INFO, "%{public}@Pushing metadata(%lu bytes) change to user %@ (%@) - local %@/%@  remote %@/%@ - creating transaction %@", buf, 0x5Cu);
        }

        objc_autoreleasePoolPop(v50);
        _Block_object_dispose(&v72, 8);

        objc_autoreleasePoolPop(contexta);
      }
    }
  }

  v57 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v18 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if ([v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
  {
    v7 = objc_autoreleasePoolPush();
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v10 = *(a1 + 32);
      v14 = 138543618;
      v15 = v9;
      v16 = 2112;
      v17 = v10;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Received sync from user %@ for metadata update", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
  }

  v11 = *(*(a1 + 40) + 8);
  v12 = *(v11 + 40);
  *(v11 + 40) = 0;

  v13 = *MEMORY[0x277D85DE8];
}

void __66__HMDHomeManager_checkAndPushMetadataToUser_destination_userInfo___block_invoke_780(uint64_t a1, void *a2, void *a3)
{
  v19 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained && [v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
  {
    v8 = objc_autoreleasePoolPush();
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = *(a1 + 32);
      v15 = 138543618;
      v16 = v10;
      v17 = 2112;
      v18 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Received sync from user %@ for metadata update", &v15, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = *(*(a1 + 40) + 8);
  v13 = *(v12 + 40);
  *(v12 + 40) = 0;

  v14 = *MEMORY[0x277D85DE8];
}

- (void)_archiveSyncDataForHome:(id)a3 toUser:(id)a4
{
  v11 = a3;
  v6 = a4;
  if (!isWatch())
  {
    v7 = -[HMDHomeManager generatePayloadFromHome:forAdmin:user:supportedFeatures:](self, "generatePayloadFromHome:forAdmin:user:supportedFeatures:", v11, [v6 isAdministrator], v6, &unk_2866272F8);
    v8 = [v7 objectForKey:@"kHomeDataKey"];
    v9 = v8;
    if (v8)
    {
      v10 = [v8 hmd_compressedData];
      [v6 saveSyncDataToLocalDisk:v10];
    }
  }
}

- (void)_archiveSyncDataForHome:(id)a3
{
  v30 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v7 = [v3 name];
    *buf = 138543618;
    v27 = v6;
    v28 = 2112;
    v29 = v7;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Archiving home [%@] for all users", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  v23 = 0u;
  v24 = 0u;
  v21 = 0u;
  v22 = 0u;
  v8 = [v3 users];
  v9 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
  if (v9)
  {
    v10 = v9;
    v11 = *v22;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v22 != v11)
        {
          objc_enumerationMutation(v8);
        }

        v13 = *(*(&v21 + 1) + 8 * i);
        v14 = [v13 userID];

        if (v14)
        {
          if (([v13 isRemoteGateway] & 1) == 0)
          {
            v15 = [v13 uuid];
            v16 = [v3 currentUser];
            v17 = [v16 uuid];
            v18 = [v15 isEqual:v17];

            if ((v18 & 1) == 0)
            {
              [(HMDHomeManager *)self _archiveSyncDataForHome:v3 toUser:v13];
            }
          }
        }
      }

      v10 = [v8 countByEnumeratingWithState:&v21 objects:v25 count:16];
    }

    while (v10);
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_pushChangesForHome:(id)a3 toRegularUsersOfHome:(id)a4 adminUsersOfHome:(id)a5
{
  v77 = *MEMORY[0x277D85DE8];
  v46 = a3;
  v40 = a4;
  v47 = a5;
  if (!isWatch() && ([v40 count] || objc_msgSend(v47, "count")))
  {
    context = objc_autoreleasePoolPush();
    v62[0] = 0;
    v62[1] = v62;
    v62[2] = 0x3032000000;
    v62[3] = __Block_byref_object_copy__172847;
    v62[4] = __Block_byref_object_dispose__172848;
    v63 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-home-to-users"];
    v39 = +[HMDHAPMetadata getSharedInstance];
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    if (v39)
    {
      HMFGetOSLogHandle();
      v10 = v45 = v9;
      if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
      {
        v11 = HMFGetLogIdentifier();
        *buf = 138543874;
        v72 = v11;
        v73 = 2112;
        v74 = v47;
        v75 = 2112;
        v76 = v40;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Pushing home changes to admins: %@ and regular users: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v8);
      v67 = @"kDeviceClassTypeKey";
      v68 = @"kDeviceClassTypeTransient";
      v69[0] = @"kRequiredCapabilitiesKey";
      v12 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v68 forKeys:&v67 count:1];
      v69[1] = @"kRequestedCapabilitiesKey";
      v70[0] = v12;
      v65[0] = @"kHomedVersionKey";
      v13 = homedVersion;
      v66[0] = v13;
      v66[1] = &unk_2866272E0;
      v14 = *MEMORY[0x277CD0640];
      v65[1] = @"kHomedSupportedFeaturesKey";
      v65[2] = v14;
      v15 = [v46 uuid];
      v16 = [v15 UUIDString];
      v66[2] = v16;
      v65[3] = @"kHomeConfigurationVersionKey";
      v17 = [MEMORY[0x277CCABB0] numberWithInteger:{objc_msgSend(v46, "configurationVersion")}];
      v66[3] = v17;
      v65[4] = @"kMetadataInfoVersionKey";
      v18 = [v39 version];
      v66[4] = v18;
      v65[5] = @"kMetadataInfoSchemaVersionKey";
      v19 = [v39 schemaVersion];
      v66[5] = v19;
      v65[6] = @"kMetadataInfoCompletenessKey";
      v20 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v39, "incomplete") ^ 1}];
      v66[6] = v20;
      v21 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v66 forKeys:v65 count:7];
      v70[1] = v21;
      v43 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v70 forKeys:v69 count:2];

      v22 = dispatch_group_create();
      v23 = [v40 arrayByAddingObjectsFromArray:v47];
      v44 = [(HMDHomeManager *)v45 _getListOfUsersToPushMetadataChangesTo];
      objc_initWeak(&location, v45);
      v59 = 0u;
      v60 = 0u;
      v57 = 0u;
      v58 = 0u;
      obj = v23;
      v24 = [obj countByEnumeratingWithState:&v57 objects:v64 count:16];
      if (v24)
      {
        v42 = *v58;
        do
        {
          for (i = 0; i != v24; ++i)
          {
            if (*v58 != v42)
            {
              objc_enumerationMutation(obj);
            }

            v26 = *(*(&v57 + 1) + 8 * i);
            v27 = objc_autoreleasePoolPush();
            v28 = v45;
            v29 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v29, OS_LOG_TYPE_INFO))
            {
              v30 = HMFGetLogIdentifier();
              *buf = 138543618;
              v72 = v30;
              v73 = 2112;
              v74 = v26;
              _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_INFO, "%{public}@Pushing home changes to shared user: %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v27);
            dispatch_group_enter(v22);
            v31 = [v26 pushDestination];
            v32 = [v26 destination];
            v33 = [(HMDHomeManager *)v28 workQueue];
            v49[0] = MEMORY[0x277D85DD0];
            v49[1] = 3221225472;
            v49[2] = __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke;
            v49[3] = &unk_279731B20;
            v50 = v44;
            v51 = v26;
            v52 = v28;
            v53 = v46;
            v54 = v47;
            v55 = v22;
            objc_copyWeak(&v56, &location);
            [(HMDHomeManager *)v28 electDeviceForUser:v31 destination:v32 deviceCapabilities:v43 queue:v33 completionHandler:v49];

            objc_destroyWeak(&v56);
          }

          v24 = [obj countByEnumeratingWithState:&v57 objects:v64 count:16];
        }

        while (v24);
      }

      v34 = [(HMDHomeManager *)v45 workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_770;
      block[3] = &unk_279734898;
      block[4] = v45;
      block[5] = v62;
      dispatch_group_notify(v22, v34, block);

      objc_destroyWeak(&location);
    }

    else
    {
      v35 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v35, OS_LOG_TYPE_ERROR))
      {
        v36 = HMFGetLogIdentifier();
        *buf = 138543362;
        v72 = v36;
        _os_log_impl(&dword_2531F8000, v35, OS_LOG_TYPE_ERROR, "%{public}@No metadata to push changes for home", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v8);
    }

    _Block_object_dispose(v62, 8);
    objc_autoreleasePoolPop(context);
  }

  v37 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v98 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v77 = a3;
  v78 = a4;
  if (v7)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 48);
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_ERROR))
    {
      v11 = HMFGetLogIdentifier();
      v12 = *(a1 + 40);
      *buf = 138543618;
      v91 = v11;
      v92 = 2112;
      v93 = v12;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_ERROR, "%{public}@Failed to elect a device to push home change: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
    dispatch_group_leave(*(a1 + 72));
    goto LABEL_38;
  }

  v13 = *(a1 + 32);
  v14 = [*(a1 + 40) pushDestination];
  LODWORD(v13) = [v13 hmf_BOOLForKey:v14];

  if (v13)
  {
    v15 = objc_autoreleasePoolPush();
    v16 = *(a1 + 48);
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      v19 = *(a1 + 40);
      *buf = 138543618;
      v91 = v18;
      v92 = 2112;
      v93 = v19;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Pushing metadata changes to shared user: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v15);
    v20 = *(a1 + 48);
    v21 = [*(a1 + 40) pushDestination];
    v22 = [v77 destination];
    [v20 checkAndPushMetadataToUser:v21 destination:v22 userInfo:v78];
  }

  v76 = [v78 objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];
  v23 = objc_autoreleasePoolPush();
  v24 = *(a1 + 48);
  v25 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v25, OS_LOG_TYPE_INFO))
  {
    v26 = HMFGetLogIdentifier();
    v27 = [*(a1 + 56) configurationVersion];
    v28 = *(a1 + 40);
    *buf = 138544130;
    v91 = v26;
    v92 = 2048;
    v93 = v27;
    v94 = 2112;
    v95 = v76;
    v96 = 2112;
    v97 = v28;
    _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_INFO, "%{public}@Current home configuration version: %ld user home configuration version: %@ user: %@", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v23);
  if (v76)
  {
    if (([*(a1 + 40) ignoreConfigCompare] & 1) == 0)
    {
      v29 = [v76 integerValue];
      if (v29 == [*(a1 + 56) configurationVersion])
      {
        v30 = objc_autoreleasePoolPush();
        v31 = *(a1 + 48);
        v32 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
        {
          v33 = HMFGetLogIdentifier();
          *buf = 138543362;
          v91 = v33;
          _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@Skipping home changes push to shared users as the local and remote versions are the same", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v30);
        dispatch_group_leave(*(a1 + 72));
LABEL_34:

        goto LABEL_38;
      }
    }
  }

  v34 = [*(a1 + 40) destination];
  if (v34)
  {
    [v77 destination];
  }

  else
  {
    [*(a1 + 40) username];
  }
  v75 = ;

  v35 = *(a1 + 48);
  v36 = [*(a1 + 56) uuid];
  [v35 _addPendingDataSyncAcksForUser:v75 forHome:v36];

  v37 = [v78 hmf_arrayForKey:@"kHomedSupportedFeaturesKey"];
  v38 = v37;
  if (v37)
  {
    v39 = [v37 containsObject:&unk_28662A268];
  }

  else
  {
    v39 = 0;
  }

  v40 = [*(a1 + 64) containsObject:*(a1 + 40)];
  v41 = *(a1 + 48);
  v42 = *(a1 + 56);
  v43 = [*(a1 + 40) user];
  v44 = [v41 generatePayloadFromHome:v42 forAdmin:v40 user:v43 supportedFeatures:v38];

  v45 = [*(a1 + 48) _compressHomeData:v44];
  v46 = v45;
  if (v39)
  {
    v47 = v45;
  }

  else
  {
    v47 = v44;
  }

  v74 = v47;

  if (v74)
  {
    v73 = [MEMORY[0x277D0F818] internalMessageWithName:@"kHomeDataSyncRequestKey" messagePayload:?];
    v48 = objc_autoreleasePoolPush();
    v49 = *(a1 + 48);
    v50 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v50, OS_LOG_TYPE_INFO))
    {
      v51 = HMFGetLogIdentifier();
      v52 = [v73 dataForKey:@"kHomeDataKey"];
      v53 = [v52 length];
      v54 = *(a1 + 40);
      *buf = 138543874;
      v91 = v51;
      v92 = 2048;
      v93 = v53;
      v94 = 2112;
      v95 = v54;
      _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_INFO, "%{public}@Pushing home changes (%ld bytes) to shared user: %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v48);
    if (v38 && [v38 containsObject:&unk_28662A280])
    {
      objc_initWeak(buf, *(a1 + 48));
      v72 = *(a1 + 48);
      v55 = [v73 dataForKey:@"kHomeDataKey"];
      v56 = [*(a1 + 56) uuid];
      v57 = [v56 UUIDString];
      v58 = [v73 name];
      v59 = [*(a1 + 40) pushDestination];
      v60 = [v77 destination];
      v85[0] = MEMORY[0x277D85DD0];
      v85[1] = 3221225472;
      v85[2] = __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_768;
      v85[3] = &unk_279731A58;
      objc_copyWeak(&v89, buf);
      v85[4] = *(a1 + 40);
      v86 = *(a1 + 56);
      v87 = v75;
      v88 = *(a1 + 72);
      [v72 sendFragmentedMessageForData:v55 objectUUID:v57 withMessageName:v58 toUser:v59 destination:v60 completionHandler:v85];

      objc_destroyWeak(&v89);
      objc_destroyWeak(buf);
    }

    else
    {
      v61 = [*(a1 + 48) messageDispatcher];
      v62 = [*(a1 + 48) uuid];
      v63 = [*(a1 + 40) pushDestination];
      v64 = [v77 destination];
      v65 = [*(a1 + 48) workQueue];
      v79[0] = MEMORY[0x277D85DD0];
      v79[1] = 3221225472;
      v79[2] = __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_769;
      v79[3] = &unk_279731A80;
      objc_copyWeak(&v84, (a1 + 80));
      v80 = vextq_s8(*(a1 + 40), *(a1 + 40), 8uLL);
      v81 = *(a1 + 56);
      v82 = v75;
      v83 = *(a1 + 72);
      [v61 sendSecureMessage:v73 target:v62 userID:v63 destination:v64 responseQueue:v65 responseHandler:v79];

      objc_destroyWeak(&v84);
    }

    goto LABEL_34;
  }

  v66 = objc_autoreleasePoolPush();
  v67 = *(a1 + 48);
  v68 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v68, OS_LOG_TYPE_INFO))
  {
    v69 = HMFGetLogIdentifier();
    v70 = *(a1 + 40);
    *buf = 138543618;
    v91 = v69;
    v92 = 2112;
    v93 = v70;
    _os_log_impl(&dword_2531F8000, v68, OS_LOG_TYPE_INFO, "%{public}@Failed to get home data payload for user: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v66);
  dispatch_group_leave(*(a1 + 72));

LABEL_38:
  v71 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_770(uint64_t a1)
{
  v11 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEBUG))
  {
    v5 = HMFGetLogIdentifier();
    v9 = 138543362;
    v10 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEBUG, "%{public}@Finished pushing home changes to users", &v9, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = *(*(a1 + 40) + 8);
  v7 = *(v6 + 40);
  *(v6 + 40) = 0;

  v8 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_768(uint64_t a1, void *a2, void *a3)
{
  v47 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if (v5)
    {
      v8 = [v5 domain];
      if ([v8 isEqualToString:*MEMORY[0x277CCA590]])
      {
        v9 = [v5 code];

        if (v9 == -6727)
        {
          v10 = objc_autoreleasePoolPush();
          v11 = WeakRetained;
          v12 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
          {
            v13 = HMFGetLogIdentifier();
            v14 = *(a1 + 48);
            v15 = [*(a1 + 40) name];
            v41 = 138543874;
            v42 = v13;
            v43 = 2112;
            v44 = v14;
            v45 = 2112;
            v46 = v15;
            v16 = "%{public}@Pushed home change fragmented message received kNotFoundErr from user %@ for data sync corresponding to home %@";
LABEL_10:
            _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, v16, &v41, 0x20u);

            goto LABEL_11;
          }

          goto LABEL_11;
        }
      }

      else
      {
      }

      v20 = [v5 domain];
      if (![v20 isEqualToString:*MEMORY[0x277CCFD28]])
      {

        goto LABEL_24;
      }

      v21 = [v5 code];

      if (v21 != 17)
      {
LABEL_24:
        dispatch_group_leave(*(a1 + 56));
        goto LABEL_25;
      }

      v22 = objc_autoreleasePoolPush();
      v23 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
      {
        v24 = HMFGetLogIdentifier();
        v25 = *(a1 + 48);
        v26 = [*(a1 + 40) name];
        v41 = 138543874;
        v42 = v24;
        v43 = 2112;
        v44 = v25;
        v45 = 2112;
        v46 = v26;
        _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Received HMErrorCodeInsufficientPrivileges from user %@ for data sync corresponding to home %@.  Removing User", &v41, 0x20u);
      }

      objc_autoreleasePoolPop(v22);
      v27 = *(a1 + 48);
      v28 = [*(a1 + 40) uuid];
      [WeakRetained _removePendingDataSyncAcksForUser:v27 forHome:v28];
    }

    else
    {
      if ([v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
      {
        v10 = objc_autoreleasePoolPush();
        v11 = WeakRetained;
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          v17 = *(a1 + 32);
          v15 = [*(a1 + 40) name];
          v41 = 138543874;
          v42 = v13;
          v43 = 2112;
          v44 = v17;
          v45 = 2112;
          v46 = v15;
          v16 = "%{public}@Pushed home change fragmented message received ACK from user %@ for data sync corresponding to home %@";
          goto LABEL_10;
        }

LABEL_11:

        objc_autoreleasePoolPop(v10);
        v18 = *(a1 + 48);
        v19 = [*(a1 + 40) uuid];
        [v11 _removePendingDataSyncAcksForUser:v18 forHome:v19];

        goto LABEL_24;
      }

      if (![v6 hmf_BOOLForKey:@"kDataSyncResponseNAckKey"])
      {
        if (![v6 hmf_BOOLForKey:@"kDataSyncResponseCancelKey"])
        {
          goto LABEL_24;
        }

        v10 = objc_autoreleasePoolPush();
        v11 = WeakRetained;
        v12 = HMFGetOSLogHandle();
        if (!os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          goto LABEL_11;
        }

        v13 = HMFGetLogIdentifier();
        v40 = *(a1 + 32);
        v15 = [*(a1 + 40) name];
        v41 = 138543874;
        v42 = v13;
        v43 = 2112;
        v44 = v40;
        v45 = 2112;
        v46 = v15;
        v16 = "%{public}@Pushed home change fragmented message received Cancel from user %@ for data corresponding to home %@";
        goto LABEL_10;
      }

      v29 = objc_autoreleasePoolPush();
      v30 = WeakRetained;
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        v33 = *(a1 + 32);
        v34 = [*(a1 + 40) name];
        v41 = 138543874;
        v42 = v32;
        v43 = 2112;
        v44 = v33;
        v45 = 2112;
        v46 = v34;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Pushed home change fragmented message received NACK from user %@ for data sync corresponding to home %@", &v41, 0x20u);
      }

      objc_autoreleasePoolPop(v29);
      v35 = *(a1 + 48);
      v36 = [*(a1 + 40) uuid];
      [v30 _removePendingDataSyncAcksForUser:v35 forHome:v36];
    }

    v37 = *(a1 + 40);
    v38 = [*(a1 + 32) username];
    [v37 removeUserWithUserID:v38];

    goto LABEL_24;
  }

LABEL_25:

  v39 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager__pushChangesForHome_toRegularUsersOfHome_adminUsersOfHome___block_invoke_769(uint64_t a1, void *a2, void *a3)
{
  v39 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (WeakRetained)
  {
    if (v5)
    {
      v8 = [v5 domain];
      if ([v8 isEqualToString:*MEMORY[0x277CCA590]])
      {
        v9 = [v5 code];

        if (v9 == -6727)
        {
          v10 = objc_autoreleasePoolPush();
          v11 = *(a1 + 32);
          v12 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
          {
            v13 = HMFGetLogIdentifier();
            v14 = *(a1 + 56);
            v15 = [*(a1 + 48) name];
            v33 = 138543874;
            v34 = v13;
            v35 = 2112;
            v36 = v14;
            v37 = 2112;
            v38 = v15;
            v16 = "%{public}@Pushed home change secure message received kNotFoundErr from user %@ for data sync corresponding to home %@";
LABEL_10:
            _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, v16, &v33, 0x20u);

            goto LABEL_11;
          }

          goto LABEL_11;
        }
      }

      else
      {
      }

      v20 = [v5 domain];
      if ([v20 isEqualToString:*MEMORY[0x277CCFD28]])
      {
        v21 = [v5 code];

        if (v21 == 17)
        {
          v22 = objc_autoreleasePoolPush();
          v23 = HMFGetOSLogHandle();
          if (!os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
          {
LABEL_23:

            objc_autoreleasePoolPop(v22);
            v29 = *(a1 + 56);
            v30 = [*(a1 + 48) uuid];
            [WeakRetained _removePendingDataSyncAcksForUser:v29 forHome:v30];

            v31 = *(a1 + 48);
            v19 = [*(a1 + 40) username];
            [v31 removeUserWithUserID:v19];
            goto LABEL_24;
          }

          v24 = HMFGetLogIdentifier();
          v25 = *(a1 + 56);
          v26 = [*(a1 + 48) name];
          v33 = 138543874;
          v34 = v24;
          v35 = 2112;
          v36 = v25;
          v37 = 2112;
          v38 = v26;
          _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@Received HMErrorCodeInsufficientPrivileges from user %@ for data sync corresponding to home %@.  Removing User", &v33, 0x20u);
          goto LABEL_21;
        }
      }

      else
      {
      }
    }

    else
    {
      if ([v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
      {
        v10 = objc_autoreleasePoolPush();
        v11 = *(a1 + 32);
        v12 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
        {
          v13 = HMFGetLogIdentifier();
          v17 = *(a1 + 40);
          v15 = [*(a1 + 48) name];
          v33 = 138543874;
          v34 = v13;
          v35 = 2112;
          v36 = v17;
          v37 = 2112;
          v38 = v15;
          v16 = "%{public}@Pushed home change secure message received ACK from user %@ for data sync corresponding to home %@";
          goto LABEL_10;
        }

LABEL_11:

        objc_autoreleasePoolPop(v10);
        v18 = *(a1 + 56);
        v19 = [*(a1 + 48) uuid];
        [WeakRetained _removePendingDataSyncAcksForUser:v18 forHome:v19];
LABEL_24:

        goto LABEL_25;
      }

      if ([v6 hmf_BOOLForKey:@"kDataSyncResponseNAckKey"])
      {
        v22 = objc_autoreleasePoolPush();
        v23 = *(a1 + 32);
        v24 = HMFGetOSLogHandle();
        if (!os_log_type_enabled(v24, OS_LOG_TYPE_INFO))
        {
LABEL_22:

          goto LABEL_23;
        }

        v26 = HMFGetLogIdentifier();
        v27 = *(a1 + 40);
        v28 = [*(a1 + 48) name];
        v33 = 138543874;
        v34 = v26;
        v35 = 2112;
        v36 = v27;
        v37 = 2112;
        v38 = v28;
        _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_INFO, "%{public}@Pushed home change secure message received NACK from user %@ for data sync corresponding to home %@", &v33, 0x20u);

LABEL_21:
        goto LABEL_22;
      }
    }
  }

LABEL_25:
  dispatch_group_leave(*(a1 + 64));

  v32 = *MEMORY[0x277D85DE8];
}

- (id)_compressHomeData:(id)a3
{
  v10[1] = *MEMORY[0x277D85DE8];
  v3 = [a3 objectForKey:@"kHomeDataKey"];
  v4 = v3;
  if (v3)
  {
    v9 = @"kHomeDataKey";
    v5 = [v3 hmd_compressedData];
    v10[0] = v5;
    v6 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v10 forKeys:&v9 count:1];
  }

  else
  {
    v6 = 0;
  }

  v7 = *MEMORY[0x277D85DE8];

  return v6;
}

- (id)generatePayloadFromHome:(id)a3 forAdmin:(BOOL)a4 user:(id)a5 supportedFeatures:(id)a6
{
  v8 = a4;
  v44[4] = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a5;
  v12 = a6;
  v13 = [(HMDHomeManager *)self primaryHomeUUID];

  v14 = 0x277CBE000uLL;
  if (v13)
  {
    v43[0] = @"kAccessoriesDataBlobKey";
    v15 = [v10 hapAccessoriesForLegacyDataBlobEncoding];
    v44[0] = v15;
    v43[1] = @"kPrimaryHomeUUIDKey";
    v16 = [(HMDHomeManager *)self primaryHomeUUID];
    v17 = [v16 UUIDString];
    v44[1] = v17;
    v44[2] = v10;
    v43[2] = @"kHomeDataBlobKey";
    v43[3] = @"kHomeDataVersionKey";
    v44[3] = &unk_28662A298;
    v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v44 forKeys:v43 count:4];
  }

  else
  {
    v41[0] = @"kAccessoriesDataBlobKey";
    v15 = [v10 hapAccessoriesForLegacyDataBlobEncoding];
    v42[0] = v15;
    v42[1] = v10;
    v41[1] = @"kHomeDataBlobKey";
    v41[2] = @"kHomeDataVersionKey";
    v42[2] = &unk_28662A298;
    v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v42 forKeys:v41 count:3];
  }

  v19 = objc_autoreleasePoolPush();
  v20 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v20, OS_LOG_TYPE_INFO))
  {
    v21 = HMFGetLogIdentifier();
    *buf = 138543618;
    v38 = v21;
    v39 = 2112;
    v40 = v11;
    _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, "%{public}@generatePayloadFromHome: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v19);
  if (v8)
  {
    v22 = v18;
    v23 = v11;
    v24 = v12;
    context = objc_autoreleasePoolPush();
    v25 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.hmdutil.encode-remote-admin."];
    v26 = v10;
    v27 = v11;
    v28 = v12;
    v29 = [[HMDRemoteKeyedArchiver alloc] initForWritingWithRemoteDeviceIsOnSameAccount:0 remoteGateway:0 remoteUserIsAdministrator:1 user:v23 supportedFeatures:v24];
    [v29 encodeObject:v22 forKey:*MEMORY[0x277CCA308]];
    [v29 finishEncoding];
    v30 = [v29 encodedData];

    v12 = v28;
    v11 = v27;
    v10 = v26;

    v14 = 0x277CBE000;
    objc_autoreleasePoolPop(context);
  }

  else
  {
    v30 = encodeRootObjectForRemote(v18, v11, v12);
  }

  v35 = @"kHomeDataKey";
  v36 = v30;
  v31 = [*(v14 + 2752) dictionaryWithObjects:&v36 forKeys:&v35 count:1];

  v32 = *MEMORY[0x277D85DE8];

  return v31;
}

- (id)generateDataForSharedHomeModel:(id)a3
{
  v10[3] = *MEMORY[0x277D85DE8];
  v9[0] = @"kAccessoriesDataBlobKey";
  v3 = a3;
  v4 = [v3 hapAccessoriesForLegacyDataBlobEncoding];
  v10[0] = v4;
  v10[1] = v3;
  v9[1] = @"kHomeDataBlobKey";
  v9[2] = @"kHomeDataVersionKey";
  v10[2] = &unk_28662A298;
  v5 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v10 forKeys:v9 count:3];

  v6 = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v5, 1, 0);

  v7 = *MEMORY[0x277D85DE8];

  return v6;
}

- (void)_pushChangesToWatch:(id)a3 payload:(id)a4 group:(id)a5 completionHandler:(id)a6
{
  v33 = *MEMORY[0x277D85DE8];
  v10 = a3;
  v11 = a4;
  v12 = a5;
  v13 = a6;
  v14 = [(HMDHomeManager *)self associatedWatchPeers];
  v15 = [v14 objectForKey:v10];
  v16 = [v15 metadataConfig];
  [(HMDHomeManager *)self checkAndPushMetadataToUser:v10 destination:v10 userInfo:v16];

  v17 = [(HMDHomeManager *)self uuid];
  v18 = [HMDMessageDispatcher destinationWithTarget:v17 userID:0 destination:v10 multicast:0];

  if (v18)
  {
    dispatch_group_enter(v12);
    v19 = [MEMORY[0x277D0F848] messageWithName:@"kHomeDataSyncRequestKey" qualityOfService:17 destination:v18 payload:v11];
    [v19 setSecureRemote:1];
    [v19 setRemoteRestriction:4];
    objc_initWeak(location, self);
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __70__HMDHomeManager__pushChangesToWatch_payload_group_completionHandler___block_invoke;
    v26[3] = &unk_279731AF8;
    objc_copyWeak(&v29, location);
    v27 = v12;
    v28 = v13;
    [v19 setResponseHandler:v26];
    v20 = [(HMDHomeManager *)self messageDispatcher];
    [v20 sendMessage:v19 completionHandler:0];

    objc_destroyWeak(&v29);
    objc_destroyWeak(location);
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    v22 = self;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
    {
      v24 = HMFGetLogIdentifier();
      *location = 138543618;
      *&location[4] = v24;
      v31 = 2112;
      v32 = v10;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, "%{public}@Cannot push changes to watch: could not create message destination for unique ID: %@", location, 0x16u);
    }

    objc_autoreleasePoolPop(v21);
    (*(v13 + 2))(v13, 0);
  }

  v25 = *MEMORY[0x277D85DE8];
}

void __70__HMDHomeManager__pushChangesToWatch_payload_group_completionHandler___block_invoke(id *a1, uint64_t a2, void *a3)
{
  v4 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v6 = WeakRetained;
  if (WeakRetained)
  {
    v7 = [WeakRetained workQueue];
    v8[0] = MEMORY[0x277D85DD0];
    v8[1] = 3221225472;
    v8[2] = __70__HMDHomeManager__pushChangesToWatch_payload_group_completionHandler___block_invoke_2;
    v8[3] = &unk_279734578;
    v9 = v4;
    v12 = a1[5];
    v10 = v6;
    v11 = a1[4];
    dispatch_async(v7, v8);
  }

  else
  {
    dispatch_group_leave(a1[4]);
  }
}

void __70__HMDHomeManager__pushChangesToWatch_payload_group_completionHandler___block_invoke_2(uint64_t a1)
{
  v13 = *MEMORY[0x277D85DE8];
  if ([*(a1 + 32) hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
  {
    v2 = *(*(a1 + 56) + 16);
  }

  else
  {
    if (![*(a1 + 32) hmf_BOOLForKey:@"kDataSyncResponseNAckKey"])
    {
      v3 = objc_autoreleasePoolPush();
      v4 = *(a1 + 40);
      v5 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v5, OS_LOG_TYPE_ERROR))
      {
        v6 = HMFGetLogIdentifier();
        v7 = *(a1 + 32);
        v9 = 138543618;
        v10 = v6;
        v11 = 2112;
        v12 = v7;
        _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_ERROR, "%{public}@Failed to push changes to watch: received unexpected response from sync message: %@", &v9, 0x16u);
      }

      objc_autoreleasePoolPop(v3);
    }

    v2 = *(*(a1 + 56) + 16);
  }

  v2();
  dispatch_group_leave(*(a1 + 48));
  v8 = *MEMORY[0x277D85DE8];
}

- (id)_prepareDataForDevicesOnSameAccountForHome:(id)a3 remoteGateway:(BOOL)a4 isAtLeastV4:(BOOL)a5 migrateToHH2:(BOOL)a6
{
  v6 = a6;
  v7 = a5;
  v8 = a4;
  v27[1] = *MEMORY[0x277D85DE8];
  v10 = MEMORY[0x277CBEB38];
  v11 = a3;
  v12 = [v10 dictionary];
  v13 = [v11 hapAccessoriesForLegacyDataBlobEncoding];
  [v12 setObject:v13 forKeyedSubscript:@"kAccessoriesDataBlobKey"];

  [v12 setObject:v11 forKeyedSubscript:@"kHomeDataBlobKey"];
  [v12 setObject:&unk_28662A298 forKeyedSubscript:@"kHomeDataVersionKey"];
  v14 = [(HMDHomeManager *)self primaryHomeUUID];
  v15 = [v14 UUIDString];
  [v12 setObject:v15 forKeyedSubscript:@"kPrimaryHomeUUIDKey"];

  v16 = [v12 copy];
  v17 = v16;
  if (v8)
  {
    v18 = v16;
    v19 = objc_autoreleasePoolPush();
    v20 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.hmdutil.encode-remote-gateway."];
    v21 = [[HMDRemoteKeyedArchiver alloc] initForWritingWithRemoteDeviceIsOnSameAccount:1 remoteGateway:1 remoteUserIsAdministrator:0 user:0 supportedFeatures:0];
    [v21 encodeObject:v18 forKey:*MEMORY[0x277CCA308]];
    [v21 finishEncoding];
    v22 = [v21 encodedData];

    objc_autoreleasePoolPop(v19);
  }

  else
  {
    v22 = encodeRootObjectForRemoteDeviceOnSameAccountMigrateToHH2(v16, v7, v6);
  }

  v26 = @"kHomeDataKey";
  v27[0] = v22;
  v23 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v27 forKeys:&v26 count:1];

  v24 = *MEMORY[0x277D85DE8];

  return v23;
}

- (void)_pushChangesForHome:(id)a3 toRemoteDevicesOnSameAccount:(id)a4 addedUser:(id)a5
{
  v85 = *MEMORY[0x277D85DE8];
  v49 = a3;
  v44 = a4;
  v48 = a5;
  if (!isWatch() && [v44 count])
  {
    context = objc_autoreleasePoolPush();
    v73[0] = 0;
    v73[1] = v73;
    v73[2] = 0x3032000000;
    v73[3] = __Block_byref_object_copy__172847;
    v73[4] = __Block_byref_object_dispose__172848;
    v74 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.push-home-to-gateways"];
    v7 = +[HMDHAPMetadata getSharedInstance];
    if (v7)
    {
      [(HMDHomeManager *)self _prepareDataForDevicesOnSameAccountForHome:v49 remoteGateway:1 isAtLeastV4:0];
      v41 = v43 = v7;
      v8 = [v41 objectForKeyedSubscript:@"kHomeDataKey"];
      v40 = [v8 hmd_compressedData];

      v47 = [MEMORY[0x277D0F818] internalMessageWithName:@"kHomeDataSyncRequestKey" messagePayload:v41];
      if (v40)
      {
        v81 = @"kHomeDataKey";
        v82 = v40;
        v9 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v82 forKeys:&v81 count:1];
        v46 = [MEMORY[0x277D0F818] internalMessageWithName:@"kHomeDataSyncRequestKey" messagePayload:v9];
        v39 = v9;
      }

      else
      {
        v46 = v47;
        v39 = 0;
      }

      objc_initWeak(&location, self);
      group = dispatch_group_create();
      v79 = @"kRequestedCapabilitiesKey";
      v77[0] = @"kMetadataInfoVersionKey";
      v14 = [v43 version];
      v78[0] = v14;
      v77[1] = @"kMetadataInfoSchemaVersionKey";
      v15 = [v43 schemaVersion];
      v78[1] = v15;
      v77[2] = @"kMetadataInfoCompletenessKey";
      v16 = [MEMORY[0x277CCABB0] numberWithInt:{objc_msgSend(v43, "incomplete") ^ 1}];
      v78[2] = v16;
      v78[3] = &unk_2866272C8;
      v77[3] = @"kHomedSupportedFeaturesKey";
      v77[4] = @"kHomedVersionKey";
      v17 = homedVersion;
      v78[4] = v17;
      v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v78 forKeys:v77 count:5];
      v80 = v18;
      v45 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v80 forKeys:&v79 count:1];

      v70 = 0u;
      v71 = 0u;
      v68 = 0u;
      v69 = 0u;
      obj = v44;
      v53 = [obj countByEnumeratingWithState:&v68 objects:v76 count:16];
      if (v53)
      {
        v52 = *v69;
        do
        {
          for (i = 0; i != v53; ++i)
          {
            if (*v69 != v52)
            {
              objc_enumerationMutation(obj);
            }

            v19 = *(*(&v68 + 1) + 8 * i);
            v20 = [(HMDHomeManager *)self appleAccountManager];
            v21 = [v20 account];
            v22 = [v21 devices];

            v66 = 0u;
            v67 = 0u;
            v64 = 0u;
            v65 = 0u;
            v23 = v22;
            v24 = [v23 countByEnumeratingWithState:&v64 objects:v75 count:16];
            if (v24)
            {
              v25 = *v65;
              while (2)
              {
                for (j = 0; j != v24; ++j)
                {
                  if (*v65 != v25)
                  {
                    objc_enumerationMutation(v23);
                  }

                  v27 = *(*(&v64 + 1) + 8 * j);
                  v28 = [v27 remoteDestinationString];
                  if ([v28 isEqualToString:v19])
                  {
                    v29 = [v27 version];
                    v30 = minimumSupportedResidentHomeKitVersion;
                    v31 = [v29 isAtLeastVersion:v30];

                    if (v31)
                    {

                      v33 = objc_autoreleasePoolPush();
                      v34 = HMFGetOSLogHandle();
                      if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
                      {
                        v36 = HMFGetLogIdentifier();
                        *buf = 138543362;
                        v84 = v36;
                        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@Resident syncs through cloud, don't send data through IDS.", buf, 0xCu);
                      }

                      objc_autoreleasePoolPop(v33);
                      goto LABEL_30;
                    }
                  }

                  else
                  {
                  }
                }

                v24 = [v23 countByEnumeratingWithState:&v64 objects:v75 count:16];
                if (v24)
                {
                  continue;
                }

                break;
              }
            }

            dispatch_group_enter(group);
            v32 = [(HMDHomeManager *)self workQueue];
            v57[0] = MEMORY[0x277D85DD0];
            v57[1] = 3221225472;
            v57[2] = __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke;
            v57[3] = &unk_279731AA8;
            v57[4] = self;
            v57[5] = v19;
            v58 = v49;
            v59 = v47;
            v60 = v46;
            v61 = v48;
            v62 = group;
            objc_copyWeak(&v63, &location);
            [(HMDHomeManager *)self electDeviceForUser:v19 destination:v19 deviceCapabilities:v45 queue:v32 completionHandler:v57];

            objc_destroyWeak(&v63);
LABEL_30:
          }

          v53 = [obj countByEnumeratingWithState:&v68 objects:v76 count:16];
        }

        while (v53);
      }

      v37 = [(HMDHomeManager *)self workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_756;
      block[3] = &unk_279731AD0;
      block[4] = v73;
      dispatch_group_notify(group, v37, block);

      objc_destroyWeak(&location);
      v10 = v43;
    }

    else
    {
      v10 = 0;
      v11 = objc_autoreleasePoolPush();
      v12 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
      {
        v13 = HMFGetLogIdentifier();
        *buf = 138543362;
        v84 = v13;
        _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@No metadata to push changes for Home", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v11);
    }

    _Block_object_dispose(v73, 8);
    objc_autoreleasePoolPop(context);
  }

  v38 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v76 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  v58 = v7;
  v59 = v8;
  if (v7)
  {
    dispatch_group_leave(*(a1 + 80));
  }

  else
  {
    v10 = *(a1 + 32);
    v11 = *(a1 + 40);
    v12 = [v8 destination];
    [v10 checkAndPushMetadataToUser:v11 destination:v12 userInfo:v9];

    v57 = [v9 objectForKeyedSubscript:@"kHomeConfigurationVersionKey"];
    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
    {
      v15 = HMFGetLogIdentifier();
      v16 = [*(a1 + 48) configurationVersion];
      *buf = 138543874;
      v71 = v15;
      v72 = 2112;
      v73 = v57;
      v74 = 2048;
      v75 = v16;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Remote's home config = %@, Self = %ld", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v13);
    if (v57 && (v17 = [v57 integerValue], v17 == objc_msgSend(*(a1 + 48), "configurationVersion")))
    {
      v18 = objc_autoreleasePoolPush();
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
      {
        v20 = HMFGetLogIdentifier();
        *buf = 138543362;
        v71 = v20;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Skip home push as the local and remote versions are the same", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      dispatch_group_leave(*(a1 + 80));
    }

    else
    {
      v21 = *(a1 + 32);
      v22 = *(a1 + 40);
      v23 = [*(a1 + 48) uuid];
      [v21 _addPendingDataSyncAcksForUser:v22 forHome:v23];

      v55 = *(a1 + 56);
      v24 = [v9 hmf_arrayForKey:@"kHomedSupportedFeaturesKey"];
      v56 = v24;
      if (v24 && [v24 containsObject:&unk_28662A268])
      {
        v25 = objc_autoreleasePoolPush();
        v26 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          *buf = 138543362;
          v71 = v27;
          _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Sending compressed data to remote because homed supports compression", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v25);
        v28 = *(a1 + 64);

        v55 = v28;
      }

      v29 = objc_autoreleasePoolPush();
      v30 = *(a1 + 32);
      v31 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v31, OS_LOG_TYPE_INFO))
      {
        v32 = HMFGetLogIdentifier();
        v33 = [v55 dataForKey:@"kHomeDataKey"];
        v34 = [v33 length];
        *buf = 138543874;
        v71 = v32;
        v72 = 2048;
        v73 = v34;
        v74 = 2112;
        v75 = v8;
        _os_log_impl(&dword_2531F8000, v31, OS_LOG_TYPE_INFO, "%{public}@Pushing home changes (%ld bytes) to remote device with handle: %@", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v29);
      if (v56 && [v56 containsObject:&unk_28662A280])
      {
        objc_initWeak(buf, *(a1 + 32));
        v35 = *(a1 + 32);
        v36 = [v55 dataForKey:@"kHomeDataKey"];
        v37 = [*(a1 + 48) uuid];
        v38 = [v37 UUIDString];
        v39 = [v55 name];
        v40 = *(a1 + 40);
        v41 = [v59 destination];
        v66[0] = MEMORY[0x277D85DD0];
        v66[1] = 3221225472;
        v66[2] = __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_753;
        v66[3] = &unk_279731A58;
        objc_copyWeak(&v69, buf);
        v54 = *(a1 + 40);
        v42 = *(&v54 + 1);
        v43 = *(a1 + 72);
        v44 = *(a1 + 80);
        *&v45 = v43;
        *(&v45 + 1) = v44;
        v67 = v54;
        v68 = v45;
        [v35 sendFragmentedMessageForData:v36 objectUUID:v38 withMessageName:v39 toUser:v40 destination:v41 completionHandler:v66];

        objc_destroyWeak(&v69);
        objc_destroyWeak(buf);
      }

      else
      {
        v46 = [*(a1 + 32) messageDispatcher];
        v47 = [*(a1 + 32) uuid];
        v48 = *(a1 + 40);
        v49 = [v59 destination];
        v50 = [*(a1 + 32) workQueue];
        v60[0] = MEMORY[0x277D85DD0];
        v60[1] = 3221225472;
        v60[2] = __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_754;
        v60[3] = &unk_279731A80;
        objc_copyWeak(&v65, (a1 + 88));
        v60[4] = *(a1 + 40);
        v61 = *(a1 + 48);
        v51 = *(a1 + 72);
        v52 = *(a1 + 32);
        v62 = v51;
        v63 = v52;
        v64 = *(a1 + 80);
        [v46 sendSecureMessage:v55 target:v47 userID:v48 destination:v49 responseQueue:v50 responseHandler:v60];

        objc_destroyWeak(&v65);
      }
    }
  }

  v53 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_756(uint64_t a1)
{
  v10 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v3, OS_LOG_TYPE_DEBUG))
  {
    v4 = HMFGetLogIdentifier();
    v8 = 138543362;
    v9 = v4;
    _os_log_impl(&dword_2531F8000, v3, OS_LOG_TYPE_DEBUG, "%{public}@Finished pushing home data changes to gateways", &v8, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v5 = *(*(a1 + 32) + 8);
  v6 = *(v5 + 40);
  *(v5 + 40) = 0;

  v7 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_753(uint64_t a1, void *a2, void *a3)
{
  v53 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  if (WeakRetained)
  {
    if (v5)
    {
      v8 = [v5 domain];
      if ([v8 isEqualToString:*MEMORY[0x277CCA590]])
      {
        v9 = [v5 code];

        if (v9 == -6727)
        {
          v10 = objc_autoreleasePoolPush();
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v12 = HMFGetLogIdentifier();
            v13 = *(a1 + 32);
            v14 = [*(a1 + 40) name];
            v47 = 138543874;
            v48 = v12;
            v49 = 2112;
            v50 = v13;
            v51 = 2112;
            v52 = v14;
            v15 = "%{public}@Received kNotFoundErr from user %@ for data sync corresponding to home %@";
LABEL_29:
            _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, v15, &v47, 0x20u);

            goto LABEL_30;
          }

          goto LABEL_30;
        }
      }

      else
      {
      }

      v30 = [v5 domain];
      if ([v30 isEqualToString:*MEMORY[0x277CCFD28]])
      {
        v31 = [v5 code];

        if (v31 == 17)
        {
          v32 = objc_autoreleasePoolPush();
          v33 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v33, OS_LOG_TYPE_ERROR))
          {
            v34 = HMFGetLogIdentifier();
            v35 = *(a1 + 32);
            v36 = [*(a1 + 40) name];
            v47 = 138543874;
            v48 = v34;
            v49 = 2112;
            v50 = v35;
            v51 = 2112;
            v52 = v36;
            v37 = "%{public}@Received HMErrorCodeInsufficientPrivileges from user %@ for data sync corresponding to home %@.  Removing User";
            v38 = v33;
            v39 = OS_LOG_TYPE_ERROR;
LABEL_24:
            _os_log_impl(&dword_2531F8000, v38, v39, v37, &v47, 0x20u);

            goto LABEL_25;
          }

          goto LABEL_25;
        }
      }

      else
      {
      }
    }

    else if ([v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
    {
      v16 = objc_autoreleasePoolPush();
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        v19 = *(a1 + 32);
        v20 = [*(a1 + 40) name];
        v47 = 138543874;
        v48 = v18;
        v49 = 2112;
        v50 = v19;
        v51 = 2112;
        v52 = v20;
        _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Received ACK from user %@ for data corresponding to home %@", &v47, 0x20u);
      }

      objc_autoreleasePoolPop(v16);
      v21 = *(a1 + 32);
      v22 = [*(a1 + 40) uuid];
      [WeakRetained _removePendingDataSyncAcksForUser:v21 forHome:v22];

      v23 = *(a1 + 48);
      if (v23)
      {
        v24 = [v23 userID];
        v25 = [v24 isEqualToString:*(a1 + 32)];

        if (v25)
        {
          v26 = objc_autoreleasePoolPush();
          v27 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
          {
            v28 = HMFGetLogIdentifier();
            v29 = [*(a1 + 40) name];
            v47 = 138543618;
            v48 = v28;
            v49 = 2112;
            v50 = v29;
            _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@We just added a resident user to home %@, checking if we need to setup remote session", &v47, 0x16u);
          }

          objc_autoreleasePoolPop(v26);
          [WeakRetained _checkForRemotePeersAndRegisterForRemoteNotifications:1];
        }
      }
    }

    else
    {
      if ([v6 hmf_BOOLForKey:@"kDataSyncResponseNAckKey"])
      {
        v32 = objc_autoreleasePoolPush();
        v33 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v33, OS_LOG_TYPE_INFO))
        {
          v34 = HMFGetLogIdentifier();
          v40 = *(a1 + 32);
          v36 = [*(a1 + 40) name];
          v47 = 138543874;
          v48 = v34;
          v49 = 2112;
          v50 = v40;
          v51 = 2112;
          v52 = v36;
          v37 = "%{public}@Received NACK from user %@ for data corresponding to home %@";
          v38 = v33;
          v39 = OS_LOG_TYPE_INFO;
          goto LABEL_24;
        }

LABEL_25:

        objc_autoreleasePoolPop(v32);
        v41 = *(a1 + 32);
        v42 = [*(a1 + 40) uuid];
        [WeakRetained _removePendingDataSyncAcksForUser:v41 forHome:v42];

        [*(a1 + 40) removeUserWithUserID:*(a1 + 32)];
        goto LABEL_31;
      }

      if ([v6 hmf_BOOLForKey:@"kDataSyncResponseCancelKey"])
      {
        v10 = objc_autoreleasePoolPush();
        v11 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
        {
          v12 = HMFGetLogIdentifier();
          v43 = *(a1 + 32);
          v14 = [*(a1 + 40) name];
          v47 = 138543874;
          v48 = v12;
          v49 = 2112;
          v50 = v43;
          v51 = 2112;
          v52 = v14;
          v15 = "%{public}@Received Cancel from user %@ for data corresponding to home %@";
          goto LABEL_29;
        }

LABEL_30:

        objc_autoreleasePoolPop(v10);
        v44 = *(a1 + 32);
        v45 = [*(a1 + 40) uuid];
        [WeakRetained _removePendingDataSyncAcksForUser:v44 forHome:v45];
      }
    }
  }

LABEL_31:
  dispatch_group_leave(*(a1 + 56));

  v46 = *MEMORY[0x277D85DE8];
}

void __77__HMDHomeManager__pushChangesForHome_toRemoteDevicesOnSameAccount_addedUser___block_invoke_754(uint64_t a1, void *a2, void *a3)
{
  v55 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  if (!WeakRetained)
  {
    goto LABEL_28;
  }

  if (v5)
  {
    v8 = [v5 domain];
    if ([v8 isEqualToString:*MEMORY[0x277CCA590]])
    {
      v9 = [v5 code];

      if (v9 == -6727)
      {
        v10 = objc_autoreleasePoolPush();
        v11 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
        {
          v12 = HMFGetLogIdentifier();
          v13 = *(a1 + 32);
          v14 = [*(a1 + 40) name];
          v49 = 138543874;
          v50 = v12;
          v51 = 2112;
          v52 = v13;
          v53 = 2112;
          v54 = v14;
          _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Received kNotFoundErr from user %@ for data sync corresponding to home %@", &v49, 0x20u);
        }

        objc_autoreleasePoolPop(v10);
        v15 = *(a1 + 32);
        v16 = [*(a1 + 40) uuid];
        [WeakRetained _removePendingDataSyncAcksForUser:v15 forHome:v16];

        goto LABEL_28;
      }
    }

    else
    {
    }

    v31 = [v5 domain];
    if (![v31 isEqualToString:*MEMORY[0x277CCFD28]])
    {

      goto LABEL_28;
    }

    v32 = [v5 code];

    if (v32 == 17)
    {
      v33 = objc_autoreleasePoolPush();
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
      {
        v35 = HMFGetLogIdentifier();
        v36 = *(a1 + 32);
        v37 = [*(a1 + 40) name];
        v49 = 138543874;
        v50 = v35;
        v51 = 2112;
        v52 = v36;
        v53 = 2112;
        v54 = v37;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_ERROR, "%{public}@Received HMErrorCodeInsufficientPrivileges from user %@ for data sync corresponding to home %@.  Removing User", &v49, 0x20u);
      }

      objc_autoreleasePoolPop(v33);
      v38 = *(a1 + 56);
      v39 = *(a1 + 32);
      v40 = [*(a1 + 40) uuid];
      [v38 _removePendingDataSyncAcksForUser:v39 forHome:v40];

      goto LABEL_27;
    }
  }

  else
  {
    if (![v6 hmf_BOOLForKey:@"kDataSyncResponseAckKey"])
    {
      if (![v6 hmf_BOOLForKey:@"kDataSyncResponseNAckKey"])
      {
        goto LABEL_28;
      }

      v41 = objc_autoreleasePoolPush();
      v42 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_INFO))
      {
        v43 = HMFGetLogIdentifier();
        v44 = *(a1 + 32);
        v45 = [*(a1 + 40) name];
        v49 = 138543874;
        v50 = v43;
        v51 = 2112;
        v52 = v44;
        v53 = 2112;
        v54 = v45;
        _os_log_impl(&dword_2531F8000, v42, OS_LOG_TYPE_INFO, "%{public}@Received NACK from user %@ for data corresponding to home %@", &v49, 0x20u);
      }

      objc_autoreleasePoolPop(v41);
      v46 = *(a1 + 32);
      v47 = [*(a1 + 40) uuid];
      [WeakRetained _removePendingDataSyncAcksForUser:v46 forHome:v47];

LABEL_27:
      [*(a1 + 40) removeUserWithUserID:*(a1 + 32)];
      goto LABEL_28;
    }

    v17 = objc_autoreleasePoolPush();
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
    {
      v19 = HMFGetLogIdentifier();
      v20 = *(a1 + 32);
      v21 = [*(a1 + 40) name];
      v49 = 138543874;
      v50 = v19;
      v51 = 2112;
      v52 = v20;
      v53 = 2112;
      v54 = v21;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@Received ACK from user %@ for data corresponding to home %@", &v49, 0x20u);
    }

    objc_autoreleasePoolPop(v17);
    v22 = *(a1 + 32);
    v23 = [*(a1 + 40) uuid];
    [WeakRetained _removePendingDataSyncAcksForUser:v22 forHome:v23];

    v24 = *(a1 + 48);
    if (v24)
    {
      v25 = [v24 userID];
      v26 = [v25 isEqualToString:*(a1 + 32)];

      if (v26)
      {
        v27 = objc_autoreleasePoolPush();
        v28 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
        {
          v29 = HMFGetLogIdentifier();
          v30 = [*(a1 + 40) name];
          v49 = 138543618;
          v50 = v29;
          v51 = 2112;
          v52 = v30;
          _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@We just added a resident user to home %@, checking if we need to setup remote session", &v49, 0x16u);
        }

        objc_autoreleasePoolPop(v27);
        [WeakRetained _checkForRemotePeersAndRegisterForRemoteNotifications:1];
      }
    }
  }

LABEL_28:
  dispatch_group_leave(*(a1 + 64));

  v48 = *MEMORY[0x277D85DE8];
}

- (unsigned)_nextTransactionIdentifier
{
  nextRequestTransactionIdentifier = self->_nextRequestTransactionIdentifier;
  self->_nextRequestTransactionIdentifier = nextRequestTransactionIdentifier + 1;
  return nextRequestTransactionIdentifier;
}

- (void)_pushUserRemovedForHome:(id)a3
{
  v40 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [v4 removedUsers];
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543618;
    v37 = v9;
    v38 = 2112;
    v39 = v5;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Attempting to resend remove message to removed users: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v6);
  v33 = 0u;
  v34 = 0u;
  v31 = 0u;
  v32 = 0u;
  obj = v5;
  v10 = [obj countByEnumeratingWithState:&v31 objects:v35 count:16];
  if (v10)
  {
    v11 = *v32;
    do
    {
      for (i = 0; i != v10; ++i)
      {
        if (*v32 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v31 + 1) + 8 * i);
        if ([v13 isExpired])
        {
          v14 = objc_autoreleasePoolPush();
          v15 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
          {
            v16 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v16;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@Removed user has expired: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v14);
          [v4 removeRemovedUser:v13];
        }

        else if ([v13 isRemovalInProgress])
        {
          v17 = objc_autoreleasePoolPush();
          v18 = v7;
          v19 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
          {
            v20 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v20;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Skipping resending message to user whose removal is already in progress: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v17);
        }

        else
        {
          [v13 setRemovalInProgress:1];
          v21 = objc_autoreleasePoolPush();
          v22 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v22, OS_LOG_TYPE_INFO))
          {
            v23 = HMFGetLogIdentifier();
            *buf = 138543618;
            v37 = v23;
            v38 = 2112;
            v39 = v13;
            _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_INFO, "%{public}@Resending message to removed user: %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v21);
          objc_initWeak(buf, v4);
          v24 = [v13 user];
          v25 = [v13 user];
          v26 = [v25 pairingUsername];
          v29[0] = MEMORY[0x277D85DD0];
          v29[1] = 3221225472;
          v29[2] = __42__HMDHomeManager__pushUserRemovedForHome___block_invoke;
          v29[3] = &unk_279735248;
          v29[4] = v13;
          objc_copyWeak(&v30, buf);
          v29[5] = v7;
          [(HMDHomeManager *)v7 sendUserRemoved:v24 fromHome:v4 pairingUsername:v26 pushToCloud:0 completionHandler:v29];

          objc_destroyWeak(&v30);
          objc_destroyWeak(buf);
        }
      }

      v10 = [obj countByEnumeratingWithState:&v31 objects:v35 count:16];
    }

    while (v10);
  }

  v27 = *MEMORY[0x277D85DE8];
}

void __42__HMDHomeManager__pushUserRemovedForHome___block_invoke(id *a1, void *a2, void *a3)
{
  v29 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  [a1[4] setRemovalInProgress:0];
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  if (!WeakRetained)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = a1[5];
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v20 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v20;
      v21 = "%{public}@Lost reference to home during removed user removal message";
      v22 = v19;
      v23 = 12;
LABEL_15:
      _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_ERROR, v21, &v25, v23);
    }

LABEL_16:

    objc_autoreleasePoolPop(v17);
    goto LABEL_17;
  }

  if (v5 && [v5 code] != 2)
  {
    v17 = objc_autoreleasePoolPush();
    v18 = a1[5];
    v19 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
    {
      v20 = HMFGetLogIdentifier();
      v25 = 138543618;
      v26 = v20;
      v27 = 2112;
      v28 = v5;
      v21 = "%{public}@Unable to remove the removed user: %@";
      v22 = v19;
      v23 = 22;
      goto LABEL_15;
    }

    goto LABEL_16;
  }

  if ([v5 code] == 2)
  {
    v8 = objc_autoreleasePoolPush();
    v9 = a1[5];
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v25 = 138543618;
      v26 = v11;
      v27 = 2112;
      v28 = v5;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@Treating user removed message error as success: %@", &v25, 0x16u);
    }

    objc_autoreleasePoolPop(v8);
  }

  v12 = objc_autoreleasePoolPush();
  v13 = a1[5];
  v14 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
  {
    v15 = HMFGetLogIdentifier();
    v16 = a1[4];
    v25 = 138543618;
    v26 = v15;
    v27 = 2112;
    v28 = v16;
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Successfully removed the removed user: %@", &v25, 0x16u);
  }

  objc_autoreleasePoolPop(v12);
  [WeakRetained removeRemovedUser:a1[4]];
LABEL_17:

  v24 = *MEMORY[0x277D85DE8];
}

- (void)_pushChangesToUsers:(id)a3 forHome:(id)a4
{
  v66 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  v8 = HMFGetOSLogHandle();
  v50 = v6;
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    v10 = [v50 name];
    *buf = 138543618;
    v60 = v9;
    v61 = 2112;
    v62 = v10;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Pushing data sync changes to all users of home %@", buf, 0x16u);

    v6 = v50;
  }

  objc_autoreleasePoolPop(v7);
  v53 = [MEMORY[0x277CBEB18] array];
  v49 = [MEMORY[0x277CBEB18] array];
  v48 = [MEMORY[0x277CBEB18] array];
  v55 = 0u;
  v56 = 0u;
  v57 = 0u;
  v58 = 0u;
  obj = [v6 users];
  v11 = [obj countByEnumeratingWithState:&v55 objects:v65 count:16];
  if (v11)
  {
    v13 = v11;
    v14 = *v56;
    *&v12 = 138543874;
    v47 = v12;
    do
    {
      for (i = 0; i != v13; ++i)
      {
        if (*v56 != v14)
        {
          objc_enumerationMutation(obj);
        }

        v16 = *(*(&v55 + 1) + 8 * i);
        v17 = [(__CFString *)v16 userID];
        if (v17)
        {
          v18 = v17;
          if (v5)
          {
            v19 = [(__CFString *)v16 userID];
            v20 = [v5 containsObject:v19];

            if (!v20)
            {
              continue;
            }
          }

          else
          {
          }

          if (![(__CFString *)v16 isRemoteGateway])
          {
            v26 = [(__CFString *)v16 uuid];
            v27 = [v6 currentUser];
            v28 = [v27 uuid];
            v29 = [v26 isEqual:v28];

            if (v29)
            {
              continue;
            }

            v30 = [(HMDHomeManager *)self _userPushCachedGetDeviceForUser:v16];
            v31 = v30;
            if (v30)
            {
              [v30 remoteDestinationString];
            }

            else
            {
              [(__CFString *)v16 userID];
            }
            v32 = ;
            if (v32)
            {
              v33 = [HMDHomeDataPushDestination alloc];
              v34 = [v31 remoteDestinationString];
              v35 = [(HMDHomeDataPushDestination *)v33 initWithUser:v16 destination:v34];

              if ([(__CFString *)v16 isAdministrator])
              {
                v36 = v48;
              }

              else
              {
                v36 = v49;
              }

              v52 = v35;
              [v36 addObject:v35];
              v37 = shouldLogPrivateInformation();
              v38 = objc_autoreleasePoolPush();
              v39 = HMFGetOSLogHandle();
              v40 = os_log_type_enabled(v39, OS_LOG_TYPE_INFO);
              if (v37)
              {
                if (v40)
                {
                  v41 = HMFGetLogIdentifier();
                  v42 = [(__CFString *)v16 userID];
                  *buf = v47;
                  v60 = v41;
                  v61 = 2112;
                  v62 = v42;
                  v63 = 2112;
                  v64 = v32;
                  _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Will push to user %@/%@", buf, 0x20u);

                  goto LABEL_33;
                }
              }

              else if (v40)
              {
                v41 = HMFGetLogIdentifier();
                *buf = v47;
                v60 = v41;
                v61 = 2112;
                v62 = @"...";
                v63 = 2112;
                v64 = @"...";
                _os_log_impl(&dword_2531F8000, v39, OS_LOG_TYPE_INFO, "%{public}@Will push to user %@/%@", buf, 0x20u);
LABEL_33:
              }

              objc_autoreleasePoolPop(v38);
              v6 = v50;
            }

            else
            {
              v43 = objc_autoreleasePoolPush();
              v44 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v44, OS_LOG_TYPE_ERROR))
              {
                v45 = HMFGetLogIdentifier();
                *buf = 138543618;
                v60 = v45;
                v61 = 2112;
                v62 = v16;
                _os_log_impl(&dword_2531F8000, v44, OS_LOG_TYPE_ERROR, "%{public}@Ignoring the user %@ as it doesn't have device or userID.", buf, 0x16u);

                v6 = v50;
              }

              objc_autoreleasePoolPop(v43);
            }

            continue;
          }

          v21 = [(__CFString *)v16 userID];
          [v53 addObject:v21];

          v22 = objc_autoreleasePoolPush();
          v23 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v23, OS_LOG_TYPE_INFO))
          {
            v24 = HMFGetLogIdentifier();
            v25 = [(__CFString *)v16 userID];
            *buf = 138543618;
            v60 = v24;
            v61 = 2112;
            v62 = v25;
            _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_INFO, "%{public}@Will push to remote gateway %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v22);
        }
      }

      v13 = [obj countByEnumeratingWithState:&v55 objects:v65 count:16];
    }

    while (v13);
  }

  [(HMDHomeManager *)self _pushChangesForHome:v6 toRemoteDevicesOnSameAccount:v53 addedUser:0];
  [(HMDHomeManager *)self _pushChangesForHome:v6 toRegularUsersOfHome:v49 adminUsersOfHome:v48];

  v46 = *MEMORY[0x277D85DE8];
}

- (void)_pushChangesToUsersThatHaveNotAcknowledged
{
  v2 = self;
  v33 = *MEMORY[0x277D85DE8];
  v22 = 0u;
  v23 = 0u;
  v24 = 0u;
  v25 = 0u;
  obj = [(HMDHomeManager *)self pendingDataSyncAcks];
  v3 = [obj countByEnumeratingWithState:&v22 objects:v32 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = *v23;
    v6 = 0x277CCA000uLL;
    v20 = v2;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v23 != v5)
        {
          objc_enumerationMutation(obj);
        }

        v8 = *(*(&v22 + 1) + 8 * i);
        v9 = [objc_alloc(*(v6 + 3448)) initWithUUIDString:v8];
        v10 = [(HMDHomeManager *)v2 _homeWithUUID:v9];
        if (v10)
        {
          v11 = [(HMDHomeManager *)v2 pendingDataSyncAcks];
          v12 = [v11 objectForKeyedSubscript:v8];

          v13 = objc_autoreleasePoolPush();
          v14 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v14, OS_LOG_TYPE_DEFAULT))
          {
            HMFGetLogIdentifier();
            v15 = v4;
            v16 = v5;
            v18 = v17 = v6;
            *buf = 138543874;
            v27 = v18;
            v28 = 2112;
            v29 = v10;
            v30 = 2112;
            v31 = v12;
            _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_DEFAULT, "%{public}@Re-pushing home configuration for home %@ to users %@", buf, 0x20u);

            v6 = v17;
            v5 = v16;
            v4 = v15;
            v2 = v20;
          }

          objc_autoreleasePoolPop(v13);
          [(HMDHomeManager *)v2 _pushChangesToUsers:v12 forHome:v10];
        }
      }

      v4 = [obj countByEnumeratingWithState:&v22 objects:v32 count:16];
    }

    while (v4);
  }

  v19 = *MEMORY[0x277D85DE8];
}

- (void)_pushChangesToAllUsersOfAllHomes
{
  v26 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self sharedHomesPushDelayTimer];
  [v3 suspend];

  if (!isWatch())
  {
    [(HMDHomeManager *)self _scheduleSendHomeDataToAllWatches];
    v4 = [MEMORY[0x277CFEC78] systemStore];
    v23 = 0;
    v24 = 0;
    [v4 getControllerPublicKey:0 secretKey:0 username:&v24 allowCreation:0 error:&v23];
    v5 = v24;
    v6 = v23;

    v7 = [(HMDHomeManager *)self pendingDataSyncAcks];
    [v7 removeAllObjects];

    v8 = [(HMDHomeManager *)self pendingDataSyncAcks];
    v9 = [HMDPersistentStore archiveIDSDataSyncJournal:v8];

    v21 = 0u;
    v22 = 0u;
    v19 = 0u;
    v20 = 0u;
    v10 = [(HMDHomeManager *)self homes];
    v11 = [v10 countByEnumeratingWithState:&v19 objects:v25 count:16];
    if (v11)
    {
      v12 = v11;
      v13 = *v20;
      do
      {
        for (i = 0; i != v12; ++i)
        {
          if (*v20 != v13)
          {
            objc_enumerationMutation(v10);
          }

          v15 = *(*(&v19 + 1) + 8 * i);
          v16 = [v15 ownerName];
          v17 = [v16 isEqualToString:v5];

          if (v17)
          {
            [(HMDHomeManager *)self _pushChangesToUsers:0 forHome:v15];
            [(HMDHomeManager *)self _pushUserRemovedForHome:v15];
          }
        }

        v12 = [v10 countByEnumeratingWithState:&v19 objects:v25 count:16];
      }

      while (v12);
    }
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (id)_pushChangesToAllUsersOfAllHomesForMigration
{
  if (isWatch())
  {
    v3 = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  else
  {
    v8 = 0;
    v3 = [MEMORY[0x277D0F7C0] futureWithPromise:&v8];
    v4 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __62__HMDHomeManager__pushChangesToAllUsersOfAllHomesForMigration__block_invoke;
    block[3] = &unk_2797359B0;
    block[4] = self;
    v7 = v8;
    dispatch_async(v4, block);
  }

  return v3;
}

void __62__HMDHomeManager__pushChangesToAllUsersOfAllHomesForMigration__block_invoke(uint64_t a1)
{
  v35 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) sharedHomesPushDelayTimer];
  [v2 suspend];

  if (isiOSDevice())
  {
    v3 = [*(a1 + 32) homes];
    [v3 hmf_enumerateWithAutoreleasePoolUsingBlock:&__block_literal_global_743];

    v4 = *(a1 + 32);
    v30[0] = MEMORY[0x277D85DD0];
    v30[1] = 3221225472;
    v30[2] = __62__HMDHomeManager__pushChangesToAllUsersOfAllHomesForMigration__block_invoke_3;
    v30[3] = &unk_2797359B0;
    v30[4] = v4;
    v31 = *(a1 + 40);
    [v4 _sendHomeDataToAllWatchesMigrateToHH2:1 completionHandler:v30];
  }

  else
  {
    v5 = objc_autoreleasePoolPush();
    v6 = *(a1 + 32);
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      *buf = 138543362;
      v34 = v8;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Skip pushing home data to watches since this device is not a companion", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 40) fulfillWithNoValue];
  }

  v9 = [MEMORY[0x277CFEC78] systemStore];
  v28 = 0;
  v29 = 0;
  [v9 getControllerPublicKey:0 secretKey:0 username:&v29 allowCreation:0 error:&v28];
  v10 = v29;
  v11 = v28;

  v12 = [*(a1 + 32) pendingDataSyncAcks];
  [v12 removeAllObjects];

  v13 = [*(a1 + 32) pendingDataSyncAcks];
  v14 = [HMDPersistentStore archiveIDSDataSyncJournal:v13];

  v26 = 0u;
  v27 = 0u;
  v24 = 0u;
  v25 = 0u;
  v15 = [*(a1 + 32) homes];
  v16 = [v15 countByEnumeratingWithState:&v24 objects:v32 count:16];
  if (v16)
  {
    v17 = v16;
    v18 = *v25;
    do
    {
      for (i = 0; i != v17; ++i)
      {
        if (*v25 != v18)
        {
          objc_enumerationMutation(v15);
        }

        v20 = *(*(&v24 + 1) + 8 * i);
        v21 = [v20 ownerName];
        v22 = [v21 isEqualToString:v10];

        if (v22)
        {
          [*(a1 + 32) _archiveSyncDataForHome:v20];
          [*(a1 + 32) _pushUserRemovedForHome:v20];
        }
      }

      v17 = [v15 countByEnumeratingWithState:&v24 objects:v32 count:16];
    }

    while (v17);
  }

  v23 = *MEMORY[0x277D85DE8];
}

uint64_t __62__HMDHomeManager__pushChangesToAllUsersOfAllHomesForMigration__block_invoke_3(uint64_t a1)
{
  v10 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    v8 = 138543362;
    v9 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Finished attempt to push home data to all watches", &v8, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  result = [*(a1 + 40) fulfillWithNoValue];
  v7 = *MEMORY[0x277D85DE8];
  return result;
}

- (void)_schedulePushChangesToAllUsersOfAllHomes
{
  v10 = *MEMORY[0x277D85DE8];
  if (+[HMDDeviceCapabilities supportsSyncingToSharedUsers])
  {
    v3 = [(HMDHomeManager *)self sharedHomesPushDelayTimer];
    [v3 resume];

    v4 = objc_autoreleasePoolPush();
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v8 = 138543362;
      v9 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Kicking shared home push delay", &v8, 0xCu);
    }

    objc_autoreleasePoolPop(v4);
  }

  v7 = *MEMORY[0x277D85DE8];
}

- (id)_userPushCachedGetDeviceForUser:(id)a3
{
  v4 = a3;
  v5 = [v4 uuid];

  if (!v5)
  {
    v11 = 0;
    goto LABEL_9;
  }

  v6 = [(HMDHomeManager *)self userPushCacheMap];
  v7 = [v4 uuid];
  v8 = [v6 objectForKeyedSubscript:v7];

  if (v8)
  {
    if (![v8 isExpired])
    {
      v11 = [v8 device];
      goto LABEL_8;
    }

    v9 = [(HMDHomeManager *)self userPushCacheMap];
    v10 = [v4 uuid];
    [v9 setObject:0 forKeyedSubscript:v10];
  }

  v11 = 0;
LABEL_8:

LABEL_9:

  return v11;
}

- (void)_updateUserPushCachedForUser:(id)a3 device:(id)a4
{
  v23 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v8 = [v6 uuid];

  if (v7 && v8)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [v6 userID];
      v17 = 138543874;
      v18 = v11;
      v19 = 2112;
      v20 = v12;
      v21 = 2112;
      v22 = v7;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Caching destination device for %@ to %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v9);
    v13 = [[HMDUserPushCache alloc] initWithDevice:v7];
    v14 = [(HMDHomeManager *)self userPushCacheMap];
    v15 = [v6 uuid];
    [v14 setObject:v13 forKeyedSubscript:v15];
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)updateUserPushCachedForUser:(id)a3 device:(id)a4
{
  v6 = a3;
  v7 = a4;
  v8 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __53__HMDHomeManager_updateUserPushCachedForUser_device___block_invoke;
  block[3] = &unk_279734960;
  block[4] = self;
  v12 = v6;
  v13 = v7;
  v9 = v7;
  v10 = v6;
  dispatch_async(v8, block);
}

- (void)_pushMetadataToCloud
{
  [(HMDHomeManager *)self setUploadMetadataToCloud:1];

  [(HMDHomeManager *)self _pushChangesToCloud:0 withDelay:0.0];
}

- (void)_performPostSaveRequestActionsWithRequest:(id)a3
{
  v19 = a3;
  v4 = [v19 reason];
  v5 = [HMDHomeManager convertSaveReasonToTransactionReason:v4];

  if (([v19 saveOptions] & 2) != 0)
  {
    v6 = [v19 reason];
    [(HMDHomeManager *)self assistantSyncDataChanged:v6];
  }

  if ([v19 saveOptions])
  {
    [(HMDHomeManager *)self setUploadHomeDataToCloud:1];
    v7 = [v19 reason];
    v8 = [v7 isEqual:@"MetadataUpdate"];

    if (v8)
    {
      [(HMDHomeManager *)self setUploadMetadataToCloud:1];
    }

    v9 = [(HMDHomeManager *)self logEventSubmitter];
    v10 = [HMDCloudSyncUploadReasonLogEvent uploadReason:v5 acceptedLegacyPush:1];
    [v9 submitLogEvent:v10];

    [(HMDHomeManager *)self _pushChangesToCloud:0 withDelay:v5 reason:0.0];
    if ([v19 objectChange])
    {
      v11 = [v19 home];

      if (v11)
      {
        v12 = [(HMDHomeManager *)self logEventSubmitter];
        v13 = [HMDCloudSyncUploadReasonLogEvent uploadReason:v5 acceptedHomeZonePush:1];
        [v12 submitLogEvent:v13];

        v14 = [v19 home];
        [(HMDHomeManager *)self _uploadHomeToCloud:v14 withDelay:0.0];
      }
    }
  }

  v15 = [v19 reason];
  v16 = [HMDHomeManager doesSaveReasonAffectHomeManager:v15];

  if (v16)
  {
    v17 = [(HMDHomeManager *)self logEventSubmitter];
    v18 = [HMDCloudSyncUploadReasonLogEvent uploadReason:v5 acceptedHomeManagerZonePush:1];
    [v17 submitLogEvent:v18];

    [(HMDHomeManager *)self _uploadHomeManagerToCloudWithDelay:0.0];
  }
}

- (void)performPostSaveRequestActionsWithRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __59__HMDHomeManager_performPostSaveRequestActionsWithRequest___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)performPostSaveRequestActionsWithReason:(id)a3
{
  v4 = a3;
  v5 = [[HMDHomeSaveRequest alloc] initWithReason:v4 information:0 postSyncNotification:0];

  [(HMDHomeManager *)self performPostSaveRequestActionsWithRequest:v5];
}

- (void)_saveWithRequest:(id)a3
{
  v29 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v6 = [v5 isLocalDataDecryptionFailed];

  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [v4 reason];
      v25 = 138543618;
      v26 = v10;
      v27 = 2112;
      v28 = v11;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping save because local data failed to decrypt: %@", &v25, 0x16u);

LABEL_15:
      goto LABEL_16;
    }

    goto LABEL_16;
  }

  v12 = [v4 reason];
  v13 = [HMDHomeManager doesSaveReasonNotAffectLocalData:v12];

  if (!v13)
  {
    v14 = objc_autoreleasePoolPush();
    v15 = self;
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_DEFAULT))
    {
      v17 = HMFGetLogIdentifier();
      v18 = [v4 reason];
      v25 = 138543618;
      v26 = v17;
      v27 = 2112;
      v28 = v18;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_DEFAULT, "%{public}@Saving to persistent store due to reason: %@", &v25, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
    v19 = [(HMDHomeManager *)v15 backingStore];
    v20 = [v4 reason];
    v21 = v20;
    if (v20)
    {
      v22 = v20;
    }

    else
    {
      v22 = @"unknown";
    }

    [v19 saveToPersistentStoreWithReason:v22 incrementGeneration:{objc_msgSend(v4, "incrementGeneration")}];
  }

  v23 = [v4 reason];

  if (!v23)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      v25 = 138543362;
      v26 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@Save reason must be specified to process further", &v25, 0xCu);
      goto LABEL_15;
    }

LABEL_16:

    objc_autoreleasePoolPop(v7);
    goto LABEL_17;
  }

  [(HMDHomeManager *)self _performPostSaveRequestActionsWithRequest:v4];
LABEL_17:

  v24 = *MEMORY[0x277D85DE8];
}

- (void)saveWithRequest:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __34__HMDHomeManager_saveWithRequest___block_invoke;
  v7[3] = &unk_2797359B0;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

- (void)_saveWithReason:(id)a3 information:(id)a4 saveOptions:(unint64_t)a5
{
  v8 = a4;
  v9 = a3;
  v10 = [[HMDHomeSaveRequest alloc] initWithReason:v9 information:v8 saveOptions:a5];

  [(HMDHomeManager *)self _saveWithRequest:v10];
}

- (void)_handleSaveRequest:(id)a3
{
  v8 = a3;
  v4 = [v8 userInfo];
  if (v4)
  {
    v5 = [v8 userInfo];
    v6 = [v5 objectForKeyedSubscript:@"HMDHomeManagerSaveReasonKey"];

    if (v6)
    {
      v7 = [v8 userInfo];
      v4 = [v7 hmf_stringForKey:@"HMDHomeManagerSaveReasonKey"];
    }

    else
    {
      v4 = 0;
    }
  }

  [(HMDHomeManager *)self _saveWithReason:v4 information:0 saveOptions:0];
}

- (int64_t)numberOfAccessoryWithNewFirmwareAvailable
{
  v16 = *MEMORY[0x277D85DE8];
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
  if (v3)
  {
    v4 = v3;
    v5 = 0;
    v6 = *v12;
    do
    {
      for (i = 0; i != v4; ++i)
      {
        if (*v12 != v6)
        {
          objc_enumerationMutation(v2);
        }

        v8 = [*(*(&v11 + 1) + 8 * i) namesOfServicesWithNewFirmwareAvailableInHome];
        v5 += [v8 count];
      }

      v4 = [v2 countByEnumeratingWithState:&v11 objects:v15 count:16];
    }

    while (v4);
  }

  else
  {
    v5 = 0;
  }

  v9 = *MEMORY[0x277D85DE8];
  return v5;
}

- (id)_homeDataForPersistentStoreIncrementingGeneration:(BOOL)a3 reason:(id)a4
{
  v4 = a3;
  v54 = *MEMORY[0x277D85DE8];
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  if (v6 && [HMDHomeManager doesSaveReasonAffectOnlyLocalData:v6]&& [HMDHomeManager doesSaveReasonRequireForceSyncToWatch:v6])
  {
    [(HMDHomeManager *)self _scheduleSendHomeDataToAllWatches];
  }

  context = v7;
  if (v4)
  {
    v8 = [(HMDHomeManager *)self uuid];
    [(HMDHomeManager *)self updateGenerationCounterWithReason:v6 sourceUUID:v8 shouldNotifyClients:0];
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    v10 = self;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543618;
      v51 = v12;
      v52 = 2112;
      v53 = v6;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Saving to persistent store. NOT INCREMENTING GENERATION COUNTER for reason %@.", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = [(HMDHomeManager *)self pairedAccessories];
  v14 = +[HMDUserManagementOperationManager sharedManager];
  v15 = [v14 operations];

  v16 = objc_alloc_init(HMDMutableHomeData);
  v17 = [(HMDHomeManager *)self homes];
  [(HMDHomeData *)v16 setHomes:v17];

  [(HMDHomeData *)v16 setAccessories:v13];
  v18 = [(HMDHomeManager *)self primaryHomeUUID];
  [(HMDHomeData *)v16 setPrimaryHomeUUID:v18];

  v19 = [(HMDHomeManager *)self lastCurrentHomeUUID];
  [(HMDHomeData *)v16 setLastCurrentHomeUUID:v19];

  [(HMDHomeData *)v16 setDataVersion:4];
  [(HMDHomeData *)v16 setSchemaVersion:5];
  [(HMDHomeData *)v16 setRecoveryVersion:[(HMDHomeManager *)self recoveryVersion]];
  v20 = [(HMDHomeManager *)self dataTag];
  [(HMDHomeData *)v16 setDataTag:v20];

  v21 = [(HMDHomeManager *)self uuidsOfRemovedHomes];
  [(HMDHomeData *)v16 setUUIDsOfRemovedHomes:v21];

  v22 = [(HMDHomeManager *)self cloudZones];
  [(HMDHomeData *)v16 setCloudZones:v22];

  v23 = [(HMDHomeManager *)self incomingInvitations];
  [(HMDHomeData *)v16 setIncomingInvitations:v23];

  v24 = [(HMDHomeManager *)self appleAccountManager];
  v25 = [v24 device];
  v26 = [v25 identifier];
  v27 = [v26 UUIDString];
  [(HMDHomeData *)v16 setCurrentDevice:v27];

  [(HMDHomeData *)v16 setPendingUserManagementOperations:v15];
  v28 = [(HMDHomeManager *)self unprocessedOperationModelIdentifiers];
  v29 = [v28 allObjects];
  [(HMDHomeData *)v16 setUnprocessedOperationIdentifiers:v29];

  v30 = [(HMDHomeManager *)self appData];
  [(HMDHomeData *)v16 setApplicationData:v30];

  [(HMDHomeData *)v16 setResidentEnabledState:[(HMDHomeManager *)self residentEnabledState]];
  [(HMDHomeData *)v16 setAccessAllowedWhenLocked:[(HMDHomeManager *)self isAccessAllowedWhenLocked]];
  v31 = [(HMDHomeManager *)self demoAccessories];
  [(HMDHomeData *)v16 setDemoAccessories:v31];

  [(HMDHomeData *)v16 setDemoFinalized:[(HMDHomeManager *)self demoFinalized]];
  v32 = [(HMDHomeManager *)self appleAccountManager];
  v33 = [v32 account];

  if ([v33 shouldCache])
  {
    [(HMDHomeData *)v16 setAccount:v33];
    v34 = [v33 primaryHandle];
    [(HMDHomeData *)v16 setPrimaryAccountHandle:v34];
  }

  v35 = [MEMORY[0x277CBEB18] array];
  v45 = 0u;
  v46 = 0u;
  v47 = 0u;
  v48 = 0u;
  v36 = [(HMDHomeManager *)self remoteAccountManager];
  v37 = [v36 countByEnumeratingWithState:&v45 objects:v49 count:16];
  if (v37)
  {
    v38 = v37;
    v39 = *v46;
    do
    {
      for (i = 0; i != v38; ++i)
      {
        if (*v46 != v39)
        {
          objc_enumerationMutation(v36);
        }

        v41 = *(*(&v45 + 1) + 8 * i);
        if ([v41 shouldCache])
        {
          [v35 addObject:v41];
        }
      }

      v38 = [v36 countByEnumeratingWithState:&v45 objects:v49 count:16];
    }

    while (v38);
  }

  if (v35)
  {
    [(HMDHomeData *)v16 setRemoteAccounts:v35];
  }

  objc_autoreleasePoolPop(context);
  v42 = *MEMORY[0x277D85DE8];

  return v16;
}

void __71__HMDHomeManager__dataForPersistentStoreIncrementingGeneration_reason___block_invoke(uint64_t a1)
{
  if ([*(a1 + 32) _updateAccessoriesConfigured])
  {
    v2 = *(a1 + 32);

    [(HMDHomeManager *)v2 _postPreferencesChangedNotification];
  }
}

- (BOOL)hasHAPAccessoryInAnyHome
{
  v15 = *MEMORY[0x277D85DE8];
  v10 = 0u;
  v11 = 0u;
  v12 = 0u;
  v13 = 0u;
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 countByEnumeratingWithState:&v10 objects:v14 count:16];
  if (v3)
  {
    v4 = *v11;
    while (2)
    {
      for (i = 0; i != v3; ++i)
      {
        if (*v11 != v4)
        {
          objc_enumerationMutation(v2);
        }

        v6 = [*(*(&v10 + 1) + 8 * i) hapAccessories];
        v7 = [v6 count];

        if (v7)
        {
          LOBYTE(v3) = 1;
          goto LABEL_11;
        }
      }

      v3 = [v2 countByEnumeratingWithState:&v10 objects:v14 count:16];
      if (v3)
      {
        continue;
      }

      break;
    }
  }

LABEL_11:

  v8 = *MEMORY[0x277D85DE8];
  return v3;
}

- (id)pairedAccessories
{
  v17 = *MEMORY[0x277D85DE8];
  v3 = [MEMORY[0x277CBEB18] array];
  v12 = 0u;
  v13 = 0u;
  v14 = 0u;
  v15 = 0u;
  v4 = [(HMDHomeManager *)self homes];
  v5 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
  if (v5)
  {
    v6 = v5;
    v7 = *v13;
    do
    {
      for (i = 0; i != v6; ++i)
      {
        if (*v13 != v7)
        {
          objc_enumerationMutation(v4);
        }

        v9 = [*(*(&v12 + 1) + 8 * i) accessories];
        [v3 addObjectsFromArray:v9];
      }

      v6 = [v4 countByEnumeratingWithState:&v12 objects:v16 count:16];
    }

    while (v6);
  }

  v10 = *MEMORY[0x277D85DE8];

  return v3;
}

- (id)accessoriesMatchingIdentifier:(id)a3
{
  v31 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    v5 = [MEMORY[0x277CBEB18] array];
    v25 = 0u;
    v26 = 0u;
    v27 = 0u;
    v28 = 0u;
    obj = [(HMDHomeManager *)self homes];
    v20 = [obj countByEnumeratingWithState:&v25 objects:v30 count:16];
    if (v20)
    {
      v19 = *v26;
      do
      {
        for (i = 0; i != v20; ++i)
        {
          if (*v26 != v19)
          {
            objc_enumerationMutation(obj);
          }

          v7 = *(*(&v25 + 1) + 8 * i);
          v21 = 0u;
          v22 = 0u;
          v23 = 0u;
          v24 = 0u;
          v8 = [v7 accessories];
          v9 = [v8 countByEnumeratingWithState:&v21 objects:v29 count:16];
          if (v9)
          {
            v10 = v9;
            v11 = *v22;
            do
            {
              for (j = 0; j != v10; ++j)
              {
                if (*v22 != v11)
                {
                  objc_enumerationMutation(v8);
                }

                v13 = *(*(&v21 + 1) + 8 * j);
                v14 = [v13 identifier];
                v15 = [v4 isEqual:v14];

                if (v15)
                {
                  [v5 addObject:v13];
                }
              }

              v10 = [v8 countByEnumeratingWithState:&v21 objects:v29 count:16];
            }

            while (v10);
          }
        }

        v20 = [obj countByEnumeratingWithState:&v25 objects:v30 count:16];
      }

      while (v20);
    }
  }

  else
  {
    v5 = MEMORY[0x277CBEBF8];
  }

  v16 = *MEMORY[0x277D85DE8];

  return v5;
}

- (NSDate)lastSoftwareUpdateDate
{
  v2 = [(HMDHomeManager *)self metricsManager];
  v3 = [v2 deviceStateManager];
  v4 = [v3 lastSoftwareUpdateDate];

  return v4;
}

- (BOOL)isActive
{
  v2 = [(HMDHomeManager *)self connectionsManager];
  v3 = [v2 hasActiveConnections];

  return v3;
}

- (void)handleAccountSettingsUpdate:(id)a3
{
  v4 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __46__HMDHomeManager_handleAccountSettingsUpdate___block_invoke;
  block[3] = &unk_279735D00;
  block[4] = self;
  dispatch_async(v4, block);
}

void __46__HMDHomeManager_handleAccountSettingsUpdate___block_invoke(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_INFO))
  {
    v5 = HMFGetLogIdentifier();
    *buf = 138543362;
    v22 = v5;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_INFO, "%{public}@Received notification that account settings updated", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v2);
  v6 = +[HMDAppleAccountSettings sharedSettings];
  if (([v6 isManaged] & 1) != 0 || objc_msgSend(v6, "isMultiUser"))
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 32);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543362;
      v22 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Current account is EDU account, erasing local data", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v11 = [MEMORY[0x277CFEC78] systemStore];
    v19 = 0;
    v20 = 0;
    v12 = [v11 getCurrentiCloudIdentifier:0 controllerPairingIdentifier:&v20 error:&v19];
    v13 = v20;
    v14 = v19;
    v15 = v14;
    if (v12 && v13)
    {
      v18 = v14;
      [v11 removeControllerKeyPairForIdentifier:v13 leaveTombstone:0 error:&v18];
      v16 = v18;

      [*(a1 + 32) _eraseLocalHomeConfiguration];
      v15 = v16;
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_setAccountAvailabilityChanged
{
  objc_initWeak(&location, self);
  v3 = [(HMDHomeManager *)self cloudAccount];
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __48__HMDHomeManager__setAccountAvailabilityChanged__block_invoke;
  v4[3] = &unk_279731A28;
  objc_copyWeak(&v5, &location);
  [v3 addAccountOperation:v4];

  objc_destroyWeak(&v5);
  objc_destroyWeak(&location);
}

void __48__HMDHomeManager__setAccountAvailabilityChanged__block_invoke(uint64_t a1, void *a2)
{
  v13 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = WeakRetained;
  if (WeakRetained)
  {
    if (([WeakRetained cloudkitAccountStatusDetermined] & 1) == 0)
    {
      [v5 _handleAccountAvailabilityChanged:v3];
      goto LABEL_9;
    }

    v6 = objc_autoreleasePoolPush();
    v7 = v5;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v11 = 138543362;
      v12 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@CloudKit account status has been determined", &v11, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
  }

  if (v3)
  {
    v3[2](v3);
  }

LABEL_9:

  v10 = *MEMORY[0x277D85DE8];
}

- (void)accountAvailabilityChanged:(id)a3
{
  v15 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v9 = [v4 name];
    v11 = 138543618;
    v12 = v8;
    v13 = 2114;
    v14 = v9;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Received account availability changed notification: %{public}@", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)v6 fetchAndUpdatePCSStatus];
  [(HMDHomeManager *)v6 _accountAvailabilityChanged:0];

  v10 = *MEMORY[0x277D85DE8];
}

- (void)fetchAndUpdatePCSStatus
{
  v3 = getCKContainer();
  v4[0] = MEMORY[0x277D85DD0];
  v4[1] = 3221225472;
  v4[2] = __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke;
  v4[3] = &unk_279731A00;
  v4[4] = self;
  [v3 accountInfoWithCompletionHandler:v4];
}

void __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  v7 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke_2;
  block[3] = &unk_279734960;
  v8 = *(a1 + 32);
  v12 = v5;
  v13 = v8;
  v14 = v6;
  v9 = v6;
  v10 = v5;
  dispatch_async(v7, block);
}

void __41__HMDHomeManager_fetchAndUpdatePCSStatus__block_invoke_2(uint64_t a1)
{
  v23 = *MEMORY[0x277D85DE8];
  if (*(a1 + 32))
  {
    v2 = [*(a1 + 40) pcsEnabled];
    [*(a1 + 40) setPcsEnabled:{(objc_msgSend(*(a1 + 32), "deviceToDeviceEncryptionAvailability") >> 1) & 1}];
    if ([*(a1 + 40) pcsEnabled])
    {
      v3 = *(*(a1 + 40) + 16);
      if (os_signpost_enabled(v3))
      {
        LOWORD(v17) = 0;
        _os_signpost_emit_with_name_impl(&dword_2531F8000, v3, OS_SIGNPOST_EVENT, 0xEEEEB0B5B2B2EEEELL, "ManateeAvailable", "", &v17, 2u);
      }
    }

    v4 = objc_autoreleasePoolPush();
    v5 = *(a1 + 40);
    v6 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
    {
      v7 = HMFGetLogIdentifier();
      v8 = [*(a1 + 40) pcsEnabled];
      v9 = @"Disabled";
      if (v8)
      {
        v10 = @"Enabled";
      }

      else
      {
        v10 = @"Disabled";
      }

      v17 = 138543874;
      v18 = v7;
      v20 = v10;
      v19 = 2112;
      if (v2)
      {
        v9 = @"Enabled";
      }

      v21 = 2112;
      v22 = v9;
      _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Current PCS status: %@, Old PCS Status: %@", &v17, 0x20u);
    }

    objc_autoreleasePoolPop(v4);
    if (v2 != [*(a1 + 40) pcsEnabled])
    {
      logAndPostNotification(@"HMDHomeManagerPCSStatusChangedNotification", *(a1 + 40), 0);
    }
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 40);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v15 = *(a1 + 48);
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v15;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Failed to fetch account info: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
  }

  v16 = *MEMORY[0x277D85DE8];
}

- (void)_registerHH1EOLMessageFilter
{
  v12 = *MEMORY[0x277D85DE8];
  if ([(HMDHomeManager *)self isHH1EOLEnabled])
  {
    v3 = objc_autoreleasePoolPush();
    v4 = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_DEBUG))
    {
      v6 = HMFGetLogIdentifier();
      v10 = 138543362;
      v11 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEBUG, "%{public}@Registering HH1 EOL message filter", &v10, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    v7 = [(HMDMessageFilter *)[HMDHH1EOLMessageFilter alloc] initWithName:@"HH1EOL"];
    v8 = [(HMDHomeManager *)v4 msgFilterChain];
    [v8 addMessageFilter:v7];
  }

  v9 = *MEMORY[0x277D85DE8];
}

- (void)_accountAvailabilityChanged:(BOOL)a3
{
  objc_initWeak(&location, self);
  v5 = [(HMDHomeManager *)self workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __46__HMDHomeManager__accountAvailabilityChanged___block_invoke;
  block[3] = &unk_2797319D8;
  objc_copyWeak(&v7, &location);
  v8 = a3;
  dispatch_async(v5, block);

  objc_destroyWeak(&v7);
  objc_destroyWeak(&location);
}

void __46__HMDHomeManager__accountAvailabilityChanged___block_invoke(uint64_t a1)
{
  v28 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    if ([WeakRetained cloudkitAccountStatusDetermined])
    {
      v4 = objc_autoreleasePoolPush();
      v5 = v3;
      v6 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v7 = HMFGetLogIdentifier();
        v24 = 138543362;
        v25 = v7;
        v8 = "%{public}@CloudKit account status has already been determined";
        v9 = v6;
        v10 = 12;
LABEL_13:
        _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, v8, &v24, v10);

        goto LABEL_14;
      }

      goto LABEL_14;
    }

    if (*(a1 + 40) == 1)
    {
      v11 = maxCloudOperationRetries;
      v12 = +[HMDDeviceCapabilities deviceCapabilities];
      v13 = [v12 supportsStandaloneMode];

      if (v13)
      {
        v14 = v11 / 2;
      }

      else
      {
        v14 = v11;
      }

      if (v14 < 1 || [v3 cloudOperationRetryCount] < v14)
      {
        v4 = objc_autoreleasePoolPush();
        v5 = v3;
        v6 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
        {
          v7 = HMFGetLogIdentifier();
          v24 = 138543618;
          v25 = v7;
          v26 = 2048;
          v27 = [v5 cloudOperationRetryCount];
          v8 = "%{public}@Not scheduling account status operation with push notification because already in retry %lu";
          v9 = v6;
          v10 = 22;
          goto LABEL_13;
        }

LABEL_14:

        objc_autoreleasePoolPop(v4);
        goto LABEL_24;
      }

      if (v14 == 1)
      {
        v22 = 0;
      }

      else
      {
        v22 = v14 - 2;
      }

      [v3 setCloudOperationRetryCount:v22];
      v15 = objc_autoreleasePoolPush();
      v16 = v3;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        v24 = 138543618;
        v25 = v18;
        v26 = 2048;
        v27 = [v16 cloudOperationRetryCount];
        v19 = "%{public}@Setting retry count to %lu, scheduling account status operation";
        v20 = v17;
        v21 = 22;
        goto LABEL_22;
      }
    }

    else
    {
      v15 = objc_autoreleasePoolPush();
      v16 = v3;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        v24 = 138543362;
        v25 = v18;
        v19 = "%{public}@Scheduling account status operation";
        v20 = v17;
        v21 = 12;
LABEL_22:
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_INFO, v19, &v24, v21);
      }
    }

    objc_autoreleasePoolPop(v15);
    [v16 _setAccountAvailabilityChanged];
  }

LABEL_24:

  v23 = *MEMORY[0x277D85DE8];
}

- (void)startWithCompletionHandler:(id)a3
{
  v4 = a3;
  v5 = [(HMDHomeManager *)self workQueue];
  v7[0] = MEMORY[0x277D85DD0];
  v7[1] = 3221225472;
  v7[2] = __45__HMDHomeManager_startWithCompletionHandler___block_invoke;
  v7[3] = &unk_279735738;
  v7[4] = self;
  v8 = v4;
  v6 = v4;
  dispatch_async(v5, v7);
}

void __45__HMDHomeManager_startWithCompletionHandler___block_invoke(uint64_t a1)
{
  v40 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) appleAccountManager];
  v3 = [v2 device];

  if (v3)
  {
    v4 = [*(a1 + 32) capabilitiesController];
    v5 = [v4 currentResidentCapabilities];
    if (v5)
    {
      v6 = v5;
      v7 = [*(a1 + 32) residentEnabledState];

      if (!v7)
      {
        v8 = [v3 productInfo];
        v9 = [v8 productClass];

        if (v9 == 3)
        {
          v35 = 0u;
          v36 = 0u;
          v33 = 0u;
          v34 = 0u;
          v10 = [*(a1 + 32) homes];
          v11 = [v10 countByEnumeratingWithState:&v33 objects:v39 count:16];
          if (v11)
          {
            v12 = *v34;
            while (2)
            {
              for (i = 0; i != v11; ++i)
              {
                if (*v34 != v12)
                {
                  objc_enumerationMutation(v10);
                }

                v14 = *(*(&v33 + 1) + 8 * i);
                if ([v14 isOwnerUser])
                {
                  v15 = [v14 residentCapableDevices];
                  v16 = [v15 containsObject:v3];

                  if (v16)
                  {
                    v17 = objc_autoreleasePoolPush();
                    v18 = *(a1 + 32);
                    v19 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v19, OS_LOG_TYPE_INFO))
                    {
                      v20 = HMFGetLogIdentifier();
                      *buf = 138543362;
                      v38 = v20;
                      _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_INFO, "%{public}@Found ourselves as a resident in one or more homes, enabling ourselves as a resident device", buf, 0xCu);
                    }

                    objc_autoreleasePoolPop(v17);
                    v11 = 1;
                    goto LABEL_20;
                  }
                }
              }

              v11 = [v10 countByEnumeratingWithState:&v33 objects:v39 count:16];
              if (v11)
              {
                continue;
              }

              break;
            }
          }

LABEL_20:
        }

        else
        {
          v11 = 1;
        }

        [*(a1 + 32) _updateResidentEnabledOnThisDevice:v11 forceNotify:0 message:0];
      }
    }

    else
    {
    }
  }

  v21 = *(a1 + 32);
  if (v21[104])
  {
    v22 = [v21 notificationCenter];
    [v22 addObserver:*(a1 + 32) selector:sel___handleWatchConnected_ name:@"HMDWatcherManagerWatchConnectedNotification" object:*(*(a1 + 32) + 832)];

    v23 = [*(a1 + 32) notificationCenter];
    [v23 addObserver:*(a1 + 32) selector:sel___handleWatchDisconnected_ name:@"HMDWatcherManagerWatchDisconnectedNotification" object:*(*(a1 + 32) + 832)];

    [*(a1 + 32) _checkAndAddWatchDevicesWithResend:0];
    v21 = *(a1 + 32);
  }

  v24 = [MEMORY[0x277CCABB0] numberWithBool:{objc_msgSend(v21, "isHH1EOLEnabled")}];
  [*(a1 + 32) setLastKnownIsHH1EOLEnabled:v24];

  [*(a1 + 32) _registerHH1EOLMessageFilter];
  v25 = *(a1 + 32);
  if (v25[38])
  {
    v26 = [v25 notificationCenter];
    [v26 addObserver:*(a1 + 32) selector:sel___handleCompanionUpdated_ name:@"HMDCompanionManagerUpdatedCompanionNotification" object:*(*(a1 + 32) + 304)];

    [*(a1 + 32) _checkAndInformCompanionDevice];
    v25 = *(a1 + 32);
  }

  v27 = [v25 chipXPCListener];
  [v27 start];

  v28 = *(a1 + 40);
  if (v28)
  {
    (*(v28 + 16))();
  }

  [*(a1 + 32) registerForXPCClientConnectionMessages];
  v29 = dispatch_walltime(0, 300000000000);
  v30 = [*(a1 + 32) workQueue];
  block[0] = MEMORY[0x277D85DD0];
  block[1] = 3221225472;
  block[2] = __45__HMDHomeManager_startWithCompletionHandler___block_invoke_672;
  block[3] = &unk_279735D00;
  block[4] = *(a1 + 32);
  dispatch_after(v29, v30, block);

  v31 = *MEMORY[0x277D85DE8];
}

uint64_t __45__HMDHomeManager_startWithCompletionHandler___block_invoke_672(uint64_t a1)
{
  [*(a1 + 32) checkAndProcessHH2UpgradeRecommendation];
  v2 = *(a1 + 32);

  return [v2 postHH2AutoMigratedSuccessBulletinIfNeeded];
}

- (void)migrateModelObjectsToCloud:(int64_t)a3 schemaVersion:(int64_t)a4
{
  v183 = *MEMORY[0x277D85DE8];
  if (!isWatch())
  {
    v4 = [(HMDHomeManager *)self cloudDataSyncManager];

    if (v4)
    {
      v5 = objc_autoreleasePoolPush();
      v6 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
      {
        v7 = HMFGetLogIdentifier();
        *buf = 138543874;
        *&buf[4] = v7;
        *&buf[12] = 2048;
        *&buf[14] = a3;
        *&buf[22] = 2048;
        v182 = a4;
        _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Beginning migration from version %ld, schema %ld", buf, 0x20u);
      }

      objc_autoreleasePoolPop(v5);
      *buf = 0;
      *&buf[8] = buf;
      *&buf[16] = 0x2020000000;
      LOBYTE(v182) = 0;
      context = objc_autoreleasePoolPush();
      v126 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.v4-migrate."];
      objc_initWeak(&location, self);
      v8 = [(HMDHomeManager *)self homes];
      v9 = [v8 count];
      v11 = a4 < 4 && v9 != 0;

      if (v11)
      {
        v12 = MEMORY[0x277CBEB18];
        v13 = [(HMDHomeManager *)self homes];
        v129 = [v12 arrayWithCapacity:{objc_msgSend(v13, "count")}];

        v168 = 0u;
        v169 = 0u;
        v166 = 0u;
        v167 = 0u;
        v14 = [(HMDHomeManager *)self homes];
        v131 = [v14 countByEnumeratingWithState:&v166 objects:v180 count:16];
        if (!v131)
        {
          goto LABEL_53;
        }

        v128 = *v167;
        v134 = v14;
        while (1)
        {
          for (i = 0; i != v131; ++i)
          {
            if (*v167 != v128)
            {
              objc_enumerationMutation(v14);
            }

            v15 = *(*(&v166 + 1) + 8 * i);
            obj = v15;
            if (a3 <= 3)
            {
              [v15 setupBackingStore];
              v16 = objc_autoreleasePoolPush();
              v17 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
              {
                v18 = HMFGetLogIdentifier();
                v19 = [obj uuid];
                v20 = [v19 UUIDString];
                *v173 = 138543618;
                v174 = v18;
                v175 = 2112;
                v176 = v20;
                _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Migrating Home %@", v173, 0x16u);

                v14 = v134;
              }

              objc_autoreleasePoolPop(v16);
              v21 = [(HMDHomeManager *)self backingStore];
              v22 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
              v136 = [v21 transaction:@"homeMigration" options:v22];

              v23 = [obj backingStore];
              v24 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
              v135 = [v23 transaction:@"homeMigration" options:v24];

              if ([obj isOwnerUser])
              {
                v25 = [obj backingStoreObjects:4];
                v164 = 0u;
                v165 = 0u;
                v162 = 0u;
                v163 = 0u;
                v26 = v25;
                v27 = [v26 countByEnumeratingWithState:&v162 objects:v179 count:16];
                if (v27)
                {
                  v28 = *v163;
                  do
                  {
                    for (j = 0; j != v27; ++j)
                    {
                      if (*v163 != v28)
                      {
                        objc_enumerationMutation(v26);
                      }

                      v30 = *(*(&v162 + 1) + 8 * j);
                      objc_opt_class();
                      isKindOfClass = objc_opt_isKindOfClass();
                      v32 = objc_autoreleasePoolPush();
                      if (isKindOfClass)
                      {
                        v33 = HMFGetOSLogHandle();
                        if (os_log_type_enabled(v33, OS_LOG_TYPE_DEBUG))
                        {
                          v34 = HMFGetLogIdentifier();
                          v35 = [obj uuid];
                          v36 = [v35 UUIDString];
                          *v173 = 138543874;
                          v174 = v34;
                          v175 = 2112;
                          v176 = v36;
                          v177 = 2112;
                          v178 = v30;
                          _os_log_impl(&dword_2531F8000, v33, OS_LOG_TYPE_DEBUG, "%{public}@[Home Migration %@] Object Change (HomeManager Queue): %@", v173, 0x20u);

                          v14 = v134;
                        }

                        objc_autoreleasePoolPop(v32);
                        v37 = v136;
                      }

                      else
                      {
                        v38 = HMFGetOSLogHandle();
                        if (os_log_type_enabled(v38, OS_LOG_TYPE_DEBUG))
                        {
                          v39 = HMFGetLogIdentifier();
                          v40 = [obj uuid];
                          v41 = [v40 UUIDString];
                          *v173 = 138543874;
                          v174 = v39;
                          v175 = 2112;
                          v176 = v41;
                          v177 = 2112;
                          v178 = v30;
                          _os_log_impl(&dword_2531F8000, v38, OS_LOG_TYPE_DEBUG, "%{public}@[Home Migration %@] Object Change: %@", v173, 0x20u);

                          v14 = v134;
                        }

                        objc_autoreleasePoolPop(v32);
                        v37 = v135;
                      }

                      [v37 add:v30 withMessage:0];
                    }

                    v27 = [v26 countByEnumeratingWithState:&v162 objects:v179 count:16];
                  }

                  while (v27);
                }
              }

              else
              {
                v26 = [obj sharedHomeModel];
                v66 = objc_autoreleasePoolPush();
                v67 = HMFGetOSLogHandle();
                if (os_log_type_enabled(v67, OS_LOG_TYPE_DEBUG))
                {
                  v68 = HMFGetLogIdentifier();
                  v69 = [obj uuid];
                  v70 = [v69 UUIDString];
                  *v173 = 138543874;
                  v174 = v68;
                  v175 = 2112;
                  v176 = v70;
                  v177 = 2112;
                  v178 = v26;
                  _os_log_impl(&dword_2531F8000, v67, OS_LOG_TYPE_DEBUG, "%{public}@[Home Migration %@] Object Change (HomeManager Queue): %@", v173, 0x20u);
                }

                objc_autoreleasePoolPop(v66);
                [v136 add:v26 withMessage:0];
              }

              [v136 save];
              [v135 save];
              v65 = [obj zoneID];
              [(HMDHomeManager *)self uploadHomeToCloudZone:v65 withDelay:0.0];
LABEL_50:

              *(*&buf[8] + 24) = 1;
              v15 = obj;
              goto LABEL_51;
            }

            if (a4 < 3)
            {
              v42 = [v15 zoneID];
              v43 = [v42 UUIDString];

              v44 = dispatch_group_create();
              dispatch_group_enter(v44);
              v45 = [(HMDHomeManager *)self cloudDataSyncManager];
              v46 = [v45 cloudCache];
              v47 = [obj ownerName];
              v158[0] = MEMORY[0x277D85DD0];
              v158[1] = 3221225472;
              v158[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke;
              v158[3] = &unk_279731960;
              objc_copyWeak(&v161, &location);
              v158[4] = obj;
              v160 = buf;
              v48 = v44;
              v159 = v48;
              [v46 homeZoneWithName:v43 owner:v47 completion:v158];

              v49 = objc_autoreleasePoolPush();
              v50 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v50, OS_LOG_TYPE_INFO))
              {
                v51 = HMFGetLogIdentifier();
                v52 = [obj uuid];
                *v173 = 138543618;
                v174 = v51;
                v175 = 2112;
                v176 = v52;
                _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_INFO, "%{public}@Waiting for home fixup for %@", v173, 0x16u);

                v14 = v134;
              }

              objc_autoreleasePoolPop(v49);
              dispatch_group_wait(v48, 0xFFFFFFFFFFFFFFFFLL);

              objc_destroyWeak(&v161);
              v15 = obj;
            }

            if ([v15 isOwnerUser])
            {
              [v15 setupBackingStore];
              v53 = objc_autoreleasePoolPush();
              v54 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v54, OS_LOG_TYPE_INFO))
              {
                v55 = HMFGetLogIdentifier();
                v56 = [obj uuid];
                v57 = [v56 UUIDString];
                *v173 = 138543618;
                v174 = v55;
                v175 = 2112;
                v176 = v57;
                _os_log_impl(&dword_2531F8000, v54, OS_LOG_TYPE_INFO, "%{public}@Migrating Home %@", v173, 0x16u);

                v14 = v134;
              }

              objc_autoreleasePoolPop(v53);
              v58 = [obj backingStore];
              v59 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
              v136 = [v58 transaction:@"homeMigration" options:v59];

              v135 = [obj homeConfigurationModelObjectWithChangeType:1];
              v60 = objc_autoreleasePoolPush();
              v61 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v61, OS_LOG_TYPE_DEBUG))
              {
                v62 = HMFGetLogIdentifier();
                v63 = [obj uuid];
                v64 = [v63 UUIDString];
                *v173 = 138543874;
                v174 = v62;
                v175 = 2112;
                v176 = v64;
                v177 = 2112;
                v178 = v135;
                _os_log_impl(&dword_2531F8000, v61, OS_LOG_TYPE_DEBUG, "%{public}@[Home Migration %@] Object Change: %@", v173, 0x20u);
              }

              objc_autoreleasePoolPop(v60);
              [v136 add:v135 withMessage:0];
              [v136 save];
              v65 = [obj zoneID];
              [(HMDHomeManager *)self uploadHomeToCloudZone:v65 withDelay:0.0];
              goto LABEL_50;
            }

LABEL_51:
            v71 = [HMDCloudZoneInformation alloc];
            v72 = [v15 ownerName];
            v73 = [v15 zoneID];
            v74 = [(HMDCloudZoneInformation *)v71 initWithOwnerName:v72 uuid:v73];

            [(HMDCloudZoneInformation *)v74 setSchemaVersion:3];
            [(HMDCloudZoneInformation *)v74 setZoneCreated:0];
            [v129 addObject:v74];
          }

          v131 = [v14 countByEnumeratingWithState:&v166 objects:v180 count:16];
          if (!v131)
          {
LABEL_53:

            if (a4 <= 1)
            {
              v75 = [(HMDHomeManager *)self cloudZones];
              [v75 removeObjectsInArray:v129];

              v76 = [(HMDHomeManager *)self cloudZones];
              [v76 addObjectsFromArray:v129];

              v77 = objc_autoreleasePoolPush();
              v78 = HMFGetOSLogHandle();
              if (os_log_type_enabled(v78, OS_LOG_TYPE_INFO))
              {
                v79 = HMFGetLogIdentifier();
                v80 = [(HMDHomeManager *)self uuid];
                v81 = [v80 UUIDString];
                *v173 = 138543618;
                v174 = v79;
                v175 = 2112;
                v176 = v81;
                _os_log_impl(&dword_2531F8000, v78, OS_LOG_TYPE_INFO, "%{public}@Migrating Home Manager %@", v173, 0x16u);
              }

              objc_autoreleasePoolPop(v77);
              v82 = [(HMDHomeManager *)self backingStore];
              v83 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
              v84 = [v82 transaction:@"homeManagerMigration" options:v83];

              [(HMDHomeManager *)self backingStoreObjects:4];
              v156 = 0u;
              v157 = 0u;
              v154 = 0u;
              obja = v155 = 0u;
              v85 = [obja countByEnumeratingWithState:&v154 objects:v172 count:16];
              if (v85)
              {
                v86 = *v155;
                do
                {
                  for (k = 0; k != v85; ++k)
                  {
                    if (*v155 != v86)
                    {
                      objc_enumerationMutation(obja);
                    }

                    v88 = *(*(&v154 + 1) + 8 * k);
                    v89 = objc_autoreleasePoolPush();
                    v90 = HMFGetOSLogHandle();
                    if (os_log_type_enabled(v90, OS_LOG_TYPE_DEBUG))
                    {
                      v91 = HMFGetLogIdentifier();
                      v92 = [(HMDHomeManager *)self uuid];
                      v93 = [v92 UUIDString];
                      *v173 = 138543874;
                      v174 = v91;
                      v175 = 2112;
                      v176 = v93;
                      v177 = 2112;
                      v178 = v88;
                      _os_log_impl(&dword_2531F8000, v90, OS_LOG_TYPE_DEBUG, "%{public}@[Home Manager Migration %@] Object Change: %@", v173, 0x20u);
                    }

                    objc_autoreleasePoolPop(v89);
                    [v84 add:v88 withMessage:0];
                  }

                  v85 = [obja countByEnumeratingWithState:&v154 objects:v172 count:16];
                }

                while (v85);
              }

              [v84 save];
              [(HMDHomeManager *)self setForceFetchHomeManagerZone:1];
              [(HMDHomeManager *)self fetchHomeManagerCloudConflict:1 withDelay:0.0];
            }

            break;
          }
        }
      }

      objb = dispatch_group_create();
      v150 = 0u;
      v151 = 0u;
      v152 = 0u;
      v153 = 0u;
      v94 = [(HMDHomeManager *)self homes];
      v95 = [v94 countByEnumeratingWithState:&v150 objects:v171 count:16];
      if (v95)
      {
        v96 = *v151;
        do
        {
          for (m = 0; m != v95; ++m)
          {
            if (*v151 != v96)
            {
              objc_enumerationMutation(v94);
            }

            v98 = *(*(&v150 + 1) + 8 * m);
            if ([v98 isOwnerUser])
            {
              dispatch_group_enter(objb);
              v99 = [v98 zoneID];
              v100 = [v99 UUIDString];

              v101 = [(HMDHomeManager *)self cloudDataSyncManager];
              v102 = [v101 cloudCache];
              v103 = [v98 ownerName];
              v146[0] = MEMORY[0x277D85DD0];
              v146[1] = 3221225472;
              v146[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_654;
              v146[3] = &unk_279731960;
              objc_copyWeak(&v149, &location);
              v146[4] = v98;
              v147 = objb;
              v148 = buf;
              [v102 homeZoneWithName:v100 owner:v103 completion:v146];

              objc_destroyWeak(&v149);
            }
          }

          v95 = [v94 countByEnumeratingWithState:&v150 objects:v171 count:16];
        }

        while (v95);
      }

      v104 = objc_autoreleasePoolPush();
      v105 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v105, OS_LOG_TYPE_INFO))
      {
        v106 = HMFGetLogIdentifier();
        *v173 = 138543362;
        v174 = v106;
        _os_log_impl(&dword_2531F8000, v105, OS_LOG_TYPE_INFO, "%{public}@Waiting for homes migration to complete", v173, 0xCu);
      }

      objc_autoreleasePoolPop(v104);
      dispatch_group_wait(objb, 0xFFFFFFFFFFFFFFFFLL);
      v107 = dispatch_group_create();
      v108 = [(HMDHomeManager *)self cloudDataSyncManager];
      v109 = [v108 homeManagerZone];

      if (v109)
      {
        dispatch_group_enter(v107);
        v142[0] = MEMORY[0x277D85DD0];
        v142[1] = 3221225472;
        v142[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_659;
        v142[3] = &unk_2797352E8;
        objc_copyWeak(&v145, &location);
        v143 = v107;
        v144 = v109;
        [v144 fetchMigratedObjects:v142];
        [(HMDHomeManager *)self _cleanHomeManagerZoneInformationWithoutHome];
        if ([(HMDHomeManager *)self recoveryVersion]<= 0)
        {
          [(HMDHomeManager *)self setRecoveryVersion:1];
          v118 = [[HMDHomeSaveRequest alloc] initWithReason:@"HMDHomeManagerRecoveryVersionUpdated" information:0 postSyncNotification:0];
          [(HMDHomeManager *)self saveWithRequest:v118];
          v140[0] = MEMORY[0x277D85DD0];
          v140[1] = 3221225472;
          v140[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_2_665;
          v140[3] = &unk_2797319B0;
          objc_copyWeak(&v141, &location);
          [(HMDHomeManager *)self _findZoneInformationWithoutHome:v140];
          objc_destroyWeak(&v141);
        }

        else
        {
          v110 = objc_autoreleasePoolPush();
          v111 = self;
          v112 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v112, OS_LOG_TYPE_INFO))
          {
            v113 = HMFGetLogIdentifier();
            *v173 = 138543362;
            v174 = v113;
            _os_log_impl(&dword_2531F8000, v112, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Recover already done, skipping", v173, 0xCu);
          }

          objc_autoreleasePoolPop(v110);
        }

        objc_destroyWeak(&v145);
      }

      else
      {
        v114 = objc_autoreleasePoolPush();
        v115 = self;
        v116 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v116, OS_LOG_TYPE_ERROR))
        {
          v117 = HMFGetLogIdentifier();
          *v173 = 138543362;
          v174 = v117;
          _os_log_impl(&dword_2531F8000, v116, OS_LOG_TYPE_ERROR, "%{public}@Cannot determine home manager zone to migrate", v173, 0xCu);
        }

        objc_autoreleasePoolPop(v114);
      }

      v119 = objc_autoreleasePoolPush();
      v120 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v120, OS_LOG_TYPE_INFO))
      {
        v121 = HMFGetLogIdentifier();
        *v173 = 138543362;
        v174 = v121;
        _os_log_impl(&dword_2531F8000, v120, OS_LOG_TYPE_INFO, "%{public}@Waiting for home manager migration to complete", v173, 0xCu);
      }

      objc_autoreleasePoolPop(v119);
      dispatch_group_wait(v107, 0xFFFFFFFFFFFFFFFFLL);

      objc_destroyWeak(&location);
      objc_autoreleasePoolPop(context);
      if (*(*&buf[8] + 24) == 1)
      {
        v122 = [HMDHomeSaveRequest alloc];
        v123 = [(HMDHomeSaveRequest *)v122 initWithReason:*MEMORY[0x277CD2080] information:0 postSyncNotification:1];
        [(HMDHomeManager *)self saveWithRequest:v123];
      }

      _Block_object_dispose(buf, 8);
    }
  }

  v124 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v38 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v8 = [*(a1 + 32) uuid];
    v9 = [v5 __cloudRecordWithObjectID:v8];

    if (!v9 && [*(a1 + 32) isOwnerUser])
    {
      v10 = objc_autoreleasePoolPush();
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v12 = HMFGetLogIdentifier();
        v13 = [*(a1 + 32) uuid];
        v14 = [v13 UUIDString];
        *buf = 138543618;
        v33 = v12;
        v34 = 2112;
        v35 = v14;
        _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Home missing cloud record, creating add object %@", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v10);
      v15 = [WeakRetained backingStore];
      v16 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
      v17 = [v15 transaction:@"homeMigration" options:v16];

      v18 = [*(a1 + 32) modelObjectWithChangeType:1];
      v19 = objc_autoreleasePoolPush();
      v20 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEBUG))
      {
        HMFGetLogIdentifier();
        v21 = v30 = v17;
        [*(a1 + 32) uuid];
        v22 = v31 = v19;
        v23 = [v22 UUIDString];
        *buf = 138543874;
        v33 = v21;
        v34 = 2112;
        v35 = v23;
        v36 = 2112;
        v37 = v18;
        _os_log_impl(&dword_2531F8000, v20, OS_LOG_TYPE_DEBUG, "%{public}@[Home Migration %@] Home Fixup Change: %@", buf, 0x20u);

        v19 = v31;
        v17 = v30;
      }

      objc_autoreleasePoolPop(v19);
      [v17 add:v18 withMessage:0];
      [v17 save];
      v24 = [*(a1 + 32) zoneID];
      [WeakRetained uploadHomeToCloudZone:v24 withDelay:0.0];

      *(*(*(a1 + 48) + 8) + 24) = 1;
    }
  }

  v25 = objc_autoreleasePoolPush();
  v26 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v26, OS_LOG_TYPE_DEFAULT))
  {
    v27 = HMFGetLogIdentifier();
    v28 = [*(a1 + 32) uuid];
    *buf = 138543618;
    v33 = v27;
    v34 = 2112;
    v35 = v28;
    _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_DEFAULT, "%{public}@Completed home fixup for %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v25);
  dispatch_group_leave(*(a1 + 40));

  v29 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_654(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v8 = WeakRetained;
  if (v6 || !WeakRetained)
  {
    dispatch_group_leave(*(a1 + 40));
  }

  else
  {
    v9 = *(a1 + 32);
    v12[0] = MEMORY[0x277D85DD0];
    v12[1] = 3221225472;
    v12[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_2;
    v12[3] = &unk_279735B48;
    objc_copyWeak(&v16, (a1 + 56));
    v10 = *(a1 + 40);
    v11 = *(a1 + 32);
    v13 = v10;
    v14 = v11;
    v15 = *(a1 + 48);
    [v9 migrateCloudZone:v5 completion:v12];

    objc_destroyWeak(&v16);
  }
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_659(id *a1, void *a2, void *a3)
{
  v48 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v32 = v5;
  v33 = v6;
  if (!WeakRetained)
  {
    goto LABEL_20;
  }

  if (!v6)
  {
    if ([v5 count])
    {
      v31 = a1;
      v14 = objc_autoreleasePoolPush();
      v30 = WeakRetained;
      v15 = WeakRetained;
      v16 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
      {
        v17 = HMFGetLogIdentifier();
        *buf = 138543362;
        v45 = v17;
        _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_INFO, "%{public}@General Object Migrating (Run Transactions) for Home Manager", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v14);
      v18 = [v15 backingStore];
      v19 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
      v20 = [v18 transaction:@"generalHomeManagerRunObjectMigration" options:v19];

      v41 = 0u;
      v42 = 0u;
      v39 = 0u;
      v40 = 0u;
      obj = v32;
      v21 = [obj countByEnumeratingWithState:&v39 objects:v43 count:16];
      if (v21)
      {
        v22 = *v40;
        do
        {
          for (i = 0; i != v21; ++i)
          {
            if (*v40 != v22)
            {
              objc_enumerationMutation(obj);
            }

            v24 = *(*(&v39 + 1) + 8 * i);
            v25 = objc_autoreleasePoolPush();
            v26 = v15;
            v27 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v27, OS_LOG_TYPE_DEBUG))
            {
              v28 = HMFGetLogIdentifier();
              *buf = 138543618;
              v45 = v28;
              v46 = 2112;
              v47 = v24;
              _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_DEBUG, "%{public}@[General Home Manager Migration] Object Change: %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v25);
            [v20 add:v24 withMessage:0];
          }

          v21 = [obj countByEnumeratingWithState:&v39 objects:v43 count:16];
        }

        while (v21);
      }

      WeakRetained = v30;
      a1 = v31;
      if (v20)
      {
        v35[0] = MEMORY[0x277D85DD0];
        v35[1] = 3221225472;
        v35[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_663;
        v35[3] = &unk_279731988;
        objc_copyWeak(&v38, v31 + 6);
        v36 = v31[4];
        v37 = v31[5];
        [v20 run:v35];

        objc_destroyWeak(&v38);
        WeakRetained = v30;
        goto LABEL_21;
      }
    }

LABEL_20:
    dispatch_group_leave(a1[4]);
    goto LABEL_21;
  }

  v8 = a1;
  v9 = objc_autoreleasePoolPush();
  v10 = WeakRetained;
  v11 = WeakRetained;
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
  {
    v13 = HMFGetLogIdentifier();
    *buf = 138543618;
    v45 = v13;
    v46 = 2112;
    v47 = v33;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Unable to fetch migration changes in home manager because of error (%@).", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v9);
  dispatch_group_leave(v8[4]);
  WeakRetained = v10;
LABEL_21:

  v29 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_2_665(uint64_t a1, void *a2, void *a3)
{
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v8 = WeakRetained;
  if (!v6 && WeakRetained && [v5 count])
  {
    v9[0] = MEMORY[0x277D85DD0];
    v9[1] = 3221225472;
    v9[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_3;
    v9[3] = &unk_279734708;
    objc_copyWeak(&v10, (a1 + 32));
    [v8 _loadHomeZonesFromCache:v5 completion:v9];
    objc_destroyWeak(&v10);
  }
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_3(uint64_t a1, void *a2)
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  v8 = os_log_type_enabled(v7, OS_LOG_TYPE_INFO);
  if (v3)
  {
    if (v8)
    {
      v9 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v9;
      v10 = "%{public}@[Recover Home] Failed to recover homes";
LABEL_6:
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, v10, &v12, 0xCu);
    }
  }

  else if (v8)
  {
    v9 = HMFGetLogIdentifier();
    v12 = 138543362;
    v13 = v9;
    v10 = "%{public}@[Recover Home] Homes recovered";
    goto LABEL_6;
  }

  objc_autoreleasePoolPop(v5);
  v11 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_663(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained)
  {
    [*(a1 + 40) markMigratedObjectsAsMigrated];
  }

  dispatch_group_leave(*(a1 + 32));
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_2(uint64_t a1, void *a2)
{
  v31 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  if (WeakRetained)
  {
    v5 = objc_autoreleasePoolPush();
    v6 = WeakRetained;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [*(a1 + 40) uuid];
      v10 = [v9 UUIDString];
      *buf = 138543874;
      v26 = v8;
      v27 = 2112;
      v28 = v10;
      v29 = 2112;
      v30 = v3;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Finished migrating home %@ with error %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
    v11 = [v6 cloudDataSyncManager];
    v12 = [v11 homeManagerZone];

    if (v12)
    {
      v13 = [*(a1 + 40) uuid];
      v21[0] = MEMORY[0x277D85DD0];
      v21[1] = 3221225472;
      v21[2] = __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_655;
      v21[3] = &unk_279731938;
      objc_copyWeak(&v24, (a1 + 56));
      v14 = *(a1 + 32);
      v15 = *(a1 + 48);
      v22 = v14;
      v23 = v15;
      [v12 cloudRecordsForParentID:v13 completionHandler:v21];

      objc_destroyWeak(&v24);
    }

    else
    {
      v16 = objc_autoreleasePoolPush();
      v17 = v6;
      v18 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v18, OS_LOG_TYPE_ERROR))
      {
        v19 = HMFGetLogIdentifier();
        *buf = 138543362;
        v26 = v19;
        _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_ERROR, "%{public}@Cannot determine home manager zone to clean", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v16);
      dispatch_group_leave(*(a1 + 32));
    }
  }

  else
  {
    dispatch_group_leave(*(a1 + 32));
  }

  v20 = *MEMORY[0x277D85DE8];
}

void __59__HMDHomeManager_migrateModelObjectsToCloud_schemaVersion___block_invoke_655(uint64_t a1, void *a2, void *a3)
{
  v48 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  if (WeakRetained && [v5 count])
  {
    v31 = a1;
    v32 = v6;
    v7 = objc_autoreleasePoolPush();
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      v10 = [WeakRetained uuid];
      v11 = [v10 UUIDString];
      *buf = 138543618;
      v42 = v9;
      v43 = 2112;
      v44 = v11;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Cleanup Records in Home Manager %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    v12 = [WeakRetained backingStore];
    v13 = +[HMDBackingStoreTransactionOptions defaultXPCOptions];
    v14 = [v12 transaction:@"homeManagerCleanup" options:v13];

    v39 = 0u;
    v40 = 0u;
    v37 = 0u;
    v38 = 0u;
    v33 = v5;
    obj = v5;
    v15 = [obj countByEnumeratingWithState:&v37 objects:v47 count:16];
    if (v15)
    {
      v16 = v15;
      v17 = *v38;
      do
      {
        v18 = 0;
        v35 = v16;
        do
        {
          if (*v38 != v17)
          {
            objc_enumerationMutation(obj);
          }

          v19 = [*(*(&v37 + 1) + 8 * v18) extractObjectChange];
          if (v19)
          {
            v20 = objc_alloc(objc_opt_class());
            v21 = [v19 uuid];
            v22 = [v19 parentUUID];
            v23 = [v20 initWithObjectChangeType:3 uuid:v21 parentUUID:v22];

            v24 = objc_autoreleasePoolPush();
            v25 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v25, OS_LOG_TYPE_DEBUG))
            {
              v26 = HMFGetLogIdentifier();
              [WeakRetained uuid];
              v28 = v27 = v14;
              v29 = [v28 UUIDString];
              *buf = 138543874;
              v42 = v26;
              v43 = 2112;
              v44 = v29;
              v45 = 2112;
              v46 = v23;
              _os_log_impl(&dword_2531F8000, v25, OS_LOG_TYPE_DEBUG, "%{public}@[Home Manager Cleanup %@] Object Change: %@", buf, 0x20u);

              v14 = v27;
              v16 = v35;
            }

            objc_autoreleasePoolPop(v24);
            [v14 add:v23 withMessage:0];
          }

          ++v18;
        }

        while (v16 != v18);
        v16 = [obj countByEnumeratingWithState:&v37 objects:v47 count:16];
      }

      while (v16);
    }

    [v14 save];
    *(*(*(v31 + 40) + 8) + 24) = 1;
    dispatch_group_leave(*(v31 + 32));

    v6 = v32;
    v5 = v33;
  }

  else
  {
    dispatch_group_leave(*(a1 + 32));
  }

  v30 = *MEMORY[0x277D85DE8];
}

- (void)_loadHomeZonesFromCache:(id)a3 completion:(id)a4
{
  v51 = *MEMORY[0x277D85DE8];
  v6 = a3;
  v7 = a4;
  v29 = v6;
  if ([v6 count])
  {
    v28 = v7;
    group = dispatch_group_create();
    v44[0] = 0;
    v44[1] = v44;
    v44[2] = 0x2020000000;
    v45 = 0;
    objc_initWeak(&location, self);
    v41 = 0u;
    v42 = 0u;
    v39 = 0u;
    v40 = 0u;
    obj = v6;
    v8 = [obj countByEnumeratingWithState:&v39 objects:v50 count:16];
    if (v8)
    {
      v9 = *v40;
      do
      {
        for (i = 0; i != v8; ++i)
        {
          if (*v40 != v9)
          {
            objc_enumerationMutation(obj);
          }

          v11 = *(*(&v39 + 1) + 8 * i);
          v12 = [(HMDHomeManager *)self cloudDataSyncManager];
          v13 = [v12 cloudCache];
          v14 = [v11 UUIDString];
          v15 = [v13 homeZoneWithName:v14];

          if (v15)
          {
            dispatch_group_enter(group);
            v16 = objc_autoreleasePoolPush();
            v17 = self;
            v18 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
            {
              v19 = HMFGetLogIdentifier();
              *buf = 138543618;
              v47 = v19;
              v48 = 2112;
              v49 = v11;
              _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Fetching all cached records for home zone %@", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v16);
            v35[0] = MEMORY[0x277D85DD0];
            v35[1] = 3221225472;
            v35[2] = __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke;
            v35[3] = &unk_2797318E8;
            objc_copyWeak(&v38, &location);
            v35[4] = v11;
            v37 = v44;
            v36 = group;
            [v15 fetchAllObjects:v35];

            objc_destroyWeak(&v38);
          }

          else
          {
            v20 = objc_autoreleasePoolPush();
            v21 = self;
            v22 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
            {
              v23 = HMFGetLogIdentifier();
              *buf = 138543618;
              v47 = v23;
              v48 = 2112;
              v49 = v11;
              _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Cloud zone does not exist for home zone %@, ignoring", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v20);
          }
        }

        v8 = [obj countByEnumeratingWithState:&v39 objects:v50 count:16];
      }

      while (v8);
    }

    v24 = [(HMDHomeManager *)self workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_640;
    block[3] = &unk_279731910;
    v34 = v44;
    v33 = v28;
    dispatch_group_notify(group, v24, block);

    objc_destroyWeak(&location);
    _Block_object_dispose(v44, 8);

    v7 = v28;
  }

  else
  {
    v25 = _Block_copy(v7);
    v26 = v25;
    if (v25)
    {
      (*(v25 + 2))(v25, 0);
    }
  }

  v27 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v63 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v8 = WeakRetained;
  v44 = v6;
  if (v5 && !v6 && WeakRetained && [v5 count])
  {
    v54 = 0u;
    v55 = 0u;
    v52 = 0u;
    v53 = 0u;
    v9 = v5;
    v10 = [v9 countByEnumeratingWithState:&v52 objects:v56 count:16];
    if (v10)
    {
      v11 = *v53;
      while (2)
      {
        for (i = 0; i != v10; ++i)
        {
          if (*v53 != v11)
          {
            objc_enumerationMutation(v9);
          }

          v13 = *(*(&v52 + 1) + 8 * i);
          objc_opt_class();
          if (objc_opt_isKindOfClass())
          {
            v14 = v13;
          }

          else
          {
            v14 = 0;
          }

          v15 = v14;

          if (v15)
          {

            v43 = [v9 mutableCopy];
            [v43 removeObject:v13];
            v27 = [v8 backingStore];
            v28 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
            v42 = [v27 transaction:@"kTransactionUpdate" options:v28];

            [v42 add:v13];
            v29 = [v8 backingStore];
            v30 = +[HMDBackingStoreTransactionOptions defaultCloudOptions];
            v31 = [v29 transaction:@"kTransactionUpdate" options:v30];

            [v31 addObjects:v43];
            v32 = objc_autoreleasePoolPush();
            v33 = v8;
            v34 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v34, OS_LOG_TYPE_INFO))
            {
              v35 = HMFGetLogIdentifier();
              v36 = [v13 uuid];
              v37 = *(a1 + 32);
              *buf = 138543874;
              v58 = v35;
              v59 = 2112;
              v60 = v36;
              v61 = 2112;
              v62 = v37;
              _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Running transaction to add home %@/%@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v32);
            v45[0] = MEMORY[0x277D85DD0];
            v45[1] = 3221225472;
            v45[2] = __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_638;
            v45[3] = &unk_2797318C0;
            objc_copyWeak(&v51, (a1 + 56));
            v38 = *(a1 + 40);
            v50 = *(a1 + 48);
            v46 = v38;
            v39 = v13;
            v40 = *(a1 + 32);
            v47 = v39;
            v48 = v40;
            v41 = v31;
            v49 = v41;
            [v42 run:v45];

            objc_destroyWeak(&v51);
            goto LABEL_23;
          }
        }

        v10 = [v9 countByEnumeratingWithState:&v52 objects:v56 count:16];
        if (v10)
        {
          continue;
        }

        break;
      }
    }

    v16 = objc_autoreleasePoolPush();
    v17 = v8;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
    {
      v19 = HMFGetLogIdentifier();
      v20 = *(a1 + 32);
      *buf = 138543618;
      v58 = v19;
      v59 = 2112;
      v60 = v20;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Cannot determine home model for home zone %@, will not recover this home zone", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v16);
  }

  else
  {
    v21 = objc_autoreleasePoolPush();
    v22 = v8;
    v23 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v23, OS_LOG_TYPE_ERROR))
    {
      v24 = HMFGetLogIdentifier();
      v25 = *(a1 + 32);
      *buf = 138543874;
      v58 = v24;
      v59 = 2112;
      v60 = v25;
      v61 = 2112;
      v62 = v6;
      _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Failed to fetch models from record cache for home zone %@ with error %@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v21);
    *(*(*(a1 + 48) + 8) + 24) = 1;
  }

  dispatch_group_leave(*(a1 + 40));
LABEL_23:

  v26 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_640(uint64_t a1)
{
  if (*(*(*(a1 + 40) + 8) + 24) == 1)
  {
    v4 = [MEMORY[0x277CCA9B8] hmErrorWithCode:52];
  }

  else
  {
    v4 = 0;
  }

  v2 = _Block_copy(*(a1 + 32));
  v3 = v2;
  if (v2)
  {
    (*(v2 + 2))(v2, v4);
  }
}

void __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_638(uint64_t a1, void *a2)
{
  v29 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 72));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  if (v3 || !WeakRetained)
  {
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v24 = v15;
      v25 = 2112;
      v26 = v3;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Cannot continue, encountered an error while processing home model: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    *(*(*(a1 + 64) + 8) + 24) = 1;
    dispatch_group_leave(*(a1 + 32));
  }

  else
  {
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v8 = HMFGetLogIdentifier();
      v9 = [*(a1 + 40) uuid];
      v10 = *(a1 + 48);
      *buf = 138543874;
      v24 = v8;
      v25 = 2112;
      v26 = v9;
      v27 = 2112;
      v28 = v10;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Running transactions for the rest of the home %@/%@", buf, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
    v11 = *(a1 + 56);
    v17[0] = MEMORY[0x277D85DD0];
    v17[1] = 3221225472;
    v17[2] = __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_639;
    v17[3] = &unk_279731898;
    objc_copyWeak(&v22, (a1 + 72));
    v21 = *(a1 + 64);
    v12 = *(a1 + 40);
    v13 = *(a1 + 48);
    v18 = v12;
    v19 = v13;
    v20 = *(a1 + 32);
    [v11 run:v17];

    objc_destroyWeak(&v22);
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __53__HMDHomeManager__loadHomeZonesFromCache_completion___block_invoke_639(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 64));
  v5 = objc_autoreleasePoolPush();
  v6 = WeakRetained;
  v7 = HMFGetOSLogHandle();
  v8 = v7;
  if (v3)
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      v14 = 138543618;
      v15 = v9;
      v16 = 2112;
      v17 = v3;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Cannot continue, encountered an error while processing reset of the home models: %@", &v14, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    *(*(*(a1 + 56) + 8) + 24) = 1;
  }

  else
  {
    if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
    {
      v10 = HMFGetLogIdentifier();
      v11 = [*(a1 + 32) uuid];
      v12 = *(a1 + 40);
      v14 = 138543874;
      v15 = v10;
      v16 = 2112;
      v17 = v11;
      v18 = 2112;
      v19 = v12;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Finished recovering home %@/%@", &v14, 0x20u);
    }

    objc_autoreleasePoolPop(v5);
  }

  dispatch_group_leave(*(a1 + 48));

  v13 = *MEMORY[0x277D85DE8];
}

- (void)_cleanHomeManagerZoneInformationWithoutHome
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = MEMORY[0x277CBEB58];
  v4 = [(HMDHomeManager *)self homes];
  v5 = [v3 setWithCapacity:{objc_msgSend(v4, "count")}];

  v25 = 0u;
  v26 = 0u;
  v23 = 0u;
  v24 = 0u;
  v6 = [(HMDHomeManager *)self homes];
  v7 = [v6 countByEnumeratingWithState:&v23 objects:v27 count:16];
  if (v7)
  {
    v8 = *v24;
    do
    {
      v9 = 0;
      do
      {
        if (*v24 != v8)
        {
          objc_enumerationMutation(v6);
        }

        v10 = [*(*(&v23 + 1) + 8 * v9) zoneID];
        [v5 addObject:v10];

        ++v9;
      }

      while (v7 != v9);
      v7 = [v6 countByEnumeratingWithState:&v23 objects:v27 count:16];
    }

    while (v7);
  }

  v11 = [(HMDHomeManager *)self cloudDataSyncManager];
  v12 = [v11 homeManagerZone];

  v13 = [MEMORY[0x277CBEB58] set];
  objc_initWeak(&location, self);
  v14 = [(HMDHomeManager *)self uuid];
  v18[0] = MEMORY[0x277D85DD0];
  v18[1] = 3221225472;
  v18[2] = __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke;
  v18[3] = &unk_2797352E8;
  objc_copyWeak(&v21, &location);
  v15 = v13;
  v19 = v15;
  v16 = v5;
  v20 = v16;
  [v12 cloudRecordsForParentID:v14 completionHandler:v18];

  objc_destroyWeak(&v21);
  objc_destroyWeak(&location);

  v17 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke(id *a1, void *a2, void *a3)
{
  v22 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained(a1 + 6);
  v8 = WeakRetained;
  if (v6 || !WeakRetained)
  {
    v10 = objc_autoreleasePoolPush();
    v11 = v8;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v21 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@[Stale Zone Information] Encountered an error while querying cloud cache for home zone records, cannot continue", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
  }

  else
  {
    v18[0] = MEMORY[0x277D85DD0];
    v18[1] = 3221225472;
    v18[2] = __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke_636;
    v18[3] = &unk_279731870;
    v19 = a1[4];
    [v5 hmf_enumerateWithAutoreleasePoolUsingBlock:v18];
    v9 = [v8 workQueue];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke_2;
    v15[3] = &unk_279734960;
    v15[4] = v8;
    v16 = a1[5];
    v17 = a1[4];
    dispatch_async(v9, v15);
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke_636(uint64_t a1, void *a2)
{
  v8 = [a2 extractObjectChange];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v8;
  }

  else
  {
    v3 = 0;
  }

  v4 = v3;
  v5 = v4;
  if (v4)
  {
    v6 = *(a1 + 32);
    v7 = [v4 uuid];
    [v6 addObject:v7];
  }
}

void __61__HMDHomeManager__cleanHomeManagerZoneInformationWithoutHome__block_invoke_2(uint64_t a1)
{
  v48 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) cloudZones];
  v3 = [v2 copy];

  v32 = v3;
  v4 = [MEMORY[0x277CBEB58] setWithCapacity:{objc_msgSend(v3, "count")}];
  v35 = 0u;
  v36 = 0u;
  v37 = 0u;
  v38 = 0u;
  v5 = [*(a1 + 32) cloudZones];
  v6 = [v5 copy];

  v7 = [v6 countByEnumeratingWithState:&v35 objects:v47 count:16];
  if (v7)
  {
    v8 = v7;
    v9 = *v36;
    v33 = v6;
    v34 = v4;
    do
    {
      for (i = 0; i != v8; ++i)
      {
        if (*v36 != v9)
        {
          objc_enumerationMutation(v6);
        }

        v11 = *(*(&v35 + 1) + 8 * i);
        v12 = *(a1 + 40);
        v13 = [v11 uuid];
        if ([v12 containsObject:v13])
        {

LABEL_9:
          v16 = [v11 uuid];
          [v4 addObject:v16];
          goto LABEL_13;
        }

        v14 = *(a1 + 48);
        v15 = [v11 uuid];
        LOBYTE(v14) = [v14 containsObject:v15];

        if (v14)
        {
          goto LABEL_9;
        }

        v17 = objc_autoreleasePoolPush();
        v18 = *(a1 + 32);
        v19 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
        {
          v20 = HMFGetLogIdentifier();
          v21 = [v11 uuid];
          *buf = 138543618;
          v40 = v20;
          v41 = 2112;
          v42 = v21;
          _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_ERROR, "%{public}@[Stale Zone Information] Found stale zone %@, removing", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v17);
        v22 = [*(a1 + 32) cloudZones];
        [v22 removeObject:v11];

        v16 = [*(a1 + 32) cloudDataSyncManager];
        v23 = [v11 uuid];
        v24 = [v23 UUIDString];
        [v16 removeHomeZoneName:v24];

        v6 = v33;
        v4 = v34;
LABEL_13:
      }

      v8 = [v6 countByEnumeratingWithState:&v35 objects:v47 count:16];
    }

    while (v8);
  }

  v25 = objc_autoreleasePoolPush();
  v26 = *(a1 + 32);
  v27 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v27, OS_LOG_TYPE_INFO))
  {
    v28 = HMFGetLogIdentifier();
    v29 = *(a1 + 40);
    v30 = *(a1 + 48);
    *buf = 138544130;
    v40 = v28;
    v41 = 2112;
    v42 = v29;
    v43 = 2112;
    v44 = v30;
    v45 = 2112;
    v46 = v4;
    _os_log_impl(&dword_2531F8000, v27, OS_LOG_TYPE_INFO, "%{public}@[Stale Zone Information] Finished zone audit. Zones with homes %@, Zones with models: %@, Zones with cloudZones %@", buf, 0x2Au);
  }

  objc_autoreleasePoolPop(v25);
  v31 = *MEMORY[0x277D85DE8];
}

- (void)_findZoneInformationWithoutHome:(id)a3
{
  v32 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self cloudDataSyncManager];
  v6 = [v5 homeManagerZone];

  v7 = MEMORY[0x277CBEB58];
  v8 = [(HMDHomeManager *)self homes];
  v9 = [v7 setWithCapacity:{objc_msgSend(v8, "count")}];

  v29 = 0u;
  v30 = 0u;
  v27 = 0u;
  v28 = 0u;
  v10 = [(HMDHomeManager *)self homes];
  v11 = [v10 countByEnumeratingWithState:&v27 objects:v31 count:16];
  if (v11)
  {
    v12 = *v28;
    do
    {
      v13 = 0;
      do
      {
        if (*v28 != v12)
        {
          objc_enumerationMutation(v10);
        }

        v14 = [*(*(&v27 + 1) + 8 * v13) zoneID];
        [v9 addObject:v14];

        ++v13;
      }

      while (v11 != v13);
      v11 = [v10 countByEnumeratingWithState:&v27 objects:v31 count:16];
    }

    while (v11);
  }

  v15 = [MEMORY[0x277CBEB58] set];
  objc_initWeak(&location, self);
  v16 = [(HMDHomeManager *)self uuid];
  v21[0] = MEMORY[0x277D85DD0];
  v21[1] = 3221225472;
  v21[2] = __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke;
  v21[3] = &unk_279731848;
  objc_copyWeak(&v25, &location);
  v17 = v4;
  v24 = v17;
  v18 = v9;
  v22 = v18;
  v19 = v15;
  v23 = v19;
  [v6 cloudRecordsForParentID:v16 completionHandler:v21];

  objc_destroyWeak(&v25);
  objc_destroyWeak(&location);

  v20 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v32 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 56));
  v8 = WeakRetained;
  if (v6 || !WeakRetained)
  {
    v9 = objc_autoreleasePoolPush();
    v10 = v8;
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v31 = v12;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Encountered an error while querying cloud cache for home zone records, cannot continue", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
    v13 = _Block_copy(*(a1 + 48));
    v14 = v13;
    if (v13)
    {
      (*(v13 + 2))(v13, 0, v6);
    }
  }

  else
  {
    v26[0] = MEMORY[0x277D85DD0];
    v26[1] = 3221225472;
    v26[2] = __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke_631;
    v26[3] = &unk_2797317F8;
    v27 = *(a1 + 32);
    v28 = v8;
    v29 = *(a1 + 40);
    [v5 hmf_enumerateWithAutoreleasePoolUsingBlock:v26];
    if ([*(a1 + 40) count])
    {
      v22[0] = MEMORY[0x277D85DD0];
      v22[1] = 3221225472;
      v22[2] = __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke_633;
      v22[3] = &unk_279731820;
      objc_copyWeak(&v25, (a1 + 56));
      v24 = *(a1 + 48);
      v23 = *(a1 + 40);
      [v8 _findCloudHomeZonesToIgnore:v22];

      objc_destroyWeak(&v25);
    }

    else
    {
      v15 = objc_autoreleasePoolPush();
      v16 = v8;
      v17 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
      {
        v18 = HMFGetLogIdentifier();
        *buf = 138543362;
        v31 = v18;
        _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] No home zone records found without a corresponding home", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v15);
      v19 = _Block_copy(*(a1 + 48));
      if (v19)
      {
        v20 = [*(a1 + 40) copy];
        v19[2](v19, v20, 0);
      }
    }

    v14 = v27;
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke_631(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = [v3 extractObjectChange];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v5 = v4;
  }

  else
  {
    v5 = 0;
  }

  v6 = v5;

  if (v6)
  {
    v7 = *(a1 + 32);
    v8 = [v6 uuid];
    LOBYTE(v7) = [v7 containsObject:v8];

    if ((v7 & 1) == 0)
    {
      v9 = objc_autoreleasePoolPush();
      v10 = *(a1 + 40);
      v11 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
      {
        v12 = HMFGetLogIdentifier();
        v13 = [v6 uuid];
        v17 = 138543618;
        v18 = v12;
        v19 = 2112;
        v20 = v13;
        _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] Found home zone record but cannot find local home for zone: %@", &v17, 0x16u);
      }

      objc_autoreleasePoolPop(v9);
      v14 = *(a1 + 48);
      v15 = [v6 uuid];
      [v14 addObject:v15];
    }
  }

  v16 = *MEMORY[0x277D85DE8];
}

void __50__HMDHomeManager__findZoneInformationWithoutHome___block_invoke_633(uint64_t a1, void *a2, void *a3)
{
  v20 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  WeakRetained = objc_loadWeakRetained((a1 + 48));
  v8 = WeakRetained;
  if (v6 || !WeakRetained)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = v8;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v18 = 138543362;
      v19 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@[Recover Home] Encountered an error while querying transaction journal, cannot continue", &v18, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    v15 = _Block_copy(*(a1 + 40));
    v16 = v15;
    if (v15)
    {
      (*(v15 + 2))(v15, 0, v6);
    }
  }

  else
  {
    [*(a1 + 32) minusSet:v5];
    v9 = _Block_copy(*(a1 + 40));
    if (v9)
    {
      v10 = [*(a1 + 32) copy];
      v9[2](v9, v10, 0);
    }
  }

  v17 = *MEMORY[0x277D85DE8];
}

- (void)_findCloudHomeZonesToIgnore:(id)a3
{
  v4 = a3;
  objc_initWeak(&location, self);
  v5 = [MEMORY[0x277CBEB58] set];
  v6 = [HMDBackingStoreLogFetchOperation alloc];
  v15[0] = MEMORY[0x277D85DD0];
  v15[1] = 3221225472;
  v15[2] = __46__HMDHomeManager__findCloudHomeZonesToIgnore___block_invoke;
  v15[3] = &unk_2797317D0;
  objc_copyWeak(&v17, &location);
  v7 = v5;
  v16 = v7;
  v8 = [(HMDBackingStoreLogFetchOperation *)v6 initWithNeedsPushTo:2 result:v15];
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __46__HMDHomeManager__findCloudHomeZonesToIgnore___block_invoke_630;
  v12[3] = &unk_279733F30;
  v9 = v4;
  v14 = v9;
  v10 = v7;
  v13 = v10;
  [(HMDBackingStoreOperation *)v8 setResultBlock:v12];
  v11 = [(HMDHomeManager *)self backingStore];
  [v11 submit:v8];

  objc_destroyWeak(&v17);
  objc_destroyWeak(&location);
}

uint64_t __46__HMDHomeManager__findCloudHomeZonesToIgnore___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v53 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v36 = a3;
  v35 = a4;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v40 = 0u;
  v41 = 0u;
  v42 = 0u;
  v43 = 0u;
  v9 = v7;
  v10 = WeakRetained;
  obj = v9;
  v39 = [v9 countByEnumeratingWithState:&v40 objects:v52 count:16];
  if (v39)
  {
    v11 = *v41;
    do
    {
      v12 = 0;
      do
      {
        if (*v41 != v11)
        {
          objc_enumerationMutation(obj);
        }

        v13 = *(*(&v40 + 1) + 8 * v12);
        objc_opt_class();
        if (objc_opt_isKindOfClass() & 1) != 0 || (objc_opt_class(), (objc_opt_isKindOfClass()))
        {
          if ([v13 objectChangeType] == 1 || objc_msgSend(v13, "objectChangeType") == 3)
          {
            v14 = [v13 uuid];
            v15 = [HMDHome zoneIDFromHomeUUID:v14];

            v16 = objc_autoreleasePoolPush();
            v17 = v10;
            v18 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v18, OS_LOG_TYPE_INFO))
            {
              v19 = HMFGetLogIdentifier();
              v38 = v16;
              v20 = v11;
              v21 = v10;
              v22 = a1;
              if ([v13 objectChangeType] == 1)
              {
                v23 = @"add";
              }

              else
              {
                v23 = @"delete";
              }

              v24 = [v13 uuid];
              *buf = 138544130;
              v45 = v19;
              v46 = 2112;
              v47 = v23;
              a1 = v22;
              v10 = v21;
              v11 = v20;
              v16 = v38;
              v48 = 2112;
              v49 = v24;
              v50 = 2112;
              v51 = v15;
              _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] There is a %@ found home %@%@, ignoring home zone for recovery", buf, 0x2Au);
            }

            objc_autoreleasePoolPop(v16);
            v25 = *(a1 + 32);
LABEL_16:
            [v25 addObject:v15];
          }
        }

        else
        {
          objc_opt_class();
          if ((objc_opt_isKindOfClass() & 1) != 0 && [v13 objectChangeType] != 3)
          {
            v26 = objc_autoreleasePoolPush();
            v27 = v10;
            v28 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v28, OS_LOG_TYPE_INFO))
            {
              v29 = HMFGetLogIdentifier();
              v30 = [v13 uuid];
              *buf = 138543618;
              v45 = v29;
              v46 = 2112;
              v47 = v30;
              _os_log_impl(&dword_2531F8000, v28, OS_LOG_TYPE_INFO, "%{public}@[Recover Home] There is a delete found home zone %@, ignoring home zone for recovery", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v26);
            v31 = *(a1 + 32);
            v15 = [v13 uuid];
            v25 = v31;
            goto LABEL_16;
          }
        }

        ++v12;
      }

      while (v39 != v12);
      v32 = [obj countByEnumeratingWithState:&v40 objects:v52 count:16];
      v39 = v32;
    }

    while (v32);
  }

  v33 = *MEMORY[0x277D85DE8];
  return 1;
}

void __46__HMDHomeManager__findCloudHomeZonesToIgnore___block_invoke_630(uint64_t a1, void *a2)
{
  v5 = a2;
  v3 = _Block_copy(*(a1 + 40));
  if (v3)
  {
    v4 = [*(a1 + 32) copy];
    v3[2](v3, v4, v5);
  }
}

- (void)_reloadHomeDataFromLocalStore:(BOOL)a3
{
  v3 = a3;
  v73 = *MEMORY[0x277D85DE8];
  if (![(HMDHomeManager *)self homeDataLoadedFromArchive])
  {
    v5 = objc_autoreleasePoolPush();
    v6 = self;
    v7 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT))
    {
      v8 = HMFGetLogIdentifier();
      LODWORD(buf) = 138543362;
      *(&buf + 4) = v8;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Reload home data from archived file", &buf, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    v57 = 0;
    v58 = &v57;
    v59 = 0x2020000000;
    v60 = 0;
    *&buf = 0;
    *(&buf + 1) = &buf;
    v69 = 0x3032000000;
    v70 = __Block_byref_object_copy__172847;
    v71 = __Block_byref_object_dispose__172848;
    v72 = 0;
    v9 = objc_autoreleasePoolPush();
    if (isWatch())
    {
      v10 = *(&buf + 1);
      v11 = *(*(&buf + 1) + 40);
      v54 = 0;
      obj = v11;
      v12 = [HMDPersistentStore unarchiveHomeData:&obj decryptionFailed:v58 + 3 successfulKeyUserName:&v54];
      objc_storeStrong((v10 + 40), obj);
      v13 = v54;
      if (v12)
      {
        v14 = objc_autoreleasePoolPush();
        v15 = v6;
        v16 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
        {
          v46 = v14;
          v17 = HMFGetLogIdentifier();
          v18 = [v12 code];
          v19 = [v12 localizedDescription];
          *v62 = 138543874;
          v63 = v17;
          v64 = 2048;
          v65 = v18;
          v66 = 2112;
          v67 = v19;
          _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Could not load home data from archived file -- continuing with error %ld:%@", v62, 0x20u);

          v14 = v46;
        }

        objc_autoreleasePoolPop(v14);
      }

      else if ((v58[3] & 1) == 0 && *(*(&buf + 1) + 40))
      {
        v24 = [MEMORY[0x277CFEC78] systemStore];
        [v24 ensureControllerKeyExistsForAllViews];
      }
    }

    else
    {
      v20 = objc_autoreleasePoolPush();
      v21 = [HMDBackingStoreFetchArchiveOperation alloc];
      v56[0] = MEMORY[0x277D85DD0];
      v56[1] = 3221225472;
      v56[2] = __48__HMDHomeManager__reloadHomeDataFromLocalStore___block_invoke;
      v56[3] = &unk_2797317A8;
      v56[4] = v6;
      v56[5] = &buf;
      v56[6] = &v57;
      v22 = [(HMDBackingStoreFetchArchiveOperation *)v21 initWithFetchResult:v56];
      v23 = [(HMDHomeManager *)v6 backingStore];
      [v23 submit:v22];

      [(HMDBackingStoreFetchArchiveOperation *)v22 waitUntilFinished];
      objc_autoreleasePoolPop(v20);
    }

    if (*(v58 + 24) == 1 && v3)
    {
      v25 = [(HMDHomeManager *)v6 syncManager];
      objc_initWeak(v62, v6);
      v51[0] = MEMORY[0x277D85DD0];
      v51[1] = 3221225472;
      v51[2] = __48__HMDHomeManager__reloadHomeDataFromLocalStore___block_invoke_614;
      v51[3] = &unk_279732E78;
      objc_copyWeak(&v53, v62);
      v26 = v25;
      v52 = v26;
      [v26 pauseAndWaitForCurrentOperationCompletion:v51];

      objc_destroyWeak(&v53);
      objc_destroyWeak(v62);
    }

    objc_autoreleasePoolPop(v9);
    if (*(*(&buf + 1) + 40))
    {
      v27 = [(HMDHomeManager *)v6 messageDispatcher];
      v28 = [(HMDHomeManager *)v6 accessoryBrowserInternal];
      v29 = [(HMDHomeManager *)v6 msgFilterChain];
      v30 = *(*(&buf + 1) + 40);
      v31 = *(v58 + 24);
      v32 = [(HMDHomeManager *)v6 identityRegistry];
      v33 = [(HMDHomeManager *)v6 accountRegistry];
      LOBYTE(v45) = 1;
      [(HMDHomeManager *)v6 _loadMessageDispatcher:v27 accessoryBrowser:v28 messageFilterChain:v29 homeData:v30 localDataDecryptionFailed:v31 identityRegistry:v32 accountRegistry:v33 uncommittedTransactions:MEMORY[0x277CBEBF8] reloadData:v45];

      v34 = +[HMDUserManagementOperationManager sharedManager];
      [v34 setHomeManager:v6];
      v49 = 0u;
      v50 = 0u;
      v47 = 0u;
      v48 = 0u;
      v35 = [*(*(&buf + 1) + 40) pendingUserManagementOperations];
      v36 = [v35 countByEnumeratingWithState:&v47 objects:v61 count:16];
      if (v36)
      {
        v37 = *v48;
        do
        {
          for (i = 0; i != v36; ++i)
          {
            if (*v48 != v37)
            {
              objc_enumerationMutation(v35);
            }

            v39 = *(*(&v47 + 1) + 8 * i);
            [v39 updateDelegate:v6];
            [v34 addOperation:v39];
          }

          v36 = [v35 countByEnumeratingWithState:&v47 objects:v61 count:16];
        }

        while (v36);
      }

      [(HMDHomeManager *)v6 _checkForRemotePeers];
    }

    else
    {
      [(HMDHomeManager *)v6 setAccessAllowedWhenLocked:isiOSDevice()];
      v40 = objc_autoreleasePoolPush();
      v41 = v6;
      v42 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v42, OS_LOG_TYPE_INFO))
      {
        v43 = HMFGetLogIdentifier();
        *v62 = 138543362;
        v63 = v43;
        _os_log_impl(&dword_2531F8000, v42, OS_LOG_TYPE_INFO, "%{public}@No home data to reload from archived file", v62, 0xCu);
      }

      objc_autoreleasePoolPop(v40);
    }

    _Block_object_dispose(&buf, 8);

    _Block_object_dispose(&v57, 8);
  }

  v44 = *MEMORY[0x277D85DE8];
}

void __48__HMDHomeManager__reloadHomeDataFromLocalStore___block_invoke(uint64_t a1, void *a2, void *a3, void *a4)
{
  v43 = *MEMORY[0x277D85DE8];
  v7 = a2;
  v8 = a3;
  v9 = a4;
  if (!v9)
  {
    if (!v7)
    {
      goto LABEL_20;
    }

    v36 = 0;
    v16 = [HMDPersistentStore hasControllerKeyWithUsername:v8 error:&v36];
    v17 = v36;
    v18 = objc_autoreleasePoolPush();
    v19 = *(a1 + 32);
    v20 = HMFGetOSLogHandle();
    v21 = v20;
    if (v16)
    {
      if (os_log_type_enabled(v20, OS_LOG_TYPE_DEFAULT))
      {
        v22 = HMFGetLogIdentifier();
        *buf = 138543362;
        v38 = v22;
        _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_DEFAULT, "%{public}@Found controller key for loaded home data", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v18);
      v23 = [MEMORY[0x277CFEC78] systemStore];
      [v23 updateActiveControllerPairingIdentifier:v8];

      v24 = *(*(a1 + 40) + 8);
      obj = *(v24 + 40);
      v25 = [HMDPersistentStore deserializeHomeData:&obj localStorage:1 fromData:v7];
      objc_storeStrong((v24 + 40), obj);
      v18 = objc_autoreleasePoolPush();
      v19 = *(a1 + 32);
      v26 = HMFGetOSLogHandle();
      v21 = v26;
      if (v25)
      {
        if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
        {
          v27 = HMFGetLogIdentifier();
          v28 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{objc_msgSend(v7, "length")}];
          *buf = 138543618;
          v38 = v27;
          v39 = 2112;
          v40 = v28;
          _os_log_impl(&dword_2531F8000, v21, OS_LOG_TYPE_INFO, "%{public}@Deserialized homes size: %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v18);
        v29 = [MEMORY[0x277CFEC78] systemStore];
        [v29 ensureControllerKeyExistsForAllViews];

        goto LABEL_19;
      }

      if (os_log_type_enabled(v26, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543362;
        v38 = v30;
        v31 = "%{public}@Failed to deserialize homes from sql archive";
        v32 = v21;
        v33 = 12;
        goto LABEL_17;
      }
    }

    else if (os_log_type_enabled(v20, OS_LOG_TYPE_ERROR))
    {
      v30 = HMFGetLogIdentifier();
      *buf = 138543618;
      v38 = v30;
      v39 = 2112;
      v40 = v17;
      v31 = "%{public}@Could not find controller key in keychain error: %@";
      v32 = v21;
      v33 = 22;
LABEL_17:
      _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_ERROR, v31, buf, v33);
    }

    objc_autoreleasePoolPop(v18);
    *(*(*(a1 + 48) + 8) + 24) = 1;
LABEL_19:

    goto LABEL_20;
  }

  v10 = objc_autoreleasePoolPush();
  v11 = *(a1 + 32);
  v12 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
  {
    v13 = HMFGetLogIdentifier();
    v14 = [v9 code];
    v15 = [v9 localizedDescription];
    *buf = 138543874;
    v38 = v13;
    v39 = 2048;
    v40 = v14;
    v41 = 2112;
    v42 = v15;
    _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@Could not load home data from archived file -- continuing with error %ld:%@", buf, 0x20u);
  }

  objc_autoreleasePoolPop(v10);
LABEL_20:

  v34 = *MEMORY[0x277D85DE8];
}

void __48__HMDHomeManager__reloadHomeDataFromLocalStore___block_invoke_614(uint64_t a1)
{
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  v3 = WeakRetained;
  if (WeakRetained)
  {
    [WeakRetained _eraseLocalHomeData];
  }

  else
  {
    [*(a1 + 32) resume];
  }
}

- (void)reloadHomeDataFromLocalStore:(BOOL)a3
{
  v5 = [(HMDHomeManager *)self workQueue];
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __47__HMDHomeManager_reloadHomeDataFromLocalStore___block_invoke;
  v6[3] = &unk_279735D28;
  v6[4] = self;
  v7 = a3;
  dispatch_async(v5, v6);
}

- (id)accessoryWithIDSIdentifier:(id)a3
{
  v32 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v26 = 0u;
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  v5 = [(HMDHomeManager *)self homes];
  v21 = [v5 countByEnumeratingWithState:&v26 objects:v31 count:16];
  if (v21)
  {
    v6 = *v27;
    v20 = *v27;
    do
    {
      for (i = 0; i != v21; ++i)
      {
        if (*v27 != v6)
        {
          objc_enumerationMutation(v5);
        }

        v8 = *(*(&v26 + 1) + 8 * i);
        v22 = 0u;
        v23 = 0u;
        v24 = 0u;
        v25 = 0u;
        v9 = [v8 appleMediaAccessories];
        v10 = [v9 countByEnumeratingWithState:&v22 objects:v30 count:16];
        if (v10)
        {
          v11 = v10;
          v12 = *v23;
          while (2)
          {
            for (j = 0; j != v11; ++j)
            {
              if (*v23 != v12)
              {
                objc_enumerationMutation(v9);
              }

              v14 = *(*(&v22 + 1) + 8 * j);
              v15 = [v14 idsIdentifier];
              v16 = [v15 hmf_isEqualToUUID:v4];

              if (v16)
              {
                v17 = v14;

                goto LABEL_19;
              }
            }

            v11 = [v9 countByEnumeratingWithState:&v22 objects:v30 count:16];
            if (v11)
            {
              continue;
            }

            break;
          }
        }

        v6 = v20;
      }

      v17 = 0;
      v21 = [v5 countByEnumeratingWithState:&v26 objects:v31 count:16];
    }

    while (v21);
  }

  else
  {
    v17 = 0;
  }

LABEL_19:

  v18 = *MEMORY[0x277D85DE8];

  return v17;
}

- (id)accessoryWithUUID:(id)a3
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v14 = 0u;
  v15 = 0u;
  v16 = 0u;
  v17 = 0u;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
  if (v6)
  {
    v7 = v6;
    v8 = *v15;
    while (2)
    {
      for (i = 0; i != v7; ++i)
      {
        if (*v15 != v8)
        {
          objc_enumerationMutation(v5);
        }

        v10 = [*(*(&v14 + 1) + 8 * i) accessoryWithUUID:v4];
        if (v10)
        {
          v11 = v10;
          goto LABEL_11;
        }
      }

      v7 = [v5 countByEnumeratingWithState:&v14 objects:v18 count:16];
      if (v7)
      {
        continue;
      }

      break;
    }
  }

  v11 = 0;
LABEL_11:

  v12 = *MEMORY[0x277D85DE8];

  return v11;
}

- (void)_updateHomesDiscoveredBonjourServicesMetrics
{
  v28[2] = *MEMORY[0x277D85DE8];
  if (!isWatch())
  {
    v3 = [(HMDHomeManager *)self bonjourBrowser];

    if (!v3)
    {
      v4 = [HMDBonjourBrowserHelper alloc];
      v28[0] = @"_sleep-proxy._udp.";
      v28[1] = @"_meshcop._udp.";
      v5 = [MEMORY[0x277CBEA60] arrayWithObjects:v28 count:2];
      v6 = [(HMDHomeManager *)self workQueue];
      v7 = [(HMDBonjourBrowserHelper *)v4 initWithServicesOfTypes:v5 browsingTimeInterval:v6 browsingPeriodicity:20.0 workQueue:0.0];
      [(HMDHomeManager *)self setBonjourBrowser:v7];
    }
  }

  v8 = [(HMDHomeManager *)self bonjourBrowser];
  if (v8)
  {
    v9 = [(HMDHomeManager *)self homes];
    if ([v9 count])
    {
      v10 = [(HMDHomeManager *)self bonjourBrowser];
      v11 = [v10 isStarted];

      if ((v11 & 1) == 0)
      {
        v12 = [(HMDHomeManager *)self bonjourBrowserHelperLastCompletionDate];

        if (!v12)
        {
          goto LABEL_9;
        }

        v13 = [MEMORY[0x277CBEAA8] date];
        v14 = [(HMDHomeManager *)self bonjourBrowserHelperLastCompletionDate];
        [v13 timeIntervalSinceDate:v14];
        v16 = v15;

        v17 = [MEMORY[0x277D0F8D0] sharedPreferences];
        v18 = [v17 preferenceForKey:@"hapBonjourBrowserHelperPeriod"];
        v19 = [v18 numberValue];
        [v19 doubleValue];
        v21 = v20;

        if (v16 >= v21)
        {
LABEL_9:
          objc_initWeak(&location, self);
          v22 = [(HMDHomeManager *)self bonjourBrowser];
          v25[0] = MEMORY[0x277D85DD0];
          v25[1] = 3221225472;
          v25[2] = __62__HMDHomeManager__updateHomesDiscoveredBonjourServicesMetrics__block_invoke;
          v25[3] = &unk_279734708;
          objc_copyWeak(&v26, &location);
          [v22 startWithBrowsingCompletion:v25];

          v23 = [MEMORY[0x277CBEAA8] date];
          [(HMDHomeManager *)self setBonjourBrowserHelperLastCompletionDate:v23];

          objc_destroyWeak(&v26);
          objc_destroyWeak(&location);
        }
      }
    }

    else
    {
    }
  }

  v24 = *MEMORY[0x277D85DE8];
}

void __62__HMDHomeManager__updateHomesDiscoveredBonjourServicesMetrics__block_invoke(uint64_t a1, uint64_t a2)
{
  v24 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  v4 = WeakRetained;
  if (!a2)
  {
    v5 = MEMORY[0x277CCABB0];
    v6 = [WeakRetained bonjourBrowser];
    v7 = [v5 numberWithUnsignedInteger:{objc_msgSend(v6, "discoveredServicesCountForServiceType:", @"_meshcop._udp."}];

    v8 = MEMORY[0x277CCABB0];
    v9 = [v4 bonjourBrowser];
    v10 = [v8 numberWithUnsignedInteger:{objc_msgSend(v9, "discoveredServicesCountForServiceType:", @"_sleep-proxy._udp."}];

    v21 = 0u;
    v22 = 0u;
    v19 = 0u;
    v20 = 0u;
    v11 = [v4 homes];
    v12 = [v11 countByEnumeratingWithState:&v19 objects:v23 count:16];
    if (v12)
    {
      v13 = v12;
      v14 = *v20;
      do
      {
        for (i = 0; i != v13; ++i)
        {
          if (*v20 != v14)
          {
            objc_enumerationMutation(v11);
          }

          v16 = *(*(&v19 + 1) + 8 * i);
          if ([v16 homeLocation] == 1)
          {
            [v16 setAvailableBorderRouters:v7];
            [v16 setAvailableBSPsCount:v10];
          }
        }

        v13 = [v11 countByEnumeratingWithState:&v19 objects:v23 count:16];
      }

      while (v13);
    }
  }

  v17 = [v4 bonjourBrowser];
  [v17 stop];

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_monitorMemoryUsage
{
  v2 = [(HMDHomeManager *)self memoryTracker];
  [v2 trackMemoryUsageWithReason:1];
}

- (void)_loadMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 uncommittedTransactions:(id)a10 reloadData:(BOOL)a11
{
  v545 = a7;
  v605 = *MEMORY[0x277D85DE8];
  v550 = a3;
  v553 = a4;
  obj = a5;
  v549 = a5;
  v17 = a6;
  v548 = a8;
  v547 = a9;
  v552 = a10;
  v18 = &OBJC_IVAR___HMDBackingStore__dataSource;
  v19 = 0x277CBE000;
  v20 = 0x277CBE000;
  v554 = v17;
  if (a11)
  {
    goto LABEL_36;
  }

  v21 = [[HMDSyncOperationManager alloc] initWithClientQueue:self->_workQueue dataSource:self];
  syncManager = self->_syncManager;
  self->_syncManager = v21;

  v23 = [[HMDCloudAccount alloc] initWithClientQueue:self->_workQueue];
  cloudAccount = self->_cloudAccount;
  self->_cloudAccount = v23;

  v25 = [MEMORY[0x277CBEB38] dictionary];
  userPushCacheMap = self->_userPushCacheMap;
  self->_userPushCacheMap = v25;

  v27 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:10.0];
  watchPushDelayTimer = self->_watchPushDelayTimer;
  self->_watchPushDelayTimer = v27;

  [(HMFTimer *)self->_watchPushDelayTimer setDelegate:self];
  v29 = self->_watchPushDelayTimer;
  v30 = [(HMDHomeManager *)self workQueue];
  [(HMFTimer *)v29 setDelegateQueue:v30];

  v31 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:10.0];
  sharedHomesPushDelayTimer = self->_sharedHomesPushDelayTimer;
  self->_sharedHomesPushDelayTimer = v31;

  [(HMFTimer *)self->_sharedHomesPushDelayTimer setDelegate:self];
  v33 = self->_sharedHomesPushDelayTimer;
  v34 = [(HMDHomeManager *)self workQueue];
  [(HMFTimer *)v33 setDelegateQueue:v34];

  objc_storeStrong(&self->_messageDispatcher, a3);
  v35 = [[HMDBiomeLogEventObserver alloc] initWithBiomeEventManager:self->_biomeEventManager dataSource:self];
  biomeLogEventObserver = self->_biomeLogEventObserver;
  self->_biomeLogEventObserver = v35;

  v37 = [[HMDCompositeSettingsControllerManager alloc] initWithDataSource:self];
  compositeSettingsControllerManager = self->_compositeSettingsControllerManager;
  self->_compositeSettingsControllerManager = v37;

  v39 = [[HMDSiriEndpointOnboardingManager alloc] initWithDataSource:self];
  siriEndpointOnboardingManager = self->_siriEndpointOnboardingManager;
  self->_siriEndpointOnboardingManager = v39;

  v41 = objc_autoreleasePoolPush();
  v42 = self;
  v43 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v43, OS_LOG_TYPE_INFO))
  {
    v44 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v44;
    _os_log_impl(&dword_2531F8000, v43, OS_LOG_TYPE_INFO, "%{public}@Creating event router broker", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v41);
  v45 = objc_alloc(MEMORY[0x277D174B8]);
  v46 = eventStorePath;
  v47 = [v45 initWithFileName:v46];
  lastEventStore = v42->_lastEventStore;
  v42->_lastEventStore = v47;

  if (([(HMELastEventStore *)v42->_lastEventStore startup]& 1) != 0)
  {
    v49 = [[HMDLastEventStoreController alloc] initWithWithEventStore:v42->_lastEventStore];
    lastEventStoreController = v42->_lastEventStoreController;
    v42->_lastEventStoreController = v49;
  }

  else
  {
    v51 = objc_autoreleasePoolPush();
    v52 = v42;
    v53 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v53, OS_LOG_TYPE_FAULT))
    {
      v54 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v54;
      _os_log_impl(&dword_2531F8000, v53, OS_LOG_TYPE_FAULT, "%{public}@Unable to start event store", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v51);
  }

  v55 = objc_alloc(MEMORY[0x277D17498]);
  v56 = [(HMDHomeManager *)v42 workQueue];
  v57 = [v55 initWithQueue:v56 dataSource:v42 storeReadHandle:v42->_lastEventStore logCategory:"Router.RegistrationForwarding" identifier:0];
  registrationForwardingEventRouter = v42->_registrationForwardingEventRouter;
  v42->_registrationForwardingEventRouter = v57;

  v59 = objc_alloc(MEMORY[0x277D174C0]);
  v60 = [(HMDHomeManager *)v42 workQueue];
  v61 = [v59 initWithQueue:v60 storeReadHandle:v42->_lastEventStore storeWriteHandle:v42->_lastEventStore logCategory:"Router.LocalMemory"];
  memoryEventRouter = v42->_memoryEventRouter;
  v42->_memoryEventRouter = v61;

  [(HMEMemoryEventBus *)v42->_memoryEventRouter setDataSource:v42];
  v63 = v42->_memoryEventRouter;
  v17 = v554;
  if (objc_opt_respondsToSelector())
  {
    v64 = v42->_registrationForwardingEventRouter;
    v65 = [(HMEMemoryEventBus *)v42->_memoryEventRouter synchronousSubscriptionProvider];
    [(HMEDelegatingEventRouter *)v64 registerSubRouter:v65];
  }

  v66 = [HMDLoggingEventForwarder alloc];
  v67 = v42->_memoryEventRouter;
  v68 = [(HMDHomeManager *)v42 logEventSubmitter];
  v69 = [(HMDLoggingEventForwarder *)v66 initWithEventForwarder:v67 logEventSubmitter:v68];
  loggingMemoryEventForwarder = v42->_loggingMemoryEventForwarder;
  v42->_loggingMemoryEventForwarder = v69;

  [(HMDHomeManager *)v42 initializeMediaGroupParticipantDataLocalStorage];
  if (_os_feature_enabled_impl() && ![(HMDHomeManager *)v42 isResidentCapable])
  {
    v71 = [HMDRemoteEventRouterAssertionController alloc];
    v72 = [(HMDHomeManager *)v42 workQueue];
    v73 = [(HMDHomeManager *)v42 notificationCenter];
    v74 = [(HMDRemoteEventRouterAssertionController *)v71 initWithQueue:v72 notificationCenter:v73];
    [(HMDHomeManager *)v42 setEventRouterAssertionController:v74];

    v75 = [(HMDHomeManager *)v42 eventRouterAssertionController];
    [v75 configure];
  }

  objc_storeStrong(&v42->_accessoryBrowserInternal, a4);
  [(HMDAccessoryBrowser *)v42->_accessoryBrowserInternal setUnpairedAccessoryManagerDelegate:v42];
  v76 = [MEMORY[0x277CBEB58] set];
  pendingHomesBeingRemoved = v42->_pendingHomesBeingRemoved;
  v42->_pendingHomesBeingRemoved = v76;

  v78 = objc_alloc_init(HMDPowerManager);
  powerManager = v42->_powerManager;
  v42->_powerManager = v78;

  v42->_accountActive = 0;
  v42->_accountStatusFailedDueToNetworkFailure = 0;
  v42->_uploadToCloudIsPending = 0;
  v42->_uploadHomeDataToCloud = 0;
  objc_storeStrong(&v42->_identityRegistry, a8);
  cloudOperationRetryTimer = v42->_cloudOperationRetryTimer;
  v42->_cloudOperationRetryTimer = 0;

  v42->_lastAnswerForShouldCloudSyncData = 0;
  objc_storeStrong(&v42->_msgFilterChain, obj);
  v42->_cloudOperationRetryCount = 0;
  v42->_backOffOperationInProgress = 0;
  objc_storeStrong(&v42->_accountRegistry, a9);
  v81 = [v554 demoAccessories];
  demoAccessories = v42->_demoAccessories;
  v42->_demoAccessories = v81;

  v42->_demoFinalized = [v554 demoFinalized];
  [(HMDHomeManager *)v42 _migrateUniqueIdentifierPrefsIfNeeded];
  v83 = +[HMDAppleAccountSettings sharedSettings];
  [v83 synchronize];

  v42->_companionReachable = 0;
  v84 = +[HMDWatchSystemState sharedState];
  if (+[HMDDeviceCapabilities isCompanionCapable])
  {
    v85 = [HMDPairedSync alloc];
    v86 = [(HMDHomeManager *)v42 workQueue];
    v87 = [(HMDPairedSync *)v85 initWithDelegate:v42 queue:v86];
    pairedSync = v42->_pairedSync;
    v42->_pairedSync = v87;

    v89 = &OBJC_IVAR___HMDHomeManager__watchManager;
    v90 = off_27971A268;
LABEL_18:
    v93 = [(__objc2_class *)*v90 sharedManager];
    v94 = *v89;
    v95 = *(&v42->super.super.isa + v94);
    *(&v42->super.super.isa + v94) = v93;

    goto LABEL_19;
  }

  v91 = [MEMORY[0x277D0F8E8] productInfo];
  v92 = [v91 productPlatform];

  if (v92 == 3)
  {
    v89 = &OBJC_IVAR___HMDHomeManager__companionManager;
    v90 = off_27971A098;
    goto LABEL_18;
  }

LABEL_19:
  if (+[HMDSoftwareUpdateManager isSupported])
  {
    v96 = objc_alloc_init(HMDSoftwareUpdateManager);
    softwareUpdateManager = v42->_softwareUpdateManager;
    v42->_softwareUpdateManager = v96;
  }

  v42->_uploadMetadataToCloud = 0;
  v42->_cloudkitAccountStatusDetermined = 0;
  v42->_generationCounter = 0;
  if (v42->_generationCounterToken == -1)
  {
    v98 = [(HMDHomeManager *)v42 darwinNotificationProvider];
    v99 = [v98 notifyRegisterCheck:*MEMORY[0x277CD0200] outToken:&v42->_generationCounterToken];

    if (!v99)
    {
      v584 = 0;
      v100 = [(HMDHomeManager *)v42 darwinNotificationProvider];
      [v100 notifyGetState:v42->_generationCounterToken state:&v584];

      if (!v584)
      {
        v101 = objc_autoreleasePoolPush();
        v102 = v42;
        v103 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v103, OS_LOG_TYPE_DEFAULT))
        {
          v104 = HMFGetLogIdentifier();
          *buf = 138543362;
          *&buf[4] = v104;
          _os_log_impl(&dword_2531F8000, v103, OS_LOG_TYPE_DEFAULT, "%{public}@Generation counter for notification token is zero - refreshing from persisted configuration", buf, 0xCu);
        }

        objc_autoreleasePoolPop(v101);
        v105 = [(HMDHomeManager *)v102 userDefaults];
        v584 = [v105 integerForKey:@"HMDHomeManagerGenerationCounter"];

        if (!v584)
        {
          v106 = objc_autoreleasePoolPush();
          v107 = v102;
          v108 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v108, OS_LOG_TYPE_DEFAULT))
          {
            v109 = HMFGetLogIdentifier();
            *buf = 138543362;
            *&buf[4] = v109;
            _os_log_impl(&dword_2531F8000, v108, OS_LOG_TYPE_DEFAULT, "%{public}@Persisted generation counter is zero - need to invalidate client caches", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v106);
        }
      }

      v110 = objc_autoreleasePoolPush();
      v111 = v42;
      v112 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v112, OS_LOG_TYPE_DEFAULT))
      {
        v113 = HMFGetLogIdentifier();
        *buf = 138543618;
        *&buf[4] = v113;
        *&buf[12] = 2048;
        *&buf[14] = v584;
        _os_log_impl(&dword_2531F8000, v112, OS_LOG_TYPE_DEFAULT, "%{public}@Initializing with generation counter %llu", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v110);
      v42->_generationCounter = v584;
    }
  }

  v114 = [MEMORY[0x277CBEB58] set];
  unassociatedRemotePeers = v42->_unassociatedRemotePeers;
  v42->_unassociatedRemotePeers = v114;

  v116 = [MEMORY[0x277CBEB38] dictionary];
  associatedRemotePeers = v42->_associatedRemotePeers;
  v42->_associatedRemotePeers = v116;

  v118 = [MEMORY[0x277CBEB38] dictionary];
  associatedWatchPeers = v42->_associatedWatchPeers;
  v42->_associatedWatchPeers = v118;

  v120 = [MEMORY[0x277CBEB38] dictionary];
  watchSyncStateMap = v42->_watchSyncStateMap;
  v42->_watchSyncStateMap = v120;

  v122 = [MEMORY[0x277CBEB58] set];
  fullSyncedWatchPeers = v42->_fullSyncedWatchPeers;
  v42->_fullSyncedWatchPeers = v122;

  v124 = [MEMORY[0x277CBEB38] dictionary];
  watchSyncRetryContextBySyncIdentifier = v42->_watchSyncRetryContextBySyncIdentifier;
  v42->_watchSyncRetryContextBySyncIdentifier = v124;

  v126 = [MEMORY[0x277CCAB00] strongToStrongObjectsMapTable];
  watchSyncRetryContextByRetryTimer = v42->_watchSyncRetryContextByRetryTimer;
  v42->_watchSyncRetryContextByRetryTimer = v126;

  v128 = [MEMORY[0x277CBEB18] array];
  pendingResponsesForAccessoryFinder = v42->_pendingResponsesForAccessoryFinder;
  v42->_pendingResponsesForAccessoryFinder = v128;

  v130 = [MEMORY[0x277CBEB38] dictionary];
  pendingRemoteSessions = v42->_pendingRemoteSessions;
  v42->_pendingRemoteSessions = v130;

  v132 = [MEMORY[0x277CBEB58] set];
  pendingResidentSetupSessions = v42->_pendingResidentSetupSessions;
  v42->_pendingResidentSetupSessions = v132;

  v134 = HMDispatchQueueNameString();
  v135 = [v134 UTF8String];
  v136 = dispatch_queue_attr_make_with_autorelease_frequency(0, DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM);
  v137 = dispatch_queue_create(v135, v136);
  clientConnectionQueue = v42->_clientConnectionQueue;
  v42->_clientConnectionQueue = v137;

  v139 = [[HMDClientConnection alloc] initWithHomeManager:v42 queue:v42->_clientConnectionQueue messageDispatcher:self->_messageDispatcher];
  clientConnection = v42->_clientConnection;
  v42->_clientConnection = v139;

  v141 = [[HMDAssistantGather alloc] initWithHomeManager:v42 queue:v42->_clientConnectionQueue];
  gatherer = v42->_gatherer;
  v42->_gatherer = v141;

  v143 = [(HMDHomeManager *)v42 _getAssistantHashingData];
  [(HMDHomeManager *)v42 _setAssistantHashingData:v143];

  v144 = +[HMDLaunchHandler sharedHandler];
  [v144 removePersistentRelaunchRegistrationsIfNecessary];

  v145 = [MEMORY[0x277CBEB38] dictionary];
  pendingFragmentationStream = v42->_pendingFragmentationStream;
  v42->_pendingFragmentationStream = v145;

  v147 = +[HMDPersistentStore unarchiveIDSDataSyncJournal];
  pendingDataSyncAcks = v42->_pendingDataSyncAcks;
  v42->_pendingDataSyncAcks = v147;

  v42->_ignoreFirstTimeReachabilityChanged = 1;
  v149 = [MEMORY[0x277CBEB58] set];
  dialogCancelationContexts = v42->_dialogCancelationContexts;
  v42->_dialogCancelationContexts = v149;

  v151 = +[HMDLocation sharedManager];
  locationHandler = v42->_locationHandler;
  v42->_locationHandler = v151;

  [(HMDHomeManager *)v42 startFindMyHandler];
  v42->_needToCleanUpKeys = 0;
  v153 = [HMDCHIPDataSource alloc];
  v154 = [(HMDHomeManager *)v42 dataSource];
  v155 = [v154 threadClientFactory];
  v156 = [(HMDCHIPDataSource *)v153 initWithHomeManager:v42 threadClientFactory:v155];
  chipDataSource = v42->_chipDataSource;
  v42->_chipDataSource = v156;

  v158 = [[HMDAccessorySetupManager alloc] initWithWorkQueue:self->_workQueue homeManager:v42];
  accessorySetupManager = v42->_accessorySetupManager;
  v42->_accessorySetupManager = v158;

  [(HMDAccessorySetupManager *)v42->_accessorySetupManager configure];
  v160 = [HMDAccessorySetupCoordinator alloc];
  workQueue = self->_workQueue;
  v162 = [(HMDAccessorySetupManager *)v42->_accessorySetupManager messageDispatcher];
  v163 = [(HMDAccessoryBrowser *)v42->_accessoryBrowserInternal chipAccessoryServerBrowser];
  v164 = [(HMDAccessorySetupCoordinator *)v160 initWithWorkQueue:workQueue messageDispatcher:v162 chipAccessoryServerBrowser:v163 chipDataSource:v42->_chipDataSource];
  accessorySetupCoordinator = v42->_accessorySetupCoordinator;
  v42->_accessorySetupCoordinator = v164;

  [(HMDAccessorySetupCoordinator *)v42->_accessorySetupCoordinator configure];
  [(HMDAccessorySetupManager *)v42->_accessorySetupManager setAccessorySetupCoordinator:v42->_accessorySetupCoordinator];
  v166 = [[HMDMTSPairingServer alloc] initWithAccessoryBrowser:v553];
  v167 = [[HMDMTSDeviceSetupServer alloc] initWithAccessorySetupManager:v42->_accessorySetupManager];
  v168 = 0;
  if (_os_feature_enabled_impl())
  {
    v169 = [HMDMTSNetworkCredentialServer alloc];
    v170 = [v553 chipAccessoryServerBrowser];
    v171 = [v170 systemCommissionerPairingManager];
    v168 = [(HMDMTSNetworkCredentialServer *)v169 initWithSystemCommissionerPairingManager:v171];
  }

  v172 = [[HMDMTSAuthorizationServer alloc] initWithAccountManager:v42->_appleAccountManager];
  v173 = [[HMDMTSXPCServer alloc] initWithPairingServer:v166 deviceSetupServer:v167 networkCredentialServer:v168 authorizationServer:v172];
  mtsXPCServer = v42->_mtsXPCServer;
  v42->_mtsXPCServer = v173;

  [(HMDMTSXPCServer *)v42->_mtsXPCServer start];
  v175 = [HMDCameraRecordingLoadBalancer alloc];
  v176 = objc_alloc_init(MEMORY[0x277D14DC8]);
  v177 = [(HMDCameraRecordingLoadBalancer *)v175 initWithHomeManager:v42 resourceUsageMonitor:v176];
  cameraLoadBalancer = v42->_cameraLoadBalancer;
  v42->_cameraLoadBalancer = v177;

  [(HMDCameraRecordingLoadBalancer *)v42->_cameraLoadBalancer start];
  v179 = [[HMDCameraClipsQuotaMessenger alloc] initWithWorkQueue:self->_workQueue messageDispatcher:self->_messageDispatcher];
  cameraClipsQuotaMessenger = v42->_cameraClipsQuotaMessenger;
  v42->_cameraClipsQuotaMessenger = v179;

  [(HMDCameraClipsQuotaMessenger *)v42->_cameraClipsQuotaMessenger configure];
  v20 = 0x277CBE000;
  v19 = 0x277CBE000uLL;
  v18 = &OBJC_IVAR___HMDBackingStore__dataSource;
LABEL_36:
  v181 = [[HMDMicroLocationManager alloc] initWithLocationManager:*(&self->super.super.isa + v18[383])];
  microLocationManager = self->_microLocationManager;
  self->_microLocationManager = v181;

  v183 = [[HMDMicroLocationLogEventObserver alloc] initWithDataSource:self microLocationManager:self->_microLocationManager];
  microLocationLogEventObserver = self->_microLocationLogEventObserver;
  self->_microLocationLogEventObserver = v183;

  self->_siriSyncNotificationTime = 0;
  v185 = +[HMDDeviceCapabilities deviceCapabilities];
  v186 = [v185 supportsHomeInvitation];

  if (v186)
  {
    v187 = [HMDHH1IDSInvitationManager alloc];
    v188 = [(HMDHomeManager *)self workQueue];
    v189 = [(HMDHH1IDSInvitationManager *)v187 initWithHomeManager:self workQueue:v188];
    idsInvitationManager = self->_idsInvitationManager;
    self->_idsInvitationManager = v189;
  }

  v191 = [*(v19 + 2904) set];
  mergeIDsOfUsersOfRemovedSharedHomes = self->_mergeIDsOfUsersOfRemovedSharedHomes;
  self->_mergeIDsOfUsersOfRemovedSharedHomes = v191;

  self->_homeDataLoadedFromArchive = v17 != 0;
  if (v17)
  {
    v193 = [v17 accessAllowedWhenLocked];
  }

  else
  {
    v193 = isiOSDevice();
  }

  self->_accessAllowedWhenLocked = v193;
  v194 = [v17 unprocessedOperationIdentifiers];

  if (v194)
  {
    v195 = *(v19 + 2904);
    v196 = [v17 unprocessedOperationIdentifiers];
    v197 = [v195 setWithArray:v196];
    unprocessedOperationModelIdentifiers = self->_unprocessedOperationModelIdentifiers;
    self->_unprocessedOperationModelIdentifiers = v197;

LABEL_43:
    goto LABEL_45;
  }

  if (!self->_unprocessedOperationModelIdentifiers)
  {
    v306 = [*(v19 + 2904) set];
    v196 = self->_unprocessedOperationModelIdentifiers;
    self->_unprocessedOperationModelIdentifiers = v306;
    goto LABEL_43;
  }

LABEL_45:
  v199 = [v17 homes];

  if (v199)
  {
    v200 = [v17 homes];
    [(HMDHomeManager *)self setHomes:v200];
  }

  if ([v17 dataVersion] <= 2)
  {
    v582 = 0u;
    v583 = 0u;
    v580 = 0u;
    v581 = 0u;
    v201 = self->_homes;
    v202 = [(NSMutableArray *)v201 countByEnumeratingWithState:&v580 objects:v604 count:16];
    if (v202)
    {
      v203 = v202;
      v204 = *v581;
      do
      {
        for (i = 0; i != v203; ++i)
        {
          if (*v581 != v204)
          {
            objc_enumerationMutation(v201);
          }

          v206 = *(*(&v580 + 1) + 8 * i);
          v207 = [v206 allowsRemoteAccess];
          v576 = 0u;
          v577 = 0u;
          v578 = 0u;
          v579 = 0u;
          v208 = [v206 users];
          v209 = [v208 countByEnumeratingWithState:&v576 objects:v603 count:16];
          if (v209)
          {
            v210 = v209;
            v211 = *v577;
            do
            {
              for (j = 0; j != v210; ++j)
              {
                if (*v577 != v211)
                {
                  objc_enumerationMutation(v208);
                }

                [*(*(&v576 + 1) + 8 * j) setRemoteAccessAllowed:v207];
              }

              v210 = [v208 countByEnumeratingWithState:&v576 objects:v603 count:16];
            }

            while (v210);
          }
        }

        v203 = [(NSMutableArray *)v201 countByEnumeratingWithState:&v580 objects:v604 count:16];
      }

      while (v203);
    }

    v17 = v554;
    v20 = 0x277CBE000uLL;
  }

  v213 = [v17 primaryHomeUUID];
  primaryHomeUUID = self->_primaryHomeUUID;
  self->_primaryHomeUUID = v213;

  self->_homeManagerZoneFirstFetch = 1;
  v215 = *(v20 + 2840);
  v216 = [v17 cloudZones];
  v217 = [v215 arrayWithArray:v216];
  cloudZones = self->_cloudZones;
  self->_cloudZones = v217;

  v219 = [v17 lastCurrentHomeUUID];
  lastCurrentHomeUUID = self->_lastCurrentHomeUUID;
  self->_lastCurrentHomeUUID = v219;

  v221 = [v17 dataTag];
  dataTag = self->_dataTag;
  self->_dataTag = v221;

  v223 = [v17 UUIDsOfRemovedHomes];
  if (v223 && (v224 = v223, v225 = isWatch(), v224, !v225))
  {
    v228 = *(v20 + 2840);
    v227 = [v17 UUIDsOfRemovedHomes];
    v229 = [v228 arrayWithArray:v227];
    uuidsOfRemovedHomes = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = v229;
  }

  else
  {
    v226 = [*(v20 + 2840) array];
    v227 = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = v226;
  }

  self->_residentEnabledState = [v17 residentEnabledState];
  v231 = getAssistantConfigurationVersion();
  self->_assistantGenerationCounter = [v231 unsignedIntegerValue];

  self->_homeDatabaseSize = 0;
  v232 = [v17 UUIDsOfRemovedHomes];
  if (v232 && (v233 = v232, v234 = isWatch(), v233, !v234))
  {
    v237 = *(v20 + 2840);
    v236 = [v17 UUIDsOfRemovedHomes];
    v238 = [v237 arrayWithArray:v236];
    v239 = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = v238;
  }

  else
  {
    v235 = [*(v20 + 2840) array];
    v236 = self->_uuidsOfRemovedHomes;
    self->_uuidsOfRemovedHomes = v235;
  }

  v240 = +[HMDDeviceCapabilities deviceCapabilities];
  v241 = [v240 supportsFirmwareUpdate];

  if (v241)
  {
    v242 = objc_autoreleasePoolPush();
    v243 = self;
    v244 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v244, OS_LOG_TYPE_DEBUG))
    {
      v245 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v245;
      _os_log_impl(&dword_2531F8000, v244, OS_LOG_TYPE_DEBUG, "%{public}@Starting AccessoryFirmwareUpdateManager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v242);
    v246 = [[HMDAccessoryFirmwareUpdateManager alloc] initWithHomeManager:v243];
    accessoryFirmwareUpdateManager = v243->_accessoryFirmwareUpdateManager;
    v243->_accessoryFirmwareUpdateManager = v246;
  }

  if ((_os_feature_enabled_impl() & 1) != 0 || CFPreferencesGetAppBooleanValue(@"MatterOTA", @"/Library/Managed Preferences/mobile/com.apple.homed.plist", 0))
  {
    v248 = [[HMDMatterSoftwareUpdateProviderDelegate alloc] initWithHomeManager:self accessoryFirmwareUpdateManager:self->_accessoryFirmwareUpdateManager];
    matterSoftwareUpdateProviderDelegate = self->_matterSoftwareUpdateProviderDelegate;
    self->_matterSoftwareUpdateProviderDelegate = v248;
  }

  v250 = [v17 accessories];
  v251 = [v17 homes];
  [(HMDHomeManager *)self _associateAccessories:v250 withHomes:v251];

  [(HMDHomeManager *)self _auditKeychainEntries];
  if ([(HMDHomeManager *)self _updateAccessoriesConfigured])
  {
    [(HMDHomeManager *)self _postPreferencesChangedNotification];
  }

  v574 = 0u;
  v575 = 0u;
  v572 = 0u;
  v573 = 0u;
  v252 = [v17 homes];
  v253 = [v252 countByEnumeratingWithState:&v572 objects:v602 count:16];
  if (v253)
  {
    v254 = v253;
    v255 = *v573;
    do
    {
      for (k = 0; k != v254; ++k)
      {
        if (*v573 != v255)
        {
          objc_enumerationMutation(v252);
        }

        [*(*(&v572 + 1) + 8 * k) fixupHomeAfterDecoding];
      }

      v254 = [v252 countByEnumeratingWithState:&v572 objects:v602 count:16];
    }

    while (v254);
  }

  v257 = [v17 incomingInvitations];
  v258 = [v257 mutableCopy];

  v259 = v258;
  if (!v258)
  {
    v259 = [*(v20 + 2840) array];
  }

  objc_storeStrong(&self->_incomingInvitations, v259);
  if (!v258)
  {
  }

  if (self->_residentEnabledState == 1)
  {
    v260 = [MEMORY[0x277D0F8E8] productInfo];
    v261 = [v260 productClass];

    if (v261 == 4)
    {
      v262 = objc_autoreleasePoolPush();
      v263 = self;
      v264 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v264, OS_LOG_TYPE_DEFAULT))
      {
        v265 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v265;
        _os_log_impl(&dword_2531F8000, v264, OS_LOG_TYPE_DEFAULT, "%{public}@Force enabling as a resident", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v262);
      self->_residentEnabledState = 2;
    }
  }

  if (a11)
  {
    v266 = [(HMDHomeManager *)self uuid];
    [(HMDHomeManager *)self updateGenerationCounterWithReason:@"ReloadHomeData" sourceUUID:v266 shouldNotifyClients:0];

    v267 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v268 = [(HMDHomeManager *)self homes];
    [v267 updateTotalHomes:{objc_msgSend(v268, "count")}];

    v269 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    [v269 updateLocalDataDecryptionFailed:v545];

    goto LABEL_140;
  }

  HMFUptime();
  v271 = v270;
  v272 = objc_autoreleasePoolPush();
  v273 = self;
  v274 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v274, OS_LOG_TYPE_DEBUG))
  {
    v275 = HMFGetLogIdentifier();
    *buf = 138544386;
    *&buf[4] = v275;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v591 = @"Start backing store setup";
    v592 = 2114;
    v593 = @"state";
    v594 = 2112;
    v595 = @"homeManagerLoadingBackingStore";
    _os_log_impl(&dword_2531F8000, v274, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v272);
  v276 = [MEMORY[0x277D17DE8] sharedInstance];
  v277 = objc_alloc(MEMORY[0x277D17DF8]);
  v600 = @"state";
  v601 = @"homeManagerLoadingBackingStore";
  v278 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v601 forKeys:&v600 count:1];
  v279 = [v277 initWithTag:@"homeManagerInitStart" data:v278];
  v280 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [v276 submitTaggedEvent:v279 processorList:v280];

  v281 = [(HMDHomeManager *)v273 dataSource];
  v282 = [v281 createBackingStoreForHomeManager:v273 error:0];
  backingStore = v273->_backingStore;
  v273->_backingStore = v282;

  [(HMDBackingStore *)v273->_backingStore setDelegate:v273];
  v284 = [(HMDHomeManager *)v273 appleAccountManager];
  [v284 configureWithBackingStore:v273->_backingStore];

  v285 = [(HMDHomeManager *)v273 remoteAccountManager];
  [v285 setBackingStore:v273->_backingStore];

  v286 = objc_autoreleasePoolPush();
  v287 = v273;
  v288 = HMFGetOSLogHandle();
  v543 = v287;
  if (os_log_type_enabled(v288, OS_LOG_TYPE_INFO))
  {
    v289 = HMFGetLogIdentifier();
    v290 = MEMORY[0x277CCACA8];
    HMFUptime();
    v292 = [v290 stringWithFormat:@"%.3f", v291 - v271];
    *buf = 138544898;
    *&buf[4] = v289;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v591 = @"Backing store setup done";
    v592 = 2114;
    v593 = @"state";
    v594 = 2112;
    v595 = @"homeManagerLoadedBackingStore";
    v596 = 2114;
    v597 = @"duration";
    v598 = 2112;
    v599 = v292;
    _os_log_impl(&dword_2531F8000, v288, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);

    v287 = v543;
  }

  objc_autoreleasePoolPop(v286);
  v293 = [MEMORY[0x277D17DE8] sharedInstance];
  v294 = objc_alloc(MEMORY[0x277D17DF8]);
  v295 = MEMORY[0x277CCACA8];
  HMFUptime();
  v297 = [v295 stringWithFormat:@"%.3f", v296 - v271];
  v298 = HMDTaggedLoggingCreateDictionary();
  v299 = [v294 initWithTag:@"homeManagerInitStart" data:{v298, @"state", @"homeManagerLoadedBackingStore", @"duration", v297}];
  v300 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [v293 submitTaggedEvent:v299 processorList:v300];

  v301 = v543;
  v302 = +[HMDDeviceCapabilities deviceCapabilities];
  LODWORD(v293) = [v302 supportsCloudDataSync];

  v17 = v554;
  if (v293)
  {
    if (disableCloudDataSync == 1)
    {
      v303 = objc_autoreleasePoolPush();
      v304 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v304, OS_LOG_TYPE_DEFAULT))
      {
        v305 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v305;
        _os_log_impl(&dword_2531F8000, v304, OS_LOG_TYPE_DEFAULT, "%{public}@Not creating the cloud data sync filter due to preference setting present on the device", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v303);
      v543->_accountActive = 1;
      goto LABEL_139;
    }

    if ((enableRetailDemoSetup & 1) != 0 || v543->_demoFinalized)
    {
      v307 = objc_autoreleasePoolPush();
      v308 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v308, OS_LOG_TYPE_DEFAULT))
      {
        v309 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v309;
        _os_log_impl(&dword_2531F8000, v308, OS_LOG_TYPE_DEFAULT, "%{public}@Not creating the cloud data sync filter because the device is in demo mode", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v307);
      v543->_accountActive = 1;
      v310 = [(HMDHomeManager *)v543 homes];
      [v310 hmf_enumerateWithAutoreleasePoolUsingBlock:&__block_literal_global_567];

      [(HMDHomeManager *)v543 _scheduleSendHomeDataToAllWatches];
      goto LABEL_139;
    }

    +[HMDPersistentStore removeServerTokenDataFile];
    v311 = [(HMDHomeManager *)v543 dataSource];
    v312 = [v311 createCloudCacheForHomeManager:v543 backingStore:v273->_backingStore workQueue:v543->_workQueue];

    v313 = dispatch_group_create();
    dispatch_group_enter(v313);
    v570[0] = MEMORY[0x277D85DD0];
    v570[1] = 3221225472;
    v570[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_2;
    v570[3] = &unk_2797359D8;
    v314 = v313;
    v571 = v314;
    [v312 createAndFetchZonesFromBackingStore:v570];
    v315 = objc_autoreleasePoolPush();
    v316 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v316, OS_LOG_TYPE_INFO))
    {
      v317 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v317;
      _os_log_impl(&dword_2531F8000, v316, OS_LOG_TYPE_INFO, "%{public}@Waiting for cloudCache to be created", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v315);
    dispatch_group_wait(v314, 0xFFFFFFFFFFFFFFFFLL);
    v318 = [v312 legacyZone];
    v319 = [v318 isHomeDataRecordAvailable];

    v542 = v314;
    if (v545)
    {
      v320 = objc_autoreleasePoolPush();
      v321 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v321, OS_LOG_TYPE_DEFAULT))
      {
        v322 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v322;
        _os_log_impl(&dword_2531F8000, v321, OS_LOG_TYPE_DEFAULT, "%{public}@Dropping locally cached legacy cloud record because local decryption has failed", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v320);
      v323 = [v312 legacyZone];
      [v323 setServerChangeToken:0];

      v324 = [v312 legacyZone];
      [v324 dropCachedRecords];

      v325 = objc_autoreleasePoolPush();
      v326 = v543;
      v327 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v327, OS_LOG_TYPE_INFO))
      {
        v328 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v328;
        _os_log_impl(&dword_2531F8000, v327, OS_LOG_TYPE_INFO, "%{public}@Resetting databaseServerChangeToken because record conflict", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v325);
      [v312 setDatabaseServerChangeToken:0];
      [v312 persistDatabaseServerChangeToken];
    }

    else if (v319)
    {
      v539 = 1;
LABEL_131:
      v337 = [v312 legacyZone];
      v338 = [v337 serverChangeToken];
      v339 = v338 != 0;

      v340 = v312;
      v341 = [v312 homeManagerZone];
      v342 = [v341 serverChangeToken];
      v343 = v342 != 0;

      v344 = [(HMDHomeManager *)v543 appleAccountManager];
      v345 = [HMDCloudDataSyncStateFilter alloc];
      v346 = [(HMDHomeManager *)v543 messageDispatcher];
      v347 = [(HMDHomeManager *)v543 homes];
      v348 = [v347 count];
      v540 = v344;
      v349 = [v344 account];
      LOBYTE(v538) = v545;
      v350 = [(HMDCloudDataSyncStateFilter *)v345 initWithName:@"CloudDataSync" homeManager:v543 messageDispatcher:v346 serverTokenAvailable:v339 homeDataHasBeenDecrypted:v539 homeManagerServerTokenAvailable:v343 localDataDecryptionFailed:v538 totalHomes:v348 currentAccount:v349];

      [v549 addMessageFilter:v350];
      objc_storeStrong(&v543->_cloudDataSyncStateFilter, v350);
      v351 = +[HMDAppleAccountSettings sharedSettings];
      v352 = [v351 isHomeEnabled];

      v353 = objc_autoreleasePoolPush();
      v354 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v354, OS_LOG_TYPE_DEFAULT))
      {
        v355 = HMFGetLogIdentifier();
        v356 = v355;
        v357 = "not ";
        if (v352)
        {
          v357 = "";
        }

        *buf = 138543618;
        *&buf[4] = v355;
        *&buf[12] = 2080;
        *&buf[14] = v357;
        _os_log_impl(&dword_2531F8000, v354, OS_LOG_TYPE_DEFAULT, "%{public}@Updating the cloud sync filter state with iCloud switch state to: %senabled", buf, 0x16u);
      }

      objc_autoreleasePoolPop(v353);
      v358 = [(HMDHomeManager *)v543 cloudDataSyncStateFilter];
      [v358 updateiCloudSwitchState:v352];

      v359 = [[HMDCloudManagerDataSource alloc] initWithHomeManager:v543];
      cloudDataSource = v543->_cloudDataSource;
      v543->_cloudDataSource = v359;

      v361 = [HMDCloudManager alloc];
      v362 = [(HMDHomeManager *)v543 cloudDataSource];
      v363 = [(HMDHomeManager *)v543 syncManager];
      v364 = [(HMDHomeManager *)v543 logEventSubmitter];
      v365 = [(HMDCloudManager *)v361 initWithMessageDispatcher:v550 cloudDataSyncStateFilter:v350 cloudCache:v340 delegate:v543 dataSource:v362 syncManager:v363 logEventSubmitter:v364 callbackQueue:v543->_workQueue];
      cloudDataSyncManager = v543->_cloudDataSyncManager;
      v543->_cloudDataSyncManager = v365;

      v301 = v543;
      if (v352 && [v540 isLoggedInToPrimaryAccount])
      {
        [(HMDCloudManager *)v543->_cloudDataSyncManager registerForPushNotifications];
      }

      v367 = [(HMDHomeManager *)v543 appleAccountManager];
      v368 = [(HMDCloudManager *)v543->_cloudDataSyncManager cloudCache];
      [v367 setCloudCache:v368];

      v17 = v554;
      goto LABEL_139;
    }

    if ([v554 dataVersion] >= 4 && objc_msgSend(v554, "schemaVersion") <= 4)
    {
      v329 = objc_autoreleasePoolPush();
      v330 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v330, OS_LOG_TYPE_DEFAULT))
      {
        v331 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v331;
        _os_log_impl(&dword_2531F8000, v330, OS_LOG_TYPE_DEFAULT, "%{public}@Resetting the legacy server token for migration", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v329);
      v332 = [v312 legacyZone];
      [v332 setServerChangeToken:0];

      v333 = objc_autoreleasePoolPush();
      v334 = v543;
      v335 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v335, OS_LOG_TYPE_INFO))
      {
        v336 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v336;
        _os_log_impl(&dword_2531F8000, v335, OS_LOG_TYPE_INFO, "%{public}@Resetting databaseServerChangeToken for migration", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v333);
      [v312 setDatabaseServerChangeToken:0];
      [v312 persistDatabaseServerChangeToken];
    }

    v539 = 0;
    goto LABEL_131;
  }

LABEL_139:
  [(HMDHomeManager *)v301 _registerForMessages];
  [(HMDHomeManager *)v301 __checkForBootTimeLogout];
LABEL_140:
  v369 = objc_alloc_init(HMDIDSServerBag);
  [(HMDHomeManager *)self setIdsServerBag:v369];

  v370 = [(HMDHomeManager *)self idsServerBag];
  [v370 setDelegate:self];

  v371 = [v17 homes];
  v372 = v371;
  if (v371)
  {
    v373 = v371;
  }

  else
  {
    v373 = MEMORY[0x277CBEBF8];
  }

  v374 = [(HMDHomeManager *)self _configureHomes:v373 uncommittedTransactions:v552];

  -[HMDHomeManager setRecoveryVersion:](self, "setRecoveryVersion:", [v17 recoveryVersion]);
  -[HMDHomeManager migrateModelObjectsToCloud:schemaVersion:](self, "migrateModelObjectsToCloud:schemaVersion:", [v17 dataVersion], objc_msgSend(v17, "schemaVersion"));
  v375 = [HMDApplicationData alloc];
  v376 = [v17 applicationData];
  v377 = [v376 dictionary];
  v378 = [(HMDApplicationData *)v375 initWithDictionary:v377 parentUUID:self->_uuid];
  appData = self->_appData;
  self->_appData = v378;

  if (a11)
  {
    [(HMDHomeManager *)self updatePowerAssertion];
    v380 = [v17 accessories];
    v381 = [v380 count];

    if (v381)
    {
      v382 = [(HMDHomeManager *)self accessoryBrowserInternal];
      [v382 startDiscoveringPairedAccessories];
    }
  }

  else
  {
    [(HMDPowerManager *)self->_powerManager start];
    [(HMDHomeManager *)self updatePowerAssertion];
    [(HMDHomeManager *)self _monitorReachability];
    [(HMDHomeManager *)self _checkForAccountChanged];
    [(HMDHomeManager *)self _fetchDataFromCloud];
    v383 = [(HMDHomeManager *)self mobileAssetManager];
    [v383 handleMetadataAssetUpdated];

    v384 = [(HMDHomeManager *)self notificationCenter];
    [v384 addObserver:self selector:sel_accountAvailabilityChanged_ name:*MEMORY[0x277CBBF00] object:0];

    v385 = [(HMDHomeManager *)self notificationCenter];
    v386 = +[HMDAppleAccountSettings sharedSettings];
    [v385 addObserver:self selector:sel_handleAccountSettingsUpdate_ name:@"HMDAppleAccountSettingsUpdatedNotification" object:v386];

    v387 = +[HMDXPCMessageTransport defaultTransport];
    v388 = [v387 queue];
    v389 = [(HMDHomeManager *)self messageTargetUUID];
    v390 = [(HMDHomeManager *)self logEventSubmitter];
    v391 = [HMDHomeManagerXPCClientConnectionsManagerFactory makeInstanceWithQueue:v388 messageDispatcher:v550 messageTargetUUID:v389 accessoryBrowser:v553 logEventSubmitter:v390];
    connectionsManager = self->_connectionsManager;
    self->_connectionsManager = v391;

    [(HMDHomeManagerXPCClientConnectionsManager *)self->_connectionsManager configure];
    v393 = [v17 accessories];
    v394 = [v393 count] != 0;

    [(HMDAccessoryBrowser *)self->_accessoryBrowserInternal activate:v394];
    if (isiOSDevice())
    {
      v395 = objc_alloc(MEMORY[0x277D0F920]);
      v396 = [v395 initWithTimeInterval:4 options:checkRemoteAccessTimeout];
      remoteAccessHealthMonitorTimer = self->_remoteAccessHealthMonitorTimer;
      self->_remoteAccessHealthMonitorTimer = v396;

      [(HMFTimer *)self->_remoteAccessHealthMonitorTimer setDelegate:self];
      v398 = self->_remoteAccessHealthMonitorTimer;
      v399 = [(HMDHomeManager *)self workQueue];
      [(HMFTimer *)v398 setDelegateQueue:v399];

      [(HMFTimer *)self->_remoteAccessHealthMonitorTimer resume];
    }
  }

  v568 = 0u;
  v569 = 0u;
  v566 = 0u;
  v567 = 0u;
  v400 = [(HMDHomeManager *)self homes];
  v401 = [v400 countByEnumeratingWithState:&v566 objects:v589 count:16];
  if (v401)
  {
    v402 = v401;
    v403 = *v567;
    do
    {
      for (m = 0; m != v402; ++m)
      {
        if (*v567 != v403)
        {
          objc_enumerationMutation(v400);
        }

        v405 = *(*(&v566 + 1) + 8 * m);
        v406 = [v405 migrateOwnedTriggers];
        if (v406)
        {
          [(HMDHomeManager *)self _saveWithReason:@"kAddTriggerRequestKey" information:v406 postSyncNotification:0];
        }

        [v405 checkTimerTriggers];
      }

      v402 = [v400 countByEnumeratingWithState:&v566 objects:v589 count:16];
    }

    while (v402);
  }

  residentMesh = self->_residentMesh;
  self->_residentMesh = 0;

  v408 = +[HMDDeviceCapabilities deviceCapabilities];
  v409 = [v408 isResidentCapable];

  if (v409)
  {
    v410 = objc_autoreleasePoolPush();
    v411 = self;
    v412 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v412, OS_LOG_TYPE_DEFAULT))
    {
      v413 = HMFGetLogIdentifier();
      [(HMDHomeManager *)v411 isResidentEnabled];
      v414 = HMFBooleanToString();
      *buf = 138543618;
      *&buf[4] = v413;
      *&buf[12] = 2112;
      *&buf[14] = v414;
      _os_log_impl(&dword_2531F8000, v412, OS_LOG_TYPE_DEFAULT, "%{public}@Initialize resident mesh: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v410);
    v415 = [[HMDResidentMesh alloc] initWithHomeManager:v411 residentEnabled:[(HMDHomeManager *)v411 isResidentEnabled]];
    v416 = self->_residentMesh;
    self->_residentMesh = v415;
  }

  v417 = +[HMDDeviceCapabilities deviceCapabilities];
  v418 = [v417 supportsKeyTransferServer];

  if (v418)
  {
    v419 = off_27971A170;
  }

  else
  {
    v420 = +[HMDDeviceCapabilities deviceCapabilities];
    v421 = [v420 supportsKeyTransferClient];

    if (!v421)
    {
      goto LABEL_166;
    }

    v419 = off_27971A168;
  }

  v422 = [objc_alloc(*v419) initWithHomeManager:self];
  keyTransferAgent = self->_keyTransferAgent;
  self->_keyTransferAgent = v422;

LABEL_166:
  v424 = objc_autoreleasePoolPush();
  v425 = self;
  v426 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v426, OS_LOG_TYPE_INFO))
  {
    v427 = HMFGetLogIdentifier();
    *buf = 138543362;
    *&buf[4] = v427;
    _os_log_impl(&dword_2531F8000, v426, OS_LOG_TYPE_INFO, "%{public}@Refreshing display names of the users and invites", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v424);
  [(HMDHomeManager *)v425 _handleContactStoreChanged];
  if (v374)
  {
    [(HMDHomeManager *)v425 _saveWithReason:@"kHomeConfigInternalRequestKey" information:0 saveOptions:3];
  }

  if (+[HMDHAPMetadata shouldUploadToCloudAfterHomedReady])
  {
    v428 = [(HMDHomeManager *)v425 homes];
    v429 = [v428 count];

    if (v429)
    {
      v430 = objc_autoreleasePoolPush();
      v431 = v425;
      v432 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v432, OS_LOG_TYPE_INFO))
      {
        v433 = HMFGetLogIdentifier();
        *buf = 138543362;
        *&buf[4] = v433;
        _os_log_impl(&dword_2531F8000, v432, OS_LOG_TYPE_INFO, "%{public}@Home manager is ready now and there is at least one home. Evaluating the necessity of uploading metadata to the cloud.", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v430);
      [(HMDHomeManager *)v431 evaluateToPushMetadataWhenHomeKitInUse];
    }
  }

  if (hasAssistantHashingKeyChanged())
  {
    v564 = 0u;
    v565 = 0u;
    v562 = 0u;
    v563 = 0u;
    v434 = [(HMDHomeManager *)v425 homes];
    v435 = [v434 countByEnumeratingWithState:&v562 objects:v588 count:16];
    if (v435)
    {
      v436 = v435;
      v437 = *v563;
      do
      {
        for (n = 0; n != v436; ++n)
        {
          if (*v563 != v437)
          {
            objc_enumerationMutation(v434);
          }

          [*(*(&v562 + 1) + 8 * n) resetAccessoryHashedRouteIdentifiers];
        }

        v436 = [v434 countByEnumeratingWithState:&v562 objects:v588 count:16];
      }

      while (v436);
    }

    [(HMDHomeManager *)v425 assistantSyncDataChanged:@"HMDAssistantEncryptionKeyChanged"];
  }

  else
  {
    v439 = [(HMDHomeManager *)v425 workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_591;
    block[3] = &unk_279735D00;
    block[4] = v425;
    dispatch_async(v439, block);
  }

  v559 = 0u;
  v560 = 0u;
  v557 = 0u;
  v558 = 0u;
  v440 = [(HMDHomeManager *)v425 homes];
  v441 = [v440 countByEnumeratingWithState:&v557 objects:v587 count:16];
  if (v441)
  {
    v442 = v441;
    v443 = *v558;
    do
    {
      for (ii = 0; ii != v442; ++ii)
      {
        if (*v558 != v443)
        {
          objc_enumerationMutation(v440);
        }

        [*(*(&v557 + 1) + 8 * ii) updateLightProfilesSettingsWithRequiresHomeNotificationsEnabled:1];
      }

      v442 = [v440 countByEnumeratingWithState:&v557 objects:v587 count:16];
    }

    while (v442);
  }

  v445 = [MEMORY[0x277D0F8D0] sharedPreferences];
  v446 = [v445 preferenceForKey:@"memoryMonitorPeriod"];
  v447 = [v446 numberValue];

  v448 = objc_alloc(MEMORY[0x277D0F920]);
  v551 = v447;
  [v447 doubleValue];
  v449 = [v448 initWithTimeInterval:12 options:?];
  [(HMDHomeManager *)v425 setMemoryMonitorLogEventTimer:v449];

  v450 = [(HMDHomeManager *)v425 memoryMonitorLogEventTimer];
  [v450 setDelegate:v425];

  v451 = [(HMDHomeManager *)v425 memoryMonitorLogEventTimer];
  v452 = [(HMDHomeManager *)v425 workQueue];
  [v451 setDelegateQueue:v452];

  v453 = [(HMDHomeManager *)v425 memoryMonitorLogEventTimer];
  [v453 resume];

  v454 = [HMDPredictionSubscriber alloc];
  v455 = [(HMDHomeManager *)v425 workQueue];
  v456 = [(HMDHomeManager *)v425 messageDispatcher];
  v457 = [(HMDPredictionSubscriber *)v454 initWithWorkQueue:v455 messageDispatcher:v456 notificationBackend:0];
  [(HMDHomeManager *)v425 setPredictionSubscriber:v457];

  v458 = [(HMDHomeManager *)v425 predictionSubscriber];
  [v458 setDataSource:v425];

  v459 = [(HMDHomeManager *)v425 predictionSubscriber];
  [v459 configure];

  if (v425)
  {
    v460 = [(HMDHomeManager *)v425 metricsManager];
    v461 = [v460 logEventDispatcher];
    v462 = [(HMDHomeManager *)v425 biomeLogEventObserver];
    *buf = objc_opt_class();
    *&buf[8] = objc_opt_class();
    *&buf[16] = objc_opt_class();
    v463 = [MEMORY[0x277CBEA60] arrayWithObjects:buf count:3];
    [v461 addObserver:v462 forEventClasses:v463];

    v464 = [(HMDHomeManager *)v425 metricsManager];
    v465 = [v464 logEventDispatcher];
    v466 = [(HMDHomeManager *)v425 microLocationLogEventObserver];
    *buf = objc_opt_class();
    *&buf[8] = objc_opt_class();
    *&buf[16] = objc_opt_class();
    v467 = [MEMORY[0x277CBEA60] arrayWithObjects:buf count:3];
    [v465 addObserver:v466 forEventClasses:v467];
  }

  [(HMDHomeManager *)v425 _notifyMetricsManagerOfConfigurationChange];
  if ([(HMDHomeManager *)v425 isResidentEnabled])
  {
    v468 = objc_autoreleasePoolPush();
    v469 = v425;
    v470 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v470, OS_LOG_TYPE_INFO))
    {
      v471 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v471;
      _os_log_impl(&dword_2531F8000, v470, OS_LOG_TYPE_INFO, "%{public}@Resident is enabled. Create multi user settings metric event dispatcher, and register for daily event.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v468);
    v472 = [HMDMultiUserSettingsMetricsEventDispatcher alloc];
    uuid = self->_uuid;
    v474 = [v469 metricsManager];
    v475 = [v474 logEventSubmitter];
    v476 = [v469 metricsManager];
    v477 = [v476 dailyScheduler];
    v478 = [(HMDMultiUserSettingsMetricsEventDispatcher *)v472 initWithIdentifier:uuid logEventSubmitter:v475 dailyScheduler:v477];
    v479 = v469[68];
    v469[68] = v478;

    [v469[68] setDataSource:v469];
    [v469[68] registerForDailyMultiUserSettingsEvents];
  }

  HMFUptime();
  v481 = v480;
  v482 = objc_autoreleasePoolPush();
  v483 = v425;
  v484 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v484, OS_LOG_TYPE_DEBUG))
  {
    v485 = HMFGetLogIdentifier();
    *buf = 138544386;
    *&buf[4] = v485;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v591 = @"Handling Home invitations";
    v592 = 2114;
    v593 = @"state";
    v594 = 2112;
    v595 = @"homeManagerHandlingInvites";
    _os_log_impl(&dword_2531F8000, v484, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
  }

  objc_autoreleasePoolPop(v482);
  v486 = [MEMORY[0x277D17DE8] sharedInstance];
  v487 = objc_alloc(MEMORY[0x277D17DF8]);
  v585 = @"state";
  v586 = @"homeManagerHandlingInvites";
  v488 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v586 forKeys:&v585 count:1];
  v489 = [v487 initWithTag:@"homeManagerInitStart" data:v488];
  v490 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [v486 submitTaggedEvent:v489 processorList:v490];

  [(HMDHomeManager *)v483 _pruneExpiredIncomingInvitations];
  v491 = objc_autoreleasePoolPush();
  v492 = v483;
  v493 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v493, OS_LOG_TYPE_INFO))
  {
    v494 = HMFGetLogIdentifier();
    v495 = MEMORY[0x277CCACA8];
    HMFUptime();
    v497 = [v495 stringWithFormat:@"%.3f", v496 - v481];
    *buf = 138544898;
    *&buf[4] = v494;
    *&buf[12] = 2114;
    *&buf[14] = @"homeManagerInitStart";
    *&buf[22] = 2112;
    v591 = @"Handled Home invitations";
    v592 = 2114;
    v593 = @"state";
    v594 = 2112;
    v595 = @"homeManagerHandledInvites";
    v596 = 2114;
    v597 = @"duration";
    v598 = 2112;
    v599 = v497;
    _os_log_impl(&dword_2531F8000, v493, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
  }

  objc_autoreleasePoolPop(v491);
  v498 = [MEMORY[0x277D17DE8] sharedInstance];
  v499 = objc_alloc(MEMORY[0x277D17DF8]);
  v500 = MEMORY[0x277CCACA8];
  HMFUptime();
  v502 = [v500 stringWithFormat:@"%.3f", v501 - v481];
  v503 = HMDTaggedLoggingCreateDictionary();
  v504 = [v499 initWithTag:@"homeManagerInitStart" data:{v503, @"state", @"homeManagerHandledInvites", @"duration", v502}];
  v505 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [v498 submitTaggedEvent:v504 processorList:v505];

  v546 = [HMDXPCEventRouterServer alloc];
  v544 = [v492 messageTargetUUID];
  v506 = *MEMORY[0x277CD01A8];
  v507 = *MEMORY[0x277CD01B0];
  v508 = [v492 messageDispatcher];
  v509 = [v492 workQueue];
  v510 = [v492 notificationCenter];
  v511 = [v492 registrationForwardingEventRouter];
  v512 = [v492 memoryEventRouter];
  v513 = [v492 lastEventStore];
  v514 = [(HMDXPCEventRouterServer *)v546 initWithMessageUUID:v544 dataSource:v492 changeRegistrationsMessageName:v506 updateEventsMessageName:v507 messageDispatcher:v508 queue:v509 notificationCenter:v510 subscriptionProvider:v511 registrationEventRouter:v512 storeReadHandle:v513];
  [v492 setEventRouterXPCServer:v514];

  v515 = [v492 eventRouterXPCServer];
  [v515 configure];

  v516 = +[HMDDeviceCapabilities deviceCapabilities];
  LODWORD(v513) = [v516 isResidentCapable];

  if (v513)
  {
    v517 = objc_autoreleasePoolPush();
    v518 = v492;
    v519 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v519, OS_LOG_TYPE_INFO))
    {
      v520 = HMFGetLogIdentifier();
      *buf = 138543362;
      *&buf[4] = v520;
      _os_log_impl(&dword_2531F8000, v519, OS_LOG_TYPE_INFO, "%{public}@Creating siriEndPointSettingsSyncManager", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v517);
    v521 = [HMDSiriEndpointSettingsSyncManager alloc];
    v522 = [v518 memoryEventRouter];
    v523 = [v518 notificationCenter];
    v524 = [v518 workQueue];
    v525 = [(HMDSiriEndpointSettingsSyncManager *)v521 initWithDataSource:v518 subscriptionProvider:v522 notificationCenter:v523 workQueue:v524];
    [v518 setSiriEndPointSettingsSyncManager:v525];

    v526 = [v518 siriEndPointSettingsSyncManager];
    [v526 configure];
  }

  v527 = +[HMDIDSServiceManager sharedManager];
  v528 = [v492 workQueue];
  v556[0] = MEMORY[0x277D85DD0];
  v556[1] = 3221225472;
  v556[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_603;
  v556[3] = &unk_279731780;
  v556[4] = v492;
  [v527 retrieveFirewallWithQueue:v528 completion:v556];

  [v492 setHasLoadedData:1];
  logAndPostNotification(@"HMDHomeManagerHomeDataLoadedNotification", v492, 0);
  [v492 autoAddWalletKeysOncePerDeviceSetup];
  [v492 updateHomeKitInUsePreferences];
  v529 = [v492 capabilitiesController];
  [v529 didFinishConfiguringHomes];

  v530 = [[HMDWidgetTimelineRefresher alloc] initWithHomeManager:v492];
  v531 = v492[70];
  v492[70] = v530;

  [v492[70] configure];
  v532 = [v492 workQueue];
  v555[0] = MEMORY[0x277D85DD0];
  v555[1] = 3221225472;
  v555[2] = __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_608;
  v555[3] = &unk_279735D00;
  v555[4] = v492;
  dispatch_async(v532, v555);

  v533 = [v492 pairedAccessories];
  [HMDCameraSnapshotManager cleanStaleSnapshotDirectoriesUsingCurrentAccessories:v533];

  v534 = MEMORY[0x277CBED10];
  if (*(v492 + 30))
  {
    v534 = MEMORY[0x277CBED28];
  }

  [v492 _setHomeConfigurationKey:*MEMORY[0x277CD2370] value:*v534];
  [v492 configureSwiftExtensions];
  v535 = [v492 featuresDataSource];
  v536 = [v535 isPlannerSupportEnabled];

  if (v536)
  {
    [v492 startIndexing];
  }

  v537 = *MEMORY[0x277D85DE8];
}

void __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_2(uint64_t a1, void *a2)
{
  v12 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    v8 = 138543618;
    v9 = v6;
    v10 = 2112;
    v11 = v3;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Completed creating cloud cached with error %@", &v8, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  dispatch_group_leave(*(a1 + 32));

  v7 = *MEMORY[0x277D85DE8];
}

void __180__HMDHomeManager__loadMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_uncommittedTransactions_reloadData___block_invoke_603(uint64_t a1, void *a2, void *a3)
{
  v23 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v5)
  {
    v7 = [HMDIDSFirewallManagerContext alloc];
    v8 = *(a1 + 32);
    v9 = [MEMORY[0x277CCAB98] defaultCenter];
    v10 = [*(a1 + 32) workQueue];
    v11 = [(HMDIDSFirewallManagerContext *)v7 initWithHomeManager:v8 IDSFirewall:v5 notificationCenter:v9 workQueue:v10];

    v12 = [[HMDIDSFirewallManager alloc] initWithContext:v11];
    [*(a1 + 32) setIdsFirewallManager:v12];

    v13 = [*(a1 + 32) idsFirewallManager];
    [v13 start];
  }

  else
  {
    v14 = objc_autoreleasePoolPush();
    v15 = *(a1 + 32);
    v16 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
    {
      v17 = HMFGetLogIdentifier();
      v19 = 138543618;
      v20 = v17;
      v21 = 2112;
      v22 = v6;
      _os_log_impl(&dword_2531F8000, v16, OS_LOG_TYPE_ERROR, "%{public}@Failed to retrieve IDSFirewall with error: %@", &v19, 0x16u);
    }

    objc_autoreleasePoolPop(v14);
  }

  v18 = *MEMORY[0x277D85DE8];
}

- (void)_migrateUniqueIdentifierPrefsIfNeeded
{
  v9[4] = *MEMORY[0x277D85DE8];
  v2 = *MEMORY[0x277CD20B8];
  v9[0] = @"kAssistantTeamIdentifier";
  v9[1] = v2;
  v9[2] = *MEMORY[0x277CD20C0];
  v9[3] = @"kUniqueDeviceIdentifierSaltkey";
  v3 = [MEMORY[0x277CBEA60] arrayWithObjects:v9 count:4];
  v4 = *MEMORY[0x277CD0030];
  v5 = *MEMORY[0x277CBF040];
  v6 = *MEMORY[0x277CBF010];
  v7 = CFPreferencesCopyMultiple(v3, *MEMORY[0x277CD0030], *MEMORY[0x277CBF040], *MEMORY[0x277CBF010]);
  if ([(__CFDictionary *)v7 count])
  {
    CFPreferencesSetMultiple(0, v3, v4, v5, v6);
    CFPreferencesSetMultiple(v7, 0, *MEMORY[0x277CD0028], v5, v6);
  }

  v8 = *MEMORY[0x277D85DE8];
}

- (id)settingsControllerForAccessoryUUID:(id)a3 homeUUID:(id)a4
{
  v6 = a4;
  v7 = a3;
  v8 = [(HMDHomeManager *)self _accessoryOfCurrentDevice];
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v9 = v8;
  }

  else
  {
    v9 = 0;
  }

  v10 = v9;

  v11 = [v10 uuid];
  v12 = [v11 hmf_isEqualToUUID:v7];

  if (v12)
  {
    v13 = [v10 home];
    v14 = [v13 uuid];
    v15 = [v14 hmf_isEqualToUUID:v6];

    if (v15)
    {
      v16 = [v10 currentAccessorySettingsController];
      goto LABEL_9;
    }
  }

  else
  {
  }

  v16 = 0;
LABEL_9:

  return v16;
}

- (id)languageListProviderForHomeUUID:(id)a3
{
  v3 = [(HMDHomeManager *)self _homeWithUUID:a3];
  v4 = [v3 unifiedLanguageValueListSettingDataProvider];

  return v4;
}

- (NSString)currentEventSource
{
  v2 = [(HMDHomeManager *)self appleAccountManager];
  v3 = [v2 device];

  if (v3)
  {
    v4 = [v3 identifier];
    v5 = [v4 UUIDString];
  }

  else
  {
    v4 = [MEMORY[0x277CCAD78] UUID];
    v6 = [v4 UUIDString];
    v5 = [@"DeviceNotDetermined." stringByAppendingString:v6];
  }

  return v5;
}

- (void)invalidate
{
  v3 = [(HMDHomeManager *)self notificationCenter];
  [v3 removeObserver:self];

  v4 = [(HMDHomeManager *)self messageDispatcher];
  [v4 deregisterReceiver:self];

  if (self->_generationCounterToken != -1)
  {
    v5 = [(HMDHomeManager *)self darwinNotificationProvider];
    [v5 notifyCancel:self->_generationCounterToken];
  }

  [(HMDHomeManager *)self deregisterForSignificantTimeChangeNotification];
}

- (void)dealloc
{
  [(HMDHomeManager *)self invalidate];
  v3.receiver = self;
  v3.super_class = HMDHomeManager;
  [(HMDHomeManager *)&v3 dealloc];
}

- (HMDHomeManager)initWithMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 metricsManager:(id)a10 darwinNotificationProvider:(id)a11 notificationCenter:(id)a12 dataSource:(id)a13 appleAccountManager:(id)a14 remoteAccountManager:(id)a15 userDefaults:(id)a16 hmdUserDefaults:(id)a17 biomeEventManager:(id)a18 logEventSubmitter:(id)a19 widgetConfigurationReader:(id)a20 configuringStateController:(id)a21 diagnosticInfoController:(id)a22 currentAccessorySetupMetricDispatcher:(id)a23 uncommittedTransactions:(id)a24 featuresDataSource:(id)a25
{
  v212 = a7;
  v273[1] = *MEMORY[0x277D85DE8];
  v240 = a3;
  v239 = a4;
  v238 = a5;
  v237 = a6;
  v235 = a8;
  v233 = a9;
  v232 = a10;
  v228 = a11;
  v227 = a12;
  v226 = a13;
  v225 = a14;
  v224 = a15;
  v223 = a16;
  v222 = a17;
  v221 = a18;
  v220 = a19;
  v219 = a20;
  v218 = a21;
  v217 = a22;
  v216 = a23;
  v231 = a24;
  v215 = a25;
  HMFUptime();
  v28 = v27;
  v29 = [(HMDHomeManager *)self init];
  if (v29)
  {
    v30 = objc_autoreleasePoolPush();
    v214 = v29;
    v31 = v29;
    v32 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v32, OS_LOG_TYPE_INFO))
    {
      v33 = HMFGetLogIdentifier();
      *buf = 138544386;
      v251 = v33;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Initializing HomeManager";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"start";
      _os_log_impl(&dword_2531F8000, v32, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v30);
    v34 = [MEMORY[0x277D17DE8] sharedInstance];
    v35 = objc_alloc(MEMORY[0x277D17DF8]);
    v272 = @"state";
    v273[0] = @"start";
    v36 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v273 forKeys:&v272 count:1];
    v37 = [v35 initWithTag:@"homeManagerInitStart" data:v36];
    v38 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v34 submitTaggedEvent:v37 processorList:v38];

    [v232 setHomeManager:v31];
    objc_storeStrong(&v31->_metricsManager, a10);
    objc_storeStrong(&v31->_darwinNotificationProvider, a11);
    objc_storeStrong(&v31->_notificationCenter, a12);
    objc_storeStrong(&v31->_appleAccountManager, a14);
    objc_storeStrong(&v31->_remoteAccountManager, a15);
    objc_storeStrong(&v31->_userDefaults, a16);
    objc_storeStrong(&v31->_hmdUserDefaults, a17);
    objc_storeStrong(&v31->_biomeEventManager, a18);
    objc_storeStrong(&v31->_logEventSubmitter, a19);
    objc_storeStrong(&v31->_widgetConfigurationReader, a20);
    objc_storeStrong(&v31->_configuringStateController, a21);
    objc_storeStrong(&v31->_appleMediaAccessoryDiagnosticInfoController, a22);
    objc_storeStrong(&v31->_currentAccessorySetupMetricDispatcher, a23);
    objc_storeStrong(&v31->_dataSource, a13);
    objc_storeStrong(&v31->_featuresDataSource, a25);
    v31->_hh2MigrationInProgress = 0;
    v39 = +[HMDBackingStoreSingleton sharedInstance];
    [v39 setHomeManager:v31];

    v40 = HMFGetOSLogHandle();
    logger = v31->_logger;
    v31->_logger = v40;

    dispatch_suspend(v31->_workQueue);
    v31->_generationCounterToken = -1;
    v42 = [(NSUserDefaults *)v31->_userDefaults objectForKey:@"HMDCurrentAccessorySetupStartUptimeKey"];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v43 = v42;
    }

    else
    {
      v43 = 0;
    }

    v44 = v43;

    if (v44)
    {
      [v44 doubleValue];
      v46 = v45;
      if (fabs(v45) >= 2.22044605e-16)
      {
        v47 = (clock_gettime_nsec_np(_CLOCK_MONOTONIC_RAW) / 0x3B9ACA00);
        v48 = objc_autoreleasePoolPush();
        v49 = v31;
        v50 = HMFGetOSLogHandle();
        v51 = os_log_type_enabled(v50, OS_LOG_TYPE_INFO);
        if (v46 <= v47)
        {
          if (v51)
          {
            v53 = HMFGetLogIdentifier();
            *buf = 138543618;
            v251 = v53;
            v252 = 2048;
            v253 = *&v46;
            _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_INFO, "%{public}@Loaded stored current accessory setup timestamp: %f", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v48);
          os_unfair_lock_lock_with_options();
          *&v49[28]._os_unfair_lock_opaque = v46;
          os_unfair_lock_unlock(v49 + 6);
        }

        else
        {
          if (v51)
          {
            v52 = HMFGetLogIdentifier();
            *buf = 138543362;
            v251 = v52;
            _os_log_impl(&dword_2531F8000, v50, OS_LOG_TYPE_INFO, "%{public}@Resetting current accessory setup timestamp to 0 as a reboot was detected", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v48);
          [(os_unfair_lock_s *)v49 setSetupStartTimestamp:0.0];
        }
      }
    }

    v54 = [(NSUserDefaults *)v31->_userDefaults objectForKey:@"HMDCurrentAccessorySetupEndUptimeKey"];
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      v55 = v54;
    }

    else
    {
      v55 = 0;
    }

    v56 = v55;

    if (v56)
    {
      [v56 doubleValue];
      v58 = v57;
      if (fabs(v57) >= 2.22044605e-16)
      {
        v59 = (clock_gettime_nsec_np(_CLOCK_MONOTONIC_RAW) / 0x3B9ACA00);
        v60 = objc_autoreleasePoolPush();
        v61 = v31;
        v62 = HMFGetOSLogHandle();
        v63 = os_log_type_enabled(v62, OS_LOG_TYPE_INFO);
        if (v58 <= v59)
        {
          if (v63)
          {
            v65 = HMFGetLogIdentifier();
            *buf = 138543618;
            v251 = v65;
            v252 = 2048;
            v253 = *&v58;
            _os_log_impl(&dword_2531F8000, v62, OS_LOG_TYPE_INFO, "%{public}@Loaded stored current accessory setup end timestamp: %f", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v60);
          os_unfair_lock_lock_with_options();
          *&v61[30]._os_unfair_lock_opaque = v58;
          os_unfair_lock_unlock(v61 + 6);
        }

        else
        {
          if (v63)
          {
            v64 = HMFGetLogIdentifier();
            *buf = 138543362;
            v251 = v64;
            _os_log_impl(&dword_2531F8000, v62, OS_LOG_TYPE_INFO, "%{public}@Resetting current accessory setup end timestamp to 0 as a reboot was detected", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v60);
          [(os_unfair_lock_s *)v61 setSetupEndTimestamp:0.0];
        }
      }
    }

    v66 = objc_alloc_init(HMDMobileAssetManager);
    mobileAssetManager = v31->_mobileAssetManager;
    v31->_mobileAssetManager = v66;

    [(HMDMobileAssetManager *)v31->_mobileAssetManager setDelegate:v31];
    v68 = [[HMDUserCloudShareManager alloc] initWithHomeManager:v31];
    userCloudShareManager = v31->_userCloudShareManager;
    v31->_userCloudShareManager = v68;

    v70 = [[HMDMultiUserStatusController alloc] initWithQueue:v31->_workQueue delegate:v31];
    multiUserStatusController = v31->_multiUserStatusController;
    v31->_multiUserStatusController = v70;

    v72 = objc_alloc_init(HMDIDSServerBag);
    idsServerBag = v31->_idsServerBag;
    v31->_idsServerBag = v72;

    [(HMDIDSServerBag *)v31->_idsServerBag setDelegate:v31];
    v74 = [[HMDCapabilitiesController alloc] initWithQueue:v31->_workQueue dataSource:v31];
    capabilitiesController = v31->_capabilitiesController;
    v31->_capabilitiesController = v74;

    v76 = objc_alloc_init(HMDMemoryUtilizationTracker);
    memoryTracker = v31->_memoryTracker;
    v31->_memoryTracker = v76;

    v78 = [(HMDHomeManager *)v31 userDefaults];
    v79 = [v78 stringForKey:@"HMDLastRemovedCurrentAccessoryUUIDKey"];

    if (v79)
    {
      v80 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:v79];
      lastRemovedCurrentAccessoryUUID = v31->_lastRemovedCurrentAccessoryUUID;
      v31->_lastRemovedCurrentAccessoryUUID = v80;
    }

    v230 = v79;
    v82 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:5.0];
    debounceHomesUpdateTimer = v31->_debounceHomesUpdateTimer;
    v31->_debounceHomesUpdateTimer = v82;

    [(HMFTimer *)v31->_debounceHomesUpdateTimer setDelegate:v31];
    v84 = v31->_debounceHomesUpdateTimer;
    v85 = [(HMDHomeManager *)v31 workQueue];
    [(HMFTimer *)v84 setDelegateQueue:v85];

    v86 = [MEMORY[0x277D0F8D0] sharedPreferences];
    v87 = [v86 preferenceForKey:@"assistantSyncDataCoalescePeriodMilliseconds"];
    v88 = [v87 numberValue];

    v229 = v88;
    [v88 doubleValue];
    v90 = [objc_alloc(MEMORY[0x277D0F920]) initWithTimeInterval:0 options:v89 / 1000.0];
    debounceRegenerateAssistantSyncDataTimer = v31->_debounceRegenerateAssistantSyncDataTimer;
    v31->_debounceRegenerateAssistantSyncDataTimer = v90;

    [(HMFTimer *)v31->_debounceRegenerateAssistantSyncDataTimer setDelegate:v31];
    v92 = v31->_debounceRegenerateAssistantSyncDataTimer;
    v93 = [(HMDHomeManager *)v31 workQueue];
    [(HMFTimer *)v92 setDelegateQueue:v93];

    HMFUptime();
    v95 = v94;
    v96 = objc_autoreleasePoolPush();
    v97 = v31;
    v98 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v98, OS_LOG_TYPE_DEBUG))
    {
      v99 = HMFGetLogIdentifier();
      *buf = 138544386;
      v251 = v99;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Initialize HH2 FW switch";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerHH2FWSwitch";
      _os_log_impl(&dword_2531F8000, v98, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v96);
    v100 = [MEMORY[0x277D17DE8] sharedInstance];
    v101 = objc_alloc(MEMORY[0x277D17DF8]);
    v270 = @"state";
    v271 = @"homeManagerHH2FWSwitch";
    v102 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v271 forKeys:&v270 count:1];
    v103 = [v101 initWithTag:@"homeManagerInitStart" data:v102];
    v104 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v100 submitTaggedEvent:v103 processorList:v104];

    v105 = objc_autoreleasePoolPush();
    [(HMDHomeManager *)v97 initializeHH2FrameworkSwitch];
    v106 = +[HMDDeviceSetupManager sharedManager];
    v107 = [v106 followUpManager];
    [v107 stopAdvertising:2];

    v108 = [(HMDHomeManager *)v97 notificationCenter];
    [v108 addObserver:v97 selector:sel__handleHH2SentinelZonePresent_ name:@"HMDHomeManagerHH2SentinelZonePresent" object:0];

    v109 = objc_autoreleasePoolPush();
    v110 = v97;
    v111 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v111, OS_LOG_TYPE_INFO))
    {
      v112 = HMFGetLogIdentifier();
      v113 = MEMORY[0x277CCACA8];
      HMFUptime();
      v115 = [v113 stringWithFormat:@"%.3f", v114 - v95];
      *buf = 138544898;
      v251 = v112;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Initialized HH2 FW switch";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerHH2FWSwitchDone";
      v260 = 2114;
      v261 = @"duration";
      v262 = 2112;
      v263 = v115;
      _os_log_impl(&dword_2531F8000, v111, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@", buf, 0x48u);
    }

    objc_autoreleasePoolPop(v109);
    v116 = [MEMORY[0x277D17DE8] sharedInstance];
    v117 = objc_alloc(MEMORY[0x277D17DF8]);
    v118 = MEMORY[0x277CCACA8];
    HMFUptime();
    v120 = [v118 stringWithFormat:@"%.3f", v119 - v95];
    v121 = HMDTaggedLoggingCreateDictionary();
    v122 = [v117 initWithTag:@"homeManagerInitStart" data:{v121, @"state", @"homeManagerHH2FWSwitchDone", @"duration", v120}];
    v123 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v116 submitTaggedEvent:v122 processorList:v123];

    objc_autoreleasePoolPop(v105);
    HMFUptime();
    v125 = v124;
    v126 = objc_autoreleasePoolPush();
    v127 = v110;
    v128 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v128, OS_LOG_TYPE_DEBUG))
    {
      v129 = HMFGetLogIdentifier();
      *buf = 138544386;
      v251 = v129;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Loading Home Manager";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerLoading";
      _os_log_impl(&dword_2531F8000, v128, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v126);
    v130 = [MEMORY[0x277D17DE8] sharedInstance];
    v131 = objc_alloc(MEMORY[0x277D17DF8]);
    v268 = @"state";
    v269 = @"homeManagerLoading";
    v132 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v269 forKeys:&v268 count:1];
    v133 = [v131 initWithTag:@"homeManagerInitStart" data:v132];
    v134 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v130 submitTaggedEvent:v133 processorList:v134];

    v135 = objc_autoreleasePoolPush();
    LOBYTE(v211) = 0;
    [(HMDHomeManager *)v127 _loadMessageDispatcher:v240 accessoryBrowser:v239 messageFilterChain:v238 homeData:v237 localDataDecryptionFailed:v212 identityRegistry:v235 accountRegistry:v233 uncommittedTransactions:v231 reloadData:v211];
    objc_autoreleasePoolPop(v135);
    v136 = objc_autoreleasePoolPush();
    v137 = v127;
    v138 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v138, OS_LOG_TYPE_INFO))
    {
      v139 = HMFGetLogIdentifier();
      v140 = MEMORY[0x277CCACA8];
      HMFUptime();
      v142 = [v140 stringWithFormat:@"%.3f", v141 - v125];
      v143 = MEMORY[0x277CCABB0];
      v144 = [(HMDHomeManager *)v137 homes];
      v145 = [v143 numberWithUnsignedInteger:{objc_msgSend(v144, "count")}];
      *buf = 138545410;
      v251 = v139;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Loaded Home Manager, resuming work queue";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerLoaded";
      v260 = 2114;
      v261 = @"duration";
      v262 = 2112;
      v263 = v142;
      v264 = 2114;
      v265 = @"homesCount";
      v266 = 2112;
      v267 = v145;
      _os_log_impl(&dword_2531F8000, v138, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x5Cu);
    }

    objc_autoreleasePoolPop(v136);
    v146 = [MEMORY[0x277D17DE8] sharedInstance];
    v147 = objc_alloc(MEMORY[0x277D17DF8]);
    v148 = MEMORY[0x277CCACA8];
    HMFUptime();
    v150 = [v148 stringWithFormat:@"%.3f", v149 - v125];
    v151 = MEMORY[0x277CCABB0];
    v152 = [(HMDHomeManager *)v137 homes];
    v153 = [v151 numberWithUnsignedInteger:{objc_msgSend(v152, "count")}];
    v154 = HMDTaggedLoggingCreateDictionary();
    v155 = [v147 initWithTag:@"homeManagerInitStart" data:{v154, @"state", @"homeManagerLoaded", @"duration", v150, @"homesCount", v153}];
    v156 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v146 submitTaggedEvent:v155 processorList:v156];

    v157 = +[HMDUserManagementOperationManager sharedManager];
    [v157 setHomeManager:v137];
    v243 = 0u;
    v244 = 0u;
    v241 = 0u;
    v242 = 0u;
    v158 = [v157 operations];
    v159 = [v158 countByEnumeratingWithState:&v241 objects:v249 count:16];
    if (v159)
    {
      v160 = v159;
      v161 = *v242;
      do
      {
        for (i = 0; i != v160; ++i)
        {
          if (*v242 != v161)
          {
            objc_enumerationMutation(v158);
          }

          [*(*(&v241 + 1) + 8 * i) updateDelegate:v137];
        }

        v160 = [v158 countByEnumeratingWithState:&v241 objects:v249 count:16];
      }

      while (v160);
    }

    dispatch_resume(v31->_workQueue);
    v163 = [(HMDHomeManager *)v137 notificationCenter];
    [v163 addObserver:v137 selector:sel_cloudHomeSettingsUpdated_ name:@"HMDAppleAccountSettingsHomeStateUpdatedNotification" object:0];

    v164 = [(HMDHomeManager *)v137 notificationCenter];
    [v164 addObserver:v137 selector:sel___handleDeviceCapabilitiesUpdated_ name:@"HMDDeviceCapabilitiiesUpdatedNotification" object:0];

    v165 = [(HMDHomeManager *)v137 notificationCenter];
    v166 = [(HMDHomeManager *)v137 appleAccountManager];
    [v165 addObserver:v137 selector:sel___handleUpdatedCurrentDevice_ name:@"HMDAppleAccountManagerDeviceUpdatedNotification" object:v166];

    v167 = [(HMDHomeManager *)v137 notificationCenter];
    [v167 addObserver:v137 selector:sel__handleCurrentAccessoryRemovedNotification_ name:@"HMDHomeManagerDidRemoveCurrentAccessoryNotification" object:0];

    v168 = [(HMDHomeManager *)v137 notificationCenter];
    [v168 addObserver:v137 selector:sel__handleCurrentAccessoryAddedNotification_ name:@"HMDHomeManagerDidAddCurrentAccessoryNotification" object:0];

    v169 = [(HMDHomeManager *)v137 notificationCenter];
    [v169 addObserver:v137 selector:sel_handleHomeManagerHasFinishedStartingUp_ name:@"HMDHomeManagerHasFinishedStartingUpNotification" object:0];

    [(HMDHomeManager *)v137 registerForNPSPreferenceChanges];
    [(HMDHomeManager *)v137 checkForRemotePeers];
    [(HMDHomeManager *)v137 registerForSignificantTimeChangeNotification];
    v170 = objc_autoreleasePoolPush();
    v171 = v137;
    v172 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v172, OS_LOG_TYPE_DEBUG))
    {
      v173 = HMFGetLogIdentifier();
      *buf = 138544386;
      v251 = v173;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Fetch and update PCS status";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerFetchPCS";
      _os_log_impl(&dword_2531F8000, v172, OS_LOG_TYPE_DEBUG, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v170);
    v174 = [MEMORY[0x277D17DE8] sharedInstance];
    v175 = objc_alloc(MEMORY[0x277D17DF8]);
    v247 = @"state";
    v248 = @"homeManagerFetchPCS";
    v176 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v248 forKeys:&v247 count:1];
    v177 = [v175 initWithTag:@"homeManagerInitStart" data:v176];
    v178 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v174 submitTaggedEvent:v177 processorList:v178];

    [(HMDHomeManager *)v171 fetchAndUpdatePCSStatus];
    v179 = objc_autoreleasePoolPush();
    v180 = v171;
    v181 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v181, OS_LOG_TYPE_INFO))
    {
      v182 = HMFGetLogIdentifier();
      *buf = 138544386;
      v251 = v182;
      v252 = 2114;
      v253 = @"homeManagerInitStart";
      v254 = 2112;
      v255 = @"Fetched and updated PCS status";
      v256 = 2114;
      v257 = @"state";
      v258 = 2112;
      v259 = @"homeManagerFetchedPCS";
      _os_log_impl(&dword_2531F8000, v181, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@", buf, 0x34u);
    }

    objc_autoreleasePoolPop(v179);
    v183 = [MEMORY[0x277D17DE8] sharedInstance];
    v184 = objc_alloc(MEMORY[0x277D17DF8]);
    v245 = @"state";
    v246 = @"homeManagerFetchedPCS";
    v185 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v246 forKeys:&v245 count:1];
    v186 = [v184 initWithTag:@"homeManagerInitStart" data:v185];
    v187 = [MEMORY[0x277D0F770] currentTagProcessorList];
    [v183 submitTaggedEvent:v186 processorList:v187];

    v29 = v214;
  }

  v188 = objc_autoreleasePoolPush();
  v189 = v29;
  v190 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v190, OS_LOG_TYPE_INFO))
  {
    v191 = HMFGetLogIdentifier();
    v192 = MEMORY[0x277CCACA8];
    HMFUptime();
    v194 = [v192 stringWithFormat:@"%.3f", v193 - v28];
    v195 = MEMORY[0x277CCABB0];
    v196 = [(HMDHomeManager *)v189 homes];
    v197 = [v195 numberWithUnsignedInteger:{objc_msgSend(v196, "count")}];
    *buf = 138545410;
    v251 = v191;
    v252 = 2114;
    v253 = @"homeManagerInitDone";
    v254 = 2112;
    v255 = @"Initialized HomeManager";
    v256 = 2114;
    v257 = @"state";
    v258 = 2112;
    v259 = @"end";
    v260 = 2114;
    v261 = @"duration";
    v262 = 2112;
    v263 = v194;
    v264 = 2114;
    v265 = @"homesCount";
    v266 = 2112;
    v267 = v197;
    _os_log_impl(&dword_2531F8000, v190, OS_LOG_TYPE_INFO, "%{public}@tag=%{public}@ desc=%@ %{public}@=%@ %{public}@=%@ %{public}@=%@", buf, 0x5Cu);
  }

  objc_autoreleasePoolPop(v188);
  v198 = [MEMORY[0x277D17DE8] sharedInstance];
  v199 = objc_alloc(MEMORY[0x277D17DF8]);
  v200 = MEMORY[0x277CCACA8];
  HMFUptime();
  v202 = [v200 stringWithFormat:@"%.3f", v201 - v28];
  v203 = MEMORY[0x277CCABB0];
  v204 = [(HMDHomeManager *)v189 homes];
  v205 = [v203 numberWithUnsignedInteger:{objc_msgSend(v204, "count")}];
  v206 = HMDTaggedLoggingCreateDictionary();
  v207 = [v199 initWithTag:@"homeManagerInitDone" data:{v206, @"state", @"end", @"duration", v202, @"homesCount", v205}];
  v208 = [MEMORY[0x277D0F770] currentTagProcessorList];
  [v198 submitTaggedEvent:v207 processorList:v208];

  v209 = *MEMORY[0x277D85DE8];
  return v189;
}

- (HMDHomeManager)initWithMessageDispatcher:(id)a3 accessoryBrowser:(id)a4 messageFilterChain:(id)a5 homeData:(id)a6 localDataDecryptionFailed:(BOOL)a7 identityRegistry:(id)a8 accountRegistry:(id)a9 metricsManager:(id)a10 configuringStateController:(id)a11 diagnosticInfoController:(id)a12 currentAccessorySetupMetricDispatcher:(id)a13 uncommittedTransactions:(id)a14 featuresDataSource:(id)a15
{
  v35 = a7;
  v33 = a15;
  v18 = a14;
  v32 = a13;
  v19 = a12;
  v29 = a11;
  v20 = a10;
  v30 = a9;
  v31 = a8;
  v28 = a6;
  v45 = a5;
  v44 = a4;
  v27 = a3;
  v42 = [[HMDHomeManagerDataSource alloc] initWithBackingStoreFactory:&__block_literal_global_173976 wifiManagerFactory:&__block_literal_global_414 cloudCacheFactory:&__block_literal_global_418 threadClientFactory:0];
  v40 = objc_alloc_init(MEMORY[0x277CD19C0]);
  v39 = [MEMORY[0x277CCAB98] defaultCenter];
  v38 = +[HMDAppleAccountManager sharedManager];
  v37 = +[HMDRemoteAccountManager sharedManager];
  v26 = [MEMORY[0x277CBEBD0] standardUserDefaults];
  v25 = +[HMDUserDefaults protectedUserDefaults];
  v24 = objc_alloc_init(HMDBiomeEventManager);
  v23 = [v20 logEventSubmitter];
  v22 = objc_alloc_init(HMDWidgetConfigurationReader);
  v36 = [(HMDHomeManager *)self initWithMessageDispatcher:v27 accessoryBrowser:v44 messageFilterChain:v45 homeData:v28 localDataDecryptionFailed:v35 identityRegistry:v31 accountRegistry:v30 metricsManager:v20 darwinNotificationProvider:v40 notificationCenter:v39 dataSource:v42 appleAccountManager:v38 remoteAccountManager:v37 userDefaults:v26 hmdUserDefaults:v25 biomeEventManager:v24 logEventSubmitter:v23 widgetConfigurationReader:v22 configuringStateController:v29 diagnosticInfoController:v19 currentAccessorySetupMetricDispatcher:v32 uncommittedTransactions:v18 featuresDataSource:v33];

  return v36;
}

HMDCloudCache *__296__HMDHomeManager_initWithMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_metricsManager_configuringStateController_diagnosticInfoController_currentAccessorySetupMetricDispatcher_uncommittedTransactions_featuresDataSource___block_invoke_3(uint64_t a1, uint64_t a2, void *a3, void *a4)
{
  v5 = a4;
  v6 = a3;
  v7 = [[HMDCloudCache alloc] initWithBackingStore:v6 workQueue:v5];

  return v7;
}

HMDBackingStore *__296__HMDHomeManager_initWithMessageDispatcher_accessoryBrowser_messageFilterChain_homeData_localDataDecryptionFailed_identityRegistry_accountRegistry_metricsManager_configuringStateController_diagnosticInfoController_currentAccessorySetupMetricDispatcher_uncommittedTransactions_featuresDataSource___block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  v3 = [HMDBackingStore alloc];
  v4 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:@"030440CB-974B-44F3-8786-7191F302252E"];
  v5 = [(HMDBackingStore *)v3 initWithUUID:v4 homeManager:v2];

  return v5;
}

- (HMDHomeManager)init
{
  v26.receiver = self;
  v26.super_class = HMDHomeManager;
  v2 = [(HMDHomeManager *)&v26 init];
  if (v2)
  {
    v3 = dispatch_queue_attr_make_with_autorelease_frequency(0, DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM);
    v4 = dispatch_queue_create("com.apple.hmd.hmgr", v3);
    workQueue = v2->_workQueue;
    v2->_workQueue = v4;

    v2->_lock._os_unfair_lock_opaque = 0;
    v6 = objc_alloc(MEMORY[0x277CCAD78]);
    v7 = [v6 initWithUUIDString:*MEMORY[0x277CD23C8]];
    uuid = v2->_uuid;
    v2->_uuid = v7;

    v9 = [MEMORY[0x277CBEB18] array];
    homes = v2->_homes;
    v2->_homes = v9;

    v11 = [MEMORY[0x277CCAB00] strongToStrongObjectsMapTable];
    homeUUIDsByWalletKeyAssertionXPCConnection = v2->_homeUUIDsByWalletKeyAssertionXPCConnection;
    v2->_homeUUIDsByWalletKeyAssertionXPCConnection = v11;

    v13 = [MEMORY[0x277CBEB38] dictionary];
    currentHomeConfigurations = v2->_currentHomeConfigurations;
    v2->_currentHomeConfigurations = v13;

    v15 = [MEMORY[0x277CBEBD0] standardUserDefaults];
    userDefaults = v2->_userDefaults;
    v2->_userDefaults = v15;

    v17 = [[HMDCHIPXPCListener alloc] initWithHomeManager:v2];
    chipXPCListener = v2->_chipXPCListener;
    v2->_chipXPCListener = v17;

    v19 = objc_alloc_init(HMDFileManager);
    fileManager = v2->_fileManager;
    v2->_fileManager = v19;

    v21 = +[HMDFMFHandlerFactory sharedHandler];
    fmfHandler = v2->_fmfHandler;
    v2->_fmfHandler = v21;

    v23 = [MEMORY[0x277CBEB18] array];
    deviceSetupSessions = v2->_deviceSetupSessions;
    v2->_deviceSetupSessions = v23;

    [(HMDHomeManager *)v2 initSwiftExtensions];
  }

  return v2;
}

+ (id)emptyModelObjectWithChangeType:(unint64_t)a3 homeManagerUUID:(id)a4
{
  v5 = a4;
  v6 = [(HMDBackingStoreModelObject *)[HMDHomeManagerModel alloc] initWithObjectChangeType:a3 uuid:v5 parentUUID:0];

  return v6;
}

+ (id)getAllBackingStoreObjects:(int64_t)a3 primaryHomeUUID:(id)a4 cloudZone:(id)a5 appData:(id)a6
{
  v9 = a4;
  v10 = a5;
  v11 = a6;
  v12 = [MEMORY[0x277CBEB18] array];
  v13 = objc_alloc(MEMORY[0x277CCAD78]);
  v14 = [v13 initWithUUIDString:*MEMORY[0x277CD23C8]];
  v15 = [objc_opt_class() emptyModelObjectWithChangeType:1 homeManagerUUID:v14];
  if (v9)
  {
    v16 = [v9 UUIDString];
    [v15 setPrimaryHomeUUID:v16];
  }

  v17 = [HMDCloudZoneInformation cloudZoneInformationWithCloudZones:v10];
  [v15 setCloudZoneInformation:v17];

  [v12 addObject:v15];
  if (a3 >= 3 && v11)
  {
    v18 = [v11 modelObjectWithChangeType:1];
    [v12 addObject:v18];
  }

  return v12;
}

+ (id)remotePeerDeviceAddress:(id)a3
{
  v3 = IDSCopyIDForDevice();
  if (v3)
  {
    v4 = [objc_alloc(MEMORY[0x277CCAB68]) initWithString:v3];
    [v4 replaceOccurrencesOfString:@"self-token" withString:@"token" options:1 range:{0, objc_msgSend(v4, "length")}];
  }

  else
  {
    v4 = 0;
  }

  return v4;
}

+ (BOOL)isThisDeviceAdminOfHome:(id)a3
{
  v3 = a3;
  if (isWatch())
  {
    v4 = 0;
  }

  else
  {
    v5 = [MEMORY[0x277CFEC78] systemStore];
    v10 = 0;
    v11 = 0;
    [v5 getAllAvailableControllerPublicKeys:0 secretKeys:0 userNames:&v11 error:&v10];
    v6 = v11;
    v7 = v10;

    v8 = [v3 ownerName];
    v4 = [v6 containsObject:v8];
  }

  return v4;
}

+ (id)saltForDeviceSpecificIdentifier
{
  v2 = uniqueDeviceId;
  v3 = [v2 hm_generateSHA1];

  return v3;
}

+ (id)createIdentifierSalt:(id)a3 deviceSpecific:(BOOL)a4
{
  v5 = a3;
  if (!isWatch() || a4)
  {
    v6 = +[HMDHomeManager saltForDeviceSpecificIdentifier];
  }

  else
  {
    v6 = +[HMDHomeManager getUniqueDeviceIdSalt];
  }

  v7 = v6;
  if (v6)
  {
    v8 = [v5 mutableCopy];
    [v8 appendData:v7];
    v9 = [v8 hm_generateSHA1];
  }

  else
  {
    v9 = 0;
  }

  return v9;
}

+ (id)_getIntentGroupClientIdentifierSalt
{
  v2 = [objc_alloc(MEMORY[0x277CCAD78]) initWithUUIDString:@"F28CD9BC-565D-4CA8-980A-6B1680D76593"];
  v3 = [v2 hm_convertToData];

  return v3;
}

+ (id)deriveIntentGroupIdentifierFromBaseUUID:(id)a3
{
  v3 = MEMORY[0x277CCAD78];
  v4 = a3;
  v5 = +[HMDHomeManager _getIntentGroupClientIdentifierSalt];
  v6 = [v3 hm_deriveUUIDFromBaseUUID:v4 identifierSalt:v5];

  return v6;
}

+ (id)getUniqueDeviceIdSalt
{
  v2 = CFPreferencesCopyAppValue(@"kUniqueDeviceIdentifierSaltkey", *MEMORY[0x277CD0028]);
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v3 = v2;
  }

  else
  {
    v3 = 0;
  }

  return v3;
}

+ (unint64_t)legacyDataSizeLimit
{
  v2 = [MEMORY[0x277D0F8D0] sharedPreferences];
  v3 = [v2 preferenceForKey:@"legacyDataSizeLimit"];

  v4 = [v3 numberValue];

  if (v4)
  {
    v5 = [v3 numberValue];
    v6 = [v5 unsignedIntegerValue];
  }

  else
  {
    v6 = 800000;
  }

  return v6;
}

+ (BOOL)doesSaveReasonNotAffectLocalData:(id)a3
{
  v3 = doesSaveReasonNotAffectLocalData__onceToken;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonNotAffectLocalData__onceToken, &__block_literal_global_739);
  }

  v5 = [doesSaveReasonNotAffectLocalData___noLocalReason containsObject:v4];

  return v5;
}

void __51__HMDHomeManager_doesSaveReasonNotAffectLocalData___block_invoke()
{
  v5[1] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = @"MetadataUpdate";
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:1];
  v2 = [v0 setWithArray:v1];
  v3 = doesSaveReasonNotAffectLocalData___noLocalReason;
  doesSaveReasonNotAffectLocalData___noLocalReason = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)shouldIgnoreExpectedConfigurationVersionUpdateForReason:(id)a3
{
  v3 = shouldIgnoreExpectedConfigurationVersionUpdateForReason__pred;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&shouldIgnoreExpectedConfigurationVersionUpdateForReason__pred, &__block_literal_global_737);
  }

  v5 = [shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons containsObject:v4];

  return v5;
}

void __74__HMDHomeManager_shouldIgnoreExpectedConfigurationVersionUpdateForReason___block_invoke()
{
  v5[2] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = @"userUserIDUpdated";
  v5[1] = @"userUpdateAccountIdentifier";
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:2];
  v2 = [v0 setWithArray:v1];
  v3 = shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons;
  shouldIgnoreExpectedConfigurationVersionUpdateForReason___ignoredReasons = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)shouldIncrementGenerationCounterForReason:(id)a3
{
  v3 = shouldIncrementGenerationCounterForReason__onceToken;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&shouldIncrementGenerationCounterForReason__onceToken, &__block_literal_global_735_174016);
  }

  v5 = [shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons containsObject:v4];

  return v5 ^ 1;
}

void __60__HMDHomeManager_shouldIncrementGenerationCounterForReason___block_invoke()
{
  v6[5] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v6[0] = @"HMDApplicationTerminatedSaveReason";
  v6[1] = @"kModifyCharacterisiticNotificationsRequestKey";
  v1 = *MEMORY[0x277CD2188];
  v6[2] = @"lastSyncedHomeConfigVersion";
  v6[3] = v1;
  v6[4] = *MEMORY[0x277CD21D0];
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v6 count:5];
  v3 = [v0 setWithArray:v2];
  v4 = shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons;
  shouldIncrementGenerationCounterForReason__noIncreaseGenerationCounterReasons = v3;

  v5 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonRequireForceSyncToWatch:(id)a3
{
  v3 = doesSaveReasonRequireForceSyncToWatch__pred;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonRequireForceSyncToWatch__pred, &__block_literal_global_733);
  }

  v5 = [doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons containsObject:v4];

  return v5;
}

void __56__HMDHomeManager_doesSaveReasonRequireForceSyncToWatch___block_invoke()
{
  v5[1] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v5[0] = *MEMORY[0x277CD12D0];
  v1 = [MEMORY[0x277CBEA60] arrayWithObjects:v5 count:1];
  v2 = [v0 setWithArray:v1];
  v3 = doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons;
  doesSaveReasonRequireForceSyncToWatch___watchForceSyncReasons = v2;

  v4 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonAffectOnlyLocalData:(id)a3
{
  v3 = doesSaveReasonAffectOnlyLocalData__pred;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonAffectOnlyLocalData__pred, &__block_literal_global_731);
  }

  v5 = [doesSaveReasonAffectOnlyLocalData___localReason containsObject:v4];

  return v5;
}

void __52__HMDHomeManager_doesSaveReasonAffectOnlyLocalData___block_invoke()
{
  v9[40] = *MEMORY[0x277D85DE8];
  v9[0] = @"kTriggerFiredNotificationKey";
  v9[1] = @"triggerSourceInternalMessage";
  v9[2] = @"kResetConfigRequestKey";
  v9[3] = @"kModifyCharacterisiticNotificationsRequestKey";
  v9[4] = @"kCharacteristicEnableNotificationRequestKey";
  v9[5] = @"Incoming invitations updated";
  v9[6] = @"kAccessHomeInviteRequestKey";
  v9[7] = @"kDismissBulletinInternalRequestKey";
  v9[8] = @"kDismissDialogInternalRequestKey";
  v9[9] = @"kApplicationVendorIDStoreUpdate";
  v0 = *MEMORY[0x277CCFEE0];
  v9[10] = *MEMORY[0x277CD20D0];
  v9[11] = v0;
  v9[12] = *MEMORY[0x277CD2348];
  v9[13] = @"HMDApplicationTerminatedSaveReason";
  v9[14] = @"kSearchForNewAccessoriesRequestKey";
  v9[15] = @"kUpdateAccessAllowedWhenLockedRequestKey";
  v9[16] = @"kBulletinBoardNotificationUpdateNotificationKey";
  v9[17] = @"HMDBulletinBoardNotificationServiceGroupUpdatedSaveReason";
  v1 = *MEMORY[0x277CD21D0];
  v9[18] = *MEMORY[0x277CD2188];
  v9[19] = v1;
  v9[20] = @"kTransactionUpdate";
  v9[21] = @"HMDHomePresenceMonitorUpdatedReason";
  v9[22] = @"userDisplayNameUpdated";
  v9[23] = @"lastSyncedHomeConfigVersion";
  v9[24] = @"AccessoryHasSymptomsHandlerUpdated";
  v9[25] = @"HMDUserCloudShareIDCodingKey";
  v9[26] = @"Update Shared Home Source Version";
  v9[27] = @"HMDHAPAccessoryUpdateCameraProfileNotificationSettingsReason";
  v9[28] = @"HMDHAPAccessorySaveAuthMethodReason";
  v9[29] = @"HMDAccessoryResidentReachabilityNotificationRegistrationMessage";
  v9[30] = @"HMDHomeManagerRecoveryVersionUpdated";
  v9[31] = @"Upgraded To HH2";
  v2 = *MEMORY[0x277CCE9E8];
  v9[32] = @"HMDAccessorySoftwareUpdate";
  v9[33] = v2;
  v9[34] = *MEMORY[0x277CD12D0];
  v9[35] = @"HMDHAPAccessoryWoLUpdateLocallyLabel";
  v9[36] = @"HMDHAPAccessoryUpdateHasPostedBulletinForWalletKeyOnboardingReason";
  v9[37] = @"HMDAppleMediaAccessoryWiFiMACLocalOnlyUpdateLabel";
  v3 = MEMORY[0x277CBEB98];
  v4 = *MEMORY[0x277CD1FA8];
  v9[38] = @"Add Accessory Locally";
  v9[39] = v4;
  v5 = [MEMORY[0x277CBEA60] arrayWithObjects:v9 count:40];
  v6 = [v3 setWithArray:v5];
  v7 = doesSaveReasonAffectOnlyLocalData___localReason;
  doesSaveReasonAffectOnlyLocalData___localReason = v6;

  v8 = *MEMORY[0x277D85DE8];
}

+ (BOOL)doesSaveReasonAffectHomeManager:(id)a3
{
  v3 = doesSaveReasonAffectHomeManager__pred;
  v4 = a3;
  if (v3 != -1)
  {
    dispatch_once(&doesSaveReasonAffectHomeManager__pred, &__block_literal_global_728);
  }

  v5 = [doesSaveReasonAffectHomeManager___homeManagerReason containsObject:v4];

  return v5;
}

void __50__HMDHomeManager_doesSaveReasonAffectHomeManager___block_invoke()
{
  v6[23] = *MEMORY[0x277D85DE8];
  v0 = MEMORY[0x277CBEB98];
  v1 = *MEMORY[0x277CD2508];
  v6[0] = *MEMORY[0x277CD2080];
  v6[1] = v1;
  v6[2] = *MEMORY[0x277CD2500];
  v6[3] = @"kHomeManagerUpdatedKey";
  v6[4] = @"kHomeManagerCloudZoneAddedKey";
  v6[5] = @"kHomeManagerCloudZoneRemovedKey";
  v6[6] = *MEMORY[0x277CD2670];
  v6[7] = @"kUserRemovedRequestKey";
  v6[8] = @"kUserManagementOperationAddedKey";
  v6[9] = @"kUserManagementOperationRemovedKey";
  v6[10] = @"kHomeDataSyncRequestKey";
  v6[11] = @"kHomeDataFragmentedSyncRequestKey";
  v6[12] = *MEMORY[0x277CD0360];
  v6[13] = @"MetadataUpdate";
  v6[14] = @"Object registration";
  v6[15] = @"Add Account";
  v6[16] = @"Update Devices";
  v6[17] = @"Update Handles";
  v6[18] = @"Remove Account";
  v6[19] = @"Update Device Name";
  v6[20] = @"Update Device";
  v6[21] = @"device pushback";
  v6[22] = @"accountHandle pushback";
  v2 = [MEMORY[0x277CBEA60] arrayWithObjects:v6 count:23];
  v3 = [v0 setWithArray:v2];
  v4 = doesSaveReasonAffectHomeManager___homeManagerReason;
  doesSaveReasonAffectHomeManager___homeManagerReason = v3;

  v5 = *MEMORY[0x277D85DE8];
}

+ (id)convertSaveReasonToTransactionReason:(id)a3
{
  v3 = a3;
  if (v3)
  {
    if (convertSaveReasonToTransactionReason__pred != -1)
    {
      dispatch_once(&convertSaveReasonToTransactionReason__pred, &__block_literal_global_726);
    }

    v4 = [convertSaveReasonToTransactionReason___reasonMap objectForKey:v3];
    v5 = v4;
    if (v4)
    {
      v6 = v4;
    }

    else
    {
      v6 = v3;
    }

    v7 = v6;
  }

  else
  {
    v7 = @"kUnknownSaveReason";
  }

  return v7;
}

void __55__HMDHomeManager_convertSaveReasonToTransactionReason___block_invoke()
{
  v4[3] = *MEMORY[0x277D85DE8];
  v3[0] = @"kRemoteUsersDeregistered";
  v3[1] = @"kAddEventTriggerRequestKey";
  v4[0] = @"kRemoveUserRequestKey";
  v4[1] = @"kAddTriggerRequestKey";
  v3[2] = @"kAddTimerTriggerRequestKey";
  v4[2] = @"kAddTriggerRequestKey";
  v0 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v4 forKeys:v3 count:3];
  v1 = convertSaveReasonToTransactionReason___reasonMap;
  convertSaveReasonToTransactionReason___reasonMap = v0;

  v2 = *MEMORY[0x277D85DE8];
}

+ (void)removeAccessoryCacheForIdentifier:(id)a3
{
  v3 = MEMORY[0x277CCAA00];
  v4 = a3;
  v7 = [v3 defaultManager];
  v5 = getBLEAccessoryCachePath();
  v6 = [v5 stringByAppendingFormat:@"/%@", v4];

  [v7 removeItemAtPath:v6 error:0];
}

+ (id)getAccessoryCacheForIdentifier:(id)a3
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = a3;
  v4 = getBLEAccessoryCachePath();
  v5 = [v4 stringByAppendingFormat:@"/%@", v3];

  v21 = 0;
  v6 = [MEMORY[0x277CBEA90] dataWithContentsOfFile:v5 options:2 error:&v21];
  v7 = v21;
  v8 = v7;
  if (v6)
  {

    v20 = 0;
    v9 = [MEMORY[0x277CCAAC8] unarchivedObjectOfClass:objc_opt_class() fromData:v6 error:&v20];
    v8 = v20;
    if (v9)
    {
      goto LABEL_13;
    }

    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
      goto LABEL_10;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543618;
    v23 = v12;
    v24 = 2112;
    v25 = v8;
    v13 = "%{public}@Failed to unarchive accessory cache from data: %@";
    v14 = v11;
    v15 = 22;
    goto LABEL_9;
  }

  v16 = [v7 domain];
  if (![v16 isEqualToString:*MEMORY[0x277CCA050]])
  {

    goto LABEL_12;
  }

  v17 = [v8 code];

  if (v17 != 260)
  {
    v10 = objc_autoreleasePoolPush();
    v11 = HMFGetOSLogHandle();
    if (!os_log_type_enabled(v11, OS_LOG_TYPE_ERROR))
    {
LABEL_10:

      objc_autoreleasePoolPop(v10);
      goto LABEL_12;
    }

    v12 = HMFGetLogIdentifier();
    *buf = 138543874;
    v23 = v12;
    v24 = 2112;
    v25 = v5;
    v26 = 2112;
    v27 = v8;
    v13 = "%{public}@Unable to load contents of cache file %@ - error %@";
    v14 = v11;
    v15 = 32;
LABEL_9:
    _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, v13, buf, v15);

    goto LABEL_10;
  }

LABEL_12:
  v9 = 0;
LABEL_13:

  v18 = *MEMORY[0x277D85DE8];

  return v9;
}

+ (void)saveAccessoryCache:(id)a3 forIdentifier:(id)a4
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a3;
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  v8 = [objc_alloc(MEMORY[0x277D0F880]) initWithName:@"com.apple.homed.btle-cache-save."];
  v9 = getBLEAccessoryCachePath();
  v10 = [v9 stringByAppendingFormat:@"/%@", v6];

  v11 = [MEMORY[0x277CCAAB0] archivedDataWithRootObject:v5 requiringSecureCoding:1 error:0];
  v12 = v11;
  if (!v11 || ([v11 writeToFile:v10 atomically:1] & 1) == 0)
  {
    v13 = objc_autoreleasePoolPush();
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v18 = v15;
      v19 = 2112;
      v20 = v10;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Failed caching to file: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v13);
  }

  objc_autoreleasePoolPop(v7);
  v16 = *MEMORY[0x277D85DE8];
}

+ (id)logCategory
{
  if (logCategory__hmf_once_t14_174027 != -1)
  {
    dispatch_once(&logCategory__hmf_once_t14_174027, &__block_literal_global_489);
  }

  v3 = logCategory__hmf_once_v15_174028;

  return v3;
}

uint64_t __29__HMDHomeManager_logCategory__block_invoke()
{
  v0 = *MEMORY[0x277D0F1A8];
  v1 = HMFCreateOSLogHandle();
  v2 = logCategory__hmf_once_v15_174028;
  logCategory__hmf_once_v15_174028 = v1;

  return MEMORY[0x2821F96F8](v1, v2);
}

- (void)_handleTestHH2Migration:(id)a3
{
  v14 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ((isInternalBuild() & 1) == 0)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = self;
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_FAULT))
    {
      v10 = HMFGetLogIdentifier();
      v12 = 138543362;
      v13 = v10;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_FAULT, "%{public}@Not sure how this message made it through isInternalBuild checks. DEBUG THIS!!!", &v12, 0xCu);
    }

    objc_autoreleasePoolPop(v7);
    v5 = [MEMORY[0x277CCA9B8] hmErrorWithCode:10];
    goto LABEL_7;
  }

  v5 = -[HMDHomeManager writeMigrationRecordWithShouldSkipKeyRollOperations:forceMigrationFailureForTesting:migrateFromTestDirectory:dryRun:isAutoMigration:](self, "writeMigrationRecordWithShouldSkipKeyRollOperations:forceMigrationFailureForTesting:migrateFromTestDirectory:dryRun:isAutoMigration:", 1, 0, 1, [v4 BOOLForKey:*MEMORY[0x277CD0210]], 0);
  if (v5)
  {
LABEL_7:
    [v4 respondWithError:v5];
    goto LABEL_8;
  }

  [HMDResetConfigPostCleanup writePostCleanupRecordToRemoveAllCoreDataFilesWithReason:5];
  v6 = [(HMDHomeManager *)self hh2FrameworkSwitch];
  [v6 switchToHH2AndRelaunchHomed];

  [v4 respondWithSuccess];
LABEL_8:

  v11 = *MEMORY[0x277D85DE8];
}

- (BOOL)canHH2MigrationBeStarted:(id *)a3
{
  v65 = *MEMORY[0x277D85DE8];
  v5 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v6 = [v5 isiCloudSwitchEnabled];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v8 = [v7 isKeychainSyncSwitchEnabled];

    if (v8)
    {
      v9 = [(HMDHomeManager *)self cloudReachabilityMonitor];
      v10 = [v9 isReachable];

      if (v10)
      {
        v11 = objc_alloc_init(HMDCloudKitReachabilitySource);
        v60 = 0;
        v12 = [(HMDCloudKitReachabilitySource *)v11 areCloudKitServersReachableWithError:&v60];
        v13 = v60;
        v14 = objc_autoreleasePoolPush();
        v15 = self;
        v16 = HMFGetOSLogHandle();
        v17 = v16;
        if (v12 != 1)
        {
          if (v12)
          {
            if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
            {
              v50 = HMFGetLogIdentifier();
              *buf = 138543362;
              v62 = v50;
              _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as there is a CloudKit account status issue", buf, 0xCu);
            }

            objc_autoreleasePoolPop(v14);
            if (a3)
            {
              v19 = [HMDHH2FrameworkSwitch errorFromHMDCKAccountStatus:v12];
              goto LABEL_42;
            }
          }

          else
          {
            if (os_log_type_enabled(v16, OS_LOG_TYPE_ERROR))
            {
              v18 = HMFGetLogIdentifier();
              *buf = 138543362;
              v62 = v18;
              _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as CloudKit account status could not be queried", buf, 0xCu);
            }

            objc_autoreleasePoolPop(v14);
            if (a3)
            {
              v19 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2727 underlyingError:v13];
LABEL_42:
              v31 = 0;
              *a3 = v19;
LABEL_44:

              goto LABEL_45;
            }
          }

LABEL_43:
          v31 = 0;
          goto LABEL_44;
        }

        if (os_log_type_enabled(v16, OS_LOG_TYPE_INFO))
        {
          v36 = HMFGetLogIdentifier();
          v37 = MEMORY[0x277CCABB0];
          v38 = [(HMDHomeManager *)v15 reachabilityMonitor];
          v39 = [v37 numberWithUnsignedInteger:{objc_msgSend(v38, "reachabilityPath")}];
          *buf = 138543618;
          v62 = v36;
          v63 = 2112;
          v64 = v39;
          _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Current Network path : %@", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v14);
        v40 = [(HMDHomeManager *)v15 reachabilityMonitor];
        v41 = [v40 reachabilityPath];

        if (v41 == 2)
        {
          v42 = [MEMORY[0x277CCAC38] processInfo];
          v43 = [v42 isLowPowerModeEnabled];

          if (!v43)
          {
            v31 = 1;
            goto LABEL_44;
          }

          v44 = objc_autoreleasePoolPush();
          v45 = v15;
          v46 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v46, OS_LOG_TYPE_ERROR))
          {
            v47 = HMFGetLogIdentifier();
            *buf = 138543362;
            v62 = v47;
            _os_log_impl(&dword_2531F8000, v46, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as low power mode is enabled", buf, 0xCu);
          }

          objc_autoreleasePoolPop(v44);
          if (!a3)
          {
            goto LABEL_43;
          }

          v48 = MEMORY[0x277CCA9B8];
          v49 = 2712;
        }

        else
        {
          v51 = objc_autoreleasePoolPush();
          v52 = v15;
          v53 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v53, OS_LOG_TYPE_ERROR))
          {
            v54 = HMFGetLogIdentifier();
            v55 = MEMORY[0x277CCABB0];
            v56 = [(HMDHomeManager *)v52 reachabilityMonitor];
            v57 = [v55 numberWithUnsignedInteger:{objc_msgSend(v56, "reachabilityPath")}];
            *buf = 138543618;
            v62 = v54;
            v63 = 2112;
            v64 = v57;
            _os_log_impl(&dword_2531F8000, v53, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as user is connected on cellular network : %@", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v51);
          if (!a3)
          {
            goto LABEL_43;
          }

          v48 = MEMORY[0x277CCA9B8];
          v49 = 2726;
        }

        v19 = [v48 hmPrivateErrorWithCode:v49];
        goto LABEL_42;
      }

      v32 = objc_autoreleasePoolPush();
      v33 = self;
      v34 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v34, OS_LOG_TYPE_ERROR))
      {
        v35 = HMFGetLogIdentifier();
        *buf = 138543362;
        v62 = v35;
        _os_log_impl(&dword_2531F8000, v34, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as CloudKit servers are not reachable", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v32);
      if (a3)
      {
        v24 = MEMORY[0x277CCA9B8];
        v25 = 2705;
        goto LABEL_14;
      }
    }

    else
    {
      v27 = objc_autoreleasePoolPush();
      v28 = self;
      v29 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v29, OS_LOG_TYPE_ERROR))
      {
        v30 = HMFGetLogIdentifier();
        *buf = 138543362;
        v62 = v30;
        _os_log_impl(&dword_2531F8000, v29, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as iCloud keychain sync is not enabled", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v27);
      if (a3)
      {
        v26 = [MEMORY[0x277CCA9B8] hmErrorWithCode:76];
        goto LABEL_19;
      }
    }

LABEL_24:
    v31 = 0;
    goto LABEL_45;
  }

  v20 = objc_autoreleasePoolPush();
  v21 = self;
  v22 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v22, OS_LOG_TYPE_ERROR))
  {
    v23 = HMFGetLogIdentifier();
    *buf = 138543362;
    v62 = v23;
    _os_log_impl(&dword_2531F8000, v22, OS_LOG_TYPE_ERROR, "%{public}@Cannot start the HH2 migration as iCloud switch for HomeKit is not enabled", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v20);
  if (!a3)
  {
    goto LABEL_24;
  }

  v24 = MEMORY[0x277CCA9B8];
  v25 = 2013;
LABEL_14:
  v26 = [v24 hmPrivateErrorWithCode:v25];
LABEL_19:
  v31 = 0;
  *a3 = v26;
LABEL_45:
  v58 = *MEMORY[0x277D85DE8];
  return v31;
}

- (void)saveToPersistentStoreForHH2MigrationWithCompletionHandler:(id)a3
{
  v15 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v13 = 138543362;
    v14 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Going to save the home graph to local archive before starting the migration", &v13, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 backingStore];
  v10 = objc_opt_class();
  v11 = [(HMDHomeManager *)v6 backingStore];
  [v10 saveToPersistentStoreWithReason:@"RefreshBeforeMigrationToHH2" homeManager:v6 shouldIncrementGenerationCounter:1 backingStore:v11 completionHandler:v4];

  v12 = *MEMORY[0x277D85DE8];
}

- (void)refreshHomeDataAndArchiveLocallyWithIsAutoMigration:(BOOL)a3 completion:(id)a4
{
  v17 = *MEMORY[0x277D85DE8];
  v5 = a4;
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
  {
    v9 = HMFGetLogIdentifier();
    *buf = 138543362;
    v16 = v9;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@refreshing home data fetch from cloud and going to archive it to local persistent store", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v6);
  objc_initWeak(buf, v7);
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __101__HMDHomeManager_HH2FrameworkSwitch__refreshHomeDataAndArchiveLocallyWithIsAutoMigration_completion___block_invoke;
  v12[3] = &unk_279734508;
  objc_copyWeak(&v14, buf);
  v10 = v5;
  v13 = v10;
  [(HMDHomeManager *)v7 _fetchAllZones:v12];

  objc_destroyWeak(&v14);
  objc_destroyWeak(buf);

  v11 = *MEMORY[0x277D85DE8];
}

void __101__HMDHomeManager_HH2FrameworkSwitch__refreshHomeDataAndArchiveLocallyWithIsAutoMigration_completion___block_invoke(uint64_t a1, void *a2)
{
  v28 = *MEMORY[0x277D85DE8];
  v3 = a2;
  WeakRetained = objc_loadWeakRetained((a1 + 40));
  if (v3)
  {
    v5 = [v3 domain];
    if ([v5 isEqual:*MEMORY[0x277CBBF50]])
    {
      v6 = [v3 code];

      if (v6 == 26)
      {
        v7 = objc_autoreleasePoolPush();
        v8 = WeakRetained;
        v9 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v9, OS_LOG_TYPE_DEFAULT))
        {
          v10 = HMFGetLogIdentifier();
          *buf = 138543618;
          v25 = v10;
          v26 = 2114;
          v27 = v3;
          _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_DEFAULT, "%{public}@Ignoring %{public}@ when refreshing home data before migration", buf, 0x16u);
        }

        objc_autoreleasePoolPop(v7);
        goto LABEL_7;
      }
    }

    else
    {
    }

    v12 = objc_autoreleasePoolPush();
    v13 = WeakRetained;
    v14 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v14, OS_LOG_TYPE_ERROR))
    {
      v15 = HMFGetLogIdentifier();
      *buf = 138543618;
      v25 = v15;
      v26 = 2112;
      v27 = v3;
      _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_ERROR, "%{public}@Unable to refresh data from cloud before starting the migration: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v12);
    v16 = *(a1 + 32);
    v17 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2704 description:0 underlyingError:v3];
    goto LABEL_16;
  }

LABEL_7:
  if (WeakRetained)
  {
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __101__HMDHomeManager_HH2FrameworkSwitch__refreshHomeDataAndArchiveLocallyWithIsAutoMigration_completion___block_invoke_81;
    v22[3] = &unk_279735558;
    v23 = *(a1 + 32);
    [WeakRetained saveToPersistentStoreForHH2MigrationWithCompletionHandler:v22];
    v11 = v23;
    goto LABEL_18;
  }

  v18 = objc_autoreleasePoolPush();
  v19 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
  {
    v20 = HMFGetLogIdentifier();
    *buf = 138543362;
    v25 = v20;
    _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_ERROR, "%{public}@(A) HomeManager is not available", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v18);
  v16 = *(a1 + 32);
  v17 = [MEMORY[0x277CCA9B8] hmErrorWithCode:20];
LABEL_16:
  v11 = v17;
  if (v16)
  {
    (*(v16 + 16))(v16, v17);
  }

LABEL_18:

  v21 = *MEMORY[0x277D85DE8];
}

uint64_t __101__HMDHomeManager_HH2FrameworkSwitch__refreshHomeDataAndArchiveLocallyWithIsAutoMigration_completion___block_invoke_81(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

- (void)_startHH2MigrationWithShouldSkipKeyRollOperations:(BOOL)a3 forceMigrationFailureForTesting:(BOOL)a4 isAutoMigration:(BOOL)a5 dryRun:(BOOL)a6 completionHandler:(id)a7
{
  v31 = *MEMORY[0x277D85DE8];
  v12 = a7;
  v13 = objc_autoreleasePoolPush();
  v14 = self;
  v15 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v15, OS_LOG_TYPE_INFO))
  {
    v16 = HMFGetLogIdentifier();
    *buf = 138543362;
    v30 = v16;
    _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_INFO, "%{public}@checking whether CK servers are reachable or not", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v13);
  v17 = objc_alloc_init(HMDCloudKitReachabilitySource);
  v28 = 0;
  v18 = [(HMDCloudKitReachabilitySource *)v17 areCloudKitServersReachableWithError:&v28];
  v19 = v28;
  if (v18 == 1)
  {
    v22[0] = MEMORY[0x277D85DD0];
    v22[1] = 3221225472;
    v22[2] = __161__HMDHomeManager_HH2FrameworkSwitch___startHH2MigrationWithShouldSkipKeyRollOperations_forceMigrationFailureForTesting_isAutoMigration_dryRun_completionHandler___block_invoke;
    v22[3] = &unk_2797344E0;
    v22[4] = v14;
    v23 = v12;
    v24 = a5;
    v25 = a3;
    v26 = a4;
    v27 = a6;
    [HMDRemoteLoginUtilities fetchIsTwoFactorAuthenticationEnabledForAccountWithReason:@"HH2 Migration" completionHandler:v22];
  }

  else
  {
    if (v18)
    {
      [HMDHH2FrameworkSwitch errorFromHMDCKAccountStatus:v18];
    }

    else
    {
      [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2727 underlyingError:v19];
    }
    v20 = ;
    if (v12)
    {
      (*(v12 + 2))(v12, v20);
    }
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __161__HMDHomeManager_HH2FrameworkSwitch___startHH2MigrationWithShouldSkipKeyRollOperations_forceMigrationFailureForTesting_isAutoMigration_dryRun_completionHandler___block_invoke(uint64_t a1, char a2)
{
  v21 = *MEMORY[0x277D85DE8];
  if (a2)
  {
    v3 = *(a1 + 48);
    v16[0] = MEMORY[0x277D85DD0];
    v16[1] = 3221225472;
    v16[2] = __161__HMDHomeManager_HH2FrameworkSwitch___startHH2MigrationWithShouldSkipKeyRollOperations_forceMigrationFailureForTesting_isAutoMigration_dryRun_completionHandler___block_invoke_79;
    v16[3] = &unk_2797344B8;
    v4 = *(a1 + 32);
    v5 = *(a1 + 40);
    v16[4] = *(a1 + 32);
    v17 = v5;
    v6.i32[0] = *(a1 + 48);
    v7 = vmovl_u8(v6).u64[0];
    v8 = vext_s8(v7, v7, 2uLL);
    v18 = vuzp1_s8(v8, v8).u32[0];
    [v4 refreshHomeDataAndArchiveLocallyWithIsAutoMigration:v3 completion:v16];
    v9 = v17;
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 32);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v20 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_ERROR, "%{public}@This account does not have HSA2 enabled", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v14 = *(a1 + 40);
    v9 = [MEMORY[0x277CCA9B8] hmPrivateErrorWithCode:2719];
    if (v14)
    {
      (*(v14 + 16))(v14, v9);
    }
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __161__HMDHomeManager_HH2FrameworkSwitch___startHH2MigrationWithShouldSkipKeyRollOperations_forceMigrationFailureForTesting_isAutoMigration_dryRun_completionHandler___block_invoke_79(uint64_t a1, void *a2)
{
  v16 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if (v3)
  {
    v4 = *(a1 + 40);
    if (v4)
    {
      (*(v4 + 16))(v4, v3);
    }
  }

  else
  {
    v5 = [*(a1 + 32) writeMigrationRecordWithShouldSkipKeyRollOperations:*(a1 + 48) forceMigrationFailureForTesting:*(a1 + 49) migrateFromTestDirectory:0 dryRun:*(a1 + 50) isAutoMigration:*(a1 + 51)];
    if (v5)
    {
      v6 = *(a1 + 40);
      if (v6)
      {
        (*(v6 + 16))(v6, v5);
      }
    }

    else
    {
      [*(a1 + 32) setHh2MigrationInProgress:1];
      [HMDHH2MigrationStateLogger recordMigrationStart:*(a1 + 51) isDryRun:*(a1 + 50)];
      v7 = *(a1 + 40);
      if (v7)
      {
        (*(v7 + 16))(v7, 0);
      }

      v8 = objc_autoreleasePoolPush();
      v9 = *(a1 + 32);
      v10 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v10, OS_LOG_TYPE_DEFAULT))
      {
        v11 = HMFGetLogIdentifier();
        v14 = 138543362;
        v15 = v11;
        _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_DEFAULT, "%{public}@Migration request is successfully received. Starting the migration work locally first...", &v14, 0xCu);
      }

      objc_autoreleasePoolPop(v8);
      v12 = [*(a1 + 32) hh2FrameworkSwitch];
      [v12 switchToHH2AndRelaunchHomedToPerformHH2Migration];
    }
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __91__HMDHomeManager_HH2FrameworkSwitch___startHH2MigrationWithRequestMessage_isAutoMigration___block_invoke(uint64_t a1, void *a2)
{
  v15 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = objc_autoreleasePoolPush();
  v5 = *(a1 + 32);
  v6 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v6, OS_LOG_TYPE_INFO))
  {
    v7 = HMFGetLogIdentifier();
    v11 = 138543618;
    v12 = v7;
    v13 = 2112;
    v14 = v3;
    _os_log_impl(&dword_2531F8000, v6, OS_LOG_TYPE_INFO, "%{public}@Migration requested with error : [%@]", &v11, 0x16u);
  }

  objc_autoreleasePoolPop(v4);
  [*(a1 + 40) respondWithPayload:0 error:v3];
  if ((*(a1 + 48) & 1) == 0 && v3 && (*(a1 + 49) & 1) == 0)
  {
    v8 = [[HMDHH2MigrationDailyTotalsLogEvent alloc] initEndWithAutoMigration:0 dryRun:0 attemptCount:0 error:v3];
    v9 = [*(a1 + 32) logEventSubmitter];
    [v9 submitLogEvent:v8];
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (BOOL)moveDirectlyToHH2IfOnlyHH2SharedHomesExist
{
  v3 = [(HMDHomeManager *)self _onlyHH2SharedHomesExist];
  if (v3)
  {

    LOBYTE(v3) = [(HMDHomeManager *)self moveDirectlyToHH2];
  }

  return v3;
}

- (void)checkAndMoveDirectlyToHH2IfOnlyHH2SharedHomesExistAllowEmptyOwnedHomes:(BOOL)a3
{
  v5 = [(HMDHomeManager *)self workQueue];
  v6[0] = MEMORY[0x277D85DD0];
  v6[1] = 3221225472;
  v6[2] = __109__HMDHomeManager_HH2FrameworkSwitch__checkAndMoveDirectlyToHH2IfOnlyHH2SharedHomesExistAllowEmptyOwnedHomes___block_invoke;
  v6[3] = &unk_279735D28;
  v7 = a3;
  v6[4] = self;
  dispatch_async(v5, v6);
}

void __109__HMDHomeManager_HH2FrameworkSwitch__checkAndMoveDirectlyToHH2IfOnlyHH2SharedHomesExistAllowEmptyOwnedHomes___block_invoke(uint64_t a1)
{
  if ((*(a1 + 40) & 1) != 0 || [*(a1 + 32) _onlyHH2SharedHomesExist])
  {
    v2 = [*(a1 + 32) cloudDataSyncStateFilter];
    [v2 moveDirectlyToHH2IfAccountOnlyHasUpgradedSharedHomesAllowEmptyOwnedHomes:*(a1 + 40)];
  }
}

- (BOOL)_onlyHH2SharedHomesExist
{
  v31 = *MEMORY[0x277D85DE8];
  v3 = [(HMDHomeManager *)self homes];
  v4 = [v3 count];

  if (v4)
  {
    v22 = 0u;
    v23 = 0u;
    v20 = 0u;
    v21 = 0u;
    v5 = [(HMDHomeManager *)self homes];
    v6 = [v5 countByEnumeratingWithState:&v20 objects:v30 count:16];
    if (v6)
    {
      v7 = v6;
      v8 = *v21;
      while (2)
      {
        for (i = 0; i != v7; ++i)
        {
          if (*v21 != v8)
          {
            objc_enumerationMutation(v5);
          }

          v10 = *(*(&v20 + 1) + 8 * i);
          if (([v10 isOwnerUser] & 1) != 0 || (objc_msgSend(v10, "isUpdatedToHH2") & 1) == 0)
          {
            v12 = objc_autoreleasePoolPush();
            v13 = self;
            v14 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
            {
              v15 = HMFGetLogIdentifier();
              [v10 isOwnerUser];
              v16 = HMFBooleanToString();
              [v10 isUpdatedToHH2];
              v17 = HMFBooleanToString();
              *buf = 138543874;
              v25 = v15;
              v26 = 2112;
              v27 = v16;
              v28 = 2112;
              v29 = v17;
              _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Skipping migration because there is at least home that cannot be migrated: owner = %@, isUpdatedToHH2 = %@", buf, 0x20u);
            }

            objc_autoreleasePoolPop(v12);
            v11 = 0;
            goto LABEL_17;
          }
        }

        v7 = [v5 countByEnumeratingWithState:&v20 objects:v30 count:16];
        v11 = 1;
        if (v7)
        {
          continue;
        }

        break;
      }
    }

    else
    {
      v11 = 1;
    }

LABEL_17:
  }

  else
  {
    v11 = 0;
  }

  v18 = *MEMORY[0x277D85DE8];
  return v11;
}

- (BOOL)moveDirectlyToHH2
{
  v24 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v21 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Skipping migration to HH2 as there are no homes need to migrate for this account", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [(HMDHomeManager *)v4 hh2FrameworkSwitch];
  v19 = 0;
  v8 = [v7 waitForHH2SentinelZoneToBeCreated:&v19 error:6.0e10];
  v9 = v19;

  v10 = objc_autoreleasePoolPush();
  v11 = v4;
  v12 = HMFGetOSLogHandle();
  v13 = v12;
  if (v8)
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v21 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Successfully created HH2 sentinel zone as this account does not have any home data.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    [HMDResetConfigPostCleanup writePostCleanupRecordToRemoveAllCoreDataFilesWithReason:5];
    v15 = [(HMDHomeManager *)v11 hh2FrameworkSwitch];
    [v15 switchToHH2AfterPerformingHH2PreRebootTask];
  }

  else
  {
    if (os_log_type_enabled(v12, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *buf = 138543618;
      v21 = v16;
      v22 = 2114;
      v23 = v9;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Cannot move empty account to HH2 because HH2 sentinel zone creation failed: %{public}@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
  }

  v17 = *MEMORY[0x277D85DE8];
  return v8;
}

- (void)_handleAttemptHH2AutoMigrationMessage:(id)a3
{
  v16 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    *buf = 138543362;
    v15 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Received request to attempt auto migration", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  v9 = [(HMDHomeManager *)v6 hh2AutoMigrationMonitor];
  v12[0] = MEMORY[0x277D85DD0];
  v12[1] = 3221225472;
  v12[2] = __76__HMDHomeManager_HH2FrameworkSwitch___handleAttemptHH2AutoMigrationMessage___block_invoke;
  v12[3] = &unk_279734468;
  v13 = v4;
  v10 = v4;
  [v9 attemptAutoMigrationWithCompletionHandler:v12];

  v11 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager_HH2FrameworkSwitch___handleAttemptHH2AutoMigrationMessage___block_invoke(uint64_t a1, int a2)
{
  v2 = *(a1 + 32);
  if (a2)
  {
    v3 = *(a1 + 32);

    [v3 respondWithSuccess];
  }

  else
  {
    v4 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
    [v2 respondWithError:v4];
  }
}

- (void)_performAutoMigrationToHH2WithIsDryRun:(BOOL)a3 completionHandler:(id)a4
{
  v4 = a3;
  v29 = *MEMORY[0x277D85DE8];
  v6 = a4;
  v7 = objc_autoreleasePoolPush();
  v8 = self;
  v9 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v9, OS_LOG_TYPE_INFO))
  {
    v10 = HMFGetLogIdentifier();
    v11 = HMFBooleanToString();
    *buf = 138543618;
    v26 = v10;
    v27 = 2112;
    v28 = v11;
    _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_INFO, "%{public}@Performing Auto Migration to HH2 with is dry run: %@", buf, 0x16u);
  }

  objc_autoreleasePoolPop(v7);
  v12 = [MEMORY[0x277CBEB38] dictionary];
  v13 = v12;
  if (v4)
  {
    [v12 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:*MEMORY[0x277CD0210]];
  }

  v14 = MEMORY[0x277D0F848];
  v15 = *MEMORY[0x277CD03E0];
  v16 = objc_alloc(MEMORY[0x277D0F820]);
  v17 = [(HMDHomeManager *)v8 uuid];
  v18 = [v16 initWithTarget:v17];
  v19 = [v14 messageWithName:v15 destination:v18 payload:v13];

  v22[0] = MEMORY[0x277D85DD0];
  v22[1] = 3221225472;
  v22[2] = __95__HMDHomeManager_HH2FrameworkSwitch___performAutoMigrationToHH2WithIsDryRun_completionHandler___block_invoke;
  v22[3] = &unk_279734440;
  v24 = v4;
  v22[4] = v8;
  v23 = v6;
  v20 = v6;
  [v19 setResponseHandler:v22];
  [(HMDHomeManager *)v8 _handleUpgradeToHH2Message:v19 autoMigration:!v4];

  v21 = *MEMORY[0x277D85DE8];
}

void __95__HMDHomeManager_HH2FrameworkSwitch___performAutoMigrationToHH2WithIsDryRun_completionHandler___block_invoke(uint64_t a1, void *a2, void *a3)
{
  v21 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  v7 = _os_feature_enabled_impl();
  if (!v5 && v7 && *(a1 + 48) == 1)
  {
    v8 = [MEMORY[0x277D0F8E8] productInfo];
    v9 = [v8 softwareVersion];
    v10 = [v9 buildVersion];

    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 32);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      v17 = 138543618;
      v18 = v14;
      v19 = 2112;
      v20 = v10;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Request to run dry run is accepted. Saving the build number: %@", &v17, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v15 = [MEMORY[0x277CBEBD0] standardUserDefaults];
    [v15 setObject:v10 forKey:@"hh2MigrationDryRunBuildNumber"];
  }

  (*(*(a1 + 40) + 16))();

  v16 = *MEMORY[0x277D85DE8];
}

- (BOOL)canPerformDryRunOfHH2Migration
{
  v25 = *MEMORY[0x277D85DE8];
  if (isInternalBuild())
  {
    v3 = objc_autoreleasePoolPush();
    v4 = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      v21 = 138543362;
      v22 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@No restriction for dry run for internal build", &v21, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    LOBYTE(v4) = 1;
  }

  else
  {
    v7 = [MEMORY[0x277D0F8E8] productInfo];
    v8 = [v7 softwareVersion];
    v9 = [v8 buildVersion];

    v10 = objc_autoreleasePoolPush();
    v11 = self;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v21 = 138543618;
      v22 = v13;
      v23 = 2112;
      v24 = v9;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@current OS version : %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [MEMORY[0x277CBEBD0] standardUserDefaults];
    v15 = [v14 stringForKey:@"hh2MigrationDryRunBuildNumber"];

    v16 = objc_autoreleasePoolPush();
    v4 = v11;
    v17 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v17, OS_LOG_TYPE_INFO))
    {
      v18 = HMFGetLogIdentifier();
      v21 = 138543618;
      v22 = v18;
      v23 = 2112;
      v24 = v15;
      _os_log_impl(&dword_2531F8000, v17, OS_LOG_TYPE_INFO, "%{public}@Stored OS version : %@", &v21, 0x16u);
    }

    objc_autoreleasePoolPop(v16);
    LODWORD(v4) = HMFEqualObjects() ^ 1;
  }

  v19 = *MEMORY[0x277D85DE8];
  return v4;
}

- (void)dryRunHH2MigrationWithCompletionHandler:(id)a3
{
  v23 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if ((_os_feature_enabled_impl() & 1) == 0)
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_ERROR))
    {
      v14 = HMFGetLogIdentifier();
      v21 = 138543362;
      v22 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_ERROR, "%{public}@Not running the dry run as FF is OFF", &v21, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    v15 = _Block_copy(v4);
    if (!v15)
    {
      goto LABEL_15;
    }

    v16 = MEMORY[0x277CCA9B8];
    v17 = 2724;
    goto LABEL_14;
  }

  v5 = [(HMDHomeManager *)self canPerformDryRunOfHH2Migration];
  v6 = objc_autoreleasePoolPush();
  v7 = self;
  v8 = HMFGetOSLogHandle();
  v9 = os_log_type_enabled(v8, OS_LOG_TYPE_INFO);
  if (!v5)
  {
    if (v9)
    {
      v18 = HMFGetLogIdentifier();
      v21 = 138543362;
      v22 = v18;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Not running the dry run as it ran previously for this software version", &v21, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v15 = _Block_copy(v4);
    if (!v15)
    {
      goto LABEL_15;
    }

    v16 = MEMORY[0x277CCA9B8];
    v17 = 2725;
LABEL_14:
    v19 = [v16 hmPrivateErrorWithCode:v17];
    v15[2](v15, v19);

LABEL_15:
    goto LABEL_16;
  }

  if (v9)
  {
    v10 = HMFGetLogIdentifier();
    v21 = 138543362;
    v22 = v10;
    _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Going to do a Dry run of HH2 migration as we never ran it on this software version", &v21, 0xCu);
  }

  objc_autoreleasePoolPop(v6);
  [(HMDHomeManager *)v7 _performAutoMigrationToHH2WithIsDryRun:1 completionHandler:v4];
LABEL_16:

  v20 = *MEMORY[0x277D85DE8];
}

- (void)autoMigrateToHH2WithCompletionHandler:(id)a3
{
  v12 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = objc_autoreleasePoolPush();
  v6 = self;
  v7 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v7, OS_LOG_TYPE_INFO))
  {
    v8 = HMFGetLogIdentifier();
    v10 = 138543362;
    v11 = v8;
    _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_INFO, "%{public}@Auto Migration: Upgrading to HH2", &v10, 0xCu);
  }

  objc_autoreleasePoolPop(v5);
  [(HMDHomeManager *)v6 _performAutoMigrationToHH2WithIsDryRun:0 completionHandler:v4];

  v9 = *MEMORY[0x277D85DE8];
}

- (void)determineEmptyHomesForSharedUsersWithCompletionHandler:(id)a3
{
  v36 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 count];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self cloudDataSyncManager];
    v8 = [v7 cloudCache];

    if (v8)
    {
      v9 = dispatch_group_create();
      v10 = [MEMORY[0x277CBEB38] dictionary];
      v11 = [(HMDHomeManager *)self homes];
      v30[0] = MEMORY[0x277D85DD0];
      v30[1] = 3221225472;
      v30[2] = __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke;
      v30[3] = &unk_2797343F8;
      v30[4] = self;
      v12 = v10;
      v31 = v12;
      v32 = v9;
      v33 = v8;
      v13 = v9;
      [v11 hmf_enumerateWithAutoreleasePoolUsingBlock:v30];

      v14 = [(HMDHomeManager *)self workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_56;
      block[3] = &unk_2797355D0;
      block[4] = self;
      v28 = v12;
      v29 = v4;
      v15 = v12;
      dispatch_group_notify(v13, v14, block);
    }

    else
    {
      v21 = objc_autoreleasePoolPush();
      v22 = self;
      v23 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = HMFGetLogIdentifier();
        *buf = 138543362;
        v35 = v24;
        _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, "%{public}@[Shared User] : Cloud cache is nil. Cannot proceed to determine empty homes. aborting...", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v21);
      v25 = _Block_copy(v4);
      v13 = v25;
      if (v25)
      {
        (v25[2].isa)(v25, MEMORY[0x277CBEC10]);
      }
    }
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = self;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v35 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@[Shared User] : No homes found.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v20 = _Block_copy(v4);
    v8 = v20;
    if (v20)
    {
      (*(v20 + 2))(v20, MEMORY[0x277CBEC10]);
    }
  }

  v26 = *MEMORY[0x277D85DE8];
}

void __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke(uint64_t a1, void *a2)
{
  v20 = *MEMORY[0x277D85DE8];
  v3 = a2;
  if ([v3 isOwnerUser])
  {
    v4 = *(a1 + 40);
    v5 = [v3 uuid];
    [v4 setObject:MEMORY[0x277CBEC28] forKeyedSubscript:v5];

    dispatch_group_enter(*(a1 + 48));
    v6 = *(a1 + 56);
    v7 = [v3 zoneID];
    v8 = [v7 UUIDString];
    v14[0] = MEMORY[0x277D85DD0];
    v14[1] = 3221225472;
    v14[2] = __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_54;
    v14[3] = &unk_2797343D0;
    v14[4] = *(a1 + 32);
    v15 = *(a1 + 48);
    v16 = v3;
    v17 = *(a1 + 40);
    [v6 homeZoneWithName:v8 owner:&stru_286509E58 completion:v14];
  }

  else
  {
    v9 = objc_autoreleasePoolPush();
    v10 = *(a1 + 32);
    v11 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v11, OS_LOG_TYPE_DEFAULT))
    {
      v12 = HMFGetLogIdentifier();
      *buf = 138543362;
      v19 = v12;
      _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_DEFAULT, "%{public}@Having a shared home (empty or full) will be considered home as non-empty", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v9);
  }

  v13 = *MEMORY[0x277D85DE8];
}

void __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_56(uint64_t a1)
{
  v14 = *MEMORY[0x277D85DE8];
  v2 = objc_autoreleasePoolPush();
  v3 = *(a1 + 32);
  v4 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v4, OS_LOG_TYPE_DEFAULT))
  {
    v5 = HMFGetLogIdentifier();
    v6 = *(a1 + 40);
    v10 = 138543618;
    v11 = v5;
    v12 = 2112;
    v13 = v6;
    _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_DEFAULT, "%{public}@[Shared User] : Empty home determination map: %@", &v10, 0x16u);
  }

  objc_autoreleasePoolPop(v2);
  v7 = _Block_copy(*(a1 + 48));
  v8 = v7;
  if (v7)
  {
    (*(v7 + 2))(v7, *(a1 + 40));
  }

  v9 = *MEMORY[0x277D85DE8];
}

void __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_54(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 32);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543618;
      v23 = v10;
      v24 = 2112;
      v25 = v6;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@[Shared User] : Error occurred while querying cloud cache: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    dispatch_group_leave(*(a1 + 40));
  }

  else
  {
    v11 = [*(a1 + 32) workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_55;
    block[3] = &unk_2797352C0;
    v17 = *(a1 + 48);
    v12 = v5;
    v13 = *(a1 + 32);
    v14 = *(a1 + 40);
    v18 = v12;
    v19 = v13;
    v20 = v14;
    v21 = *(a1 + 56);
    dispatch_async(v11, block);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __93__HMDHomeManager_HH2FrameworkSwitch__determineEmptyHomesForSharedUsersWithCompletionHandler___block_invoke_55(uint64_t a1)
{
  v37 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) residentDeviceManager];
  v3 = [v2 wasTheHomeFetchedFromCloud];

  if ([*(a1 + 40) hasServerTokenAvailable] && (v3 & 1) != 0)
  {
    if (HMDIsEmptyHome(*(a1 + 32)))
    {
      v4 = *(a1 + 64);
      v5 = [*(a1 + 32) uuid];
      [v4 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:v5];
    }

    v6 = objc_autoreleasePoolPush();
    v7 = *(a1 + 48);
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = HMFGetLogIdentifier();
      v10 = MEMORY[0x277CCABB0];
      v26 = [*(a1 + 32) rooms];
      [v10 numberWithUnsignedInteger:{objc_msgSend(v26, "count")}];
      v11 = v25 = v6;
      v12 = MEMORY[0x277CCABB0];
      v24 = [*(a1 + 32) accessories];
      v13 = [v12 numberWithUnsignedInteger:{objc_msgSend(v24, "count")}];
      v14 = MEMORY[0x277CCABB0];
      v15 = [*(a1 + 32) sharedUsers];
      v16 = [v14 numberWithUnsignedInteger:{objc_msgSend(v15, "count")}];
      v17 = MEMORY[0x277CCABB0];
      v18 = [*(a1 + 32) outgoingInvitations];
      v19 = [v17 numberWithUnsignedInteger:{objc_msgSend(v18, "count")}];
      *buf = 138544386;
      v28 = v9;
      v29 = 2112;
      v30 = v11;
      v31 = 2112;
      v32 = v13;
      v33 = 2112;
      v34 = v16;
      v35 = 2112;
      v36 = v19;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@[Shared User] : Home Stats: [Total Rooms: %@], [Total Accessories: %@], [Total Shared Users: %@], [Total Invitations: %@]", buf, 0x34u);

      v6 = v25;
    }
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = *(a1 + 48);
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v20 = HMFGetLogIdentifier();
      [*(a1 + 40) hasServerTokenAvailable];
      v21 = HMFBooleanToString();
      v22 = HMFBooleanToString();
      *buf = 138543874;
      v28 = v20;
      v29 = 2114;
      v30 = v21;
      v31 = 2114;
      v32 = v22;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@[Shared User] : Either Server token is not available (%{public}@) or the home was not fetched from the cloud (%{public}@)", buf, 0x20u);
    }
  }

  objc_autoreleasePoolPop(v6);
  dispatch_group_leave(*(a1 + 56));
  v23 = *MEMORY[0x277D85DE8];
}

- (void)_determineEmptyHomesForOwnersWithCompletionHandler:(id)a3
{
  v38 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self homes];
  v6 = [v5 count];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self cloudDataSyncManager];
    v8 = [v7 cloudCache];

    if (v8)
    {
      v9 = dispatch_group_create();
      v10 = [MEMORY[0x277CBEB38] dictionary];
      v11 = [(HMDHomeManager *)self homes];
      v31[0] = MEMORY[0x277D85DD0];
      v31[1] = 3221225472;
      v31[2] = __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke;
      v31[3] = &unk_2797343F8;
      v12 = v10;
      v32 = v12;
      v33 = self;
      v34 = v9;
      v35 = v8;
      v13 = v9;
      [v11 hmf_enumerateWithAutoreleasePoolUsingBlock:v31];

      v14 = [(HMDHomeManager *)self workQueue];
      block[0] = MEMORY[0x277D85DD0];
      block[1] = 3221225472;
      block[2] = __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_49;
      block[3] = &unk_2797355D0;
      v28 = v12;
      v29 = self;
      v30 = v4;
      v15 = v12;
      dispatch_group_notify(v13, v14, block);
    }

    else
    {
      v21 = objc_autoreleasePoolPush();
      v22 = self;
      v23 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v23, OS_LOG_TYPE_DEFAULT))
      {
        v24 = HMFGetLogIdentifier();
        *buf = 138543362;
        v37 = v24;
        _os_log_impl(&dword_2531F8000, v23, OS_LOG_TYPE_DEFAULT, "%{public}@Cloud cache is nil. Cannot proceed to determine empty homes. aborting...", buf, 0xCu);
      }

      objc_autoreleasePoolPop(v21);
      v25 = _Block_copy(v4);
      v13 = v25;
      if (v25)
      {
        (v25[2].isa)(v25, 0);
      }
    }
  }

  else
  {
    v16 = objc_autoreleasePoolPush();
    v17 = self;
    v18 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v18, OS_LOG_TYPE_DEFAULT))
    {
      v19 = HMFGetLogIdentifier();
      *buf = 138543362;
      v37 = v19;
      _os_log_impl(&dword_2531F8000, v18, OS_LOG_TYPE_DEFAULT, "%{public}@No homes found.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v16);
    v20 = _Block_copy(v4);
    v8 = v20;
    if (v20)
    {
      (*(v20 + 2))(v20, 0);
    }
  }

  v26 = *MEMORY[0x277D85DE8];
}

void __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke(uint64_t a1, void *a2)
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = a2;
  v4 = *(a1 + 32);
  v5 = [v3 uuid];
  [v4 setObject:MEMORY[0x277CBEC28] forKeyedSubscript:v5];

  if ([v3 isOwnerUser])
  {
    dispatch_group_enter(*(a1 + 48));
    v6 = *(a1 + 56);
    v7 = [v3 zoneID];
    v8 = [v7 UUIDString];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_46;
    v15[3] = &unk_2797343D0;
    v9 = *(a1 + 48);
    v15[4] = *(a1 + 40);
    v16 = v9;
    v17 = v3;
    v18 = *(a1 + 32);
    [v6 homeZoneWithName:v8 owner:&stru_286509E58 completion:v15];
  }

  else
  {
    v10 = objc_autoreleasePoolPush();
    v11 = *(a1 + 40);
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_DEFAULT))
    {
      v13 = HMFGetLogIdentifier();
      *buf = 138543362;
      v20 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_DEFAULT, "%{public}@Having a shared home (empty or full) will be considered home as non-empty", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_49(uint64_t a1)
{
  v26 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) count];
  v3 = [*(a1 + 40) homes];
  v4 = [v3 count];

  v5 = objc_autoreleasePoolPush();
  v6 = *(a1 + 40);
  v7 = HMFGetOSLogHandle();
  v8 = os_log_type_enabled(v7, OS_LOG_TYPE_DEFAULT);
  if (v2 == v4)
  {
    if (v8)
    {
      v9 = HMFGetLogIdentifier();
      v10 = *(a1 + 32);
      v22 = 138543618;
      v23 = v9;
      v24 = 2112;
      v25 = v10;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Empty home determination map: %@", &v22, 0x16u);
    }

    objc_autoreleasePoolPop(v5);
    [*(a1 + 32) na_allSatisfy:&__block_literal_global_53_185358];
    v11 = objc_autoreleasePoolPush();
    v12 = *(a1 + 40);
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_DEFAULT))
    {
      v14 = HMFGetLogIdentifier();
      v15 = HMFBooleanToString();
      v22 = 138543618;
      v23 = v14;
      v24 = 2112;
      v25 = v15;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_DEFAULT, "%{public}@Did we found any empty homes for this user: %@", &v22, 0x16u);
    }

    objc_autoreleasePoolPop(v11);
    v16 = _Block_copy(*(a1 + 48));
    v17 = v16;
    if (v16)
    {
      v18 = v16[2];
LABEL_12:
      v18();
    }
  }

  else
  {
    if (v8)
    {
      v19 = HMFGetLogIdentifier();
      v22 = 138543362;
      v23 = v19;
      _os_log_impl(&dword_2531F8000, v7, OS_LOG_TYPE_DEFAULT, "%{public}@Actual homes in the list and empty home map do not agree. Aborting...", &v22, 0xCu);
    }

    objc_autoreleasePoolPop(v5);
    v20 = _Block_copy(*(a1 + 48));
    v17 = v20;
    if (v20)
    {
      v18 = v20[2];
      goto LABEL_12;
    }
  }

  v21 = *MEMORY[0x277D85DE8];
}

void __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_46(uint64_t a1, void *a2, void *a3)
{
  v26 = *MEMORY[0x277D85DE8];
  v5 = a2;
  v6 = a3;
  if (v6)
  {
    v7 = objc_autoreleasePoolPush();
    v8 = *(a1 + 32);
    v9 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v9, OS_LOG_TYPE_ERROR))
    {
      v10 = HMFGetLogIdentifier();
      *buf = 138543618;
      v23 = v10;
      v24 = 2112;
      v25 = v6;
      _os_log_impl(&dword_2531F8000, v9, OS_LOG_TYPE_ERROR, "%{public}@Error occurred while querying cloud cache: %@", buf, 0x16u);
    }

    objc_autoreleasePoolPop(v7);
    dispatch_group_leave(*(a1 + 40));
  }

  else
  {
    v11 = [*(a1 + 32) workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_47;
    block[3] = &unk_2797352C0;
    v17 = *(a1 + 48);
    v12 = v5;
    v13 = *(a1 + 32);
    v14 = *(a1 + 40);
    v18 = v12;
    v19 = v13;
    v20 = v14;
    v21 = *(a1 + 56);
    dispatch_async(v11, block);
  }

  v15 = *MEMORY[0x277D85DE8];
}

void __89__HMDHomeManager_HH2FrameworkSwitch___determineEmptyHomesForOwnersWithCompletionHandler___block_invoke_47(uint64_t a1)
{
  v37 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) residentDeviceManager];
  v3 = [v2 wasTheHomeFetchedFromCloud];

  if ([*(a1 + 40) hasServerTokenAvailable] && (v3 & 1) != 0)
  {
    if (HMDIsEmptyHome(*(a1 + 32)))
    {
      v4 = *(a1 + 64);
      v5 = [*(a1 + 32) uuid];
      [v4 setObject:MEMORY[0x277CBEC38] forKeyedSubscript:v5];
    }

    v6 = objc_autoreleasePoolPush();
    v7 = *(a1 + 48);
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v9 = HMFGetLogIdentifier();
      v10 = MEMORY[0x277CCABB0];
      v26 = [*(a1 + 32) rooms];
      [v10 numberWithUnsignedInteger:{objc_msgSend(v26, "count")}];
      v11 = v25 = v6;
      v12 = MEMORY[0x277CCABB0];
      v24 = [*(a1 + 32) accessories];
      v13 = [v12 numberWithUnsignedInteger:{objc_msgSend(v24, "count")}];
      v14 = MEMORY[0x277CCABB0];
      v15 = [*(a1 + 32) sharedUsers];
      v16 = [v14 numberWithUnsignedInteger:{objc_msgSend(v15, "count")}];
      v17 = MEMORY[0x277CCABB0];
      v18 = [*(a1 + 32) outgoingInvitations];
      v19 = [v17 numberWithUnsignedInteger:{objc_msgSend(v18, "count")}];
      *buf = 138544386;
      v28 = v9;
      v29 = 2112;
      v30 = v11;
      v31 = 2112;
      v32 = v13;
      v33 = 2112;
      v34 = v16;
      v35 = 2112;
      v36 = v19;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@Home Stats: [Total Rooms: %@], [Total Accessories: %@], [Total Shared Users: %@], [Total Invitations: %@]", buf, 0x34u);

      v6 = v25;
    }
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = *(a1 + 48);
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_DEFAULT))
    {
      v20 = HMFGetLogIdentifier();
      [*(a1 + 40) hasServerTokenAvailable];
      v21 = HMFBooleanToString();
      v22 = HMFBooleanToString();
      *buf = 138543874;
      v28 = v20;
      v29 = 2114;
      v30 = v21;
      v31 = 2114;
      v32 = v22;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_DEFAULT, "%{public}@Either Server token is not available (%{public}@) or the home was not fetched from the cloud (%{public}@)", buf, 0x20u);
    }
  }

  objc_autoreleasePoolPop(v6);
  dispatch_group_leave(*(a1 + 56));
  v23 = *MEMORY[0x277D85DE8];
}

- (void)_fetchHasOnlyEmptyHomesWithCompletion:(id)a3
{
  v19 = *MEMORY[0x277D85DE8];
  v4 = a3;
  v5 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
  v6 = [v5 isHomeManagerFirstFetchFinished];

  if (v6)
  {
    v7 = [(HMDHomeManager *)self cloudDataSyncStateFilter];
    v15[0] = MEMORY[0x277D85DD0];
    v15[1] = 3221225472;
    v15[2] = __76__HMDHomeManager_HH2FrameworkSwitch___fetchHasOnlyEmptyHomesWithCompletion___block_invoke;
    v15[3] = &unk_2797343A8;
    v15[4] = self;
    v16 = v4;
    [v7 totalHomesInCloudZones:v15];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = self;
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v11;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@First fetch for Home Manager's zone is not done yet.", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v8);
    v12 = _Block_copy(v4);
    v13 = v12;
    if (v12)
    {
      (*(v12 + 2))(v12, 0);
    }
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager_HH2FrameworkSwitch___fetchHasOnlyEmptyHomesWithCompletion___block_invoke(uint64_t a1, uint64_t a2, void *a3)
{
  v20 = *MEMORY[0x277D85DE8];
  v5 = a3;
  if (v5)
  {
    v6 = objc_autoreleasePoolPush();
    v7 = *(a1 + 32);
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v19 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_ERROR, "%{public}@Failed to fetch all homes from the cloud. Aborting...", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
    v10 = _Block_copy(*(a1 + 40));
    v11 = v10;
    if (v10)
    {
      (*(v10 + 2))(v10, 0);
    }
  }

  else
  {
    v12 = [*(a1 + 32) workQueue];
    block[0] = MEMORY[0x277D85DD0];
    block[1] = 3221225472;
    block[2] = __76__HMDHomeManager_HH2FrameworkSwitch___fetchHasOnlyEmptyHomesWithCompletion___block_invoke_41;
    block[3] = &unk_279734380;
    v13 = *(a1 + 40);
    block[4] = *(a1 + 32);
    v17 = a2;
    v16 = v13;
    dispatch_async(v12, block);
  }

  v14 = *MEMORY[0x277D85DE8];
}

void __76__HMDHomeManager_HH2FrameworkSwitch___fetchHasOnlyEmptyHomesWithCompletion___block_invoke_41(uint64_t a1)
{
  v25 = *MEMORY[0x277D85DE8];
  v2 = [*(a1 + 32) homes];
  v3 = [v2 count];
  v4 = *(a1 + 48);

  if (v3 == v4)
  {
    v5 = *(a1 + 32);
    v6 = *(a1 + 40);
    v7 = *MEMORY[0x277D85DE8];

    [v5 _determineEmptyHomesForOwnersWithCompletionHandler:v6];
  }

  else
  {
    v8 = objc_autoreleasePoolPush();
    v9 = *(a1 + 32);
    v10 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v10, OS_LOG_TYPE_INFO))
    {
      v11 = HMFGetLogIdentifier();
      v12 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:*(a1 + 48)];
      v13 = MEMORY[0x277CCABB0];
      v14 = [*(a1 + 32) homes];
      v15 = [v13 numberWithUnsignedInteger:{objc_msgSend(v14, "count")}];
      v19 = 138543874;
      v20 = v11;
      v21 = 2112;
      v22 = v12;
      v23 = 2112;
      v24 = v15;
      _os_log_impl(&dword_2531F8000, v10, OS_LOG_TYPE_INFO, "%{public}@There are still homes in the cloud which are not yet downloaded : [HomesInCloud: %@] [HomesInMemory: %@]", &v19, 0x20u);
    }

    objc_autoreleasePoolPop(v8);
    v16 = _Block_copy(*(a1 + 40));
    v17 = v16;
    if (v16)
    {
      (*(v16 + 2))(v16, 0);
    }

    v18 = *MEMORY[0x277D85DE8];
  }
}

- (void)fetchHasOnlyEmptyHomesWithCompletion:(id)a3
{
  v15 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (v4)
  {
    v5 = [(HMDHomeManager *)self workQueue];
    v11[0] = MEMORY[0x277D85DD0];
    v11[1] = 3221225472;
    v11[2] = __75__HMDHomeManager_HH2FrameworkSwitch__fetchHasOnlyEmptyHomesWithCompletion___block_invoke;
    v11[3] = &unk_279735738;
    v11[4] = self;
    v12 = v4;
    dispatch_async(v5, v11);
  }

  else
  {
    v6 = objc_autoreleasePoolPush();
    v7 = self;
    v8 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v8, OS_LOG_TYPE_INFO))
    {
      v9 = HMFGetLogIdentifier();
      *buf = 138543362;
      v14 = v9;
      _os_log_impl(&dword_2531F8000, v8, OS_LOG_TYPE_INFO, "%{public}@Nil completion provided", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v6);
  }

  v10 = *MEMORY[0x277D85DE8];
}

- (void)_initializeAutoMigration
{
  v19 = *MEMORY[0x277D85DE8];
  if (_os_feature_enabled_impl() & 1) != 0 || (_os_feature_enabled_impl())
  {
    v3 = [(HMDHomeManager *)self messageDispatcher];
    v4 = *MEMORY[0x277CD0090];
    v5 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v16 = v5;
    v6 = [MEMORY[0x277CBEA60] arrayWithObjects:&v16 count:1];
    [v3 registerForMessage:v4 receiver:self policies:v6 selector:sel__handleAttemptHH2AutoMigrationMessage_];

    v7 = [HMDHH2AutoMigrationMonitor alloc];
    v8 = [(HMDHomeManager *)self hh2AutoMigrationEligibilityChecker];
    v9 = [(HMDHH2AutoMigrationMonitor *)v7 initWithHomeManager:self eligibilityChecker:v8];
    [(HMDHomeManager *)self setHh2AutoMigrationMonitor:v9];

    v10 = [(HMDHomeManager *)self hh2AutoMigrationMonitor];
    [v10 startMonitoring];
  }

  else
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v18 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Not initializing auto-migration support because feature is disabled", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
  }

  v15 = *MEMORY[0x277D85DE8];
}

- (void)waitForHH2SentinelZoneToBeRemoved
{
  v2 = [(HMDHomeManager *)self hh2FrameworkSwitch];
  [v2 waitForHH2SentinelZoneToBeRemoved];
}

- (void)_handleSwitchSetupMode:(id)a3
{
  v33 = *MEMORY[0x277D85DE8];
  v4 = a3;
  if (_os_feature_enabled_impl())
  {
    v5 = *MEMORY[0x277CD0370];
    v6 = [v4 numberForKey:*MEMORY[0x277CD0370]];
    if (v6)
    {
      v7 = v6;
      v8 = [v6 integerValue];
      keyExistsAndHasValidFormat[0] = 0;
      AppIntegerValue = CFPreferencesGetAppIntegerValue(@"HHTTSUMode", @"com.apple.homed", keyExistsAndHasValidFormat);
      if (keyExistsAndHasValidFormat[0])
      {
        v10 = AppIntegerValue;
      }

      else
      {
        v10 = 0;
      }

      v11 = [(HMDHomeManager *)self hh2FrameworkSwitch];
      v12 = [v11 switchToSetupMode:v8];

      if (v12)
      {
        [v4 respondWithSuccess];
      }

      else
      {
        v22 = objc_autoreleasePoolPush();
        v23 = self;
        v24 = HMFGetOSLogHandle();
        if (os_log_type_enabled(v24, OS_LOG_TYPE_DEFAULT))
        {
          v25 = HMFGetLogIdentifier();
          *keyExistsAndHasValidFormat = 138543362;
          v32 = v25;
          _os_log_impl(&dword_2531F8000, v24, OS_LOG_TYPE_DEFAULT, "%{public}@Mode switch will result in a change do not callback message.", keyExistsAndHasValidFormat, 0xCu);
        }

        objc_autoreleasePoolPop(v22);
        v26 = [MEMORY[0x277CCABB0] numberWithUnsignedInteger:{v10, v5}];
        v30 = v26;
        v27 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v30 forKeys:&v29 count:1];
        [v4 respondWithPayload:v27];
      }
    }

    else
    {
      v17 = objc_autoreleasePoolPush();
      v18 = self;
      v19 = HMFGetOSLogHandle();
      if (os_log_type_enabled(v19, OS_LOG_TYPE_ERROR))
      {
        v20 = HMFGetLogIdentifier();
        *keyExistsAndHasValidFormat = 138543362;
        v32 = v20;
        _os_log_impl(&dword_2531F8000, v19, OS_LOG_TYPE_ERROR, "%{public}@No setup mode in request", keyExistsAndHasValidFormat, 0xCu);
      }

      objc_autoreleasePoolPop(v17);
      v21 = [MEMORY[0x277CCA9B8] hmErrorWithCode:3];
      [v4 respondWithError:v21];

      v7 = 0;
    }
  }

  else
  {
    v13 = objc_autoreleasePoolPush();
    v14 = self;
    v15 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v15, OS_LOG_TYPE_ERROR))
    {
      v16 = HMFGetLogIdentifier();
      *keyExistsAndHasValidFormat = 138543362;
      v32 = v16;
      _os_log_impl(&dword_2531F8000, v15, OS_LOG_TYPE_ERROR, "%{public}@Setup mode is not enabled Failing", keyExistsAndHasValidFormat, 0xCu);
    }

    objc_autoreleasePoolPop(v13);
    v7 = [MEMORY[0x277CCA9B8] hmErrorWithCode:48];
    [v4 respondWithError:v7];
  }

  v28 = *MEMORY[0x277D85DE8];
}

- (void)_handleFetchSetupMode:(id)a3
{
  v9[1] = *MEMORY[0x277D85DE8];
  v8 = *MEMORY[0x277CD0370];
  v3 = MEMORY[0x277CCABB0];
  v4 = a3;
  v5 = [v3 numberWithBool:0];
  v9[0] = v5;
  v6 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v9 forKeys:&v8 count:1];
  [v4 respondWithPayload:v6];

  v7 = *MEMORY[0x277D85DE8];
}

- (void)_registerForFrameworkSwitch
{
  v29 = *MEMORY[0x277D85DE8];
  if (isiOSDevice() || isMac())
  {
    v3 = objc_autoreleasePoolPush();
    v4 = self;
    v5 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
    {
      v6 = HMFGetLogIdentifier();
      *buf = 138543362;
      v28 = v6;
      _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Registering for Upgrade to HH2 migration request", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v3);
    v7 = [(HMDHomeManager *)v4 messageDispatcher];
    v8 = *MEMORY[0x277CD03E0];
    v9 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v26 = v9;
    v10 = [MEMORY[0x277CBEA60] arrayWithObjects:&v26 count:1];
    [v7 registerForMessage:v8 receiver:v4 policies:v10 selector:sel__handleUpgradeToHH2Message_];
  }

  [(HMDHomeManager *)self _initializeAutoMigration];
  if (isInternalBuild())
  {
    v11 = objc_autoreleasePoolPush();
    v12 = self;
    v13 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v13, OS_LOG_TYPE_INFO))
    {
      v14 = HMFGetLogIdentifier();
      *buf = 138543362;
      v28 = v14;
      _os_log_impl(&dword_2531F8000, v13, OS_LOG_TYPE_INFO, "%{public}@Registering for test HH2 migration request message", buf, 0xCu);
    }

    objc_autoreleasePoolPop(v11);
    v15 = [(HMDHomeManager *)v12 messageDispatcher];
    v16 = *MEMORY[0x277CD03B0];
    v17 = [HMDXPCMessagePolicy policyWithEntitlements:5];
    v25 = v17;
    v18 = [MEMORY[0x277CBEA60] arrayWithObjects:&v25 count:1];
    [v15 registerForMessage:v16 receiver:v12 policies:v18 selector:sel__handleTestHH2Migration_];
  }

  v19 = [(HMDHomeManager *)self messageDispatcher];
  v20 = *MEMORY[0x277CD01E0];
  v21 = [HMDXPCMessagePolicy policyWithEntitlements:5];
  v24 = v21;
  v22 = [MEMORY[0x277CBEA60] arrayWithObjects:&v24 count:1];
  [v19 registerForMessage:v20 receiver:self policies:v22 selector:sel__handleFetchSetupMode_];

  v23 = *MEMORY[0x277D85DE8];
}

- (void)stashSharedHomeInfoNotYetMigrated
{
  v38 = *MEMORY[0x277D85DE8];
  v26 = objc_opt_new();
  v27 = 0u;
  v28 = 0u;
  v29 = 0u;
  v30 = 0u;
  v2 = [(HMDHomeManager *)self homes];
  v3 = [v2 countByEnumeratingWithState:&v27 objects:v37 count:16];
  if (v3)
  {
    v5 = v3;
    v6 = *v28;
    *&v4 = 138543618;
    v24 = v4;
    do
    {
      for (i = 0; i != v5; ++i)
      {
        if (*v28 != v6)
        {
          objc_enumerationMutation(v2);
        }

        v8 = *(*(&v27 + 1) + 8 * i);
        if (([v8 isOwnerUser] & 1) == 0)
        {
          v9 = [v8 owner];
          v10 = [v9 account];
          v11 = [v10 senderCorrelationIdentifier];

          if (v11)
          {
            v12 = objc_autoreleasePoolPush();
            v13 = self;
            v14 = HMFGetOSLogHandle();
            if (os_log_type_enabled(v14, OS_LOG_TYPE_INFO))
            {
              v15 = HMFGetLogIdentifier();
              v16 = [v8 uuid];
              *buf = v24;
              v34 = v15;
              v35 = 2112;
              v36 = v16;
              _os_log_impl(&dword_2531F8000, v14, OS_LOG_TYPE_INFO, "%{public}@Stashing info of shared home %@ not being migrated, not yet", buf, 0x16u);
            }

            objc_autoreleasePoolPop(v12);
            v31 = @"HMDHomeManagerAutoAcceptMigrationDateKey";
            v17 = [MEMORY[0x277CBEAA8] now];
            v32 = v17;
            v18 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:&v32 forKeys:&v31 count:1];
            v19 = [v8 uuid];
            v20 = [v19 UUIDString];
            [v26 setObject:v18 forKeyedSubscript:v20];
          }
        }
      }

      v5 = [v2 countByEnumeratingWithState:&v27 objects:v37 count:16];
    }

    while (v5);
  }

  if ([v26 count])
  {
    v21 = [(HMDHomeManager *)self hmdUserDefaults];
    v22 = [v26 copy];
    [v21 setObject:v22 forKey:@"HMDHomeManagerSharedHomesNotYetMigratedKey"];
  }

  v23 = *MEMORY[0x277D85DE8];
}

- (void)maybeStashOwnerMetadataForPostMigrationPingUsingMigratorRecord:(id)a3
{
  v57 = *MEMORY[0x277D85DE8];
  v36 = a3;
  v37 = objc_opt_new();
  v42 = 0u;
  v43 = 0u;
  v44 = 0u;
  v45 = 0u;
  v40 = self;
  obj = [(HMDHomeManager *)self homes];
  v41 = [obj countByEnumeratingWithState:&v42 objects:v56 count:16];
  if (v41)
  {
    v39 = *v43;
    do
    {
      for (i = 0; i != v41; ++i)
      {
        if (*v43 != v39)
        {
          objc_enumerationMutation(obj);
        }

        v5 = *(*(&v42 + 1) + 8 * i);
        if ([v5 isOwnerUser])
        {
          goto LABEL_11;
        }

        v6 = [v5 owner];
        v7 = [v6 account];
        v8 = [v7 senderCorrelationIdentifier];

        if (!v8)
        {
LABEL_11:
          v24 = objc_autoreleasePoolPush();
          v25 = v40;
          v26 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v26, OS_LOG_TYPE_INFO))
          {
            v27 = HMFGetLogIdentifier();
            v28 = [v5 owner];
            v29 = [v28 account];
            v30 = [v29 senderCorrelationIdentifier];
            v31 = [v5 uuid];
            [v5 isOwnerUser];
            v32 = HMFBooleanToString();
            *buf = 138544130;
            v47 = v27;
            v48 = 2112;
            v49 = v30;
            v50 = 2112;
            v51 = v31;
            v52 = 2112;
            v53 = v32;
            _os_log_impl(&dword_2531F8000, v26, OS_LOG_TYPE_INFO, "%{public}@Not stashing owner merge id (%@) for home %@ (isOwnerUser=%@)", buf, 0x2Au);
          }

          objc_autoreleasePoolPop(v24);
        }

        else
        {
          v9 = objc_autoreleasePoolPush();
          v10 = v40;
          v11 = HMFGetOSLogHandle();
          if (os_log_type_enabled(v11, OS_LOG_TYPE_INFO))
          {
            v12 = HMFGetLogIdentifier();
            v13 = [v5 uuid];
            *buf = 138543618;
            v47 = v12;
            v48 = 2112;
            v49 = v13;
            _os_log_impl(&dword_2531F8000, v11, OS_LOG_TYPE_INFO, "%{public}@Stashing owner account metadata for home %@ to ping after migration", buf, 0x16u);
          }

          objc_autoreleasePoolPop(v9);
          v54[0] = @"HMDHomeManagerAutoAcceptMigrationDateKey";
          v14 = [MEMORY[0x277CBEAA8] now];
          v55[0] = v14;
          v54[1] = @"HMDHomeManagerAutoAcceptOwnerMergeIDKey";
          v15 = [v5 owner];
          v16 = [v15 account];
          v17 = [v16 senderCorrelationIdentifier];
          v55[1] = v17;
          v54[2] = @"HMDHomeManagerAutoAcceptOwnerHandleKey";
          v18 = [v5 owner];
          v19 = [v18 accountHandle];
          v20 = [v19 remoteDestinationString];
          v55[2] = v20;
          v21 = [MEMORY[0x277CBEAC0] dictionaryWithObjects:v55 forKeys:v54 count:3];

          v22 = [v5 uuid];
          v23 = [v22 UUIDString];
          [v37 setObject:v21 forKeyedSubscript:v23];
        }
      }

      v41 = [obj countByEnumeratingWithState:&v42 objects:v56 count:16];
    }

    while (v41);
  }

  if ([v37 count])
  {
    v33 = [(HMDHomeManager *)v40 hmdUserDefaults];
    v34 = [v37 copy];
    [v33 setObject:v34 forKey:@"HMDHomeManagerHomesAwaitingHH2AutoAcceptKey"];
  }

  v35 = *MEMORY[0x277D85DE8];
}

- (void)_storeAllLocalSettingsForThisDevice
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_DEFAULT))
  {
    v6 = HMFGetLogIdentifier();
    v7 = [(HMDHomeManager *)v4 homes];
    v10 = 138543618;
    v11 = v6;
    v12 = 2112;
    v13 = v7;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_DEFAULT, "%{public}@Going to store Bulletin board notification settings for each home. %@", &v10, 0x16u);
  }

  objc_autoreleasePoolPop(v3);
  v8 = [(HMDHomeManager *)v4 homes];
  [v8 hmf_enumerateWithAutoreleasePoolUsingBlock:&__block_literal_global_185383];

  [(HMDHomeManager *)v4 saveAccessAllowedWhenLockedSettingToLocalDisk];
  v9 = *MEMORY[0x277D85DE8];
}

void __73__HMDHomeManager_HH2FrameworkSwitch___storeAllLocalSettingsForThisDevice__block_invoke(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 storeMigrationBulletinBoardNotificationsToDisk];
  [v2 storeMigrationCameraNotificationSettingsToDisk];
  [v2 storeMigrationCharacteristicsAuthorizationData];
  v3 = [v2 walletKeyManager];
  [v3 storeWalletKeyMigrationSettingsToDisk];

  v4 = [v2 users];
  [v4 hmf_enumerateWithAutoreleasePoolUsingBlock:&__block_literal_global_17_185385];

  v5 = [v2 accessories];

  [v5 hmf_enumerateWithAutoreleasePoolUsingBlock:&__block_literal_global_20_185386];
}

void __73__HMDHomeManager_HH2FrameworkSwitch___storeAllLocalSettingsForThisDevice__block_invoke_3(uint64_t a1, void *a2)
{
  v5 = a2;
  objc_opt_class();
  if (objc_opt_isKindOfClass())
  {
    v2 = v5;
  }

  else
  {
    v2 = 0;
  }

  v3 = v2;
  v4 = v3;
  if (v3)
  {
    [v3 saveCharacteristicsToLocalDiskForHH2Migration];
  }
}

void __73__HMDHomeManager_HH2FrameworkSwitch___storeAllLocalSettingsForThisDevice__block_invoke_2(uint64_t a1, void *a2)
{
  v2 = a2;
  [v2 saveAnnounceNotificationModeForCurrentUserToLocalDisk];
  [v2 savePersonClassificationSettingsForCurrentUserToLocalDisk];
}

- (id)_performPreHH2RebootTasks
{
  v21 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    v19 = 138543362;
    v20 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Perform HH2 Pre reboot task", &v19, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  v7 = [MEMORY[0x277CBEBD0] standardUserDefaults];
  [v7 removeObjectForKey:@"HMDHomeWalletKeyManagerDidTryReplacingKeyAlready"];

  v8 = +[HMDXPCMessageTransport defaultTransport];
  [v8 stop];

  [HMDResetConfigPostCleanup writePostCleanupRecordToRemoveAllCoreDataFilesWithReason:5];
  +[HMDHH2MigratorRecord removeMigrationFailureRecord];
  v9 = +[HMDHH2MigratorRecord singleRecord];
  if (([v9 dryRun] & 1) != 0 || objc_msgSend(v9, "migrateFromTestDirectory"))
  {
    v10 = objc_autoreleasePoolPush();
    v11 = v4;
    v12 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v12, OS_LOG_TYPE_INFO))
    {
      v13 = HMFGetLogIdentifier();
      v19 = 138543362;
      v20 = v13;
      _os_log_impl(&dword_2531F8000, v12, OS_LOG_TYPE_INFO, "%{public}@Not running per device migration as we are doing a dryRun for HH2 migration.", &v19, 0xCu);
    }

    objc_autoreleasePoolPop(v10);
    v14 = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  else
  {
    [(HMDHomeManager *)v4 maybeStashOwnerMetadataForPostMigrationPingUsingMigratorRecord:v9];
    [(HMDHomeManager *)v4 stashSharedHomeInfoNotYetMigrated];
    v15 = [(HMDHomeManager *)v4 metricsManager];
    [v15 saveCounters];

    v16 = [(HMDHomeManager *)v4 metricsManager];
    [v16 waitToCompleteCurrentlyQueuedTasks];

    v14 = [(HMDHomeManager *)v4 _pushChangesToAllUsersOfAllHomesForMigration];
    [(HMDHomeManager *)v4 _storeAllLocalSettingsForThisDevice];
    [(HMDHomeManager *)v4 _migrateCurrentAccessoryDataIfNeeded];
    [(HMDHomeManager *)v4 migrateLocalMediaGroupParticipantData];
  }

  v17 = *MEMORY[0x277D85DE8];

  return v14;
}

- (void)initializeHH2FrameworkSwitch
{
  v14 = *MEMORY[0x277D85DE8];
  v3 = objc_autoreleasePoolPush();
  v4 = self;
  v5 = HMFGetOSLogHandle();
  if (os_log_type_enabled(v5, OS_LOG_TYPE_INFO))
  {
    v6 = HMFGetLogIdentifier();
    *buf = 138543362;
    v13 = v6;
    _os_log_impl(&dword_2531F8000, v5, OS_LOG_TYPE_INFO, "%{public}@Initializing framework switch with auto switch enabled", buf, 0xCu);
  }

  objc_autoreleasePoolPop(v3);
  objc_initWeak(buf, v4);
  v7 = [HMDHH2FrameworkSwitch alloc];
  v10[0] = MEMORY[0x277D85DD0];
  v10[1] = 3221225472;
  v10[2] = __66__HMDHomeManager_HH2FrameworkSwitch__initializeHH2FrameworkSwitch__block_invoke;
  v10[3] = &unk_2797342F8;
  objc_copyWeak(&v11, buf);
  v8 = [(HMDHH2FrameworkSwitch *)v7 initWithAutoSwitch:1 homeManager:v4 dataSource:0 callBeforeFrameworkSwitch:v10];
  [(HMDHomeManager *)v4 setHh2FrameworkSwitch:v8];

  objc_destroyWeak(&v11);
  objc_destroyWeak(buf);
  v9 = *MEMORY[0x277D85DE8];
}

id __66__HMDHomeManager_HH2FrameworkSwitch__initializeHH2FrameworkSwitch__block_invoke(uint64_t a1)
{
  v12 = *MEMORY[0x277D85DE8];
  WeakRetained = objc_loadWeakRetained((a1 + 32));
  if (!WeakRetained)
  {
    v2 = objc_autoreleasePoolPush();
    v3 = objc_opt_class();
    v4 = HMFGetOSLogHandle();
    if (os_log_type_enabled(v4, OS_LOG_TYPE_ERROR))
    {
      v5 = HMFGetLogIdentifier();
      v10 = 138543362;
      v11 = v5;
      _os_log_impl(&dword_2531F8000, v4, OS_LOG_TYPE_ERROR, "%{public}@Home manager died before framework switch completed", &v10, 0xCu);
    }

    objc_autoreleasePoolPop(v2);
    v6 = [MEMORY[0x277D0F7C0] futureWithNoValue];
  }

  v7 = [WeakRetained _performPreHH2RebootTasks];

  v8 = *MEMORY[0x277D85DE8];

  return v7;
}

@end