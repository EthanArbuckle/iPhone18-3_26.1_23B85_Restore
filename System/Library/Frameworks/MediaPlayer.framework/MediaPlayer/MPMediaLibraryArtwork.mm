@interface MPMediaLibraryArtwork
+ (BOOL)artworkExistsForRequest:(id)request;
+ (BOOL)fetchableArtworkExistsForRequest:(id)request;
+ (BOOL)needsToFetchArtworkForRequest:(id)request;
+ (id)availableArtworkWithRequest:(id)request;
+ (void)cancelFetchingArtworkForRequest:(id)request;
+ (void)fetchArtworkForRequest:(id)request completionHandler:(id)handler;
+ (void)fetchArtworkInfoForRequest:(id)request completionHandler:(id)handler;
- (BOOL)isEqual:(id)equal;
- (MPMediaLibraryArtwork)init;
- (MPMediaLibraryArtworkRequest)artworkRequest;
- (NSArray)autogeneratedSizes;
- (NSArray)validSizes;
- (NSDictionary)effectsMetadata;
- (id)imageFileURLForEffect:(id)effect;
- (id)imageFileURLForSize:(CGSize)size;
- (unint64_t)hash;
- (void)setArtwork:(id)artwork;
- (void)setEffectsMetadata:(id)metadata;
@end

@implementation MPMediaLibraryArtwork

- (MPMediaLibraryArtworkRequest)artworkRequest
{
  WeakRetained = objc_loadWeakRetained(&self->_artworkRequest);

  return WeakRetained;
}

- (void)setEffectsMetadata:(id)metadata
{
  metadataCopy = metadata;
  os_unfair_lock_lock(&self->_stateLock);
  v5 = [metadataCopy copy];

  [(ML3Artwork *)self->_artwork setInterestDictionary:v5];

  os_unfair_lock_unlock(&self->_stateLock);
}

- (NSDictionary)effectsMetadata
{
  os_unfair_lock_lock(&self->_stateLock);
  interestDictionary = [(ML3Artwork *)self->_artwork interestDictionary];
  v4 = [interestDictionary copy];
  v5 = v4;
  v6 = MEMORY[0x1E695E0F8];
  if (v4)
  {
    v6 = v4;
  }

  v7 = v6;

  os_unfair_lock_unlock(&self->_stateLock);

  return v7;
}

- (void)setArtwork:(id)artwork
{
  artworkCopy = artwork;
  os_unfair_lock_lock(&self->_stateLock);
  artwork = self->_artwork;
  self->_artwork = artworkCopy;

  os_unfair_lock_unlock(&self->_stateLock);
}

- (NSArray)autogeneratedSizes
{
  os_unfair_lock_lock(&self->_stateLock);
  autogeneratedSizes = self->_autogeneratedSizes;
  if (!autogeneratedSizes)
  {
    artworkRequest = [(MPMediaLibraryArtwork *)self artworkRequest];
    v5 = +[MPArtworkConfiguration systemConfiguration];
    v6 = [v5 sizesToAutogenerateForMediaType:objc_msgSend(artworkRequest artworkType:"mediaType") artworkVariantType:{objc_msgSend(artworkRequest, "artworkType"), objc_msgSend(artworkRequest, "variantType")}];
    allObjects = [v6 allObjects];

    v8 = [allObjects sortedArrayUsingComparator:&__block_literal_global_390];
    v9 = self->_autogeneratedSizes;
    self->_autogeneratedSizes = v8;

    autogeneratedSizes = self->_autogeneratedSizes;
  }

  v10 = autogeneratedSizes;
  os_unfair_lock_unlock(&self->_stateLock);

  return v10;
}

- (NSArray)validSizes
{
  os_unfair_lock_lock(&self->_stateLock);
  validSizes = self->_validSizes;
  if (!validSizes)
  {
    artworkRequest = [(MPMediaLibraryArtwork *)self artworkRequest];
    v5 = +[MPArtworkConfiguration systemConfiguration];
    v6 = [v5 supportedSizesForMediaType:objc_msgSend(artworkRequest artworkType:"mediaType") artworkVariantType:{objc_msgSend(artworkRequest, "artworkType"), objc_msgSend(artworkRequest, "variantType")}];
    allObjects = [v6 allObjects];

    v8 = [allObjects sortedArrayUsingComparator:&__block_literal_global_390];
    v9 = self->_validSizes;
    self->_validSizes = v8;

    validSizes = self->_validSizes;
  }

  v10 = validSizes;
  os_unfair_lock_unlock(&self->_stateLock);

  return v10;
}

- (id)imageFileURLForEffect:(id)effect
{
  effectCopy = effect;
  os_unfair_lock_lock(&self->_stateLock);
  artwork = [(MPMediaLibraryArtwork *)self artwork];
  v6 = [artwork fileURLForEffect:effectCopy];

  os_unfair_lock_unlock(&self->_stateLock);

  return v6;
}

- (id)imageFileURLForSize:(CGSize)size
{
  height = size.height;
  width = size.width;
  os_unfair_lock_lock(&self->_stateLock);
  artwork = [(MPMediaLibraryArtwork *)self artwork];
  v7 = [artwork fileURLForSize:{width, height}];

  os_unfair_lock_unlock(&self->_stateLock);

  return v7;
}

- (BOOL)isEqual:(id)equal
{
  equalCopy = equal;
  if (self == equalCopy)
  {
    v7 = 1;
  }

  else
  {
    objc_opt_class();
    if (objc_opt_isKindOfClass())
    {
      artwork = [(MPMediaLibraryArtwork *)self artwork];
      artwork2 = [(MPMediaLibraryArtwork *)equalCopy artwork];
      v7 = [artwork isEqual:artwork2];
    }

    else
    {
      v7 = 0;
    }
  }

  return v7;
}

- (unint64_t)hash
{
  artwork = [(MPMediaLibraryArtwork *)self artwork];
  v3 = [artwork hash];

  return v3;
}

- (MPMediaLibraryArtwork)init
{
  v3.receiver = self;
  v3.super_class = MPMediaLibraryArtwork;
  result = [(MPMediaLibraryArtwork *)&v3 init];
  if (result)
  {
    result->_stateLock._os_unfair_lock_opaque = 0;
  }

  return result;
}

+ (void)fetchArtworkInfoForRequest:(id)request completionHandler:(id)handler
{
  v25[1] = *MEMORY[0x1E69E9840];
  requestCopy = request;
  handlerCopy = handler;
  fetchableArtworkSource = [requestCopy fetchableArtworkSource];
  integerValue = [fetchableArtworkSource integerValue];

  if (integerValue)
  {
    availableArtworkToken = 0;
LABEL_3:
    userIdentity = [requestCopy userIdentity];
    v11 = [MPCloudController controllerWithUserIdentity:userIdentity];
    libraryID = [requestCopy libraryID];
    entityType = [requestCopy entityType];
    artworkType = [requestCopy artworkType];
    v22[0] = MEMORY[0x1E69E9820];
    v22[1] = 3221225472;
    v22[2] = __70__MPMediaLibraryArtwork_fetchArtworkInfoForRequest_completionHandler___block_invoke;
    v22[3] = &unk_1E7675C98;
    v23 = handlerCopy;
    [v11 loadArtworkInfoForEntityPersistentID:libraryID entityType:entityType artworkType:artworkType artworkSourceType:integerValue completionHandler:v22];

    v15 = v23;
    goto LABEL_4;
  }

  availableArtworkToken = [requestCopy availableArtworkToken];

  if (availableArtworkToken)
  {
    v16 = objc_alloc(MEMORY[0x1E69B3440]);
    availableArtworkToken2 = [requestCopy availableArtworkToken];
    artworkType2 = [requestCopy artworkType];
    musicLibrary = [requestCopy musicLibrary];
    availableArtworkToken = [v16 initWithToken:availableArtworkToken2 artworkType:artworkType2 musicLibrary:musicLibrary];

    integerValue = [availableArtworkToken sourceType];
    if (integerValue)
    {
      goto LABEL_3;
    }
  }

  if (!handlerCopy)
  {
    goto LABEL_5;
  }

  v20 = MEMORY[0x1E696ABC0];
  v24 = *MEMORY[0x1E696A578];
  v25[0] = @"Unknown artwork source type for artwork info request.";
  v15 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v25 forKeys:&v24 count:1];
  v21 = [v20 errorWithDomain:@"MPMediaLibraryArtworkErrorDomain" code:0 userInfo:v15];
  (*(handlerCopy + 2))(handlerCopy, 0, v21);

LABEL_4:
LABEL_5:
}

uint64_t __70__MPMediaLibraryArtwork_fetchArtworkInfoForRequest_completionHandler___block_invoke(uint64_t a1)
{
  result = *(a1 + 32);
  if (result)
  {
    return (*(result + 16))();
  }

  return result;
}

+ (void)cancelFetchingArtworkForRequest:(id)request
{
  v11 = *MEMORY[0x1E69E9840];
  requestCopy = request;
  fetchableArtworkSource = [requestCopy fetchableArtworkSource];
  integerValue = [fetchableArtworkSource integerValue];

  if (integerValue)
  {
    userIdentity = [requestCopy userIdentity];
    v7 = [MPCloudController controllerWithUserIdentity:userIdentity];
    [v7 deprioritizeArtworkRequestForEntityPersistentID:objc_msgSend(requestCopy entityType:"libraryID") artworkType:objc_msgSend(requestCopy artworkSourceType:{"entityType"), objc_msgSend(requestCopy, "artworkType"), integerValue}];
  }

  else
  {
    v8 = os_log_create("com.apple.amp.mediaplayer", "Artwork");
    if (os_log_type_enabled(v8, OS_LOG_TYPE_ERROR))
    {
      v9 = 138543362;
      v10 = requestCopy;
      _os_log_impl(&dword_1A238D000, v8, OS_LOG_TYPE_ERROR, "[MPArtwork] Failed to deprioritize artwork request %{public}@ â€“ unknown artwork source type", &v9, 0xCu);
    }
  }
}

+ (void)fetchArtworkForRequest:(id)request completionHandler:(id)handler
{
  v24[1] = *MEMORY[0x1E69E9840];
  requestCopy = request;
  handlerCopy = handler;
  fetchableArtworkSource = [requestCopy fetchableArtworkSource];
  integerValue = [fetchableArtworkSource integerValue];

  if (integerValue)
  {
    userIdentity = [requestCopy userIdentity];
    v11 = [MPCloudController controllerWithUserIdentity:userIdentity];
    libraryID = [requestCopy libraryID];
    entityType = [requestCopy entityType];
    artworkType = [requestCopy artworkType];
    variantType = [requestCopy variantType];
    v19[0] = MEMORY[0x1E69E9820];
    v19[1] = 3221225472;
    v19[2] = __66__MPMediaLibraryArtwork_fetchArtworkForRequest_completionHandler___block_invoke;
    v19[3] = &unk_1E7680808;
    v20 = requestCopy;
    v21 = handlerCopy;
    selfCopy = self;
    [v11 loadArtworkForEntityPersistentID:libraryID entityType:entityType artworkType:artworkType artworkSourceType:integerValue artworkVariantType:variantType completionHandler:v19];

    v16 = v20;
LABEL_5:

    goto LABEL_6;
  }

  if (handlerCopy)
  {
    v17 = MEMORY[0x1E696ABC0];
    v23 = *MEMORY[0x1E696A578];
    v24[0] = @"Unknown artwork source type.";
    v16 = [MEMORY[0x1E695DF20] dictionaryWithObjects:v24 forKeys:&v23 count:1];
    v18 = [v17 errorWithDomain:@"MPMediaLibraryArtworkErrorDomain" code:0 userInfo:v16];
    (*(handlerCopy + 2))(handlerCopy, 0, v18);

    goto LABEL_5;
  }

LABEL_6:
}

void __66__MPMediaLibraryArtwork_fetchArtworkForRequest_completionHandler___block_invoke(uint64_t a1, void *a2)
{
  v3 = a2;
  v7 = MEMORY[0x1E69E9820];
  v8 = 3221225472;
  v9 = __66__MPMediaLibraryArtwork_fetchArtworkForRequest_completionHandler___block_invoke_2;
  v10 = &unk_1E7675470;
  v11 = *(a1 + 32);
  v4 = v3;
  v12 = v4;
  AnalyticsSendEventLazy();
  if (!v4)
  {
    [*(a1 + 32) promoteFetchableArtworkTokenIfNeeded];
  }

  [*(a1 + 32) clearFailedFetchableToken];
  v5 = *(a1 + 40);
  if (v5)
  {
    if (v4)
    {
      v6 = 0;
    }

    else
    {
      v6 = [*(a1 + 48) availableArtworkWithRequest:*(a1 + 32)];
      v5 = *(a1 + 40);
    }

    (*(v5 + 16))(v5, v6, v4);
  }
}

id __66__MPMediaLibraryArtwork_fetchArtworkForRequest_completionHandler___block_invoke_2(uint64_t a1)
{
  v2 = [MEMORY[0x1E695DF90] dictionary];
  v3 = [MEMORY[0x1E695DF00] date];
  v4 = _NSStringFromMPMediaLibraryArtworkType([*(a1 + 32) artworkType]);
  [v2 setObject:v4 forKeyedSubscript:@"mediaType"];

  if (*(a1 + 40))
  {
    v5 = MEMORY[0x1E695E118];
  }

  else
  {
    v5 = MEMORY[0x1E695E110];
  }

  [v2 setObject:v5 forKeyedSubscript:@"success"];
  v6 = MEMORY[0x1E696AD98];
  [v3 timeIntervalSinceNow];
  v8 = [v6 numberWithDouble:fabs(v7)];
  [v2 setObject:v8 forKeyedSubscript:@"duration"];

  return v2;
}

+ (BOOL)fetchableArtworkExistsForRequest:(id)request
{
  requestCopy = request;
  v17 = 0;
  v18 = &v17;
  v19 = 0x2020000000;
  v20 = 0;
  libraryID = [requestCopy libraryID];
  entityType = [requestCopy entityType];
  artworkType = [requestCopy artworkType];
  variantType = [requestCopy variantType];
  musicLibrary = [requestCopy musicLibrary];
  v11[0] = MEMORY[0x1E69E9820];
  v11[1] = 3221225472;
  v11[2] = __58__MPMediaLibraryArtwork_fetchableArtworkExistsForRequest___block_invoke;
  v11[3] = &unk_1E7675448;
  v13 = &v17;
  v9 = musicLibrary;
  v12 = v9;
  v14 = libraryID;
  v15 = entityType;
  v16 = artworkType;
  [v9 enumerateArtworkTokensForEntityPersistentID:libraryID entityType:entityType artworkType:artworkType variantType:variantType usingBlock:v11];
  LOBYTE(libraryID) = *(v18 + 24);

  _Block_object_dispose(&v17, 8);
  return libraryID;
}

uint64_t __58__MPMediaLibraryArtwork_fetchableArtworkExistsForRequest___block_invoke(uint64_t a1, uint64_t a2, uint64_t a3, _BYTE *a4)
{
  result = [*(a1 + 32) isArtworkFetchableForPersistentID:*(a1 + 48) entityType:*(a1 + 56) artworkType:*(a1 + 64) artworkSourceType:a3];
  *(*(*(a1 + 40) + 8) + 24) = result;
  *a4 = *(*(*(a1 + 40) + 8) + 24);
  return result;
}

+ (id)availableArtworkWithRequest:(id)request
{
  requestCopy = request;
  libraryArtwork = [requestCopy libraryArtwork];
  if (libraryArtwork)
  {
    v5 = libraryArtwork;
  }

  else
  {
    availableArtworkToken = [requestCopy availableArtworkToken];

    if (availableArtworkToken && (v7 = objc_alloc(MEMORY[0x1E69B3440]), [requestCopy availableArtworkToken], v8 = objc_claimAutoreleasedReturnValue(), v9 = objc_msgSend(requestCopy, "artworkType"), v10 = objc_msgSend(requestCopy, "variantType"), objc_msgSend(requestCopy, "musicLibrary"), v11 = objc_claimAutoreleasedReturnValue(), v12 = objc_msgSend(v7, "initWithToken:artworkType:variantType:musicLibrary:", v8, v9, v10, v11), v11, v8, v12))
    {
      v13 = objc_alloc_init(MPMediaLibraryArtwork);
      [(MPMediaLibraryArtwork *)v13 setArtworkRequest:requestCopy];
      [(MPMediaLibraryArtwork *)v13 setArtwork:v12];
      [requestCopy setLibraryArtwork:v13];
      v5 = v13;
    }

    else
    {
      v5 = 0;
    }
  }

  return v5;
}

+ (BOOL)needsToFetchArtworkForRequest:(id)request
{
  requestCopy = request;
  fetchableArtworkToken = [requestCopy fetchableArtworkToken];
  v5 = [fetchableArtworkToken length];

  if (v5)
  {
    musicLibrary = [requestCopy musicLibrary];
    fetchableArtworkToken2 = [requestCopy fetchableArtworkToken];
    v8 = [musicLibrary isArtworkTokenAvailable:fetchableArtworkToken2 forVariantType:{objc_msgSend(requestCopy, "variantType")}];

    if (!v8)
    {
      v10 = 1;
      goto LABEL_6;
    }

    fetchableArtworkToken3 = [requestCopy fetchableArtworkToken];
    [requestCopy setAvailableArtworkToken:fetchableArtworkToken3];

    [requestCopy setFetchableArtworkToken:0];
    [requestCopy setLibraryArtwork:0];
  }

  v10 = 0;
LABEL_6:

  return v10;
}

+ (BOOL)artworkExistsForRequest:(id)request
{
  requestCopy = request;
  availableArtworkToken = [requestCopy availableArtworkToken];
  if ([availableArtworkToken length])
  {
    v5 = 1;
  }

  else
  {
    fetchableArtworkToken = [requestCopy fetchableArtworkToken];
    v5 = [fetchableArtworkToken length] != 0;
  }

  return v5;
}

@end